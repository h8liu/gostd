<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/fcgi</h2>
<ul>
<li><a href="/gostd/net/http/fcgi/child.go.html" class="current">child.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi.go.html">fcgi.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi_test.go.html">fcgi_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6110602">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6110657">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6110711">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6110762">package</span>&nbsp;<span class="ident" id="6110770">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6110776">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;FastCGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6110850">import</span>&nbsp;<span class="op" id="6110857">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6110860">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6110870">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6110877">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6110883">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6110896">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6110903">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6110915">&#34;net/http/cgi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6110931">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6110937">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6110948">&#34;sync&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6110956">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6110963">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6110966">//&nbsp;request&nbsp;holds&nbsp;the&nbsp;state&nbsp;for&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;As&nbsp;soon&nbsp;as&nbsp;it&#39;s&nbsp;complete,</span><br>
<span class="lineno"></span><span class="comment" id="6111047">//&nbsp;it&#39;s&nbsp;converted&nbsp;to&nbsp;an&nbsp;http.Request.</span><br>
<span class="lineno">25</span><span class="keyword" id="6111085">type</span>&nbsp;<span class="ident" id="6111090">request</span>&nbsp;<span class="keyword" id="6111098">struct</span>&nbsp;<span class="op" id="6111105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111108">pw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6111118">*</span><span class="ident" id="6111119">io</span><span class="op" id="6111121">.</span><span class="ident" id="6111122">PipeWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111134">reqId</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6111144">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111152">params</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6111162">map</span><span class="op" id="6111165">[</span><span class="builtintype" id="6111166">string</span><span class="op" id="6111172">]</span><span class="builtintype" id="6111173">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111181">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6111191">[</span><span class="num" id="6111192">1024</span><span class="op" id="6111196">]</span><span class="builtintype" id="6111197">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111203">rawParams</span>&nbsp;<span class="op" id="6111213">[</span><span class="op" id="6111214">]</span><span class="builtintype" id="6111215">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111221">keepConn</span>&nbsp;&nbsp;<span class="builtintype" id="6111231">bool</span><br>
<span class="lineno"></span><span class="op" id="6111236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6111239">func</span>&nbsp;<span class="ident" id="6111244">newRequest</span><span class="op" id="6111254">(</span><span class="ident" id="6111255">reqId</span>&nbsp;<span class="builtintype" id="6111261">uint16</span><span class="op" id="6111267">,</span>&nbsp;<span class="ident" id="6111269">flags</span>&nbsp;<span class="builtintype" id="6111275">uint8</span><span class="op" id="6111280">)</span>&nbsp;<span class="op" id="6111282">*</span><span class="ident" id="6111283">request</span>&nbsp;<span class="op" id="6111291">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111294">r</span>&nbsp;<span class="op" id="6111296">:=</span>&nbsp;<span class="op" id="6111299">&amp;</span><span class="ident" id="6111300">request</span><span class="op" id="6111307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111311">reqId</span><span class="op" id="6111316">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111321">reqId</span><span class="op" id="6111326">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111330">params</span><span class="op" id="6111336">:</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="6111340">map</span><span class="op" id="6111343">[</span><span class="builtintype" id="6111344">string</span><span class="op" id="6111350">]</span><span class="builtintype" id="6111351">string</span><span class="op" id="6111357">{</span><span class="op" id="6111358">}</span><span class="op" id="6111359">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111363">keepConn</span><span class="op" id="6111371">:</span>&nbsp;<span class="ident" id="6111373">flags</span><span class="op" id="6111378">&amp;</span><span class="ident" id="6111379">flagKeepConn</span>&nbsp;<span class="op" id="6111392">!=</span>&nbsp;<span class="num" id="6111395">0</span><span class="op" id="6111396">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6111399">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111402">r</span><span class="op" id="6111403">.</span><span class="ident" id="6111404">rawParams</span>&nbsp;<span class="op" id="6111414">=</span>&nbsp;<span class="ident" id="6111416">r</span><span class="op" id="6111417">.</span><span class="ident" id="6111418">buf</span><span class="op" id="6111421">[</span><span class="op" id="6111422">:</span><span class="num" id="6111423">0</span><span class="op" id="6111424">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6111427">return</span>&nbsp;<span class="ident" id="6111434">r</span><br>
<span class="lineno"></span><span class="op" id="6111436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6111439">//&nbsp;parseParams&nbsp;reads&nbsp;an&nbsp;encoded&nbsp;[]byte&nbsp;into&nbsp;Params.</span><br>
<span class="lineno">45</span><span class="keyword" id="6111491">func</span>&nbsp;<span class="op" id="6111496">(</span><span class="ident" id="6111497">r</span>&nbsp;<span class="op" id="6111499">*</span><span class="ident" id="6111500">request</span><span class="op" id="6111507">)</span>&nbsp;<span class="ident" id="6111509">parseParams</span><span class="op" id="6111520">(</span><span class="op" id="6111521">)</span>&nbsp;<span class="op" id="6111523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111526">text</span>&nbsp;<span class="op" id="6111531">:=</span>&nbsp;<span class="ident" id="6111534">r</span><span class="op" id="6111535">.</span><span class="ident" id="6111536">rawParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111547">r</span><span class="op" id="6111548">.</span><span class="ident" id="6111549">rawParams</span>&nbsp;<span class="op" id="6111559">=</span>&nbsp;<span class="builtintype" id="6111561">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6111566">for</span>&nbsp;<span class="builtinfunc" id="6111570">len</span><span class="op" id="6111573">(</span><span class="ident" id="6111574">text</span><span class="op" id="6111578">)</span>&nbsp;<span class="op" id="6111580">&gt;</span>&nbsp;<span class="num" id="6111582">0</span>&nbsp;<span class="op" id="6111584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111588">keyLen</span><span class="op" id="6111594">,</span>&nbsp;<span class="ident" id="6111596">n</span>&nbsp;<span class="op" id="6111598">:=</span>&nbsp;<span class="ident" id="6111601">readSize</span><span class="op" id="6111609">(</span><span class="ident" id="6111610">text</span><span class="op" id="6111614">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6111618">if</span>&nbsp;<span class="ident" id="6111621">n</span>&nbsp;<span class="op" id="6111623">==</span>&nbsp;<span class="num" id="6111626">0</span>&nbsp;<span class="op" id="6111628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6111633">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6111642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111646">text</span>&nbsp;<span class="op" id="6111651">=</span>&nbsp;<span class="ident" id="6111653">text</span><span class="op" id="6111657">[</span><span class="ident" id="6111658">n</span><span class="op" id="6111659">:</span><span class="op" id="6111660">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111664">valLen</span><span class="op" id="6111670">,</span>&nbsp;<span class="ident" id="6111672">n</span>&nbsp;<span class="op" id="6111674">:=</span>&nbsp;<span class="ident" id="6111677">readSize</span><span class="op" id="6111685">(</span><span class="ident" id="6111686">text</span><span class="op" id="6111690">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6111694">if</span>&nbsp;<span class="ident" id="6111697">n</span>&nbsp;<span class="op" id="6111699">==</span>&nbsp;<span class="num" id="6111702">0</span>&nbsp;<span class="op" id="6111704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6111709">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6111718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111722">text</span>&nbsp;<span class="op" id="6111727">=</span>&nbsp;<span class="ident" id="6111729">text</span><span class="op" id="6111733">[</span><span class="ident" id="6111734">n</span><span class="op" id="6111735">:</span><span class="op" id="6111736">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111740">key</span>&nbsp;<span class="op" id="6111744">:=</span>&nbsp;<span class="ident" id="6111747">readString</span><span class="op" id="6111757">(</span><span class="ident" id="6111758">text</span><span class="op" id="6111762">,</span>&nbsp;<span class="ident" id="6111764">keyLen</span><span class="op" id="6111770">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111774">text</span>&nbsp;<span class="op" id="6111779">=</span>&nbsp;<span class="ident" id="6111781">text</span><span class="op" id="6111785">[</span><span class="ident" id="6111786">keyLen</span><span class="op" id="6111792">:</span><span class="op" id="6111793">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111797">val</span>&nbsp;<span class="op" id="6111801">:=</span>&nbsp;<span class="ident" id="6111804">readString</span><span class="op" id="6111814">(</span><span class="ident" id="6111815">text</span><span class="op" id="6111819">,</span>&nbsp;<span class="ident" id="6111821">valLen</span><span class="op" id="6111827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111831">text</span>&nbsp;<span class="op" id="6111836">=</span>&nbsp;<span class="ident" id="6111838">text</span><span class="op" id="6111842">[</span><span class="ident" id="6111843">valLen</span><span class="op" id="6111849">:</span><span class="op" id="6111850">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111854">r</span><span class="op" id="6111855">.</span><span class="ident" id="6111856">params</span><span class="op" id="6111862">[</span><span class="ident" id="6111863">key</span><span class="op" id="6111866">]</span>&nbsp;<span class="op" id="6111868">=</span>&nbsp;<span class="ident" id="6111870">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6111875">}</span><br>
<span class="lineno">65</span><span class="op" id="6111877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6111880">//&nbsp;response&nbsp;implements&nbsp;http.ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="6111924">type</span>&nbsp;<span class="ident" id="6111929">response</span>&nbsp;<span class="keyword" id="6111938">struct</span>&nbsp;<span class="op" id="6111945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111948">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6111960">*</span><span class="ident" id="6111961">request</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111970">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111982">http</span><span class="op" id="6111986">.</span><span class="ident" id="6111987">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6111995">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6112007">*</span><span class="ident" id="6112008">bufWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112019">wroteHeader</span>&nbsp;<span class="builtintype" id="6112031">bool</span><br>
<span class="lineno"></span><span class="op" id="6112036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="6112039">func</span>&nbsp;<span class="ident" id="6112044">newResponse</span><span class="op" id="6112055">(</span><span class="ident" id="6112056">c</span>&nbsp;<span class="op" id="6112058">*</span><span class="ident" id="6112059">child</span><span class="op" id="6112064">,</span>&nbsp;<span class="ident" id="6112066">req</span>&nbsp;<span class="op" id="6112070">*</span><span class="ident" id="6112071">request</span><span class="op" id="6112078">)</span>&nbsp;<span class="op" id="6112080">*</span><span class="ident" id="6112081">response</span>&nbsp;<span class="op" id="6112090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6112093">return</span>&nbsp;<span class="op" id="6112100">&amp;</span><span class="ident" id="6112101">response</span><span class="op" id="6112109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112113">req</span><span class="op" id="6112116">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112121">req</span><span class="op" id="6112124">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112128">header</span><span class="op" id="6112134">:</span>&nbsp;<span class="ident" id="6112136">http</span><span class="op" id="6112140">.</span><span class="ident" id="6112141">Header</span><span class="op" id="6112147">{</span><span class="op" id="6112148">}</span><span class="op" id="6112149">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112153">w</span><span class="op" id="6112154">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112161">newWriter</span><span class="op" id="6112170">(</span><span class="ident" id="6112171">c</span><span class="op" id="6112172">.</span><span class="ident" id="6112173">conn</span><span class="op" id="6112177">,</span>&nbsp;<span class="ident" id="6112179">typeStdout</span><span class="op" id="6112189">,</span>&nbsp;<span class="ident" id="6112191">req</span><span class="op" id="6112194">.</span><span class="ident" id="6112195">reqId</span><span class="op" id="6112200">)</span><span class="op" id="6112201">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6112204">}</span><br>
<span class="lineno"></span><span class="op" id="6112206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6112209">func</span>&nbsp;<span class="op" id="6112214">(</span><span class="ident" id="6112215">r</span>&nbsp;<span class="op" id="6112217">*</span><span class="ident" id="6112218">response</span><span class="op" id="6112226">)</span>&nbsp;<span class="ident" id="6112228">Header</span><span class="op" id="6112234">(</span><span class="op" id="6112235">)</span>&nbsp;<span class="ident" id="6112237">http</span><span class="op" id="6112241">.</span><span class="ident" id="6112242">Header</span>&nbsp;<span class="op" id="6112249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6112252">return</span>&nbsp;<span class="ident" id="6112259">r</span><span class="op" id="6112260">.</span><span class="ident" id="6112261">header</span><br>
<span class="lineno">85</span><span class="op" id="6112268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6112271">func</span>&nbsp;<span class="op" id="6112276">(</span><span class="ident" id="6112277">r</span>&nbsp;<span class="op" id="6112279">*</span><span class="ident" id="6112280">response</span><span class="op" id="6112288">)</span>&nbsp;<span class="ident" id="6112290">Write</span><span class="op" id="6112295">(</span><span class="ident" id="6112296">data</span>&nbsp;<span class="op" id="6112301">[</span><span class="op" id="6112302">]</span><span class="builtintype" id="6112303">byte</span><span class="op" id="6112307">)</span>&nbsp;<span class="op" id="6112309">(</span><span class="builtintype" id="6112310">int</span><span class="op" id="6112313">,</span>&nbsp;<span class="builtintype" id="6112315">error</span><span class="op" id="6112320">)</span>&nbsp;<span class="op" id="6112322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6112325">if</span>&nbsp;<span class="op" id="6112328">!</span><span class="ident" id="6112329">r</span><span class="op" id="6112330">.</span><span class="ident" id="6112331">wroteHeader</span>&nbsp;<span class="op" id="6112343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112347">r</span><span class="op" id="6112348">.</span><span class="ident" id="6112349">WriteHeader</span><span class="op" id="6112360">(</span><span class="ident" id="6112361">http</span><span class="op" id="6112365">.</span><span class="ident" id="6112366">StatusOK</span><span class="op" id="6112374">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6112377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6112380">return</span>&nbsp;<span class="ident" id="6112387">r</span><span class="op" id="6112388">.</span><span class="ident" id="6112389">w</span><span class="op" id="6112390">.</span><span class="ident" id="6112391">Write</span><span class="op" id="6112396">(</span><span class="ident" id="6112397">data</span><span class="op" id="6112401">)</span><br>
<span class="lineno"></span><span class="op" id="6112403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6112406">func</span>&nbsp;<span class="op" id="6112411">(</span><span class="ident" id="6112412">r</span>&nbsp;<span class="op" id="6112414">*</span><span class="ident" id="6112415">response</span><span class="op" id="6112423">)</span>&nbsp;<span class="ident" id="6112425">WriteHeader</span><span class="op" id="6112436">(</span><span class="ident" id="6112437">code</span>&nbsp;<span class="builtintype" id="6112442">int</span><span class="op" id="6112445">)</span>&nbsp;<span class="op" id="6112447">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6112450">if</span>&nbsp;<span class="ident" id="6112453">r</span><span class="op" id="6112454">.</span><span class="ident" id="6112455">wroteHeader</span>&nbsp;<span class="op" id="6112467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6112471">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6112479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112482">r</span><span class="op" id="6112483">.</span><span class="ident" id="6112484">wroteHeader</span>&nbsp;<span class="op" id="6112496">=</span>&nbsp;<span class="builtintype" id="6112498">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6112504">if</span>&nbsp;<span class="ident" id="6112507">code</span>&nbsp;<span class="op" id="6112512">==</span>&nbsp;<span class="ident" id="6112515">http</span><span class="op" id="6112519">.</span><span class="ident" id="6112520">StatusNotModified</span>&nbsp;<span class="op" id="6112538">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6112542">//&nbsp;Must&nbsp;not&nbsp;have&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112567">r</span><span class="op" id="6112568">.</span><span class="ident" id="6112569">header</span><span class="op" id="6112575">.</span><span class="ident" id="6112576">Del</span><span class="op" id="6112579">(</span><span class="string" id="6112580">&#34;Content-Type&#34;</span><span class="op" id="6112594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112598">r</span><span class="op" id="6112599">.</span><span class="ident" id="6112600">header</span><span class="op" id="6112606">.</span><span class="ident" id="6112607">Del</span><span class="op" id="6112610">(</span><span class="string" id="6112611">&#34;Content-Length&#34;</span><span class="op" id="6112627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112631">r</span><span class="op" id="6112632">.</span><span class="ident" id="6112633">header</span><span class="op" id="6112639">.</span><span class="ident" id="6112640">Del</span><span class="op" id="6112643">(</span><span class="string" id="6112644">&#34;Transfer-Encoding&#34;</span><span class="op" id="6112663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6112666">}</span>&nbsp;<span class="keyword" id="6112668">else</span>&nbsp;<span class="keyword" id="6112673">if</span>&nbsp;<span class="ident" id="6112676">r</span><span class="op" id="6112677">.</span><span class="ident" id="6112678">header</span><span class="op" id="6112684">.</span><span class="ident" id="6112685">Get</span><span class="op" id="6112688">(</span><span class="string" id="6112689">&#34;Content-Type&#34;</span><span class="op" id="6112703">)</span>&nbsp;<span class="op" id="6112705">==</span>&nbsp;<span class="string" id="6112708">&#34;&#34;</span>&nbsp;<span class="op" id="6112711">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112715">r</span><span class="op" id="6112716">.</span><span class="ident" id="6112717">header</span><span class="op" id="6112723">.</span><span class="ident" id="6112724">Set</span><span class="op" id="6112727">(</span><span class="string" id="6112728">&#34;Content-Type&#34;</span><span class="op" id="6112742">,</span>&nbsp;<span class="string" id="6112744">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="6112770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6112773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6112777">if</span>&nbsp;<span class="ident" id="6112780">r</span><span class="op" id="6112781">.</span><span class="ident" id="6112782">header</span><span class="op" id="6112788">.</span><span class="ident" id="6112789">Get</span><span class="op" id="6112792">(</span><span class="string" id="6112793">&#34;Date&#34;</span><span class="op" id="6112799">)</span>&nbsp;<span class="op" id="6112801">==</span>&nbsp;<span class="string" id="6112804">&#34;&#34;</span>&nbsp;<span class="op" id="6112807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112811">r</span><span class="op" id="6112812">.</span><span class="ident" id="6112813">header</span><span class="op" id="6112819">.</span><span class="ident" id="6112820">Set</span><span class="op" id="6112823">(</span><span class="string" id="6112824">&#34;Date&#34;</span><span class="op" id="6112830">,</span>&nbsp;<span class="ident" id="6112832">time</span><span class="op" id="6112836">.</span><span class="ident" id="6112837">Now</span><span class="op" id="6112840">(</span><span class="op" id="6112841">)</span><span class="op" id="6112842">.</span><span class="ident" id="6112843">UTC</span><span class="op" id="6112846">(</span><span class="op" id="6112847">)</span><span class="op" id="6112848">.</span><span class="ident" id="6112849">Format</span><span class="op" id="6112855">(</span><span class="ident" id="6112856">http</span><span class="op" id="6112860">.</span><span class="ident" id="6112861">TimeFormat</span><span class="op" id="6112871">)</span><span class="op" id="6112872">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6112875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112879">fmt</span><span class="op" id="6112882">.</span><span class="ident" id="6112883">Fprintf</span><span class="op" id="6112890">(</span><span class="ident" id="6112891">r</span><span class="op" id="6112892">.</span><span class="ident" id="6112893">w</span><span class="op" id="6112894">,</span>&nbsp;<span class="string" id="6112896">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="6112915">,</span>&nbsp;<span class="ident" id="6112917">code</span><span class="op" id="6112921">,</span>&nbsp;<span class="ident" id="6112923">http</span><span class="op" id="6112927">.</span><span class="ident" id="6112928">StatusText</span><span class="op" id="6112938">(</span><span class="ident" id="6112939">code</span><span class="op" id="6112943">)</span><span class="op" id="6112944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112947">r</span><span class="op" id="6112948">.</span><span class="ident" id="6112949">header</span><span class="op" id="6112955">.</span><span class="ident" id="6112956">Write</span><span class="op" id="6112961">(</span><span class="ident" id="6112962">r</span><span class="op" id="6112963">.</span><span class="ident" id="6112964">w</span><span class="op" id="6112965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6112968">r</span><span class="op" id="6112969">.</span><span class="ident" id="6112970">w</span><span class="op" id="6112971">.</span><span class="ident" id="6112972">WriteString</span><span class="op" id="6112983">(</span><span class="string" id="6112984">&#34;\r\n&#34;</span><span class="op" id="6112990">)</span><br>
<span class="lineno">115</span><span class="op" id="6112992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6112995">func</span>&nbsp;<span class="op" id="6113000">(</span><span class="ident" id="6113001">r</span>&nbsp;<span class="op" id="6113003">*</span><span class="ident" id="6113004">response</span><span class="op" id="6113012">)</span>&nbsp;<span class="ident" id="6113014">Flush</span><span class="op" id="6113019">(</span><span class="op" id="6113020">)</span>&nbsp;<span class="op" id="6113022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6113025">if</span>&nbsp;<span class="op" id="6113028">!</span><span class="ident" id="6113029">r</span><span class="op" id="6113030">.</span><span class="ident" id="6113031">wroteHeader</span>&nbsp;<span class="op" id="6113043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113047">r</span><span class="op" id="6113048">.</span><span class="ident" id="6113049">WriteHeader</span><span class="op" id="6113060">(</span><span class="ident" id="6113061">http</span><span class="op" id="6113065">.</span><span class="ident" id="6113066">StatusOK</span><span class="op" id="6113074">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6113077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113080">r</span><span class="op" id="6113081">.</span><span class="ident" id="6113082">w</span><span class="op" id="6113083">.</span><span class="ident" id="6113084">Flush</span><span class="op" id="6113089">(</span><span class="op" id="6113090">)</span><br>
<span class="lineno"></span><span class="op" id="6113092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6113095">func</span>&nbsp;<span class="op" id="6113100">(</span><span class="ident" id="6113101">r</span>&nbsp;<span class="op" id="6113103">*</span><span class="ident" id="6113104">response</span><span class="op" id="6113112">)</span>&nbsp;<span class="ident" id="6113114">Close</span><span class="op" id="6113119">(</span><span class="op" id="6113120">)</span>&nbsp;<span class="builtintype" id="6113122">error</span>&nbsp;<span class="op" id="6113128">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113131">r</span><span class="op" id="6113132">.</span><span class="ident" id="6113133">Flush</span><span class="op" id="6113138">(</span><span class="op" id="6113139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6113142">return</span>&nbsp;<span class="ident" id="6113149">r</span><span class="op" id="6113150">.</span><span class="ident" id="6113151">w</span><span class="op" id="6113152">.</span><span class="ident" id="6113153">Close</span><span class="op" id="6113158">(</span><span class="op" id="6113159">)</span><br>
<span class="lineno"></span><span class="op" id="6113161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6113164">type</span>&nbsp;<span class="ident" id="6113169">child</span>&nbsp;<span class="keyword" id="6113175">struct</span>&nbsp;<span class="op" id="6113182">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113185">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6113193">*</span><span class="ident" id="6113194">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113200">handler</span>&nbsp;<span class="ident" id="6113208">http</span><span class="op" id="6113212">.</span><span class="ident" id="6113213">Handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113223">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113232">sync</span><span class="op" id="6113236">.</span><span class="ident" id="6113237">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6113252">//&nbsp;protects&nbsp;requests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113275">requests</span>&nbsp;<span class="keyword" id="6113284">map</span><span class="op" id="6113287">[</span><span class="builtintype" id="6113288">uint16</span><span class="op" id="6113294">]</span><span class="op" id="6113295">*</span><span class="ident" id="6113296">request</span>&nbsp;<span class="comment" id="6113304">//&nbsp;keyed&nbsp;by&nbsp;request&nbsp;ID</span><br>
<span class="lineno">135</span><span class="op" id="6113327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6113330">func</span>&nbsp;<span class="ident" id="6113335">newChild</span><span class="op" id="6113343">(</span><span class="ident" id="6113344">rwc</span>&nbsp;<span class="ident" id="6113348">io</span><span class="op" id="6113350">.</span><span class="ident" id="6113351">ReadWriteCloser</span><span class="op" id="6113366">,</span>&nbsp;<span class="ident" id="6113368">handler</span>&nbsp;<span class="ident" id="6113376">http</span><span class="op" id="6113380">.</span><span class="ident" id="6113381">Handler</span><span class="op" id="6113388">)</span>&nbsp;<span class="op" id="6113390">*</span><span class="ident" id="6113391">child</span>&nbsp;<span class="op" id="6113397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6113400">return</span>&nbsp;<span class="op" id="6113407">&amp;</span><span class="ident" id="6113408">child</span><span class="op" id="6113413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113417">conn</span><span class="op" id="6113421">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113427">newConn</span><span class="op" id="6113434">(</span><span class="ident" id="6113435">rwc</span><span class="op" id="6113438">)</span><span class="op" id="6113439">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113443">handler</span><span class="op" id="6113450">:</span>&nbsp;&nbsp;<span class="ident" id="6113453">handler</span><span class="op" id="6113460">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113464">requests</span><span class="op" id="6113472">:</span>&nbsp;<span class="builtinfunc" id="6113474">make</span><span class="op" id="6113478">(</span><span class="keyword" id="6113479">map</span><span class="op" id="6113482">[</span><span class="builtintype" id="6113483">uint16</span><span class="op" id="6113489">]</span><span class="op" id="6113490">*</span><span class="ident" id="6113491">request</span><span class="op" id="6113498">)</span><span class="op" id="6113499">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6113502">}</span><br>
<span class="lineno"></span><span class="op" id="6113504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="6113507">func</span>&nbsp;<span class="op" id="6113512">(</span><span class="ident" id="6113513">c</span>&nbsp;<span class="op" id="6113515">*</span><span class="ident" id="6113516">child</span><span class="op" id="6113521">)</span>&nbsp;<span class="ident" id="6113523">serve</span><span class="op" id="6113528">(</span><span class="op" id="6113529">)</span>&nbsp;<span class="op" id="6113531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6113534">defer</span>&nbsp;<span class="ident" id="6113540">c</span><span class="op" id="6113541">.</span><span class="ident" id="6113542">conn</span><span class="op" id="6113546">.</span><span class="ident" id="6113547">Close</span><span class="op" id="6113552">(</span><span class="op" id="6113553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6113556">var</span>&nbsp;<span class="ident" id="6113560">rec</span>&nbsp;<span class="ident" id="6113564">record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6113572">for</span>&nbsp;<span class="op" id="6113576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6113580">if</span>&nbsp;<span class="ident" id="6113583">err</span>&nbsp;<span class="op" id="6113587">:=</span>&nbsp;<span class="ident" id="6113590">rec</span><span class="op" id="6113593">.</span><span class="ident" id="6113594">read</span><span class="op" id="6113598">(</span><span class="ident" id="6113599">c</span><span class="op" id="6113600">.</span><span class="ident" id="6113601">conn</span><span class="op" id="6113605">.</span><span class="ident" id="6113606">rwc</span><span class="op" id="6113609">)</span><span class="op" id="6113610">;</span>&nbsp;<span class="ident" id="6113612">err</span>&nbsp;<span class="op" id="6113616">!=</span>&nbsp;<span class="builtintype" id="6113619">nil</span>&nbsp;<span class="op" id="6113623">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6113628">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6113637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6113641">if</span>&nbsp;<span class="ident" id="6113644">err</span>&nbsp;<span class="op" id="6113648">:=</span>&nbsp;<span class="ident" id="6113651">c</span><span class="op" id="6113652">.</span><span class="ident" id="6113653">handleRecord</span><span class="op" id="6113665">(</span><span class="op" id="6113666">&amp;</span><span class="ident" id="6113667">rec</span><span class="op" id="6113670">)</span><span class="op" id="6113671">;</span>&nbsp;<span class="ident" id="6113673">err</span>&nbsp;<span class="op" id="6113677">!=</span>&nbsp;<span class="builtintype" id="6113680">nil</span>&nbsp;<span class="op" id="6113684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6113689">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6113698">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6113701">}</span><br>
<span class="lineno"></span><span class="op" id="6113703">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6113706">var</span>&nbsp;<span class="ident" id="6113710">errCloseConn</span>&nbsp;<span class="op" id="6113723">=</span>&nbsp;<span class="ident" id="6113725">errors</span><span class="op" id="6113731">.</span><span class="ident" id="6113732">New</span><span class="op" id="6113735">(</span><span class="string" id="6113736">&#34;fcgi:&nbsp;connection&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="6113771">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="6113774">var</span>&nbsp;<span class="ident" id="6113778">emptyBody</span>&nbsp;<span class="op" id="6113788">=</span>&nbsp;<span class="ident" id="6113790">ioutil</span><span class="op" id="6113796">.</span><span class="ident" id="6113797">NopCloser</span><span class="op" id="6113806">(</span><span class="ident" id="6113807">strings</span><span class="op" id="6113814">.</span><span class="ident" id="6113815">NewReader</span><span class="op" id="6113824">(</span><span class="string" id="6113825">&#34;&#34;</span><span class="op" id="6113827">)</span><span class="op" id="6113828">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6113831">func</span>&nbsp;<span class="op" id="6113836">(</span><span class="ident" id="6113837">c</span>&nbsp;<span class="op" id="6113839">*</span><span class="ident" id="6113840">child</span><span class="op" id="6113845">)</span>&nbsp;<span class="ident" id="6113847">handleRecord</span><span class="op" id="6113859">(</span><span class="ident" id="6113860">rec</span>&nbsp;<span class="op" id="6113864">*</span><span class="ident" id="6113865">record</span><span class="op" id="6113871">)</span>&nbsp;<span class="builtintype" id="6113873">error</span>&nbsp;<span class="op" id="6113879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113882">c</span><span class="op" id="6113883">.</span><span class="ident" id="6113884">mu</span><span class="op" id="6113886">.</span><span class="ident" id="6113887">Lock</span><span class="op" id="6113891">(</span><span class="op" id="6113892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113895">req</span><span class="op" id="6113898">,</span>&nbsp;<span class="ident" id="6113900">ok</span>&nbsp;<span class="op" id="6113903">:=</span>&nbsp;<span class="ident" id="6113906">c</span><span class="op" id="6113907">.</span><span class="ident" id="6113908">requests</span><span class="op" id="6113916">[</span><span class="ident" id="6113917">rec</span><span class="op" id="6113920">.</span><span class="ident" id="6113921">h</span><span class="op" id="6113922">.</span><span class="ident" id="6113923">Id</span><span class="op" id="6113925">]</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6113928">c</span><span class="op" id="6113929">.</span><span class="ident" id="6113930">mu</span><span class="op" id="6113932">.</span><span class="ident" id="6113933">Unlock</span><span class="op" id="6113939">(</span><span class="op" id="6113940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6113943">if</span>&nbsp;<span class="op" id="6113946">!</span><span class="ident" id="6113947">ok</span>&nbsp;<span class="op" id="6113950">&amp;&amp;</span>&nbsp;<span class="ident" id="6113953">rec</span><span class="op" id="6113956">.</span><span class="ident" id="6113957">h</span><span class="op" id="6113958">.</span><span class="ident" id="6113959">Type</span>&nbsp;<span class="op" id="6113964">!=</span>&nbsp;<span class="ident" id="6113967">typeBeginRequest</span>&nbsp;<span class="op" id="6113984">&amp;&amp;</span>&nbsp;<span class="ident" id="6113987">rec</span><span class="op" id="6113990">.</span><span class="ident" id="6113991">h</span><span class="op" id="6113992">.</span><span class="ident" id="6113993">Type</span>&nbsp;<span class="op" id="6113998">!=</span>&nbsp;<span class="ident" id="6114001">typeGetValues</span>&nbsp;<span class="op" id="6114015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6114019">//&nbsp;The&nbsp;spec&nbsp;says&nbsp;to&nbsp;ignore&nbsp;unknown&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114069">return</span>&nbsp;<span class="builtintype" id="6114076">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6114081">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114085">switch</span>&nbsp;<span class="ident" id="6114092">rec</span><span class="op" id="6114095">.</span><span class="ident" id="6114096">h</span><span class="op" id="6114097">.</span><span class="ident" id="6114098">Type</span>&nbsp;<span class="op" id="6114103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114106">case</span>&nbsp;<span class="ident" id="6114111">typeBeginRequest</span><span class="op" id="6114127">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114131">if</span>&nbsp;<span class="ident" id="6114134">req</span>&nbsp;<span class="op" id="6114138">!=</span>&nbsp;<span class="builtintype" id="6114141">nil</span>&nbsp;<span class="op" id="6114145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6114150">//&nbsp;The&nbsp;server&nbsp;is&nbsp;trying&nbsp;to&nbsp;begin&nbsp;a&nbsp;request&nbsp;with&nbsp;the&nbsp;same&nbsp;ID</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6114213">//&nbsp;as&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;This&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114264">return</span>&nbsp;<span class="ident" id="6114271">errors</span><span class="op" id="6114277">.</span><span class="ident" id="6114278">New</span><span class="op" id="6114281">(</span><span class="string" id="6114282">&#34;fcgi:&nbsp;received&nbsp;ID&nbsp;that&nbsp;is&nbsp;already&nbsp;in-flight&#34;</span><span class="op" id="6114327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6114331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114336">var</span>&nbsp;<span class="ident" id="6114340">br</span>&nbsp;<span class="ident" id="6114343">beginRequest</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114358">if</span>&nbsp;<span class="ident" id="6114361">err</span>&nbsp;<span class="op" id="6114365">:=</span>&nbsp;<span class="ident" id="6114368">br</span><span class="op" id="6114370">.</span><span class="ident" id="6114371">read</span><span class="op" id="6114375">(</span><span class="ident" id="6114376">rec</span><span class="op" id="6114379">.</span><span class="ident" id="6114380">content</span><span class="op" id="6114387">(</span><span class="op" id="6114388">)</span><span class="op" id="6114389">)</span><span class="op" id="6114390">;</span>&nbsp;<span class="ident" id="6114392">err</span>&nbsp;<span class="op" id="6114396">!=</span>&nbsp;<span class="builtintype" id="6114399">nil</span>&nbsp;<span class="op" id="6114403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114408">return</span>&nbsp;<span class="ident" id="6114415">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6114421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114425">if</span>&nbsp;<span class="ident" id="6114428">br</span><span class="op" id="6114430">.</span><span class="ident" id="6114431">role</span>&nbsp;<span class="op" id="6114436">!=</span>&nbsp;<span class="ident" id="6114439">roleResponder</span>&nbsp;<span class="op" id="6114453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114458">c</span><span class="op" id="6114459">.</span><span class="ident" id="6114460">conn</span><span class="op" id="6114464">.</span><span class="ident" id="6114465">writeEndRequest</span><span class="op" id="6114480">(</span><span class="ident" id="6114481">rec</span><span class="op" id="6114484">.</span><span class="ident" id="6114485">h</span><span class="op" id="6114486">.</span><span class="ident" id="6114487">Id</span><span class="op" id="6114489">,</span>&nbsp;<span class="num" id="6114491">0</span><span class="op" id="6114492">,</span>&nbsp;<span class="ident" id="6114494">statusUnknownRole</span><span class="op" id="6114511">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114516">return</span>&nbsp;<span class="builtintype" id="6114523">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6114529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114533">req</span>&nbsp;<span class="op" id="6114537">=</span>&nbsp;<span class="ident" id="6114539">newRequest</span><span class="op" id="6114549">(</span><span class="ident" id="6114550">rec</span><span class="op" id="6114553">.</span><span class="ident" id="6114554">h</span><span class="op" id="6114555">.</span><span class="ident" id="6114556">Id</span><span class="op" id="6114558">,</span>&nbsp;<span class="ident" id="6114560">br</span><span class="op" id="6114562">.</span><span class="ident" id="6114563">flags</span><span class="op" id="6114568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114572">c</span><span class="op" id="6114573">.</span><span class="ident" id="6114574">mu</span><span class="op" id="6114576">.</span><span class="ident" id="6114577">Lock</span><span class="op" id="6114581">(</span><span class="op" id="6114582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114586">c</span><span class="op" id="6114587">.</span><span class="ident" id="6114588">requests</span><span class="op" id="6114596">[</span><span class="ident" id="6114597">rec</span><span class="op" id="6114600">.</span><span class="ident" id="6114601">h</span><span class="op" id="6114602">.</span><span class="ident" id="6114603">Id</span><span class="op" id="6114605">]</span>&nbsp;<span class="op" id="6114607">=</span>&nbsp;<span class="ident" id="6114609">req</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114615">c</span><span class="op" id="6114616">.</span><span class="ident" id="6114617">mu</span><span class="op" id="6114619">.</span><span class="ident" id="6114620">Unlock</span><span class="op" id="6114626">(</span><span class="op" id="6114627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114631">return</span>&nbsp;<span class="builtintype" id="6114638">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114643">case</span>&nbsp;<span class="ident" id="6114648">typeParams</span><span class="op" id="6114658">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6114662">//&nbsp;NOTE(eds):&nbsp;Technically&nbsp;a&nbsp;key-value&nbsp;pair&nbsp;can&nbsp;straddle&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6114733">//&nbsp;between&nbsp;two&nbsp;packets.&nbsp;We&nbsp;buffer&nbsp;until&nbsp;we&#39;ve&nbsp;received&nbsp;all&nbsp;parameters.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114806">if</span>&nbsp;<span class="builtinfunc" id="6114809">len</span><span class="op" id="6114812">(</span><span class="ident" id="6114813">rec</span><span class="op" id="6114816">.</span><span class="ident" id="6114817">content</span><span class="op" id="6114824">(</span><span class="op" id="6114825">)</span><span class="op" id="6114826">)</span>&nbsp;<span class="op" id="6114828">&gt;</span>&nbsp;<span class="num" id="6114830">0</span>&nbsp;<span class="op" id="6114832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114837">req</span><span class="op" id="6114840">.</span><span class="ident" id="6114841">rawParams</span>&nbsp;<span class="op" id="6114851">=</span>&nbsp;<span class="builtinfunc" id="6114853">append</span><span class="op" id="6114859">(</span><span class="ident" id="6114860">req</span><span class="op" id="6114863">.</span><span class="ident" id="6114864">rawParams</span><span class="op" id="6114873">,</span>&nbsp;<span class="ident" id="6114875">rec</span><span class="op" id="6114878">.</span><span class="ident" id="6114879">content</span><span class="op" id="6114886">(</span><span class="op" id="6114887">)</span><span class="op" id="6114888">...</span><span class="op" id="6114891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114896">return</span>&nbsp;<span class="builtintype" id="6114903">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6114909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114913">req</span><span class="op" id="6114916">.</span><span class="ident" id="6114917">parseParams</span><span class="op" id="6114928">(</span><span class="op" id="6114929">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114933">return</span>&nbsp;<span class="builtintype" id="6114940">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114945">case</span>&nbsp;<span class="ident" id="6114950">typeStdin</span><span class="op" id="6114959">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6114963">content</span>&nbsp;<span class="op" id="6114971">:=</span>&nbsp;<span class="ident" id="6114974">rec</span><span class="op" id="6114977">.</span><span class="ident" id="6114978">content</span><span class="op" id="6114985">(</span><span class="op" id="6114986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6114990">if</span>&nbsp;<span class="ident" id="6114993">req</span><span class="op" id="6114996">.</span><span class="ident" id="6114997">pw</span>&nbsp;<span class="op" id="6115000">==</span>&nbsp;<span class="builtintype" id="6115003">nil</span>&nbsp;<span class="op" id="6115007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6115012">var</span>&nbsp;<span class="ident" id="6115016">body</span>&nbsp;<span class="ident" id="6115021">io</span><span class="op" id="6115023">.</span><span class="ident" id="6115024">ReadCloser</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6115038">if</span>&nbsp;<span class="builtinfunc" id="6115041">len</span><span class="op" id="6115044">(</span><span class="ident" id="6115045">content</span><span class="op" id="6115052">)</span>&nbsp;<span class="op" id="6115054">&gt;</span>&nbsp;<span class="num" id="6115056">0</span>&nbsp;<span class="op" id="6115058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6115064">//&nbsp;body&nbsp;could&nbsp;be&nbsp;an&nbsp;io.LimitReader,&nbsp;but&nbsp;it&nbsp;shouldn&#39;t&nbsp;matter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6115128">//&nbsp;as&nbsp;long&nbsp;as&nbsp;both&nbsp;sides&nbsp;are&nbsp;behaving.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115171">body</span><span class="op" id="6115175">,</span>&nbsp;<span class="ident" id="6115177">req</span><span class="op" id="6115180">.</span><span class="ident" id="6115181">pw</span>&nbsp;<span class="op" id="6115184">=</span>&nbsp;<span class="ident" id="6115186">io</span><span class="op" id="6115188">.</span><span class="ident" id="6115189">Pipe</span><span class="op" id="6115193">(</span><span class="op" id="6115194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6115199">}</span>&nbsp;<span class="keyword" id="6115201">else</span>&nbsp;<span class="op" id="6115206">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115212">body</span>&nbsp;<span class="op" id="6115217">=</span>&nbsp;<span class="ident" id="6115219">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6115232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6115237">go</span>&nbsp;<span class="ident" id="6115240">c</span><span class="op" id="6115241">.</span><span class="ident" id="6115242">serveRequest</span><span class="op" id="6115254">(</span><span class="ident" id="6115255">req</span><span class="op" id="6115258">,</span>&nbsp;<span class="ident" id="6115260">body</span><span class="op" id="6115264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6115268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6115272">if</span>&nbsp;<span class="builtinfunc" id="6115275">len</span><span class="op" id="6115278">(</span><span class="ident" id="6115279">content</span><span class="op" id="6115286">)</span>&nbsp;<span class="op" id="6115288">&gt;</span>&nbsp;<span class="num" id="6115290">0</span>&nbsp;<span class="op" id="6115292">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6115297">//&nbsp;TODO(eds):&nbsp;This&nbsp;blocks&nbsp;until&nbsp;the&nbsp;handler&nbsp;reads&nbsp;from&nbsp;the&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6115365">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;takes&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;might&nbsp;be&nbsp;a&nbsp;problem.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115428">req</span><span class="op" id="6115431">.</span><span class="ident" id="6115432">pw</span><span class="op" id="6115434">.</span><span class="ident" id="6115435">Write</span><span class="op" id="6115440">(</span><span class="ident" id="6115441">content</span><span class="op" id="6115448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6115452">}</span>&nbsp;<span class="keyword" id="6115454">else</span>&nbsp;<span class="keyword" id="6115459">if</span>&nbsp;<span class="ident" id="6115462">req</span><span class="op" id="6115465">.</span><span class="ident" id="6115466">pw</span>&nbsp;<span class="op" id="6115469">!=</span>&nbsp;<span class="builtintype" id="6115472">nil</span>&nbsp;<span class="op" id="6115476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115481">req</span><span class="op" id="6115484">.</span><span class="ident" id="6115485">pw</span><span class="op" id="6115487">.</span><span class="ident" id="6115488">Close</span><span class="op" id="6115493">(</span><span class="op" id="6115494">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6115498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6115502">return</span>&nbsp;<span class="builtintype" id="6115509">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6115514">case</span>&nbsp;<span class="ident" id="6115519">typeGetValues</span><span class="op" id="6115532">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115536">values</span>&nbsp;<span class="op" id="6115543">:=</span>&nbsp;<span class="keyword" id="6115546">map</span><span class="op" id="6115549">[</span><span class="builtintype" id="6115550">string</span><span class="op" id="6115556">]</span><span class="builtintype" id="6115557">string</span><span class="op" id="6115563">{</span><span class="string" id="6115564">&#34;FCGI_MPXS_CONNS&#34;</span><span class="op" id="6115581">:</span>&nbsp;<span class="string" id="6115583">&#34;1&#34;</span><span class="op" id="6115586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115590">c</span><span class="op" id="6115591">.</span><span class="ident" id="6115592">conn</span><span class="op" id="6115596">.</span><span class="ident" id="6115597">writePairs</span><span class="op" id="6115607">(</span><span class="ident" id="6115608">typeGetValuesResult</span><span class="op" id="6115627">,</span>&nbsp;<span class="num" id="6115629">0</span><span class="op" id="6115630">,</span>&nbsp;<span class="ident" id="6115632">values</span><span class="op" id="6115638">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6115642">return</span>&nbsp;<span class="builtintype" id="6115649">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6115654">case</span>&nbsp;<span class="ident" id="6115659">typeData</span><span class="op" id="6115667">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6115671">//&nbsp;If&nbsp;the&nbsp;filter&nbsp;role&nbsp;is&nbsp;implemented,&nbsp;read&nbsp;the&nbsp;data&nbsp;stream&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6115738">return</span>&nbsp;<span class="builtintype" id="6115745">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6115750">case</span>&nbsp;<span class="ident" id="6115755">typeAbortRequest</span><span class="op" id="6115771">:</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6115775">println</span><span class="op" id="6115782">(</span><span class="string" id="6115783">&#34;abort&#34;</span><span class="op" id="6115790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115794">c</span><span class="op" id="6115795">.</span><span class="ident" id="6115796">mu</span><span class="op" id="6115798">.</span><span class="ident" id="6115799">Lock</span><span class="op" id="6115803">(</span><span class="op" id="6115804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6115808">delete</span><span class="op" id="6115814">(</span><span class="ident" id="6115815">c</span><span class="op" id="6115816">.</span><span class="ident" id="6115817">requests</span><span class="op" id="6115825">,</span>&nbsp;<span class="ident" id="6115827">rec</span><span class="op" id="6115830">.</span><span class="ident" id="6115831">h</span><span class="op" id="6115832">.</span><span class="ident" id="6115833">Id</span><span class="op" id="6115835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115839">c</span><span class="op" id="6115840">.</span><span class="ident" id="6115841">mu</span><span class="op" id="6115843">.</span><span class="ident" id="6115844">Unlock</span><span class="op" id="6115850">(</span><span class="op" id="6115851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6115855">c</span><span class="op" id="6115856">.</span><span class="ident" id="6115857">conn</span><span class="op" id="6115861">.</span><span class="ident" id="6115862">writeEndRequest</span><span class="op" id="6115877">(</span><span class="ident" id="6115878">rec</span><span class="op" id="6115881">.</span><span class="ident" id="6115882">h</span><span class="op" id="6115883">.</span><span class="ident" id="6115884">Id</span><span class="op" id="6115886">,</span>&nbsp;<span class="num" id="6115888">0</span><span class="op" id="6115889">,</span>&nbsp;<span class="ident" id="6115891">statusRequestComplete</span><span class="op" id="6115912">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6115916">if</span>&nbsp;<span class="op" id="6115919">!</span><span class="ident" id="6115920">req</span><span class="op" id="6115923">.</span><span class="ident" id="6115924">keepConn</span>&nbsp;<span class="op" id="6115933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6115938">//&nbsp;connection&nbsp;will&nbsp;close&nbsp;upon&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6115978">return</span>&nbsp;<span class="ident" id="6115985">errCloseConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6116000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6116004">return</span>&nbsp;<span class="builtintype" id="6116011">nil</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6116016">default</span><span class="op" id="6116023">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116027">b</span>&nbsp;<span class="op" id="6116029">:=</span>&nbsp;<span class="builtinfunc" id="6116032">make</span><span class="op" id="6116036">(</span><span class="op" id="6116037">[</span><span class="op" id="6116038">]</span><span class="builtintype" id="6116039">byte</span><span class="op" id="6116043">,</span>&nbsp;<span class="num" id="6116045">8</span><span class="op" id="6116046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116050">b</span><span class="op" id="6116051">[</span><span class="num" id="6116052">0</span><span class="op" id="6116053">]</span>&nbsp;<span class="op" id="6116055">=</span>&nbsp;<span class="builtintype" id="6116057">byte</span><span class="op" id="6116061">(</span><span class="ident" id="6116062">rec</span><span class="op" id="6116065">.</span><span class="ident" id="6116066">h</span><span class="op" id="6116067">.</span><span class="ident" id="6116068">Type</span><span class="op" id="6116072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116076">c</span><span class="op" id="6116077">.</span><span class="ident" id="6116078">conn</span><span class="op" id="6116082">.</span><span class="ident" id="6116083">writeRecord</span><span class="op" id="6116094">(</span><span class="ident" id="6116095">typeUnknownType</span><span class="op" id="6116110">,</span>&nbsp;<span class="num" id="6116112">0</span><span class="op" id="6116113">,</span>&nbsp;<span class="ident" id="6116115">b</span><span class="op" id="6116116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6116120">return</span>&nbsp;<span class="builtintype" id="6116127">nil</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6116132">}</span><br>
<span class="lineno"></span><span class="op" id="6116134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6116137">func</span>&nbsp;<span class="op" id="6116142">(</span><span class="ident" id="6116143">c</span>&nbsp;<span class="op" id="6116145">*</span><span class="ident" id="6116146">child</span><span class="op" id="6116151">)</span>&nbsp;<span class="ident" id="6116153">serveRequest</span><span class="op" id="6116165">(</span><span class="ident" id="6116166">req</span>&nbsp;<span class="op" id="6116170">*</span><span class="ident" id="6116171">request</span><span class="op" id="6116178">,</span>&nbsp;<span class="ident" id="6116180">body</span>&nbsp;<span class="ident" id="6116185">io</span><span class="op" id="6116187">.</span><span class="ident" id="6116188">ReadCloser</span><span class="op" id="6116198">)</span>&nbsp;<span class="op" id="6116200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116203">r</span>&nbsp;<span class="op" id="6116205">:=</span>&nbsp;<span class="ident" id="6116208">newResponse</span><span class="op" id="6116219">(</span><span class="ident" id="6116220">c</span><span class="op" id="6116221">,</span>&nbsp;<span class="ident" id="6116223">req</span><span class="op" id="6116226">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116229">httpReq</span><span class="op" id="6116236">,</span>&nbsp;<span class="ident" id="6116238">err</span>&nbsp;<span class="op" id="6116242">:=</span>&nbsp;<span class="ident" id="6116245">cgi</span><span class="op" id="6116248">.</span><span class="ident" id="6116249">RequestFromMap</span><span class="op" id="6116263">(</span><span class="ident" id="6116264">req</span><span class="op" id="6116267">.</span><span class="ident" id="6116268">params</span><span class="op" id="6116274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6116277">if</span>&nbsp;<span class="ident" id="6116280">err</span>&nbsp;<span class="op" id="6116284">!=</span>&nbsp;<span class="builtintype" id="6116287">nil</span>&nbsp;<span class="op" id="6116291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6116295">//&nbsp;there&nbsp;was&nbsp;an&nbsp;error&nbsp;reading&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116339">r</span><span class="op" id="6116340">.</span><span class="ident" id="6116341">WriteHeader</span><span class="op" id="6116352">(</span><span class="ident" id="6116353">http</span><span class="op" id="6116357">.</span><span class="ident" id="6116358">StatusInternalServerError</span><span class="op" id="6116383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116387">c</span><span class="op" id="6116388">.</span><span class="ident" id="6116389">conn</span><span class="op" id="6116393">.</span><span class="ident" id="6116394">writeRecord</span><span class="op" id="6116405">(</span><span class="ident" id="6116406">typeStderr</span><span class="op" id="6116416">,</span>&nbsp;<span class="ident" id="6116418">req</span><span class="op" id="6116421">.</span><span class="ident" id="6116422">reqId</span><span class="op" id="6116427">,</span>&nbsp;<span class="op" id="6116429">[</span><span class="op" id="6116430">]</span><span class="builtintype" id="6116431">byte</span><span class="op" id="6116435">(</span><span class="ident" id="6116436">err</span><span class="op" id="6116439">.</span><span class="ident" id="6116440">Error</span><span class="op" id="6116445">(</span><span class="op" id="6116446">)</span><span class="op" id="6116447">)</span><span class="op" id="6116448">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6116451">}</span>&nbsp;<span class="keyword" id="6116453">else</span>&nbsp;<span class="op" id="6116458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116462">httpReq</span><span class="op" id="6116469">.</span><span class="ident" id="6116470">Body</span>&nbsp;<span class="op" id="6116475">=</span>&nbsp;<span class="ident" id="6116477">body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116484">c</span><span class="op" id="6116485">.</span><span class="ident" id="6116486">handler</span><span class="op" id="6116493">.</span><span class="ident" id="6116494">ServeHTTP</span><span class="op" id="6116503">(</span><span class="ident" id="6116504">r</span><span class="op" id="6116505">,</span>&nbsp;<span class="ident" id="6116507">httpReq</span><span class="op" id="6116514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6116517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116520">r</span><span class="op" id="6116521">.</span><span class="ident" id="6116522">Close</span><span class="op" id="6116527">(</span><span class="op" id="6116528">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116531">c</span><span class="op" id="6116532">.</span><span class="ident" id="6116533">mu</span><span class="op" id="6116535">.</span><span class="ident" id="6116536">Lock</span><span class="op" id="6116540">(</span><span class="op" id="6116541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6116544">delete</span><span class="op" id="6116550">(</span><span class="ident" id="6116551">c</span><span class="op" id="6116552">.</span><span class="ident" id="6116553">requests</span><span class="op" id="6116561">,</span>&nbsp;<span class="ident" id="6116563">req</span><span class="op" id="6116566">.</span><span class="ident" id="6116567">reqId</span><span class="op" id="6116572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116575">c</span><span class="op" id="6116576">.</span><span class="ident" id="6116577">mu</span><span class="op" id="6116579">.</span><span class="ident" id="6116580">Unlock</span><span class="op" id="6116586">(</span><span class="op" id="6116587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6116590">c</span><span class="op" id="6116591">.</span><span class="ident" id="6116592">conn</span><span class="op" id="6116596">.</span><span class="ident" id="6116597">writeEndRequest</span><span class="op" id="6116612">(</span><span class="ident" id="6116613">req</span><span class="op" id="6116616">.</span><span class="ident" id="6116617">reqId</span><span class="op" id="6116622">,</span>&nbsp;<span class="num" id="6116624">0</span><span class="op" id="6116625">,</span>&nbsp;<span class="ident" id="6116627">statusRequestComplete</span><span class="op" id="6116648">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6116652">//&nbsp;Consume&nbsp;the&nbsp;entire&nbsp;body,&nbsp;so&nbsp;the&nbsp;host&nbsp;isn&#39;t&nbsp;still&nbsp;writing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6116716">//&nbsp;us&nbsp;when&nbsp;we&nbsp;close&nbsp;the&nbsp;socket&nbsp;below&nbsp;in&nbsp;the&nbsp;!keepConn&nbsp;case,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6116777">//&nbsp;otherwise&nbsp;we&#39;d&nbsp;send&nbsp;a&nbsp;RST.&nbsp;(golang.org/issue/4183)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6116832">//&nbsp;TODO(bradfitz):&nbsp;also&nbsp;bound&nbsp;this&nbsp;copy&nbsp;in&nbsp;time.&nbsp;Or&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6116890">//&nbsp;some&nbsp;sort&nbsp;of&nbsp;abort&nbsp;request&nbsp;to&nbsp;the&nbsp;host,&nbsp;so&nbsp;the&nbsp;host</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6116946">//&nbsp;can&nbsp;properly&nbsp;cut&nbsp;off&nbsp;the&nbsp;client&nbsp;sending&nbsp;all&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6117004">//&nbsp;For&nbsp;now&nbsp;just&nbsp;bound&nbsp;it&nbsp;a&nbsp;little&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6117043">io</span><span class="op" id="6117045">.</span><span class="ident" id="6117046">CopyN</span><span class="op" id="6117051">(</span><span class="ident" id="6117052">ioutil</span><span class="op" id="6117058">.</span><span class="ident" id="6117059">Discard</span><span class="op" id="6117066">,</span>&nbsp;<span class="ident" id="6117068">body</span><span class="op" id="6117072">,</span>&nbsp;<span class="num" id="6117074">100</span><span class="op" id="6117077">&lt;&lt;</span><span class="num" id="6117079">20</span><span class="op" id="6117081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6117084">body</span><span class="op" id="6117088">.</span><span class="ident" id="6117089">Close</span><span class="op" id="6117094">(</span><span class="op" id="6117095">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6117099">if</span>&nbsp;<span class="op" id="6117102">!</span><span class="ident" id="6117103">req</span><span class="op" id="6117106">.</span><span class="ident" id="6117107">keepConn</span>&nbsp;<span class="op" id="6117116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6117120">c</span><span class="op" id="6117121">.</span><span class="ident" id="6117122">conn</span><span class="op" id="6117126">.</span><span class="ident" id="6117127">Close</span><span class="op" id="6117132">(</span><span class="op" id="6117133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6117136">}</span><br>
<span class="lineno"></span><span class="op" id="6117138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="6117141">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;FastCGI&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,&nbsp;creating&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="6117221">//&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;The&nbsp;goroutine&nbsp;reads&nbsp;requests&nbsp;and&nbsp;then&nbsp;calls&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="6117296">//&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="6117317">//&nbsp;If&nbsp;l&nbsp;is&nbsp;nil,&nbsp;Serve&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;os.Stdin.</span><br>
<span class="lineno"></span><span class="comment" id="6117374">//&nbsp;If&nbsp;handler&nbsp;is&nbsp;nil,&nbsp;http.DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno">285</span><span class="keyword" id="6117426">func</span>&nbsp;<span class="ident" id="6117431">Serve</span><span class="op" id="6117436">(</span><span class="ident" id="6117437">l</span>&nbsp;<span class="ident" id="6117439">net</span><span class="op" id="6117442">.</span><span class="ident" id="6117443">Listener</span><span class="op" id="6117451">,</span>&nbsp;<span class="ident" id="6117453">handler</span>&nbsp;<span class="ident" id="6117461">http</span><span class="op" id="6117465">.</span><span class="ident" id="6117466">Handler</span><span class="op" id="6117473">)</span>&nbsp;<span class="builtintype" id="6117475">error</span>&nbsp;<span class="op" id="6117481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6117484">if</span>&nbsp;<span class="ident" id="6117487">l</span>&nbsp;<span class="op" id="6117489">==</span>&nbsp;<span class="builtintype" id="6117492">nil</span>&nbsp;<span class="op" id="6117496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6117500">var</span>&nbsp;<span class="ident" id="6117504">err</span>&nbsp;<span class="builtintype" id="6117508">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6117516">l</span><span class="op" id="6117517">,</span>&nbsp;<span class="ident" id="6117519">err</span>&nbsp;<span class="op" id="6117523">=</span>&nbsp;<span class="ident" id="6117525">net</span><span class="op" id="6117528">.</span><span class="ident" id="6117529">FileListener</span><span class="op" id="6117541">(</span><span class="ident" id="6117542">os</span><span class="op" id="6117544">.</span><span class="ident" id="6117545">Stdin</span><span class="op" id="6117550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6117554">if</span>&nbsp;<span class="ident" id="6117557">err</span>&nbsp;<span class="op" id="6117561">!=</span>&nbsp;<span class="builtintype" id="6117564">nil</span>&nbsp;<span class="op" id="6117568">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6117573">return</span>&nbsp;<span class="ident" id="6117580">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6117586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6117590">defer</span>&nbsp;<span class="ident" id="6117596">l</span><span class="op" id="6117597">.</span><span class="ident" id="6117598">Close</span><span class="op" id="6117603">(</span><span class="op" id="6117604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6117607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6117610">if</span>&nbsp;<span class="ident" id="6117613">handler</span>&nbsp;<span class="op" id="6117621">==</span>&nbsp;<span class="builtintype" id="6117624">nil</span>&nbsp;<span class="op" id="6117628">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6117632">handler</span>&nbsp;<span class="op" id="6117640">=</span>&nbsp;<span class="ident" id="6117642">http</span><span class="op" id="6117646">.</span><span class="ident" id="6117647">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6117664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6117667">for</span>&nbsp;<span class="op" id="6117671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6117675">rw</span><span class="op" id="6117677">,</span>&nbsp;<span class="ident" id="6117679">err</span>&nbsp;<span class="op" id="6117683">:=</span>&nbsp;<span class="ident" id="6117686">l</span><span class="op" id="6117687">.</span><span class="ident" id="6117688">Accept</span><span class="op" id="6117694">(</span><span class="op" id="6117695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6117699">if</span>&nbsp;<span class="ident" id="6117702">err</span>&nbsp;<span class="op" id="6117706">!=</span>&nbsp;<span class="builtintype" id="6117709">nil</span>&nbsp;<span class="op" id="6117713">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6117718">return</span>&nbsp;<span class="ident" id="6117725">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6117731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6117735">c</span>&nbsp;<span class="op" id="6117737">:=</span>&nbsp;<span class="ident" id="6117740">newChild</span><span class="op" id="6117748">(</span><span class="ident" id="6117749">rw</span><span class="op" id="6117751">,</span>&nbsp;<span class="ident" id="6117753">handler</span><span class="op" id="6117760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6117764">go</span>&nbsp;<span class="ident" id="6117767">c</span><span class="op" id="6117768">.</span><span class="ident" id="6117769">serve</span><span class="op" id="6117774">(</span><span class="op" id="6117775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6117778">}</span><br>
<span class="lineno">305</span><span class="op" id="6117780">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
