<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3046505">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3046560">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3046614">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3046665">//&nbsp;HTTP&nbsp;Response&nbsp;reading&nbsp;and&nbsp;parsing.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3046704">package</span>&nbsp;<span class="ident" id="3046712">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3046718">import</span>&nbsp;<span class="op" id="3046725">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3046728">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3046737">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3046746">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3046760">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3046770">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3046776">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3046793">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3046804">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3046815">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="3046825">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3046828">var</span>&nbsp;<span class="ident" id="3046832">respExcludeHeader</span>&nbsp;<span class="op" id="3046850">=</span>&nbsp;<span class="keyword" id="3046852">map</span><span class="op" id="3046855">[</span><span class="builtintype" id="3046856">string</span><span class="op" id="3046862">]</span><span class="builtintype" id="3046863">bool</span><span class="op" id="3046867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3046870">&#34;Content-Length&#34;</span><span class="op" id="3046886">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3046891">true</span><span class="op" id="3046895">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3046898">&#34;Transfer-Encoding&#34;</span><span class="op" id="3046917">:</span>&nbsp;<span class="builtintype" id="3046919">true</span><span class="op" id="3046923">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3046926">&#34;Trailer&#34;</span><span class="op" id="3046935">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3046947">true</span><span class="op" id="3046951">,</span><br>
<span class="lineno">25</span><span class="op" id="3046953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3046956">//&nbsp;Response&nbsp;represents&nbsp;the&nbsp;response&nbsp;from&nbsp;an&nbsp;HTTP&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="3047014">//</span><br>
<span class="lineno"></span><span class="keyword" id="3047017">type</span>&nbsp;<span class="ident" id="3047022">Response</span>&nbsp;<span class="keyword" id="3047031">struct</span>&nbsp;<span class="op" id="3047038">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3047041">Status</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3047052">string</span>&nbsp;<span class="comment" id="3047059">//&nbsp;e.g.&nbsp;&#34;200&nbsp;OK&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3047077">StatusCode</span>&nbsp;<span class="builtintype" id="3047088">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3047095">//&nbsp;e.g.&nbsp;200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3047108">Proto</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3047119">string</span>&nbsp;<span class="comment" id="3047126">//&nbsp;e.g.&nbsp;&#34;HTTP/1.0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3047146">ProtoMajor</span>&nbsp;<span class="builtintype" id="3047157">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3047164">//&nbsp;e.g.&nbsp;1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3047175">ProtoMinor</span>&nbsp;<span class="builtintype" id="3047186">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3047193">//&nbsp;e.g.&nbsp;0</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3047205">//&nbsp;Header&nbsp;maps&nbsp;header&nbsp;keys&nbsp;to&nbsp;values.&nbsp;&nbsp;If&nbsp;the&nbsp;response&nbsp;had&nbsp;multiple</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3047274">//&nbsp;headers&nbsp;with&nbsp;the&nbsp;same&nbsp;key,&nbsp;they&nbsp;may&nbsp;be&nbsp;concatenated,&nbsp;with&nbsp;comma</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3047342">//&nbsp;delimiters.&nbsp;&nbsp;(Section&nbsp;4.2&nbsp;of&nbsp;RFC&nbsp;2616&nbsp;requires&nbsp;that&nbsp;multiple&nbsp;headers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3047415">//&nbsp;be&nbsp;semantically&nbsp;equivalent&nbsp;to&nbsp;a&nbsp;comma-delimited&nbsp;sequence.)&nbsp;Values</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3047485">//&nbsp;duplicated&nbsp;by&nbsp;other&nbsp;fields&nbsp;in&nbsp;this&nbsp;struct&nbsp;(e.g.,&nbsp;ContentLength)&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3047557">//&nbsp;omitted&nbsp;from&nbsp;Header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3047582">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3047586">//&nbsp;Keys&nbsp;in&nbsp;the&nbsp;map&nbsp;are&nbsp;canonicalized&nbsp;(see&nbsp;CanonicalHeaderKey).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3047650">Header</span>&nbsp;<span class="ident" id="3047657">Header</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3047666">//&nbsp;Body&nbsp;represents&nbsp;the&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3047705">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3047709">//&nbsp;The&nbsp;http&nbsp;Client&nbsp;and&nbsp;Transport&nbsp;guarantee&nbsp;that&nbsp;Body&nbsp;is&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3047773">//&nbsp;non-nil,&nbsp;even&nbsp;on&nbsp;responses&nbsp;without&nbsp;a&nbsp;body&nbsp;or&nbsp;responses&nbsp;with</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3047837">//&nbsp;a&nbsp;zero-length&nbsp;body.&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3047898">//&nbsp;close&nbsp;Body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3047914">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3047918">//&nbsp;The&nbsp;Body&nbsp;is&nbsp;automatically&nbsp;dechunked&nbsp;if&nbsp;the&nbsp;server&nbsp;replied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3047980">//&nbsp;with&nbsp;a&nbsp;&#34;chunked&#34;&nbsp;Transfer-Encoding.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3048020">Body</span>&nbsp;<span class="ident" id="3048025">io</span><span class="op" id="3048027">.</span><span class="ident" id="3048028">ReadCloser</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3048041">//&nbsp;ContentLength&nbsp;records&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;associated&nbsp;content.&nbsp;&nbsp;The</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3048110">//&nbsp;value&nbsp;-1&nbsp;indicates&nbsp;that&nbsp;the&nbsp;length&nbsp;is&nbsp;unknown.&nbsp;&nbsp;Unless&nbsp;Request.Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3048184">//&nbsp;is&nbsp;&#34;HEAD&#34;,&nbsp;values&nbsp;&gt;=&nbsp;0&nbsp;indicate&nbsp;that&nbsp;the&nbsp;given&nbsp;number&nbsp;of&nbsp;bytes&nbsp;may</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3048255">//&nbsp;be&nbsp;read&nbsp;from&nbsp;Body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3048278">ContentLength</span>&nbsp;<span class="ident" id="3048292">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3048300">//&nbsp;Contains&nbsp;transfer&nbsp;encodings&nbsp;from&nbsp;outer-most&nbsp;to&nbsp;inner-most.&nbsp;Value&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3048372">//&nbsp;nil,&nbsp;means&nbsp;that&nbsp;&#34;identity&#34;&nbsp;encoding&nbsp;is&nbsp;used.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3048421">TransferEncoding</span>&nbsp;<span class="op" id="3048438">[</span><span class="op" id="3048439">]</span><span class="builtintype" id="3048440">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3048449">//&nbsp;Close&nbsp;records&nbsp;whether&nbsp;the&nbsp;header&nbsp;directed&nbsp;that&nbsp;the&nbsp;connection&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3048518">//&nbsp;closed&nbsp;after&nbsp;reading&nbsp;Body.&nbsp;&nbsp;The&nbsp;value&nbsp;is&nbsp;advice&nbsp;for&nbsp;clients:&nbsp;neither</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3048591">//&nbsp;ReadResponse&nbsp;nor&nbsp;Response.Write&nbsp;ever&nbsp;closes&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3048653">Close</span>&nbsp;<span class="builtintype" id="3048659">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3048666">//&nbsp;Trailer&nbsp;maps&nbsp;trailer&nbsp;keys&nbsp;to&nbsp;values,&nbsp;in&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3048719">//&nbsp;format&nbsp;as&nbsp;the&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3048745">Trailer</span>&nbsp;<span class="ident" id="3048753">Header</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3048762">//&nbsp;The&nbsp;Request&nbsp;that&nbsp;was&nbsp;sent&nbsp;to&nbsp;obtain&nbsp;this&nbsp;Response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3048817">//&nbsp;Request&#39;s&nbsp;Body&nbsp;is&nbsp;nil&nbsp;(having&nbsp;already&nbsp;been&nbsp;consumed).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3048875">//&nbsp;This&nbsp;is&nbsp;only&nbsp;populated&nbsp;for&nbsp;Client&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3048923">Request</span>&nbsp;<span class="op" id="3048931">*</span><span class="ident" id="3048932">Request</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3048942">//&nbsp;TLS&nbsp;contains&nbsp;information&nbsp;about&nbsp;the&nbsp;TLS&nbsp;connection&nbsp;on&nbsp;which&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3049009">//&nbsp;response&nbsp;was&nbsp;received.&nbsp;It&nbsp;is&nbsp;nil&nbsp;for&nbsp;unencrypted&nbsp;responses.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3049073">//&nbsp;The&nbsp;pointer&nbsp;is&nbsp;shared&nbsp;between&nbsp;responses&nbsp;and&nbsp;should&nbsp;not&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3049135">//&nbsp;modified.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3049149">TLS</span>&nbsp;<span class="op" id="3049153">*</span><span class="ident" id="3049154">tls</span><span class="op" id="3049157">.</span><span class="ident" id="3049158">ConnectionState</span><br>
<span class="lineno"></span><span class="op" id="3049174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3049177">//&nbsp;Cookies&nbsp;parses&nbsp;and&nbsp;returns&nbsp;the&nbsp;cookies&nbsp;set&nbsp;in&nbsp;the&nbsp;Set-Cookie&nbsp;headers.</span><br>
<span class="lineno"></span><span class="keyword" id="3049250">func</span>&nbsp;<span class="op" id="3049255">(</span><span class="ident" id="3049256">r</span>&nbsp;<span class="op" id="3049258">*</span><span class="ident" id="3049259">Response</span><span class="op" id="3049267">)</span>&nbsp;<span class="ident" id="3049269">Cookies</span><span class="op" id="3049276">(</span><span class="op" id="3049277">)</span>&nbsp;<span class="op" id="3049279">[</span><span class="op" id="3049280">]</span><span class="op" id="3049281">*</span><span class="ident" id="3049282">Cookie</span>&nbsp;<span class="op" id="3049289">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3049292">return</span>&nbsp;<span class="ident" id="3049299">readSetCookies</span><span class="op" id="3049313">(</span><span class="ident" id="3049314">r</span><span class="op" id="3049315">.</span><span class="ident" id="3049316">Header</span><span class="op" id="3049322">)</span><br>
<span class="lineno"></span><span class="op" id="3049324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3049327">var</span>&nbsp;<span class="ident" id="3049331">ErrNoLocation</span>&nbsp;<span class="op" id="3049345">=</span>&nbsp;<span class="ident" id="3049347">errors</span><span class="op" id="3049353">.</span><span class="ident" id="3049354">New</span><span class="op" id="3049357">(</span><span class="string" id="3049358">&#34;http:&nbsp;no&nbsp;Location&nbsp;header&nbsp;in&nbsp;response&#34;</span><span class="op" id="3049396">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="3049399">//&nbsp;Location&nbsp;returns&nbsp;the&nbsp;URL&nbsp;of&nbsp;the&nbsp;response&#39;s&nbsp;&#34;Location&#34;&nbsp;header,</span><br>
<span class="lineno"></span><span class="comment" id="3049464">//&nbsp;if&nbsp;present.&nbsp;&nbsp;Relative&nbsp;redirects&nbsp;are&nbsp;resolved&nbsp;relative&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3049524">//&nbsp;the&nbsp;Response&#39;s&nbsp;Request.&nbsp;&nbsp;ErrNoLocation&nbsp;is&nbsp;returned&nbsp;if&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="3049584">//&nbsp;Location&nbsp;header&nbsp;is&nbsp;present.</span><br>
<span class="lineno"></span><span class="keyword" id="3049615">func</span>&nbsp;<span class="op" id="3049620">(</span><span class="ident" id="3049621">r</span>&nbsp;<span class="op" id="3049623">*</span><span class="ident" id="3049624">Response</span><span class="op" id="3049632">)</span>&nbsp;<span class="ident" id="3049634">Location</span><span class="op" id="3049642">(</span><span class="op" id="3049643">)</span>&nbsp;<span class="op" id="3049645">(</span><span class="op" id="3049646">*</span><span class="ident" id="3049647">url</span><span class="op" id="3049650">.</span><span class="ident" id="3049651">URL</span><span class="op" id="3049654">,</span>&nbsp;<span class="builtintype" id="3049656">error</span><span class="op" id="3049661">)</span>&nbsp;<span class="op" id="3049663">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3049666">lv</span>&nbsp;<span class="op" id="3049669">:=</span>&nbsp;<span class="ident" id="3049672">r</span><span class="op" id="3049673">.</span><span class="ident" id="3049674">Header</span><span class="op" id="3049680">.</span><span class="ident" id="3049681">Get</span><span class="op" id="3049684">(</span><span class="string" id="3049685">&#34;Location&#34;</span><span class="op" id="3049695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3049698">if</span>&nbsp;<span class="ident" id="3049701">lv</span>&nbsp;<span class="op" id="3049704">==</span>&nbsp;<span class="string" id="3049707">&#34;&#34;</span>&nbsp;<span class="op" id="3049710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3049714">return</span>&nbsp;<span class="ident" id="3049721">nil</span><span class="op" id="3049724">,</span>&nbsp;<span class="ident" id="3049726">ErrNoLocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3049741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3049744">if</span>&nbsp;<span class="ident" id="3049747">r</span><span class="op" id="3049748">.</span><span class="ident" id="3049749">Request</span>&nbsp;<span class="op" id="3049757">!=</span>&nbsp;<span class="ident" id="3049760">nil</span>&nbsp;<span class="op" id="3049764">&amp;&amp;</span>&nbsp;<span class="ident" id="3049767">r</span><span class="op" id="3049768">.</span><span class="ident" id="3049769">Request</span><span class="op" id="3049776">.</span><span class="ident" id="3049777">URL</span>&nbsp;<span class="op" id="3049781">!=</span>&nbsp;<span class="ident" id="3049784">nil</span>&nbsp;<span class="op" id="3049788">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3049792">return</span>&nbsp;<span class="ident" id="3049799">r</span><span class="op" id="3049800">.</span><span class="ident" id="3049801">Request</span><span class="op" id="3049808">.</span><span class="ident" id="3049809">URL</span><span class="op" id="3049812">.</span><span class="ident" id="3049813">Parse</span><span class="op" id="3049818">(</span><span class="ident" id="3049819">lv</span><span class="op" id="3049821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3049824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3049827">return</span>&nbsp;<span class="ident" id="3049834">url</span><span class="op" id="3049837">.</span><span class="ident" id="3049838">Parse</span><span class="op" id="3049843">(</span><span class="ident" id="3049844">lv</span><span class="op" id="3049846">)</span><br>
<span class="lineno"></span><span class="op" id="3049848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="3049851">//&nbsp;ReadResponse&nbsp;reads&nbsp;and&nbsp;returns&nbsp;an&nbsp;HTTP&nbsp;response&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="3049910">//&nbsp;The&nbsp;req&nbsp;parameter&nbsp;optionally&nbsp;specifies&nbsp;the&nbsp;Request&nbsp;that&nbsp;corresponds</span><br>
<span class="lineno"></span><span class="comment" id="3049981">//&nbsp;to&nbsp;this&nbsp;Response.&nbsp;If&nbsp;nil,&nbsp;a&nbsp;GET&nbsp;request&nbsp;is&nbsp;assumed.</span><br>
<span class="lineno"></span><span class="comment" id="3050036">//&nbsp;Clients&nbsp;must&nbsp;call&nbsp;resp.Body.Close&nbsp;when&nbsp;finished&nbsp;reading&nbsp;resp.Body.</span><br>
<span class="lineno"></span><span class="comment" id="3050106">//&nbsp;After&nbsp;that&nbsp;call,&nbsp;clients&nbsp;can&nbsp;inspect&nbsp;resp.Trailer&nbsp;to&nbsp;find&nbsp;key/value</span><br>
<span class="lineno">115</span><span class="comment" id="3050177">//&nbsp;pairs&nbsp;included&nbsp;in&nbsp;the&nbsp;response&nbsp;trailer.</span><br>
<span class="lineno"></span><span class="keyword" id="3050220">func</span>&nbsp;<span class="ident" id="3050225">ReadResponse</span><span class="op" id="3050237">(</span><span class="ident" id="3050238">r</span>&nbsp;<span class="op" id="3050240">*</span><span class="ident" id="3050241">bufio</span><span class="op" id="3050246">.</span><span class="ident" id="3050247">Reader</span><span class="op" id="3050253">,</span>&nbsp;<span class="ident" id="3050255">req</span>&nbsp;<span class="op" id="3050259">*</span><span class="ident" id="3050260">Request</span><span class="op" id="3050267">)</span>&nbsp;<span class="op" id="3050269">(</span><span class="op" id="3050270">*</span><span class="ident" id="3050271">Response</span><span class="op" id="3050279">,</span>&nbsp;<span class="builtintype" id="3050281">error</span><span class="op" id="3050286">)</span>&nbsp;<span class="op" id="3050288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3050291">tp</span>&nbsp;<span class="op" id="3050294">:=</span>&nbsp;<span class="ident" id="3050297">textproto</span><span class="op" id="3050306">.</span><span class="ident" id="3050307">NewReader</span><span class="op" id="3050316">(</span><span class="ident" id="3050317">r</span><span class="op" id="3050318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3050321">resp</span>&nbsp;<span class="op" id="3050326">:=</span>&nbsp;<span class="op" id="3050329">&amp;</span><span class="ident" id="3050330">Response</span><span class="op" id="3050338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3050342">Request</span><span class="op" id="3050349">:</span>&nbsp;<span class="ident" id="3050351">req</span><span class="op" id="3050354">,</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3050357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3050361">//&nbsp;Parse&nbsp;the&nbsp;first&nbsp;line&nbsp;of&nbsp;the&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3050403">line</span><span class="op" id="3050407">,</span>&nbsp;<span class="ident" id="3050409">err</span>&nbsp;<span class="op" id="3050413">:=</span>&nbsp;<span class="ident" id="3050416">tp</span><span class="op" id="3050418">.</span><span class="ident" id="3050419">ReadLine</span><span class="op" id="3050427">(</span><span class="op" id="3050428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3050431">if</span>&nbsp;<span class="ident" id="3050434">err</span>&nbsp;<span class="op" id="3050438">!=</span>&nbsp;<span class="ident" id="3050441">nil</span>&nbsp;<span class="op" id="3050445">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3050449">if</span>&nbsp;<span class="ident" id="3050452">err</span>&nbsp;<span class="op" id="3050456">==</span>&nbsp;<span class="ident" id="3050459">io</span><span class="op" id="3050461">.</span><span class="ident" id="3050462">EOF</span>&nbsp;<span class="op" id="3050466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3050471">err</span>&nbsp;<span class="op" id="3050475">=</span>&nbsp;<span class="ident" id="3050477">io</span><span class="op" id="3050479">.</span><span class="ident" id="3050480">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3050499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3050503">return</span>&nbsp;<span class="ident" id="3050510">nil</span><span class="op" id="3050513">,</span>&nbsp;<span class="ident" id="3050515">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3050520">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3050523">f</span>&nbsp;<span class="op" id="3050525">:=</span>&nbsp;<span class="ident" id="3050528">strings</span><span class="op" id="3050535">.</span><span class="ident" id="3050536">SplitN</span><span class="op" id="3050542">(</span><span class="ident" id="3050543">line</span><span class="op" id="3050547">,</span>&nbsp;<span class="string" id="3050549">&#34;&nbsp;&#34;</span><span class="op" id="3050552">,</span>&nbsp;<span class="num" id="3050554">3</span><span class="op" id="3050555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3050558">if</span>&nbsp;<span class="builtinfunc" id="3050561">len</span><span class="op" id="3050564">(</span><span class="ident" id="3050565">f</span><span class="op" id="3050566">)</span>&nbsp;<span class="op" id="3050568">&lt;</span>&nbsp;<span class="num" id="3050570">2</span>&nbsp;<span class="op" id="3050572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3050576">return</span>&nbsp;<span class="ident" id="3050583">nil</span><span class="op" id="3050586">,</span>&nbsp;<span class="op" id="3050588">&amp;</span><span class="ident" id="3050589">badStringError</span><span class="op" id="3050603">{</span><span class="string" id="3050604">&#34;malformed&nbsp;HTTP&nbsp;response&#34;</span><span class="op" id="3050629">,</span>&nbsp;<span class="ident" id="3050631">line</span><span class="op" id="3050635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3050638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3050641">reasonPhrase</span>&nbsp;<span class="op" id="3050654">:=</span>&nbsp;<span class="string" id="3050657">&#34;&#34;</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3050661">if</span>&nbsp;<span class="builtinfunc" id="3050664">len</span><span class="op" id="3050667">(</span><span class="ident" id="3050668">f</span><span class="op" id="3050669">)</span>&nbsp;<span class="op" id="3050671">&gt;</span>&nbsp;<span class="num" id="3050673">2</span>&nbsp;<span class="op" id="3050675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3050679">reasonPhrase</span>&nbsp;<span class="op" id="3050692">=</span>&nbsp;<span class="ident" id="3050694">f</span><span class="op" id="3050695">[</span><span class="num" id="3050696">2</span><span class="op" id="3050697">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3050700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3050703">resp</span><span class="op" id="3050707">.</span><span class="ident" id="3050708">Status</span>&nbsp;<span class="op" id="3050715">=</span>&nbsp;<span class="ident" id="3050717">f</span><span class="op" id="3050718">[</span><span class="num" id="3050719">1</span><span class="op" id="3050720">]</span>&nbsp;<span class="op" id="3050722">+</span>&nbsp;<span class="string" id="3050724">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="3050728">+</span>&nbsp;<span class="ident" id="3050730">reasonPhrase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3050744">resp</span><span class="op" id="3050748">.</span><span class="ident" id="3050749">StatusCode</span><span class="op" id="3050759">,</span>&nbsp;<span class="ident" id="3050761">err</span>&nbsp;<span class="op" id="3050765">=</span>&nbsp;<span class="ident" id="3050767">strconv</span><span class="op" id="3050774">.</span><span class="ident" id="3050775">Atoi</span><span class="op" id="3050779">(</span><span class="ident" id="3050780">f</span><span class="op" id="3050781">[</span><span class="num" id="3050782">1</span><span class="op" id="3050783">]</span><span class="op" id="3050784">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3050787">if</span>&nbsp;<span class="ident" id="3050790">err</span>&nbsp;<span class="op" id="3050794">!=</span>&nbsp;<span class="ident" id="3050797">nil</span>&nbsp;<span class="op" id="3050801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3050805">return</span>&nbsp;<span class="ident" id="3050812">nil</span><span class="op" id="3050815">,</span>&nbsp;<span class="op" id="3050817">&amp;</span><span class="ident" id="3050818">badStringError</span><span class="op" id="3050832">{</span><span class="string" id="3050833">&#34;malformed&nbsp;HTTP&nbsp;status&nbsp;code&#34;</span><span class="op" id="3050861">,</span>&nbsp;<span class="ident" id="3050863">f</span><span class="op" id="3050864">[</span><span class="num" id="3050865">1</span><span class="op" id="3050866">]</span><span class="op" id="3050867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3050870">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3050874">resp</span><span class="op" id="3050878">.</span><span class="ident" id="3050879">Proto</span>&nbsp;<span class="op" id="3050885">=</span>&nbsp;<span class="ident" id="3050887">f</span><span class="op" id="3050888">[</span><span class="num" id="3050889">0</span><span class="op" id="3050890">]</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3050893">var</span>&nbsp;<span class="ident" id="3050897">ok</span>&nbsp;<span class="builtintype" id="3050900">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3050906">if</span>&nbsp;<span class="ident" id="3050909">resp</span><span class="op" id="3050913">.</span><span class="ident" id="3050914">ProtoMajor</span><span class="op" id="3050924">,</span>&nbsp;<span class="ident" id="3050926">resp</span><span class="op" id="3050930">.</span><span class="ident" id="3050931">ProtoMinor</span><span class="op" id="3050941">,</span>&nbsp;<span class="ident" id="3050943">ok</span>&nbsp;<span class="op" id="3050946">=</span>&nbsp;<span class="ident" id="3050948">ParseHTTPVersion</span><span class="op" id="3050964">(</span><span class="ident" id="3050965">resp</span><span class="op" id="3050969">.</span><span class="ident" id="3050970">Proto</span><span class="op" id="3050975">)</span><span class="op" id="3050976">;</span>&nbsp;<span class="op" id="3050978">!</span><span class="ident" id="3050979">ok</span>&nbsp;<span class="op" id="3050982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3050986">return</span>&nbsp;<span class="ident" id="3050993">nil</span><span class="op" id="3050996">,</span>&nbsp;<span class="op" id="3050998">&amp;</span><span class="ident" id="3050999">badStringError</span><span class="op" id="3051013">{</span><span class="string" id="3051014">&#34;malformed&nbsp;HTTP&nbsp;version&#34;</span><span class="op" id="3051038">,</span>&nbsp;<span class="ident" id="3051040">resp</span><span class="op" id="3051044">.</span><span class="ident" id="3051045">Proto</span><span class="op" id="3051050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3051053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3051057">//&nbsp;Parse&nbsp;the&nbsp;response&nbsp;headers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3051089">mimeHeader</span><span class="op" id="3051099">,</span>&nbsp;<span class="ident" id="3051101">err</span>&nbsp;<span class="op" id="3051105">:=</span>&nbsp;<span class="ident" id="3051108">tp</span><span class="op" id="3051110">.</span><span class="ident" id="3051111">ReadMIMEHeader</span><span class="op" id="3051125">(</span><span class="op" id="3051126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3051129">if</span>&nbsp;<span class="ident" id="3051132">err</span>&nbsp;<span class="op" id="3051136">!=</span>&nbsp;<span class="ident" id="3051139">nil</span>&nbsp;<span class="op" id="3051143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3051147">if</span>&nbsp;<span class="ident" id="3051150">err</span>&nbsp;<span class="op" id="3051154">==</span>&nbsp;<span class="ident" id="3051157">io</span><span class="op" id="3051159">.</span><span class="ident" id="3051160">EOF</span>&nbsp;<span class="op" id="3051164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3051169">err</span>&nbsp;<span class="op" id="3051173">=</span>&nbsp;<span class="ident" id="3051175">io</span><span class="op" id="3051177">.</span><span class="ident" id="3051178">ErrUnexpectedEOF</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3051197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3051201">return</span>&nbsp;<span class="ident" id="3051208">nil</span><span class="op" id="3051211">,</span>&nbsp;<span class="ident" id="3051213">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3051218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3051221">resp</span><span class="op" id="3051225">.</span><span class="ident" id="3051226">Header</span>&nbsp;<span class="op" id="3051233">=</span>&nbsp;<span class="ident" id="3051235">Header</span><span class="op" id="3051241">(</span><span class="ident" id="3051242">mimeHeader</span><span class="op" id="3051252">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3051256">fixPragmaCacheControl</span><span class="op" id="3051277">(</span><span class="ident" id="3051278">resp</span><span class="op" id="3051282">.</span><span class="ident" id="3051283">Header</span><span class="op" id="3051289">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3051293">err</span>&nbsp;<span class="op" id="3051297">=</span>&nbsp;<span class="ident" id="3051299">readTransfer</span><span class="op" id="3051311">(</span><span class="ident" id="3051312">resp</span><span class="op" id="3051316">,</span>&nbsp;<span class="ident" id="3051318">r</span><span class="op" id="3051319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3051322">if</span>&nbsp;<span class="ident" id="3051325">err</span>&nbsp;<span class="op" id="3051329">!=</span>&nbsp;<span class="ident" id="3051332">nil</span>&nbsp;<span class="op" id="3051336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3051340">return</span>&nbsp;<span class="ident" id="3051347">nil</span><span class="op" id="3051350">,</span>&nbsp;<span class="ident" id="3051352">err</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3051357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3051361">return</span>&nbsp;<span class="ident" id="3051368">resp</span><span class="op" id="3051372">,</span>&nbsp;<span class="ident" id="3051374">nil</span><br>
<span class="lineno"></span><span class="op" id="3051378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="3051381">//&nbsp;RFC2616:&nbsp;Should&nbsp;treat</span><br>
<span class="lineno"></span><span class="comment" id="3051406">//&nbsp;&nbsp;&nbsp;&nbspPragma:&nbsp;no-cache</span><br>
<span class="lineno"></span><span class="comment" id="3051426">//&nbsp;like</span><br>
<span class="lineno"></span><span class="comment" id="3051434">//&nbsp;&nbsp;&nbsp;&nbspCache-Control:&nbsp;no-cache</span><br>
<span class="lineno"></span><span class="keyword" id="3051461">func</span>&nbsp;<span class="ident" id="3051466">fixPragmaCacheControl</span><span class="op" id="3051487">(</span><span class="ident" id="3051488">header</span>&nbsp;<span class="ident" id="3051495">Header</span><span class="op" id="3051501">)</span>&nbsp;<span class="op" id="3051503">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3051506">if</span>&nbsp;<span class="ident" id="3051509">hp</span><span class="op" id="3051511">,</span>&nbsp;<span class="ident" id="3051513">ok</span>&nbsp;<span class="op" id="3051516">:=</span>&nbsp;<span class="ident" id="3051519">header</span><span class="op" id="3051525">[</span><span class="string" id="3051526">&#34;Pragma&#34;</span><span class="op" id="3051534">]</span><span class="op" id="3051535">;</span>&nbsp;<span class="ident" id="3051537">ok</span>&nbsp;<span class="op" id="3051540">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3051543">len</span><span class="op" id="3051546">(</span><span class="ident" id="3051547">hp</span><span class="op" id="3051549">)</span>&nbsp;<span class="op" id="3051551">&gt;</span>&nbsp;<span class="num" id="3051553">0</span>&nbsp;<span class="op" id="3051555">&amp;&amp;</span>&nbsp;<span class="ident" id="3051558">hp</span><span class="op" id="3051560">[</span><span class="num" id="3051561">0</span><span class="op" id="3051562">]</span>&nbsp;<span class="op" id="3051564">==</span>&nbsp;<span class="string" id="3051567">&#34;no-cache&#34;</span>&nbsp;<span class="op" id="3051578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3051582">if</span>&nbsp;<span class="ident" id="3051585">_</span><span class="op" id="3051586">,</span>&nbsp;<span class="ident" id="3051588">presentcc</span>&nbsp;<span class="op" id="3051598">:=</span>&nbsp;<span class="ident" id="3051601">header</span><span class="op" id="3051607">[</span><span class="string" id="3051608">&#34;Cache-Control&#34;</span><span class="op" id="3051623">]</span><span class="op" id="3051624">;</span>&nbsp;<span class="op" id="3051626">!</span><span class="ident" id="3051627">presentcc</span>&nbsp;<span class="op" id="3051637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3051642">header</span><span class="op" id="3051648">[</span><span class="string" id="3051649">&#34;Cache-Control&#34;</span><span class="op" id="3051664">]</span>&nbsp;<span class="op" id="3051666">=</span>&nbsp;<span class="op" id="3051668">[</span><span class="op" id="3051669">]</span><span class="builtintype" id="3051670">string</span><span class="op" id="3051676">{</span><span class="string" id="3051677">&#34;no-cache&#34;</span><span class="op" id="3051687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3051691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3051694">}</span><br>
<span class="lineno">180</span><span class="op" id="3051696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3051699">//&nbsp;ProtoAtLeast&nbsp;reports&nbsp;whether&nbsp;the&nbsp;HTTP&nbsp;protocol&nbsp;used</span><br>
<span class="lineno"></span><span class="comment" id="3051754">//&nbsp;in&nbsp;the&nbsp;response&nbsp;is&nbsp;at&nbsp;least&nbsp;major.minor.</span><br>
<span class="lineno"></span><span class="keyword" id="3051798">func</span>&nbsp;<span class="op" id="3051803">(</span><span class="ident" id="3051804">r</span>&nbsp;<span class="op" id="3051806">*</span><span class="ident" id="3051807">Response</span><span class="op" id="3051815">)</span>&nbsp;<span class="ident" id="3051817">ProtoAtLeast</span><span class="op" id="3051829">(</span><span class="ident" id="3051830">major</span><span class="op" id="3051835">,</span>&nbsp;<span class="ident" id="3051837">minor</span>&nbsp;<span class="builtintype" id="3051843">int</span><span class="op" id="3051846">)</span>&nbsp;<span class="builtintype" id="3051848">bool</span>&nbsp;<span class="op" id="3051853">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3051856">return</span>&nbsp;<span class="ident" id="3051863">r</span><span class="op" id="3051864">.</span><span class="ident" id="3051865">ProtoMajor</span>&nbsp;<span class="op" id="3051876">&gt;</span>&nbsp;<span class="ident" id="3051878">major</span>&nbsp;<span class="op" id="3051884">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3051889">r</span><span class="op" id="3051890">.</span><span class="ident" id="3051891">ProtoMajor</span>&nbsp;<span class="op" id="3051902">==</span>&nbsp;<span class="ident" id="3051905">major</span>&nbsp;<span class="op" id="3051911">&amp;&amp;</span>&nbsp;<span class="ident" id="3051914">r</span><span class="op" id="3051915">.</span><span class="ident" id="3051916">ProtoMinor</span>&nbsp;<span class="op" id="3051927">&gt;=</span>&nbsp;<span class="ident" id="3051930">minor</span><br>
<span class="lineno"></span><span class="op" id="3051936">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3051939">//&nbsp;Writes&nbsp;the&nbsp;response&nbsp;(header,&nbsp;body&nbsp;and&nbsp;trailer)&nbsp;in&nbsp;wire&nbsp;format.&nbsp;This&nbsp;method</span><br>
<span class="lineno">190</span><span class="comment" id="3052017">//&nbsp;consults&nbsp;the&nbsp;following&nbsp;fields&nbsp;of&nbsp;the&nbsp;response:</span><br>
<span class="lineno"></span><span class="comment" id="3052067">//</span><br>
<span class="lineno"></span><span class="comment" id="3052070">//&nbsp;&nbsp;StatusCode</span><br>
<span class="lineno"></span><span class="comment" id="3052085">//&nbsp;&nbsp;ProtoMajor</span><br>
<span class="lineno"></span><span class="comment" id="3052100">//&nbsp;&nbsp;ProtoMinor</span><br>
<span class="lineno">195</span><span class="comment" id="3052115">//&nbsp;&nbsp;Request.Method</span><br>
<span class="lineno"></span><span class="comment" id="3052134">//&nbsp;&nbsp;TransferEncoding</span><br>
<span class="lineno"></span><span class="comment" id="3052155">//&nbsp;&nbsp;Trailer</span><br>
<span class="lineno"></span><span class="comment" id="3052167">//&nbsp;&nbsp;Body</span><br>
<span class="lineno"></span><span class="comment" id="3052176">//&nbsp;&nbsp;ContentLength</span><br>
<span class="lineno">200</span><span class="comment" id="3052194">//&nbsp;&nbsp;Header,&nbsp;values&nbsp;for&nbsp;non-canonical&nbsp;keys&nbsp;will&nbsp;have&nbsp;unpredictable&nbsp;behavior</span><br>
<span class="lineno"></span><span class="comment" id="3052269">//</span><br>
<span class="lineno"></span><span class="comment" id="3052272">//&nbsp;Body&nbsp;is&nbsp;closed&nbsp;after&nbsp;it&nbsp;is&nbsp;sent.</span><br>
<span class="lineno"></span><span class="keyword" id="3052308">func</span>&nbsp;<span class="op" id="3052313">(</span><span class="ident" id="3052314">r</span>&nbsp;<span class="op" id="3052316">*</span><span class="ident" id="3052317">Response</span><span class="op" id="3052325">)</span>&nbsp;<span class="ident" id="3052327">Write</span><span class="op" id="3052332">(</span><span class="ident" id="3052333">w</span>&nbsp;<span class="ident" id="3052335">io</span><span class="op" id="3052337">.</span><span class="ident" id="3052338">Writer</span><span class="op" id="3052344">)</span>&nbsp;<span class="builtintype" id="3052346">error</span>&nbsp;<span class="op" id="3052352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3052355">//&nbsp;Status&nbsp;line</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3052371">text</span>&nbsp;<span class="op" id="3052376">:=</span>&nbsp;<span class="ident" id="3052379">r</span><span class="op" id="3052380">.</span><span class="ident" id="3052381">Status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3052389">if</span>&nbsp;<span class="ident" id="3052392">text</span>&nbsp;<span class="op" id="3052397">==</span>&nbsp;<span class="string" id="3052400">&#34;&#34;</span>&nbsp;<span class="op" id="3052403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3052407">var</span>&nbsp;<span class="ident" id="3052411">ok</span>&nbsp;<span class="builtintype" id="3052414">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3052421">text</span><span class="op" id="3052425">,</span>&nbsp;<span class="ident" id="3052427">ok</span>&nbsp;<span class="op" id="3052430">=</span>&nbsp;<span class="ident" id="3052432">statusText</span><span class="op" id="3052442">[</span><span class="ident" id="3052443">r</span><span class="op" id="3052444">.</span><span class="ident" id="3052445">StatusCode</span><span class="op" id="3052455">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3052459">if</span>&nbsp;<span class="op" id="3052462">!</span><span class="ident" id="3052463">ok</span>&nbsp;<span class="op" id="3052466">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3052471">text</span>&nbsp;<span class="op" id="3052476">=</span>&nbsp;<span class="string" id="3052478">&#34;status&nbsp;code&nbsp;&#34;</span>&nbsp;<span class="op" id="3052493">+</span>&nbsp;<span class="ident" id="3052495">strconv</span><span class="op" id="3052502">.</span><span class="ident" id="3052503">Itoa</span><span class="op" id="3052507">(</span><span class="ident" id="3052508">r</span><span class="op" id="3052509">.</span><span class="ident" id="3052510">StatusCode</span><span class="op" id="3052520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3052524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3052527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3052530">protoMajor</span><span class="op" id="3052540">,</span>&nbsp;<span class="ident" id="3052542">protoMinor</span>&nbsp;<span class="op" id="3052553">:=</span>&nbsp;<span class="ident" id="3052556">strconv</span><span class="op" id="3052563">.</span><span class="ident" id="3052564">Itoa</span><span class="op" id="3052568">(</span><span class="ident" id="3052569">r</span><span class="op" id="3052570">.</span><span class="ident" id="3052571">ProtoMajor</span><span class="op" id="3052581">)</span><span class="op" id="3052582">,</span>&nbsp;<span class="ident" id="3052584">strconv</span><span class="op" id="3052591">.</span><span class="ident" id="3052592">Itoa</span><span class="op" id="3052596">(</span><span class="ident" id="3052597">r</span><span class="op" id="3052598">.</span><span class="ident" id="3052599">ProtoMinor</span><span class="op" id="3052609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3052612">statusCode</span>&nbsp;<span class="op" id="3052623">:=</span>&nbsp;<span class="ident" id="3052626">strconv</span><span class="op" id="3052633">.</span><span class="ident" id="3052634">Itoa</span><span class="op" id="3052638">(</span><span class="ident" id="3052639">r</span><span class="op" id="3052640">.</span><span class="ident" id="3052641">StatusCode</span><span class="op" id="3052651">)</span>&nbsp;<span class="op" id="3052653">+</span>&nbsp;<span class="string" id="3052655">&#34;&nbsp;&#34;</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3052660">text</span>&nbsp;<span class="op" id="3052665">=</span>&nbsp;<span class="ident" id="3052667">strings</span><span class="op" id="3052674">.</span><span class="ident" id="3052675">TrimPrefix</span><span class="op" id="3052685">(</span><span class="ident" id="3052686">text</span><span class="op" id="3052690">,</span>&nbsp;<span class="ident" id="3052692">statusCode</span><span class="op" id="3052702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3052705">if</span>&nbsp;<span class="ident" id="3052708">_</span><span class="op" id="3052709">,</span>&nbsp;<span class="ident" id="3052711">err</span>&nbsp;<span class="op" id="3052715">:=</span>&nbsp;<span class="ident" id="3052718">io</span><span class="op" id="3052720">.</span><span class="ident" id="3052721">WriteString</span><span class="op" id="3052732">(</span><span class="ident" id="3052733">w</span><span class="op" id="3052734">,</span>&nbsp;<span class="string" id="3052736">&#34;HTTP/&#34;</span><span class="op" id="3052743">+</span><span class="ident" id="3052744">protoMajor</span><span class="op" id="3052754">+</span><span class="string" id="3052755">&#34;.&#34;</span><span class="op" id="3052758">+</span><span class="ident" id="3052759">protoMinor</span><span class="op" id="3052769">+</span><span class="string" id="3052770">&#34;&nbsp;&#34;</span><span class="op" id="3052773">+</span><span class="ident" id="3052774">statusCode</span><span class="op" id="3052784">+</span><span class="ident" id="3052785">text</span><span class="op" id="3052789">+</span><span class="string" id="3052790">&#34;\r\n&#34;</span><span class="op" id="3052796">)</span><span class="op" id="3052797">;</span>&nbsp;<span class="ident" id="3052799">err</span>&nbsp;<span class="op" id="3052803">!=</span>&nbsp;<span class="ident" id="3052806">nil</span>&nbsp;<span class="op" id="3052810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3052814">return</span>&nbsp;<span class="ident" id="3052821">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3052826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3052830">//&nbsp;Clone&nbsp;it,&nbsp;so&nbsp;we&nbsp;can&nbsp;modify&nbsp;r1&nbsp;as&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3052875">r1</span>&nbsp;<span class="op" id="3052878">:=</span>&nbsp;<span class="builtinfunc" id="3052881">new</span><span class="op" id="3052884">(</span><span class="ident" id="3052885">Response</span><span class="op" id="3052893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3052896">*</span><span class="ident" id="3052897">r1</span>&nbsp;<span class="op" id="3052900">=</span>&nbsp;<span class="op" id="3052902">*</span><span class="ident" id="3052903">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3052906">if</span>&nbsp;<span class="ident" id="3052909">r1</span><span class="op" id="3052911">.</span><span class="ident" id="3052912">ContentLength</span>&nbsp;<span class="op" id="3052926">==</span>&nbsp;<span class="num" id="3052929">0</span>&nbsp;<span class="op" id="3052931">&amp;&amp;</span>&nbsp;<span class="ident" id="3052934">r1</span><span class="op" id="3052936">.</span><span class="ident" id="3052937">Body</span>&nbsp;<span class="op" id="3052942">!=</span>&nbsp;<span class="ident" id="3052945">nil</span>&nbsp;<span class="op" id="3052949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3052953">//&nbsp;Is&nbsp;it&nbsp;actually&nbsp;0&nbsp;length?&nbsp;Or&nbsp;just&nbsp;unknown?</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3053000">var</span>&nbsp;<span class="ident" id="3053004">buf</span>&nbsp;<span class="op" id="3053008">[</span><span class="num" id="3053009">1</span><span class="op" id="3053010">]</span><span class="builtintype" id="3053011">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3053018">n</span><span class="op" id="3053019">,</span>&nbsp;<span class="ident" id="3053021">err</span>&nbsp;<span class="op" id="3053025">:=</span>&nbsp;<span class="ident" id="3053028">r1</span><span class="op" id="3053030">.</span><span class="ident" id="3053031">Body</span><span class="op" id="3053035">.</span><span class="ident" id="3053036">Read</span><span class="op" id="3053040">(</span><span class="ident" id="3053041">buf</span><span class="op" id="3053044">[</span><span class="op" id="3053045">:</span><span class="op" id="3053046">]</span><span class="op" id="3053047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3053051">if</span>&nbsp;<span class="ident" id="3053054">err</span>&nbsp;<span class="op" id="3053058">!=</span>&nbsp;<span class="ident" id="3053061">nil</span>&nbsp;<span class="op" id="3053065">&amp;&amp;</span>&nbsp;<span class="ident" id="3053068">err</span>&nbsp;<span class="op" id="3053072">!=</span>&nbsp;<span class="ident" id="3053075">io</span><span class="op" id="3053077">.</span><span class="ident" id="3053078">EOF</span>&nbsp;<span class="op" id="3053082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3053087">return</span>&nbsp;<span class="ident" id="3053094">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3053100">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3053104">if</span>&nbsp;<span class="ident" id="3053107">n</span>&nbsp;<span class="op" id="3053109">==</span>&nbsp;<span class="num" id="3053112">0</span>&nbsp;<span class="op" id="3053114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3053119">//&nbsp;Reset&nbsp;it&nbsp;to&nbsp;a&nbsp;known&nbsp;zero&nbsp;reader,&nbsp;in&nbsp;case&nbsp;underlying&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3053181">//&nbsp;is&nbsp;unhappy&nbsp;being&nbsp;read&nbsp;repeatedly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3053221">r1</span><span class="op" id="3053223">.</span><span class="ident" id="3053224">Body</span>&nbsp;<span class="op" id="3053229">=</span>&nbsp;<span class="ident" id="3053231">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3053243">}</span>&nbsp;<span class="keyword" id="3053245">else</span>&nbsp;<span class="op" id="3053250">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3053255">r1</span><span class="op" id="3053257">.</span><span class="ident" id="3053258">ContentLength</span>&nbsp;<span class="op" id="3053272">=</span>&nbsp;<span class="op" id="3053274">-</span><span class="num" id="3053275">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3053280">r1</span><span class="op" id="3053282">.</span><span class="ident" id="3053283">Body</span>&nbsp;<span class="op" id="3053288">=</span>&nbsp;<span class="keyword" id="3053290">struct</span>&nbsp;<span class="op" id="3053297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3053303">io</span><span class="op" id="3053305">.</span><span class="ident" id="3053306">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3053317">io</span><span class="op" id="3053319">.</span><span class="ident" id="3053320">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3053330">}</span><span class="op" id="3053331">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3053337">io</span><span class="op" id="3053339">.</span><span class="ident" id="3053340">MultiReader</span><span class="op" id="3053351">(</span><span class="ident" id="3053352">bytes</span><span class="op" id="3053357">.</span><span class="ident" id="3053358">NewReader</span><span class="op" id="3053367">(</span><span class="ident" id="3053368">buf</span><span class="op" id="3053371">[</span><span class="op" id="3053372">:</span><span class="num" id="3053373">1</span><span class="op" id="3053374">]</span><span class="op" id="3053375">)</span><span class="op" id="3053376">,</span>&nbsp;<span class="ident" id="3053378">r</span><span class="op" id="3053379">.</span><span class="ident" id="3053380">Body</span><span class="op" id="3053384">)</span><span class="op" id="3053385">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3053391">r</span><span class="op" id="3053392">.</span><span class="ident" id="3053393">Body</span><span class="op" id="3053397">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3053402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3053406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3053409">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3053412">//&nbsp;If&nbsp;we&#39;re&nbsp;sending&nbsp;a&nbsp;non-chunked&nbsp;HTTP/1.1&nbsp;response&nbsp;without&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3053475">//&nbsp;content-length,&nbsp;the&nbsp;only&nbsp;way&nbsp;to&nbsp;do&nbsp;that&nbsp;is&nbsp;the&nbsp;old&nbsp;HTTP/1.0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3053539">//&nbsp;way,&nbsp;by&nbsp;noting&nbsp;the&nbsp;EOF&nbsp;with&nbsp;a&nbsp;connection&nbsp;close,&nbsp;so&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3053602">//&nbsp;to&nbsp;set&nbsp;Close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3053620">if</span>&nbsp;<span class="ident" id="3053623">r1</span><span class="op" id="3053625">.</span><span class="ident" id="3053626">ContentLength</span>&nbsp;<span class="op" id="3053640">==</span>&nbsp;<span class="op" id="3053643">-</span><span class="num" id="3053644">1</span>&nbsp;<span class="op" id="3053646">&amp;&amp;</span>&nbsp;<span class="op" id="3053649">!</span><span class="ident" id="3053650">r1</span><span class="op" id="3053652">.</span><span class="ident" id="3053653">Close</span>&nbsp;<span class="op" id="3053659">&amp;&amp;</span>&nbsp;<span class="ident" id="3053662">r1</span><span class="op" id="3053664">.</span><span class="ident" id="3053665">ProtoAtLeast</span><span class="op" id="3053677">(</span><span class="num" id="3053678">1</span><span class="op" id="3053679">,</span>&nbsp;<span class="num" id="3053681">1</span><span class="op" id="3053682">)</span>&nbsp;<span class="op" id="3053684">&amp;&amp;</span>&nbsp;<span class="op" id="3053687">!</span><span class="ident" id="3053688">chunked</span><span class="op" id="3053695">(</span><span class="ident" id="3053696">r1</span><span class="op" id="3053698">.</span><span class="ident" id="3053699">TransferEncoding</span><span class="op" id="3053715">)</span>&nbsp;<span class="op" id="3053717">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3053721">r1</span><span class="op" id="3053723">.</span><span class="ident" id="3053724">Close</span>&nbsp;<span class="op" id="3053730">=</span>&nbsp;<span class="builtintype" id="3053732">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3053738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3053742">//&nbsp;Process&nbsp;Body,ContentLength,Close,Trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3053787">tw</span><span class="op" id="3053789">,</span>&nbsp;<span class="ident" id="3053791">err</span>&nbsp;<span class="op" id="3053795">:=</span>&nbsp;<span class="ident" id="3053798">newTransferWriter</span><span class="op" id="3053815">(</span><span class="ident" id="3053816">r1</span><span class="op" id="3053818">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3053821">if</span>&nbsp;<span class="ident" id="3053824">err</span>&nbsp;<span class="op" id="3053828">!=</span>&nbsp;<span class="ident" id="3053831">nil</span>&nbsp;<span class="op" id="3053835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3053839">return</span>&nbsp;<span class="ident" id="3053846">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3053851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3053854">err</span>&nbsp;<span class="op" id="3053858">=</span>&nbsp;<span class="ident" id="3053860">tw</span><span class="op" id="3053862">.</span><span class="ident" id="3053863">WriteHeader</span><span class="op" id="3053874">(</span><span class="ident" id="3053875">w</span><span class="op" id="3053876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3053879">if</span>&nbsp;<span class="ident" id="3053882">err</span>&nbsp;<span class="op" id="3053886">!=</span>&nbsp;<span class="ident" id="3053889">nil</span>&nbsp;<span class="op" id="3053893">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3053897">return</span>&nbsp;<span class="ident" id="3053904">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3053909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3053913">//&nbsp;Rest&nbsp;of&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3053932">err</span>&nbsp;<span class="op" id="3053936">=</span>&nbsp;<span class="ident" id="3053938">r</span><span class="op" id="3053939">.</span><span class="ident" id="3053940">Header</span><span class="op" id="3053946">.</span><span class="ident" id="3053947">WriteSubset</span><span class="op" id="3053958">(</span><span class="ident" id="3053959">w</span><span class="op" id="3053960">,</span>&nbsp;<span class="ident" id="3053962">respExcludeHeader</span><span class="op" id="3053979">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3053982">if</span>&nbsp;<span class="ident" id="3053985">err</span>&nbsp;<span class="op" id="3053989">!=</span>&nbsp;<span class="ident" id="3053992">nil</span>&nbsp;<span class="op" id="3053996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3054000">return</span>&nbsp;<span class="ident" id="3054007">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3054012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3054016">//&nbsp;contentLengthAlreadySent&nbsp;may&nbsp;have&nbsp;been&nbsp;already&nbsp;sent&nbsp;for</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3054076">//&nbsp;POST/PUT&nbsp;requests,&nbsp;even&nbsp;if&nbsp;zero&nbsp;length.&nbsp;See&nbsp;Issue&nbsp;8180.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3054136">contentLengthAlreadySent</span>&nbsp;<span class="op" id="3054161">:=</span>&nbsp;<span class="ident" id="3054164">tw</span><span class="op" id="3054166">.</span><span class="ident" id="3054167">shouldSendContentLength</span><span class="op" id="3054190">(</span><span class="op" id="3054191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3054194">if</span>&nbsp;<span class="ident" id="3054197">r1</span><span class="op" id="3054199">.</span><span class="ident" id="3054200">ContentLength</span>&nbsp;<span class="op" id="3054214">==</span>&nbsp;<span class="num" id="3054217">0</span>&nbsp;<span class="op" id="3054219">&amp;&amp;</span>&nbsp;<span class="op" id="3054222">!</span><span class="ident" id="3054223">chunked</span><span class="op" id="3054230">(</span><span class="ident" id="3054231">r1</span><span class="op" id="3054233">.</span><span class="ident" id="3054234">TransferEncoding</span><span class="op" id="3054250">)</span>&nbsp;<span class="op" id="3054252">&amp;&amp;</span>&nbsp;<span class="op" id="3054255">!</span><span class="ident" id="3054256">contentLengthAlreadySent</span>&nbsp;<span class="op" id="3054281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3054285">if</span>&nbsp;<span class="ident" id="3054288">_</span><span class="op" id="3054289">,</span>&nbsp;<span class="ident" id="3054291">err</span>&nbsp;<span class="op" id="3054295">:=</span>&nbsp;<span class="ident" id="3054298">io</span><span class="op" id="3054300">.</span><span class="ident" id="3054301">WriteString</span><span class="op" id="3054312">(</span><span class="ident" id="3054313">w</span><span class="op" id="3054314">,</span>&nbsp;<span class="string" id="3054316">&#34;Content-Length:&nbsp;0\r\n&#34;</span><span class="op" id="3054339">)</span><span class="op" id="3054340">;</span>&nbsp;<span class="ident" id="3054342">err</span>&nbsp;<span class="op" id="3054346">!=</span>&nbsp;<span class="ident" id="3054349">nil</span>&nbsp;<span class="op" id="3054353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3054358">return</span>&nbsp;<span class="ident" id="3054365">err</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3054371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3054374">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3054378">//&nbsp;End-of-header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3054396">if</span>&nbsp;<span class="ident" id="3054399">_</span><span class="op" id="3054400">,</span>&nbsp;<span class="ident" id="3054402">err</span>&nbsp;<span class="op" id="3054406">:=</span>&nbsp;<span class="ident" id="3054409">io</span><span class="op" id="3054411">.</span><span class="ident" id="3054412">WriteString</span><span class="op" id="3054423">(</span><span class="ident" id="3054424">w</span><span class="op" id="3054425">,</span>&nbsp;<span class="string" id="3054427">&#34;\r\n&#34;</span><span class="op" id="3054433">)</span><span class="op" id="3054434">;</span>&nbsp;<span class="ident" id="3054436">err</span>&nbsp;<span class="op" id="3054440">!=</span>&nbsp;<span class="ident" id="3054443">nil</span>&nbsp;<span class="op" id="3054447">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3054451">return</span>&nbsp;<span class="ident" id="3054458">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3054463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3054467">//&nbsp;Write&nbsp;body&nbsp;and&nbsp;trailer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3054494">err</span>&nbsp;<span class="op" id="3054498">=</span>&nbsp;<span class="ident" id="3054500">tw</span><span class="op" id="3054502">.</span><span class="ident" id="3054503">WriteBody</span><span class="op" id="3054512">(</span><span class="ident" id="3054513">w</span><span class="op" id="3054514">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3054517">if</span>&nbsp;<span class="ident" id="3054520">err</span>&nbsp;<span class="op" id="3054524">!=</span>&nbsp;<span class="ident" id="3054527">nil</span>&nbsp;<span class="op" id="3054531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3054535">return</span>&nbsp;<span class="ident" id="3054542">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3054547">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3054551">//&nbsp;Success</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3054563">return</span>&nbsp;<span class="ident" id="3054570">nil</span><br>
<span class="lineno"></span><span class="op" id="3054574">}</span>
</div>
</body>
</html>
