<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6297785">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6297840">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6297894">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6297945">//&nbsp;Implementation&nbsp;of&nbsp;Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6297974">package</span>&nbsp;<span class="ident" id="6297982">httptest</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6297992">import</span>&nbsp;<span class="op" id="6297999">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6298002">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6298016">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6298024">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6298031">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6298038">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6298050">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6298056">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="6298063">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6298066">//&nbsp;A&nbsp;Server&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;server&nbsp;listening&nbsp;on&nbsp;a&nbsp;system-chosen&nbsp;port&nbsp;on&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="6298137">//&nbsp;local&nbsp;loopback&nbsp;interface,&nbsp;for&nbsp;use&nbsp;in&nbsp;end-to-end&nbsp;HTTP&nbsp;tests.</span><br>
<span class="lineno"></span><span class="keyword" id="6298200">type</span>&nbsp;<span class="ident" id="6298205">Server</span>&nbsp;<span class="keyword" id="6298212">struct</span>&nbsp;<span class="op" id="6298219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6298222">URL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6298231">string</span>&nbsp;<span class="comment" id="6298238">//&nbsp;base&nbsp;URL&nbsp;of&nbsp;form&nbsp;http://ipaddr:port&nbsp;with&nbsp;no&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6298301">Listener</span>&nbsp;<span class="ident" id="6298310"><a href="/net/http/httptest/server.go.html#6298031">net</a></span><span class="op" id="6298313">.</span><span class="ident" id="6298314">Listener</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6298325">//&nbsp;TLS&nbsp;is&nbsp;the&nbsp;optional&nbsp;TLS&nbsp;configuration,&nbsp;populated&nbsp;with&nbsp;a&nbsp;new&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6298396">//&nbsp;after&nbsp;TLS&nbsp;is&nbsp;started.&nbsp;If&nbsp;set&nbsp;on&nbsp;an&nbsp;unstarted&nbsp;server&nbsp;before&nbsp;StartTLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6298468">//&nbsp;is&nbsp;called,&nbsp;existing&nbsp;fields&nbsp;are&nbsp;copied&nbsp;into&nbsp;the&nbsp;new&nbsp;config.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6298531">TLS</span>&nbsp;<span class="op" id="6298535">*</span><span class="ident" id="6298536"><a href="/net/http/httptest/server.go.html#6298002">tls</a></span><span class="op" id="6298539">.</span><span class="ident" id="6298540">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6298549">//&nbsp;Config&nbsp;may&nbsp;be&nbsp;changed&nbsp;after&nbsp;calling&nbsp;NewUnstartedServer&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6298612">//&nbsp;before&nbsp;Start&nbsp;or&nbsp;StartTLS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6298642">Config</span>&nbsp;<span class="op" id="6298649">*</span><span class="ident" id="6298650"><a href="/net/http/httptest/server.go.html#6298038">http</a></span><span class="op" id="6298654">.</span><span class="ident" id="6298655">Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6298664">//&nbsp;wg&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;HTTP&nbsp;requests&nbsp;on&nbsp;this&nbsp;server.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6298734">//&nbsp;Close&nbsp;blocks&nbsp;until&nbsp;all&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6298784">wg</span>&nbsp;<span class="ident" id="6298787"><a href="/net/http/httptest/server.go.html#6298056">sync</a></span><span class="op" id="6298791">.</span><span class="ident" id="6298792">WaitGroup</span><br>
<span class="lineno"></span><span class="op" id="6298802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6298805">//&nbsp;historyListener&nbsp;keeps&nbsp;track&nbsp;of&nbsp;all&nbsp;connections&nbsp;that&nbsp;it&#39;s&nbsp;ever</span><br>
<span class="lineno">40</span><span class="comment" id="6298870">//&nbsp;accepted.</span><br>
<span class="lineno"></span><span class="keyword" id="6298883">type</span>&nbsp;<span class="ident" id="6298888">historyListener</span>&nbsp;<span class="keyword" id="6298904">struct</span>&nbsp;<span class="op" id="6298911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6298914"><a href="/net/http/httptest/server.go.html#6298031">net</a></span><span class="op" id="6298917">.</span><span class="ident" id="6298918">Listener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6298928"><a href="/net/http/httptest/server.go.html#6298056">sync</a></span><span class="op" id="6298932">.</span><span class="ident" id="6298933">Mutex</span>&nbsp;<span class="comment" id="6298939">//&nbsp;protects&nbsp;history</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6298960">history</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6298971">[</span><span class="op" id="6298972">]</span><span class="ident" id="6298973"><a href="/net/http/httptest/server.go.html#6298031">net</a></span><span class="op" id="6298976">.</span><span class="ident" id="6298977">Conn</span><br>
<span class="lineno">45</span><span class="op" id="6298982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6298985">func</span>&nbsp;<span class="op" id="6298990">(</span><span class="ident" id="6298991">hs</span>&nbsp;<span class="op" id="6298994">*</span><span class="ident" id="6298995"><a href="/net/http/httptest/server.go.html#6298888">historyListener</a></span><span class="op" id="6299010">)</span>&nbsp;<span class="ident" id="6299012">Accept</span><span class="op" id="6299018">(</span><span class="op" id="6299019">)</span>&nbsp;<span class="op" id="6299021">(</span><span class="ident" id="6299022">c</span>&nbsp;<span class="ident" id="6299024"><a href="/net/http/httptest/server.go.html#6298031">net</a></span><span class="op" id="6299027">.</span><span class="ident" id="6299028">Conn</span><span class="op" id="6299032">,</span>&nbsp;<span class="ident" id="6299034">err</span>&nbsp;<span class="builtintype" id="6299038">error</span><span class="op" id="6299043">)</span>&nbsp;<span class="op" id="6299045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6299048"><a href="/net/http/httptest/server.go.html#6299022">c</a></span><span class="op" id="6299049">,</span>&nbsp;<span class="ident" id="6299051"><a href="/net/http/httptest/server.go.html#6299034">err</a></span>&nbsp;<span class="op" id="6299055">=</span>&nbsp;<span class="ident" id="6299057"><a href="/net/http/httptest/server.go.html#6298991">hs</a></span><span class="op" id="6299059">.</span><span class="ident" id="6299060">Listener</span><span class="op" id="6299068">.</span><span class="ident" id="6299069">Accept</span><span class="op" id="6299075">(</span><span class="op" id="6299076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299079">if</span>&nbsp;<span class="ident" id="6299082"><a href="/net/http/httptest/server.go.html#6299034">err</a></span>&nbsp;<span class="op" id="6299086">==</span>&nbsp;<span class="ident" id="6299089">nil</span>&nbsp;<span class="op" id="6299093">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6299097"><a href="/net/http/httptest/server.go.html#6298991">hs</a></span><span class="op" id="6299099">.</span><span class="ident" id="6299100">Lock</span><span class="op" id="6299104">(</span><span class="op" id="6299105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6299109"><a href="/net/http/httptest/server.go.html#6298991">hs</a></span><span class="op" id="6299111">.</span><span class="ident" id="6299112">history</span>&nbsp;<span class="op" id="6299120">=</span>&nbsp;<span class="builtinfunc" id="6299122">append</span><span class="op" id="6299128">(</span><span class="ident" id="6299129"><a href="/net/http/httptest/server.go.html#6298991">hs</a></span><span class="op" id="6299131">.</span><span class="ident" id="6299132">history</span><span class="op" id="6299139">,</span>&nbsp;<span class="ident" id="6299141"><a href="/net/http/httptest/server.go.html#6299022">c</a></span><span class="op" id="6299142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6299146"><a href="/net/http/httptest/server.go.html#6298991">hs</a></span><span class="op" id="6299148">.</span><span class="ident" id="6299149">Unlock</span><span class="op" id="6299155">(</span><span class="op" id="6299156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6299159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299162">return</span><br>
<span class="lineno">55</span><span class="op" id="6299169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6299172">func</span>&nbsp;<span class="ident" id="6299177">newLocalListener</span><span class="op" id="6299193">(</span><span class="op" id="6299194">)</span>&nbsp;<span class="ident" id="6299196"><a href="/net/http/httptest/server.go.html#6298031">net</a></span><span class="op" id="6299199">.</span><span class="ident" id="6299200">Listener</span>&nbsp;<span class="op" id="6299209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299212">if</span>&nbsp;<span class="op" id="6299215">*</span><span class="ident" id="6299216"><a href="/net/http/httptest/server.go.html#6299800">serve</a></span>&nbsp;<span class="op" id="6299222">!=</span>&nbsp;<span class="string" id="6299225">&#34;&#34;</span>&nbsp;<span class="op" id="6299228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6299232">l</span><span class="op" id="6299233">,</span>&nbsp;<span class="ident" id="6299235">err</span>&nbsp;<span class="op" id="6299239">:=</span>&nbsp;<span class="ident" id="6299242"><a href="/net/http/httptest/server.go.html#6298031">net</a></span><span class="op" id="6299245">.</span><span class="ident" id="6299246">Listen</span><span class="op" id="6299252">(</span><span class="string" id="6299253">&#34;tcp&#34;</span><span class="op" id="6299258">,</span>&nbsp;<span class="op" id="6299260">*</span><span class="ident" id="6299261"><a href="/net/http/httptest/server.go.html#6299800">serve</a></span><span class="op" id="6299266">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299270">if</span>&nbsp;<span class="ident" id="6299273"><a href="/net/http/httptest/server.go.html#6299235">err</a></span>&nbsp;<span class="op" id="6299277">!=</span>&nbsp;<span class="ident" id="6299280">nil</span>&nbsp;<span class="op" id="6299284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6299289">panic</span><span class="op" id="6299294">(</span><span class="ident" id="6299295"><a href="/net/http/httptest/server.go.html#6298024">fmt</a></span><span class="op" id="6299298">.</span><span class="ident" id="6299299">Sprintf</span><span class="op" id="6299306">(</span><span class="string" id="6299307">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;%v:&nbsp;%v&#34;</span><span class="op" id="6299345">,</span>&nbsp;<span class="op" id="6299347">*</span><span class="ident" id="6299348"><a href="/net/http/httptest/server.go.html#6299800">serve</a></span><span class="op" id="6299353">,</span>&nbsp;<span class="ident" id="6299355"><a href="/net/http/httptest/server.go.html#6299235">err</a></span><span class="op" id="6299358">)</span><span class="op" id="6299359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6299363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299367">return</span>&nbsp;<span class="ident" id="6299374"><a href="/net/http/httptest/server.go.html#6299232">l</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6299377">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6299380">l</span><span class="op" id="6299381">,</span>&nbsp;<span class="ident" id="6299383">err</span>&nbsp;<span class="op" id="6299387">:=</span>&nbsp;<span class="ident" id="6299390"><a href="/net/http/httptest/server.go.html#6298031">net</a></span><span class="op" id="6299393">.</span><span class="ident" id="6299394">Listen</span><span class="op" id="6299400">(</span><span class="string" id="6299401">&#34;tcp&#34;</span><span class="op" id="6299406">,</span>&nbsp;<span class="string" id="6299408">&#34;127.0.0.1:0&#34;</span><span class="op" id="6299421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299424">if</span>&nbsp;<span class="ident" id="6299427"><a href="/net/http/httptest/server.go.html#6299383">err</a></span>&nbsp;<span class="op" id="6299431">!=</span>&nbsp;<span class="ident" id="6299434">nil</span>&nbsp;<span class="op" id="6299438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299442">if</span>&nbsp;<span class="ident" id="6299445"><a href="/net/http/httptest/server.go.html#6299380">l</a></span><span class="op" id="6299446">,</span>&nbsp;<span class="ident" id="6299448"><a href="/net/http/httptest/server.go.html#6299383">err</a></span>&nbsp;<span class="op" id="6299452">=</span>&nbsp;<span class="ident" id="6299454"><a href="/net/http/httptest/server.go.html#6298031">net</a></span><span class="op" id="6299457">.</span><span class="ident" id="6299458">Listen</span><span class="op" id="6299464">(</span><span class="string" id="6299465">&#34;tcp6&#34;</span><span class="op" id="6299471">,</span>&nbsp;<span class="string" id="6299473">&#34;[::1]:0&#34;</span><span class="op" id="6299482">)</span><span class="op" id="6299483">;</span>&nbsp;<span class="ident" id="6299485"><a href="/net/http/httptest/server.go.html#6299383">err</a></span>&nbsp;<span class="op" id="6299489">!=</span>&nbsp;<span class="ident" id="6299492">nil</span>&nbsp;<span class="op" id="6299496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6299501">panic</span><span class="op" id="6299506">(</span><span class="ident" id="6299507"><a href="/net/http/httptest/server.go.html#6298024">fmt</a></span><span class="op" id="6299510">.</span><span class="ident" id="6299511">Sprintf</span><span class="op" id="6299518">(</span><span class="string" id="6299519">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;a&nbsp;port:&nbsp;%v&#34;</span><span class="op" id="6299561">,</span>&nbsp;<span class="ident" id="6299563"><a href="/net/http/httptest/server.go.html#6299383">err</a></span><span class="op" id="6299566">)</span><span class="op" id="6299567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6299571">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6299574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6299577">return</span>&nbsp;<span class="ident" id="6299584"><a href="/net/http/httptest/server.go.html#6299380">l</a></span><br>
<span class="lineno"></span><span class="op" id="6299586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6299589">//&nbsp;When&nbsp;debugging&nbsp;a&nbsp;particular&nbsp;http&nbsp;server-based&nbsp;test,</span><br>
<span class="lineno">75</span><span class="comment" id="6299644">//&nbsp;this&nbsp;flag&nbsp;lets&nbsp;you&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="6299670">//&nbsp;&nbsp;&nbsp;&nbspgo&nbsp;test&nbsp;-run=BrokenTest&nbsp;-httptest.serve=127.0.0.1:8000</span><br>
<span class="lineno"></span><span class="comment" id="6299728">//&nbsp;to&nbsp;start&nbsp;the&nbsp;broken&nbsp;server&nbsp;so&nbsp;you&nbsp;can&nbsp;interact&nbsp;with&nbsp;it&nbsp;manually.</span><br>
<span class="lineno"></span><span class="keyword" id="6299796">var</span>&nbsp;<span class="ident" id="6299800">serve</span>&nbsp;<span class="op" id="6299806">=</span>&nbsp;<span class="ident" id="6299808"><a href="/net/http/httptest/server.go.html#6298016">flag</a></span><span class="op" id="6299812">.</span><span class="ident" id="6299813">String</span><span class="op" id="6299819">(</span><span class="string" id="6299820">&#34;httptest.serve&#34;</span><span class="op" id="6299836">,</span>&nbsp;<span class="string" id="6299838">&#34;&#34;</span><span class="op" id="6299840">,</span>&nbsp;<span class="string" id="6299842">&#34;if&nbsp;non-empty,&nbsp;httptest.NewServer&nbsp;serves&nbsp;on&nbsp;this&nbsp;address&nbsp;and&nbsp;blocks&#34;</span><span class="op" id="6299910">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="6299913">//&nbsp;NewServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="6299959">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="6300023">func</span>&nbsp;<span class="ident" id="6300028">NewServer</span><span class="op" id="6300037">(</span><span class="ident" id="6300038">handler</span>&nbsp;<span class="ident" id="6300046"><a href="/net/http/httptest/server.go.html#6298038">http</a></span><span class="op" id="6300050">.</span><span class="ident" id="6300051">Handler</span><span class="op" id="6300058">)</span>&nbsp;<span class="op" id="6300060">*</span><span class="ident" id="6300061"><a href="/net/http/httptest/server.go.html#6298205">Server</a></span>&nbsp;<span class="op" id="6300068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6300071">ts</span>&nbsp;<span class="op" id="6300074">:=</span>&nbsp;<span class="ident" id="6300077"><a href="/net/http/httptest/server.go.html#6300353">NewUnstartedServer</a></span><span class="op" id="6300095">(</span><span class="ident" id="6300096"><a href="/net/http/httptest/server.go.html#6300038">handler</a></span><span class="op" id="6300103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6300106"><a href="/net/http/httptest/server.go.html#6300071">ts</a></span><span class="op" id="6300108">.</span><span class="ident" id="6300109">Start</span><span class="op" id="6300114">(</span><span class="op" id="6300115">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6300118">return</span>&nbsp;<span class="ident" id="6300125"><a href="/net/http/httptest/server.go.html#6300071">ts</a></span><br>
<span class="lineno"></span><span class="op" id="6300128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6300131">//&nbsp;NewUnstartedServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;but&nbsp;doesn&#39;t&nbsp;start&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="6300196">//</span><br>
<span class="lineno">90</span><span class="comment" id="6300199">//&nbsp;After&nbsp;changing&nbsp;its&nbsp;configuration,&nbsp;the&nbsp;caller&nbsp;should&nbsp;call&nbsp;Start&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6300268">//&nbsp;StartTLS.</span><br>
<span class="lineno"></span><span class="comment" id="6300281">//</span><br>
<span class="lineno"></span><span class="comment" id="6300284">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="6300348">func</span>&nbsp;<span class="ident" id="6300353">NewUnstartedServer</span><span class="op" id="6300371">(</span><span class="ident" id="6300372">handler</span>&nbsp;<span class="ident" id="6300380"><a href="/net/http/httptest/server.go.html#6298038">http</a></span><span class="op" id="6300384">.</span><span class="ident" id="6300385">Handler</span><span class="op" id="6300392">)</span>&nbsp;<span class="op" id="6300394">*</span><span class="ident" id="6300395"><a href="/net/http/httptest/server.go.html#6298205">Server</a></span>&nbsp;<span class="op" id="6300402">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6300405">return</span>&nbsp;<span class="op" id="6300412">&amp;</span><span class="ident" id="6300413"><a href="/net/http/httptest/server.go.html#6298205">Server</a></span><span class="op" id="6300419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6300423">Listener</span><span class="op" id="6300431">:</span>&nbsp;<span class="ident" id="6300433"><a href="/net/http/httptest/server.go.html#6299177">newLocalListener</a></span><span class="op" id="6300449">(</span><span class="op" id="6300450">)</span><span class="op" id="6300451">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6300455">Config</span><span class="op" id="6300461">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6300465">&amp;</span><span class="ident" id="6300466"><a href="/net/http/httptest/server.go.html#6298038">http</a></span><span class="op" id="6300470">.</span><span class="ident" id="6300471">Server</span><span class="op" id="6300477">{</span><span class="ident" id="6300478">Handler</span><span class="op" id="6300485">:</span>&nbsp;<span class="ident" id="6300487"><a href="/net/http/httptest/server.go.html#6300372">handler</a></span><span class="op" id="6300494">}</span><span class="op" id="6300495">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6300498">}</span><br>
<span class="lineno"></span><span class="op" id="6300500">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="6300503">//&nbsp;Start&nbsp;starts&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="6300553">func</span>&nbsp;<span class="op" id="6300558">(</span><span class="ident" id="6300559">s</span>&nbsp;<span class="op" id="6300561">*</span><span class="ident" id="6300562"><a href="/net/http/httptest/server.go.html#6298205">Server</a></span><span class="op" id="6300568">)</span>&nbsp;<span class="ident" id="6300570">Start</span><span class="op" id="6300575">(</span><span class="op" id="6300576">)</span>&nbsp;<span class="op" id="6300578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6300581">if</span>&nbsp;<span class="ident" id="6300584"><a href="/net/http/httptest/server.go.html#6300559">s</a></span><span class="op" id="6300585">.</span><span class="ident" id="6300586">URL</span>&nbsp;<span class="op" id="6300590">!=</span>&nbsp;<span class="string" id="6300593">&#34;&#34;</span>&nbsp;<span class="op" id="6300596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6300600">panic</span><span class="op" id="6300605">(</span><span class="string" id="6300606">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="6300630">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6300633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6300636"><a href="/net/http/httptest/server.go.html#6300559">s</a></span><span class="op" id="6300637">.</span><span class="ident" id="6300638">Listener</span>&nbsp;<span class="op" id="6300647">=</span>&nbsp;<span class="op" id="6300649">&amp;</span><span class="ident" id="6300650"><a href="/net/http/httptest/server.go.html#6298888">historyListener</a></span><span class="op" id="6300665">{</span><span class="ident" id="6300666">Listener</span><span class="op" id="6300674">:</span>&nbsp;<span class="ident" id="6300676"><a href="/net/http/httptest/server.go.html#6300559">s</a></span><span class="op" id="6300677">.</span><span class="ident" id="6300678">Listener</span><span class="op" id="6300686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6300689"><a href="/net/http/httptest/server.go.html#6300559">s</a></span><span class="op" id="6300690">.</span><span class="ident" id="6300691">URL</span>&nbsp;<span class="op" id="6300695">=</span>&nbsp;<span class="string" id="6300697">&#34;http://&#34;</span>&nbsp;<span class="op" id="6300707">+</span>&nbsp;<span class="ident" id="6300709"><a href="/net/http/httptest/server.go.html#6300559">s</a></span><span class="op" id="6300710">.</span><span class="ident" id="6300711">Listener</span><span class="op" id="6300719">.</span><span class="ident" id="6300720">Addr</span><span class="op" id="6300724">(</span><span class="op" id="6300725">)</span><span class="op" id="6300726">.</span><span class="ident" id="6300727">String</span><span class="op" id="6300733">(</span><span class="op" id="6300734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6300737"><a href="/net/http/httptest/server.go.html#6300559">s</a></span><span class="op" id="6300738">.</span><span class="ident" id="6300739">wrapHandler</span><span class="op" id="6300750">(</span><span class="op" id="6300751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6300754">go</span>&nbsp;<span class="ident" id="6300757"><a href="/net/http/httptest/server.go.html#6300559">s</a></span><span class="op" id="6300758">.</span><span class="ident" id="6300759">Config</span><span class="op" id="6300765">.</span><span class="ident" id="6300766">Serve</span><span class="op" id="6300771">(</span><span class="ident" id="6300772"><a href="/net/http/httptest/server.go.html#6300559">s</a></span><span class="op" id="6300773">.</span><span class="ident" id="6300774">Listener</span><span class="op" id="6300782">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6300785">if</span>&nbsp;<span class="op" id="6300788">*</span><span class="ident" id="6300789"><a href="/net/http/httptest/server.go.html#6299800">serve</a></span>&nbsp;<span class="op" id="6300795">!=</span>&nbsp;<span class="string" id="6300798">&#34;&#34;</span>&nbsp;<span class="op" id="6300801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6300805"><a href="/net/http/httptest/server.go.html#6298024">fmt</a></span><span class="op" id="6300808">.</span><span class="ident" id="6300809">Fprintln</span><span class="op" id="6300817">(</span><span class="ident" id="6300818"><a href="/net/http/httptest/server.go.html#6298050">os</a></span><span class="op" id="6300820">.</span><span class="ident" id="6300821">Stderr</span><span class="op" id="6300827">,</span>&nbsp;<span class="string" id="6300829">&#34;httptest:&nbsp;serving&nbsp;on&#34;</span><span class="op" id="6300851">,</span>&nbsp;<span class="ident" id="6300853"><a href="/net/http/httptest/server.go.html#6300559">s</a></span><span class="op" id="6300854">.</span><span class="ident" id="6300855">URL</span><span class="op" id="6300858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6300862">select</span>&nbsp;<span class="op" id="6300869">{</span><span class="op" id="6300870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6300873">}</span><br>
<span class="lineno"></span><span class="op" id="6300875">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="6300878">//&nbsp;StartTLS&nbsp;starts&nbsp;TLS&nbsp;on&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="6300938">func</span>&nbsp;<span class="op" id="6300943">(</span><span class="ident" id="6300944">s</span>&nbsp;<span class="op" id="6300946">*</span><span class="ident" id="6300947"><a href="/net/http/httptest/server.go.html#6298205">Server</a></span><span class="op" id="6300953">)</span>&nbsp;<span class="ident" id="6300955">StartTLS</span><span class="op" id="6300963">(</span><span class="op" id="6300964">)</span>&nbsp;<span class="op" id="6300966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6300969">if</span>&nbsp;<span class="ident" id="6300972"><a href="/net/http/httptest/server.go.html#6300944">s</a></span><span class="op" id="6300973">.</span><span class="ident" id="6300974">URL</span>&nbsp;<span class="op" id="6300978">!=</span>&nbsp;<span class="string" id="6300981">&#34;&#34;</span>&nbsp;<span class="op" id="6300984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6300988">panic</span><span class="op" id="6300993">(</span><span class="string" id="6300994">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="6301018">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6301021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301024">cert</span><span class="op" id="6301028">,</span>&nbsp;<span class="ident" id="6301030">err</span>&nbsp;<span class="op" id="6301034">:=</span>&nbsp;<span class="ident" id="6301037"><a href="/net/http/httptest/server.go.html#6298002">tls</a></span><span class="op" id="6301040">.</span><span class="ident" id="6301041">X509KeyPair</span><span class="op" id="6301052">(</span><span class="ident" id="6301053"><a href="/net/http/httptest/server.go.html#6303354">localhostCert</a></span><span class="op" id="6301066">,</span>&nbsp;<span class="ident" id="6301068"><a href="/net/http/httptest/server.go.html#6304009">localhostKey</a></span><span class="op" id="6301080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301083">if</span>&nbsp;<span class="ident" id="6301086"><a href="/net/http/httptest/server.go.html#6301030">err</a></span>&nbsp;<span class="op" id="6301090">!=</span>&nbsp;<span class="ident" id="6301093">nil</span>&nbsp;<span class="op" id="6301097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6301101">panic</span><span class="op" id="6301106">(</span><span class="ident" id="6301107"><a href="/net/http/httptest/server.go.html#6298024">fmt</a></span><span class="op" id="6301110">.</span><span class="ident" id="6301111">Sprintf</span><span class="op" id="6301118">(</span><span class="string" id="6301119">&#34;httptest:&nbsp;NewTLSServer:&nbsp;%v&#34;</span><span class="op" id="6301147">,</span>&nbsp;<span class="ident" id="6301149"><a href="/net/http/httptest/server.go.html#6301030">err</a></span><span class="op" id="6301152">)</span><span class="op" id="6301153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6301156">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301160">existingConfig</span>&nbsp;<span class="op" id="6301175">:=</span>&nbsp;<span class="ident" id="6301178"><a href="/net/http/httptest/server.go.html#6300944">s</a></span><span class="op" id="6301179">.</span><span class="ident" id="6301180">TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301185"><a href="/net/http/httptest/server.go.html#6300944">s</a></span><span class="op" id="6301186">.</span><span class="ident" id="6301187">TLS</span>&nbsp;<span class="op" id="6301191">=</span>&nbsp;<span class="builtinfunc" id="6301193">new</span><span class="op" id="6301196">(</span><span class="ident" id="6301197"><a href="/net/http/httptest/server.go.html#6298002">tls</a></span><span class="op" id="6301200">.</span><span class="ident" id="6301201">Config</span><span class="op" id="6301207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301210">if</span>&nbsp;<span class="ident" id="6301213"><a href="/net/http/httptest/server.go.html#6301160">existingConfig</a></span>&nbsp;<span class="op" id="6301228">!=</span>&nbsp;<span class="ident" id="6301231">nil</span>&nbsp;<span class="op" id="6301235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6301239">*</span><span class="ident" id="6301240"><a href="/net/http/httptest/server.go.html#6300944">s</a></span><span class="op" id="6301241">.</span><span class="ident" id="6301242">TLS</span>&nbsp;<span class="op" id="6301246">=</span>&nbsp;<span class="op" id="6301248">*</span><span class="ident" id="6301249"><a href="/net/http/httptest/server.go.html#6301160">existingConfig</a></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6301265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301268">if</span>&nbsp;<span class="ident" id="6301271"><a href="/net/http/httptest/server.go.html#6300944">s</a></span><span class="op" id="6301272">.</span><span class="ident" id="6301273">TLS</span><span class="op" id="6301276">.</span><span class="ident" id="6301277">NextProtos</span>&nbsp;<span class="op" id="6301288">==</span>&nbsp;<span class="ident" id="6301291">nil</span>&nbsp;<span class="op" id="6301295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301299"><a href="/net/http/httptest/server.go.html#6300944">s</a></span><span class="op" id="6301300">.</span><span class="ident" id="6301301">TLS</span><span class="op" id="6301304">.</span><span class="ident" id="6301305">NextProtos</span>&nbsp;<span class="op" id="6301316">=</span>&nbsp;<span class="op" id="6301318">[</span><span class="op" id="6301319">]</span><span class="builtintype" id="6301320">string</span><span class="op" id="6301326">{</span><span class="string" id="6301327">&#34;http/1.1&#34;</span><span class="op" id="6301337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6301340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301343">if</span>&nbsp;<span class="builtinfunc" id="6301346">len</span><span class="op" id="6301349">(</span><span class="ident" id="6301350"><a href="/net/http/httptest/server.go.html#6300944">s</a></span><span class="op" id="6301351">.</span><span class="ident" id="6301352">TLS</span><span class="op" id="6301355">.</span><span class="ident" id="6301356">Certificates</span><span class="op" id="6301368">)</span>&nbsp;<span class="op" id="6301370">==</span>&nbsp;<span class="num" id="6301373">0</span>&nbsp;<span class="op" id="6301375">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301379"><a href="/net/http/httptest/server.go.html#6300944">s</a></span><span class="op" id="6301380">.</span><span class="ident" id="6301381">TLS</span><span class="op" id="6301384">.</span><span class="ident" id="6301385">Certificates</span>&nbsp;<span class="op" id="6301398">=</span>&nbsp;<span class="op" id="6301400">[</span><span class="op" id="6301401">]</span><span class="ident" id="6301402"><a href="/net/http/httptest/server.go.html#6298002">tls</a></span><span class="op" id="6301405">.</span><span class="ident" id="6301406">Certificate</span><span class="op" id="6301417">{</span><span class="ident" id="6301418"><a href="/net/http/httptest/server.go.html#6301024">cert</a></span><span class="op" id="6301422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6301425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301428">tlsListener</span>&nbsp;<span class="op" id="6301440">:=</span>&nbsp;<span class="ident" id="6301443"><a href="/net/http/httptest/server.go.html#6298002">tls</a></span><span class="op" id="6301446">.</span><span class="ident" id="6301447">NewListener</span><span class="op" id="6301458">(</span><span class="ident" id="6301459"><a href="/net/http/httptest/server.go.html#6300944">s</a></span><span class="op" id="6301460">.</span><span class="ident" id="6301461">Listener</span><span class="op" id="6301469">,</span>&nbsp;<span class="ident" id="6301471"><a href="/net/http/httptest/server.go.html#6300944">s</a></span><span class="op" id="6301472">.</span><span class="ident" id="6301473">TLS</span><span class="op" id="6301476">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301480"><a href="/net/http/httptest/server.go.html#6300944">s</a></span><span class="op" id="6301481">.</span><span class="ident" id="6301482">Listener</span>&nbsp;<span class="op" id="6301491">=</span>&nbsp;<span class="op" id="6301493">&amp;</span><span class="ident" id="6301494"><a href="/net/http/httptest/server.go.html#6298888">historyListener</a></span><span class="op" id="6301509">{</span><span class="ident" id="6301510">Listener</span><span class="op" id="6301518">:</span>&nbsp;<span class="ident" id="6301520"><a href="/net/http/httptest/server.go.html#6301428">tlsListener</a></span><span class="op" id="6301531">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301534"><a href="/net/http/httptest/server.go.html#6300944">s</a></span><span class="op" id="6301535">.</span><span class="ident" id="6301536">URL</span>&nbsp;<span class="op" id="6301540">=</span>&nbsp;<span class="string" id="6301542">&#34;https://&#34;</span>&nbsp;<span class="op" id="6301553">+</span>&nbsp;<span class="ident" id="6301555"><a href="/net/http/httptest/server.go.html#6300944">s</a></span><span class="op" id="6301556">.</span><span class="ident" id="6301557">Listener</span><span class="op" id="6301565">.</span><span class="ident" id="6301566">Addr</span><span class="op" id="6301570">(</span><span class="op" id="6301571">)</span><span class="op" id="6301572">.</span><span class="ident" id="6301573">String</span><span class="op" id="6301579">(</span><span class="op" id="6301580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301583"><a href="/net/http/httptest/server.go.html#6300944">s</a></span><span class="op" id="6301584">.</span><span class="ident" id="6301585">wrapHandler</span><span class="op" id="6301596">(</span><span class="op" id="6301597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301600">go</span>&nbsp;<span class="ident" id="6301603"><a href="/net/http/httptest/server.go.html#6300944">s</a></span><span class="op" id="6301604">.</span><span class="ident" id="6301605">Config</span><span class="op" id="6301611">.</span><span class="ident" id="6301612">Serve</span><span class="op" id="6301617">(</span><span class="ident" id="6301618"><a href="/net/http/httptest/server.go.html#6300944">s</a></span><span class="op" id="6301619">.</span><span class="ident" id="6301620">Listener</span><span class="op" id="6301628">)</span><br>
<span class="lineno"></span><span class="op" id="6301630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="6301633">func</span>&nbsp;<span class="op" id="6301638">(</span><span class="ident" id="6301639">s</span>&nbsp;<span class="op" id="6301641">*</span><span class="ident" id="6301642"><a href="/net/http/httptest/server.go.html#6298205">Server</a></span><span class="op" id="6301648">)</span>&nbsp;<span class="ident" id="6301650">wrapHandler</span><span class="op" id="6301661">(</span><span class="op" id="6301662">)</span>&nbsp;<span class="op" id="6301664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301667">h</span>&nbsp;<span class="op" id="6301669">:=</span>&nbsp;<span class="ident" id="6301672"><a href="/net/http/httptest/server.go.html#6301639">s</a></span><span class="op" id="6301673">.</span><span class="ident" id="6301674">Config</span><span class="op" id="6301680">.</span><span class="ident" id="6301681">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6301690">if</span>&nbsp;<span class="ident" id="6301693"><a href="/net/http/httptest/server.go.html#6301667">h</a></span>&nbsp;<span class="op" id="6301695">==</span>&nbsp;<span class="ident" id="6301698">nil</span>&nbsp;<span class="op" id="6301702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301706"><a href="/net/http/httptest/server.go.html#6301667">h</a></span>&nbsp;<span class="op" id="6301708">=</span>&nbsp;<span class="ident" id="6301710"><a href="/net/http/httptest/server.go.html#6298038">http</a></span><span class="op" id="6301714">.</span><span class="ident" id="6301715">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6301732">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301735"><a href="/net/http/httptest/server.go.html#6301639">s</a></span><span class="op" id="6301736">.</span><span class="ident" id="6301737">Config</span><span class="op" id="6301743">.</span><span class="ident" id="6301744">Handler</span>&nbsp;<span class="op" id="6301752">=</span>&nbsp;<span class="op" id="6301754">&amp;</span><span class="ident" id="6301755"><a href="/net/http/httptest/server.go.html#6302783">waitGroupHandler</a></span><span class="op" id="6301771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301775">s</span><span class="op" id="6301776">:</span>&nbsp;<span class="ident" id="6301778"><a href="/net/http/httptest/server.go.html#6301639">s</a></span><span class="op" id="6301779">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301783">h</span><span class="op" id="6301784">:</span>&nbsp;<span class="ident" id="6301786"><a href="/net/http/httptest/server.go.html#6301667">h</a></span><span class="op" id="6301787">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6301790">}</span><br>
<span class="lineno"></span><span class="op" id="6301792">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="6301795">//&nbsp;NewTLSServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;using&nbsp;TLS.</span><br>
<span class="lineno"></span><span class="comment" id="6301854">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="6301918">func</span>&nbsp;<span class="ident" id="6301923">NewTLSServer</span><span class="op" id="6301935">(</span><span class="ident" id="6301936">handler</span>&nbsp;<span class="ident" id="6301944"><a href="/net/http/httptest/server.go.html#6298038">http</a></span><span class="op" id="6301948">.</span><span class="ident" id="6301949">Handler</span><span class="op" id="6301956">)</span>&nbsp;<span class="op" id="6301958">*</span><span class="ident" id="6301959"><a href="/net/http/httptest/server.go.html#6298205">Server</a></span>&nbsp;<span class="op" id="6301966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6301969">ts</span>&nbsp;<span class="op" id="6301972">:=</span>&nbsp;<span class="ident" id="6301975"><a href="/net/http/httptest/server.go.html#6300353">NewUnstartedServer</a></span><span class="op" id="6301993">(</span><span class="ident" id="6301994"><a href="/net/http/httptest/server.go.html#6301936">handler</a></span><span class="op" id="6302001">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302004"><a href="/net/http/httptest/server.go.html#6301969">ts</a></span><span class="op" id="6302006">.</span><span class="ident" id="6302007">StartTLS</span><span class="op" id="6302015">(</span><span class="op" id="6302016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302019">return</span>&nbsp;<span class="ident" id="6302026"><a href="/net/http/httptest/server.go.html#6301969">ts</a></span><br>
<span class="lineno"></span><span class="op" id="6302029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6302032">//&nbsp;Close&nbsp;shuts&nbsp;down&nbsp;the&nbsp;server&nbsp;and&nbsp;blocks&nbsp;until&nbsp;all&nbsp;outstanding</span><br>
<span class="lineno">165</span><span class="comment" id="6302096">//&nbsp;requests&nbsp;on&nbsp;this&nbsp;server&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="6302139">func</span>&nbsp;<span class="op" id="6302144">(</span><span class="ident" id="6302145">s</span>&nbsp;<span class="op" id="6302147">*</span><span class="ident" id="6302148"><a href="/net/http/httptest/server.go.html#6298205">Server</a></span><span class="op" id="6302154">)</span>&nbsp;<span class="ident" id="6302156">Close</span><span class="op" id="6302161">(</span><span class="op" id="6302162">)</span>&nbsp;<span class="op" id="6302164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302167"><a href="/net/http/httptest/server.go.html#6302145">s</a></span><span class="op" id="6302168">.</span><span class="ident" id="6302169">Listener</span><span class="op" id="6302177">.</span><span class="ident" id="6302178">Close</span><span class="op" id="6302183">(</span><span class="op" id="6302184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302187"><a href="/net/http/httptest/server.go.html#6302145">s</a></span><span class="op" id="6302188">.</span><span class="ident" id="6302189">wg</span><span class="op" id="6302191">.</span><span class="ident" id="6302192">Wait</span><span class="op" id="6302196">(</span><span class="op" id="6302197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302200"><a href="/net/http/httptest/server.go.html#6302145">s</a></span><span class="op" id="6302201">.</span><span class="ident" id="6302202">CloseClientConnections</span><span class="op" id="6302224">(</span><span class="op" id="6302225">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302228">if</span>&nbsp;<span class="ident" id="6302231">t</span><span class="op" id="6302232">,</span>&nbsp;<span class="ident" id="6302234">ok</span>&nbsp;<span class="op" id="6302237">:=</span>&nbsp;<span class="ident" id="6302240"><a href="/net/http/httptest/server.go.html#6298038">http</a></span><span class="op" id="6302244">.</span><span class="ident" id="6302245">DefaultTransport</span><span class="op" id="6302261">.</span><span class="op" id="6302262">(</span><span class="op" id="6302263">*</span><span class="ident" id="6302264"><a href="/net/http/httptest/server.go.html#6298038">http</a></span><span class="op" id="6302268">.</span><span class="ident" id="6302269">Transport</span><span class="op" id="6302278">)</span><span class="op" id="6302279">;</span>&nbsp;<span class="ident" id="6302281"><a href="/net/http/httptest/server.go.html#6302234">ok</a></span>&nbsp;<span class="op" id="6302284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302288"><a href="/net/http/httptest/server.go.html#6302231">t</a></span><span class="op" id="6302289">.</span><span class="ident" id="6302290">CloseIdleConnections</span><span class="op" id="6302310">(</span><span class="op" id="6302311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6302314">}</span><br>
<span class="lineno"></span><span class="op" id="6302316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="6302319">//&nbsp;CloseClientConnections&nbsp;closes&nbsp;any&nbsp;currently&nbsp;open&nbsp;HTTP&nbsp;connections</span><br>
<span class="lineno"></span><span class="comment" id="6302388">//&nbsp;to&nbsp;the&nbsp;test&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="6302411">func</span>&nbsp;<span class="op" id="6302416">(</span><span class="ident" id="6302417">s</span>&nbsp;<span class="op" id="6302419">*</span><span class="ident" id="6302420"><a href="/net/http/httptest/server.go.html#6298205">Server</a></span><span class="op" id="6302426">)</span>&nbsp;<span class="ident" id="6302428">CloseClientConnections</span><span class="op" id="6302450">(</span><span class="op" id="6302451">)</span>&nbsp;<span class="op" id="6302453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302456">hl</span><span class="op" id="6302458">,</span>&nbsp;<span class="ident" id="6302460">ok</span>&nbsp;<span class="op" id="6302463">:=</span>&nbsp;<span class="ident" id="6302466"><a href="/net/http/httptest/server.go.html#6302417">s</a></span><span class="op" id="6302467">.</span><span class="ident" id="6302468">Listener</span><span class="op" id="6302476">.</span><span class="op" id="6302477">(</span><span class="op" id="6302478">*</span><span class="ident" id="6302479"><a href="/net/http/httptest/server.go.html#6298888">historyListener</a></span><span class="op" id="6302494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302497">if</span>&nbsp;<span class="op" id="6302500">!</span><span class="ident" id="6302501"><a href="/net/http/httptest/server.go.html#6302460">ok</a></span>&nbsp;<span class="op" id="6302504">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302508">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6302516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302519"><a href="/net/http/httptest/server.go.html#6302456">hl</a></span><span class="op" id="6302521">.</span><span class="ident" id="6302522">Lock</span><span class="op" id="6302526">(</span><span class="op" id="6302527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302530">for</span>&nbsp;<span class="ident" id="6302534">_</span><span class="op" id="6302535">,</span>&nbsp;<span class="ident" id="6302537">conn</span>&nbsp;<span class="op" id="6302542">:=</span>&nbsp;<span class="keyword" id="6302545">range</span>&nbsp;<span class="ident" id="6302551"><a href="/net/http/httptest/server.go.html#6302456">hl</a></span><span class="op" id="6302553">.</span><span class="ident" id="6302554">history</span>&nbsp;<span class="op" id="6302562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302566"><a href="/net/http/httptest/server.go.html#6302537">conn</a></span><span class="op" id="6302570">.</span><span class="ident" id="6302571">Close</span><span class="op" id="6302576">(</span><span class="op" id="6302577">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6302580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302583"><a href="/net/http/httptest/server.go.html#6302456">hl</a></span><span class="op" id="6302585">.</span><span class="ident" id="6302586">Unlock</span><span class="op" id="6302592">(</span><span class="op" id="6302593">)</span><br>
<span class="lineno"></span><span class="op" id="6302595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6302598">//&nbsp;waitGroupHandler&nbsp;wraps&nbsp;a&nbsp;handler,&nbsp;incrementing&nbsp;and&nbsp;decrementing&nbsp;a</span><br>
<span class="lineno">190</span><span class="comment" id="6302667">//&nbsp;sync.WaitGroup&nbsp;on&nbsp;each&nbsp;request,&nbsp;to&nbsp;enable&nbsp;Server.Close&nbsp;to&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="6302734">//&nbsp;until&nbsp;outstanding&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="6302778">type</span>&nbsp;<span class="ident" id="6302783">waitGroupHandler</span>&nbsp;<span class="keyword" id="6302800">struct</span>&nbsp;<span class="op" id="6302807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302810">s</span>&nbsp;<span class="op" id="6302812">*</span><span class="ident" id="6302813"><a href="/net/http/httptest/server.go.html#6298205">Server</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302821">h</span>&nbsp;<span class="ident" id="6302823"><a href="/net/http/httptest/server.go.html#6298038">http</a></span><span class="op" id="6302827">.</span><span class="ident" id="6302828">Handler</span>&nbsp;<span class="comment" id="6302836">//&nbsp;non-nil</span><br>
<span class="lineno">195</span><span class="op" id="6302847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6302850">func</span>&nbsp;<span class="op" id="6302855">(</span><span class="ident" id="6302856">h</span>&nbsp;<span class="op" id="6302858">*</span><span class="ident" id="6302859"><a href="/net/http/httptest/server.go.html#6302783">waitGroupHandler</a></span><span class="op" id="6302875">)</span>&nbsp;<span class="ident" id="6302877">ServeHTTP</span><span class="op" id="6302886">(</span><span class="ident" id="6302887">w</span>&nbsp;<span class="ident" id="6302889"><a href="/net/http/httptest/server.go.html#6298038">http</a></span><span class="op" id="6302893">.</span><span class="ident" id="6302894">ResponseWriter</span><span class="op" id="6302908">,</span>&nbsp;<span class="ident" id="6302910">r</span>&nbsp;<span class="op" id="6302912">*</span><span class="ident" id="6302913"><a href="/net/http/httptest/server.go.html#6298038">http</a></span><span class="op" id="6302917">.</span><span class="ident" id="6302918">Request</span><span class="op" id="6302925">)</span>&nbsp;<span class="op" id="6302927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6302930"><a href="/net/http/httptest/server.go.html#6302856">h</a></span><span class="op" id="6302931">.</span><span class="ident" id="6302932">s</span><span class="op" id="6302933">.</span><span class="ident" id="6302934">wg</span><span class="op" id="6302936">.</span><span class="ident" id="6302937">Add</span><span class="op" id="6302940">(</span><span class="num" id="6302941">1</span><span class="op" id="6302942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6302945">defer</span>&nbsp;<span class="ident" id="6302951"><a href="/net/http/httptest/server.go.html#6302856">h</a></span><span class="op" id="6302952">.</span><span class="ident" id="6302953">s</span><span class="op" id="6302954">.</span><span class="ident" id="6302955">wg</span><span class="op" id="6302957">.</span><span class="ident" id="6302958">Done</span><span class="op" id="6302962">(</span><span class="op" id="6302963">)</span>&nbsp;<span class="comment" id="6302965">//&nbsp;a&nbsp;defer,&nbsp;in&nbsp;case&nbsp;ServeHTTP&nbsp;below&nbsp;panics</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6303009"><a href="/net/http/httptest/server.go.html#6302856">h</a></span><span class="op" id="6303010">.</span><span class="ident" id="6303011">h</span><span class="op" id="6303012">.</span><span class="ident" id="6303013">ServeHTTP</span><span class="op" id="6303022">(</span><span class="ident" id="6303023"><a href="/net/http/httptest/server.go.html#6302887">w</a></span><span class="op" id="6303024">,</span>&nbsp;<span class="ident" id="6303026"><a href="/net/http/httptest/server.go.html#6302910">r</a></span><span class="op" id="6303027">)</span><br>
<span class="lineno"></span><span class="op" id="6303029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6303032">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno"></span><span class="comment" id="6303088">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno">205</span><span class="comment" id="6303161">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="6303180">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="6303214">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="6303350">var</span>&nbsp;<span class="ident" id="6303354">localhostCert</span>&nbsp;<span class="op" id="6303368">=</span>&nbsp;<span class="op" id="6303370">[</span><span class="op" id="6303371">]</span><span class="builtintype" id="6303372">byte</span><span class="op" id="6303376">(</span><span class="string" id="6303377">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno"></span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno">210</span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno"></span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno">215</span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="6303948">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6303951">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno">220</span><span class="keyword" id="6304005">var</span>&nbsp;<span class="ident" id="6304009">localhostKey</span>&nbsp;<span class="op" id="6304022">=</span>&nbsp;<span class="op" id="6304024">[</span><span class="op" id="6304025">]</span><span class="builtintype" id="6304026">byte</span><span class="op" id="6304030">(</span><span class="string" id="6304031">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno"></span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno">225</span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="6304529">)</span>
</div>
</body>
</html>
