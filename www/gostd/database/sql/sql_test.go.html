<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7605610">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7605665">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7605719">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7605770">package</span>&nbsp;<span class="ident" id="7605778">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7605783">import</span>&nbsp;<span class="op" id="7605790">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7605793">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7605816">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7605826">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7605833">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7605846">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7605857">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7605868">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7605879">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7605887">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7605898">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7605905">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="7605908">func</span>&nbsp;<span class="ident" id="7605913">init</span><span class="op" id="7605917">(</span><span class="op" id="7605918">)</span>&nbsp;<span class="op" id="7605920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7605923">type</span>&nbsp;<span class="ident" id="7605928">dbConn</span>&nbsp;<span class="keyword" id="7605935">struct</span>&nbsp;<span class="op" id="7605942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7605946">db</span>&nbsp;<span class="op" id="7605949">*</span><span class="ident" id="7605950">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7605955">c</span>&nbsp;&nbsp;<span class="op" id="7605958">*</span><span class="ident" id="7605959">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7605971">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7605974">freedFrom</span>&nbsp;<span class="op" id="7605984">:=</span>&nbsp;<span class="builtinfunc" id="7605987">make</span><span class="op" id="7605991">(</span><span class="keyword" id="7605992">map</span><span class="op" id="7605995">[</span><span class="ident" id="7605996">dbConn</span><span class="op" id="7606002">]</span><span class="builtintype" id="7606003">string</span><span class="op" id="7606009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7606012">putConnHook</span>&nbsp;<span class="op" id="7606024">=</span>&nbsp;<span class="keyword" id="7606026">func</span><span class="op" id="7606030">(</span><span class="ident" id="7606031">db</span>&nbsp;<span class="op" id="7606034">*</span><span class="ident" id="7606035">DB</span><span class="op" id="7606037">,</span>&nbsp;<span class="ident" id="7606039">c</span>&nbsp;<span class="op" id="7606041">*</span><span class="ident" id="7606042">driverConn</span><span class="op" id="7606052">)</span>&nbsp;<span class="op" id="7606054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7606058">idx</span>&nbsp;<span class="op" id="7606062">:=</span>&nbsp;<span class="op" id="7606065">-</span><span class="num" id="7606066">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7606070">for</span>&nbsp;<span class="ident" id="7606074">i</span><span class="op" id="7606075">,</span>&nbsp;<span class="ident" id="7606077">v</span>&nbsp;<span class="op" id="7606079">:=</span>&nbsp;<span class="keyword" id="7606082">range</span>&nbsp;<span class="ident" id="7606088">db</span><span class="op" id="7606090">.</span><span class="ident" id="7606091">freeConn</span>&nbsp;<span class="op" id="7606100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7606105">if</span>&nbsp;<span class="ident" id="7606108">v</span>&nbsp;<span class="op" id="7606110">==</span>&nbsp;<span class="ident" id="7606113">c</span>&nbsp;<span class="op" id="7606115">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7606121">idx</span>&nbsp;<span class="op" id="7606125">=</span>&nbsp;<span class="ident" id="7606127">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7606133">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7606142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7606146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7606150">if</span>&nbsp;<span class="ident" id="7606153">idx</span>&nbsp;<span class="op" id="7606157">&gt;=</span>&nbsp;<span class="num" id="7606160">0</span>&nbsp;<span class="op" id="7606162">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7606167">//&nbsp;print&nbsp;before&nbsp;panic,&nbsp;as&nbsp;panic&nbsp;may&nbsp;get&nbsp;lost&nbsp;due&nbsp;to&nbsp;conflicting&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7606240">//&nbsp;(all&nbsp;goroutines&nbsp;asleep)&nbsp;elsewhere,&nbsp;since&nbsp;we&nbsp;might&nbsp;not&nbsp;unlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7606307">//&nbsp;the&nbsp;mutex&nbsp;in&nbsp;freeConn&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7606341">println</span><span class="op" id="7606348">(</span><span class="string" id="7606349">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&nbsp;conflicts&nbsp;are:\nA)&nbsp;&#34;</span>&nbsp;<span class="op" id="7606392">+</span>&nbsp;<span class="ident" id="7606394">freedFrom</span><span class="op" id="7606403">[</span><span class="ident" id="7606404">dbConn</span><span class="op" id="7606410">{</span><span class="ident" id="7606411">db</span><span class="op" id="7606413">,</span>&nbsp;<span class="ident" id="7606415">c</span><span class="op" id="7606416">}</span><span class="op" id="7606417">]</span>&nbsp;<span class="op" id="7606419">+</span>&nbsp;<span class="string" id="7606421">&#34;\n\nand\nB)&nbsp;&#34;</span>&nbsp;<span class="op" id="7606436">+</span>&nbsp;<span class="ident" id="7606438">stack</span><span class="op" id="7606443">(</span><span class="op" id="7606444">)</span><span class="op" id="7606445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7606450">panic</span><span class="op" id="7606455">(</span><span class="string" id="7606456">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&#34;</span><span class="op" id="7606478">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7606482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7606486">freedFrom</span><span class="op" id="7606495">[</span><span class="ident" id="7606496">dbConn</span><span class="op" id="7606502">{</span><span class="ident" id="7606503">db</span><span class="op" id="7606505">,</span>&nbsp;<span class="ident" id="7606507">c</span><span class="op" id="7606508">}</span><span class="op" id="7606509">]</span>&nbsp;<span class="op" id="7606511">=</span>&nbsp;<span class="ident" id="7606513">stack</span><span class="op" id="7606518">(</span><span class="op" id="7606519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7606522">}</span><br>
<span class="lineno"></span><span class="op" id="7606524">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="7606527">const</span>&nbsp;<span class="ident" id="7606533">fakeDBName</span>&nbsp;<span class="op" id="7606544">=</span>&nbsp;<span class="string" id="7606546">&#34;foo&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7606553">var</span>&nbsp;<span class="ident" id="7606557">chrisBirthday</span>&nbsp;<span class="op" id="7606571">=</span>&nbsp;<span class="ident" id="7606573">time</span><span class="op" id="7606577">.</span><span class="ident" id="7606578">Unix</span><span class="op" id="7606582">(</span><span class="num" id="7606583">123456789</span><span class="op" id="7606592">,</span>&nbsp;<span class="num" id="7606594">0</span><span class="op" id="7606595">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7606598">func</span>&nbsp;<span class="ident" id="7606603">newTestDB</span><span class="op" id="7606612">(</span><span class="ident" id="7606613">t</span>&nbsp;<span class="ident" id="7606615">testing</span><span class="op" id="7606622">.</span><span class="ident" id="7606623">TB</span><span class="op" id="7606625">,</span>&nbsp;<span class="ident" id="7606627">name</span>&nbsp;<span class="builtintype" id="7606632">string</span><span class="op" id="7606638">)</span>&nbsp;<span class="op" id="7606640">*</span><span class="ident" id="7606641">DB</span>&nbsp;<span class="op" id="7606644">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7606647">db</span><span class="op" id="7606649">,</span>&nbsp;<span class="ident" id="7606651">err</span>&nbsp;<span class="op" id="7606655">:=</span>&nbsp;<span class="ident" id="7606658">Open</span><span class="op" id="7606662">(</span><span class="string" id="7606663">&#34;test&#34;</span><span class="op" id="7606669">,</span>&nbsp;<span class="ident" id="7606671">fakeDBName</span><span class="op" id="7606681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7606684">if</span>&nbsp;<span class="ident" id="7606687">err</span>&nbsp;<span class="op" id="7606691">!=</span>&nbsp;<span class="ident" id="7606694">nil</span>&nbsp;<span class="op" id="7606698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7606702">t</span><span class="op" id="7606703">.</span><span class="ident" id="7606704">Fatalf</span><span class="op" id="7606710">(</span><span class="string" id="7606711">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="7606721">,</span>&nbsp;<span class="ident" id="7606723">err</span><span class="op" id="7606726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7606729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7606732">if</span>&nbsp;<span class="ident" id="7606735">_</span><span class="op" id="7606736">,</span>&nbsp;<span class="ident" id="7606738">err</span>&nbsp;<span class="op" id="7606742">:=</span>&nbsp;<span class="ident" id="7606745">db</span><span class="op" id="7606747">.</span><span class="ident" id="7606748">Exec</span><span class="op" id="7606752">(</span><span class="string" id="7606753">&#34;WIPE&#34;</span><span class="op" id="7606759">)</span><span class="op" id="7606760">;</span>&nbsp;<span class="ident" id="7606762">err</span>&nbsp;<span class="op" id="7606766">!=</span>&nbsp;<span class="ident" id="7606769">nil</span>&nbsp;<span class="op" id="7606773">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7606777">t</span><span class="op" id="7606778">.</span><span class="ident" id="7606779">Fatalf</span><span class="op" id="7606785">(</span><span class="string" id="7606786">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="7606801">,</span>&nbsp;<span class="ident" id="7606803">err</span><span class="op" id="7606806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7606809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7606812">if</span>&nbsp;<span class="ident" id="7606815">name</span>&nbsp;<span class="op" id="7606820">==</span>&nbsp;<span class="string" id="7606823">&#34;people&#34;</span>&nbsp;<span class="op" id="7606832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7606836">exec</span><span class="op" id="7606840">(</span><span class="ident" id="7606841">t</span><span class="op" id="7606842">,</span>&nbsp;<span class="ident" id="7606844">db</span><span class="op" id="7606846">,</span>&nbsp;<span class="string" id="7606848">&#34;CREATE|people|name=string,age=int32,photo=blob,dead=bool,bdate=datetime&#34;</span><span class="op" id="7606921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7606925">exec</span><span class="op" id="7606929">(</span><span class="ident" id="7606930">t</span><span class="op" id="7606931">,</span>&nbsp;<span class="ident" id="7606933">db</span><span class="op" id="7606935">,</span>&nbsp;<span class="string" id="7606937">&#34;INSERT|people|name=Alice,age=?,photo=APHOTO&#34;</span><span class="op" id="7606982">,</span>&nbsp;<span class="num" id="7606984">1</span><span class="op" id="7606985">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7606989">exec</span><span class="op" id="7606993">(</span><span class="ident" id="7606994">t</span><span class="op" id="7606995">,</span>&nbsp;<span class="ident" id="7606997">db</span><span class="op" id="7606999">,</span>&nbsp;<span class="string" id="7607001">&#34;INSERT|people|name=Bob,age=?,photo=BPHOTO&#34;</span><span class="op" id="7607044">,</span>&nbsp;<span class="num" id="7607046">2</span><span class="op" id="7607047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607051">exec</span><span class="op" id="7607055">(</span><span class="ident" id="7607056">t</span><span class="op" id="7607057">,</span>&nbsp;<span class="ident" id="7607059">db</span><span class="op" id="7607061">,</span>&nbsp;<span class="string" id="7607063">&#34;INSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7607116">,</span>&nbsp;<span class="num" id="7607118">3</span><span class="op" id="7607119">,</span>&nbsp;<span class="ident" id="7607121">chrisBirthday</span><span class="op" id="7607134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7607137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7607140">if</span>&nbsp;<span class="ident" id="7607143">name</span>&nbsp;<span class="op" id="7607148">==</span>&nbsp;<span class="string" id="7607151">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="7607164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7607168">//&nbsp;Magic&nbsp;table&nbsp;name&nbsp;and&nbsp;column,&nbsp;known&nbsp;by&nbsp;fakedb_test.go.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607227">exec</span><span class="op" id="7607231">(</span><span class="ident" id="7607232">t</span><span class="op" id="7607233">,</span>&nbsp;<span class="ident" id="7607235">db</span><span class="op" id="7607237">,</span>&nbsp;<span class="string" id="7607239">&#34;CREATE|magicquery|op=string,millis=int32&#34;</span><span class="op" id="7607281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607285">exec</span><span class="op" id="7607289">(</span><span class="ident" id="7607290">t</span><span class="op" id="7607291">,</span>&nbsp;<span class="ident" id="7607293">db</span><span class="op" id="7607295">,</span>&nbsp;<span class="string" id="7607297">&#34;INSERT|magicquery|op=sleep,millis=10&#34;</span><span class="op" id="7607335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7607338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7607341">return</span>&nbsp;<span class="ident" id="7607348">db</span><br>
<span class="lineno"></span><span class="op" id="7607351">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="7607354">func</span>&nbsp;<span class="ident" id="7607359">exec</span><span class="op" id="7607363">(</span><span class="ident" id="7607364">t</span>&nbsp;<span class="ident" id="7607366">testing</span><span class="op" id="7607373">.</span><span class="ident" id="7607374">TB</span><span class="op" id="7607376">,</span>&nbsp;<span class="ident" id="7607378">db</span>&nbsp;<span class="op" id="7607381">*</span><span class="ident" id="7607382">DB</span><span class="op" id="7607384">,</span>&nbsp;<span class="ident" id="7607386">query</span>&nbsp;<span class="builtintype" id="7607392">string</span><span class="op" id="7607398">,</span>&nbsp;<span class="ident" id="7607400">args</span>&nbsp;<span class="op" id="7607405">...</span><span class="keyword" id="7607408">interface</span><span class="op" id="7607417">{</span><span class="op" id="7607418">}</span><span class="op" id="7607419">)</span>&nbsp;<span class="op" id="7607421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607424">_</span><span class="op" id="7607425">,</span>&nbsp;<span class="ident" id="7607427">err</span>&nbsp;<span class="op" id="7607431">:=</span>&nbsp;<span class="ident" id="7607434">db</span><span class="op" id="7607436">.</span><span class="ident" id="7607437">Exec</span><span class="op" id="7607441">(</span><span class="ident" id="7607442">query</span><span class="op" id="7607447">,</span>&nbsp;<span class="ident" id="7607449">args</span><span class="op" id="7607453">...</span><span class="op" id="7607456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7607459">if</span>&nbsp;<span class="ident" id="7607462">err</span>&nbsp;<span class="op" id="7607466">!=</span>&nbsp;<span class="ident" id="7607469">nil</span>&nbsp;<span class="op" id="7607473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607477">t</span><span class="op" id="7607478">.</span><span class="ident" id="7607479">Fatalf</span><span class="op" id="7607485">(</span><span class="string" id="7607486">&#34;Exec&nbsp;of&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="7607502">,</span>&nbsp;<span class="ident" id="7607504">query</span><span class="op" id="7607509">,</span>&nbsp;<span class="ident" id="7607511">err</span><span class="op" id="7607514">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7607517">}</span><br>
<span class="lineno"></span><span class="op" id="7607519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7607522">func</span>&nbsp;<span class="ident" id="7607527">closeDB</span><span class="op" id="7607534">(</span><span class="ident" id="7607535">t</span>&nbsp;<span class="ident" id="7607537">testing</span><span class="op" id="7607544">.</span><span class="ident" id="7607545">TB</span><span class="op" id="7607547">,</span>&nbsp;<span class="ident" id="7607549">db</span>&nbsp;<span class="op" id="7607552">*</span><span class="ident" id="7607553">DB</span><span class="op" id="7607555">)</span>&nbsp;<span class="op" id="7607557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7607560">if</span>&nbsp;<span class="ident" id="7607563">e</span>&nbsp;<span class="op" id="7607565">:=</span>&nbsp;<span class="builtinfunc" id="7607568">recover</span><span class="op" id="7607575">(</span><span class="op" id="7607576">)</span><span class="op" id="7607577">;</span>&nbsp;<span class="ident" id="7607579">e</span>&nbsp;<span class="op" id="7607581">!=</span>&nbsp;<span class="ident" id="7607584">nil</span>&nbsp;<span class="op" id="7607588">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607592">fmt</span><span class="op" id="7607595">.</span><span class="ident" id="7607596">Printf</span><span class="op" id="7607602">(</span><span class="string" id="7607603">&#34;Panic:&nbsp;%v\n&#34;</span><span class="op" id="7607616">,</span>&nbsp;<span class="ident" id="7607618">e</span><span class="op" id="7607619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7607623">panic</span><span class="op" id="7607628">(</span><span class="ident" id="7607629">e</span><span class="op" id="7607630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7607633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7607636">defer</span>&nbsp;<span class="ident" id="7607642">setHookpostCloseConn</span><span class="op" id="7607662">(</span><span class="ident" id="7607663">nil</span><span class="op" id="7607666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607669">setHookpostCloseConn</span><span class="op" id="7607689">(</span><span class="keyword" id="7607690">func</span><span class="op" id="7607694">(</span><span class="ident" id="7607695">_</span>&nbsp;<span class="op" id="7607697">*</span><span class="ident" id="7607698">fakeConn</span><span class="op" id="7607706">,</span>&nbsp;<span class="ident" id="7607708">err</span>&nbsp;<span class="builtintype" id="7607712">error</span><span class="op" id="7607717">)</span>&nbsp;<span class="op" id="7607719">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7607723">if</span>&nbsp;<span class="ident" id="7607726">err</span>&nbsp;<span class="op" id="7607730">!=</span>&nbsp;<span class="ident" id="7607733">nil</span>&nbsp;<span class="op" id="7607737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7607742">t</span><span class="op" id="7607743">.</span><span class="ident" id="7607744">Errorf</span><span class="op" id="7607750">(</span><span class="string" id="7607751">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7607779">,</span>&nbsp;<span class="ident" id="7607781">err</span><span class="op" id="7607784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7607788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7607791">}</span><span class="op" id="7607792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7607795">for</span>&nbsp;<span class="ident" id="7607799">i</span><span class="op" id="7607800">,</span>&nbsp;<span class="ident" id="7607802">dc</span>&nbsp;<span class="op" id="7607805">:=</span>&nbsp;<span class="keyword" id="7607808">range</span>&nbsp;<span class="ident" id="7607814">db</span><span class="op" id="7607816">.</span><span class="ident" id="7607817">freeConn</span>&nbsp;<span class="op" id="7607826">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7607830">if</span>&nbsp;<span class="ident" id="7607833">n</span>&nbsp;<span class="op" id="7607835">:=</span>&nbsp;<span class="builtinfunc" id="7607838">len</span><span class="op" id="7607841">(</span><span class="ident" id="7607842">dc</span><span class="op" id="7607844">.</span><span class="ident" id="7607845">openStmt</span><span class="op" id="7607853">)</span><span class="op" id="7607854">;</span>&nbsp;<span class="ident" id="7607856">n</span>&nbsp;<span class="op" id="7607858">&gt;</span>&nbsp;<span class="num" id="7607860">0</span>&nbsp;<span class="op" id="7607862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7607867">//&nbsp;Just&nbsp;a&nbsp;sanity&nbsp;check.&nbsp;This&nbsp;is&nbsp;legal&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7607911">//&nbsp;general,&nbsp;but&nbsp;if&nbsp;we&nbsp;make&nbsp;the&nbsp;tests&nbsp;clean&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7607960">//&nbsp;their&nbsp;statements&nbsp;first,&nbsp;then&nbsp;we&nbsp;can&nbsp;safely</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7608009">//&nbsp;verify&nbsp;this&nbsp;is&nbsp;always&nbsp;zero&nbsp;here,&nbsp;and&nbsp;any</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7608056">//&nbsp;other&nbsp;value&nbsp;is&nbsp;a&nbsp;leak.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608085">t</span><span class="op" id="7608086">.</span><span class="ident" id="7608087">Errorf</span><span class="op" id="7608093">(</span><span class="string" id="7608094">&#34;while&nbsp;closing&nbsp;db,&nbsp;freeConn&nbsp;%d/%d&nbsp;had&nbsp;%d&nbsp;open&nbsp;stmts;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7608154">,</span>&nbsp;<span class="ident" id="7608156">i</span><span class="op" id="7608157">,</span>&nbsp;<span class="builtinfunc" id="7608159">len</span><span class="op" id="7608162">(</span><span class="ident" id="7608163">db</span><span class="op" id="7608165">.</span><span class="ident" id="7608166">freeConn</span><span class="op" id="7608174">)</span><span class="op" id="7608175">,</span>&nbsp;<span class="ident" id="7608177">n</span><span class="op" id="7608178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7608182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7608185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608188">err</span>&nbsp;<span class="op" id="7608192">:=</span>&nbsp;<span class="ident" id="7608195">db</span><span class="op" id="7608197">.</span><span class="ident" id="7608198">Close</span><span class="op" id="7608203">(</span><span class="op" id="7608204">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608207">if</span>&nbsp;<span class="ident" id="7608210">err</span>&nbsp;<span class="op" id="7608214">!=</span>&nbsp;<span class="ident" id="7608217">nil</span>&nbsp;<span class="op" id="7608221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608225">t</span><span class="op" id="7608226">.</span><span class="ident" id="7608227">Fatalf</span><span class="op" id="7608233">(</span><span class="string" id="7608234">&#34;error&nbsp;closing&nbsp;DB:&nbsp;%v&#34;</span><span class="op" id="7608256">,</span>&nbsp;<span class="ident" id="7608258">err</span><span class="op" id="7608261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7608264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608267">db</span><span class="op" id="7608269">.</span><span class="ident" id="7608270">mu</span><span class="op" id="7608272">.</span><span class="ident" id="7608273">Lock</span><span class="op" id="7608277">(</span><span class="op" id="7608278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608281">count</span>&nbsp;<span class="op" id="7608287">:=</span>&nbsp;<span class="ident" id="7608290">db</span><span class="op" id="7608292">.</span><span class="ident" id="7608293">numOpen</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608302">db</span><span class="op" id="7608304">.</span><span class="ident" id="7608305">mu</span><span class="op" id="7608307">.</span><span class="ident" id="7608308">Unlock</span><span class="op" id="7608314">(</span><span class="op" id="7608315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608318">if</span>&nbsp;<span class="ident" id="7608321">count</span>&nbsp;<span class="op" id="7608327">!=</span>&nbsp;<span class="num" id="7608330">0</span>&nbsp;<span class="op" id="7608332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608336">t</span><span class="op" id="7608337">.</span><span class="ident" id="7608338">Fatalf</span><span class="op" id="7608344">(</span><span class="string" id="7608345">&#34;%d&nbsp;connections&nbsp;still&nbsp;open&nbsp;after&nbsp;closing&nbsp;DB&#34;</span><span class="op" id="7608389">,</span>&nbsp;<span class="ident" id="7608391">db</span><span class="op" id="7608393">.</span><span class="ident" id="7608394">numOpen</span><span class="op" id="7608401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7608404">}</span><br>
<span class="lineno"></span><span class="op" id="7608406">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="comment" id="7608409">//&nbsp;numPrepares&nbsp;assumes&nbsp;that&nbsp;db&nbsp;has&nbsp;exactly&nbsp;1&nbsp;idle&nbsp;conn&nbsp;and&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="7608476">//&nbsp;its&nbsp;count&nbsp;of&nbsp;calls&nbsp;to&nbsp;Prepare</span><br>
<span class="lineno"></span><span class="keyword" id="7608509">func</span>&nbsp;<span class="ident" id="7608514">numPrepares</span><span class="op" id="7608525">(</span><span class="ident" id="7608526">t</span>&nbsp;<span class="op" id="7608528">*</span><span class="ident" id="7608529">testing</span><span class="op" id="7608536">.</span><span class="ident" id="7608537">T</span><span class="op" id="7608538">,</span>&nbsp;<span class="ident" id="7608540">db</span>&nbsp;<span class="op" id="7608543">*</span><span class="ident" id="7608544">DB</span><span class="op" id="7608546">)</span>&nbsp;<span class="builtintype" id="7608548">int</span>&nbsp;<span class="op" id="7608552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608555">if</span>&nbsp;<span class="ident" id="7608558">n</span>&nbsp;<span class="op" id="7608560">:=</span>&nbsp;<span class="builtinfunc" id="7608563">len</span><span class="op" id="7608566">(</span><span class="ident" id="7608567">db</span><span class="op" id="7608569">.</span><span class="ident" id="7608570">freeConn</span><span class="op" id="7608578">)</span><span class="op" id="7608579">;</span>&nbsp;<span class="ident" id="7608581">n</span>&nbsp;<span class="op" id="7608583">!=</span>&nbsp;<span class="num" id="7608586">1</span>&nbsp;<span class="op" id="7608588">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608592">t</span><span class="op" id="7608593">.</span><span class="ident" id="7608594">Fatalf</span><span class="op" id="7608600">(</span><span class="string" id="7608601">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7608626">,</span>&nbsp;<span class="ident" id="7608628">n</span><span class="op" id="7608629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7608632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608635">return</span>&nbsp;<span class="ident" id="7608642">db</span><span class="op" id="7608644">.</span><span class="ident" id="7608645">freeConn</span><span class="op" id="7608653">[</span><span class="num" id="7608654">0</span><span class="op" id="7608655">]</span><span class="op" id="7608656">.</span><span class="ident" id="7608657">ci</span><span class="op" id="7608659">.</span><span class="op" id="7608660">(</span><span class="op" id="7608661">*</span><span class="ident" id="7608662">fakeConn</span><span class="op" id="7608670">)</span><span class="op" id="7608671">.</span><span class="ident" id="7608672">numPrepare</span><br>
<span class="lineno"></span><span class="op" id="7608683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="7608686">func</span>&nbsp;<span class="op" id="7608691">(</span><span class="ident" id="7608692">db</span>&nbsp;<span class="op" id="7608695">*</span><span class="ident" id="7608696">DB</span><span class="op" id="7608698">)</span>&nbsp;<span class="ident" id="7608700">numDeps</span><span class="op" id="7608707">(</span><span class="op" id="7608708">)</span>&nbsp;<span class="builtintype" id="7608710">int</span>&nbsp;<span class="op" id="7608714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608717">db</span><span class="op" id="7608719">.</span><span class="ident" id="7608720">mu</span><span class="op" id="7608722">.</span><span class="ident" id="7608723">Lock</span><span class="op" id="7608727">(</span><span class="op" id="7608728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608731">defer</span>&nbsp;<span class="ident" id="7608737">db</span><span class="op" id="7608739">.</span><span class="ident" id="7608740">mu</span><span class="op" id="7608742">.</span><span class="ident" id="7608743">Unlock</span><span class="op" id="7608749">(</span><span class="op" id="7608750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608753">return</span>&nbsp;<span class="builtinfunc" id="7608760">len</span><span class="op" id="7608763">(</span><span class="ident" id="7608764">db</span><span class="op" id="7608766">.</span><span class="ident" id="7608767">dep</span><span class="op" id="7608770">)</span><br>
<span class="lineno"></span><span class="op" id="7608772">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="7608775">//&nbsp;Dependencies&nbsp;are&nbsp;closed&nbsp;via&nbsp;a&nbsp;goroutine,&nbsp;so&nbsp;this&nbsp;polls&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="7608845">//&nbsp;numDeps&nbsp;to&nbsp;fall&nbsp;to&nbsp;want,&nbsp;waiting&nbsp;up&nbsp;to&nbsp;d.</span><br>
<span class="lineno"></span><span class="keyword" id="7608890">func</span>&nbsp;<span class="op" id="7608895">(</span><span class="ident" id="7608896">db</span>&nbsp;<span class="op" id="7608899">*</span><span class="ident" id="7608900">DB</span><span class="op" id="7608902">)</span>&nbsp;<span class="ident" id="7608904">numDepsPollUntil</span><span class="op" id="7608920">(</span><span class="ident" id="7608921">want</span>&nbsp;<span class="builtintype" id="7608926">int</span><span class="op" id="7608929">,</span>&nbsp;<span class="ident" id="7608931">d</span>&nbsp;<span class="ident" id="7608933">time</span><span class="op" id="7608937">.</span><span class="ident" id="7608938">Duration</span><span class="op" id="7608946">)</span>&nbsp;<span class="builtintype" id="7608948">int</span>&nbsp;<span class="op" id="7608952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608955">deadline</span>&nbsp;<span class="op" id="7608964">:=</span>&nbsp;<span class="ident" id="7608967">time</span><span class="op" id="7608971">.</span><span class="ident" id="7608972">Now</span><span class="op" id="7608975">(</span><span class="op" id="7608976">)</span><span class="op" id="7608977">.</span><span class="ident" id="7608978">Add</span><span class="op" id="7608981">(</span><span class="ident" id="7608982">d</span><span class="op" id="7608983">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7608986">for</span>&nbsp;<span class="op" id="7608990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7608994">n</span>&nbsp;<span class="op" id="7608996">:=</span>&nbsp;<span class="ident" id="7608999">db</span><span class="op" id="7609001">.</span><span class="ident" id="7609002">numDeps</span><span class="op" id="7609009">(</span><span class="op" id="7609010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609014">if</span>&nbsp;<span class="ident" id="7609017">n</span>&nbsp;<span class="op" id="7609019">&lt;=</span>&nbsp;<span class="ident" id="7609022">want</span>&nbsp;<span class="op" id="7609027">||</span>&nbsp;<span class="ident" id="7609030">time</span><span class="op" id="7609034">.</span><span class="ident" id="7609035">Now</span><span class="op" id="7609038">(</span><span class="op" id="7609039">)</span><span class="op" id="7609040">.</span><span class="ident" id="7609041">After</span><span class="op" id="7609046">(</span><span class="ident" id="7609047">deadline</span><span class="op" id="7609055">)</span>&nbsp;<span class="op" id="7609057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609062">return</span>&nbsp;<span class="ident" id="7609069">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7609073">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609077">time</span><span class="op" id="7609081">.</span><span class="ident" id="7609082">Sleep</span><span class="op" id="7609087">(</span><span class="num" id="7609088">50</span>&nbsp;<span class="op" id="7609091">*</span>&nbsp;<span class="ident" id="7609093">time</span><span class="op" id="7609097">.</span><span class="ident" id="7609098">Millisecond</span><span class="op" id="7609109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7609112">}</span><br>
<span class="lineno"></span><span class="op" id="7609114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7609117">func</span>&nbsp;<span class="op" id="7609122">(</span><span class="ident" id="7609123">db</span>&nbsp;<span class="op" id="7609126">*</span><span class="ident" id="7609127">DB</span><span class="op" id="7609129">)</span>&nbsp;<span class="ident" id="7609131">numFreeConns</span><span class="op" id="7609143">(</span><span class="op" id="7609144">)</span>&nbsp;<span class="builtintype" id="7609146">int</span>&nbsp;<span class="op" id="7609150">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609153">db</span><span class="op" id="7609155">.</span><span class="ident" id="7609156">mu</span><span class="op" id="7609158">.</span><span class="ident" id="7609159">Lock</span><span class="op" id="7609163">(</span><span class="op" id="7609164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609167">defer</span>&nbsp;<span class="ident" id="7609173">db</span><span class="op" id="7609175">.</span><span class="ident" id="7609176">mu</span><span class="op" id="7609178">.</span><span class="ident" id="7609179">Unlock</span><span class="op" id="7609185">(</span><span class="op" id="7609186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609189">return</span>&nbsp;<span class="builtinfunc" id="7609196">len</span><span class="op" id="7609199">(</span><span class="ident" id="7609200">db</span><span class="op" id="7609202">.</span><span class="ident" id="7609203">freeConn</span><span class="op" id="7609211">)</span><br>
<span class="lineno"></span><span class="op" id="7609213">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="7609216">func</span>&nbsp;<span class="op" id="7609221">(</span><span class="ident" id="7609222">db</span>&nbsp;<span class="op" id="7609225">*</span><span class="ident" id="7609226">DB</span><span class="op" id="7609228">)</span>&nbsp;<span class="ident" id="7609230">dumpDeps</span><span class="op" id="7609238">(</span><span class="ident" id="7609239">t</span>&nbsp;<span class="op" id="7609241">*</span><span class="ident" id="7609242">testing</span><span class="op" id="7609249">.</span><span class="ident" id="7609250">T</span><span class="op" id="7609251">)</span>&nbsp;<span class="op" id="7609253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609256">for</span>&nbsp;<span class="ident" id="7609260">fc</span>&nbsp;<span class="op" id="7609263">:=</span>&nbsp;<span class="keyword" id="7609266">range</span>&nbsp;<span class="ident" id="7609272">db</span><span class="op" id="7609274">.</span><span class="ident" id="7609275">dep</span>&nbsp;<span class="op" id="7609279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609283">db</span><span class="op" id="7609285">.</span><span class="ident" id="7609286">dumpDep</span><span class="op" id="7609293">(</span><span class="ident" id="7609294">t</span><span class="op" id="7609295">,</span>&nbsp;<span class="num" id="7609297">0</span><span class="op" id="7609298">,</span>&nbsp;<span class="ident" id="7609300">fc</span><span class="op" id="7609302">,</span>&nbsp;<span class="keyword" id="7609304">map</span><span class="op" id="7609307">[</span><span class="ident" id="7609308">finalCloser</span><span class="op" id="7609319">]</span><span class="builtintype" id="7609320">bool</span><span class="op" id="7609324">{</span><span class="op" id="7609325">}</span><span class="op" id="7609326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7609329">}</span><br>
<span class="lineno"></span><span class="op" id="7609331">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="7609334">func</span>&nbsp;<span class="op" id="7609339">(</span><span class="ident" id="7609340">db</span>&nbsp;<span class="op" id="7609343">*</span><span class="ident" id="7609344">DB</span><span class="op" id="7609346">)</span>&nbsp;<span class="ident" id="7609348">dumpDep</span><span class="op" id="7609355">(</span><span class="ident" id="7609356">t</span>&nbsp;<span class="op" id="7609358">*</span><span class="ident" id="7609359">testing</span><span class="op" id="7609366">.</span><span class="ident" id="7609367">T</span><span class="op" id="7609368">,</span>&nbsp;<span class="ident" id="7609370">depth</span>&nbsp;<span class="builtintype" id="7609376">int</span><span class="op" id="7609379">,</span>&nbsp;<span class="ident" id="7609381">dep</span>&nbsp;<span class="ident" id="7609385">finalCloser</span><span class="op" id="7609396">,</span>&nbsp;<span class="ident" id="7609398">seen</span>&nbsp;<span class="keyword" id="7609403">map</span><span class="op" id="7609406">[</span><span class="ident" id="7609407">finalCloser</span><span class="op" id="7609418">]</span><span class="builtintype" id="7609419">bool</span><span class="op" id="7609423">)</span>&nbsp;<span class="op" id="7609425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609428">seen</span><span class="op" id="7609432">[</span><span class="ident" id="7609433">dep</span><span class="op" id="7609436">]</span>&nbsp;<span class="op" id="7609438">=</span>&nbsp;<span class="builtintype" id="7609440">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609446">indent</span>&nbsp;<span class="op" id="7609453">:=</span>&nbsp;<span class="ident" id="7609456">strings</span><span class="op" id="7609463">.</span><span class="ident" id="7609464">Repeat</span><span class="op" id="7609470">(</span><span class="string" id="7609471">&#34;&nbsp;&nbsp;&#34;</span><span class="op" id="7609475">,</span>&nbsp;<span class="ident" id="7609477">depth</span><span class="op" id="7609482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609485">ds</span>&nbsp;<span class="op" id="7609488">:=</span>&nbsp;<span class="ident" id="7609491">db</span><span class="op" id="7609493">.</span><span class="ident" id="7609494">dep</span><span class="op" id="7609497">[</span><span class="ident" id="7609498">dep</span><span class="op" id="7609501">]</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609504">for</span>&nbsp;<span class="ident" id="7609508">k</span>&nbsp;<span class="op" id="7609510">:=</span>&nbsp;<span class="keyword" id="7609513">range</span>&nbsp;<span class="ident" id="7609519">ds</span>&nbsp;<span class="op" id="7609522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609526">t</span><span class="op" id="7609527">.</span><span class="ident" id="7609528">Logf</span><span class="op" id="7609532">(</span><span class="string" id="7609533">&#34;%s%T&nbsp;(%p)&nbsp;waiting&nbsp;for&nbsp;-&gt;&nbsp;%T&nbsp;(%p)&#34;</span><span class="op" id="7609567">,</span>&nbsp;<span class="ident" id="7609569">indent</span><span class="op" id="7609575">,</span>&nbsp;<span class="ident" id="7609577">dep</span><span class="op" id="7609580">,</span>&nbsp;<span class="ident" id="7609582">dep</span><span class="op" id="7609585">,</span>&nbsp;<span class="ident" id="7609587">k</span><span class="op" id="7609588">,</span>&nbsp;<span class="ident" id="7609590">k</span><span class="op" id="7609591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609595">if</span>&nbsp;<span class="ident" id="7609598">fc</span><span class="op" id="7609600">,</span>&nbsp;<span class="ident" id="7609602">ok</span>&nbsp;<span class="op" id="7609605">:=</span>&nbsp;<span class="ident" id="7609608">k</span><span class="op" id="7609609">.</span><span class="op" id="7609610">(</span><span class="ident" id="7609611">finalCloser</span><span class="op" id="7609622">)</span><span class="op" id="7609623">;</span>&nbsp;<span class="ident" id="7609625">ok</span>&nbsp;<span class="op" id="7609628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609633">if</span>&nbsp;<span class="op" id="7609636">!</span><span class="ident" id="7609637">seen</span><span class="op" id="7609641">[</span><span class="ident" id="7609642">fc</span><span class="op" id="7609644">]</span>&nbsp;<span class="op" id="7609646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609652">db</span><span class="op" id="7609654">.</span><span class="ident" id="7609655">dumpDep</span><span class="op" id="7609662">(</span><span class="ident" id="7609663">t</span><span class="op" id="7609664">,</span>&nbsp;<span class="ident" id="7609666">depth</span><span class="op" id="7609671">+</span><span class="num" id="7609672">1</span><span class="op" id="7609673">,</span>&nbsp;<span class="ident" id="7609675">fc</span><span class="op" id="7609677">,</span>&nbsp;<span class="ident" id="7609679">seen</span><span class="op" id="7609683">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7609688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7609692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7609695">}</span><br>
<span class="lineno"></span><span class="op" id="7609697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="7609700">func</span>&nbsp;<span class="ident" id="7609705">TestQuery</span><span class="op" id="7609714">(</span><span class="ident" id="7609715">t</span>&nbsp;<span class="op" id="7609717">*</span><span class="ident" id="7609718">testing</span><span class="op" id="7609725">.</span><span class="ident" id="7609726">T</span><span class="op" id="7609727">)</span>&nbsp;<span class="op" id="7609729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609732">db</span>&nbsp;<span class="op" id="7609735">:=</span>&nbsp;<span class="ident" id="7609738">newTestDB</span><span class="op" id="7609747">(</span><span class="ident" id="7609748">t</span><span class="op" id="7609749">,</span>&nbsp;<span class="string" id="7609751">&#34;people&#34;</span><span class="op" id="7609759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609762">defer</span>&nbsp;<span class="ident" id="7609768">closeDB</span><span class="op" id="7609775">(</span><span class="ident" id="7609776">t</span><span class="op" id="7609777">,</span>&nbsp;<span class="ident" id="7609779">db</span><span class="op" id="7609781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609784">prepares0</span>&nbsp;<span class="op" id="7609794">:=</span>&nbsp;<span class="ident" id="7609797">numPrepares</span><span class="op" id="7609808">(</span><span class="ident" id="7609809">t</span><span class="op" id="7609810">,</span>&nbsp;<span class="ident" id="7609812">db</span><span class="op" id="7609814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609817">rows</span><span class="op" id="7609821">,</span>&nbsp;<span class="ident" id="7609823">err</span>&nbsp;<span class="op" id="7609827">:=</span>&nbsp;<span class="ident" id="7609830">db</span><span class="op" id="7609832">.</span><span class="ident" id="7609833">Query</span><span class="op" id="7609838">(</span><span class="string" id="7609839">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7609864">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609867">if</span>&nbsp;<span class="ident" id="7609870">err</span>&nbsp;<span class="op" id="7609874">!=</span>&nbsp;<span class="ident" id="7609877">nil</span>&nbsp;<span class="op" id="7609881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609885">t</span><span class="op" id="7609886">.</span><span class="ident" id="7609887">Fatalf</span><span class="op" id="7609893">(</span><span class="string" id="7609894">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="7609905">,</span>&nbsp;<span class="ident" id="7609907">err</span><span class="op" id="7609910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7609913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609916">type</span>&nbsp;<span class="ident" id="7609921">row</span>&nbsp;<span class="keyword" id="7609925">struct</span>&nbsp;<span class="op" id="7609932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609936">age</span>&nbsp;&nbsp;<span class="builtintype" id="7609941">int</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609947">name</span>&nbsp;<span class="builtintype" id="7609952">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7609960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7609963">got</span>&nbsp;<span class="op" id="7609967">:=</span>&nbsp;<span class="op" id="7609970">[</span><span class="op" id="7609971">]</span><span class="ident" id="7609972">row</span><span class="op" id="7609975">{</span><span class="op" id="7609976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609979">for</span>&nbsp;<span class="ident" id="7609983">rows</span><span class="op" id="7609987">.</span><span class="ident" id="7609988">Next</span><span class="op" id="7609992">(</span><span class="op" id="7609993">)</span>&nbsp;<span class="op" id="7609995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7609999">var</span>&nbsp;<span class="ident" id="7610003">r</span>&nbsp;<span class="ident" id="7610005">row</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610011">err</span>&nbsp;<span class="op" id="7610015">=</span>&nbsp;<span class="ident" id="7610017">rows</span><span class="op" id="7610021">.</span><span class="ident" id="7610022">Scan</span><span class="op" id="7610026">(</span><span class="op" id="7610027">&amp;</span><span class="ident" id="7610028">r</span><span class="op" id="7610029">.</span><span class="ident" id="7610030">age</span><span class="op" id="7610033">,</span>&nbsp;<span class="op" id="7610035">&amp;</span><span class="ident" id="7610036">r</span><span class="op" id="7610037">.</span><span class="ident" id="7610038">name</span><span class="op" id="7610042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7610046">if</span>&nbsp;<span class="ident" id="7610049">err</span>&nbsp;<span class="op" id="7610053">!=</span>&nbsp;<span class="ident" id="7610056">nil</span>&nbsp;<span class="op" id="7610060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610065">t</span><span class="op" id="7610066">.</span><span class="ident" id="7610067">Fatalf</span><span class="op" id="7610073">(</span><span class="string" id="7610074">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="7610084">,</span>&nbsp;<span class="ident" id="7610086">err</span><span class="op" id="7610089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7610093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610097">got</span>&nbsp;<span class="op" id="7610101">=</span>&nbsp;<span class="builtinfunc" id="7610103">append</span><span class="op" id="7610109">(</span><span class="ident" id="7610110">got</span><span class="op" id="7610113">,</span>&nbsp;<span class="ident" id="7610115">r</span><span class="op" id="7610116">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7610119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610122">err</span>&nbsp;<span class="op" id="7610126">=</span>&nbsp;<span class="ident" id="7610128">rows</span><span class="op" id="7610132">.</span><span class="ident" id="7610133">Err</span><span class="op" id="7610136">(</span><span class="op" id="7610137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7610140">if</span>&nbsp;<span class="ident" id="7610143">err</span>&nbsp;<span class="op" id="7610147">!=</span>&nbsp;<span class="ident" id="7610150">nil</span>&nbsp;<span class="op" id="7610154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610158">t</span><span class="op" id="7610159">.</span><span class="ident" id="7610160">Fatalf</span><span class="op" id="7610166">(</span><span class="string" id="7610167">&#34;Err:&nbsp;%v&#34;</span><span class="op" id="7610176">,</span>&nbsp;<span class="ident" id="7610178">err</span><span class="op" id="7610181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7610184">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610187">want</span>&nbsp;<span class="op" id="7610192">:=</span>&nbsp;<span class="op" id="7610195">[</span><span class="op" id="7610196">]</span><span class="ident" id="7610197">row</span><span class="op" id="7610200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7610204">{</span><span class="ident" id="7610205">age</span><span class="op" id="7610208">:</span>&nbsp;<span class="num" id="7610210">1</span><span class="op" id="7610211">,</span>&nbsp;<span class="ident" id="7610213">name</span><span class="op" id="7610217">:</span>&nbsp;<span class="string" id="7610219">&#34;Alice&#34;</span><span class="op" id="7610226">}</span><span class="op" id="7610227">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7610231">{</span><span class="ident" id="7610232">age</span><span class="op" id="7610235">:</span>&nbsp;<span class="num" id="7610237">2</span><span class="op" id="7610238">,</span>&nbsp;<span class="ident" id="7610240">name</span><span class="op" id="7610244">:</span>&nbsp;<span class="string" id="7610246">&#34;Bob&#34;</span><span class="op" id="7610251">}</span><span class="op" id="7610252">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7610256">{</span><span class="ident" id="7610257">age</span><span class="op" id="7610260">:</span>&nbsp;<span class="num" id="7610262">3</span><span class="op" id="7610263">,</span>&nbsp;<span class="ident" id="7610265">name</span><span class="op" id="7610269">:</span>&nbsp;<span class="string" id="7610271">&#34;Chris&#34;</span><span class="op" id="7610278">}</span><span class="op" id="7610279">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7610282">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7610285">if</span>&nbsp;<span class="op" id="7610288">!</span><span class="ident" id="7610289">reflect</span><span class="op" id="7610296">.</span><span class="ident" id="7610297">DeepEqual</span><span class="op" id="7610306">(</span><span class="ident" id="7610307">got</span><span class="op" id="7610310">,</span>&nbsp;<span class="ident" id="7610312">want</span><span class="op" id="7610316">)</span>&nbsp;<span class="op" id="7610318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610322">t</span><span class="op" id="7610323">.</span><span class="ident" id="7610324">Errorf</span><span class="op" id="7610330">(</span><span class="string" id="7610331">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="7610364">,</span>&nbsp;<span class="ident" id="7610366">got</span><span class="op" id="7610369">,</span>&nbsp;<span class="ident" id="7610371">want</span><span class="op" id="7610375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7610378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7610382">//&nbsp;And&nbsp;verify&nbsp;that&nbsp;the&nbsp;final&nbsp;rows.Next()&nbsp;call,&nbsp;which&nbsp;hit&nbsp;EOF,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7610445">//&nbsp;also&nbsp;closed&nbsp;the&nbsp;rows&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7610482">if</span>&nbsp;<span class="ident" id="7610485">n</span>&nbsp;<span class="op" id="7610487">:=</span>&nbsp;<span class="ident" id="7610490">db</span><span class="op" id="7610492">.</span><span class="ident" id="7610493">numFreeConns</span><span class="op" id="7610505">(</span><span class="op" id="7610506">)</span><span class="op" id="7610507">;</span>&nbsp;<span class="ident" id="7610509">n</span>&nbsp;<span class="op" id="7610511">!=</span>&nbsp;<span class="num" id="7610514">1</span>&nbsp;<span class="op" id="7610516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610520">t</span><span class="op" id="7610521">.</span><span class="ident" id="7610522">Fatalf</span><span class="op" id="7610528">(</span><span class="string" id="7610529">&#34;free&nbsp;conns&nbsp;after&nbsp;query&nbsp;hitting&nbsp;EOF&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7610578">,</span>&nbsp;<span class="ident" id="7610580">n</span><span class="op" id="7610581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7610584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7610587">if</span>&nbsp;<span class="ident" id="7610590">prepares</span>&nbsp;<span class="op" id="7610599">:=</span>&nbsp;<span class="ident" id="7610602">numPrepares</span><span class="op" id="7610613">(</span><span class="ident" id="7610614">t</span><span class="op" id="7610615">,</span>&nbsp;<span class="ident" id="7610617">db</span><span class="op" id="7610619">)</span>&nbsp;<span class="op" id="7610621">-</span>&nbsp;<span class="ident" id="7610623">prepares0</span><span class="op" id="7610632">;</span>&nbsp;<span class="ident" id="7610634">prepares</span>&nbsp;<span class="op" id="7610643">!=</span>&nbsp;<span class="num" id="7610646">1</span>&nbsp;<span class="op" id="7610648">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610652">t</span><span class="op" id="7610653">.</span><span class="ident" id="7610654">Errorf</span><span class="op" id="7610660">(</span><span class="string" id="7610661">&#34;executed&nbsp;%d&nbsp;Prepare&nbsp;statements;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7610701">,</span>&nbsp;<span class="ident" id="7610703">prepares</span><span class="op" id="7610711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7610714">}</span><br>
<span class="lineno"></span><span class="op" id="7610716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7610719">func</span>&nbsp;<span class="ident" id="7610724">TestByteOwnership</span><span class="op" id="7610741">(</span><span class="ident" id="7610742">t</span>&nbsp;<span class="op" id="7610744">*</span><span class="ident" id="7610745">testing</span><span class="op" id="7610752">.</span><span class="ident" id="7610753">T</span><span class="op" id="7610754">)</span>&nbsp;<span class="op" id="7610756">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610759">db</span>&nbsp;<span class="op" id="7610762">:=</span>&nbsp;<span class="ident" id="7610765">newTestDB</span><span class="op" id="7610774">(</span><span class="ident" id="7610775">t</span><span class="op" id="7610776">,</span>&nbsp;<span class="string" id="7610778">&#34;people&#34;</span><span class="op" id="7610786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7610789">defer</span>&nbsp;<span class="ident" id="7610795">closeDB</span><span class="op" id="7610802">(</span><span class="ident" id="7610803">t</span><span class="op" id="7610804">,</span>&nbsp;<span class="ident" id="7610806">db</span><span class="op" id="7610808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610811">rows</span><span class="op" id="7610815">,</span>&nbsp;<span class="ident" id="7610817">err</span>&nbsp;<span class="op" id="7610821">:=</span>&nbsp;<span class="ident" id="7610824">db</span><span class="op" id="7610826">.</span><span class="ident" id="7610827">Query</span><span class="op" id="7610832">(</span><span class="string" id="7610833">&#34;SELECT|people|name,photo|&#34;</span><span class="op" id="7610860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7610863">if</span>&nbsp;<span class="ident" id="7610866">err</span>&nbsp;<span class="op" id="7610870">!=</span>&nbsp;<span class="ident" id="7610873">nil</span>&nbsp;<span class="op" id="7610877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610881">t</span><span class="op" id="7610882">.</span><span class="ident" id="7610883">Fatalf</span><span class="op" id="7610889">(</span><span class="string" id="7610890">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="7610901">,</span>&nbsp;<span class="ident" id="7610903">err</span><span class="op" id="7610906">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7610909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7610912">type</span>&nbsp;<span class="ident" id="7610917">row</span>&nbsp;<span class="keyword" id="7610921">struct</span>&nbsp;<span class="op" id="7610928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610932">name</span>&nbsp;&nbsp;<span class="op" id="7610938">[</span><span class="op" id="7610939">]</span><span class="builtintype" id="7610940">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610947">photo</span>&nbsp;<span class="ident" id="7610953">RawBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7610963">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7610966">got</span>&nbsp;<span class="op" id="7610970">:=</span>&nbsp;<span class="op" id="7610973">[</span><span class="op" id="7610974">]</span><span class="ident" id="7610975">row</span><span class="op" id="7610978">{</span><span class="op" id="7610979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7610982">for</span>&nbsp;<span class="ident" id="7610986">rows</span><span class="op" id="7610990">.</span><span class="ident" id="7610991">Next</span><span class="op" id="7610995">(</span><span class="op" id="7610996">)</span>&nbsp;<span class="op" id="7610998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7611002">var</span>&nbsp;<span class="ident" id="7611006">r</span>&nbsp;<span class="ident" id="7611008">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611014">err</span>&nbsp;<span class="op" id="7611018">=</span>&nbsp;<span class="ident" id="7611020">rows</span><span class="op" id="7611024">.</span><span class="ident" id="7611025">Scan</span><span class="op" id="7611029">(</span><span class="op" id="7611030">&amp;</span><span class="ident" id="7611031">r</span><span class="op" id="7611032">.</span><span class="ident" id="7611033">name</span><span class="op" id="7611037">,</span>&nbsp;<span class="op" id="7611039">&amp;</span><span class="ident" id="7611040">r</span><span class="op" id="7611041">.</span><span class="ident" id="7611042">photo</span><span class="op" id="7611047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7611051">if</span>&nbsp;<span class="ident" id="7611054">err</span>&nbsp;<span class="op" id="7611058">!=</span>&nbsp;<span class="ident" id="7611061">nil</span>&nbsp;<span class="op" id="7611065">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611070">t</span><span class="op" id="7611071">.</span><span class="ident" id="7611072">Fatalf</span><span class="op" id="7611078">(</span><span class="string" id="7611079">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="7611089">,</span>&nbsp;<span class="ident" id="7611091">err</span><span class="op" id="7611094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7611098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611102">got</span>&nbsp;<span class="op" id="7611106">=</span>&nbsp;<span class="builtinfunc" id="7611108">append</span><span class="op" id="7611114">(</span><span class="ident" id="7611115">got</span><span class="op" id="7611118">,</span>&nbsp;<span class="ident" id="7611120">r</span><span class="op" id="7611121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7611124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611127">corruptMemory</span>&nbsp;<span class="op" id="7611141">:=</span>&nbsp;<span class="op" id="7611144">[</span><span class="op" id="7611145">]</span><span class="builtintype" id="7611146">byte</span><span class="op" id="7611150">(</span><span class="string" id="7611151">&#34;\xffPHOTO&#34;</span><span class="op" id="7611162">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611165">want</span>&nbsp;<span class="op" id="7611170">:=</span>&nbsp;<span class="op" id="7611173">[</span><span class="op" id="7611174">]</span><span class="ident" id="7611175">row</span><span class="op" id="7611178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7611182">{</span><span class="ident" id="7611183">name</span><span class="op" id="7611187">:</span>&nbsp;<span class="op" id="7611189">[</span><span class="op" id="7611190">]</span><span class="builtintype" id="7611191">byte</span><span class="op" id="7611195">(</span><span class="string" id="7611196">&#34;Alice&#34;</span><span class="op" id="7611203">)</span><span class="op" id="7611204">,</span>&nbsp;<span class="ident" id="7611206">photo</span><span class="op" id="7611211">:</span>&nbsp;<span class="ident" id="7611213">corruptMemory</span><span class="op" id="7611226">}</span><span class="op" id="7611227">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7611231">{</span><span class="ident" id="7611232">name</span><span class="op" id="7611236">:</span>&nbsp;<span class="op" id="7611238">[</span><span class="op" id="7611239">]</span><span class="builtintype" id="7611240">byte</span><span class="op" id="7611244">(</span><span class="string" id="7611245">&#34;Bob&#34;</span><span class="op" id="7611250">)</span><span class="op" id="7611251">,</span>&nbsp;<span class="ident" id="7611253">photo</span><span class="op" id="7611258">:</span>&nbsp;<span class="ident" id="7611260">corruptMemory</span><span class="op" id="7611273">}</span><span class="op" id="7611274">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7611278">{</span><span class="ident" id="7611279">name</span><span class="op" id="7611283">:</span>&nbsp;<span class="op" id="7611285">[</span><span class="op" id="7611286">]</span><span class="builtintype" id="7611287">byte</span><span class="op" id="7611291">(</span><span class="string" id="7611292">&#34;Chris&#34;</span><span class="op" id="7611299">)</span><span class="op" id="7611300">,</span>&nbsp;<span class="ident" id="7611302">photo</span><span class="op" id="7611307">:</span>&nbsp;<span class="ident" id="7611309">corruptMemory</span><span class="op" id="7611322">}</span><span class="op" id="7611323">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7611326">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7611329">if</span>&nbsp;<span class="op" id="7611332">!</span><span class="ident" id="7611333">reflect</span><span class="op" id="7611340">.</span><span class="ident" id="7611341">DeepEqual</span><span class="op" id="7611350">(</span><span class="ident" id="7611351">got</span><span class="op" id="7611354">,</span>&nbsp;<span class="ident" id="7611356">want</span><span class="op" id="7611360">)</span>&nbsp;<span class="op" id="7611362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611366">t</span><span class="op" id="7611367">.</span><span class="ident" id="7611368">Errorf</span><span class="op" id="7611374">(</span><span class="string" id="7611375">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="7611408">,</span>&nbsp;<span class="ident" id="7611410">got</span><span class="op" id="7611413">,</span>&nbsp;<span class="ident" id="7611415">want</span><span class="op" id="7611419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7611422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7611426">var</span>&nbsp;<span class="ident" id="7611430">photo</span>&nbsp;<span class="ident" id="7611436">RawBytes</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611446">err</span>&nbsp;<span class="op" id="7611450">=</span>&nbsp;<span class="ident" id="7611452">db</span><span class="op" id="7611454">.</span><span class="ident" id="7611455">QueryRow</span><span class="op" id="7611463">(</span><span class="string" id="7611464">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="7611492">,</span>&nbsp;<span class="string" id="7611494">&#34;Alice&#34;</span><span class="op" id="7611501">)</span><span class="op" id="7611502">.</span><span class="ident" id="7611503">Scan</span><span class="op" id="7611507">(</span><span class="op" id="7611508">&amp;</span><span class="ident" id="7611509">photo</span><span class="op" id="7611514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7611517">if</span>&nbsp;<span class="ident" id="7611520">err</span>&nbsp;<span class="op" id="7611524">==</span>&nbsp;<span class="ident" id="7611527">nil</span>&nbsp;<span class="op" id="7611531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611535">t</span><span class="op" id="7611536">.</span><span class="ident" id="7611537">Error</span><span class="op" id="7611542">(</span><span class="string" id="7611543">&#34;want&nbsp;error&nbsp;scanning&nbsp;into&nbsp;RawBytes&nbsp;from&nbsp;QueryRow&#34;</span><span class="op" id="7611592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7611595">}</span><br>
<span class="lineno"></span><span class="op" id="7611597">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword" id="7611600">func</span>&nbsp;<span class="ident" id="7611605">TestRowsColumns</span><span class="op" id="7611620">(</span><span class="ident" id="7611621">t</span>&nbsp;<span class="op" id="7611623">*</span><span class="ident" id="7611624">testing</span><span class="op" id="7611631">.</span><span class="ident" id="7611632">T</span><span class="op" id="7611633">)</span>&nbsp;<span class="op" id="7611635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611638">db</span>&nbsp;<span class="op" id="7611641">:=</span>&nbsp;<span class="ident" id="7611644">newTestDB</span><span class="op" id="7611653">(</span><span class="ident" id="7611654">t</span><span class="op" id="7611655">,</span>&nbsp;<span class="string" id="7611657">&#34;people&#34;</span><span class="op" id="7611665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7611668">defer</span>&nbsp;<span class="ident" id="7611674">closeDB</span><span class="op" id="7611681">(</span><span class="ident" id="7611682">t</span><span class="op" id="7611683">,</span>&nbsp;<span class="ident" id="7611685">db</span><span class="op" id="7611687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611690">rows</span><span class="op" id="7611694">,</span>&nbsp;<span class="ident" id="7611696">err</span>&nbsp;<span class="op" id="7611700">:=</span>&nbsp;<span class="ident" id="7611703">db</span><span class="op" id="7611705">.</span><span class="ident" id="7611706">Query</span><span class="op" id="7611711">(</span><span class="string" id="7611712">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7611737">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7611740">if</span>&nbsp;<span class="ident" id="7611743">err</span>&nbsp;<span class="op" id="7611747">!=</span>&nbsp;<span class="ident" id="7611750">nil</span>&nbsp;<span class="op" id="7611754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611758">t</span><span class="op" id="7611759">.</span><span class="ident" id="7611760">Fatalf</span><span class="op" id="7611766">(</span><span class="string" id="7611767">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="7611778">,</span>&nbsp;<span class="ident" id="7611780">err</span><span class="op" id="7611783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7611786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611789">cols</span><span class="op" id="7611793">,</span>&nbsp;<span class="ident" id="7611795">err</span>&nbsp;<span class="op" id="7611799">:=</span>&nbsp;<span class="ident" id="7611802">rows</span><span class="op" id="7611806">.</span><span class="ident" id="7611807">Columns</span><span class="op" id="7611814">(</span><span class="op" id="7611815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7611818">if</span>&nbsp;<span class="ident" id="7611821">err</span>&nbsp;<span class="op" id="7611825">!=</span>&nbsp;<span class="ident" id="7611828">nil</span>&nbsp;<span class="op" id="7611832">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611836">t</span><span class="op" id="7611837">.</span><span class="ident" id="7611838">Fatalf</span><span class="op" id="7611844">(</span><span class="string" id="7611845">&#34;Columns:&nbsp;%v&#34;</span><span class="op" id="7611858">,</span>&nbsp;<span class="ident" id="7611860">err</span><span class="op" id="7611863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7611866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611869">want</span>&nbsp;<span class="op" id="7611874">:=</span>&nbsp;<span class="op" id="7611877">[</span><span class="op" id="7611878">]</span><span class="builtintype" id="7611879">string</span><span class="op" id="7611885">{</span><span class="string" id="7611886">&#34;age&#34;</span><span class="op" id="7611891">,</span>&nbsp;<span class="string" id="7611893">&#34;name&#34;</span><span class="op" id="7611899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7611902">if</span>&nbsp;<span class="op" id="7611905">!</span><span class="ident" id="7611906">reflect</span><span class="op" id="7611913">.</span><span class="ident" id="7611914">DeepEqual</span><span class="op" id="7611923">(</span><span class="ident" id="7611924">cols</span><span class="op" id="7611928">,</span>&nbsp;<span class="ident" id="7611930">want</span><span class="op" id="7611934">)</span>&nbsp;<span class="op" id="7611936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7611940">t</span><span class="op" id="7611941">.</span><span class="ident" id="7611942">Errorf</span><span class="op" id="7611948">(</span><span class="string" id="7611949">&#34;got&nbsp;%#v;&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="7611968">,</span>&nbsp;<span class="ident" id="7611970">cols</span><span class="op" id="7611974">,</span>&nbsp;<span class="ident" id="7611976">want</span><span class="op" id="7611980">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7611983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7611986">if</span>&nbsp;<span class="ident" id="7611989">err</span>&nbsp;<span class="op" id="7611993">:=</span>&nbsp;<span class="ident" id="7611996">rows</span><span class="op" id="7612000">.</span><span class="ident" id="7612001">Close</span><span class="op" id="7612006">(</span><span class="op" id="7612007">)</span><span class="op" id="7612008">;</span>&nbsp;<span class="ident" id="7612010">err</span>&nbsp;<span class="op" id="7612014">!=</span>&nbsp;<span class="ident" id="7612017">nil</span>&nbsp;<span class="op" id="7612021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612025">t</span><span class="op" id="7612026">.</span><span class="ident" id="7612027">Errorf</span><span class="op" id="7612033">(</span><span class="string" id="7612034">&#34;error&nbsp;closing&nbsp;rows:&nbsp;%s&#34;</span><span class="op" id="7612058">,</span>&nbsp;<span class="ident" id="7612060">err</span><span class="op" id="7612063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7612066">}</span><br>
<span class="lineno"></span><span class="op" id="7612068">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="7612071">func</span>&nbsp;<span class="ident" id="7612076">TestQueryRow</span><span class="op" id="7612088">(</span><span class="ident" id="7612089">t</span>&nbsp;<span class="op" id="7612091">*</span><span class="ident" id="7612092">testing</span><span class="op" id="7612099">.</span><span class="ident" id="7612100">T</span><span class="op" id="7612101">)</span>&nbsp;<span class="op" id="7612103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612106">db</span>&nbsp;<span class="op" id="7612109">:=</span>&nbsp;<span class="ident" id="7612112">newTestDB</span><span class="op" id="7612121">(</span><span class="ident" id="7612122">t</span><span class="op" id="7612123">,</span>&nbsp;<span class="string" id="7612125">&#34;people&#34;</span><span class="op" id="7612133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7612136">defer</span>&nbsp;<span class="ident" id="7612142">closeDB</span><span class="op" id="7612149">(</span><span class="ident" id="7612150">t</span><span class="op" id="7612151">,</span>&nbsp;<span class="ident" id="7612153">db</span><span class="op" id="7612155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7612158">var</span>&nbsp;<span class="ident" id="7612162">name</span>&nbsp;<span class="builtintype" id="7612167">string</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7612175">var</span>&nbsp;<span class="ident" id="7612179">age</span>&nbsp;<span class="builtintype" id="7612183">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7612188">var</span>&nbsp;<span class="ident" id="7612192">birthday</span>&nbsp;<span class="ident" id="7612201">time</span><span class="op" id="7612205">.</span><span class="ident" id="7612206">Time</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612213">err</span>&nbsp;<span class="op" id="7612217">:=</span>&nbsp;<span class="ident" id="7612220">db</span><span class="op" id="7612222">.</span><span class="ident" id="7612223">QueryRow</span><span class="op" id="7612231">(</span><span class="string" id="7612232">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="7612262">,</span>&nbsp;<span class="num" id="7612264">3</span><span class="op" id="7612265">)</span><span class="op" id="7612266">.</span><span class="ident" id="7612267">Scan</span><span class="op" id="7612271">(</span><span class="op" id="7612272">&amp;</span><span class="ident" id="7612273">age</span><span class="op" id="7612276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7612279">if</span>&nbsp;<span class="ident" id="7612282">err</span>&nbsp;<span class="op" id="7612286">==</span>&nbsp;<span class="ident" id="7612289">nil</span>&nbsp;<span class="op" id="7612293">||</span>&nbsp;<span class="op" id="7612296">!</span><span class="ident" id="7612297">strings</span><span class="op" id="7612304">.</span><span class="ident" id="7612305">Contains</span><span class="op" id="7612313">(</span><span class="ident" id="7612314">err</span><span class="op" id="7612317">.</span><span class="ident" id="7612318">Error</span><span class="op" id="7612323">(</span><span class="op" id="7612324">)</span><span class="op" id="7612325">,</span>&nbsp;<span class="string" id="7612327">&#34;expected&nbsp;2&nbsp;destination&nbsp;arguments&#34;</span><span class="op" id="7612361">)</span>&nbsp;<span class="op" id="7612363">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612367">t</span><span class="op" id="7612368">.</span><span class="ident" id="7612369">Errorf</span><span class="op" id="7612375">(</span><span class="string" id="7612376">&#34;expected&nbsp;error&nbsp;from&nbsp;wrong&nbsp;number&nbsp;of&nbsp;arguments;&nbsp;actually&nbsp;got:&nbsp;%v&#34;</span><span class="op" id="7612441">,</span>&nbsp;<span class="ident" id="7612443">err</span><span class="op" id="7612446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7612449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612453">err</span>&nbsp;<span class="op" id="7612457">=</span>&nbsp;<span class="ident" id="7612459">db</span><span class="op" id="7612461">.</span><span class="ident" id="7612462">QueryRow</span><span class="op" id="7612470">(</span><span class="string" id="7612471">&#34;SELECT|people|bdate|age=?&#34;</span><span class="op" id="7612498">,</span>&nbsp;<span class="num" id="7612500">3</span><span class="op" id="7612501">)</span><span class="op" id="7612502">.</span><span class="ident" id="7612503">Scan</span><span class="op" id="7612507">(</span><span class="op" id="7612508">&amp;</span><span class="ident" id="7612509">birthday</span><span class="op" id="7612517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7612520">if</span>&nbsp;<span class="ident" id="7612523">err</span>&nbsp;<span class="op" id="7612527">!=</span>&nbsp;<span class="ident" id="7612530">nil</span>&nbsp;<span class="op" id="7612534">||</span>&nbsp;<span class="op" id="7612537">!</span><span class="ident" id="7612538">birthday</span><span class="op" id="7612546">.</span><span class="ident" id="7612547">Equal</span><span class="op" id="7612552">(</span><span class="ident" id="7612553">chrisBirthday</span><span class="op" id="7612566">)</span>&nbsp;<span class="op" id="7612568">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612572">t</span><span class="op" id="7612573">.</span><span class="ident" id="7612574">Errorf</span><span class="op" id="7612580">(</span><span class="string" id="7612581">&#34;chris&nbsp;birthday&nbsp;=&nbsp;%v,&nbsp;err&nbsp;=&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7612621">,</span>&nbsp;<span class="ident" id="7612623">birthday</span><span class="op" id="7612631">,</span>&nbsp;<span class="ident" id="7612633">err</span><span class="op" id="7612636">,</span>&nbsp;<span class="ident" id="7612638">chrisBirthday</span><span class="op" id="7612651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7612654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612658">err</span>&nbsp;<span class="op" id="7612662">=</span>&nbsp;<span class="ident" id="7612664">db</span><span class="op" id="7612666">.</span><span class="ident" id="7612667">QueryRow</span><span class="op" id="7612675">(</span><span class="string" id="7612676">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="7612706">,</span>&nbsp;<span class="num" id="7612708">2</span><span class="op" id="7612709">)</span><span class="op" id="7612710">.</span><span class="ident" id="7612711">Scan</span><span class="op" id="7612715">(</span><span class="op" id="7612716">&amp;</span><span class="ident" id="7612717">age</span><span class="op" id="7612720">,</span>&nbsp;<span class="op" id="7612722">&amp;</span><span class="ident" id="7612723">name</span><span class="op" id="7612727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7612730">if</span>&nbsp;<span class="ident" id="7612733">err</span>&nbsp;<span class="op" id="7612737">!=</span>&nbsp;<span class="ident" id="7612740">nil</span>&nbsp;<span class="op" id="7612744">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612748">t</span><span class="op" id="7612749">.</span><span class="ident" id="7612750">Fatalf</span><span class="op" id="7612756">(</span><span class="string" id="7612757">&#34;age&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="7612780">,</span>&nbsp;<span class="ident" id="7612782">err</span><span class="op" id="7612785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7612788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7612791">if</span>&nbsp;<span class="ident" id="7612794">name</span>&nbsp;<span class="op" id="7612799">!=</span>&nbsp;<span class="string" id="7612802">&#34;Bob&#34;</span>&nbsp;<span class="op" id="7612808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612812">t</span><span class="op" id="7612813">.</span><span class="ident" id="7612814">Errorf</span><span class="op" id="7612820">(</span><span class="string" id="7612821">&#34;expected&nbsp;name&nbsp;Bob,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7612848">,</span>&nbsp;<span class="ident" id="7612850">name</span><span class="op" id="7612854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7612857">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7612860">if</span>&nbsp;<span class="ident" id="7612863">age</span>&nbsp;<span class="op" id="7612867">!=</span>&nbsp;<span class="num" id="7612870">2</span>&nbsp;<span class="op" id="7612872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612876">t</span><span class="op" id="7612877">.</span><span class="ident" id="7612878">Errorf</span><span class="op" id="7612884">(</span><span class="string" id="7612885">&#34;expected&nbsp;age&nbsp;2,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7612909">,</span>&nbsp;<span class="ident" id="7612911">age</span><span class="op" id="7612914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7612917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7612921">err</span>&nbsp;<span class="op" id="7612925">=</span>&nbsp;<span class="ident" id="7612927">db</span><span class="op" id="7612929">.</span><span class="ident" id="7612930">QueryRow</span><span class="op" id="7612938">(</span><span class="string" id="7612939">&#34;SELECT|people|age,name|name=?&#34;</span><span class="op" id="7612970">,</span>&nbsp;<span class="string" id="7612972">&#34;Alice&#34;</span><span class="op" id="7612979">)</span><span class="op" id="7612980">.</span><span class="ident" id="7612981">Scan</span><span class="op" id="7612985">(</span><span class="op" id="7612986">&amp;</span><span class="ident" id="7612987">age</span><span class="op" id="7612990">,</span>&nbsp;<span class="op" id="7612992">&amp;</span><span class="ident" id="7612993">name</span><span class="op" id="7612997">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613000">if</span>&nbsp;<span class="ident" id="7613003">err</span>&nbsp;<span class="op" id="7613007">!=</span>&nbsp;<span class="ident" id="7613010">nil</span>&nbsp;<span class="op" id="7613014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613018">t</span><span class="op" id="7613019">.</span><span class="ident" id="7613020">Fatalf</span><span class="op" id="7613026">(</span><span class="string" id="7613027">&#34;name&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="7613051">,</span>&nbsp;<span class="ident" id="7613053">err</span><span class="op" id="7613056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7613059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613062">if</span>&nbsp;<span class="ident" id="7613065">name</span>&nbsp;<span class="op" id="7613070">!=</span>&nbsp;<span class="string" id="7613073">&#34;Alice&#34;</span>&nbsp;<span class="op" id="7613081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613085">t</span><span class="op" id="7613086">.</span><span class="ident" id="7613087">Errorf</span><span class="op" id="7613093">(</span><span class="string" id="7613094">&#34;expected&nbsp;name&nbsp;Alice,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7613123">,</span>&nbsp;<span class="ident" id="7613125">name</span><span class="op" id="7613129">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7613132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613135">if</span>&nbsp;<span class="ident" id="7613138">age</span>&nbsp;<span class="op" id="7613142">!=</span>&nbsp;<span class="num" id="7613145">1</span>&nbsp;<span class="op" id="7613147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613151">t</span><span class="op" id="7613152">.</span><span class="ident" id="7613153">Errorf</span><span class="op" id="7613159">(</span><span class="string" id="7613160">&#34;expected&nbsp;age&nbsp;1,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7613184">,</span>&nbsp;<span class="ident" id="7613186">age</span><span class="op" id="7613189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7613192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613196">var</span>&nbsp;<span class="ident" id="7613200">photo</span>&nbsp;<span class="op" id="7613206">[</span><span class="op" id="7613207">]</span><span class="builtintype" id="7613208">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613214">err</span>&nbsp;<span class="op" id="7613218">=</span>&nbsp;<span class="ident" id="7613220">db</span><span class="op" id="7613222">.</span><span class="ident" id="7613223">QueryRow</span><span class="op" id="7613231">(</span><span class="string" id="7613232">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="7613260">,</span>&nbsp;<span class="string" id="7613262">&#34;Alice&#34;</span><span class="op" id="7613269">)</span><span class="op" id="7613270">.</span><span class="ident" id="7613271">Scan</span><span class="op" id="7613275">(</span><span class="op" id="7613276">&amp;</span><span class="ident" id="7613277">photo</span><span class="op" id="7613282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613285">if</span>&nbsp;<span class="ident" id="7613288">err</span>&nbsp;<span class="op" id="7613292">!=</span>&nbsp;<span class="ident" id="7613295">nil</span>&nbsp;<span class="op" id="7613299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613303">t</span><span class="op" id="7613304">.</span><span class="ident" id="7613305">Fatalf</span><span class="op" id="7613311">(</span><span class="string" id="7613312">&#34;photo&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="7613337">,</span>&nbsp;<span class="ident" id="7613339">err</span><span class="op" id="7613342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7613345">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613348">want</span>&nbsp;<span class="op" id="7613353">:=</span>&nbsp;<span class="op" id="7613356">[</span><span class="op" id="7613357">]</span><span class="builtintype" id="7613358">byte</span><span class="op" id="7613362">(</span><span class="string" id="7613363">&#34;APHOTO&#34;</span><span class="op" id="7613371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613374">if</span>&nbsp;<span class="op" id="7613377">!</span><span class="ident" id="7613378">reflect</span><span class="op" id="7613385">.</span><span class="ident" id="7613386">DeepEqual</span><span class="op" id="7613395">(</span><span class="ident" id="7613396">photo</span><span class="op" id="7613401">,</span>&nbsp;<span class="ident" id="7613403">want</span><span class="op" id="7613407">)</span>&nbsp;<span class="op" id="7613409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613413">t</span><span class="op" id="7613414">.</span><span class="ident" id="7613415">Errorf</span><span class="op" id="7613421">(</span><span class="string" id="7613422">&#34;photo&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7613443">,</span>&nbsp;<span class="ident" id="7613445">photo</span><span class="op" id="7613450">,</span>&nbsp;<span class="ident" id="7613452">want</span><span class="op" id="7613456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7613459">}</span><br>
<span class="lineno"></span><span class="op" id="7613461">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="7613464">func</span>&nbsp;<span class="ident" id="7613469">TestStatementErrorAfterClose</span><span class="op" id="7613497">(</span><span class="ident" id="7613498">t</span>&nbsp;<span class="op" id="7613500">*</span><span class="ident" id="7613501">testing</span><span class="op" id="7613508">.</span><span class="ident" id="7613509">T</span><span class="op" id="7613510">)</span>&nbsp;<span class="op" id="7613512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613515">db</span>&nbsp;<span class="op" id="7613518">:=</span>&nbsp;<span class="ident" id="7613521">newTestDB</span><span class="op" id="7613530">(</span><span class="ident" id="7613531">t</span><span class="op" id="7613532">,</span>&nbsp;<span class="string" id="7613534">&#34;people&#34;</span><span class="op" id="7613542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613545">defer</span>&nbsp;<span class="ident" id="7613551">closeDB</span><span class="op" id="7613558">(</span><span class="ident" id="7613559">t</span><span class="op" id="7613560">,</span>&nbsp;<span class="ident" id="7613562">db</span><span class="op" id="7613564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613567">stmt</span><span class="op" id="7613571">,</span>&nbsp;<span class="ident" id="7613573">err</span>&nbsp;<span class="op" id="7613577">:=</span>&nbsp;<span class="ident" id="7613580">db</span><span class="op" id="7613582">.</span><span class="ident" id="7613583">Prepare</span><span class="op" id="7613590">(</span><span class="string" id="7613591">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="7613617">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613620">if</span>&nbsp;<span class="ident" id="7613623">err</span>&nbsp;<span class="op" id="7613627">!=</span>&nbsp;<span class="ident" id="7613630">nil</span>&nbsp;<span class="op" id="7613634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613638">t</span><span class="op" id="7613639">.</span><span class="ident" id="7613640">Fatalf</span><span class="op" id="7613646">(</span><span class="string" id="7613647">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="7613660">,</span>&nbsp;<span class="ident" id="7613662">err</span><span class="op" id="7613665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7613668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613671">err</span>&nbsp;<span class="op" id="7613675">=</span>&nbsp;<span class="ident" id="7613677">stmt</span><span class="op" id="7613681">.</span><span class="ident" id="7613682">Close</span><span class="op" id="7613687">(</span><span class="op" id="7613688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613691">if</span>&nbsp;<span class="ident" id="7613694">err</span>&nbsp;<span class="op" id="7613698">!=</span>&nbsp;<span class="ident" id="7613701">nil</span>&nbsp;<span class="op" id="7613705">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613709">t</span><span class="op" id="7613710">.</span><span class="ident" id="7613711">Fatalf</span><span class="op" id="7613717">(</span><span class="string" id="7613718">&#34;Close:&nbsp;%v&#34;</span><span class="op" id="7613729">,</span>&nbsp;<span class="ident" id="7613731">err</span><span class="op" id="7613734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7613737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613740">var</span>&nbsp;<span class="ident" id="7613744">name</span>&nbsp;<span class="builtintype" id="7613749">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613757">err</span>&nbsp;<span class="op" id="7613761">=</span>&nbsp;<span class="ident" id="7613763">stmt</span><span class="op" id="7613767">.</span><span class="ident" id="7613768">QueryRow</span><span class="op" id="7613776">(</span><span class="string" id="7613777">&#34;foo&#34;</span><span class="op" id="7613782">)</span><span class="op" id="7613783">.</span><span class="ident" id="7613784">Scan</span><span class="op" id="7613788">(</span><span class="op" id="7613789">&amp;</span><span class="ident" id="7613790">name</span><span class="op" id="7613794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613797">if</span>&nbsp;<span class="ident" id="7613800">err</span>&nbsp;<span class="op" id="7613804">==</span>&nbsp;<span class="ident" id="7613807">nil</span>&nbsp;<span class="op" id="7613811">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613815">t</span><span class="op" id="7613816">.</span><span class="ident" id="7613817">Errorf</span><span class="op" id="7613823">(</span><span class="string" id="7613824">&#34;expected&nbsp;error&nbsp;from&nbsp;QueryRow.Scan&nbsp;after&nbsp;Stmt.Close&#34;</span><span class="op" id="7613876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7613879">}</span><br>
<span class="lineno"></span><span class="op" id="7613881">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7613884">func</span>&nbsp;<span class="ident" id="7613889">TestStatementQueryRow</span><span class="op" id="7613910">(</span><span class="ident" id="7613911">t</span>&nbsp;<span class="op" id="7613913">*</span><span class="ident" id="7613914">testing</span><span class="op" id="7613921">.</span><span class="ident" id="7613922">T</span><span class="op" id="7613923">)</span>&nbsp;<span class="op" id="7613925">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613928">db</span>&nbsp;<span class="op" id="7613931">:=</span>&nbsp;<span class="ident" id="7613934">newTestDB</span><span class="op" id="7613943">(</span><span class="ident" id="7613944">t</span><span class="op" id="7613945">,</span>&nbsp;<span class="string" id="7613947">&#34;people&#34;</span><span class="op" id="7613955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7613958">defer</span>&nbsp;<span class="ident" id="7613964">closeDB</span><span class="op" id="7613971">(</span><span class="ident" id="7613972">t</span><span class="op" id="7613973">,</span>&nbsp;<span class="ident" id="7613975">db</span><span class="op" id="7613977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7613980">stmt</span><span class="op" id="7613984">,</span>&nbsp;<span class="ident" id="7613986">err</span>&nbsp;<span class="op" id="7613990">:=</span>&nbsp;<span class="ident" id="7613993">db</span><span class="op" id="7613995">.</span><span class="ident" id="7613996">Prepare</span><span class="op" id="7614003">(</span><span class="string" id="7614004">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="7614030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614033">if</span>&nbsp;<span class="ident" id="7614036">err</span>&nbsp;<span class="op" id="7614040">!=</span>&nbsp;<span class="ident" id="7614043">nil</span>&nbsp;<span class="op" id="7614047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614051">t</span><span class="op" id="7614052">.</span><span class="ident" id="7614053">Fatalf</span><span class="op" id="7614059">(</span><span class="string" id="7614060">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="7614073">,</span>&nbsp;<span class="ident" id="7614075">err</span><span class="op" id="7614078">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7614081">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614084">defer</span>&nbsp;<span class="ident" id="7614090">stmt</span><span class="op" id="7614094">.</span><span class="ident" id="7614095">Close</span><span class="op" id="7614100">(</span><span class="op" id="7614101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614104">var</span>&nbsp;<span class="ident" id="7614108">age</span>&nbsp;<span class="builtintype" id="7614112">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614117">for</span>&nbsp;<span class="ident" id="7614121">n</span><span class="op" id="7614122">,</span>&nbsp;<span class="ident" id="7614124">tt</span>&nbsp;<span class="op" id="7614127">:=</span>&nbsp;<span class="keyword" id="7614130">range</span>&nbsp;<span class="op" id="7614136">[</span><span class="op" id="7614137">]</span><span class="keyword" id="7614138">struct</span>&nbsp;<span class="op" id="7614145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614149">name</span>&nbsp;<span class="builtintype" id="7614154">string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614163">want</span>&nbsp;<span class="builtintype" id="7614168">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7614173">}</span><span class="op" id="7614174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7614178">{</span><span class="string" id="7614179">&#34;Alice&#34;</span><span class="op" id="7614186">,</span>&nbsp;<span class="num" id="7614188">1</span><span class="op" id="7614189">}</span><span class="op" id="7614190">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7614194">{</span><span class="string" id="7614195">&#34;Bob&#34;</span><span class="op" id="7614200">,</span>&nbsp;<span class="num" id="7614202">2</span><span class="op" id="7614203">}</span><span class="op" id="7614204">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7614208">{</span><span class="string" id="7614209">&#34;Chris&#34;</span><span class="op" id="7614216">,</span>&nbsp;<span class="num" id="7614218">3</span><span class="op" id="7614219">}</span><span class="op" id="7614220">,</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7614223">}</span>&nbsp;<span class="op" id="7614225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614229">if</span>&nbsp;<span class="ident" id="7614232">err</span>&nbsp;<span class="op" id="7614236">:=</span>&nbsp;<span class="ident" id="7614239">stmt</span><span class="op" id="7614243">.</span><span class="ident" id="7614244">QueryRow</span><span class="op" id="7614252">(</span><span class="ident" id="7614253">tt</span><span class="op" id="7614255">.</span><span class="ident" id="7614256">name</span><span class="op" id="7614260">)</span><span class="op" id="7614261">.</span><span class="ident" id="7614262">Scan</span><span class="op" id="7614266">(</span><span class="op" id="7614267">&amp;</span><span class="ident" id="7614268">age</span><span class="op" id="7614271">)</span><span class="op" id="7614272">;</span>&nbsp;<span class="ident" id="7614274">err</span>&nbsp;<span class="op" id="7614278">!=</span>&nbsp;<span class="ident" id="7614281">nil</span>&nbsp;<span class="op" id="7614285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614290">t</span><span class="op" id="7614291">.</span><span class="ident" id="7614292">Errorf</span><span class="op" id="7614298">(</span><span class="string" id="7614299">&#34;%d:&nbsp;on&nbsp;%q,&nbsp;QueryRow/Scan:&nbsp;%v&#34;</span><span class="op" id="7614329">,</span>&nbsp;<span class="ident" id="7614331">n</span><span class="op" id="7614332">,</span>&nbsp;<span class="ident" id="7614334">tt</span><span class="op" id="7614336">.</span><span class="ident" id="7614337">name</span><span class="op" id="7614341">,</span>&nbsp;<span class="ident" id="7614343">err</span><span class="op" id="7614346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7614350">}</span>&nbsp;<span class="keyword" id="7614352">else</span>&nbsp;<span class="keyword" id="7614357">if</span>&nbsp;<span class="ident" id="7614360">age</span>&nbsp;<span class="op" id="7614364">!=</span>&nbsp;<span class="ident" id="7614367">tt</span><span class="op" id="7614369">.</span><span class="ident" id="7614370">want</span>&nbsp;<span class="op" id="7614375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614380">t</span><span class="op" id="7614381">.</span><span class="ident" id="7614382">Errorf</span><span class="op" id="7614388">(</span><span class="string" id="7614389">&#34;%d:&nbsp;age=%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7614410">,</span>&nbsp;<span class="ident" id="7614412">n</span><span class="op" id="7614413">,</span>&nbsp;<span class="ident" id="7614415">age</span><span class="op" id="7614418">,</span>&nbsp;<span class="ident" id="7614420">tt</span><span class="op" id="7614422">.</span><span class="ident" id="7614423">want</span><span class="op" id="7614427">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7614431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7614434">}</span><br>
<span class="lineno"></span><span class="op" id="7614436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7614439">//&nbsp;golang.org/issue/3734</span><br>
<span class="lineno">360</span><span class="keyword" id="7614464">func</span>&nbsp;<span class="ident" id="7614469">TestStatementQueryRowConcurrent</span><span class="op" id="7614500">(</span><span class="ident" id="7614501">t</span>&nbsp;<span class="op" id="7614503">*</span><span class="ident" id="7614504">testing</span><span class="op" id="7614511">.</span><span class="ident" id="7614512">T</span><span class="op" id="7614513">)</span>&nbsp;<span class="op" id="7614515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614518">db</span>&nbsp;<span class="op" id="7614521">:=</span>&nbsp;<span class="ident" id="7614524">newTestDB</span><span class="op" id="7614533">(</span><span class="ident" id="7614534">t</span><span class="op" id="7614535">,</span>&nbsp;<span class="string" id="7614537">&#34;people&#34;</span><span class="op" id="7614545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614548">defer</span>&nbsp;<span class="ident" id="7614554">closeDB</span><span class="op" id="7614561">(</span><span class="ident" id="7614562">t</span><span class="op" id="7614563">,</span>&nbsp;<span class="ident" id="7614565">db</span><span class="op" id="7614567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614570">stmt</span><span class="op" id="7614574">,</span>&nbsp;<span class="ident" id="7614576">err</span>&nbsp;<span class="op" id="7614580">:=</span>&nbsp;<span class="ident" id="7614583">db</span><span class="op" id="7614585">.</span><span class="ident" id="7614586">Prepare</span><span class="op" id="7614593">(</span><span class="string" id="7614594">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="7614620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614623">if</span>&nbsp;<span class="ident" id="7614626">err</span>&nbsp;<span class="op" id="7614630">!=</span>&nbsp;<span class="ident" id="7614633">nil</span>&nbsp;<span class="op" id="7614637">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614641">t</span><span class="op" id="7614642">.</span><span class="ident" id="7614643">Fatalf</span><span class="op" id="7614649">(</span><span class="string" id="7614650">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="7614663">,</span>&nbsp;<span class="ident" id="7614665">err</span><span class="op" id="7614668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7614671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614674">defer</span>&nbsp;<span class="ident" id="7614680">stmt</span><span class="op" id="7614684">.</span><span class="ident" id="7614685">Close</span><span class="op" id="7614690">(</span><span class="op" id="7614691">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614695">const</span>&nbsp;<span class="ident" id="7614701">n</span>&nbsp;<span class="op" id="7614703">=</span>&nbsp;<span class="num" id="7614705">10</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614709">ch</span>&nbsp;<span class="op" id="7614712">:=</span>&nbsp;<span class="builtinfunc" id="7614715">make</span><span class="op" id="7614719">(</span><span class="keyword" id="7614720">chan</span>&nbsp;<span class="builtintype" id="7614725">error</span><span class="op" id="7614730">,</span>&nbsp;<span class="ident" id="7614732">n</span><span class="op" id="7614733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614736">for</span>&nbsp;<span class="ident" id="7614740">i</span>&nbsp;<span class="op" id="7614742">:=</span>&nbsp;<span class="num" id="7614745">0</span><span class="op" id="7614746">;</span>&nbsp;<span class="ident" id="7614748">i</span>&nbsp;<span class="op" id="7614750">&lt;</span>&nbsp;<span class="ident" id="7614752">n</span><span class="op" id="7614753">;</span>&nbsp;<span class="ident" id="7614755">i</span><span class="op" id="7614756">++</span>&nbsp;<span class="op" id="7614759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614763">go</span>&nbsp;<span class="keyword" id="7614766">func</span><span class="op" id="7614770">(</span><span class="op" id="7614771">)</span>&nbsp;<span class="op" id="7614773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614778">var</span>&nbsp;<span class="ident" id="7614782">age</span>&nbsp;<span class="builtintype" id="7614786">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614793">err</span>&nbsp;<span class="op" id="7614797">:=</span>&nbsp;<span class="ident" id="7614800">stmt</span><span class="op" id="7614804">.</span><span class="ident" id="7614805">QueryRow</span><span class="op" id="7614813">(</span><span class="string" id="7614814">&#34;Alice&#34;</span><span class="op" id="7614821">)</span><span class="op" id="7614822">.</span><span class="ident" id="7614823">Scan</span><span class="op" id="7614827">(</span><span class="op" id="7614828">&amp;</span><span class="ident" id="7614829">age</span><span class="op" id="7614832">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614837">if</span>&nbsp;<span class="ident" id="7614840">err</span>&nbsp;<span class="op" id="7614844">==</span>&nbsp;<span class="ident" id="7614847">nil</span>&nbsp;<span class="op" id="7614851">&amp;&amp;</span>&nbsp;<span class="ident" id="7614854">age</span>&nbsp;<span class="op" id="7614858">!=</span>&nbsp;<span class="num" id="7614861">1</span>&nbsp;<span class="op" id="7614863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614869">err</span>&nbsp;<span class="op" id="7614873">=</span>&nbsp;<span class="ident" id="7614875">fmt</span><span class="op" id="7614878">.</span><span class="ident" id="7614879">Errorf</span><span class="op" id="7614885">(</span><span class="string" id="7614886">&#34;unexpected&nbsp;age&nbsp;%d&#34;</span><span class="op" id="7614905">,</span>&nbsp;<span class="ident" id="7614907">age</span><span class="op" id="7614910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7614915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614920">ch</span>&nbsp;<span class="op" id="7614923">&lt;-</span>&nbsp;<span class="ident" id="7614926">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7614932">}</span><span class="op" id="7614933">(</span><span class="op" id="7614934">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7614937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614940">for</span>&nbsp;<span class="ident" id="7614944">i</span>&nbsp;<span class="op" id="7614946">:=</span>&nbsp;<span class="num" id="7614949">0</span><span class="op" id="7614950">;</span>&nbsp;<span class="ident" id="7614952">i</span>&nbsp;<span class="op" id="7614954">&lt;</span>&nbsp;<span class="ident" id="7614956">n</span><span class="op" id="7614957">;</span>&nbsp;<span class="ident" id="7614959">i</span><span class="op" id="7614960">++</span>&nbsp;<span class="op" id="7614963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7614967">if</span>&nbsp;<span class="ident" id="7614970">err</span>&nbsp;<span class="op" id="7614974">:=</span>&nbsp;<span class="op" id="7614977">&lt;-</span><span class="ident" id="7614979">ch</span><span class="op" id="7614981">;</span>&nbsp;<span class="ident" id="7614983">err</span>&nbsp;<span class="op" id="7614987">!=</span>&nbsp;<span class="ident" id="7614990">nil</span>&nbsp;<span class="op" id="7614994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7614999">t</span><span class="op" id="7615000">.</span><span class="ident" id="7615001">Error</span><span class="op" id="7615006">(</span><span class="ident" id="7615007">err</span><span class="op" id="7615010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615014">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615017">}</span><br>
<span class="lineno"></span><span class="op" id="7615019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7615022">//&nbsp;just&nbsp;a&nbsp;test&nbsp;of&nbsp;fakedb&nbsp;itself</span><br>
<span class="lineno"></span><span class="keyword" id="7615054">func</span>&nbsp;<span class="ident" id="7615059">TestBogusPreboundParameters</span><span class="op" id="7615086">(</span><span class="ident" id="7615087">t</span>&nbsp;<span class="op" id="7615089">*</span><span class="ident" id="7615090">testing</span><span class="op" id="7615097">.</span><span class="ident" id="7615098">T</span><span class="op" id="7615099">)</span>&nbsp;<span class="op" id="7615101">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615104">db</span>&nbsp;<span class="op" id="7615107">:=</span>&nbsp;<span class="ident" id="7615110">newTestDB</span><span class="op" id="7615119">(</span><span class="ident" id="7615120">t</span><span class="op" id="7615121">,</span>&nbsp;<span class="string" id="7615123">&#34;foo&#34;</span><span class="op" id="7615128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7615131">defer</span>&nbsp;<span class="ident" id="7615137">closeDB</span><span class="op" id="7615144">(</span><span class="ident" id="7615145">t</span><span class="op" id="7615146">,</span>&nbsp;<span class="ident" id="7615148">db</span><span class="op" id="7615150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615153">exec</span><span class="op" id="7615157">(</span><span class="ident" id="7615158">t</span><span class="op" id="7615159">,</span>&nbsp;<span class="ident" id="7615161">db</span><span class="op" id="7615163">,</span>&nbsp;<span class="string" id="7615165">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7615208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615211">_</span><span class="op" id="7615212">,</span>&nbsp;<span class="ident" id="7615214">err</span>&nbsp;<span class="op" id="7615218">:=</span>&nbsp;<span class="ident" id="7615221">db</span><span class="op" id="7615223">.</span><span class="ident" id="7615224">Prepare</span><span class="op" id="7615231">(</span><span class="string" id="7615232">&#34;INSERT|t1|name=?,age=bogusconversion&#34;</span><span class="op" id="7615270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7615273">if</span>&nbsp;<span class="ident" id="7615276">err</span>&nbsp;<span class="op" id="7615280">==</span>&nbsp;<span class="ident" id="7615283">nil</span>&nbsp;<span class="op" id="7615287">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615291">t</span><span class="op" id="7615292">.</span><span class="ident" id="7615293">Fatalf</span><span class="op" id="7615299">(</span><span class="string" id="7615300">&#34;expected&nbsp;error&#34;</span><span class="op" id="7615316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7615322">if</span>&nbsp;<span class="ident" id="7615325">err</span><span class="op" id="7615328">.</span><span class="ident" id="7615329">Error</span><span class="op" id="7615334">(</span><span class="op" id="7615335">)</span>&nbsp;<span class="op" id="7615337">!=</span>&nbsp;<span class="string" id="7615340">`fakedb:&nbsp;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;&#34;bogusconversion&#34;`</span>&nbsp;<span class="op" id="7615401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615405">t</span><span class="op" id="7615406">.</span><span class="ident" id="7615407">Errorf</span><span class="op" id="7615413">(</span><span class="string" id="7615414">&#34;unexpected&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="7615436">,</span>&nbsp;<span class="ident" id="7615438">err</span><span class="op" id="7615441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615444">}</span><br>
<span class="lineno">400</span><span class="op" id="7615446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7615449">func</span>&nbsp;<span class="ident" id="7615454">TestExec</span><span class="op" id="7615462">(</span><span class="ident" id="7615463">t</span>&nbsp;<span class="op" id="7615465">*</span><span class="ident" id="7615466">testing</span><span class="op" id="7615473">.</span><span class="ident" id="7615474">T</span><span class="op" id="7615475">)</span>&nbsp;<span class="op" id="7615477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615480">db</span>&nbsp;<span class="op" id="7615483">:=</span>&nbsp;<span class="ident" id="7615486">newTestDB</span><span class="op" id="7615495">(</span><span class="ident" id="7615496">t</span><span class="op" id="7615497">,</span>&nbsp;<span class="string" id="7615499">&#34;foo&#34;</span><span class="op" id="7615504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7615507">defer</span>&nbsp;<span class="ident" id="7615513">closeDB</span><span class="op" id="7615520">(</span><span class="ident" id="7615521">t</span><span class="op" id="7615522">,</span>&nbsp;<span class="ident" id="7615524">db</span><span class="op" id="7615526">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615529">exec</span><span class="op" id="7615533">(</span><span class="ident" id="7615534">t</span><span class="op" id="7615535">,</span>&nbsp;<span class="ident" id="7615537">db</span><span class="op" id="7615539">,</span>&nbsp;<span class="string" id="7615541">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7615584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615587">stmt</span><span class="op" id="7615591">,</span>&nbsp;<span class="ident" id="7615593">err</span>&nbsp;<span class="op" id="7615597">:=</span>&nbsp;<span class="ident" id="7615600">db</span><span class="op" id="7615602">.</span><span class="ident" id="7615603">Prepare</span><span class="op" id="7615610">(</span><span class="string" id="7615611">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7615635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7615638">if</span>&nbsp;<span class="ident" id="7615641">err</span>&nbsp;<span class="op" id="7615645">!=</span>&nbsp;<span class="ident" id="7615648">nil</span>&nbsp;<span class="op" id="7615652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615656">t</span><span class="op" id="7615657">.</span><span class="ident" id="7615658">Errorf</span><span class="op" id="7615664">(</span><span class="string" id="7615665">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7615685">,</span>&nbsp;<span class="ident" id="7615687">stmt</span><span class="op" id="7615691">,</span>&nbsp;<span class="ident" id="7615693">err</span><span class="op" id="7615696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615699">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7615702">defer</span>&nbsp;<span class="ident" id="7615708">stmt</span><span class="op" id="7615712">.</span><span class="ident" id="7615713">Close</span><span class="op" id="7615718">(</span><span class="op" id="7615719">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7615723">type</span>&nbsp;<span class="ident" id="7615728">execTest</span>&nbsp;<span class="keyword" id="7615737">struct</span>&nbsp;<span class="op" id="7615744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615748">args</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7615756">[</span><span class="op" id="7615757">]</span><span class="keyword" id="7615758">interface</span><span class="op" id="7615767">{</span><span class="op" id="7615768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615772">wantErr</span>&nbsp;<span class="builtintype" id="7615780">string</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7615791">execTests</span>&nbsp;<span class="op" id="7615801">:=</span>&nbsp;<span class="op" id="7615804">[</span><span class="op" id="7615805">]</span><span class="ident" id="7615806">execTest</span><span class="op" id="7615814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7615818">//&nbsp;Okay:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615829">{</span><span class="op" id="7615830">[</span><span class="op" id="7615831">]</span><span class="keyword" id="7615832">interface</span><span class="op" id="7615841">{</span><span class="op" id="7615842">}</span><span class="op" id="7615843">{</span><span class="string" id="7615844">&#34;Brad&#34;</span><span class="op" id="7615850">,</span>&nbsp;<span class="num" id="7615852">31</span><span class="op" id="7615854">}</span><span class="op" id="7615855">,</span>&nbsp;<span class="string" id="7615857">&#34;&#34;</span><span class="op" id="7615859">}</span><span class="op" id="7615860">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615864">{</span><span class="op" id="7615865">[</span><span class="op" id="7615866">]</span><span class="keyword" id="7615867">interface</span><span class="op" id="7615876">{</span><span class="op" id="7615877">}</span><span class="op" id="7615878">{</span><span class="string" id="7615879">&#34;Brad&#34;</span><span class="op" id="7615885">,</span>&nbsp;<span class="ident" id="7615887">int64</span><span class="op" id="7615892">(</span><span class="num" id="7615893">31</span><span class="op" id="7615895">)</span><span class="op" id="7615896">}</span><span class="op" id="7615897">,</span>&nbsp;<span class="string" id="7615899">&#34;&#34;</span><span class="op" id="7615901">}</span><span class="op" id="7615902">,</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615906">{</span><span class="op" id="7615907">[</span><span class="op" id="7615908">]</span><span class="keyword" id="7615909">interface</span><span class="op" id="7615918">{</span><span class="op" id="7615919">}</span><span class="op" id="7615920">{</span><span class="string" id="7615921">&#34;Bob&#34;</span><span class="op" id="7615926">,</span>&nbsp;<span class="string" id="7615928">&#34;32&#34;</span><span class="op" id="7615932">}</span><span class="op" id="7615933">,</span>&nbsp;<span class="string" id="7615935">&#34;&#34;</span><span class="op" id="7615937">}</span><span class="op" id="7615938">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615942">{</span><span class="op" id="7615943">[</span><span class="op" id="7615944">]</span><span class="keyword" id="7615945">interface</span><span class="op" id="7615954">{</span><span class="op" id="7615955">}</span><span class="op" id="7615956">{</span><span class="num" id="7615957">7</span><span class="op" id="7615958">,</span>&nbsp;<span class="num" id="7615960">9</span><span class="op" id="7615961">}</span><span class="op" id="7615962">,</span>&nbsp;<span class="string" id="7615964">&#34;&#34;</span><span class="op" id="7615966">}</span><span class="op" id="7615967">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7615972">//&nbsp;Invalid&nbsp;conversions:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7615998">{</span><span class="op" id="7615999">[</span><span class="op" id="7616000">]</span><span class="keyword" id="7616001">interface</span><span class="op" id="7616010">{</span><span class="op" id="7616011">}</span><span class="op" id="7616012">{</span><span class="string" id="7616013">&#34;Brad&#34;</span><span class="op" id="7616019">,</span>&nbsp;<span class="ident" id="7616021">int64</span><span class="op" id="7616026">(</span><span class="num" id="7616027">0xFFFFFFFF</span><span class="op" id="7616037">)</span><span class="op" id="7616038">}</span><span class="op" id="7616039">,</span>&nbsp;<span class="string" id="7616041">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;4294967295&nbsp;overflows&nbsp;int32&#34;</span><span class="op" id="7616123">}</span><span class="op" id="7616124">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7616128">{</span><span class="op" id="7616129">[</span><span class="op" id="7616130">]</span><span class="keyword" id="7616131">interface</span><span class="op" id="7616140">{</span><span class="op" id="7616141">}</span><span class="op" id="7616142">{</span><span class="string" id="7616143">&#34;Brad&#34;</span><span class="op" id="7616149">,</span>&nbsp;<span class="string" id="7616151">&#34;strconv&nbsp;fail&#34;</span><span class="op" id="7616165">}</span><span class="op" id="7616166">,</span>&nbsp;<span class="string" id="7616168">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;\&#34;strconv&nbsp;fail\&#34;&nbsp;can&#39;t&nbsp;be&nbsp;converted&nbsp;to&nbsp;int32&#34;</span><span class="op" id="7616268">}</span><span class="op" id="7616269">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7616274">//&nbsp;Wrong&nbsp;number&nbsp;of&nbsp;args:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7616301">{</span><span class="op" id="7616302">[</span><span class="op" id="7616303">]</span><span class="keyword" id="7616304">interface</span><span class="op" id="7616313">{</span><span class="op" id="7616314">}</span><span class="op" id="7616315">{</span><span class="op" id="7616316">}</span><span class="op" id="7616317">,</span>&nbsp;<span class="string" id="7616319">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;0&#34;</span><span class="op" id="7616353">}</span><span class="op" id="7616354">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7616358">{</span><span class="op" id="7616359">[</span><span class="op" id="7616360">]</span><span class="keyword" id="7616361">interface</span><span class="op" id="7616370">{</span><span class="op" id="7616371">}</span><span class="op" id="7616372">{</span><span class="num" id="7616373">1</span><span class="op" id="7616374">,</span>&nbsp;<span class="num" id="7616376">2</span><span class="op" id="7616377">,</span>&nbsp;<span class="num" id="7616379">3</span><span class="op" id="7616380">}</span><span class="op" id="7616381">,</span>&nbsp;<span class="string" id="7616383">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;3&#34;</span><span class="op" id="7616417">}</span><span class="op" id="7616418">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7616421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7616424">for</span>&nbsp;<span class="ident" id="7616428">n</span><span class="op" id="7616429">,</span>&nbsp;<span class="ident" id="7616431">et</span>&nbsp;<span class="op" id="7616434">:=</span>&nbsp;<span class="keyword" id="7616437">range</span>&nbsp;<span class="ident" id="7616443">execTests</span>&nbsp;<span class="op" id="7616453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616457">_</span><span class="op" id="7616458">,</span>&nbsp;<span class="ident" id="7616460">err</span>&nbsp;<span class="op" id="7616464">:=</span>&nbsp;<span class="ident" id="7616467">stmt</span><span class="op" id="7616471">.</span><span class="ident" id="7616472">Exec</span><span class="op" id="7616476">(</span><span class="ident" id="7616477">et</span><span class="op" id="7616479">.</span><span class="ident" id="7616480">args</span><span class="op" id="7616484">...</span><span class="op" id="7616487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616491">errStr</span>&nbsp;<span class="op" id="7616498">:=</span>&nbsp;<span class="string" id="7616501">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7616506">if</span>&nbsp;<span class="ident" id="7616509">err</span>&nbsp;<span class="op" id="7616513">!=</span>&nbsp;<span class="ident" id="7616516">nil</span>&nbsp;<span class="op" id="7616520">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616525">errStr</span>&nbsp;<span class="op" id="7616532">=</span>&nbsp;<span class="ident" id="7616534">err</span><span class="op" id="7616537">.</span><span class="ident" id="7616538">Error</span><span class="op" id="7616543">(</span><span class="op" id="7616544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7616548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7616552">if</span>&nbsp;<span class="ident" id="7616555">errStr</span>&nbsp;<span class="op" id="7616562">!=</span>&nbsp;<span class="ident" id="7616565">et</span><span class="op" id="7616567">.</span><span class="ident" id="7616568">wantErr</span>&nbsp;<span class="op" id="7616576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616581">t</span><span class="op" id="7616582">.</span><span class="ident" id="7616583">Errorf</span><span class="op" id="7616589">(</span><span class="string" id="7616590">&#34;stmt.Execute&nbsp;#%d:&nbsp;for&nbsp;%v,&nbsp;got&nbsp;error&nbsp;%q,&nbsp;want&nbsp;error&nbsp;%q&#34;</span><span class="op" id="7616645">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616651">n</span><span class="op" id="7616652">,</span>&nbsp;<span class="ident" id="7616654">et</span><span class="op" id="7616656">.</span><span class="ident" id="7616657">args</span><span class="op" id="7616661">,</span>&nbsp;<span class="ident" id="7616663">errStr</span><span class="op" id="7616669">,</span>&nbsp;<span class="ident" id="7616671">et</span><span class="op" id="7616673">.</span><span class="ident" id="7616674">wantErr</span><span class="op" id="7616681">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7616685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7616688">}</span><br>
<span class="lineno"></span><span class="op" id="7616690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7616693">func</span>&nbsp;<span class="ident" id="7616698">TestTxPrepare</span><span class="op" id="7616711">(</span><span class="ident" id="7616712">t</span>&nbsp;<span class="op" id="7616714">*</span><span class="ident" id="7616715">testing</span><span class="op" id="7616722">.</span><span class="ident" id="7616723">T</span><span class="op" id="7616724">)</span>&nbsp;<span class="op" id="7616726">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616729">db</span>&nbsp;<span class="op" id="7616732">:=</span>&nbsp;<span class="ident" id="7616735">newTestDB</span><span class="op" id="7616744">(</span><span class="ident" id="7616745">t</span><span class="op" id="7616746">,</span>&nbsp;<span class="string" id="7616748">&#34;&#34;</span><span class="op" id="7616750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7616753">defer</span>&nbsp;<span class="ident" id="7616759">closeDB</span><span class="op" id="7616766">(</span><span class="ident" id="7616767">t</span><span class="op" id="7616768">,</span>&nbsp;<span class="ident" id="7616770">db</span><span class="op" id="7616772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616775">exec</span><span class="op" id="7616779">(</span><span class="ident" id="7616780">t</span><span class="op" id="7616781">,</span>&nbsp;<span class="ident" id="7616783">db</span><span class="op" id="7616785">,</span>&nbsp;<span class="string" id="7616787">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7616830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616833">tx</span><span class="op" id="7616835">,</span>&nbsp;<span class="ident" id="7616837">err</span>&nbsp;<span class="op" id="7616841">:=</span>&nbsp;<span class="ident" id="7616844">db</span><span class="op" id="7616846">.</span><span class="ident" id="7616847">Begin</span><span class="op" id="7616852">(</span><span class="op" id="7616853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7616856">if</span>&nbsp;<span class="ident" id="7616859">err</span>&nbsp;<span class="op" id="7616863">!=</span>&nbsp;<span class="ident" id="7616866">nil</span>&nbsp;<span class="op" id="7616870">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616874">t</span><span class="op" id="7616875">.</span><span class="ident" id="7616876">Fatalf</span><span class="op" id="7616882">(</span><span class="string" id="7616883">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7616895">,</span>&nbsp;<span class="ident" id="7616897">err</span><span class="op" id="7616900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7616903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616906">stmt</span><span class="op" id="7616910">,</span>&nbsp;<span class="ident" id="7616912">err</span>&nbsp;<span class="op" id="7616916">:=</span>&nbsp;<span class="ident" id="7616919">tx</span><span class="op" id="7616921">.</span><span class="ident" id="7616922">Prepare</span><span class="op" id="7616929">(</span><span class="string" id="7616930">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7616954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7616957">if</span>&nbsp;<span class="ident" id="7616960">err</span>&nbsp;<span class="op" id="7616964">!=</span>&nbsp;<span class="ident" id="7616967">nil</span>&nbsp;<span class="op" id="7616971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7616975">t</span><span class="op" id="7616976">.</span><span class="ident" id="7616977">Fatalf</span><span class="op" id="7616983">(</span><span class="string" id="7616984">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7617004">,</span>&nbsp;<span class="ident" id="7617006">stmt</span><span class="op" id="7617010">,</span>&nbsp;<span class="ident" id="7617012">err</span><span class="op" id="7617015">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7617018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617021">defer</span>&nbsp;<span class="ident" id="7617027">stmt</span><span class="op" id="7617031">.</span><span class="ident" id="7617032">Close</span><span class="op" id="7617037">(</span><span class="op" id="7617038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617041">_</span><span class="op" id="7617042">,</span>&nbsp;<span class="ident" id="7617044">err</span>&nbsp;<span class="op" id="7617048">=</span>&nbsp;<span class="ident" id="7617050">stmt</span><span class="op" id="7617054">.</span><span class="ident" id="7617055">Exec</span><span class="op" id="7617059">(</span><span class="string" id="7617060">&#34;Bobby&#34;</span><span class="op" id="7617067">,</span>&nbsp;<span class="num" id="7617069">7</span><span class="op" id="7617070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617073">if</span>&nbsp;<span class="ident" id="7617076">err</span>&nbsp;<span class="op" id="7617080">!=</span>&nbsp;<span class="ident" id="7617083">nil</span>&nbsp;<span class="op" id="7617087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617091">t</span><span class="op" id="7617092">.</span><span class="ident" id="7617093">Fatalf</span><span class="op" id="7617099">(</span><span class="string" id="7617100">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7617111">,</span>&nbsp;<span class="ident" id="7617113">err</span><span class="op" id="7617116">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7617119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617122">err</span>&nbsp;<span class="op" id="7617126">=</span>&nbsp;<span class="ident" id="7617128">tx</span><span class="op" id="7617130">.</span><span class="ident" id="7617131">Commit</span><span class="op" id="7617137">(</span><span class="op" id="7617138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617141">if</span>&nbsp;<span class="ident" id="7617144">err</span>&nbsp;<span class="op" id="7617148">!=</span>&nbsp;<span class="ident" id="7617151">nil</span>&nbsp;<span class="op" id="7617155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617159">t</span><span class="op" id="7617160">.</span><span class="ident" id="7617161">Fatalf</span><span class="op" id="7617167">(</span><span class="string" id="7617168">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7617181">,</span>&nbsp;<span class="ident" id="7617183">err</span><span class="op" id="7617186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7617189">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7617192">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617238">if</span>&nbsp;<span class="op" id="7617241">!</span><span class="ident" id="7617242">stmt</span><span class="op" id="7617246">.</span><span class="ident" id="7617247">closed</span>&nbsp;<span class="op" id="7617254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617258">t</span><span class="op" id="7617259">.</span><span class="ident" id="7617260">Fatal</span><span class="op" id="7617265">(</span><span class="string" id="7617266">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="7617296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7617299">}</span><br>
<span class="lineno"></span><span class="op" id="7617301">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="keyword" id="7617304">func</span>&nbsp;<span class="ident" id="7617309">TestTxStmt</span><span class="op" id="7617319">(</span><span class="ident" id="7617320">t</span>&nbsp;<span class="op" id="7617322">*</span><span class="ident" id="7617323">testing</span><span class="op" id="7617330">.</span><span class="ident" id="7617331">T</span><span class="op" id="7617332">)</span>&nbsp;<span class="op" id="7617334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617337">db</span>&nbsp;<span class="op" id="7617340">:=</span>&nbsp;<span class="ident" id="7617343">newTestDB</span><span class="op" id="7617352">(</span><span class="ident" id="7617353">t</span><span class="op" id="7617354">,</span>&nbsp;<span class="string" id="7617356">&#34;&#34;</span><span class="op" id="7617358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617361">defer</span>&nbsp;<span class="ident" id="7617367">closeDB</span><span class="op" id="7617374">(</span><span class="ident" id="7617375">t</span><span class="op" id="7617376">,</span>&nbsp;<span class="ident" id="7617378">db</span><span class="op" id="7617380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617383">exec</span><span class="op" id="7617387">(</span><span class="ident" id="7617388">t</span><span class="op" id="7617389">,</span>&nbsp;<span class="ident" id="7617391">db</span><span class="op" id="7617393">,</span>&nbsp;<span class="string" id="7617395">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7617438">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617441">stmt</span><span class="op" id="7617445">,</span>&nbsp;<span class="ident" id="7617447">err</span>&nbsp;<span class="op" id="7617451">:=</span>&nbsp;<span class="ident" id="7617454">db</span><span class="op" id="7617456">.</span><span class="ident" id="7617457">Prepare</span><span class="op" id="7617464">(</span><span class="string" id="7617465">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7617489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617492">if</span>&nbsp;<span class="ident" id="7617495">err</span>&nbsp;<span class="op" id="7617499">!=</span>&nbsp;<span class="ident" id="7617502">nil</span>&nbsp;<span class="op" id="7617506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617510">t</span><span class="op" id="7617511">.</span><span class="ident" id="7617512">Fatalf</span><span class="op" id="7617518">(</span><span class="string" id="7617519">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7617539">,</span>&nbsp;<span class="ident" id="7617541">stmt</span><span class="op" id="7617545">,</span>&nbsp;<span class="ident" id="7617547">err</span><span class="op" id="7617550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7617553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617556">defer</span>&nbsp;<span class="ident" id="7617562">stmt</span><span class="op" id="7617566">.</span><span class="ident" id="7617567">Close</span><span class="op" id="7617572">(</span><span class="op" id="7617573">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617576">tx</span><span class="op" id="7617578">,</span>&nbsp;<span class="ident" id="7617580">err</span>&nbsp;<span class="op" id="7617584">:=</span>&nbsp;<span class="ident" id="7617587">db</span><span class="op" id="7617589">.</span><span class="ident" id="7617590">Begin</span><span class="op" id="7617595">(</span><span class="op" id="7617596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617599">if</span>&nbsp;<span class="ident" id="7617602">err</span>&nbsp;<span class="op" id="7617606">!=</span>&nbsp;<span class="ident" id="7617609">nil</span>&nbsp;<span class="op" id="7617613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617617">t</span><span class="op" id="7617618">.</span><span class="ident" id="7617619">Fatalf</span><span class="op" id="7617625">(</span><span class="string" id="7617626">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7617638">,</span>&nbsp;<span class="ident" id="7617640">err</span><span class="op" id="7617643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7617646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617649">txs</span>&nbsp;<span class="op" id="7617653">:=</span>&nbsp;<span class="ident" id="7617656">tx</span><span class="op" id="7617658">.</span><span class="ident" id="7617659">Stmt</span><span class="op" id="7617663">(</span><span class="ident" id="7617664">stmt</span><span class="op" id="7617668">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617671">defer</span>&nbsp;<span class="ident" id="7617677">txs</span><span class="op" id="7617680">.</span><span class="ident" id="7617681">Close</span><span class="op" id="7617686">(</span><span class="op" id="7617687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617690">_</span><span class="op" id="7617691">,</span>&nbsp;<span class="ident" id="7617693">err</span>&nbsp;<span class="op" id="7617697">=</span>&nbsp;<span class="ident" id="7617699">txs</span><span class="op" id="7617702">.</span><span class="ident" id="7617703">Exec</span><span class="op" id="7617707">(</span><span class="string" id="7617708">&#34;Bobby&#34;</span><span class="op" id="7617715">,</span>&nbsp;<span class="num" id="7617717">7</span><span class="op" id="7617718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617721">if</span>&nbsp;<span class="ident" id="7617724">err</span>&nbsp;<span class="op" id="7617728">!=</span>&nbsp;<span class="ident" id="7617731">nil</span>&nbsp;<span class="op" id="7617735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617739">t</span><span class="op" id="7617740">.</span><span class="ident" id="7617741">Fatalf</span><span class="op" id="7617747">(</span><span class="string" id="7617748">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7617759">,</span>&nbsp;<span class="ident" id="7617761">err</span><span class="op" id="7617764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7617767">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617770">err</span>&nbsp;<span class="op" id="7617774">=</span>&nbsp;<span class="ident" id="7617776">tx</span><span class="op" id="7617778">.</span><span class="ident" id="7617779">Commit</span><span class="op" id="7617785">(</span><span class="op" id="7617786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617789">if</span>&nbsp;<span class="ident" id="7617792">err</span>&nbsp;<span class="op" id="7617796">!=</span>&nbsp;<span class="ident" id="7617799">nil</span>&nbsp;<span class="op" id="7617803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617807">t</span><span class="op" id="7617808">.</span><span class="ident" id="7617809">Fatalf</span><span class="op" id="7617815">(</span><span class="string" id="7617816">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7617829">,</span>&nbsp;<span class="ident" id="7617831">err</span><span class="op" id="7617834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7617837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7617840">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7617886">if</span>&nbsp;<span class="op" id="7617889">!</span><span class="ident" id="7617890">txs</span><span class="op" id="7617893">.</span><span class="ident" id="7617894">closed</span>&nbsp;<span class="op" id="7617901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7617905">t</span><span class="op" id="7617906">.</span><span class="ident" id="7617907">Fatal</span><span class="op" id="7617912">(</span><span class="string" id="7617913">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="7617943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7617946">}</span><br>
<span class="lineno"></span><span class="op" id="7617948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">500</span><span class="comment" id="7617951">//&nbsp;Issue:&nbsp;http://golang.org/issue/2784</span><br>
<span class="lineno"></span><span class="comment" id="7617990">//&nbsp;This&nbsp;test&nbsp;didn&#39;t&nbsp;fail&nbsp;before&nbsp;because&nbsp;we&nbsp;got&nbsp;lucky&nbsp;with&nbsp;the&nbsp;fakedb&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="7618067">//&nbsp;It&nbsp;was&nbsp;failing,&nbsp;and&nbsp;now&nbsp;not,&nbsp;in&nbsp;github.com/bradfitz/go-sql-test</span><br>
<span class="lineno"></span><span class="keyword" id="7618134">func</span>&nbsp;<span class="ident" id="7618139">TestTxQuery</span><span class="op" id="7618150">(</span><span class="ident" id="7618151">t</span>&nbsp;<span class="op" id="7618153">*</span><span class="ident" id="7618154">testing</span><span class="op" id="7618161">.</span><span class="ident" id="7618162">T</span><span class="op" id="7618163">)</span>&nbsp;<span class="op" id="7618165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618168">db</span>&nbsp;<span class="op" id="7618171">:=</span>&nbsp;<span class="ident" id="7618174">newTestDB</span><span class="op" id="7618183">(</span><span class="ident" id="7618184">t</span><span class="op" id="7618185">,</span>&nbsp;<span class="string" id="7618187">&#34;&#34;</span><span class="op" id="7618189">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7618192">defer</span>&nbsp;<span class="ident" id="7618198">closeDB</span><span class="op" id="7618205">(</span><span class="ident" id="7618206">t</span><span class="op" id="7618207">,</span>&nbsp;<span class="ident" id="7618209">db</span><span class="op" id="7618211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618214">exec</span><span class="op" id="7618218">(</span><span class="ident" id="7618219">t</span><span class="op" id="7618220">,</span>&nbsp;<span class="ident" id="7618222">db</span><span class="op" id="7618224">,</span>&nbsp;<span class="string" id="7618226">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7618269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618272">exec</span><span class="op" id="7618276">(</span><span class="ident" id="7618277">t</span><span class="op" id="7618278">,</span>&nbsp;<span class="ident" id="7618280">db</span><span class="op" id="7618282">,</span>&nbsp;<span class="string" id="7618284">&#34;INSERT|t1|name=Alice&#34;</span><span class="op" id="7618306">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618310">tx</span><span class="op" id="7618312">,</span>&nbsp;<span class="ident" id="7618314">err</span>&nbsp;<span class="op" id="7618318">:=</span>&nbsp;<span class="ident" id="7618321">db</span><span class="op" id="7618323">.</span><span class="ident" id="7618324">Begin</span><span class="op" id="7618329">(</span><span class="op" id="7618330">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7618333">if</span>&nbsp;<span class="ident" id="7618336">err</span>&nbsp;<span class="op" id="7618340">!=</span>&nbsp;<span class="ident" id="7618343">nil</span>&nbsp;<span class="op" id="7618347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618351">t</span><span class="op" id="7618352">.</span><span class="ident" id="7618353">Fatal</span><span class="op" id="7618358">(</span><span class="ident" id="7618359">err</span><span class="op" id="7618362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7618365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7618368">defer</span>&nbsp;<span class="ident" id="7618374">tx</span><span class="op" id="7618376">.</span><span class="ident" id="7618377">Rollback</span><span class="op" id="7618385">(</span><span class="op" id="7618386">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618390">r</span><span class="op" id="7618391">,</span>&nbsp;<span class="ident" id="7618393">err</span>&nbsp;<span class="op" id="7618397">:=</span>&nbsp;<span class="ident" id="7618400">tx</span><span class="op" id="7618402">.</span><span class="ident" id="7618403">Query</span><span class="op" id="7618408">(</span><span class="string" id="7618409">&#34;SELECT|t1|name|&#34;</span><span class="op" id="7618426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7618429">if</span>&nbsp;<span class="ident" id="7618432">err</span>&nbsp;<span class="op" id="7618436">!=</span>&nbsp;<span class="ident" id="7618439">nil</span>&nbsp;<span class="op" id="7618443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618447">t</span><span class="op" id="7618448">.</span><span class="ident" id="7618449">Fatal</span><span class="op" id="7618454">(</span><span class="ident" id="7618455">err</span><span class="op" id="7618458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7618461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7618464">defer</span>&nbsp;<span class="ident" id="7618470">r</span><span class="op" id="7618471">.</span><span class="ident" id="7618472">Close</span><span class="op" id="7618477">(</span><span class="op" id="7618478">)</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7618482">if</span>&nbsp;<span class="op" id="7618485">!</span><span class="ident" id="7618486">r</span><span class="op" id="7618487">.</span><span class="ident" id="7618488">Next</span><span class="op" id="7618492">(</span><span class="op" id="7618493">)</span>&nbsp;<span class="op" id="7618495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7618499">if</span>&nbsp;<span class="ident" id="7618502">r</span><span class="op" id="7618503">.</span><span class="ident" id="7618504">Err</span><span class="op" id="7618507">(</span><span class="op" id="7618508">)</span>&nbsp;<span class="op" id="7618510">!=</span>&nbsp;<span class="ident" id="7618513">nil</span>&nbsp;<span class="op" id="7618517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618522">t</span><span class="op" id="7618523">.</span><span class="ident" id="7618524">Fatal</span><span class="op" id="7618529">(</span><span class="ident" id="7618530">r</span><span class="op" id="7618531">.</span><span class="ident" id="7618532">Err</span><span class="op" id="7618535">(</span><span class="op" id="7618536">)</span><span class="op" id="7618537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7618541">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618545">t</span><span class="op" id="7618546">.</span><span class="ident" id="7618547">Fatal</span><span class="op" id="7618552">(</span><span class="string" id="7618553">&#34;expected&nbsp;one&nbsp;row&#34;</span><span class="op" id="7618571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7618574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7618578">var</span>&nbsp;<span class="ident" id="7618582">x</span>&nbsp;<span class="builtintype" id="7618584">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618592">err</span>&nbsp;<span class="op" id="7618596">=</span>&nbsp;<span class="ident" id="7618598">r</span><span class="op" id="7618599">.</span><span class="ident" id="7618600">Scan</span><span class="op" id="7618604">(</span><span class="op" id="7618605">&amp;</span><span class="ident" id="7618606">x</span><span class="op" id="7618607">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7618610">if</span>&nbsp;<span class="ident" id="7618613">err</span>&nbsp;<span class="op" id="7618617">!=</span>&nbsp;<span class="ident" id="7618620">nil</span>&nbsp;<span class="op" id="7618624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618628">t</span><span class="op" id="7618629">.</span><span class="ident" id="7618630">Fatal</span><span class="op" id="7618635">(</span><span class="ident" id="7618636">err</span><span class="op" id="7618639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7618642">}</span><br>
<span class="lineno"></span><span class="op" id="7618644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="7618647">func</span>&nbsp;<span class="ident" id="7618652">TestTxQueryInvalid</span><span class="op" id="7618670">(</span><span class="ident" id="7618671">t</span>&nbsp;<span class="op" id="7618673">*</span><span class="ident" id="7618674">testing</span><span class="op" id="7618681">.</span><span class="ident" id="7618682">T</span><span class="op" id="7618683">)</span>&nbsp;<span class="op" id="7618685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618688">db</span>&nbsp;<span class="op" id="7618691">:=</span>&nbsp;<span class="ident" id="7618694">newTestDB</span><span class="op" id="7618703">(</span><span class="ident" id="7618704">t</span><span class="op" id="7618705">,</span>&nbsp;<span class="string" id="7618707">&#34;&#34;</span><span class="op" id="7618709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7618712">defer</span>&nbsp;<span class="ident" id="7618718">closeDB</span><span class="op" id="7618725">(</span><span class="ident" id="7618726">t</span><span class="op" id="7618727">,</span>&nbsp;<span class="ident" id="7618729">db</span><span class="op" id="7618731">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618735">tx</span><span class="op" id="7618737">,</span>&nbsp;<span class="ident" id="7618739">err</span>&nbsp;<span class="op" id="7618743">:=</span>&nbsp;<span class="ident" id="7618746">db</span><span class="op" id="7618748">.</span><span class="ident" id="7618749">Begin</span><span class="op" id="7618754">(</span><span class="op" id="7618755">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7618758">if</span>&nbsp;<span class="ident" id="7618761">err</span>&nbsp;<span class="op" id="7618765">!=</span>&nbsp;<span class="ident" id="7618768">nil</span>&nbsp;<span class="op" id="7618772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618776">t</span><span class="op" id="7618777">.</span><span class="ident" id="7618778">Fatal</span><span class="op" id="7618783">(</span><span class="ident" id="7618784">err</span><span class="op" id="7618787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7618790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7618793">defer</span>&nbsp;<span class="ident" id="7618799">tx</span><span class="op" id="7618801">.</span><span class="ident" id="7618802">Rollback</span><span class="op" id="7618810">(</span><span class="op" id="7618811">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618815">_</span><span class="op" id="7618816">,</span>&nbsp;<span class="ident" id="7618818">err</span>&nbsp;<span class="op" id="7618822">=</span>&nbsp;<span class="ident" id="7618824">tx</span><span class="op" id="7618826">.</span><span class="ident" id="7618827">Query</span><span class="op" id="7618832">(</span><span class="string" id="7618833">&#34;SELECT|t1|name|&#34;</span><span class="op" id="7618850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7618853">if</span>&nbsp;<span class="ident" id="7618856">err</span>&nbsp;<span class="op" id="7618860">==</span>&nbsp;<span class="ident" id="7618863">nil</span>&nbsp;<span class="op" id="7618867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7618871">t</span><span class="op" id="7618872">.</span><span class="ident" id="7618873">Fatal</span><span class="op" id="7618878">(</span><span class="string" id="7618879">&#34;Error&nbsp;expected&#34;</span><span class="op" id="7618895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7618898">}</span><br>
<span class="lineno"></span><span class="op" id="7618900">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="7618903">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;4433,&nbsp;that&nbsp;retries&nbsp;in&nbsp;Begin&nbsp;happen&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="7618966">//&nbsp;conn.Begin()&nbsp;returns&nbsp;ErrBadConn</span><br>
<span class="lineno"></span><span class="keyword" id="7619001">func</span>&nbsp;<span class="ident" id="7619006">TestTxErrBadConn</span><span class="op" id="7619022">(</span><span class="ident" id="7619023">t</span>&nbsp;<span class="op" id="7619025">*</span><span class="ident" id="7619026">testing</span><span class="op" id="7619033">.</span><span class="ident" id="7619034">T</span><span class="op" id="7619035">)</span>&nbsp;<span class="op" id="7619037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619040">db</span><span class="op" id="7619042">,</span>&nbsp;<span class="ident" id="7619044">err</span>&nbsp;<span class="op" id="7619048">:=</span>&nbsp;<span class="ident" id="7619051">Open</span><span class="op" id="7619055">(</span><span class="string" id="7619056">&#34;test&#34;</span><span class="op" id="7619062">,</span>&nbsp;<span class="ident" id="7619064">fakeDBName</span><span class="op" id="7619074">+</span><span class="string" id="7619075">&#34;;badConn&#34;</span><span class="op" id="7619085">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7619088">if</span>&nbsp;<span class="ident" id="7619091">err</span>&nbsp;<span class="op" id="7619095">!=</span>&nbsp;<span class="ident" id="7619098">nil</span>&nbsp;<span class="op" id="7619102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619106">t</span><span class="op" id="7619107">.</span><span class="ident" id="7619108">Fatalf</span><span class="op" id="7619114">(</span><span class="string" id="7619115">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="7619125">,</span>&nbsp;<span class="ident" id="7619127">err</span><span class="op" id="7619130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7619133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7619136">if</span>&nbsp;<span class="ident" id="7619139">_</span><span class="op" id="7619140">,</span>&nbsp;<span class="ident" id="7619142">err</span>&nbsp;<span class="op" id="7619146">:=</span>&nbsp;<span class="ident" id="7619149">db</span><span class="op" id="7619151">.</span><span class="ident" id="7619152">Exec</span><span class="op" id="7619156">(</span><span class="string" id="7619157">&#34;WIPE&#34;</span><span class="op" id="7619163">)</span><span class="op" id="7619164">;</span>&nbsp;<span class="ident" id="7619166">err</span>&nbsp;<span class="op" id="7619170">!=</span>&nbsp;<span class="ident" id="7619173">nil</span>&nbsp;<span class="op" id="7619177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619181">t</span><span class="op" id="7619182">.</span><span class="ident" id="7619183">Fatalf</span><span class="op" id="7619189">(</span><span class="string" id="7619190">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="7619205">,</span>&nbsp;<span class="ident" id="7619207">err</span><span class="op" id="7619210">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7619213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7619216">defer</span>&nbsp;<span class="ident" id="7619222">closeDB</span><span class="op" id="7619229">(</span><span class="ident" id="7619230">t</span><span class="op" id="7619231">,</span>&nbsp;<span class="ident" id="7619233">db</span><span class="op" id="7619235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619238">exec</span><span class="op" id="7619242">(</span><span class="ident" id="7619243">t</span><span class="op" id="7619244">,</span>&nbsp;<span class="ident" id="7619246">db</span><span class="op" id="7619248">,</span>&nbsp;<span class="string" id="7619250">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7619293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619296">stmt</span><span class="op" id="7619300">,</span>&nbsp;<span class="ident" id="7619302">err</span>&nbsp;<span class="op" id="7619306">:=</span>&nbsp;<span class="ident" id="7619309">db</span><span class="op" id="7619311">.</span><span class="ident" id="7619312">Prepare</span><span class="op" id="7619319">(</span><span class="string" id="7619320">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="7619344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7619347">if</span>&nbsp;<span class="ident" id="7619350">err</span>&nbsp;<span class="op" id="7619354">!=</span>&nbsp;<span class="ident" id="7619357">nil</span>&nbsp;<span class="op" id="7619361">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619365">t</span><span class="op" id="7619366">.</span><span class="ident" id="7619367">Fatalf</span><span class="op" id="7619373">(</span><span class="string" id="7619374">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7619394">,</span>&nbsp;<span class="ident" id="7619396">stmt</span><span class="op" id="7619400">,</span>&nbsp;<span class="ident" id="7619402">err</span><span class="op" id="7619405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7619408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7619411">defer</span>&nbsp;<span class="ident" id="7619417">stmt</span><span class="op" id="7619421">.</span><span class="ident" id="7619422">Close</span><span class="op" id="7619427">(</span><span class="op" id="7619428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619431">tx</span><span class="op" id="7619433">,</span>&nbsp;<span class="ident" id="7619435">err</span>&nbsp;<span class="op" id="7619439">:=</span>&nbsp;<span class="ident" id="7619442">db</span><span class="op" id="7619444">.</span><span class="ident" id="7619445">Begin</span><span class="op" id="7619450">(</span><span class="op" id="7619451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7619454">if</span>&nbsp;<span class="ident" id="7619457">err</span>&nbsp;<span class="op" id="7619461">!=</span>&nbsp;<span class="ident" id="7619464">nil</span>&nbsp;<span class="op" id="7619468">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619472">t</span><span class="op" id="7619473">.</span><span class="ident" id="7619474">Fatalf</span><span class="op" id="7619480">(</span><span class="string" id="7619481">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7619493">,</span>&nbsp;<span class="ident" id="7619495">err</span><span class="op" id="7619498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7619501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619504">txs</span>&nbsp;<span class="op" id="7619508">:=</span>&nbsp;<span class="ident" id="7619511">tx</span><span class="op" id="7619513">.</span><span class="ident" id="7619514">Stmt</span><span class="op" id="7619518">(</span><span class="ident" id="7619519">stmt</span><span class="op" id="7619523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7619526">defer</span>&nbsp;<span class="ident" id="7619532">txs</span><span class="op" id="7619535">.</span><span class="ident" id="7619536">Close</span><span class="op" id="7619541">(</span><span class="op" id="7619542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619545">_</span><span class="op" id="7619546">,</span>&nbsp;<span class="ident" id="7619548">err</span>&nbsp;<span class="op" id="7619552">=</span>&nbsp;<span class="ident" id="7619554">txs</span><span class="op" id="7619557">.</span><span class="ident" id="7619558">Exec</span><span class="op" id="7619562">(</span><span class="string" id="7619563">&#34;Bobby&#34;</span><span class="op" id="7619570">,</span>&nbsp;<span class="num" id="7619572">7</span><span class="op" id="7619573">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7619576">if</span>&nbsp;<span class="ident" id="7619579">err</span>&nbsp;<span class="op" id="7619583">!=</span>&nbsp;<span class="ident" id="7619586">nil</span>&nbsp;<span class="op" id="7619590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619594">t</span><span class="op" id="7619595">.</span><span class="ident" id="7619596">Fatalf</span><span class="op" id="7619602">(</span><span class="string" id="7619603">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7619614">,</span>&nbsp;<span class="ident" id="7619616">err</span><span class="op" id="7619619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7619622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619625">err</span>&nbsp;<span class="op" id="7619629">=</span>&nbsp;<span class="ident" id="7619631">tx</span><span class="op" id="7619633">.</span><span class="ident" id="7619634">Commit</span><span class="op" id="7619640">(</span><span class="op" id="7619641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7619644">if</span>&nbsp;<span class="ident" id="7619647">err</span>&nbsp;<span class="op" id="7619651">!=</span>&nbsp;<span class="ident" id="7619654">nil</span>&nbsp;<span class="op" id="7619658">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619662">t</span><span class="op" id="7619663">.</span><span class="ident" id="7619664">Fatalf</span><span class="op" id="7619670">(</span><span class="string" id="7619671">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7619684">,</span>&nbsp;<span class="ident" id="7619686">err</span><span class="op" id="7619689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7619692">}</span><br>
<span class="lineno"></span><span class="op" id="7619694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7619697">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2542,&nbsp;that&nbsp;we&nbsp;release&nbsp;a&nbsp;lock&nbsp;when&nbsp;querying&nbsp;on</span><br>
<span class="lineno">585</span><span class="comment" id="7619766">//&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="7619790">func</span>&nbsp;<span class="ident" id="7619795">TestIssue2542Deadlock</span><span class="op" id="7619816">(</span><span class="ident" id="7619817">t</span>&nbsp;<span class="op" id="7619819">*</span><span class="ident" id="7619820">testing</span><span class="op" id="7619827">.</span><span class="ident" id="7619828">T</span><span class="op" id="7619829">)</span>&nbsp;<span class="op" id="7619831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619834">db</span>&nbsp;<span class="op" id="7619837">:=</span>&nbsp;<span class="ident" id="7619840">newTestDB</span><span class="op" id="7619849">(</span><span class="ident" id="7619850">t</span><span class="op" id="7619851">,</span>&nbsp;<span class="string" id="7619853">&#34;people&#34;</span><span class="op" id="7619861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619864">closeDB</span><span class="op" id="7619871">(</span><span class="ident" id="7619872">t</span><span class="op" id="7619873">,</span>&nbsp;<span class="ident" id="7619875">db</span><span class="op" id="7619877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7619880">for</span>&nbsp;<span class="ident" id="7619884">i</span>&nbsp;<span class="op" id="7619886">:=</span>&nbsp;<span class="num" id="7619889">0</span><span class="op" id="7619890">;</span>&nbsp;<span class="ident" id="7619892">i</span>&nbsp;<span class="op" id="7619894">&lt;</span>&nbsp;<span class="num" id="7619896">2</span><span class="op" id="7619897">;</span>&nbsp;<span class="ident" id="7619899">i</span><span class="op" id="7619900">++</span>&nbsp;<span class="op" id="7619903">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619907">_</span><span class="op" id="7619908">,</span>&nbsp;<span class="ident" id="7619910">err</span>&nbsp;<span class="op" id="7619914">:=</span>&nbsp;<span class="ident" id="7619917">db</span><span class="op" id="7619919">.</span><span class="ident" id="7619920">Query</span><span class="op" id="7619925">(</span><span class="string" id="7619926">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7619951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7619955">if</span>&nbsp;<span class="ident" id="7619958">err</span>&nbsp;<span class="op" id="7619962">==</span>&nbsp;<span class="ident" id="7619965">nil</span>&nbsp;<span class="op" id="7619969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7619974">t</span><span class="op" id="7619975">.</span><span class="ident" id="7619976">Fatalf</span><span class="op" id="7619982">(</span><span class="string" id="7619983">&#34;expected&nbsp;error&#34;</span><span class="op" id="7619999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7620003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7620006">}</span><br>
<span class="lineno">595</span><span class="op" id="7620008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7620011">//&nbsp;From&nbsp;golang.org/issue/3865</span><br>
<span class="lineno"></span><span class="keyword" id="7620041">func</span>&nbsp;<span class="ident" id="7620046">TestCloseStmtBeforeRows</span><span class="op" id="7620069">(</span><span class="ident" id="7620070">t</span>&nbsp;<span class="op" id="7620072">*</span><span class="ident" id="7620073">testing</span><span class="op" id="7620080">.</span><span class="ident" id="7620081">T</span><span class="op" id="7620082">)</span>&nbsp;<span class="op" id="7620084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620087">db</span>&nbsp;<span class="op" id="7620090">:=</span>&nbsp;<span class="ident" id="7620093">newTestDB</span><span class="op" id="7620102">(</span><span class="ident" id="7620103">t</span><span class="op" id="7620104">,</span>&nbsp;<span class="string" id="7620106">&#34;people&#34;</span><span class="op" id="7620114">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7620117">defer</span>&nbsp;<span class="ident" id="7620123">closeDB</span><span class="op" id="7620130">(</span><span class="ident" id="7620131">t</span><span class="op" id="7620132">,</span>&nbsp;<span class="ident" id="7620134">db</span><span class="op" id="7620136">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620140">s</span><span class="op" id="7620141">,</span>&nbsp;<span class="ident" id="7620143">err</span>&nbsp;<span class="op" id="7620147">:=</span>&nbsp;<span class="ident" id="7620150">db</span><span class="op" id="7620152">.</span><span class="ident" id="7620153">Prepare</span><span class="op" id="7620160">(</span><span class="string" id="7620161">&#34;SELECT|people|name|&#34;</span><span class="op" id="7620182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7620185">if</span>&nbsp;<span class="ident" id="7620188">err</span>&nbsp;<span class="op" id="7620192">!=</span>&nbsp;<span class="ident" id="7620195">nil</span>&nbsp;<span class="op" id="7620199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620203">t</span><span class="op" id="7620204">.</span><span class="ident" id="7620205">Fatal</span><span class="op" id="7620210">(</span><span class="ident" id="7620211">err</span><span class="op" id="7620214">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7620217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620221">r</span><span class="op" id="7620222">,</span>&nbsp;<span class="ident" id="7620224">err</span>&nbsp;<span class="op" id="7620228">:=</span>&nbsp;<span class="ident" id="7620231">s</span><span class="op" id="7620232">.</span><span class="ident" id="7620233">Query</span><span class="op" id="7620238">(</span><span class="op" id="7620239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7620242">if</span>&nbsp;<span class="ident" id="7620245">err</span>&nbsp;<span class="op" id="7620249">!=</span>&nbsp;<span class="ident" id="7620252">nil</span>&nbsp;<span class="op" id="7620256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620260">s</span><span class="op" id="7620261">.</span><span class="ident" id="7620262">Close</span><span class="op" id="7620267">(</span><span class="op" id="7620268">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620272">t</span><span class="op" id="7620273">.</span><span class="ident" id="7620274">Fatal</span><span class="op" id="7620279">(</span><span class="ident" id="7620280">err</span><span class="op" id="7620283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7620286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620290">err</span>&nbsp;<span class="op" id="7620294">=</span>&nbsp;<span class="ident" id="7620296">s</span><span class="op" id="7620297">.</span><span class="ident" id="7620298">Close</span><span class="op" id="7620303">(</span><span class="op" id="7620304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7620307">if</span>&nbsp;<span class="ident" id="7620310">err</span>&nbsp;<span class="op" id="7620314">!=</span>&nbsp;<span class="ident" id="7620317">nil</span>&nbsp;<span class="op" id="7620321">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620325">t</span><span class="op" id="7620326">.</span><span class="ident" id="7620327">Fatal</span><span class="op" id="7620332">(</span><span class="ident" id="7620333">err</span><span class="op" id="7620336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7620339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620343">r</span><span class="op" id="7620344">.</span><span class="ident" id="7620345">Close</span><span class="op" id="7620350">(</span><span class="op" id="7620351">)</span><br>
<span class="lineno"></span><span class="op" id="7620353">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="comment" id="7620356">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2788,&nbsp;that&nbsp;we&nbsp;bind&nbsp;nil&nbsp;to&nbsp;a&nbsp;[]byte&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="7620421">//&nbsp;value&nbsp;in&nbsp;the&nbsp;column&nbsp;is&nbsp;sql&nbsp;null</span><br>
<span class="lineno"></span><span class="keyword" id="7620456">func</span>&nbsp;<span class="ident" id="7620461">TestNullByteSlice</span><span class="op" id="7620478">(</span><span class="ident" id="7620479">t</span>&nbsp;<span class="op" id="7620481">*</span><span class="ident" id="7620482">testing</span><span class="op" id="7620489">.</span><span class="ident" id="7620490">T</span><span class="op" id="7620491">)</span>&nbsp;<span class="op" id="7620493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620496">db</span>&nbsp;<span class="op" id="7620499">:=</span>&nbsp;<span class="ident" id="7620502">newTestDB</span><span class="op" id="7620511">(</span><span class="ident" id="7620512">t</span><span class="op" id="7620513">,</span>&nbsp;<span class="string" id="7620515">&#34;&#34;</span><span class="op" id="7620517">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7620520">defer</span>&nbsp;<span class="ident" id="7620526">closeDB</span><span class="op" id="7620533">(</span><span class="ident" id="7620534">t</span><span class="op" id="7620535">,</span>&nbsp;<span class="ident" id="7620537">db</span><span class="op" id="7620539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620542">exec</span><span class="op" id="7620546">(</span><span class="ident" id="7620547">t</span><span class="op" id="7620548">,</span>&nbsp;<span class="ident" id="7620550">db</span><span class="op" id="7620552">,</span>&nbsp;<span class="string" id="7620554">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="7620589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620592">exec</span><span class="op" id="7620596">(</span><span class="ident" id="7620597">t</span><span class="op" id="7620598">,</span>&nbsp;<span class="ident" id="7620600">db</span><span class="op" id="7620602">,</span>&nbsp;<span class="string" id="7620604">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="7620627">,</span>&nbsp;<span class="ident" id="7620629">nil</span><span class="op" id="7620632">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7620636">var</span>&nbsp;<span class="ident" id="7620640">name</span>&nbsp;<span class="op" id="7620645">[</span><span class="op" id="7620646">]</span><span class="builtintype" id="7620647">byte</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620654">err</span>&nbsp;<span class="op" id="7620658">:=</span>&nbsp;<span class="ident" id="7620661">db</span><span class="op" id="7620663">.</span><span class="ident" id="7620664">QueryRow</span><span class="op" id="7620672">(</span><span class="string" id="7620673">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7620693">,</span>&nbsp;<span class="num" id="7620695">10</span><span class="op" id="7620697">)</span><span class="op" id="7620698">.</span><span class="ident" id="7620699">Scan</span><span class="op" id="7620703">(</span><span class="op" id="7620704">&amp;</span><span class="ident" id="7620705">name</span><span class="op" id="7620709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7620712">if</span>&nbsp;<span class="ident" id="7620715">err</span>&nbsp;<span class="op" id="7620719">!=</span>&nbsp;<span class="ident" id="7620722">nil</span>&nbsp;<span class="op" id="7620726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620730">t</span><span class="op" id="7620731">.</span><span class="ident" id="7620732">Fatal</span><span class="op" id="7620737">(</span><span class="ident" id="7620738">err</span><span class="op" id="7620741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7620744">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7620747">if</span>&nbsp;<span class="ident" id="7620750">name</span>&nbsp;<span class="op" id="7620755">!=</span>&nbsp;<span class="ident" id="7620758">nil</span>&nbsp;<span class="op" id="7620762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620766">t</span><span class="op" id="7620767">.</span><span class="ident" id="7620768">Fatalf</span><span class="op" id="7620774">(</span><span class="string" id="7620775">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;nil&nbsp;for&nbsp;null&nbsp;column&nbsp;value,&nbsp;got:&nbsp;%#v&#34;</span><span class="op" id="7620834">,</span>&nbsp;<span class="ident" id="7620836">name</span><span class="op" id="7620840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7620843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620847">exec</span><span class="op" id="7620851">(</span><span class="ident" id="7620852">t</span><span class="op" id="7620853">,</span>&nbsp;<span class="ident" id="7620855">db</span><span class="op" id="7620857">,</span>&nbsp;<span class="string" id="7620859">&#34;INSERT|t|id=11,name=?&#34;</span><span class="op" id="7620882">,</span>&nbsp;<span class="string" id="7620884">&#34;bob&#34;</span><span class="op" id="7620889">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620892">err</span>&nbsp;<span class="op" id="7620896">=</span>&nbsp;<span class="ident" id="7620898">db</span><span class="op" id="7620900">.</span><span class="ident" id="7620901">QueryRow</span><span class="op" id="7620909">(</span><span class="string" id="7620910">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7620930">,</span>&nbsp;<span class="num" id="7620932">11</span><span class="op" id="7620934">)</span><span class="op" id="7620935">.</span><span class="ident" id="7620936">Scan</span><span class="op" id="7620940">(</span><span class="op" id="7620941">&amp;</span><span class="ident" id="7620942">name</span><span class="op" id="7620946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7620949">if</span>&nbsp;<span class="ident" id="7620952">err</span>&nbsp;<span class="op" id="7620956">!=</span>&nbsp;<span class="ident" id="7620959">nil</span>&nbsp;<span class="op" id="7620963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7620967">t</span><span class="op" id="7620968">.</span><span class="ident" id="7620969">Fatal</span><span class="op" id="7620974">(</span><span class="ident" id="7620975">err</span><span class="op" id="7620978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7620981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7620984">if</span>&nbsp;<span class="builtintype" id="7620987">string</span><span class="op" id="7620993">(</span><span class="ident" id="7620994">name</span><span class="op" id="7620998">)</span>&nbsp;<span class="op" id="7621000">!=</span>&nbsp;<span class="string" id="7621003">&#34;bob&#34;</span>&nbsp;<span class="op" id="7621009">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621013">t</span><span class="op" id="7621014">.</span><span class="ident" id="7621015">Fatalf</span><span class="op" id="7621021">(</span><span class="string" id="7621022">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;bob,&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="7621058">,</span>&nbsp;<span class="builtintype" id="7621060">string</span><span class="op" id="7621066">(</span><span class="ident" id="7621067">name</span><span class="op" id="7621071">)</span><span class="op" id="7621072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7621075">}</span><br>
<span class="lineno"></span><span class="op" id="7621077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7621080">func</span>&nbsp;<span class="ident" id="7621085">TestPointerParamsAndScans</span><span class="op" id="7621110">(</span><span class="ident" id="7621111">t</span>&nbsp;<span class="op" id="7621113">*</span><span class="ident" id="7621114">testing</span><span class="op" id="7621121">.</span><span class="ident" id="7621122">T</span><span class="op" id="7621123">)</span>&nbsp;<span class="op" id="7621125">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621128">db</span>&nbsp;<span class="op" id="7621131">:=</span>&nbsp;<span class="ident" id="7621134">newTestDB</span><span class="op" id="7621143">(</span><span class="ident" id="7621144">t</span><span class="op" id="7621145">,</span>&nbsp;<span class="string" id="7621147">&#34;&#34;</span><span class="op" id="7621149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7621152">defer</span>&nbsp;<span class="ident" id="7621158">closeDB</span><span class="op" id="7621165">(</span><span class="ident" id="7621166">t</span><span class="op" id="7621167">,</span>&nbsp;<span class="ident" id="7621169">db</span><span class="op" id="7621171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621174">exec</span><span class="op" id="7621178">(</span><span class="ident" id="7621179">t</span><span class="op" id="7621180">,</span>&nbsp;<span class="ident" id="7621182">db</span><span class="op" id="7621184">,</span>&nbsp;<span class="string" id="7621186">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="7621221">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621225">bob</span>&nbsp;<span class="op" id="7621229">:=</span>&nbsp;<span class="string" id="7621232">&#34;bob&#34;</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7621239">var</span>&nbsp;<span class="ident" id="7621243">name</span>&nbsp;<span class="op" id="7621248">*</span><span class="builtintype" id="7621249">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621258">name</span>&nbsp;<span class="op" id="7621263">=</span>&nbsp;<span class="op" id="7621265">&amp;</span><span class="ident" id="7621266">bob</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621271">exec</span><span class="op" id="7621275">(</span><span class="ident" id="7621276">t</span><span class="op" id="7621277">,</span>&nbsp;<span class="ident" id="7621279">db</span><span class="op" id="7621281">,</span>&nbsp;<span class="string" id="7621283">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="7621306">,</span>&nbsp;<span class="ident" id="7621308">name</span><span class="op" id="7621312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621315">name</span>&nbsp;<span class="op" id="7621320">=</span>&nbsp;<span class="ident" id="7621322">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621327">exec</span><span class="op" id="7621331">(</span><span class="ident" id="7621332">t</span><span class="op" id="7621333">,</span>&nbsp;<span class="ident" id="7621335">db</span><span class="op" id="7621337">,</span>&nbsp;<span class="string" id="7621339">&#34;INSERT|t|id=20,name=?&#34;</span><span class="op" id="7621362">,</span>&nbsp;<span class="ident" id="7621364">name</span><span class="op" id="7621368">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621372">err</span>&nbsp;<span class="op" id="7621376">:=</span>&nbsp;<span class="ident" id="7621379">db</span><span class="op" id="7621381">.</span><span class="ident" id="7621382">QueryRow</span><span class="op" id="7621390">(</span><span class="string" id="7621391">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7621411">,</span>&nbsp;<span class="num" id="7621413">10</span><span class="op" id="7621415">)</span><span class="op" id="7621416">.</span><span class="ident" id="7621417">Scan</span><span class="op" id="7621421">(</span><span class="op" id="7621422">&amp;</span><span class="ident" id="7621423">name</span><span class="op" id="7621427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7621430">if</span>&nbsp;<span class="ident" id="7621433">err</span>&nbsp;<span class="op" id="7621437">!=</span>&nbsp;<span class="ident" id="7621440">nil</span>&nbsp;<span class="op" id="7621444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621448">t</span><span class="op" id="7621449">.</span><span class="ident" id="7621450">Fatalf</span><span class="op" id="7621456">(</span><span class="string" id="7621457">&#34;querying&nbsp;id&nbsp;10:&nbsp;%v&#34;</span><span class="op" id="7621477">,</span>&nbsp;<span class="ident" id="7621479">err</span><span class="op" id="7621482">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7621485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7621488">if</span>&nbsp;<span class="ident" id="7621491">name</span>&nbsp;<span class="op" id="7621496">==</span>&nbsp;<span class="ident" id="7621499">nil</span>&nbsp;<span class="op" id="7621503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621507">t</span><span class="op" id="7621508">.</span><span class="ident" id="7621509">Errorf</span><span class="op" id="7621515">(</span><span class="string" id="7621516">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;nil;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="7621546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7621549">}</span>&nbsp;<span class="keyword" id="7621551">else</span>&nbsp;<span class="keyword" id="7621556">if</span>&nbsp;<span class="op" id="7621559">*</span><span class="ident" id="7621560">name</span>&nbsp;<span class="op" id="7621565">!=</span>&nbsp;<span class="string" id="7621568">&#34;bob&#34;</span>&nbsp;<span class="op" id="7621574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621578">t</span><span class="op" id="7621579">.</span><span class="ident" id="7621580">Errorf</span><span class="op" id="7621586">(</span><span class="string" id="7621587">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="7621616">,</span>&nbsp;<span class="op" id="7621618">*</span><span class="ident" id="7621619">name</span><span class="op" id="7621623">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7621626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621630">err</span>&nbsp;<span class="op" id="7621634">=</span>&nbsp;<span class="ident" id="7621636">db</span><span class="op" id="7621638">.</span><span class="ident" id="7621639">QueryRow</span><span class="op" id="7621647">(</span><span class="string" id="7621648">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="7621668">,</span>&nbsp;<span class="num" id="7621670">20</span><span class="op" id="7621672">)</span><span class="op" id="7621673">.</span><span class="ident" id="7621674">Scan</span><span class="op" id="7621678">(</span><span class="op" id="7621679">&amp;</span><span class="ident" id="7621680">name</span><span class="op" id="7621684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7621687">if</span>&nbsp;<span class="ident" id="7621690">err</span>&nbsp;<span class="op" id="7621694">!=</span>&nbsp;<span class="ident" id="7621697">nil</span>&nbsp;<span class="op" id="7621701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621705">t</span><span class="op" id="7621706">.</span><span class="ident" id="7621707">Fatalf</span><span class="op" id="7621713">(</span><span class="string" id="7621714">&#34;querying&nbsp;id&nbsp;20:&nbsp;%v&#34;</span><span class="op" id="7621734">,</span>&nbsp;<span class="ident" id="7621736">err</span><span class="op" id="7621739">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7621742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7621745">if</span>&nbsp;<span class="ident" id="7621748">name</span>&nbsp;<span class="op" id="7621753">!=</span>&nbsp;<span class="ident" id="7621756">nil</span>&nbsp;<span class="op" id="7621760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621764">t</span><span class="op" id="7621765">.</span><span class="ident" id="7621766">Errorf</span><span class="op" id="7621772">(</span><span class="string" id="7621773">&#34;id&nbsp;20&nbsp;=&nbsp;%q;&nbsp;want&nbsp;nil&#34;</span><span class="op" id="7621795">,</span>&nbsp;<span class="op" id="7621797">*</span><span class="ident" id="7621798">name</span><span class="op" id="7621802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7621805">}</span><br>
<span class="lineno"></span><span class="op" id="7621807">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="7621810">func</span>&nbsp;<span class="ident" id="7621815">TestQueryRowClosingStmt</span><span class="op" id="7621838">(</span><span class="ident" id="7621839">t</span>&nbsp;<span class="op" id="7621841">*</span><span class="ident" id="7621842">testing</span><span class="op" id="7621849">.</span><span class="ident" id="7621850">T</span><span class="op" id="7621851">)</span>&nbsp;<span class="op" id="7621853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621856">db</span>&nbsp;<span class="op" id="7621859">:=</span>&nbsp;<span class="ident" id="7621862">newTestDB</span><span class="op" id="7621871">(</span><span class="ident" id="7621872">t</span><span class="op" id="7621873">,</span>&nbsp;<span class="string" id="7621875">&#34;people&#34;</span><span class="op" id="7621883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7621886">defer</span>&nbsp;<span class="ident" id="7621892">closeDB</span><span class="op" id="7621899">(</span><span class="ident" id="7621900">t</span><span class="op" id="7621901">,</span>&nbsp;<span class="ident" id="7621903">db</span><span class="op" id="7621905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7621908">var</span>&nbsp;<span class="ident" id="7621912">name</span>&nbsp;<span class="builtintype" id="7621917">string</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7621925">var</span>&nbsp;<span class="ident" id="7621929">age</span>&nbsp;<span class="builtintype" id="7621933">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7621938">err</span>&nbsp;<span class="op" id="7621942">:=</span>&nbsp;<span class="ident" id="7621945">db</span><span class="op" id="7621947">.</span><span class="ident" id="7621948">QueryRow</span><span class="op" id="7621956">(</span><span class="string" id="7621957">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="7621987">,</span>&nbsp;<span class="num" id="7621989">3</span><span class="op" id="7621990">)</span><span class="op" id="7621991">.</span><span class="ident" id="7621992">Scan</span><span class="op" id="7621996">(</span><span class="op" id="7621997">&amp;</span><span class="ident" id="7621998">age</span><span class="op" id="7622001">,</span>&nbsp;<span class="op" id="7622003">&amp;</span><span class="ident" id="7622004">name</span><span class="op" id="7622008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7622011">if</span>&nbsp;<span class="ident" id="7622014">err</span>&nbsp;<span class="op" id="7622018">!=</span>&nbsp;<span class="ident" id="7622021">nil</span>&nbsp;<span class="op" id="7622025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622029">t</span><span class="op" id="7622030">.</span><span class="ident" id="7622031">Fatal</span><span class="op" id="7622036">(</span><span class="ident" id="7622037">err</span><span class="op" id="7622040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7622043">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7622046">if</span>&nbsp;<span class="builtinfunc" id="7622049">len</span><span class="op" id="7622052">(</span><span class="ident" id="7622053">db</span><span class="op" id="7622055">.</span><span class="ident" id="7622056">freeConn</span><span class="op" id="7622064">)</span>&nbsp;<span class="op" id="7622066">!=</span>&nbsp;<span class="num" id="7622069">1</span>&nbsp;<span class="op" id="7622071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622075">t</span><span class="op" id="7622076">.</span><span class="ident" id="7622077">Fatalf</span><span class="op" id="7622083">(</span><span class="string" id="7622084">&#34;expected&nbsp;1&nbsp;free&nbsp;conn&#34;</span><span class="op" id="7622106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7622109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622112">fakeConn</span>&nbsp;<span class="op" id="7622121">:=</span>&nbsp;<span class="ident" id="7622124">db</span><span class="op" id="7622126">.</span><span class="ident" id="7622127">freeConn</span><span class="op" id="7622135">[</span><span class="num" id="7622136">0</span><span class="op" id="7622137">]</span><span class="op" id="7622138">.</span><span class="ident" id="7622139">ci</span><span class="op" id="7622141">.</span><span class="op" id="7622142">(</span><span class="op" id="7622143">*</span><span class="ident" id="7622144">fakeConn</span><span class="op" id="7622152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7622155">if</span>&nbsp;<span class="ident" id="7622158">made</span><span class="op" id="7622162">,</span>&nbsp;<span class="ident" id="7622164">closed</span>&nbsp;<span class="op" id="7622171">:=</span>&nbsp;<span class="ident" id="7622174">fakeConn</span><span class="op" id="7622182">.</span><span class="ident" id="7622183">stmtsMade</span><span class="op" id="7622192">,</span>&nbsp;<span class="ident" id="7622194">fakeConn</span><span class="op" id="7622202">.</span><span class="ident" id="7622203">stmtsClosed</span><span class="op" id="7622214">;</span>&nbsp;<span class="ident" id="7622216">made</span>&nbsp;<span class="op" id="7622221">!=</span>&nbsp;<span class="ident" id="7622224">closed</span>&nbsp;<span class="op" id="7622231">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622235">t</span><span class="op" id="7622236">.</span><span class="ident" id="7622237">Errorf</span><span class="op" id="7622243">(</span><span class="string" id="7622244">&#34;statement&nbsp;close&nbsp;mismatch:&nbsp;made&nbsp;%d,&nbsp;closed&nbsp;%d&#34;</span><span class="op" id="7622290">,</span>&nbsp;<span class="ident" id="7622292">made</span><span class="op" id="7622296">,</span>&nbsp;<span class="ident" id="7622298">closed</span><span class="op" id="7622304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7622307">}</span><br>
<span class="lineno"></span><span class="op" id="7622309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7622312">//&nbsp;Test&nbsp;issue&nbsp;6651</span><br>
<span class="lineno">700</span><span class="keyword" id="7622331">func</span>&nbsp;<span class="ident" id="7622336">TestIssue6651</span><span class="op" id="7622349">(</span><span class="ident" id="7622350">t</span>&nbsp;<span class="op" id="7622352">*</span><span class="ident" id="7622353">testing</span><span class="op" id="7622360">.</span><span class="ident" id="7622361">T</span><span class="op" id="7622362">)</span>&nbsp;<span class="op" id="7622364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622367">db</span>&nbsp;<span class="op" id="7622370">:=</span>&nbsp;<span class="ident" id="7622373">newTestDB</span><span class="op" id="7622382">(</span><span class="ident" id="7622383">t</span><span class="op" id="7622384">,</span>&nbsp;<span class="string" id="7622386">&#34;people&#34;</span><span class="op" id="7622394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7622397">defer</span>&nbsp;<span class="ident" id="7622403">closeDB</span><span class="op" id="7622410">(</span><span class="ident" id="7622411">t</span><span class="op" id="7622412">,</span>&nbsp;<span class="ident" id="7622414">db</span><span class="op" id="7622416">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7622420">var</span>&nbsp;<span class="ident" id="7622424">v</span>&nbsp;<span class="builtintype" id="7622426">string</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622435">want</span>&nbsp;<span class="op" id="7622440">:=</span>&nbsp;<span class="string" id="7622443">&#34;error&nbsp;in&nbsp;rows.Next&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622465">rowsCursorNextHook</span>&nbsp;<span class="op" id="7622484">=</span>&nbsp;<span class="keyword" id="7622486">func</span><span class="op" id="7622490">(</span><span class="ident" id="7622491">dest</span>&nbsp;<span class="op" id="7622496">[</span><span class="op" id="7622497">]</span><span class="ident" id="7622498">driver</span><span class="op" id="7622504">.</span><span class="ident" id="7622505">Value</span><span class="op" id="7622510">)</span>&nbsp;<span class="builtintype" id="7622512">error</span>&nbsp;<span class="op" id="7622518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7622522">return</span>&nbsp;<span class="ident" id="7622529">fmt</span><span class="op" id="7622532">.</span><span class="ident" id="7622533">Errorf</span><span class="op" id="7622539">(</span><span class="ident" id="7622540">want</span><span class="op" id="7622544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7622547">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7622550">defer</span>&nbsp;<span class="keyword" id="7622556">func</span><span class="op" id="7622560">(</span><span class="op" id="7622561">)</span>&nbsp;<span class="op" id="7622563">{</span>&nbsp;<span class="ident" id="7622565">rowsCursorNextHook</span>&nbsp;<span class="op" id="7622584">=</span>&nbsp;<span class="ident" id="7622586">nil</span>&nbsp;<span class="op" id="7622590">}</span><span class="op" id="7622591">(</span><span class="op" id="7622592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622595">err</span>&nbsp;<span class="op" id="7622599">:=</span>&nbsp;<span class="ident" id="7622602">db</span><span class="op" id="7622604">.</span><span class="ident" id="7622605">QueryRow</span><span class="op" id="7622613">(</span><span class="string" id="7622614">&#34;SELECT|people|name|&#34;</span><span class="op" id="7622635">)</span><span class="op" id="7622636">.</span><span class="ident" id="7622637">Scan</span><span class="op" id="7622641">(</span><span class="op" id="7622642">&amp;</span><span class="ident" id="7622643">v</span><span class="op" id="7622644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7622647">if</span>&nbsp;<span class="ident" id="7622650">err</span>&nbsp;<span class="op" id="7622654">==</span>&nbsp;<span class="ident" id="7622657">nil</span>&nbsp;<span class="op" id="7622661">||</span>&nbsp;<span class="ident" id="7622664">err</span><span class="op" id="7622667">.</span><span class="ident" id="7622668">Error</span><span class="op" id="7622673">(</span><span class="op" id="7622674">)</span>&nbsp;<span class="op" id="7622676">!=</span>&nbsp;<span class="ident" id="7622679">want</span>&nbsp;<span class="op" id="7622684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622688">t</span><span class="op" id="7622689">.</span><span class="ident" id="7622690">Errorf</span><span class="op" id="7622696">(</span><span class="string" id="7622697">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7622718">,</span>&nbsp;<span class="ident" id="7622720">err</span><span class="op" id="7622723">,</span>&nbsp;<span class="ident" id="7622725">want</span><span class="op" id="7622729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7622732">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622735">rowsCursorNextHook</span>&nbsp;<span class="op" id="7622754">=</span>&nbsp;<span class="ident" id="7622756">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622762">want</span>&nbsp;<span class="op" id="7622767">=</span>&nbsp;<span class="string" id="7622769">&#34;error&nbsp;in&nbsp;rows.Close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622792">rowsCloseHook</span>&nbsp;<span class="op" id="7622806">=</span>&nbsp;<span class="keyword" id="7622808">func</span><span class="op" id="7622812">(</span><span class="ident" id="7622813">rows</span>&nbsp;<span class="op" id="7622818">*</span><span class="ident" id="7622819">Rows</span><span class="op" id="7622823">,</span>&nbsp;<span class="ident" id="7622825">err</span>&nbsp;<span class="op" id="7622829">*</span><span class="builtintype" id="7622830">error</span><span class="op" id="7622835">)</span>&nbsp;<span class="op" id="7622837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7622841">*</span><span class="ident" id="7622842">err</span>&nbsp;<span class="op" id="7622846">=</span>&nbsp;<span class="ident" id="7622848">fmt</span><span class="op" id="7622851">.</span><span class="ident" id="7622852">Errorf</span><span class="op" id="7622858">(</span><span class="ident" id="7622859">want</span><span class="op" id="7622863">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7622866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7622869">defer</span>&nbsp;<span class="keyword" id="7622875">func</span><span class="op" id="7622879">(</span><span class="op" id="7622880">)</span>&nbsp;<span class="op" id="7622882">{</span>&nbsp;<span class="ident" id="7622884">rowsCloseHook</span>&nbsp;<span class="op" id="7622898">=</span>&nbsp;<span class="ident" id="7622900">nil</span>&nbsp;<span class="op" id="7622904">}</span><span class="op" id="7622905">(</span><span class="op" id="7622906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7622909">err</span>&nbsp;<span class="op" id="7622913">=</span>&nbsp;<span class="ident" id="7622915">db</span><span class="op" id="7622917">.</span><span class="ident" id="7622918">QueryRow</span><span class="op" id="7622926">(</span><span class="string" id="7622927">&#34;SELECT|people|name|&#34;</span><span class="op" id="7622948">)</span><span class="op" id="7622949">.</span><span class="ident" id="7622950">Scan</span><span class="op" id="7622954">(</span><span class="op" id="7622955">&amp;</span><span class="ident" id="7622956">v</span><span class="op" id="7622957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7622960">if</span>&nbsp;<span class="ident" id="7622963">err</span>&nbsp;<span class="op" id="7622967">==</span>&nbsp;<span class="ident" id="7622970">nil</span>&nbsp;<span class="op" id="7622974">||</span>&nbsp;<span class="ident" id="7622977">err</span><span class="op" id="7622980">.</span><span class="ident" id="7622981">Error</span><span class="op" id="7622986">(</span><span class="op" id="7622987">)</span>&nbsp;<span class="op" id="7622989">!=</span>&nbsp;<span class="ident" id="7622992">want</span>&nbsp;<span class="op" id="7622997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623001">t</span><span class="op" id="7623002">.</span><span class="ident" id="7623003">Errorf</span><span class="op" id="7623009">(</span><span class="string" id="7623010">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7623031">,</span>&nbsp;<span class="ident" id="7623033">err</span><span class="op" id="7623036">,</span>&nbsp;<span class="ident" id="7623038">want</span><span class="op" id="7623042">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7623045">}</span><br>
<span class="lineno"></span><span class="op" id="7623047">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7623050">type</span>&nbsp;<span class="ident" id="7623055">nullTestRow</span>&nbsp;<span class="keyword" id="7623067">struct</span>&nbsp;<span class="op" id="7623074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623077">nullParam</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7623090">interface</span><span class="op" id="7623099">{</span><span class="op" id="7623100">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623103">notNullParam</span>&nbsp;<span class="keyword" id="7623116">interface</span><span class="op" id="7623125">{</span><span class="op" id="7623126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623129">scanNullVal</span>&nbsp;&nbsp;<span class="keyword" id="7623142">interface</span><span class="op" id="7623151">{</span><span class="op" id="7623152">}</span><br>
<span class="lineno"></span><span class="op" id="7623154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7623157">type</span>&nbsp;<span class="ident" id="7623162">nullTestSpec</span>&nbsp;<span class="keyword" id="7623175">struct</span>&nbsp;<span class="op" id="7623182">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623185">nullType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7623197">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623205">notNullType</span>&nbsp;<span class="builtintype" id="7623217">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623225">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7623237">[</span><span class="num" id="7623238">6</span><span class="op" id="7623239">]</span><span class="ident" id="7623240">nullTestRow</span><br>
<span class="lineno"></span><span class="op" id="7623252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">740</span><span class="keyword" id="7623255">func</span>&nbsp;<span class="ident" id="7623260">TestNullStringParam</span><span class="op" id="7623279">(</span><span class="ident" id="7623280">t</span>&nbsp;<span class="op" id="7623282">*</span><span class="ident" id="7623283">testing</span><span class="op" id="7623290">.</span><span class="ident" id="7623291">T</span><span class="op" id="7623292">)</span>&nbsp;<span class="op" id="7623294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623297">spec</span>&nbsp;<span class="op" id="7623302">:=</span>&nbsp;<span class="ident" id="7623305">nullTestSpec</span><span class="op" id="7623317">{</span><span class="string" id="7623318">&#34;nullstring&#34;</span><span class="op" id="7623330">,</span>&nbsp;<span class="string" id="7623332">&#34;string&#34;</span><span class="op" id="7623340">,</span>&nbsp;<span class="op" id="7623342">[</span><span class="num" id="7623343">6</span><span class="op" id="7623344">]</span><span class="ident" id="7623345">nullTestRow</span><span class="op" id="7623356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7623360">{</span><span class="ident" id="7623361">NullString</span><span class="op" id="7623371">{</span><span class="string" id="7623372">&#34;aqua&#34;</span><span class="op" id="7623378">,</span>&nbsp;<span class="builtintype" id="7623380">true</span><span class="op" id="7623384">}</span><span class="op" id="7623385">,</span>&nbsp;<span class="string" id="7623387">&#34;&#34;</span><span class="op" id="7623389">,</span>&nbsp;<span class="ident" id="7623391">NullString</span><span class="op" id="7623401">{</span><span class="string" id="7623402">&#34;aqua&#34;</span><span class="op" id="7623408">,</span>&nbsp;<span class="builtintype" id="7623410">true</span><span class="op" id="7623414">}</span><span class="op" id="7623415">}</span><span class="op" id="7623416">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7623420">{</span><span class="ident" id="7623421">NullString</span><span class="op" id="7623431">{</span><span class="string" id="7623432">&#34;brown&#34;</span><span class="op" id="7623439">,</span>&nbsp;<span class="builtintype" id="7623441">false</span><span class="op" id="7623446">}</span><span class="op" id="7623447">,</span>&nbsp;<span class="string" id="7623449">&#34;&#34;</span><span class="op" id="7623451">,</span>&nbsp;<span class="ident" id="7623453">NullString</span><span class="op" id="7623463">{</span><span class="string" id="7623464">&#34;&#34;</span><span class="op" id="7623466">,</span>&nbsp;<span class="builtintype" id="7623468">false</span><span class="op" id="7623473">}</span><span class="op" id="7623474">}</span><span class="op" id="7623475">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7623479">{</span><span class="string" id="7623480">&#34;chartreuse&#34;</span><span class="op" id="7623492">,</span>&nbsp;<span class="string" id="7623494">&#34;&#34;</span><span class="op" id="7623496">,</span>&nbsp;<span class="ident" id="7623498">NullString</span><span class="op" id="7623508">{</span><span class="string" id="7623509">&#34;chartreuse&#34;</span><span class="op" id="7623521">,</span>&nbsp;<span class="builtintype" id="7623523">true</span><span class="op" id="7623527">}</span><span class="op" id="7623528">}</span><span class="op" id="7623529">,</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7623533">{</span><span class="ident" id="7623534">NullString</span><span class="op" id="7623544">{</span><span class="string" id="7623545">&#34;darkred&#34;</span><span class="op" id="7623554">,</span>&nbsp;<span class="builtintype" id="7623556">true</span><span class="op" id="7623560">}</span><span class="op" id="7623561">,</span>&nbsp;<span class="string" id="7623563">&#34;&#34;</span><span class="op" id="7623565">,</span>&nbsp;<span class="ident" id="7623567">NullString</span><span class="op" id="7623577">{</span><span class="string" id="7623578">&#34;darkred&#34;</span><span class="op" id="7623587">,</span>&nbsp;<span class="builtintype" id="7623589">true</span><span class="op" id="7623593">}</span><span class="op" id="7623594">}</span><span class="op" id="7623595">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7623599">{</span><span class="ident" id="7623600">NullString</span><span class="op" id="7623610">{</span><span class="string" id="7623611">&#34;eel&#34;</span><span class="op" id="7623616">,</span>&nbsp;<span class="builtintype" id="7623618">false</span><span class="op" id="7623623">}</span><span class="op" id="7623624">,</span>&nbsp;<span class="string" id="7623626">&#34;&#34;</span><span class="op" id="7623628">,</span>&nbsp;<span class="ident" id="7623630">NullString</span><span class="op" id="7623640">{</span><span class="string" id="7623641">&#34;&#34;</span><span class="op" id="7623643">,</span>&nbsp;<span class="builtintype" id="7623645">false</span><span class="op" id="7623650">}</span><span class="op" id="7623651">}</span><span class="op" id="7623652">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7623656">{</span><span class="string" id="7623657">&#34;foo&#34;</span><span class="op" id="7623662">,</span>&nbsp;<span class="ident" id="7623664">NullString</span><span class="op" id="7623674">{</span><span class="string" id="7623675">&#34;black&#34;</span><span class="op" id="7623682">,</span>&nbsp;<span class="builtintype" id="7623684">false</span><span class="op" id="7623689">}</span><span class="op" id="7623690">,</span>&nbsp;<span class="ident" id="7623692">nil</span><span class="op" id="7623695">}</span><span class="op" id="7623696">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7623699">}</span><span class="op" id="7623700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623703">nullTestRun</span><span class="op" id="7623714">(</span><span class="ident" id="7623715">t</span><span class="op" id="7623716">,</span>&nbsp;<span class="ident" id="7623718">spec</span><span class="op" id="7623722">)</span><br>
<span class="lineno">750</span><span class="op" id="7623724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7623727">func</span>&nbsp;<span class="ident" id="7623732">TestNullInt64Param</span><span class="op" id="7623750">(</span><span class="ident" id="7623751">t</span>&nbsp;<span class="op" id="7623753">*</span><span class="ident" id="7623754">testing</span><span class="op" id="7623761">.</span><span class="ident" id="7623762">T</span><span class="op" id="7623763">)</span>&nbsp;<span class="op" id="7623765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7623768">spec</span>&nbsp;<span class="op" id="7623773">:=</span>&nbsp;<span class="ident" id="7623776">nullTestSpec</span><span class="op" id="7623788">{</span><span class="string" id="7623789">&#34;nullint64&#34;</span><span class="op" id="7623800">,</span>&nbsp;<span class="string" id="7623802">&#34;int64&#34;</span><span class="op" id="7623809">,</span>&nbsp;<span class="op" id="7623811">[</span><span class="num" id="7623812">6</span><span class="op" id="7623813">]</span><span class="ident" id="7623814">nullTestRow</span><span class="op" id="7623825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7623829">{</span><span class="ident" id="7623830">NullInt64</span><span class="op" id="7623839">{</span><span class="num" id="7623840">31</span><span class="op" id="7623842">,</span>&nbsp;<span class="builtintype" id="7623844">true</span><span class="op" id="7623848">}</span><span class="op" id="7623849">,</span>&nbsp;<span class="num" id="7623851">1</span><span class="op" id="7623852">,</span>&nbsp;<span class="ident" id="7623854">NullInt64</span><span class="op" id="7623863">{</span><span class="num" id="7623864">31</span><span class="op" id="7623866">,</span>&nbsp;<span class="builtintype" id="7623868">true</span><span class="op" id="7623872">}</span><span class="op" id="7623873">}</span><span class="op" id="7623874">,</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7623878">{</span><span class="ident" id="7623879">NullInt64</span><span class="op" id="7623888">{</span><span class="op" id="7623889">-</span><span class="num" id="7623890">22</span><span class="op" id="7623892">,</span>&nbsp;<span class="builtintype" id="7623894">false</span><span class="op" id="7623899">}</span><span class="op" id="7623900">,</span>&nbsp;<span class="num" id="7623902">1</span><span class="op" id="7623903">,</span>&nbsp;<span class="ident" id="7623905">NullInt64</span><span class="op" id="7623914">{</span><span class="num" id="7623915">0</span><span class="op" id="7623916">,</span>&nbsp;<span class="builtintype" id="7623918">false</span><span class="op" id="7623923">}</span><span class="op" id="7623924">}</span><span class="op" id="7623925">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7623929">{</span><span class="num" id="7623930">22</span><span class="op" id="7623932">,</span>&nbsp;<span class="num" id="7623934">1</span><span class="op" id="7623935">,</span>&nbsp;<span class="ident" id="7623937">NullInt64</span><span class="op" id="7623946">{</span><span class="num" id="7623947">22</span><span class="op" id="7623949">,</span>&nbsp;<span class="builtintype" id="7623951">true</span><span class="op" id="7623955">}</span><span class="op" id="7623956">}</span><span class="op" id="7623957">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7623961">{</span><span class="ident" id="7623962">NullInt64</span><span class="op" id="7623971">{</span><span class="num" id="7623972">33</span><span class="op" id="7623974">,</span>&nbsp;<span class="builtintype" id="7623976">true</span><span class="op" id="7623980">}</span><span class="op" id="7623981">,</span>&nbsp;<span class="num" id="7623983">1</span><span class="op" id="7623984">,</span>&nbsp;<span class="ident" id="7623986">NullInt64</span><span class="op" id="7623995">{</span><span class="num" id="7623996">33</span><span class="op" id="7623998">,</span>&nbsp;<span class="builtintype" id="7624000">true</span><span class="op" id="7624004">}</span><span class="op" id="7624005">}</span><span class="op" id="7624006">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624010">{</span><span class="ident" id="7624011">NullInt64</span><span class="op" id="7624020">{</span><span class="num" id="7624021">222</span><span class="op" id="7624024">,</span>&nbsp;<span class="builtintype" id="7624026">false</span><span class="op" id="7624031">}</span><span class="op" id="7624032">,</span>&nbsp;<span class="num" id="7624034">1</span><span class="op" id="7624035">,</span>&nbsp;<span class="ident" id="7624037">NullInt64</span><span class="op" id="7624046">{</span><span class="num" id="7624047">0</span><span class="op" id="7624048">,</span>&nbsp;<span class="builtintype" id="7624050">false</span><span class="op" id="7624055">}</span><span class="op" id="7624056">}</span><span class="op" id="7624057">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624061">{</span><span class="num" id="7624062">0</span><span class="op" id="7624063">,</span>&nbsp;<span class="ident" id="7624065">NullInt64</span><span class="op" id="7624074">{</span><span class="num" id="7624075">31</span><span class="op" id="7624077">,</span>&nbsp;<span class="builtintype" id="7624079">false</span><span class="op" id="7624084">}</span><span class="op" id="7624085">,</span>&nbsp;<span class="ident" id="7624087">nil</span><span class="op" id="7624090">}</span><span class="op" id="7624091">,</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624094">}</span><span class="op" id="7624095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624098">nullTestRun</span><span class="op" id="7624109">(</span><span class="ident" id="7624110">t</span><span class="op" id="7624111">,</span>&nbsp;<span class="ident" id="7624113">spec</span><span class="op" id="7624117">)</span><br>
<span class="lineno"></span><span class="op" id="7624119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7624122">func</span>&nbsp;<span class="ident" id="7624127">TestNullFloat64Param</span><span class="op" id="7624147">(</span><span class="ident" id="7624148">t</span>&nbsp;<span class="op" id="7624150">*</span><span class="ident" id="7624151">testing</span><span class="op" id="7624158">.</span><span class="ident" id="7624159">T</span><span class="op" id="7624160">)</span>&nbsp;<span class="op" id="7624162">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624165">spec</span>&nbsp;<span class="op" id="7624170">:=</span>&nbsp;<span class="ident" id="7624173">nullTestSpec</span><span class="op" id="7624185">{</span><span class="string" id="7624186">&#34;nullfloat64&#34;</span><span class="op" id="7624199">,</span>&nbsp;<span class="string" id="7624201">&#34;float64&#34;</span><span class="op" id="7624210">,</span>&nbsp;<span class="op" id="7624212">[</span><span class="num" id="7624213">6</span><span class="op" id="7624214">]</span><span class="ident" id="7624215">nullTestRow</span><span class="op" id="7624226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624230">{</span><span class="ident" id="7624231">NullFloat64</span><span class="op" id="7624242">{</span><span class="num" id="7624243">31.2</span><span class="op" id="7624247">,</span>&nbsp;<span class="builtintype" id="7624249">true</span><span class="op" id="7624253">}</span><span class="op" id="7624254">,</span>&nbsp;<span class="num" id="7624256">1</span><span class="op" id="7624257">,</span>&nbsp;<span class="ident" id="7624259">NullFloat64</span><span class="op" id="7624270">{</span><span class="num" id="7624271">31.2</span><span class="op" id="7624275">,</span>&nbsp;<span class="builtintype" id="7624277">true</span><span class="op" id="7624281">}</span><span class="op" id="7624282">}</span><span class="op" id="7624283">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624287">{</span><span class="ident" id="7624288">NullFloat64</span><span class="op" id="7624299">{</span><span class="num" id="7624300">13.1</span><span class="op" id="7624304">,</span>&nbsp;<span class="builtintype" id="7624306">false</span><span class="op" id="7624311">}</span><span class="op" id="7624312">,</span>&nbsp;<span class="num" id="7624314">1</span><span class="op" id="7624315">,</span>&nbsp;<span class="ident" id="7624317">NullFloat64</span><span class="op" id="7624328">{</span><span class="num" id="7624329">0</span><span class="op" id="7624330">,</span>&nbsp;<span class="builtintype" id="7624332">false</span><span class="op" id="7624337">}</span><span class="op" id="7624338">}</span><span class="op" id="7624339">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624343">{</span><span class="op" id="7624344">-</span><span class="num" id="7624345">22.9</span><span class="op" id="7624349">,</span>&nbsp;<span class="num" id="7624351">1</span><span class="op" id="7624352">,</span>&nbsp;<span class="ident" id="7624354">NullFloat64</span><span class="op" id="7624365">{</span><span class="op" id="7624366">-</span><span class="num" id="7624367">22.9</span><span class="op" id="7624371">,</span>&nbsp;<span class="builtintype" id="7624373">true</span><span class="op" id="7624377">}</span><span class="op" id="7624378">}</span><span class="op" id="7624379">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624383">{</span><span class="ident" id="7624384">NullFloat64</span><span class="op" id="7624395">{</span><span class="num" id="7624396">33.81</span><span class="op" id="7624401">,</span>&nbsp;<span class="builtintype" id="7624403">true</span><span class="op" id="7624407">}</span><span class="op" id="7624408">,</span>&nbsp;<span class="num" id="7624410">1</span><span class="op" id="7624411">,</span>&nbsp;<span class="ident" id="7624413">NullFloat64</span><span class="op" id="7624424">{</span><span class="num" id="7624425">33.81</span><span class="op" id="7624430">,</span>&nbsp;<span class="builtintype" id="7624432">true</span><span class="op" id="7624436">}</span><span class="op" id="7624437">}</span><span class="op" id="7624438">,</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624442">{</span><span class="ident" id="7624443">NullFloat64</span><span class="op" id="7624454">{</span><span class="num" id="7624455">222</span><span class="op" id="7624458">,</span>&nbsp;<span class="builtintype" id="7624460">false</span><span class="op" id="7624465">}</span><span class="op" id="7624466">,</span>&nbsp;<span class="num" id="7624468">1</span><span class="op" id="7624469">,</span>&nbsp;<span class="ident" id="7624471">NullFloat64</span><span class="op" id="7624482">{</span><span class="num" id="7624483">0</span><span class="op" id="7624484">,</span>&nbsp;<span class="builtintype" id="7624486">false</span><span class="op" id="7624491">}</span><span class="op" id="7624492">}</span><span class="op" id="7624493">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624497">{</span><span class="num" id="7624498">10</span><span class="op" id="7624500">,</span>&nbsp;<span class="ident" id="7624502">NullFloat64</span><span class="op" id="7624513">{</span><span class="num" id="7624514">31.2</span><span class="op" id="7624518">,</span>&nbsp;<span class="builtintype" id="7624520">false</span><span class="op" id="7624525">}</span><span class="op" id="7624526">,</span>&nbsp;<span class="ident" id="7624528">nil</span><span class="op" id="7624531">}</span><span class="op" id="7624532">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624535">}</span><span class="op" id="7624536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624539">nullTestRun</span><span class="op" id="7624550">(</span><span class="ident" id="7624551">t</span><span class="op" id="7624552">,</span>&nbsp;<span class="ident" id="7624554">spec</span><span class="op" id="7624558">)</span><br>
<span class="lineno"></span><span class="op" id="7624560">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="keyword" id="7624563">func</span>&nbsp;<span class="ident" id="7624568">TestNullBoolParam</span><span class="op" id="7624585">(</span><span class="ident" id="7624586">t</span>&nbsp;<span class="op" id="7624588">*</span><span class="ident" id="7624589">testing</span><span class="op" id="7624596">.</span><span class="ident" id="7624597">T</span><span class="op" id="7624598">)</span>&nbsp;<span class="op" id="7624600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624603">spec</span>&nbsp;<span class="op" id="7624608">:=</span>&nbsp;<span class="ident" id="7624611">nullTestSpec</span><span class="op" id="7624623">{</span><span class="string" id="7624624">&#34;nullbool&#34;</span><span class="op" id="7624634">,</span>&nbsp;<span class="string" id="7624636">&#34;bool&#34;</span><span class="op" id="7624642">,</span>&nbsp;<span class="op" id="7624644">[</span><span class="num" id="7624645">6</span><span class="op" id="7624646">]</span><span class="ident" id="7624647">nullTestRow</span><span class="op" id="7624658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624662">{</span><span class="ident" id="7624663">NullBool</span><span class="op" id="7624671">{</span><span class="builtintype" id="7624672">false</span><span class="op" id="7624677">,</span>&nbsp;<span class="builtintype" id="7624679">true</span><span class="op" id="7624683">}</span><span class="op" id="7624684">,</span>&nbsp;<span class="builtintype" id="7624686">true</span><span class="op" id="7624690">,</span>&nbsp;<span class="ident" id="7624692">NullBool</span><span class="op" id="7624700">{</span><span class="builtintype" id="7624701">false</span><span class="op" id="7624706">,</span>&nbsp;<span class="builtintype" id="7624708">true</span><span class="op" id="7624712">}</span><span class="op" id="7624713">}</span><span class="op" id="7624714">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624718">{</span><span class="ident" id="7624719">NullBool</span><span class="op" id="7624727">{</span><span class="builtintype" id="7624728">true</span><span class="op" id="7624732">,</span>&nbsp;<span class="builtintype" id="7624734">false</span><span class="op" id="7624739">}</span><span class="op" id="7624740">,</span>&nbsp;<span class="builtintype" id="7624742">false</span><span class="op" id="7624747">,</span>&nbsp;<span class="ident" id="7624749">NullBool</span><span class="op" id="7624757">{</span><span class="builtintype" id="7624758">false</span><span class="op" id="7624763">,</span>&nbsp;<span class="builtintype" id="7624765">false</span><span class="op" id="7624770">}</span><span class="op" id="7624771">}</span><span class="op" id="7624772">,</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624776">{</span><span class="builtintype" id="7624777">true</span><span class="op" id="7624781">,</span>&nbsp;<span class="builtintype" id="7624783">true</span><span class="op" id="7624787">,</span>&nbsp;<span class="ident" id="7624789">NullBool</span><span class="op" id="7624797">{</span><span class="builtintype" id="7624798">true</span><span class="op" id="7624802">,</span>&nbsp;<span class="builtintype" id="7624804">true</span><span class="op" id="7624808">}</span><span class="op" id="7624809">}</span><span class="op" id="7624810">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624814">{</span><span class="ident" id="7624815">NullBool</span><span class="op" id="7624823">{</span><span class="builtintype" id="7624824">true</span><span class="op" id="7624828">,</span>&nbsp;<span class="builtintype" id="7624830">true</span><span class="op" id="7624834">}</span><span class="op" id="7624835">,</span>&nbsp;<span class="builtintype" id="7624837">false</span><span class="op" id="7624842">,</span>&nbsp;<span class="ident" id="7624844">NullBool</span><span class="op" id="7624852">{</span><span class="builtintype" id="7624853">true</span><span class="op" id="7624857">,</span>&nbsp;<span class="builtintype" id="7624859">true</span><span class="op" id="7624863">}</span><span class="op" id="7624864">}</span><span class="op" id="7624865">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624869">{</span><span class="ident" id="7624870">NullBool</span><span class="op" id="7624878">{</span><span class="builtintype" id="7624879">true</span><span class="op" id="7624883">,</span>&nbsp;<span class="builtintype" id="7624885">false</span><span class="op" id="7624890">}</span><span class="op" id="7624891">,</span>&nbsp;<span class="builtintype" id="7624893">true</span><span class="op" id="7624897">,</span>&nbsp;<span class="ident" id="7624899">NullBool</span><span class="op" id="7624907">{</span><span class="builtintype" id="7624908">false</span><span class="op" id="7624913">,</span>&nbsp;<span class="builtintype" id="7624915">false</span><span class="op" id="7624920">}</span><span class="op" id="7624921">}</span><span class="op" id="7624922">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624926">{</span><span class="builtintype" id="7624927">true</span><span class="op" id="7624931">,</span>&nbsp;<span class="ident" id="7624933">NullBool</span><span class="op" id="7624941">{</span><span class="builtintype" id="7624942">true</span><span class="op" id="7624946">,</span>&nbsp;<span class="builtintype" id="7624948">false</span><span class="op" id="7624953">}</span><span class="op" id="7624954">,</span>&nbsp;<span class="ident" id="7624956">nil</span><span class="op" id="7624959">}</span><span class="op" id="7624960">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7624963">}</span><span class="op" id="7624964">}</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7624967">nullTestRun</span><span class="op" id="7624978">(</span><span class="ident" id="7624979">t</span><span class="op" id="7624980">,</span>&nbsp;<span class="ident" id="7624982">spec</span><span class="op" id="7624986">)</span><br>
<span class="lineno"></span><span class="op" id="7624988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7624991">func</span>&nbsp;<span class="ident" id="7624996">nullTestRun</span><span class="op" id="7625007">(</span><span class="ident" id="7625008">t</span>&nbsp;<span class="op" id="7625010">*</span><span class="ident" id="7625011">testing</span><span class="op" id="7625018">.</span><span class="ident" id="7625019">T</span><span class="op" id="7625020">,</span>&nbsp;<span class="ident" id="7625022">spec</span>&nbsp;<span class="ident" id="7625027">nullTestSpec</span><span class="op" id="7625039">)</span>&nbsp;<span class="op" id="7625041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625044">db</span>&nbsp;<span class="op" id="7625047">:=</span>&nbsp;<span class="ident" id="7625050">newTestDB</span><span class="op" id="7625059">(</span><span class="ident" id="7625060">t</span><span class="op" id="7625061">,</span>&nbsp;<span class="string" id="7625063">&#34;&#34;</span><span class="op" id="7625065">)</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625068">defer</span>&nbsp;<span class="ident" id="7625074">closeDB</span><span class="op" id="7625081">(</span><span class="ident" id="7625082">t</span><span class="op" id="7625083">,</span>&nbsp;<span class="ident" id="7625085">db</span><span class="op" id="7625087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625090">exec</span><span class="op" id="7625094">(</span><span class="ident" id="7625095">t</span><span class="op" id="7625096">,</span>&nbsp;<span class="ident" id="7625098">db</span><span class="op" id="7625100">,</span>&nbsp;<span class="ident" id="7625102">fmt</span><span class="op" id="7625105">.</span><span class="ident" id="7625106">Sprintf</span><span class="op" id="7625113">(</span><span class="string" id="7625114">&#34;CREATE|t|id=int32,name=string,nullf=%s,notnullf=%s&#34;</span><span class="op" id="7625166">,</span>&nbsp;<span class="ident" id="7625168">spec</span><span class="op" id="7625172">.</span><span class="ident" id="7625173">nullType</span><span class="op" id="7625181">,</span>&nbsp;<span class="ident" id="7625183">spec</span><span class="op" id="7625187">.</span><span class="ident" id="7625188">notNullType</span><span class="op" id="7625199">)</span><span class="op" id="7625200">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7625204">//&nbsp;Inserts&nbsp;with&nbsp;db.Exec:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625230">exec</span><span class="op" id="7625234">(</span><span class="ident" id="7625235">t</span><span class="op" id="7625236">,</span>&nbsp;<span class="ident" id="7625238">db</span><span class="op" id="7625240">,</span>&nbsp;<span class="string" id="7625242">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="7625283">,</span>&nbsp;<span class="num" id="7625285">1</span><span class="op" id="7625286">,</span>&nbsp;<span class="string" id="7625288">&#34;alice&#34;</span><span class="op" id="7625295">,</span>&nbsp;<span class="ident" id="7625297">spec</span><span class="op" id="7625301">.</span><span class="ident" id="7625302">rows</span><span class="op" id="7625306">[</span><span class="num" id="7625307">0</span><span class="op" id="7625308">]</span><span class="op" id="7625309">.</span><span class="ident" id="7625310">nullParam</span><span class="op" id="7625319">,</span>&nbsp;<span class="ident" id="7625321">spec</span><span class="op" id="7625325">.</span><span class="ident" id="7625326">rows</span><span class="op" id="7625330">[</span><span class="num" id="7625331">0</span><span class="op" id="7625332">]</span><span class="op" id="7625333">.</span><span class="ident" id="7625334">notNullParam</span><span class="op" id="7625346">)</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625349">exec</span><span class="op" id="7625353">(</span><span class="ident" id="7625354">t</span><span class="op" id="7625355">,</span>&nbsp;<span class="ident" id="7625357">db</span><span class="op" id="7625359">,</span>&nbsp;<span class="string" id="7625361">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="7625402">,</span>&nbsp;<span class="num" id="7625404">2</span><span class="op" id="7625405">,</span>&nbsp;<span class="string" id="7625407">&#34;bob&#34;</span><span class="op" id="7625412">,</span>&nbsp;<span class="ident" id="7625414">spec</span><span class="op" id="7625418">.</span><span class="ident" id="7625419">rows</span><span class="op" id="7625423">[</span><span class="num" id="7625424">1</span><span class="op" id="7625425">]</span><span class="op" id="7625426">.</span><span class="ident" id="7625427">nullParam</span><span class="op" id="7625436">,</span>&nbsp;<span class="ident" id="7625438">spec</span><span class="op" id="7625442">.</span><span class="ident" id="7625443">rows</span><span class="op" id="7625447">[</span><span class="num" id="7625448">1</span><span class="op" id="7625449">]</span><span class="op" id="7625450">.</span><span class="ident" id="7625451">notNullParam</span><span class="op" id="7625463">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7625467">//&nbsp;Inserts&nbsp;with&nbsp;a&nbsp;prepared&nbsp;statement:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625506">stmt</span><span class="op" id="7625510">,</span>&nbsp;<span class="ident" id="7625512">err</span>&nbsp;<span class="op" id="7625516">:=</span>&nbsp;<span class="ident" id="7625519">db</span><span class="op" id="7625521">.</span><span class="ident" id="7625522">Prepare</span><span class="op" id="7625529">(</span><span class="string" id="7625530">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="7625571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625574">if</span>&nbsp;<span class="ident" id="7625577">err</span>&nbsp;<span class="op" id="7625581">!=</span>&nbsp;<span class="ident" id="7625584">nil</span>&nbsp;<span class="op" id="7625588">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625592">t</span><span class="op" id="7625593">.</span><span class="ident" id="7625594">Fatalf</span><span class="op" id="7625600">(</span><span class="string" id="7625601">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="7625614">,</span>&nbsp;<span class="ident" id="7625616">err</span><span class="op" id="7625619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7625622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625625">defer</span>&nbsp;<span class="ident" id="7625631">stmt</span><span class="op" id="7625635">.</span><span class="ident" id="7625636">Close</span><span class="op" id="7625641">(</span><span class="op" id="7625642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625645">if</span>&nbsp;<span class="ident" id="7625648">_</span><span class="op" id="7625649">,</span>&nbsp;<span class="ident" id="7625651">err</span>&nbsp;<span class="op" id="7625655">:=</span>&nbsp;<span class="ident" id="7625658">stmt</span><span class="op" id="7625662">.</span><span class="ident" id="7625663">Exec</span><span class="op" id="7625667">(</span><span class="num" id="7625668">3</span><span class="op" id="7625669">,</span>&nbsp;<span class="string" id="7625671">&#34;chris&#34;</span><span class="op" id="7625678">,</span>&nbsp;<span class="ident" id="7625680">spec</span><span class="op" id="7625684">.</span><span class="ident" id="7625685">rows</span><span class="op" id="7625689">[</span><span class="num" id="7625690">2</span><span class="op" id="7625691">]</span><span class="op" id="7625692">.</span><span class="ident" id="7625693">nullParam</span><span class="op" id="7625702">,</span>&nbsp;<span class="ident" id="7625704">spec</span><span class="op" id="7625708">.</span><span class="ident" id="7625709">rows</span><span class="op" id="7625713">[</span><span class="num" id="7625714">2</span><span class="op" id="7625715">]</span><span class="op" id="7625716">.</span><span class="ident" id="7625717">notNullParam</span><span class="op" id="7625729">)</span><span class="op" id="7625730">;</span>&nbsp;<span class="ident" id="7625732">err</span>&nbsp;<span class="op" id="7625736">!=</span>&nbsp;<span class="ident" id="7625739">nil</span>&nbsp;<span class="op" id="7625743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625747">t</span><span class="op" id="7625748">.</span><span class="ident" id="7625749">Errorf</span><span class="op" id="7625755">(</span><span class="string" id="7625756">&#34;exec&nbsp;insert&nbsp;chris:&nbsp;%v&#34;</span><span class="op" id="7625779">,</span>&nbsp;<span class="ident" id="7625781">err</span><span class="op" id="7625784">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7625787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625790">if</span>&nbsp;<span class="ident" id="7625793">_</span><span class="op" id="7625794">,</span>&nbsp;<span class="ident" id="7625796">err</span>&nbsp;<span class="op" id="7625800">:=</span>&nbsp;<span class="ident" id="7625803">stmt</span><span class="op" id="7625807">.</span><span class="ident" id="7625808">Exec</span><span class="op" id="7625812">(</span><span class="num" id="7625813">4</span><span class="op" id="7625814">,</span>&nbsp;<span class="string" id="7625816">&#34;dave&#34;</span><span class="op" id="7625822">,</span>&nbsp;<span class="ident" id="7625824">spec</span><span class="op" id="7625828">.</span><span class="ident" id="7625829">rows</span><span class="op" id="7625833">[</span><span class="num" id="7625834">3</span><span class="op" id="7625835">]</span><span class="op" id="7625836">.</span><span class="ident" id="7625837">nullParam</span><span class="op" id="7625846">,</span>&nbsp;<span class="ident" id="7625848">spec</span><span class="op" id="7625852">.</span><span class="ident" id="7625853">rows</span><span class="op" id="7625857">[</span><span class="num" id="7625858">3</span><span class="op" id="7625859">]</span><span class="op" id="7625860">.</span><span class="ident" id="7625861">notNullParam</span><span class="op" id="7625873">)</span><span class="op" id="7625874">;</span>&nbsp;<span class="ident" id="7625876">err</span>&nbsp;<span class="op" id="7625880">!=</span>&nbsp;<span class="ident" id="7625883">nil</span>&nbsp;<span class="op" id="7625887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7625891">t</span><span class="op" id="7625892">.</span><span class="ident" id="7625893">Errorf</span><span class="op" id="7625899">(</span><span class="string" id="7625900">&#34;exec&nbsp;insert&nbsp;dave:&nbsp;%v&#34;</span><span class="op" id="7625922">,</span>&nbsp;<span class="ident" id="7625924">err</span><span class="op" id="7625927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7625930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7625933">if</span>&nbsp;<span class="ident" id="7625936">_</span><span class="op" id="7625937">,</span>&nbsp;<span class="ident" id="7625939">err</span>&nbsp;<span class="op" id="7625943">:=</span>&nbsp;<span class="ident" id="7625946">stmt</span><span class="op" id="7625950">.</span><span class="ident" id="7625951">Exec</span><span class="op" id="7625955">(</span><span class="num" id="7625956">5</span><span class="op" id="7625957">,</span>&nbsp;<span class="string" id="7625959">&#34;eleanor&#34;</span><span class="op" id="7625968">,</span>&nbsp;<span class="ident" id="7625970">spec</span><span class="op" id="7625974">.</span><span class="ident" id="7625975">rows</span><span class="op" id="7625979">[</span><span class="num" id="7625980">4</span><span class="op" id="7625981">]</span><span class="op" id="7625982">.</span><span class="ident" id="7625983">nullParam</span><span class="op" id="7625992">,</span>&nbsp;<span class="ident" id="7625994">spec</span><span class="op" id="7625998">.</span><span class="ident" id="7625999">rows</span><span class="op" id="7626003">[</span><span class="num" id="7626004">4</span><span class="op" id="7626005">]</span><span class="op" id="7626006">.</span><span class="ident" id="7626007">notNullParam</span><span class="op" id="7626019">)</span><span class="op" id="7626020">;</span>&nbsp;<span class="ident" id="7626022">err</span>&nbsp;<span class="op" id="7626026">!=</span>&nbsp;<span class="ident" id="7626029">nil</span>&nbsp;<span class="op" id="7626033">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626037">t</span><span class="op" id="7626038">.</span><span class="ident" id="7626039">Errorf</span><span class="op" id="7626045">(</span><span class="string" id="7626046">&#34;exec&nbsp;insert&nbsp;eleanor:&nbsp;%v&#34;</span><span class="op" id="7626071">,</span>&nbsp;<span class="ident" id="7626073">err</span><span class="op" id="7626076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626079">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7626083">//&nbsp;Can&#39;t&nbsp;put&nbsp;null&nbsp;val&nbsp;into&nbsp;non-null&nbsp;col</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626124">if</span>&nbsp;<span class="ident" id="7626127">_</span><span class="op" id="7626128">,</span>&nbsp;<span class="ident" id="7626130">err</span>&nbsp;<span class="op" id="7626134">:=</span>&nbsp;<span class="ident" id="7626137">stmt</span><span class="op" id="7626141">.</span><span class="ident" id="7626142">Exec</span><span class="op" id="7626146">(</span><span class="num" id="7626147">6</span><span class="op" id="7626148">,</span>&nbsp;<span class="string" id="7626150">&#34;bob&#34;</span><span class="op" id="7626155">,</span>&nbsp;<span class="ident" id="7626157">spec</span><span class="op" id="7626161">.</span><span class="ident" id="7626162">rows</span><span class="op" id="7626166">[</span><span class="num" id="7626167">5</span><span class="op" id="7626168">]</span><span class="op" id="7626169">.</span><span class="ident" id="7626170">nullParam</span><span class="op" id="7626179">,</span>&nbsp;<span class="ident" id="7626181">spec</span><span class="op" id="7626185">.</span><span class="ident" id="7626186">rows</span><span class="op" id="7626190">[</span><span class="num" id="7626191">5</span><span class="op" id="7626192">]</span><span class="op" id="7626193">.</span><span class="ident" id="7626194">notNullParam</span><span class="op" id="7626206">)</span><span class="op" id="7626207">;</span>&nbsp;<span class="ident" id="7626209">err</span>&nbsp;<span class="op" id="7626213">==</span>&nbsp;<span class="ident" id="7626216">nil</span>&nbsp;<span class="op" id="7626220">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626224">t</span><span class="op" id="7626225">.</span><span class="ident" id="7626226">Errorf</span><span class="op" id="7626232">(</span><span class="string" id="7626233">&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;val&nbsp;with&nbsp;prepared&nbsp;statement&nbsp;Exec&#34;</span><span class="op" id="7626296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626303">_</span><span class="op" id="7626304">,</span>&nbsp;<span class="ident" id="7626306">err</span>&nbsp;<span class="op" id="7626310">=</span>&nbsp;<span class="ident" id="7626312">db</span><span class="op" id="7626314">.</span><span class="ident" id="7626315">Exec</span><span class="op" id="7626319">(</span><span class="string" id="7626320">&#34;INSERT|t|id=?,name=?,nullf=?&#34;</span><span class="op" id="7626350">,</span>&nbsp;<span class="num" id="7626352">999</span><span class="op" id="7626355">,</span>&nbsp;<span class="ident" id="7626357">nil</span><span class="op" id="7626360">,</span>&nbsp;<span class="ident" id="7626362">nil</span><span class="op" id="7626365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626368">if</span>&nbsp;<span class="ident" id="7626371">err</span>&nbsp;<span class="op" id="7626375">==</span>&nbsp;<span class="ident" id="7626378">nil</span>&nbsp;<span class="op" id="7626382">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7626386">//&nbsp;TODO:&nbsp;this&nbsp;test&nbsp;fails,&nbsp;but&nbsp;it&#39;s&nbsp;just&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7626436">//&nbsp;fakeConn&nbsp;implements&nbsp;the&nbsp;optional&nbsp;Execer&nbsp;interface,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7626492">//&nbsp;so&nbsp;arguably&nbsp;this&nbsp;is&nbsp;the&nbsp;correct&nbsp;behavior.&nbsp;&nbsp;But</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7626544">//&nbsp;maybe&nbsp;I&nbsp;should&nbsp;flesh&nbsp;out&nbsp;the&nbsp;fakeConn.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7626592">//&nbsp;implementation&nbsp;so&nbsp;this&nbsp;properly&nbsp;fails.</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7626636">//&nbsp;t.Errorf(&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;name&nbsp;with&nbsp;Exec&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626700">paramtype</span>&nbsp;<span class="op" id="7626710">:=</span>&nbsp;<span class="ident" id="7626713">reflect</span><span class="op" id="7626720">.</span><span class="ident" id="7626721">TypeOf</span><span class="op" id="7626727">(</span><span class="ident" id="7626728">spec</span><span class="op" id="7626732">.</span><span class="ident" id="7626733">rows</span><span class="op" id="7626737">[</span><span class="num" id="7626738">0</span><span class="op" id="7626739">]</span><span class="op" id="7626740">.</span><span class="ident" id="7626741">nullParam</span><span class="op" id="7626750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626753">bindVal</span>&nbsp;<span class="op" id="7626761">:=</span>&nbsp;<span class="ident" id="7626764">reflect</span><span class="op" id="7626771">.</span><span class="ident" id="7626772">New</span><span class="op" id="7626775">(</span><span class="ident" id="7626776">paramtype</span><span class="op" id="7626785">)</span><span class="op" id="7626786">.</span><span class="ident" id="7626787">Interface</span><span class="op" id="7626796">(</span><span class="op" id="7626797">)</span><br>
<span class="lineno">830</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626801">for</span>&nbsp;<span class="ident" id="7626805">i</span>&nbsp;<span class="op" id="7626807">:=</span>&nbsp;<span class="num" id="7626810">0</span><span class="op" id="7626811">;</span>&nbsp;<span class="ident" id="7626813">i</span>&nbsp;<span class="op" id="7626815">&lt;</span>&nbsp;<span class="num" id="7626817">5</span><span class="op" id="7626818">;</span>&nbsp;<span class="ident" id="7626820">i</span><span class="op" id="7626821">++</span>&nbsp;<span class="op" id="7626824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626828">id</span>&nbsp;<span class="op" id="7626831">:=</span>&nbsp;<span class="ident" id="7626834">i</span>&nbsp;<span class="op" id="7626836">+</span>&nbsp;<span class="num" id="7626838">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7626842">if</span>&nbsp;<span class="ident" id="7626845">err</span>&nbsp;<span class="op" id="7626849">:=</span>&nbsp;<span class="ident" id="7626852">db</span><span class="op" id="7626854">.</span><span class="ident" id="7626855">QueryRow</span><span class="op" id="7626863">(</span><span class="string" id="7626864">&#34;SELECT|t|nullf|id=?&#34;</span><span class="op" id="7626885">,</span>&nbsp;<span class="ident" id="7626887">id</span><span class="op" id="7626889">)</span><span class="op" id="7626890">.</span><span class="ident" id="7626891">Scan</span><span class="op" id="7626895">(</span><span class="ident" id="7626896">bindVal</span><span class="op" id="7626903">)</span><span class="op" id="7626904">;</span>&nbsp;<span class="ident" id="7626906">err</span>&nbsp;<span class="op" id="7626910">!=</span>&nbsp;<span class="ident" id="7626913">nil</span>&nbsp;<span class="op" id="7626917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626922">t</span><span class="op" id="7626923">.</span><span class="ident" id="7626924">Errorf</span><span class="op" id="7626930">(</span><span class="string" id="7626931">&#34;id=%d&nbsp;Scan:&nbsp;%v&#34;</span><span class="op" id="7626947">,</span>&nbsp;<span class="ident" id="7626949">id</span><span class="op" id="7626951">,</span>&nbsp;<span class="ident" id="7626953">err</span><span class="op" id="7626956">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7626960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7626964">bindValDeref</span>&nbsp;<span class="op" id="7626977">:=</span>&nbsp;<span class="ident" id="7626980">reflect</span><span class="op" id="7626987">.</span><span class="ident" id="7626988">ValueOf</span><span class="op" id="7626995">(</span><span class="ident" id="7626996">bindVal</span><span class="op" id="7627003">)</span><span class="op" id="7627004">.</span><span class="ident" id="7627005">Elem</span><span class="op" id="7627009">(</span><span class="op" id="7627010">)</span><span class="op" id="7627011">.</span><span class="ident" id="7627012">Interface</span><span class="op" id="7627021">(</span><span class="op" id="7627022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627026">if</span>&nbsp;<span class="op" id="7627029">!</span><span class="ident" id="7627030">reflect</span><span class="op" id="7627037">.</span><span class="ident" id="7627038">DeepEqual</span><span class="op" id="7627047">(</span><span class="ident" id="7627048">bindValDeref</span><span class="op" id="7627060">,</span>&nbsp;<span class="ident" id="7627062">spec</span><span class="op" id="7627066">.</span><span class="ident" id="7627067">rows</span><span class="op" id="7627071">[</span><span class="ident" id="7627072">i</span><span class="op" id="7627073">]</span><span class="op" id="7627074">.</span><span class="ident" id="7627075">scanNullVal</span><span class="op" id="7627086">)</span>&nbsp;<span class="op" id="7627088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627093">t</span><span class="op" id="7627094">.</span><span class="ident" id="7627095">Errorf</span><span class="op" id="7627101">(</span><span class="string" id="7627102">&#34;id=%d&nbsp;got&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="7627127">,</span>&nbsp;<span class="ident" id="7627129">id</span><span class="op" id="7627131">,</span>&nbsp;<span class="ident" id="7627133">bindValDeref</span><span class="op" id="7627145">,</span>&nbsp;<span class="ident" id="7627147">spec</span><span class="op" id="7627151">.</span><span class="ident" id="7627152">rows</span><span class="op" id="7627156">[</span><span class="ident" id="7627157">i</span><span class="op" id="7627158">]</span><span class="op" id="7627159">.</span><span class="ident" id="7627160">scanNullVal</span><span class="op" id="7627171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7627175">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7627178">}</span><br>
<span class="lineno"></span><span class="op" id="7627180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7627183">//&nbsp;golang.org/issue/4859</span><br>
<span class="lineno"></span><span class="keyword" id="7627208">func</span>&nbsp;<span class="ident" id="7627213">TestQueryRowNilScanDest</span><span class="op" id="7627236">(</span><span class="ident" id="7627237">t</span>&nbsp;<span class="op" id="7627239">*</span><span class="ident" id="7627240">testing</span><span class="op" id="7627247">.</span><span class="ident" id="7627248">T</span><span class="op" id="7627249">)</span>&nbsp;<span class="op" id="7627251">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627254">db</span>&nbsp;<span class="op" id="7627257">:=</span>&nbsp;<span class="ident" id="7627260">newTestDB</span><span class="op" id="7627269">(</span><span class="ident" id="7627270">t</span><span class="op" id="7627271">,</span>&nbsp;<span class="string" id="7627273">&#34;people&#34;</span><span class="op" id="7627281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627284">defer</span>&nbsp;<span class="ident" id="7627290">closeDB</span><span class="op" id="7627297">(</span><span class="ident" id="7627298">t</span><span class="op" id="7627299">,</span>&nbsp;<span class="ident" id="7627301">db</span><span class="op" id="7627303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627306">var</span>&nbsp;<span class="ident" id="7627310">name</span>&nbsp;<span class="op" id="7627315">*</span><span class="builtintype" id="7627316">string</span>&nbsp;<span class="comment" id="7627323">//&nbsp;nil&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627339">err</span>&nbsp;<span class="op" id="7627343">:=</span>&nbsp;<span class="ident" id="7627346">db</span><span class="op" id="7627348">.</span><span class="ident" id="7627349">QueryRow</span><span class="op" id="7627357">(</span><span class="string" id="7627358">&#34;SELECT|people|name|&#34;</span><span class="op" id="7627379">)</span><span class="op" id="7627380">.</span><span class="ident" id="7627381">Scan</span><span class="op" id="7627385">(</span><span class="ident" id="7627386">name</span><span class="op" id="7627390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627393">want</span>&nbsp;<span class="op" id="7627398">:=</span>&nbsp;<span class="string" id="7627401">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;0:&nbsp;destination&nbsp;pointer&nbsp;is&nbsp;nil&#34;</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627466">if</span>&nbsp;<span class="ident" id="7627469">err</span>&nbsp;<span class="op" id="7627473">==</span>&nbsp;<span class="ident" id="7627476">nil</span>&nbsp;<span class="op" id="7627480">||</span>&nbsp;<span class="ident" id="7627483">err</span><span class="op" id="7627486">.</span><span class="ident" id="7627487">Error</span><span class="op" id="7627492">(</span><span class="op" id="7627493">)</span>&nbsp;<span class="op" id="7627495">!=</span>&nbsp;<span class="ident" id="7627498">want</span>&nbsp;<span class="op" id="7627503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627507">t</span><span class="op" id="7627508">.</span><span class="ident" id="7627509">Errorf</span><span class="op" id="7627515">(</span><span class="string" id="7627516">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7627537">,</span>&nbsp;<span class="ident" id="7627539">err</span><span class="op" id="7627542">.</span><span class="ident" id="7627543">Error</span><span class="op" id="7627548">(</span><span class="op" id="7627549">)</span><span class="op" id="7627550">,</span>&nbsp;<span class="ident" id="7627552">want</span><span class="op" id="7627556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7627559">}</span><br>
<span class="lineno"></span><span class="op" id="7627561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">855</span><span class="keyword" id="7627564">func</span>&nbsp;<span class="ident" id="7627569">TestIssue4902</span><span class="op" id="7627582">(</span><span class="ident" id="7627583">t</span>&nbsp;<span class="op" id="7627585">*</span><span class="ident" id="7627586">testing</span><span class="op" id="7627593">.</span><span class="ident" id="7627594">T</span><span class="op" id="7627595">)</span>&nbsp;<span class="op" id="7627597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627600">db</span>&nbsp;<span class="op" id="7627603">:=</span>&nbsp;<span class="ident" id="7627606">newTestDB</span><span class="op" id="7627615">(</span><span class="ident" id="7627616">t</span><span class="op" id="7627617">,</span>&nbsp;<span class="string" id="7627619">&#34;people&#34;</span><span class="op" id="7627627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627630">defer</span>&nbsp;<span class="ident" id="7627636">closeDB</span><span class="op" id="7627643">(</span><span class="ident" id="7627644">t</span><span class="op" id="7627645">,</span>&nbsp;<span class="ident" id="7627647">db</span><span class="op" id="7627649">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627653">driver</span>&nbsp;<span class="op" id="7627660">:=</span>&nbsp;<span class="ident" id="7627663">db</span><span class="op" id="7627665">.</span><span class="ident" id="7627666">driver</span><span class="op" id="7627672">.</span><span class="op" id="7627673">(</span><span class="op" id="7627674">*</span><span class="ident" id="7627675">fakeDriver</span><span class="op" id="7627685">)</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627688">opens0</span>&nbsp;<span class="op" id="7627695">:=</span>&nbsp;<span class="ident" id="7627698">driver</span><span class="op" id="7627704">.</span><span class="ident" id="7627705">openCount</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627717">var</span>&nbsp;<span class="ident" id="7627721">stmt</span>&nbsp;<span class="op" id="7627726">*</span><span class="ident" id="7627727">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627733">var</span>&nbsp;<span class="ident" id="7627737">err</span>&nbsp;<span class="builtintype" id="7627741">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627748">for</span>&nbsp;<span class="ident" id="7627752">i</span>&nbsp;<span class="op" id="7627754">:=</span>&nbsp;<span class="num" id="7627757">0</span><span class="op" id="7627758">;</span>&nbsp;<span class="ident" id="7627760">i</span>&nbsp;<span class="op" id="7627762">&lt;</span>&nbsp;<span class="num" id="7627764">10</span><span class="op" id="7627766">;</span>&nbsp;<span class="ident" id="7627768">i</span><span class="op" id="7627769">++</span>&nbsp;<span class="op" id="7627772">{</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627776">stmt</span><span class="op" id="7627780">,</span>&nbsp;<span class="ident" id="7627782">err</span>&nbsp;<span class="op" id="7627786">=</span>&nbsp;<span class="ident" id="7627788">db</span><span class="op" id="7627790">.</span><span class="ident" id="7627791">Prepare</span><span class="op" id="7627798">(</span><span class="string" id="7627799">&#34;SELECT|people|name|&#34;</span><span class="op" id="7627820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627824">if</span>&nbsp;<span class="ident" id="7627827">err</span>&nbsp;<span class="op" id="7627831">!=</span>&nbsp;<span class="ident" id="7627834">nil</span>&nbsp;<span class="op" id="7627838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627843">t</span><span class="op" id="7627844">.</span><span class="ident" id="7627845">Fatal</span><span class="op" id="7627850">(</span><span class="ident" id="7627851">err</span><span class="op" id="7627854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7627858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627862">err</span>&nbsp;<span class="op" id="7627866">=</span>&nbsp;<span class="ident" id="7627868">stmt</span><span class="op" id="7627872">.</span><span class="ident" id="7627873">Close</span><span class="op" id="7627878">(</span><span class="op" id="7627879">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627883">if</span>&nbsp;<span class="ident" id="7627886">err</span>&nbsp;<span class="op" id="7627890">!=</span>&nbsp;<span class="ident" id="7627893">nil</span>&nbsp;<span class="op" id="7627897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627902">t</span><span class="op" id="7627903">.</span><span class="ident" id="7627904">Fatal</span><span class="op" id="7627909">(</span><span class="ident" id="7627910">err</span><span class="op" id="7627913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7627917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7627920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627924">opens</span>&nbsp;<span class="op" id="7627930">:=</span>&nbsp;<span class="ident" id="7627933">driver</span><span class="op" id="7627939">.</span><span class="ident" id="7627940">openCount</span>&nbsp;<span class="op" id="7627950">-</span>&nbsp;<span class="ident" id="7627952">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7627960">if</span>&nbsp;<span class="ident" id="7627963">opens</span>&nbsp;<span class="op" id="7627969">&gt;</span>&nbsp;<span class="num" id="7627971">1</span>&nbsp;<span class="op" id="7627973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7627977">t</span><span class="op" id="7627978">.</span><span class="ident" id="7627979">Errorf</span><span class="op" id="7627985">(</span><span class="string" id="7627986">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="7628009">,</span>&nbsp;<span class="ident" id="7628011">opens</span><span class="op" id="7628016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628020">t</span><span class="op" id="7628021">.</span><span class="ident" id="7628022">Logf</span><span class="op" id="7628026">(</span><span class="string" id="7628027">&#34;db&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7628037">,</span>&nbsp;<span class="ident" id="7628039">db</span><span class="op" id="7628041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628045">t</span><span class="op" id="7628046">.</span><span class="ident" id="7628047">Logf</span><span class="op" id="7628051">(</span><span class="string" id="7628052">&#34;driver&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7628066">,</span>&nbsp;<span class="ident" id="7628068">driver</span><span class="op" id="7628074">)</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628078">t</span><span class="op" id="7628079">.</span><span class="ident" id="7628080">Logf</span><span class="op" id="7628084">(</span><span class="string" id="7628085">&#34;stmt&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7628097">,</span>&nbsp;<span class="ident" id="7628099">stmt</span><span class="op" id="7628103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628106">}</span><br>
<span class="lineno"></span><span class="op" id="7628108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7628111">//&nbsp;Issue&nbsp;3857</span><br>
<span class="lineno">885</span><span class="comment" id="7628125">//&nbsp;This&nbsp;used&nbsp;to&nbsp;deadlock.</span><br>
<span class="lineno"></span><span class="keyword" id="7628151">func</span>&nbsp;<span class="ident" id="7628156">TestSimultaneousQueries</span><span class="op" id="7628179">(</span><span class="ident" id="7628180">t</span>&nbsp;<span class="op" id="7628182">*</span><span class="ident" id="7628183">testing</span><span class="op" id="7628190">.</span><span class="ident" id="7628191">T</span><span class="op" id="7628192">)</span>&nbsp;<span class="op" id="7628194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628197">db</span>&nbsp;<span class="op" id="7628200">:=</span>&nbsp;<span class="ident" id="7628203">newTestDB</span><span class="op" id="7628212">(</span><span class="ident" id="7628213">t</span><span class="op" id="7628214">,</span>&nbsp;<span class="string" id="7628216">&#34;people&#34;</span><span class="op" id="7628224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628227">defer</span>&nbsp;<span class="ident" id="7628233">closeDB</span><span class="op" id="7628240">(</span><span class="ident" id="7628241">t</span><span class="op" id="7628242">,</span>&nbsp;<span class="ident" id="7628244">db</span><span class="op" id="7628246">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628250">tx</span><span class="op" id="7628252">,</span>&nbsp;<span class="ident" id="7628254">err</span>&nbsp;<span class="op" id="7628258">:=</span>&nbsp;<span class="ident" id="7628261">db</span><span class="op" id="7628263">.</span><span class="ident" id="7628264">Begin</span><span class="op" id="7628269">(</span><span class="op" id="7628270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628273">if</span>&nbsp;<span class="ident" id="7628276">err</span>&nbsp;<span class="op" id="7628280">!=</span>&nbsp;<span class="ident" id="7628283">nil</span>&nbsp;<span class="op" id="7628287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628291">t</span><span class="op" id="7628292">.</span><span class="ident" id="7628293">Fatal</span><span class="op" id="7628298">(</span><span class="ident" id="7628299">err</span><span class="op" id="7628302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628308">defer</span>&nbsp;<span class="ident" id="7628314">tx</span><span class="op" id="7628316">.</span><span class="ident" id="7628317">Rollback</span><span class="op" id="7628325">(</span><span class="op" id="7628326">)</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628330">r1</span><span class="op" id="7628332">,</span>&nbsp;<span class="ident" id="7628334">err</span>&nbsp;<span class="op" id="7628338">:=</span>&nbsp;<span class="ident" id="7628341">tx</span><span class="op" id="7628343">.</span><span class="ident" id="7628344">Query</span><span class="op" id="7628349">(</span><span class="string" id="7628350">&#34;SELECT|people|name|&#34;</span><span class="op" id="7628371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628374">if</span>&nbsp;<span class="ident" id="7628377">err</span>&nbsp;<span class="op" id="7628381">!=</span>&nbsp;<span class="ident" id="7628384">nil</span>&nbsp;<span class="op" id="7628388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628392">t</span><span class="op" id="7628393">.</span><span class="ident" id="7628394">Fatal</span><span class="op" id="7628399">(</span><span class="ident" id="7628400">err</span><span class="op" id="7628403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628406">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628409">defer</span>&nbsp;<span class="ident" id="7628415">r1</span><span class="op" id="7628417">.</span><span class="ident" id="7628418">Close</span><span class="op" id="7628423">(</span><span class="op" id="7628424">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628428">r2</span><span class="op" id="7628430">,</span>&nbsp;<span class="ident" id="7628432">err</span>&nbsp;<span class="op" id="7628436">:=</span>&nbsp;<span class="ident" id="7628439">tx</span><span class="op" id="7628441">.</span><span class="ident" id="7628442">Query</span><span class="op" id="7628447">(</span><span class="string" id="7628448">&#34;SELECT|people|name|&#34;</span><span class="op" id="7628469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628472">if</span>&nbsp;<span class="ident" id="7628475">err</span>&nbsp;<span class="op" id="7628479">!=</span>&nbsp;<span class="ident" id="7628482">nil</span>&nbsp;<span class="op" id="7628486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628490">t</span><span class="op" id="7628491">.</span><span class="ident" id="7628492">Fatal</span><span class="op" id="7628497">(</span><span class="ident" id="7628498">err</span><span class="op" id="7628501">)</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628507">defer</span>&nbsp;<span class="ident" id="7628513">r2</span><span class="op" id="7628515">.</span><span class="ident" id="7628516">Close</span><span class="op" id="7628521">(</span><span class="op" id="7628522">)</span><br>
<span class="lineno"></span><span class="op" id="7628524">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7628527">func</span>&nbsp;<span class="ident" id="7628532">TestMaxIdleConns</span><span class="op" id="7628548">(</span><span class="ident" id="7628549">t</span>&nbsp;<span class="op" id="7628551">*</span><span class="ident" id="7628552">testing</span><span class="op" id="7628559">.</span><span class="ident" id="7628560">T</span><span class="op" id="7628561">)</span>&nbsp;<span class="op" id="7628563">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628566">db</span>&nbsp;<span class="op" id="7628569">:=</span>&nbsp;<span class="ident" id="7628572">newTestDB</span><span class="op" id="7628581">(</span><span class="ident" id="7628582">t</span><span class="op" id="7628583">,</span>&nbsp;<span class="string" id="7628585">&#34;people&#34;</span><span class="op" id="7628593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628596">defer</span>&nbsp;<span class="ident" id="7628602">closeDB</span><span class="op" id="7628609">(</span><span class="ident" id="7628610">t</span><span class="op" id="7628611">,</span>&nbsp;<span class="ident" id="7628613">db</span><span class="op" id="7628615">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628619">tx</span><span class="op" id="7628621">,</span>&nbsp;<span class="ident" id="7628623">err</span>&nbsp;<span class="op" id="7628627">:=</span>&nbsp;<span class="ident" id="7628630">db</span><span class="op" id="7628632">.</span><span class="ident" id="7628633">Begin</span><span class="op" id="7628638">(</span><span class="op" id="7628639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628642">if</span>&nbsp;<span class="ident" id="7628645">err</span>&nbsp;<span class="op" id="7628649">!=</span>&nbsp;<span class="ident" id="7628652">nil</span>&nbsp;<span class="op" id="7628656">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628660">t</span><span class="op" id="7628661">.</span><span class="ident" id="7628662">Fatal</span><span class="op" id="7628667">(</span><span class="ident" id="7628668">err</span><span class="op" id="7628671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628677">tx</span><span class="op" id="7628679">.</span><span class="ident" id="7628680">Commit</span><span class="op" id="7628686">(</span><span class="op" id="7628687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628690">if</span>&nbsp;<span class="ident" id="7628693">got</span>&nbsp;<span class="op" id="7628697">:=</span>&nbsp;<span class="builtinfunc" id="7628700">len</span><span class="op" id="7628703">(</span><span class="ident" id="7628704">db</span><span class="op" id="7628706">.</span><span class="ident" id="7628707">freeConn</span><span class="op" id="7628715">)</span><span class="op" id="7628716">;</span>&nbsp;<span class="ident" id="7628718">got</span>&nbsp;<span class="op" id="7628722">!=</span>&nbsp;<span class="num" id="7628725">1</span>&nbsp;<span class="op" id="7628727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628731">t</span><span class="op" id="7628732">.</span><span class="ident" id="7628733">Errorf</span><span class="op" id="7628739">(</span><span class="string" id="7628740">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7628764">,</span>&nbsp;<span class="ident" id="7628766">got</span><span class="op" id="7628769">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628776">db</span><span class="op" id="7628778">.</span><span class="ident" id="7628779">SetMaxIdleConns</span><span class="op" id="7628794">(</span><span class="num" id="7628795">0</span><span class="op" id="7628796">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628800">if</span>&nbsp;<span class="ident" id="7628803">got</span>&nbsp;<span class="op" id="7628807">:=</span>&nbsp;<span class="builtinfunc" id="7628810">len</span><span class="op" id="7628813">(</span><span class="ident" id="7628814">db</span><span class="op" id="7628816">.</span><span class="ident" id="7628817">freeConn</span><span class="op" id="7628825">)</span><span class="op" id="7628826">;</span>&nbsp;<span class="ident" id="7628828">got</span>&nbsp;<span class="op" id="7628832">!=</span>&nbsp;<span class="num" id="7628835">0</span>&nbsp;<span class="op" id="7628837">{</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628841">t</span><span class="op" id="7628842">.</span><span class="ident" id="7628843">Errorf</span><span class="op" id="7628849">(</span><span class="string" id="7628850">&#34;freeConns&nbsp;after&nbsp;set&nbsp;to&nbsp;zero&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7628892">,</span>&nbsp;<span class="ident" id="7628894">got</span><span class="op" id="7628897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628904">tx</span><span class="op" id="7628906">,</span>&nbsp;<span class="ident" id="7628908">err</span>&nbsp;<span class="op" id="7628912">=</span>&nbsp;<span class="ident" id="7628914">db</span><span class="op" id="7628916">.</span><span class="ident" id="7628917">Begin</span><span class="op" id="7628922">(</span><span class="op" id="7628923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628926">if</span>&nbsp;<span class="ident" id="7628929">err</span>&nbsp;<span class="op" id="7628933">!=</span>&nbsp;<span class="ident" id="7628936">nil</span>&nbsp;<span class="op" id="7628940">{</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628944">t</span><span class="op" id="7628945">.</span><span class="ident" id="7628946">Fatal</span><span class="op" id="7628951">(</span><span class="ident" id="7628952">err</span><span class="op" id="7628955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7628958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7628961">tx</span><span class="op" id="7628963">.</span><span class="ident" id="7628964">Commit</span><span class="op" id="7628970">(</span><span class="op" id="7628971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7628974">if</span>&nbsp;<span class="ident" id="7628977">got</span>&nbsp;<span class="op" id="7628981">:=</span>&nbsp;<span class="builtinfunc" id="7628984">len</span><span class="op" id="7628987">(</span><span class="ident" id="7628988">db</span><span class="op" id="7628990">.</span><span class="ident" id="7628991">freeConn</span><span class="op" id="7628999">)</span><span class="op" id="7629000">;</span>&nbsp;<span class="ident" id="7629002">got</span>&nbsp;<span class="op" id="7629006">!=</span>&nbsp;<span class="num" id="7629009">0</span>&nbsp;<span class="op" id="7629011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629015">t</span><span class="op" id="7629016">.</span><span class="ident" id="7629017">Errorf</span><span class="op" id="7629023">(</span><span class="string" id="7629024">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7629048">,</span>&nbsp;<span class="ident" id="7629050">got</span><span class="op" id="7629053">)</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629056">}</span><br>
<span class="lineno"></span><span class="op" id="7629058">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7629061">func</span>&nbsp;<span class="ident" id="7629066">TestMaxOpenConns</span><span class="op" id="7629082">(</span><span class="ident" id="7629083">t</span>&nbsp;<span class="op" id="7629085">*</span><span class="ident" id="7629086">testing</span><span class="op" id="7629093">.</span><span class="ident" id="7629094">T</span><span class="op" id="7629095">)</span>&nbsp;<span class="op" id="7629097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629100">if</span>&nbsp;<span class="ident" id="7629103">testing</span><span class="op" id="7629110">.</span><span class="ident" id="7629111">Short</span><span class="op" id="7629116">(</span><span class="op" id="7629117">)</span>&nbsp;<span class="op" id="7629119">{</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629123">t</span><span class="op" id="7629124">.</span><span class="ident" id="7629125">Skip</span><span class="op" id="7629129">(</span><span class="string" id="7629130">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="7629154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629160">defer</span>&nbsp;<span class="ident" id="7629166">setHookpostCloseConn</span><span class="op" id="7629186">(</span><span class="ident" id="7629187">nil</span><span class="op" id="7629190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629193">setHookpostCloseConn</span><span class="op" id="7629213">(</span><span class="keyword" id="7629214">func</span><span class="op" id="7629218">(</span><span class="ident" id="7629219">_</span>&nbsp;<span class="op" id="7629221">*</span><span class="ident" id="7629222">fakeConn</span><span class="op" id="7629230">,</span>&nbsp;<span class="ident" id="7629232">err</span>&nbsp;<span class="builtintype" id="7629236">error</span><span class="op" id="7629241">)</span>&nbsp;<span class="op" id="7629243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629247">if</span>&nbsp;<span class="ident" id="7629250">err</span>&nbsp;<span class="op" id="7629254">!=</span>&nbsp;<span class="ident" id="7629257">nil</span>&nbsp;<span class="op" id="7629261">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629266">t</span><span class="op" id="7629267">.</span><span class="ident" id="7629268">Errorf</span><span class="op" id="7629274">(</span><span class="string" id="7629275">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7629303">,</span>&nbsp;<span class="ident" id="7629305">err</span><span class="op" id="7629308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629315">}</span><span class="op" id="7629316">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629320">db</span>&nbsp;<span class="op" id="7629323">:=</span>&nbsp;<span class="ident" id="7629326">newTestDB</span><span class="op" id="7629335">(</span><span class="ident" id="7629336">t</span><span class="op" id="7629337">,</span>&nbsp;<span class="string" id="7629339">&#34;magicquery&#34;</span><span class="op" id="7629351">)</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629354">defer</span>&nbsp;<span class="ident" id="7629360">closeDB</span><span class="op" id="7629367">(</span><span class="ident" id="7629368">t</span><span class="op" id="7629369">,</span>&nbsp;<span class="ident" id="7629371">db</span><span class="op" id="7629373">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629377">driver</span>&nbsp;<span class="op" id="7629384">:=</span>&nbsp;<span class="ident" id="7629387">db</span><span class="op" id="7629389">.</span><span class="ident" id="7629390">driver</span><span class="op" id="7629396">.</span><span class="op" id="7629397">(</span><span class="op" id="7629398">*</span><span class="ident" id="7629399">fakeDriver</span><span class="op" id="7629409">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7629413">//&nbsp;Force&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;0&nbsp;so&nbsp;we&nbsp;can&nbsp;get&nbsp;an&nbsp;accurate</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7629485">//&nbsp;count&nbsp;for&nbsp;the&nbsp;test</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629508">db</span><span class="op" id="7629510">.</span><span class="ident" id="7629511">SetMaxIdleConns</span><span class="op" id="7629526">(</span><span class="num" id="7629527">0</span><span class="op" id="7629528">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629532">if</span>&nbsp;<span class="ident" id="7629535">g</span><span class="op" id="7629536">,</span>&nbsp;<span class="ident" id="7629538">w</span>&nbsp;<span class="op" id="7629540">:=</span>&nbsp;<span class="ident" id="7629543">db</span><span class="op" id="7629545">.</span><span class="ident" id="7629546">numFreeConns</span><span class="op" id="7629558">(</span><span class="op" id="7629559">)</span><span class="op" id="7629560">,</span>&nbsp;<span class="num" id="7629562">0</span><span class="op" id="7629563">;</span>&nbsp;<span class="ident" id="7629565">g</span>&nbsp;<span class="op" id="7629567">!=</span>&nbsp;<span class="ident" id="7629570">w</span>&nbsp;<span class="op" id="7629572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629576">t</span><span class="op" id="7629577">.</span><span class="ident" id="7629578">Errorf</span><span class="op" id="7629584">(</span><span class="string" id="7629585">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7629611">,</span>&nbsp;<span class="ident" id="7629613">g</span><span class="op" id="7629614">,</span>&nbsp;<span class="ident" id="7629616">w</span><span class="op" id="7629617">)</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629624">if</span>&nbsp;<span class="ident" id="7629627">n</span>&nbsp;<span class="op" id="7629629">:=</span>&nbsp;<span class="ident" id="7629632">db</span><span class="op" id="7629634">.</span><span class="ident" id="7629635">numDepsPollUntil</span><span class="op" id="7629651">(</span><span class="num" id="7629652">0</span><span class="op" id="7629653">,</span>&nbsp;<span class="ident" id="7629655">time</span><span class="op" id="7629659">.</span><span class="ident" id="7629660">Second</span><span class="op" id="7629666">)</span><span class="op" id="7629667">;</span>&nbsp;<span class="ident" id="7629669">n</span>&nbsp;<span class="op" id="7629671">&gt;</span>&nbsp;<span class="num" id="7629673">0</span>&nbsp;<span class="op" id="7629675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629679">t</span><span class="op" id="7629680">.</span><span class="ident" id="7629681">Errorf</span><span class="op" id="7629687">(</span><span class="string" id="7629688">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7629729">,</span>&nbsp;<span class="ident" id="7629731">n</span><span class="op" id="7629732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629736">db</span><span class="op" id="7629738">.</span><span class="ident" id="7629739">dumpDeps</span><span class="op" id="7629747">(</span><span class="ident" id="7629748">t</span><span class="op" id="7629749">)</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629756">driver</span><span class="op" id="7629762">.</span><span class="ident" id="7629763">mu</span><span class="op" id="7629765">.</span><span class="ident" id="7629766">Lock</span><span class="op" id="7629770">(</span><span class="op" id="7629771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629774">opens0</span>&nbsp;<span class="op" id="7629781">:=</span>&nbsp;<span class="ident" id="7629784">driver</span><span class="op" id="7629790">.</span><span class="ident" id="7629791">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629802">closes0</span>&nbsp;<span class="op" id="7629810">:=</span>&nbsp;<span class="ident" id="7629813">driver</span><span class="op" id="7629819">.</span><span class="ident" id="7629820">closeCount</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629832">driver</span><span class="op" id="7629838">.</span><span class="ident" id="7629839">mu</span><span class="op" id="7629841">.</span><span class="ident" id="7629842">Unlock</span><span class="op" id="7629848">(</span><span class="op" id="7629849">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629853">db</span><span class="op" id="7629855">.</span><span class="ident" id="7629856">SetMaxIdleConns</span><span class="op" id="7629871">(</span><span class="num" id="7629872">10</span><span class="op" id="7629874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629877">db</span><span class="op" id="7629879">.</span><span class="ident" id="7629880">SetMaxOpenConns</span><span class="op" id="7629895">(</span><span class="num" id="7629896">10</span><span class="op" id="7629898">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629902">stmt</span><span class="op" id="7629906">,</span>&nbsp;<span class="ident" id="7629908">err</span>&nbsp;<span class="op" id="7629912">:=</span>&nbsp;<span class="ident" id="7629915">db</span><span class="op" id="7629917">.</span><span class="ident" id="7629918">Prepare</span><span class="op" id="7629925">(</span><span class="string" id="7629926">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="7629962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7629965">if</span>&nbsp;<span class="ident" id="7629968">err</span>&nbsp;<span class="op" id="7629972">!=</span>&nbsp;<span class="ident" id="7629975">nil</span>&nbsp;<span class="op" id="7629979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7629983">t</span><span class="op" id="7629984">.</span><span class="ident" id="7629985">Fatal</span><span class="op" id="7629990">(</span><span class="ident" id="7629991">err</span><span class="op" id="7629994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7629997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7630001">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7630037">const</span>&nbsp;<span class="op" id="7630043">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630047">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7630059">=</span>&nbsp;<span class="num" id="7630061">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630066">sleepMillis</span>&nbsp;<span class="op" id="7630078">=</span>&nbsp;<span class="num" id="7630080">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630085">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7630097">=</span>&nbsp;<span class="num" id="7630099">2</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7630105">var</span>&nbsp;<span class="ident" id="7630109">wg</span>&nbsp;<span class="ident" id="7630112">sync</span><span class="op" id="7630116">.</span><span class="ident" id="7630117">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7630128">for</span>&nbsp;<span class="ident" id="7630132">batch</span>&nbsp;<span class="op" id="7630138">:=</span>&nbsp;<span class="num" id="7630141">0</span><span class="op" id="7630142">;</span>&nbsp;<span class="ident" id="7630144">batch</span>&nbsp;<span class="op" id="7630150">&lt;</span>&nbsp;<span class="ident" id="7630152">nbatch</span><span class="op" id="7630158">;</span>&nbsp;<span class="ident" id="7630160">batch</span><span class="op" id="7630165">++</span>&nbsp;<span class="op" id="7630168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7630172">for</span>&nbsp;<span class="ident" id="7630176">i</span>&nbsp;<span class="op" id="7630178">:=</span>&nbsp;<span class="num" id="7630181">0</span><span class="op" id="7630182">;</span>&nbsp;<span class="ident" id="7630184">i</span>&nbsp;<span class="op" id="7630186">&lt;</span>&nbsp;<span class="ident" id="7630188">nquery</span><span class="op" id="7630194">;</span>&nbsp;<span class="ident" id="7630196">i</span><span class="op" id="7630197">++</span>&nbsp;<span class="op" id="7630200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630205">wg</span><span class="op" id="7630207">.</span><span class="ident" id="7630208">Add</span><span class="op" id="7630211">(</span><span class="num" id="7630212">1</span><span class="op" id="7630213">)</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7630218">go</span>&nbsp;<span class="keyword" id="7630221">func</span><span class="op" id="7630225">(</span><span class="op" id="7630226">)</span>&nbsp;<span class="op" id="7630228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7630234">defer</span>&nbsp;<span class="ident" id="7630240">wg</span><span class="op" id="7630242">.</span><span class="ident" id="7630243">Done</span><span class="op" id="7630247">(</span><span class="op" id="7630248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7630254">var</span>&nbsp;<span class="ident" id="7630258">op</span>&nbsp;<span class="builtintype" id="7630261">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7630272">if</span>&nbsp;<span class="ident" id="7630275">err</span>&nbsp;<span class="op" id="7630279">:=</span>&nbsp;<span class="ident" id="7630282">stmt</span><span class="op" id="7630286">.</span><span class="ident" id="7630287">QueryRow</span><span class="op" id="7630295">(</span><span class="string" id="7630296">&#34;sleep&#34;</span><span class="op" id="7630303">,</span>&nbsp;<span class="ident" id="7630305">sleepMillis</span><span class="op" id="7630316">)</span><span class="op" id="7630317">.</span><span class="ident" id="7630318">Scan</span><span class="op" id="7630322">(</span><span class="op" id="7630323">&amp;</span><span class="ident" id="7630324">op</span><span class="op" id="7630326">)</span><span class="op" id="7630327">;</span>&nbsp;<span class="ident" id="7630329">err</span>&nbsp;<span class="op" id="7630333">!=</span>&nbsp;<span class="ident" id="7630336">nil</span>&nbsp;<span class="op" id="7630340">&amp;&amp;</span>&nbsp;<span class="ident" id="7630343">err</span>&nbsp;<span class="op" id="7630347">!=</span>&nbsp;<span class="ident" id="7630350">ErrNoRows</span>&nbsp;<span class="op" id="7630360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630367">t</span><span class="op" id="7630368">.</span><span class="ident" id="7630369">Error</span><span class="op" id="7630374">(</span><span class="ident" id="7630375">err</span><span class="op" id="7630378">)</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630389">}</span><span class="op" id="7630390">(</span><span class="op" id="7630391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7630399">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7630456">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7630513">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630534">time</span><span class="op" id="7630538">.</span><span class="ident" id="7630539">Sleep</span><span class="op" id="7630544">(</span><span class="num" id="7630545">2</span>&nbsp;<span class="op" id="7630547">*</span>&nbsp;<span class="ident" id="7630549">sleepMillis</span>&nbsp;<span class="op" id="7630561">*</span>&nbsp;<span class="ident" id="7630563">time</span><span class="op" id="7630567">.</span><span class="ident" id="7630568">Millisecond</span><span class="op" id="7630579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630585">wg</span><span class="op" id="7630587">.</span><span class="ident" id="7630588">Wait</span><span class="op" id="7630592">(</span><span class="op" id="7630593">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7630597">if</span>&nbsp;<span class="ident" id="7630600">g</span><span class="op" id="7630601">,</span>&nbsp;<span class="ident" id="7630603">w</span>&nbsp;<span class="op" id="7630605">:=</span>&nbsp;<span class="ident" id="7630608">db</span><span class="op" id="7630610">.</span><span class="ident" id="7630611">numFreeConns</span><span class="op" id="7630623">(</span><span class="op" id="7630624">)</span><span class="op" id="7630625">,</span>&nbsp;<span class="num" id="7630627">10</span><span class="op" id="7630629">;</span>&nbsp;<span class="ident" id="7630631">g</span>&nbsp;<span class="op" id="7630633">!=</span>&nbsp;<span class="ident" id="7630636">w</span>&nbsp;<span class="op" id="7630638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630642">t</span><span class="op" id="7630643">.</span><span class="ident" id="7630644">Errorf</span><span class="op" id="7630650">(</span><span class="string" id="7630651">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7630677">,</span>&nbsp;<span class="ident" id="7630679">g</span><span class="op" id="7630680">,</span>&nbsp;<span class="ident" id="7630682">w</span><span class="op" id="7630683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7630690">if</span>&nbsp;<span class="ident" id="7630693">n</span>&nbsp;<span class="op" id="7630695">:=</span>&nbsp;<span class="ident" id="7630698">db</span><span class="op" id="7630700">.</span><span class="ident" id="7630701">numDepsPollUntil</span><span class="op" id="7630717">(</span><span class="num" id="7630718">20</span><span class="op" id="7630720">,</span>&nbsp;<span class="ident" id="7630722">time</span><span class="op" id="7630726">.</span><span class="ident" id="7630727">Second</span><span class="op" id="7630733">)</span><span class="op" id="7630734">;</span>&nbsp;<span class="ident" id="7630736">n</span>&nbsp;<span class="op" id="7630738">&gt;</span>&nbsp;<span class="num" id="7630740">20</span>&nbsp;<span class="op" id="7630743">{</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630747">t</span><span class="op" id="7630748">.</span><span class="ident" id="7630749">Errorf</span><span class="op" id="7630755">(</span><span class="string" id="7630756">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;20&#34;</span><span class="op" id="7630801">,</span>&nbsp;<span class="ident" id="7630803">n</span><span class="op" id="7630804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630808">db</span><span class="op" id="7630810">.</span><span class="ident" id="7630811">dumpDeps</span><span class="op" id="7630819">(</span><span class="ident" id="7630820">t</span><span class="op" id="7630821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7630824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630828">driver</span><span class="op" id="7630834">.</span><span class="ident" id="7630835">mu</span><span class="op" id="7630837">.</span><span class="ident" id="7630838">Lock</span><span class="op" id="7630842">(</span><span class="op" id="7630843">)</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630846">opens</span>&nbsp;<span class="op" id="7630852">:=</span>&nbsp;<span class="ident" id="7630855">driver</span><span class="op" id="7630861">.</span><span class="ident" id="7630862">openCount</span>&nbsp;<span class="op" id="7630872">-</span>&nbsp;<span class="ident" id="7630874">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630882">closes</span>&nbsp;<span class="op" id="7630889">:=</span>&nbsp;<span class="ident" id="7630892">driver</span><span class="op" id="7630898">.</span><span class="ident" id="7630899">closeCount</span>&nbsp;<span class="op" id="7630910">-</span>&nbsp;<span class="ident" id="7630912">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630921">driver</span><span class="op" id="7630927">.</span><span class="ident" id="7630928">mu</span><span class="op" id="7630930">.</span><span class="ident" id="7630931">Unlock</span><span class="op" id="7630937">(</span><span class="op" id="7630938">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7630942">if</span>&nbsp;<span class="ident" id="7630945">opens</span>&nbsp;<span class="op" id="7630951">&gt;</span>&nbsp;<span class="num" id="7630953">10</span>&nbsp;<span class="op" id="7630956">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630960">t</span><span class="op" id="7630961">.</span><span class="ident" id="7630962">Logf</span><span class="op" id="7630966">(</span><span class="string" id="7630967">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7630984">,</span>&nbsp;<span class="ident" id="7630986">opens</span><span class="op" id="7630991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7630995">t</span><span class="op" id="7630996">.</span><span class="ident" id="7630997">Logf</span><span class="op" id="7631001">(</span><span class="string" id="7631002">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7631020">,</span>&nbsp;<span class="ident" id="7631022">closes</span><span class="op" id="7631028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631032">t</span><span class="op" id="7631033">.</span><span class="ident" id="7631034">Errorf</span><span class="op" id="7631040">(</span><span class="string" id="7631041">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="7631081">,</span>&nbsp;<span class="ident" id="7631083">opens</span><span class="op" id="7631088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631092">db</span><span class="op" id="7631094">.</span><span class="ident" id="7631095">dumpDeps</span><span class="op" id="7631103">(</span><span class="ident" id="7631104">t</span><span class="op" id="7631105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7631108">}</span><br>
<span class="lineno">1025</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631112">if</span>&nbsp;<span class="ident" id="7631115">err</span>&nbsp;<span class="op" id="7631119">:=</span>&nbsp;<span class="ident" id="7631122">stmt</span><span class="op" id="7631126">.</span><span class="ident" id="7631127">Close</span><span class="op" id="7631132">(</span><span class="op" id="7631133">)</span><span class="op" id="7631134">;</span>&nbsp;<span class="ident" id="7631136">err</span>&nbsp;<span class="op" id="7631140">!=</span>&nbsp;<span class="ident" id="7631143">nil</span>&nbsp;<span class="op" id="7631147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631151">t</span><span class="op" id="7631152">.</span><span class="ident" id="7631153">Fatal</span><span class="op" id="7631158">(</span><span class="ident" id="7631159">err</span><span class="op" id="7631162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7631165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631169">if</span>&nbsp;<span class="ident" id="7631172">g</span><span class="op" id="7631173">,</span>&nbsp;<span class="ident" id="7631175">w</span>&nbsp;<span class="op" id="7631177">:=</span>&nbsp;<span class="ident" id="7631180">db</span><span class="op" id="7631182">.</span><span class="ident" id="7631183">numFreeConns</span><span class="op" id="7631195">(</span><span class="op" id="7631196">)</span><span class="op" id="7631197">,</span>&nbsp;<span class="num" id="7631199">10</span><span class="op" id="7631201">;</span>&nbsp;<span class="ident" id="7631203">g</span>&nbsp;<span class="op" id="7631205">!=</span>&nbsp;<span class="ident" id="7631208">w</span>&nbsp;<span class="op" id="7631210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631214">t</span><span class="op" id="7631215">.</span><span class="ident" id="7631216">Errorf</span><span class="op" id="7631222">(</span><span class="string" id="7631223">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7631249">,</span>&nbsp;<span class="ident" id="7631251">g</span><span class="op" id="7631252">,</span>&nbsp;<span class="ident" id="7631254">w</span><span class="op" id="7631255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7631258">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631262">if</span>&nbsp;<span class="ident" id="7631265">n</span>&nbsp;<span class="op" id="7631267">:=</span>&nbsp;<span class="ident" id="7631270">db</span><span class="op" id="7631272">.</span><span class="ident" id="7631273">numDepsPollUntil</span><span class="op" id="7631289">(</span><span class="num" id="7631290">10</span><span class="op" id="7631292">,</span>&nbsp;<span class="ident" id="7631294">time</span><span class="op" id="7631298">.</span><span class="ident" id="7631299">Second</span><span class="op" id="7631305">)</span><span class="op" id="7631306">;</span>&nbsp;<span class="ident" id="7631308">n</span>&nbsp;<span class="op" id="7631310">&gt;</span>&nbsp;<span class="num" id="7631312">10</span>&nbsp;<span class="op" id="7631315">{</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631319">t</span><span class="op" id="7631320">.</span><span class="ident" id="7631321">Errorf</span><span class="op" id="7631327">(</span><span class="string" id="7631328">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="7631373">,</span>&nbsp;<span class="ident" id="7631375">n</span><span class="op" id="7631376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631380">db</span><span class="op" id="7631382">.</span><span class="ident" id="7631383">dumpDeps</span><span class="op" id="7631391">(</span><span class="ident" id="7631392">t</span><span class="op" id="7631393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7631396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631400">db</span><span class="op" id="7631402">.</span><span class="ident" id="7631403">SetMaxOpenConns</span><span class="op" id="7631418">(</span><span class="num" id="7631419">5</span><span class="op" id="7631420">)</span><br>
<span class="lineno">1040</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631424">if</span>&nbsp;<span class="ident" id="7631427">g</span><span class="op" id="7631428">,</span>&nbsp;<span class="ident" id="7631430">w</span>&nbsp;<span class="op" id="7631432">:=</span>&nbsp;<span class="ident" id="7631435">db</span><span class="op" id="7631437">.</span><span class="ident" id="7631438">numFreeConns</span><span class="op" id="7631450">(</span><span class="op" id="7631451">)</span><span class="op" id="7631452">,</span>&nbsp;<span class="num" id="7631454">5</span><span class="op" id="7631455">;</span>&nbsp;<span class="ident" id="7631457">g</span>&nbsp;<span class="op" id="7631459">!=</span>&nbsp;<span class="ident" id="7631462">w</span>&nbsp;<span class="op" id="7631464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631468">t</span><span class="op" id="7631469">.</span><span class="ident" id="7631470">Errorf</span><span class="op" id="7631476">(</span><span class="string" id="7631477">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7631503">,</span>&nbsp;<span class="ident" id="7631505">g</span><span class="op" id="7631506">,</span>&nbsp;<span class="ident" id="7631508">w</span><span class="op" id="7631509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7631512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631516">if</span>&nbsp;<span class="ident" id="7631519">n</span>&nbsp;<span class="op" id="7631521">:=</span>&nbsp;<span class="ident" id="7631524">db</span><span class="op" id="7631526">.</span><span class="ident" id="7631527">numDepsPollUntil</span><span class="op" id="7631543">(</span><span class="num" id="7631544">5</span><span class="op" id="7631545">,</span>&nbsp;<span class="ident" id="7631547">time</span><span class="op" id="7631551">.</span><span class="ident" id="7631552">Second</span><span class="op" id="7631558">)</span><span class="op" id="7631559">;</span>&nbsp;<span class="ident" id="7631561">n</span>&nbsp;<span class="op" id="7631563">&gt;</span>&nbsp;<span class="num" id="7631565">5</span>&nbsp;<span class="op" id="7631567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631571">t</span><span class="op" id="7631572">.</span><span class="ident" id="7631573">Errorf</span><span class="op" id="7631579">(</span><span class="string" id="7631580">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7631621">,</span>&nbsp;<span class="ident" id="7631623">n</span><span class="op" id="7631624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631628">db</span><span class="op" id="7631630">.</span><span class="ident" id="7631631">dumpDeps</span><span class="op" id="7631639">(</span><span class="ident" id="7631640">t</span><span class="op" id="7631641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7631644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631648">db</span><span class="op" id="7631650">.</span><span class="ident" id="7631651">SetMaxOpenConns</span><span class="op" id="7631666">(</span><span class="num" id="7631667">0</span><span class="op" id="7631668">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631672">if</span>&nbsp;<span class="ident" id="7631675">g</span><span class="op" id="7631676">,</span>&nbsp;<span class="ident" id="7631678">w</span>&nbsp;<span class="op" id="7631680">:=</span>&nbsp;<span class="ident" id="7631683">db</span><span class="op" id="7631685">.</span><span class="ident" id="7631686">numFreeConns</span><span class="op" id="7631698">(</span><span class="op" id="7631699">)</span><span class="op" id="7631700">,</span>&nbsp;<span class="num" id="7631702">5</span><span class="op" id="7631703">;</span>&nbsp;<span class="ident" id="7631705">g</span>&nbsp;<span class="op" id="7631707">!=</span>&nbsp;<span class="ident" id="7631710">w</span>&nbsp;<span class="op" id="7631712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631716">t</span><span class="op" id="7631717">.</span><span class="ident" id="7631718">Errorf</span><span class="op" id="7631724">(</span><span class="string" id="7631725">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7631751">,</span>&nbsp;<span class="ident" id="7631753">g</span><span class="op" id="7631754">,</span>&nbsp;<span class="ident" id="7631756">w</span><span class="op" id="7631757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7631760">}</span><br>
<span class="lineno">1055</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631764">if</span>&nbsp;<span class="ident" id="7631767">n</span>&nbsp;<span class="op" id="7631769">:=</span>&nbsp;<span class="ident" id="7631772">db</span><span class="op" id="7631774">.</span><span class="ident" id="7631775">numDepsPollUntil</span><span class="op" id="7631791">(</span><span class="num" id="7631792">5</span><span class="op" id="7631793">,</span>&nbsp;<span class="ident" id="7631795">time</span><span class="op" id="7631799">.</span><span class="ident" id="7631800">Second</span><span class="op" id="7631806">)</span><span class="op" id="7631807">;</span>&nbsp;<span class="ident" id="7631809">n</span>&nbsp;<span class="op" id="7631811">&gt;</span>&nbsp;<span class="num" id="7631813">5</span>&nbsp;<span class="op" id="7631815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631819">t</span><span class="op" id="7631820">.</span><span class="ident" id="7631821">Errorf</span><span class="op" id="7631827">(</span><span class="string" id="7631828">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7631869">,</span>&nbsp;<span class="ident" id="7631871">n</span><span class="op" id="7631872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631876">db</span><span class="op" id="7631878">.</span><span class="ident" id="7631879">dumpDeps</span><span class="op" id="7631887">(</span><span class="ident" id="7631888">t</span><span class="op" id="7631889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7631892">}</span><br>
<span class="lineno">1060</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631896">db</span><span class="op" id="7631898">.</span><span class="ident" id="7631899">SetMaxIdleConns</span><span class="op" id="7631914">(</span><span class="num" id="7631915">0</span><span class="op" id="7631916">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7631920">if</span>&nbsp;<span class="ident" id="7631923">g</span><span class="op" id="7631924">,</span>&nbsp;<span class="ident" id="7631926">w</span>&nbsp;<span class="op" id="7631928">:=</span>&nbsp;<span class="ident" id="7631931">db</span><span class="op" id="7631933">.</span><span class="ident" id="7631934">numFreeConns</span><span class="op" id="7631946">(</span><span class="op" id="7631947">)</span><span class="op" id="7631948">,</span>&nbsp;<span class="num" id="7631950">0</span><span class="op" id="7631951">;</span>&nbsp;<span class="ident" id="7631953">g</span>&nbsp;<span class="op" id="7631955">!=</span>&nbsp;<span class="ident" id="7631958">w</span>&nbsp;<span class="op" id="7631960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7631964">t</span><span class="op" id="7631965">.</span><span class="ident" id="7631966">Errorf</span><span class="op" id="7631972">(</span><span class="string" id="7631973">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7631999">,</span>&nbsp;<span class="ident" id="7632001">g</span><span class="op" id="7632002">,</span>&nbsp;<span class="ident" id="7632004">w</span><span class="op" id="7632005">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632012">if</span>&nbsp;<span class="ident" id="7632015">n</span>&nbsp;<span class="op" id="7632017">:=</span>&nbsp;<span class="ident" id="7632020">db</span><span class="op" id="7632022">.</span><span class="ident" id="7632023">numDepsPollUntil</span><span class="op" id="7632039">(</span><span class="num" id="7632040">0</span><span class="op" id="7632041">,</span>&nbsp;<span class="ident" id="7632043">time</span><span class="op" id="7632047">.</span><span class="ident" id="7632048">Second</span><span class="op" id="7632054">)</span><span class="op" id="7632055">;</span>&nbsp;<span class="ident" id="7632057">n</span>&nbsp;<span class="op" id="7632059">&gt;</span>&nbsp;<span class="num" id="7632061">0</span>&nbsp;<span class="op" id="7632063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632067">t</span><span class="op" id="7632068">.</span><span class="ident" id="7632069">Errorf</span><span class="op" id="7632075">(</span><span class="string" id="7632076">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7632117">,</span>&nbsp;<span class="ident" id="7632119">n</span><span class="op" id="7632120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632124">db</span><span class="op" id="7632126">.</span><span class="ident" id="7632127">dumpDeps</span><span class="op" id="7632135">(</span><span class="ident" id="7632136">t</span><span class="op" id="7632137">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632140">}</span><br>
<span class="lineno"></span><span class="op" id="7632142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7632145">func</span>&nbsp;<span class="ident" id="7632150">TestSingleOpenConn</span><span class="op" id="7632168">(</span><span class="ident" id="7632169">t</span>&nbsp;<span class="op" id="7632171">*</span><span class="ident" id="7632172">testing</span><span class="op" id="7632179">.</span><span class="ident" id="7632180">T</span><span class="op" id="7632181">)</span>&nbsp;<span class="op" id="7632183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632186">db</span>&nbsp;<span class="op" id="7632189">:=</span>&nbsp;<span class="ident" id="7632192">newTestDB</span><span class="op" id="7632201">(</span><span class="ident" id="7632202">t</span><span class="op" id="7632203">,</span>&nbsp;<span class="string" id="7632205">&#34;people&#34;</span><span class="op" id="7632213">)</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632216">defer</span>&nbsp;<span class="ident" id="7632222">closeDB</span><span class="op" id="7632229">(</span><span class="ident" id="7632230">t</span><span class="op" id="7632231">,</span>&nbsp;<span class="ident" id="7632233">db</span><span class="op" id="7632235">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632239">db</span><span class="op" id="7632241">.</span><span class="ident" id="7632242">SetMaxOpenConns</span><span class="op" id="7632257">(</span><span class="num" id="7632258">1</span><span class="op" id="7632259">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632263">rows</span><span class="op" id="7632267">,</span>&nbsp;<span class="ident" id="7632269">err</span>&nbsp;<span class="op" id="7632273">:=</span>&nbsp;<span class="ident" id="7632276">db</span><span class="op" id="7632278">.</span><span class="ident" id="7632279">Query</span><span class="op" id="7632284">(</span><span class="string" id="7632285">&#34;SELECT|people|name|&#34;</span><span class="op" id="7632306">)</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632309">if</span>&nbsp;<span class="ident" id="7632312">err</span>&nbsp;<span class="op" id="7632316">!=</span>&nbsp;<span class="ident" id="7632319">nil</span>&nbsp;<span class="op" id="7632323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632327">t</span><span class="op" id="7632328">.</span><span class="ident" id="7632329">Fatal</span><span class="op" id="7632334">(</span><span class="ident" id="7632335">err</span><span class="op" id="7632338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632344">if</span>&nbsp;<span class="ident" id="7632347">err</span>&nbsp;<span class="op" id="7632351">=</span>&nbsp;<span class="ident" id="7632353">rows</span><span class="op" id="7632357">.</span><span class="ident" id="7632358">Close</span><span class="op" id="7632363">(</span><span class="op" id="7632364">)</span><span class="op" id="7632365">;</span>&nbsp;<span class="ident" id="7632367">err</span>&nbsp;<span class="op" id="7632371">!=</span>&nbsp;<span class="ident" id="7632374">nil</span>&nbsp;<span class="op" id="7632378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632382">t</span><span class="op" id="7632383">.</span><span class="ident" id="7632384">Fatal</span><span class="op" id="7632389">(</span><span class="ident" id="7632390">err</span><span class="op" id="7632393">)</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7632399">//&nbsp;shouldn&#39;t&nbsp;deadlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632422">rows</span><span class="op" id="7632426">,</span>&nbsp;<span class="ident" id="7632428">err</span>&nbsp;<span class="op" id="7632432">=</span>&nbsp;<span class="ident" id="7632434">db</span><span class="op" id="7632436">.</span><span class="ident" id="7632437">Query</span><span class="op" id="7632442">(</span><span class="string" id="7632443">&#34;SELECT|people|name|&#34;</span><span class="op" id="7632464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632467">if</span>&nbsp;<span class="ident" id="7632470">err</span>&nbsp;<span class="op" id="7632474">!=</span>&nbsp;<span class="ident" id="7632477">nil</span>&nbsp;<span class="op" id="7632481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632485">t</span><span class="op" id="7632486">.</span><span class="ident" id="7632487">Fatal</span><span class="op" id="7632492">(</span><span class="ident" id="7632493">err</span><span class="op" id="7632496">)</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632502">if</span>&nbsp;<span class="ident" id="7632505">err</span>&nbsp;<span class="op" id="7632509">=</span>&nbsp;<span class="ident" id="7632511">rows</span><span class="op" id="7632515">.</span><span class="ident" id="7632516">Close</span><span class="op" id="7632521">(</span><span class="op" id="7632522">)</span><span class="op" id="7632523">;</span>&nbsp;<span class="ident" id="7632525">err</span>&nbsp;<span class="op" id="7632529">!=</span>&nbsp;<span class="ident" id="7632532">nil</span>&nbsp;<span class="op" id="7632536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632540">t</span><span class="op" id="7632541">.</span><span class="ident" id="7632542">Fatal</span><span class="op" id="7632547">(</span><span class="ident" id="7632548">err</span><span class="op" id="7632551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632554">}</span><br>
<span class="lineno"></span><span class="op" id="7632556">}</span><br>
<span class="lineno">1095</span><br>
<span class="lineno"></span><span class="comment" id="7632559">//&nbsp;golang.org/issue/5323</span><br>
<span class="lineno"></span><span class="keyword" id="7632584">func</span>&nbsp;<span class="ident" id="7632589">TestStmtCloseDeps</span><span class="op" id="7632606">(</span><span class="ident" id="7632607">t</span>&nbsp;<span class="op" id="7632609">*</span><span class="ident" id="7632610">testing</span><span class="op" id="7632617">.</span><span class="ident" id="7632618">T</span><span class="op" id="7632619">)</span>&nbsp;<span class="op" id="7632621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632624">if</span>&nbsp;<span class="ident" id="7632627">testing</span><span class="op" id="7632634">.</span><span class="ident" id="7632635">Short</span><span class="op" id="7632640">(</span><span class="op" id="7632641">)</span>&nbsp;<span class="op" id="7632643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632647">t</span><span class="op" id="7632648">.</span><span class="ident" id="7632649">Skip</span><span class="op" id="7632653">(</span><span class="string" id="7632654">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="7632678">)</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632684">defer</span>&nbsp;<span class="ident" id="7632690">setHookpostCloseConn</span><span class="op" id="7632710">(</span><span class="ident" id="7632711">nil</span><span class="op" id="7632714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632717">setHookpostCloseConn</span><span class="op" id="7632737">(</span><span class="keyword" id="7632738">func</span><span class="op" id="7632742">(</span><span class="ident" id="7632743">_</span>&nbsp;<span class="op" id="7632745">*</span><span class="ident" id="7632746">fakeConn</span><span class="op" id="7632754">,</span>&nbsp;<span class="ident" id="7632756">err</span>&nbsp;<span class="builtintype" id="7632760">error</span><span class="op" id="7632765">)</span>&nbsp;<span class="op" id="7632767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632771">if</span>&nbsp;<span class="ident" id="7632774">err</span>&nbsp;<span class="op" id="7632778">!=</span>&nbsp;<span class="ident" id="7632781">nil</span>&nbsp;<span class="op" id="7632785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632790">t</span><span class="op" id="7632791">.</span><span class="ident" id="7632792">Errorf</span><span class="op" id="7632798">(</span><span class="string" id="7632799">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7632827">,</span>&nbsp;<span class="ident" id="7632829">err</span><span class="op" id="7632832">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7632839">}</span><span class="op" id="7632840">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632844">db</span>&nbsp;<span class="op" id="7632847">:=</span>&nbsp;<span class="ident" id="7632850">newTestDB</span><span class="op" id="7632859">(</span><span class="ident" id="7632860">t</span><span class="op" id="7632861">,</span>&nbsp;<span class="string" id="7632863">&#34;magicquery&#34;</span><span class="op" id="7632875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7632878">defer</span>&nbsp;<span class="ident" id="7632884">closeDB</span><span class="op" id="7632891">(</span><span class="ident" id="7632892">t</span><span class="op" id="7632893">,</span>&nbsp;<span class="ident" id="7632895">db</span><span class="op" id="7632897">)</span><br>
<span class="lineno">1110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632901">driver</span>&nbsp;<span class="op" id="7632908">:=</span>&nbsp;<span class="ident" id="7632911">db</span><span class="op" id="7632913">.</span><span class="ident" id="7632914">driver</span><span class="op" id="7632920">.</span><span class="op" id="7632921">(</span><span class="op" id="7632922">*</span><span class="ident" id="7632923">fakeDriver</span><span class="op" id="7632933">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632937">driver</span><span class="op" id="7632943">.</span><span class="ident" id="7632944">mu</span><span class="op" id="7632946">.</span><span class="ident" id="7632947">Lock</span><span class="op" id="7632951">(</span><span class="op" id="7632952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632955">opens0</span>&nbsp;<span class="op" id="7632962">:=</span>&nbsp;<span class="ident" id="7632965">driver</span><span class="op" id="7632971">.</span><span class="ident" id="7632972">openCount</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7632983">closes0</span>&nbsp;<span class="op" id="7632991">:=</span>&nbsp;<span class="ident" id="7632994">driver</span><span class="op" id="7633000">.</span><span class="ident" id="7633001">closeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633013">driver</span><span class="op" id="7633019">.</span><span class="ident" id="7633020">mu</span><span class="op" id="7633022">.</span><span class="ident" id="7633023">Unlock</span><span class="op" id="7633029">(</span><span class="op" id="7633030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633033">openDelta0</span>&nbsp;<span class="op" id="7633044">:=</span>&nbsp;<span class="ident" id="7633047">opens0</span>&nbsp;<span class="op" id="7633054">-</span>&nbsp;<span class="ident" id="7633056">closes0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633066">stmt</span><span class="op" id="7633070">,</span>&nbsp;<span class="ident" id="7633072">err</span>&nbsp;<span class="op" id="7633076">:=</span>&nbsp;<span class="ident" id="7633079">db</span><span class="op" id="7633081">.</span><span class="ident" id="7633082">Prepare</span><span class="op" id="7633089">(</span><span class="string" id="7633090">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="7633126">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633129">if</span>&nbsp;<span class="ident" id="7633132">err</span>&nbsp;<span class="op" id="7633136">!=</span>&nbsp;<span class="ident" id="7633139">nil</span>&nbsp;<span class="op" id="7633143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633147">t</span><span class="op" id="7633148">.</span><span class="ident" id="7633149">Fatal</span><span class="op" id="7633154">(</span><span class="ident" id="7633155">err</span><span class="op" id="7633158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7633165">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633201">const</span>&nbsp;<span class="op" id="7633207">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633211">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7633223">=</span>&nbsp;<span class="num" id="7633225">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633230">sleepMillis</span>&nbsp;<span class="op" id="7633242">=</span>&nbsp;<span class="num" id="7633244">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633249">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7633261">=</span>&nbsp;<span class="num" id="7633263">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633266">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633269">var</span>&nbsp;<span class="ident" id="7633273">wg</span>&nbsp;<span class="ident" id="7633276">sync</span><span class="op" id="7633280">.</span><span class="ident" id="7633281">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633292">for</span>&nbsp;<span class="ident" id="7633296">batch</span>&nbsp;<span class="op" id="7633302">:=</span>&nbsp;<span class="num" id="7633305">0</span><span class="op" id="7633306">;</span>&nbsp;<span class="ident" id="7633308">batch</span>&nbsp;<span class="op" id="7633314">&lt;</span>&nbsp;<span class="ident" id="7633316">nbatch</span><span class="op" id="7633322">;</span>&nbsp;<span class="ident" id="7633324">batch</span><span class="op" id="7633329">++</span>&nbsp;<span class="op" id="7633332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633336">for</span>&nbsp;<span class="ident" id="7633340">i</span>&nbsp;<span class="op" id="7633342">:=</span>&nbsp;<span class="num" id="7633345">0</span><span class="op" id="7633346">;</span>&nbsp;<span class="ident" id="7633348">i</span>&nbsp;<span class="op" id="7633350">&lt;</span>&nbsp;<span class="ident" id="7633352">nquery</span><span class="op" id="7633358">;</span>&nbsp;<span class="ident" id="7633360">i</span><span class="op" id="7633361">++</span>&nbsp;<span class="op" id="7633364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633369">wg</span><span class="op" id="7633371">.</span><span class="ident" id="7633372">Add</span><span class="op" id="7633375">(</span><span class="num" id="7633376">1</span><span class="op" id="7633377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633382">go</span>&nbsp;<span class="keyword" id="7633385">func</span><span class="op" id="7633389">(</span><span class="op" id="7633390">)</span>&nbsp;<span class="op" id="7633392">{</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633398">defer</span>&nbsp;<span class="ident" id="7633404">wg</span><span class="op" id="7633406">.</span><span class="ident" id="7633407">Done</span><span class="op" id="7633411">(</span><span class="op" id="7633412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633418">var</span>&nbsp;<span class="ident" id="7633422">op</span>&nbsp;<span class="builtintype" id="7633425">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633436">if</span>&nbsp;<span class="ident" id="7633439">err</span>&nbsp;<span class="op" id="7633443">:=</span>&nbsp;<span class="ident" id="7633446">stmt</span><span class="op" id="7633450">.</span><span class="ident" id="7633451">QueryRow</span><span class="op" id="7633459">(</span><span class="string" id="7633460">&#34;sleep&#34;</span><span class="op" id="7633467">,</span>&nbsp;<span class="ident" id="7633469">sleepMillis</span><span class="op" id="7633480">)</span><span class="op" id="7633481">.</span><span class="ident" id="7633482">Scan</span><span class="op" id="7633486">(</span><span class="op" id="7633487">&amp;</span><span class="ident" id="7633488">op</span><span class="op" id="7633490">)</span><span class="op" id="7633491">;</span>&nbsp;<span class="ident" id="7633493">err</span>&nbsp;<span class="op" id="7633497">!=</span>&nbsp;<span class="ident" id="7633500">nil</span>&nbsp;<span class="op" id="7633504">&amp;&amp;</span>&nbsp;<span class="ident" id="7633507">err</span>&nbsp;<span class="op" id="7633511">!=</span>&nbsp;<span class="ident" id="7633514">ErrNoRows</span>&nbsp;<span class="op" id="7633524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633531">t</span><span class="op" id="7633532">.</span><span class="ident" id="7633533">Error</span><span class="op" id="7633538">(</span><span class="ident" id="7633539">err</span><span class="op" id="7633542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633548">}</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633553">}</span><span class="op" id="7633554">(</span><span class="op" id="7633555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7633563">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7633620">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7633677">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633698">time</span><span class="op" id="7633702">.</span><span class="ident" id="7633703">Sleep</span><span class="op" id="7633708">(</span><span class="num" id="7633709">2</span>&nbsp;<span class="op" id="7633711">*</span>&nbsp;<span class="ident" id="7633713">sleepMillis</span>&nbsp;<span class="op" id="7633725">*</span>&nbsp;<span class="ident" id="7633727">time</span><span class="op" id="7633731">.</span><span class="ident" id="7633732">Millisecond</span><span class="op" id="7633743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633749">wg</span><span class="op" id="7633751">.</span><span class="ident" id="7633752">Wait</span><span class="op" id="7633756">(</span><span class="op" id="7633757">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633761">if</span>&nbsp;<span class="ident" id="7633764">g</span><span class="op" id="7633765">,</span>&nbsp;<span class="ident" id="7633767">w</span>&nbsp;<span class="op" id="7633769">:=</span>&nbsp;<span class="ident" id="7633772">db</span><span class="op" id="7633774">.</span><span class="ident" id="7633775">numFreeConns</span><span class="op" id="7633787">(</span><span class="op" id="7633788">)</span><span class="op" id="7633789">,</span>&nbsp;<span class="num" id="7633791">2</span><span class="op" id="7633792">;</span>&nbsp;<span class="ident" id="7633794">g</span>&nbsp;<span class="op" id="7633796">!=</span>&nbsp;<span class="ident" id="7633799">w</span>&nbsp;<span class="op" id="7633801">{</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633805">t</span><span class="op" id="7633806">.</span><span class="ident" id="7633807">Errorf</span><span class="op" id="7633813">(</span><span class="string" id="7633814">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7633840">,</span>&nbsp;<span class="ident" id="7633842">g</span><span class="op" id="7633843">,</span>&nbsp;<span class="ident" id="7633845">w</span><span class="op" id="7633846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7633853">if</span>&nbsp;<span class="ident" id="7633856">n</span>&nbsp;<span class="op" id="7633858">:=</span>&nbsp;<span class="ident" id="7633861">db</span><span class="op" id="7633863">.</span><span class="ident" id="7633864">numDepsPollUntil</span><span class="op" id="7633880">(</span><span class="num" id="7633881">4</span><span class="op" id="7633882">,</span>&nbsp;<span class="ident" id="7633884">time</span><span class="op" id="7633888">.</span><span class="ident" id="7633889">Second</span><span class="op" id="7633895">)</span><span class="op" id="7633896">;</span>&nbsp;<span class="ident" id="7633898">n</span>&nbsp;<span class="op" id="7633900">&gt;</span>&nbsp;<span class="num" id="7633902">4</span>&nbsp;<span class="op" id="7633904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633908">t</span><span class="op" id="7633909">.</span><span class="ident" id="7633910">Errorf</span><span class="op" id="7633916">(</span><span class="string" id="7633917">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;4&#34;</span><span class="op" id="7633961">,</span>&nbsp;<span class="ident" id="7633963">n</span><span class="op" id="7633964">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633968">db</span><span class="op" id="7633970">.</span><span class="ident" id="7633971">dumpDeps</span><span class="op" id="7633979">(</span><span class="ident" id="7633980">t</span><span class="op" id="7633981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7633984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7633988">driver</span><span class="op" id="7633994">.</span><span class="ident" id="7633995">mu</span><span class="op" id="7633997">.</span><span class="ident" id="7633998">Lock</span><span class="op" id="7634002">(</span><span class="op" id="7634003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634006">opens</span>&nbsp;<span class="op" id="7634012">:=</span>&nbsp;<span class="ident" id="7634015">driver</span><span class="op" id="7634021">.</span><span class="ident" id="7634022">openCount</span>&nbsp;<span class="op" id="7634032">-</span>&nbsp;<span class="ident" id="7634034">opens0</span><br>
<span class="lineno">1160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634042">closes</span>&nbsp;<span class="op" id="7634049">:=</span>&nbsp;<span class="ident" id="7634052">driver</span><span class="op" id="7634058">.</span><span class="ident" id="7634059">closeCount</span>&nbsp;<span class="op" id="7634070">-</span>&nbsp;<span class="ident" id="7634072">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634081">openDelta</span>&nbsp;<span class="op" id="7634091">:=</span>&nbsp;<span class="op" id="7634094">(</span><span class="ident" id="7634095">driver</span><span class="op" id="7634101">.</span><span class="ident" id="7634102">openCount</span>&nbsp;<span class="op" id="7634112">-</span>&nbsp;<span class="ident" id="7634114">driver</span><span class="op" id="7634120">.</span><span class="ident" id="7634121">closeCount</span><span class="op" id="7634131">)</span>&nbsp;<span class="op" id="7634133">-</span>&nbsp;<span class="ident" id="7634135">openDelta0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634147">driver</span><span class="op" id="7634153">.</span><span class="ident" id="7634154">mu</span><span class="op" id="7634156">.</span><span class="ident" id="7634157">Unlock</span><span class="op" id="7634163">(</span><span class="op" id="7634164">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634168">if</span>&nbsp;<span class="ident" id="7634171">openDelta</span>&nbsp;<span class="op" id="7634181">&gt;</span>&nbsp;<span class="num" id="7634183">2</span>&nbsp;<span class="op" id="7634185">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634189">t</span><span class="op" id="7634190">.</span><span class="ident" id="7634191">Logf</span><span class="op" id="7634195">(</span><span class="string" id="7634196">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7634213">,</span>&nbsp;<span class="ident" id="7634215">opens</span><span class="op" id="7634220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634224">t</span><span class="op" id="7634225">.</span><span class="ident" id="7634226">Logf</span><span class="op" id="7634230">(</span><span class="string" id="7634231">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7634249">,</span>&nbsp;<span class="ident" id="7634251">closes</span><span class="op" id="7634257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634261">t</span><span class="op" id="7634262">.</span><span class="ident" id="7634263">Logf</span><span class="op" id="7634267">(</span><span class="string" id="7634268">&#34;open&nbsp;delta&nbsp;=&nbsp;%d&#34;</span><span class="op" id="7634285">,</span>&nbsp;<span class="ident" id="7634287">openDelta</span><span class="op" id="7634296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634300">t</span><span class="op" id="7634301">.</span><span class="ident" id="7634302">Errorf</span><span class="op" id="7634308">(</span><span class="string" id="7634309">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="7634348">,</span>&nbsp;<span class="ident" id="7634350">openDelta</span><span class="op" id="7634359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634363">db</span><span class="op" id="7634365">.</span><span class="ident" id="7634366">dumpDeps</span><span class="op" id="7634374">(</span><span class="ident" id="7634375">t</span><span class="op" id="7634376">)</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634383">if</span>&nbsp;<span class="builtinfunc" id="7634386">len</span><span class="op" id="7634389">(</span><span class="ident" id="7634390">stmt</span><span class="op" id="7634394">.</span><span class="ident" id="7634395">css</span><span class="op" id="7634398">)</span>&nbsp;<span class="op" id="7634400">&gt;</span>&nbsp;<span class="ident" id="7634402">nquery</span>&nbsp;<span class="op" id="7634409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634413">t</span><span class="op" id="7634414">.</span><span class="ident" id="7634415">Errorf</span><span class="op" id="7634421">(</span><span class="string" id="7634422">&#34;len(stmt.css)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;%d&#34;</span><span class="op" id="7634454">,</span>&nbsp;<span class="builtinfunc" id="7634456">len</span><span class="op" id="7634459">(</span><span class="ident" id="7634460">stmt</span><span class="op" id="7634464">.</span><span class="ident" id="7634465">css</span><span class="op" id="7634468">)</span><span class="op" id="7634469">,</span>&nbsp;<span class="ident" id="7634471">nquery</span><span class="op" id="7634477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634480">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634484">if</span>&nbsp;<span class="ident" id="7634487">err</span>&nbsp;<span class="op" id="7634491">:=</span>&nbsp;<span class="ident" id="7634494">stmt</span><span class="op" id="7634498">.</span><span class="ident" id="7634499">Close</span><span class="op" id="7634504">(</span><span class="op" id="7634505">)</span><span class="op" id="7634506">;</span>&nbsp;<span class="ident" id="7634508">err</span>&nbsp;<span class="op" id="7634512">!=</span>&nbsp;<span class="ident" id="7634515">nil</span>&nbsp;<span class="op" id="7634519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634523">t</span><span class="op" id="7634524">.</span><span class="ident" id="7634525">Fatal</span><span class="op" id="7634530">(</span><span class="ident" id="7634531">err</span><span class="op" id="7634534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634537">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634541">if</span>&nbsp;<span class="ident" id="7634544">g</span><span class="op" id="7634545">,</span>&nbsp;<span class="ident" id="7634547">w</span>&nbsp;<span class="op" id="7634549">:=</span>&nbsp;<span class="ident" id="7634552">db</span><span class="op" id="7634554">.</span><span class="ident" id="7634555">numFreeConns</span><span class="op" id="7634567">(</span><span class="op" id="7634568">)</span><span class="op" id="7634569">,</span>&nbsp;<span class="num" id="7634571">2</span><span class="op" id="7634572">;</span>&nbsp;<span class="ident" id="7634574">g</span>&nbsp;<span class="op" id="7634576">!=</span>&nbsp;<span class="ident" id="7634579">w</span>&nbsp;<span class="op" id="7634581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634585">t</span><span class="op" id="7634586">.</span><span class="ident" id="7634587">Errorf</span><span class="op" id="7634593">(</span><span class="string" id="7634594">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7634620">,</span>&nbsp;<span class="ident" id="7634622">g</span><span class="op" id="7634623">,</span>&nbsp;<span class="ident" id="7634625">w</span><span class="op" id="7634626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634633">if</span>&nbsp;<span class="ident" id="7634636">n</span>&nbsp;<span class="op" id="7634638">:=</span>&nbsp;<span class="ident" id="7634641">db</span><span class="op" id="7634643">.</span><span class="ident" id="7634644">numDepsPollUntil</span><span class="op" id="7634660">(</span><span class="num" id="7634661">2</span><span class="op" id="7634662">,</span>&nbsp;<span class="ident" id="7634664">time</span><span class="op" id="7634668">.</span><span class="ident" id="7634669">Second</span><span class="op" id="7634675">)</span><span class="op" id="7634676">;</span>&nbsp;<span class="ident" id="7634678">n</span>&nbsp;<span class="op" id="7634680">&gt;</span>&nbsp;<span class="num" id="7634682">2</span>&nbsp;<span class="op" id="7634684">{</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634688">t</span><span class="op" id="7634689">.</span><span class="ident" id="7634690">Errorf</span><span class="op" id="7634696">(</span><span class="string" id="7634697">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="7634741">,</span>&nbsp;<span class="ident" id="7634743">n</span><span class="op" id="7634744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634748">db</span><span class="op" id="7634750">.</span><span class="ident" id="7634751">dumpDeps</span><span class="op" id="7634759">(</span><span class="ident" id="7634760">t</span><span class="op" id="7634761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634764">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634768">db</span><span class="op" id="7634770">.</span><span class="ident" id="7634771">SetMaxIdleConns</span><span class="op" id="7634786">(</span><span class="num" id="7634787">0</span><span class="op" id="7634788">)</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634792">if</span>&nbsp;<span class="ident" id="7634795">g</span><span class="op" id="7634796">,</span>&nbsp;<span class="ident" id="7634798">w</span>&nbsp;<span class="op" id="7634800">:=</span>&nbsp;<span class="ident" id="7634803">db</span><span class="op" id="7634805">.</span><span class="ident" id="7634806">numFreeConns</span><span class="op" id="7634818">(</span><span class="op" id="7634819">)</span><span class="op" id="7634820">,</span>&nbsp;<span class="num" id="7634822">0</span><span class="op" id="7634823">;</span>&nbsp;<span class="ident" id="7634825">g</span>&nbsp;<span class="op" id="7634827">!=</span>&nbsp;<span class="ident" id="7634830">w</span>&nbsp;<span class="op" id="7634832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634836">t</span><span class="op" id="7634837">.</span><span class="ident" id="7634838">Errorf</span><span class="op" id="7634844">(</span><span class="string" id="7634845">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7634871">,</span>&nbsp;<span class="ident" id="7634873">g</span><span class="op" id="7634874">,</span>&nbsp;<span class="ident" id="7634876">w</span><span class="op" id="7634877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7634880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7634884">if</span>&nbsp;<span class="ident" id="7634887">n</span>&nbsp;<span class="op" id="7634889">:=</span>&nbsp;<span class="ident" id="7634892">db</span><span class="op" id="7634894">.</span><span class="ident" id="7634895">numDepsPollUntil</span><span class="op" id="7634911">(</span><span class="num" id="7634912">0</span><span class="op" id="7634913">,</span>&nbsp;<span class="ident" id="7634915">time</span><span class="op" id="7634919">.</span><span class="ident" id="7634920">Second</span><span class="op" id="7634926">)</span><span class="op" id="7634927">;</span>&nbsp;<span class="ident" id="7634929">n</span>&nbsp;<span class="op" id="7634931">&gt;</span>&nbsp;<span class="num" id="7634933">0</span>&nbsp;<span class="op" id="7634935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634939">t</span><span class="op" id="7634940">.</span><span class="ident" id="7634941">Errorf</span><span class="op" id="7634947">(</span><span class="string" id="7634948">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="7634989">,</span>&nbsp;<span class="ident" id="7634991">n</span><span class="op" id="7634992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7634996">db</span><span class="op" id="7634998">.</span><span class="ident" id="7634999">dumpDeps</span><span class="op" id="7635007">(</span><span class="ident" id="7635008">t</span><span class="op" id="7635009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635012">}</span><br>
<span class="lineno"></span><span class="op" id="7635014">}</span><br>
<span class="lineno">1200</span><br>
<span class="lineno"></span><span class="comment" id="7635017">//&nbsp;golang.org/issue/5046</span><br>
<span class="lineno"></span><span class="keyword" id="7635042">func</span>&nbsp;<span class="ident" id="7635047">TestCloseConnBeforeStmts</span><span class="op" id="7635071">(</span><span class="ident" id="7635072">t</span>&nbsp;<span class="op" id="7635074">*</span><span class="ident" id="7635075">testing</span><span class="op" id="7635082">.</span><span class="ident" id="7635083">T</span><span class="op" id="7635084">)</span>&nbsp;<span class="op" id="7635086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635089">db</span>&nbsp;<span class="op" id="7635092">:=</span>&nbsp;<span class="ident" id="7635095">newTestDB</span><span class="op" id="7635104">(</span><span class="ident" id="7635105">t</span><span class="op" id="7635106">,</span>&nbsp;<span class="string" id="7635108">&#34;people&#34;</span><span class="op" id="7635116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635119">defer</span>&nbsp;<span class="ident" id="7635125">closeDB</span><span class="op" id="7635132">(</span><span class="ident" id="7635133">t</span><span class="op" id="7635134">,</span>&nbsp;<span class="ident" id="7635136">db</span><span class="op" id="7635138">)</span><br>
<span class="lineno">1205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635142">defer</span>&nbsp;<span class="ident" id="7635148">setHookpostCloseConn</span><span class="op" id="7635168">(</span><span class="ident" id="7635169">nil</span><span class="op" id="7635172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635175">setHookpostCloseConn</span><span class="op" id="7635195">(</span><span class="keyword" id="7635196">func</span><span class="op" id="7635200">(</span><span class="ident" id="7635201">_</span>&nbsp;<span class="op" id="7635203">*</span><span class="ident" id="7635204">fakeConn</span><span class="op" id="7635212">,</span>&nbsp;<span class="ident" id="7635214">err</span>&nbsp;<span class="builtintype" id="7635218">error</span><span class="op" id="7635223">)</span>&nbsp;<span class="op" id="7635225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635229">if</span>&nbsp;<span class="ident" id="7635232">err</span>&nbsp;<span class="op" id="7635236">!=</span>&nbsp;<span class="ident" id="7635239">nil</span>&nbsp;<span class="op" id="7635243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635248">t</span><span class="op" id="7635249">.</span><span class="ident" id="7635250">Errorf</span><span class="op" id="7635256">(</span><span class="string" id="7635257">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v;&nbsp;from&nbsp;%s&#34;</span><span class="op" id="7635294">,</span>&nbsp;<span class="ident" id="7635296">err</span><span class="op" id="7635299">,</span>&nbsp;<span class="ident" id="7635301">stack</span><span class="op" id="7635306">(</span><span class="op" id="7635307">)</span><span class="op" id="7635308">)</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635313">db</span><span class="op" id="7635315">.</span><span class="ident" id="7635316">dumpDeps</span><span class="op" id="7635324">(</span><span class="ident" id="7635325">t</span><span class="op" id="7635326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635331">t</span><span class="op" id="7635332">.</span><span class="ident" id="7635333">Errorf</span><span class="op" id="7635339">(</span><span class="string" id="7635340">&#34;DB&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="7635350">,</span>&nbsp;<span class="ident" id="7635352">db</span><span class="op" id="7635354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635361">}</span><span class="op" id="7635362">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635366">stmt</span><span class="op" id="7635370">,</span>&nbsp;<span class="ident" id="7635372">err</span>&nbsp;<span class="op" id="7635376">:=</span>&nbsp;<span class="ident" id="7635379">db</span><span class="op" id="7635381">.</span><span class="ident" id="7635382">Prepare</span><span class="op" id="7635389">(</span><span class="string" id="7635390">&#34;SELECT|people|name|&#34;</span><span class="op" id="7635411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635414">if</span>&nbsp;<span class="ident" id="7635417">err</span>&nbsp;<span class="op" id="7635421">!=</span>&nbsp;<span class="ident" id="7635424">nil</span>&nbsp;<span class="op" id="7635428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635432">t</span><span class="op" id="7635433">.</span><span class="ident" id="7635434">Fatal</span><span class="op" id="7635439">(</span><span class="ident" id="7635440">err</span><span class="op" id="7635443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635450">if</span>&nbsp;<span class="builtinfunc" id="7635453">len</span><span class="op" id="7635456">(</span><span class="ident" id="7635457">db</span><span class="op" id="7635459">.</span><span class="ident" id="7635460">freeConn</span><span class="op" id="7635468">)</span>&nbsp;<span class="op" id="7635470">!=</span>&nbsp;<span class="num" id="7635473">1</span>&nbsp;<span class="op" id="7635475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635479">t</span><span class="op" id="7635480">.</span><span class="ident" id="7635481">Fatalf</span><span class="op" id="7635487">(</span><span class="string" id="7635488">&#34;expected&nbsp;1&nbsp;freeConn;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="7635517">,</span>&nbsp;<span class="builtinfunc" id="7635519">len</span><span class="op" id="7635522">(</span><span class="ident" id="7635523">db</span><span class="op" id="7635525">.</span><span class="ident" id="7635526">freeConn</span><span class="op" id="7635534">)</span><span class="op" id="7635535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635541">dc</span>&nbsp;<span class="op" id="7635544">:=</span>&nbsp;<span class="ident" id="7635547">db</span><span class="op" id="7635549">.</span><span class="ident" id="7635550">freeConn</span><span class="op" id="7635558">[</span><span class="num" id="7635559">0</span><span class="op" id="7635560">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635563">if</span>&nbsp;<span class="ident" id="7635566">dc</span><span class="op" id="7635568">.</span><span class="ident" id="7635569">closed</span>&nbsp;<span class="op" id="7635576">{</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635580">t</span><span class="op" id="7635581">.</span><span class="ident" id="7635582">Errorf</span><span class="op" id="7635588">(</span><span class="string" id="7635589">&#34;conn&nbsp;shouldn&#39;t&nbsp;be&nbsp;closed&#34;</span><span class="op" id="7635615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635622">if</span>&nbsp;<span class="ident" id="7635625">n</span>&nbsp;<span class="op" id="7635627">:=</span>&nbsp;<span class="builtinfunc" id="7635630">len</span><span class="op" id="7635633">(</span><span class="ident" id="7635634">dc</span><span class="op" id="7635636">.</span><span class="ident" id="7635637">openStmt</span><span class="op" id="7635645">)</span><span class="op" id="7635646">;</span>&nbsp;<span class="ident" id="7635648">n</span>&nbsp;<span class="op" id="7635650">!=</span>&nbsp;<span class="num" id="7635653">1</span>&nbsp;<span class="op" id="7635655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635659">t</span><span class="op" id="7635660">.</span><span class="ident" id="7635661">Errorf</span><span class="op" id="7635667">(</span><span class="string" id="7635668">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="7635706">,</span>&nbsp;<span class="ident" id="7635708">n</span><span class="op" id="7635709">)</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635715">err</span>&nbsp;<span class="op" id="7635719">=</span>&nbsp;<span class="ident" id="7635721">db</span><span class="op" id="7635723">.</span><span class="ident" id="7635724">Close</span><span class="op" id="7635729">(</span><span class="op" id="7635730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635733">if</span>&nbsp;<span class="ident" id="7635736">err</span>&nbsp;<span class="op" id="7635740">!=</span>&nbsp;<span class="ident" id="7635743">nil</span>&nbsp;<span class="op" id="7635747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635751">t</span><span class="op" id="7635752">.</span><span class="ident" id="7635753">Errorf</span><span class="op" id="7635759">(</span><span class="string" id="7635760">&#34;db&nbsp;Close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7635775">,</span>&nbsp;<span class="ident" id="7635777">err</span><span class="op" id="7635780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635783">}</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635786">if</span>&nbsp;<span class="op" id="7635789">!</span><span class="ident" id="7635790">dc</span><span class="op" id="7635792">.</span><span class="ident" id="7635793">closed</span>&nbsp;<span class="op" id="7635800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635804">t</span><span class="op" id="7635805">.</span><span class="ident" id="7635806">Errorf</span><span class="op" id="7635812">(</span><span class="string" id="7635813">&#34;after&nbsp;db.Close,&nbsp;driverConn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="7635858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635864">if</span>&nbsp;<span class="ident" id="7635867">n</span>&nbsp;<span class="op" id="7635869">:=</span>&nbsp;<span class="builtinfunc" id="7635872">len</span><span class="op" id="7635875">(</span><span class="ident" id="7635876">dc</span><span class="op" id="7635878">.</span><span class="ident" id="7635879">openStmt</span><span class="op" id="7635887">)</span><span class="op" id="7635888">;</span>&nbsp;<span class="ident" id="7635890">n</span>&nbsp;<span class="op" id="7635892">!=</span>&nbsp;<span class="num" id="7635895">0</span>&nbsp;<span class="op" id="7635897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635901">t</span><span class="op" id="7635902">.</span><span class="ident" id="7635903">Errorf</span><span class="op" id="7635909">(</span><span class="string" id="7635910">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7635948">,</span>&nbsp;<span class="ident" id="7635950">n</span><span class="op" id="7635951">)</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7635954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635958">err</span>&nbsp;<span class="op" id="7635962">=</span>&nbsp;<span class="ident" id="7635964">stmt</span><span class="op" id="7635968">.</span><span class="ident" id="7635969">Close</span><span class="op" id="7635974">(</span><span class="op" id="7635975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7635978">if</span>&nbsp;<span class="ident" id="7635981">err</span>&nbsp;<span class="op" id="7635985">!=</span>&nbsp;<span class="ident" id="7635988">nil</span>&nbsp;<span class="op" id="7635992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7635996">t</span><span class="op" id="7635997">.</span><span class="ident" id="7635998">Errorf</span><span class="op" id="7636004">(</span><span class="string" id="7636005">&#34;Stmt&nbsp;close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="7636022">,</span>&nbsp;<span class="ident" id="7636024">err</span><span class="op" id="7636027">)</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636034">if</span>&nbsp;<span class="op" id="7636037">!</span><span class="ident" id="7636038">dc</span><span class="op" id="7636040">.</span><span class="ident" id="7636041">closed</span>&nbsp;<span class="op" id="7636048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636052">t</span><span class="op" id="7636053">.</span><span class="ident" id="7636054">Errorf</span><span class="op" id="7636060">(</span><span class="string" id="7636061">&#34;conn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="7636084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636087">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636090">if</span>&nbsp;<span class="ident" id="7636093">dc</span><span class="op" id="7636095">.</span><span class="ident" id="7636096">ci</span>&nbsp;<span class="op" id="7636099">!=</span>&nbsp;<span class="ident" id="7636102">nil</span>&nbsp;<span class="op" id="7636106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636110">t</span><span class="op" id="7636111">.</span><span class="ident" id="7636112">Errorf</span><span class="op" id="7636118">(</span><span class="string" id="7636119">&#34;after&nbsp;Stmt&nbsp;Close,&nbsp;driverConn&#39;s&nbsp;Conn&nbsp;interface&nbsp;should&nbsp;be&nbsp;nil&#34;</span><span class="op" id="7636180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636183">}</span><br>
<span class="lineno"></span><span class="op" id="7636185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1255</span><span class="comment" id="7636188">//&nbsp;golang.org/issue/5283:&nbsp;don&#39;t&nbsp;release&nbsp;the&nbsp;Rows&#39;&nbsp;connection&nbsp;in&nbsp;Close</span><br>
<span class="lineno"></span><span class="comment" id="7636258">//&nbsp;before&nbsp;calling&nbsp;Stmt.Close.</span><br>
<span class="lineno"></span><span class="keyword" id="7636288">func</span>&nbsp;<span class="ident" id="7636293">TestRowsCloseOrder</span><span class="op" id="7636311">(</span><span class="ident" id="7636312">t</span>&nbsp;<span class="op" id="7636314">*</span><span class="ident" id="7636315">testing</span><span class="op" id="7636322">.</span><span class="ident" id="7636323">T</span><span class="op" id="7636324">)</span>&nbsp;<span class="op" id="7636326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636329">db</span>&nbsp;<span class="op" id="7636332">:=</span>&nbsp;<span class="ident" id="7636335">newTestDB</span><span class="op" id="7636344">(</span><span class="ident" id="7636345">t</span><span class="op" id="7636346">,</span>&nbsp;<span class="string" id="7636348">&#34;people&#34;</span><span class="op" id="7636356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636359">defer</span>&nbsp;<span class="ident" id="7636365">closeDB</span><span class="op" id="7636372">(</span><span class="ident" id="7636373">t</span><span class="op" id="7636374">,</span>&nbsp;<span class="ident" id="7636376">db</span><span class="op" id="7636378">)</span><br>
<span class="lineno">1260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636382">db</span><span class="op" id="7636384">.</span><span class="ident" id="7636385">SetMaxIdleConns</span><span class="op" id="7636400">(</span><span class="num" id="7636401">0</span><span class="op" id="7636402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636405">setStrictFakeConnClose</span><span class="op" id="7636427">(</span><span class="ident" id="7636428">t</span><span class="op" id="7636429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636432">defer</span>&nbsp;<span class="ident" id="7636438">setStrictFakeConnClose</span><span class="op" id="7636460">(</span><span class="ident" id="7636461">nil</span><span class="op" id="7636464">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636468">rows</span><span class="op" id="7636472">,</span>&nbsp;<span class="ident" id="7636474">err</span>&nbsp;<span class="op" id="7636478">:=</span>&nbsp;<span class="ident" id="7636481">db</span><span class="op" id="7636483">.</span><span class="ident" id="7636484">Query</span><span class="op" id="7636489">(</span><span class="string" id="7636490">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7636515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636518">if</span>&nbsp;<span class="ident" id="7636521">err</span>&nbsp;<span class="op" id="7636525">!=</span>&nbsp;<span class="ident" id="7636528">nil</span>&nbsp;<span class="op" id="7636532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636536">t</span><span class="op" id="7636537">.</span><span class="ident" id="7636538">Fatal</span><span class="op" id="7636543">(</span><span class="ident" id="7636544">err</span><span class="op" id="7636547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636553">err</span>&nbsp;<span class="op" id="7636557">=</span>&nbsp;<span class="ident" id="7636559">rows</span><span class="op" id="7636563">.</span><span class="ident" id="7636564">Close</span><span class="op" id="7636569">(</span><span class="op" id="7636570">)</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636573">if</span>&nbsp;<span class="ident" id="7636576">err</span>&nbsp;<span class="op" id="7636580">!=</span>&nbsp;<span class="ident" id="7636583">nil</span>&nbsp;<span class="op" id="7636587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636591">t</span><span class="op" id="7636592">.</span><span class="ident" id="7636593">Fatal</span><span class="op" id="7636598">(</span><span class="ident" id="7636599">err</span><span class="op" id="7636602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636605">}</span><br>
<span class="lineno"></span><span class="op" id="7636607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1275</span><span class="keyword" id="7636610">func</span>&nbsp;<span class="ident" id="7636615">TestRowsImplicitClose</span><span class="op" id="7636636">(</span><span class="ident" id="7636637">t</span>&nbsp;<span class="op" id="7636639">*</span><span class="ident" id="7636640">testing</span><span class="op" id="7636647">.</span><span class="ident" id="7636648">T</span><span class="op" id="7636649">)</span>&nbsp;<span class="op" id="7636651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636654">db</span>&nbsp;<span class="op" id="7636657">:=</span>&nbsp;<span class="ident" id="7636660">newTestDB</span><span class="op" id="7636669">(</span><span class="ident" id="7636670">t</span><span class="op" id="7636671">,</span>&nbsp;<span class="string" id="7636673">&#34;people&#34;</span><span class="op" id="7636681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636684">defer</span>&nbsp;<span class="ident" id="7636690">closeDB</span><span class="op" id="7636697">(</span><span class="ident" id="7636698">t</span><span class="op" id="7636699">,</span>&nbsp;<span class="ident" id="7636701">db</span><span class="op" id="7636703">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636707">rows</span><span class="op" id="7636711">,</span>&nbsp;<span class="ident" id="7636713">err</span>&nbsp;<span class="op" id="7636717">:=</span>&nbsp;<span class="ident" id="7636720">db</span><span class="op" id="7636722">.</span><span class="ident" id="7636723">Query</span><span class="op" id="7636728">(</span><span class="string" id="7636729">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="7636754">)</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636757">if</span>&nbsp;<span class="ident" id="7636760">err</span>&nbsp;<span class="op" id="7636764">!=</span>&nbsp;<span class="ident" id="7636767">nil</span>&nbsp;<span class="op" id="7636771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636775">t</span><span class="op" id="7636776">.</span><span class="ident" id="7636777">Fatal</span><span class="op" id="7636782">(</span><span class="ident" id="7636783">err</span><span class="op" id="7636786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636793">want</span><span class="op" id="7636797">,</span>&nbsp;<span class="ident" id="7636799">fail</span>&nbsp;<span class="op" id="7636804">:=</span>&nbsp;<span class="num" id="7636807">2</span><span class="op" id="7636808">,</span>&nbsp;<span class="ident" id="7636810">errors</span><span class="op" id="7636816">.</span><span class="ident" id="7636817">New</span><span class="op" id="7636820">(</span><span class="string" id="7636821">&#34;fail&#34;</span><span class="op" id="7636827">)</span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636830">r</span>&nbsp;<span class="op" id="7636832">:=</span>&nbsp;<span class="ident" id="7636835">rows</span><span class="op" id="7636839">.</span><span class="ident" id="7636840">rowsi</span><span class="op" id="7636845">.</span><span class="op" id="7636846">(</span><span class="op" id="7636847">*</span><span class="ident" id="7636848">rowsCursor</span><span class="op" id="7636858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636861">r</span><span class="op" id="7636862">.</span><span class="ident" id="7636863">errPos</span><span class="op" id="7636869">,</span>&nbsp;<span class="ident" id="7636871">r</span><span class="op" id="7636872">.</span><span class="ident" id="7636873">err</span>&nbsp;<span class="op" id="7636877">=</span>&nbsp;<span class="ident" id="7636879">want</span><span class="op" id="7636883">,</span>&nbsp;<span class="ident" id="7636885">fail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636892">got</span>&nbsp;<span class="op" id="7636896">:=</span>&nbsp;<span class="num" id="7636899">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636902">for</span>&nbsp;<span class="ident" id="7636906">rows</span><span class="op" id="7636910">.</span><span class="ident" id="7636911">Next</span><span class="op" id="7636915">(</span><span class="op" id="7636916">)</span>&nbsp;<span class="op" id="7636918">{</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636922">got</span><span class="op" id="7636925">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636932">if</span>&nbsp;<span class="ident" id="7636935">got</span>&nbsp;<span class="op" id="7636939">!=</span>&nbsp;<span class="ident" id="7636942">want</span>&nbsp;<span class="op" id="7636947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7636951">t</span><span class="op" id="7636952">.</span><span class="ident" id="7636953">Errorf</span><span class="op" id="7636959">(</span><span class="string" id="7636960">&#34;got&nbsp;%d&nbsp;rows,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="7636982">,</span>&nbsp;<span class="ident" id="7636984">got</span><span class="op" id="7636987">,</span>&nbsp;<span class="ident" id="7636989">want</span><span class="op" id="7636993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7636996">}</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7636999">if</span>&nbsp;<span class="ident" id="7637002">err</span>&nbsp;<span class="op" id="7637006">:=</span>&nbsp;<span class="ident" id="7637009">rows</span><span class="op" id="7637013">.</span><span class="ident" id="7637014">Err</span><span class="op" id="7637017">(</span><span class="op" id="7637018">)</span><span class="op" id="7637019">;</span>&nbsp;<span class="ident" id="7637021">err</span>&nbsp;<span class="op" id="7637025">!=</span>&nbsp;<span class="ident" id="7637028">fail</span>&nbsp;<span class="op" id="7637033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637037">t</span><span class="op" id="7637038">.</span><span class="ident" id="7637039">Errorf</span><span class="op" id="7637045">(</span><span class="string" id="7637046">&#34;got&nbsp;error&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7637069">,</span>&nbsp;<span class="ident" id="7637071">err</span><span class="op" id="7637074">,</span>&nbsp;<span class="ident" id="7637076">fail</span><span class="op" id="7637080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637086">if</span>&nbsp;<span class="op" id="7637089">!</span><span class="ident" id="7637090">r</span><span class="op" id="7637091">.</span><span class="ident" id="7637092">closed</span>&nbsp;<span class="op" id="7637099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637103">t</span><span class="op" id="7637104">.</span><span class="ident" id="7637105">Errorf</span><span class="op" id="7637111">(</span><span class="string" id="7637112">&#34;r.closed&nbsp;is&nbsp;false,&nbsp;want&nbsp;true&#34;</span><span class="op" id="7637142">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637145">}</span><br>
<span class="lineno"></span><span class="op" id="7637147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7637150">func</span>&nbsp;<span class="ident" id="7637155">TestStmtCloseOrder</span><span class="op" id="7637173">(</span><span class="ident" id="7637174">t</span>&nbsp;<span class="op" id="7637176">*</span><span class="ident" id="7637177">testing</span><span class="op" id="7637184">.</span><span class="ident" id="7637185">T</span><span class="op" id="7637186">)</span>&nbsp;<span class="op" id="7637188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637191">db</span>&nbsp;<span class="op" id="7637194">:=</span>&nbsp;<span class="ident" id="7637197">newTestDB</span><span class="op" id="7637206">(</span><span class="ident" id="7637207">t</span><span class="op" id="7637208">,</span>&nbsp;<span class="string" id="7637210">&#34;people&#34;</span><span class="op" id="7637218">)</span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637221">defer</span>&nbsp;<span class="ident" id="7637227">closeDB</span><span class="op" id="7637234">(</span><span class="ident" id="7637235">t</span><span class="op" id="7637236">,</span>&nbsp;<span class="ident" id="7637238">db</span><span class="op" id="7637240">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637244">db</span><span class="op" id="7637246">.</span><span class="ident" id="7637247">SetMaxIdleConns</span><span class="op" id="7637262">(</span><span class="num" id="7637263">0</span><span class="op" id="7637264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637267">setStrictFakeConnClose</span><span class="op" id="7637289">(</span><span class="ident" id="7637290">t</span><span class="op" id="7637291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637294">defer</span>&nbsp;<span class="ident" id="7637300">setStrictFakeConnClose</span><span class="op" id="7637322">(</span><span class="ident" id="7637323">nil</span><span class="op" id="7637326">)</span><br>
<span class="lineno">1310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637330">_</span><span class="op" id="7637331">,</span>&nbsp;<span class="ident" id="7637333">err</span>&nbsp;<span class="op" id="7637337">:=</span>&nbsp;<span class="ident" id="7637340">db</span><span class="op" id="7637342">.</span><span class="ident" id="7637343">Query</span><span class="op" id="7637348">(</span><span class="string" id="7637349">&#34;SELECT|non_existent|name|&#34;</span><span class="op" id="7637376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637379">if</span>&nbsp;<span class="ident" id="7637382">err</span>&nbsp;<span class="op" id="7637386">==</span>&nbsp;<span class="ident" id="7637389">nil</span>&nbsp;<span class="op" id="7637393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637397">t</span><span class="op" id="7637398">.</span><span class="ident" id="7637399">Fatal</span><span class="op" id="7637404">(</span><span class="string" id="7637405">&#34;Quering&nbsp;non-existent&nbsp;table&nbsp;should&nbsp;fail&#34;</span><span class="op" id="7637445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637448">}</span><br>
<span class="lineno">1315</span><span class="op" id="7637450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7637453">//&nbsp;golang.org/issue/5781</span><br>
<span class="lineno"></span><span class="keyword" id="7637478">func</span>&nbsp;<span class="ident" id="7637483">TestErrBadConnReconnect</span><span class="op" id="7637506">(</span><span class="ident" id="7637507">t</span>&nbsp;<span class="op" id="7637509">*</span><span class="ident" id="7637510">testing</span><span class="op" id="7637517">.</span><span class="ident" id="7637518">T</span><span class="op" id="7637519">)</span>&nbsp;<span class="op" id="7637521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637524">db</span>&nbsp;<span class="op" id="7637527">:=</span>&nbsp;<span class="ident" id="7637530">newTestDB</span><span class="op" id="7637539">(</span><span class="ident" id="7637540">t</span><span class="op" id="7637541">,</span>&nbsp;<span class="string" id="7637543">&#34;foo&#34;</span><span class="op" id="7637548">)</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637551">defer</span>&nbsp;<span class="ident" id="7637557">closeDB</span><span class="op" id="7637564">(</span><span class="ident" id="7637565">t</span><span class="op" id="7637566">,</span>&nbsp;<span class="ident" id="7637568">db</span><span class="op" id="7637570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637573">exec</span><span class="op" id="7637577">(</span><span class="ident" id="7637578">t</span><span class="op" id="7637579">,</span>&nbsp;<span class="ident" id="7637581">db</span><span class="op" id="7637583">,</span>&nbsp;<span class="string" id="7637585">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="7637628">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637632">simulateBadConn</span>&nbsp;<span class="op" id="7637648">:=</span>&nbsp;<span class="keyword" id="7637651">func</span><span class="op" id="7637655">(</span><span class="ident" id="7637656">name</span>&nbsp;<span class="builtintype" id="7637661">string</span><span class="op" id="7637667">,</span>&nbsp;<span class="ident" id="7637669">hook</span>&nbsp;<span class="op" id="7637674">*</span><span class="keyword" id="7637675">func</span><span class="op" id="7637679">(</span><span class="op" id="7637680">)</span>&nbsp;<span class="builtintype" id="7637682">bool</span><span class="op" id="7637686">,</span>&nbsp;<span class="ident" id="7637688">op</span>&nbsp;<span class="keyword" id="7637691">func</span><span class="op" id="7637695">(</span><span class="op" id="7637696">)</span>&nbsp;<span class="builtintype" id="7637698">error</span><span class="op" id="7637703">)</span>&nbsp;<span class="op" id="7637705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637709">broken</span><span class="op" id="7637715">,</span>&nbsp;<span class="ident" id="7637717">retried</span>&nbsp;<span class="op" id="7637725">:=</span>&nbsp;<span class="builtintype" id="7637728">false</span><span class="op" id="7637733">,</span>&nbsp;<span class="builtintype" id="7637735">false</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637743">numOpen</span>&nbsp;<span class="op" id="7637751">:=</span>&nbsp;<span class="ident" id="7637754">db</span><span class="op" id="7637756">.</span><span class="ident" id="7637757">numOpen</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7637768">//&nbsp;simulate&nbsp;a&nbsp;broken&nbsp;connection&nbsp;on&nbsp;the&nbsp;first&nbsp;try</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637819">*</span><span class="ident" id="7637820">hook</span>&nbsp;<span class="op" id="7637825">=</span>&nbsp;<span class="keyword" id="7637827">func</span><span class="op" id="7637831">(</span><span class="op" id="7637832">)</span>&nbsp;<span class="builtintype" id="7637834">bool</span>&nbsp;<span class="op" id="7637839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637844">if</span>&nbsp;<span class="op" id="7637847">!</span><span class="ident" id="7637848">broken</span>&nbsp;<span class="op" id="7637855">{</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637861">broken</span>&nbsp;<span class="op" id="7637868">=</span>&nbsp;<span class="builtintype" id="7637870">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637879">return</span>&nbsp;<span class="builtintype" id="7637886">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637899">retried</span>&nbsp;<span class="op" id="7637907">=</span>&nbsp;<span class="builtintype" id="7637909">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637917">return</span>&nbsp;<span class="builtintype" id="7637924">false</span><br>
<span class="lineno">1335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7637932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637937">if</span>&nbsp;<span class="ident" id="7637940">err</span>&nbsp;<span class="op" id="7637944">:=</span>&nbsp;<span class="ident" id="7637947">op</span><span class="op" id="7637949">(</span><span class="op" id="7637950">)</span><span class="op" id="7637951">;</span>&nbsp;<span class="ident" id="7637953">err</span>&nbsp;<span class="op" id="7637957">!=</span>&nbsp;<span class="ident" id="7637960">nil</span>&nbsp;<span class="op" id="7637964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7637969">t</span><span class="op" id="7637970">.</span><span class="ident" id="7637971">Errorf</span><span class="op" id="7637977">(</span><span class="ident" id="7637978">name</span><span class="op" id="7637982">+</span><span class="string" id="7637983">&#34;:&nbsp;%v&#34;</span><span class="op" id="7637989">,</span>&nbsp;<span class="ident" id="7637991">err</span><span class="op" id="7637994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7637999">return</span><br>
<span class="lineno">1340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7638008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638013">if</span>&nbsp;<span class="op" id="7638016">!</span><span class="ident" id="7638017">broken</span>&nbsp;<span class="op" id="7638024">||</span>&nbsp;<span class="op" id="7638027">!</span><span class="ident" id="7638028">retried</span>&nbsp;<span class="op" id="7638036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638041">t</span><span class="op" id="7638042">.</span><span class="ident" id="7638043">Error</span><span class="op" id="7638048">(</span><span class="ident" id="7638049">name</span>&nbsp;<span class="op" id="7638054">+</span>&nbsp;<span class="string" id="7638056">&#34;:&nbsp;Failed&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="7638096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7638100">}</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7638104">*</span><span class="ident" id="7638105">hook</span>&nbsp;<span class="op" id="7638110">=</span>&nbsp;<span class="ident" id="7638112">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638119">if</span>&nbsp;<span class="ident" id="7638122">numOpen</span>&nbsp;<span class="op" id="7638130">!=</span>&nbsp;<span class="ident" id="7638133">db</span><span class="op" id="7638135">.</span><span class="ident" id="7638136">numOpen</span>&nbsp;<span class="op" id="7638144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638149">t</span><span class="op" id="7638150">.</span><span class="ident" id="7638151">Errorf</span><span class="op" id="7638157">(</span><span class="ident" id="7638158">name</span><span class="op" id="7638162">+</span><span class="string" id="7638163">&#34;:&nbsp;leaked&nbsp;%d&nbsp;connection(s)!&#34;</span><span class="op" id="7638191">,</span>&nbsp;<span class="ident" id="7638193">db</span><span class="op" id="7638195">.</span><span class="ident" id="7638196">numOpen</span><span class="op" id="7638203">-</span><span class="ident" id="7638204">numOpen</span><span class="op" id="7638211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638216">numOpen</span>&nbsp;<span class="op" id="7638224">=</span>&nbsp;<span class="ident" id="7638226">db</span><span class="op" id="7638228">.</span><span class="ident" id="7638229">numOpen</span><br>
<span class="lineno">1350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7638239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7638242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7638246">//&nbsp;db.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638258">dbExec</span>&nbsp;<span class="op" id="7638265">:=</span>&nbsp;<span class="keyword" id="7638268">func</span><span class="op" id="7638272">(</span><span class="op" id="7638273">)</span>&nbsp;<span class="builtintype" id="7638275">error</span>&nbsp;<span class="op" id="7638281">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638285">_</span><span class="op" id="7638286">,</span>&nbsp;<span class="ident" id="7638288">err</span>&nbsp;<span class="op" id="7638292">:=</span>&nbsp;<span class="ident" id="7638295">db</span><span class="op" id="7638297">.</span><span class="ident" id="7638298">Exec</span><span class="op" id="7638302">(</span><span class="string" id="7638303">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="7638334">,</span>&nbsp;<span class="string" id="7638336">&#34;Gordon&#34;</span><span class="op" id="7638344">,</span>&nbsp;<span class="num" id="7638346">3</span><span class="op" id="7638347">,</span>&nbsp;<span class="builtintype" id="7638349">true</span><span class="op" id="7638353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638357">return</span>&nbsp;<span class="ident" id="7638364">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7638369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638372">simulateBadConn</span><span class="op" id="7638387">(</span><span class="string" id="7638388">&#34;db.Exec&nbsp;prepare&#34;</span><span class="op" id="7638405">,</span>&nbsp;<span class="op" id="7638407">&amp;</span><span class="ident" id="7638408">hookPrepareBadConn</span><span class="op" id="7638426">,</span>&nbsp;<span class="ident" id="7638428">dbExec</span><span class="op" id="7638434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638437">simulateBadConn</span><span class="op" id="7638452">(</span><span class="string" id="7638453">&#34;db.Exec&nbsp;exec&#34;</span><span class="op" id="7638467">,</span>&nbsp;<span class="op" id="7638469">&amp;</span><span class="ident" id="7638470">hookExecBadConn</span><span class="op" id="7638485">,</span>&nbsp;<span class="ident" id="7638487">dbExec</span><span class="op" id="7638493">)</span><br>
<span class="lineno">1360</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7638497">//&nbsp;db.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638510">dbQuery</span>&nbsp;<span class="op" id="7638518">:=</span>&nbsp;<span class="keyword" id="7638521">func</span><span class="op" id="7638525">(</span><span class="op" id="7638526">)</span>&nbsp;<span class="builtintype" id="7638528">error</span>&nbsp;<span class="op" id="7638534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638538">rows</span><span class="op" id="7638542">,</span>&nbsp;<span class="ident" id="7638544">err</span>&nbsp;<span class="op" id="7638548">:=</span>&nbsp;<span class="ident" id="7638551">db</span><span class="op" id="7638553">.</span><span class="ident" id="7638554">Query</span><span class="op" id="7638559">(</span><span class="string" id="7638560">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="7638581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638585">if</span>&nbsp;<span class="ident" id="7638588">err</span>&nbsp;<span class="op" id="7638592">==</span>&nbsp;<span class="ident" id="7638595">nil</span>&nbsp;<span class="op" id="7638599">{</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638604">err</span>&nbsp;<span class="op" id="7638608">=</span>&nbsp;<span class="ident" id="7638610">rows</span><span class="op" id="7638614">.</span><span class="ident" id="7638615">Close</span><span class="op" id="7638620">(</span><span class="op" id="7638621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7638625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638629">return</span>&nbsp;<span class="ident" id="7638636">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7638641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638644">simulateBadConn</span><span class="op" id="7638659">(</span><span class="string" id="7638660">&#34;db.Query&nbsp;prepare&#34;</span><span class="op" id="7638678">,</span>&nbsp;<span class="op" id="7638680">&amp;</span><span class="ident" id="7638681">hookPrepareBadConn</span><span class="op" id="7638699">,</span>&nbsp;<span class="ident" id="7638701">dbQuery</span><span class="op" id="7638708">)</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638711">simulateBadConn</span><span class="op" id="7638726">(</span><span class="string" id="7638727">&#34;db.Query&nbsp;query&#34;</span><span class="op" id="7638743">,</span>&nbsp;<span class="op" id="7638745">&amp;</span><span class="ident" id="7638746">hookQueryBadConn</span><span class="op" id="7638762">,</span>&nbsp;<span class="ident" id="7638764">dbQuery</span><span class="op" id="7638771">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7638775">//&nbsp;db.Prepare</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638790">simulateBadConn</span><span class="op" id="7638805">(</span><span class="string" id="7638806">&#34;db.Prepare&#34;</span><span class="op" id="7638818">,</span>&nbsp;<span class="op" id="7638820">&amp;</span><span class="ident" id="7638821">hookPrepareBadConn</span><span class="op" id="7638839">,</span>&nbsp;<span class="keyword" id="7638841">func</span><span class="op" id="7638845">(</span><span class="op" id="7638846">)</span>&nbsp;<span class="builtintype" id="7638848">error</span>&nbsp;<span class="op" id="7638854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638858">stmt</span><span class="op" id="7638862">,</span>&nbsp;<span class="ident" id="7638864">err</span>&nbsp;<span class="op" id="7638868">:=</span>&nbsp;<span class="ident" id="7638871">db</span><span class="op" id="7638873">.</span><span class="ident" id="7638874">Prepare</span><span class="op" id="7638881">(</span><span class="string" id="7638882">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="7638913">)</span><br>
<span class="lineno">1375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638917">if</span>&nbsp;<span class="ident" id="7638920">err</span>&nbsp;<span class="op" id="7638924">!=</span>&nbsp;<span class="ident" id="7638927">nil</span>&nbsp;<span class="op" id="7638931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638936">return</span>&nbsp;<span class="ident" id="7638943">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7638949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7638953">stmt</span><span class="op" id="7638957">.</span><span class="ident" id="7638958">Close</span><span class="op" id="7638963">(</span><span class="op" id="7638964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7638968">return</span>&nbsp;<span class="ident" id="7638975">nil</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7638980">}</span><span class="op" id="7638981">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7638985">//&nbsp;Provide&nbsp;a&nbsp;way&nbsp;to&nbsp;force&nbsp;a&nbsp;re-prepare&nbsp;of&nbsp;a&nbsp;statement&nbsp;on&nbsp;next&nbsp;execution</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7639058">forcePrepare</span>&nbsp;<span class="op" id="7639071">:=</span>&nbsp;<span class="keyword" id="7639074">func</span><span class="op" id="7639078">(</span><span class="ident" id="7639079">stmt</span>&nbsp;<span class="op" id="7639084">*</span><span class="ident" id="7639085">Stmt</span><span class="op" id="7639089">)</span>&nbsp;<span class="op" id="7639091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7639095">stmt</span><span class="op" id="7639099">.</span><span class="ident" id="7639100">css</span>&nbsp;<span class="op" id="7639104">=</span>&nbsp;<span class="ident" id="7639106">nil</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7639111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7639115">//&nbsp;stmt.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7639129">stmt1</span><span class="op" id="7639134">,</span>&nbsp;<span class="ident" id="7639136">err</span>&nbsp;<span class="op" id="7639140">:=</span>&nbsp;<span class="ident" id="7639143">db</span><span class="op" id="7639145">.</span><span class="ident" id="7639146">Prepare</span><span class="op" id="7639153">(</span><span class="string" id="7639154">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="7639185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7639188">if</span>&nbsp;<span class="ident" id="7639191">err</span>&nbsp;<span class="op" id="7639195">!=</span>&nbsp;<span class="ident" id="7639198">nil</span>&nbsp;<span class="op" id="7639202">{</span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7639206">t</span><span class="op" id="7639207">.</span><span class="ident" id="7639208">Fatalf</span><span class="op" id="7639214">(</span><span class="string" id="7639215">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="7639228">,</span>&nbsp;<span class="ident" id="7639230">err</span><span class="op" id="7639233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7639236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7639239">defer</span>&nbsp;<span class="ident" id="7639245">stmt1</span><span class="op" id="7639250">.</span><span class="ident" id="7639251">Close</span><span class="op" id="7639256">(</span><span class="op" id="7639257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7639260">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7639305">forcePrepare</span><span class="op" id="7639317">(</span><span class="ident" id="7639318">stmt1</span><span class="op" id="7639323">)</span><br>
<span class="lineno">1395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7639327">stmtExec</span>&nbsp;<span class="op" id="7639336">:=</span>&nbsp;<span class="keyword" id="7639339">func</span><span class="op" id="7639343">(</span><span class="op" id="7639344">)</span>&nbsp;<span class="builtintype" id="7639346">error</span>&nbsp;<span class="op" id="7639352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7639356">_</span><span class="op" id="7639357">,</span>&nbsp;<span class="ident" id="7639359">err</span>&nbsp;<span class="op" id="7639363">:=</span>&nbsp;<span class="ident" id="7639366">stmt1</span><span class="op" id="7639371">.</span><span class="ident" id="7639372">Exec</span><span class="op" id="7639376">(</span><span class="string" id="7639377">&#34;Gopher&#34;</span><span class="op" id="7639385">,</span>&nbsp;<span class="num" id="7639387">3</span><span class="op" id="7639388">,</span>&nbsp;<span class="builtintype" id="7639390">false</span><span class="op" id="7639395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7639399">return</span>&nbsp;<span class="ident" id="7639406">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7639411">}</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7639414">simulateBadConn</span><span class="op" id="7639429">(</span><span class="string" id="7639430">&#34;stmt.Exec&nbsp;prepare&#34;</span><span class="op" id="7639449">,</span>&nbsp;<span class="op" id="7639451">&amp;</span><span class="ident" id="7639452">hookPrepareBadConn</span><span class="op" id="7639470">,</span>&nbsp;<span class="ident" id="7639472">stmtExec</span><span class="op" id="7639480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7639483">simulateBadConn</span><span class="op" id="7639498">(</span><span class="string" id="7639499">&#34;stmt.Exec&nbsp;exec&#34;</span><span class="op" id="7639515">,</span>&nbsp;<span class="op" id="7639517">&amp;</span><span class="ident" id="7639518">hookExecBadConn</span><span class="op" id="7639533">,</span>&nbsp;<span class="ident" id="7639535">stmtExec</span><span class="op" id="7639543">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7639547">//&nbsp;stmt.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7639562">stmt2</span><span class="op" id="7639567">,</span>&nbsp;<span class="ident" id="7639569">err</span>&nbsp;<span class="op" id="7639573">:=</span>&nbsp;<span class="ident" id="7639576">db</span><span class="op" id="7639578">.</span><span class="ident" id="7639579">Prepare</span><span class="op" id="7639586">(</span><span class="string" id="7639587">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="7639608">)</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7639611">if</span>&nbsp;<span class="ident" id="7639614">err</span>&nbsp;<span class="op" id="7639618">!=</span>&nbsp;<span class="ident" id="7639621">nil</span>&nbsp;<span class="op" id="7639625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7639629">t</span><span class="op" id="7639630">.</span><span class="ident" id="7639631">Fatalf</span><span class="op" id="7639637">(</span><span class="string" id="7639638">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="7639651">,</span>&nbsp;<span class="ident" id="7639653">err</span><span class="op" id="7639656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7639659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7639662">defer</span>&nbsp;<span class="ident" id="7639668">stmt2</span><span class="op" id="7639673">.</span><span class="ident" id="7639674">Close</span><span class="op" id="7639679">(</span><span class="op" id="7639680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7639683">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7639728">forcePrepare</span><span class="op" id="7639740">(</span><span class="ident" id="7639741">stmt2</span><span class="op" id="7639746">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7639750">stmtQuery</span>&nbsp;<span class="op" id="7639760">:=</span>&nbsp;<span class="keyword" id="7639763">func</span><span class="op" id="7639767">(</span><span class="op" id="7639768">)</span>&nbsp;<span class="builtintype" id="7639770">error</span>&nbsp;<span class="op" id="7639776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7639780">rows</span><span class="op" id="7639784">,</span>&nbsp;<span class="ident" id="7639786">err</span>&nbsp;<span class="op" id="7639790">:=</span>&nbsp;<span class="ident" id="7639793">stmt2</span><span class="op" id="7639798">.</span><span class="ident" id="7639799">Query</span><span class="op" id="7639804">(</span><span class="op" id="7639805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7639809">if</span>&nbsp;<span class="ident" id="7639812">err</span>&nbsp;<span class="op" id="7639816">==</span>&nbsp;<span class="ident" id="7639819">nil</span>&nbsp;<span class="op" id="7639823">{</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7639828">err</span>&nbsp;<span class="op" id="7639832">=</span>&nbsp;<span class="ident" id="7639834">rows</span><span class="op" id="7639838">.</span><span class="ident" id="7639839">Close</span><span class="op" id="7639844">(</span><span class="op" id="7639845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7639849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7639853">return</span>&nbsp;<span class="ident" id="7639860">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7639865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7639868">simulateBadConn</span><span class="op" id="7639883">(</span><span class="string" id="7639884">&#34;stmt.Query&nbsp;prepare&#34;</span><span class="op" id="7639904">,</span>&nbsp;<span class="op" id="7639906">&amp;</span><span class="ident" id="7639907">hookPrepareBadConn</span><span class="op" id="7639925">,</span>&nbsp;<span class="ident" id="7639927">stmtQuery</span><span class="op" id="7639936">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7639939">simulateBadConn</span><span class="op" id="7639954">(</span><span class="string" id="7639955">&#34;stmt.Query&nbsp;exec&#34;</span><span class="op" id="7639972">,</span>&nbsp;<span class="op" id="7639974">&amp;</span><span class="ident" id="7639975">hookQueryBadConn</span><span class="op" id="7639991">,</span>&nbsp;<span class="ident" id="7639993">stmtQuery</span><span class="op" id="7640002">)</span><br>
<span class="lineno"></span><span class="op" id="7640004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7640007">type</span>&nbsp;<span class="ident" id="7640012">concurrentTest</span>&nbsp;<span class="keyword" id="7640027">interface</span>&nbsp;<span class="op" id="7640037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7640040">init</span><span class="op" id="7640044">(</span><span class="ident" id="7640045">t</span>&nbsp;<span class="ident" id="7640047">testing</span><span class="op" id="7640054">.</span><span class="ident" id="7640055">TB</span><span class="op" id="7640057">,</span>&nbsp;<span class="ident" id="7640059">db</span>&nbsp;<span class="op" id="7640062">*</span><span class="ident" id="7640063">DB</span><span class="op" id="7640065">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7640068">finish</span><span class="op" id="7640074">(</span><span class="ident" id="7640075">t</span>&nbsp;<span class="ident" id="7640077">testing</span><span class="op" id="7640084">.</span><span class="ident" id="7640085">TB</span><span class="op" id="7640087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7640090">test</span><span class="op" id="7640094">(</span><span class="ident" id="7640095">t</span>&nbsp;<span class="ident" id="7640097">testing</span><span class="op" id="7640104">.</span><span class="ident" id="7640105">TB</span><span class="op" id="7640107">)</span>&nbsp;<span class="builtintype" id="7640109">error</span><br>
<span class="lineno"></span><span class="op" id="7640115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7640118">type</span>&nbsp;<span class="ident" id="7640123">concurrentDBQueryTest</span>&nbsp;<span class="keyword" id="7640145">struct</span>&nbsp;<span class="op" id="7640152">{</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7640155">db</span>&nbsp;<span class="op" id="7640158">*</span><span class="ident" id="7640159">DB</span><br>
<span class="lineno"></span><span class="op" id="7640162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7640165">func</span>&nbsp;<span class="op" id="7640170">(</span><span class="ident" id="7640171">c</span>&nbsp;<span class="op" id="7640173">*</span><span class="ident" id="7640174">concurrentDBQueryTest</span><span class="op" id="7640195">)</span>&nbsp;<span class="ident" id="7640197">init</span><span class="op" id="7640201">(</span><span class="ident" id="7640202">t</span>&nbsp;<span class="ident" id="7640204">testing</span><span class="op" id="7640211">.</span><span class="ident" id="7640212">TB</span><span class="op" id="7640214">,</span>&nbsp;<span class="ident" id="7640216">db</span>&nbsp;<span class="op" id="7640219">*</span><span class="ident" id="7640220">DB</span><span class="op" id="7640222">)</span>&nbsp;<span class="op" id="7640224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7640227">c</span><span class="op" id="7640228">.</span><span class="ident" id="7640229">db</span>&nbsp;<span class="op" id="7640232">=</span>&nbsp;<span class="ident" id="7640234">db</span><br>
<span class="lineno">1435</span><span class="op" id="7640237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7640240">func</span>&nbsp;<span class="op" id="7640245">(</span><span class="ident" id="7640246">c</span>&nbsp;<span class="op" id="7640248">*</span><span class="ident" id="7640249">concurrentDBQueryTest</span><span class="op" id="7640270">)</span>&nbsp;<span class="ident" id="7640272">finish</span><span class="op" id="7640278">(</span><span class="ident" id="7640279">t</span>&nbsp;<span class="ident" id="7640281">testing</span><span class="op" id="7640288">.</span><span class="ident" id="7640289">TB</span><span class="op" id="7640291">)</span>&nbsp;<span class="op" id="7640293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7640296">c</span><span class="op" id="7640297">.</span><span class="ident" id="7640298">db</span>&nbsp;<span class="op" id="7640301">=</span>&nbsp;<span class="ident" id="7640303">nil</span><br>
<span class="lineno"></span><span class="op" id="7640307">}</span><br>
<span class="lineno">1440</span><br>
<span class="lineno"></span><span class="keyword" id="7640310">func</span>&nbsp;<span class="op" id="7640315">(</span><span class="ident" id="7640316">c</span>&nbsp;<span class="op" id="7640318">*</span><span class="ident" id="7640319">concurrentDBQueryTest</span><span class="op" id="7640340">)</span>&nbsp;<span class="ident" id="7640342">test</span><span class="op" id="7640346">(</span><span class="ident" id="7640347">t</span>&nbsp;<span class="ident" id="7640349">testing</span><span class="op" id="7640356">.</span><span class="ident" id="7640357">TB</span><span class="op" id="7640359">)</span>&nbsp;<span class="builtintype" id="7640361">error</span>&nbsp;<span class="op" id="7640367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7640370">rows</span><span class="op" id="7640374">,</span>&nbsp;<span class="ident" id="7640376">err</span>&nbsp;<span class="op" id="7640380">:=</span>&nbsp;<span class="ident" id="7640383">c</span><span class="op" id="7640384">.</span><span class="ident" id="7640385">db</span><span class="op" id="7640387">.</span><span class="ident" id="7640388">Query</span><span class="op" id="7640393">(</span><span class="string" id="7640394">&#34;SELECT|people|name|&#34;</span><span class="op" id="7640415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7640418">if</span>&nbsp;<span class="ident" id="7640421">err</span>&nbsp;<span class="op" id="7640425">!=</span>&nbsp;<span class="ident" id="7640428">nil</span>&nbsp;<span class="op" id="7640432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7640436">t</span><span class="op" id="7640437">.</span><span class="ident" id="7640438">Error</span><span class="op" id="7640443">(</span><span class="ident" id="7640444">err</span><span class="op" id="7640447">)</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7640451">return</span>&nbsp;<span class="ident" id="7640458">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7640463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7640466">var</span>&nbsp;<span class="ident" id="7640470">name</span>&nbsp;<span class="builtintype" id="7640475">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7640483">for</span>&nbsp;<span class="ident" id="7640487">rows</span><span class="op" id="7640491">.</span><span class="ident" id="7640492">Next</span><span class="op" id="7640496">(</span><span class="op" id="7640497">)</span>&nbsp;<span class="op" id="7640499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7640503">rows</span><span class="op" id="7640507">.</span><span class="ident" id="7640508">Scan</span><span class="op" id="7640512">(</span><span class="op" id="7640513">&amp;</span><span class="ident" id="7640514">name</span><span class="op" id="7640518">)</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7640521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7640524">rows</span><span class="op" id="7640528">.</span><span class="ident" id="7640529">Close</span><span class="op" id="7640534">(</span><span class="op" id="7640535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7640538">return</span>&nbsp;<span class="ident" id="7640545">nil</span><br>
<span class="lineno"></span><span class="op" id="7640549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1455</span><span class="keyword" id="7640552">type</span>&nbsp;<span class="ident" id="7640557">concurrentDBExecTest</span>&nbsp;<span class="keyword" id="7640578">struct</span>&nbsp;<span class="op" id="7640585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7640588">db</span>&nbsp;<span class="op" id="7640591">*</span><span class="ident" id="7640592">DB</span><br>
<span class="lineno"></span><span class="op" id="7640595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7640598">func</span>&nbsp;<span class="op" id="7640603">(</span><span class="ident" id="7640604">c</span>&nbsp;<span class="op" id="7640606">*</span><span class="ident" id="7640607">concurrentDBExecTest</span><span class="op" id="7640627">)</span>&nbsp;<span class="ident" id="7640629">init</span><span class="op" id="7640633">(</span><span class="ident" id="7640634">t</span>&nbsp;<span class="ident" id="7640636">testing</span><span class="op" id="7640643">.</span><span class="ident" id="7640644">TB</span><span class="op" id="7640646">,</span>&nbsp;<span class="ident" id="7640648">db</span>&nbsp;<span class="op" id="7640651">*</span><span class="ident" id="7640652">DB</span><span class="op" id="7640654">)</span>&nbsp;<span class="op" id="7640656">{</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7640659">c</span><span class="op" id="7640660">.</span><span class="ident" id="7640661">db</span>&nbsp;<span class="op" id="7640664">=</span>&nbsp;<span class="ident" id="7640666">db</span><br>
<span class="lineno"></span><span class="op" id="7640669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7640672">func</span>&nbsp;<span class="op" id="7640677">(</span><span class="ident" id="7640678">c</span>&nbsp;<span class="op" id="7640680">*</span><span class="ident" id="7640681">concurrentDBExecTest</span><span class="op" id="7640701">)</span>&nbsp;<span class="ident" id="7640703">finish</span><span class="op" id="7640709">(</span><span class="ident" id="7640710">t</span>&nbsp;<span class="ident" id="7640712">testing</span><span class="op" id="7640719">.</span><span class="ident" id="7640720">TB</span><span class="op" id="7640722">)</span>&nbsp;<span class="op" id="7640724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7640727">c</span><span class="op" id="7640728">.</span><span class="ident" id="7640729">db</span>&nbsp;<span class="op" id="7640732">=</span>&nbsp;<span class="ident" id="7640734">nil</span><br>
<span class="lineno">1465</span><span class="op" id="7640738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7640741">func</span>&nbsp;<span class="op" id="7640746">(</span><span class="ident" id="7640747">c</span>&nbsp;<span class="op" id="7640749">*</span><span class="ident" id="7640750">concurrentDBExecTest</span><span class="op" id="7640770">)</span>&nbsp;<span class="ident" id="7640772">test</span><span class="op" id="7640776">(</span><span class="ident" id="7640777">t</span>&nbsp;<span class="ident" id="7640779">testing</span><span class="op" id="7640786">.</span><span class="ident" id="7640787">TB</span><span class="op" id="7640789">)</span>&nbsp;<span class="builtintype" id="7640791">error</span>&nbsp;<span class="op" id="7640797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7640800">_</span><span class="op" id="7640801">,</span>&nbsp;<span class="ident" id="7640803">err</span>&nbsp;<span class="op" id="7640807">:=</span>&nbsp;<span class="ident" id="7640810">c</span><span class="op" id="7640811">.</span><span class="ident" id="7640812">db</span><span class="op" id="7640814">.</span><span class="ident" id="7640815">Exec</span><span class="op" id="7640819">(</span><span class="string" id="7640820">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7640873">,</span>&nbsp;<span class="num" id="7640875">3</span><span class="op" id="7640876">,</span>&nbsp;<span class="ident" id="7640878">chrisBirthday</span><span class="op" id="7640891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7640894">if</span>&nbsp;<span class="ident" id="7640897">err</span>&nbsp;<span class="op" id="7640901">!=</span>&nbsp;<span class="ident" id="7640904">nil</span>&nbsp;<span class="op" id="7640908">{</span><br>
<span class="lineno">1470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7640912">t</span><span class="op" id="7640913">.</span><span class="ident" id="7640914">Error</span><span class="op" id="7640919">(</span><span class="ident" id="7640920">err</span><span class="op" id="7640923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7640927">return</span>&nbsp;<span class="ident" id="7640934">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7640939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7640942">return</span>&nbsp;<span class="ident" id="7640949">nil</span><br>
<span class="lineno"></span><span class="op" id="7640953">}</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span><span class="keyword" id="7640956">type</span>&nbsp;<span class="ident" id="7640961">concurrentStmtQueryTest</span>&nbsp;<span class="keyword" id="7640985">struct</span>&nbsp;<span class="op" id="7640992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7640995">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7641000">*</span><span class="ident" id="7641001">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7641005">stmt</span>&nbsp;<span class="op" id="7641010">*</span><span class="ident" id="7641011">Stmt</span><br>
<span class="lineno"></span><span class="op" id="7641016">}</span><br>
<span class="lineno">1480</span><br>
<span class="lineno"></span><span class="keyword" id="7641019">func</span>&nbsp;<span class="op" id="7641024">(</span><span class="ident" id="7641025">c</span>&nbsp;<span class="op" id="7641027">*</span><span class="ident" id="7641028">concurrentStmtQueryTest</span><span class="op" id="7641051">)</span>&nbsp;<span class="ident" id="7641053">init</span><span class="op" id="7641057">(</span><span class="ident" id="7641058">t</span>&nbsp;<span class="ident" id="7641060">testing</span><span class="op" id="7641067">.</span><span class="ident" id="7641068">TB</span><span class="op" id="7641070">,</span>&nbsp;<span class="ident" id="7641072">db</span>&nbsp;<span class="op" id="7641075">*</span><span class="ident" id="7641076">DB</span><span class="op" id="7641078">)</span>&nbsp;<span class="op" id="7641080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7641083">c</span><span class="op" id="7641084">.</span><span class="ident" id="7641085">db</span>&nbsp;<span class="op" id="7641088">=</span>&nbsp;<span class="ident" id="7641090">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7641094">var</span>&nbsp;<span class="ident" id="7641098">err</span>&nbsp;<span class="builtintype" id="7641102">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7641109">c</span><span class="op" id="7641110">.</span><span class="ident" id="7641111">stmt</span><span class="op" id="7641115">,</span>&nbsp;<span class="ident" id="7641117">err</span>&nbsp;<span class="op" id="7641121">=</span>&nbsp;<span class="ident" id="7641123">db</span><span class="op" id="7641125">.</span><span class="ident" id="7641126">Prepare</span><span class="op" id="7641133">(</span><span class="string" id="7641134">&#34;SELECT|people|name|&#34;</span><span class="op" id="7641155">)</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7641158">if</span>&nbsp;<span class="ident" id="7641161">err</span>&nbsp;<span class="op" id="7641165">!=</span>&nbsp;<span class="ident" id="7641168">nil</span>&nbsp;<span class="op" id="7641172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7641176">t</span><span class="op" id="7641177">.</span><span class="ident" id="7641178">Fatal</span><span class="op" id="7641183">(</span><span class="ident" id="7641184">err</span><span class="op" id="7641187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7641190">}</span><br>
<span class="lineno"></span><span class="op" id="7641192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1490</span><span class="keyword" id="7641195">func</span>&nbsp;<span class="op" id="7641200">(</span><span class="ident" id="7641201">c</span>&nbsp;<span class="op" id="7641203">*</span><span class="ident" id="7641204">concurrentStmtQueryTest</span><span class="op" id="7641227">)</span>&nbsp;<span class="ident" id="7641229">finish</span><span class="op" id="7641235">(</span><span class="ident" id="7641236">t</span>&nbsp;<span class="ident" id="7641238">testing</span><span class="op" id="7641245">.</span><span class="ident" id="7641246">TB</span><span class="op" id="7641248">)</span>&nbsp;<span class="op" id="7641250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7641253">if</span>&nbsp;<span class="ident" id="7641256">c</span><span class="op" id="7641257">.</span><span class="ident" id="7641258">stmt</span>&nbsp;<span class="op" id="7641263">!=</span>&nbsp;<span class="ident" id="7641266">nil</span>&nbsp;<span class="op" id="7641270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7641274">c</span><span class="op" id="7641275">.</span><span class="ident" id="7641276">stmt</span><span class="op" id="7641280">.</span><span class="ident" id="7641281">Close</span><span class="op" id="7641286">(</span><span class="op" id="7641287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7641291">c</span><span class="op" id="7641292">.</span><span class="ident" id="7641293">stmt</span>&nbsp;<span class="op" id="7641298">=</span>&nbsp;<span class="ident" id="7641300">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7641305">}</span><br>
<span class="lineno">1495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7641308">c</span><span class="op" id="7641309">.</span><span class="ident" id="7641310">db</span>&nbsp;<span class="op" id="7641313">=</span>&nbsp;<span class="ident" id="7641315">nil</span><br>
<span class="lineno"></span><span class="op" id="7641319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7641322">func</span>&nbsp;<span class="op" id="7641327">(</span><span class="ident" id="7641328">c</span>&nbsp;<span class="op" id="7641330">*</span><span class="ident" id="7641331">concurrentStmtQueryTest</span><span class="op" id="7641354">)</span>&nbsp;<span class="ident" id="7641356">test</span><span class="op" id="7641360">(</span><span class="ident" id="7641361">t</span>&nbsp;<span class="ident" id="7641363">testing</span><span class="op" id="7641370">.</span><span class="ident" id="7641371">TB</span><span class="op" id="7641373">)</span>&nbsp;<span class="builtintype" id="7641375">error</span>&nbsp;<span class="op" id="7641381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7641384">rows</span><span class="op" id="7641388">,</span>&nbsp;<span class="ident" id="7641390">err</span>&nbsp;<span class="op" id="7641394">:=</span>&nbsp;<span class="ident" id="7641397">c</span><span class="op" id="7641398">.</span><span class="ident" id="7641399">stmt</span><span class="op" id="7641403">.</span><span class="ident" id="7641404">Query</span><span class="op" id="7641409">(</span><span class="op" id="7641410">)</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7641413">if</span>&nbsp;<span class="ident" id="7641416">err</span>&nbsp;<span class="op" id="7641420">!=</span>&nbsp;<span class="ident" id="7641423">nil</span>&nbsp;<span class="op" id="7641427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7641431">t</span><span class="op" id="7641432">.</span><span class="ident" id="7641433">Errorf</span><span class="op" id="7641439">(</span><span class="string" id="7641440">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7641461">,</span>&nbsp;<span class="ident" id="7641463">err</span><span class="op" id="7641466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7641470">return</span>&nbsp;<span class="ident" id="7641477">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7641482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7641486">var</span>&nbsp;<span class="ident" id="7641490">name</span>&nbsp;<span class="builtintype" id="7641495">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7641503">for</span>&nbsp;<span class="ident" id="7641507">rows</span><span class="op" id="7641511">.</span><span class="ident" id="7641512">Next</span><span class="op" id="7641516">(</span><span class="op" id="7641517">)</span>&nbsp;<span class="op" id="7641519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7641523">rows</span><span class="op" id="7641527">.</span><span class="ident" id="7641528">Scan</span><span class="op" id="7641532">(</span><span class="op" id="7641533">&amp;</span><span class="ident" id="7641534">name</span><span class="op" id="7641538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7641541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7641544">rows</span><span class="op" id="7641548">.</span><span class="ident" id="7641549">Close</span><span class="op" id="7641554">(</span><span class="op" id="7641555">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7641558">return</span>&nbsp;<span class="ident" id="7641565">nil</span><br>
<span class="lineno"></span><span class="op" id="7641569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7641572">type</span>&nbsp;<span class="ident" id="7641577">concurrentStmtExecTest</span>&nbsp;<span class="keyword" id="7641600">struct</span>&nbsp;<span class="op" id="7641607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7641610">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7641615">*</span><span class="ident" id="7641616">DB</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7641620">stmt</span>&nbsp;<span class="op" id="7641625">*</span><span class="ident" id="7641626">Stmt</span><br>
<span class="lineno"></span><span class="op" id="7641631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7641634">func</span>&nbsp;<span class="op" id="7641639">(</span><span class="ident" id="7641640">c</span>&nbsp;<span class="op" id="7641642">*</span><span class="ident" id="7641643">concurrentStmtExecTest</span><span class="op" id="7641665">)</span>&nbsp;<span class="ident" id="7641667">init</span><span class="op" id="7641671">(</span><span class="ident" id="7641672">t</span>&nbsp;<span class="ident" id="7641674">testing</span><span class="op" id="7641681">.</span><span class="ident" id="7641682">TB</span><span class="op" id="7641684">,</span>&nbsp;<span class="ident" id="7641686">db</span>&nbsp;<span class="op" id="7641689">*</span><span class="ident" id="7641690">DB</span><span class="op" id="7641692">)</span>&nbsp;<span class="op" id="7641694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7641697">c</span><span class="op" id="7641698">.</span><span class="ident" id="7641699">db</span>&nbsp;<span class="op" id="7641702">=</span>&nbsp;<span class="ident" id="7641704">db</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7641708">var</span>&nbsp;<span class="ident" id="7641712">err</span>&nbsp;<span class="builtintype" id="7641716">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7641723">c</span><span class="op" id="7641724">.</span><span class="ident" id="7641725">stmt</span><span class="op" id="7641729">,</span>&nbsp;<span class="ident" id="7641731">err</span>&nbsp;<span class="op" id="7641735">=</span>&nbsp;<span class="ident" id="7641737">db</span><span class="op" id="7641739">.</span><span class="ident" id="7641740">Prepare</span><span class="op" id="7641747">(</span><span class="string" id="7641748">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7641801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7641804">if</span>&nbsp;<span class="ident" id="7641807">err</span>&nbsp;<span class="op" id="7641811">!=</span>&nbsp;<span class="ident" id="7641814">nil</span>&nbsp;<span class="op" id="7641818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7641822">t</span><span class="op" id="7641823">.</span><span class="ident" id="7641824">Fatal</span><span class="op" id="7641829">(</span><span class="ident" id="7641830">err</span><span class="op" id="7641833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7641836">}</span><br>
<span class="lineno">1525</span><span class="op" id="7641838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7641841">func</span>&nbsp;<span class="op" id="7641846">(</span><span class="ident" id="7641847">c</span>&nbsp;<span class="op" id="7641849">*</span><span class="ident" id="7641850">concurrentStmtExecTest</span><span class="op" id="7641872">)</span>&nbsp;<span class="ident" id="7641874">finish</span><span class="op" id="7641880">(</span><span class="ident" id="7641881">t</span>&nbsp;<span class="ident" id="7641883">testing</span><span class="op" id="7641890">.</span><span class="ident" id="7641891">TB</span><span class="op" id="7641893">)</span>&nbsp;<span class="op" id="7641895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7641898">if</span>&nbsp;<span class="ident" id="7641901">c</span><span class="op" id="7641902">.</span><span class="ident" id="7641903">stmt</span>&nbsp;<span class="op" id="7641908">!=</span>&nbsp;<span class="ident" id="7641911">nil</span>&nbsp;<span class="op" id="7641915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7641919">c</span><span class="op" id="7641920">.</span><span class="ident" id="7641921">stmt</span><span class="op" id="7641925">.</span><span class="ident" id="7641926">Close</span><span class="op" id="7641931">(</span><span class="op" id="7641932">)</span><br>
<span class="lineno">1530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7641936">c</span><span class="op" id="7641937">.</span><span class="ident" id="7641938">stmt</span>&nbsp;<span class="op" id="7641943">=</span>&nbsp;<span class="ident" id="7641945">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7641950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7641953">c</span><span class="op" id="7641954">.</span><span class="ident" id="7641955">db</span>&nbsp;<span class="op" id="7641958">=</span>&nbsp;<span class="ident" id="7641960">nil</span><br>
<span class="lineno"></span><span class="op" id="7641964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1535</span><span class="keyword" id="7641967">func</span>&nbsp;<span class="op" id="7641972">(</span><span class="ident" id="7641973">c</span>&nbsp;<span class="op" id="7641975">*</span><span class="ident" id="7641976">concurrentStmtExecTest</span><span class="op" id="7641998">)</span>&nbsp;<span class="ident" id="7642000">test</span><span class="op" id="7642004">(</span><span class="ident" id="7642005">t</span>&nbsp;<span class="ident" id="7642007">testing</span><span class="op" id="7642014">.</span><span class="ident" id="7642015">TB</span><span class="op" id="7642017">)</span>&nbsp;<span class="builtintype" id="7642019">error</span>&nbsp;<span class="op" id="7642025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642028">_</span><span class="op" id="7642029">,</span>&nbsp;<span class="ident" id="7642031">err</span>&nbsp;<span class="op" id="7642035">:=</span>&nbsp;<span class="ident" id="7642038">c</span><span class="op" id="7642039">.</span><span class="ident" id="7642040">stmt</span><span class="op" id="7642044">.</span><span class="ident" id="7642045">Exec</span><span class="op" id="7642049">(</span><span class="num" id="7642050">3</span><span class="op" id="7642051">,</span>&nbsp;<span class="ident" id="7642053">chrisBirthday</span><span class="op" id="7642066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7642069">if</span>&nbsp;<span class="ident" id="7642072">err</span>&nbsp;<span class="op" id="7642076">!=</span>&nbsp;<span class="ident" id="7642079">nil</span>&nbsp;<span class="op" id="7642083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642087">t</span><span class="op" id="7642088">.</span><span class="ident" id="7642089">Errorf</span><span class="op" id="7642095">(</span><span class="string" id="7642096">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7642116">,</span>&nbsp;<span class="ident" id="7642118">err</span><span class="op" id="7642121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7642125">return</span>&nbsp;<span class="ident" id="7642132">err</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7642137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7642140">return</span>&nbsp;<span class="ident" id="7642147">nil</span><br>
<span class="lineno"></span><span class="op" id="7642151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7642154">type</span>&nbsp;<span class="ident" id="7642159">concurrentTxQueryTest</span>&nbsp;<span class="keyword" id="7642181">struct</span>&nbsp;<span class="op" id="7642188">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642191">db</span>&nbsp;<span class="op" id="7642194">*</span><span class="ident" id="7642195">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642199">tx</span>&nbsp;<span class="op" id="7642202">*</span><span class="ident" id="7642203">Tx</span><br>
<span class="lineno"></span><span class="op" id="7642206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7642209">func</span>&nbsp;<span class="op" id="7642214">(</span><span class="ident" id="7642215">c</span>&nbsp;<span class="op" id="7642217">*</span><span class="ident" id="7642218">concurrentTxQueryTest</span><span class="op" id="7642239">)</span>&nbsp;<span class="ident" id="7642241">init</span><span class="op" id="7642245">(</span><span class="ident" id="7642246">t</span>&nbsp;<span class="ident" id="7642248">testing</span><span class="op" id="7642255">.</span><span class="ident" id="7642256">TB</span><span class="op" id="7642258">,</span>&nbsp;<span class="ident" id="7642260">db</span>&nbsp;<span class="op" id="7642263">*</span><span class="ident" id="7642264">DB</span><span class="op" id="7642266">)</span>&nbsp;<span class="op" id="7642268">{</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642271">c</span><span class="op" id="7642272">.</span><span class="ident" id="7642273">db</span>&nbsp;<span class="op" id="7642276">=</span>&nbsp;<span class="ident" id="7642278">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7642282">var</span>&nbsp;<span class="ident" id="7642286">err</span>&nbsp;<span class="builtintype" id="7642290">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642297">c</span><span class="op" id="7642298">.</span><span class="ident" id="7642299">tx</span><span class="op" id="7642301">,</span>&nbsp;<span class="ident" id="7642303">err</span>&nbsp;<span class="op" id="7642307">=</span>&nbsp;<span class="ident" id="7642309">c</span><span class="op" id="7642310">.</span><span class="ident" id="7642311">db</span><span class="op" id="7642313">.</span><span class="ident" id="7642314">Begin</span><span class="op" id="7642319">(</span><span class="op" id="7642320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7642323">if</span>&nbsp;<span class="ident" id="7642326">err</span>&nbsp;<span class="op" id="7642330">!=</span>&nbsp;<span class="ident" id="7642333">nil</span>&nbsp;<span class="op" id="7642337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642341">t</span><span class="op" id="7642342">.</span><span class="ident" id="7642343">Fatal</span><span class="op" id="7642348">(</span><span class="ident" id="7642349">err</span><span class="op" id="7642352">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7642355">}</span><br>
<span class="lineno"></span><span class="op" id="7642357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7642360">func</span>&nbsp;<span class="op" id="7642365">(</span><span class="ident" id="7642366">c</span>&nbsp;<span class="op" id="7642368">*</span><span class="ident" id="7642369">concurrentTxQueryTest</span><span class="op" id="7642390">)</span>&nbsp;<span class="ident" id="7642392">finish</span><span class="op" id="7642398">(</span><span class="ident" id="7642399">t</span>&nbsp;<span class="ident" id="7642401">testing</span><span class="op" id="7642408">.</span><span class="ident" id="7642409">TB</span><span class="op" id="7642411">)</span>&nbsp;<span class="op" id="7642413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7642416">if</span>&nbsp;<span class="ident" id="7642419">c</span><span class="op" id="7642420">.</span><span class="ident" id="7642421">tx</span>&nbsp;<span class="op" id="7642424">!=</span>&nbsp;<span class="ident" id="7642427">nil</span>&nbsp;<span class="op" id="7642431">{</span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642435">c</span><span class="op" id="7642436">.</span><span class="ident" id="7642437">tx</span><span class="op" id="7642439">.</span><span class="ident" id="7642440">Rollback</span><span class="op" id="7642448">(</span><span class="op" id="7642449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642453">c</span><span class="op" id="7642454">.</span><span class="ident" id="7642455">tx</span>&nbsp;<span class="op" id="7642458">=</span>&nbsp;<span class="ident" id="7642460">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7642465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642468">c</span><span class="op" id="7642469">.</span><span class="ident" id="7642470">db</span>&nbsp;<span class="op" id="7642473">=</span>&nbsp;<span class="ident" id="7642475">nil</span><br>
<span class="lineno"></span><span class="op" id="7642479">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span><span class="keyword" id="7642482">func</span>&nbsp;<span class="op" id="7642487">(</span><span class="ident" id="7642488">c</span>&nbsp;<span class="op" id="7642490">*</span><span class="ident" id="7642491">concurrentTxQueryTest</span><span class="op" id="7642512">)</span>&nbsp;<span class="ident" id="7642514">test</span><span class="op" id="7642518">(</span><span class="ident" id="7642519">t</span>&nbsp;<span class="ident" id="7642521">testing</span><span class="op" id="7642528">.</span><span class="ident" id="7642529">TB</span><span class="op" id="7642531">)</span>&nbsp;<span class="builtintype" id="7642533">error</span>&nbsp;<span class="op" id="7642539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642542">rows</span><span class="op" id="7642546">,</span>&nbsp;<span class="ident" id="7642548">err</span>&nbsp;<span class="op" id="7642552">:=</span>&nbsp;<span class="ident" id="7642555">c</span><span class="op" id="7642556">.</span><span class="ident" id="7642557">db</span><span class="op" id="7642559">.</span><span class="ident" id="7642560">Query</span><span class="op" id="7642565">(</span><span class="string" id="7642566">&#34;SELECT|people|name|&#34;</span><span class="op" id="7642587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7642590">if</span>&nbsp;<span class="ident" id="7642593">err</span>&nbsp;<span class="op" id="7642597">!=</span>&nbsp;<span class="ident" id="7642600">nil</span>&nbsp;<span class="op" id="7642604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642608">t</span><span class="op" id="7642609">.</span><span class="ident" id="7642610">Error</span><span class="op" id="7642615">(</span><span class="ident" id="7642616">err</span><span class="op" id="7642619">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7642623">return</span>&nbsp;<span class="ident" id="7642630">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7642635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7642638">var</span>&nbsp;<span class="ident" id="7642642">name</span>&nbsp;<span class="builtintype" id="7642647">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7642655">for</span>&nbsp;<span class="ident" id="7642659">rows</span><span class="op" id="7642663">.</span><span class="ident" id="7642664">Next</span><span class="op" id="7642668">(</span><span class="op" id="7642669">)</span>&nbsp;<span class="op" id="7642671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642675">rows</span><span class="op" id="7642679">.</span><span class="ident" id="7642680">Scan</span><span class="op" id="7642684">(</span><span class="op" id="7642685">&amp;</span><span class="ident" id="7642686">name</span><span class="op" id="7642690">)</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7642693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642696">rows</span><span class="op" id="7642700">.</span><span class="ident" id="7642701">Close</span><span class="op" id="7642706">(</span><span class="op" id="7642707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7642710">return</span>&nbsp;<span class="ident" id="7642717">nil</span><br>
<span class="lineno"></span><span class="op" id="7642721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1580</span><span class="keyword" id="7642724">type</span>&nbsp;<span class="ident" id="7642729">concurrentTxExecTest</span>&nbsp;<span class="keyword" id="7642750">struct</span>&nbsp;<span class="op" id="7642757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642760">db</span>&nbsp;<span class="op" id="7642763">*</span><span class="ident" id="7642764">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642768">tx</span>&nbsp;<span class="op" id="7642771">*</span><span class="ident" id="7642772">Tx</span><br>
<span class="lineno"></span><span class="op" id="7642775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1585</span><span class="keyword" id="7642778">func</span>&nbsp;<span class="op" id="7642783">(</span><span class="ident" id="7642784">c</span>&nbsp;<span class="op" id="7642786">*</span><span class="ident" id="7642787">concurrentTxExecTest</span><span class="op" id="7642807">)</span>&nbsp;<span class="ident" id="7642809">init</span><span class="op" id="7642813">(</span><span class="ident" id="7642814">t</span>&nbsp;<span class="ident" id="7642816">testing</span><span class="op" id="7642823">.</span><span class="ident" id="7642824">TB</span><span class="op" id="7642826">,</span>&nbsp;<span class="ident" id="7642828">db</span>&nbsp;<span class="op" id="7642831">*</span><span class="ident" id="7642832">DB</span><span class="op" id="7642834">)</span>&nbsp;<span class="op" id="7642836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642839">c</span><span class="op" id="7642840">.</span><span class="ident" id="7642841">db</span>&nbsp;<span class="op" id="7642844">=</span>&nbsp;<span class="ident" id="7642846">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7642850">var</span>&nbsp;<span class="ident" id="7642854">err</span>&nbsp;<span class="builtintype" id="7642858">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642865">c</span><span class="op" id="7642866">.</span><span class="ident" id="7642867">tx</span><span class="op" id="7642869">,</span>&nbsp;<span class="ident" id="7642871">err</span>&nbsp;<span class="op" id="7642875">=</span>&nbsp;<span class="ident" id="7642877">c</span><span class="op" id="7642878">.</span><span class="ident" id="7642879">db</span><span class="op" id="7642881">.</span><span class="ident" id="7642882">Begin</span><span class="op" id="7642887">(</span><span class="op" id="7642888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7642891">if</span>&nbsp;<span class="ident" id="7642894">err</span>&nbsp;<span class="op" id="7642898">!=</span>&nbsp;<span class="ident" id="7642901">nil</span>&nbsp;<span class="op" id="7642905">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7642909">t</span><span class="op" id="7642910">.</span><span class="ident" id="7642911">Fatal</span><span class="op" id="7642916">(</span><span class="ident" id="7642917">err</span><span class="op" id="7642920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7642923">}</span><br>
<span class="lineno"></span><span class="op" id="7642925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7642928">func</span>&nbsp;<span class="op" id="7642933">(</span><span class="ident" id="7642934">c</span>&nbsp;<span class="op" id="7642936">*</span><span class="ident" id="7642937">concurrentTxExecTest</span><span class="op" id="7642957">)</span>&nbsp;<span class="ident" id="7642959">finish</span><span class="op" id="7642965">(</span><span class="ident" id="7642966">t</span>&nbsp;<span class="ident" id="7642968">testing</span><span class="op" id="7642975">.</span><span class="ident" id="7642976">TB</span><span class="op" id="7642978">)</span>&nbsp;<span class="op" id="7642980">{</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7642983">if</span>&nbsp;<span class="ident" id="7642986">c</span><span class="op" id="7642987">.</span><span class="ident" id="7642988">tx</span>&nbsp;<span class="op" id="7642991">!=</span>&nbsp;<span class="ident" id="7642994">nil</span>&nbsp;<span class="op" id="7642998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643002">c</span><span class="op" id="7643003">.</span><span class="ident" id="7643004">tx</span><span class="op" id="7643006">.</span><span class="ident" id="7643007">Rollback</span><span class="op" id="7643015">(</span><span class="op" id="7643016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643020">c</span><span class="op" id="7643021">.</span><span class="ident" id="7643022">tx</span>&nbsp;<span class="op" id="7643025">=</span>&nbsp;<span class="ident" id="7643027">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7643032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643035">c</span><span class="op" id="7643036">.</span><span class="ident" id="7643037">db</span>&nbsp;<span class="op" id="7643040">=</span>&nbsp;<span class="ident" id="7643042">nil</span><br>
<span class="lineno">1600</span><span class="op" id="7643046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7643049">func</span>&nbsp;<span class="op" id="7643054">(</span><span class="ident" id="7643055">c</span>&nbsp;<span class="op" id="7643057">*</span><span class="ident" id="7643058">concurrentTxExecTest</span><span class="op" id="7643078">)</span>&nbsp;<span class="ident" id="7643080">test</span><span class="op" id="7643084">(</span><span class="ident" id="7643085">t</span>&nbsp;<span class="ident" id="7643087">testing</span><span class="op" id="7643094">.</span><span class="ident" id="7643095">TB</span><span class="op" id="7643097">)</span>&nbsp;<span class="builtintype" id="7643099">error</span>&nbsp;<span class="op" id="7643105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643108">_</span><span class="op" id="7643109">,</span>&nbsp;<span class="ident" id="7643111">err</span>&nbsp;<span class="op" id="7643115">:=</span>&nbsp;<span class="ident" id="7643118">c</span><span class="op" id="7643119">.</span><span class="ident" id="7643120">tx</span><span class="op" id="7643122">.</span><span class="ident" id="7643123">Exec</span><span class="op" id="7643127">(</span><span class="string" id="7643128">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7643181">,</span>&nbsp;<span class="num" id="7643183">3</span><span class="op" id="7643184">,</span>&nbsp;<span class="ident" id="7643186">chrisBirthday</span><span class="op" id="7643199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643202">if</span>&nbsp;<span class="ident" id="7643205">err</span>&nbsp;<span class="op" id="7643209">!=</span>&nbsp;<span class="ident" id="7643212">nil</span>&nbsp;<span class="op" id="7643216">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643220">t</span><span class="op" id="7643221">.</span><span class="ident" id="7643222">Error</span><span class="op" id="7643227">(</span><span class="ident" id="7643228">err</span><span class="op" id="7643231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643235">return</span>&nbsp;<span class="ident" id="7643242">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7643247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643250">return</span>&nbsp;<span class="ident" id="7643257">nil</span><br>
<span class="lineno"></span><span class="op" id="7643261">}</span><br>
<span class="lineno">1610</span><br>
<span class="lineno"></span><span class="keyword" id="7643264">type</span>&nbsp;<span class="ident" id="7643269">concurrentTxStmtQueryTest</span>&nbsp;<span class="keyword" id="7643295">struct</span>&nbsp;<span class="op" id="7643302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643305">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7643310">*</span><span class="ident" id="7643311">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643315">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7643320">*</span><span class="ident" id="7643321">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643325">stmt</span>&nbsp;<span class="op" id="7643330">*</span><span class="ident" id="7643331">Stmt</span><br>
<span class="lineno">1615</span><span class="op" id="7643336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7643339">func</span>&nbsp;<span class="op" id="7643344">(</span><span class="ident" id="7643345">c</span>&nbsp;<span class="op" id="7643347">*</span><span class="ident" id="7643348">concurrentTxStmtQueryTest</span><span class="op" id="7643373">)</span>&nbsp;<span class="ident" id="7643375">init</span><span class="op" id="7643379">(</span><span class="ident" id="7643380">t</span>&nbsp;<span class="ident" id="7643382">testing</span><span class="op" id="7643389">.</span><span class="ident" id="7643390">TB</span><span class="op" id="7643392">,</span>&nbsp;<span class="ident" id="7643394">db</span>&nbsp;<span class="op" id="7643397">*</span><span class="ident" id="7643398">DB</span><span class="op" id="7643400">)</span>&nbsp;<span class="op" id="7643402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643405">c</span><span class="op" id="7643406">.</span><span class="ident" id="7643407">db</span>&nbsp;<span class="op" id="7643410">=</span>&nbsp;<span class="ident" id="7643412">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643416">var</span>&nbsp;<span class="ident" id="7643420">err</span>&nbsp;<span class="builtintype" id="7643424">error</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643431">c</span><span class="op" id="7643432">.</span><span class="ident" id="7643433">tx</span><span class="op" id="7643435">,</span>&nbsp;<span class="ident" id="7643437">err</span>&nbsp;<span class="op" id="7643441">=</span>&nbsp;<span class="ident" id="7643443">c</span><span class="op" id="7643444">.</span><span class="ident" id="7643445">db</span><span class="op" id="7643447">.</span><span class="ident" id="7643448">Begin</span><span class="op" id="7643453">(</span><span class="op" id="7643454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643457">if</span>&nbsp;<span class="ident" id="7643460">err</span>&nbsp;<span class="op" id="7643464">!=</span>&nbsp;<span class="ident" id="7643467">nil</span>&nbsp;<span class="op" id="7643471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643475">t</span><span class="op" id="7643476">.</span><span class="ident" id="7643477">Fatal</span><span class="op" id="7643482">(</span><span class="ident" id="7643483">err</span><span class="op" id="7643486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7643489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643492">c</span><span class="op" id="7643493">.</span><span class="ident" id="7643494">stmt</span><span class="op" id="7643498">,</span>&nbsp;<span class="ident" id="7643500">err</span>&nbsp;<span class="op" id="7643504">=</span>&nbsp;<span class="ident" id="7643506">c</span><span class="op" id="7643507">.</span><span class="ident" id="7643508">tx</span><span class="op" id="7643510">.</span><span class="ident" id="7643511">Prepare</span><span class="op" id="7643518">(</span><span class="string" id="7643519">&#34;SELECT|people|name|&#34;</span><span class="op" id="7643540">)</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643543">if</span>&nbsp;<span class="ident" id="7643546">err</span>&nbsp;<span class="op" id="7643550">!=</span>&nbsp;<span class="ident" id="7643553">nil</span>&nbsp;<span class="op" id="7643557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643561">t</span><span class="op" id="7643562">.</span><span class="ident" id="7643563">Fatal</span><span class="op" id="7643568">(</span><span class="ident" id="7643569">err</span><span class="op" id="7643572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7643575">}</span><br>
<span class="lineno"></span><span class="op" id="7643577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1630</span><span class="keyword" id="7643580">func</span>&nbsp;<span class="op" id="7643585">(</span><span class="ident" id="7643586">c</span>&nbsp;<span class="op" id="7643588">*</span><span class="ident" id="7643589">concurrentTxStmtQueryTest</span><span class="op" id="7643614">)</span>&nbsp;<span class="ident" id="7643616">finish</span><span class="op" id="7643622">(</span><span class="ident" id="7643623">t</span>&nbsp;<span class="ident" id="7643625">testing</span><span class="op" id="7643632">.</span><span class="ident" id="7643633">TB</span><span class="op" id="7643635">)</span>&nbsp;<span class="op" id="7643637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643640">if</span>&nbsp;<span class="ident" id="7643643">c</span><span class="op" id="7643644">.</span><span class="ident" id="7643645">stmt</span>&nbsp;<span class="op" id="7643650">!=</span>&nbsp;<span class="ident" id="7643653">nil</span>&nbsp;<span class="op" id="7643657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643661">c</span><span class="op" id="7643662">.</span><span class="ident" id="7643663">stmt</span><span class="op" id="7643667">.</span><span class="ident" id="7643668">Close</span><span class="op" id="7643673">(</span><span class="op" id="7643674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643678">c</span><span class="op" id="7643679">.</span><span class="ident" id="7643680">stmt</span>&nbsp;<span class="op" id="7643685">=</span>&nbsp;<span class="ident" id="7643687">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7643692">}</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643695">if</span>&nbsp;<span class="ident" id="7643698">c</span><span class="op" id="7643699">.</span><span class="ident" id="7643700">tx</span>&nbsp;<span class="op" id="7643703">!=</span>&nbsp;<span class="ident" id="7643706">nil</span>&nbsp;<span class="op" id="7643710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643714">c</span><span class="op" id="7643715">.</span><span class="ident" id="7643716">tx</span><span class="op" id="7643718">.</span><span class="ident" id="7643719">Rollback</span><span class="op" id="7643727">(</span><span class="op" id="7643728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643732">c</span><span class="op" id="7643733">.</span><span class="ident" id="7643734">tx</span>&nbsp;<span class="op" id="7643737">=</span>&nbsp;<span class="ident" id="7643739">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7643744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643747">c</span><span class="op" id="7643748">.</span><span class="ident" id="7643749">db</span>&nbsp;<span class="op" id="7643752">=</span>&nbsp;<span class="ident" id="7643754">nil</span><br>
<span class="lineno">1640</span><span class="op" id="7643758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7643761">func</span>&nbsp;<span class="op" id="7643766">(</span><span class="ident" id="7643767">c</span>&nbsp;<span class="op" id="7643769">*</span><span class="ident" id="7643770">concurrentTxStmtQueryTest</span><span class="op" id="7643795">)</span>&nbsp;<span class="ident" id="7643797">test</span><span class="op" id="7643801">(</span><span class="ident" id="7643802">t</span>&nbsp;<span class="ident" id="7643804">testing</span><span class="op" id="7643811">.</span><span class="ident" id="7643812">TB</span><span class="op" id="7643814">)</span>&nbsp;<span class="builtintype" id="7643816">error</span>&nbsp;<span class="op" id="7643822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643825">rows</span><span class="op" id="7643829">,</span>&nbsp;<span class="ident" id="7643831">err</span>&nbsp;<span class="op" id="7643835">:=</span>&nbsp;<span class="ident" id="7643838">c</span><span class="op" id="7643839">.</span><span class="ident" id="7643840">stmt</span><span class="op" id="7643844">.</span><span class="ident" id="7643845">Query</span><span class="op" id="7643850">(</span><span class="op" id="7643851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643854">if</span>&nbsp;<span class="ident" id="7643857">err</span>&nbsp;<span class="op" id="7643861">!=</span>&nbsp;<span class="ident" id="7643864">nil</span>&nbsp;<span class="op" id="7643868">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643872">t</span><span class="op" id="7643873">.</span><span class="ident" id="7643874">Errorf</span><span class="op" id="7643880">(</span><span class="string" id="7643881">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7643902">,</span>&nbsp;<span class="ident" id="7643904">err</span><span class="op" id="7643907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643911">return</span>&nbsp;<span class="ident" id="7643918">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7643923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643927">var</span>&nbsp;<span class="ident" id="7643931">name</span>&nbsp;<span class="builtintype" id="7643936">string</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643944">for</span>&nbsp;<span class="ident" id="7643948">rows</span><span class="op" id="7643952">.</span><span class="ident" id="7643953">Next</span><span class="op" id="7643957">(</span><span class="op" id="7643958">)</span>&nbsp;<span class="op" id="7643960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643964">rows</span><span class="op" id="7643968">.</span><span class="ident" id="7643969">Scan</span><span class="op" id="7643973">(</span><span class="op" id="7643974">&amp;</span><span class="ident" id="7643975">name</span><span class="op" id="7643979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7643982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7643985">rows</span><span class="op" id="7643989">.</span><span class="ident" id="7643990">Close</span><span class="op" id="7643995">(</span><span class="op" id="7643996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7643999">return</span>&nbsp;<span class="ident" id="7644006">nil</span><br>
<span class="lineno">1655</span><span class="op" id="7644010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7644013">type</span>&nbsp;<span class="ident" id="7644018">concurrentTxStmtExecTest</span>&nbsp;<span class="keyword" id="7644043">struct</span>&nbsp;<span class="op" id="7644050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644053">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7644058">*</span><span class="ident" id="7644059">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644063">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7644068">*</span><span class="ident" id="7644069">Tx</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644073">stmt</span>&nbsp;<span class="op" id="7644078">*</span><span class="ident" id="7644079">Stmt</span><br>
<span class="lineno"></span><span class="op" id="7644084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7644087">func</span>&nbsp;<span class="op" id="7644092">(</span><span class="ident" id="7644093">c</span>&nbsp;<span class="op" id="7644095">*</span><span class="ident" id="7644096">concurrentTxStmtExecTest</span><span class="op" id="7644120">)</span>&nbsp;<span class="ident" id="7644122">init</span><span class="op" id="7644126">(</span><span class="ident" id="7644127">t</span>&nbsp;<span class="ident" id="7644129">testing</span><span class="op" id="7644136">.</span><span class="ident" id="7644137">TB</span><span class="op" id="7644139">,</span>&nbsp;<span class="ident" id="7644141">db</span>&nbsp;<span class="op" id="7644144">*</span><span class="ident" id="7644145">DB</span><span class="op" id="7644147">)</span>&nbsp;<span class="op" id="7644149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644152">c</span><span class="op" id="7644153">.</span><span class="ident" id="7644154">db</span>&nbsp;<span class="op" id="7644157">=</span>&nbsp;<span class="ident" id="7644159">db</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7644163">var</span>&nbsp;<span class="ident" id="7644167">err</span>&nbsp;<span class="builtintype" id="7644171">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644178">c</span><span class="op" id="7644179">.</span><span class="ident" id="7644180">tx</span><span class="op" id="7644182">,</span>&nbsp;<span class="ident" id="7644184">err</span>&nbsp;<span class="op" id="7644188">=</span>&nbsp;<span class="ident" id="7644190">c</span><span class="op" id="7644191">.</span><span class="ident" id="7644192">db</span><span class="op" id="7644194">.</span><span class="ident" id="7644195">Begin</span><span class="op" id="7644200">(</span><span class="op" id="7644201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7644204">if</span>&nbsp;<span class="ident" id="7644207">err</span>&nbsp;<span class="op" id="7644211">!=</span>&nbsp;<span class="ident" id="7644214">nil</span>&nbsp;<span class="op" id="7644218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644222">t</span><span class="op" id="7644223">.</span><span class="ident" id="7644224">Fatal</span><span class="op" id="7644229">(</span><span class="ident" id="7644230">err</span><span class="op" id="7644233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7644236">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644239">c</span><span class="op" id="7644240">.</span><span class="ident" id="7644241">stmt</span><span class="op" id="7644245">,</span>&nbsp;<span class="ident" id="7644247">err</span>&nbsp;<span class="op" id="7644251">=</span>&nbsp;<span class="ident" id="7644253">c</span><span class="op" id="7644254">.</span><span class="ident" id="7644255">tx</span><span class="op" id="7644257">.</span><span class="ident" id="7644258">Prepare</span><span class="op" id="7644265">(</span><span class="string" id="7644266">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="7644319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7644322">if</span>&nbsp;<span class="ident" id="7644325">err</span>&nbsp;<span class="op" id="7644329">!=</span>&nbsp;<span class="ident" id="7644332">nil</span>&nbsp;<span class="op" id="7644336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644340">t</span><span class="op" id="7644341">.</span><span class="ident" id="7644342">Fatal</span><span class="op" id="7644347">(</span><span class="ident" id="7644348">err</span><span class="op" id="7644351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7644354">}</span><br>
<span class="lineno"></span><span class="op" id="7644356">}</span><br>
<span class="lineno">1675</span><br>
<span class="lineno"></span><span class="keyword" id="7644359">func</span>&nbsp;<span class="op" id="7644364">(</span><span class="ident" id="7644365">c</span>&nbsp;<span class="op" id="7644367">*</span><span class="ident" id="7644368">concurrentTxStmtExecTest</span><span class="op" id="7644392">)</span>&nbsp;<span class="ident" id="7644394">finish</span><span class="op" id="7644400">(</span><span class="ident" id="7644401">t</span>&nbsp;<span class="ident" id="7644403">testing</span><span class="op" id="7644410">.</span><span class="ident" id="7644411">TB</span><span class="op" id="7644413">)</span>&nbsp;<span class="op" id="7644415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7644418">if</span>&nbsp;<span class="ident" id="7644421">c</span><span class="op" id="7644422">.</span><span class="ident" id="7644423">stmt</span>&nbsp;<span class="op" id="7644428">!=</span>&nbsp;<span class="ident" id="7644431">nil</span>&nbsp;<span class="op" id="7644435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644439">c</span><span class="op" id="7644440">.</span><span class="ident" id="7644441">stmt</span><span class="op" id="7644445">.</span><span class="ident" id="7644446">Close</span><span class="op" id="7644451">(</span><span class="op" id="7644452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644456">c</span><span class="op" id="7644457">.</span><span class="ident" id="7644458">stmt</span>&nbsp;<span class="op" id="7644463">=</span>&nbsp;<span class="ident" id="7644465">nil</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7644470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7644473">if</span>&nbsp;<span class="ident" id="7644476">c</span><span class="op" id="7644477">.</span><span class="ident" id="7644478">tx</span>&nbsp;<span class="op" id="7644481">!=</span>&nbsp;<span class="ident" id="7644484">nil</span>&nbsp;<span class="op" id="7644488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644492">c</span><span class="op" id="7644493">.</span><span class="ident" id="7644494">tx</span><span class="op" id="7644496">.</span><span class="ident" id="7644497">Rollback</span><span class="op" id="7644505">(</span><span class="op" id="7644506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644510">c</span><span class="op" id="7644511">.</span><span class="ident" id="7644512">tx</span>&nbsp;<span class="op" id="7644515">=</span>&nbsp;<span class="ident" id="7644517">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7644522">}</span><br>
<span class="lineno">1685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644525">c</span><span class="op" id="7644526">.</span><span class="ident" id="7644527">db</span>&nbsp;<span class="op" id="7644530">=</span>&nbsp;<span class="ident" id="7644532">nil</span><br>
<span class="lineno"></span><span class="op" id="7644536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7644539">func</span>&nbsp;<span class="op" id="7644544">(</span><span class="ident" id="7644545">c</span>&nbsp;<span class="op" id="7644547">*</span><span class="ident" id="7644548">concurrentTxStmtExecTest</span><span class="op" id="7644572">)</span>&nbsp;<span class="ident" id="7644574">test</span><span class="op" id="7644578">(</span><span class="ident" id="7644579">t</span>&nbsp;<span class="ident" id="7644581">testing</span><span class="op" id="7644588">.</span><span class="ident" id="7644589">TB</span><span class="op" id="7644591">)</span>&nbsp;<span class="builtintype" id="7644593">error</span>&nbsp;<span class="op" id="7644599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644602">_</span><span class="op" id="7644603">,</span>&nbsp;<span class="ident" id="7644605">err</span>&nbsp;<span class="op" id="7644609">:=</span>&nbsp;<span class="ident" id="7644612">c</span><span class="op" id="7644613">.</span><span class="ident" id="7644614">stmt</span><span class="op" id="7644618">.</span><span class="ident" id="7644619">Exec</span><span class="op" id="7644623">(</span><span class="num" id="7644624">3</span><span class="op" id="7644625">,</span>&nbsp;<span class="ident" id="7644627">chrisBirthday</span><span class="op" id="7644640">)</span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7644643">if</span>&nbsp;<span class="ident" id="7644646">err</span>&nbsp;<span class="op" id="7644650">!=</span>&nbsp;<span class="ident" id="7644653">nil</span>&nbsp;<span class="op" id="7644657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644661">t</span><span class="op" id="7644662">.</span><span class="ident" id="7644663">Errorf</span><span class="op" id="7644669">(</span><span class="string" id="7644670">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7644690">,</span>&nbsp;<span class="ident" id="7644692">err</span><span class="op" id="7644695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7644699">return</span>&nbsp;<span class="ident" id="7644706">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7644711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7644714">return</span>&nbsp;<span class="ident" id="7644721">nil</span><br>
<span class="lineno">1695</span><span class="op" id="7644725">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7644728">type</span>&nbsp;<span class="ident" id="7644733">concurrentRandomTest</span>&nbsp;<span class="keyword" id="7644754">struct</span>&nbsp;<span class="op" id="7644761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644764">tests</span>&nbsp;<span class="op" id="7644770">[</span><span class="op" id="7644771">]</span><span class="ident" id="7644772">concurrentTest</span><br>
<span class="lineno"></span><span class="op" id="7644787">}</span><br>
<span class="lineno">1700</span><br>
<span class="lineno"></span><span class="keyword" id="7644790">func</span>&nbsp;<span class="op" id="7644795">(</span><span class="ident" id="7644796">c</span>&nbsp;<span class="op" id="7644798">*</span><span class="ident" id="7644799">concurrentRandomTest</span><span class="op" id="7644819">)</span>&nbsp;<span class="ident" id="7644821">init</span><span class="op" id="7644825">(</span><span class="ident" id="7644826">t</span>&nbsp;<span class="ident" id="7644828">testing</span><span class="op" id="7644835">.</span><span class="ident" id="7644836">TB</span><span class="op" id="7644838">,</span>&nbsp;<span class="ident" id="7644840">db</span>&nbsp;<span class="op" id="7644843">*</span><span class="ident" id="7644844">DB</span><span class="op" id="7644846">)</span>&nbsp;<span class="op" id="7644848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7644851">c</span><span class="op" id="7644852">.</span><span class="ident" id="7644853">tests</span>&nbsp;<span class="op" id="7644859">=</span>&nbsp;<span class="op" id="7644861">[</span><span class="op" id="7644862">]</span><span class="ident" id="7644863">concurrentTest</span><span class="op" id="7644877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7644881">new</span><span class="op" id="7644884">(</span><span class="ident" id="7644885">concurrentDBQueryTest</span><span class="op" id="7644906">)</span><span class="op" id="7644907">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7644911">new</span><span class="op" id="7644914">(</span><span class="ident" id="7644915">concurrentDBExecTest</span><span class="op" id="7644935">)</span><span class="op" id="7644936">,</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7644940">new</span><span class="op" id="7644943">(</span><span class="ident" id="7644944">concurrentStmtQueryTest</span><span class="op" id="7644967">)</span><span class="op" id="7644968">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7644972">new</span><span class="op" id="7644975">(</span><span class="ident" id="7644976">concurrentStmtExecTest</span><span class="op" id="7644998">)</span><span class="op" id="7644999">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7645003">new</span><span class="op" id="7645006">(</span><span class="ident" id="7645007">concurrentTxQueryTest</span><span class="op" id="7645028">)</span><span class="op" id="7645029">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7645033">new</span><span class="op" id="7645036">(</span><span class="ident" id="7645037">concurrentTxExecTest</span><span class="op" id="7645057">)</span><span class="op" id="7645058">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7645062">new</span><span class="op" id="7645065">(</span><span class="ident" id="7645066">concurrentTxStmtQueryTest</span><span class="op" id="7645091">)</span><span class="op" id="7645092">,</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7645096">new</span><span class="op" id="7645099">(</span><span class="ident" id="7645100">concurrentTxStmtExecTest</span><span class="op" id="7645124">)</span><span class="op" id="7645125">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7645128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7645131">for</span>&nbsp;<span class="ident" id="7645135">_</span><span class="op" id="7645136">,</span>&nbsp;<span class="ident" id="7645138">ct</span>&nbsp;<span class="op" id="7645141">:=</span>&nbsp;<span class="keyword" id="7645144">range</span>&nbsp;<span class="ident" id="7645150">c</span><span class="op" id="7645151">.</span><span class="ident" id="7645152">tests</span>&nbsp;<span class="op" id="7645158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645162">ct</span><span class="op" id="7645164">.</span><span class="ident" id="7645165">init</span><span class="op" id="7645169">(</span><span class="ident" id="7645170">t</span><span class="op" id="7645171">,</span>&nbsp;<span class="ident" id="7645173">db</span><span class="op" id="7645175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7645178">}</span><br>
<span class="lineno">1715</span><span class="op" id="7645180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7645183">func</span>&nbsp;<span class="op" id="7645188">(</span><span class="ident" id="7645189">c</span>&nbsp;<span class="op" id="7645191">*</span><span class="ident" id="7645192">concurrentRandomTest</span><span class="op" id="7645212">)</span>&nbsp;<span class="ident" id="7645214">finish</span><span class="op" id="7645220">(</span><span class="ident" id="7645221">t</span>&nbsp;<span class="ident" id="7645223">testing</span><span class="op" id="7645230">.</span><span class="ident" id="7645231">TB</span><span class="op" id="7645233">)</span>&nbsp;<span class="op" id="7645235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7645238">for</span>&nbsp;<span class="ident" id="7645242">_</span><span class="op" id="7645243">,</span>&nbsp;<span class="ident" id="7645245">ct</span>&nbsp;<span class="op" id="7645248">:=</span>&nbsp;<span class="keyword" id="7645251">range</span>&nbsp;<span class="ident" id="7645257">c</span><span class="op" id="7645258">.</span><span class="ident" id="7645259">tests</span>&nbsp;<span class="op" id="7645265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645269">ct</span><span class="op" id="7645271">.</span><span class="ident" id="7645272">finish</span><span class="op" id="7645278">(</span><span class="ident" id="7645279">t</span><span class="op" id="7645280">)</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7645283">}</span><br>
<span class="lineno"></span><span class="op" id="7645285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7645288">func</span>&nbsp;<span class="op" id="7645293">(</span><span class="ident" id="7645294">c</span>&nbsp;<span class="op" id="7645296">*</span><span class="ident" id="7645297">concurrentRandomTest</span><span class="op" id="7645317">)</span>&nbsp;<span class="ident" id="7645319">test</span><span class="op" id="7645323">(</span><span class="ident" id="7645324">t</span>&nbsp;<span class="ident" id="7645326">testing</span><span class="op" id="7645333">.</span><span class="ident" id="7645334">TB</span><span class="op" id="7645336">)</span>&nbsp;<span class="builtintype" id="7645338">error</span>&nbsp;<span class="op" id="7645344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645347">ct</span>&nbsp;<span class="op" id="7645350">:=</span>&nbsp;<span class="ident" id="7645353">c</span><span class="op" id="7645354">.</span><span class="ident" id="7645355">tests</span><span class="op" id="7645360">[</span><span class="ident" id="7645361">rand</span><span class="op" id="7645365">.</span><span class="ident" id="7645366">Intn</span><span class="op" id="7645370">(</span><span class="builtinfunc" id="7645371">len</span><span class="op" id="7645374">(</span><span class="ident" id="7645375">c</span><span class="op" id="7645376">.</span><span class="ident" id="7645377">tests</span><span class="op" id="7645382">)</span><span class="op" id="7645383">)</span><span class="op" id="7645384">]</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7645387">return</span>&nbsp;<span class="ident" id="7645394">ct</span><span class="op" id="7645396">.</span><span class="ident" id="7645397">test</span><span class="op" id="7645401">(</span><span class="ident" id="7645402">t</span><span class="op" id="7645403">)</span><br>
<span class="lineno"></span><span class="op" id="7645405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7645408">func</span>&nbsp;<span class="ident" id="7645413">doConcurrentTest</span><span class="op" id="7645429">(</span><span class="ident" id="7645430">t</span>&nbsp;<span class="ident" id="7645432">testing</span><span class="op" id="7645439">.</span><span class="ident" id="7645440">TB</span><span class="op" id="7645442">,</span>&nbsp;<span class="ident" id="7645444">ct</span>&nbsp;<span class="ident" id="7645447">concurrentTest</span><span class="op" id="7645461">)</span>&nbsp;<span class="op" id="7645463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645466">maxProcs</span><span class="op" id="7645474">,</span>&nbsp;<span class="ident" id="7645476">numReqs</span>&nbsp;<span class="op" id="7645484">:=</span>&nbsp;<span class="num" id="7645487">1</span><span class="op" id="7645488">,</span>&nbsp;<span class="num" id="7645490">500</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7645495">if</span>&nbsp;<span class="ident" id="7645498">testing</span><span class="op" id="7645505">.</span><span class="ident" id="7645506">Short</span><span class="op" id="7645511">(</span><span class="op" id="7645512">)</span>&nbsp;<span class="op" id="7645514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645518">maxProcs</span><span class="op" id="7645526">,</span>&nbsp;<span class="ident" id="7645528">numReqs</span>&nbsp;<span class="op" id="7645536">=</span>&nbsp;<span class="num" id="7645538">4</span><span class="op" id="7645539">,</span>&nbsp;<span class="num" id="7645541">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7645545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7645548">defer</span>&nbsp;<span class="ident" id="7645554">runtime</span><span class="op" id="7645561">.</span><span class="ident" id="7645562">GOMAXPROCS</span><span class="op" id="7645572">(</span><span class="ident" id="7645573">runtime</span><span class="op" id="7645580">.</span><span class="ident" id="7645581">GOMAXPROCS</span><span class="op" id="7645591">(</span><span class="ident" id="7645592">maxProcs</span><span class="op" id="7645600">)</span><span class="op" id="7645601">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645605">db</span>&nbsp;<span class="op" id="7645608">:=</span>&nbsp;<span class="ident" id="7645611">newTestDB</span><span class="op" id="7645620">(</span><span class="ident" id="7645621">t</span><span class="op" id="7645622">,</span>&nbsp;<span class="string" id="7645624">&#34;people&#34;</span><span class="op" id="7645632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7645635">defer</span>&nbsp;<span class="ident" id="7645641">closeDB</span><span class="op" id="7645648">(</span><span class="ident" id="7645649">t</span><span class="op" id="7645650">,</span>&nbsp;<span class="ident" id="7645652">db</span><span class="op" id="7645654">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645658">ct</span><span class="op" id="7645660">.</span><span class="ident" id="7645661">init</span><span class="op" id="7645665">(</span><span class="ident" id="7645666">t</span><span class="op" id="7645667">,</span>&nbsp;<span class="ident" id="7645669">db</span><span class="op" id="7645671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7645674">defer</span>&nbsp;<span class="ident" id="7645680">ct</span><span class="op" id="7645682">.</span><span class="ident" id="7645683">finish</span><span class="op" id="7645689">(</span><span class="ident" id="7645690">t</span><span class="op" id="7645691">)</span><br>
<span class="lineno">1740</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7645695">var</span>&nbsp;<span class="ident" id="7645699">wg</span>&nbsp;<span class="ident" id="7645702">sync</span><span class="op" id="7645706">.</span><span class="ident" id="7645707">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645718">wg</span><span class="op" id="7645720">.</span><span class="ident" id="7645721">Add</span><span class="op" id="7645724">(</span><span class="ident" id="7645725">numReqs</span><span class="op" id="7645732">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645736">reqs</span>&nbsp;<span class="op" id="7645741">:=</span>&nbsp;<span class="builtinfunc" id="7645744">make</span><span class="op" id="7645748">(</span><span class="keyword" id="7645749">chan</span>&nbsp;<span class="builtintype" id="7645754">bool</span><span class="op" id="7645758">)</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7645761">defer</span>&nbsp;<span class="builtinfunc" id="7645767">close</span><span class="op" id="7645772">(</span><span class="ident" id="7645773">reqs</span><span class="op" id="7645777">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7645781">for</span>&nbsp;<span class="ident" id="7645785">i</span>&nbsp;<span class="op" id="7645787">:=</span>&nbsp;<span class="num" id="7645790">0</span><span class="op" id="7645791">;</span>&nbsp;<span class="ident" id="7645793">i</span>&nbsp;<span class="op" id="7645795">&lt;</span>&nbsp;<span class="ident" id="7645797">maxProcs</span><span class="op" id="7645805">*</span><span class="num" id="7645806">2</span><span class="op" id="7645807">;</span>&nbsp;<span class="ident" id="7645809">i</span><span class="op" id="7645810">++</span>&nbsp;<span class="op" id="7645813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7645817">go</span>&nbsp;<span class="keyword" id="7645820">func</span><span class="op" id="7645824">(</span><span class="op" id="7645825">)</span>&nbsp;<span class="op" id="7645827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7645832">for</span>&nbsp;<span class="keyword" id="7645836">range</span>&nbsp;<span class="ident" id="7645842">reqs</span>&nbsp;<span class="op" id="7645847">{</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645853">err</span>&nbsp;<span class="op" id="7645857">:=</span>&nbsp;<span class="ident" id="7645860">ct</span><span class="op" id="7645862">.</span><span class="ident" id="7645863">test</span><span class="op" id="7645867">(</span><span class="ident" id="7645868">t</span><span class="op" id="7645869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7645875">if</span>&nbsp;<span class="ident" id="7645878">err</span>&nbsp;<span class="op" id="7645882">!=</span>&nbsp;<span class="ident" id="7645885">nil</span>&nbsp;<span class="op" id="7645889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645896">wg</span><span class="op" id="7645898">.</span><span class="ident" id="7645899">Done</span><span class="op" id="7645903">(</span><span class="op" id="7645904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7645911">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7645924">}</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645930">wg</span><span class="op" id="7645932">.</span><span class="ident" id="7645933">Done</span><span class="op" id="7645937">(</span><span class="op" id="7645938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7645943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7645947">}</span><span class="op" id="7645948">(</span><span class="op" id="7645949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7645952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7645956">for</span>&nbsp;<span class="ident" id="7645960">i</span>&nbsp;<span class="op" id="7645962">:=</span>&nbsp;<span class="num" id="7645965">0</span><span class="op" id="7645966">;</span>&nbsp;<span class="ident" id="7645968">i</span>&nbsp;<span class="op" id="7645970">&lt;</span>&nbsp;<span class="ident" id="7645972">numReqs</span><span class="op" id="7645979">;</span>&nbsp;<span class="ident" id="7645981">i</span><span class="op" id="7645982">++</span>&nbsp;<span class="op" id="7645985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7645989">reqs</span>&nbsp;<span class="op" id="7645994">&lt;-</span>&nbsp;<span class="builtintype" id="7645997">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7646003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646007">wg</span><span class="op" id="7646009">.</span><span class="ident" id="7646010">Wait</span><span class="op" id="7646014">(</span><span class="op" id="7646015">)</span><br>
<span class="lineno">1765</span><span class="op" id="7646017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7646020">func</span>&nbsp;<span class="ident" id="7646025">manyConcurrentQueries</span><span class="op" id="7646046">(</span><span class="ident" id="7646047">t</span>&nbsp;<span class="ident" id="7646049">testing</span><span class="op" id="7646056">.</span><span class="ident" id="7646057">TB</span><span class="op" id="7646059">)</span>&nbsp;<span class="op" id="7646061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646064">maxProcs</span><span class="op" id="7646072">,</span>&nbsp;<span class="ident" id="7646074">numReqs</span>&nbsp;<span class="op" id="7646082">:=</span>&nbsp;<span class="num" id="7646085">16</span><span class="op" id="7646087">,</span>&nbsp;<span class="num" id="7646089">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7646094">if</span>&nbsp;<span class="ident" id="7646097">testing</span><span class="op" id="7646104">.</span><span class="ident" id="7646105">Short</span><span class="op" id="7646110">(</span><span class="op" id="7646111">)</span>&nbsp;<span class="op" id="7646113">{</span><br>
<span class="lineno">1770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646117">maxProcs</span><span class="op" id="7646125">,</span>&nbsp;<span class="ident" id="7646127">numReqs</span>&nbsp;<span class="op" id="7646135">=</span>&nbsp;<span class="num" id="7646137">4</span><span class="op" id="7646138">,</span>&nbsp;<span class="num" id="7646140">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7646144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7646147">defer</span>&nbsp;<span class="ident" id="7646153">runtime</span><span class="op" id="7646160">.</span><span class="ident" id="7646161">GOMAXPROCS</span><span class="op" id="7646171">(</span><span class="ident" id="7646172">runtime</span><span class="op" id="7646179">.</span><span class="ident" id="7646180">GOMAXPROCS</span><span class="op" id="7646190">(</span><span class="ident" id="7646191">maxProcs</span><span class="op" id="7646199">)</span><span class="op" id="7646200">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646204">db</span>&nbsp;<span class="op" id="7646207">:=</span>&nbsp;<span class="ident" id="7646210">newTestDB</span><span class="op" id="7646219">(</span><span class="ident" id="7646220">t</span><span class="op" id="7646221">,</span>&nbsp;<span class="string" id="7646223">&#34;people&#34;</span><span class="op" id="7646231">)</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7646234">defer</span>&nbsp;<span class="ident" id="7646240">closeDB</span><span class="op" id="7646247">(</span><span class="ident" id="7646248">t</span><span class="op" id="7646249">,</span>&nbsp;<span class="ident" id="7646251">db</span><span class="op" id="7646253">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646257">stmt</span><span class="op" id="7646261">,</span>&nbsp;<span class="ident" id="7646263">err</span>&nbsp;<span class="op" id="7646267">:=</span>&nbsp;<span class="ident" id="7646270">db</span><span class="op" id="7646272">.</span><span class="ident" id="7646273">Prepare</span><span class="op" id="7646280">(</span><span class="string" id="7646281">&#34;SELECT|people|name|&#34;</span><span class="op" id="7646302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7646305">if</span>&nbsp;<span class="ident" id="7646308">err</span>&nbsp;<span class="op" id="7646312">!=</span>&nbsp;<span class="ident" id="7646315">nil</span>&nbsp;<span class="op" id="7646319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646323">t</span><span class="op" id="7646324">.</span><span class="ident" id="7646325">Fatal</span><span class="op" id="7646330">(</span><span class="ident" id="7646331">err</span><span class="op" id="7646334">)</span><br>
<span class="lineno">1780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7646337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7646340">defer</span>&nbsp;<span class="ident" id="7646346">stmt</span><span class="op" id="7646350">.</span><span class="ident" id="7646351">Close</span><span class="op" id="7646356">(</span><span class="op" id="7646357">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7646361">var</span>&nbsp;<span class="ident" id="7646365">wg</span>&nbsp;<span class="ident" id="7646368">sync</span><span class="op" id="7646372">.</span><span class="ident" id="7646373">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646384">wg</span><span class="op" id="7646386">.</span><span class="ident" id="7646387">Add</span><span class="op" id="7646390">(</span><span class="ident" id="7646391">numReqs</span><span class="op" id="7646398">)</span><br>
<span class="lineno">1785</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646402">reqs</span>&nbsp;<span class="op" id="7646407">:=</span>&nbsp;<span class="builtinfunc" id="7646410">make</span><span class="op" id="7646414">(</span><span class="keyword" id="7646415">chan</span>&nbsp;<span class="builtintype" id="7646420">bool</span><span class="op" id="7646424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7646427">defer</span>&nbsp;<span class="builtinfunc" id="7646433">close</span><span class="op" id="7646438">(</span><span class="ident" id="7646439">reqs</span><span class="op" id="7646443">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7646447">for</span>&nbsp;<span class="ident" id="7646451">i</span>&nbsp;<span class="op" id="7646453">:=</span>&nbsp;<span class="num" id="7646456">0</span><span class="op" id="7646457">;</span>&nbsp;<span class="ident" id="7646459">i</span>&nbsp;<span class="op" id="7646461">&lt;</span>&nbsp;<span class="ident" id="7646463">maxProcs</span><span class="op" id="7646471">*</span><span class="num" id="7646472">2</span><span class="op" id="7646473">;</span>&nbsp;<span class="ident" id="7646475">i</span><span class="op" id="7646476">++</span>&nbsp;<span class="op" id="7646479">{</span><br>
<span class="lineno">1790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7646483">go</span>&nbsp;<span class="keyword" id="7646486">func</span><span class="op" id="7646490">(</span><span class="op" id="7646491">)</span>&nbsp;<span class="op" id="7646493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7646498">for</span>&nbsp;<span class="keyword" id="7646502">range</span>&nbsp;<span class="ident" id="7646508">reqs</span>&nbsp;<span class="op" id="7646513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646519">rows</span><span class="op" id="7646523">,</span>&nbsp;<span class="ident" id="7646525">err</span>&nbsp;<span class="op" id="7646529">:=</span>&nbsp;<span class="ident" id="7646532">stmt</span><span class="op" id="7646536">.</span><span class="ident" id="7646537">Query</span><span class="op" id="7646542">(</span><span class="op" id="7646543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7646549">if</span>&nbsp;<span class="ident" id="7646552">err</span>&nbsp;<span class="op" id="7646556">!=</span>&nbsp;<span class="ident" id="7646559">nil</span>&nbsp;<span class="op" id="7646563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646570">t</span><span class="op" id="7646571">.</span><span class="ident" id="7646572">Errorf</span><span class="op" id="7646578">(</span><span class="string" id="7646579">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="7646600">,</span>&nbsp;<span class="ident" id="7646602">err</span><span class="op" id="7646605">)</span><br>
<span class="lineno">1795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646612">wg</span><span class="op" id="7646614">.</span><span class="ident" id="7646615">Done</span><span class="op" id="7646619">(</span><span class="op" id="7646620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7646627">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7646640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7646647">var</span>&nbsp;<span class="ident" id="7646651">name</span>&nbsp;<span class="builtintype" id="7646656">string</span><br>
<span class="lineno">1800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7646667">for</span>&nbsp;<span class="ident" id="7646671">rows</span><span class="op" id="7646675">.</span><span class="ident" id="7646676">Next</span><span class="op" id="7646680">(</span><span class="op" id="7646681">)</span>&nbsp;<span class="op" id="7646683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646690">rows</span><span class="op" id="7646694">.</span><span class="ident" id="7646695">Scan</span><span class="op" id="7646699">(</span><span class="op" id="7646700">&amp;</span><span class="ident" id="7646701">name</span><span class="op" id="7646705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7646711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646717">rows</span><span class="op" id="7646721">.</span><span class="ident" id="7646722">Close</span><span class="op" id="7646727">(</span><span class="op" id="7646728">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646735">wg</span><span class="op" id="7646737">.</span><span class="ident" id="7646738">Done</span><span class="op" id="7646742">(</span><span class="op" id="7646743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7646748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7646752">}</span><span class="op" id="7646753">(</span><span class="op" id="7646754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7646757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7646761">for</span>&nbsp;<span class="ident" id="7646765">i</span>&nbsp;<span class="op" id="7646767">:=</span>&nbsp;<span class="num" id="7646770">0</span><span class="op" id="7646771">;</span>&nbsp;<span class="ident" id="7646773">i</span>&nbsp;<span class="op" id="7646775">&lt;</span>&nbsp;<span class="ident" id="7646777">numReqs</span><span class="op" id="7646784">;</span>&nbsp;<span class="ident" id="7646786">i</span><span class="op" id="7646787">++</span>&nbsp;<span class="op" id="7646790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646794">reqs</span>&nbsp;<span class="op" id="7646799">&lt;-</span>&nbsp;<span class="builtintype" id="7646802">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7646808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646812">wg</span><span class="op" id="7646814">.</span><span class="ident" id="7646815">Wait</span><span class="op" id="7646819">(</span><span class="op" id="7646820">)</span><br>
<span class="lineno">1815</span><span class="op" id="7646822">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7646825">func</span>&nbsp;<span class="ident" id="7646830">TestIssue6081</span><span class="op" id="7646843">(</span><span class="ident" id="7646844">t</span>&nbsp;<span class="op" id="7646846">*</span><span class="ident" id="7646847">testing</span><span class="op" id="7646854">.</span><span class="ident" id="7646855">T</span><span class="op" id="7646856">)</span>&nbsp;<span class="op" id="7646858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646861">db</span>&nbsp;<span class="op" id="7646864">:=</span>&nbsp;<span class="ident" id="7646867">newTestDB</span><span class="op" id="7646876">(</span><span class="ident" id="7646877">t</span><span class="op" id="7646878">,</span>&nbsp;<span class="string" id="7646880">&#34;people&#34;</span><span class="op" id="7646888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7646891">defer</span>&nbsp;<span class="ident" id="7646897">closeDB</span><span class="op" id="7646904">(</span><span class="ident" id="7646905">t</span><span class="op" id="7646906">,</span>&nbsp;<span class="ident" id="7646908">db</span><span class="op" id="7646910">)</span><br>
<span class="lineno">1820</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646914">drv</span>&nbsp;<span class="op" id="7646918">:=</span>&nbsp;<span class="ident" id="7646921">db</span><span class="op" id="7646923">.</span><span class="ident" id="7646924">driver</span><span class="op" id="7646930">.</span><span class="op" id="7646931">(</span><span class="op" id="7646932">*</span><span class="ident" id="7646933">fakeDriver</span><span class="op" id="7646943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646946">drv</span><span class="op" id="7646949">.</span><span class="ident" id="7646950">mu</span><span class="op" id="7646952">.</span><span class="ident" id="7646953">Lock</span><span class="op" id="7646957">(</span><span class="op" id="7646958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646961">opens0</span>&nbsp;<span class="op" id="7646968">:=</span>&nbsp;<span class="ident" id="7646971">drv</span><span class="op" id="7646974">.</span><span class="ident" id="7646975">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7646986">closes0</span>&nbsp;<span class="op" id="7646994">:=</span>&nbsp;<span class="ident" id="7646997">drv</span><span class="op" id="7647000">.</span><span class="ident" id="7647001">closeCount</span><br>
<span class="lineno">1825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647013">drv</span><span class="op" id="7647016">.</span><span class="ident" id="7647017">mu</span><span class="op" id="7647019">.</span><span class="ident" id="7647020">Unlock</span><span class="op" id="7647026">(</span><span class="op" id="7647027">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647031">stmt</span><span class="op" id="7647035">,</span>&nbsp;<span class="ident" id="7647037">err</span>&nbsp;<span class="op" id="7647041">:=</span>&nbsp;<span class="ident" id="7647044">db</span><span class="op" id="7647046">.</span><span class="ident" id="7647047">Prepare</span><span class="op" id="7647054">(</span><span class="string" id="7647055">&#34;SELECT|people|name|&#34;</span><span class="op" id="7647076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7647079">if</span>&nbsp;<span class="ident" id="7647082">err</span>&nbsp;<span class="op" id="7647086">!=</span>&nbsp;<span class="ident" id="7647089">nil</span>&nbsp;<span class="op" id="7647093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647097">t</span><span class="op" id="7647098">.</span><span class="ident" id="7647099">Fatal</span><span class="op" id="7647104">(</span><span class="ident" id="7647105">err</span><span class="op" id="7647108">)</span><br>
<span class="lineno">1830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7647111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647114">rowsCloseHook</span>&nbsp;<span class="op" id="7647128">=</span>&nbsp;<span class="keyword" id="7647130">func</span><span class="op" id="7647134">(</span><span class="ident" id="7647135">rows</span>&nbsp;<span class="op" id="7647140">*</span><span class="ident" id="7647141">Rows</span><span class="op" id="7647145">,</span>&nbsp;<span class="ident" id="7647147">err</span>&nbsp;<span class="op" id="7647151">*</span><span class="builtintype" id="7647152">error</span><span class="op" id="7647157">)</span>&nbsp;<span class="op" id="7647159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7647163">*</span><span class="ident" id="7647164">err</span>&nbsp;<span class="op" id="7647168">=</span>&nbsp;<span class="ident" id="7647170">driver</span><span class="op" id="7647176">.</span><span class="ident" id="7647177">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7647189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7647192">defer</span>&nbsp;<span class="keyword" id="7647198">func</span><span class="op" id="7647202">(</span><span class="op" id="7647203">)</span>&nbsp;<span class="op" id="7647205">{</span>&nbsp;<span class="ident" id="7647207">rowsCloseHook</span>&nbsp;<span class="op" id="7647221">=</span>&nbsp;<span class="ident" id="7647223">nil</span>&nbsp;<span class="op" id="7647227">}</span><span class="op" id="7647228">(</span><span class="op" id="7647229">)</span><br>
<span class="lineno">1835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7647232">for</span>&nbsp;<span class="ident" id="7647236">i</span>&nbsp;<span class="op" id="7647238">:=</span>&nbsp;<span class="num" id="7647241">0</span><span class="op" id="7647242">;</span>&nbsp;<span class="ident" id="7647244">i</span>&nbsp;<span class="op" id="7647246">&lt;</span>&nbsp;<span class="num" id="7647248">10</span><span class="op" id="7647250">;</span>&nbsp;<span class="ident" id="7647252">i</span><span class="op" id="7647253">++</span>&nbsp;<span class="op" id="7647256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647260">rows</span><span class="op" id="7647264">,</span>&nbsp;<span class="ident" id="7647266">err</span>&nbsp;<span class="op" id="7647270">:=</span>&nbsp;<span class="ident" id="7647273">stmt</span><span class="op" id="7647277">.</span><span class="ident" id="7647278">Query</span><span class="op" id="7647283">(</span><span class="op" id="7647284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7647288">if</span>&nbsp;<span class="ident" id="7647291">err</span>&nbsp;<span class="op" id="7647295">!=</span>&nbsp;<span class="ident" id="7647298">nil</span>&nbsp;<span class="op" id="7647302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647307">t</span><span class="op" id="7647308">.</span><span class="ident" id="7647309">Fatal</span><span class="op" id="7647314">(</span><span class="ident" id="7647315">err</span><span class="op" id="7647318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7647322">}</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647326">rows</span><span class="op" id="7647330">.</span><span class="ident" id="7647331">Close</span><span class="op" id="7647336">(</span><span class="op" id="7647337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7647340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7647343">if</span>&nbsp;<span class="ident" id="7647346">n</span>&nbsp;<span class="op" id="7647348">:=</span>&nbsp;<span class="builtinfunc" id="7647351">len</span><span class="op" id="7647354">(</span><span class="ident" id="7647355">stmt</span><span class="op" id="7647359">.</span><span class="ident" id="7647360">css</span><span class="op" id="7647363">)</span><span class="op" id="7647364">;</span>&nbsp;<span class="ident" id="7647366">n</span>&nbsp;<span class="op" id="7647368">&gt;</span>&nbsp;<span class="num" id="7647370">1</span>&nbsp;<span class="op" id="7647372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647376">t</span><span class="op" id="7647377">.</span><span class="ident" id="7647378">Errorf</span><span class="op" id="7647384">(</span><span class="string" id="7647385">&#34;len(css&nbsp;slice)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="7647417">,</span>&nbsp;<span class="ident" id="7647419">n</span><span class="op" id="7647420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7647423">}</span><br>
<span class="lineno">1845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647426">stmt</span><span class="op" id="7647430">.</span><span class="ident" id="7647431">Close</span><span class="op" id="7647436">(</span><span class="op" id="7647437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7647440">if</span>&nbsp;<span class="ident" id="7647443">n</span>&nbsp;<span class="op" id="7647445">:=</span>&nbsp;<span class="builtinfunc" id="7647448">len</span><span class="op" id="7647451">(</span><span class="ident" id="7647452">stmt</span><span class="op" id="7647456">.</span><span class="ident" id="7647457">css</span><span class="op" id="7647460">)</span><span class="op" id="7647461">;</span>&nbsp;<span class="ident" id="7647463">n</span>&nbsp;<span class="op" id="7647465">!=</span>&nbsp;<span class="num" id="7647468">0</span>&nbsp;<span class="op" id="7647470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647474">t</span><span class="op" id="7647475">.</span><span class="ident" id="7647476">Errorf</span><span class="op" id="7647482">(</span><span class="string" id="7647483">&#34;len(css&nbsp;slice)&nbsp;after&nbsp;Close&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="7647524">,</span>&nbsp;<span class="ident" id="7647526">n</span><span class="op" id="7647527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7647530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647534">drv</span><span class="op" id="7647537">.</span><span class="ident" id="7647538">mu</span><span class="op" id="7647540">.</span><span class="ident" id="7647541">Lock</span><span class="op" id="7647545">(</span><span class="op" id="7647546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647549">opens</span>&nbsp;<span class="op" id="7647555">:=</span>&nbsp;<span class="ident" id="7647558">drv</span><span class="op" id="7647561">.</span><span class="ident" id="7647562">openCount</span>&nbsp;<span class="op" id="7647572">-</span>&nbsp;<span class="ident" id="7647574">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647582">closes</span>&nbsp;<span class="op" id="7647589">:=</span>&nbsp;<span class="ident" id="7647592">drv</span><span class="op" id="7647595">.</span><span class="ident" id="7647596">closeCount</span>&nbsp;<span class="op" id="7647607">-</span>&nbsp;<span class="ident" id="7647609">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647618">drv</span><span class="op" id="7647621">.</span><span class="ident" id="7647622">mu</span><span class="op" id="7647624">.</span><span class="ident" id="7647625">Unlock</span><span class="op" id="7647631">(</span><span class="op" id="7647632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7647635">if</span>&nbsp;<span class="ident" id="7647638">opens</span>&nbsp;<span class="op" id="7647644">&lt;</span>&nbsp;<span class="num" id="7647646">9</span>&nbsp;<span class="op" id="7647648">{</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647652">t</span><span class="op" id="7647653">.</span><span class="ident" id="7647654">Errorf</span><span class="op" id="7647660">(</span><span class="string" id="7647661">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="7647684">,</span>&nbsp;<span class="ident" id="7647686">opens</span><span class="op" id="7647691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7647694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7647697">if</span>&nbsp;<span class="ident" id="7647700">closes</span>&nbsp;<span class="op" id="7647707">&lt;</span>&nbsp;<span class="num" id="7647709">9</span>&nbsp;<span class="op" id="7647711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647715">t</span><span class="op" id="7647716">.</span><span class="ident" id="7647717">Errorf</span><span class="op" id="7647723">(</span><span class="string" id="7647724">&#34;closes&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="7647748">,</span>&nbsp;<span class="ident" id="7647750">closes</span><span class="op" id="7647756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7647759">}</span><br>
<span class="lineno">1860</span><span class="op" id="7647761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7647764">func</span>&nbsp;<span class="ident" id="7647769">TestConcurrency</span><span class="op" id="7647784">(</span><span class="ident" id="7647785">t</span>&nbsp;<span class="op" id="7647787">*</span><span class="ident" id="7647788">testing</span><span class="op" id="7647795">.</span><span class="ident" id="7647796">T</span><span class="op" id="7647797">)</span>&nbsp;<span class="op" id="7647799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647802">doConcurrentTest</span><span class="op" id="7647818">(</span><span class="ident" id="7647819">t</span><span class="op" id="7647820">,</span>&nbsp;<span class="builtinfunc" id="7647822">new</span><span class="op" id="7647825">(</span><span class="ident" id="7647826">concurrentDBQueryTest</span><span class="op" id="7647847">)</span><span class="op" id="7647848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647851">doConcurrentTest</span><span class="op" id="7647867">(</span><span class="ident" id="7647868">t</span><span class="op" id="7647869">,</span>&nbsp;<span class="builtinfunc" id="7647871">new</span><span class="op" id="7647874">(</span><span class="ident" id="7647875">concurrentDBExecTest</span><span class="op" id="7647895">)</span><span class="op" id="7647896">)</span><br>
<span class="lineno">1865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647899">doConcurrentTest</span><span class="op" id="7647915">(</span><span class="ident" id="7647916">t</span><span class="op" id="7647917">,</span>&nbsp;<span class="builtinfunc" id="7647919">new</span><span class="op" id="7647922">(</span><span class="ident" id="7647923">concurrentStmtQueryTest</span><span class="op" id="7647946">)</span><span class="op" id="7647947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7647950">doConcurrentTest</span><span class="op" id="7647966">(</span><span class="ident" id="7647967">t</span><span class="op" id="7647968">,</span>&nbsp;<span class="builtinfunc" id="7647970">new</span><span class="op" id="7647973">(</span><span class="ident" id="7647974">concurrentStmtExecTest</span><span class="op" id="7647996">)</span><span class="op" id="7647997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648000">doConcurrentTest</span><span class="op" id="7648016">(</span><span class="ident" id="7648017">t</span><span class="op" id="7648018">,</span>&nbsp;<span class="builtinfunc" id="7648020">new</span><span class="op" id="7648023">(</span><span class="ident" id="7648024">concurrentTxQueryTest</span><span class="op" id="7648045">)</span><span class="op" id="7648046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648049">doConcurrentTest</span><span class="op" id="7648065">(</span><span class="ident" id="7648066">t</span><span class="op" id="7648067">,</span>&nbsp;<span class="builtinfunc" id="7648069">new</span><span class="op" id="7648072">(</span><span class="ident" id="7648073">concurrentTxExecTest</span><span class="op" id="7648093">)</span><span class="op" id="7648094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648097">doConcurrentTest</span><span class="op" id="7648113">(</span><span class="ident" id="7648114">t</span><span class="op" id="7648115">,</span>&nbsp;<span class="builtinfunc" id="7648117">new</span><span class="op" id="7648120">(</span><span class="ident" id="7648121">concurrentTxStmtQueryTest</span><span class="op" id="7648146">)</span><span class="op" id="7648147">)</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648150">doConcurrentTest</span><span class="op" id="7648166">(</span><span class="ident" id="7648167">t</span><span class="op" id="7648168">,</span>&nbsp;<span class="builtinfunc" id="7648170">new</span><span class="op" id="7648173">(</span><span class="ident" id="7648174">concurrentTxStmtExecTest</span><span class="op" id="7648198">)</span><span class="op" id="7648199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648202">doConcurrentTest</span><span class="op" id="7648218">(</span><span class="ident" id="7648219">t</span><span class="op" id="7648220">,</span>&nbsp;<span class="builtinfunc" id="7648222">new</span><span class="op" id="7648225">(</span><span class="ident" id="7648226">concurrentRandomTest</span><span class="op" id="7648246">)</span><span class="op" id="7648247">)</span><br>
<span class="lineno"></span><span class="op" id="7648249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7648252">func</span>&nbsp;<span class="ident" id="7648257">TestConnectionLeak</span><span class="op" id="7648275">(</span><span class="ident" id="7648276">t</span>&nbsp;<span class="op" id="7648278">*</span><span class="ident" id="7648279">testing</span><span class="op" id="7648286">.</span><span class="ident" id="7648287">T</span><span class="op" id="7648288">)</span>&nbsp;<span class="op" id="7648290">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648293">db</span>&nbsp;<span class="op" id="7648296">:=</span>&nbsp;<span class="ident" id="7648299">newTestDB</span><span class="op" id="7648308">(</span><span class="ident" id="7648309">t</span><span class="op" id="7648310">,</span>&nbsp;<span class="string" id="7648312">&#34;people&#34;</span><span class="op" id="7648320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7648323">defer</span>&nbsp;<span class="ident" id="7648329">closeDB</span><span class="op" id="7648336">(</span><span class="ident" id="7648337">t</span><span class="op" id="7648338">,</span>&nbsp;<span class="ident" id="7648340">db</span><span class="op" id="7648342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7648345">//&nbsp;Start&nbsp;by&nbsp;opening&nbsp;defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648386">rows</span>&nbsp;<span class="op" id="7648391">:=</span>&nbsp;<span class="builtinfunc" id="7648394">make</span><span class="op" id="7648398">(</span><span class="op" id="7648399">[</span><span class="op" id="7648400">]</span><span class="op" id="7648401">*</span><span class="ident" id="7648402">Rows</span><span class="op" id="7648406">,</span>&nbsp;<span class="ident" id="7648408">defaultMaxIdleConns</span><span class="op" id="7648427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7648430">//&nbsp;We&nbsp;need&nbsp;to&nbsp;SetMaxOpenConns&nbsp;&gt;&nbsp;MaxIdleConns,&nbsp;so&nbsp;the&nbsp;DB&nbsp;can&nbsp;open</span><br>
<span class="lineno">1880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7648496">//&nbsp;a&nbsp;new&nbsp;connection&nbsp;and&nbsp;we&nbsp;can&nbsp;fill&nbsp;the&nbsp;idle&nbsp;queue&nbsp;with&nbsp;the&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7648566">//&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648583">db</span><span class="op" id="7648585">.</span><span class="ident" id="7648586">SetMaxOpenConns</span><span class="op" id="7648601">(</span><span class="builtinfunc" id="7648602">len</span><span class="op" id="7648605">(</span><span class="ident" id="7648606">rows</span><span class="op" id="7648610">)</span>&nbsp;<span class="op" id="7648612">+</span>&nbsp;<span class="num" id="7648614">1</span><span class="op" id="7648615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7648618">for</span>&nbsp;<span class="ident" id="7648622">ii</span>&nbsp;<span class="op" id="7648625">:=</span>&nbsp;<span class="keyword" id="7648628">range</span>&nbsp;<span class="ident" id="7648634">rows</span>&nbsp;<span class="op" id="7648639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648643">r</span><span class="op" id="7648644">,</span>&nbsp;<span class="ident" id="7648646">err</span>&nbsp;<span class="op" id="7648650">:=</span>&nbsp;<span class="ident" id="7648653">db</span><span class="op" id="7648655">.</span><span class="ident" id="7648656">Query</span><span class="op" id="7648661">(</span><span class="string" id="7648662">&#34;SELECT|people|name|&#34;</span><span class="op" id="7648683">)</span><br>
<span class="lineno">1885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7648687">if</span>&nbsp;<span class="ident" id="7648690">err</span>&nbsp;<span class="op" id="7648694">!=</span>&nbsp;<span class="ident" id="7648697">nil</span>&nbsp;<span class="op" id="7648701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648706">t</span><span class="op" id="7648707">.</span><span class="ident" id="7648708">Fatal</span><span class="op" id="7648713">(</span><span class="ident" id="7648714">err</span><span class="op" id="7648717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7648721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648725">r</span><span class="op" id="7648726">.</span><span class="ident" id="7648727">Next</span><span class="op" id="7648731">(</span><span class="op" id="7648732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7648736">if</span>&nbsp;<span class="ident" id="7648739">err</span>&nbsp;<span class="op" id="7648743">:=</span>&nbsp;<span class="ident" id="7648746">r</span><span class="op" id="7648747">.</span><span class="ident" id="7648748">Err</span><span class="op" id="7648751">(</span><span class="op" id="7648752">)</span><span class="op" id="7648753">;</span>&nbsp;<span class="ident" id="7648755">err</span>&nbsp;<span class="op" id="7648759">!=</span>&nbsp;<span class="ident" id="7648762">nil</span>&nbsp;<span class="op" id="7648766">{</span><br>
<span class="lineno">1890</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648771">t</span><span class="op" id="7648772">.</span><span class="ident" id="7648773">Fatal</span><span class="op" id="7648778">(</span><span class="ident" id="7648779">err</span><span class="op" id="7648782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7648786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648790">rows</span><span class="op" id="7648794">[</span><span class="ident" id="7648795">ii</span><span class="op" id="7648797">]</span>&nbsp;<span class="op" id="7648799">=</span>&nbsp;<span class="ident" id="7648801">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7648804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7648807">//&nbsp;Now&nbsp;we&nbsp;have&nbsp;defaultMaxIdleConns&nbsp;busy&nbsp;connections.&nbsp;Open</span><br>
<span class="lineno">1895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7648866">//&nbsp;a&nbsp;new&nbsp;one,&nbsp;but&nbsp;wait&nbsp;until&nbsp;the&nbsp;busy&nbsp;connections&nbsp;are&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7648930">//&nbsp;before&nbsp;returning&nbsp;control&nbsp;to&nbsp;DB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648966">drv</span>&nbsp;<span class="op" id="7648970">:=</span>&nbsp;<span class="ident" id="7648973">db</span><span class="op" id="7648975">.</span><span class="ident" id="7648976">driver</span><span class="op" id="7648982">.</span><span class="op" id="7648983">(</span><span class="op" id="7648984">*</span><span class="ident" id="7648985">fakeDriver</span><span class="op" id="7648995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7648998">drv</span><span class="op" id="7649001">.</span><span class="ident" id="7649002">waitCh</span>&nbsp;<span class="op" id="7649009">=</span>&nbsp;<span class="builtinfunc" id="7649011">make</span><span class="op" id="7649015">(</span><span class="keyword" id="7649016">chan</span>&nbsp;<span class="keyword" id="7649021">struct</span><span class="op" id="7649027">{</span><span class="op" id="7649028">}</span><span class="op" id="7649029">,</span>&nbsp;<span class="num" id="7649031">1</span><span class="op" id="7649032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649035">drv</span><span class="op" id="7649038">.</span><span class="ident" id="7649039">waitingCh</span>&nbsp;<span class="op" id="7649049">=</span>&nbsp;<span class="builtinfunc" id="7649051">make</span><span class="op" id="7649055">(</span><span class="keyword" id="7649056">chan</span>&nbsp;<span class="keyword" id="7649061">struct</span><span class="op" id="7649067">{</span><span class="op" id="7649068">}</span><span class="op" id="7649069">,</span>&nbsp;<span class="num" id="7649071">1</span><span class="op" id="7649072">)</span><br>
<span class="lineno">1900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7649075">var</span>&nbsp;<span class="ident" id="7649079">wg</span>&nbsp;<span class="ident" id="7649082">sync</span><span class="op" id="7649086">.</span><span class="ident" id="7649087">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649098">wg</span><span class="op" id="7649100">.</span><span class="ident" id="7649101">Add</span><span class="op" id="7649104">(</span><span class="num" id="7649105">1</span><span class="op" id="7649106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7649109">go</span>&nbsp;<span class="keyword" id="7649112">func</span><span class="op" id="7649116">(</span><span class="op" id="7649117">)</span>&nbsp;<span class="op" id="7649119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649123">r</span><span class="op" id="7649124">,</span>&nbsp;<span class="ident" id="7649126">err</span>&nbsp;<span class="op" id="7649130">:=</span>&nbsp;<span class="ident" id="7649133">db</span><span class="op" id="7649135">.</span><span class="ident" id="7649136">Query</span><span class="op" id="7649141">(</span><span class="string" id="7649142">&#34;SELECT|people|name|&#34;</span><span class="op" id="7649163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7649167">if</span>&nbsp;<span class="ident" id="7649170">err</span>&nbsp;<span class="op" id="7649174">!=</span>&nbsp;<span class="ident" id="7649177">nil</span>&nbsp;<span class="op" id="7649181">{</span><br>
<span class="lineno">1905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649186">t</span><span class="op" id="7649187">.</span><span class="ident" id="7649188">Fatal</span><span class="op" id="7649193">(</span><span class="ident" id="7649194">err</span><span class="op" id="7649197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649205">r</span><span class="op" id="7649206">.</span><span class="ident" id="7649207">Close</span><span class="op" id="7649212">(</span><span class="op" id="7649213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649217">wg</span><span class="op" id="7649219">.</span><span class="ident" id="7649220">Done</span><span class="op" id="7649224">(</span><span class="op" id="7649225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649228">}</span><span class="op" id="7649229">(</span><span class="op" id="7649230">)</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7649233">//&nbsp;Wait&nbsp;until&nbsp;the&nbsp;goroutine&nbsp;we&#39;ve&nbsp;just&nbsp;created&nbsp;has&nbsp;started&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649302">&lt;-</span><span class="ident" id="7649304">drv</span><span class="op" id="7649307">.</span><span class="ident" id="7649308">waitingCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7649319">//&nbsp;Now&nbsp;close&nbsp;the&nbsp;busy&nbsp;connections.&nbsp;This&nbsp;provides&nbsp;a&nbsp;connection&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7649386">//&nbsp;the&nbsp;blocked&nbsp;goroutine&nbsp;and&nbsp;then&nbsp;fills&nbsp;up&nbsp;the&nbsp;idle&nbsp;queue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7649446">for</span>&nbsp;<span class="ident" id="7649450">_</span><span class="op" id="7649451">,</span>&nbsp;<span class="ident" id="7649453">v</span>&nbsp;<span class="op" id="7649455">:=</span>&nbsp;<span class="keyword" id="7649458">range</span>&nbsp;<span class="ident" id="7649464">rows</span>&nbsp;<span class="op" id="7649469">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649473">v</span><span class="op" id="7649474">.</span><span class="ident" id="7649475">Close</span><span class="op" id="7649480">(</span><span class="op" id="7649481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7649487">//&nbsp;At&nbsp;this&nbsp;point&nbsp;we&nbsp;give&nbsp;the&nbsp;new&nbsp;connection&nbsp;to&nbsp;DB.&nbsp;This&nbsp;connection&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7649558">//&nbsp;now&nbsp;useless,&nbsp;since&nbsp;the&nbsp;idle&nbsp;queue&nbsp;is&nbsp;full&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7649629">//&nbsp;requests.&nbsp;DB&nbsp;should&nbsp;deal&nbsp;with&nbsp;this&nbsp;situation&nbsp;without&nbsp;leaking&nbsp;the</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7649698">//&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649714">drv</span><span class="op" id="7649717">.</span><span class="ident" id="7649718">waitCh</span>&nbsp;<span class="op" id="7649725">&lt;-</span>&nbsp;<span class="keyword" id="7649728">struct</span><span class="op" id="7649734">{</span><span class="op" id="7649735">}</span><span class="op" id="7649736">{</span><span class="op" id="7649737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649740">wg</span><span class="op" id="7649742">.</span><span class="ident" id="7649743">Wait</span><span class="op" id="7649747">(</span><span class="op" id="7649748">)</span><br>
<span class="lineno"></span><span class="op" id="7649750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1925</span><span class="keyword" id="7649753">func</span>&nbsp;<span class="ident" id="7649758">BenchmarkConcurrentDBExec</span><span class="op" id="7649783">(</span><span class="ident" id="7649784">b</span>&nbsp;<span class="op" id="7649786">*</span><span class="ident" id="7649787">testing</span><span class="op" id="7649794">.</span><span class="ident" id="7649795">B</span><span class="op" id="7649796">)</span>&nbsp;<span class="op" id="7649798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649801">b</span><span class="op" id="7649802">.</span><span class="ident" id="7649803">ReportAllocs</span><span class="op" id="7649815">(</span><span class="op" id="7649816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649819">ct</span>&nbsp;<span class="op" id="7649822">:=</span>&nbsp;<span class="builtinfunc" id="7649825">new</span><span class="op" id="7649828">(</span><span class="ident" id="7649829">concurrentDBExecTest</span><span class="op" id="7649849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7649852">for</span>&nbsp;<span class="ident" id="7649856">i</span>&nbsp;<span class="op" id="7649858">:=</span>&nbsp;<span class="num" id="7649861">0</span><span class="op" id="7649862">;</span>&nbsp;<span class="ident" id="7649864">i</span>&nbsp;<span class="op" id="7649866">&lt;</span>&nbsp;<span class="ident" id="7649868">b</span><span class="op" id="7649869">.</span><span class="ident" id="7649870">N</span><span class="op" id="7649871">;</span>&nbsp;<span class="ident" id="7649873">i</span><span class="op" id="7649874">++</span>&nbsp;<span class="op" id="7649877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649881">doConcurrentTest</span><span class="op" id="7649897">(</span><span class="ident" id="7649898">b</span><span class="op" id="7649899">,</span>&nbsp;<span class="ident" id="7649901">ct</span><span class="op" id="7649903">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7649906">}</span><br>
<span class="lineno"></span><span class="op" id="7649908">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7649911">func</span>&nbsp;<span class="ident" id="7649916">BenchmarkConcurrentStmtQuery</span><span class="op" id="7649944">(</span><span class="ident" id="7649945">b</span>&nbsp;<span class="op" id="7649947">*</span><span class="ident" id="7649948">testing</span><span class="op" id="7649955">.</span><span class="ident" id="7649956">B</span><span class="op" id="7649957">)</span>&nbsp;<span class="op" id="7649959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649962">b</span><span class="op" id="7649963">.</span><span class="ident" id="7649964">ReportAllocs</span><span class="op" id="7649976">(</span><span class="op" id="7649977">)</span><br>
<span class="lineno">1935</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7649980">ct</span>&nbsp;<span class="op" id="7649983">:=</span>&nbsp;<span class="builtinfunc" id="7649986">new</span><span class="op" id="7649989">(</span><span class="ident" id="7649990">concurrentStmtQueryTest</span><span class="op" id="7650013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650016">for</span>&nbsp;<span class="ident" id="7650020">i</span>&nbsp;<span class="op" id="7650022">:=</span>&nbsp;<span class="num" id="7650025">0</span><span class="op" id="7650026">;</span>&nbsp;<span class="ident" id="7650028">i</span>&nbsp;<span class="op" id="7650030">&lt;</span>&nbsp;<span class="ident" id="7650032">b</span><span class="op" id="7650033">.</span><span class="ident" id="7650034">N</span><span class="op" id="7650035">;</span>&nbsp;<span class="ident" id="7650037">i</span><span class="op" id="7650038">++</span>&nbsp;<span class="op" id="7650041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650045">doConcurrentTest</span><span class="op" id="7650061">(</span><span class="ident" id="7650062">b</span><span class="op" id="7650063">,</span>&nbsp;<span class="ident" id="7650065">ct</span><span class="op" id="7650067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650070">}</span><br>
<span class="lineno"></span><span class="op" id="7650072">}</span><br>
<span class="lineno">1940</span><br>
<span class="lineno"></span><span class="keyword" id="7650075">func</span>&nbsp;<span class="ident" id="7650080">BenchmarkConcurrentStmtExec</span><span class="op" id="7650107">(</span><span class="ident" id="7650108">b</span>&nbsp;<span class="op" id="7650110">*</span><span class="ident" id="7650111">testing</span><span class="op" id="7650118">.</span><span class="ident" id="7650119">B</span><span class="op" id="7650120">)</span>&nbsp;<span class="op" id="7650122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650125">b</span><span class="op" id="7650126">.</span><span class="ident" id="7650127">ReportAllocs</span><span class="op" id="7650139">(</span><span class="op" id="7650140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650143">ct</span>&nbsp;<span class="op" id="7650146">:=</span>&nbsp;<span class="builtinfunc" id="7650149">new</span><span class="op" id="7650152">(</span><span class="ident" id="7650153">concurrentStmtExecTest</span><span class="op" id="7650175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650178">for</span>&nbsp;<span class="ident" id="7650182">i</span>&nbsp;<span class="op" id="7650184">:=</span>&nbsp;<span class="num" id="7650187">0</span><span class="op" id="7650188">;</span>&nbsp;<span class="ident" id="7650190">i</span>&nbsp;<span class="op" id="7650192">&lt;</span>&nbsp;<span class="ident" id="7650194">b</span><span class="op" id="7650195">.</span><span class="ident" id="7650196">N</span><span class="op" id="7650197">;</span>&nbsp;<span class="ident" id="7650199">i</span><span class="op" id="7650200">++</span>&nbsp;<span class="op" id="7650203">{</span><br>
<span class="lineno">1945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650207">doConcurrentTest</span><span class="op" id="7650223">(</span><span class="ident" id="7650224">b</span><span class="op" id="7650225">,</span>&nbsp;<span class="ident" id="7650227">ct</span><span class="op" id="7650229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650232">}</span><br>
<span class="lineno"></span><span class="op" id="7650234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7650237">func</span>&nbsp;<span class="ident" id="7650242">BenchmarkConcurrentTxQuery</span><span class="op" id="7650268">(</span><span class="ident" id="7650269">b</span>&nbsp;<span class="op" id="7650271">*</span><span class="ident" id="7650272">testing</span><span class="op" id="7650279">.</span><span class="ident" id="7650280">B</span><span class="op" id="7650281">)</span>&nbsp;<span class="op" id="7650283">{</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650286">b</span><span class="op" id="7650287">.</span><span class="ident" id="7650288">ReportAllocs</span><span class="op" id="7650300">(</span><span class="op" id="7650301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650304">ct</span>&nbsp;<span class="op" id="7650307">:=</span>&nbsp;<span class="builtinfunc" id="7650310">new</span><span class="op" id="7650313">(</span><span class="ident" id="7650314">concurrentTxQueryTest</span><span class="op" id="7650335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650338">for</span>&nbsp;<span class="ident" id="7650342">i</span>&nbsp;<span class="op" id="7650344">:=</span>&nbsp;<span class="num" id="7650347">0</span><span class="op" id="7650348">;</span>&nbsp;<span class="ident" id="7650350">i</span>&nbsp;<span class="op" id="7650352">&lt;</span>&nbsp;<span class="ident" id="7650354">b</span><span class="op" id="7650355">.</span><span class="ident" id="7650356">N</span><span class="op" id="7650357">;</span>&nbsp;<span class="ident" id="7650359">i</span><span class="op" id="7650360">++</span>&nbsp;<span class="op" id="7650363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650367">doConcurrentTest</span><span class="op" id="7650383">(</span><span class="ident" id="7650384">b</span><span class="op" id="7650385">,</span>&nbsp;<span class="ident" id="7650387">ct</span><span class="op" id="7650389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650392">}</span><br>
<span class="lineno">1955</span><span class="op" id="7650394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7650397">func</span>&nbsp;<span class="ident" id="7650402">BenchmarkConcurrentTxExec</span><span class="op" id="7650427">(</span><span class="ident" id="7650428">b</span>&nbsp;<span class="op" id="7650430">*</span><span class="ident" id="7650431">testing</span><span class="op" id="7650438">.</span><span class="ident" id="7650439">B</span><span class="op" id="7650440">)</span>&nbsp;<span class="op" id="7650442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650445">b</span><span class="op" id="7650446">.</span><span class="ident" id="7650447">ReportAllocs</span><span class="op" id="7650459">(</span><span class="op" id="7650460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650463">ct</span>&nbsp;<span class="op" id="7650466">:=</span>&nbsp;<span class="builtinfunc" id="7650469">new</span><span class="op" id="7650472">(</span><span class="ident" id="7650473">concurrentTxExecTest</span><span class="op" id="7650493">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650496">for</span>&nbsp;<span class="ident" id="7650500">i</span>&nbsp;<span class="op" id="7650502">:=</span>&nbsp;<span class="num" id="7650505">0</span><span class="op" id="7650506">;</span>&nbsp;<span class="ident" id="7650508">i</span>&nbsp;<span class="op" id="7650510">&lt;</span>&nbsp;<span class="ident" id="7650512">b</span><span class="op" id="7650513">.</span><span class="ident" id="7650514">N</span><span class="op" id="7650515">;</span>&nbsp;<span class="ident" id="7650517">i</span><span class="op" id="7650518">++</span>&nbsp;<span class="op" id="7650521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650525">doConcurrentTest</span><span class="op" id="7650541">(</span><span class="ident" id="7650542">b</span><span class="op" id="7650543">,</span>&nbsp;<span class="ident" id="7650545">ct</span><span class="op" id="7650547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650550">}</span><br>
<span class="lineno"></span><span class="op" id="7650552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1965</span><span class="keyword" id="7650555">func</span>&nbsp;<span class="ident" id="7650560">BenchmarkConcurrentTxStmtQuery</span><span class="op" id="7650590">(</span><span class="ident" id="7650591">b</span>&nbsp;<span class="op" id="7650593">*</span><span class="ident" id="7650594">testing</span><span class="op" id="7650601">.</span><span class="ident" id="7650602">B</span><span class="op" id="7650603">)</span>&nbsp;<span class="op" id="7650605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650608">b</span><span class="op" id="7650609">.</span><span class="ident" id="7650610">ReportAllocs</span><span class="op" id="7650622">(</span><span class="op" id="7650623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650626">ct</span>&nbsp;<span class="op" id="7650629">:=</span>&nbsp;<span class="builtinfunc" id="7650632">new</span><span class="op" id="7650635">(</span><span class="ident" id="7650636">concurrentTxStmtQueryTest</span><span class="op" id="7650661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650664">for</span>&nbsp;<span class="ident" id="7650668">i</span>&nbsp;<span class="op" id="7650670">:=</span>&nbsp;<span class="num" id="7650673">0</span><span class="op" id="7650674">;</span>&nbsp;<span class="ident" id="7650676">i</span>&nbsp;<span class="op" id="7650678">&lt;</span>&nbsp;<span class="ident" id="7650680">b</span><span class="op" id="7650681">.</span><span class="ident" id="7650682">N</span><span class="op" id="7650683">;</span>&nbsp;<span class="ident" id="7650685">i</span><span class="op" id="7650686">++</span>&nbsp;<span class="op" id="7650689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650693">doConcurrentTest</span><span class="op" id="7650709">(</span><span class="ident" id="7650710">b</span><span class="op" id="7650711">,</span>&nbsp;<span class="ident" id="7650713">ct</span><span class="op" id="7650715">)</span><br>
<span class="lineno">1970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650718">}</span><br>
<span class="lineno"></span><span class="op" id="7650720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7650723">func</span>&nbsp;<span class="ident" id="7650728">BenchmarkConcurrentTxStmtExec</span><span class="op" id="7650757">(</span><span class="ident" id="7650758">b</span>&nbsp;<span class="op" id="7650760">*</span><span class="ident" id="7650761">testing</span><span class="op" id="7650768">.</span><span class="ident" id="7650769">B</span><span class="op" id="7650770">)</span>&nbsp;<span class="op" id="7650772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650775">b</span><span class="op" id="7650776">.</span><span class="ident" id="7650777">ReportAllocs</span><span class="op" id="7650789">(</span><span class="op" id="7650790">)</span><br>
<span class="lineno">1975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650793">ct</span>&nbsp;<span class="op" id="7650796">:=</span>&nbsp;<span class="builtinfunc" id="7650799">new</span><span class="op" id="7650802">(</span><span class="ident" id="7650803">concurrentTxStmtExecTest</span><span class="op" id="7650827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650830">for</span>&nbsp;<span class="ident" id="7650834">i</span>&nbsp;<span class="op" id="7650836">:=</span>&nbsp;<span class="num" id="7650839">0</span><span class="op" id="7650840">;</span>&nbsp;<span class="ident" id="7650842">i</span>&nbsp;<span class="op" id="7650844">&lt;</span>&nbsp;<span class="ident" id="7650846">b</span><span class="op" id="7650847">.</span><span class="ident" id="7650848">N</span><span class="op" id="7650849">;</span>&nbsp;<span class="ident" id="7650851">i</span><span class="op" id="7650852">++</span>&nbsp;<span class="op" id="7650855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650859">doConcurrentTest</span><span class="op" id="7650875">(</span><span class="ident" id="7650876">b</span><span class="op" id="7650877">,</span>&nbsp;<span class="ident" id="7650879">ct</span><span class="op" id="7650881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7650884">}</span><br>
<span class="lineno"></span><span class="op" id="7650886">}</span><br>
<span class="lineno">1980</span><br>
<span class="lineno"></span><span class="keyword" id="7650889">func</span>&nbsp;<span class="ident" id="7650894">BenchmarkConcurrentRandom</span><span class="op" id="7650919">(</span><span class="ident" id="7650920">b</span>&nbsp;<span class="op" id="7650922">*</span><span class="ident" id="7650923">testing</span><span class="op" id="7650930">.</span><span class="ident" id="7650931">B</span><span class="op" id="7650932">)</span>&nbsp;<span class="op" id="7650934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650937">b</span><span class="op" id="7650938">.</span><span class="ident" id="7650939">ReportAllocs</span><span class="op" id="7650951">(</span><span class="op" id="7650952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7650955">ct</span>&nbsp;<span class="op" id="7650958">:=</span>&nbsp;<span class="builtinfunc" id="7650961">new</span><span class="op" id="7650964">(</span><span class="ident" id="7650965">concurrentRandomTest</span><span class="op" id="7650985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7650988">for</span>&nbsp;<span class="ident" id="7650992">i</span>&nbsp;<span class="op" id="7650994">:=</span>&nbsp;<span class="num" id="7650997">0</span><span class="op" id="7650998">;</span>&nbsp;<span class="ident" id="7651000">i</span>&nbsp;<span class="op" id="7651002">&lt;</span>&nbsp;<span class="ident" id="7651004">b</span><span class="op" id="7651005">.</span><span class="ident" id="7651006">N</span><span class="op" id="7651007">;</span>&nbsp;<span class="ident" id="7651009">i</span><span class="op" id="7651010">++</span>&nbsp;<span class="op" id="7651013">{</span><br>
<span class="lineno">1985</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7651017">doConcurrentTest</span><span class="op" id="7651033">(</span><span class="ident" id="7651034">b</span><span class="op" id="7651035">,</span>&nbsp;<span class="ident" id="7651037">ct</span><span class="op" id="7651039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7651042">}</span><br>
<span class="lineno"></span><span class="op" id="7651044">}</span>
</div>
</body>
</html>
