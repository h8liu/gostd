<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html" class="current">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4105156">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4105212">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4105266">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4105317">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4105395">package</span>&nbsp;<span class="ident" id="4105403">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4105408">import</span>&nbsp;<span class="op" id="4105415">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4105418">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4105429">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4105436">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4105439">//&nbsp;BUG(mikio):&nbsp;On&nbsp;every&nbsp;POSIX&nbsp;platform,&nbsp;reads&nbsp;from&nbsp;the&nbsp;&#34;ip4&#34;&nbsp;network</span><br>
<span class="lineno">15</span><span class="comment" id="4105508">//&nbsp;using&nbsp;the&nbsp;ReadFrom&nbsp;or&nbsp;ReadFromIP&nbsp;method&nbsp;might&nbsp;not&nbsp;return&nbsp;a&nbsp;complete</span><br>
<span class="lineno"></span><span class="comment" id="4105579">//&nbsp;IPv4&nbsp;packet,&nbsp;including&nbsp;its&nbsp;header,&nbsp;even&nbsp;if&nbsp;there&nbsp;is&nbsp;space</span><br>
<span class="lineno"></span><span class="comment" id="4105640">//&nbsp;available.&nbsp;This&nbsp;can&nbsp;occur&nbsp;even&nbsp;in&nbsp;cases&nbsp;where&nbsp;Read&nbsp;or&nbsp;ReadMsgIP</span><br>
<span class="lineno"></span><span class="comment" id="4105707">//&nbsp;could&nbsp;return&nbsp;a&nbsp;complete&nbsp;packet.&nbsp;For&nbsp;this&nbsp;reason,&nbsp;it&nbsp;is&nbsp;recommended</span><br>
<span class="lineno"></span><span class="comment" id="4105777">//&nbsp;that&nbsp;you&nbsp;do&nbsp;not&nbsp;uses&nbsp;these&nbsp;methods&nbsp;if&nbsp;it&nbsp;is&nbsp;important&nbsp;to&nbsp;receive&nbsp;a</span><br>
<span class="lineno">20</span><span class="comment" id="4105847">//&nbsp;full&nbsp;packet.</span><br>
<span class="lineno"></span><span class="comment" id="4105863">//</span><br>
<span class="lineno"></span><span class="comment" id="4105866">//&nbsp;The&nbsp;Go&nbsp;1&nbsp;compatibility&nbsp;guidelines&nbsp;make&nbsp;it&nbsp;impossible&nbsp;for&nbsp;us&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4105932">//&nbsp;change&nbsp;the&nbsp;behavior&nbsp;of&nbsp;these&nbsp;methods;&nbsp;use&nbsp;Read&nbsp;or&nbsp;ReadMsgIP</span><br>
<span class="lineno"></span><span class="comment" id="4105995">//&nbsp;instead.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="4106008">func</span>&nbsp;<span class="ident" id="4106013">sockaddrToIP</span><span class="op" id="4106025">(</span><span class="ident" id="4106026">sa</span>&nbsp;<span class="ident" id="4106029">syscall</span><span class="op" id="4106036">.</span><span class="ident" id="4106037">Sockaddr</span><span class="op" id="4106045">)</span>&nbsp;<span class="ident" id="4106047">Addr</span>&nbsp;<span class="op" id="4106052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106055">switch</span>&nbsp;<span class="ident" id="4106062">sa</span>&nbsp;<span class="op" id="4106065">:=</span>&nbsp;<span class="ident" id="4106068">sa</span><span class="op" id="4106070">.</span><span class="op" id="4106071">(</span><span class="keyword" id="4106072">type</span><span class="op" id="4106076">)</span>&nbsp;<span class="op" id="4106078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106081">case</span>&nbsp;<span class="op" id="4106086">*</span><span class="ident" id="4106087">syscall</span><span class="op" id="4106094">.</span><span class="ident" id="4106095">SockaddrInet4</span><span class="op" id="4106108">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106112">return</span>&nbsp;<span class="op" id="4106119">&amp;</span><span class="ident" id="4106120">IPAddr</span><span class="op" id="4106126">{</span><span class="ident" id="4106127">IP</span><span class="op" id="4106129">:</span>&nbsp;<span class="ident" id="4106131">sa</span><span class="op" id="4106133">.</span><span class="ident" id="4106134">Addr</span><span class="op" id="4106138">[</span><span class="num" id="4106139">0</span><span class="op" id="4106140">:</span><span class="op" id="4106141">]</span><span class="op" id="4106142">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106145">case</span>&nbsp;<span class="op" id="4106150">*</span><span class="ident" id="4106151">syscall</span><span class="op" id="4106158">.</span><span class="ident" id="4106159">SockaddrInet6</span><span class="op" id="4106172">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106176">return</span>&nbsp;<span class="op" id="4106183">&amp;</span><span class="ident" id="4106184">IPAddr</span><span class="op" id="4106190">{</span><span class="ident" id="4106191">IP</span><span class="op" id="4106193">:</span>&nbsp;<span class="ident" id="4106195">sa</span><span class="op" id="4106197">.</span><span class="ident" id="4106198">Addr</span><span class="op" id="4106202">[</span><span class="num" id="4106203">0</span><span class="op" id="4106204">:</span><span class="op" id="4106205">]</span><span class="op" id="4106206">,</span>&nbsp;<span class="ident" id="4106208">Zone</span><span class="op" id="4106212">:</span>&nbsp;<span class="ident" id="4106214">zoneToString</span><span class="op" id="4106226">(</span><span class="builtintype" id="4106227">int</span><span class="op" id="4106230">(</span><span class="ident" id="4106231">sa</span><span class="op" id="4106233">.</span><span class="ident" id="4106234">ZoneId</span><span class="op" id="4106240">)</span><span class="op" id="4106241">)</span><span class="op" id="4106242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4106245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106248">return</span>&nbsp;<span class="ident" id="4106255">nil</span><br>
<span class="lineno"></span><span class="op" id="4106259">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="4106262">func</span>&nbsp;<span class="op" id="4106267">(</span><span class="ident" id="4106268">a</span>&nbsp;<span class="op" id="4106270">*</span><span class="ident" id="4106271">IPAddr</span><span class="op" id="4106277">)</span>&nbsp;<span class="ident" id="4106279">family</span><span class="op" id="4106285">(</span><span class="op" id="4106286">)</span>&nbsp;<span class="builtintype" id="4106288">int</span>&nbsp;<span class="op" id="4106292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106295">if</span>&nbsp;<span class="ident" id="4106298">a</span>&nbsp;<span class="op" id="4106300">==</span>&nbsp;<span class="ident" id="4106303">nil</span>&nbsp;<span class="op" id="4106307">||</span>&nbsp;<span class="builtinfunc" id="4106310">len</span><span class="op" id="4106313">(</span><span class="ident" id="4106314">a</span><span class="op" id="4106315">.</span><span class="ident" id="4106316">IP</span><span class="op" id="4106318">)</span>&nbsp;<span class="op" id="4106320">&lt;=</span>&nbsp;<span class="ident" id="4106323">IPv4len</span>&nbsp;<span class="op" id="4106331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106335">return</span>&nbsp;<span class="ident" id="4106342">syscall</span><span class="op" id="4106349">.</span><span class="ident" id="4106350">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4106359">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106362">if</span>&nbsp;<span class="ident" id="4106365">a</span><span class="op" id="4106366">.</span><span class="ident" id="4106367">IP</span><span class="op" id="4106369">.</span><span class="ident" id="4106370">To4</span><span class="op" id="4106373">(</span><span class="op" id="4106374">)</span>&nbsp;<span class="op" id="4106376">!=</span>&nbsp;<span class="ident" id="4106379">nil</span>&nbsp;<span class="op" id="4106383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106387">return</span>&nbsp;<span class="ident" id="4106394">syscall</span><span class="op" id="4106401">.</span><span class="ident" id="4106402">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4106411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106414">return</span>&nbsp;<span class="ident" id="4106421">syscall</span><span class="op" id="4106428">.</span><span class="ident" id="4106429">AF_INET6</span><br>
<span class="lineno"></span><span class="op" id="4106438">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="4106441">func</span>&nbsp;<span class="op" id="4106446">(</span><span class="ident" id="4106447">a</span>&nbsp;<span class="op" id="4106449">*</span><span class="ident" id="4106450">IPAddr</span><span class="op" id="4106456">)</span>&nbsp;<span class="ident" id="4106458">isWildcard</span><span class="op" id="4106468">(</span><span class="op" id="4106469">)</span>&nbsp;<span class="builtintype" id="4106471">bool</span>&nbsp;<span class="op" id="4106476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106479">if</span>&nbsp;<span class="ident" id="4106482">a</span>&nbsp;<span class="op" id="4106484">==</span>&nbsp;<span class="ident" id="4106487">nil</span>&nbsp;<span class="op" id="4106491">||</span>&nbsp;<span class="ident" id="4106494">a</span><span class="op" id="4106495">.</span><span class="ident" id="4106496">IP</span>&nbsp;<span class="op" id="4106499">==</span>&nbsp;<span class="ident" id="4106502">nil</span>&nbsp;<span class="op" id="4106506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106510">return</span>&nbsp;<span class="builtintype" id="4106517">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4106523">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106526">return</span>&nbsp;<span class="ident" id="4106533">a</span><span class="op" id="4106534">.</span><span class="ident" id="4106535">IP</span><span class="op" id="4106537">.</span><span class="ident" id="4106538">IsUnspecified</span><span class="op" id="4106551">(</span><span class="op" id="4106552">)</span><br>
<span class="lineno"></span><span class="op" id="4106554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4106557">func</span>&nbsp;<span class="op" id="4106562">(</span><span class="ident" id="4106563">a</span>&nbsp;<span class="op" id="4106565">*</span><span class="ident" id="4106566">IPAddr</span><span class="op" id="4106572">)</span>&nbsp;<span class="ident" id="4106574">sockaddr</span><span class="op" id="4106582">(</span><span class="ident" id="4106583">family</span>&nbsp;<span class="builtintype" id="4106590">int</span><span class="op" id="4106593">)</span>&nbsp;<span class="op" id="4106595">(</span><span class="ident" id="4106596">syscall</span><span class="op" id="4106603">.</span><span class="ident" id="4106604">Sockaddr</span><span class="op" id="4106612">,</span>&nbsp;<span class="builtintype" id="4106614">error</span><span class="op" id="4106619">)</span>&nbsp;<span class="op" id="4106621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106624">if</span>&nbsp;<span class="ident" id="4106627">a</span>&nbsp;<span class="op" id="4106629">==</span>&nbsp;<span class="ident" id="4106632">nil</span>&nbsp;<span class="op" id="4106636">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106640">return</span>&nbsp;<span class="ident" id="4106647">nil</span><span class="op" id="4106650">,</span>&nbsp;<span class="ident" id="4106652">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4106657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4106660">return</span>&nbsp;<span class="ident" id="4106667">ipToSockaddr</span><span class="op" id="4106679">(</span><span class="ident" id="4106680">family</span><span class="op" id="4106686">,</span>&nbsp;<span class="ident" id="4106688">a</span><span class="op" id="4106689">.</span><span class="ident" id="4106690">IP</span><span class="op" id="4106692">,</span>&nbsp;<span class="num" id="4106694">0</span><span class="op" id="4106695">,</span>&nbsp;<span class="ident" id="4106697">a</span><span class="op" id="4106698">.</span><span class="ident" id="4106699">Zone</span><span class="op" id="4106703">)</span><br>
<span class="lineno"></span><span class="op" id="4106705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="4106708">//&nbsp;IPConn&nbsp;is&nbsp;the&nbsp;implementation&nbsp;of&nbsp;the&nbsp;Conn&nbsp;and&nbsp;PacketConn&nbsp;interfaces</span><br>
<span class="lineno"></span><span class="comment" id="4106778">//&nbsp;for&nbsp;IP&nbsp;network&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="4106809">type</span>&nbsp;<span class="ident" id="4106814">IPConn</span>&nbsp;<span class="keyword" id="4106821">struct</span>&nbsp;<span class="op" id="4106828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4106831">conn</span><br>
<span class="lineno"></span><span class="op" id="4106836">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="keyword" id="4106839">func</span>&nbsp;<span class="ident" id="4106844">newIPConn</span><span class="op" id="4106853">(</span><span class="ident" id="4106854">fd</span>&nbsp;<span class="op" id="4106857">*</span><span class="ident" id="4106858">netFD</span><span class="op" id="4106863">)</span>&nbsp;<span class="op" id="4106865">*</span><span class="ident" id="4106866">IPConn</span>&nbsp;<span class="op" id="4106873">{</span>&nbsp;<span class="keyword" id="4106875">return</span>&nbsp;<span class="op" id="4106882">&amp;</span><span class="ident" id="4106883">IPConn</span><span class="op" id="4106889">{</span><span class="ident" id="4106890">conn</span><span class="op" id="4106894">{</span><span class="ident" id="4106895">fd</span><span class="op" id="4106897">}</span><span class="op" id="4106898">}</span>&nbsp;<span class="op" id="4106900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4106903">//&nbsp;ReadFromIP&nbsp;reads&nbsp;an&nbsp;IP&nbsp;packet&nbsp;from&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload&nbsp;into&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="4106972">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;copied&nbsp;into&nbsp;b&nbsp;and&nbsp;the&nbsp;return&nbsp;address</span><br>
<span class="lineno">70</span><span class="comment" id="4107043">//&nbsp;that&nbsp;was&nbsp;on&nbsp;the&nbsp;packet.</span><br>
<span class="lineno"></span><span class="comment" id="4107070">//</span><br>
<span class="lineno"></span><span class="comment" id="4107073">//&nbsp;ReadFromIP&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;an&nbsp;error&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="4107136">//&nbsp;Timeout()&nbsp;==&nbsp;true&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4107203">//&nbsp;SetReadDeadline.</span><br>
<span class="lineno">75</span><span class="keyword" id="4107223">func</span>&nbsp;<span class="op" id="4107228">(</span><span class="ident" id="4107229">c</span>&nbsp;<span class="op" id="4107231">*</span><span class="ident" id="4107232">IPConn</span><span class="op" id="4107238">)</span>&nbsp;<span class="ident" id="4107240">ReadFromIP</span><span class="op" id="4107250">(</span><span class="ident" id="4107251">b</span>&nbsp;<span class="op" id="4107253">[</span><span class="op" id="4107254">]</span><span class="builtintype" id="4107255">byte</span><span class="op" id="4107259">)</span>&nbsp;<span class="op" id="4107261">(</span><span class="builtintype" id="4107262">int</span><span class="op" id="4107265">,</span>&nbsp;<span class="op" id="4107267">*</span><span class="ident" id="4107268">IPAddr</span><span class="op" id="4107274">,</span>&nbsp;<span class="builtintype" id="4107276">error</span><span class="op" id="4107281">)</span>&nbsp;<span class="op" id="4107283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107286">if</span>&nbsp;<span class="op" id="4107289">!</span><span class="ident" id="4107290">c</span><span class="op" id="4107291">.</span><span class="ident" id="4107292">ok</span><span class="op" id="4107294">(</span><span class="op" id="4107295">)</span>&nbsp;<span class="op" id="4107297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107301">return</span>&nbsp;<span class="num" id="4107308">0</span><span class="op" id="4107309">,</span>&nbsp;<span class="ident" id="4107311">nil</span><span class="op" id="4107314">,</span>&nbsp;<span class="ident" id="4107316">syscall</span><span class="op" id="4107323">.</span><span class="ident" id="4107324">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4107332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4107335">//&nbsp;TODO(cw,rsc):&nbsp;consider&nbsp;using&nbsp;readv&nbsp;if&nbsp;we&nbsp;know&nbsp;the&nbsp;family</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4107396">//&nbsp;type&nbsp;to&nbsp;avoid&nbsp;the&nbsp;header&nbsp;trim/copy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107435">var</span>&nbsp;<span class="ident" id="4107439">addr</span>&nbsp;<span class="op" id="4107444">*</span><span class="ident" id="4107445">IPAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4107453">n</span><span class="op" id="4107454">,</span>&nbsp;<span class="ident" id="4107456">sa</span><span class="op" id="4107458">,</span>&nbsp;<span class="ident" id="4107460">err</span>&nbsp;<span class="op" id="4107464">:=</span>&nbsp;<span class="ident" id="4107467">c</span><span class="op" id="4107468">.</span><span class="ident" id="4107469">fd</span><span class="op" id="4107471">.</span><span class="ident" id="4107472">readFrom</span><span class="op" id="4107480">(</span><span class="ident" id="4107481">b</span><span class="op" id="4107482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107485">switch</span>&nbsp;<span class="ident" id="4107492">sa</span>&nbsp;<span class="op" id="4107495">:=</span>&nbsp;<span class="ident" id="4107498">sa</span><span class="op" id="4107500">.</span><span class="op" id="4107501">(</span><span class="keyword" id="4107502">type</span><span class="op" id="4107506">)</span>&nbsp;<span class="op" id="4107508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107511">case</span>&nbsp;<span class="op" id="4107516">*</span><span class="ident" id="4107517">syscall</span><span class="op" id="4107524">.</span><span class="ident" id="4107525">SockaddrInet4</span><span class="op" id="4107538">:</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4107542">addr</span>&nbsp;<span class="op" id="4107547">=</span>&nbsp;<span class="op" id="4107549">&amp;</span><span class="ident" id="4107550">IPAddr</span><span class="op" id="4107556">{</span><span class="ident" id="4107557">IP</span><span class="op" id="4107559">:</span>&nbsp;<span class="ident" id="4107561">sa</span><span class="op" id="4107563">.</span><span class="ident" id="4107564">Addr</span><span class="op" id="4107568">[</span><span class="num" id="4107569">0</span><span class="op" id="4107570">:</span><span class="op" id="4107571">]</span><span class="op" id="4107572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107576">if</span>&nbsp;<span class="builtinfunc" id="4107579">len</span><span class="op" id="4107582">(</span><span class="ident" id="4107583">b</span><span class="op" id="4107584">)</span>&nbsp;<span class="op" id="4107586">&gt;=</span>&nbsp;<span class="ident" id="4107589">IPv4len</span>&nbsp;<span class="op" id="4107597">{</span>&nbsp;<span class="comment" id="4107599">//&nbsp;discard&nbsp;ipv4&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4107625">hsize</span>&nbsp;<span class="op" id="4107631">:=</span>&nbsp;<span class="op" id="4107634">(</span><span class="builtintype" id="4107635">int</span><span class="op" id="4107638">(</span><span class="ident" id="4107639">b</span><span class="op" id="4107640">[</span><span class="num" id="4107641">0</span><span class="op" id="4107642">]</span><span class="op" id="4107643">)</span>&nbsp;<span class="op" id="4107645">&amp;</span>&nbsp;<span class="num" id="4107647">0xf</span><span class="op" id="4107650">)</span>&nbsp;<span class="op" id="4107652">*</span>&nbsp;<span class="num" id="4107654">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4107659">copy</span><span class="op" id="4107663">(</span><span class="ident" id="4107664">b</span><span class="op" id="4107665">,</span>&nbsp;<span class="ident" id="4107667">b</span><span class="op" id="4107668">[</span><span class="ident" id="4107669">hsize</span><span class="op" id="4107674">:</span><span class="op" id="4107675">]</span><span class="op" id="4107676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4107681">n</span>&nbsp;<span class="op" id="4107683">-=</span>&nbsp;<span class="ident" id="4107686">hsize</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4107694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107697">case</span>&nbsp;<span class="op" id="4107702">*</span><span class="ident" id="4107703">syscall</span><span class="op" id="4107710">.</span><span class="ident" id="4107711">SockaddrInet6</span><span class="op" id="4107724">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4107728">addr</span>&nbsp;<span class="op" id="4107733">=</span>&nbsp;<span class="op" id="4107735">&amp;</span><span class="ident" id="4107736">IPAddr</span><span class="op" id="4107742">{</span><span class="ident" id="4107743">IP</span><span class="op" id="4107745">:</span>&nbsp;<span class="ident" id="4107747">sa</span><span class="op" id="4107749">.</span><span class="ident" id="4107750">Addr</span><span class="op" id="4107754">[</span><span class="num" id="4107755">0</span><span class="op" id="4107756">:</span><span class="op" id="4107757">]</span><span class="op" id="4107758">,</span>&nbsp;<span class="ident" id="4107760">Zone</span><span class="op" id="4107764">:</span>&nbsp;<span class="ident" id="4107766">zoneToString</span><span class="op" id="4107778">(</span><span class="builtintype" id="4107779">int</span><span class="op" id="4107782">(</span><span class="ident" id="4107783">sa</span><span class="op" id="4107785">.</span><span class="ident" id="4107786">ZoneId</span><span class="op" id="4107792">)</span><span class="op" id="4107793">)</span><span class="op" id="4107794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4107797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107800">return</span>&nbsp;<span class="ident" id="4107807">n</span><span class="op" id="4107808">,</span>&nbsp;<span class="ident" id="4107810">addr</span><span class="op" id="4107814">,</span>&nbsp;<span class="ident" id="4107816">err</span><br>
<span class="lineno">95</span><span class="op" id="4107820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4107823">//&nbsp;ReadFrom&nbsp;implements&nbsp;the&nbsp;PacketConn&nbsp;ReadFrom&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="4107878">func</span>&nbsp;<span class="op" id="4107883">(</span><span class="ident" id="4107884">c</span>&nbsp;<span class="op" id="4107886">*</span><span class="ident" id="4107887">IPConn</span><span class="op" id="4107893">)</span>&nbsp;<span class="ident" id="4107895">ReadFrom</span><span class="op" id="4107903">(</span><span class="ident" id="4107904">b</span>&nbsp;<span class="op" id="4107906">[</span><span class="op" id="4107907">]</span><span class="builtintype" id="4107908">byte</span><span class="op" id="4107912">)</span>&nbsp;<span class="op" id="4107914">(</span><span class="builtintype" id="4107915">int</span><span class="op" id="4107918">,</span>&nbsp;<span class="ident" id="4107920">Addr</span><span class="op" id="4107924">,</span>&nbsp;<span class="builtintype" id="4107926">error</span><span class="op" id="4107931">)</span>&nbsp;<span class="op" id="4107933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107936">if</span>&nbsp;<span class="op" id="4107939">!</span><span class="ident" id="4107940">c</span><span class="op" id="4107941">.</span><span class="ident" id="4107942">ok</span><span class="op" id="4107944">(</span><span class="op" id="4107945">)</span>&nbsp;<span class="op" id="4107947">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4107951">return</span>&nbsp;<span class="num" id="4107958">0</span><span class="op" id="4107959">,</span>&nbsp;<span class="ident" id="4107961">nil</span><span class="op" id="4107964">,</span>&nbsp;<span class="ident" id="4107966">syscall</span><span class="op" id="4107973">.</span><span class="ident" id="4107974">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4107982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4107985">n</span><span class="op" id="4107986">,</span>&nbsp;<span class="ident" id="4107988">addr</span><span class="op" id="4107992">,</span>&nbsp;<span class="ident" id="4107994">err</span>&nbsp;<span class="op" id="4107998">:=</span>&nbsp;<span class="ident" id="4108001">c</span><span class="op" id="4108002">.</span><span class="ident" id="4108003">ReadFromIP</span><span class="op" id="4108013">(</span><span class="ident" id="4108014">b</span><span class="op" id="4108015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4108018">return</span>&nbsp;<span class="ident" id="4108025">n</span><span class="op" id="4108026">,</span>&nbsp;<span class="ident" id="4108028">addr</span><span class="op" id="4108032">.</span><span class="ident" id="4108033">toAddr</span><span class="op" id="4108039">(</span><span class="op" id="4108040">)</span><span class="op" id="4108041">,</span>&nbsp;<span class="ident" id="4108043">err</span><br>
<span class="lineno"></span><span class="op" id="4108047">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="comment" id="4108050">//&nbsp;ReadMsgIP&nbsp;reads&nbsp;a&nbsp;packet&nbsp;from&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload&nbsp;into&nbsp;b&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4108121">//&nbsp;associated&nbsp;out-of-band&nbsp;data&nbsp;into&nbsp;oob.&nbsp;&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4108188">//&nbsp;bytes&nbsp;copied&nbsp;into&nbsp;b,&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;copied&nbsp;into&nbsp;oob,&nbsp;the&nbsp;flags</span><br>
<span class="lineno"></span><span class="comment" id="4108259">//&nbsp;that&nbsp;were&nbsp;set&nbsp;on&nbsp;the&nbsp;packet&nbsp;and&nbsp;the&nbsp;source&nbsp;address&nbsp;of&nbsp;the&nbsp;packet.</span><br>
<span class="lineno">110</span><span class="keyword" id="4108328">func</span>&nbsp;<span class="op" id="4108333">(</span><span class="ident" id="4108334">c</span>&nbsp;<span class="op" id="4108336">*</span><span class="ident" id="4108337">IPConn</span><span class="op" id="4108343">)</span>&nbsp;<span class="ident" id="4108345">ReadMsgIP</span><span class="op" id="4108354">(</span><span class="ident" id="4108355">b</span><span class="op" id="4108356">,</span>&nbsp;<span class="ident" id="4108358">oob</span>&nbsp;<span class="op" id="4108362">[</span><span class="op" id="4108363">]</span><span class="builtintype" id="4108364">byte</span><span class="op" id="4108368">)</span>&nbsp;<span class="op" id="4108370">(</span><span class="ident" id="4108371">n</span><span class="op" id="4108372">,</span>&nbsp;<span class="ident" id="4108374">oobn</span><span class="op" id="4108378">,</span>&nbsp;<span class="ident" id="4108380">flags</span>&nbsp;<span class="builtintype" id="4108386">int</span><span class="op" id="4108389">,</span>&nbsp;<span class="ident" id="4108391">addr</span>&nbsp;<span class="op" id="4108396">*</span><span class="ident" id="4108397">IPAddr</span><span class="op" id="4108403">,</span>&nbsp;<span class="ident" id="4108405">err</span>&nbsp;<span class="builtintype" id="4108409">error</span><span class="op" id="4108414">)</span>&nbsp;<span class="op" id="4108416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4108419">if</span>&nbsp;<span class="op" id="4108422">!</span><span class="ident" id="4108423">c</span><span class="op" id="4108424">.</span><span class="ident" id="4108425">ok</span><span class="op" id="4108427">(</span><span class="op" id="4108428">)</span>&nbsp;<span class="op" id="4108430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4108434">return</span>&nbsp;<span class="num" id="4108441">0</span><span class="op" id="4108442">,</span>&nbsp;<span class="num" id="4108444">0</span><span class="op" id="4108445">,</span>&nbsp;<span class="num" id="4108447">0</span><span class="op" id="4108448">,</span>&nbsp;<span class="ident" id="4108450">nil</span><span class="op" id="4108453">,</span>&nbsp;<span class="ident" id="4108455">syscall</span><span class="op" id="4108462">.</span><span class="ident" id="4108463">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4108471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4108474">var</span>&nbsp;<span class="ident" id="4108478">sa</span>&nbsp;<span class="ident" id="4108481">syscall</span><span class="op" id="4108488">.</span><span class="ident" id="4108489">Sockaddr</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4108499">n</span><span class="op" id="4108500">,</span>&nbsp;<span class="ident" id="4108502">oobn</span><span class="op" id="4108506">,</span>&nbsp;<span class="ident" id="4108508">flags</span><span class="op" id="4108513">,</span>&nbsp;<span class="ident" id="4108515">sa</span><span class="op" id="4108517">,</span>&nbsp;<span class="ident" id="4108519">err</span>&nbsp;<span class="op" id="4108523">=</span>&nbsp;<span class="ident" id="4108525">c</span><span class="op" id="4108526">.</span><span class="ident" id="4108527">fd</span><span class="op" id="4108529">.</span><span class="ident" id="4108530">readMsg</span><span class="op" id="4108537">(</span><span class="ident" id="4108538">b</span><span class="op" id="4108539">,</span>&nbsp;<span class="ident" id="4108541">oob</span><span class="op" id="4108544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4108547">switch</span>&nbsp;<span class="ident" id="4108554">sa</span>&nbsp;<span class="op" id="4108557">:=</span>&nbsp;<span class="ident" id="4108560">sa</span><span class="op" id="4108562">.</span><span class="op" id="4108563">(</span><span class="keyword" id="4108564">type</span><span class="op" id="4108568">)</span>&nbsp;<span class="op" id="4108570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4108573">case</span>&nbsp;<span class="op" id="4108578">*</span><span class="ident" id="4108579">syscall</span><span class="op" id="4108586">.</span><span class="ident" id="4108587">SockaddrInet4</span><span class="op" id="4108600">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4108604">addr</span>&nbsp;<span class="op" id="4108609">=</span>&nbsp;<span class="op" id="4108611">&amp;</span><span class="ident" id="4108612">IPAddr</span><span class="op" id="4108618">{</span><span class="ident" id="4108619">IP</span><span class="op" id="4108621">:</span>&nbsp;<span class="ident" id="4108623">sa</span><span class="op" id="4108625">.</span><span class="ident" id="4108626">Addr</span><span class="op" id="4108630">[</span><span class="num" id="4108631">0</span><span class="op" id="4108632">:</span><span class="op" id="4108633">]</span><span class="op" id="4108634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4108637">case</span>&nbsp;<span class="op" id="4108642">*</span><span class="ident" id="4108643">syscall</span><span class="op" id="4108650">.</span><span class="ident" id="4108651">SockaddrInet6</span><span class="op" id="4108664">:</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4108668">addr</span>&nbsp;<span class="op" id="4108673">=</span>&nbsp;<span class="op" id="4108675">&amp;</span><span class="ident" id="4108676">IPAddr</span><span class="op" id="4108682">{</span><span class="ident" id="4108683">IP</span><span class="op" id="4108685">:</span>&nbsp;<span class="ident" id="4108687">sa</span><span class="op" id="4108689">.</span><span class="ident" id="4108690">Addr</span><span class="op" id="4108694">[</span><span class="num" id="4108695">0</span><span class="op" id="4108696">:</span><span class="op" id="4108697">]</span><span class="op" id="4108698">,</span>&nbsp;<span class="ident" id="4108700">Zone</span><span class="op" id="4108704">:</span>&nbsp;<span class="ident" id="4108706">zoneToString</span><span class="op" id="4108718">(</span><span class="builtintype" id="4108719">int</span><span class="op" id="4108722">(</span><span class="ident" id="4108723">sa</span><span class="op" id="4108725">.</span><span class="ident" id="4108726">ZoneId</span><span class="op" id="4108732">)</span><span class="op" id="4108733">)</span><span class="op" id="4108734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4108737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4108740">return</span><br>
<span class="lineno"></span><span class="op" id="4108747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="4108750">//&nbsp;WriteToIP&nbsp;writes&nbsp;an&nbsp;IP&nbsp;packet&nbsp;to&nbsp;addr&nbsp;via&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload</span><br>
<span class="lineno"></span><span class="comment" id="4108818">//&nbsp;from&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="4108829">//</span><br>
<span class="lineno"></span><span class="comment" id="4108832">//&nbsp;WriteToIP&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;an&nbsp;error&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="4108894">//&nbsp;Timeout()&nbsp;==&nbsp;true&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and</span><br>
<span class="lineno">130</span><span class="comment" id="4108961">//&nbsp;SetWriteDeadline.&nbsp;&nbsp;On&nbsp;packet-oriented&nbsp;connections,&nbsp;write&nbsp;timeouts</span><br>
<span class="lineno"></span><span class="comment" id="4109030">//&nbsp;are&nbsp;rare.</span><br>
<span class="lineno"></span><span class="keyword" id="4109043">func</span>&nbsp;<span class="op" id="4109048">(</span><span class="ident" id="4109049">c</span>&nbsp;<span class="op" id="4109051">*</span><span class="ident" id="4109052">IPConn</span><span class="op" id="4109058">)</span>&nbsp;<span class="ident" id="4109060">WriteToIP</span><span class="op" id="4109069">(</span><span class="ident" id="4109070">b</span>&nbsp;<span class="op" id="4109072">[</span><span class="op" id="4109073">]</span><span class="builtintype" id="4109074">byte</span><span class="op" id="4109078">,</span>&nbsp;<span class="ident" id="4109080">addr</span>&nbsp;<span class="op" id="4109085">*</span><span class="ident" id="4109086">IPAddr</span><span class="op" id="4109092">)</span>&nbsp;<span class="op" id="4109094">(</span><span class="builtintype" id="4109095">int</span><span class="op" id="4109098">,</span>&nbsp;<span class="builtintype" id="4109100">error</span><span class="op" id="4109105">)</span>&nbsp;<span class="op" id="4109107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4109110">if</span>&nbsp;<span class="op" id="4109113">!</span><span class="ident" id="4109114">c</span><span class="op" id="4109115">.</span><span class="ident" id="4109116">ok</span><span class="op" id="4109118">(</span><span class="op" id="4109119">)</span>&nbsp;<span class="op" id="4109121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4109125">return</span>&nbsp;<span class="num" id="4109132">0</span><span class="op" id="4109133">,</span>&nbsp;<span class="ident" id="4109135">syscall</span><span class="op" id="4109142">.</span><span class="ident" id="4109143">EINVAL</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4109151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4109154">if</span>&nbsp;<span class="ident" id="4109157">c</span><span class="op" id="4109158">.</span><span class="ident" id="4109159">fd</span><span class="op" id="4109161">.</span><span class="ident" id="4109162">isConnected</span>&nbsp;<span class="op" id="4109174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4109178">return</span>&nbsp;<span class="num" id="4109185">0</span><span class="op" id="4109186">,</span>&nbsp;<span class="op" id="4109188">&amp;</span><span class="ident" id="4109189">OpError</span><span class="op" id="4109196">{</span><span class="ident" id="4109197">Op</span><span class="op" id="4109199">:</span>&nbsp;<span class="string" id="4109201">&#34;write&#34;</span><span class="op" id="4109208">,</span>&nbsp;<span class="ident" id="4109210">Net</span><span class="op" id="4109213">:</span>&nbsp;<span class="ident" id="4109215">c</span><span class="op" id="4109216">.</span><span class="ident" id="4109217">fd</span><span class="op" id="4109219">.</span><span class="ident" id="4109220">net</span><span class="op" id="4109223">,</span>&nbsp;<span class="ident" id="4109225">Addr</span><span class="op" id="4109229">:</span>&nbsp;<span class="ident" id="4109231">addr</span><span class="op" id="4109235">,</span>&nbsp;<span class="ident" id="4109237">Err</span><span class="op" id="4109240">:</span>&nbsp;<span class="ident" id="4109242">ErrWriteToConnected</span><span class="op" id="4109261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4109264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4109267">if</span>&nbsp;<span class="ident" id="4109270">addr</span>&nbsp;<span class="op" id="4109275">==</span>&nbsp;<span class="ident" id="4109278">nil</span>&nbsp;<span class="op" id="4109282">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4109286">return</span>&nbsp;<span class="num" id="4109293">0</span><span class="op" id="4109294">,</span>&nbsp;<span class="op" id="4109296">&amp;</span><span class="ident" id="4109297">OpError</span><span class="op" id="4109304">{</span><span class="ident" id="4109305">Op</span><span class="op" id="4109307">:</span>&nbsp;<span class="string" id="4109309">&#34;write&#34;</span><span class="op" id="4109316">,</span>&nbsp;<span class="ident" id="4109318">Net</span><span class="op" id="4109321">:</span>&nbsp;<span class="ident" id="4109323">c</span><span class="op" id="4109324">.</span><span class="ident" id="4109325">fd</span><span class="op" id="4109327">.</span><span class="ident" id="4109328">net</span><span class="op" id="4109331">,</span>&nbsp;<span class="ident" id="4109333">Addr</span><span class="op" id="4109337">:</span>&nbsp;<span class="ident" id="4109339">nil</span><span class="op" id="4109342">,</span>&nbsp;<span class="ident" id="4109344">Err</span><span class="op" id="4109347">:</span>&nbsp;<span class="ident" id="4109349">errMissingAddress</span><span class="op" id="4109366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4109369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4109372">sa</span><span class="op" id="4109374">,</span>&nbsp;<span class="ident" id="4109376">err</span>&nbsp;<span class="op" id="4109380">:=</span>&nbsp;<span class="ident" id="4109383">addr</span><span class="op" id="4109387">.</span><span class="ident" id="4109388">sockaddr</span><span class="op" id="4109396">(</span><span class="ident" id="4109397">c</span><span class="op" id="4109398">.</span><span class="ident" id="4109399">fd</span><span class="op" id="4109401">.</span><span class="ident" id="4109402">family</span><span class="op" id="4109408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4109411">if</span>&nbsp;<span class="ident" id="4109414">err</span>&nbsp;<span class="op" id="4109418">!=</span>&nbsp;<span class="ident" id="4109421">nil</span>&nbsp;<span class="op" id="4109425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4109429">return</span>&nbsp;<span class="num" id="4109436">0</span><span class="op" id="4109437">,</span>&nbsp;<span class="op" id="4109439">&amp;</span><span class="ident" id="4109440">OpError</span><span class="op" id="4109447">{</span><span class="string" id="4109448">&#34;write&#34;</span><span class="op" id="4109455">,</span>&nbsp;<span class="ident" id="4109457">c</span><span class="op" id="4109458">.</span><span class="ident" id="4109459">fd</span><span class="op" id="4109461">.</span><span class="ident" id="4109462">net</span><span class="op" id="4109465">,</span>&nbsp;<span class="ident" id="4109467">addr</span><span class="op" id="4109471">,</span>&nbsp;<span class="ident" id="4109473">err</span><span class="op" id="4109476">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4109479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4109482">return</span>&nbsp;<span class="ident" id="4109489">c</span><span class="op" id="4109490">.</span><span class="ident" id="4109491">fd</span><span class="op" id="4109493">.</span><span class="ident" id="4109494">writeTo</span><span class="op" id="4109501">(</span><span class="ident" id="4109502">b</span><span class="op" id="4109503">,</span>&nbsp;<span class="ident" id="4109505">sa</span><span class="op" id="4109507">)</span><br>
<span class="lineno"></span><span class="op" id="4109509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4109512">//&nbsp;WriteTo&nbsp;implements&nbsp;the&nbsp;PacketConn&nbsp;WriteTo&nbsp;method.</span><br>
<span class="lineno">150</span><span class="keyword" id="4109565">func</span>&nbsp;<span class="op" id="4109570">(</span><span class="ident" id="4109571">c</span>&nbsp;<span class="op" id="4109573">*</span><span class="ident" id="4109574">IPConn</span><span class="op" id="4109580">)</span>&nbsp;<span class="ident" id="4109582">WriteTo</span><span class="op" id="4109589">(</span><span class="ident" id="4109590">b</span>&nbsp;<span class="op" id="4109592">[</span><span class="op" id="4109593">]</span><span class="builtintype" id="4109594">byte</span><span class="op" id="4109598">,</span>&nbsp;<span class="ident" id="4109600">addr</span>&nbsp;<span class="ident" id="4109605">Addr</span><span class="op" id="4109609">)</span>&nbsp;<span class="op" id="4109611">(</span><span class="builtintype" id="4109612">int</span><span class="op" id="4109615">,</span>&nbsp;<span class="builtintype" id="4109617">error</span><span class="op" id="4109622">)</span>&nbsp;<span class="op" id="4109624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4109627">if</span>&nbsp;<span class="op" id="4109630">!</span><span class="ident" id="4109631">c</span><span class="op" id="4109632">.</span><span class="ident" id="4109633">ok</span><span class="op" id="4109635">(</span><span class="op" id="4109636">)</span>&nbsp;<span class="op" id="4109638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4109642">return</span>&nbsp;<span class="num" id="4109649">0</span><span class="op" id="4109650">,</span>&nbsp;<span class="ident" id="4109652">syscall</span><span class="op" id="4109659">.</span><span class="ident" id="4109660">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4109668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4109671">a</span><span class="op" id="4109672">,</span>&nbsp;<span class="ident" id="4109674">ok</span>&nbsp;<span class="op" id="4109677">:=</span>&nbsp;<span class="ident" id="4109680">addr</span><span class="op" id="4109684">.</span><span class="op" id="4109685">(</span><span class="op" id="4109686">*</span><span class="ident" id="4109687">IPAddr</span><span class="op" id="4109693">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4109696">if</span>&nbsp;<span class="op" id="4109699">!</span><span class="ident" id="4109700">ok</span>&nbsp;<span class="op" id="4109703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4109707">return</span>&nbsp;<span class="num" id="4109714">0</span><span class="op" id="4109715">,</span>&nbsp;<span class="op" id="4109717">&amp;</span><span class="ident" id="4109718">OpError</span><span class="op" id="4109725">{</span><span class="string" id="4109726">&#34;write&#34;</span><span class="op" id="4109733">,</span>&nbsp;<span class="ident" id="4109735">c</span><span class="op" id="4109736">.</span><span class="ident" id="4109737">fd</span><span class="op" id="4109739">.</span><span class="ident" id="4109740">net</span><span class="op" id="4109743">,</span>&nbsp;<span class="ident" id="4109745">addr</span><span class="op" id="4109749">,</span>&nbsp;<span class="ident" id="4109751">syscall</span><span class="op" id="4109758">.</span><span class="ident" id="4109759">EINVAL</span><span class="op" id="4109765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4109768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4109771">return</span>&nbsp;<span class="ident" id="4109778">c</span><span class="op" id="4109779">.</span><span class="ident" id="4109780">WriteToIP</span><span class="op" id="4109789">(</span><span class="ident" id="4109790">b</span><span class="op" id="4109791">,</span>&nbsp;<span class="ident" id="4109793">a</span><span class="op" id="4109794">)</span><br>
<span class="lineno"></span><span class="op" id="4109796">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="4109799">//&nbsp;WriteMsgIP&nbsp;writes&nbsp;a&nbsp;packet&nbsp;to&nbsp;addr&nbsp;via&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="4109869">//&nbsp;b&nbsp;and&nbsp;the&nbsp;associated&nbsp;out-of-band&nbsp;data&nbsp;from&nbsp;oob.&nbsp;&nbsp;It&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4109936">//&nbsp;number&nbsp;of&nbsp;payload&nbsp;and&nbsp;out-of-band&nbsp;bytes&nbsp;written.</span><br>
<span class="lineno"></span><span class="keyword" id="4109988">func</span>&nbsp;<span class="op" id="4109993">(</span><span class="ident" id="4109994">c</span>&nbsp;<span class="op" id="4109996">*</span><span class="ident" id="4109997">IPConn</span><span class="op" id="4110003">)</span>&nbsp;<span class="ident" id="4110005">WriteMsgIP</span><span class="op" id="4110015">(</span><span class="ident" id="4110016">b</span><span class="op" id="4110017">,</span>&nbsp;<span class="ident" id="4110019">oob</span>&nbsp;<span class="op" id="4110023">[</span><span class="op" id="4110024">]</span><span class="builtintype" id="4110025">byte</span><span class="op" id="4110029">,</span>&nbsp;<span class="ident" id="4110031">addr</span>&nbsp;<span class="op" id="4110036">*</span><span class="ident" id="4110037">IPAddr</span><span class="op" id="4110043">)</span>&nbsp;<span class="op" id="4110045">(</span><span class="ident" id="4110046">n</span><span class="op" id="4110047">,</span>&nbsp;<span class="ident" id="4110049">oobn</span>&nbsp;<span class="builtintype" id="4110054">int</span><span class="op" id="4110057">,</span>&nbsp;<span class="ident" id="4110059">err</span>&nbsp;<span class="builtintype" id="4110063">error</span><span class="op" id="4110068">)</span>&nbsp;<span class="op" id="4110070">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110073">if</span>&nbsp;<span class="op" id="4110076">!</span><span class="ident" id="4110077">c</span><span class="op" id="4110078">.</span><span class="ident" id="4110079">ok</span><span class="op" id="4110081">(</span><span class="op" id="4110082">)</span>&nbsp;<span class="op" id="4110084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110088">return</span>&nbsp;<span class="num" id="4110095">0</span><span class="op" id="4110096">,</span>&nbsp;<span class="num" id="4110098">0</span><span class="op" id="4110099">,</span>&nbsp;<span class="ident" id="4110101">syscall</span><span class="op" id="4110108">.</span><span class="ident" id="4110109">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4110117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110120">if</span>&nbsp;<span class="ident" id="4110123">c</span><span class="op" id="4110124">.</span><span class="ident" id="4110125">fd</span><span class="op" id="4110127">.</span><span class="ident" id="4110128">isConnected</span>&nbsp;<span class="op" id="4110140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110144">return</span>&nbsp;<span class="num" id="4110151">0</span><span class="op" id="4110152">,</span>&nbsp;<span class="num" id="4110154">0</span><span class="op" id="4110155">,</span>&nbsp;<span class="op" id="4110157">&amp;</span><span class="ident" id="4110158">OpError</span><span class="op" id="4110165">{</span><span class="ident" id="4110166">Op</span><span class="op" id="4110168">:</span>&nbsp;<span class="string" id="4110170">&#34;write&#34;</span><span class="op" id="4110177">,</span>&nbsp;<span class="ident" id="4110179">Net</span><span class="op" id="4110182">:</span>&nbsp;<span class="ident" id="4110184">c</span><span class="op" id="4110185">.</span><span class="ident" id="4110186">fd</span><span class="op" id="4110188">.</span><span class="ident" id="4110189">net</span><span class="op" id="4110192">,</span>&nbsp;<span class="ident" id="4110194">Addr</span><span class="op" id="4110198">:</span>&nbsp;<span class="ident" id="4110200">addr</span><span class="op" id="4110204">,</span>&nbsp;<span class="ident" id="4110206">Err</span><span class="op" id="4110209">:</span>&nbsp;<span class="ident" id="4110211">ErrWriteToConnected</span><span class="op" id="4110230">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4110233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110236">if</span>&nbsp;<span class="ident" id="4110239">addr</span>&nbsp;<span class="op" id="4110244">==</span>&nbsp;<span class="ident" id="4110247">nil</span>&nbsp;<span class="op" id="4110251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110255">return</span>&nbsp;<span class="num" id="4110262">0</span><span class="op" id="4110263">,</span>&nbsp;<span class="num" id="4110265">0</span><span class="op" id="4110266">,</span>&nbsp;<span class="op" id="4110268">&amp;</span><span class="ident" id="4110269">OpError</span><span class="op" id="4110276">{</span><span class="ident" id="4110277">Op</span><span class="op" id="4110279">:</span>&nbsp;<span class="string" id="4110281">&#34;write&#34;</span><span class="op" id="4110288">,</span>&nbsp;<span class="ident" id="4110290">Net</span><span class="op" id="4110293">:</span>&nbsp;<span class="ident" id="4110295">c</span><span class="op" id="4110296">.</span><span class="ident" id="4110297">fd</span><span class="op" id="4110299">.</span><span class="ident" id="4110300">net</span><span class="op" id="4110303">,</span>&nbsp;<span class="ident" id="4110305">Addr</span><span class="op" id="4110309">:</span>&nbsp;<span class="ident" id="4110311">nil</span><span class="op" id="4110314">,</span>&nbsp;<span class="ident" id="4110316">Err</span><span class="op" id="4110319">:</span>&nbsp;<span class="ident" id="4110321">errMissingAddress</span><span class="op" id="4110338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4110341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110344">sa</span><span class="op" id="4110346">,</span>&nbsp;<span class="ident" id="4110348">err</span>&nbsp;<span class="op" id="4110352">:=</span>&nbsp;<span class="ident" id="4110355">addr</span><span class="op" id="4110359">.</span><span class="ident" id="4110360">sockaddr</span><span class="op" id="4110368">(</span><span class="ident" id="4110369">c</span><span class="op" id="4110370">.</span><span class="ident" id="4110371">fd</span><span class="op" id="4110373">.</span><span class="ident" id="4110374">family</span><span class="op" id="4110380">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110383">if</span>&nbsp;<span class="ident" id="4110386">err</span>&nbsp;<span class="op" id="4110390">!=</span>&nbsp;<span class="ident" id="4110393">nil</span>&nbsp;<span class="op" id="4110397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110401">return</span>&nbsp;<span class="num" id="4110408">0</span><span class="op" id="4110409">,</span>&nbsp;<span class="num" id="4110411">0</span><span class="op" id="4110412">,</span>&nbsp;<span class="op" id="4110414">&amp;</span><span class="ident" id="4110415">OpError</span><span class="op" id="4110422">{</span><span class="string" id="4110423">&#34;write&#34;</span><span class="op" id="4110430">,</span>&nbsp;<span class="ident" id="4110432">c</span><span class="op" id="4110433">.</span><span class="ident" id="4110434">fd</span><span class="op" id="4110436">.</span><span class="ident" id="4110437">net</span><span class="op" id="4110440">,</span>&nbsp;<span class="ident" id="4110442">addr</span><span class="op" id="4110446">,</span>&nbsp;<span class="ident" id="4110448">err</span><span class="op" id="4110451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4110454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110457">return</span>&nbsp;<span class="ident" id="4110464">c</span><span class="op" id="4110465">.</span><span class="ident" id="4110466">fd</span><span class="op" id="4110468">.</span><span class="ident" id="4110469">writeMsg</span><span class="op" id="4110477">(</span><span class="ident" id="4110478">b</span><span class="op" id="4110479">,</span>&nbsp;<span class="ident" id="4110481">oob</span><span class="op" id="4110484">,</span>&nbsp;<span class="ident" id="4110486">sa</span><span class="op" id="4110488">)</span><br>
<span class="lineno"></span><span class="op" id="4110490">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="comment" id="4110493">//&nbsp;DialIP&nbsp;connects&nbsp;to&nbsp;the&nbsp;remote&nbsp;address&nbsp;raddr&nbsp;on&nbsp;the&nbsp;network&nbsp;protocol</span><br>
<span class="lineno"></span><span class="comment" id="4110564">//&nbsp;netProto,&nbsp;which&nbsp;must&nbsp;be&nbsp;&#34;ip&#34;,&nbsp;&#34;ip4&#34;,&nbsp;or&nbsp;&#34;ip6&#34;&nbsp;followed&nbsp;by&nbsp;a&nbsp;colon</span><br>
<span class="lineno"></span><span class="comment" id="4110633">//&nbsp;and&nbsp;a&nbsp;protocol&nbsp;number&nbsp;or&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="4110667">func</span>&nbsp;<span class="ident" id="4110672">DialIP</span><span class="op" id="4110678">(</span><span class="ident" id="4110679">netProto</span>&nbsp;<span class="builtintype" id="4110688">string</span><span class="op" id="4110694">,</span>&nbsp;<span class="ident" id="4110696">laddr</span><span class="op" id="4110701">,</span>&nbsp;<span class="ident" id="4110703">raddr</span>&nbsp;<span class="op" id="4110709">*</span><span class="ident" id="4110710">IPAddr</span><span class="op" id="4110716">)</span>&nbsp;<span class="op" id="4110718">(</span><span class="op" id="4110719">*</span><span class="ident" id="4110720">IPConn</span><span class="op" id="4110726">,</span>&nbsp;<span class="builtintype" id="4110728">error</span><span class="op" id="4110733">)</span>&nbsp;<span class="op" id="4110735">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110738">return</span>&nbsp;<span class="ident" id="4110745">dialIP</span><span class="op" id="4110751">(</span><span class="ident" id="4110752">netProto</span><span class="op" id="4110760">,</span>&nbsp;<span class="ident" id="4110762">laddr</span><span class="op" id="4110767">,</span>&nbsp;<span class="ident" id="4110769">raddr</span><span class="op" id="4110774">,</span>&nbsp;<span class="ident" id="4110776">noDeadline</span><span class="op" id="4110786">)</span><br>
<span class="lineno"></span><span class="op" id="4110788">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4110791">func</span>&nbsp;<span class="ident" id="4110796">dialIP</span><span class="op" id="4110802">(</span><span class="ident" id="4110803">netProto</span>&nbsp;<span class="builtintype" id="4110812">string</span><span class="op" id="4110818">,</span>&nbsp;<span class="ident" id="4110820">laddr</span><span class="op" id="4110825">,</span>&nbsp;<span class="ident" id="4110827">raddr</span>&nbsp;<span class="op" id="4110833">*</span><span class="ident" id="4110834">IPAddr</span><span class="op" id="4110840">,</span>&nbsp;<span class="ident" id="4110842">deadline</span>&nbsp;<span class="ident" id="4110851">time</span><span class="op" id="4110855">.</span><span class="ident" id="4110856">Time</span><span class="op" id="4110860">)</span>&nbsp;<span class="op" id="4110862">(</span><span class="op" id="4110863">*</span><span class="ident" id="4110864">IPConn</span><span class="op" id="4110870">,</span>&nbsp;<span class="builtintype" id="4110872">error</span><span class="op" id="4110877">)</span>&nbsp;<span class="op" id="4110879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4110882">net</span><span class="op" id="4110885">,</span>&nbsp;<span class="ident" id="4110887">proto</span><span class="op" id="4110892">,</span>&nbsp;<span class="ident" id="4110894">err</span>&nbsp;<span class="op" id="4110898">:=</span>&nbsp;<span class="ident" id="4110901">parseNetwork</span><span class="op" id="4110913">(</span><span class="ident" id="4110914">netProto</span><span class="op" id="4110922">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110925">if</span>&nbsp;<span class="ident" id="4110928">err</span>&nbsp;<span class="op" id="4110932">!=</span>&nbsp;<span class="ident" id="4110935">nil</span>&nbsp;<span class="op" id="4110939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4110943">return</span>&nbsp;<span class="ident" id="4110950">nil</span><span class="op" id="4110953">,</span>&nbsp;<span class="op" id="4110955">&amp;</span><span class="ident" id="4110956">OpError</span><span class="op" id="4110963">{</span><span class="ident" id="4110964">Op</span><span class="op" id="4110966">:</span>&nbsp;<span class="string" id="4110968">&#34;dial&#34;</span><span class="op" id="4110974">,</span>&nbsp;<span class="ident" id="4110976">Net</span><span class="op" id="4110979">:</span>&nbsp;<span class="ident" id="4110981">netProto</span><span class="op" id="4110989">,</span>&nbsp;<span class="ident" id="4110991">Addr</span><span class="op" id="4110995">:</span>&nbsp;<span class="ident" id="4110997">raddr</span><span class="op" id="4111002">,</span>&nbsp;<span class="ident" id="4111004">Err</span><span class="op" id="4111007">:</span>&nbsp;<span class="ident" id="4111009">err</span><span class="op" id="4111012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4111015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111018">switch</span>&nbsp;<span class="ident" id="4111025">net</span>&nbsp;<span class="op" id="4111029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111032">case</span>&nbsp;<span class="string" id="4111037">&#34;ip&#34;</span><span class="op" id="4111041">,</span>&nbsp;<span class="string" id="4111043">&#34;ip4&#34;</span><span class="op" id="4111048">,</span>&nbsp;<span class="string" id="4111050">&#34;ip6&#34;</span><span class="op" id="4111055">:</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111058">default</span><span class="op" id="4111065">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111069">return</span>&nbsp;<span class="ident" id="4111076">nil</span><span class="op" id="4111079">,</span>&nbsp;<span class="op" id="4111081">&amp;</span><span class="ident" id="4111082">OpError</span><span class="op" id="4111089">{</span><span class="ident" id="4111090">Op</span><span class="op" id="4111092">:</span>&nbsp;<span class="string" id="4111094">&#34;dial&#34;</span><span class="op" id="4111100">,</span>&nbsp;<span class="ident" id="4111102">Net</span><span class="op" id="4111105">:</span>&nbsp;<span class="ident" id="4111107">netProto</span><span class="op" id="4111115">,</span>&nbsp;<span class="ident" id="4111117">Addr</span><span class="op" id="4111121">:</span>&nbsp;<span class="ident" id="4111123">raddr</span><span class="op" id="4111128">,</span>&nbsp;<span class="ident" id="4111130">Err</span><span class="op" id="4111133">:</span>&nbsp;<span class="ident" id="4111135">UnknownNetworkError</span><span class="op" id="4111154">(</span><span class="ident" id="4111155">netProto</span><span class="op" id="4111163">)</span><span class="op" id="4111164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4111167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111170">if</span>&nbsp;<span class="ident" id="4111173">raddr</span>&nbsp;<span class="op" id="4111179">==</span>&nbsp;<span class="ident" id="4111182">nil</span>&nbsp;<span class="op" id="4111186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111190">return</span>&nbsp;<span class="ident" id="4111197">nil</span><span class="op" id="4111200">,</span>&nbsp;<span class="op" id="4111202">&amp;</span><span class="ident" id="4111203">OpError</span><span class="op" id="4111210">{</span><span class="ident" id="4111211">Op</span><span class="op" id="4111213">:</span>&nbsp;<span class="string" id="4111215">&#34;dial&#34;</span><span class="op" id="4111221">,</span>&nbsp;<span class="ident" id="4111223">Net</span><span class="op" id="4111226">:</span>&nbsp;<span class="ident" id="4111228">netProto</span><span class="op" id="4111236">,</span>&nbsp;<span class="ident" id="4111238">Addr</span><span class="op" id="4111242">:</span>&nbsp;<span class="ident" id="4111244">nil</span><span class="op" id="4111247">,</span>&nbsp;<span class="ident" id="4111249">Err</span><span class="op" id="4111252">:</span>&nbsp;<span class="ident" id="4111254">errMissingAddress</span><span class="op" id="4111271">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4111274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111277">fd</span><span class="op" id="4111279">,</span>&nbsp;<span class="ident" id="4111281">err</span>&nbsp;<span class="op" id="4111285">:=</span>&nbsp;<span class="ident" id="4111288">internetSocket</span><span class="op" id="4111302">(</span><span class="ident" id="4111303">net</span><span class="op" id="4111306">,</span>&nbsp;<span class="ident" id="4111308">laddr</span><span class="op" id="4111313">,</span>&nbsp;<span class="ident" id="4111315">raddr</span><span class="op" id="4111320">,</span>&nbsp;<span class="ident" id="4111322">deadline</span><span class="op" id="4111330">,</span>&nbsp;<span class="ident" id="4111332">syscall</span><span class="op" id="4111339">.</span><span class="ident" id="4111340">SOCK_RAW</span><span class="op" id="4111348">,</span>&nbsp;<span class="ident" id="4111350">proto</span><span class="op" id="4111355">,</span>&nbsp;<span class="string" id="4111357">&#34;dial&#34;</span><span class="op" id="4111363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111366">if</span>&nbsp;<span class="ident" id="4111369">err</span>&nbsp;<span class="op" id="4111373">!=</span>&nbsp;<span class="ident" id="4111376">nil</span>&nbsp;<span class="op" id="4111380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111384">return</span>&nbsp;<span class="ident" id="4111391">nil</span><span class="op" id="4111394">,</span>&nbsp;<span class="op" id="4111396">&amp;</span><span class="ident" id="4111397">OpError</span><span class="op" id="4111404">{</span><span class="ident" id="4111405">Op</span><span class="op" id="4111407">:</span>&nbsp;<span class="string" id="4111409">&#34;dial&#34;</span><span class="op" id="4111415">,</span>&nbsp;<span class="ident" id="4111417">Net</span><span class="op" id="4111420">:</span>&nbsp;<span class="ident" id="4111422">netProto</span><span class="op" id="4111430">,</span>&nbsp;<span class="ident" id="4111432">Addr</span><span class="op" id="4111436">:</span>&nbsp;<span class="ident" id="4111438">raddr</span><span class="op" id="4111443">,</span>&nbsp;<span class="ident" id="4111445">Err</span><span class="op" id="4111448">:</span>&nbsp;<span class="ident" id="4111450">err</span><span class="op" id="4111453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4111456">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111459">return</span>&nbsp;<span class="ident" id="4111466">newIPConn</span><span class="op" id="4111475">(</span><span class="ident" id="4111476">fd</span><span class="op" id="4111478">)</span><span class="op" id="4111479">,</span>&nbsp;<span class="ident" id="4111481">nil</span><br>
<span class="lineno"></span><span class="op" id="4111485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4111488">//&nbsp;ListenIP&nbsp;listens&nbsp;for&nbsp;incoming&nbsp;IP&nbsp;packets&nbsp;addressed&nbsp;to&nbsp;the&nbsp;local</span><br>
<span class="lineno"></span><span class="comment" id="4111555">//&nbsp;address&nbsp;laddr.&nbsp;&nbsp;The&nbsp;returned&nbsp;connection&#39;s&nbsp;ReadFrom&nbsp;and&nbsp;WriteTo</span><br>
<span class="lineno">210</span><span class="comment" id="4111621">//&nbsp;methods&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;receive&nbsp;and&nbsp;send&nbsp;IP&nbsp;packets&nbsp;with&nbsp;per-packet</span><br>
<span class="lineno"></span><span class="comment" id="4111691">//&nbsp;addressing.</span><br>
<span class="lineno"></span><span class="keyword" id="4111706">func</span>&nbsp;<span class="ident" id="4111711">ListenIP</span><span class="op" id="4111719">(</span><span class="ident" id="4111720">netProto</span>&nbsp;<span class="builtintype" id="4111729">string</span><span class="op" id="4111735">,</span>&nbsp;<span class="ident" id="4111737">laddr</span>&nbsp;<span class="op" id="4111743">*</span><span class="ident" id="4111744">IPAddr</span><span class="op" id="4111750">)</span>&nbsp;<span class="op" id="4111752">(</span><span class="op" id="4111753">*</span><span class="ident" id="4111754">IPConn</span><span class="op" id="4111760">,</span>&nbsp;<span class="builtintype" id="4111762">error</span><span class="op" id="4111767">)</span>&nbsp;<span class="op" id="4111769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4111772">net</span><span class="op" id="4111775">,</span>&nbsp;<span class="ident" id="4111777">proto</span><span class="op" id="4111782">,</span>&nbsp;<span class="ident" id="4111784">err</span>&nbsp;<span class="op" id="4111788">:=</span>&nbsp;<span class="ident" id="4111791">parseNetwork</span><span class="op" id="4111803">(</span><span class="ident" id="4111804">netProto</span><span class="op" id="4111812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111815">if</span>&nbsp;<span class="ident" id="4111818">err</span>&nbsp;<span class="op" id="4111822">!=</span>&nbsp;<span class="ident" id="4111825">nil</span>&nbsp;<span class="op" id="4111829">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111833">return</span>&nbsp;<span class="ident" id="4111840">nil</span><span class="op" id="4111843">,</span>&nbsp;<span class="op" id="4111845">&amp;</span><span class="ident" id="4111846">OpError</span><span class="op" id="4111853">{</span><span class="ident" id="4111854">Op</span><span class="op" id="4111856">:</span>&nbsp;<span class="string" id="4111858">&#34;dial&#34;</span><span class="op" id="4111864">,</span>&nbsp;<span class="ident" id="4111866">Net</span><span class="op" id="4111869">:</span>&nbsp;<span class="ident" id="4111871">netProto</span><span class="op" id="4111879">,</span>&nbsp;<span class="ident" id="4111881">Addr</span><span class="op" id="4111885">:</span>&nbsp;<span class="ident" id="4111887">laddr</span><span class="op" id="4111892">,</span>&nbsp;<span class="ident" id="4111894">Err</span><span class="op" id="4111897">:</span>&nbsp;<span class="ident" id="4111899">err</span><span class="op" id="4111902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4111905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111908">switch</span>&nbsp;<span class="ident" id="4111915">net</span>&nbsp;<span class="op" id="4111919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111922">case</span>&nbsp;<span class="string" id="4111927">&#34;ip&#34;</span><span class="op" id="4111931">,</span>&nbsp;<span class="string" id="4111933">&#34;ip4&#34;</span><span class="op" id="4111938">,</span>&nbsp;<span class="string" id="4111940">&#34;ip6&#34;</span><span class="op" id="4111945">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111948">default</span><span class="op" id="4111955">:</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4111959">return</span>&nbsp;<span class="ident" id="4111966">nil</span><span class="op" id="4111969">,</span>&nbsp;<span class="op" id="4111971">&amp;</span><span class="ident" id="4111972">OpError</span><span class="op" id="4111979">{</span><span class="ident" id="4111980">Op</span><span class="op" id="4111982">:</span>&nbsp;<span class="string" id="4111984">&#34;listen&#34;</span><span class="op" id="4111992">,</span>&nbsp;<span class="ident" id="4111994">Net</span><span class="op" id="4111997">:</span>&nbsp;<span class="ident" id="4111999">netProto</span><span class="op" id="4112007">,</span>&nbsp;<span class="ident" id="4112009">Addr</span><span class="op" id="4112013">:</span>&nbsp;<span class="ident" id="4112015">laddr</span><span class="op" id="4112020">,</span>&nbsp;<span class="ident" id="4112022">Err</span><span class="op" id="4112025">:</span>&nbsp;<span class="ident" id="4112027">UnknownNetworkError</span><span class="op" id="4112046">(</span><span class="ident" id="4112047">netProto</span><span class="op" id="4112055">)</span><span class="op" id="4112056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4112059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4112062">fd</span><span class="op" id="4112064">,</span>&nbsp;<span class="ident" id="4112066">err</span>&nbsp;<span class="op" id="4112070">:=</span>&nbsp;<span class="ident" id="4112073">internetSocket</span><span class="op" id="4112087">(</span><span class="ident" id="4112088">net</span><span class="op" id="4112091">,</span>&nbsp;<span class="ident" id="4112093">laddr</span><span class="op" id="4112098">,</span>&nbsp;<span class="ident" id="4112100">nil</span><span class="op" id="4112103">,</span>&nbsp;<span class="ident" id="4112105">noDeadline</span><span class="op" id="4112115">,</span>&nbsp;<span class="ident" id="4112117">syscall</span><span class="op" id="4112124">.</span><span class="ident" id="4112125">SOCK_RAW</span><span class="op" id="4112133">,</span>&nbsp;<span class="ident" id="4112135">proto</span><span class="op" id="4112140">,</span>&nbsp;<span class="string" id="4112142">&#34;listen&#34;</span><span class="op" id="4112150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4112153">if</span>&nbsp;<span class="ident" id="4112156">err</span>&nbsp;<span class="op" id="4112160">!=</span>&nbsp;<span class="ident" id="4112163">nil</span>&nbsp;<span class="op" id="4112167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4112171">return</span>&nbsp;<span class="ident" id="4112178">nil</span><span class="op" id="4112181">,</span>&nbsp;<span class="op" id="4112183">&amp;</span><span class="ident" id="4112184">OpError</span><span class="op" id="4112191">{</span><span class="ident" id="4112192">Op</span><span class="op" id="4112194">:</span>&nbsp;<span class="string" id="4112196">&#34;listen&#34;</span><span class="op" id="4112204">,</span>&nbsp;<span class="ident" id="4112206">Net</span><span class="op" id="4112209">:</span>&nbsp;<span class="ident" id="4112211">netProto</span><span class="op" id="4112219">,</span>&nbsp;<span class="ident" id="4112221">Addr</span><span class="op" id="4112225">:</span>&nbsp;<span class="ident" id="4112227">laddr</span><span class="op" id="4112232">,</span>&nbsp;<span class="ident" id="4112234">Err</span><span class="op" id="4112237">:</span>&nbsp;<span class="ident" id="4112239">err</span><span class="op" id="4112242">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4112245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4112248">return</span>&nbsp;<span class="ident" id="4112255">newIPConn</span><span class="op" id="4112264">(</span><span class="ident" id="4112265">fd</span><span class="op" id="4112267">)</span><span class="op" id="4112268">,</span>&nbsp;<span class="ident" id="4112270">nil</span><br>
<span class="lineno"></span><span class="op" id="4112274">}</span>
</div>
</body>
</html>
