<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc/jsonrpc</h2>
<ul>
<li><a href="/gostd/net/rpc/jsonrpc/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/server.go.html" class="current">server.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5613511">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5613567">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5613621">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5613672">package</span>&nbsp;<span class="ident" id="5613680">jsonrpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5613689">import</span>&nbsp;<span class="op" id="5613696">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5613699">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5613716">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5613726">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5613732">&#34;net/rpc&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5613743">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5613750">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5613753">var</span>&nbsp;<span class="ident" id="5613757">errMissingParams</span>&nbsp;<span class="op" id="5613774">=</span>&nbsp;<span class="ident" id="5613776">errors</span><span class="op" id="5613782">.</span><span class="ident" id="5613783">New</span><span class="op" id="5613786">(</span><span class="string" id="5613787">&#34;jsonrpc:&nbsp;request&nbsp;body&nbsp;missing&nbsp;params&#34;</span><span class="op" id="5613825">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5613828">type</span>&nbsp;<span class="ident" id="5613833">serverCodec</span>&nbsp;<span class="keyword" id="5613845">struct</span>&nbsp;<span class="op" id="5613852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613855">dec</span>&nbsp;<span class="op" id="5613859">*</span><span class="ident" id="5613860">json</span><span class="op" id="5613864">.</span><span class="ident" id="5613865">Decoder</span>&nbsp;<span class="comment" id="5613873">//&nbsp;for&nbsp;reading&nbsp;JSON&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613901">enc</span>&nbsp;<span class="op" id="5613905">*</span><span class="ident" id="5613906">json</span><span class="op" id="5613910">.</span><span class="ident" id="5613911">Encoder</span>&nbsp;<span class="comment" id="5613919">//&nbsp;for&nbsp;writing&nbsp;JSON&nbsp;values</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613947">c</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5613951">io</span><span class="op" id="5613953">.</span><span class="ident" id="5613954">Closer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5613963">//&nbsp;temporary&nbsp;work&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613988">req</span>&nbsp;<span class="ident" id="5613992">serverRequest</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5614008">//&nbsp;JSON-RPC&nbsp;clients&nbsp;can&nbsp;use&nbsp;arbitrary&nbsp;json&nbsp;values&nbsp;as&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5614075">//&nbsp;Package&nbsp;rpc&nbsp;expects&nbsp;uint64&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5614119">//&nbsp;We&nbsp;assign&nbsp;uint64&nbsp;sequence&nbsp;numbers&nbsp;to&nbsp;incoming&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5614178">//&nbsp;but&nbsp;save&nbsp;the&nbsp;original&nbsp;request&nbsp;ID&nbsp;in&nbsp;the&nbsp;pending&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5614235">//&nbsp;When&nbsp;rpc&nbsp;responds,&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number&nbsp;in</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5614288">//&nbsp;the&nbsp;response&nbsp;to&nbsp;find&nbsp;the&nbsp;original&nbsp;request&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614338">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5614346">sync</span><span class="op" id="5614350">.</span><span class="ident" id="5614351">Mutex</span>&nbsp;<span class="comment" id="5614357">//&nbsp;protects&nbsp;seq,&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614383">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5614391">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614399">pending</span>&nbsp;<span class="keyword" id="5614407">map</span><span class="op" id="5614410">[</span><span class="ident" id="5614411">uint64</span><span class="op" id="5614417">]</span><span class="op" id="5614418">*</span><span class="ident" id="5614419">json</span><span class="op" id="5614423">.</span><span class="ident" id="5614424">RawMessage</span><br>
<span class="lineno"></span><span class="op" id="5614435">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="5614438">//&nbsp;NewServerCodec&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.ServerCodec&nbsp;using&nbsp;JSON-RPC&nbsp;on&nbsp;conn.</span><br>
<span class="lineno"></span><span class="keyword" id="5614510">func</span>&nbsp;<span class="ident" id="5614515">NewServerCodec</span><span class="op" id="5614529">(</span><span class="ident" id="5614530">conn</span>&nbsp;<span class="ident" id="5614535">io</span><span class="op" id="5614537">.</span><span class="ident" id="5614538">ReadWriteCloser</span><span class="op" id="5614553">)</span>&nbsp;<span class="ident" id="5614555">rpc</span><span class="op" id="5614558">.</span><span class="ident" id="5614559">ServerCodec</span>&nbsp;<span class="op" id="5614571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614574">return</span>&nbsp;<span class="op" id="5614581">&amp;</span><span class="ident" id="5614582">serverCodec</span><span class="op" id="5614593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614597">dec</span><span class="op" id="5614600">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5614606">json</span><span class="op" id="5614610">.</span><span class="ident" id="5614611">NewDecoder</span><span class="op" id="5614621">(</span><span class="ident" id="5614622">conn</span><span class="op" id="5614626">)</span><span class="op" id="5614627">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614631">enc</span><span class="op" id="5614634">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5614640">json</span><span class="op" id="5614644">.</span><span class="ident" id="5614645">NewEncoder</span><span class="op" id="5614655">(</span><span class="ident" id="5614656">conn</span><span class="op" id="5614660">)</span><span class="op" id="5614661">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614665">c</span><span class="op" id="5614666">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5614674">conn</span><span class="op" id="5614678">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614682">pending</span><span class="op" id="5614689">:</span>&nbsp;<span class="builtinfunc" id="5614691">make</span><span class="op" id="5614695">(</span><span class="keyword" id="5614696">map</span><span class="op" id="5614699">[</span><span class="ident" id="5614700">uint64</span><span class="op" id="5614706">]</span><span class="op" id="5614707">*</span><span class="ident" id="5614708">json</span><span class="op" id="5614712">.</span><span class="ident" id="5614713">RawMessage</span><span class="op" id="5614723">)</span><span class="op" id="5614724">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5614727">}</span><br>
<span class="lineno"></span><span class="op" id="5614729">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="5614732">type</span>&nbsp;<span class="ident" id="5614737">serverRequest</span>&nbsp;<span class="keyword" id="5614751">struct</span>&nbsp;<span class="op" id="5614758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614761">Method</span>&nbsp;<span class="builtintype" id="5614768">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5614785">`json:&#34;method&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614802">Params</span>&nbsp;<span class="op" id="5614809">*</span><span class="ident" id="5614810">json</span><span class="op" id="5614814">.</span><span class="ident" id="5614815">RawMessage</span>&nbsp;<span class="string" id="5614826">`json:&#34;params&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614843">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5614850">*</span><span class="ident" id="5614851">json</span><span class="op" id="5614855">.</span><span class="ident" id="5614856">RawMessage</span>&nbsp;<span class="string" id="5614867">`json:&#34;id&#34;`</span><br>
<span class="lineno">50</span><span class="op" id="5614879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5614882">func</span>&nbsp;<span class="op" id="5614887">(</span><span class="ident" id="5614888">r</span>&nbsp;<span class="op" id="5614890">*</span><span class="ident" id="5614891">serverRequest</span><span class="op" id="5614904">)</span>&nbsp;<span class="ident" id="5614906">reset</span><span class="op" id="5614911">(</span><span class="op" id="5614912">)</span>&nbsp;<span class="op" id="5614914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614917">r</span><span class="op" id="5614918">.</span><span class="ident" id="5614919">Method</span>&nbsp;<span class="op" id="5614926">=</span>&nbsp;<span class="string" id="5614928">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614932">r</span><span class="op" id="5614933">.</span><span class="ident" id="5614934">Params</span>&nbsp;<span class="op" id="5614941">=</span>&nbsp;<span class="ident" id="5614943">nil</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614948">r</span><span class="op" id="5614949">.</span><span class="ident" id="5614950">Id</span>&nbsp;<span class="op" id="5614953">=</span>&nbsp;<span class="ident" id="5614955">nil</span><br>
<span class="lineno"></span><span class="op" id="5614959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5614962">type</span>&nbsp;<span class="ident" id="5614967">serverResponse</span>&nbsp;<span class="keyword" id="5614982">struct</span>&nbsp;<span class="op" id="5614989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614992">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5614999">*</span><span class="ident" id="5615000">json</span><span class="op" id="5615004">.</span><span class="ident" id="5615005">RawMessage</span>&nbsp;<span class="string" id="5615016">`json:&#34;id&#34;`</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615029">Result</span>&nbsp;<span class="keyword" id="5615036">interface</span><span class="op" id="5615045">{</span><span class="op" id="5615046">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5615053">`json:&#34;result&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615070">Error</span>&nbsp;&nbsp;<span class="keyword" id="5615077">interface</span><span class="op" id="5615086">{</span><span class="op" id="5615087">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5615094">`json:&#34;error&#34;`</span><br>
<span class="lineno"></span><span class="op" id="5615109">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5615112">func</span>&nbsp;<span class="op" id="5615117">(</span><span class="ident" id="5615118">c</span>&nbsp;<span class="op" id="5615120">*</span><span class="ident" id="5615121">serverCodec</span><span class="op" id="5615132">)</span>&nbsp;<span class="ident" id="5615134">ReadRequestHeader</span><span class="op" id="5615151">(</span><span class="ident" id="5615152">r</span>&nbsp;<span class="op" id="5615154">*</span><span class="ident" id="5615155">rpc</span><span class="op" id="5615158">.</span><span class="ident" id="5615159">Request</span><span class="op" id="5615166">)</span>&nbsp;<span class="builtintype" id="5615168">error</span>&nbsp;<span class="op" id="5615174">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615177">c</span><span class="op" id="5615178">.</span><span class="ident" id="5615179">req</span><span class="op" id="5615182">.</span><span class="ident" id="5615183">reset</span><span class="op" id="5615188">(</span><span class="op" id="5615189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615192">if</span>&nbsp;<span class="ident" id="5615195">err</span>&nbsp;<span class="op" id="5615199">:=</span>&nbsp;<span class="ident" id="5615202">c</span><span class="op" id="5615203">.</span><span class="ident" id="5615204">dec</span><span class="op" id="5615207">.</span><span class="ident" id="5615208">Decode</span><span class="op" id="5615214">(</span><span class="op" id="5615215">&amp;</span><span class="ident" id="5615216">c</span><span class="op" id="5615217">.</span><span class="ident" id="5615218">req</span><span class="op" id="5615221">)</span><span class="op" id="5615222">;</span>&nbsp;<span class="ident" id="5615224">err</span>&nbsp;<span class="op" id="5615228">!=</span>&nbsp;<span class="ident" id="5615231">nil</span>&nbsp;<span class="op" id="5615235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615239">return</span>&nbsp;<span class="ident" id="5615246">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5615251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615254">r</span><span class="op" id="5615255">.</span><span class="ident" id="5615256">ServiceMethod</span>&nbsp;<span class="op" id="5615270">=</span>&nbsp;<span class="ident" id="5615272">c</span><span class="op" id="5615273">.</span><span class="ident" id="5615274">req</span><span class="op" id="5615277">.</span><span class="ident" id="5615278">Method</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5615287">//&nbsp;JSON&nbsp;request&nbsp;id&nbsp;can&nbsp;be&nbsp;any&nbsp;JSON&nbsp;value;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5615330">//&nbsp;RPC&nbsp;package&nbsp;expects&nbsp;uint64.&nbsp;&nbsp;Translate&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5615376">//&nbsp;internal&nbsp;uint64&nbsp;and&nbsp;save&nbsp;JSON&nbsp;on&nbsp;the&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615423">c</span><span class="op" id="5615424">.</span><span class="ident" id="5615425">mutex</span><span class="op" id="5615430">.</span><span class="ident" id="5615431">Lock</span><span class="op" id="5615435">(</span><span class="op" id="5615436">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615439">c</span><span class="op" id="5615440">.</span><span class="ident" id="5615441">seq</span><span class="op" id="5615444">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615448">c</span><span class="op" id="5615449">.</span><span class="ident" id="5615450">pending</span><span class="op" id="5615457">[</span><span class="ident" id="5615458">c</span><span class="op" id="5615459">.</span><span class="ident" id="5615460">seq</span><span class="op" id="5615463">]</span>&nbsp;<span class="op" id="5615465">=</span>&nbsp;<span class="ident" id="5615467">c</span><span class="op" id="5615468">.</span><span class="ident" id="5615469">req</span><span class="op" id="5615472">.</span><span class="ident" id="5615473">Id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615477">c</span><span class="op" id="5615478">.</span><span class="ident" id="5615479">req</span><span class="op" id="5615482">.</span><span class="ident" id="5615483">Id</span>&nbsp;<span class="op" id="5615486">=</span>&nbsp;<span class="ident" id="5615488">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615493">r</span><span class="op" id="5615494">.</span><span class="ident" id="5615495">Seq</span>&nbsp;<span class="op" id="5615499">=</span>&nbsp;<span class="ident" id="5615501">c</span><span class="op" id="5615502">.</span><span class="ident" id="5615503">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615508">c</span><span class="op" id="5615509">.</span><span class="ident" id="5615510">mutex</span><span class="op" id="5615515">.</span><span class="ident" id="5615516">Unlock</span><span class="op" id="5615522">(</span><span class="op" id="5615523">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615527">return</span>&nbsp;<span class="ident" id="5615534">nil</span><br>
<span class="lineno"></span><span class="op" id="5615538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5615541">func</span>&nbsp;<span class="op" id="5615546">(</span><span class="ident" id="5615547">c</span>&nbsp;<span class="op" id="5615549">*</span><span class="ident" id="5615550">serverCodec</span><span class="op" id="5615561">)</span>&nbsp;<span class="ident" id="5615563">ReadRequestBody</span><span class="op" id="5615578">(</span><span class="ident" id="5615579">x</span>&nbsp;<span class="keyword" id="5615581">interface</span><span class="op" id="5615590">{</span><span class="op" id="5615591">}</span><span class="op" id="5615592">)</span>&nbsp;<span class="builtintype" id="5615594">error</span>&nbsp;<span class="op" id="5615600">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615603">if</span>&nbsp;<span class="ident" id="5615606">x</span>&nbsp;<span class="op" id="5615608">==</span>&nbsp;<span class="ident" id="5615611">nil</span>&nbsp;<span class="op" id="5615615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615619">return</span>&nbsp;<span class="ident" id="5615626">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5615631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615634">if</span>&nbsp;<span class="ident" id="5615637">c</span><span class="op" id="5615638">.</span><span class="ident" id="5615639">req</span><span class="op" id="5615642">.</span><span class="ident" id="5615643">Params</span>&nbsp;<span class="op" id="5615650">==</span>&nbsp;<span class="ident" id="5615653">nil</span>&nbsp;<span class="op" id="5615657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615661">return</span>&nbsp;<span class="ident" id="5615668">errMissingParams</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5615686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5615689">//&nbsp;JSON&nbsp;params&nbsp;is&nbsp;array&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5615721">//&nbsp;RPC&nbsp;params&nbsp;is&nbsp;struct.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5615747">//&nbsp;Unmarshal&nbsp;into&nbsp;array&nbsp;containing&nbsp;struct&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5615799">//&nbsp;Should&nbsp;think&nbsp;about&nbsp;making&nbsp;RPC&nbsp;more&nbsp;general.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615847">var</span>&nbsp;<span class="ident" id="5615851">params</span>&nbsp;<span class="op" id="5615858">[</span><span class="num" id="5615859">1</span><span class="op" id="5615860">]</span><span class="keyword" id="5615861">interface</span><span class="op" id="5615870">{</span><span class="op" id="5615871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615874">params</span><span class="op" id="5615880">[</span><span class="num" id="5615881">0</span><span class="op" id="5615882">]</span>&nbsp;<span class="op" id="5615884">=</span>&nbsp;<span class="ident" id="5615886">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615889">return</span>&nbsp;<span class="ident" id="5615896">json</span><span class="op" id="5615900">.</span><span class="ident" id="5615901">Unmarshal</span><span class="op" id="5615910">(</span><span class="op" id="5615911">*</span><span class="ident" id="5615912">c</span><span class="op" id="5615913">.</span><span class="ident" id="5615914">req</span><span class="op" id="5615917">.</span><span class="ident" id="5615918">Params</span><span class="op" id="5615924">,</span>&nbsp;<span class="op" id="5615926">&amp;</span><span class="ident" id="5615927">params</span><span class="op" id="5615933">)</span><br>
<span class="lineno"></span><span class="op" id="5615935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="5615938">var</span>&nbsp;<span class="ident" id="5615942">null</span>&nbsp;<span class="op" id="5615947">=</span>&nbsp;<span class="ident" id="5615949">json</span><span class="op" id="5615953">.</span><span class="ident" id="5615954">RawMessage</span><span class="op" id="5615964">(</span><span class="op" id="5615965">[</span><span class="op" id="5615966">]</span><span class="builtintype" id="5615967">byte</span><span class="op" id="5615971">(</span><span class="string" id="5615972">&#34;null&#34;</span><span class="op" id="5615978">)</span><span class="op" id="5615979">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5615982">func</span>&nbsp;<span class="op" id="5615987">(</span><span class="ident" id="5615988">c</span>&nbsp;<span class="op" id="5615990">*</span><span class="ident" id="5615991">serverCodec</span><span class="op" id="5616002">)</span>&nbsp;<span class="ident" id="5616004">WriteResponse</span><span class="op" id="5616017">(</span><span class="ident" id="5616018">r</span>&nbsp;<span class="op" id="5616020">*</span><span class="ident" id="5616021">rpc</span><span class="op" id="5616024">.</span><span class="ident" id="5616025">Response</span><span class="op" id="5616033">,</span>&nbsp;<span class="ident" id="5616035">x</span>&nbsp;<span class="keyword" id="5616037">interface</span><span class="op" id="5616046">{</span><span class="op" id="5616047">}</span><span class="op" id="5616048">)</span>&nbsp;<span class="builtintype" id="5616050">error</span>&nbsp;<span class="op" id="5616056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616059">c</span><span class="op" id="5616060">.</span><span class="ident" id="5616061">mutex</span><span class="op" id="5616066">.</span><span class="ident" id="5616067">Lock</span><span class="op" id="5616071">(</span><span class="op" id="5616072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616075">b</span><span class="op" id="5616076">,</span>&nbsp;<span class="ident" id="5616078">ok</span>&nbsp;<span class="op" id="5616081">:=</span>&nbsp;<span class="ident" id="5616084">c</span><span class="op" id="5616085">.</span><span class="ident" id="5616086">pending</span><span class="op" id="5616093">[</span><span class="ident" id="5616094">r</span><span class="op" id="5616095">.</span><span class="ident" id="5616096">Seq</span><span class="op" id="5616099">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616102">if</span>&nbsp;<span class="op" id="5616105">!</span><span class="ident" id="5616106">ok</span>&nbsp;<span class="op" id="5616109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616113">c</span><span class="op" id="5616114">.</span><span class="ident" id="5616115">mutex</span><span class="op" id="5616120">.</span><span class="ident" id="5616121">Unlock</span><span class="op" id="5616127">(</span><span class="op" id="5616128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616132">return</span>&nbsp;<span class="ident" id="5616139">errors</span><span class="op" id="5616145">.</span><span class="ident" id="5616146">New</span><span class="op" id="5616149">(</span><span class="string" id="5616150">&#34;invalid&nbsp;sequence&nbsp;number&nbsp;in&nbsp;response&#34;</span><span class="op" id="5616187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5616190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5616193">delete</span><span class="op" id="5616199">(</span><span class="ident" id="5616200">c</span><span class="op" id="5616201">.</span><span class="ident" id="5616202">pending</span><span class="op" id="5616209">,</span>&nbsp;<span class="ident" id="5616211">r</span><span class="op" id="5616212">.</span><span class="ident" id="5616213">Seq</span><span class="op" id="5616216">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616219">c</span><span class="op" id="5616220">.</span><span class="ident" id="5616221">mutex</span><span class="op" id="5616226">.</span><span class="ident" id="5616227">Unlock</span><span class="op" id="5616233">(</span><span class="op" id="5616234">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616238">if</span>&nbsp;<span class="ident" id="5616241">b</span>&nbsp;<span class="op" id="5616243">==</span>&nbsp;<span class="ident" id="5616246">nil</span>&nbsp;<span class="op" id="5616250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5616254">//&nbsp;Invalid&nbsp;request&nbsp;so&nbsp;no&nbsp;id.&nbsp;&nbsp;Use&nbsp;JSON&nbsp;null.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616301">b</span>&nbsp;<span class="op" id="5616303">=</span>&nbsp;<span class="op" id="5616305">&amp;</span><span class="ident" id="5616306">null</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5616312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616315">resp</span>&nbsp;<span class="op" id="5616320">:=</span>&nbsp;<span class="ident" id="5616323">serverResponse</span><span class="op" id="5616337">{</span><span class="ident" id="5616338">Id</span><span class="op" id="5616340">:</span>&nbsp;<span class="ident" id="5616342">b</span><span class="op" id="5616343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616346">if</span>&nbsp;<span class="ident" id="5616349">r</span><span class="op" id="5616350">.</span><span class="ident" id="5616351">Error</span>&nbsp;<span class="op" id="5616357">==</span>&nbsp;<span class="string" id="5616360">&#34;&#34;</span>&nbsp;<span class="op" id="5616363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616367">resp</span><span class="op" id="5616371">.</span><span class="ident" id="5616372">Result</span>&nbsp;<span class="op" id="5616379">=</span>&nbsp;<span class="ident" id="5616381">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5616384">}</span>&nbsp;<span class="keyword" id="5616386">else</span>&nbsp;<span class="op" id="5616391">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616395">resp</span><span class="op" id="5616399">.</span><span class="ident" id="5616400">Error</span>&nbsp;<span class="op" id="5616406">=</span>&nbsp;<span class="ident" id="5616408">r</span><span class="op" id="5616409">.</span><span class="ident" id="5616410">Error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5616417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616420">return</span>&nbsp;<span class="ident" id="5616427">c</span><span class="op" id="5616428">.</span><span class="ident" id="5616429">enc</span><span class="op" id="5616432">.</span><span class="ident" id="5616433">Encode</span><span class="op" id="5616439">(</span><span class="ident" id="5616440">resp</span><span class="op" id="5616444">)</span><br>
<span class="lineno"></span><span class="op" id="5616446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="keyword" id="5616449">func</span>&nbsp;<span class="op" id="5616454">(</span><span class="ident" id="5616455">c</span>&nbsp;<span class="op" id="5616457">*</span><span class="ident" id="5616458">serverCodec</span><span class="op" id="5616469">)</span>&nbsp;<span class="ident" id="5616471">Close</span><span class="op" id="5616476">(</span><span class="op" id="5616477">)</span>&nbsp;<span class="builtintype" id="5616479">error</span>&nbsp;<span class="op" id="5616485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616488">return</span>&nbsp;<span class="ident" id="5616495">c</span><span class="op" id="5616496">.</span><span class="ident" id="5616497">c</span><span class="op" id="5616498">.</span><span class="ident" id="5616499">Close</span><span class="op" id="5616504">(</span><span class="op" id="5616505">)</span><br>
<span class="lineno"></span><span class="op" id="5616507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5616510">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;JSON-RPC&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno">130</span><span class="comment" id="5616572">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5616643">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5616704">func</span>&nbsp;<span class="ident" id="5616709">ServeConn</span><span class="op" id="5616718">(</span><span class="ident" id="5616719">conn</span>&nbsp;<span class="ident" id="5616724">io</span><span class="op" id="5616726">.</span><span class="ident" id="5616727">ReadWriteCloser</span><span class="op" id="5616742">)</span>&nbsp;<span class="op" id="5616744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616747">rpc</span><span class="op" id="5616750">.</span><span class="ident" id="5616751">ServeCodec</span><span class="op" id="5616761">(</span><span class="ident" id="5616762">NewServerCodec</span><span class="op" id="5616776">(</span><span class="ident" id="5616777">conn</span><span class="op" id="5616781">)</span><span class="op" id="5616782">)</span><br>
<span class="lineno"></span><span class="op" id="5616784">}</span>
</div>
</body>
</html>
