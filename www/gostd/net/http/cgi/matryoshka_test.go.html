<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html" class="current">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6947974">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6948029">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6948083">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6948134">//&nbsp;Tests&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;program&nbsp;running&nbsp;under&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;host&nbsp;process.</span><br>
<span class="lineno"></span><span class="comment" id="6948197">//&nbsp;Further,&nbsp;the&nbsp;two&nbsp;programs&nbsp;are&nbsp;the&nbsp;same&nbsp;binary,&nbsp;just&nbsp;checking</span><br>
<span class="lineno"></span><span class="comment" id="6948261">//&nbsp;their&nbsp;environment&nbsp;to&nbsp;figure&nbsp;out&nbsp;what&nbsp;mode&nbsp;to&nbsp;run&nbsp;in.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6948318">package</span>&nbsp;<span class="ident" id="6948326">cgi</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="6948331">import</span>&nbsp;<span class="op" id="6948338">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6948341">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6948350">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6948360">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6948367">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6948373">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6948385">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6948406">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6948412">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6948423">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6948434">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6948441">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6948444">//&nbsp;This&nbsp;test&nbsp;is&nbsp;a&nbsp;CGI&nbsp;host&nbsp;(testing&nbsp;host.go)&nbsp;that&nbsp;runs&nbsp;its&nbsp;own&nbsp;binary</span><br>
<span class="lineno">25</span><span class="comment" id="6948514">//&nbsp;as&nbsp;a&nbsp;child&nbsp;process&nbsp;testing&nbsp;the&nbsp;other&nbsp;half&nbsp;of&nbsp;CGI&nbsp;(child.go).</span><br>
<span class="lineno"></span><span class="keyword" id="6948578">func</span>&nbsp;<span class="ident" id="6948583">TestHostingOurselves</span><span class="op" id="6948603">(</span><span class="ident" id="6948604">t</span>&nbsp;<span class="op" id="6948606">*</span><span class="ident" id="6948607">testing</span><span class="op" id="6948614">.</span><span class="ident" id="6948615">T</span><span class="op" id="6948616">)</span>&nbsp;<span class="op" id="6948618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6948621">if</span>&nbsp;<span class="ident" id="6948624">runtime</span><span class="op" id="6948631">.</span><span class="ident" id="6948632">GOOS</span>&nbsp;<span class="op" id="6948637">==</span>&nbsp;<span class="string" id="6948640">&#34;nacl&#34;</span>&nbsp;<span class="op" id="6948647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6948651">t</span><span class="op" id="6948652">.</span><span class="ident" id="6948653">Skip</span><span class="op" id="6948657">(</span><span class="string" id="6948658">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="6948676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6948679">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6948683">h</span>&nbsp;<span class="op" id="6948685">:=</span>&nbsp;<span class="op" id="6948688">&amp;</span><span class="ident" id="6948689">Handler</span><span class="op" id="6948696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6948700">Path</span><span class="op" id="6948704">:</span>&nbsp;<span class="ident" id="6948706">os</span><span class="op" id="6948708">.</span><span class="ident" id="6948709">Args</span><span class="op" id="6948713">[</span><span class="num" id="6948714">0</span><span class="op" id="6948715">]</span><span class="op" id="6948716">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6948720">Root</span><span class="op" id="6948724">:</span>&nbsp;<span class="string" id="6948726">&#34;/test.go&#34;</span><span class="op" id="6948736">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6948740">Args</span><span class="op" id="6948744">:</span>&nbsp;<span class="op" id="6948746">[</span><span class="op" id="6948747">]</span><span class="builtintype" id="6948748">string</span><span class="op" id="6948754">{</span><span class="string" id="6948755">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="6948788">}</span><span class="op" id="6948789">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6948792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6948795">expectedMap</span>&nbsp;<span class="op" id="6948807">:=</span>&nbsp;<span class="keyword" id="6948810">map</span><span class="op" id="6948813">[</span><span class="builtintype" id="6948814">string</span><span class="op" id="6948820">]</span><span class="builtintype" id="6948821">string</span><span class="op" id="6948827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6948831">&#34;test&#34;</span><span class="op" id="6948837">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6948856">&#34;Hello&nbsp;CGI-in-CGI&#34;</span><span class="op" id="6948874">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6948878">&#34;param-a&#34;</span><span class="op" id="6948887">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6948903">&#34;b&#34;</span><span class="op" id="6948906">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6948910">&#34;param-foo&#34;</span><span class="op" id="6948921">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6948935">&#34;bar&#34;</span><span class="op" id="6948940">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6948944">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="6948967">:</span>&nbsp;<span class="string" id="6948969">&#34;CGI/1.1&#34;</span><span class="op" id="6948978">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6948982">&#34;env-HTTP_HOST&#34;</span><span class="op" id="6948997">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6949007">&#34;example.com&#34;</span><span class="op" id="6949020">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6949024">&#34;env-PATH_INFO&#34;</span><span class="op" id="6949039">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6949049">&#34;&#34;</span><span class="op" id="6949051">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6949055">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6949073">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6949080">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="6949093">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6949097">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="6949114">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6949122">&#34;1.2.3.4&#34;</span><span class="op" id="6949131">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6949135">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="6949152">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6949160">&#34;1.2.3.4&#34;</span><span class="op" id="6949169">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6949173">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="6949193">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6949198">&#34;GET&#34;</span><span class="op" id="6949203">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6949207">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6949224">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6949232">&#34;/test.go?foo=bar&amp;a=b&#34;</span><span class="op" id="6949254">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6949258">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6949279">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6949283">os</span><span class="op" id="6949285">.</span><span class="ident" id="6949286">Args</span><span class="op" id="6949290">[</span><span class="num" id="6949291">0</span><span class="op" id="6949292">]</span><span class="op" id="6949293">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6949297">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6949314">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6949322">&#34;/test.go&#34;</span><span class="op" id="6949332">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6949336">&#34;env-SERVER_NAME&#34;</span><span class="op" id="6949353">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6949361">&#34;example.com&#34;</span><span class="op" id="6949374">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6949378">&#34;env-SERVER_PORT&#34;</span><span class="op" id="6949395">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6949403">&#34;80&#34;</span><span class="op" id="6949407">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6949411">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="6949432">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="6949436">&#34;go&#34;</span><span class="op" id="6949440">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6949443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6949446">replay</span>&nbsp;<span class="op" id="6949453">:=</span>&nbsp;<span class="ident" id="6949456">runCgiTest</span><span class="op" id="6949466">(</span><span class="ident" id="6949467">t</span><span class="op" id="6949468">,</span>&nbsp;<span class="ident" id="6949470">h</span><span class="op" id="6949471">,</span>&nbsp;<span class="string" id="6949473">&#34;GET&nbsp;/test.go?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6949531">,</span>&nbsp;<span class="ident" id="6949533">expectedMap</span><span class="op" id="6949544">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6949548">if</span>&nbsp;<span class="ident" id="6949551">expected</span><span class="op" id="6949559">,</span>&nbsp;<span class="ident" id="6949561">got</span>&nbsp;<span class="op" id="6949565">:=</span>&nbsp;<span class="string" id="6949568">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="6949594">,</span>&nbsp;<span class="ident" id="6949596">replay</span><span class="op" id="6949602">.</span><span class="ident" id="6949603">Header</span><span class="op" id="6949609">(</span><span class="op" id="6949610">)</span><span class="op" id="6949611">.</span><span class="ident" id="6949612">Get</span><span class="op" id="6949615">(</span><span class="string" id="6949616">&#34;Content-Type&#34;</span><span class="op" id="6949630">)</span><span class="op" id="6949631">;</span>&nbsp;<span class="ident" id="6949633">got</span>&nbsp;<span class="op" id="6949637">!=</span>&nbsp;<span class="ident" id="6949640">expected</span>&nbsp;<span class="op" id="6949649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6949653">t</span><span class="op" id="6949654">.</span><span class="ident" id="6949655">Errorf</span><span class="op" id="6949661">(</span><span class="string" id="6949662">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6949701">,</span>&nbsp;<span class="ident" id="6949703">got</span><span class="op" id="6949706">,</span>&nbsp;<span class="ident" id="6949708">expected</span><span class="op" id="6949716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6949719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6949722">if</span>&nbsp;<span class="ident" id="6949725">expected</span><span class="op" id="6949733">,</span>&nbsp;<span class="ident" id="6949735">got</span>&nbsp;<span class="op" id="6949739">:=</span>&nbsp;<span class="string" id="6949742">&#34;X-Test-Value&#34;</span><span class="op" id="6949756">,</span>&nbsp;<span class="ident" id="6949758">replay</span><span class="op" id="6949764">.</span><span class="ident" id="6949765">Header</span><span class="op" id="6949771">(</span><span class="op" id="6949772">)</span><span class="op" id="6949773">.</span><span class="ident" id="6949774">Get</span><span class="op" id="6949777">(</span><span class="string" id="6949778">&#34;X-Test-Header&#34;</span><span class="op" id="6949793">)</span><span class="op" id="6949794">;</span>&nbsp;<span class="ident" id="6949796">got</span>&nbsp;<span class="op" id="6949800">!=</span>&nbsp;<span class="ident" id="6949803">expected</span>&nbsp;<span class="op" id="6949812">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6949816">t</span><span class="op" id="6949817">.</span><span class="ident" id="6949818">Errorf</span><span class="op" id="6949824">(</span><span class="string" id="6949825">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6949865">,</span>&nbsp;<span class="ident" id="6949867">got</span><span class="op" id="6949870">,</span>&nbsp;<span class="ident" id="6949872">expected</span><span class="op" id="6949880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6949883">}</span><br>
<span class="lineno"></span><span class="op" id="6949885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6949888">type</span>&nbsp;<span class="ident" id="6949893">customWriterRecorder</span>&nbsp;<span class="keyword" id="6949914">struct</span>&nbsp;<span class="op" id="6949921">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6949924">w</span>&nbsp;<span class="ident" id="6949926">io</span><span class="op" id="6949928">.</span><span class="ident" id="6949929">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6949937">*</span><span class="ident" id="6949938">httptest</span><span class="op" id="6949946">.</span><span class="ident" id="6949947">ResponseRecorder</span><br>
<span class="lineno"></span><span class="op" id="6949964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6949967">func</span>&nbsp;<span class="op" id="6949972">(</span><span class="ident" id="6949973">r</span>&nbsp;<span class="op" id="6949975">*</span><span class="ident" id="6949976">customWriterRecorder</span><span class="op" id="6949996">)</span>&nbsp;<span class="ident" id="6949998">Write</span><span class="op" id="6950003">(</span><span class="ident" id="6950004">p</span>&nbsp;<span class="op" id="6950006">[</span><span class="op" id="6950007">]</span><span class="builtintype" id="6950008">byte</span><span class="op" id="6950012">)</span>&nbsp;<span class="op" id="6950014">(</span><span class="ident" id="6950015">n</span>&nbsp;<span class="builtintype" id="6950017">int</span><span class="op" id="6950020">,</span>&nbsp;<span class="ident" id="6950022">err</span>&nbsp;<span class="builtintype" id="6950026">error</span><span class="op" id="6950031">)</span>&nbsp;<span class="op" id="6950033">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6950036">return</span>&nbsp;<span class="ident" id="6950043">r</span><span class="op" id="6950044">.</span><span class="ident" id="6950045">w</span><span class="op" id="6950046">.</span><span class="ident" id="6950047">Write</span><span class="op" id="6950052">(</span><span class="ident" id="6950053">p</span><span class="op" id="6950054">)</span><br>
<span class="lineno"></span><span class="op" id="6950056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6950059">type</span>&nbsp;<span class="ident" id="6950064">limitWriter</span>&nbsp;<span class="keyword" id="6950076">struct</span>&nbsp;<span class="op" id="6950083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6950086">w</span>&nbsp;<span class="ident" id="6950088">io</span><span class="op" id="6950090">.</span><span class="ident" id="6950091">Writer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6950099">n</span>&nbsp;<span class="builtintype" id="6950101">int</span><br>
<span class="lineno"></span><span class="op" id="6950105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6950108">func</span>&nbsp;<span class="op" id="6950113">(</span><span class="ident" id="6950114">w</span>&nbsp;<span class="op" id="6950116">*</span><span class="ident" id="6950117">limitWriter</span><span class="op" id="6950128">)</span>&nbsp;<span class="ident" id="6950130">Write</span><span class="op" id="6950135">(</span><span class="ident" id="6950136">p</span>&nbsp;<span class="op" id="6950138">[</span><span class="op" id="6950139">]</span><span class="builtintype" id="6950140">byte</span><span class="op" id="6950144">)</span>&nbsp;<span class="op" id="6950146">(</span><span class="ident" id="6950147">n</span>&nbsp;<span class="builtintype" id="6950149">int</span><span class="op" id="6950152">,</span>&nbsp;<span class="ident" id="6950154">err</span>&nbsp;<span class="builtintype" id="6950158">error</span><span class="op" id="6950163">)</span>&nbsp;<span class="op" id="6950165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6950168">if</span>&nbsp;<span class="builtinfunc" id="6950171">len</span><span class="op" id="6950174">(</span><span class="ident" id="6950175">p</span><span class="op" id="6950176">)</span>&nbsp;<span class="op" id="6950178">&gt;</span>&nbsp;<span class="ident" id="6950180">w</span><span class="op" id="6950181">.</span><span class="ident" id="6950182">n</span>&nbsp;<span class="op" id="6950184">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6950188">p</span>&nbsp;<span class="op" id="6950190">=</span>&nbsp;<span class="ident" id="6950192">p</span><span class="op" id="6950193">[</span><span class="op" id="6950194">:</span><span class="ident" id="6950195">w</span><span class="op" id="6950196">.</span><span class="ident" id="6950197">n</span><span class="op" id="6950198">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6950201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6950204">if</span>&nbsp;<span class="builtinfunc" id="6950207">len</span><span class="op" id="6950210">(</span><span class="ident" id="6950211">p</span><span class="op" id="6950212">)</span>&nbsp;<span class="op" id="6950214">&gt;</span>&nbsp;<span class="num" id="6950216">0</span>&nbsp;<span class="op" id="6950218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6950222">n</span><span class="op" id="6950223">,</span>&nbsp;<span class="ident" id="6950225">err</span>&nbsp;<span class="op" id="6950229">=</span>&nbsp;<span class="ident" id="6950231">w</span><span class="op" id="6950232">.</span><span class="ident" id="6950233">w</span><span class="op" id="6950234">.</span><span class="ident" id="6950235">Write</span><span class="op" id="6950240">(</span><span class="ident" id="6950241">p</span><span class="op" id="6950242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6950246">w</span><span class="op" id="6950247">.</span><span class="ident" id="6950248">n</span>&nbsp;<span class="op" id="6950250">-=</span>&nbsp;<span class="ident" id="6950253">n</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6950256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6950259">if</span>&nbsp;<span class="ident" id="6950262">w</span><span class="op" id="6950263">.</span><span class="ident" id="6950264">n</span>&nbsp;<span class="op" id="6950266">==</span>&nbsp;<span class="num" id="6950269">0</span>&nbsp;<span class="op" id="6950271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6950275">err</span>&nbsp;<span class="op" id="6950279">=</span>&nbsp;<span class="ident" id="6950281">errors</span><span class="op" id="6950287">.</span><span class="ident" id="6950288">New</span><span class="op" id="6950291">(</span><span class="string" id="6950292">&#34;past&nbsp;write&nbsp;limit&#34;</span><span class="op" id="6950310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6950313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6950316">return</span><br>
<span class="lineno">90</span><span class="op" id="6950323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6950326">//&nbsp;If&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying&nbsp;the&nbsp;child&#39;s&nbsp;output&nbsp;to&nbsp;the&nbsp;parent,&nbsp;test</span><br>
<span class="lineno"></span><span class="comment" id="6950396">//&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;child.</span><br>
<span class="lineno"></span><span class="keyword" id="6950423">func</span>&nbsp;<span class="ident" id="6950428">TestKillChildAfterCopyError</span><span class="op" id="6950455">(</span><span class="ident" id="6950456">t</span>&nbsp;<span class="op" id="6950458">*</span><span class="ident" id="6950459">testing</span><span class="op" id="6950466">.</span><span class="ident" id="6950467">T</span><span class="op" id="6950468">)</span>&nbsp;<span class="op" id="6950470">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6950473">if</span>&nbsp;<span class="ident" id="6950476">runtime</span><span class="op" id="6950483">.</span><span class="ident" id="6950484">GOOS</span>&nbsp;<span class="op" id="6950489">==</span>&nbsp;<span class="string" id="6950492">&#34;nacl&#34;</span>&nbsp;<span class="op" id="6950499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6950503">t</span><span class="op" id="6950504">.</span><span class="ident" id="6950505">Skip</span><span class="op" id="6950509">(</span><span class="string" id="6950510">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="6950528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6950531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6950535">defer</span>&nbsp;<span class="keyword" id="6950541">func</span><span class="op" id="6950545">(</span><span class="op" id="6950546">)</span>&nbsp;<span class="op" id="6950548">{</span>&nbsp;<span class="ident" id="6950550">testHookStartProcess</span>&nbsp;<span class="op" id="6950571">=</span>&nbsp;<span class="ident" id="6950573">nil</span>&nbsp;<span class="op" id="6950577">}</span><span class="op" id="6950578">(</span><span class="op" id="6950579">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6950582">proc</span>&nbsp;<span class="op" id="6950587">:=</span>&nbsp;<span class="builtinfunc" id="6950590">make</span><span class="op" id="6950594">(</span><span class="keyword" id="6950595">chan</span>&nbsp;<span class="op" id="6950600">*</span><span class="ident" id="6950601">os</span><span class="op" id="6950603">.</span><span class="ident" id="6950604">Process</span><span class="op" id="6950611">,</span>&nbsp;<span class="num" id="6950613">1</span><span class="op" id="6950614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6950617">testHookStartProcess</span>&nbsp;<span class="op" id="6950638">=</span>&nbsp;<span class="keyword" id="6950640">func</span><span class="op" id="6950644">(</span><span class="ident" id="6950645">p</span>&nbsp;<span class="op" id="6950647">*</span><span class="ident" id="6950648">os</span><span class="op" id="6950650">.</span><span class="ident" id="6950651">Process</span><span class="op" id="6950658">)</span>&nbsp;<span class="op" id="6950660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6950664">proc</span>&nbsp;<span class="op" id="6950669">&lt;-</span>&nbsp;<span class="ident" id="6950672">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6950675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6950679">h</span>&nbsp;<span class="op" id="6950681">:=</span>&nbsp;<span class="op" id="6950684">&amp;</span><span class="ident" id="6950685">Handler</span><span class="op" id="6950692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6950696">Path</span><span class="op" id="6950700">:</span>&nbsp;<span class="ident" id="6950702">os</span><span class="op" id="6950704">.</span><span class="ident" id="6950705">Args</span><span class="op" id="6950709">[</span><span class="num" id="6950710">0</span><span class="op" id="6950711">]</span><span class="op" id="6950712">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6950716">Root</span><span class="op" id="6950720">:</span>&nbsp;<span class="string" id="6950722">&#34;/test.go&#34;</span><span class="op" id="6950732">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6950736">Args</span><span class="op" id="6950740">:</span>&nbsp;<span class="op" id="6950742">[</span><span class="op" id="6950743">]</span><span class="builtintype" id="6950744">string</span><span class="op" id="6950750">{</span><span class="string" id="6950751">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="6950784">}</span><span class="op" id="6950785">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6950788">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6950791">req</span><span class="op" id="6950794">,</span>&nbsp;<span class="ident" id="6950796">_</span>&nbsp;<span class="op" id="6950798">:=</span>&nbsp;<span class="ident" id="6950801">http</span><span class="op" id="6950805">.</span><span class="ident" id="6950806">NewRequest</span><span class="op" id="6950816">(</span><span class="string" id="6950817">&#34;GET&#34;</span><span class="op" id="6950822">,</span>&nbsp;<span class="string" id="6950824">&#34;http://example.com/test.cgi?write-forever=1&#34;</span><span class="op" id="6950869">,</span>&nbsp;<span class="ident" id="6950871">nil</span><span class="op" id="6950874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6950877">rec</span>&nbsp;<span class="op" id="6950881">:=</span>&nbsp;<span class="ident" id="6950884">httptest</span><span class="op" id="6950892">.</span><span class="ident" id="6950893">NewRecorder</span><span class="op" id="6950904">(</span><span class="op" id="6950905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6950908">var</span>&nbsp;<span class="ident" id="6950912">out</span>&nbsp;<span class="ident" id="6950916">bytes</span><span class="op" id="6950921">.</span><span class="ident" id="6950922">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6950930">const</span>&nbsp;<span class="ident" id="6950936">writeLen</span>&nbsp;<span class="op" id="6950945">=</span>&nbsp;<span class="num" id="6950947">50</span>&nbsp;<span class="op" id="6950950">&lt;&lt;</span>&nbsp;<span class="num" id="6950953">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6950957">rw</span>&nbsp;<span class="op" id="6950960">:=</span>&nbsp;<span class="op" id="6950963">&amp;</span><span class="ident" id="6950964">customWriterRecorder</span><span class="op" id="6950984">{</span><span class="op" id="6950985">&amp;</span><span class="ident" id="6950986">limitWriter</span><span class="op" id="6950997">{</span><span class="op" id="6950998">&amp;</span><span class="ident" id="6950999">out</span><span class="op" id="6951002">,</span>&nbsp;<span class="ident" id="6951004">writeLen</span><span class="op" id="6951012">}</span><span class="op" id="6951013">,</span>&nbsp;<span class="ident" id="6951015">rec</span><span class="op" id="6951018">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6951022">donec</span>&nbsp;<span class="op" id="6951028">:=</span>&nbsp;<span class="builtinfunc" id="6951031">make</span><span class="op" id="6951035">(</span><span class="keyword" id="6951036">chan</span>&nbsp;<span class="builtintype" id="6951041">bool</span><span class="op" id="6951045">,</span>&nbsp;<span class="num" id="6951047">1</span><span class="op" id="6951048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6951051">go</span>&nbsp;<span class="keyword" id="6951054">func</span><span class="op" id="6951058">(</span><span class="op" id="6951059">)</span>&nbsp;<span class="op" id="6951061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6951065">h</span><span class="op" id="6951066">.</span><span class="ident" id="6951067">ServeHTTP</span><span class="op" id="6951076">(</span><span class="ident" id="6951077">rw</span><span class="op" id="6951079">,</span>&nbsp;<span class="ident" id="6951081">req</span><span class="op" id="6951084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6951088">donec</span>&nbsp;<span class="op" id="6951094">&lt;-</span>&nbsp;<span class="builtintype" id="6951097">true</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6951103">}</span><span class="op" id="6951104">(</span><span class="op" id="6951105">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6951109">select</span>&nbsp;<span class="op" id="6951116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6951119">case</span>&nbsp;<span class="op" id="6951124">&lt;-</span><span class="ident" id="6951126">donec</span><span class="op" id="6951131">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6951135">if</span>&nbsp;<span class="ident" id="6951138">out</span><span class="op" id="6951141">.</span><span class="ident" id="6951142">Len</span><span class="op" id="6951145">(</span><span class="op" id="6951146">)</span>&nbsp;<span class="op" id="6951148">!=</span>&nbsp;<span class="ident" id="6951151">writeLen</span>&nbsp;<span class="op" id="6951160">||</span>&nbsp;<span class="ident" id="6951163">out</span><span class="op" id="6951166">.</span><span class="ident" id="6951167">Bytes</span><span class="op" id="6951172">(</span><span class="op" id="6951173">)</span><span class="op" id="6951174">[</span><span class="num" id="6951175">0</span><span class="op" id="6951176">]</span>&nbsp;<span class="op" id="6951178">!=</span>&nbsp;<span class="string" id="6951181">&#39;a&#39;</span>&nbsp;<span class="op" id="6951185">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6951190">t</span><span class="op" id="6951191">.</span><span class="ident" id="6951192">Errorf</span><span class="op" id="6951198">(</span><span class="string" id="6951199">&#34;unexpected&nbsp;output:&nbsp;%q&#34;</span><span class="op" id="6951222">,</span>&nbsp;<span class="ident" id="6951224">out</span><span class="op" id="6951227">.</span><span class="ident" id="6951228">Bytes</span><span class="op" id="6951233">(</span><span class="op" id="6951234">)</span><span class="op" id="6951235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6951239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6951242">case</span>&nbsp;<span class="op" id="6951247">&lt;-</span><span class="ident" id="6951249">time</span><span class="op" id="6951253">.</span><span class="ident" id="6951254">After</span><span class="op" id="6951259">(</span><span class="num" id="6951260">5</span>&nbsp;<span class="op" id="6951262">*</span>&nbsp;<span class="ident" id="6951264">time</span><span class="op" id="6951268">.</span><span class="ident" id="6951269">Second</span><span class="op" id="6951275">)</span><span class="op" id="6951276">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6951280">t</span><span class="op" id="6951281">.</span><span class="ident" id="6951282">Errorf</span><span class="op" id="6951288">(</span><span class="string" id="6951289">&#34;timeout.&nbsp;ServeHTTP&nbsp;hung&nbsp;and&nbsp;didn&#39;t&nbsp;kill&nbsp;the&nbsp;child&nbsp;process?&#34;</span><span class="op" id="6951349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6951353">select</span>&nbsp;<span class="op" id="6951360">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6951364">case</span>&nbsp;<span class="ident" id="6951369">p</span>&nbsp;<span class="op" id="6951371">:=</span>&nbsp;<span class="op" id="6951374">&lt;-</span><span class="ident" id="6951376">proc</span><span class="op" id="6951380">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6951385">p</span><span class="op" id="6951386">.</span><span class="ident" id="6951387">Kill</span><span class="op" id="6951391">(</span><span class="op" id="6951392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6951397">t</span><span class="op" id="6951398">.</span><span class="ident" id="6951399">Logf</span><span class="op" id="6951403">(</span><span class="string" id="6951404">&#34;killed&nbsp;process&#34;</span><span class="op" id="6951420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6951424">default</span><span class="op" id="6951431">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6951436">t</span><span class="op" id="6951437">.</span><span class="ident" id="6951438">Logf</span><span class="op" id="6951442">(</span><span class="string" id="6951443">&#34;didn&#39;t&nbsp;kill&nbsp;process&#34;</span><span class="op" id="6951464">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6951468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6951471">}</span><br>
<span class="lineno"></span><span class="op" id="6951473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6951476">//&nbsp;Test&nbsp;that&nbsp;a&nbsp;child&nbsp;handler&nbsp;writing&nbsp;only&nbsp;headers&nbsp;works.</span><br>
<span class="lineno">140</span><span class="comment" id="6951533">//&nbsp;golang.org/issue/7196</span><br>
<span class="lineno"></span><span class="keyword" id="6951558">func</span>&nbsp;<span class="ident" id="6951563">TestChildOnlyHeaders</span><span class="op" id="6951583">(</span><span class="ident" id="6951584">t</span>&nbsp;<span class="op" id="6951586">*</span><span class="ident" id="6951587">testing</span><span class="op" id="6951594">.</span><span class="ident" id="6951595">T</span><span class="op" id="6951596">)</span>&nbsp;<span class="op" id="6951598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6951601">if</span>&nbsp;<span class="ident" id="6951604">runtime</span><span class="op" id="6951611">.</span><span class="ident" id="6951612">GOOS</span>&nbsp;<span class="op" id="6951617">==</span>&nbsp;<span class="string" id="6951620">&#34;nacl&#34;</span>&nbsp;<span class="op" id="6951627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6951631">t</span><span class="op" id="6951632">.</span><span class="ident" id="6951633">Skip</span><span class="op" id="6951637">(</span><span class="string" id="6951638">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="6951656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6951659">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6951663">h</span>&nbsp;<span class="op" id="6951665">:=</span>&nbsp;<span class="op" id="6951668">&amp;</span><span class="ident" id="6951669">Handler</span><span class="op" id="6951676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6951680">Path</span><span class="op" id="6951684">:</span>&nbsp;<span class="ident" id="6951686">os</span><span class="op" id="6951688">.</span><span class="ident" id="6951689">Args</span><span class="op" id="6951693">[</span><span class="num" id="6951694">0</span><span class="op" id="6951695">]</span><span class="op" id="6951696">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6951700">Root</span><span class="op" id="6951704">:</span>&nbsp;<span class="string" id="6951706">&#34;/test.go&#34;</span><span class="op" id="6951716">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6951720">Args</span><span class="op" id="6951724">:</span>&nbsp;<span class="op" id="6951726">[</span><span class="op" id="6951727">]</span><span class="builtintype" id="6951728">string</span><span class="op" id="6951734">{</span><span class="string" id="6951735">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="6951768">}</span><span class="op" id="6951769">,</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6951772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6951775">expectedMap</span>&nbsp;<span class="op" id="6951787">:=</span>&nbsp;<span class="keyword" id="6951790">map</span><span class="op" id="6951793">[</span><span class="builtintype" id="6951794">string</span><span class="op" id="6951800">]</span><span class="builtintype" id="6951801">string</span><span class="op" id="6951807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6951811">&#34;_body&#34;</span><span class="op" id="6951818">:</span>&nbsp;<span class="string" id="6951820">&#34;&#34;</span><span class="op" id="6951822">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6951825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6951828">replay</span>&nbsp;<span class="op" id="6951835">:=</span>&nbsp;<span class="ident" id="6951838">runCgiTest</span><span class="op" id="6951848">(</span><span class="ident" id="6951849">t</span><span class="op" id="6951850">,</span>&nbsp;<span class="ident" id="6951852">h</span><span class="op" id="6951853">,</span>&nbsp;<span class="string" id="6951855">&#34;GET&nbsp;/test.go?no-body=1&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6951911">,</span>&nbsp;<span class="ident" id="6951913">expectedMap</span><span class="op" id="6951924">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6951927">if</span>&nbsp;<span class="ident" id="6951930">expected</span><span class="op" id="6951938">,</span>&nbsp;<span class="ident" id="6951940">got</span>&nbsp;<span class="op" id="6951944">:=</span>&nbsp;<span class="string" id="6951947">&#34;X-Test-Value&#34;</span><span class="op" id="6951961">,</span>&nbsp;<span class="ident" id="6951963">replay</span><span class="op" id="6951969">.</span><span class="ident" id="6951970">Header</span><span class="op" id="6951976">(</span><span class="op" id="6951977">)</span><span class="op" id="6951978">.</span><span class="ident" id="6951979">Get</span><span class="op" id="6951982">(</span><span class="string" id="6951983">&#34;X-Test-Header&#34;</span><span class="op" id="6951998">)</span><span class="op" id="6951999">;</span>&nbsp;<span class="ident" id="6952001">got</span>&nbsp;<span class="op" id="6952005">!=</span>&nbsp;<span class="ident" id="6952008">expected</span>&nbsp;<span class="op" id="6952017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6952021">t</span><span class="op" id="6952022">.</span><span class="ident" id="6952023">Errorf</span><span class="op" id="6952029">(</span><span class="string" id="6952030">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6952070">,</span>&nbsp;<span class="ident" id="6952072">got</span><span class="op" id="6952075">,</span>&nbsp;<span class="ident" id="6952077">expected</span><span class="op" id="6952085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6952088">}</span><br>
<span class="lineno"></span><span class="op" id="6952090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="6952093">//&nbsp;golang.org/issue/7198</span><br>
<span class="lineno"></span><span class="keyword" id="6952118">func</span>&nbsp;<span class="ident" id="6952123">Test500WithNoHeaders</span><span class="op" id="6952143">(</span><span class="ident" id="6952144">t</span>&nbsp;<span class="op" id="6952146">*</span><span class="ident" id="6952147">testing</span><span class="op" id="6952154">.</span><span class="ident" id="6952155">T</span><span class="op" id="6952156">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6952162">{</span>&nbsp;<span class="ident" id="6952164">want500Test</span><span class="op" id="6952175">(</span><span class="ident" id="6952176">t</span><span class="op" id="6952177">,</span>&nbsp;<span class="string" id="6952179">&#34;/immediate-disconnect&#34;</span><span class="op" id="6952202">)</span>&nbsp;<span class="op" id="6952204">}</span><br>
<span class="lineno"></span><span class="keyword" id="6952206">func</span>&nbsp;<span class="ident" id="6952211">Test500WithNoContentType</span><span class="op" id="6952235">(</span><span class="ident" id="6952236">t</span>&nbsp;<span class="op" id="6952238">*</span><span class="ident" id="6952239">testing</span><span class="op" id="6952246">.</span><span class="ident" id="6952247">T</span><span class="op" id="6952248">)</span>&nbsp;<span class="op" id="6952250">{</span>&nbsp;<span class="ident" id="6952252">want500Test</span><span class="op" id="6952263">(</span><span class="ident" id="6952264">t</span><span class="op" id="6952265">,</span>&nbsp;<span class="string" id="6952267">&#34;/no-content-type&#34;</span><span class="op" id="6952285">)</span>&nbsp;<span class="op" id="6952287">}</span><br>
<span class="lineno"></span><span class="keyword" id="6952289">func</span>&nbsp;<span class="ident" id="6952294">Test500WithEmptyHeaders</span><span class="op" id="6952317">(</span><span class="ident" id="6952318">t</span>&nbsp;<span class="op" id="6952320">*</span><span class="ident" id="6952321">testing</span><span class="op" id="6952328">.</span><span class="ident" id="6952329">T</span><span class="op" id="6952330">)</span>&nbsp;&nbsp;<span class="op" id="6952333">{</span>&nbsp;<span class="ident" id="6952335">want500Test</span><span class="op" id="6952346">(</span><span class="ident" id="6952347">t</span><span class="op" id="6952348">,</span>&nbsp;<span class="string" id="6952350">&#34;/empty-headers&#34;</span><span class="op" id="6952366">)</span>&nbsp;<span class="op" id="6952368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="6952371">func</span>&nbsp;<span class="ident" id="6952376">want500Test</span><span class="op" id="6952387">(</span><span class="ident" id="6952388">t</span>&nbsp;<span class="op" id="6952390">*</span><span class="ident" id="6952391">testing</span><span class="op" id="6952398">.</span><span class="ident" id="6952399">T</span><span class="op" id="6952400">,</span>&nbsp;<span class="ident" id="6952402">path</span>&nbsp;<span class="builtintype" id="6952407">string</span><span class="op" id="6952413">)</span>&nbsp;<span class="op" id="6952415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6952418">h</span>&nbsp;<span class="op" id="6952420">:=</span>&nbsp;<span class="op" id="6952423">&amp;</span><span class="ident" id="6952424">Handler</span><span class="op" id="6952431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6952435">Path</span><span class="op" id="6952439">:</span>&nbsp;<span class="ident" id="6952441">os</span><span class="op" id="6952443">.</span><span class="ident" id="6952444">Args</span><span class="op" id="6952448">[</span><span class="num" id="6952449">0</span><span class="op" id="6952450">]</span><span class="op" id="6952451">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6952455">Root</span><span class="op" id="6952459">:</span>&nbsp;<span class="string" id="6952461">&#34;/test.go&#34;</span><span class="op" id="6952471">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6952475">Args</span><span class="op" id="6952479">:</span>&nbsp;<span class="op" id="6952481">[</span><span class="op" id="6952482">]</span><span class="builtintype" id="6952483">string</span><span class="op" id="6952489">{</span><span class="string" id="6952490">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="6952523">}</span><span class="op" id="6952524">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6952527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6952530">expectedMap</span>&nbsp;<span class="op" id="6952542">:=</span>&nbsp;<span class="keyword" id="6952545">map</span><span class="op" id="6952548">[</span><span class="builtintype" id="6952549">string</span><span class="op" id="6952555">]</span><span class="builtintype" id="6952556">string</span><span class="op" id="6952562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6952566">&#34;_body&#34;</span><span class="op" id="6952573">:</span>&nbsp;<span class="string" id="6952575">&#34;&#34;</span><span class="op" id="6952577">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6952580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6952583">replay</span>&nbsp;<span class="op" id="6952590">:=</span>&nbsp;<span class="ident" id="6952593">runCgiTest</span><span class="op" id="6952603">(</span><span class="ident" id="6952604">t</span><span class="op" id="6952605">,</span>&nbsp;<span class="ident" id="6952607">h</span><span class="op" id="6952608">,</span>&nbsp;<span class="string" id="6952610">&#34;GET&nbsp;&#34;</span><span class="op" id="6952616">+</span><span class="ident" id="6952617">path</span><span class="op" id="6952621">+</span><span class="string" id="6952622">&#34;&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6952656">,</span>&nbsp;<span class="ident" id="6952658">expectedMap</span><span class="op" id="6952669">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6952672">if</span>&nbsp;<span class="ident" id="6952675">replay</span><span class="op" id="6952681">.</span><span class="ident" id="6952682">Code</span>&nbsp;<span class="op" id="6952687">!=</span>&nbsp;<span class="num" id="6952690">500</span>&nbsp;<span class="op" id="6952694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6952698">t</span><span class="op" id="6952699">.</span><span class="ident" id="6952700">Errorf</span><span class="op" id="6952706">(</span><span class="string" id="6952707">&#34;Got&nbsp;code&nbsp;%d;&nbsp;want&nbsp;500&#34;</span><span class="op" id="6952730">,</span>&nbsp;<span class="ident" id="6952732">replay</span><span class="op" id="6952738">.</span><span class="ident" id="6952739">Code</span><span class="op" id="6952743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6952746">}</span><br>
<span class="lineno"></span><span class="op" id="6952748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="6952751">type</span>&nbsp;<span class="ident" id="6952756">neverEnding</span>&nbsp;<span class="builtintype" id="6952768">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6952774">func</span>&nbsp;<span class="op" id="6952779">(</span><span class="ident" id="6952780">b</span>&nbsp;<span class="ident" id="6952782">neverEnding</span><span class="op" id="6952793">)</span>&nbsp;<span class="ident" id="6952795">Read</span><span class="op" id="6952799">(</span><span class="ident" id="6952800">p</span>&nbsp;<span class="op" id="6952802">[</span><span class="op" id="6952803">]</span><span class="builtintype" id="6952804">byte</span><span class="op" id="6952808">)</span>&nbsp;<span class="op" id="6952810">(</span><span class="ident" id="6952811">n</span>&nbsp;<span class="builtintype" id="6952813">int</span><span class="op" id="6952816">,</span>&nbsp;<span class="ident" id="6952818">err</span>&nbsp;<span class="builtintype" id="6952822">error</span><span class="op" id="6952827">)</span>&nbsp;<span class="op" id="6952829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6952832">for</span>&nbsp;<span class="ident" id="6952836">i</span>&nbsp;<span class="op" id="6952838">:=</span>&nbsp;<span class="keyword" id="6952841">range</span>&nbsp;<span class="ident" id="6952847">p</span>&nbsp;<span class="op" id="6952849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6952853">p</span><span class="op" id="6952854">[</span><span class="ident" id="6952855">i</span><span class="op" id="6952856">]</span>&nbsp;<span class="op" id="6952858">=</span>&nbsp;<span class="builtintype" id="6952860">byte</span><span class="op" id="6952864">(</span><span class="ident" id="6952865">b</span><span class="op" id="6952866">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6952869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6952872">return</span>&nbsp;<span class="builtinfunc" id="6952879">len</span><span class="op" id="6952882">(</span><span class="ident" id="6952883">p</span><span class="op" id="6952884">)</span><span class="op" id="6952885">,</span>&nbsp;<span class="ident" id="6952887">nil</span><br>
<span class="lineno"></span><span class="op" id="6952891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6952894">//&nbsp;Note:&nbsp;not&nbsp;actually&nbsp;a&nbsp;test.</span><br>
<span class="lineno">190</span><span class="keyword" id="6952924">func</span>&nbsp;<span class="ident" id="6952929">TestBeChildCGIProcess</span><span class="op" id="6952950">(</span><span class="ident" id="6952951">t</span>&nbsp;<span class="op" id="6952953">*</span><span class="ident" id="6952954">testing</span><span class="op" id="6952961">.</span><span class="ident" id="6952962">T</span><span class="op" id="6952963">)</span>&nbsp;<span class="op" id="6952965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6952968">if</span>&nbsp;<span class="ident" id="6952971">os</span><span class="op" id="6952973">.</span><span class="ident" id="6952974">Getenv</span><span class="op" id="6952980">(</span><span class="string" id="6952981">&#34;REQUEST_METHOD&#34;</span><span class="op" id="6952997">)</span>&nbsp;<span class="op" id="6952999">==</span>&nbsp;<span class="string" id="6953002">&#34;&#34;</span>&nbsp;<span class="op" id="6953005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6953009">//&nbsp;Not&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment;&nbsp;skipping&nbsp;test.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6953055">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6953063">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6953066">switch</span>&nbsp;<span class="ident" id="6953073">os</span><span class="op" id="6953075">.</span><span class="ident" id="6953076">Getenv</span><span class="op" id="6953082">(</span><span class="string" id="6953083">&#34;REQUEST_URI&#34;</span><span class="op" id="6953096">)</span>&nbsp;<span class="op" id="6953098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6953101">case</span>&nbsp;<span class="string" id="6953106">&#34;/immediate-disconnect&#34;</span><span class="op" id="6953129">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6953133">os</span><span class="op" id="6953135">.</span><span class="ident" id="6953136">Exit</span><span class="op" id="6953140">(</span><span class="num" id="6953141">0</span><span class="op" id="6953142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6953145">case</span>&nbsp;<span class="string" id="6953150">&#34;/no-content-type&#34;</span><span class="op" id="6953168">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6953172">fmt</span><span class="op" id="6953175">.</span><span class="ident" id="6953176">Printf</span><span class="op" id="6953182">(</span><span class="string" id="6953183">&#34;Content-Length:&nbsp;6\n\nHello\n&#34;</span><span class="op" id="6953213">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6953217">os</span><span class="op" id="6953219">.</span><span class="ident" id="6953220">Exit</span><span class="op" id="6953224">(</span><span class="num" id="6953225">0</span><span class="op" id="6953226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6953229">case</span>&nbsp;<span class="string" id="6953234">&#34;/empty-headers&#34;</span><span class="op" id="6953250">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6953254">fmt</span><span class="op" id="6953257">.</span><span class="ident" id="6953258">Printf</span><span class="op" id="6953264">(</span><span class="string" id="6953265">&#34;\nHello&#34;</span><span class="op" id="6953274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6953278">os</span><span class="op" id="6953280">.</span><span class="ident" id="6953281">Exit</span><span class="op" id="6953285">(</span><span class="num" id="6953286">0</span><span class="op" id="6953287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6953290">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6953293">Serve</span><span class="op" id="6953298">(</span><span class="ident" id="6953299">http</span><span class="op" id="6953303">.</span><span class="ident" id="6953304">HandlerFunc</span><span class="op" id="6953315">(</span><span class="keyword" id="6953316">func</span><span class="op" id="6953320">(</span><span class="ident" id="6953321">rw</span>&nbsp;<span class="ident" id="6953324">http</span><span class="op" id="6953328">.</span><span class="ident" id="6953329">ResponseWriter</span><span class="op" id="6953343">,</span>&nbsp;<span class="ident" id="6953345">req</span>&nbsp;<span class="op" id="6953349">*</span><span class="ident" id="6953350">http</span><span class="op" id="6953354">.</span><span class="ident" id="6953355">Request</span><span class="op" id="6953362">)</span>&nbsp;<span class="op" id="6953364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6953368">rw</span><span class="op" id="6953370">.</span><span class="ident" id="6953371">Header</span><span class="op" id="6953377">(</span><span class="op" id="6953378">)</span><span class="op" id="6953379">.</span><span class="ident" id="6953380">Set</span><span class="op" id="6953383">(</span><span class="string" id="6953384">&#34;X-Test-Header&#34;</span><span class="op" id="6953399">,</span>&nbsp;<span class="string" id="6953401">&#34;X-Test-Value&#34;</span><span class="op" id="6953415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6953419">req</span><span class="op" id="6953422">.</span><span class="ident" id="6953423">ParseForm</span><span class="op" id="6953432">(</span><span class="op" id="6953433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6953437">if</span>&nbsp;<span class="ident" id="6953440">req</span><span class="op" id="6953443">.</span><span class="ident" id="6953444">FormValue</span><span class="op" id="6953453">(</span><span class="string" id="6953454">&#34;no-body&#34;</span><span class="op" id="6953463">)</span>&nbsp;<span class="op" id="6953465">==</span>&nbsp;<span class="string" id="6953468">&#34;1&#34;</span>&nbsp;<span class="op" id="6953472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6953477">return</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6953486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6953490">if</span>&nbsp;<span class="ident" id="6953493">req</span><span class="op" id="6953496">.</span><span class="ident" id="6953497">FormValue</span><span class="op" id="6953506">(</span><span class="string" id="6953507">&#34;write-forever&#34;</span><span class="op" id="6953522">)</span>&nbsp;<span class="op" id="6953524">==</span>&nbsp;<span class="string" id="6953527">&#34;1&#34;</span>&nbsp;<span class="op" id="6953531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6953536">io</span><span class="op" id="6953538">.</span><span class="ident" id="6953539">Copy</span><span class="op" id="6953543">(</span><span class="ident" id="6953544">rw</span><span class="op" id="6953546">,</span>&nbsp;<span class="ident" id="6953548">neverEnding</span><span class="op" id="6953559">(</span><span class="string" id="6953560">&#39;a&#39;</span><span class="op" id="6953563">)</span><span class="op" id="6953564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6953569">for</span>&nbsp;<span class="op" id="6953573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6953579">time</span><span class="op" id="6953583">.</span><span class="ident" id="6953584">Sleep</span><span class="op" id="6953589">(</span><span class="num" id="6953590">5</span>&nbsp;<span class="op" id="6953592">*</span>&nbsp;<span class="ident" id="6953594">time</span><span class="op" id="6953598">.</span><span class="ident" id="6953599">Second</span><span class="op" id="6953605">)</span>&nbsp;<span class="comment" id="6953607">//&nbsp;hang&nbsp;forever,&nbsp;until&nbsp;killed</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6953640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6953644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6953648">fmt</span><span class="op" id="6953651">.</span><span class="ident" id="6953652">Fprintf</span><span class="op" id="6953659">(</span><span class="ident" id="6953660">rw</span><span class="op" id="6953662">,</span>&nbsp;<span class="string" id="6953664">&#34;test=Hello&nbsp;CGI-in-CGI\n&#34;</span><span class="op" id="6953689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6953693">for</span>&nbsp;<span class="ident" id="6953697">k</span><span class="op" id="6953698">,</span>&nbsp;<span class="ident" id="6953700">vv</span>&nbsp;<span class="op" id="6953703">:=</span>&nbsp;<span class="keyword" id="6953706">range</span>&nbsp;<span class="ident" id="6953712">req</span><span class="op" id="6953715">.</span><span class="ident" id="6953716">Form</span>&nbsp;<span class="op" id="6953721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6953726">for</span>&nbsp;<span class="ident" id="6953730">_</span><span class="op" id="6953731">,</span>&nbsp;<span class="ident" id="6953733">v</span>&nbsp;<span class="op" id="6953735">:=</span>&nbsp;<span class="keyword" id="6953738">range</span>&nbsp;<span class="ident" id="6953744">vv</span>&nbsp;<span class="op" id="6953747">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6953753">fmt</span><span class="op" id="6953756">.</span><span class="ident" id="6953757">Fprintf</span><span class="op" id="6953764">(</span><span class="ident" id="6953765">rw</span><span class="op" id="6953767">,</span>&nbsp;<span class="string" id="6953769">&#34;param-%s=%s\n&#34;</span><span class="op" id="6953784">,</span>&nbsp;<span class="ident" id="6953786">k</span><span class="op" id="6953787">,</span>&nbsp;<span class="ident" id="6953789">v</span><span class="op" id="6953790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6953795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6953799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6953803">for</span>&nbsp;<span class="ident" id="6953807">_</span><span class="op" id="6953808">,</span>&nbsp;<span class="ident" id="6953810">kv</span>&nbsp;<span class="op" id="6953813">:=</span>&nbsp;<span class="keyword" id="6953816">range</span>&nbsp;<span class="ident" id="6953822">os</span><span class="op" id="6953824">.</span><span class="ident" id="6953825">Environ</span><span class="op" id="6953832">(</span><span class="op" id="6953833">)</span>&nbsp;<span class="op" id="6953835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6953840">fmt</span><span class="op" id="6953843">.</span><span class="ident" id="6953844">Fprintf</span><span class="op" id="6953851">(</span><span class="ident" id="6953852">rw</span><span class="op" id="6953854">,</span>&nbsp;<span class="string" id="6953856">&#34;env-%s\n&#34;</span><span class="op" id="6953866">,</span>&nbsp;<span class="ident" id="6953868">kv</span><span class="op" id="6953870">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6953874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6953877">}</span><span class="op" id="6953878">)</span><span class="op" id="6953879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6953882">os</span><span class="op" id="6953884">.</span><span class="ident" id="6953885">Exit</span><span class="op" id="6953889">(</span><span class="num" id="6953890">0</span><span class="op" id="6953891">)</span><br>
<span class="lineno"></span><span class="op" id="6953893">}</span>
</div>
</body>
</html>
