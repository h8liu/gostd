<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3393408">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3393464">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3393518">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3393569">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3393647">//&nbsp;Internet&nbsp;protocol&nbsp;family&nbsp;sockets&nbsp;for&nbsp;POSIX</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3393694">package</span>&nbsp;<span class="ident" id="3393702">net</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="3393707">import</span>&nbsp;<span class="op" id="3393714">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3393717">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3393728">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3393735">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3393738">func</span>&nbsp;<span class="ident" id="3393743">probeIPv4Stack</span><span class="op" id="3393757">(</span><span class="op" id="3393758">)</span>&nbsp;<span class="builtintype" id="3393760">bool</span>&nbsp;<span class="op" id="3393765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3393768">s</span><span class="op" id="3393769">,</span>&nbsp;<span class="ident" id="3393771">err</span>&nbsp;<span class="op" id="3393775">:=</span>&nbsp;<span class="ident" id="3393778">syscall</span><span class="op" id="3393785">.</span><span class="ident" id="3393786">Socket</span><span class="op" id="3393792">(</span><span class="ident" id="3393793">syscall</span><span class="op" id="3393800">.</span><span class="ident" id="3393801">AF_INET</span><span class="op" id="3393808">,</span>&nbsp;<span class="ident" id="3393810">syscall</span><span class="op" id="3393817">.</span><span class="ident" id="3393818">SOCK_STREAM</span><span class="op" id="3393829">,</span>&nbsp;<span class="ident" id="3393831">syscall</span><span class="op" id="3393838">.</span><span class="ident" id="3393839">IPPROTO_TCP</span><span class="op" id="3393850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3393853">switch</span>&nbsp;<span class="ident" id="3393860">err</span>&nbsp;<span class="op" id="3393864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3393867">case</span>&nbsp;<span class="ident" id="3393872">syscall</span><span class="op" id="3393879">.</span><span class="ident" id="3393880">EAFNOSUPPORT</span><span class="op" id="3393892">,</span>&nbsp;<span class="ident" id="3393894">syscall</span><span class="op" id="3393901">.</span><span class="ident" id="3393902">EPROTONOSUPPORT</span><span class="op" id="3393917">:</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3393921">return</span>&nbsp;<span class="ident" id="3393928">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3393935">case</span>&nbsp;<span class="ident" id="3393940">nil</span><span class="op" id="3393943">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3393947">closesocket</span><span class="op" id="3393958">(</span><span class="ident" id="3393959">s</span><span class="op" id="3393960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3393963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3393966">return</span>&nbsp;<span class="ident" id="3393973">true</span><br>
<span class="lineno">25</span><span class="op" id="3393978">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3393981">//&nbsp;Should&nbsp;we&nbsp;try&nbsp;to&nbsp;use&nbsp;the&nbsp;IPv4&nbsp;socket&nbsp;interface&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span><span class="comment" id="3394040">//&nbsp;only&nbsp;dealing&nbsp;with&nbsp;IPv4&nbsp;sockets?&nbsp;&nbsp;As&nbsp;long&nbsp;as&nbsp;the&nbsp;host&nbsp;system</span><br>
<span class="lineno"></span><span class="comment" id="3394103">//&nbsp;understands&nbsp;IPv6,&nbsp;it&#39;s&nbsp;okay&nbsp;to&nbsp;pass&nbsp;IPv4&nbsp;addresses&nbsp;to&nbsp;the&nbsp;IPv6</span><br>
<span class="lineno">30</span><span class="comment" id="3394169">//&nbsp;interface.&nbsp;&nbsp;That&nbsp;simplifies&nbsp;our&nbsp;code&nbsp;and&nbsp;is&nbsp;most&nbsp;general.</span><br>
<span class="lineno"></span><span class="comment" id="3394230">//&nbsp;Unfortunately,&nbsp;we&nbsp;need&nbsp;to&nbsp;run&nbsp;on&nbsp;kernels&nbsp;built&nbsp;without&nbsp;IPv6</span><br>
<span class="lineno"></span><span class="comment" id="3394293">//&nbsp;support&nbsp;too.&nbsp;&nbsp;So&nbsp;probe&nbsp;the&nbsp;kernel&nbsp;to&nbsp;figure&nbsp;it&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="3394348">//</span><br>
<span class="lineno"></span><span class="comment" id="3394351">//&nbsp;probeIPv6Stack&nbsp;probes&nbsp;both&nbsp;basic&nbsp;IPv6&nbsp;capability&nbsp;and&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno">35</span><span class="comment" id="3394418">//&nbsp;mapping&nbsp;capability&nbsp;which&nbsp;is&nbsp;controlled&nbsp;by&nbsp;IPV6_V6ONLY&nbsp;socket</span><br>
<span class="lineno"></span><span class="comment" id="3394482">//&nbsp;option&nbsp;and/or&nbsp;kernel&nbsp;state&nbsp;&#34;net.inet6.ip6.v6only&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3394536">//&nbsp;It&nbsp;returns&nbsp;two&nbsp;boolean&nbsp;values.&nbsp;&nbsp;If&nbsp;the&nbsp;first&nbsp;boolean&nbsp;value&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3394601">//&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;basic&nbsp;IPv6&nbsp;functionality.&nbsp;&nbsp;If&nbsp;the&nbsp;second</span><br>
<span class="lineno"></span><span class="comment" id="3394667">//&nbsp;boolean&nbsp;value&nbsp;is&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;IPv6&nbsp;IPv4-mapping.</span><br>
<span class="lineno">40</span><span class="keyword" id="3394728">func</span>&nbsp;<span class="ident" id="3394733">probeIPv6Stack</span><span class="op" id="3394747">(</span><span class="op" id="3394748">)</span>&nbsp;<span class="op" id="3394750">(</span><span class="ident" id="3394751">supportsIPv6</span><span class="op" id="3394763">,</span>&nbsp;<span class="ident" id="3394765">supportsIPv4map</span>&nbsp;<span class="builtintype" id="3394781">bool</span><span class="op" id="3394785">)</span>&nbsp;<span class="op" id="3394787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3394790">var</span>&nbsp;<span class="ident" id="3394794">probes</span>&nbsp;<span class="op" id="3394801">=</span>&nbsp;<span class="op" id="3394803">[</span><span class="op" id="3394804">]</span><span class="keyword" id="3394805">struct</span>&nbsp;<span class="op" id="3394812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394816">laddr</span>&nbsp;<span class="ident" id="3394822">TCPAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394832">value</span>&nbsp;<span class="builtintype" id="3394838">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3394844">ok</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3394850">bool</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3394856">}</span><span class="op" id="3394857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3394861">//&nbsp;IPv6&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3394896">{</span><span class="ident" id="3394897">laddr</span><span class="op" id="3394902">:</span>&nbsp;<span class="ident" id="3394904">TCPAddr</span><span class="op" id="3394911">{</span><span class="ident" id="3394912">IP</span><span class="op" id="3394914">:</span>&nbsp;<span class="ident" id="3394916">ParseIP</span><span class="op" id="3394923">(</span><span class="string" id="3394924">&#34;::1&#34;</span><span class="op" id="3394929">)</span><span class="op" id="3394930">}</span><span class="op" id="3394931">,</span>&nbsp;<span class="ident" id="3394933">value</span><span class="op" id="3394938">:</span>&nbsp;<span class="num" id="3394940">1</span><span class="op" id="3394941">}</span><span class="op" id="3394942">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3394946">//&nbsp;IPv6&nbsp;IPv4-mapped&nbsp;address&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3395001">{</span><span class="ident" id="3395002">laddr</span><span class="op" id="3395007">:</span>&nbsp;<span class="ident" id="3395009">TCPAddr</span><span class="op" id="3395016">{</span><span class="ident" id="3395017">IP</span><span class="op" id="3395019">:</span>&nbsp;<span class="ident" id="3395021">IPv4</span><span class="op" id="3395025">(</span><span class="num" id="3395026">127</span><span class="op" id="3395029">,</span>&nbsp;<span class="num" id="3395031">0</span><span class="op" id="3395032">,</span>&nbsp;<span class="num" id="3395034">0</span><span class="op" id="3395035">,</span>&nbsp;<span class="num" id="3395037">1</span><span class="op" id="3395038">)</span><span class="op" id="3395039">}</span><span class="op" id="3395040">,</span>&nbsp;<span class="ident" id="3395042">value</span><span class="op" id="3395047">:</span>&nbsp;<span class="num" id="3395049">0</span><span class="op" id="3395050">}</span><span class="op" id="3395051">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3395054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395058">for</span>&nbsp;<span class="ident" id="3395062">i</span>&nbsp;<span class="op" id="3395064">:=</span>&nbsp;<span class="keyword" id="3395067">range</span>&nbsp;<span class="ident" id="3395073">probes</span>&nbsp;<span class="op" id="3395080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3395084">s</span><span class="op" id="3395085">,</span>&nbsp;<span class="ident" id="3395087">err</span>&nbsp;<span class="op" id="3395091">:=</span>&nbsp;<span class="ident" id="3395094">syscall</span><span class="op" id="3395101">.</span><span class="ident" id="3395102">Socket</span><span class="op" id="3395108">(</span><span class="ident" id="3395109">syscall</span><span class="op" id="3395116">.</span><span class="ident" id="3395117">AF_INET6</span><span class="op" id="3395125">,</span>&nbsp;<span class="ident" id="3395127">syscall</span><span class="op" id="3395134">.</span><span class="ident" id="3395135">SOCK_STREAM</span><span class="op" id="3395146">,</span>&nbsp;<span class="ident" id="3395148">syscall</span><span class="op" id="3395155">.</span><span class="ident" id="3395156">IPPROTO_TCP</span><span class="op" id="3395167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395171">if</span>&nbsp;<span class="ident" id="3395174">err</span>&nbsp;<span class="op" id="3395178">!=</span>&nbsp;<span class="ident" id="3395181">nil</span>&nbsp;<span class="op" id="3395185">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395190">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3395201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395205">defer</span>&nbsp;<span class="ident" id="3395211">closesocket</span><span class="op" id="3395222">(</span><span class="ident" id="3395223">s</span><span class="op" id="3395224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3395228">syscall</span><span class="op" id="3395235">.</span><span class="ident" id="3395236">SetsockoptInt</span><span class="op" id="3395249">(</span><span class="ident" id="3395250">s</span><span class="op" id="3395251">,</span>&nbsp;<span class="ident" id="3395253">syscall</span><span class="op" id="3395260">.</span><span class="ident" id="3395261">IPPROTO_IPV6</span><span class="op" id="3395273">,</span>&nbsp;<span class="ident" id="3395275">syscall</span><span class="op" id="3395282">.</span><span class="ident" id="3395283">IPV6_V6ONLY</span><span class="op" id="3395294">,</span>&nbsp;<span class="ident" id="3395296">probes</span><span class="op" id="3395302">[</span><span class="ident" id="3395303">i</span><span class="op" id="3395304">]</span><span class="op" id="3395305">.</span><span class="ident" id="3395306">value</span><span class="op" id="3395311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3395315">sa</span><span class="op" id="3395317">,</span>&nbsp;<span class="ident" id="3395319">err</span>&nbsp;<span class="op" id="3395323">:=</span>&nbsp;<span class="ident" id="3395326">probes</span><span class="op" id="3395332">[</span><span class="ident" id="3395333">i</span><span class="op" id="3395334">]</span><span class="op" id="3395335">.</span><span class="ident" id="3395336">laddr</span><span class="op" id="3395341">.</span><span class="ident" id="3395342">sockaddr</span><span class="op" id="3395350">(</span><span class="ident" id="3395351">syscall</span><span class="op" id="3395358">.</span><span class="ident" id="3395359">AF_INET6</span><span class="op" id="3395367">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395371">if</span>&nbsp;<span class="ident" id="3395374">err</span>&nbsp;<span class="op" id="3395378">!=</span>&nbsp;<span class="ident" id="3395381">nil</span>&nbsp;<span class="op" id="3395385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395390">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3395401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395405">if</span>&nbsp;<span class="ident" id="3395408">err</span>&nbsp;<span class="op" id="3395412">:=</span>&nbsp;<span class="ident" id="3395415">syscall</span><span class="op" id="3395422">.</span><span class="ident" id="3395423">Bind</span><span class="op" id="3395427">(</span><span class="ident" id="3395428">s</span><span class="op" id="3395429">,</span>&nbsp;<span class="ident" id="3395431">sa</span><span class="op" id="3395433">)</span><span class="op" id="3395434">;</span>&nbsp;<span class="ident" id="3395436">err</span>&nbsp;<span class="op" id="3395440">!=</span>&nbsp;<span class="ident" id="3395443">nil</span>&nbsp;<span class="op" id="3395447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395452">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3395463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3395467">probes</span><span class="op" id="3395473">[</span><span class="ident" id="3395474">i</span><span class="op" id="3395475">]</span><span class="op" id="3395476">.</span><span class="ident" id="3395477">ok</span>&nbsp;<span class="op" id="3395480">=</span>&nbsp;<span class="ident" id="3395482">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3395488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3395492">return</span>&nbsp;<span class="ident" id="3395499">probes</span><span class="op" id="3395505">[</span><span class="num" id="3395506">0</span><span class="op" id="3395507">]</span><span class="op" id="3395508">.</span><span class="ident" id="3395509">ok</span><span class="op" id="3395511">,</span>&nbsp;<span class="ident" id="3395513">probes</span><span class="op" id="3395519">[</span><span class="num" id="3395520">1</span><span class="op" id="3395521">]</span><span class="op" id="3395522">.</span><span class="ident" id="3395523">ok</span><br>
<span class="lineno">70</span><span class="op" id="3395526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3395529">//&nbsp;favoriteAddrFamily&nbsp;returns&nbsp;the&nbsp;appropriate&nbsp;address&nbsp;family&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3395593">//&nbsp;the&nbsp;given&nbsp;net,&nbsp;laddr,&nbsp;raddr&nbsp;and&nbsp;mode.&nbsp;&nbsp;At&nbsp;first&nbsp;it&nbsp;figures</span><br>
<span class="lineno"></span><span class="comment" id="3395655">//&nbsp;address&nbsp;family&nbsp;out&nbsp;from&nbsp;the&nbsp;net.&nbsp;&nbsp;If&nbsp;mode&nbsp;indicates&nbsp;&#34;listen&#34;</span><br>
<span class="lineno">75</span><span class="comment" id="3395719">//&nbsp;and&nbsp;laddr&nbsp;is&nbsp;a&nbsp;wildcard,&nbsp;it&nbsp;assumes&nbsp;that&nbsp;the&nbsp;user&nbsp;wants&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3395781">//&nbsp;make&nbsp;a&nbsp;passive&nbsp;connection&nbsp;with&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;family,&nbsp;both</span><br>
<span class="lineno"></span><span class="comment" id="3395847">//&nbsp;AF_INET&nbsp;and&nbsp;AF_INET6,&nbsp;and&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;like&nbsp;following:</span><br>
<span class="lineno"></span><span class="comment" id="3395911">//</span><br>
<span class="lineno"></span><span class="comment" id="3395914">//&nbsp;&nbsp;&nbsp;&nbsp1.&nbsp;A&nbsp;wild-wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;&#34;</span><br>
<span class="lineno">80</span><span class="comment" id="3395951">//&nbsp;&nbsp;&nbsp;&nbspIf&nbsp;the&nbsp;platform&nbsp;supports&nbsp;both&nbsp;IPv6&nbsp;and&nbsp;IPv6&nbsp;IPv4-mapping</span><br>
<span class="lineno"></span><span class="comment" id="3396011">//&nbsp;&nbsp;&nbsp;&nbspcapabilities,&nbsp;we&nbsp;assume&nbsp;that&nbsp;the&nbsp;user&nbsp;want&nbsp;to&nbsp;listen&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3396070">//&nbsp;&nbsp;&nbsp;&nbspboth&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;wildcard&nbsp;address&nbsp;over&nbsp;an&nbsp;AF_INET6</span><br>
<span class="lineno"></span><span class="comment" id="3396126">//&nbsp;&nbsp;&nbsp;&nbspsocket&nbsp;with&nbsp;IPV6_V6ONLY=0.&nbsp;&nbsp;Otherwise&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv4</span><br>
<span class="lineno"></span><span class="comment" id="3396185">//&nbsp;&nbsp;&nbsp;&nbspwildcard&nbsp;address&nbsp;listen&nbsp;over&nbsp;an&nbsp;AF_INET&nbsp;socket.</span><br>
<span class="lineno">85</span><span class="comment" id="3396236">//</span><br>
<span class="lineno"></span><span class="comment" id="3396239">//&nbsp;&nbsp;&nbsp;&nbsp2.&nbsp;A&nbsp;wild-ipv4wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3396287">//&nbsp;&nbsp;&nbsp;&nbspSame&nbsp;as&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="3396301">//</span><br>
<span class="lineno"></span><span class="comment" id="3396304">//&nbsp;&nbsp;&nbsp;&nbsp3.&nbsp;A&nbsp;wild-ipv6wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno">90</span><span class="comment" id="3396349">//&nbsp;&nbsp;&nbsp;&nbspAlmost&nbsp;same&nbsp;as&nbsp;1&nbsp;but&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv6&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno"></span><span class="comment" id="3396408">//&nbsp;&nbsp;&nbsp;&nbsplisten&nbsp;over&nbsp;an&nbsp;AF_INET6&nbsp;socket&nbsp;with&nbsp;IPV6_V6ONLY=0&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="3396466">//&nbsp;&nbsp;&nbsp;&nbspthe&nbsp;platform&nbsp;supports&nbsp;IPv6&nbsp;capability&nbsp;but&nbsp;not&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno"></span><span class="comment" id="3396526">//&nbsp;&nbsp;&nbsp;&nbspmapping&nbsp;capability.</span><br>
<span class="lineno"></span><span class="comment" id="3396549">//</span><br>
<span class="lineno">95</span><span class="comment" id="3396552">//&nbsp;&nbsp;&nbsp;&nbsp4.&nbsp;A&nbsp;ipv4-ipv4wild&nbsp;listen,&nbsp;&#34;tcp4&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3396607">//&nbsp;&nbsp;&nbsp;&nbspWe&nbsp;use&nbsp;an&nbsp;IPv4&nbsp;(AF_INET)&nbsp;wildcard&nbsp;address&nbsp;listen.</span><br>
<span class="lineno"></span><span class="comment" id="3396660">//</span><br>
<span class="lineno"></span><span class="comment" id="3396663">//&nbsp;&nbsp;&nbsp;&nbsp5.&nbsp;A&nbsp;ipv6-ipv6wild&nbsp;listen,&nbsp;&#34;tcp6&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3396715">//&nbsp;&nbsp;&nbsp;&nbspWe&nbsp;use&nbsp;an&nbsp;IPv6&nbsp;(AF_INET6,&nbsp;IPV6_V6ONLY=1)&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno">100</span><span class="comment" id="3396776">//&nbsp;&nbsp;&nbsp;&nbsplisten.</span><br>
<span class="lineno"></span><span class="comment" id="3396787">//</span><br>
<span class="lineno"></span><span class="comment" id="3396790">//&nbsp;Otherwise&nbsp;guess:&nbsp;if&nbsp;the&nbsp;addresses&nbsp;are&nbsp;IPv4&nbsp;then&nbsp;returns&nbsp;AF_INET,</span><br>
<span class="lineno"></span><span class="comment" id="3396858">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;AF_INET6.&nbsp;&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;boolean&nbsp;value&nbsp;what</span><br>
<span class="lineno"></span><span class="comment" id="3396925">//&nbsp;designates&nbsp;IPV6_V6ONLY&nbsp;option.</span><br>
<span class="lineno">105</span><span class="comment" id="3396959">//</span><br>
<span class="lineno"></span><span class="comment" id="3396962">//&nbsp;Note&nbsp;that&nbsp;OpenBSD&nbsp;allows&nbsp;neither&nbsp;&#34;net.inet6.ip6.v6only=1&#34;&nbsp;change</span><br>
<span class="lineno"></span><span class="comment" id="3397030">//&nbsp;nor&nbsp;IPPROTO_IPV6&nbsp;level&nbsp;IPV6_V6ONLY&nbsp;socket&nbsp;option&nbsp;setting.</span><br>
<span class="lineno"></span><span class="keyword" id="3397091">func</span>&nbsp;<span class="ident" id="3397096">favoriteAddrFamily</span><span class="op" id="3397114">(</span><span class="ident" id="3397115">net</span>&nbsp;<span class="builtintype" id="3397119">string</span><span class="op" id="3397125">,</span>&nbsp;<span class="ident" id="3397127">laddr</span><span class="op" id="3397132">,</span>&nbsp;<span class="ident" id="3397134">raddr</span>&nbsp;<span class="ident" id="3397140">sockaddr</span><span class="op" id="3397148">,</span>&nbsp;<span class="ident" id="3397150">mode</span>&nbsp;<span class="builtintype" id="3397155">string</span><span class="op" id="3397161">)</span>&nbsp;<span class="op" id="3397163">(</span><span class="ident" id="3397164">family</span>&nbsp;<span class="builtintype" id="3397171">int</span><span class="op" id="3397174">,</span>&nbsp;<span class="ident" id="3397176">ipv6only</span>&nbsp;<span class="builtintype" id="3397185">bool</span><span class="op" id="3397189">)</span>&nbsp;<span class="op" id="3397191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397194">switch</span>&nbsp;<span class="ident" id="3397201">net</span><span class="op" id="3397204">[</span><span class="builtinfunc" id="3397205">len</span><span class="op" id="3397208">(</span><span class="ident" id="3397209">net</span><span class="op" id="3397212">)</span><span class="op" id="3397213">-</span><span class="num" id="3397214">1</span><span class="op" id="3397215">]</span>&nbsp;<span class="op" id="3397217">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397220">case</span>&nbsp;<span class="string" id="3397225">&#39;4&#39;</span><span class="op" id="3397228">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397232">return</span>&nbsp;<span class="ident" id="3397239">syscall</span><span class="op" id="3397246">.</span><span class="ident" id="3397247">AF_INET</span><span class="op" id="3397254">,</span>&nbsp;<span class="ident" id="3397256">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397263">case</span>&nbsp;<span class="string" id="3397268">&#39;6&#39;</span><span class="op" id="3397271">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397275">return</span>&nbsp;<span class="ident" id="3397282">syscall</span><span class="op" id="3397289">.</span><span class="ident" id="3397290">AF_INET6</span><span class="op" id="3397298">,</span>&nbsp;<span class="ident" id="3397300">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3397306">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397310">if</span>&nbsp;<span class="ident" id="3397313">mode</span>&nbsp;<span class="op" id="3397318">==</span>&nbsp;<span class="string" id="3397321">&#34;listen&#34;</span>&nbsp;<span class="op" id="3397330">&amp;&amp;</span>&nbsp;<span class="op" id="3397333">(</span><span class="ident" id="3397334">laddr</span>&nbsp;<span class="op" id="3397340">==</span>&nbsp;<span class="ident" id="3397343">nil</span>&nbsp;<span class="op" id="3397347">||</span>&nbsp;<span class="ident" id="3397350">laddr</span><span class="op" id="3397355">.</span><span class="ident" id="3397356">isWildcard</span><span class="op" id="3397366">(</span><span class="op" id="3397367">)</span><span class="op" id="3397368">)</span>&nbsp;<span class="op" id="3397370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397374">if</span>&nbsp;<span class="ident" id="3397377">supportsIPv4map</span>&nbsp;<span class="op" id="3397393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397398">return</span>&nbsp;<span class="ident" id="3397405">syscall</span><span class="op" id="3397412">.</span><span class="ident" id="3397413">AF_INET6</span><span class="op" id="3397421">,</span>&nbsp;<span class="ident" id="3397423">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3397431">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397435">if</span>&nbsp;<span class="ident" id="3397438">laddr</span>&nbsp;<span class="op" id="3397444">==</span>&nbsp;<span class="ident" id="3397447">nil</span>&nbsp;<span class="op" id="3397451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397456">return</span>&nbsp;<span class="ident" id="3397463">syscall</span><span class="op" id="3397470">.</span><span class="ident" id="3397471">AF_INET</span><span class="op" id="3397478">,</span>&nbsp;<span class="ident" id="3397480">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3397488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397492">return</span>&nbsp;<span class="ident" id="3397499">laddr</span><span class="op" id="3397504">.</span><span class="ident" id="3397505">family</span><span class="op" id="3397511">(</span><span class="op" id="3397512">)</span><span class="op" id="3397513">,</span>&nbsp;<span class="ident" id="3397515">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3397522">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397526">if</span>&nbsp;<span class="op" id="3397529">(</span><span class="ident" id="3397530">laddr</span>&nbsp;<span class="op" id="3397536">==</span>&nbsp;<span class="ident" id="3397539">nil</span>&nbsp;<span class="op" id="3397543">||</span>&nbsp;<span class="ident" id="3397546">laddr</span><span class="op" id="3397551">.</span><span class="ident" id="3397552">family</span><span class="op" id="3397558">(</span><span class="op" id="3397559">)</span>&nbsp;<span class="op" id="3397561">==</span>&nbsp;<span class="ident" id="3397564">syscall</span><span class="op" id="3397571">.</span><span class="ident" id="3397572">AF_INET</span><span class="op" id="3397579">)</span>&nbsp;<span class="op" id="3397581">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3397586">(</span><span class="ident" id="3397587">raddr</span>&nbsp;<span class="op" id="3397593">==</span>&nbsp;<span class="ident" id="3397596">nil</span>&nbsp;<span class="op" id="3397600">||</span>&nbsp;<span class="ident" id="3397603">raddr</span><span class="op" id="3397608">.</span><span class="ident" id="3397609">family</span><span class="op" id="3397615">(</span><span class="op" id="3397616">)</span>&nbsp;<span class="op" id="3397618">==</span>&nbsp;<span class="ident" id="3397621">syscall</span><span class="op" id="3397628">.</span><span class="ident" id="3397629">AF_INET</span><span class="op" id="3397636">)</span>&nbsp;<span class="op" id="3397638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397642">return</span>&nbsp;<span class="ident" id="3397649">syscall</span><span class="op" id="3397656">.</span><span class="ident" id="3397657">AF_INET</span><span class="op" id="3397664">,</span>&nbsp;<span class="ident" id="3397666">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3397673">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397676">return</span>&nbsp;<span class="ident" id="3397683">syscall</span><span class="op" id="3397690">.</span><span class="ident" id="3397691">AF_INET6</span><span class="op" id="3397699">,</span>&nbsp;<span class="ident" id="3397701">false</span><br>
<span class="lineno"></span><span class="op" id="3397707">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3397710">//&nbsp;Internet&nbsp;sockets&nbsp;(TCP,&nbsp;UDP,&nbsp;IP)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="3397746">func</span>&nbsp;<span class="ident" id="3397751">internetSocket</span><span class="op" id="3397765">(</span><span class="ident" id="3397766">net</span>&nbsp;<span class="builtintype" id="3397770">string</span><span class="op" id="3397776">,</span>&nbsp;<span class="ident" id="3397778">laddr</span><span class="op" id="3397783">,</span>&nbsp;<span class="ident" id="3397785">raddr</span>&nbsp;<span class="ident" id="3397791">sockaddr</span><span class="op" id="3397799">,</span>&nbsp;<span class="ident" id="3397801">deadline</span>&nbsp;<span class="ident" id="3397810">time</span><span class="op" id="3397814">.</span><span class="ident" id="3397815">Time</span><span class="op" id="3397819">,</span>&nbsp;<span class="ident" id="3397821">sotype</span><span class="op" id="3397827">,</span>&nbsp;<span class="ident" id="3397829">proto</span>&nbsp;<span class="builtintype" id="3397835">int</span><span class="op" id="3397838">,</span>&nbsp;<span class="ident" id="3397840">mode</span>&nbsp;<span class="builtintype" id="3397845">string</span><span class="op" id="3397851">)</span>&nbsp;<span class="op" id="3397853">(</span><span class="ident" id="3397854">fd</span>&nbsp;<span class="op" id="3397857">*</span><span class="ident" id="3397858">netFD</span><span class="op" id="3397863">,</span>&nbsp;<span class="ident" id="3397865">err</span>&nbsp;<span class="builtintype" id="3397869">error</span><span class="op" id="3397874">)</span>&nbsp;<span class="op" id="3397876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3397879">family</span><span class="op" id="3397885">,</span>&nbsp;<span class="ident" id="3397887">ipv6only</span>&nbsp;<span class="op" id="3397896">:=</span>&nbsp;<span class="ident" id="3397899">favoriteAddrFamily</span><span class="op" id="3397917">(</span><span class="ident" id="3397918">net</span><span class="op" id="3397921">,</span>&nbsp;<span class="ident" id="3397923">laddr</span><span class="op" id="3397928">,</span>&nbsp;<span class="ident" id="3397930">raddr</span><span class="op" id="3397935">,</span>&nbsp;<span class="ident" id="3397937">mode</span><span class="op" id="3397941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3397944">return</span>&nbsp;<span class="ident" id="3397951">socket</span><span class="op" id="3397957">(</span><span class="ident" id="3397958">net</span><span class="op" id="3397961">,</span>&nbsp;<span class="ident" id="3397963">family</span><span class="op" id="3397969">,</span>&nbsp;<span class="ident" id="3397971">sotype</span><span class="op" id="3397977">,</span>&nbsp;<span class="ident" id="3397979">proto</span><span class="op" id="3397984">,</span>&nbsp;<span class="ident" id="3397986">ipv6only</span><span class="op" id="3397994">,</span>&nbsp;<span class="ident" id="3397996">laddr</span><span class="op" id="3398001">,</span>&nbsp;<span class="ident" id="3398003">raddr</span><span class="op" id="3398008">,</span>&nbsp;<span class="ident" id="3398010">deadline</span><span class="op" id="3398018">)</span><br>
<span class="lineno"></span><span class="op" id="3398020">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="3398023">func</span>&nbsp;<span class="ident" id="3398028">ipToSockaddr</span><span class="op" id="3398040">(</span><span class="ident" id="3398041">family</span>&nbsp;<span class="builtintype" id="3398048">int</span><span class="op" id="3398051">,</span>&nbsp;<span class="ident" id="3398053">ip</span>&nbsp;<span class="ident" id="3398056">IP</span><span class="op" id="3398058">,</span>&nbsp;<span class="ident" id="3398060">port</span>&nbsp;<span class="builtintype" id="3398065">int</span><span class="op" id="3398068">,</span>&nbsp;<span class="ident" id="3398070">zone</span>&nbsp;<span class="builtintype" id="3398075">string</span><span class="op" id="3398081">)</span>&nbsp;<span class="op" id="3398083">(</span><span class="ident" id="3398084">syscall</span><span class="op" id="3398091">.</span><span class="ident" id="3398092">Sockaddr</span><span class="op" id="3398100">,</span>&nbsp;<span class="builtintype" id="3398102">error</span><span class="op" id="3398107">)</span>&nbsp;<span class="op" id="3398109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3398112">switch</span>&nbsp;<span class="ident" id="3398119">family</span>&nbsp;<span class="op" id="3398126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3398129">case</span>&nbsp;<span class="ident" id="3398134">syscall</span><span class="op" id="3398141">.</span><span class="ident" id="3398142">AF_INET</span><span class="op" id="3398149">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3398153">if</span>&nbsp;<span class="builtinfunc" id="3398156">len</span><span class="op" id="3398159">(</span><span class="ident" id="3398160">ip</span><span class="op" id="3398162">)</span>&nbsp;<span class="op" id="3398164">==</span>&nbsp;<span class="num" id="3398167">0</span>&nbsp;<span class="op" id="3398169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398174">ip</span>&nbsp;<span class="op" id="3398177">=</span>&nbsp;<span class="ident" id="3398179">IPv4zero</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3398190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3398194">if</span>&nbsp;<span class="ident" id="3398197">ip</span>&nbsp;<span class="op" id="3398200">=</span>&nbsp;<span class="ident" id="3398202">ip</span><span class="op" id="3398204">.</span><span class="ident" id="3398205">To4</span><span class="op" id="3398208">(</span><span class="op" id="3398209">)</span><span class="op" id="3398210">;</span>&nbsp;<span class="ident" id="3398212">ip</span>&nbsp;<span class="op" id="3398215">==</span>&nbsp;<span class="ident" id="3398218">nil</span>&nbsp;<span class="op" id="3398222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3398227">return</span>&nbsp;<span class="ident" id="3398234">nil</span><span class="op" id="3398237">,</span>&nbsp;<span class="ident" id="3398239">InvalidAddrError</span><span class="op" id="3398255">(</span><span class="string" id="3398256">&#34;non-IPv4&nbsp;address&#34;</span><span class="op" id="3398274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3398278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398282">sa</span>&nbsp;<span class="op" id="3398285">:=</span>&nbsp;<span class="builtinfunc" id="3398288">new</span><span class="op" id="3398291">(</span><span class="ident" id="3398292">syscall</span><span class="op" id="3398299">.</span><span class="ident" id="3398300">SockaddrInet4</span><span class="op" id="3398313">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3398317">for</span>&nbsp;<span class="ident" id="3398321">i</span>&nbsp;<span class="op" id="3398323">:=</span>&nbsp;<span class="num" id="3398326">0</span><span class="op" id="3398327">;</span>&nbsp;<span class="ident" id="3398329">i</span>&nbsp;<span class="op" id="3398331">&lt;</span>&nbsp;<span class="ident" id="3398333">IPv4len</span><span class="op" id="3398340">;</span>&nbsp;<span class="ident" id="3398342">i</span><span class="op" id="3398343">++</span>&nbsp;<span class="op" id="3398346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398351">sa</span><span class="op" id="3398353">.</span><span class="ident" id="3398354">Addr</span><span class="op" id="3398358">[</span><span class="ident" id="3398359">i</span><span class="op" id="3398360">]</span>&nbsp;<span class="op" id="3398362">=</span>&nbsp;<span class="ident" id="3398364">ip</span><span class="op" id="3398366">[</span><span class="ident" id="3398367">i</span><span class="op" id="3398368">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3398372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398376">sa</span><span class="op" id="3398378">.</span><span class="ident" id="3398379">Port</span>&nbsp;<span class="op" id="3398384">=</span>&nbsp;<span class="ident" id="3398386">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3398393">return</span>&nbsp;<span class="ident" id="3398400">sa</span><span class="op" id="3398402">,</span>&nbsp;<span class="ident" id="3398404">nil</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3398409">case</span>&nbsp;<span class="ident" id="3398414">syscall</span><span class="op" id="3398421">.</span><span class="ident" id="3398422">AF_INET6</span><span class="op" id="3398430">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3398434">if</span>&nbsp;<span class="builtinfunc" id="3398437">len</span><span class="op" id="3398440">(</span><span class="ident" id="3398441">ip</span><span class="op" id="3398443">)</span>&nbsp;<span class="op" id="3398445">==</span>&nbsp;<span class="num" id="3398448">0</span>&nbsp;<span class="op" id="3398450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398455">ip</span>&nbsp;<span class="op" id="3398458">=</span>&nbsp;<span class="ident" id="3398460">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3398471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3398475">//&nbsp;IPv4&nbsp;callers&nbsp;use&nbsp;0.0.0.0&nbsp;to&nbsp;mean&nbsp;&#34;announce&nbsp;on&nbsp;any&nbsp;available&nbsp;address&#34;.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3398550">//&nbsp;In&nbsp;IPv6&nbsp;mode,&nbsp;Linux&nbsp;treats&nbsp;that&nbsp;as&nbsp;meaning&nbsp;&#34;announce&nbsp;on&nbsp;0.0.0.0&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3398621">//&nbsp;which&nbsp;it&nbsp;refuses&nbsp;to&nbsp;do.&nbsp;&nbsp;Rewrite&nbsp;to&nbsp;the&nbsp;IPv6&nbsp;unspecified&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3398692">if</span>&nbsp;<span class="ident" id="3398695">ip</span><span class="op" id="3398697">.</span><span class="ident" id="3398698">Equal</span><span class="op" id="3398703">(</span><span class="ident" id="3398704">IPv4zero</span><span class="op" id="3398712">)</span>&nbsp;<span class="op" id="3398714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398719">ip</span>&nbsp;<span class="op" id="3398722">=</span>&nbsp;<span class="ident" id="3398724">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3398735">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3398739">if</span>&nbsp;<span class="ident" id="3398742">ip</span>&nbsp;<span class="op" id="3398745">=</span>&nbsp;<span class="ident" id="3398747">ip</span><span class="op" id="3398749">.</span><span class="ident" id="3398750">To16</span><span class="op" id="3398754">(</span><span class="op" id="3398755">)</span><span class="op" id="3398756">;</span>&nbsp;<span class="ident" id="3398758">ip</span>&nbsp;<span class="op" id="3398761">==</span>&nbsp;<span class="ident" id="3398764">nil</span>&nbsp;<span class="op" id="3398768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3398773">return</span>&nbsp;<span class="ident" id="3398780">nil</span><span class="op" id="3398783">,</span>&nbsp;<span class="ident" id="3398785">InvalidAddrError</span><span class="op" id="3398801">(</span><span class="string" id="3398802">&#34;non-IPv6&nbsp;address&#34;</span><span class="op" id="3398820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3398824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398828">sa</span>&nbsp;<span class="op" id="3398831">:=</span>&nbsp;<span class="builtinfunc" id="3398834">new</span><span class="op" id="3398837">(</span><span class="ident" id="3398838">syscall</span><span class="op" id="3398845">.</span><span class="ident" id="3398846">SockaddrInet6</span><span class="op" id="3398859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3398863">for</span>&nbsp;<span class="ident" id="3398867">i</span>&nbsp;<span class="op" id="3398869">:=</span>&nbsp;<span class="num" id="3398872">0</span><span class="op" id="3398873">;</span>&nbsp;<span class="ident" id="3398875">i</span>&nbsp;<span class="op" id="3398877">&lt;</span>&nbsp;<span class="ident" id="3398879">IPv6len</span><span class="op" id="3398886">;</span>&nbsp;<span class="ident" id="3398888">i</span><span class="op" id="3398889">++</span>&nbsp;<span class="op" id="3398892">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398897">sa</span><span class="op" id="3398899">.</span><span class="ident" id="3398900">Addr</span><span class="op" id="3398904">[</span><span class="ident" id="3398905">i</span><span class="op" id="3398906">]</span>&nbsp;<span class="op" id="3398908">=</span>&nbsp;<span class="ident" id="3398910">ip</span><span class="op" id="3398912">[</span><span class="ident" id="3398913">i</span><span class="op" id="3398914">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3398918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398922">sa</span><span class="op" id="3398924">.</span><span class="ident" id="3398925">Port</span>&nbsp;<span class="op" id="3398930">=</span>&nbsp;<span class="ident" id="3398932">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3398939">sa</span><span class="op" id="3398941">.</span><span class="ident" id="3398942">ZoneId</span>&nbsp;<span class="op" id="3398949">=</span>&nbsp;<span class="builtintype" id="3398951">uint32</span><span class="op" id="3398957">(</span><span class="ident" id="3398958">zoneToInt</span><span class="op" id="3398967">(</span><span class="ident" id="3398968">zone</span><span class="op" id="3398972">)</span><span class="op" id="3398973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3398977">return</span>&nbsp;<span class="ident" id="3398984">sa</span><span class="op" id="3398986">,</span>&nbsp;<span class="ident" id="3398988">nil</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3398993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3398996">return</span>&nbsp;<span class="ident" id="3399003">nil</span><span class="op" id="3399006">,</span>&nbsp;<span class="ident" id="3399008">InvalidAddrError</span><span class="op" id="3399024">(</span><span class="string" id="3399025">&#34;unexpected&nbsp;socket&nbsp;family&#34;</span><span class="op" id="3399051">)</span><br>
<span class="lineno"></span><span class="op" id="3399053">}</span>
</div>
</body>
</html>
