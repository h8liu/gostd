<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/smtp</h2>
<ul>
<li><a href="/gostd/net/smtp/auth.go.html">auth.go</a></li>
<li><a href="/gostd/net/smtp/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/smtp/smtp.go.html">smtp.go</a></li>
<li><a href="/gostd/net/smtp/smtp_test.go.html" class="current">smtp_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6953891">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6953946">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6954000">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6954051">package</span>&nbsp;<span class="ident" id="6954059">smtp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6954065">import</span>&nbsp;<span class="op" id="6954072">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6954075">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6954084">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6954093">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6954107">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6954122">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6954128">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6954135">&#34;net/textproto&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6954152">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6954163">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6954174">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6954181">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="6954184">type</span>&nbsp;<span class="ident" id="6954189">authTest</span>&nbsp;<span class="keyword" id="6954198">struct</span>&nbsp;<span class="op" id="6954205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6954208">auth</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6954219">Auth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6954225">challenges</span>&nbsp;<span class="op" id="6954236">[</span><span class="op" id="6954237">]</span><span class="builtintype" id="6954238">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6954246">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6954257">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6954265">responses</span>&nbsp;&nbsp;<span class="op" id="6954276">[</span><span class="op" id="6954277">]</span><span class="builtintype" id="6954278">string</span><br>
<span class="lineno">25</span><span class="op" id="6954285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6954288">var</span>&nbsp;<span class="ident" id="6954292">authTests</span>&nbsp;<span class="op" id="6954302">=</span>&nbsp;<span class="op" id="6954304">[</span><span class="op" id="6954305">]</span><span class="ident" id="6954306">authTest</span><span class="op" id="6954314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6954317">{</span><span class="ident" id="6954318">PlainAuth</span><span class="op" id="6954327">(</span><span class="string" id="6954328">&#34;&#34;</span><span class="op" id="6954330">,</span>&nbsp;<span class="string" id="6954332">&#34;user&#34;</span><span class="op" id="6954338">,</span>&nbsp;<span class="string" id="6954340">&#34;pass&#34;</span><span class="op" id="6954346">,</span>&nbsp;<span class="string" id="6954348">&#34;testserver&#34;</span><span class="op" id="6954360">)</span><span class="op" id="6954361">,</span>&nbsp;<span class="op" id="6954363">[</span><span class="op" id="6954364">]</span><span class="builtintype" id="6954365">string</span><span class="op" id="6954371">{</span><span class="op" id="6954372">}</span><span class="op" id="6954373">,</span>&nbsp;<span class="string" id="6954375">&#34;PLAIN&#34;</span><span class="op" id="6954382">,</span>&nbsp;<span class="op" id="6954384">[</span><span class="op" id="6954385">]</span><span class="builtintype" id="6954386">string</span><span class="op" id="6954392">{</span><span class="string" id="6954393">&#34;\x00user\x00pass&#34;</span><span class="op" id="6954411">}</span><span class="op" id="6954412">}</span><span class="op" id="6954413">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6954416">{</span><span class="ident" id="6954417">PlainAuth</span><span class="op" id="6954426">(</span><span class="string" id="6954427">&#34;foo&#34;</span><span class="op" id="6954432">,</span>&nbsp;<span class="string" id="6954434">&#34;bar&#34;</span><span class="op" id="6954439">,</span>&nbsp;<span class="string" id="6954441">&#34;baz&#34;</span><span class="op" id="6954446">,</span>&nbsp;<span class="string" id="6954448">&#34;testserver&#34;</span><span class="op" id="6954460">)</span><span class="op" id="6954461">,</span>&nbsp;<span class="op" id="6954463">[</span><span class="op" id="6954464">]</span><span class="builtintype" id="6954465">string</span><span class="op" id="6954471">{</span><span class="op" id="6954472">}</span><span class="op" id="6954473">,</span>&nbsp;<span class="string" id="6954475">&#34;PLAIN&#34;</span><span class="op" id="6954482">,</span>&nbsp;<span class="op" id="6954484">[</span><span class="op" id="6954485">]</span><span class="builtintype" id="6954486">string</span><span class="op" id="6954492">{</span><span class="string" id="6954493">&#34;foo\x00bar\x00baz&#34;</span><span class="op" id="6954512">}</span><span class="op" id="6954513">}</span><span class="op" id="6954514">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6954517">{</span><span class="ident" id="6954518">CRAMMD5Auth</span><span class="op" id="6954529">(</span><span class="string" id="6954530">&#34;user&#34;</span><span class="op" id="6954536">,</span>&nbsp;<span class="string" id="6954538">&#34;pass&#34;</span><span class="op" id="6954544">)</span><span class="op" id="6954545">,</span>&nbsp;<span class="op" id="6954547">[</span><span class="op" id="6954548">]</span><span class="builtintype" id="6954549">string</span><span class="op" id="6954555">{</span><span class="string" id="6954556">&#34;&lt;123456.1322876914@testserver&gt;&#34;</span><span class="op" id="6954588">}</span><span class="op" id="6954589">,</span>&nbsp;<span class="string" id="6954591">&#34;CRAM-MD5&#34;</span><span class="op" id="6954601">,</span>&nbsp;<span class="op" id="6954603">[</span><span class="op" id="6954604">]</span><span class="builtintype" id="6954605">string</span><span class="op" id="6954611">{</span><span class="string" id="6954612">&#34;&#34;</span><span class="op" id="6954614">,</span>&nbsp;<span class="string" id="6954616">&#34;user&nbsp;287eb355114cf5c471c26a875f1ca4ae&#34;</span><span class="op" id="6954655">}</span><span class="op" id="6954656">}</span><span class="op" id="6954657">,</span><br>
<span class="lineno"></span><span class="op" id="6954659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6954662">func</span>&nbsp;<span class="ident" id="6954667">TestAuth</span><span class="op" id="6954675">(</span><span class="ident" id="6954676">t</span>&nbsp;<span class="op" id="6954678">*</span><span class="ident" id="6954679">testing</span><span class="op" id="6954686">.</span><span class="ident" id="6954687">T</span><span class="op" id="6954688">)</span>&nbsp;<span class="op" id="6954690">{</span><br>
<span class="lineno"></span><span class="ident" id="6954692">testLoop</span><span class="op" id="6954700">:</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6954703">for</span>&nbsp;<span class="ident" id="6954707">i</span><span class="op" id="6954708">,</span>&nbsp;<span class="ident" id="6954710">test</span>&nbsp;<span class="op" id="6954715">:=</span>&nbsp;<span class="keyword" id="6954718">range</span>&nbsp;<span class="ident" id="6954724">authTests</span>&nbsp;<span class="op" id="6954734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6954738">name</span><span class="op" id="6954742">,</span>&nbsp;<span class="ident" id="6954744">resp</span><span class="op" id="6954748">,</span>&nbsp;<span class="ident" id="6954750">err</span>&nbsp;<span class="op" id="6954754">:=</span>&nbsp;<span class="ident" id="6954757">test</span><span class="op" id="6954761">.</span><span class="ident" id="6954762">auth</span><span class="op" id="6954766">.</span><span class="ident" id="6954767">Start</span><span class="op" id="6954772">(</span><span class="op" id="6954773">&amp;</span><span class="ident" id="6954774">ServerInfo</span><span class="op" id="6954784">{</span><span class="string" id="6954785">&#34;testserver&#34;</span><span class="op" id="6954797">,</span>&nbsp;<span class="builtintype" id="6954799">true</span><span class="op" id="6954803">,</span>&nbsp;<span class="builtintype" id="6954805">nil</span><span class="op" id="6954808">}</span><span class="op" id="6954809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6954813">if</span>&nbsp;<span class="ident" id="6954816">name</span>&nbsp;<span class="op" id="6954821">!=</span>&nbsp;<span class="ident" id="6954824">test</span><span class="op" id="6954828">.</span><span class="ident" id="6954829">name</span>&nbsp;<span class="op" id="6954834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6954839">t</span><span class="op" id="6954840">.</span><span class="ident" id="6954841">Errorf</span><span class="op" id="6954847">(</span><span class="string" id="6954848">&#34;#%d&nbsp;got&nbsp;name&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="6954878">,</span>&nbsp;<span class="ident" id="6954880">i</span><span class="op" id="6954881">,</span>&nbsp;<span class="ident" id="6954883">name</span><span class="op" id="6954887">,</span>&nbsp;<span class="ident" id="6954889">test</span><span class="op" id="6954893">.</span><span class="ident" id="6954894">name</span><span class="op" id="6954898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6954902">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6954906">if</span>&nbsp;<span class="op" id="6954909">!</span><span class="ident" id="6954910">bytes</span><span class="op" id="6954915">.</span><span class="ident" id="6954916">Equal</span><span class="op" id="6954921">(</span><span class="ident" id="6954922">resp</span><span class="op" id="6954926">,</span>&nbsp;<span class="op" id="6954928">[</span><span class="op" id="6954929">]</span><span class="builtintype" id="6954930">byte</span><span class="op" id="6954934">(</span><span class="ident" id="6954935">test</span><span class="op" id="6954939">.</span><span class="ident" id="6954940">responses</span><span class="op" id="6954949">[</span><span class="num" id="6954950">0</span><span class="op" id="6954951">]</span><span class="op" id="6954952">)</span><span class="op" id="6954953">)</span>&nbsp;<span class="op" id="6954955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6954960">t</span><span class="op" id="6954961">.</span><span class="ident" id="6954962">Errorf</span><span class="op" id="6954968">(</span><span class="string" id="6954969">&#34;#%d&nbsp;got&nbsp;response&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="6955003">,</span>&nbsp;<span class="ident" id="6955005">i</span><span class="op" id="6955006">,</span>&nbsp;<span class="ident" id="6955008">resp</span><span class="op" id="6955012">,</span>&nbsp;<span class="ident" id="6955014">test</span><span class="op" id="6955018">.</span><span class="ident" id="6955019">responses</span><span class="op" id="6955028">[</span><span class="num" id="6955029">0</span><span class="op" id="6955030">]</span><span class="op" id="6955031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6955035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6955039">if</span>&nbsp;<span class="ident" id="6955042">err</span>&nbsp;<span class="op" id="6955046">!=</span>&nbsp;<span class="builtintype" id="6955049">nil</span>&nbsp;<span class="op" id="6955053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6955058">t</span><span class="op" id="6955059">.</span><span class="ident" id="6955060">Errorf</span><span class="op" id="6955066">(</span><span class="string" id="6955067">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="6955082">,</span>&nbsp;<span class="ident" id="6955084">i</span><span class="op" id="6955085">,</span>&nbsp;<span class="ident" id="6955087">err</span><span class="op" id="6955090">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6955094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6955098">for</span>&nbsp;<span class="ident" id="6955102">j</span>&nbsp;<span class="op" id="6955104">:=</span>&nbsp;<span class="keyword" id="6955107">range</span>&nbsp;<span class="ident" id="6955113">test</span><span class="op" id="6955117">.</span><span class="ident" id="6955118">challenges</span>&nbsp;<span class="op" id="6955129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6955134">challenge</span>&nbsp;<span class="op" id="6955144">:=</span>&nbsp;<span class="op" id="6955147">[</span><span class="op" id="6955148">]</span><span class="builtintype" id="6955149">byte</span><span class="op" id="6955153">(</span><span class="ident" id="6955154">test</span><span class="op" id="6955158">.</span><span class="ident" id="6955159">challenges</span><span class="op" id="6955169">[</span><span class="ident" id="6955170">j</span><span class="op" id="6955171">]</span><span class="op" id="6955172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6955177">expected</span>&nbsp;<span class="op" id="6955186">:=</span>&nbsp;<span class="op" id="6955189">[</span><span class="op" id="6955190">]</span><span class="builtintype" id="6955191">byte</span><span class="op" id="6955195">(</span><span class="ident" id="6955196">test</span><span class="op" id="6955200">.</span><span class="ident" id="6955201">responses</span><span class="op" id="6955210">[</span><span class="ident" id="6955211">j</span><span class="op" id="6955212">+</span><span class="num" id="6955213">1</span><span class="op" id="6955214">]</span><span class="op" id="6955215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6955220">resp</span><span class="op" id="6955224">,</span>&nbsp;<span class="ident" id="6955226">err</span>&nbsp;<span class="op" id="6955230">:=</span>&nbsp;<span class="ident" id="6955233">test</span><span class="op" id="6955237">.</span><span class="ident" id="6955238">auth</span><span class="op" id="6955242">.</span><span class="ident" id="6955243">Next</span><span class="op" id="6955247">(</span><span class="ident" id="6955248">challenge</span><span class="op" id="6955257">,</span>&nbsp;<span class="builtintype" id="6955259">true</span><span class="op" id="6955263">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6955268">if</span>&nbsp;<span class="ident" id="6955271">err</span>&nbsp;<span class="op" id="6955275">!=</span>&nbsp;<span class="builtintype" id="6955278">nil</span>&nbsp;<span class="op" id="6955282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6955288">t</span><span class="op" id="6955289">.</span><span class="ident" id="6955290">Errorf</span><span class="op" id="6955296">(</span><span class="string" id="6955297">&#34;#%d&nbsp;error:&nbsp;%s&#34;</span><span class="op" id="6955312">,</span>&nbsp;<span class="ident" id="6955314">i</span><span class="op" id="6955315">,</span>&nbsp;<span class="ident" id="6955317">err</span><span class="op" id="6955320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6955326">continue</span>&nbsp;<span class="ident" id="6955335">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6955347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6955352">if</span>&nbsp;<span class="op" id="6955355">!</span><span class="ident" id="6955356">bytes</span><span class="op" id="6955361">.</span><span class="ident" id="6955362">Equal</span><span class="op" id="6955367">(</span><span class="ident" id="6955368">resp</span><span class="op" id="6955372">,</span>&nbsp;<span class="ident" id="6955374">expected</span><span class="op" id="6955382">)</span>&nbsp;<span class="op" id="6955384">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6955390">t</span><span class="op" id="6955391">.</span><span class="ident" id="6955392">Errorf</span><span class="op" id="6955398">(</span><span class="string" id="6955399">&#34;#%d&nbsp;got&nbsp;%s,&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="6955424">,</span>&nbsp;<span class="ident" id="6955426">i</span><span class="op" id="6955427">,</span>&nbsp;<span class="ident" id="6955429">resp</span><span class="op" id="6955433">,</span>&nbsp;<span class="ident" id="6955435">expected</span><span class="op" id="6955443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6955449">continue</span>&nbsp;<span class="ident" id="6955458">testLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6955470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6955474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6955477">}</span><br>
<span class="lineno">60</span><span class="op" id="6955479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6955482">func</span>&nbsp;<span class="ident" id="6955487">TestAuthPlain</span><span class="op" id="6955500">(</span><span class="ident" id="6955501">t</span>&nbsp;<span class="op" id="6955503">*</span><span class="ident" id="6955504">testing</span><span class="op" id="6955511">.</span><span class="ident" id="6955512">T</span><span class="op" id="6955513">)</span>&nbsp;<span class="op" id="6955515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6955518">auth</span>&nbsp;<span class="op" id="6955523">:=</span>&nbsp;<span class="ident" id="6955526">PlainAuth</span><span class="op" id="6955535">(</span><span class="string" id="6955536">&#34;foo&#34;</span><span class="op" id="6955541">,</span>&nbsp;<span class="string" id="6955543">&#34;bar&#34;</span><span class="op" id="6955548">,</span>&nbsp;<span class="string" id="6955550">&#34;baz&#34;</span><span class="op" id="6955555">,</span>&nbsp;<span class="string" id="6955557">&#34;servername&#34;</span><span class="op" id="6955569">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6955573">tests</span>&nbsp;<span class="op" id="6955579">:=</span>&nbsp;<span class="op" id="6955582">[</span><span class="op" id="6955583">]</span><span class="keyword" id="6955584">struct</span>&nbsp;<span class="op" id="6955591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6955595">server</span>&nbsp;<span class="op" id="6955602">*</span><span class="ident" id="6955603">ServerInfo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6955616">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6955623">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6955631">}</span><span class="op" id="6955632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6955636">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6955641">server</span><span class="op" id="6955647">:</span>&nbsp;<span class="op" id="6955649">&amp;</span><span class="ident" id="6955650">ServerInfo</span><span class="op" id="6955660">{</span><span class="ident" id="6955661">Name</span><span class="op" id="6955665">:</span>&nbsp;<span class="string" id="6955667">&#34;servername&#34;</span><span class="op" id="6955679">,</span>&nbsp;<span class="ident" id="6955681">TLS</span><span class="op" id="6955684">:</span>&nbsp;<span class="builtintype" id="6955686">true</span><span class="op" id="6955690">}</span><span class="op" id="6955691">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6955695">}</span><span class="op" id="6955696">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6955700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6955705">//&nbsp;Okay;&nbsp;explicitly&nbsp;advertised&nbsp;by&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6955750">server</span><span class="op" id="6955756">:</span>&nbsp;<span class="op" id="6955758">&amp;</span><span class="ident" id="6955759">ServerInfo</span><span class="op" id="6955769">{</span><span class="ident" id="6955770">Name</span><span class="op" id="6955774">:</span>&nbsp;<span class="string" id="6955776">&#34;servername&#34;</span><span class="op" id="6955788">,</span>&nbsp;<span class="ident" id="6955790">Auth</span><span class="op" id="6955794">:</span>&nbsp;<span class="op" id="6955796">[</span><span class="op" id="6955797">]</span><span class="builtintype" id="6955798">string</span><span class="op" id="6955804">{</span><span class="string" id="6955805">&#34;PLAIN&#34;</span><span class="op" id="6955812">}</span><span class="op" id="6955813">}</span><span class="op" id="6955814">,</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6955818">}</span><span class="op" id="6955819">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6955823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6955828">server</span><span class="op" id="6955834">:</span>&nbsp;<span class="op" id="6955836">&amp;</span><span class="ident" id="6955837">ServerInfo</span><span class="op" id="6955847">{</span><span class="ident" id="6955848">Name</span><span class="op" id="6955852">:</span>&nbsp;<span class="string" id="6955854">&#34;servername&#34;</span><span class="op" id="6955866">,</span>&nbsp;<span class="ident" id="6955868">Auth</span><span class="op" id="6955872">:</span>&nbsp;<span class="op" id="6955874">[</span><span class="op" id="6955875">]</span><span class="builtintype" id="6955876">string</span><span class="op" id="6955882">{</span><span class="string" id="6955883">&#34;CRAM-MD5&#34;</span><span class="op" id="6955893">}</span><span class="op" id="6955894">}</span><span class="op" id="6955895">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6955900">err</span><span class="op" id="6955903">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6955908">&#34;unencrypted&nbsp;connection&#34;</span><span class="op" id="6955932">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6955936">}</span><span class="op" id="6955937">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6955941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6955946">server</span><span class="op" id="6955952">:</span>&nbsp;<span class="op" id="6955954">&amp;</span><span class="ident" id="6955955">ServerInfo</span><span class="op" id="6955965">{</span><span class="ident" id="6955966">Name</span><span class="op" id="6955970">:</span>&nbsp;<span class="string" id="6955972">&#34;attacker&#34;</span><span class="op" id="6955982">,</span>&nbsp;<span class="ident" id="6955984">TLS</span><span class="op" id="6955987">:</span>&nbsp;<span class="builtintype" id="6955989">true</span><span class="op" id="6955993">}</span><span class="op" id="6955994">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6955999">err</span><span class="op" id="6956002">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6956007">&#34;wrong&nbsp;host&nbsp;name&#34;</span><span class="op" id="6956024">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6956028">}</span><span class="op" id="6956029">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6956032">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6956035">for</span>&nbsp;<span class="ident" id="6956039">i</span><span class="op" id="6956040">,</span>&nbsp;<span class="ident" id="6956042">tt</span>&nbsp;<span class="op" id="6956045">:=</span>&nbsp;<span class="keyword" id="6956048">range</span>&nbsp;<span class="ident" id="6956054">tests</span>&nbsp;<span class="op" id="6956060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6956064">_</span><span class="op" id="6956065">,</span>&nbsp;<span class="ident" id="6956067">_</span><span class="op" id="6956068">,</span>&nbsp;<span class="ident" id="6956070">err</span>&nbsp;<span class="op" id="6956074">:=</span>&nbsp;<span class="ident" id="6956077">auth</span><span class="op" id="6956081">.</span><span class="ident" id="6956082">Start</span><span class="op" id="6956087">(</span><span class="ident" id="6956088">tt</span><span class="op" id="6956090">.</span><span class="ident" id="6956091">server</span><span class="op" id="6956097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6956101">got</span>&nbsp;<span class="op" id="6956105">:=</span>&nbsp;<span class="string" id="6956108">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6956113">if</span>&nbsp;<span class="ident" id="6956116">err</span>&nbsp;<span class="op" id="6956120">!=</span>&nbsp;<span class="builtintype" id="6956123">nil</span>&nbsp;<span class="op" id="6956127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6956132">got</span>&nbsp;<span class="op" id="6956136">=</span>&nbsp;<span class="ident" id="6956138">err</span><span class="op" id="6956141">.</span><span class="ident" id="6956142">Error</span><span class="op" id="6956147">(</span><span class="op" id="6956148">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6956152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6956156">if</span>&nbsp;<span class="ident" id="6956159">got</span>&nbsp;<span class="op" id="6956163">!=</span>&nbsp;<span class="ident" id="6956166">tt</span><span class="op" id="6956168">.</span><span class="ident" id="6956169">err</span>&nbsp;<span class="op" id="6956173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6956178">t</span><span class="op" id="6956179">.</span><span class="ident" id="6956180">Errorf</span><span class="op" id="6956186">(</span><span class="string" id="6956187">&#34;%d.&nbsp;got&nbsp;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6956216">,</span>&nbsp;<span class="ident" id="6956218">i</span><span class="op" id="6956219">,</span>&nbsp;<span class="ident" id="6956221">got</span><span class="op" id="6956224">,</span>&nbsp;<span class="ident" id="6956226">tt</span><span class="op" id="6956228">.</span><span class="ident" id="6956229">err</span><span class="op" id="6956232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6956236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6956239">}</span><br>
<span class="lineno">95</span><span class="op" id="6956241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6956244">type</span>&nbsp;<span class="ident" id="6956249">faker</span>&nbsp;<span class="keyword" id="6956255">struct</span>&nbsp;<span class="op" id="6956262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6956265">io</span><span class="op" id="6956267">.</span><span class="ident" id="6956268">ReadWriter</span><br>
<span class="lineno"></span><span class="op" id="6956279">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="6956282">func</span>&nbsp;<span class="op" id="6956287">(</span><span class="ident" id="6956288">f</span>&nbsp;<span class="ident" id="6956290">faker</span><span class="op" id="6956295">)</span>&nbsp;<span class="ident" id="6956297">Close</span><span class="op" id="6956302">(</span><span class="op" id="6956303">)</span>&nbsp;<span class="builtintype" id="6956305">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6956331">{</span>&nbsp;<span class="keyword" id="6956333">return</span>&nbsp;<span class="builtintype" id="6956340">nil</span>&nbsp;<span class="op" id="6956344">}</span><br>
<span class="lineno"></span><span class="keyword" id="6956346">func</span>&nbsp;<span class="op" id="6956351">(</span><span class="ident" id="6956352">f</span>&nbsp;<span class="ident" id="6956354">faker</span><span class="op" id="6956359">)</span>&nbsp;<span class="ident" id="6956361">LocalAddr</span><span class="op" id="6956370">(</span><span class="op" id="6956371">)</span>&nbsp;<span class="ident" id="6956373">net</span><span class="op" id="6956376">.</span><span class="ident" id="6956377">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6956395">{</span>&nbsp;<span class="keyword" id="6956397">return</span>&nbsp;<span class="builtintype" id="6956404">nil</span>&nbsp;<span class="op" id="6956408">}</span><br>
<span class="lineno"></span><span class="keyword" id="6956410">func</span>&nbsp;<span class="op" id="6956415">(</span><span class="ident" id="6956416">f</span>&nbsp;<span class="ident" id="6956418">faker</span><span class="op" id="6956423">)</span>&nbsp;<span class="ident" id="6956425">RemoteAddr</span><span class="op" id="6956435">(</span><span class="op" id="6956436">)</span>&nbsp;<span class="ident" id="6956438">net</span><span class="op" id="6956441">.</span><span class="ident" id="6956442">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6956459">{</span>&nbsp;<span class="keyword" id="6956461">return</span>&nbsp;<span class="builtintype" id="6956468">nil</span>&nbsp;<span class="op" id="6956472">}</span><br>
<span class="lineno"></span><span class="keyword" id="6956474">func</span>&nbsp;<span class="op" id="6956479">(</span><span class="ident" id="6956480">f</span>&nbsp;<span class="ident" id="6956482">faker</span><span class="op" id="6956487">)</span>&nbsp;<span class="ident" id="6956489">SetDeadline</span><span class="op" id="6956500">(</span><span class="ident" id="6956501">time</span><span class="op" id="6956505">.</span><span class="ident" id="6956506">Time</span><span class="op" id="6956510">)</span>&nbsp;<span class="builtintype" id="6956512">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6956523">{</span>&nbsp;<span class="keyword" id="6956525">return</span>&nbsp;<span class="builtintype" id="6956532">nil</span>&nbsp;<span class="op" id="6956536">}</span><br>
<span class="lineno">105</span><span class="keyword" id="6956538">func</span>&nbsp;<span class="op" id="6956543">(</span><span class="ident" id="6956544">f</span>&nbsp;<span class="ident" id="6956546">faker</span><span class="op" id="6956551">)</span>&nbsp;<span class="ident" id="6956553">SetReadDeadline</span><span class="op" id="6956568">(</span><span class="ident" id="6956569">time</span><span class="op" id="6956573">.</span><span class="ident" id="6956574">Time</span><span class="op" id="6956578">)</span>&nbsp;<span class="builtintype" id="6956580">error</span>&nbsp;&nbsp;<span class="op" id="6956587">{</span>&nbsp;<span class="keyword" id="6956589">return</span>&nbsp;<span class="builtintype" id="6956596">nil</span>&nbsp;<span class="op" id="6956600">}</span><br>
<span class="lineno"></span><span class="keyword" id="6956602">func</span>&nbsp;<span class="op" id="6956607">(</span><span class="ident" id="6956608">f</span>&nbsp;<span class="ident" id="6956610">faker</span><span class="op" id="6956615">)</span>&nbsp;<span class="ident" id="6956617">SetWriteDeadline</span><span class="op" id="6956633">(</span><span class="ident" id="6956634">time</span><span class="op" id="6956638">.</span><span class="ident" id="6956639">Time</span><span class="op" id="6956643">)</span>&nbsp;<span class="builtintype" id="6956645">error</span>&nbsp;<span class="op" id="6956651">{</span>&nbsp;<span class="keyword" id="6956653">return</span>&nbsp;<span class="builtintype" id="6956660">nil</span>&nbsp;<span class="op" id="6956664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6956667">func</span>&nbsp;<span class="ident" id="6956672">TestBasic</span><span class="op" id="6956681">(</span><span class="ident" id="6956682">t</span>&nbsp;<span class="op" id="6956684">*</span><span class="ident" id="6956685">testing</span><span class="op" id="6956692">.</span><span class="ident" id="6956693">T</span><span class="op" id="6956694">)</span>&nbsp;<span class="op" id="6956696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6956699">server</span>&nbsp;<span class="op" id="6956706">:=</span>&nbsp;<span class="ident" id="6956709">strings</span><span class="op" id="6956716">.</span><span class="ident" id="6956717">Join</span><span class="op" id="6956721">(</span><span class="ident" id="6956722">strings</span><span class="op" id="6956729">.</span><span class="ident" id="6956730">Split</span><span class="op" id="6956735">(</span><span class="ident" id="6956736">basicServer</span><span class="op" id="6956747">,</span>&nbsp;<span class="string" id="6956749">&#34;\n&#34;</span><span class="op" id="6956753">)</span><span class="op" id="6956754">,</span>&nbsp;<span class="string" id="6956756">&#34;\r\n&#34;</span><span class="op" id="6956762">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6956765">client</span>&nbsp;<span class="op" id="6956772">:=</span>&nbsp;<span class="ident" id="6956775">strings</span><span class="op" id="6956782">.</span><span class="ident" id="6956783">Join</span><span class="op" id="6956787">(</span><span class="ident" id="6956788">strings</span><span class="op" id="6956795">.</span><span class="ident" id="6956796">Split</span><span class="op" id="6956801">(</span><span class="ident" id="6956802">basicClient</span><span class="op" id="6956813">,</span>&nbsp;<span class="string" id="6956815">&#34;\n&#34;</span><span class="op" id="6956819">)</span><span class="op" id="6956820">,</span>&nbsp;<span class="string" id="6956822">&#34;\r\n&#34;</span><span class="op" id="6956828">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6956832">var</span>&nbsp;<span class="ident" id="6956836">cmdbuf</span>&nbsp;<span class="ident" id="6956843">bytes</span><span class="op" id="6956848">.</span><span class="ident" id="6956849">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6956857">bcmdbuf</span>&nbsp;<span class="op" id="6956865">:=</span>&nbsp;<span class="ident" id="6956868">bufio</span><span class="op" id="6956873">.</span><span class="ident" id="6956874">NewWriter</span><span class="op" id="6956883">(</span><span class="op" id="6956884">&amp;</span><span class="ident" id="6956885">cmdbuf</span><span class="op" id="6956891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6956894">var</span>&nbsp;<span class="ident" id="6956898">fake</span>&nbsp;<span class="ident" id="6956903">faker</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6956910">fake</span><span class="op" id="6956914">.</span><span class="ident" id="6956915">ReadWriter</span>&nbsp;<span class="op" id="6956926">=</span>&nbsp;<span class="ident" id="6956928">bufio</span><span class="op" id="6956933">.</span><span class="ident" id="6956934">NewReadWriter</span><span class="op" id="6956947">(</span><span class="ident" id="6956948">bufio</span><span class="op" id="6956953">.</span><span class="ident" id="6956954">NewReader</span><span class="op" id="6956963">(</span><span class="ident" id="6956964">strings</span><span class="op" id="6956971">.</span><span class="ident" id="6956972">NewReader</span><span class="op" id="6956981">(</span><span class="ident" id="6956982">server</span><span class="op" id="6956988">)</span><span class="op" id="6956989">)</span><span class="op" id="6956990">,</span>&nbsp;<span class="ident" id="6956992">bcmdbuf</span><span class="op" id="6956999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6957002">c</span>&nbsp;<span class="op" id="6957004">:=</span>&nbsp;<span class="op" id="6957007">&amp;</span><span class="ident" id="6957008">Client</span><span class="op" id="6957014">{</span><span class="ident" id="6957015">Text</span><span class="op" id="6957019">:</span>&nbsp;<span class="ident" id="6957021">textproto</span><span class="op" id="6957030">.</span><span class="ident" id="6957031">NewConn</span><span class="op" id="6957038">(</span><span class="ident" id="6957039">fake</span><span class="op" id="6957043">)</span><span class="op" id="6957044">,</span>&nbsp;<span class="ident" id="6957046">localName</span><span class="op" id="6957055">:</span>&nbsp;<span class="string" id="6957057">&#34;localhost&#34;</span><span class="op" id="6957068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6957072">if</span>&nbsp;<span class="ident" id="6957075">err</span>&nbsp;<span class="op" id="6957079">:=</span>&nbsp;<span class="ident" id="6957082">c</span><span class="op" id="6957083">.</span><span class="ident" id="6957084">helo</span><span class="op" id="6957088">(</span><span class="op" id="6957089">)</span><span class="op" id="6957090">;</span>&nbsp;<span class="ident" id="6957092">err</span>&nbsp;<span class="op" id="6957096">!=</span>&nbsp;<span class="builtintype" id="6957099">nil</span>&nbsp;<span class="op" id="6957103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6957107">t</span><span class="op" id="6957108">.</span><span class="ident" id="6957109">Fatalf</span><span class="op" id="6957115">(</span><span class="string" id="6957116">&#34;HELO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6957133">,</span>&nbsp;<span class="ident" id="6957135">err</span><span class="op" id="6957138">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6957141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6957144">if</span>&nbsp;<span class="ident" id="6957147">err</span>&nbsp;<span class="op" id="6957151">:=</span>&nbsp;<span class="ident" id="6957154">c</span><span class="op" id="6957155">.</span><span class="ident" id="6957156">ehlo</span><span class="op" id="6957160">(</span><span class="op" id="6957161">)</span><span class="op" id="6957162">;</span>&nbsp;<span class="ident" id="6957164">err</span>&nbsp;<span class="op" id="6957168">==</span>&nbsp;<span class="builtintype" id="6957171">nil</span>&nbsp;<span class="op" id="6957175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6957179">t</span><span class="op" id="6957180">.</span><span class="ident" id="6957181">Fatalf</span><span class="op" id="6957187">(</span><span class="string" id="6957188">&#34;Expected&nbsp;first&nbsp;EHLO&nbsp;to&nbsp;fail&#34;</span><span class="op" id="6957217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6957220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6957223">if</span>&nbsp;<span class="ident" id="6957226">err</span>&nbsp;<span class="op" id="6957230">:=</span>&nbsp;<span class="ident" id="6957233">c</span><span class="op" id="6957234">.</span><span class="ident" id="6957235">ehlo</span><span class="op" id="6957239">(</span><span class="op" id="6957240">)</span><span class="op" id="6957241">;</span>&nbsp;<span class="ident" id="6957243">err</span>&nbsp;<span class="op" id="6957247">!=</span>&nbsp;<span class="builtintype" id="6957250">nil</span>&nbsp;<span class="op" id="6957254">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6957258">t</span><span class="op" id="6957259">.</span><span class="ident" id="6957260">Fatalf</span><span class="op" id="6957266">(</span><span class="string" id="6957267">&#34;Second&nbsp;EHLO&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6957291">,</span>&nbsp;<span class="ident" id="6957293">err</span><span class="op" id="6957296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6957299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6957303">c</span><span class="op" id="6957304">.</span><span class="ident" id="6957305">didHello</span>&nbsp;<span class="op" id="6957314">=</span>&nbsp;<span class="builtintype" id="6957316">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6957322">if</span>&nbsp;<span class="ident" id="6957325">ok</span><span class="op" id="6957327">,</span>&nbsp;<span class="ident" id="6957329">args</span>&nbsp;<span class="op" id="6957334">:=</span>&nbsp;<span class="ident" id="6957337">c</span><span class="op" id="6957338">.</span><span class="ident" id="6957339">Extension</span><span class="op" id="6957348">(</span><span class="string" id="6957349">&#34;aUtH&#34;</span><span class="op" id="6957355">)</span><span class="op" id="6957356">;</span>&nbsp;<span class="op" id="6957358">!</span><span class="ident" id="6957359">ok</span>&nbsp;<span class="op" id="6957362">||</span>&nbsp;<span class="ident" id="6957365">args</span>&nbsp;<span class="op" id="6957370">!=</span>&nbsp;<span class="string" id="6957373">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="6957387">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6957391">t</span><span class="op" id="6957392">.</span><span class="ident" id="6957393">Fatalf</span><span class="op" id="6957399">(</span><span class="string" id="6957400">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="6957425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6957428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6957431">if</span>&nbsp;<span class="ident" id="6957434">ok</span><span class="op" id="6957436">,</span>&nbsp;<span class="ident" id="6957438">_</span>&nbsp;<span class="op" id="6957440">:=</span>&nbsp;<span class="ident" id="6957443">c</span><span class="op" id="6957444">.</span><span class="ident" id="6957445">Extension</span><span class="op" id="6957454">(</span><span class="string" id="6957455">&#34;DSN&#34;</span><span class="op" id="6957460">)</span><span class="op" id="6957461">;</span>&nbsp;<span class="ident" id="6957463">ok</span>&nbsp;<span class="op" id="6957466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6957470">t</span><span class="op" id="6957471">.</span><span class="ident" id="6957472">Fatalf</span><span class="op" id="6957478">(</span><span class="string" id="6957479">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="6957502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6957505">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6957509">if</span>&nbsp;<span class="ident" id="6957512">err</span>&nbsp;<span class="op" id="6957516">:=</span>&nbsp;<span class="ident" id="6957519">c</span><span class="op" id="6957520">.</span><span class="ident" id="6957521">Mail</span><span class="op" id="6957525">(</span><span class="string" id="6957526">&#34;user@gmail.com&#34;</span><span class="op" id="6957542">)</span><span class="op" id="6957543">;</span>&nbsp;<span class="ident" id="6957545">err</span>&nbsp;<span class="op" id="6957549">==</span>&nbsp;<span class="builtintype" id="6957552">nil</span>&nbsp;<span class="op" id="6957556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6957560">t</span><span class="op" id="6957561">.</span><span class="ident" id="6957562">Fatalf</span><span class="op" id="6957568">(</span><span class="string" id="6957569">&#34;MAIL&nbsp;should&nbsp;require&nbsp;authentication&#34;</span><span class="op" id="6957605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6957608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6957612">if</span>&nbsp;<span class="ident" id="6957615">err</span>&nbsp;<span class="op" id="6957619">:=</span>&nbsp;<span class="ident" id="6957622">c</span><span class="op" id="6957623">.</span><span class="ident" id="6957624">Verify</span><span class="op" id="6957630">(</span><span class="string" id="6957631">&#34;user1@gmail.com&#34;</span><span class="op" id="6957648">)</span><span class="op" id="6957649">;</span>&nbsp;<span class="ident" id="6957651">err</span>&nbsp;<span class="op" id="6957655">==</span>&nbsp;<span class="builtintype" id="6957658">nil</span>&nbsp;<span class="op" id="6957662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6957666">t</span><span class="op" id="6957667">.</span><span class="ident" id="6957668">Fatalf</span><span class="op" id="6957674">(</span><span class="string" id="6957675">&#34;First&nbsp;VRFY:&nbsp;expected&nbsp;no&nbsp;verification&#34;</span><span class="op" id="6957713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6957716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6957719">if</span>&nbsp;<span class="ident" id="6957722">err</span>&nbsp;<span class="op" id="6957726">:=</span>&nbsp;<span class="ident" id="6957729">c</span><span class="op" id="6957730">.</span><span class="ident" id="6957731">Verify</span><span class="op" id="6957737">(</span><span class="string" id="6957738">&#34;user2@gmail.com&#34;</span><span class="op" id="6957755">)</span><span class="op" id="6957756">;</span>&nbsp;<span class="ident" id="6957758">err</span>&nbsp;<span class="op" id="6957762">!=</span>&nbsp;<span class="builtintype" id="6957765">nil</span>&nbsp;<span class="op" id="6957769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6957773">t</span><span class="op" id="6957774">.</span><span class="ident" id="6957775">Fatalf</span><span class="op" id="6957781">(</span><span class="string" id="6957782">&#34;Second&nbsp;VRFY:&nbsp;expected&nbsp;verification,&nbsp;got&nbsp;%s&#34;</span><span class="op" id="6957826">,</span>&nbsp;<span class="ident" id="6957828">err</span><span class="op" id="6957831">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6957834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6957838">//&nbsp;fake&nbsp;TLS&nbsp;so&nbsp;authentication&nbsp;won&#39;t&nbsp;complain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6957884">c</span><span class="op" id="6957885">.</span><span class="ident" id="6957886">tls</span>&nbsp;<span class="op" id="6957890">=</span>&nbsp;<span class="builtintype" id="6957892">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6957898">c</span><span class="op" id="6957899">.</span><span class="ident" id="6957900">serverName</span>&nbsp;<span class="op" id="6957911">=</span>&nbsp;<span class="string" id="6957913">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6957932">if</span>&nbsp;<span class="ident" id="6957935">err</span>&nbsp;<span class="op" id="6957939">:=</span>&nbsp;<span class="ident" id="6957942">c</span><span class="op" id="6957943">.</span><span class="ident" id="6957944">Auth</span><span class="op" id="6957948">(</span><span class="ident" id="6957949">PlainAuth</span><span class="op" id="6957958">(</span><span class="string" id="6957959">&#34;&#34;</span><span class="op" id="6957961">,</span>&nbsp;<span class="string" id="6957963">&#34;user&#34;</span><span class="op" id="6957969">,</span>&nbsp;<span class="string" id="6957971">&#34;pass&#34;</span><span class="op" id="6957977">,</span>&nbsp;<span class="string" id="6957979">&#34;smtp.google.com&#34;</span><span class="op" id="6957996">)</span><span class="op" id="6957997">)</span><span class="op" id="6957998">;</span>&nbsp;<span class="ident" id="6958000">err</span>&nbsp;<span class="op" id="6958004">!=</span>&nbsp;<span class="builtintype" id="6958007">nil</span>&nbsp;<span class="op" id="6958011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6958015">t</span><span class="op" id="6958016">.</span><span class="ident" id="6958017">Fatalf</span><span class="op" id="6958023">(</span><span class="string" id="6958024">&#34;AUTH&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6958041">,</span>&nbsp;<span class="ident" id="6958043">err</span><span class="op" id="6958046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6958049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6958053">if</span>&nbsp;<span class="ident" id="6958056">err</span>&nbsp;<span class="op" id="6958060">:=</span>&nbsp;<span class="ident" id="6958063">c</span><span class="op" id="6958064">.</span><span class="ident" id="6958065">Mail</span><span class="op" id="6958069">(</span><span class="string" id="6958070">&#34;user@gmail.com&#34;</span><span class="op" id="6958086">)</span><span class="op" id="6958087">;</span>&nbsp;<span class="ident" id="6958089">err</span>&nbsp;<span class="op" id="6958093">!=</span>&nbsp;<span class="builtintype" id="6958096">nil</span>&nbsp;<span class="op" id="6958100">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6958104">t</span><span class="op" id="6958105">.</span><span class="ident" id="6958106">Fatalf</span><span class="op" id="6958112">(</span><span class="string" id="6958113">&#34;MAIL&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6958130">,</span>&nbsp;<span class="ident" id="6958132">err</span><span class="op" id="6958135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6958138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6958141">if</span>&nbsp;<span class="ident" id="6958144">err</span>&nbsp;<span class="op" id="6958148">:=</span>&nbsp;<span class="ident" id="6958151">c</span><span class="op" id="6958152">.</span><span class="ident" id="6958153">Rcpt</span><span class="op" id="6958157">(</span><span class="string" id="6958158">&#34;golang-nuts@googlegroups.com&#34;</span><span class="op" id="6958188">)</span><span class="op" id="6958189">;</span>&nbsp;<span class="ident" id="6958191">err</span>&nbsp;<span class="op" id="6958195">!=</span>&nbsp;<span class="builtintype" id="6958198">nil</span>&nbsp;<span class="op" id="6958202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6958206">t</span><span class="op" id="6958207">.</span><span class="ident" id="6958208">Fatalf</span><span class="op" id="6958214">(</span><span class="string" id="6958215">&#34;RCPT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6958232">,</span>&nbsp;<span class="ident" id="6958234">err</span><span class="op" id="6958237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6958240">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6958243">msg</span>&nbsp;<span class="op" id="6958247">:=</span>&nbsp;<span class="string" id="6958250">`From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno"></span>Line&nbsp;1<br>
<span class="lineno">165</span>.Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6958367">w</span><span class="op" id="6958368">,</span>&nbsp;<span class="ident" id="6958370">err</span>&nbsp;<span class="op" id="6958374">:=</span>&nbsp;<span class="ident" id="6958377">c</span><span class="op" id="6958378">.</span><span class="ident" id="6958379">Data</span><span class="op" id="6958383">(</span><span class="op" id="6958384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6958387">if</span>&nbsp;<span class="ident" id="6958390">err</span>&nbsp;<span class="op" id="6958394">!=</span>&nbsp;<span class="builtintype" id="6958397">nil</span>&nbsp;<span class="op" id="6958401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6958405">t</span><span class="op" id="6958406">.</span><span class="ident" id="6958407">Fatalf</span><span class="op" id="6958413">(</span><span class="string" id="6958414">&#34;DATA&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6958431">,</span>&nbsp;<span class="ident" id="6958433">err</span><span class="op" id="6958436">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6958439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6958442">if</span>&nbsp;<span class="ident" id="6958445">_</span><span class="op" id="6958446">,</span>&nbsp;<span class="ident" id="6958448">err</span>&nbsp;<span class="op" id="6958452">:=</span>&nbsp;<span class="ident" id="6958455">w</span><span class="op" id="6958456">.</span><span class="ident" id="6958457">Write</span><span class="op" id="6958462">(</span><span class="op" id="6958463">[</span><span class="op" id="6958464">]</span><span class="builtintype" id="6958465">byte</span><span class="op" id="6958469">(</span><span class="ident" id="6958470">msg</span><span class="op" id="6958473">)</span><span class="op" id="6958474">)</span><span class="op" id="6958475">;</span>&nbsp;<span class="ident" id="6958477">err</span>&nbsp;<span class="op" id="6958481">!=</span>&nbsp;<span class="builtintype" id="6958484">nil</span>&nbsp;<span class="op" id="6958488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6958492">t</span><span class="op" id="6958493">.</span><span class="ident" id="6958494">Fatalf</span><span class="op" id="6958500">(</span><span class="string" id="6958501">&#34;Data&nbsp;write&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6958524">,</span>&nbsp;<span class="ident" id="6958526">err</span><span class="op" id="6958529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6958532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6958535">if</span>&nbsp;<span class="ident" id="6958538">err</span>&nbsp;<span class="op" id="6958542">:=</span>&nbsp;<span class="ident" id="6958545">w</span><span class="op" id="6958546">.</span><span class="ident" id="6958547">Close</span><span class="op" id="6958552">(</span><span class="op" id="6958553">)</span><span class="op" id="6958554">;</span>&nbsp;<span class="ident" id="6958556">err</span>&nbsp;<span class="op" id="6958560">!=</span>&nbsp;<span class="builtintype" id="6958563">nil</span>&nbsp;<span class="op" id="6958567">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6958571">t</span><span class="op" id="6958572">.</span><span class="ident" id="6958573">Fatalf</span><span class="op" id="6958579">(</span><span class="string" id="6958580">&#34;Bad&nbsp;data&nbsp;response:&nbsp;%s&#34;</span><span class="op" id="6958603">,</span>&nbsp;<span class="ident" id="6958605">err</span><span class="op" id="6958608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6958611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6958615">if</span>&nbsp;<span class="ident" id="6958618">err</span>&nbsp;<span class="op" id="6958622">:=</span>&nbsp;<span class="ident" id="6958625">c</span><span class="op" id="6958626">.</span><span class="ident" id="6958627">Quit</span><span class="op" id="6958631">(</span><span class="op" id="6958632">)</span><span class="op" id="6958633">;</span>&nbsp;<span class="ident" id="6958635">err</span>&nbsp;<span class="op" id="6958639">!=</span>&nbsp;<span class="builtintype" id="6958642">nil</span>&nbsp;<span class="op" id="6958646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6958650">t</span><span class="op" id="6958651">.</span><span class="ident" id="6958652">Fatalf</span><span class="op" id="6958658">(</span><span class="string" id="6958659">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6958676">,</span>&nbsp;<span class="ident" id="6958678">err</span><span class="op" id="6958681">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6958684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6958688">bcmdbuf</span><span class="op" id="6958695">.</span><span class="ident" id="6958696">Flush</span><span class="op" id="6958701">(</span><span class="op" id="6958702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6958705">actualcmds</span>&nbsp;<span class="op" id="6958716">:=</span>&nbsp;<span class="ident" id="6958719">cmdbuf</span><span class="op" id="6958725">.</span><span class="ident" id="6958726">String</span><span class="op" id="6958732">(</span><span class="op" id="6958733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6958736">if</span>&nbsp;<span class="ident" id="6958739">client</span>&nbsp;<span class="op" id="6958746">!=</span>&nbsp;<span class="ident" id="6958749">actualcmds</span>&nbsp;<span class="op" id="6958760">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6958764">t</span><span class="op" id="6958765">.</span><span class="ident" id="6958766">Fatalf</span><span class="op" id="6958772">(</span><span class="string" id="6958773">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6958798">,</span>&nbsp;<span class="ident" id="6958800">actualcmds</span><span class="op" id="6958810">,</span>&nbsp;<span class="ident" id="6958812">client</span><span class="op" id="6958818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6958821">}</span><br>
<span class="lineno"></span><span class="op" id="6958823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6958826">var</span>&nbsp;<span class="ident" id="6958830">basicServer</span>&nbsp;<span class="op" id="6958842">=</span>&nbsp;<span class="string" id="6958844">`250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno">190</span>502&nbsp;Unrecognized&nbsp;command.<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">195</span>530&nbsp;Authentication&nbsp;required<br>
<span class="lineno"></span>252&nbsp;Send&nbsp;some&nbsp;mail,&nbsp;I&#39;ll&nbsp;try&nbsp;my&nbsp;best<br>
<span class="lineno"></span>250&nbsp;User&nbsp;is&nbsp;valid<br>
<span class="lineno"></span>235&nbsp;Accepted<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;OK<br>
<span class="lineno">200</span>250&nbsp;Receiver&nbsp;OK<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;OK<br>
<span class="lineno"></span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="6959152">var</span>&nbsp;<span class="ident" id="6959156">basicClient</span>&nbsp;<span class="op" id="6959168">=</span>&nbsp;<span class="string" id="6959170">`HELO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>EHLO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno">210</span>VRFY&nbsp;user1@gmail.com<br>
<span class="lineno"></span>VRFY&nbsp;user2@gmail.com<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;user@gmail.com&gt;&nbsp;BODY=8BITMIME<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;golang-nuts@googlegroups.com&gt;<br>
<span class="lineno">215</span>DATA<br>
<span class="lineno"></span>From:&nbsp;user@gmail.com<br>
<span class="lineno"></span>To:&nbsp;golang-nuts@googlegroups.com<br>
<span class="lineno"></span>Subject:&nbsp;Hooray&nbsp;for&nbsp;Go<br>
<span class="lineno"></span><br>
<span class="lineno">220</span>Line&nbsp;1<br>
<span class="lineno"></span>..Leading&nbsp;dot&nbsp;line&nbsp;.<br>
<span class="lineno"></span>Goodbye.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">225</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6959537">func</span>&nbsp;<span class="ident" id="6959542">TestNewClient</span><span class="op" id="6959555">(</span><span class="ident" id="6959556">t</span>&nbsp;<span class="op" id="6959558">*</span><span class="ident" id="6959559">testing</span><span class="op" id="6959566">.</span><span class="ident" id="6959567">T</span><span class="op" id="6959568">)</span>&nbsp;<span class="op" id="6959570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6959573">server</span>&nbsp;<span class="op" id="6959580">:=</span>&nbsp;<span class="ident" id="6959583">strings</span><span class="op" id="6959590">.</span><span class="ident" id="6959591">Join</span><span class="op" id="6959595">(</span><span class="ident" id="6959596">strings</span><span class="op" id="6959603">.</span><span class="ident" id="6959604">Split</span><span class="op" id="6959609">(</span><span class="ident" id="6959610">newClientServer</span><span class="op" id="6959625">,</span>&nbsp;<span class="string" id="6959627">&#34;\n&#34;</span><span class="op" id="6959631">)</span><span class="op" id="6959632">,</span>&nbsp;<span class="string" id="6959634">&#34;\r\n&#34;</span><span class="op" id="6959640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6959643">client</span>&nbsp;<span class="op" id="6959650">:=</span>&nbsp;<span class="ident" id="6959653">strings</span><span class="op" id="6959660">.</span><span class="ident" id="6959661">Join</span><span class="op" id="6959665">(</span><span class="ident" id="6959666">strings</span><span class="op" id="6959673">.</span><span class="ident" id="6959674">Split</span><span class="op" id="6959679">(</span><span class="ident" id="6959680">newClientClient</span><span class="op" id="6959695">,</span>&nbsp;<span class="string" id="6959697">&#34;\n&#34;</span><span class="op" id="6959701">)</span><span class="op" id="6959702">,</span>&nbsp;<span class="string" id="6959704">&#34;\r\n&#34;</span><span class="op" id="6959710">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6959714">var</span>&nbsp;<span class="ident" id="6959718">cmdbuf</span>&nbsp;<span class="ident" id="6959725">bytes</span><span class="op" id="6959730">.</span><span class="ident" id="6959731">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6959739">bcmdbuf</span>&nbsp;<span class="op" id="6959747">:=</span>&nbsp;<span class="ident" id="6959750">bufio</span><span class="op" id="6959755">.</span><span class="ident" id="6959756">NewWriter</span><span class="op" id="6959765">(</span><span class="op" id="6959766">&amp;</span><span class="ident" id="6959767">cmdbuf</span><span class="op" id="6959773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6959776">out</span>&nbsp;<span class="op" id="6959780">:=</span>&nbsp;<span class="keyword" id="6959783">func</span><span class="op" id="6959787">(</span><span class="op" id="6959788">)</span>&nbsp;<span class="builtintype" id="6959790">string</span>&nbsp;<span class="op" id="6959797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6959801">bcmdbuf</span><span class="op" id="6959808">.</span><span class="ident" id="6959809">Flush</span><span class="op" id="6959814">(</span><span class="op" id="6959815">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6959819">return</span>&nbsp;<span class="ident" id="6959826">cmdbuf</span><span class="op" id="6959832">.</span><span class="ident" id="6959833">String</span><span class="op" id="6959839">(</span><span class="op" id="6959840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6959843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6959846">var</span>&nbsp;<span class="ident" id="6959850">fake</span>&nbsp;<span class="ident" id="6959855">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6959862">fake</span><span class="op" id="6959866">.</span><span class="ident" id="6959867">ReadWriter</span>&nbsp;<span class="op" id="6959878">=</span>&nbsp;<span class="ident" id="6959880">bufio</span><span class="op" id="6959885">.</span><span class="ident" id="6959886">NewReadWriter</span><span class="op" id="6959899">(</span><span class="ident" id="6959900">bufio</span><span class="op" id="6959905">.</span><span class="ident" id="6959906">NewReader</span><span class="op" id="6959915">(</span><span class="ident" id="6959916">strings</span><span class="op" id="6959923">.</span><span class="ident" id="6959924">NewReader</span><span class="op" id="6959933">(</span><span class="ident" id="6959934">server</span><span class="op" id="6959940">)</span><span class="op" id="6959941">)</span><span class="op" id="6959942">,</span>&nbsp;<span class="ident" id="6959944">bcmdbuf</span><span class="op" id="6959951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6959954">c</span><span class="op" id="6959955">,</span>&nbsp;<span class="ident" id="6959957">err</span>&nbsp;<span class="op" id="6959961">:=</span>&nbsp;<span class="ident" id="6959964">NewClient</span><span class="op" id="6959973">(</span><span class="ident" id="6959974">fake</span><span class="op" id="6959978">,</span>&nbsp;<span class="string" id="6959980">&#34;fake.host&#34;</span><span class="op" id="6959991">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6959994">if</span>&nbsp;<span class="ident" id="6959997">err</span>&nbsp;<span class="op" id="6960001">!=</span>&nbsp;<span class="builtintype" id="6960004">nil</span>&nbsp;<span class="op" id="6960008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6960012">t</span><span class="op" id="6960013">.</span><span class="ident" id="6960014">Fatalf</span><span class="op" id="6960020">(</span><span class="string" id="6960021">&#34;NewClient:&nbsp;%v\n(after&nbsp;%v)&#34;</span><span class="op" id="6960048">,</span>&nbsp;<span class="ident" id="6960050">err</span><span class="op" id="6960053">,</span>&nbsp;<span class="ident" id="6960055">out</span><span class="op" id="6960058">(</span><span class="op" id="6960059">)</span><span class="op" id="6960060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6960063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6960066">defer</span>&nbsp;<span class="ident" id="6960072">c</span><span class="op" id="6960073">.</span><span class="ident" id="6960074">Close</span><span class="op" id="6960079">(</span><span class="op" id="6960080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6960083">if</span>&nbsp;<span class="ident" id="6960086">ok</span><span class="op" id="6960088">,</span>&nbsp;<span class="ident" id="6960090">args</span>&nbsp;<span class="op" id="6960095">:=</span>&nbsp;<span class="ident" id="6960098">c</span><span class="op" id="6960099">.</span><span class="ident" id="6960100">Extension</span><span class="op" id="6960109">(</span><span class="string" id="6960110">&#34;aUtH&#34;</span><span class="op" id="6960116">)</span><span class="op" id="6960117">;</span>&nbsp;<span class="op" id="6960119">!</span><span class="ident" id="6960120">ok</span>&nbsp;<span class="op" id="6960123">||</span>&nbsp;<span class="ident" id="6960126">args</span>&nbsp;<span class="op" id="6960131">!=</span>&nbsp;<span class="string" id="6960134">&#34;LOGIN&nbsp;PLAIN&#34;</span>&nbsp;<span class="op" id="6960148">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6960152">t</span><span class="op" id="6960153">.</span><span class="ident" id="6960154">Fatalf</span><span class="op" id="6960160">(</span><span class="string" id="6960161">&#34;Expected&nbsp;AUTH&nbsp;supported&#34;</span><span class="op" id="6960186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6960189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6960192">if</span>&nbsp;<span class="ident" id="6960195">ok</span><span class="op" id="6960197">,</span>&nbsp;<span class="ident" id="6960199">_</span>&nbsp;<span class="op" id="6960201">:=</span>&nbsp;<span class="ident" id="6960204">c</span><span class="op" id="6960205">.</span><span class="ident" id="6960206">Extension</span><span class="op" id="6960215">(</span><span class="string" id="6960216">&#34;DSN&#34;</span><span class="op" id="6960221">)</span><span class="op" id="6960222">;</span>&nbsp;<span class="ident" id="6960224">ok</span>&nbsp;<span class="op" id="6960227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6960231">t</span><span class="op" id="6960232">.</span><span class="ident" id="6960233">Fatalf</span><span class="op" id="6960239">(</span><span class="string" id="6960240">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="6960263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6960266">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6960269">if</span>&nbsp;<span class="ident" id="6960272">err</span>&nbsp;<span class="op" id="6960276">:=</span>&nbsp;<span class="ident" id="6960279">c</span><span class="op" id="6960280">.</span><span class="ident" id="6960281">Quit</span><span class="op" id="6960285">(</span><span class="op" id="6960286">)</span><span class="op" id="6960287">;</span>&nbsp;<span class="ident" id="6960289">err</span>&nbsp;<span class="op" id="6960293">!=</span>&nbsp;<span class="builtintype" id="6960296">nil</span>&nbsp;<span class="op" id="6960300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6960304">t</span><span class="op" id="6960305">.</span><span class="ident" id="6960306">Fatalf</span><span class="op" id="6960312">(</span><span class="string" id="6960313">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6960330">,</span>&nbsp;<span class="ident" id="6960332">err</span><span class="op" id="6960335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6960338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6960342">actualcmds</span>&nbsp;<span class="op" id="6960353">:=</span>&nbsp;<span class="ident" id="6960356">out</span><span class="op" id="6960359">(</span><span class="op" id="6960360">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6960363">if</span>&nbsp;<span class="ident" id="6960366">client</span>&nbsp;<span class="op" id="6960373">!=</span>&nbsp;<span class="ident" id="6960376">actualcmds</span>&nbsp;<span class="op" id="6960387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6960391">t</span><span class="op" id="6960392">.</span><span class="ident" id="6960393">Fatalf</span><span class="op" id="6960399">(</span><span class="string" id="6960400">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6960425">,</span>&nbsp;<span class="ident" id="6960427">actualcmds</span><span class="op" id="6960437">,</span>&nbsp;<span class="ident" id="6960439">client</span><span class="op" id="6960445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6960448">}</span><br>
<span class="lineno"></span><span class="op" id="6960450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="keyword" id="6960453">var</span>&nbsp;<span class="ident" id="6960457">newClientServer</span>&nbsp;<span class="op" id="6960473">=</span>&nbsp;<span class="string" id="6960475">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">265</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6960588">var</span>&nbsp;<span class="ident" id="6960592">newClientClient</span>&nbsp;<span class="op" id="6960608">=</span>&nbsp;<span class="string" id="6960610">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno">270</span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6960634">func</span>&nbsp;<span class="ident" id="6960639">TestNewClient2</span><span class="op" id="6960653">(</span><span class="ident" id="6960654">t</span>&nbsp;<span class="op" id="6960656">*</span><span class="ident" id="6960657">testing</span><span class="op" id="6960664">.</span><span class="ident" id="6960665">T</span><span class="op" id="6960666">)</span>&nbsp;<span class="op" id="6960668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6960671">server</span>&nbsp;<span class="op" id="6960678">:=</span>&nbsp;<span class="ident" id="6960681">strings</span><span class="op" id="6960688">.</span><span class="ident" id="6960689">Join</span><span class="op" id="6960693">(</span><span class="ident" id="6960694">strings</span><span class="op" id="6960701">.</span><span class="ident" id="6960702">Split</span><span class="op" id="6960707">(</span><span class="ident" id="6960708">newClient2Server</span><span class="op" id="6960724">,</span>&nbsp;<span class="string" id="6960726">&#34;\n&#34;</span><span class="op" id="6960730">)</span><span class="op" id="6960731">,</span>&nbsp;<span class="string" id="6960733">&#34;\r\n&#34;</span><span class="op" id="6960739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6960742">client</span>&nbsp;<span class="op" id="6960749">:=</span>&nbsp;<span class="ident" id="6960752">strings</span><span class="op" id="6960759">.</span><span class="ident" id="6960760">Join</span><span class="op" id="6960764">(</span><span class="ident" id="6960765">strings</span><span class="op" id="6960772">.</span><span class="ident" id="6960773">Split</span><span class="op" id="6960778">(</span><span class="ident" id="6960779">newClient2Client</span><span class="op" id="6960795">,</span>&nbsp;<span class="string" id="6960797">&#34;\n&#34;</span><span class="op" id="6960801">)</span><span class="op" id="6960802">,</span>&nbsp;<span class="string" id="6960804">&#34;\r\n&#34;</span><span class="op" id="6960810">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6960814">var</span>&nbsp;<span class="ident" id="6960818">cmdbuf</span>&nbsp;<span class="ident" id="6960825">bytes</span><span class="op" id="6960830">.</span><span class="ident" id="6960831">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6960839">bcmdbuf</span>&nbsp;<span class="op" id="6960847">:=</span>&nbsp;<span class="ident" id="6960850">bufio</span><span class="op" id="6960855">.</span><span class="ident" id="6960856">NewWriter</span><span class="op" id="6960865">(</span><span class="op" id="6960866">&amp;</span><span class="ident" id="6960867">cmdbuf</span><span class="op" id="6960873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6960876">var</span>&nbsp;<span class="ident" id="6960880">fake</span>&nbsp;<span class="ident" id="6960885">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6960892">fake</span><span class="op" id="6960896">.</span><span class="ident" id="6960897">ReadWriter</span>&nbsp;<span class="op" id="6960908">=</span>&nbsp;<span class="ident" id="6960910">bufio</span><span class="op" id="6960915">.</span><span class="ident" id="6960916">NewReadWriter</span><span class="op" id="6960929">(</span><span class="ident" id="6960930">bufio</span><span class="op" id="6960935">.</span><span class="ident" id="6960936">NewReader</span><span class="op" id="6960945">(</span><span class="ident" id="6960946">strings</span><span class="op" id="6960953">.</span><span class="ident" id="6960954">NewReader</span><span class="op" id="6960963">(</span><span class="ident" id="6960964">server</span><span class="op" id="6960970">)</span><span class="op" id="6960971">)</span><span class="op" id="6960972">,</span>&nbsp;<span class="ident" id="6960974">bcmdbuf</span><span class="op" id="6960981">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6960984">c</span><span class="op" id="6960985">,</span>&nbsp;<span class="ident" id="6960987">err</span>&nbsp;<span class="op" id="6960991">:=</span>&nbsp;<span class="ident" id="6960994">NewClient</span><span class="op" id="6961003">(</span><span class="ident" id="6961004">fake</span><span class="op" id="6961008">,</span>&nbsp;<span class="string" id="6961010">&#34;fake.host&#34;</span><span class="op" id="6961021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6961024">if</span>&nbsp;<span class="ident" id="6961027">err</span>&nbsp;<span class="op" id="6961031">!=</span>&nbsp;<span class="builtintype" id="6961034">nil</span>&nbsp;<span class="op" id="6961038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6961042">t</span><span class="op" id="6961043">.</span><span class="ident" id="6961044">Fatalf</span><span class="op" id="6961050">(</span><span class="string" id="6961051">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="6961066">,</span>&nbsp;<span class="ident" id="6961068">err</span><span class="op" id="6961071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6961074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6961077">defer</span>&nbsp;<span class="ident" id="6961083">c</span><span class="op" id="6961084">.</span><span class="ident" id="6961085">Close</span><span class="op" id="6961090">(</span><span class="op" id="6961091">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6961094">if</span>&nbsp;<span class="ident" id="6961097">ok</span><span class="op" id="6961099">,</span>&nbsp;<span class="ident" id="6961101">_</span>&nbsp;<span class="op" id="6961103">:=</span>&nbsp;<span class="ident" id="6961106">c</span><span class="op" id="6961107">.</span><span class="ident" id="6961108">Extension</span><span class="op" id="6961117">(</span><span class="string" id="6961118">&#34;DSN&#34;</span><span class="op" id="6961123">)</span><span class="op" id="6961124">;</span>&nbsp;<span class="ident" id="6961126">ok</span>&nbsp;<span class="op" id="6961129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6961133">t</span><span class="op" id="6961134">.</span><span class="ident" id="6961135">Fatalf</span><span class="op" id="6961141">(</span><span class="string" id="6961142">&#34;Shouldn&#39;t&nbsp;support&nbsp;DSN&#34;</span><span class="op" id="6961165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6961168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6961171">if</span>&nbsp;<span class="ident" id="6961174">err</span>&nbsp;<span class="op" id="6961178">:=</span>&nbsp;<span class="ident" id="6961181">c</span><span class="op" id="6961182">.</span><span class="ident" id="6961183">Quit</span><span class="op" id="6961187">(</span><span class="op" id="6961188">)</span><span class="op" id="6961189">;</span>&nbsp;<span class="ident" id="6961191">err</span>&nbsp;<span class="op" id="6961195">!=</span>&nbsp;<span class="builtintype" id="6961198">nil</span>&nbsp;<span class="op" id="6961202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6961206">t</span><span class="op" id="6961207">.</span><span class="ident" id="6961208">Fatalf</span><span class="op" id="6961214">(</span><span class="string" id="6961215">&#34;QUIT&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="6961232">,</span>&nbsp;<span class="ident" id="6961234">err</span><span class="op" id="6961237">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6961240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6961244">bcmdbuf</span><span class="op" id="6961251">.</span><span class="ident" id="6961252">Flush</span><span class="op" id="6961257">(</span><span class="op" id="6961258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6961261">actualcmds</span>&nbsp;<span class="op" id="6961272">:=</span>&nbsp;<span class="ident" id="6961275">cmdbuf</span><span class="op" id="6961281">.</span><span class="ident" id="6961282">String</span><span class="op" id="6961288">(</span><span class="op" id="6961289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6961292">if</span>&nbsp;<span class="ident" id="6961295">client</span>&nbsp;<span class="op" id="6961302">!=</span>&nbsp;<span class="ident" id="6961305">actualcmds</span>&nbsp;<span class="op" id="6961316">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6961320">t</span><span class="op" id="6961321">.</span><span class="ident" id="6961322">Fatalf</span><span class="op" id="6961328">(</span><span class="string" id="6961329">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6961354">,</span>&nbsp;<span class="ident" id="6961356">actualcmds</span><span class="op" id="6961366">,</span>&nbsp;<span class="ident" id="6961368">client</span><span class="op" id="6961374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6961377">}</span><br>
<span class="lineno"></span><span class="op" id="6961379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6961382">var</span>&nbsp;<span class="ident" id="6961386">newClient2Server</span>&nbsp;<span class="op" id="6961403">=</span>&nbsp;<span class="string" id="6961405">`220&nbsp;hello&nbsp;world<br>
<span class="lineno">300</span>502&nbsp;EH?<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250-SIZE&nbsp;35651584<br>
<span class="lineno"></span>250-AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>250&nbsp;8BITMIME<br>
<span class="lineno">305</span>221&nbsp;OK<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6961526">var</span>&nbsp;<span class="ident" id="6961530">newClient2Client</span>&nbsp;<span class="op" id="6961547">=</span>&nbsp;<span class="string" id="6961549">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno">310</span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6961588">func</span>&nbsp;<span class="ident" id="6961593">TestHello</span><span class="op" id="6961602">(</span><span class="ident" id="6961603">t</span>&nbsp;<span class="op" id="6961605">*</span><span class="ident" id="6961606">testing</span><span class="op" id="6961613">.</span><span class="ident" id="6961614">T</span><span class="op" id="6961615">)</span>&nbsp;<span class="op" id="6961617">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6961621">if</span>&nbsp;<span class="builtinfunc" id="6961624">len</span><span class="op" id="6961627">(</span><span class="ident" id="6961628">helloServer</span><span class="op" id="6961639">)</span>&nbsp;<span class="op" id="6961641">!=</span>&nbsp;<span class="builtinfunc" id="6961644">len</span><span class="op" id="6961647">(</span><span class="ident" id="6961648">helloClient</span><span class="op" id="6961659">)</span>&nbsp;<span class="op" id="6961661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6961665">t</span><span class="op" id="6961666">.</span><span class="ident" id="6961667">Fatalf</span><span class="op" id="6961673">(</span><span class="string" id="6961674">&#34;Hello&nbsp;server&nbsp;and&nbsp;client&nbsp;size&nbsp;mismatch&#34;</span><span class="op" id="6961713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6961716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6961720">for</span>&nbsp;<span class="ident" id="6961724">i</span>&nbsp;<span class="op" id="6961726">:=</span>&nbsp;<span class="num" id="6961729">0</span><span class="op" id="6961730">;</span>&nbsp;<span class="ident" id="6961732">i</span>&nbsp;<span class="op" id="6961734">&lt;</span>&nbsp;<span class="builtinfunc" id="6961736">len</span><span class="op" id="6961739">(</span><span class="ident" id="6961740">helloServer</span><span class="op" id="6961751">)</span><span class="op" id="6961752">;</span>&nbsp;<span class="ident" id="6961754">i</span><span class="op" id="6961755">++</span>&nbsp;<span class="op" id="6961758">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6961762">server</span>&nbsp;<span class="op" id="6961769">:=</span>&nbsp;<span class="ident" id="6961772">strings</span><span class="op" id="6961779">.</span><span class="ident" id="6961780">Join</span><span class="op" id="6961784">(</span><span class="ident" id="6961785">strings</span><span class="op" id="6961792">.</span><span class="ident" id="6961793">Split</span><span class="op" id="6961798">(</span><span class="ident" id="6961799">baseHelloServer</span><span class="op" id="6961814">+</span><span class="ident" id="6961815">helloServer</span><span class="op" id="6961826">[</span><span class="ident" id="6961827">i</span><span class="op" id="6961828">]</span><span class="op" id="6961829">,</span>&nbsp;<span class="string" id="6961831">&#34;\n&#34;</span><span class="op" id="6961835">)</span><span class="op" id="6961836">,</span>&nbsp;<span class="string" id="6961838">&#34;\r\n&#34;</span><span class="op" id="6961844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6961848">client</span>&nbsp;<span class="op" id="6961855">:=</span>&nbsp;<span class="ident" id="6961858">strings</span><span class="op" id="6961865">.</span><span class="ident" id="6961866">Join</span><span class="op" id="6961870">(</span><span class="ident" id="6961871">strings</span><span class="op" id="6961878">.</span><span class="ident" id="6961879">Split</span><span class="op" id="6961884">(</span><span class="ident" id="6961885">baseHelloClient</span><span class="op" id="6961900">+</span><span class="ident" id="6961901">helloClient</span><span class="op" id="6961912">[</span><span class="ident" id="6961913">i</span><span class="op" id="6961914">]</span><span class="op" id="6961915">,</span>&nbsp;<span class="string" id="6961917">&#34;\n&#34;</span><span class="op" id="6961921">)</span><span class="op" id="6961922">,</span>&nbsp;<span class="string" id="6961924">&#34;\r\n&#34;</span><span class="op" id="6961930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6961934">var</span>&nbsp;<span class="ident" id="6961938">cmdbuf</span>&nbsp;<span class="ident" id="6961945">bytes</span><span class="op" id="6961950">.</span><span class="ident" id="6961951">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6961960">bcmdbuf</span>&nbsp;<span class="op" id="6961968">:=</span>&nbsp;<span class="ident" id="6961971">bufio</span><span class="op" id="6961976">.</span><span class="ident" id="6961977">NewWriter</span><span class="op" id="6961986">(</span><span class="op" id="6961987">&amp;</span><span class="ident" id="6961988">cmdbuf</span><span class="op" id="6961994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6961998">var</span>&nbsp;<span class="ident" id="6962002">fake</span>&nbsp;<span class="ident" id="6962007">faker</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6962015">fake</span><span class="op" id="6962019">.</span><span class="ident" id="6962020">ReadWriter</span>&nbsp;<span class="op" id="6962031">=</span>&nbsp;<span class="ident" id="6962033">bufio</span><span class="op" id="6962038">.</span><span class="ident" id="6962039">NewReadWriter</span><span class="op" id="6962052">(</span><span class="ident" id="6962053">bufio</span><span class="op" id="6962058">.</span><span class="ident" id="6962059">NewReader</span><span class="op" id="6962068">(</span><span class="ident" id="6962069">strings</span><span class="op" id="6962076">.</span><span class="ident" id="6962077">NewReader</span><span class="op" id="6962086">(</span><span class="ident" id="6962087">server</span><span class="op" id="6962093">)</span><span class="op" id="6962094">)</span><span class="op" id="6962095">,</span>&nbsp;<span class="ident" id="6962097">bcmdbuf</span><span class="op" id="6962104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6962108">c</span><span class="op" id="6962109">,</span>&nbsp;<span class="ident" id="6962111">err</span>&nbsp;<span class="op" id="6962115">:=</span>&nbsp;<span class="ident" id="6962118">NewClient</span><span class="op" id="6962127">(</span><span class="ident" id="6962128">fake</span><span class="op" id="6962132">,</span>&nbsp;<span class="string" id="6962134">&#34;fake.host&#34;</span><span class="op" id="6962145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6962149">if</span>&nbsp;<span class="ident" id="6962152">err</span>&nbsp;<span class="op" id="6962156">!=</span>&nbsp;<span class="builtintype" id="6962159">nil</span>&nbsp;<span class="op" id="6962163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6962168">t</span><span class="op" id="6962169">.</span><span class="ident" id="6962170">Fatalf</span><span class="op" id="6962176">(</span><span class="string" id="6962177">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="6962192">,</span>&nbsp;<span class="ident" id="6962194">err</span><span class="op" id="6962197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6962201">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6962205">defer</span>&nbsp;<span class="ident" id="6962211">c</span><span class="op" id="6962212">.</span><span class="ident" id="6962213">Close</span><span class="op" id="6962218">(</span><span class="op" id="6962219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6962223">c</span><span class="op" id="6962224">.</span><span class="ident" id="6962225">localName</span>&nbsp;<span class="op" id="6962235">=</span>&nbsp;<span class="string" id="6962237">&#34;customhost&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6962252">err</span>&nbsp;<span class="op" id="6962256">=</span>&nbsp;<span class="builtintype" id="6962258">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6962265">switch</span>&nbsp;<span class="ident" id="6962272">i</span>&nbsp;<span class="op" id="6962274">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6962278">case</span>&nbsp;<span class="num" id="6962283">0</span><span class="op" id="6962284">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6962289">err</span>&nbsp;<span class="op" id="6962293">=</span>&nbsp;<span class="ident" id="6962295">c</span><span class="op" id="6962296">.</span><span class="ident" id="6962297">Hello</span><span class="op" id="6962302">(</span><span class="string" id="6962303">&#34;customhost&#34;</span><span class="op" id="6962315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6962319">case</span>&nbsp;<span class="num" id="6962324">1</span><span class="op" id="6962325">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6962330">err</span>&nbsp;<span class="op" id="6962334">=</span>&nbsp;<span class="ident" id="6962336">c</span><span class="op" id="6962337">.</span><span class="ident" id="6962338">StartTLS</span><span class="op" id="6962346">(</span><span class="builtintype" id="6962347">nil</span><span class="op" id="6962350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6962355">if</span>&nbsp;<span class="ident" id="6962358">err</span><span class="op" id="6962361">.</span><span class="ident" id="6962362">Error</span><span class="op" id="6962367">(</span><span class="op" id="6962368">)</span>&nbsp;<span class="op" id="6962370">==</span>&nbsp;<span class="string" id="6962373">&#34;502&nbsp;Not&nbsp;implemented&#34;</span>&nbsp;<span class="op" id="6962395">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6962401">err</span>&nbsp;<span class="op" id="6962405">=</span>&nbsp;<span class="builtintype" id="6962407">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6962414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6962418">case</span>&nbsp;<span class="num" id="6962423">2</span><span class="op" id="6962424">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6962429">err</span>&nbsp;<span class="op" id="6962433">=</span>&nbsp;<span class="ident" id="6962435">c</span><span class="op" id="6962436">.</span><span class="ident" id="6962437">Verify</span><span class="op" id="6962443">(</span><span class="string" id="6962444">&#34;test@example.com&#34;</span><span class="op" id="6962462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6962466">case</span>&nbsp;<span class="num" id="6962471">3</span><span class="op" id="6962472">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6962477">c</span><span class="op" id="6962478">.</span><span class="ident" id="6962479">tls</span>&nbsp;<span class="op" id="6962483">=</span>&nbsp;<span class="builtintype" id="6962485">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6962493">c</span><span class="op" id="6962494">.</span><span class="ident" id="6962495">serverName</span>&nbsp;<span class="op" id="6962506">=</span>&nbsp;<span class="string" id="6962508">&#34;smtp.google.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6962529">err</span>&nbsp;<span class="op" id="6962533">=</span>&nbsp;<span class="ident" id="6962535">c</span><span class="op" id="6962536">.</span><span class="ident" id="6962537">Auth</span><span class="op" id="6962541">(</span><span class="ident" id="6962542">PlainAuth</span><span class="op" id="6962551">(</span><span class="string" id="6962552">&#34;&#34;</span><span class="op" id="6962554">,</span>&nbsp;<span class="string" id="6962556">&#34;user&#34;</span><span class="op" id="6962562">,</span>&nbsp;<span class="string" id="6962564">&#34;pass&#34;</span><span class="op" id="6962570">,</span>&nbsp;<span class="string" id="6962572">&#34;smtp.google.com&#34;</span><span class="op" id="6962589">)</span><span class="op" id="6962590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6962594">case</span>&nbsp;<span class="num" id="6962599">4</span><span class="op" id="6962600">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6962605">err</span>&nbsp;<span class="op" id="6962609">=</span>&nbsp;<span class="ident" id="6962611">c</span><span class="op" id="6962612">.</span><span class="ident" id="6962613">Mail</span><span class="op" id="6962617">(</span><span class="string" id="6962618">&#34;test@example.com&#34;</span><span class="op" id="6962636">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6962640">case</span>&nbsp;<span class="num" id="6962645">5</span><span class="op" id="6962646">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6962651">ok</span><span class="op" id="6962653">,</span>&nbsp;<span class="ident" id="6962655">_</span>&nbsp;<span class="op" id="6962657">:=</span>&nbsp;<span class="ident" id="6962660">c</span><span class="op" id="6962661">.</span><span class="ident" id="6962662">Extension</span><span class="op" id="6962671">(</span><span class="string" id="6962672">&#34;feature&#34;</span><span class="op" id="6962681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6962686">if</span>&nbsp;<span class="ident" id="6962689">ok</span>&nbsp;<span class="op" id="6962692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6962698">t</span><span class="op" id="6962699">.</span><span class="ident" id="6962700">Errorf</span><span class="op" id="6962706">(</span><span class="string" id="6962707">&#34;Expected&nbsp;FEATURE&nbsp;not&nbsp;to&nbsp;be&nbsp;supported&#34;</span><span class="op" id="6962745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6962750">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6962754">case</span>&nbsp;<span class="num" id="6962759">6</span><span class="op" id="6962760">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6962765">err</span>&nbsp;<span class="op" id="6962769">=</span>&nbsp;<span class="ident" id="6962771">c</span><span class="op" id="6962772">.</span><span class="ident" id="6962773">Reset</span><span class="op" id="6962778">(</span><span class="op" id="6962779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6962783">case</span>&nbsp;<span class="num" id="6962788">7</span><span class="op" id="6962789">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6962794">err</span>&nbsp;<span class="op" id="6962798">=</span>&nbsp;<span class="ident" id="6962800">c</span><span class="op" id="6962801">.</span><span class="ident" id="6962802">Quit</span><span class="op" id="6962806">(</span><span class="op" id="6962807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6962811">case</span>&nbsp;<span class="num" id="6962816">8</span><span class="op" id="6962817">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6962822">err</span>&nbsp;<span class="op" id="6962826">=</span>&nbsp;<span class="ident" id="6962828">c</span><span class="op" id="6962829">.</span><span class="ident" id="6962830">Verify</span><span class="op" id="6962836">(</span><span class="string" id="6962837">&#34;test@example.com&#34;</span><span class="op" id="6962855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6962860">if</span>&nbsp;<span class="ident" id="6962863">err</span>&nbsp;<span class="op" id="6962867">!=</span>&nbsp;<span class="builtintype" id="6962870">nil</span>&nbsp;<span class="op" id="6962874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6962880">err</span>&nbsp;<span class="op" id="6962884">=</span>&nbsp;<span class="ident" id="6962886">c</span><span class="op" id="6962887">.</span><span class="ident" id="6962888">Hello</span><span class="op" id="6962893">(</span><span class="string" id="6962894">&#34;customhost&#34;</span><span class="op" id="6962906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6962912">if</span>&nbsp;<span class="ident" id="6962915">err</span>&nbsp;<span class="op" id="6962919">!=</span>&nbsp;<span class="builtintype" id="6962922">nil</span>&nbsp;<span class="op" id="6962926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6962933">t</span><span class="op" id="6962934">.</span><span class="ident" id="6962935">Errorf</span><span class="op" id="6962941">(</span><span class="string" id="6962942">&#34;Want&nbsp;error,&nbsp;got&nbsp;none&#34;</span><span class="op" id="6962964">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6962970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6962975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6962979">default</span><span class="op" id="6962986">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6962991">t</span><span class="op" id="6962992">.</span><span class="ident" id="6962993">Fatalf</span><span class="op" id="6962999">(</span><span class="string" id="6963000">&#34;Unhandled&nbsp;command&#34;</span><span class="op" id="6963019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6963023">}</span><br>
<span class="lineno">370</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6963028">if</span>&nbsp;<span class="ident" id="6963031">err</span>&nbsp;<span class="op" id="6963035">!=</span>&nbsp;<span class="builtintype" id="6963038">nil</span>&nbsp;<span class="op" id="6963042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6963047">t</span><span class="op" id="6963048">.</span><span class="ident" id="6963049">Errorf</span><span class="op" id="6963055">(</span><span class="string" id="6963056">&#34;Command&nbsp;%d&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6963079">,</span>&nbsp;<span class="ident" id="6963081">i</span><span class="op" id="6963082">,</span>&nbsp;<span class="ident" id="6963084">err</span><span class="op" id="6963087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6963091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6963096">bcmdbuf</span><span class="op" id="6963103">.</span><span class="ident" id="6963104">Flush</span><span class="op" id="6963109">(</span><span class="op" id="6963110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6963114">actualcmds</span>&nbsp;<span class="op" id="6963125">:=</span>&nbsp;<span class="ident" id="6963128">cmdbuf</span><span class="op" id="6963134">.</span><span class="ident" id="6963135">String</span><span class="op" id="6963141">(</span><span class="op" id="6963142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6963146">if</span>&nbsp;<span class="ident" id="6963149">client</span>&nbsp;<span class="op" id="6963156">!=</span>&nbsp;<span class="ident" id="6963159">actualcmds</span>&nbsp;<span class="op" id="6963170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6963175">t</span><span class="op" id="6963176">.</span><span class="ident" id="6963177">Errorf</span><span class="op" id="6963183">(</span><span class="string" id="6963184">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6963209">,</span>&nbsp;<span class="ident" id="6963211">actualcmds</span><span class="op" id="6963221">,</span>&nbsp;<span class="ident" id="6963223">client</span><span class="op" id="6963229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6963233">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6963236">}</span><br>
<span class="lineno"></span><span class="op" id="6963238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6963241">var</span>&nbsp;<span class="ident" id="6963245">baseHelloServer</span>&nbsp;<span class="op" id="6963261">=</span>&nbsp;<span class="string" id="6963263">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno">385</span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;FEATURE<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6963337">var</span>&nbsp;<span class="ident" id="6963341">helloServer</span>&nbsp;<span class="op" id="6963353">=</span>&nbsp;<span class="op" id="6963355">[</span><span class="op" id="6963356">]</span><span class="builtintype" id="6963357">string</span><span class="op" id="6963363">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6963366">&#34;&#34;</span><span class="op" id="6963368">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6963371">&#34;502&nbsp;Not&nbsp;implemented\n&#34;</span><span class="op" id="6963394">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6963397">&#34;250&nbsp;User&nbsp;is&nbsp;valid\n&#34;</span><span class="op" id="6963418">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6963421">&#34;235&nbsp;Accepted\n&#34;</span><span class="op" id="6963437">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6963440">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="6963457">,</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6963460">&#34;&#34;</span><span class="op" id="6963462">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6963465">&#34;250&nbsp;Reset&nbsp;ok\n&#34;</span><span class="op" id="6963481">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6963484">&#34;221&nbsp;Goodbye\n&#34;</span><span class="op" id="6963499">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6963502">&#34;250&nbsp;Sender&nbsp;ok\n&#34;</span><span class="op" id="6963519">,</span><br>
<span class="lineno"></span><span class="op" id="6963521">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="6963524">var</span>&nbsp;<span class="ident" id="6963528">baseHelloClient</span>&nbsp;<span class="op" id="6963544">=</span>&nbsp;<span class="string" id="6963546">`EHLO&nbsp;customhost<br>
<span class="lineno"></span>HELO&nbsp;customhost<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="6963582">var</span>&nbsp;<span class="ident" id="6963586">helloClient</span>&nbsp;<span class="op" id="6963598">=</span>&nbsp;<span class="op" id="6963600">[</span><span class="op" id="6963601">]</span><span class="builtintype" id="6963602">string</span><span class="op" id="6963608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6963611">&#34;&#34;</span><span class="op" id="6963613">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6963616">&#34;STARTTLS\n&#34;</span><span class="op" id="6963628">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6963631">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="6963656">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6963659">&#34;AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==\n&#34;</span><span class="op" id="6963690">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6963693">&#34;MAIL&nbsp;FROM:&lt;test@example.com&gt;\n&#34;</span><span class="op" id="6963725">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6963728">&#34;&#34;</span><span class="op" id="6963730">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6963733">&#34;RSET\n&#34;</span><span class="op" id="6963741">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6963744">&#34;QUIT\n&#34;</span><span class="op" id="6963752">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6963755">&#34;VRFY&nbsp;test@example.com\n&#34;</span><span class="op" id="6963780">,</span><br>
<span class="lineno">415</span><span class="op" id="6963782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6963785">func</span>&nbsp;<span class="ident" id="6963790">TestSendMail</span><span class="op" id="6963802">(</span><span class="ident" id="6963803">t</span>&nbsp;<span class="op" id="6963805">*</span><span class="ident" id="6963806">testing</span><span class="op" id="6963813">.</span><span class="ident" id="6963814">T</span><span class="op" id="6963815">)</span>&nbsp;<span class="op" id="6963817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6963820">server</span>&nbsp;<span class="op" id="6963827">:=</span>&nbsp;<span class="ident" id="6963830">strings</span><span class="op" id="6963837">.</span><span class="ident" id="6963838">Join</span><span class="op" id="6963842">(</span><span class="ident" id="6963843">strings</span><span class="op" id="6963850">.</span><span class="ident" id="6963851">Split</span><span class="op" id="6963856">(</span><span class="ident" id="6963857">sendMailServer</span><span class="op" id="6963871">,</span>&nbsp;<span class="string" id="6963873">&#34;\n&#34;</span><span class="op" id="6963877">)</span><span class="op" id="6963878">,</span>&nbsp;<span class="string" id="6963880">&#34;\r\n&#34;</span><span class="op" id="6963886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6963889">client</span>&nbsp;<span class="op" id="6963896">:=</span>&nbsp;<span class="ident" id="6963899">strings</span><span class="op" id="6963906">.</span><span class="ident" id="6963907">Join</span><span class="op" id="6963911">(</span><span class="ident" id="6963912">strings</span><span class="op" id="6963919">.</span><span class="ident" id="6963920">Split</span><span class="op" id="6963925">(</span><span class="ident" id="6963926">sendMailClient</span><span class="op" id="6963940">,</span>&nbsp;<span class="string" id="6963942">&#34;\n&#34;</span><span class="op" id="6963946">)</span><span class="op" id="6963947">,</span>&nbsp;<span class="string" id="6963949">&#34;\r\n&#34;</span><span class="op" id="6963955">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6963958">var</span>&nbsp;<span class="ident" id="6963962">cmdbuf</span>&nbsp;<span class="ident" id="6963969">bytes</span><span class="op" id="6963974">.</span><span class="ident" id="6963975">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6963983">bcmdbuf</span>&nbsp;<span class="op" id="6963991">:=</span>&nbsp;<span class="ident" id="6963994">bufio</span><span class="op" id="6963999">.</span><span class="ident" id="6964000">NewWriter</span><span class="op" id="6964009">(</span><span class="op" id="6964010">&amp;</span><span class="ident" id="6964011">cmdbuf</span><span class="op" id="6964017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6964020">l</span><span class="op" id="6964021">,</span>&nbsp;<span class="ident" id="6964023">err</span>&nbsp;<span class="op" id="6964027">:=</span>&nbsp;<span class="ident" id="6964030">net</span><span class="op" id="6964033">.</span><span class="ident" id="6964034">Listen</span><span class="op" id="6964040">(</span><span class="string" id="6964041">&#34;tcp&#34;</span><span class="op" id="6964046">,</span>&nbsp;<span class="string" id="6964048">&#34;127.0.0.1:0&#34;</span><span class="op" id="6964061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6964064">if</span>&nbsp;<span class="ident" id="6964067">err</span>&nbsp;<span class="op" id="6964071">!=</span>&nbsp;<span class="builtintype" id="6964074">nil</span>&nbsp;<span class="op" id="6964078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6964082">t</span><span class="op" id="6964083">.</span><span class="ident" id="6964084">Fatalf</span><span class="op" id="6964090">(</span><span class="string" id="6964091">&#34;Unable&nbsp;to&nbsp;to&nbsp;create&nbsp;listener:&nbsp;%v&#34;</span><span class="op" id="6964125">,</span>&nbsp;<span class="ident" id="6964127">err</span><span class="op" id="6964130">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6964133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6964136">defer</span>&nbsp;<span class="ident" id="6964142">l</span><span class="op" id="6964143">.</span><span class="ident" id="6964144">Close</span><span class="op" id="6964149">(</span><span class="op" id="6964150">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6964154">//&nbsp;prevent&nbsp;data&nbsp;race&nbsp;on&nbsp;bcmdbuf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6964187">var</span>&nbsp;<span class="ident" id="6964191">done</span>&nbsp;<span class="op" id="6964196">=</span>&nbsp;<span class="builtinfunc" id="6964198">make</span><span class="op" id="6964202">(</span><span class="keyword" id="6964203">chan</span>&nbsp;<span class="keyword" id="6964208">struct</span><span class="op" id="6964214">{</span><span class="op" id="6964215">}</span><span class="op" id="6964216">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6964219">go</span>&nbsp;<span class="keyword" id="6964222">func</span><span class="op" id="6964226">(</span><span class="ident" id="6964227">data</span>&nbsp;<span class="op" id="6964232">[</span><span class="op" id="6964233">]</span><span class="builtintype" id="6964234">string</span><span class="op" id="6964240">)</span>&nbsp;<span class="op" id="6964242">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6964247">defer</span>&nbsp;<span class="builtinfunc" id="6964253">close</span><span class="op" id="6964258">(</span><span class="ident" id="6964259">done</span><span class="op" id="6964263">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6964268">conn</span><span class="op" id="6964272">,</span>&nbsp;<span class="ident" id="6964274">err</span>&nbsp;<span class="op" id="6964278">:=</span>&nbsp;<span class="ident" id="6964281">l</span><span class="op" id="6964282">.</span><span class="ident" id="6964283">Accept</span><span class="op" id="6964289">(</span><span class="op" id="6964290">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6964294">if</span>&nbsp;<span class="ident" id="6964297">err</span>&nbsp;<span class="op" id="6964301">!=</span>&nbsp;<span class="builtintype" id="6964304">nil</span>&nbsp;<span class="op" id="6964308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6964313">t</span><span class="op" id="6964314">.</span><span class="ident" id="6964315">Errorf</span><span class="op" id="6964321">(</span><span class="string" id="6964322">&#34;Accept&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6964340">,</span>&nbsp;<span class="ident" id="6964342">err</span><span class="op" id="6964345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6964350">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6964359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6964363">defer</span>&nbsp;<span class="ident" id="6964369">conn</span><span class="op" id="6964373">.</span><span class="ident" id="6964374">Close</span><span class="op" id="6964379">(</span><span class="op" id="6964380">)</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6964385">tc</span>&nbsp;<span class="op" id="6964388">:=</span>&nbsp;<span class="ident" id="6964391">textproto</span><span class="op" id="6964400">.</span><span class="ident" id="6964401">NewConn</span><span class="op" id="6964408">(</span><span class="ident" id="6964409">conn</span><span class="op" id="6964413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6964417">for</span>&nbsp;<span class="ident" id="6964421">i</span>&nbsp;<span class="op" id="6964423">:=</span>&nbsp;<span class="num" id="6964426">0</span><span class="op" id="6964427">;</span>&nbsp;<span class="ident" id="6964429">i</span>&nbsp;<span class="op" id="6964431">&lt;</span>&nbsp;<span class="builtinfunc" id="6964433">len</span><span class="op" id="6964436">(</span><span class="ident" id="6964437">data</span><span class="op" id="6964441">)</span>&nbsp;<span class="op" id="6964443">&amp;&amp;</span>&nbsp;<span class="ident" id="6964446">data</span><span class="op" id="6964450">[</span><span class="ident" id="6964451">i</span><span class="op" id="6964452">]</span>&nbsp;<span class="op" id="6964454">!=</span>&nbsp;<span class="string" id="6964457">&#34;&#34;</span><span class="op" id="6964459">;</span>&nbsp;<span class="ident" id="6964461">i</span><span class="op" id="6964462">++</span>&nbsp;<span class="op" id="6964465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6964470">tc</span><span class="op" id="6964472">.</span><span class="ident" id="6964473">PrintfLine</span><span class="op" id="6964483">(</span><span class="ident" id="6964484">data</span><span class="op" id="6964488">[</span><span class="ident" id="6964489">i</span><span class="op" id="6964490">]</span><span class="op" id="6964491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6964496">for</span>&nbsp;<span class="builtinfunc" id="6964500">len</span><span class="op" id="6964503">(</span><span class="ident" id="6964504">data</span><span class="op" id="6964508">[</span><span class="ident" id="6964509">i</span><span class="op" id="6964510">]</span><span class="op" id="6964511">)</span>&nbsp;<span class="op" id="6964513">&gt;=</span>&nbsp;<span class="num" id="6964516">4</span>&nbsp;<span class="op" id="6964518">&amp;&amp;</span>&nbsp;<span class="ident" id="6964521">data</span><span class="op" id="6964525">[</span><span class="ident" id="6964526">i</span><span class="op" id="6964527">]</span><span class="op" id="6964528">[</span><span class="num" id="6964529">3</span><span class="op" id="6964530">]</span>&nbsp;<span class="op" id="6964532">==</span>&nbsp;<span class="string" id="6964535">&#39;-&#39;</span>&nbsp;<span class="op" id="6964539">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6964545">i</span><span class="op" id="6964546">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6964553">tc</span><span class="op" id="6964555">.</span><span class="ident" id="6964556">PrintfLine</span><span class="op" id="6964566">(</span><span class="ident" id="6964567">data</span><span class="op" id="6964571">[</span><span class="ident" id="6964572">i</span><span class="op" id="6964573">]</span><span class="op" id="6964574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6964579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6964584">if</span>&nbsp;<span class="ident" id="6964587">data</span><span class="op" id="6964591">[</span><span class="ident" id="6964592">i</span><span class="op" id="6964593">]</span>&nbsp;<span class="op" id="6964595">==</span>&nbsp;<span class="string" id="6964598">&#34;221&nbsp;Goodbye&#34;</span>&nbsp;<span class="op" id="6964612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6964618">return</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6964628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6964633">read</span>&nbsp;<span class="op" id="6964638">:=</span>&nbsp;<span class="builtintype" id="6964641">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6964650">for</span>&nbsp;<span class="op" id="6964654">!</span><span class="ident" id="6964655">read</span>&nbsp;<span class="op" id="6964660">||</span>&nbsp;<span class="ident" id="6964663">data</span><span class="op" id="6964667">[</span><span class="ident" id="6964668">i</span><span class="op" id="6964669">]</span>&nbsp;<span class="op" id="6964671">==</span>&nbsp;<span class="string" id="6964674">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="6964689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6964695">msg</span><span class="op" id="6964698">,</span>&nbsp;<span class="ident" id="6964700">err</span>&nbsp;<span class="op" id="6964704">:=</span>&nbsp;<span class="ident" id="6964707">tc</span><span class="op" id="6964709">.</span><span class="ident" id="6964710">ReadLine</span><span class="op" id="6964718">(</span><span class="op" id="6964719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6964725">bcmdbuf</span><span class="op" id="6964732">.</span><span class="ident" id="6964733">Write</span><span class="op" id="6964738">(</span><span class="op" id="6964739">[</span><span class="op" id="6964740">]</span><span class="builtintype" id="6964741">byte</span><span class="op" id="6964745">(</span><span class="ident" id="6964746">msg</span>&nbsp;<span class="op" id="6964750">+</span>&nbsp;<span class="string" id="6964752">&#34;\r\n&#34;</span><span class="op" id="6964758">)</span><span class="op" id="6964759">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6964765">read</span>&nbsp;<span class="op" id="6964770">=</span>&nbsp;<span class="builtintype" id="6964772">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6964781">if</span>&nbsp;<span class="ident" id="6964784">err</span>&nbsp;<span class="op" id="6964788">!=</span>&nbsp;<span class="builtintype" id="6964791">nil</span>&nbsp;<span class="op" id="6964795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6964802">t</span><span class="op" id="6964803">.</span><span class="ident" id="6964804">Errorf</span><span class="op" id="6964810">(</span><span class="string" id="6964811">&#34;Read&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6964827">,</span>&nbsp;<span class="ident" id="6964829">err</span><span class="op" id="6964832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6964839">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6964850">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6964856">if</span>&nbsp;<span class="ident" id="6964859">data</span><span class="op" id="6964863">[</span><span class="ident" id="6964864">i</span><span class="op" id="6964865">]</span>&nbsp;<span class="op" id="6964867">==</span>&nbsp;<span class="string" id="6964870">&#34;354&nbsp;Go&nbsp;ahead&#34;</span>&nbsp;<span class="op" id="6964885">&amp;&amp;</span>&nbsp;<span class="ident" id="6964888">msg</span>&nbsp;<span class="op" id="6964892">==</span>&nbsp;<span class="string" id="6964895">&#34;.&#34;</span>&nbsp;<span class="op" id="6964899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6964906">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6964916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6964921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6964925">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6964928">}</span><span class="op" id="6964929">(</span><span class="ident" id="6964930">strings</span><span class="op" id="6964937">.</span><span class="ident" id="6964938">Split</span><span class="op" id="6964943">(</span><span class="ident" id="6964944">server</span><span class="op" id="6964950">,</span>&nbsp;<span class="string" id="6964952">&#34;\r\n&#34;</span><span class="op" id="6964958">)</span><span class="op" id="6964959">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6964963">err</span>&nbsp;<span class="op" id="6964967">=</span>&nbsp;<span class="ident" id="6964969">SendMail</span><span class="op" id="6964977">(</span><span class="ident" id="6964978">l</span><span class="op" id="6964979">.</span><span class="ident" id="6964980">Addr</span><span class="op" id="6964984">(</span><span class="op" id="6964985">)</span><span class="op" id="6964986">.</span><span class="ident" id="6964987">String</span><span class="op" id="6964993">(</span><span class="op" id="6964994">)</span><span class="op" id="6964995">,</span>&nbsp;<span class="builtintype" id="6964997">nil</span><span class="op" id="6965000">,</span>&nbsp;<span class="string" id="6965002">&#34;test@example.com&#34;</span><span class="op" id="6965020">,</span>&nbsp;<span class="op" id="6965022">[</span><span class="op" id="6965023">]</span><span class="builtintype" id="6965024">string</span><span class="op" id="6965030">{</span><span class="string" id="6965031">&#34;other@example.com&#34;</span><span class="op" id="6965050">}</span><span class="op" id="6965051">,</span>&nbsp;<span class="op" id="6965053">[</span><span class="op" id="6965054">]</span><span class="builtintype" id="6965055">byte</span><span class="op" id="6965059">(</span><span class="ident" id="6965060">strings</span><span class="op" id="6965067">.</span><span class="ident" id="6965068">Replace</span><span class="op" id="6965075">(</span><span class="string" id="6965076">`From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno">470</span><br>
<span class="lineno"></span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>`</span><span class="op" id="6965175">,</span>&nbsp;<span class="string" id="6965177">&#34;\n&#34;</span><span class="op" id="6965181">,</span>&nbsp;<span class="string" id="6965183">&#34;\r\n&#34;</span><span class="op" id="6965189">,</span>&nbsp;<span class="op" id="6965191">-</span><span class="num" id="6965192">1</span><span class="op" id="6965193">)</span><span class="op" id="6965194">)</span><span class="op" id="6965195">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6965199">if</span>&nbsp;<span class="ident" id="6965202">err</span>&nbsp;<span class="op" id="6965206">!=</span>&nbsp;<span class="builtintype" id="6965209">nil</span>&nbsp;<span class="op" id="6965213">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6965217">t</span><span class="op" id="6965218">.</span><span class="ident" id="6965219">Errorf</span><span class="op" id="6965225">(</span><span class="string" id="6965226">&#34;%v&#34;</span><span class="op" id="6965230">,</span>&nbsp;<span class="ident" id="6965232">err</span><span class="op" id="6965235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6965238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6965242">&lt;-</span><span class="ident" id="6965244">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6965250">bcmdbuf</span><span class="op" id="6965257">.</span><span class="ident" id="6965258">Flush</span><span class="op" id="6965263">(</span><span class="op" id="6965264">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6965267">actualcmds</span>&nbsp;<span class="op" id="6965278">:=</span>&nbsp;<span class="ident" id="6965281">cmdbuf</span><span class="op" id="6965287">.</span><span class="ident" id="6965288">String</span><span class="op" id="6965294">(</span><span class="op" id="6965295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6965298">if</span>&nbsp;<span class="ident" id="6965301">client</span>&nbsp;<span class="op" id="6965308">!=</span>&nbsp;<span class="ident" id="6965311">actualcmds</span>&nbsp;<span class="op" id="6965322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6965326">t</span><span class="op" id="6965327">.</span><span class="ident" id="6965328">Errorf</span><span class="op" id="6965334">(</span><span class="string" id="6965335">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6965360">,</span>&nbsp;<span class="ident" id="6965362">actualcmds</span><span class="op" id="6965372">,</span>&nbsp;<span class="ident" id="6965374">client</span><span class="op" id="6965380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6965383">}</span><br>
<span class="lineno"></span><span class="op" id="6965385">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="6965388">var</span>&nbsp;<span class="ident" id="6965392">sendMailServer</span>&nbsp;<span class="op" id="6965407">=</span>&nbsp;<span class="string" id="6965409">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>502&nbsp;EH?<br>
<span class="lineno"></span>250&nbsp;mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;Sender&nbsp;ok<br>
<span class="lineno">490</span>250&nbsp;Receiver&nbsp;ok<br>
<span class="lineno"></span>354&nbsp;Go&nbsp;ahead<br>
<span class="lineno"></span>250&nbsp;Data&nbsp;ok<br>
<span class="lineno"></span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="keyword" id="6965538">var</span>&nbsp;<span class="ident" id="6965542">sendMailClient</span>&nbsp;<span class="op" id="6965557">=</span>&nbsp;<span class="string" id="6965559">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>HELO&nbsp;localhost<br>
<span class="lineno"></span>MAIL&nbsp;FROM:&lt;test@example.com&gt;<br>
<span class="lineno"></span>RCPT&nbsp;TO:&lt;other@example.com&gt;<br>
<span class="lineno">500</span>DATA<br>
<span class="lineno"></span>From:&nbsp;test@example.com<br>
<span class="lineno"></span>To:&nbsp;other@example.com<br>
<span class="lineno"></span>Subject:&nbsp;SendMail&nbsp;test<br>
<span class="lineno"></span><br>
<span class="lineno">505</span>SendMail&nbsp;is&nbsp;working&nbsp;for&nbsp;me.<br>
<span class="lineno"></span>.<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="6965759">func</span>&nbsp;<span class="ident" id="6965764">TestAuthFailed</span><span class="op" id="6965778">(</span><span class="ident" id="6965779">t</span>&nbsp;<span class="op" id="6965781">*</span><span class="ident" id="6965782">testing</span><span class="op" id="6965789">.</span><span class="ident" id="6965790">T</span><span class="op" id="6965791">)</span>&nbsp;<span class="op" id="6965793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6965796">server</span>&nbsp;<span class="op" id="6965803">:=</span>&nbsp;<span class="ident" id="6965806">strings</span><span class="op" id="6965813">.</span><span class="ident" id="6965814">Join</span><span class="op" id="6965818">(</span><span class="ident" id="6965819">strings</span><span class="op" id="6965826">.</span><span class="ident" id="6965827">Split</span><span class="op" id="6965832">(</span><span class="ident" id="6965833">authFailedServer</span><span class="op" id="6965849">,</span>&nbsp;<span class="string" id="6965851">&#34;\n&#34;</span><span class="op" id="6965855">)</span><span class="op" id="6965856">,</span>&nbsp;<span class="string" id="6965858">&#34;\r\n&#34;</span><span class="op" id="6965864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6965867">client</span>&nbsp;<span class="op" id="6965874">:=</span>&nbsp;<span class="ident" id="6965877">strings</span><span class="op" id="6965884">.</span><span class="ident" id="6965885">Join</span><span class="op" id="6965889">(</span><span class="ident" id="6965890">strings</span><span class="op" id="6965897">.</span><span class="ident" id="6965898">Split</span><span class="op" id="6965903">(</span><span class="ident" id="6965904">authFailedClient</span><span class="op" id="6965920">,</span>&nbsp;<span class="string" id="6965922">&#34;\n&#34;</span><span class="op" id="6965926">)</span><span class="op" id="6965927">,</span>&nbsp;<span class="string" id="6965929">&#34;\r\n&#34;</span><span class="op" id="6965935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6965938">var</span>&nbsp;<span class="ident" id="6965942">cmdbuf</span>&nbsp;<span class="ident" id="6965949">bytes</span><span class="op" id="6965954">.</span><span class="ident" id="6965955">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6965963">bcmdbuf</span>&nbsp;<span class="op" id="6965971">:=</span>&nbsp;<span class="ident" id="6965974">bufio</span><span class="op" id="6965979">.</span><span class="ident" id="6965980">NewWriter</span><span class="op" id="6965989">(</span><span class="op" id="6965990">&amp;</span><span class="ident" id="6965991">cmdbuf</span><span class="op" id="6965997">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6966000">var</span>&nbsp;<span class="ident" id="6966004">fake</span>&nbsp;<span class="ident" id="6966009">faker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6966016">fake</span><span class="op" id="6966020">.</span><span class="ident" id="6966021">ReadWriter</span>&nbsp;<span class="op" id="6966032">=</span>&nbsp;<span class="ident" id="6966034">bufio</span><span class="op" id="6966039">.</span><span class="ident" id="6966040">NewReadWriter</span><span class="op" id="6966053">(</span><span class="ident" id="6966054">bufio</span><span class="op" id="6966059">.</span><span class="ident" id="6966060">NewReader</span><span class="op" id="6966069">(</span><span class="ident" id="6966070">strings</span><span class="op" id="6966077">.</span><span class="ident" id="6966078">NewReader</span><span class="op" id="6966087">(</span><span class="ident" id="6966088">server</span><span class="op" id="6966094">)</span><span class="op" id="6966095">)</span><span class="op" id="6966096">,</span>&nbsp;<span class="ident" id="6966098">bcmdbuf</span><span class="op" id="6966105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6966108">c</span><span class="op" id="6966109">,</span>&nbsp;<span class="ident" id="6966111">err</span>&nbsp;<span class="op" id="6966115">:=</span>&nbsp;<span class="ident" id="6966118">NewClient</span><span class="op" id="6966127">(</span><span class="ident" id="6966128">fake</span><span class="op" id="6966132">,</span>&nbsp;<span class="string" id="6966134">&#34;fake.host&#34;</span><span class="op" id="6966145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6966148">if</span>&nbsp;<span class="ident" id="6966151">err</span>&nbsp;<span class="op" id="6966155">!=</span>&nbsp;<span class="builtintype" id="6966158">nil</span>&nbsp;<span class="op" id="6966162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6966166">t</span><span class="op" id="6966167">.</span><span class="ident" id="6966168">Fatalf</span><span class="op" id="6966174">(</span><span class="string" id="6966175">&#34;NewClient:&nbsp;%v&#34;</span><span class="op" id="6966190">,</span>&nbsp;<span class="ident" id="6966192">err</span><span class="op" id="6966195">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6966198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6966201">defer</span>&nbsp;<span class="ident" id="6966207">c</span><span class="op" id="6966208">.</span><span class="ident" id="6966209">Close</span><span class="op" id="6966214">(</span><span class="op" id="6966215">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6966219">c</span><span class="op" id="6966220">.</span><span class="ident" id="6966221">tls</span>&nbsp;<span class="op" id="6966225">=</span>&nbsp;<span class="builtintype" id="6966227">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6966233">c</span><span class="op" id="6966234">.</span><span class="ident" id="6966235">serverName</span>&nbsp;<span class="op" id="6966246">=</span>&nbsp;<span class="string" id="6966248">&#34;smtp.google.com&#34;</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6966267">err</span>&nbsp;<span class="op" id="6966271">=</span>&nbsp;<span class="ident" id="6966273">c</span><span class="op" id="6966274">.</span><span class="ident" id="6966275">Auth</span><span class="op" id="6966279">(</span><span class="ident" id="6966280">PlainAuth</span><span class="op" id="6966289">(</span><span class="string" id="6966290">&#34;&#34;</span><span class="op" id="6966292">,</span>&nbsp;<span class="string" id="6966294">&#34;user&#34;</span><span class="op" id="6966300">,</span>&nbsp;<span class="string" id="6966302">&#34;pass&#34;</span><span class="op" id="6966308">,</span>&nbsp;<span class="string" id="6966310">&#34;smtp.google.com&#34;</span><span class="op" id="6966327">)</span><span class="op" id="6966328">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6966332">if</span>&nbsp;<span class="ident" id="6966335">err</span>&nbsp;<span class="op" id="6966339">==</span>&nbsp;<span class="builtintype" id="6966342">nil</span>&nbsp;<span class="op" id="6966346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6966350">t</span><span class="op" id="6966351">.</span><span class="ident" id="6966352">Error</span><span class="op" id="6966357">(</span><span class="string" id="6966358">&#34;Auth:&nbsp;expected&nbsp;error;&nbsp;got&nbsp;none&#34;</span><span class="op" id="6966390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6966393">}</span>&nbsp;<span class="keyword" id="6966395">else</span>&nbsp;<span class="keyword" id="6966400">if</span>&nbsp;<span class="ident" id="6966403">err</span><span class="op" id="6966406">.</span><span class="ident" id="6966407">Error</span><span class="op" id="6966412">(</span><span class="op" id="6966413">)</span>&nbsp;<span class="op" id="6966415">!=</span>&nbsp;<span class="string" id="6966418">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span>&nbsp;<span class="op" id="6966472">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6966476">t</span><span class="op" id="6966477">.</span><span class="ident" id="6966478">Errorf</span><span class="op" id="6966484">(</span><span class="string" id="6966485">&#34;Auth:&nbsp;got&nbsp;error:&nbsp;%v,&nbsp;want:&nbsp;%s&#34;</span><span class="op" id="6966516">,</span>&nbsp;<span class="ident" id="6966518">err</span><span class="op" id="6966521">,</span>&nbsp;<span class="string" id="6966523">&#34;535&nbsp;Invalid&nbsp;credentials\nplease&nbsp;see&nbsp;www.example.com&#34;</span><span class="op" id="6966576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6966579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6966583">bcmdbuf</span><span class="op" id="6966590">.</span><span class="ident" id="6966591">Flush</span><span class="op" id="6966596">(</span><span class="op" id="6966597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6966600">actualcmds</span>&nbsp;<span class="op" id="6966611">:=</span>&nbsp;<span class="ident" id="6966614">cmdbuf</span><span class="op" id="6966620">.</span><span class="ident" id="6966621">String</span><span class="op" id="6966627">(</span><span class="op" id="6966628">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6966631">if</span>&nbsp;<span class="ident" id="6966634">client</span>&nbsp;<span class="op" id="6966641">!=</span>&nbsp;<span class="ident" id="6966644">actualcmds</span>&nbsp;<span class="op" id="6966655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6966659">t</span><span class="op" id="6966660">.</span><span class="ident" id="6966661">Errorf</span><span class="op" id="6966667">(</span><span class="string" id="6966668">&#34;Got:\n%s\nExpected:\n%s&#34;</span><span class="op" id="6966693">,</span>&nbsp;<span class="ident" id="6966695">actualcmds</span><span class="op" id="6966705">,</span>&nbsp;<span class="ident" id="6966707">client</span><span class="op" id="6966713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6966716">}</span><br>
<span class="lineno"></span><span class="op" id="6966718">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">540</span><span class="keyword" id="6966721">var</span>&nbsp;<span class="ident" id="6966725">authFailedServer</span>&nbsp;<span class="op" id="6966742">=</span>&nbsp;<span class="string" id="6966744">`220&nbsp;hello&nbsp;world<br>
<span class="lineno"></span>250-mx.google.com&nbsp;at&nbsp;your&nbsp;service<br>
<span class="lineno"></span>250&nbsp;AUTH&nbsp;LOGIN&nbsp;PLAIN<br>
<span class="lineno"></span>535-Invalid&nbsp;credentials<br>
<span class="lineno"></span>535&nbsp;please&nbsp;see&nbsp;www.example.com<br>
<span class="lineno">545</span>221&nbsp;Goodbye<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6966886">var</span>&nbsp;<span class="ident" id="6966890">authFailedClient</span>&nbsp;<span class="op" id="6966907">=</span>&nbsp;<span class="string" id="6966909">`EHLO&nbsp;localhost<br>
<span class="lineno"></span>AUTH&nbsp;PLAIN&nbsp;AHVzZXIAcGFzcw==<br>
<span class="lineno">550</span>*<br>
<span class="lineno"></span>QUIT<br>
<span class="lineno"></span>`</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6966963">func</span>&nbsp;<span class="ident" id="6966968">TestTLSClient</span><span class="op" id="6966981">(</span><span class="ident" id="6966982">t</span>&nbsp;<span class="op" id="6966984">*</span><span class="ident" id="6966985">testing</span><span class="op" id="6966992">.</span><span class="ident" id="6966993">T</span><span class="op" id="6966994">)</span>&nbsp;<span class="op" id="6966996">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6966999">ln</span>&nbsp;<span class="op" id="6967002">:=</span>&nbsp;<span class="ident" id="6967005">newLocalListener</span><span class="op" id="6967021">(</span><span class="ident" id="6967022">t</span><span class="op" id="6967023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6967026">defer</span>&nbsp;<span class="ident" id="6967032">ln</span><span class="op" id="6967034">.</span><span class="ident" id="6967035">Close</span><span class="op" id="6967040">(</span><span class="op" id="6967041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6967044">errc</span>&nbsp;<span class="op" id="6967049">:=</span>&nbsp;<span class="builtinfunc" id="6967052">make</span><span class="op" id="6967056">(</span><span class="keyword" id="6967057">chan</span>&nbsp;<span class="builtintype" id="6967062">error</span><span class="op" id="6967067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6967070">go</span>&nbsp;<span class="keyword" id="6967073">func</span><span class="op" id="6967077">(</span><span class="op" id="6967078">)</span>&nbsp;<span class="op" id="6967080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6967084">errc</span>&nbsp;<span class="op" id="6967089">&lt;-</span>&nbsp;<span class="ident" id="6967092">sendMail</span><span class="op" id="6967100">(</span><span class="ident" id="6967101">ln</span><span class="op" id="6967103">.</span><span class="ident" id="6967104">Addr</span><span class="op" id="6967108">(</span><span class="op" id="6967109">)</span><span class="op" id="6967110">.</span><span class="ident" id="6967111">String</span><span class="op" id="6967117">(</span><span class="op" id="6967118">)</span><span class="op" id="6967119">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6967122">}</span><span class="op" id="6967123">(</span><span class="op" id="6967124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6967127">conn</span><span class="op" id="6967131">,</span>&nbsp;<span class="ident" id="6967133">err</span>&nbsp;<span class="op" id="6967137">:=</span>&nbsp;<span class="ident" id="6967140">ln</span><span class="op" id="6967142">.</span><span class="ident" id="6967143">Accept</span><span class="op" id="6967149">(</span><span class="op" id="6967150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6967153">if</span>&nbsp;<span class="ident" id="6967156">err</span>&nbsp;<span class="op" id="6967160">!=</span>&nbsp;<span class="builtintype" id="6967163">nil</span>&nbsp;<span class="op" id="6967167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6967171">t</span><span class="op" id="6967172">.</span><span class="ident" id="6967173">Fatalf</span><span class="op" id="6967179">(</span><span class="string" id="6967180">&#34;failed&nbsp;to&nbsp;accept&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="6967213">,</span>&nbsp;<span class="ident" id="6967215">err</span><span class="op" id="6967218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6967221">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6967224">defer</span>&nbsp;<span class="ident" id="6967230">conn</span><span class="op" id="6967234">.</span><span class="ident" id="6967235">Close</span><span class="op" id="6967240">(</span><span class="op" id="6967241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6967244">if</span>&nbsp;<span class="ident" id="6967247">err</span>&nbsp;<span class="op" id="6967251">:=</span>&nbsp;<span class="ident" id="6967254">serverHandle</span><span class="op" id="6967266">(</span><span class="ident" id="6967267">conn</span><span class="op" id="6967271">,</span>&nbsp;<span class="ident" id="6967273">t</span><span class="op" id="6967274">)</span><span class="op" id="6967275">;</span>&nbsp;<span class="ident" id="6967277">err</span>&nbsp;<span class="op" id="6967281">!=</span>&nbsp;<span class="builtintype" id="6967284">nil</span>&nbsp;<span class="op" id="6967288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6967292">t</span><span class="op" id="6967293">.</span><span class="ident" id="6967294">Fatalf</span><span class="op" id="6967300">(</span><span class="string" id="6967301">&#34;failed&nbsp;to&nbsp;handle&nbsp;connection:&nbsp;%v&#34;</span><span class="op" id="6967334">,</span>&nbsp;<span class="ident" id="6967336">err</span><span class="op" id="6967339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6967342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6967345">if</span>&nbsp;<span class="ident" id="6967348">err</span>&nbsp;<span class="op" id="6967352">:=</span>&nbsp;<span class="op" id="6967355">&lt;-</span><span class="ident" id="6967357">errc</span><span class="op" id="6967361">;</span>&nbsp;<span class="ident" id="6967363">err</span>&nbsp;<span class="op" id="6967367">!=</span>&nbsp;<span class="builtintype" id="6967370">nil</span>&nbsp;<span class="op" id="6967374">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6967378">t</span><span class="op" id="6967379">.</span><span class="ident" id="6967380">Fatalf</span><span class="op" id="6967386">(</span><span class="string" id="6967387">&#34;client&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6967405">,</span>&nbsp;<span class="ident" id="6967407">err</span><span class="op" id="6967410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6967413">}</span><br>
<span class="lineno"></span><span class="op" id="6967415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6967418">func</span>&nbsp;<span class="ident" id="6967423">newLocalListener</span><span class="op" id="6967439">(</span><span class="ident" id="6967440">t</span>&nbsp;<span class="op" id="6967442">*</span><span class="ident" id="6967443">testing</span><span class="op" id="6967450">.</span><span class="ident" id="6967451">T</span><span class="op" id="6967452">)</span>&nbsp;<span class="ident" id="6967454">net</span><span class="op" id="6967457">.</span><span class="ident" id="6967458">Listener</span>&nbsp;<span class="op" id="6967467">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6967470">ln</span><span class="op" id="6967472">,</span>&nbsp;<span class="ident" id="6967474">err</span>&nbsp;<span class="op" id="6967478">:=</span>&nbsp;<span class="ident" id="6967481">net</span><span class="op" id="6967484">.</span><span class="ident" id="6967485">Listen</span><span class="op" id="6967491">(</span><span class="string" id="6967492">&#34;tcp&#34;</span><span class="op" id="6967497">,</span>&nbsp;<span class="string" id="6967499">&#34;127.0.0.1:0&#34;</span><span class="op" id="6967512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6967515">if</span>&nbsp;<span class="ident" id="6967518">err</span>&nbsp;<span class="op" id="6967522">!=</span>&nbsp;<span class="builtintype" id="6967525">nil</span>&nbsp;<span class="op" id="6967529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6967533">ln</span><span class="op" id="6967535">,</span>&nbsp;<span class="ident" id="6967537">err</span>&nbsp;<span class="op" id="6967541">=</span>&nbsp;<span class="ident" id="6967543">net</span><span class="op" id="6967546">.</span><span class="ident" id="6967547">Listen</span><span class="op" id="6967553">(</span><span class="string" id="6967554">&#34;tcp6&#34;</span><span class="op" id="6967560">,</span>&nbsp;<span class="string" id="6967562">&#34;[::1]:0&#34;</span><span class="op" id="6967571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6967574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6967577">if</span>&nbsp;<span class="ident" id="6967580">err</span>&nbsp;<span class="op" id="6967584">!=</span>&nbsp;<span class="builtintype" id="6967587">nil</span>&nbsp;<span class="op" id="6967591">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6967595">t</span><span class="op" id="6967596">.</span><span class="ident" id="6967597">Fatal</span><span class="op" id="6967602">(</span><span class="ident" id="6967603">err</span><span class="op" id="6967606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6967609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6967612">return</span>&nbsp;<span class="ident" id="6967619">ln</span><br>
<span class="lineno"></span><span class="op" id="6967622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span><span class="keyword" id="6967625">type</span>&nbsp;<span class="ident" id="6967630">smtpSender</span>&nbsp;<span class="keyword" id="6967641">struct</span>&nbsp;<span class="op" id="6967648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6967651">w</span>&nbsp;<span class="ident" id="6967653">io</span><span class="op" id="6967655">.</span><span class="ident" id="6967656">Writer</span><br>
<span class="lineno"></span><span class="op" id="6967663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6967666">func</span>&nbsp;<span class="op" id="6967671">(</span><span class="ident" id="6967672">s</span>&nbsp;<span class="ident" id="6967674">smtpSender</span><span class="op" id="6967684">)</span>&nbsp;<span class="ident" id="6967686">send</span><span class="op" id="6967690">(</span><span class="ident" id="6967691">f</span>&nbsp;<span class="builtintype" id="6967693">string</span><span class="op" id="6967699">)</span>&nbsp;<span class="op" id="6967701">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6967704">s</span><span class="op" id="6967705">.</span><span class="ident" id="6967706">w</span><span class="op" id="6967707">.</span><span class="ident" id="6967708">Write</span><span class="op" id="6967713">(</span><span class="op" id="6967714">[</span><span class="op" id="6967715">]</span><span class="builtintype" id="6967716">byte</span><span class="op" id="6967720">(</span><span class="ident" id="6967721">f</span>&nbsp;<span class="op" id="6967723">+</span>&nbsp;<span class="string" id="6967725">&#34;\r\n&#34;</span><span class="op" id="6967731">)</span><span class="op" id="6967732">)</span><br>
<span class="lineno"></span><span class="op" id="6967734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6967737">//&nbsp;smtp&nbsp;server,&nbsp;finely&nbsp;tailored&nbsp;to&nbsp;deal&nbsp;with&nbsp;our&nbsp;own&nbsp;client&nbsp;only!</span><br>
<span class="lineno"></span><span class="keyword" id="6967803">func</span>&nbsp;<span class="ident" id="6967808">serverHandle</span><span class="op" id="6967820">(</span><span class="ident" id="6967821">c</span>&nbsp;<span class="ident" id="6967823">net</span><span class="op" id="6967826">.</span><span class="ident" id="6967827">Conn</span><span class="op" id="6967831">,</span>&nbsp;<span class="ident" id="6967833">t</span>&nbsp;<span class="op" id="6967835">*</span><span class="ident" id="6967836">testing</span><span class="op" id="6967843">.</span><span class="ident" id="6967844">T</span><span class="op" id="6967845">)</span>&nbsp;<span class="builtintype" id="6967847">error</span>&nbsp;<span class="op" id="6967853">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6967856">send</span>&nbsp;<span class="op" id="6967861">:=</span>&nbsp;<span class="ident" id="6967864">smtpSender</span><span class="op" id="6967874">{</span><span class="ident" id="6967875">c</span><span class="op" id="6967876">}</span><span class="op" id="6967877">.</span><span class="ident" id="6967878">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6967884">send</span><span class="op" id="6967888">(</span><span class="string" id="6967889">&#34;220&nbsp;127.0.0.1&nbsp;ESMTP&nbsp;service&nbsp;ready&#34;</span><span class="op" id="6967924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6967927">s</span>&nbsp;<span class="op" id="6967929">:=</span>&nbsp;<span class="ident" id="6967932">bufio</span><span class="op" id="6967937">.</span><span class="ident" id="6967938">NewScanner</span><span class="op" id="6967948">(</span><span class="ident" id="6967949">c</span><span class="op" id="6967950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6967953">for</span>&nbsp;<span class="ident" id="6967957">s</span><span class="op" id="6967958">.</span><span class="ident" id="6967959">Scan</span><span class="op" id="6967963">(</span><span class="op" id="6967964">)</span>&nbsp;<span class="op" id="6967966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6967970">switch</span>&nbsp;<span class="ident" id="6967977">s</span><span class="op" id="6967978">.</span><span class="ident" id="6967979">Text</span><span class="op" id="6967983">(</span><span class="op" id="6967984">)</span>&nbsp;<span class="op" id="6967986">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6967990">case</span>&nbsp;<span class="string" id="6967995">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="6968011">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6968016">send</span><span class="op" id="6968020">(</span><span class="string" id="6968021">&#34;250-127.0.0.1&nbsp;ESMTP&nbsp;offers&nbsp;a&nbsp;warm&nbsp;hug&nbsp;of&nbsp;welcome&#34;</span><span class="op" id="6968071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6968076">send</span><span class="op" id="6968080">(</span><span class="string" id="6968081">&#34;250-STARTTLS&#34;</span><span class="op" id="6968095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6968100">send</span><span class="op" id="6968104">(</span><span class="string" id="6968105">&#34;250&nbsp;Ok&#34;</span><span class="op" id="6968113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6968117">case</span>&nbsp;<span class="string" id="6968122">&#34;STARTTLS&#34;</span><span class="op" id="6968132">:</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6968137">send</span><span class="op" id="6968141">(</span><span class="string" id="6968142">&#34;220&nbsp;Go&nbsp;ahead&#34;</span><span class="op" id="6968156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6968161">keypair</span><span class="op" id="6968168">,</span>&nbsp;<span class="ident" id="6968170">err</span>&nbsp;<span class="op" id="6968174">:=</span>&nbsp;<span class="ident" id="6968177">tls</span><span class="op" id="6968180">.</span><span class="ident" id="6968181">X509KeyPair</span><span class="op" id="6968192">(</span><span class="ident" id="6968193">localhostCert</span><span class="op" id="6968206">,</span>&nbsp;<span class="ident" id="6968208">localhostKey</span><span class="op" id="6968220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6968225">if</span>&nbsp;<span class="ident" id="6968228">err</span>&nbsp;<span class="op" id="6968232">!=</span>&nbsp;<span class="builtintype" id="6968235">nil</span>&nbsp;<span class="op" id="6968239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6968245">return</span>&nbsp;<span class="ident" id="6968252">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6968259">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6968264">config</span>&nbsp;<span class="op" id="6968271">:=</span>&nbsp;<span class="op" id="6968274">&amp;</span><span class="ident" id="6968275">tls</span><span class="op" id="6968278">.</span><span class="ident" id="6968279">Config</span><span class="op" id="6968285">{</span><span class="ident" id="6968286">Certificates</span><span class="op" id="6968298">:</span>&nbsp;<span class="op" id="6968300">[</span><span class="op" id="6968301">]</span><span class="ident" id="6968302">tls</span><span class="op" id="6968305">.</span><span class="ident" id="6968306">Certificate</span><span class="op" id="6968317">{</span><span class="ident" id="6968318">keypair</span><span class="op" id="6968325">}</span><span class="op" id="6968326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6968331">c</span>&nbsp;<span class="op" id="6968333">=</span>&nbsp;<span class="ident" id="6968335">tls</span><span class="op" id="6968338">.</span><span class="ident" id="6968339">Server</span><span class="op" id="6968345">(</span><span class="ident" id="6968346">c</span><span class="op" id="6968347">,</span>&nbsp;<span class="ident" id="6968349">config</span><span class="op" id="6968355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6968360">defer</span>&nbsp;<span class="ident" id="6968366">c</span><span class="op" id="6968367">.</span><span class="ident" id="6968368">Close</span><span class="op" id="6968373">(</span><span class="op" id="6968374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6968379">return</span>&nbsp;<span class="ident" id="6968386">serverHandleTLS</span><span class="op" id="6968401">(</span><span class="ident" id="6968402">c</span><span class="op" id="6968403">,</span>&nbsp;<span class="ident" id="6968405">t</span><span class="op" id="6968406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6968410">default</span><span class="op" id="6968417">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6968422">t</span><span class="op" id="6968423">.</span><span class="ident" id="6968424">Fatalf</span><span class="op" id="6968430">(</span><span class="string" id="6968431">&#34;unrecognized&nbsp;command:&nbsp;%q&#34;</span><span class="op" id="6968457">,</span>&nbsp;<span class="ident" id="6968459">s</span><span class="op" id="6968460">.</span><span class="ident" id="6968461">Text</span><span class="op" id="6968465">(</span><span class="op" id="6968466">)</span><span class="op" id="6968467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6968471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6968474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6968477">return</span>&nbsp;<span class="ident" id="6968484">s</span><span class="op" id="6968485">.</span><span class="ident" id="6968486">Err</span><span class="op" id="6968489">(</span><span class="op" id="6968490">)</span><br>
<span class="lineno"></span><span class="op" id="6968492">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="keyword" id="6968495">func</span>&nbsp;<span class="ident" id="6968500">serverHandleTLS</span><span class="op" id="6968515">(</span><span class="ident" id="6968516">c</span>&nbsp;<span class="ident" id="6968518">net</span><span class="op" id="6968521">.</span><span class="ident" id="6968522">Conn</span><span class="op" id="6968526">,</span>&nbsp;<span class="ident" id="6968528">t</span>&nbsp;<span class="op" id="6968530">*</span><span class="ident" id="6968531">testing</span><span class="op" id="6968538">.</span><span class="ident" id="6968539">T</span><span class="op" id="6968540">)</span>&nbsp;<span class="builtintype" id="6968542">error</span>&nbsp;<span class="op" id="6968548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6968551">send</span>&nbsp;<span class="op" id="6968556">:=</span>&nbsp;<span class="ident" id="6968559">smtpSender</span><span class="op" id="6968569">{</span><span class="ident" id="6968570">c</span><span class="op" id="6968571">}</span><span class="op" id="6968572">.</span><span class="ident" id="6968573">send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6968579">s</span>&nbsp;<span class="op" id="6968581">:=</span>&nbsp;<span class="ident" id="6968584">bufio</span><span class="op" id="6968589">.</span><span class="ident" id="6968590">NewScanner</span><span class="op" id="6968600">(</span><span class="ident" id="6968601">c</span><span class="op" id="6968602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6968605">for</span>&nbsp;<span class="ident" id="6968609">s</span><span class="op" id="6968610">.</span><span class="ident" id="6968611">Scan</span><span class="op" id="6968615">(</span><span class="op" id="6968616">)</span>&nbsp;<span class="op" id="6968618">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6968622">switch</span>&nbsp;<span class="ident" id="6968629">s</span><span class="op" id="6968630">.</span><span class="ident" id="6968631">Text</span><span class="op" id="6968635">(</span><span class="op" id="6968636">)</span>&nbsp;<span class="op" id="6968638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6968642">case</span>&nbsp;<span class="string" id="6968647">&#34;EHLO&nbsp;localhost&#34;</span><span class="op" id="6968663">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6968668">send</span><span class="op" id="6968672">(</span><span class="string" id="6968673">&#34;250&nbsp;Ok&#34;</span><span class="op" id="6968681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6968685">case</span>&nbsp;<span class="string" id="6968690">&#34;MAIL&nbsp;FROM:&lt;joe1@example.com&gt;&#34;</span><span class="op" id="6968720">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6968725">send</span><span class="op" id="6968729">(</span><span class="string" id="6968730">&#34;250&nbsp;Ok&#34;</span><span class="op" id="6968738">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6968742">case</span>&nbsp;<span class="string" id="6968747">&#34;RCPT&nbsp;TO:&lt;joe2@example.com&gt;&#34;</span><span class="op" id="6968775">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6968780">send</span><span class="op" id="6968784">(</span><span class="string" id="6968785">&#34;250&nbsp;Ok&#34;</span><span class="op" id="6968793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6968797">case</span>&nbsp;<span class="string" id="6968802">&#34;DATA&#34;</span><span class="op" id="6968808">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6968813">send</span><span class="op" id="6968817">(</span><span class="string" id="6968818">&#34;354&nbsp;send&nbsp;the&nbsp;mail&nbsp;data,&nbsp;end&nbsp;with&nbsp;.&#34;</span><span class="op" id="6968854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6968859">send</span><span class="op" id="6968863">(</span><span class="string" id="6968864">&#34;250&nbsp;Ok&#34;</span><span class="op" id="6968872">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6968876">case</span>&nbsp;<span class="string" id="6968881">&#34;Subject:&nbsp;test&#34;</span><span class="op" id="6968896">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6968900">case</span>&nbsp;<span class="string" id="6968905">&#34;&#34;</span><span class="op" id="6968907">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6968911">case</span>&nbsp;<span class="string" id="6968916">&#34;howdy!&#34;</span><span class="op" id="6968924">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6968928">case</span>&nbsp;<span class="string" id="6968933">&#34;.&#34;</span><span class="op" id="6968936">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6968940">case</span>&nbsp;<span class="string" id="6968945">&#34;QUIT&#34;</span><span class="op" id="6968951">:</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6968956">send</span><span class="op" id="6968960">(</span><span class="string" id="6968961">&#34;221&nbsp;127.0.0.1&nbsp;Service&nbsp;closing&nbsp;transmission&nbsp;channel&#34;</span><span class="op" id="6969013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6969018">return</span>&nbsp;<span class="builtintype" id="6969025">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6969031">default</span><span class="op" id="6969038">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6969043">t</span><span class="op" id="6969044">.</span><span class="ident" id="6969045">Fatalf</span><span class="op" id="6969051">(</span><span class="string" id="6969052">&#34;unrecognized&nbsp;command&nbsp;during&nbsp;TLS:&nbsp;%q&#34;</span><span class="op" id="6969089">,</span>&nbsp;<span class="ident" id="6969091">s</span><span class="op" id="6969092">.</span><span class="ident" id="6969093">Text</span><span class="op" id="6969097">(</span><span class="op" id="6969098">)</span><span class="op" id="6969099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6969103">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6969106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6969109">return</span>&nbsp;<span class="ident" id="6969116">s</span><span class="op" id="6969117">.</span><span class="ident" id="6969118">Err</span><span class="op" id="6969121">(</span><span class="op" id="6969122">)</span><br>
<span class="lineno"></span><span class="op" id="6969124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6969127">func</span>&nbsp;<span class="ident" id="6969132">init</span><span class="op" id="6969136">(</span><span class="op" id="6969137">)</span>&nbsp;<span class="op" id="6969139">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6969142">testRootCAs</span>&nbsp;<span class="op" id="6969154">:=</span>&nbsp;<span class="ident" id="6969157">x509</span><span class="op" id="6969161">.</span><span class="ident" id="6969162">NewCertPool</span><span class="op" id="6969173">(</span><span class="op" id="6969174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6969177">testRootCAs</span><span class="op" id="6969188">.</span><span class="ident" id="6969189">AppendCertsFromPEM</span><span class="op" id="6969207">(</span><span class="ident" id="6969208">localhostCert</span><span class="op" id="6969221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6969224">testHookStartTLS</span>&nbsp;<span class="op" id="6969241">=</span>&nbsp;<span class="keyword" id="6969243">func</span><span class="op" id="6969247">(</span><span class="ident" id="6969248">config</span>&nbsp;<span class="op" id="6969255">*</span><span class="ident" id="6969256">tls</span><span class="op" id="6969259">.</span><span class="ident" id="6969260">Config</span><span class="op" id="6969266">)</span>&nbsp;<span class="op" id="6969268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6969272">config</span><span class="op" id="6969278">.</span><span class="ident" id="6969279">RootCAs</span>&nbsp;<span class="op" id="6969287">=</span>&nbsp;<span class="ident" id="6969289">testRootCAs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6969302">}</span><br>
<span class="lineno">655</span><span class="op" id="6969304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6969307">func</span>&nbsp;<span class="ident" id="6969312">sendMail</span><span class="op" id="6969320">(</span><span class="ident" id="6969321">hostPort</span>&nbsp;<span class="builtintype" id="6969330">string</span><span class="op" id="6969336">)</span>&nbsp;<span class="builtintype" id="6969338">error</span>&nbsp;<span class="op" id="6969344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6969347">host</span><span class="op" id="6969351">,</span>&nbsp;<span class="ident" id="6969353">_</span><span class="op" id="6969354">,</span>&nbsp;<span class="ident" id="6969356">err</span>&nbsp;<span class="op" id="6969360">:=</span>&nbsp;<span class="ident" id="6969363">net</span><span class="op" id="6969366">.</span><span class="ident" id="6969367">SplitHostPort</span><span class="op" id="6969380">(</span><span class="ident" id="6969381">hostPort</span><span class="op" id="6969389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6969392">if</span>&nbsp;<span class="ident" id="6969395">err</span>&nbsp;<span class="op" id="6969399">!=</span>&nbsp;<span class="builtintype" id="6969402">nil</span>&nbsp;<span class="op" id="6969406">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6969410">return</span>&nbsp;<span class="ident" id="6969417">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6969422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6969425">auth</span>&nbsp;<span class="op" id="6969430">:=</span>&nbsp;<span class="ident" id="6969433">PlainAuth</span><span class="op" id="6969442">(</span><span class="string" id="6969443">&#34;&#34;</span><span class="op" id="6969445">,</span>&nbsp;<span class="string" id="6969447">&#34;&#34;</span><span class="op" id="6969449">,</span>&nbsp;<span class="string" id="6969451">&#34;&#34;</span><span class="op" id="6969453">,</span>&nbsp;<span class="ident" id="6969455">host</span><span class="op" id="6969459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6969462">from</span>&nbsp;<span class="op" id="6969467">:=</span>&nbsp;<span class="string" id="6969470">&#34;joe1@example.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6969490">to</span>&nbsp;<span class="op" id="6969493">:=</span>&nbsp;<span class="op" id="6969496">[</span><span class="op" id="6969497">]</span><span class="builtintype" id="6969498">string</span><span class="op" id="6969504">{</span><span class="string" id="6969505">&#34;joe2@example.com&#34;</span><span class="op" id="6969523">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6969526">return</span>&nbsp;<span class="ident" id="6969533">SendMail</span><span class="op" id="6969541">(</span><span class="ident" id="6969542">hostPort</span><span class="op" id="6969550">,</span>&nbsp;<span class="ident" id="6969552">auth</span><span class="op" id="6969556">,</span>&nbsp;<span class="ident" id="6969558">from</span><span class="op" id="6969562">,</span>&nbsp;<span class="ident" id="6969564">to</span><span class="op" id="6969566">,</span>&nbsp;<span class="op" id="6969568">[</span><span class="op" id="6969569">]</span><span class="builtintype" id="6969570">byte</span><span class="op" id="6969574">(</span><span class="string" id="6969575">&#34;Subject:&nbsp;test\n\nhowdy!&#34;</span><span class="op" id="6969600">)</span><span class="op" id="6969601">)</span><br>
<span class="lineno"></span><span class="op" id="6969603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6969606">//&nbsp;(copied&nbsp;from&nbsp;net/http/httptest)</span><br>
<span class="lineno"></span><span class="comment" id="6969641">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno">670</span><span class="comment" id="6969697">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno"></span><span class="comment" id="6969770">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="6969789">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="6969823">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="6969959">var</span>&nbsp;<span class="ident" id="6969963">localhostCert</span>&nbsp;<span class="op" id="6969977">=</span>&nbsp;<span class="op" id="6969979">[</span><span class="op" id="6969980">]</span><span class="builtintype" id="6969981">byte</span><span class="op" id="6969985">(</span><span class="string" id="6969986">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno">675</span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno"></span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno">680</span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno"></span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="6970557">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span><span class="comment" id="6970560">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno"></span><span class="keyword" id="6970614">var</span>&nbsp;<span class="ident" id="6970618">localhostKey</span>&nbsp;<span class="op" id="6970631">=</span>&nbsp;<span class="op" id="6970633">[</span><span class="op" id="6970634">]</span><span class="builtintype" id="6970635">byte</span><span class="op" id="6970639">(</span><span class="string" id="6970640">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno">690</span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno"></span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="6971138">)</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
