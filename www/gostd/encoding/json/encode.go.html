<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/json</h2>
<ul>
<li><a href="/gostd/encoding/json/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/encoding/json/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/json/decode_test.go.html">decode_test.go</a></li>
<li><a href="/gostd/encoding/json/encode.go.html" class="current">encode.go</a></li>
<li><a href="/gostd/encoding/json/encode_test.go.html">encode_test.go</a></li>
<li><a href="/gostd/encoding/json/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/json/fold.go.html">fold.go</a></li>
<li><a href="/gostd/encoding/json/fold_test.go.html">fold_test.go</a></li>
<li><a href="/gostd/encoding/json/indent.go.html">indent.go</a></li>
<li><a href="/gostd/encoding/json/scanner.go.html">scanner.go</a></li>
<li><a href="/gostd/encoding/json/scanner_test.go.html">scanner_test.go</a></li>
<li><a href="/gostd/encoding/json/stream.go.html">stream.go</a></li>
<li><a href="/gostd/encoding/json/stream_test.go.html">stream_test.go</a></li>
<li><a href="/gostd/encoding/json/tagkey_test.go.html">tagkey_test.go</a></li>
<li><a href="/gostd/encoding/json/tags.go.html">tags.go</a></li>
<li><a href="/gostd/encoding/json/tags_test.go.html">tags_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5254641">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5254697">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5254751">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5254802">//&nbsp;Package&nbsp;json&nbsp;implements&nbsp;encoding&nbsp;and&nbsp;decoding&nbsp;of&nbsp;JSON&nbsp;objects&nbsp;as&nbsp;defined&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="5254881">//&nbsp;RFC&nbsp;4627.&nbsp;The&nbsp;mapping&nbsp;between&nbsp;JSON&nbsp;objects&nbsp;and&nbsp;Go&nbsp;values&nbsp;is&nbsp;described</span><br>
<span class="lineno"></span><span class="comment" id="5254954">//&nbsp;in&nbsp;the&nbsp;documentation&nbsp;for&nbsp;the&nbsp;Marshal&nbsp;and&nbsp;Unmarshal&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="5255019">//</span><br>
<span class="lineno"></span><span class="comment" id="5255022">//&nbsp;See&nbsp;&#34;JSON&nbsp;and&nbsp;Go&#34;&nbsp;for&nbsp;an&nbsp;introduction&nbsp;to&nbsp;this&nbsp;package:</span><br>
<span class="lineno">10</span><span class="comment" id="5255080">//&nbsp;http://golang.org/doc/articles/json_and_go.html</span><br>
<span class="lineno"></span><span class="keyword" id="5255131">package</span>&nbsp;<span class="ident" id="5255139">json</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5255145">import</span>&nbsp;<span class="op" id="5255152">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5255155">&#34;bytes&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5255164">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5255176">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5255195">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5255203">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5255214">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5255225">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5255233">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5255244">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5255255">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5255263">&#34;unicode&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5255274">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="5255289">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5255292">//&nbsp;Marshal&nbsp;returns&nbsp;the&nbsp;JSON&nbsp;encoding&nbsp;of&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="5255335">//</span><br>
<span class="lineno">30</span><span class="comment" id="5255338">//&nbsp;Marshal&nbsp;traverses&nbsp;the&nbsp;value&nbsp;v&nbsp;recursively.</span><br>
<span class="lineno"></span><span class="comment" id="5255384">//&nbsp;If&nbsp;an&nbsp;encountered&nbsp;value&nbsp;implements&nbsp;the&nbsp;Marshaler&nbsp;interface</span><br>
<span class="lineno"></span><span class="comment" id="5255446">//&nbsp;and&nbsp;is&nbsp;not&nbsp;a&nbsp;nil&nbsp;pointer,&nbsp;Marshal&nbsp;calls&nbsp;its&nbsp;MarshalJSON&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="5255512">//&nbsp;to&nbsp;produce&nbsp;JSON.&nbsp;&nbsp;The&nbsp;nil&nbsp;pointer&nbsp;exception&nbsp;is&nbsp;not&nbsp;strictly&nbsp;necessary</span><br>
<span class="lineno"></span><span class="comment" id="5255585">//&nbsp;but&nbsp;mimics&nbsp;a&nbsp;similar,&nbsp;necessary&nbsp;exception&nbsp;in&nbsp;the&nbsp;behavior&nbsp;of</span><br>
<span class="lineno">35</span><span class="comment" id="5255649">//&nbsp;UnmarshalJSON.</span><br>
<span class="lineno"></span><span class="comment" id="5255667">//</span><br>
<span class="lineno"></span><span class="comment" id="5255670">//&nbsp;Otherwise,&nbsp;Marshal&nbsp;uses&nbsp;the&nbsp;following&nbsp;type-dependent&nbsp;default&nbsp;encodings:</span><br>
<span class="lineno"></span><span class="comment" id="5255745">//</span><br>
<span class="lineno"></span><span class="comment" id="5255748">//&nbsp;Boolean&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;booleans.</span><br>
<span class="lineno">40</span><span class="comment" id="5255791">//</span><br>
<span class="lineno"></span><span class="comment" id="5255794">//&nbsp;Floating&nbsp;point,&nbsp;integer,&nbsp;and&nbsp;Number&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;numbers.</span><br>
<span class="lineno"></span><span class="comment" id="5255864">//</span><br>
<span class="lineno"></span><span class="comment" id="5255867">//&nbsp;String&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;strings&nbsp;coerced&nbsp;to&nbsp;valid&nbsp;UTF-8,</span><br>
<span class="lineno"></span><span class="comment" id="5255931">//&nbsp;replacing&nbsp;invalid&nbsp;bytes&nbsp;with&nbsp;the&nbsp;Unicode&nbsp;replacement&nbsp;rune.</span><br>
<span class="lineno">45</span><span class="comment" id="5255993">//&nbsp;The&nbsp;angle&nbsp;brackets&nbsp;&#34;&lt;&#34;&nbsp;and&nbsp;&#34;&gt;&#34;&nbsp;are&nbsp;escaped&nbsp;to&nbsp;&#34;\u003c&#34;&nbsp;and&nbsp;&#34;\u003e&#34;</span><br>
<span class="lineno"></span><span class="comment" id="5256064">//&nbsp;to&nbsp;keep&nbsp;some&nbsp;browsers&nbsp;from&nbsp;misinterpreting&nbsp;JSON&nbsp;output&nbsp;as&nbsp;HTML.</span><br>
<span class="lineno"></span><span class="comment" id="5256131">//&nbsp;Ampersand&nbsp;&#34;&amp;&#34;&nbsp;is&nbsp;also&nbsp;escaped&nbsp;to&nbsp;&#34;\u0026&#34;&nbsp;for&nbsp;the&nbsp;same&nbsp;reason.</span><br>
<span class="lineno"></span><span class="comment" id="5256197">//</span><br>
<span class="lineno"></span><span class="comment" id="5256200">//&nbsp;Array&nbsp;and&nbsp;slice&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;arrays,&nbsp;except&nbsp;that</span><br>
<span class="lineno">50</span><span class="comment" id="5256261">//&nbsp;[]byte&nbsp;encodes&nbsp;as&nbsp;a&nbsp;base64-encoded&nbsp;string,&nbsp;and&nbsp;a&nbsp;nil&nbsp;slice</span><br>
<span class="lineno"></span><span class="comment" id="5256323">//&nbsp;encodes&nbsp;as&nbsp;the&nbsp;null&nbsp;JSON&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="5256359">//</span><br>
<span class="lineno"></span><span class="comment" id="5256362">//&nbsp;Struct&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;objects.&nbsp;Each&nbsp;exported&nbsp;struct&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="5256430">//&nbsp;becomes&nbsp;a&nbsp;member&nbsp;of&nbsp;the&nbsp;object&nbsp;unless</span><br>
<span class="lineno">55</span><span class="comment" id="5256471">//&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;field&#39;s&nbsp;tag&nbsp;is&nbsp;&#34;-&#34;,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="5256505">//&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;field&nbsp;is&nbsp;empty&nbsp;and&nbsp;its&nbsp;tag&nbsp;specifies&nbsp;the&nbsp;&#34;omitempty&#34;&nbsp;option.</span><br>
<span class="lineno"></span><span class="comment" id="5256577">//&nbsp;The&nbsp;empty&nbsp;values&nbsp;are&nbsp;false,&nbsp;0,&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="5256615">//&nbsp;nil&nbsp;pointer&nbsp;or&nbsp;interface&nbsp;value,&nbsp;and&nbsp;any&nbsp;array,&nbsp;slice,&nbsp;map,&nbsp;or&nbsp;string&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5256690">//&nbsp;length&nbsp;zero.&nbsp;The&nbsp;object&#39;s&nbsp;default&nbsp;key&nbsp;string&nbsp;is&nbsp;the&nbsp;struct&nbsp;field&nbsp;name</span><br>
<span class="lineno">60</span><span class="comment" id="5256763">//&nbsp;but&nbsp;can&nbsp;be&nbsp;specified&nbsp;in&nbsp;the&nbsp;struct&nbsp;field&#39;s&nbsp;tag&nbsp;value.&nbsp;The&nbsp;&#34;json&#34;&nbsp;key&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="5256838">//&nbsp;the&nbsp;struct&nbsp;field&#39;s&nbsp;tag&nbsp;value&nbsp;is&nbsp;the&nbsp;key&nbsp;name,&nbsp;followed&nbsp;by&nbsp;an&nbsp;optional&nbsp;comma</span><br>
<span class="lineno"></span><span class="comment" id="5256917">//&nbsp;and&nbsp;options.&nbsp;Examples:</span><br>
<span class="lineno"></span><span class="comment" id="5256943">//</span><br>
<span class="lineno"></span><span class="comment" id="5256946">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;is&nbsp;ignored&nbsp;by&nbsp;this&nbsp;package.</span><br>
<span class="lineno">65</span><span class="comment" id="5256988">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;-&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="5257014">//</span><br>
<span class="lineno"></span><span class="comment" id="5257017">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;appears&nbsp;in&nbsp;JSON&nbsp;as&nbsp;key&nbsp;&#34;myName&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="5257064">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;myName&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="5257095">//</span><br>
<span class="lineno">70</span><span class="comment" id="5257098">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;appears&nbsp;in&nbsp;JSON&nbsp;as&nbsp;key&nbsp;&#34;myName&#34;&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5257148">//&nbsp;&nbsp;&nbsp;//&nbsp;the&nbsp;field&nbsp;is&nbsp;omitted&nbsp;from&nbsp;the&nbsp;object&nbsp;if&nbsp;its&nbsp;value&nbsp;is&nbsp;empty,</span><br>
<span class="lineno"></span><span class="comment" id="5257216">//&nbsp;&nbsp;&nbsp;//&nbsp;as&nbsp;defined&nbsp;above.</span><br>
<span class="lineno"></span><span class="comment" id="5257242">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;myName,omitempty&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="5257283">//</span><br>
<span class="lineno">75</span><span class="comment" id="5257286">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;appears&nbsp;in&nbsp;JSON&nbsp;as&nbsp;key&nbsp;&#34;Field&#34;&nbsp;(the&nbsp;default),&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="5257350">//&nbsp;&nbsp;&nbsp;//&nbsp;the&nbsp;field&nbsp;is&nbsp;skipped&nbsp;if&nbsp;empty.</span><br>
<span class="lineno"></span><span class="comment" id="5257389">//&nbsp;&nbsp;&nbsp;//&nbsp;Note&nbsp;the&nbsp;leading&nbsp;comma.</span><br>
<span class="lineno"></span><span class="comment" id="5257421">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;,omitempty&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="5257456">//</span><br>
<span class="lineno">80</span><span class="comment" id="5257459">//&nbsp;The&nbsp;&#34;string&#34;&nbsp;option&nbsp;signals&nbsp;that&nbsp;a&nbsp;field&nbsp;is&nbsp;stored&nbsp;as&nbsp;JSON&nbsp;inside&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5257530">//&nbsp;JSON-encoded&nbsp;string.&nbsp;It&nbsp;applies&nbsp;only&nbsp;to&nbsp;fields&nbsp;of&nbsp;string,&nbsp;floating&nbsp;point,</span><br>
<span class="lineno"></span><span class="comment" id="5257607">//&nbsp;or&nbsp;integer&nbsp;types.&nbsp;This&nbsp;extra&nbsp;level&nbsp;of&nbsp;encoding&nbsp;is&nbsp;sometimes&nbsp;used&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="5257680">//&nbsp;communicating&nbsp;with&nbsp;JavaScript&nbsp;programs:</span><br>
<span class="lineno"></span><span class="comment" id="5257723">//</span><br>
<span class="lineno">85</span><span class="comment" id="5257726">//&nbsp;&nbsp;&nbsp;&nbsp;Int64String&nbsp;int64&nbsp;`json:&#34;,string&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="5257767">//</span><br>
<span class="lineno"></span><span class="comment" id="5257770">//&nbsp;The&nbsp;key&nbsp;name&nbsp;will&nbsp;be&nbsp;used&nbsp;if&nbsp;it&#39;s&nbsp;a&nbsp;non-empty&nbsp;string&nbsp;consisting&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5257840">//&nbsp;only&nbsp;Unicode&nbsp;letters,&nbsp;digits,&nbsp;dollar&nbsp;signs,&nbsp;percent&nbsp;signs,&nbsp;hyphens,</span><br>
<span class="lineno"></span><span class="comment" id="5257911">//&nbsp;underscores&nbsp;and&nbsp;slashes.</span><br>
<span class="lineno">90</span><span class="comment" id="5257939">//</span><br>
<span class="lineno"></span><span class="comment" id="5257942">//&nbsp;Anonymous&nbsp;struct&nbsp;fields&nbsp;are&nbsp;usually&nbsp;marshaled&nbsp;as&nbsp;if&nbsp;their&nbsp;inner&nbsp;exported&nbsp;fields</span><br>
<span class="lineno"></span><span class="comment" id="5258025">//&nbsp;were&nbsp;fields&nbsp;in&nbsp;the&nbsp;outer&nbsp;struct,&nbsp;subject&nbsp;to&nbsp;the&nbsp;usual&nbsp;Go&nbsp;visibility&nbsp;rules&nbsp;amended</span><br>
<span class="lineno"></span><span class="comment" id="5258110">//&nbsp;as&nbsp;described&nbsp;in&nbsp;the&nbsp;next&nbsp;paragraph.</span><br>
<span class="lineno"></span><span class="comment" id="5258149">//&nbsp;An&nbsp;anonymous&nbsp;struct&nbsp;field&nbsp;with&nbsp;a&nbsp;name&nbsp;given&nbsp;in&nbsp;its&nbsp;JSON&nbsp;tag&nbsp;is&nbsp;treated&nbsp;as</span><br>
<span class="lineno">95</span><span class="comment" id="5258226">//&nbsp;having&nbsp;that&nbsp;name,&nbsp;rather&nbsp;than&nbsp;being&nbsp;anonymous.</span><br>
<span class="lineno"></span><span class="comment" id="5258276">//&nbsp;An&nbsp;anonymous&nbsp;struct&nbsp;field&nbsp;of&nbsp;interface&nbsp;type&nbsp;is&nbsp;treated&nbsp;the&nbsp;same&nbsp;as&nbsp;having</span><br>
<span class="lineno"></span><span class="comment" id="5258353">//&nbsp;that&nbsp;type&nbsp;as&nbsp;its&nbsp;name,&nbsp;rather&nbsp;than&nbsp;being&nbsp;anonymous.</span><br>
<span class="lineno"></span><span class="comment" id="5258408">//</span><br>
<span class="lineno"></span><span class="comment" id="5258411">//&nbsp;The&nbsp;Go&nbsp;visibility&nbsp;rules&nbsp;for&nbsp;struct&nbsp;fields&nbsp;are&nbsp;amended&nbsp;for&nbsp;JSON&nbsp;when</span><br>
<span class="lineno">100</span><span class="comment" id="5258482">//&nbsp;deciding&nbsp;which&nbsp;field&nbsp;to&nbsp;marshal&nbsp;or&nbsp;unmarshal.&nbsp;If&nbsp;there&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="5258544">//&nbsp;multiple&nbsp;fields&nbsp;at&nbsp;the&nbsp;same&nbsp;level,&nbsp;and&nbsp;that&nbsp;level&nbsp;is&nbsp;the&nbsp;least</span><br>
<span class="lineno"></span><span class="comment" id="5258610">//&nbsp;nested&nbsp;(and&nbsp;would&nbsp;therefore&nbsp;be&nbsp;the&nbsp;nesting&nbsp;level&nbsp;selected&nbsp;by&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5258678">//&nbsp;usual&nbsp;Go&nbsp;rules),&nbsp;the&nbsp;following&nbsp;extra&nbsp;rules&nbsp;apply:</span><br>
<span class="lineno"></span><span class="comment" id="5258731">//</span><br>
<span class="lineno">105</span><span class="comment" id="5258734">//&nbsp;1)&nbsp;Of&nbsp;those&nbsp;fields,&nbsp;if&nbsp;any&nbsp;are&nbsp;JSON-tagged,&nbsp;only&nbsp;tagged&nbsp;fields&nbsp;are&nbsp;considered,</span><br>
<span class="lineno"></span><span class="comment" id="5258816">//&nbsp;even&nbsp;if&nbsp;there&nbsp;are&nbsp;multiple&nbsp;untagged&nbsp;fields&nbsp;that&nbsp;would&nbsp;otherwise&nbsp;conflict.</span><br>
<span class="lineno"></span><span class="comment" id="5258893">//&nbsp;2)&nbsp;If&nbsp;there&nbsp;is&nbsp;exactly&nbsp;one&nbsp;field&nbsp;(tagged&nbsp;or&nbsp;not&nbsp;according&nbsp;to&nbsp;the&nbsp;first&nbsp;rule),&nbsp;that&nbsp;is&nbsp;selected.</span><br>
<span class="lineno"></span><span class="comment" id="5258992">//&nbsp;3)&nbsp;Otherwise&nbsp;there&nbsp;are&nbsp;multiple&nbsp;fields,&nbsp;and&nbsp;all&nbsp;are&nbsp;ignored;&nbsp;no&nbsp;error&nbsp;occurs.</span><br>
<span class="lineno"></span><span class="comment" id="5259073">//</span><br>
<span class="lineno">110</span><span class="comment" id="5259076">//&nbsp;Handling&nbsp;of&nbsp;anonymous&nbsp;struct&nbsp;fields&nbsp;is&nbsp;new&nbsp;in&nbsp;Go&nbsp;1.1.</span><br>
<span class="lineno"></span><span class="comment" id="5259133">//&nbsp;Prior&nbsp;to&nbsp;Go&nbsp;1.1,&nbsp;anonymous&nbsp;struct&nbsp;fields&nbsp;were&nbsp;ignored.&nbsp;To&nbsp;force&nbsp;ignoring&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5259212">//&nbsp;an&nbsp;anonymous&nbsp;struct&nbsp;field&nbsp;in&nbsp;both&nbsp;current&nbsp;and&nbsp;earlier&nbsp;versions,&nbsp;give&nbsp;the&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="5259294">//&nbsp;a&nbsp;JSON&nbsp;tag&nbsp;of&nbsp;&#34;-&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="5259316">//</span><br>
<span class="lineno">115</span><span class="comment" id="5259319">//&nbsp;Map&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;objects.</span><br>
<span class="lineno"></span><span class="comment" id="5259357">//&nbsp;The&nbsp;map&#39;s&nbsp;key&nbsp;type&nbsp;must&nbsp;be&nbsp;string;&nbsp;the&nbsp;object&nbsp;keys&nbsp;are&nbsp;used&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="5259429">//&nbsp;as&nbsp;map&nbsp;keys.</span><br>
<span class="lineno"></span><span class="comment" id="5259445">//</span><br>
<span class="lineno"></span><span class="comment" id="5259448">//&nbsp;Pointer&nbsp;values&nbsp;encode&nbsp;as&nbsp;the&nbsp;value&nbsp;pointed&nbsp;to.</span><br>
<span class="lineno">120</span><span class="comment" id="5259498">//&nbsp;A&nbsp;nil&nbsp;pointer&nbsp;encodes&nbsp;as&nbsp;the&nbsp;null&nbsp;JSON&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="5259548">//</span><br>
<span class="lineno"></span><span class="comment" id="5259551">//&nbsp;Interface&nbsp;values&nbsp;encode&nbsp;as&nbsp;the&nbsp;value&nbsp;contained&nbsp;in&nbsp;the&nbsp;interface.</span><br>
<span class="lineno"></span><span class="comment" id="5259619">//&nbsp;A&nbsp;nil&nbsp;interface&nbsp;value&nbsp;encodes&nbsp;as&nbsp;the&nbsp;null&nbsp;JSON&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="5259677">//</span><br>
<span class="lineno">125</span><span class="comment" id="5259680">//&nbsp;Channel,&nbsp;complex,&nbsp;and&nbsp;function&nbsp;values&nbsp;cannot&nbsp;be&nbsp;encoded&nbsp;in&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="comment" id="5259748">//&nbsp;Attempting&nbsp;to&nbsp;encode&nbsp;such&nbsp;a&nbsp;value&nbsp;causes&nbsp;Marshal&nbsp;to&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="5259810">//&nbsp;an&nbsp;UnsupportedTypeError.</span><br>
<span class="lineno"></span><span class="comment" id="5259838">//</span><br>
<span class="lineno"></span><span class="comment" id="5259841">//&nbsp;JSON&nbsp;cannot&nbsp;represent&nbsp;cyclic&nbsp;data&nbsp;structures&nbsp;and&nbsp;Marshal&nbsp;does&nbsp;not</span><br>
<span class="lineno">130</span><span class="comment" id="5259910">//&nbsp;handle&nbsp;them.&nbsp;&nbsp;Passing&nbsp;cyclic&nbsp;structures&nbsp;to&nbsp;Marshal&nbsp;will&nbsp;result&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="5259979">//&nbsp;an&nbsp;infinite&nbsp;recursion.</span><br>
<span class="lineno"></span><span class="comment" id="5260005">//</span><br>
<span class="lineno"></span><span class="keyword" id="5260008">func</span>&nbsp;<span class="ident" id="5260013">Marshal</span><span class="op" id="5260020">(</span><span class="ident" id="5260021">v</span>&nbsp;<span class="keyword" id="5260023">interface</span><span class="op" id="5260032">{</span><span class="op" id="5260033">}</span><span class="op" id="5260034">)</span>&nbsp;<span class="op" id="5260036">(</span><span class="op" id="5260037">[</span><span class="op" id="5260038">]</span><span class="builtintype" id="5260039">byte</span><span class="op" id="5260043">,</span>&nbsp;<span class="builtintype" id="5260045">error</span><span class="op" id="5260050">)</span>&nbsp;<span class="op" id="5260052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5260055">e</span>&nbsp;<span class="op" id="5260057">:=</span>&nbsp;<span class="op" id="5260060">&amp;</span><span class="ident" id="5260061">encodeState</span><span class="op" id="5260072">{</span><span class="op" id="5260073">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5260076">err</span>&nbsp;<span class="op" id="5260080">:=</span>&nbsp;<span class="ident" id="5260083">e</span><span class="op" id="5260084">.</span><span class="ident" id="5260085">marshal</span><span class="op" id="5260092">(</span><span class="ident" id="5260093">v</span><span class="op" id="5260094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260097">if</span>&nbsp;<span class="ident" id="5260100">err</span>&nbsp;<span class="op" id="5260104">!=</span>&nbsp;<span class="ident" id="5260107">nil</span>&nbsp;<span class="op" id="5260111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260115">return</span>&nbsp;<span class="ident" id="5260122">nil</span><span class="op" id="5260125">,</span>&nbsp;<span class="ident" id="5260127">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5260132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260135">return</span>&nbsp;<span class="ident" id="5260142">e</span><span class="op" id="5260143">.</span><span class="ident" id="5260144">Bytes</span><span class="op" id="5260149">(</span><span class="op" id="5260150">)</span><span class="op" id="5260151">,</span>&nbsp;<span class="ident" id="5260153">nil</span><br>
<span class="lineno">140</span><span class="op" id="5260157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5260160">//&nbsp;MarshalIndent&nbsp;is&nbsp;like&nbsp;Marshal&nbsp;but&nbsp;applies&nbsp;Indent&nbsp;to&nbsp;format&nbsp;the&nbsp;output.</span><br>
<span class="lineno"></span><span class="keyword" id="5260234">func</span>&nbsp;<span class="ident" id="5260239">MarshalIndent</span><span class="op" id="5260252">(</span><span class="ident" id="5260253">v</span>&nbsp;<span class="keyword" id="5260255">interface</span><span class="op" id="5260264">{</span><span class="op" id="5260265">}</span><span class="op" id="5260266">,</span>&nbsp;<span class="ident" id="5260268">prefix</span><span class="op" id="5260274">,</span>&nbsp;<span class="ident" id="5260276">indent</span>&nbsp;<span class="builtintype" id="5260283">string</span><span class="op" id="5260289">)</span>&nbsp;<span class="op" id="5260291">(</span><span class="op" id="5260292">[</span><span class="op" id="5260293">]</span><span class="builtintype" id="5260294">byte</span><span class="op" id="5260298">,</span>&nbsp;<span class="builtintype" id="5260300">error</span><span class="op" id="5260305">)</span>&nbsp;<span class="op" id="5260307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5260310">b</span><span class="op" id="5260311">,</span>&nbsp;<span class="ident" id="5260313">err</span>&nbsp;<span class="op" id="5260317">:=</span>&nbsp;<span class="ident" id="5260320">Marshal</span><span class="op" id="5260327">(</span><span class="ident" id="5260328">v</span><span class="op" id="5260329">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260332">if</span>&nbsp;<span class="ident" id="5260335">err</span>&nbsp;<span class="op" id="5260339">!=</span>&nbsp;<span class="ident" id="5260342">nil</span>&nbsp;<span class="op" id="5260346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260350">return</span>&nbsp;<span class="ident" id="5260357">nil</span><span class="op" id="5260360">,</span>&nbsp;<span class="ident" id="5260362">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5260367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260370">var</span>&nbsp;<span class="ident" id="5260374">buf</span>&nbsp;<span class="ident" id="5260378">bytes</span><span class="op" id="5260383">.</span><span class="ident" id="5260384">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5260392">err</span>&nbsp;<span class="op" id="5260396">=</span>&nbsp;<span class="ident" id="5260398">Indent</span><span class="op" id="5260404">(</span><span class="op" id="5260405">&amp;</span><span class="ident" id="5260406">buf</span><span class="op" id="5260409">,</span>&nbsp;<span class="ident" id="5260411">b</span><span class="op" id="5260412">,</span>&nbsp;<span class="ident" id="5260414">prefix</span><span class="op" id="5260420">,</span>&nbsp;<span class="ident" id="5260422">indent</span><span class="op" id="5260428">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260431">if</span>&nbsp;<span class="ident" id="5260434">err</span>&nbsp;<span class="op" id="5260438">!=</span>&nbsp;<span class="ident" id="5260441">nil</span>&nbsp;<span class="op" id="5260445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260449">return</span>&nbsp;<span class="ident" id="5260456">nil</span><span class="op" id="5260459">,</span>&nbsp;<span class="ident" id="5260461">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5260466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5260469">return</span>&nbsp;<span class="ident" id="5260476">buf</span><span class="op" id="5260479">.</span><span class="ident" id="5260480">Bytes</span><span class="op" id="5260485">(</span><span class="op" id="5260486">)</span><span class="op" id="5260487">,</span>&nbsp;<span class="ident" id="5260489">nil</span><br>
<span class="lineno"></span><span class="op" id="5260493">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5260496">//&nbsp;HTMLEscape&nbsp;appends&nbsp;to&nbsp;dst&nbsp;the&nbsp;JSON-encoded&nbsp;src&nbsp;with&nbsp;&lt;,&nbsp;&gt;,&nbsp;&amp;,&nbsp;U+2028&nbsp;and&nbsp;U+2029</span><br>
<span class="lineno"></span><span class="comment" id="5260578">//&nbsp;characters&nbsp;inside&nbsp;string&nbsp;literals&nbsp;changed&nbsp;to&nbsp;\u003c,&nbsp;\u003e,&nbsp;\u0026,&nbsp;\u2028,&nbsp;\u2029</span><br>
<span class="lineno"></span><span class="comment" id="5260665">//&nbsp;so&nbsp;that&nbsp;the&nbsp;JSON&nbsp;will&nbsp;be&nbsp;safe&nbsp;to&nbsp;embed&nbsp;inside&nbsp;HTML&nbsp;&lt;script&gt;&nbsp;tags.</span><br>
<span class="lineno"></span><span class="comment" id="5260734">//&nbsp;For&nbsp;historical&nbsp;reasons,&nbsp;web&nbsp;browsers&nbsp;don&#39;t&nbsp;honor&nbsp;standard&nbsp;HTML</span><br>
<span class="lineno">160</span><span class="comment" id="5260800">//&nbsp;escaping&nbsp;within&nbsp;&lt;script&gt;&nbsp;tags,&nbsp;so&nbsp;an&nbsp;alternative&nbsp;JSON&nbsp;encoding&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="5260871">//&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="5260883">func</span>&nbsp;<span class="ident" id="5260888">HTMLEscape</span><span class="op" id="5260898">(</span><span class="ident" id="5260899">dst</span>&nbsp;<span class="op" id="5260903">*</span><span class="ident" id="5260904">bytes</span><span class="op" id="5260909">.</span><span class="ident" id="5260910">Buffer</span><span class="op" id="5260916">,</span>&nbsp;<span class="ident" id="5260918">src</span>&nbsp;<span class="op" id="5260922">[</span><span class="op" id="5260923">]</span><span class="builtintype" id="5260924">byte</span><span class="op" id="5260928">)</span>&nbsp;<span class="op" id="5260930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5260933">//&nbsp;The&nbsp;characters&nbsp;can&nbsp;only&nbsp;appear&nbsp;in&nbsp;string&nbsp;literals,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5260988">//&nbsp;so&nbsp;just&nbsp;scan&nbsp;the&nbsp;string&nbsp;one&nbsp;byte&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5261036">start</span>&nbsp;<span class="op" id="5261042">:=</span>&nbsp;<span class="num" id="5261045">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5261048">for</span>&nbsp;<span class="ident" id="5261052">i</span><span class="op" id="5261053">,</span>&nbsp;<span class="ident" id="5261055">c</span>&nbsp;<span class="op" id="5261057">:=</span>&nbsp;<span class="keyword" id="5261060">range</span>&nbsp;<span class="ident" id="5261066">src</span>&nbsp;<span class="op" id="5261070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5261074">if</span>&nbsp;<span class="ident" id="5261077">c</span>&nbsp;<span class="op" id="5261079">==</span>&nbsp;<span class="string" id="5261082">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5261086">||</span>&nbsp;<span class="ident" id="5261089">c</span>&nbsp;<span class="op" id="5261091">==</span>&nbsp;<span class="string" id="5261094">&#39;&gt;&#39;</span>&nbsp;<span class="op" id="5261098">||</span>&nbsp;<span class="ident" id="5261101">c</span>&nbsp;<span class="op" id="5261103">==</span>&nbsp;<span class="string" id="5261106">&#39;&amp;&#39;</span>&nbsp;<span class="op" id="5261110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5261115">if</span>&nbsp;<span class="ident" id="5261118">start</span>&nbsp;<span class="op" id="5261124">&lt;</span>&nbsp;<span class="ident" id="5261126">i</span>&nbsp;<span class="op" id="5261128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5261134">dst</span><span class="op" id="5261137">.</span><span class="ident" id="5261138">Write</span><span class="op" id="5261143">(</span><span class="ident" id="5261144">src</span><span class="op" id="5261147">[</span><span class="ident" id="5261148">start</span><span class="op" id="5261153">:</span><span class="ident" id="5261154">i</span><span class="op" id="5261155">]</span><span class="op" id="5261156">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5261161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5261166">dst</span><span class="op" id="5261169">.</span><span class="ident" id="5261170">WriteString</span><span class="op" id="5261181">(</span><span class="string" id="5261182">`\u00`</span><span class="op" id="5261188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5261193">dst</span><span class="op" id="5261196">.</span><span class="ident" id="5261197">WriteByte</span><span class="op" id="5261206">(</span><span class="ident" id="5261207">hex</span><span class="op" id="5261210">[</span><span class="ident" id="5261211">c</span><span class="op" id="5261212">&gt;&gt;</span><span class="num" id="5261214">4</span><span class="op" id="5261215">]</span><span class="op" id="5261216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5261221">dst</span><span class="op" id="5261224">.</span><span class="ident" id="5261225">WriteByte</span><span class="op" id="5261234">(</span><span class="ident" id="5261235">hex</span><span class="op" id="5261238">[</span><span class="ident" id="5261239">c</span><span class="op" id="5261240">&amp;</span><span class="num" id="5261241">0xF</span><span class="op" id="5261244">]</span><span class="op" id="5261245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5261250">start</span>&nbsp;<span class="op" id="5261256">=</span>&nbsp;<span class="ident" id="5261258">i</span>&nbsp;<span class="op" id="5261260">+</span>&nbsp;<span class="num" id="5261262">1</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5261266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5261270">//&nbsp;Convert&nbsp;U+2028&nbsp;and&nbsp;U+2029&nbsp;(E2&nbsp;80&nbsp;A8&nbsp;and&nbsp;E2&nbsp;80&nbsp;A9).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5261326">if</span>&nbsp;<span class="ident" id="5261329">c</span>&nbsp;<span class="op" id="5261331">==</span>&nbsp;<span class="num" id="5261334">0xE2</span>&nbsp;<span class="op" id="5261339">&amp;&amp;</span>&nbsp;<span class="ident" id="5261342">i</span><span class="op" id="5261343">+</span><span class="num" id="5261344">2</span>&nbsp;<span class="op" id="5261346">&lt;</span>&nbsp;<span class="builtinfunc" id="5261348">len</span><span class="op" id="5261351">(</span><span class="ident" id="5261352">src</span><span class="op" id="5261355">)</span>&nbsp;<span class="op" id="5261357">&amp;&amp;</span>&nbsp;<span class="ident" id="5261360">src</span><span class="op" id="5261363">[</span><span class="ident" id="5261364">i</span><span class="op" id="5261365">+</span><span class="num" id="5261366">1</span><span class="op" id="5261367">]</span>&nbsp;<span class="op" id="5261369">==</span>&nbsp;<span class="num" id="5261372">0x80</span>&nbsp;<span class="op" id="5261377">&amp;&amp;</span>&nbsp;<span class="ident" id="5261380">src</span><span class="op" id="5261383">[</span><span class="ident" id="5261384">i</span><span class="op" id="5261385">+</span><span class="num" id="5261386">2</span><span class="op" id="5261387">]</span><span class="op" id="5261388">&amp;^</span><span class="num" id="5261390">1</span>&nbsp;<span class="op" id="5261392">==</span>&nbsp;<span class="num" id="5261395">0xA8</span>&nbsp;<span class="op" id="5261400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5261405">if</span>&nbsp;<span class="ident" id="5261408">start</span>&nbsp;<span class="op" id="5261414">&lt;</span>&nbsp;<span class="ident" id="5261416">i</span>&nbsp;<span class="op" id="5261418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5261424">dst</span><span class="op" id="5261427">.</span><span class="ident" id="5261428">Write</span><span class="op" id="5261433">(</span><span class="ident" id="5261434">src</span><span class="op" id="5261437">[</span><span class="ident" id="5261438">start</span><span class="op" id="5261443">:</span><span class="ident" id="5261444">i</span><span class="op" id="5261445">]</span><span class="op" id="5261446">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5261451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5261456">dst</span><span class="op" id="5261459">.</span><span class="ident" id="5261460">WriteString</span><span class="op" id="5261471">(</span><span class="string" id="5261472">`\u202`</span><span class="op" id="5261479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5261484">dst</span><span class="op" id="5261487">.</span><span class="ident" id="5261488">WriteByte</span><span class="op" id="5261497">(</span><span class="ident" id="5261498">hex</span><span class="op" id="5261501">[</span><span class="ident" id="5261502">src</span><span class="op" id="5261505">[</span><span class="ident" id="5261506">i</span><span class="op" id="5261507">+</span><span class="num" id="5261508">2</span><span class="op" id="5261509">]</span><span class="op" id="5261510">&amp;</span><span class="num" id="5261511">0xF</span><span class="op" id="5261514">]</span><span class="op" id="5261515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5261520">start</span>&nbsp;<span class="op" id="5261526">=</span>&nbsp;<span class="ident" id="5261528">i</span>&nbsp;<span class="op" id="5261530">+</span>&nbsp;<span class="num" id="5261532">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5261536">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5261539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5261542">if</span>&nbsp;<span class="ident" id="5261545">start</span>&nbsp;<span class="op" id="5261551">&lt;</span>&nbsp;<span class="builtinfunc" id="5261553">len</span><span class="op" id="5261556">(</span><span class="ident" id="5261557">src</span><span class="op" id="5261560">)</span>&nbsp;<span class="op" id="5261562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5261566">dst</span><span class="op" id="5261569">.</span><span class="ident" id="5261570">Write</span><span class="op" id="5261575">(</span><span class="ident" id="5261576">src</span><span class="op" id="5261579">[</span><span class="ident" id="5261580">start</span><span class="op" id="5261585">:</span><span class="op" id="5261586">]</span><span class="op" id="5261587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5261590">}</span><br>
<span class="lineno"></span><span class="op" id="5261592">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="5261595">//&nbsp;Marshaler&nbsp;is&nbsp;the&nbsp;interface&nbsp;implemented&nbsp;by&nbsp;objects&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="5261653">//&nbsp;can&nbsp;marshal&nbsp;themselves&nbsp;into&nbsp;valid&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="keyword" id="5261696">type</span>&nbsp;<span class="ident" id="5261701">Marshaler</span>&nbsp;<span class="keyword" id="5261711">interface</span>&nbsp;<span class="op" id="5261721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5261724">MarshalJSON</span><span class="op" id="5261735">(</span><span class="op" id="5261736">)</span>&nbsp;<span class="op" id="5261738">(</span><span class="op" id="5261739">[</span><span class="op" id="5261740">]</span><span class="builtintype" id="5261741">byte</span><span class="op" id="5261745">,</span>&nbsp;<span class="builtintype" id="5261747">error</span><span class="op" id="5261752">)</span><br>
<span class="lineno">195</span><span class="op" id="5261754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5261757">//&nbsp;An&nbsp;UnsupportedTypeError&nbsp;is&nbsp;returned&nbsp;by&nbsp;Marshal&nbsp;when&nbsp;attempting</span><br>
<span class="lineno"></span><span class="comment" id="5261823">//&nbsp;to&nbsp;encode&nbsp;an&nbsp;unsupported&nbsp;value&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5261863">type</span>&nbsp;<span class="ident" id="5261868">UnsupportedTypeError</span>&nbsp;<span class="keyword" id="5261889">struct</span>&nbsp;<span class="op" id="5261896">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5261899">Type</span>&nbsp;<span class="ident" id="5261904">reflect</span><span class="op" id="5261911">.</span><span class="ident" id="5261912">Type</span><br>
<span class="lineno"></span><span class="op" id="5261917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5261920">func</span>&nbsp;<span class="op" id="5261925">(</span><span class="ident" id="5261926">e</span>&nbsp;<span class="op" id="5261928">*</span><span class="ident" id="5261929">UnsupportedTypeError</span><span class="op" id="5261949">)</span>&nbsp;<span class="ident" id="5261951">Error</span><span class="op" id="5261956">(</span><span class="op" id="5261957">)</span>&nbsp;<span class="builtintype" id="5261959">string</span>&nbsp;<span class="op" id="5261966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5261969">return</span>&nbsp;<span class="string" id="5261976">&#34;json:&nbsp;unsupported&nbsp;type:&nbsp;&#34;</span>&nbsp;<span class="op" id="5262003">+</span>&nbsp;<span class="ident" id="5262005">e</span><span class="op" id="5262006">.</span><span class="ident" id="5262007">Type</span><span class="op" id="5262011">.</span><span class="ident" id="5262012">String</span><span class="op" id="5262018">(</span><span class="op" id="5262019">)</span><br>
<span class="lineno">205</span><span class="op" id="5262021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5262024">type</span>&nbsp;<span class="ident" id="5262029">UnsupportedValueError</span>&nbsp;<span class="keyword" id="5262051">struct</span>&nbsp;<span class="op" id="5262058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5262061">Value</span>&nbsp;<span class="ident" id="5262067">reflect</span><span class="op" id="5262074">.</span><span class="ident" id="5262075">Value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5262082">Str</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5262088">string</span><br>
<span class="lineno">210</span><span class="op" id="5262095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5262098">func</span>&nbsp;<span class="op" id="5262103">(</span><span class="ident" id="5262104">e</span>&nbsp;<span class="op" id="5262106">*</span><span class="ident" id="5262107">UnsupportedValueError</span><span class="op" id="5262128">)</span>&nbsp;<span class="ident" id="5262130">Error</span><span class="op" id="5262135">(</span><span class="op" id="5262136">)</span>&nbsp;<span class="builtintype" id="5262138">string</span>&nbsp;<span class="op" id="5262145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5262148">return</span>&nbsp;<span class="string" id="5262155">&#34;json:&nbsp;unsupported&nbsp;value:&nbsp;&#34;</span>&nbsp;<span class="op" id="5262183">+</span>&nbsp;<span class="ident" id="5262185">e</span><span class="op" id="5262186">.</span><span class="ident" id="5262187">Str</span><br>
<span class="lineno"></span><span class="op" id="5262191">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="comment" id="5262194">//&nbsp;Before&nbsp;Go&nbsp;1.2,&nbsp;an&nbsp;InvalidUTF8Error&nbsp;was&nbsp;returned&nbsp;by&nbsp;Marshal&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="5262261">//&nbsp;attempting&nbsp;to&nbsp;encode&nbsp;a&nbsp;string&nbsp;value&nbsp;with&nbsp;invalid&nbsp;UTF-8&nbsp;sequences.</span><br>
<span class="lineno"></span><span class="comment" id="5262330">//&nbsp;As&nbsp;of&nbsp;Go&nbsp;1.2,&nbsp;Marshal&nbsp;instead&nbsp;coerces&nbsp;the&nbsp;string&nbsp;to&nbsp;valid&nbsp;UTF-8&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5262400">//&nbsp;replacing&nbsp;invalid&nbsp;bytes&nbsp;with&nbsp;the&nbsp;Unicode&nbsp;replacement&nbsp;rune&nbsp;U+FFFD.</span><br>
<span class="lineno">220</span><span class="comment" id="5262469">//&nbsp;This&nbsp;error&nbsp;is&nbsp;no&nbsp;longer&nbsp;generated&nbsp;but&nbsp;is&nbsp;kept&nbsp;for&nbsp;backwards&nbsp;compatibility</span><br>
<span class="lineno"></span><span class="comment" id="5262546">//&nbsp;with&nbsp;programs&nbsp;that&nbsp;might&nbsp;mention&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="5262586">type</span>&nbsp;<span class="ident" id="5262591">InvalidUTF8Error</span>&nbsp;<span class="keyword" id="5262608">struct</span>&nbsp;<span class="op" id="5262615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5262618">S</span>&nbsp;<span class="builtintype" id="5262620">string</span>&nbsp;<span class="comment" id="5262627">//&nbsp;the&nbsp;whole&nbsp;string&nbsp;value&nbsp;that&nbsp;caused&nbsp;the&nbsp;error</span><br>
<span class="lineno"></span><span class="op" id="5262675">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="5262678">func</span>&nbsp;<span class="op" id="5262683">(</span><span class="ident" id="5262684">e</span>&nbsp;<span class="op" id="5262686">*</span><span class="ident" id="5262687">InvalidUTF8Error</span><span class="op" id="5262703">)</span>&nbsp;<span class="ident" id="5262705">Error</span><span class="op" id="5262710">(</span><span class="op" id="5262711">)</span>&nbsp;<span class="builtintype" id="5262713">string</span>&nbsp;<span class="op" id="5262720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5262723">return</span>&nbsp;<span class="string" id="5262730">&#34;json:&nbsp;invalid&nbsp;UTF-8&nbsp;in&nbsp;string:&nbsp;&#34;</span>&nbsp;<span class="op" id="5262764">+</span>&nbsp;<span class="ident" id="5262766">strconv</span><span class="op" id="5262773">.</span><span class="ident" id="5262774">Quote</span><span class="op" id="5262779">(</span><span class="ident" id="5262780">e</span><span class="op" id="5262781">.</span><span class="ident" id="5262782">S</span><span class="op" id="5262783">)</span><br>
<span class="lineno"></span><span class="op" id="5262785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="5262788">type</span>&nbsp;<span class="ident" id="5262793">MarshalerError</span>&nbsp;<span class="keyword" id="5262808">struct</span>&nbsp;<span class="op" id="5262815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5262818">Type</span>&nbsp;<span class="ident" id="5262823">reflect</span><span class="op" id="5262830">.</span><span class="ident" id="5262831">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5262837">Err</span>&nbsp;&nbsp;<span class="builtintype" id="5262842">error</span><br>
<span class="lineno"></span><span class="op" id="5262848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span><span class="keyword" id="5262851">func</span>&nbsp;<span class="op" id="5262856">(</span><span class="ident" id="5262857">e</span>&nbsp;<span class="op" id="5262859">*</span><span class="ident" id="5262860">MarshalerError</span><span class="op" id="5262874">)</span>&nbsp;<span class="ident" id="5262876">Error</span><span class="op" id="5262881">(</span><span class="op" id="5262882">)</span>&nbsp;<span class="builtintype" id="5262884">string</span>&nbsp;<span class="op" id="5262891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5262894">return</span>&nbsp;<span class="string" id="5262901">&#34;json:&nbsp;error&nbsp;calling&nbsp;MarshalJSON&nbsp;for&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5262945">+</span>&nbsp;<span class="ident" id="5262947">e</span><span class="op" id="5262948">.</span><span class="ident" id="5262949">Type</span><span class="op" id="5262953">.</span><span class="ident" id="5262954">String</span><span class="op" id="5262960">(</span><span class="op" id="5262961">)</span>&nbsp;<span class="op" id="5262963">+</span>&nbsp;<span class="string" id="5262965">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="5262970">+</span>&nbsp;<span class="ident" id="5262972">e</span><span class="op" id="5262973">.</span><span class="ident" id="5262974">Err</span><span class="op" id="5262977">.</span><span class="ident" id="5262978">Error</span><span class="op" id="5262983">(</span><span class="op" id="5262984">)</span><br>
<span class="lineno"></span><span class="op" id="5262986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5262989">var</span>&nbsp;<span class="ident" id="5262993">hex</span>&nbsp;<span class="op" id="5262997">=</span>&nbsp;<span class="string" id="5262999">&#34;0123456789abcdef&#34;</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="comment" id="5263019">//&nbsp;An&nbsp;encodeState&nbsp;encodes&nbsp;JSON&nbsp;into&nbsp;a&nbsp;bytes.Buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="5263071">type</span>&nbsp;<span class="ident" id="5263076">encodeState</span>&nbsp;<span class="keyword" id="5263088">struct</span>&nbsp;<span class="op" id="5263095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5263098">bytes</span><span class="op" id="5263103">.</span><span class="ident" id="5263104">Buffer</span>&nbsp;<span class="comment" id="5263111">//&nbsp;accumulated&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5263134">scratch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5263147">[</span><span class="num" id="5263148">64</span><span class="op" id="5263150">]</span><span class="builtintype" id="5263151">byte</span><br>
<span class="lineno">245</span><span class="op" id="5263156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5263159">var</span>&nbsp;<span class="ident" id="5263163">encodeStatePool</span>&nbsp;<span class="ident" id="5263179">sync</span><span class="op" id="5263183">.</span><span class="ident" id="5263184">Pool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5263190">func</span>&nbsp;<span class="ident" id="5263195">newEncodeState</span><span class="op" id="5263209">(</span><span class="op" id="5263210">)</span>&nbsp;<span class="op" id="5263212">*</span><span class="ident" id="5263213">encodeState</span>&nbsp;<span class="op" id="5263225">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263228">if</span>&nbsp;<span class="ident" id="5263231">v</span>&nbsp;<span class="op" id="5263233">:=</span>&nbsp;<span class="ident" id="5263236">encodeStatePool</span><span class="op" id="5263251">.</span><span class="ident" id="5263252">Get</span><span class="op" id="5263255">(</span><span class="op" id="5263256">)</span><span class="op" id="5263257">;</span>&nbsp;<span class="ident" id="5263259">v</span>&nbsp;<span class="op" id="5263261">!=</span>&nbsp;<span class="ident" id="5263264">nil</span>&nbsp;<span class="op" id="5263268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5263272">e</span>&nbsp;<span class="op" id="5263274">:=</span>&nbsp;<span class="ident" id="5263277">v</span><span class="op" id="5263278">.</span><span class="op" id="5263279">(</span><span class="op" id="5263280">*</span><span class="ident" id="5263281">encodeState</span><span class="op" id="5263292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5263296">e</span><span class="op" id="5263297">.</span><span class="ident" id="5263298">Reset</span><span class="op" id="5263303">(</span><span class="op" id="5263304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263308">return</span>&nbsp;<span class="ident" id="5263315">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5263318">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263321">return</span>&nbsp;<span class="builtinfunc" id="5263328">new</span><span class="op" id="5263331">(</span><span class="ident" id="5263332">encodeState</span><span class="op" id="5263343">)</span><br>
<span class="lineno"></span><span class="op" id="5263345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5263348">func</span>&nbsp;<span class="op" id="5263353">(</span><span class="ident" id="5263354">e</span>&nbsp;<span class="op" id="5263356">*</span><span class="ident" id="5263357">encodeState</span><span class="op" id="5263368">)</span>&nbsp;<span class="ident" id="5263370">marshal</span><span class="op" id="5263377">(</span><span class="ident" id="5263378">v</span>&nbsp;<span class="keyword" id="5263380">interface</span><span class="op" id="5263389">{</span><span class="op" id="5263390">}</span><span class="op" id="5263391">)</span>&nbsp;<span class="op" id="5263393">(</span><span class="ident" id="5263394">err</span>&nbsp;<span class="builtintype" id="5263398">error</span><span class="op" id="5263403">)</span>&nbsp;<span class="op" id="5263405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263408">defer</span>&nbsp;<span class="keyword" id="5263414">func</span><span class="op" id="5263418">(</span><span class="op" id="5263419">)</span>&nbsp;<span class="op" id="5263421">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263425">if</span>&nbsp;<span class="ident" id="5263428">r</span>&nbsp;<span class="op" id="5263430">:=</span>&nbsp;<span class="builtinfunc" id="5263433">recover</span><span class="op" id="5263440">(</span><span class="op" id="5263441">)</span><span class="op" id="5263442">;</span>&nbsp;<span class="ident" id="5263444">r</span>&nbsp;<span class="op" id="5263446">!=</span>&nbsp;<span class="ident" id="5263449">nil</span>&nbsp;<span class="op" id="5263453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263458">if</span>&nbsp;<span class="ident" id="5263461">_</span><span class="op" id="5263462">,</span>&nbsp;<span class="ident" id="5263464">ok</span>&nbsp;<span class="op" id="5263467">:=</span>&nbsp;<span class="ident" id="5263470">r</span><span class="op" id="5263471">.</span><span class="op" id="5263472">(</span><span class="ident" id="5263473">runtime</span><span class="op" id="5263480">.</span><span class="ident" id="5263481">Error</span><span class="op" id="5263486">)</span><span class="op" id="5263487">;</span>&nbsp;<span class="ident" id="5263489">ok</span>&nbsp;<span class="op" id="5263492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5263498">panic</span><span class="op" id="5263503">(</span><span class="ident" id="5263504">r</span><span class="op" id="5263505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5263510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263515">if</span>&nbsp;<span class="ident" id="5263518">s</span><span class="op" id="5263519">,</span>&nbsp;<span class="ident" id="5263521">ok</span>&nbsp;<span class="op" id="5263524">:=</span>&nbsp;<span class="ident" id="5263527">r</span><span class="op" id="5263528">.</span><span class="op" id="5263529">(</span><span class="builtintype" id="5263530">string</span><span class="op" id="5263536">)</span><span class="op" id="5263537">;</span>&nbsp;<span class="ident" id="5263539">ok</span>&nbsp;<span class="op" id="5263542">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5263548">panic</span><span class="op" id="5263553">(</span><span class="ident" id="5263554">s</span><span class="op" id="5263555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5263560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5263565">err</span>&nbsp;<span class="op" id="5263569">=</span>&nbsp;<span class="ident" id="5263571">r</span><span class="op" id="5263572">.</span><span class="op" id="5263573">(</span><span class="builtintype" id="5263574">error</span><span class="op" id="5263579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5263583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5263586">}</span><span class="op" id="5263587">(</span><span class="op" id="5263588">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5263591">e</span><span class="op" id="5263592">.</span><span class="ident" id="5263593">reflectValue</span><span class="op" id="5263605">(</span><span class="ident" id="5263606">reflect</span><span class="op" id="5263613">.</span><span class="ident" id="5263614">ValueOf</span><span class="op" id="5263621">(</span><span class="ident" id="5263622">v</span><span class="op" id="5263623">)</span><span class="op" id="5263624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263627">return</span>&nbsp;<span class="ident" id="5263634">nil</span><br>
<span class="lineno"></span><span class="op" id="5263638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5263641">func</span>&nbsp;<span class="op" id="5263646">(</span><span class="ident" id="5263647">e</span>&nbsp;<span class="op" id="5263649">*</span><span class="ident" id="5263650">encodeState</span><span class="op" id="5263661">)</span>&nbsp;<span class="builtintype" id="5263663">error</span><span class="op" id="5263668">(</span><span class="ident" id="5263669">err</span>&nbsp;<span class="builtintype" id="5263673">error</span><span class="op" id="5263678">)</span>&nbsp;<span class="op" id="5263680">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5263683">panic</span><span class="op" id="5263688">(</span><span class="ident" id="5263689">err</span><span class="op" id="5263692">)</span><br>
<span class="lineno"></span><span class="op" id="5263694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5263697">var</span>&nbsp;<span class="ident" id="5263701">byteSliceType</span>&nbsp;<span class="op" id="5263715">=</span>&nbsp;<span class="ident" id="5263717">reflect</span><span class="op" id="5263724">.</span><span class="ident" id="5263725">TypeOf</span><span class="op" id="5263731">(</span><span class="op" id="5263732">[</span><span class="op" id="5263733">]</span><span class="builtintype" id="5263734">byte</span><span class="op" id="5263738">(</span><span class="ident" id="5263739">nil</span><span class="op" id="5263742">)</span><span class="op" id="5263743">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="keyword" id="5263746">func</span>&nbsp;<span class="ident" id="5263751">isEmptyValue</span><span class="op" id="5263763">(</span><span class="ident" id="5263764">v</span>&nbsp;<span class="ident" id="5263766">reflect</span><span class="op" id="5263773">.</span><span class="ident" id="5263774">Value</span><span class="op" id="5263779">)</span>&nbsp;<span class="builtintype" id="5263781">bool</span>&nbsp;<span class="op" id="5263786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263789">switch</span>&nbsp;<span class="ident" id="5263796">v</span><span class="op" id="5263797">.</span><span class="ident" id="5263798">Kind</span><span class="op" id="5263802">(</span><span class="op" id="5263803">)</span>&nbsp;<span class="op" id="5263805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263808">case</span>&nbsp;<span class="ident" id="5263813">reflect</span><span class="op" id="5263820">.</span><span class="ident" id="5263821">Array</span><span class="op" id="5263826">,</span>&nbsp;<span class="ident" id="5263828">reflect</span><span class="op" id="5263835">.</span><span class="ident" id="5263836">Map</span><span class="op" id="5263839">,</span>&nbsp;<span class="ident" id="5263841">reflect</span><span class="op" id="5263848">.</span><span class="ident" id="5263849">Slice</span><span class="op" id="5263854">,</span>&nbsp;<span class="ident" id="5263856">reflect</span><span class="op" id="5263863">.</span><span class="ident" id="5263864">String</span><span class="op" id="5263870">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263874">return</span>&nbsp;<span class="ident" id="5263881">v</span><span class="op" id="5263882">.</span><span class="ident" id="5263883">Len</span><span class="op" id="5263886">(</span><span class="op" id="5263887">)</span>&nbsp;<span class="op" id="5263889">==</span>&nbsp;<span class="num" id="5263892">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263895">case</span>&nbsp;<span class="ident" id="5263900">reflect</span><span class="op" id="5263907">.</span><span class="ident" id="5263908">Bool</span><span class="op" id="5263912">:</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263916">return</span>&nbsp;<span class="op" id="5263923">!</span><span class="ident" id="5263924">v</span><span class="op" id="5263925">.</span><span class="ident" id="5263926">Bool</span><span class="op" id="5263930">(</span><span class="op" id="5263931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5263934">case</span>&nbsp;<span class="ident" id="5263939">reflect</span><span class="op" id="5263946">.</span><span class="ident" id="5263947">Int</span><span class="op" id="5263950">,</span>&nbsp;<span class="ident" id="5263952">reflect</span><span class="op" id="5263959">.</span><span class="ident" id="5263960">Int8</span><span class="op" id="5263964">,</span>&nbsp;<span class="ident" id="5263966">reflect</span><span class="op" id="5263973">.</span><span class="ident" id="5263974">Int16</span><span class="op" id="5263979">,</span>&nbsp;<span class="ident" id="5263981">reflect</span><span class="op" id="5263988">.</span><span class="ident" id="5263989">Int32</span><span class="op" id="5263994">,</span>&nbsp;<span class="ident" id="5263996">reflect</span><span class="op" id="5264003">.</span><span class="ident" id="5264004">Int64</span><span class="op" id="5264009">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264013">return</span>&nbsp;<span class="ident" id="5264020">v</span><span class="op" id="5264021">.</span><span class="ident" id="5264022">Int</span><span class="op" id="5264025">(</span><span class="op" id="5264026">)</span>&nbsp;<span class="op" id="5264028">==</span>&nbsp;<span class="num" id="5264031">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264034">case</span>&nbsp;<span class="ident" id="5264039">reflect</span><span class="op" id="5264046">.</span><span class="ident" id="5264047">Uint</span><span class="op" id="5264051">,</span>&nbsp;<span class="ident" id="5264053">reflect</span><span class="op" id="5264060">.</span><span class="ident" id="5264061">Uint8</span><span class="op" id="5264066">,</span>&nbsp;<span class="ident" id="5264068">reflect</span><span class="op" id="5264075">.</span><span class="ident" id="5264076">Uint16</span><span class="op" id="5264082">,</span>&nbsp;<span class="ident" id="5264084">reflect</span><span class="op" id="5264091">.</span><span class="ident" id="5264092">Uint32</span><span class="op" id="5264098">,</span>&nbsp;<span class="ident" id="5264100">reflect</span><span class="op" id="5264107">.</span><span class="ident" id="5264108">Uint64</span><span class="op" id="5264114">,</span>&nbsp;<span class="ident" id="5264116">reflect</span><span class="op" id="5264123">.</span><span class="ident" id="5264124">Uintptr</span><span class="op" id="5264131">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264135">return</span>&nbsp;<span class="ident" id="5264142">v</span><span class="op" id="5264143">.</span><span class="ident" id="5264144">Uint</span><span class="op" id="5264148">(</span><span class="op" id="5264149">)</span>&nbsp;<span class="op" id="5264151">==</span>&nbsp;<span class="num" id="5264154">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264157">case</span>&nbsp;<span class="ident" id="5264162">reflect</span><span class="op" id="5264169">.</span><span class="ident" id="5264170">Float32</span><span class="op" id="5264177">,</span>&nbsp;<span class="ident" id="5264179">reflect</span><span class="op" id="5264186">.</span><span class="ident" id="5264187">Float64</span><span class="op" id="5264194">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264198">return</span>&nbsp;<span class="ident" id="5264205">v</span><span class="op" id="5264206">.</span><span class="ident" id="5264207">Float</span><span class="op" id="5264212">(</span><span class="op" id="5264213">)</span>&nbsp;<span class="op" id="5264215">==</span>&nbsp;<span class="num" id="5264218">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264221">case</span>&nbsp;<span class="ident" id="5264226">reflect</span><span class="op" id="5264233">.</span><span class="ident" id="5264234">Interface</span><span class="op" id="5264243">,</span>&nbsp;<span class="ident" id="5264245">reflect</span><span class="op" id="5264252">.</span><span class="ident" id="5264253">Ptr</span><span class="op" id="5264256">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264260">return</span>&nbsp;<span class="ident" id="5264267">v</span><span class="op" id="5264268">.</span><span class="ident" id="5264269">IsNil</span><span class="op" id="5264274">(</span><span class="op" id="5264275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5264278">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264281">return</span>&nbsp;<span class="builtintype" id="5264288">false</span><br>
<span class="lineno"></span><span class="op" id="5264294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5264297">func</span>&nbsp;<span class="op" id="5264302">(</span><span class="ident" id="5264303">e</span>&nbsp;<span class="op" id="5264305">*</span><span class="ident" id="5264306">encodeState</span><span class="op" id="5264317">)</span>&nbsp;<span class="ident" id="5264319">reflectValue</span><span class="op" id="5264331">(</span><span class="ident" id="5264332">v</span>&nbsp;<span class="ident" id="5264334">reflect</span><span class="op" id="5264341">.</span><span class="ident" id="5264342">Value</span><span class="op" id="5264347">)</span>&nbsp;<span class="op" id="5264349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5264352">valueEncoder</span><span class="op" id="5264364">(</span><span class="ident" id="5264365">v</span><span class="op" id="5264366">)</span><span class="op" id="5264367">(</span><span class="ident" id="5264368">e</span><span class="op" id="5264369">,</span>&nbsp;<span class="ident" id="5264371">v</span><span class="op" id="5264372">,</span>&nbsp;<span class="builtintype" id="5264374">false</span><span class="op" id="5264379">)</span><br>
<span class="lineno">300</span><span class="op" id="5264381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5264384">type</span>&nbsp;<span class="ident" id="5264389">encoderFunc</span>&nbsp;<span class="keyword" id="5264401">func</span><span class="op" id="5264405">(</span><span class="ident" id="5264406">e</span>&nbsp;<span class="op" id="5264408">*</span><span class="ident" id="5264409">encodeState</span><span class="op" id="5264420">,</span>&nbsp;<span class="ident" id="5264422">v</span>&nbsp;<span class="ident" id="5264424">reflect</span><span class="op" id="5264431">.</span><span class="ident" id="5264432">Value</span><span class="op" id="5264437">,</span>&nbsp;<span class="ident" id="5264439">quoted</span>&nbsp;<span class="builtintype" id="5264446">bool</span><span class="op" id="5264450">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5264453">var</span>&nbsp;<span class="ident" id="5264457">encoderCache</span>&nbsp;<span class="keyword" id="5264470">struct</span>&nbsp;<span class="op" id="5264477">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5264480">sync</span><span class="op" id="5264484">.</span><span class="ident" id="5264485">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5264494">m</span>&nbsp;<span class="keyword" id="5264496">map</span><span class="op" id="5264499">[</span><span class="ident" id="5264500">reflect</span><span class="op" id="5264507">.</span><span class="ident" id="5264508">Type</span><span class="op" id="5264512">]</span><span class="ident" id="5264513">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="5264525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5264528">func</span>&nbsp;<span class="ident" id="5264533">valueEncoder</span><span class="op" id="5264545">(</span><span class="ident" id="5264546">v</span>&nbsp;<span class="ident" id="5264548">reflect</span><span class="op" id="5264555">.</span><span class="ident" id="5264556">Value</span><span class="op" id="5264561">)</span>&nbsp;<span class="ident" id="5264563">encoderFunc</span>&nbsp;<span class="op" id="5264575">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264578">if</span>&nbsp;<span class="op" id="5264581">!</span><span class="ident" id="5264582">v</span><span class="op" id="5264583">.</span><span class="ident" id="5264584">IsValid</span><span class="op" id="5264591">(</span><span class="op" id="5264592">)</span>&nbsp;<span class="op" id="5264594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264598">return</span>&nbsp;<span class="ident" id="5264605">invalidValueEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5264626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264629">return</span>&nbsp;<span class="ident" id="5264636">typeEncoder</span><span class="op" id="5264647">(</span><span class="ident" id="5264648">v</span><span class="op" id="5264649">.</span><span class="ident" id="5264650">Type</span><span class="op" id="5264654">(</span><span class="op" id="5264655">)</span><span class="op" id="5264656">)</span><br>
<span class="lineno"></span><span class="op" id="5264658">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="5264661">func</span>&nbsp;<span class="ident" id="5264666">typeEncoder</span><span class="op" id="5264677">(</span><span class="ident" id="5264678">t</span>&nbsp;<span class="ident" id="5264680">reflect</span><span class="op" id="5264687">.</span><span class="ident" id="5264688">Type</span><span class="op" id="5264692">)</span>&nbsp;<span class="ident" id="5264694">encoderFunc</span>&nbsp;<span class="op" id="5264706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5264709">encoderCache</span><span class="op" id="5264721">.</span><span class="ident" id="5264722">RLock</span><span class="op" id="5264727">(</span><span class="op" id="5264728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5264731">f</span>&nbsp;<span class="op" id="5264733">:=</span>&nbsp;<span class="ident" id="5264736">encoderCache</span><span class="op" id="5264748">.</span><span class="ident" id="5264749">m</span><span class="op" id="5264750">[</span><span class="ident" id="5264751">t</span><span class="op" id="5264752">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5264755">encoderCache</span><span class="op" id="5264767">.</span><span class="ident" id="5264768">RUnlock</span><span class="op" id="5264775">(</span><span class="op" id="5264776">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264779">if</span>&nbsp;<span class="ident" id="5264782">f</span>&nbsp;<span class="op" id="5264784">!=</span>&nbsp;<span class="ident" id="5264787">nil</span>&nbsp;<span class="op" id="5264791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5264795">return</span>&nbsp;<span class="ident" id="5264802">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5264805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5264809">//&nbsp;To&nbsp;deal&nbsp;with&nbsp;recursive&nbsp;types,&nbsp;populate&nbsp;the&nbsp;map&nbsp;with&nbsp;an</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5264868">//&nbsp;indirect&nbsp;func&nbsp;before&nbsp;we&nbsp;build&nbsp;it.&nbsp;This&nbsp;type&nbsp;waits&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5264929">//&nbsp;real&nbsp;func&nbsp;(f)&nbsp;to&nbsp;be&nbsp;ready&nbsp;and&nbsp;then&nbsp;calls&nbsp;it.&nbsp;&nbsp;This&nbsp;indirect</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5264993">//&nbsp;func&nbsp;is&nbsp;only&nbsp;used&nbsp;for&nbsp;recursive&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5265036">encoderCache</span><span class="op" id="5265048">.</span><span class="ident" id="5265049">Lock</span><span class="op" id="5265053">(</span><span class="op" id="5265054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265057">if</span>&nbsp;<span class="ident" id="5265060">encoderCache</span><span class="op" id="5265072">.</span><span class="ident" id="5265073">m</span>&nbsp;<span class="op" id="5265075">==</span>&nbsp;<span class="ident" id="5265078">nil</span>&nbsp;<span class="op" id="5265082">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5265086">encoderCache</span><span class="op" id="5265098">.</span><span class="ident" id="5265099">m</span>&nbsp;<span class="op" id="5265101">=</span>&nbsp;<span class="builtinfunc" id="5265103">make</span><span class="op" id="5265107">(</span><span class="keyword" id="5265108">map</span><span class="op" id="5265111">[</span><span class="ident" id="5265112">reflect</span><span class="op" id="5265119">.</span><span class="ident" id="5265120">Type</span><span class="op" id="5265124">]</span><span class="ident" id="5265125">encoderFunc</span><span class="op" id="5265136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5265139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265142">var</span>&nbsp;<span class="ident" id="5265146">wg</span>&nbsp;<span class="ident" id="5265149">sync</span><span class="op" id="5265153">.</span><span class="ident" id="5265154">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5265165">wg</span><span class="op" id="5265167">.</span><span class="ident" id="5265168">Add</span><span class="op" id="5265171">(</span><span class="num" id="5265172">1</span><span class="op" id="5265173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5265176">encoderCache</span><span class="op" id="5265188">.</span><span class="ident" id="5265189">m</span><span class="op" id="5265190">[</span><span class="ident" id="5265191">t</span><span class="op" id="5265192">]</span>&nbsp;<span class="op" id="5265194">=</span>&nbsp;<span class="keyword" id="5265196">func</span><span class="op" id="5265200">(</span><span class="ident" id="5265201">e</span>&nbsp;<span class="op" id="5265203">*</span><span class="ident" id="5265204">encodeState</span><span class="op" id="5265215">,</span>&nbsp;<span class="ident" id="5265217">v</span>&nbsp;<span class="ident" id="5265219">reflect</span><span class="op" id="5265226">.</span><span class="ident" id="5265227">Value</span><span class="op" id="5265232">,</span>&nbsp;<span class="ident" id="5265234">quoted</span>&nbsp;<span class="builtintype" id="5265241">bool</span><span class="op" id="5265245">)</span>&nbsp;<span class="op" id="5265247">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5265251">wg</span><span class="op" id="5265253">.</span><span class="ident" id="5265254">Wait</span><span class="op" id="5265258">(</span><span class="op" id="5265259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5265263">f</span><span class="op" id="5265264">(</span><span class="ident" id="5265265">e</span><span class="op" id="5265266">,</span>&nbsp;<span class="ident" id="5265268">v</span><span class="op" id="5265269">,</span>&nbsp;<span class="ident" id="5265271">quoted</span><span class="op" id="5265277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5265280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5265283">encoderCache</span><span class="op" id="5265295">.</span><span class="ident" id="5265296">Unlock</span><span class="op" id="5265302">(</span><span class="op" id="5265303">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5265307">//&nbsp;Compute&nbsp;fields&nbsp;without&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5265340">//&nbsp;Might&nbsp;duplicate&nbsp;effort&nbsp;but&nbsp;won&#39;t&nbsp;hold&nbsp;other&nbsp;computations&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5265407">f</span>&nbsp;<span class="op" id="5265409">=</span>&nbsp;<span class="ident" id="5265411">newTypeEncoder</span><span class="op" id="5265425">(</span><span class="ident" id="5265426">t</span><span class="op" id="5265427">,</span>&nbsp;<span class="builtintype" id="5265429">true</span><span class="op" id="5265433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5265436">wg</span><span class="op" id="5265438">.</span><span class="ident" id="5265439">Done</span><span class="op" id="5265443">(</span><span class="op" id="5265444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5265447">encoderCache</span><span class="op" id="5265459">.</span><span class="ident" id="5265460">Lock</span><span class="op" id="5265464">(</span><span class="op" id="5265465">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5265468">encoderCache</span><span class="op" id="5265480">.</span><span class="ident" id="5265481">m</span><span class="op" id="5265482">[</span><span class="ident" id="5265483">t</span><span class="op" id="5265484">]</span>&nbsp;<span class="op" id="5265486">=</span>&nbsp;<span class="ident" id="5265488">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5265491">encoderCache</span><span class="op" id="5265503">.</span><span class="ident" id="5265504">Unlock</span><span class="op" id="5265510">(</span><span class="op" id="5265511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265514">return</span>&nbsp;<span class="ident" id="5265521">f</span><br>
<span class="lineno"></span><span class="op" id="5265523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span><span class="keyword" id="5265526">var</span>&nbsp;<span class="op" id="5265530">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5265533">marshalerType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5265551">=</span>&nbsp;<span class="ident" id="5265553">reflect</span><span class="op" id="5265560">.</span><span class="ident" id="5265561">TypeOf</span><span class="op" id="5265567">(</span><span class="builtinfunc" id="5265568">new</span><span class="op" id="5265571">(</span><span class="ident" id="5265572">Marshaler</span><span class="op" id="5265581">)</span><span class="op" id="5265582">)</span><span class="op" id="5265583">.</span><span class="ident" id="5265584">Elem</span><span class="op" id="5265588">(</span><span class="op" id="5265589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5265592">textMarshalerType</span>&nbsp;<span class="op" id="5265610">=</span>&nbsp;<span class="ident" id="5265612">reflect</span><span class="op" id="5265619">.</span><span class="ident" id="5265620">TypeOf</span><span class="op" id="5265626">(</span><span class="builtinfunc" id="5265627">new</span><span class="op" id="5265630">(</span><span class="ident" id="5265631">encoding</span><span class="op" id="5265639">.</span><span class="ident" id="5265640">TextMarshaler</span><span class="op" id="5265653">)</span><span class="op" id="5265654">)</span><span class="op" id="5265655">.</span><span class="ident" id="5265656">Elem</span><span class="op" id="5265660">(</span><span class="op" id="5265661">)</span><br>
<span class="lineno"></span><span class="op" id="5265663">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment" id="5265666">//&nbsp;newTypeEncoder&nbsp;constructs&nbsp;an&nbsp;encoderFunc&nbsp;for&nbsp;a&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="5265722">//&nbsp;The&nbsp;returned&nbsp;encoder&nbsp;only&nbsp;checks&nbsp;CanAddr&nbsp;when&nbsp;allowAddr&nbsp;is&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="5265790">func</span>&nbsp;<span class="ident" id="5265795">newTypeEncoder</span><span class="op" id="5265809">(</span><span class="ident" id="5265810">t</span>&nbsp;<span class="ident" id="5265812">reflect</span><span class="op" id="5265819">.</span><span class="ident" id="5265820">Type</span><span class="op" id="5265824">,</span>&nbsp;<span class="ident" id="5265826">allowAddr</span>&nbsp;<span class="builtintype" id="5265836">bool</span><span class="op" id="5265840">)</span>&nbsp;<span class="ident" id="5265842">encoderFunc</span>&nbsp;<span class="op" id="5265854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265857">if</span>&nbsp;<span class="ident" id="5265860">t</span><span class="op" id="5265861">.</span><span class="ident" id="5265862">Implements</span><span class="op" id="5265872">(</span><span class="ident" id="5265873">marshalerType</span><span class="op" id="5265886">)</span>&nbsp;<span class="op" id="5265888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265892">return</span>&nbsp;<span class="ident" id="5265899">marshalerEncoder</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5265917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265920">if</span>&nbsp;<span class="ident" id="5265923">t</span><span class="op" id="5265924">.</span><span class="ident" id="5265925">Kind</span><span class="op" id="5265929">(</span><span class="op" id="5265930">)</span>&nbsp;<span class="op" id="5265932">!=</span>&nbsp;<span class="ident" id="5265935">reflect</span><span class="op" id="5265942">.</span><span class="ident" id="5265943">Ptr</span>&nbsp;<span class="op" id="5265947">&amp;&amp;</span>&nbsp;<span class="ident" id="5265950">allowAddr</span>&nbsp;<span class="op" id="5265960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5265964">if</span>&nbsp;<span class="ident" id="5265967">reflect</span><span class="op" id="5265974">.</span><span class="ident" id="5265975">PtrTo</span><span class="op" id="5265980">(</span><span class="ident" id="5265981">t</span><span class="op" id="5265982">)</span><span class="op" id="5265983">.</span><span class="ident" id="5265984">Implements</span><span class="op" id="5265994">(</span><span class="ident" id="5265995">marshalerType</span><span class="op" id="5266008">)</span>&nbsp;<span class="op" id="5266010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266015">return</span>&nbsp;<span class="ident" id="5266022">newCondAddrEncoder</span><span class="op" id="5266040">(</span><span class="ident" id="5266041">addrMarshalerEncoder</span><span class="op" id="5266061">,</span>&nbsp;<span class="ident" id="5266063">newTypeEncoder</span><span class="op" id="5266077">(</span><span class="ident" id="5266078">t</span><span class="op" id="5266079">,</span>&nbsp;<span class="builtintype" id="5266081">false</span><span class="op" id="5266086">)</span><span class="op" id="5266087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5266091">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5266094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266098">if</span>&nbsp;<span class="ident" id="5266101">t</span><span class="op" id="5266102">.</span><span class="ident" id="5266103">Implements</span><span class="op" id="5266113">(</span><span class="ident" id="5266114">textMarshalerType</span><span class="op" id="5266131">)</span>&nbsp;<span class="op" id="5266133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266137">return</span>&nbsp;<span class="ident" id="5266144">textMarshalerEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5266166">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266169">if</span>&nbsp;<span class="ident" id="5266172">t</span><span class="op" id="5266173">.</span><span class="ident" id="5266174">Kind</span><span class="op" id="5266178">(</span><span class="op" id="5266179">)</span>&nbsp;<span class="op" id="5266181">!=</span>&nbsp;<span class="ident" id="5266184">reflect</span><span class="op" id="5266191">.</span><span class="ident" id="5266192">Ptr</span>&nbsp;<span class="op" id="5266196">&amp;&amp;</span>&nbsp;<span class="ident" id="5266199">allowAddr</span>&nbsp;<span class="op" id="5266209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266213">if</span>&nbsp;<span class="ident" id="5266216">reflect</span><span class="op" id="5266223">.</span><span class="ident" id="5266224">PtrTo</span><span class="op" id="5266229">(</span><span class="ident" id="5266230">t</span><span class="op" id="5266231">)</span><span class="op" id="5266232">.</span><span class="ident" id="5266233">Implements</span><span class="op" id="5266243">(</span><span class="ident" id="5266244">textMarshalerType</span><span class="op" id="5266261">)</span>&nbsp;<span class="op" id="5266263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266268">return</span>&nbsp;<span class="ident" id="5266275">newCondAddrEncoder</span><span class="op" id="5266293">(</span><span class="ident" id="5266294">addrTextMarshalerEncoder</span><span class="op" id="5266318">,</span>&nbsp;<span class="ident" id="5266320">newTypeEncoder</span><span class="op" id="5266334">(</span><span class="ident" id="5266335">t</span><span class="op" id="5266336">,</span>&nbsp;<span class="builtintype" id="5266338">false</span><span class="op" id="5266343">)</span><span class="op" id="5266344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5266348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5266351">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266355">switch</span>&nbsp;<span class="ident" id="5266362">t</span><span class="op" id="5266363">.</span><span class="ident" id="5266364">Kind</span><span class="op" id="5266368">(</span><span class="op" id="5266369">)</span>&nbsp;<span class="op" id="5266371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266374">case</span>&nbsp;<span class="ident" id="5266379">reflect</span><span class="op" id="5266386">.</span><span class="ident" id="5266387">Bool</span><span class="op" id="5266391">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266395">return</span>&nbsp;<span class="ident" id="5266402">boolEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266415">case</span>&nbsp;<span class="ident" id="5266420">reflect</span><span class="op" id="5266427">.</span><span class="ident" id="5266428">Int</span><span class="op" id="5266431">,</span>&nbsp;<span class="ident" id="5266433">reflect</span><span class="op" id="5266440">.</span><span class="ident" id="5266441">Int8</span><span class="op" id="5266445">,</span>&nbsp;<span class="ident" id="5266447">reflect</span><span class="op" id="5266454">.</span><span class="ident" id="5266455">Int16</span><span class="op" id="5266460">,</span>&nbsp;<span class="ident" id="5266462">reflect</span><span class="op" id="5266469">.</span><span class="ident" id="5266470">Int32</span><span class="op" id="5266475">,</span>&nbsp;<span class="ident" id="5266477">reflect</span><span class="op" id="5266484">.</span><span class="ident" id="5266485">Int64</span><span class="op" id="5266490">:</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266494">return</span>&nbsp;<span class="ident" id="5266501">intEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266513">case</span>&nbsp;<span class="ident" id="5266518">reflect</span><span class="op" id="5266525">.</span><span class="ident" id="5266526">Uint</span><span class="op" id="5266530">,</span>&nbsp;<span class="ident" id="5266532">reflect</span><span class="op" id="5266539">.</span><span class="ident" id="5266540">Uint8</span><span class="op" id="5266545">,</span>&nbsp;<span class="ident" id="5266547">reflect</span><span class="op" id="5266554">.</span><span class="ident" id="5266555">Uint16</span><span class="op" id="5266561">,</span>&nbsp;<span class="ident" id="5266563">reflect</span><span class="op" id="5266570">.</span><span class="ident" id="5266571">Uint32</span><span class="op" id="5266577">,</span>&nbsp;<span class="ident" id="5266579">reflect</span><span class="op" id="5266586">.</span><span class="ident" id="5266587">Uint64</span><span class="op" id="5266593">,</span>&nbsp;<span class="ident" id="5266595">reflect</span><span class="op" id="5266602">.</span><span class="ident" id="5266603">Uintptr</span><span class="op" id="5266610">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266614">return</span>&nbsp;<span class="ident" id="5266621">uintEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266634">case</span>&nbsp;<span class="ident" id="5266639">reflect</span><span class="op" id="5266646">.</span><span class="ident" id="5266647">Float32</span><span class="op" id="5266654">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266658">return</span>&nbsp;<span class="ident" id="5266665">float32Encoder</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266681">case</span>&nbsp;<span class="ident" id="5266686">reflect</span><span class="op" id="5266693">.</span><span class="ident" id="5266694">Float64</span><span class="op" id="5266701">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266705">return</span>&nbsp;<span class="ident" id="5266712">float64Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266728">case</span>&nbsp;<span class="ident" id="5266733">reflect</span><span class="op" id="5266740">.</span><span class="ident" id="5266741">String</span><span class="op" id="5266747">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266751">return</span>&nbsp;<span class="ident" id="5266758">stringEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266773">case</span>&nbsp;<span class="ident" id="5266778">reflect</span><span class="op" id="5266785">.</span><span class="ident" id="5266786">Interface</span><span class="op" id="5266795">:</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266799">return</span>&nbsp;<span class="ident" id="5266806">interfaceEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266824">case</span>&nbsp;<span class="ident" id="5266829">reflect</span><span class="op" id="5266836">.</span><span class="ident" id="5266837">Struct</span><span class="op" id="5266843">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266847">return</span>&nbsp;<span class="ident" id="5266854">newStructEncoder</span><span class="op" id="5266870">(</span><span class="ident" id="5266871">t</span><span class="op" id="5266872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266875">case</span>&nbsp;<span class="ident" id="5266880">reflect</span><span class="op" id="5266887">.</span><span class="ident" id="5266888">Map</span><span class="op" id="5266891">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266895">return</span>&nbsp;<span class="ident" id="5266902">newMapEncoder</span><span class="op" id="5266915">(</span><span class="ident" id="5266916">t</span><span class="op" id="5266917">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266920">case</span>&nbsp;<span class="ident" id="5266925">reflect</span><span class="op" id="5266932">.</span><span class="ident" id="5266933">Slice</span><span class="op" id="5266938">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266942">return</span>&nbsp;<span class="ident" id="5266949">newSliceEncoder</span><span class="op" id="5266964">(</span><span class="ident" id="5266965">t</span><span class="op" id="5266966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266969">case</span>&nbsp;<span class="ident" id="5266974">reflect</span><span class="op" id="5266981">.</span><span class="ident" id="5266982">Array</span><span class="op" id="5266987">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5266991">return</span>&nbsp;<span class="ident" id="5266998">newArrayEncoder</span><span class="op" id="5267013">(</span><span class="ident" id="5267014">t</span><span class="op" id="5267015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267018">case</span>&nbsp;<span class="ident" id="5267023">reflect</span><span class="op" id="5267030">.</span><span class="ident" id="5267031">Ptr</span><span class="op" id="5267034">:</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267038">return</span>&nbsp;<span class="ident" id="5267045">newPtrEncoder</span><span class="op" id="5267058">(</span><span class="ident" id="5267059">t</span><span class="op" id="5267060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267063">default</span><span class="op" id="5267070">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267074">return</span>&nbsp;<span class="ident" id="5267081">unsupportedTypeEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5267105">}</span><br>
<span class="lineno"></span><span class="op" id="5267107">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span><span class="keyword" id="5267110">func</span>&nbsp;<span class="ident" id="5267115">invalidValueEncoder</span><span class="op" id="5267134">(</span><span class="ident" id="5267135">e</span>&nbsp;<span class="op" id="5267137">*</span><span class="ident" id="5267138">encodeState</span><span class="op" id="5267149">,</span>&nbsp;<span class="ident" id="5267151">v</span>&nbsp;<span class="ident" id="5267153">reflect</span><span class="op" id="5267160">.</span><span class="ident" id="5267161">Value</span><span class="op" id="5267166">,</span>&nbsp;<span class="ident" id="5267168">quoted</span>&nbsp;<span class="builtintype" id="5267175">bool</span><span class="op" id="5267179">)</span>&nbsp;<span class="op" id="5267181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5267184">e</span><span class="op" id="5267185">.</span><span class="ident" id="5267186">WriteString</span><span class="op" id="5267197">(</span><span class="string" id="5267198">&#34;null&#34;</span><span class="op" id="5267204">)</span><br>
<span class="lineno"></span><span class="op" id="5267206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="keyword" id="5267209">func</span>&nbsp;<span class="ident" id="5267214">marshalerEncoder</span><span class="op" id="5267230">(</span><span class="ident" id="5267231">e</span>&nbsp;<span class="op" id="5267233">*</span><span class="ident" id="5267234">encodeState</span><span class="op" id="5267245">,</span>&nbsp;<span class="ident" id="5267247">v</span>&nbsp;<span class="ident" id="5267249">reflect</span><span class="op" id="5267256">.</span><span class="ident" id="5267257">Value</span><span class="op" id="5267262">,</span>&nbsp;<span class="ident" id="5267264">quoted</span>&nbsp;<span class="builtintype" id="5267271">bool</span><span class="op" id="5267275">)</span>&nbsp;<span class="op" id="5267277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267280">if</span>&nbsp;<span class="ident" id="5267283">v</span><span class="op" id="5267284">.</span><span class="ident" id="5267285">Kind</span><span class="op" id="5267289">(</span><span class="op" id="5267290">)</span>&nbsp;<span class="op" id="5267292">==</span>&nbsp;<span class="ident" id="5267295">reflect</span><span class="op" id="5267302">.</span><span class="ident" id="5267303">Ptr</span>&nbsp;<span class="op" id="5267307">&amp;&amp;</span>&nbsp;<span class="ident" id="5267310">v</span><span class="op" id="5267311">.</span><span class="ident" id="5267312">IsNil</span><span class="op" id="5267317">(</span><span class="op" id="5267318">)</span>&nbsp;<span class="op" id="5267320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5267324">e</span><span class="op" id="5267325">.</span><span class="ident" id="5267326">WriteString</span><span class="op" id="5267337">(</span><span class="string" id="5267338">&#34;null&#34;</span><span class="op" id="5267344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267348">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5267356">}</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5267359">m</span>&nbsp;<span class="op" id="5267361">:=</span>&nbsp;<span class="ident" id="5267364">v</span><span class="op" id="5267365">.</span><span class="ident" id="5267366">Interface</span><span class="op" id="5267375">(</span><span class="op" id="5267376">)</span><span class="op" id="5267377">.</span><span class="op" id="5267378">(</span><span class="ident" id="5267379">Marshaler</span><span class="op" id="5267388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5267391">b</span><span class="op" id="5267392">,</span>&nbsp;<span class="ident" id="5267394">err</span>&nbsp;<span class="op" id="5267398">:=</span>&nbsp;<span class="ident" id="5267401">m</span><span class="op" id="5267402">.</span><span class="ident" id="5267403">MarshalJSON</span><span class="op" id="5267414">(</span><span class="op" id="5267415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267418">if</span>&nbsp;<span class="ident" id="5267421">err</span>&nbsp;<span class="op" id="5267425">==</span>&nbsp;<span class="ident" id="5267428">nil</span>&nbsp;<span class="op" id="5267432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5267436">//&nbsp;copy&nbsp;JSON&nbsp;into&nbsp;buffer,&nbsp;checking&nbsp;validity.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5267483">err</span>&nbsp;<span class="op" id="5267487">=</span>&nbsp;<span class="ident" id="5267489">compact</span><span class="op" id="5267496">(</span><span class="op" id="5267497">&amp;</span><span class="ident" id="5267498">e</span><span class="op" id="5267499">.</span><span class="ident" id="5267500">Buffer</span><span class="op" id="5267506">,</span>&nbsp;<span class="ident" id="5267508">b</span><span class="op" id="5267509">,</span>&nbsp;<span class="builtintype" id="5267511">true</span><span class="op" id="5267515">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5267518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267521">if</span>&nbsp;<span class="ident" id="5267524">err</span>&nbsp;<span class="op" id="5267528">!=</span>&nbsp;<span class="ident" id="5267531">nil</span>&nbsp;<span class="op" id="5267535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5267539">e</span><span class="op" id="5267540">.</span><span class="builtintype" id="5267541">error</span><span class="op" id="5267546">(</span><span class="op" id="5267547">&amp;</span><span class="ident" id="5267548">MarshalerError</span><span class="op" id="5267562">{</span><span class="ident" id="5267563">v</span><span class="op" id="5267564">.</span><span class="ident" id="5267565">Type</span><span class="op" id="5267569">(</span><span class="op" id="5267570">)</span><span class="op" id="5267571">,</span>&nbsp;<span class="ident" id="5267573">err</span><span class="op" id="5267576">}</span><span class="op" id="5267577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5267580">}</span><br>
<span class="lineno"></span><span class="op" id="5267582">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="keyword" id="5267585">func</span>&nbsp;<span class="ident" id="5267590">addrMarshalerEncoder</span><span class="op" id="5267610">(</span><span class="ident" id="5267611">e</span>&nbsp;<span class="op" id="5267613">*</span><span class="ident" id="5267614">encodeState</span><span class="op" id="5267625">,</span>&nbsp;<span class="ident" id="5267627">v</span>&nbsp;<span class="ident" id="5267629">reflect</span><span class="op" id="5267636">.</span><span class="ident" id="5267637">Value</span><span class="op" id="5267642">,</span>&nbsp;<span class="ident" id="5267644">quoted</span>&nbsp;<span class="builtintype" id="5267651">bool</span><span class="op" id="5267655">)</span>&nbsp;<span class="op" id="5267657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5267660">va</span>&nbsp;<span class="op" id="5267663">:=</span>&nbsp;<span class="ident" id="5267666">v</span><span class="op" id="5267667">.</span><span class="ident" id="5267668">Addr</span><span class="op" id="5267672">(</span><span class="op" id="5267673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267676">if</span>&nbsp;<span class="ident" id="5267679">va</span><span class="op" id="5267681">.</span><span class="ident" id="5267682">IsNil</span><span class="op" id="5267687">(</span><span class="op" id="5267688">)</span>&nbsp;<span class="op" id="5267690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5267694">e</span><span class="op" id="5267695">.</span><span class="ident" id="5267696">WriteString</span><span class="op" id="5267707">(</span><span class="string" id="5267708">&#34;null&#34;</span><span class="op" id="5267714">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267718">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5267726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5267729">m</span>&nbsp;<span class="op" id="5267731">:=</span>&nbsp;<span class="ident" id="5267734">va</span><span class="op" id="5267736">.</span><span class="ident" id="5267737">Interface</span><span class="op" id="5267746">(</span><span class="op" id="5267747">)</span><span class="op" id="5267748">.</span><span class="op" id="5267749">(</span><span class="ident" id="5267750">Marshaler</span><span class="op" id="5267759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5267762">b</span><span class="op" id="5267763">,</span>&nbsp;<span class="ident" id="5267765">err</span>&nbsp;<span class="op" id="5267769">:=</span>&nbsp;<span class="ident" id="5267772">m</span><span class="op" id="5267773">.</span><span class="ident" id="5267774">MarshalJSON</span><span class="op" id="5267785">(</span><span class="op" id="5267786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267789">if</span>&nbsp;<span class="ident" id="5267792">err</span>&nbsp;<span class="op" id="5267796">==</span>&nbsp;<span class="ident" id="5267799">nil</span>&nbsp;<span class="op" id="5267803">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5267807">//&nbsp;copy&nbsp;JSON&nbsp;into&nbsp;buffer,&nbsp;checking&nbsp;validity.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5267854">err</span>&nbsp;<span class="op" id="5267858">=</span>&nbsp;<span class="ident" id="5267860">compact</span><span class="op" id="5267867">(</span><span class="op" id="5267868">&amp;</span><span class="ident" id="5267869">e</span><span class="op" id="5267870">.</span><span class="ident" id="5267871">Buffer</span><span class="op" id="5267877">,</span>&nbsp;<span class="ident" id="5267879">b</span><span class="op" id="5267880">,</span>&nbsp;<span class="builtintype" id="5267882">true</span><span class="op" id="5267886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5267889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5267892">if</span>&nbsp;<span class="ident" id="5267895">err</span>&nbsp;<span class="op" id="5267899">!=</span>&nbsp;<span class="ident" id="5267902">nil</span>&nbsp;<span class="op" id="5267906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5267910">e</span><span class="op" id="5267911">.</span><span class="builtintype" id="5267912">error</span><span class="op" id="5267917">(</span><span class="op" id="5267918">&amp;</span><span class="ident" id="5267919">MarshalerError</span><span class="op" id="5267933">{</span><span class="ident" id="5267934">v</span><span class="op" id="5267935">.</span><span class="ident" id="5267936">Type</span><span class="op" id="5267940">(</span><span class="op" id="5267941">)</span><span class="op" id="5267942">,</span>&nbsp;<span class="ident" id="5267944">err</span><span class="op" id="5267947">}</span><span class="op" id="5267948">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5267951">}</span><br>
<span class="lineno"></span><span class="op" id="5267953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5267956">func</span>&nbsp;<span class="ident" id="5267961">textMarshalerEncoder</span><span class="op" id="5267981">(</span><span class="ident" id="5267982">e</span>&nbsp;<span class="op" id="5267984">*</span><span class="ident" id="5267985">encodeState</span><span class="op" id="5267996">,</span>&nbsp;<span class="ident" id="5267998">v</span>&nbsp;<span class="ident" id="5268000">reflect</span><span class="op" id="5268007">.</span><span class="ident" id="5268008">Value</span><span class="op" id="5268013">,</span>&nbsp;<span class="ident" id="5268015">quoted</span>&nbsp;<span class="builtintype" id="5268022">bool</span><span class="op" id="5268026">)</span>&nbsp;<span class="op" id="5268028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5268031">if</span>&nbsp;<span class="ident" id="5268034">v</span><span class="op" id="5268035">.</span><span class="ident" id="5268036">Kind</span><span class="op" id="5268040">(</span><span class="op" id="5268041">)</span>&nbsp;<span class="op" id="5268043">==</span>&nbsp;<span class="ident" id="5268046">reflect</span><span class="op" id="5268053">.</span><span class="ident" id="5268054">Ptr</span>&nbsp;<span class="op" id="5268058">&amp;&amp;</span>&nbsp;<span class="ident" id="5268061">v</span><span class="op" id="5268062">.</span><span class="ident" id="5268063">IsNil</span><span class="op" id="5268068">(</span><span class="op" id="5268069">)</span>&nbsp;<span class="op" id="5268071">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268075">e</span><span class="op" id="5268076">.</span><span class="ident" id="5268077">WriteString</span><span class="op" id="5268088">(</span><span class="string" id="5268089">&#34;null&#34;</span><span class="op" id="5268095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5268099">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5268107">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268110">m</span>&nbsp;<span class="op" id="5268112">:=</span>&nbsp;<span class="ident" id="5268115">v</span><span class="op" id="5268116">.</span><span class="ident" id="5268117">Interface</span><span class="op" id="5268126">(</span><span class="op" id="5268127">)</span><span class="op" id="5268128">.</span><span class="op" id="5268129">(</span><span class="ident" id="5268130">encoding</span><span class="op" id="5268138">.</span><span class="ident" id="5268139">TextMarshaler</span><span class="op" id="5268152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268155">b</span><span class="op" id="5268156">,</span>&nbsp;<span class="ident" id="5268158">err</span>&nbsp;<span class="op" id="5268162">:=</span>&nbsp;<span class="ident" id="5268165">m</span><span class="op" id="5268166">.</span><span class="ident" id="5268167">MarshalText</span><span class="op" id="5268178">(</span><span class="op" id="5268179">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5268182">if</span>&nbsp;<span class="ident" id="5268185">err</span>&nbsp;<span class="op" id="5268189">==</span>&nbsp;<span class="ident" id="5268192">nil</span>&nbsp;<span class="op" id="5268196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268200">_</span><span class="op" id="5268201">,</span>&nbsp;<span class="ident" id="5268203">err</span>&nbsp;<span class="op" id="5268207">=</span>&nbsp;<span class="ident" id="5268209">e</span><span class="op" id="5268210">.</span><span class="ident" id="5268211">stringBytes</span><span class="op" id="5268222">(</span><span class="ident" id="5268223">b</span><span class="op" id="5268224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5268227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5268230">if</span>&nbsp;<span class="ident" id="5268233">err</span>&nbsp;<span class="op" id="5268237">!=</span>&nbsp;<span class="ident" id="5268240">nil</span>&nbsp;<span class="op" id="5268244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268248">e</span><span class="op" id="5268249">.</span><span class="builtintype" id="5268250">error</span><span class="op" id="5268255">(</span><span class="op" id="5268256">&amp;</span><span class="ident" id="5268257">MarshalerError</span><span class="op" id="5268271">{</span><span class="ident" id="5268272">v</span><span class="op" id="5268273">.</span><span class="ident" id="5268274">Type</span><span class="op" id="5268278">(</span><span class="op" id="5268279">)</span><span class="op" id="5268280">,</span>&nbsp;<span class="ident" id="5268282">err</span><span class="op" id="5268285">}</span><span class="op" id="5268286">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5268289">}</span><br>
<span class="lineno"></span><span class="op" id="5268291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5268294">func</span>&nbsp;<span class="ident" id="5268299">addrTextMarshalerEncoder</span><span class="op" id="5268323">(</span><span class="ident" id="5268324">e</span>&nbsp;<span class="op" id="5268326">*</span><span class="ident" id="5268327">encodeState</span><span class="op" id="5268338">,</span>&nbsp;<span class="ident" id="5268340">v</span>&nbsp;<span class="ident" id="5268342">reflect</span><span class="op" id="5268349">.</span><span class="ident" id="5268350">Value</span><span class="op" id="5268355">,</span>&nbsp;<span class="ident" id="5268357">quoted</span>&nbsp;<span class="builtintype" id="5268364">bool</span><span class="op" id="5268368">)</span>&nbsp;<span class="op" id="5268370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268373">va</span>&nbsp;<span class="op" id="5268376">:=</span>&nbsp;<span class="ident" id="5268379">v</span><span class="op" id="5268380">.</span><span class="ident" id="5268381">Addr</span><span class="op" id="5268385">(</span><span class="op" id="5268386">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5268389">if</span>&nbsp;<span class="ident" id="5268392">va</span><span class="op" id="5268394">.</span><span class="ident" id="5268395">IsNil</span><span class="op" id="5268400">(</span><span class="op" id="5268401">)</span>&nbsp;<span class="op" id="5268403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268407">e</span><span class="op" id="5268408">.</span><span class="ident" id="5268409">WriteString</span><span class="op" id="5268420">(</span><span class="string" id="5268421">&#34;null&#34;</span><span class="op" id="5268427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5268431">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5268439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268442">m</span>&nbsp;<span class="op" id="5268444">:=</span>&nbsp;<span class="ident" id="5268447">va</span><span class="op" id="5268449">.</span><span class="ident" id="5268450">Interface</span><span class="op" id="5268459">(</span><span class="op" id="5268460">)</span><span class="op" id="5268461">.</span><span class="op" id="5268462">(</span><span class="ident" id="5268463">encoding</span><span class="op" id="5268471">.</span><span class="ident" id="5268472">TextMarshaler</span><span class="op" id="5268485">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268488">b</span><span class="op" id="5268489">,</span>&nbsp;<span class="ident" id="5268491">err</span>&nbsp;<span class="op" id="5268495">:=</span>&nbsp;<span class="ident" id="5268498">m</span><span class="op" id="5268499">.</span><span class="ident" id="5268500">MarshalText</span><span class="op" id="5268511">(</span><span class="op" id="5268512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5268515">if</span>&nbsp;<span class="ident" id="5268518">err</span>&nbsp;<span class="op" id="5268522">==</span>&nbsp;<span class="ident" id="5268525">nil</span>&nbsp;<span class="op" id="5268529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268533">_</span><span class="op" id="5268534">,</span>&nbsp;<span class="ident" id="5268536">err</span>&nbsp;<span class="op" id="5268540">=</span>&nbsp;<span class="ident" id="5268542">e</span><span class="op" id="5268543">.</span><span class="ident" id="5268544">stringBytes</span><span class="op" id="5268555">(</span><span class="ident" id="5268556">b</span><span class="op" id="5268557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5268560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5268563">if</span>&nbsp;<span class="ident" id="5268566">err</span>&nbsp;<span class="op" id="5268570">!=</span>&nbsp;<span class="ident" id="5268573">nil</span>&nbsp;<span class="op" id="5268577">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268581">e</span><span class="op" id="5268582">.</span><span class="builtintype" id="5268583">error</span><span class="op" id="5268588">(</span><span class="op" id="5268589">&amp;</span><span class="ident" id="5268590">MarshalerError</span><span class="op" id="5268604">{</span><span class="ident" id="5268605">v</span><span class="op" id="5268606">.</span><span class="ident" id="5268607">Type</span><span class="op" id="5268611">(</span><span class="op" id="5268612">)</span><span class="op" id="5268613">,</span>&nbsp;<span class="ident" id="5268615">err</span><span class="op" id="5268618">}</span><span class="op" id="5268619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5268622">}</span><br>
<span class="lineno"></span><span class="op" id="5268624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5268627">func</span>&nbsp;<span class="ident" id="5268632">boolEncoder</span><span class="op" id="5268643">(</span><span class="ident" id="5268644">e</span>&nbsp;<span class="op" id="5268646">*</span><span class="ident" id="5268647">encodeState</span><span class="op" id="5268658">,</span>&nbsp;<span class="ident" id="5268660">v</span>&nbsp;<span class="ident" id="5268662">reflect</span><span class="op" id="5268669">.</span><span class="ident" id="5268670">Value</span><span class="op" id="5268675">,</span>&nbsp;<span class="ident" id="5268677">quoted</span>&nbsp;<span class="builtintype" id="5268684">bool</span><span class="op" id="5268688">)</span>&nbsp;<span class="op" id="5268690">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5268693">if</span>&nbsp;<span class="ident" id="5268696">quoted</span>&nbsp;<span class="op" id="5268703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268707">e</span><span class="op" id="5268708">.</span><span class="ident" id="5268709">WriteByte</span><span class="op" id="5268718">(</span><span class="string" id="5268719">&#39;&#34;&#39;</span><span class="op" id="5268722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5268725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5268728">if</span>&nbsp;<span class="ident" id="5268731">v</span><span class="op" id="5268732">.</span><span class="ident" id="5268733">Bool</span><span class="op" id="5268737">(</span><span class="op" id="5268738">)</span>&nbsp;<span class="op" id="5268740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268744">e</span><span class="op" id="5268745">.</span><span class="ident" id="5268746">WriteString</span><span class="op" id="5268757">(</span><span class="string" id="5268758">&#34;true&#34;</span><span class="op" id="5268764">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5268767">}</span>&nbsp;<span class="keyword" id="5268769">else</span>&nbsp;<span class="op" id="5268774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268778">e</span><span class="op" id="5268779">.</span><span class="ident" id="5268780">WriteString</span><span class="op" id="5268791">(</span><span class="string" id="5268792">&#34;false&#34;</span><span class="op" id="5268799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5268802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5268805">if</span>&nbsp;<span class="ident" id="5268808">quoted</span>&nbsp;<span class="op" id="5268815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268819">e</span><span class="op" id="5268820">.</span><span class="ident" id="5268821">WriteByte</span><span class="op" id="5268830">(</span><span class="string" id="5268831">&#39;&#34;&#39;</span><span class="op" id="5268834">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5268837">}</span><br>
<span class="lineno"></span><span class="op" id="5268839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5268842">func</span>&nbsp;<span class="ident" id="5268847">intEncoder</span><span class="op" id="5268857">(</span><span class="ident" id="5268858">e</span>&nbsp;<span class="op" id="5268860">*</span><span class="ident" id="5268861">encodeState</span><span class="op" id="5268872">,</span>&nbsp;<span class="ident" id="5268874">v</span>&nbsp;<span class="ident" id="5268876">reflect</span><span class="op" id="5268883">.</span><span class="ident" id="5268884">Value</span><span class="op" id="5268889">,</span>&nbsp;<span class="ident" id="5268891">quoted</span>&nbsp;<span class="builtintype" id="5268898">bool</span><span class="op" id="5268902">)</span>&nbsp;<span class="op" id="5268904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268907">b</span>&nbsp;<span class="op" id="5268909">:=</span>&nbsp;<span class="ident" id="5268912">strconv</span><span class="op" id="5268919">.</span><span class="ident" id="5268920">AppendInt</span><span class="op" id="5268929">(</span><span class="ident" id="5268930">e</span><span class="op" id="5268931">.</span><span class="ident" id="5268932">scratch</span><span class="op" id="5268939">[</span><span class="op" id="5268940">:</span><span class="num" id="5268941">0</span><span class="op" id="5268942">]</span><span class="op" id="5268943">,</span>&nbsp;<span class="ident" id="5268945">v</span><span class="op" id="5268946">.</span><span class="ident" id="5268947">Int</span><span class="op" id="5268950">(</span><span class="op" id="5268951">)</span><span class="op" id="5268952">,</span>&nbsp;<span class="num" id="5268954">10</span><span class="op" id="5268956">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5268959">if</span>&nbsp;<span class="ident" id="5268962">quoted</span>&nbsp;<span class="op" id="5268969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268973">e</span><span class="op" id="5268974">.</span><span class="ident" id="5268975">WriteByte</span><span class="op" id="5268984">(</span><span class="string" id="5268985">&#39;&#34;&#39;</span><span class="op" id="5268988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5268991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5268994">e</span><span class="op" id="5268995">.</span><span class="ident" id="5268996">Write</span><span class="op" id="5269001">(</span><span class="ident" id="5269002">b</span><span class="op" id="5269003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269006">if</span>&nbsp;<span class="ident" id="5269009">quoted</span>&nbsp;<span class="op" id="5269016">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269020">e</span><span class="op" id="5269021">.</span><span class="ident" id="5269022">WriteByte</span><span class="op" id="5269031">(</span><span class="string" id="5269032">&#39;&#34;&#39;</span><span class="op" id="5269035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5269038">}</span><br>
<span class="lineno"></span><span class="op" id="5269040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5269043">func</span>&nbsp;<span class="ident" id="5269048">uintEncoder</span><span class="op" id="5269059">(</span><span class="ident" id="5269060">e</span>&nbsp;<span class="op" id="5269062">*</span><span class="ident" id="5269063">encodeState</span><span class="op" id="5269074">,</span>&nbsp;<span class="ident" id="5269076">v</span>&nbsp;<span class="ident" id="5269078">reflect</span><span class="op" id="5269085">.</span><span class="ident" id="5269086">Value</span><span class="op" id="5269091">,</span>&nbsp;<span class="ident" id="5269093">quoted</span>&nbsp;<span class="builtintype" id="5269100">bool</span><span class="op" id="5269104">)</span>&nbsp;<span class="op" id="5269106">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269109">b</span>&nbsp;<span class="op" id="5269111">:=</span>&nbsp;<span class="ident" id="5269114">strconv</span><span class="op" id="5269121">.</span><span class="ident" id="5269122">AppendUint</span><span class="op" id="5269132">(</span><span class="ident" id="5269133">e</span><span class="op" id="5269134">.</span><span class="ident" id="5269135">scratch</span><span class="op" id="5269142">[</span><span class="op" id="5269143">:</span><span class="num" id="5269144">0</span><span class="op" id="5269145">]</span><span class="op" id="5269146">,</span>&nbsp;<span class="ident" id="5269148">v</span><span class="op" id="5269149">.</span><span class="ident" id="5269150">Uint</span><span class="op" id="5269154">(</span><span class="op" id="5269155">)</span><span class="op" id="5269156">,</span>&nbsp;<span class="num" id="5269158">10</span><span class="op" id="5269160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269163">if</span>&nbsp;<span class="ident" id="5269166">quoted</span>&nbsp;<span class="op" id="5269173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269177">e</span><span class="op" id="5269178">.</span><span class="ident" id="5269179">WriteByte</span><span class="op" id="5269188">(</span><span class="string" id="5269189">&#39;&#34;&#39;</span><span class="op" id="5269192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5269195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269198">e</span><span class="op" id="5269199">.</span><span class="ident" id="5269200">Write</span><span class="op" id="5269205">(</span><span class="ident" id="5269206">b</span><span class="op" id="5269207">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269210">if</span>&nbsp;<span class="ident" id="5269213">quoted</span>&nbsp;<span class="op" id="5269220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269224">e</span><span class="op" id="5269225">.</span><span class="ident" id="5269226">WriteByte</span><span class="op" id="5269235">(</span><span class="string" id="5269236">&#39;&#34;&#39;</span><span class="op" id="5269239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5269242">}</span><br>
<span class="lineno"></span><span class="op" id="5269244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="5269247">type</span>&nbsp;<span class="ident" id="5269252">floatEncoder</span>&nbsp;<span class="builtintype" id="5269265">int</span>&nbsp;<span class="comment" id="5269269">//&nbsp;number&nbsp;of&nbsp;bits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5269288">func</span>&nbsp;<span class="op" id="5269293">(</span><span class="ident" id="5269294">bits</span>&nbsp;<span class="ident" id="5269299">floatEncoder</span><span class="op" id="5269311">)</span>&nbsp;<span class="ident" id="5269313">encode</span><span class="op" id="5269319">(</span><span class="ident" id="5269320">e</span>&nbsp;<span class="op" id="5269322">*</span><span class="ident" id="5269323">encodeState</span><span class="op" id="5269334">,</span>&nbsp;<span class="ident" id="5269336">v</span>&nbsp;<span class="ident" id="5269338">reflect</span><span class="op" id="5269345">.</span><span class="ident" id="5269346">Value</span><span class="op" id="5269351">,</span>&nbsp;<span class="ident" id="5269353">quoted</span>&nbsp;<span class="builtintype" id="5269360">bool</span><span class="op" id="5269364">)</span>&nbsp;<span class="op" id="5269366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269369">f</span>&nbsp;<span class="op" id="5269371">:=</span>&nbsp;<span class="ident" id="5269374">v</span><span class="op" id="5269375">.</span><span class="ident" id="5269376">Float</span><span class="op" id="5269381">(</span><span class="op" id="5269382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269385">if</span>&nbsp;<span class="ident" id="5269388">math</span><span class="op" id="5269392">.</span><span class="ident" id="5269393">IsInf</span><span class="op" id="5269398">(</span><span class="ident" id="5269399">f</span><span class="op" id="5269400">,</span>&nbsp;<span class="num" id="5269402">0</span><span class="op" id="5269403">)</span>&nbsp;<span class="op" id="5269405">||</span>&nbsp;<span class="ident" id="5269408">math</span><span class="op" id="5269412">.</span><span class="ident" id="5269413">IsNaN</span><span class="op" id="5269418">(</span><span class="ident" id="5269419">f</span><span class="op" id="5269420">)</span>&nbsp;<span class="op" id="5269422">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269426">e</span><span class="op" id="5269427">.</span><span class="builtintype" id="5269428">error</span><span class="op" id="5269433">(</span><span class="op" id="5269434">&amp;</span><span class="ident" id="5269435">UnsupportedValueError</span><span class="op" id="5269456">{</span><span class="ident" id="5269457">v</span><span class="op" id="5269458">,</span>&nbsp;<span class="ident" id="5269460">strconv</span><span class="op" id="5269467">.</span><span class="ident" id="5269468">FormatFloat</span><span class="op" id="5269479">(</span><span class="ident" id="5269480">f</span><span class="op" id="5269481">,</span>&nbsp;<span class="string" id="5269483">&#39;g&#39;</span><span class="op" id="5269486">,</span>&nbsp;<span class="op" id="5269488">-</span><span class="num" id="5269489">1</span><span class="op" id="5269490">,</span>&nbsp;<span class="builtintype" id="5269492">int</span><span class="op" id="5269495">(</span><span class="ident" id="5269496">bits</span><span class="op" id="5269500">)</span><span class="op" id="5269501">)</span><span class="op" id="5269502">}</span><span class="op" id="5269503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5269506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269509">b</span>&nbsp;<span class="op" id="5269511">:=</span>&nbsp;<span class="ident" id="5269514">strconv</span><span class="op" id="5269521">.</span><span class="ident" id="5269522">AppendFloat</span><span class="op" id="5269533">(</span><span class="ident" id="5269534">e</span><span class="op" id="5269535">.</span><span class="ident" id="5269536">scratch</span><span class="op" id="5269543">[</span><span class="op" id="5269544">:</span><span class="num" id="5269545">0</span><span class="op" id="5269546">]</span><span class="op" id="5269547">,</span>&nbsp;<span class="ident" id="5269549">f</span><span class="op" id="5269550">,</span>&nbsp;<span class="string" id="5269552">&#39;g&#39;</span><span class="op" id="5269555">,</span>&nbsp;<span class="op" id="5269557">-</span><span class="num" id="5269558">1</span><span class="op" id="5269559">,</span>&nbsp;<span class="builtintype" id="5269561">int</span><span class="op" id="5269564">(</span><span class="ident" id="5269565">bits</span><span class="op" id="5269569">)</span><span class="op" id="5269570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269573">if</span>&nbsp;<span class="ident" id="5269576">quoted</span>&nbsp;<span class="op" id="5269583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269587">e</span><span class="op" id="5269588">.</span><span class="ident" id="5269589">WriteByte</span><span class="op" id="5269598">(</span><span class="string" id="5269599">&#39;&#34;&#39;</span><span class="op" id="5269602">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5269605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269608">e</span><span class="op" id="5269609">.</span><span class="ident" id="5269610">Write</span><span class="op" id="5269615">(</span><span class="ident" id="5269616">b</span><span class="op" id="5269617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269620">if</span>&nbsp;<span class="ident" id="5269623">quoted</span>&nbsp;<span class="op" id="5269630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269634">e</span><span class="op" id="5269635">.</span><span class="ident" id="5269636">WriteByte</span><span class="op" id="5269645">(</span><span class="string" id="5269646">&#39;&#34;&#39;</span><span class="op" id="5269649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5269652">}</span><br>
<span class="lineno">525</span><span class="op" id="5269654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5269657">var</span>&nbsp;<span class="op" id="5269661">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269664">float32Encoder</span>&nbsp;<span class="op" id="5269679">=</span>&nbsp;<span class="op" id="5269681">(</span><span class="ident" id="5269682">floatEncoder</span><span class="op" id="5269694">(</span><span class="num" id="5269695">32</span><span class="op" id="5269697">)</span><span class="op" id="5269698">)</span><span class="op" id="5269699">.</span><span class="ident" id="5269700">encode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269708">float64Encoder</span>&nbsp;<span class="op" id="5269723">=</span>&nbsp;<span class="op" id="5269725">(</span><span class="ident" id="5269726">floatEncoder</span><span class="op" id="5269738">(</span><span class="num" id="5269739">64</span><span class="op" id="5269741">)</span><span class="op" id="5269742">)</span><span class="op" id="5269743">.</span><span class="ident" id="5269744">encode</span><br>
<span class="lineno">530</span><span class="op" id="5269751">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5269754">func</span>&nbsp;<span class="ident" id="5269759">stringEncoder</span><span class="op" id="5269772">(</span><span class="ident" id="5269773">e</span>&nbsp;<span class="op" id="5269775">*</span><span class="ident" id="5269776">encodeState</span><span class="op" id="5269787">,</span>&nbsp;<span class="ident" id="5269789">v</span>&nbsp;<span class="ident" id="5269791">reflect</span><span class="op" id="5269798">.</span><span class="ident" id="5269799">Value</span><span class="op" id="5269804">,</span>&nbsp;<span class="ident" id="5269806">quoted</span>&nbsp;<span class="builtintype" id="5269813">bool</span><span class="op" id="5269817">)</span>&nbsp;<span class="op" id="5269819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269822">if</span>&nbsp;<span class="ident" id="5269825">v</span><span class="op" id="5269826">.</span><span class="ident" id="5269827">Type</span><span class="op" id="5269831">(</span><span class="op" id="5269832">)</span>&nbsp;<span class="op" id="5269834">==</span>&nbsp;<span class="ident" id="5269837">numberType</span>&nbsp;<span class="op" id="5269848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269852">numStr</span>&nbsp;<span class="op" id="5269859">:=</span>&nbsp;<span class="ident" id="5269862">v</span><span class="op" id="5269863">.</span><span class="ident" id="5269864">String</span><span class="op" id="5269870">(</span><span class="op" id="5269871">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269875">if</span>&nbsp;<span class="ident" id="5269878">numStr</span>&nbsp;<span class="op" id="5269885">==</span>&nbsp;<span class="string" id="5269888">&#34;&#34;</span>&nbsp;<span class="op" id="5269891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269896">numStr</span>&nbsp;<span class="op" id="5269903">=</span>&nbsp;<span class="string" id="5269905">&#34;0&#34;</span>&nbsp;<span class="comment" id="5269909">//&nbsp;Number&#39;s&nbsp;zero-val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5269932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269936">e</span><span class="op" id="5269937">.</span><span class="ident" id="5269938">WriteString</span><span class="op" id="5269949">(</span><span class="ident" id="5269950">numStr</span><span class="op" id="5269956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269960">return</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5269968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5269971">if</span>&nbsp;<span class="ident" id="5269974">quoted</span>&nbsp;<span class="op" id="5269981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5269985">sb</span><span class="op" id="5269987">,</span>&nbsp;<span class="ident" id="5269989">err</span>&nbsp;<span class="op" id="5269993">:=</span>&nbsp;<span class="ident" id="5269996">Marshal</span><span class="op" id="5270003">(</span><span class="ident" id="5270004">v</span><span class="op" id="5270005">.</span><span class="ident" id="5270006">String</span><span class="op" id="5270012">(</span><span class="op" id="5270013">)</span><span class="op" id="5270014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5270018">if</span>&nbsp;<span class="ident" id="5270021">err</span>&nbsp;<span class="op" id="5270025">!=</span>&nbsp;<span class="ident" id="5270028">nil</span>&nbsp;<span class="op" id="5270032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270037">e</span><span class="op" id="5270038">.</span><span class="builtintype" id="5270039">error</span><span class="op" id="5270044">(</span><span class="ident" id="5270045">err</span><span class="op" id="5270048">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5270052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270056">e</span><span class="op" id="5270057">.</span><span class="builtintype" id="5270058">string</span><span class="op" id="5270064">(</span><span class="builtintype" id="5270065">string</span><span class="op" id="5270071">(</span><span class="ident" id="5270072">sb</span><span class="op" id="5270074">)</span><span class="op" id="5270075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5270078">}</span>&nbsp;<span class="keyword" id="5270080">else</span>&nbsp;<span class="op" id="5270085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270089">e</span><span class="op" id="5270090">.</span><span class="builtintype" id="5270091">string</span><span class="op" id="5270097">(</span><span class="ident" id="5270098">v</span><span class="op" id="5270099">.</span><span class="ident" id="5270100">String</span><span class="op" id="5270106">(</span><span class="op" id="5270107">)</span><span class="op" id="5270108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5270111">}</span><br>
<span class="lineno">550</span><span class="op" id="5270113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5270116">func</span>&nbsp;<span class="ident" id="5270121">interfaceEncoder</span><span class="op" id="5270137">(</span><span class="ident" id="5270138">e</span>&nbsp;<span class="op" id="5270140">*</span><span class="ident" id="5270141">encodeState</span><span class="op" id="5270152">,</span>&nbsp;<span class="ident" id="5270154">v</span>&nbsp;<span class="ident" id="5270156">reflect</span><span class="op" id="5270163">.</span><span class="ident" id="5270164">Value</span><span class="op" id="5270169">,</span>&nbsp;<span class="ident" id="5270171">quoted</span>&nbsp;<span class="builtintype" id="5270178">bool</span><span class="op" id="5270182">)</span>&nbsp;<span class="op" id="5270184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5270187">if</span>&nbsp;<span class="ident" id="5270190">v</span><span class="op" id="5270191">.</span><span class="ident" id="5270192">IsNil</span><span class="op" id="5270197">(</span><span class="op" id="5270198">)</span>&nbsp;<span class="op" id="5270200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270204">e</span><span class="op" id="5270205">.</span><span class="ident" id="5270206">WriteString</span><span class="op" id="5270217">(</span><span class="string" id="5270218">&#34;null&#34;</span><span class="op" id="5270224">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5270228">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5270236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270239">e</span><span class="op" id="5270240">.</span><span class="ident" id="5270241">reflectValue</span><span class="op" id="5270253">(</span><span class="ident" id="5270254">v</span><span class="op" id="5270255">.</span><span class="ident" id="5270256">Elem</span><span class="op" id="5270260">(</span><span class="op" id="5270261">)</span><span class="op" id="5270262">)</span><br>
<span class="lineno"></span><span class="op" id="5270264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">560</span><span class="keyword" id="5270267">func</span>&nbsp;<span class="ident" id="5270272">unsupportedTypeEncoder</span><span class="op" id="5270294">(</span><span class="ident" id="5270295">e</span>&nbsp;<span class="op" id="5270297">*</span><span class="ident" id="5270298">encodeState</span><span class="op" id="5270309">,</span>&nbsp;<span class="ident" id="5270311">v</span>&nbsp;<span class="ident" id="5270313">reflect</span><span class="op" id="5270320">.</span><span class="ident" id="5270321">Value</span><span class="op" id="5270326">,</span>&nbsp;<span class="ident" id="5270328">quoted</span>&nbsp;<span class="builtintype" id="5270335">bool</span><span class="op" id="5270339">)</span>&nbsp;<span class="op" id="5270341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270344">e</span><span class="op" id="5270345">.</span><span class="builtintype" id="5270346">error</span><span class="op" id="5270351">(</span><span class="op" id="5270352">&amp;</span><span class="ident" id="5270353">UnsupportedTypeError</span><span class="op" id="5270373">{</span><span class="ident" id="5270374">v</span><span class="op" id="5270375">.</span><span class="ident" id="5270376">Type</span><span class="op" id="5270380">(</span><span class="op" id="5270381">)</span><span class="op" id="5270382">}</span><span class="op" id="5270383">)</span><br>
<span class="lineno"></span><span class="op" id="5270385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5270388">type</span>&nbsp;<span class="ident" id="5270393">structEncoder</span>&nbsp;<span class="keyword" id="5270407">struct</span>&nbsp;<span class="op" id="5270414">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270417">fields</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5270427">[</span><span class="op" id="5270428">]</span><span class="ident" id="5270429">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270436">fieldEncs</span>&nbsp;<span class="op" id="5270446">[</span><span class="op" id="5270447">]</span><span class="ident" id="5270448">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="5270460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5270463">func</span>&nbsp;<span class="op" id="5270468">(</span><span class="ident" id="5270469">se</span>&nbsp;<span class="op" id="5270472">*</span><span class="ident" id="5270473">structEncoder</span><span class="op" id="5270486">)</span>&nbsp;<span class="ident" id="5270488">encode</span><span class="op" id="5270494">(</span><span class="ident" id="5270495">e</span>&nbsp;<span class="op" id="5270497">*</span><span class="ident" id="5270498">encodeState</span><span class="op" id="5270509">,</span>&nbsp;<span class="ident" id="5270511">v</span>&nbsp;<span class="ident" id="5270513">reflect</span><span class="op" id="5270520">.</span><span class="ident" id="5270521">Value</span><span class="op" id="5270526">,</span>&nbsp;<span class="ident" id="5270528">quoted</span>&nbsp;<span class="builtintype" id="5270535">bool</span><span class="op" id="5270539">)</span>&nbsp;<span class="op" id="5270541">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270544">e</span><span class="op" id="5270545">.</span><span class="ident" id="5270546">WriteByte</span><span class="op" id="5270555">(</span><span class="string" id="5270556">&#39;{&#39;</span><span class="op" id="5270559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270562">first</span>&nbsp;<span class="op" id="5270568">:=</span>&nbsp;<span class="builtintype" id="5270571">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5270577">for</span>&nbsp;<span class="ident" id="5270581">i</span><span class="op" id="5270582">,</span>&nbsp;<span class="ident" id="5270584">f</span>&nbsp;<span class="op" id="5270586">:=</span>&nbsp;<span class="keyword" id="5270589">range</span>&nbsp;<span class="ident" id="5270595">se</span><span class="op" id="5270597">.</span><span class="ident" id="5270598">fields</span>&nbsp;<span class="op" id="5270605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270609">fv</span>&nbsp;<span class="op" id="5270612">:=</span>&nbsp;<span class="ident" id="5270615">fieldByIndex</span><span class="op" id="5270627">(</span><span class="ident" id="5270628">v</span><span class="op" id="5270629">,</span>&nbsp;<span class="ident" id="5270631">f</span><span class="op" id="5270632">.</span><span class="ident" id="5270633">index</span><span class="op" id="5270638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5270642">if</span>&nbsp;<span class="op" id="5270645">!</span><span class="ident" id="5270646">fv</span><span class="op" id="5270648">.</span><span class="ident" id="5270649">IsValid</span><span class="op" id="5270656">(</span><span class="op" id="5270657">)</span>&nbsp;<span class="op" id="5270659">||</span>&nbsp;<span class="ident" id="5270662">f</span><span class="op" id="5270663">.</span><span class="ident" id="5270664">omitEmpty</span>&nbsp;<span class="op" id="5270674">&amp;&amp;</span>&nbsp;<span class="ident" id="5270677">isEmptyValue</span><span class="op" id="5270689">(</span><span class="ident" id="5270690">fv</span><span class="op" id="5270692">)</span>&nbsp;<span class="op" id="5270694">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5270699">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5270710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5270714">if</span>&nbsp;<span class="ident" id="5270717">first</span>&nbsp;<span class="op" id="5270723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270728">first</span>&nbsp;<span class="op" id="5270734">=</span>&nbsp;<span class="builtintype" id="5270736">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5270744">}</span>&nbsp;<span class="keyword" id="5270746">else</span>&nbsp;<span class="op" id="5270751">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270756">e</span><span class="op" id="5270757">.</span><span class="ident" id="5270758">WriteByte</span><span class="op" id="5270767">(</span><span class="string" id="5270768">&#39;,&#39;</span><span class="op" id="5270771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5270775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270779">e</span><span class="op" id="5270780">.</span><span class="builtintype" id="5270781">string</span><span class="op" id="5270787">(</span><span class="ident" id="5270788">f</span><span class="op" id="5270789">.</span><span class="ident" id="5270790">name</span><span class="op" id="5270794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270798">e</span><span class="op" id="5270799">.</span><span class="ident" id="5270800">WriteByte</span><span class="op" id="5270809">(</span><span class="string" id="5270810">&#39;:&#39;</span><span class="op" id="5270813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270817">se</span><span class="op" id="5270819">.</span><span class="ident" id="5270820">fieldEncs</span><span class="op" id="5270829">[</span><span class="ident" id="5270830">i</span><span class="op" id="5270831">]</span><span class="op" id="5270832">(</span><span class="ident" id="5270833">e</span><span class="op" id="5270834">,</span>&nbsp;<span class="ident" id="5270836">fv</span><span class="op" id="5270838">,</span>&nbsp;<span class="ident" id="5270840">f</span><span class="op" id="5270841">.</span><span class="ident" id="5270842">quoted</span><span class="op" id="5270848">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5270851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270854">e</span><span class="op" id="5270855">.</span><span class="ident" id="5270856">WriteByte</span><span class="op" id="5270865">(</span><span class="string" id="5270866">&#39;}&#39;</span><span class="op" id="5270869">)</span><br>
<span class="lineno"></span><span class="op" id="5270871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5270874">func</span>&nbsp;<span class="ident" id="5270879">newStructEncoder</span><span class="op" id="5270895">(</span><span class="ident" id="5270896">t</span>&nbsp;<span class="ident" id="5270898">reflect</span><span class="op" id="5270905">.</span><span class="ident" id="5270906">Type</span><span class="op" id="5270910">)</span>&nbsp;<span class="ident" id="5270912">encoderFunc</span>&nbsp;<span class="op" id="5270924">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270927">fields</span>&nbsp;<span class="op" id="5270934">:=</span>&nbsp;<span class="ident" id="5270937">cachedTypeFields</span><span class="op" id="5270953">(</span><span class="ident" id="5270954">t</span><span class="op" id="5270955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270958">se</span>&nbsp;<span class="op" id="5270961">:=</span>&nbsp;<span class="op" id="5270964">&amp;</span><span class="ident" id="5270965">structEncoder</span><span class="op" id="5270978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5270982">fields</span><span class="op" id="5270988">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5270993">fields</span><span class="op" id="5270999">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271003">fieldEncs</span><span class="op" id="5271012">:</span>&nbsp;<span class="builtinfunc" id="5271014">make</span><span class="op" id="5271018">(</span><span class="op" id="5271019">[</span><span class="op" id="5271020">]</span><span class="ident" id="5271021">encoderFunc</span><span class="op" id="5271032">,</span>&nbsp;<span class="builtinfunc" id="5271034">len</span><span class="op" id="5271037">(</span><span class="ident" id="5271038">fields</span><span class="op" id="5271044">)</span><span class="op" id="5271045">)</span><span class="op" id="5271046">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5271049">}</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271052">for</span>&nbsp;<span class="ident" id="5271056">i</span><span class="op" id="5271057">,</span>&nbsp;<span class="ident" id="5271059">f</span>&nbsp;<span class="op" id="5271061">:=</span>&nbsp;<span class="keyword" id="5271064">range</span>&nbsp;<span class="ident" id="5271070">fields</span>&nbsp;<span class="op" id="5271077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271081">se</span><span class="op" id="5271083">.</span><span class="ident" id="5271084">fieldEncs</span><span class="op" id="5271093">[</span><span class="ident" id="5271094">i</span><span class="op" id="5271095">]</span>&nbsp;<span class="op" id="5271097">=</span>&nbsp;<span class="ident" id="5271099">typeEncoder</span><span class="op" id="5271110">(</span><span class="ident" id="5271111">typeByIndex</span><span class="op" id="5271122">(</span><span class="ident" id="5271123">t</span><span class="op" id="5271124">,</span>&nbsp;<span class="ident" id="5271126">f</span><span class="op" id="5271127">.</span><span class="ident" id="5271128">index</span><span class="op" id="5271133">)</span><span class="op" id="5271134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5271137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271140">return</span>&nbsp;<span class="ident" id="5271147">se</span><span class="op" id="5271149">.</span><span class="ident" id="5271150">encode</span><br>
<span class="lineno"></span><span class="op" id="5271157">}</span><br>
<span class="lineno">600</span><br>
<span class="lineno"></span><span class="keyword" id="5271160">type</span>&nbsp;<span class="ident" id="5271165">mapEncoder</span>&nbsp;<span class="keyword" id="5271176">struct</span>&nbsp;<span class="op" id="5271183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271186">elemEnc</span>&nbsp;<span class="ident" id="5271194">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="5271206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">605</span><span class="keyword" id="5271209">func</span>&nbsp;<span class="op" id="5271214">(</span><span class="ident" id="5271215">me</span>&nbsp;<span class="op" id="5271218">*</span><span class="ident" id="5271219">mapEncoder</span><span class="op" id="5271229">)</span>&nbsp;<span class="ident" id="5271231">encode</span><span class="op" id="5271237">(</span><span class="ident" id="5271238">e</span>&nbsp;<span class="op" id="5271240">*</span><span class="ident" id="5271241">encodeState</span><span class="op" id="5271252">,</span>&nbsp;<span class="ident" id="5271254">v</span>&nbsp;<span class="ident" id="5271256">reflect</span><span class="op" id="5271263">.</span><span class="ident" id="5271264">Value</span><span class="op" id="5271269">,</span>&nbsp;<span class="ident" id="5271271">_</span>&nbsp;<span class="builtintype" id="5271273">bool</span><span class="op" id="5271277">)</span>&nbsp;<span class="op" id="5271279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271282">if</span>&nbsp;<span class="ident" id="5271285">v</span><span class="op" id="5271286">.</span><span class="ident" id="5271287">IsNil</span><span class="op" id="5271292">(</span><span class="op" id="5271293">)</span>&nbsp;<span class="op" id="5271295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271299">e</span><span class="op" id="5271300">.</span><span class="ident" id="5271301">WriteString</span><span class="op" id="5271312">(</span><span class="string" id="5271313">&#34;null&#34;</span><span class="op" id="5271319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271323">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5271331">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271334">e</span><span class="op" id="5271335">.</span><span class="ident" id="5271336">WriteByte</span><span class="op" id="5271345">(</span><span class="string" id="5271346">&#39;{&#39;</span><span class="op" id="5271349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271352">var</span>&nbsp;<span class="ident" id="5271356">sv</span>&nbsp;<span class="ident" id="5271359">stringValues</span>&nbsp;<span class="op" id="5271372">=</span>&nbsp;<span class="ident" id="5271374">v</span><span class="op" id="5271375">.</span><span class="ident" id="5271376">MapKeys</span><span class="op" id="5271383">(</span><span class="op" id="5271384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271387">sort</span><span class="op" id="5271391">.</span><span class="ident" id="5271392">Sort</span><span class="op" id="5271396">(</span><span class="ident" id="5271397">sv</span><span class="op" id="5271399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271402">for</span>&nbsp;<span class="ident" id="5271406">i</span><span class="op" id="5271407">,</span>&nbsp;<span class="ident" id="5271409">k</span>&nbsp;<span class="op" id="5271411">:=</span>&nbsp;<span class="keyword" id="5271414">range</span>&nbsp;<span class="ident" id="5271420">sv</span>&nbsp;<span class="op" id="5271423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271427">if</span>&nbsp;<span class="ident" id="5271430">i</span>&nbsp;<span class="op" id="5271432">&gt;</span>&nbsp;<span class="num" id="5271434">0</span>&nbsp;<span class="op" id="5271436">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271441">e</span><span class="op" id="5271442">.</span><span class="ident" id="5271443">WriteByte</span><span class="op" id="5271452">(</span><span class="string" id="5271453">&#39;,&#39;</span><span class="op" id="5271456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5271460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271464">e</span><span class="op" id="5271465">.</span><span class="builtintype" id="5271466">string</span><span class="op" id="5271472">(</span><span class="ident" id="5271473">k</span><span class="op" id="5271474">.</span><span class="ident" id="5271475">String</span><span class="op" id="5271481">(</span><span class="op" id="5271482">)</span><span class="op" id="5271483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271487">e</span><span class="op" id="5271488">.</span><span class="ident" id="5271489">WriteByte</span><span class="op" id="5271498">(</span><span class="string" id="5271499">&#39;:&#39;</span><span class="op" id="5271502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271506">me</span><span class="op" id="5271508">.</span><span class="ident" id="5271509">elemEnc</span><span class="op" id="5271516">(</span><span class="ident" id="5271517">e</span><span class="op" id="5271518">,</span>&nbsp;<span class="ident" id="5271520">v</span><span class="op" id="5271521">.</span><span class="ident" id="5271522">MapIndex</span><span class="op" id="5271530">(</span><span class="ident" id="5271531">k</span><span class="op" id="5271532">)</span><span class="op" id="5271533">,</span>&nbsp;<span class="builtintype" id="5271535">false</span><span class="op" id="5271540">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5271543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271546">e</span><span class="op" id="5271547">.</span><span class="ident" id="5271548">WriteByte</span><span class="op" id="5271557">(</span><span class="string" id="5271558">&#39;}&#39;</span><span class="op" id="5271561">)</span><br>
<span class="lineno"></span><span class="op" id="5271563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5271566">func</span>&nbsp;<span class="ident" id="5271571">newMapEncoder</span><span class="op" id="5271584">(</span><span class="ident" id="5271585">t</span>&nbsp;<span class="ident" id="5271587">reflect</span><span class="op" id="5271594">.</span><span class="ident" id="5271595">Type</span><span class="op" id="5271599">)</span>&nbsp;<span class="ident" id="5271601">encoderFunc</span>&nbsp;<span class="op" id="5271613">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271616">if</span>&nbsp;<span class="ident" id="5271619">t</span><span class="op" id="5271620">.</span><span class="ident" id="5271621">Key</span><span class="op" id="5271624">(</span><span class="op" id="5271625">)</span><span class="op" id="5271626">.</span><span class="ident" id="5271627">Kind</span><span class="op" id="5271631">(</span><span class="op" id="5271632">)</span>&nbsp;<span class="op" id="5271634">!=</span>&nbsp;<span class="ident" id="5271637">reflect</span><span class="op" id="5271644">.</span><span class="ident" id="5271645">String</span>&nbsp;<span class="op" id="5271652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271656">return</span>&nbsp;<span class="ident" id="5271663">unsupportedTypeEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5271687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271690">me</span>&nbsp;<span class="op" id="5271693">:=</span>&nbsp;<span class="op" id="5271696">&amp;</span><span class="ident" id="5271697">mapEncoder</span><span class="op" id="5271707">{</span><span class="ident" id="5271708">typeEncoder</span><span class="op" id="5271719">(</span><span class="ident" id="5271720">t</span><span class="op" id="5271721">.</span><span class="ident" id="5271722">Elem</span><span class="op" id="5271726">(</span><span class="op" id="5271727">)</span><span class="op" id="5271728">)</span><span class="op" id="5271729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271732">return</span>&nbsp;<span class="ident" id="5271739">me</span><span class="op" id="5271741">.</span><span class="ident" id="5271742">encode</span><br>
<span class="lineno">630</span><span class="op" id="5271749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5271752">func</span>&nbsp;<span class="ident" id="5271757">encodeByteSlice</span><span class="op" id="5271772">(</span><span class="ident" id="5271773">e</span>&nbsp;<span class="op" id="5271775">*</span><span class="ident" id="5271776">encodeState</span><span class="op" id="5271787">,</span>&nbsp;<span class="ident" id="5271789">v</span>&nbsp;<span class="ident" id="5271791">reflect</span><span class="op" id="5271798">.</span><span class="ident" id="5271799">Value</span><span class="op" id="5271804">,</span>&nbsp;<span class="ident" id="5271806">_</span>&nbsp;<span class="builtintype" id="5271808">bool</span><span class="op" id="5271812">)</span>&nbsp;<span class="op" id="5271814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271817">if</span>&nbsp;<span class="ident" id="5271820">v</span><span class="op" id="5271821">.</span><span class="ident" id="5271822">IsNil</span><span class="op" id="5271827">(</span><span class="op" id="5271828">)</span>&nbsp;<span class="op" id="5271830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271834">e</span><span class="op" id="5271835">.</span><span class="ident" id="5271836">WriteString</span><span class="op" id="5271847">(</span><span class="string" id="5271848">&#34;null&#34;</span><span class="op" id="5271854">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271858">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5271866">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271869">s</span>&nbsp;<span class="op" id="5271871">:=</span>&nbsp;<span class="ident" id="5271874">v</span><span class="op" id="5271875">.</span><span class="ident" id="5271876">Bytes</span><span class="op" id="5271881">(</span><span class="op" id="5271882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271885">e</span><span class="op" id="5271886">.</span><span class="ident" id="5271887">WriteByte</span><span class="op" id="5271896">(</span><span class="string" id="5271897">&#39;&#34;&#39;</span><span class="op" id="5271900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5271903">if</span>&nbsp;<span class="builtinfunc" id="5271906">len</span><span class="op" id="5271909">(</span><span class="ident" id="5271910">s</span><span class="op" id="5271911">)</span>&nbsp;<span class="op" id="5271913">&lt;</span>&nbsp;<span class="num" id="5271915">1024</span>&nbsp;<span class="op" id="5271920">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5271924">//&nbsp;for&nbsp;small&nbsp;buffers,&nbsp;using&nbsp;Encode&nbsp;directly&nbsp;is&nbsp;much&nbsp;faster.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5271986">dst</span>&nbsp;<span class="op" id="5271990">:=</span>&nbsp;<span class="builtinfunc" id="5271993">make</span><span class="op" id="5271997">(</span><span class="op" id="5271998">[</span><span class="op" id="5271999">]</span><span class="builtintype" id="5272000">byte</span><span class="op" id="5272004">,</span>&nbsp;<span class="ident" id="5272006">base64</span><span class="op" id="5272012">.</span><span class="ident" id="5272013">StdEncoding</span><span class="op" id="5272024">.</span><span class="ident" id="5272025">EncodedLen</span><span class="op" id="5272035">(</span><span class="builtinfunc" id="5272036">len</span><span class="op" id="5272039">(</span><span class="ident" id="5272040">s</span><span class="op" id="5272041">)</span><span class="op" id="5272042">)</span><span class="op" id="5272043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272047">base64</span><span class="op" id="5272053">.</span><span class="ident" id="5272054">StdEncoding</span><span class="op" id="5272065">.</span><span class="ident" id="5272066">Encode</span><span class="op" id="5272072">(</span><span class="ident" id="5272073">dst</span><span class="op" id="5272076">,</span>&nbsp;<span class="ident" id="5272078">s</span><span class="op" id="5272079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272083">e</span><span class="op" id="5272084">.</span><span class="ident" id="5272085">Write</span><span class="op" id="5272090">(</span><span class="ident" id="5272091">dst</span><span class="op" id="5272094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5272097">}</span>&nbsp;<span class="keyword" id="5272099">else</span>&nbsp;<span class="op" id="5272104">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5272108">//&nbsp;for&nbsp;large&nbsp;buffers,&nbsp;avoid&nbsp;unnecessary&nbsp;extra&nbsp;temporary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5272166">//&nbsp;buffer&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272185">enc</span>&nbsp;<span class="op" id="5272189">:=</span>&nbsp;<span class="ident" id="5272192">base64</span><span class="op" id="5272198">.</span><span class="ident" id="5272199">NewEncoder</span><span class="op" id="5272209">(</span><span class="ident" id="5272210">base64</span><span class="op" id="5272216">.</span><span class="ident" id="5272217">StdEncoding</span><span class="op" id="5272228">,</span>&nbsp;<span class="ident" id="5272230">e</span><span class="op" id="5272231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272235">enc</span><span class="op" id="5272238">.</span><span class="ident" id="5272239">Write</span><span class="op" id="5272244">(</span><span class="ident" id="5272245">s</span><span class="op" id="5272246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272250">enc</span><span class="op" id="5272253">.</span><span class="ident" id="5272254">Close</span><span class="op" id="5272259">(</span><span class="op" id="5272260">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5272263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272266">e</span><span class="op" id="5272267">.</span><span class="ident" id="5272268">WriteByte</span><span class="op" id="5272277">(</span><span class="string" id="5272278">&#39;&#34;&#39;</span><span class="op" id="5272281">)</span><br>
<span class="lineno"></span><span class="op" id="5272283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5272286">//&nbsp;sliceEncoder&nbsp;just&nbsp;wraps&nbsp;an&nbsp;arrayEncoder,&nbsp;checking&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;value&nbsp;isn&#39;t&nbsp;nil.</span><br>
<span class="lineno">655</span><span class="keyword" id="5272373">type</span>&nbsp;<span class="ident" id="5272378">sliceEncoder</span>&nbsp;<span class="keyword" id="5272391">struct</span>&nbsp;<span class="op" id="5272398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272401">arrayEnc</span>&nbsp;<span class="ident" id="5272410">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="5272422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5272425">func</span>&nbsp;<span class="op" id="5272430">(</span><span class="ident" id="5272431">se</span>&nbsp;<span class="op" id="5272434">*</span><span class="ident" id="5272435">sliceEncoder</span><span class="op" id="5272447">)</span>&nbsp;<span class="ident" id="5272449">encode</span><span class="op" id="5272455">(</span><span class="ident" id="5272456">e</span>&nbsp;<span class="op" id="5272458">*</span><span class="ident" id="5272459">encodeState</span><span class="op" id="5272470">,</span>&nbsp;<span class="ident" id="5272472">v</span>&nbsp;<span class="ident" id="5272474">reflect</span><span class="op" id="5272481">.</span><span class="ident" id="5272482">Value</span><span class="op" id="5272487">,</span>&nbsp;<span class="ident" id="5272489">_</span>&nbsp;<span class="builtintype" id="5272491">bool</span><span class="op" id="5272495">)</span>&nbsp;<span class="op" id="5272497">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5272500">if</span>&nbsp;<span class="ident" id="5272503">v</span><span class="op" id="5272504">.</span><span class="ident" id="5272505">IsNil</span><span class="op" id="5272510">(</span><span class="op" id="5272511">)</span>&nbsp;<span class="op" id="5272513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272517">e</span><span class="op" id="5272518">.</span><span class="ident" id="5272519">WriteString</span><span class="op" id="5272530">(</span><span class="string" id="5272531">&#34;null&#34;</span><span class="op" id="5272537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5272541">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5272549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272552">se</span><span class="op" id="5272554">.</span><span class="ident" id="5272555">arrayEnc</span><span class="op" id="5272563">(</span><span class="ident" id="5272564">e</span><span class="op" id="5272565">,</span>&nbsp;<span class="ident" id="5272567">v</span><span class="op" id="5272568">,</span>&nbsp;<span class="builtintype" id="5272570">false</span><span class="op" id="5272575">)</span><br>
<span class="lineno">665</span><span class="op" id="5272577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5272580">func</span>&nbsp;<span class="ident" id="5272585">newSliceEncoder</span><span class="op" id="5272600">(</span><span class="ident" id="5272601">t</span>&nbsp;<span class="ident" id="5272603">reflect</span><span class="op" id="5272610">.</span><span class="ident" id="5272611">Type</span><span class="op" id="5272615">)</span>&nbsp;<span class="ident" id="5272617">encoderFunc</span>&nbsp;<span class="op" id="5272629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5272632">//&nbsp;Byte&nbsp;slices&nbsp;get&nbsp;special&nbsp;treatment;&nbsp;arrays&nbsp;don&#39;t.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5272685">if</span>&nbsp;<span class="ident" id="5272688">t</span><span class="op" id="5272689">.</span><span class="ident" id="5272690">Elem</span><span class="op" id="5272694">(</span><span class="op" id="5272695">)</span><span class="op" id="5272696">.</span><span class="ident" id="5272697">Kind</span><span class="op" id="5272701">(</span><span class="op" id="5272702">)</span>&nbsp;<span class="op" id="5272704">==</span>&nbsp;<span class="ident" id="5272707">reflect</span><span class="op" id="5272714">.</span><span class="ident" id="5272715">Uint8</span>&nbsp;<span class="op" id="5272721">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5272725">return</span>&nbsp;<span class="ident" id="5272732">encodeByteSlice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5272749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272752">enc</span>&nbsp;<span class="op" id="5272756">:=</span>&nbsp;<span class="op" id="5272759">&amp;</span><span class="ident" id="5272760">sliceEncoder</span><span class="op" id="5272772">{</span><span class="ident" id="5272773">newArrayEncoder</span><span class="op" id="5272788">(</span><span class="ident" id="5272789">t</span><span class="op" id="5272790">)</span><span class="op" id="5272791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5272794">return</span>&nbsp;<span class="ident" id="5272801">enc</span><span class="op" id="5272804">.</span><span class="ident" id="5272805">encode</span><br>
<span class="lineno"></span><span class="op" id="5272812">}</span><br>
<span class="lineno">675</span><br>
<span class="lineno"></span><span class="keyword" id="5272815">type</span>&nbsp;<span class="ident" id="5272820">arrayEncoder</span>&nbsp;<span class="keyword" id="5272833">struct</span>&nbsp;<span class="op" id="5272840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272843">elemEnc</span>&nbsp;<span class="ident" id="5272851">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="5272863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="keyword" id="5272866">func</span>&nbsp;<span class="op" id="5272871">(</span><span class="ident" id="5272872">ae</span>&nbsp;<span class="op" id="5272875">*</span><span class="ident" id="5272876">arrayEncoder</span><span class="op" id="5272888">)</span>&nbsp;<span class="ident" id="5272890">encode</span><span class="op" id="5272896">(</span><span class="ident" id="5272897">e</span>&nbsp;<span class="op" id="5272899">*</span><span class="ident" id="5272900">encodeState</span><span class="op" id="5272911">,</span>&nbsp;<span class="ident" id="5272913">v</span>&nbsp;<span class="ident" id="5272915">reflect</span><span class="op" id="5272922">.</span><span class="ident" id="5272923">Value</span><span class="op" id="5272928">,</span>&nbsp;<span class="ident" id="5272930">_</span>&nbsp;<span class="builtintype" id="5272932">bool</span><span class="op" id="5272936">)</span>&nbsp;<span class="op" id="5272938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272941">e</span><span class="op" id="5272942">.</span><span class="ident" id="5272943">WriteByte</span><span class="op" id="5272952">(</span><span class="string" id="5272953">&#39;[&#39;</span><span class="op" id="5272956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5272959">n</span>&nbsp;<span class="op" id="5272961">:=</span>&nbsp;<span class="ident" id="5272964">v</span><span class="op" id="5272965">.</span><span class="ident" id="5272966">Len</span><span class="op" id="5272969">(</span><span class="op" id="5272970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5272973">for</span>&nbsp;<span class="ident" id="5272977">i</span>&nbsp;<span class="op" id="5272979">:=</span>&nbsp;<span class="num" id="5272982">0</span><span class="op" id="5272983">;</span>&nbsp;<span class="ident" id="5272985">i</span>&nbsp;<span class="op" id="5272987">&lt;</span>&nbsp;<span class="ident" id="5272989">n</span><span class="op" id="5272990">;</span>&nbsp;<span class="ident" id="5272992">i</span><span class="op" id="5272993">++</span>&nbsp;<span class="op" id="5272996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5273000">if</span>&nbsp;<span class="ident" id="5273003">i</span>&nbsp;<span class="op" id="5273005">&gt;</span>&nbsp;<span class="num" id="5273007">0</span>&nbsp;<span class="op" id="5273009">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273014">e</span><span class="op" id="5273015">.</span><span class="ident" id="5273016">WriteByte</span><span class="op" id="5273025">(</span><span class="string" id="5273026">&#39;,&#39;</span><span class="op" id="5273029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5273033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273037">ae</span><span class="op" id="5273039">.</span><span class="ident" id="5273040">elemEnc</span><span class="op" id="5273047">(</span><span class="ident" id="5273048">e</span><span class="op" id="5273049">,</span>&nbsp;<span class="ident" id="5273051">v</span><span class="op" id="5273052">.</span><span class="ident" id="5273053">Index</span><span class="op" id="5273058">(</span><span class="ident" id="5273059">i</span><span class="op" id="5273060">)</span><span class="op" id="5273061">,</span>&nbsp;<span class="builtintype" id="5273063">false</span><span class="op" id="5273068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5273071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273074">e</span><span class="op" id="5273075">.</span><span class="ident" id="5273076">WriteByte</span><span class="op" id="5273085">(</span><span class="string" id="5273086">&#39;]&#39;</span><span class="op" id="5273089">)</span><br>
<span class="lineno">690</span><span class="op" id="5273091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5273094">func</span>&nbsp;<span class="ident" id="5273099">newArrayEncoder</span><span class="op" id="5273114">(</span><span class="ident" id="5273115">t</span>&nbsp;<span class="ident" id="5273117">reflect</span><span class="op" id="5273124">.</span><span class="ident" id="5273125">Type</span><span class="op" id="5273129">)</span>&nbsp;<span class="ident" id="5273131">encoderFunc</span>&nbsp;<span class="op" id="5273143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273146">enc</span>&nbsp;<span class="op" id="5273150">:=</span>&nbsp;<span class="op" id="5273153">&amp;</span><span class="ident" id="5273154">arrayEncoder</span><span class="op" id="5273166">{</span><span class="ident" id="5273167">typeEncoder</span><span class="op" id="5273178">(</span><span class="ident" id="5273179">t</span><span class="op" id="5273180">.</span><span class="ident" id="5273181">Elem</span><span class="op" id="5273185">(</span><span class="op" id="5273186">)</span><span class="op" id="5273187">)</span><span class="op" id="5273188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5273191">return</span>&nbsp;<span class="ident" id="5273198">enc</span><span class="op" id="5273201">.</span><span class="ident" id="5273202">encode</span><br>
<span class="lineno">695</span><span class="op" id="5273209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5273212">type</span>&nbsp;<span class="ident" id="5273217">ptrEncoder</span>&nbsp;<span class="keyword" id="5273228">struct</span>&nbsp;<span class="op" id="5273235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273238">elemEnc</span>&nbsp;<span class="ident" id="5273246">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="5273258">}</span><br>
<span class="lineno">700</span><br>
<span class="lineno"></span><span class="keyword" id="5273261">func</span>&nbsp;<span class="op" id="5273266">(</span><span class="ident" id="5273267">pe</span>&nbsp;<span class="op" id="5273270">*</span><span class="ident" id="5273271">ptrEncoder</span><span class="op" id="5273281">)</span>&nbsp;<span class="ident" id="5273283">encode</span><span class="op" id="5273289">(</span><span class="ident" id="5273290">e</span>&nbsp;<span class="op" id="5273292">*</span><span class="ident" id="5273293">encodeState</span><span class="op" id="5273304">,</span>&nbsp;<span class="ident" id="5273306">v</span>&nbsp;<span class="ident" id="5273308">reflect</span><span class="op" id="5273315">.</span><span class="ident" id="5273316">Value</span><span class="op" id="5273321">,</span>&nbsp;<span class="ident" id="5273323">quoted</span>&nbsp;<span class="builtintype" id="5273330">bool</span><span class="op" id="5273334">)</span>&nbsp;<span class="op" id="5273336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5273339">if</span>&nbsp;<span class="ident" id="5273342">v</span><span class="op" id="5273343">.</span><span class="ident" id="5273344">IsNil</span><span class="op" id="5273349">(</span><span class="op" id="5273350">)</span>&nbsp;<span class="op" id="5273352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273356">e</span><span class="op" id="5273357">.</span><span class="ident" id="5273358">WriteString</span><span class="op" id="5273369">(</span><span class="string" id="5273370">&#34;null&#34;</span><span class="op" id="5273376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5273380">return</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5273388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273391">pe</span><span class="op" id="5273393">.</span><span class="ident" id="5273394">elemEnc</span><span class="op" id="5273401">(</span><span class="ident" id="5273402">e</span><span class="op" id="5273403">,</span>&nbsp;<span class="ident" id="5273405">v</span><span class="op" id="5273406">.</span><span class="ident" id="5273407">Elem</span><span class="op" id="5273411">(</span><span class="op" id="5273412">)</span><span class="op" id="5273413">,</span>&nbsp;<span class="ident" id="5273415">quoted</span><span class="op" id="5273421">)</span><br>
<span class="lineno"></span><span class="op" id="5273423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5273426">func</span>&nbsp;<span class="ident" id="5273431">newPtrEncoder</span><span class="op" id="5273444">(</span><span class="ident" id="5273445">t</span>&nbsp;<span class="ident" id="5273447">reflect</span><span class="op" id="5273454">.</span><span class="ident" id="5273455">Type</span><span class="op" id="5273459">)</span>&nbsp;<span class="ident" id="5273461">encoderFunc</span>&nbsp;<span class="op" id="5273473">{</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273476">enc</span>&nbsp;<span class="op" id="5273480">:=</span>&nbsp;<span class="op" id="5273483">&amp;</span><span class="ident" id="5273484">ptrEncoder</span><span class="op" id="5273494">{</span><span class="ident" id="5273495">typeEncoder</span><span class="op" id="5273506">(</span><span class="ident" id="5273507">t</span><span class="op" id="5273508">.</span><span class="ident" id="5273509">Elem</span><span class="op" id="5273513">(</span><span class="op" id="5273514">)</span><span class="op" id="5273515">)</span><span class="op" id="5273516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5273519">return</span>&nbsp;<span class="ident" id="5273526">enc</span><span class="op" id="5273529">.</span><span class="ident" id="5273530">encode</span><br>
<span class="lineno"></span><span class="op" id="5273537">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5273540">type</span>&nbsp;<span class="ident" id="5273545">condAddrEncoder</span>&nbsp;<span class="keyword" id="5273561">struct</span>&nbsp;<span class="op" id="5273568">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273571">canAddrEnc</span><span class="op" id="5273581">,</span>&nbsp;<span class="ident" id="5273583">elseEnc</span>&nbsp;<span class="ident" id="5273591">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="5273603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5273606">func</span>&nbsp;<span class="op" id="5273611">(</span><span class="ident" id="5273612">ce</span>&nbsp;<span class="op" id="5273615">*</span><span class="ident" id="5273616">condAddrEncoder</span><span class="op" id="5273631">)</span>&nbsp;<span class="ident" id="5273633">encode</span><span class="op" id="5273639">(</span><span class="ident" id="5273640">e</span>&nbsp;<span class="op" id="5273642">*</span><span class="ident" id="5273643">encodeState</span><span class="op" id="5273654">,</span>&nbsp;<span class="ident" id="5273656">v</span>&nbsp;<span class="ident" id="5273658">reflect</span><span class="op" id="5273665">.</span><span class="ident" id="5273666">Value</span><span class="op" id="5273671">,</span>&nbsp;<span class="ident" id="5273673">quoted</span>&nbsp;<span class="builtintype" id="5273680">bool</span><span class="op" id="5273684">)</span>&nbsp;<span class="op" id="5273686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5273689">if</span>&nbsp;<span class="ident" id="5273692">v</span><span class="op" id="5273693">.</span><span class="ident" id="5273694">CanAddr</span><span class="op" id="5273701">(</span><span class="op" id="5273702">)</span>&nbsp;<span class="op" id="5273704">{</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273708">ce</span><span class="op" id="5273710">.</span><span class="ident" id="5273711">canAddrEnc</span><span class="op" id="5273721">(</span><span class="ident" id="5273722">e</span><span class="op" id="5273723">,</span>&nbsp;<span class="ident" id="5273725">v</span><span class="op" id="5273726">,</span>&nbsp;<span class="ident" id="5273728">quoted</span><span class="op" id="5273734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5273737">}</span>&nbsp;<span class="keyword" id="5273739">else</span>&nbsp;<span class="op" id="5273744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273748">ce</span><span class="op" id="5273750">.</span><span class="ident" id="5273751">elseEnc</span><span class="op" id="5273758">(</span><span class="ident" id="5273759">e</span><span class="op" id="5273760">,</span>&nbsp;<span class="ident" id="5273762">v</span><span class="op" id="5273763">,</span>&nbsp;<span class="ident" id="5273765">quoted</span><span class="op" id="5273771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5273774">}</span><br>
<span class="lineno"></span><span class="op" id="5273776">}</span><br>
<span class="lineno">725</span><br>
<span class="lineno"></span><span class="comment" id="5273779">//&nbsp;newCondAddrEncoder&nbsp;returns&nbsp;an&nbsp;encoder&nbsp;that&nbsp;checks&nbsp;whether&nbsp;its&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="5273850">//&nbsp;CanAddr&nbsp;and&nbsp;delegates&nbsp;to&nbsp;canAddrEnc&nbsp;if&nbsp;so,&nbsp;else&nbsp;to&nbsp;elseEnc.</span><br>
<span class="lineno"></span><span class="keyword" id="5273913">func</span>&nbsp;<span class="ident" id="5273918">newCondAddrEncoder</span><span class="op" id="5273936">(</span><span class="ident" id="5273937">canAddrEnc</span><span class="op" id="5273947">,</span>&nbsp;<span class="ident" id="5273949">elseEnc</span>&nbsp;<span class="ident" id="5273957">encoderFunc</span><span class="op" id="5273968">)</span>&nbsp;<span class="ident" id="5273970">encoderFunc</span>&nbsp;<span class="op" id="5273982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5273985">enc</span>&nbsp;<span class="op" id="5273989">:=</span>&nbsp;<span class="op" id="5273992">&amp;</span><span class="ident" id="5273993">condAddrEncoder</span><span class="op" id="5274008">{</span><span class="ident" id="5274009">canAddrEnc</span><span class="op" id="5274019">:</span>&nbsp;<span class="ident" id="5274021">canAddrEnc</span><span class="op" id="5274031">,</span>&nbsp;<span class="ident" id="5274033">elseEnc</span><span class="op" id="5274040">:</span>&nbsp;<span class="ident" id="5274042">elseEnc</span><span class="op" id="5274049">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274052">return</span>&nbsp;<span class="ident" id="5274059">enc</span><span class="op" id="5274062">.</span><span class="ident" id="5274063">encode</span><br>
<span class="lineno"></span><span class="op" id="5274070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5274073">func</span>&nbsp;<span class="ident" id="5274078">isValidTag</span><span class="op" id="5274088">(</span><span class="ident" id="5274089">s</span>&nbsp;<span class="builtintype" id="5274091">string</span><span class="op" id="5274097">)</span>&nbsp;<span class="builtintype" id="5274099">bool</span>&nbsp;<span class="op" id="5274104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274107">if</span>&nbsp;<span class="ident" id="5274110">s</span>&nbsp;<span class="op" id="5274112">==</span>&nbsp;<span class="string" id="5274115">&#34;&#34;</span>&nbsp;<span class="op" id="5274118">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274122">return</span>&nbsp;<span class="builtintype" id="5274129">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5274136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274139">for</span>&nbsp;<span class="ident" id="5274143">_</span><span class="op" id="5274144">,</span>&nbsp;<span class="ident" id="5274146">c</span>&nbsp;<span class="op" id="5274148">:=</span>&nbsp;<span class="keyword" id="5274151">range</span>&nbsp;<span class="ident" id="5274157">s</span>&nbsp;<span class="op" id="5274159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274163">switch</span>&nbsp;<span class="op" id="5274170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274174">case</span>&nbsp;<span class="ident" id="5274179">strings</span><span class="op" id="5274186">.</span><span class="ident" id="5274187">ContainsRune</span><span class="op" id="5274199">(</span><span class="string" id="5274200">&#34;!#$%&amp;()*+-./:&lt;=&gt;?@[]^_{|}~&nbsp;&#34;</span><span class="op" id="5274229">,</span>&nbsp;<span class="ident" id="5274231">c</span><span class="op" id="5274232">)</span><span class="op" id="5274233">:</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5274238">//&nbsp;Backslash&nbsp;and&nbsp;quote&nbsp;chars&nbsp;are&nbsp;reserved,&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5274288">//&nbsp;otherwise&nbsp;any&nbsp;punctuation&nbsp;chars&nbsp;are&nbsp;allowed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5274338">//&nbsp;in&nbsp;a&nbsp;tag&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274358">default</span><span class="op" id="5274365">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274370">if</span>&nbsp;<span class="op" id="5274373">!</span><span class="ident" id="5274374">unicode</span><span class="op" id="5274381">.</span><span class="ident" id="5274382">IsLetter</span><span class="op" id="5274390">(</span><span class="ident" id="5274391">c</span><span class="op" id="5274392">)</span>&nbsp;<span class="op" id="5274394">&amp;&amp;</span>&nbsp;<span class="op" id="5274397">!</span><span class="ident" id="5274398">unicode</span><span class="op" id="5274405">.</span><span class="ident" id="5274406">IsDigit</span><span class="op" id="5274413">(</span><span class="ident" id="5274414">c</span><span class="op" id="5274415">)</span>&nbsp;<span class="op" id="5274417">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274423">return</span>&nbsp;<span class="builtintype" id="5274430">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5274439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5274443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5274446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274449">return</span>&nbsp;<span class="builtintype" id="5274456">true</span><br>
<span class="lineno">750</span><span class="op" id="5274461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5274464">func</span>&nbsp;<span class="ident" id="5274469">fieldByIndex</span><span class="op" id="5274481">(</span><span class="ident" id="5274482">v</span>&nbsp;<span class="ident" id="5274484">reflect</span><span class="op" id="5274491">.</span><span class="ident" id="5274492">Value</span><span class="op" id="5274497">,</span>&nbsp;<span class="ident" id="5274499">index</span>&nbsp;<span class="op" id="5274505">[</span><span class="op" id="5274506">]</span><span class="builtintype" id="5274507">int</span><span class="op" id="5274510">)</span>&nbsp;<span class="ident" id="5274512">reflect</span><span class="op" id="5274519">.</span><span class="ident" id="5274520">Value</span>&nbsp;<span class="op" id="5274526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274529">for</span>&nbsp;<span class="ident" id="5274533">_</span><span class="op" id="5274534">,</span>&nbsp;<span class="ident" id="5274536">i</span>&nbsp;<span class="op" id="5274538">:=</span>&nbsp;<span class="keyword" id="5274541">range</span>&nbsp;<span class="ident" id="5274547">index</span>&nbsp;<span class="op" id="5274553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274557">if</span>&nbsp;<span class="ident" id="5274560">v</span><span class="op" id="5274561">.</span><span class="ident" id="5274562">Kind</span><span class="op" id="5274566">(</span><span class="op" id="5274567">)</span>&nbsp;<span class="op" id="5274569">==</span>&nbsp;<span class="ident" id="5274572">reflect</span><span class="op" id="5274579">.</span><span class="ident" id="5274580">Ptr</span>&nbsp;<span class="op" id="5274584">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274589">if</span>&nbsp;<span class="ident" id="5274592">v</span><span class="op" id="5274593">.</span><span class="ident" id="5274594">IsNil</span><span class="op" id="5274599">(</span><span class="op" id="5274600">)</span>&nbsp;<span class="op" id="5274602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274608">return</span>&nbsp;<span class="ident" id="5274615">reflect</span><span class="op" id="5274622">.</span><span class="ident" id="5274623">Value</span><span class="op" id="5274628">{</span><span class="op" id="5274629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5274634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274639">v</span>&nbsp;<span class="op" id="5274641">=</span>&nbsp;<span class="ident" id="5274643">v</span><span class="op" id="5274644">.</span><span class="ident" id="5274645">Elem</span><span class="op" id="5274649">(</span><span class="op" id="5274650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5274654">}</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274658">v</span>&nbsp;<span class="op" id="5274660">=</span>&nbsp;<span class="ident" id="5274662">v</span><span class="op" id="5274663">.</span><span class="ident" id="5274664">Field</span><span class="op" id="5274669">(</span><span class="ident" id="5274670">i</span><span class="op" id="5274671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5274674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274677">return</span>&nbsp;<span class="ident" id="5274684">v</span><br>
<span class="lineno"></span><span class="op" id="5274686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">765</span><span class="keyword" id="5274689">func</span>&nbsp;<span class="ident" id="5274694">typeByIndex</span><span class="op" id="5274705">(</span><span class="ident" id="5274706">t</span>&nbsp;<span class="ident" id="5274708">reflect</span><span class="op" id="5274715">.</span><span class="ident" id="5274716">Type</span><span class="op" id="5274720">,</span>&nbsp;<span class="ident" id="5274722">index</span>&nbsp;<span class="op" id="5274728">[</span><span class="op" id="5274729">]</span><span class="builtintype" id="5274730">int</span><span class="op" id="5274733">)</span>&nbsp;<span class="ident" id="5274735">reflect</span><span class="op" id="5274742">.</span><span class="ident" id="5274743">Type</span>&nbsp;<span class="op" id="5274748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274751">for</span>&nbsp;<span class="ident" id="5274755">_</span><span class="op" id="5274756">,</span>&nbsp;<span class="ident" id="5274758">i</span>&nbsp;<span class="op" id="5274760">:=</span>&nbsp;<span class="keyword" id="5274763">range</span>&nbsp;<span class="ident" id="5274769">index</span>&nbsp;<span class="op" id="5274775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274779">if</span>&nbsp;<span class="ident" id="5274782">t</span><span class="op" id="5274783">.</span><span class="ident" id="5274784">Kind</span><span class="op" id="5274788">(</span><span class="op" id="5274789">)</span>&nbsp;<span class="op" id="5274791">==</span>&nbsp;<span class="ident" id="5274794">reflect</span><span class="op" id="5274801">.</span><span class="ident" id="5274802">Ptr</span>&nbsp;<span class="op" id="5274806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274811">t</span>&nbsp;<span class="op" id="5274813">=</span>&nbsp;<span class="ident" id="5274815">t</span><span class="op" id="5274816">.</span><span class="ident" id="5274817">Elem</span><span class="op" id="5274821">(</span><span class="op" id="5274822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5274826">}</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5274830">t</span>&nbsp;<span class="op" id="5274832">=</span>&nbsp;<span class="ident" id="5274834">t</span><span class="op" id="5274835">.</span><span class="ident" id="5274836">Field</span><span class="op" id="5274841">(</span><span class="ident" id="5274842">i</span><span class="op" id="5274843">)</span><span class="op" id="5274844">.</span><span class="ident" id="5274845">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5274851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5274854">return</span>&nbsp;<span class="ident" id="5274861">t</span><br>
<span class="lineno"></span><span class="op" id="5274863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">775</span><span class="comment" id="5274866">//&nbsp;stringValues&nbsp;is&nbsp;a&nbsp;slice&nbsp;of&nbsp;reflect.Value&nbsp;holding&nbsp;*reflect.StringValue.</span><br>
<span class="lineno"></span><span class="comment" id="5274940">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;methods&nbsp;to&nbsp;sort&nbsp;by&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="5274988">type</span>&nbsp;<span class="ident" id="5274993">stringValues</span>&nbsp;<span class="op" id="5275006">[</span><span class="op" id="5275007">]</span><span class="ident" id="5275008">reflect</span><span class="op" id="5275015">.</span><span class="ident" id="5275016">Value</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5275023">func</span>&nbsp;<span class="op" id="5275028">(</span><span class="ident" id="5275029">sv</span>&nbsp;<span class="ident" id="5275032">stringValues</span><span class="op" id="5275044">)</span>&nbsp;<span class="ident" id="5275046">Len</span><span class="op" id="5275049">(</span><span class="op" id="5275050">)</span>&nbsp;<span class="builtintype" id="5275052">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5275066">{</span>&nbsp;<span class="keyword" id="5275068">return</span>&nbsp;<span class="builtinfunc" id="5275075">len</span><span class="op" id="5275078">(</span><span class="ident" id="5275079">sv</span><span class="op" id="5275081">)</span>&nbsp;<span class="op" id="5275083">}</span><br>
<span class="lineno">780</span><span class="keyword" id="5275085">func</span>&nbsp;<span class="op" id="5275090">(</span><span class="ident" id="5275091">sv</span>&nbsp;<span class="ident" id="5275094">stringValues</span><span class="op" id="5275106">)</span>&nbsp;<span class="ident" id="5275108">Swap</span><span class="op" id="5275112">(</span><span class="ident" id="5275113">i</span><span class="op" id="5275114">,</span>&nbsp;<span class="ident" id="5275116">j</span>&nbsp;<span class="builtintype" id="5275118">int</span><span class="op" id="5275121">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5275128">{</span>&nbsp;<span class="ident" id="5275130">sv</span><span class="op" id="5275132">[</span><span class="ident" id="5275133">i</span><span class="op" id="5275134">]</span><span class="op" id="5275135">,</span>&nbsp;<span class="ident" id="5275137">sv</span><span class="op" id="5275139">[</span><span class="ident" id="5275140">j</span><span class="op" id="5275141">]</span>&nbsp;<span class="op" id="5275143">=</span>&nbsp;<span class="ident" id="5275145">sv</span><span class="op" id="5275147">[</span><span class="ident" id="5275148">j</span><span class="op" id="5275149">]</span><span class="op" id="5275150">,</span>&nbsp;<span class="ident" id="5275152">sv</span><span class="op" id="5275154">[</span><span class="ident" id="5275155">i</span><span class="op" id="5275156">]</span>&nbsp;<span class="op" id="5275158">}</span><br>
<span class="lineno"></span><span class="keyword" id="5275160">func</span>&nbsp;<span class="op" id="5275165">(</span><span class="ident" id="5275166">sv</span>&nbsp;<span class="ident" id="5275169">stringValues</span><span class="op" id="5275181">)</span>&nbsp;<span class="ident" id="5275183">Less</span><span class="op" id="5275187">(</span><span class="ident" id="5275188">i</span><span class="op" id="5275189">,</span>&nbsp;<span class="ident" id="5275191">j</span>&nbsp;<span class="builtintype" id="5275193">int</span><span class="op" id="5275196">)</span>&nbsp;<span class="builtintype" id="5275198">bool</span>&nbsp;<span class="op" id="5275203">{</span>&nbsp;<span class="keyword" id="5275205">return</span>&nbsp;<span class="ident" id="5275212">sv</span><span class="op" id="5275214">.</span><span class="ident" id="5275215">get</span><span class="op" id="5275218">(</span><span class="ident" id="5275219">i</span><span class="op" id="5275220">)</span>&nbsp;<span class="op" id="5275222">&lt;</span>&nbsp;<span class="ident" id="5275224">sv</span><span class="op" id="5275226">.</span><span class="ident" id="5275227">get</span><span class="op" id="5275230">(</span><span class="ident" id="5275231">j</span><span class="op" id="5275232">)</span>&nbsp;<span class="op" id="5275234">}</span><br>
<span class="lineno"></span><span class="keyword" id="5275236">func</span>&nbsp;<span class="op" id="5275241">(</span><span class="ident" id="5275242">sv</span>&nbsp;<span class="ident" id="5275245">stringValues</span><span class="op" id="5275257">)</span>&nbsp;<span class="ident" id="5275259">get</span><span class="op" id="5275262">(</span><span class="ident" id="5275263">i</span>&nbsp;<span class="builtintype" id="5275265">int</span><span class="op" id="5275268">)</span>&nbsp;<span class="builtintype" id="5275270">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5275279">{</span>&nbsp;<span class="keyword" id="5275281">return</span>&nbsp;<span class="ident" id="5275288">sv</span><span class="op" id="5275290">[</span><span class="ident" id="5275291">i</span><span class="op" id="5275292">]</span><span class="op" id="5275293">.</span><span class="ident" id="5275294">String</span><span class="op" id="5275300">(</span><span class="op" id="5275301">)</span>&nbsp;<span class="op" id="5275303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5275306">//&nbsp;NOTE:&nbsp;keep&nbsp;in&nbsp;sync&nbsp;with&nbsp;stringBytes&nbsp;below.</span><br>
<span class="lineno">785</span><span class="keyword" id="5275352">func</span>&nbsp;<span class="op" id="5275357">(</span><span class="ident" id="5275358">e</span>&nbsp;<span class="op" id="5275360">*</span><span class="ident" id="5275361">encodeState</span><span class="op" id="5275372">)</span>&nbsp;<span class="builtintype" id="5275374">string</span><span class="op" id="5275380">(</span><span class="ident" id="5275381">s</span>&nbsp;<span class="builtintype" id="5275383">string</span><span class="op" id="5275389">)</span>&nbsp;<span class="op" id="5275391">(</span><span class="builtintype" id="5275392">int</span><span class="op" id="5275395">,</span>&nbsp;<span class="builtintype" id="5275397">error</span><span class="op" id="5275402">)</span>&nbsp;<span class="op" id="5275404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275407">len0</span>&nbsp;<span class="op" id="5275412">:=</span>&nbsp;<span class="ident" id="5275415">e</span><span class="op" id="5275416">.</span><span class="ident" id="5275417">Len</span><span class="op" id="5275420">(</span><span class="op" id="5275421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275424">e</span><span class="op" id="5275425">.</span><span class="ident" id="5275426">WriteByte</span><span class="op" id="5275435">(</span><span class="string" id="5275436">&#39;&#34;&#39;</span><span class="op" id="5275439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275442">start</span>&nbsp;<span class="op" id="5275448">:=</span>&nbsp;<span class="num" id="5275451">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275454">for</span>&nbsp;<span class="ident" id="5275458">i</span>&nbsp;<span class="op" id="5275460">:=</span>&nbsp;<span class="num" id="5275463">0</span><span class="op" id="5275464">;</span>&nbsp;<span class="ident" id="5275466">i</span>&nbsp;<span class="op" id="5275468">&lt;</span>&nbsp;<span class="builtinfunc" id="5275470">len</span><span class="op" id="5275473">(</span><span class="ident" id="5275474">s</span><span class="op" id="5275475">)</span><span class="op" id="5275476">;</span>&nbsp;<span class="op" id="5275478">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275482">if</span>&nbsp;<span class="ident" id="5275485">b</span>&nbsp;<span class="op" id="5275487">:=</span>&nbsp;<span class="ident" id="5275490">s</span><span class="op" id="5275491">[</span><span class="ident" id="5275492">i</span><span class="op" id="5275493">]</span><span class="op" id="5275494">;</span>&nbsp;<span class="ident" id="5275496">b</span>&nbsp;<span class="op" id="5275498">&lt;</span>&nbsp;<span class="ident" id="5275500">utf8</span><span class="op" id="5275504">.</span><span class="ident" id="5275505">RuneSelf</span>&nbsp;<span class="op" id="5275514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275519">if</span>&nbsp;<span class="num" id="5275522">0x20</span>&nbsp;<span class="op" id="5275527">&lt;=</span>&nbsp;<span class="ident" id="5275530">b</span>&nbsp;<span class="op" id="5275532">&amp;&amp;</span>&nbsp;<span class="ident" id="5275535">b</span>&nbsp;<span class="op" id="5275537">!=</span>&nbsp;<span class="string" id="5275540">&#39;\\&#39;</span>&nbsp;<span class="op" id="5275545">&amp;&amp;</span>&nbsp;<span class="ident" id="5275548">b</span>&nbsp;<span class="op" id="5275550">!=</span>&nbsp;<span class="string" id="5275553">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="5275557">&amp;&amp;</span>&nbsp;<span class="ident" id="5275560">b</span>&nbsp;<span class="op" id="5275562">!=</span>&nbsp;<span class="string" id="5275565">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5275569">&amp;&amp;</span>&nbsp;<span class="ident" id="5275572">b</span>&nbsp;<span class="op" id="5275574">!=</span>&nbsp;<span class="string" id="5275577">&#39;&gt;&#39;</span>&nbsp;<span class="op" id="5275581">&amp;&amp;</span>&nbsp;<span class="ident" id="5275584">b</span>&nbsp;<span class="op" id="5275586">!=</span>&nbsp;<span class="string" id="5275589">&#39;&amp;&#39;</span>&nbsp;<span class="op" id="5275593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275599">i</span><span class="op" id="5275600">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275607">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5275619">}</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275624">if</span>&nbsp;<span class="ident" id="5275627">start</span>&nbsp;<span class="op" id="5275633">&lt;</span>&nbsp;<span class="ident" id="5275635">i</span>&nbsp;<span class="op" id="5275637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275643">e</span><span class="op" id="5275644">.</span><span class="ident" id="5275645">WriteString</span><span class="op" id="5275656">(</span><span class="ident" id="5275657">s</span><span class="op" id="5275658">[</span><span class="ident" id="5275659">start</span><span class="op" id="5275664">:</span><span class="ident" id="5275665">i</span><span class="op" id="5275666">]</span><span class="op" id="5275667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5275672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275677">switch</span>&nbsp;<span class="ident" id="5275684">b</span>&nbsp;<span class="op" id="5275686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275691">case</span>&nbsp;<span class="string" id="5275696">&#39;\\&#39;</span><span class="op" id="5275700">,</span>&nbsp;<span class="string" id="5275702">&#39;&#34;&#39;</span><span class="op" id="5275705">:</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275711">e</span><span class="op" id="5275712">.</span><span class="ident" id="5275713">WriteByte</span><span class="op" id="5275722">(</span><span class="string" id="5275723">&#39;\\&#39;</span><span class="op" id="5275727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275733">e</span><span class="op" id="5275734">.</span><span class="ident" id="5275735">WriteByte</span><span class="op" id="5275744">(</span><span class="ident" id="5275745">b</span><span class="op" id="5275746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275751">case</span>&nbsp;<span class="string" id="5275756">&#39;\n&#39;</span><span class="op" id="5275760">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275766">e</span><span class="op" id="5275767">.</span><span class="ident" id="5275768">WriteByte</span><span class="op" id="5275777">(</span><span class="string" id="5275778">&#39;\\&#39;</span><span class="op" id="5275782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275788">e</span><span class="op" id="5275789">.</span><span class="ident" id="5275790">WriteByte</span><span class="op" id="5275799">(</span><span class="string" id="5275800">&#39;n&#39;</span><span class="op" id="5275803">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275808">case</span>&nbsp;<span class="string" id="5275813">&#39;\r&#39;</span><span class="op" id="5275817">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275823">e</span><span class="op" id="5275824">.</span><span class="ident" id="5275825">WriteByte</span><span class="op" id="5275834">(</span><span class="string" id="5275835">&#39;\\&#39;</span><span class="op" id="5275839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275845">e</span><span class="op" id="5275846">.</span><span class="ident" id="5275847">WriteByte</span><span class="op" id="5275856">(</span><span class="string" id="5275857">&#39;r&#39;</span><span class="op" id="5275860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275865">case</span>&nbsp;<span class="string" id="5275870">&#39;\t&#39;</span><span class="op" id="5275874">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275880">e</span><span class="op" id="5275881">.</span><span class="ident" id="5275882">WriteByte</span><span class="op" id="5275891">(</span><span class="string" id="5275892">&#39;\\&#39;</span><span class="op" id="5275896">)</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5275902">e</span><span class="op" id="5275903">.</span><span class="ident" id="5275904">WriteByte</span><span class="op" id="5275913">(</span><span class="string" id="5275914">&#39;t&#39;</span><span class="op" id="5275917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5275922">default</span><span class="op" id="5275929">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5275935">//&nbsp;This&nbsp;encodes&nbsp;bytes&nbsp;&lt;&nbsp;0x20&nbsp;except&nbsp;for&nbsp;\n&nbsp;and&nbsp;\r,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5275990">//&nbsp;as&nbsp;well&nbsp;as&nbsp;&lt;,&nbsp;&gt;&nbsp;and&nbsp;&amp;.&nbsp;The&nbsp;latter&nbsp;are&nbsp;escaped&nbsp;because&nbsp;they</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5276056">//&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;when&nbsp;user-controlled&nbsp;strings</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5276119">//&nbsp;are&nbsp;rendered&nbsp;into&nbsp;JSON&nbsp;and&nbsp;served&nbsp;to&nbsp;some&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276178">e</span><span class="op" id="5276179">.</span><span class="ident" id="5276180">WriteString</span><span class="op" id="5276191">(</span><span class="string" id="5276192">`\u00`</span><span class="op" id="5276198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276204">e</span><span class="op" id="5276205">.</span><span class="ident" id="5276206">WriteByte</span><span class="op" id="5276215">(</span><span class="ident" id="5276216">hex</span><span class="op" id="5276219">[</span><span class="ident" id="5276220">b</span><span class="op" id="5276221">&gt;&gt;</span><span class="num" id="5276223">4</span><span class="op" id="5276224">]</span><span class="op" id="5276225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276231">e</span><span class="op" id="5276232">.</span><span class="ident" id="5276233">WriteByte</span><span class="op" id="5276242">(</span><span class="ident" id="5276243">hex</span><span class="op" id="5276246">[</span><span class="ident" id="5276247">b</span><span class="op" id="5276248">&amp;</span><span class="num" id="5276249">0xF</span><span class="op" id="5276252">]</span><span class="op" id="5276253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276258">}</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276263">i</span><span class="op" id="5276264">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276270">start</span>&nbsp;<span class="op" id="5276276">=</span>&nbsp;<span class="ident" id="5276278">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276283">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276298">c</span><span class="op" id="5276299">,</span>&nbsp;<span class="ident" id="5276301">size</span>&nbsp;<span class="op" id="5276306">:=</span>&nbsp;<span class="ident" id="5276309">utf8</span><span class="op" id="5276313">.</span><span class="ident" id="5276314">DecodeRuneInString</span><span class="op" id="5276332">(</span><span class="ident" id="5276333">s</span><span class="op" id="5276334">[</span><span class="ident" id="5276335">i</span><span class="op" id="5276336">:</span><span class="op" id="5276337">]</span><span class="op" id="5276338">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276342">if</span>&nbsp;<span class="ident" id="5276345">c</span>&nbsp;<span class="op" id="5276347">==</span>&nbsp;<span class="ident" id="5276350">utf8</span><span class="op" id="5276354">.</span><span class="ident" id="5276355">RuneError</span>&nbsp;<span class="op" id="5276365">&amp;&amp;</span>&nbsp;<span class="ident" id="5276368">size</span>&nbsp;<span class="op" id="5276373">==</span>&nbsp;<span class="num" id="5276376">1</span>&nbsp;<span class="op" id="5276378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276383">if</span>&nbsp;<span class="ident" id="5276386">start</span>&nbsp;<span class="op" id="5276392">&lt;</span>&nbsp;<span class="ident" id="5276394">i</span>&nbsp;<span class="op" id="5276396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276402">e</span><span class="op" id="5276403">.</span><span class="ident" id="5276404">WriteString</span><span class="op" id="5276415">(</span><span class="ident" id="5276416">s</span><span class="op" id="5276417">[</span><span class="ident" id="5276418">start</span><span class="op" id="5276423">:</span><span class="ident" id="5276424">i</span><span class="op" id="5276425">]</span><span class="op" id="5276426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276436">e</span><span class="op" id="5276437">.</span><span class="ident" id="5276438">WriteString</span><span class="op" id="5276449">(</span><span class="string" id="5276450">`\ufffd`</span><span class="op" id="5276458">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276463">i</span>&nbsp;<span class="op" id="5276465">+=</span>&nbsp;<span class="ident" id="5276468">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276476">start</span>&nbsp;<span class="op" id="5276482">=</span>&nbsp;<span class="ident" id="5276484">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276489">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5276504">//&nbsp;U+2028&nbsp;is&nbsp;LINE&nbsp;SEPARATOR.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5276535">//&nbsp;U+2029&nbsp;is&nbsp;PARAGRAPH&nbsp;SEPARATOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5276571">//&nbsp;They&nbsp;are&nbsp;both&nbsp;technically&nbsp;valid&nbsp;characters&nbsp;in&nbsp;JSON&nbsp;strings,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5276636">//&nbsp;but&nbsp;don&#39;t&nbsp;work&nbsp;in&nbsp;JSONP,&nbsp;which&nbsp;has&nbsp;to&nbsp;be&nbsp;evaluated&nbsp;as&nbsp;JavaScript,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5276707">//&nbsp;and&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;there.&nbsp;It&nbsp;is&nbsp;valid&nbsp;JSON&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5276770">//&nbsp;escape&nbsp;them,&nbsp;so&nbsp;we&nbsp;do&nbsp;so&nbsp;unconditionally.</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5276817">//&nbsp;See&nbsp;http://timelessrepo.com/json-isnt-a-javascript-subset&nbsp;for&nbsp;discussion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276896">if</span>&nbsp;<span class="ident" id="5276899">c</span>&nbsp;<span class="op" id="5276901">==</span>&nbsp;<span class="string" id="5276904">&#39;\u2028&#39;</span>&nbsp;<span class="op" id="5276913">||</span>&nbsp;<span class="ident" id="5276916">c</span>&nbsp;<span class="op" id="5276918">==</span>&nbsp;<span class="string" id="5276921">&#39;\u2029&#39;</span>&nbsp;<span class="op" id="5276930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5276935">if</span>&nbsp;<span class="ident" id="5276938">start</span>&nbsp;<span class="op" id="5276944">&lt;</span>&nbsp;<span class="ident" id="5276946">i</span>&nbsp;<span class="op" id="5276948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276954">e</span><span class="op" id="5276955">.</span><span class="ident" id="5276956">WriteString</span><span class="op" id="5276967">(</span><span class="ident" id="5276968">s</span><span class="op" id="5276969">[</span><span class="ident" id="5276970">start</span><span class="op" id="5276975">:</span><span class="ident" id="5276976">i</span><span class="op" id="5276977">]</span><span class="op" id="5276978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5276983">}</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5276988">e</span><span class="op" id="5276989">.</span><span class="ident" id="5276990">WriteString</span><span class="op" id="5277001">(</span><span class="string" id="5277002">`\u202`</span><span class="op" id="5277009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277014">e</span><span class="op" id="5277015">.</span><span class="ident" id="5277016">WriteByte</span><span class="op" id="5277025">(</span><span class="ident" id="5277026">hex</span><span class="op" id="5277029">[</span><span class="ident" id="5277030">c</span><span class="op" id="5277031">&amp;</span><span class="num" id="5277032">0xF</span><span class="op" id="5277035">]</span><span class="op" id="5277036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277041">i</span>&nbsp;<span class="op" id="5277043">+=</span>&nbsp;<span class="ident" id="5277046">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277054">start</span>&nbsp;<span class="op" id="5277060">=</span>&nbsp;<span class="ident" id="5277062">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277067">continue</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277082">i</span>&nbsp;<span class="op" id="5277084">+=</span>&nbsp;<span class="ident" id="5277087">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277096">if</span>&nbsp;<span class="ident" id="5277099">start</span>&nbsp;<span class="op" id="5277105">&lt;</span>&nbsp;<span class="builtinfunc" id="5277107">len</span><span class="op" id="5277110">(</span><span class="ident" id="5277111">s</span><span class="op" id="5277112">)</span>&nbsp;<span class="op" id="5277114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277118">e</span><span class="op" id="5277119">.</span><span class="ident" id="5277120">WriteString</span><span class="op" id="5277131">(</span><span class="ident" id="5277132">s</span><span class="op" id="5277133">[</span><span class="ident" id="5277134">start</span><span class="op" id="5277139">:</span><span class="op" id="5277140">]</span><span class="op" id="5277141">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277147">e</span><span class="op" id="5277148">.</span><span class="ident" id="5277149">WriteByte</span><span class="op" id="5277158">(</span><span class="string" id="5277159">&#39;&#34;&#39;</span><span class="op" id="5277162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277165">return</span>&nbsp;<span class="ident" id="5277172">e</span><span class="op" id="5277173">.</span><span class="ident" id="5277174">Len</span><span class="op" id="5277177">(</span><span class="op" id="5277178">)</span>&nbsp;<span class="op" id="5277180">-</span>&nbsp;<span class="ident" id="5277182">len0</span><span class="op" id="5277186">,</span>&nbsp;<span class="ident" id="5277188">nil</span><br>
<span class="lineno"></span><span class="op" id="5277192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span><span class="comment" id="5277195">//&nbsp;NOTE:&nbsp;keep&nbsp;in&nbsp;sync&nbsp;with&nbsp;string&nbsp;above.</span><br>
<span class="lineno"></span><span class="keyword" id="5277236">func</span>&nbsp;<span class="op" id="5277241">(</span><span class="ident" id="5277242">e</span>&nbsp;<span class="op" id="5277244">*</span><span class="ident" id="5277245">encodeState</span><span class="op" id="5277256">)</span>&nbsp;<span class="ident" id="5277258">stringBytes</span><span class="op" id="5277269">(</span><span class="ident" id="5277270">s</span>&nbsp;<span class="op" id="5277272">[</span><span class="op" id="5277273">]</span><span class="builtintype" id="5277274">byte</span><span class="op" id="5277278">)</span>&nbsp;<span class="op" id="5277280">(</span><span class="builtintype" id="5277281">int</span><span class="op" id="5277284">,</span>&nbsp;<span class="builtintype" id="5277286">error</span><span class="op" id="5277291">)</span>&nbsp;<span class="op" id="5277293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277296">len0</span>&nbsp;<span class="op" id="5277301">:=</span>&nbsp;<span class="ident" id="5277304">e</span><span class="op" id="5277305">.</span><span class="ident" id="5277306">Len</span><span class="op" id="5277309">(</span><span class="op" id="5277310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277313">e</span><span class="op" id="5277314">.</span><span class="ident" id="5277315">WriteByte</span><span class="op" id="5277324">(</span><span class="string" id="5277325">&#39;&#34;&#39;</span><span class="op" id="5277328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277331">start</span>&nbsp;<span class="op" id="5277337">:=</span>&nbsp;<span class="num" id="5277340">0</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277343">for</span>&nbsp;<span class="ident" id="5277347">i</span>&nbsp;<span class="op" id="5277349">:=</span>&nbsp;<span class="num" id="5277352">0</span><span class="op" id="5277353">;</span>&nbsp;<span class="ident" id="5277355">i</span>&nbsp;<span class="op" id="5277357">&lt;</span>&nbsp;<span class="builtinfunc" id="5277359">len</span><span class="op" id="5277362">(</span><span class="ident" id="5277363">s</span><span class="op" id="5277364">)</span><span class="op" id="5277365">;</span>&nbsp;<span class="op" id="5277367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277371">if</span>&nbsp;<span class="ident" id="5277374">b</span>&nbsp;<span class="op" id="5277376">:=</span>&nbsp;<span class="ident" id="5277379">s</span><span class="op" id="5277380">[</span><span class="ident" id="5277381">i</span><span class="op" id="5277382">]</span><span class="op" id="5277383">;</span>&nbsp;<span class="ident" id="5277385">b</span>&nbsp;<span class="op" id="5277387">&lt;</span>&nbsp;<span class="ident" id="5277389">utf8</span><span class="op" id="5277393">.</span><span class="ident" id="5277394">RuneSelf</span>&nbsp;<span class="op" id="5277403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277408">if</span>&nbsp;<span class="num" id="5277411">0x20</span>&nbsp;<span class="op" id="5277416">&lt;=</span>&nbsp;<span class="ident" id="5277419">b</span>&nbsp;<span class="op" id="5277421">&amp;&amp;</span>&nbsp;<span class="ident" id="5277424">b</span>&nbsp;<span class="op" id="5277426">!=</span>&nbsp;<span class="string" id="5277429">&#39;\\&#39;</span>&nbsp;<span class="op" id="5277434">&amp;&amp;</span>&nbsp;<span class="ident" id="5277437">b</span>&nbsp;<span class="op" id="5277439">!=</span>&nbsp;<span class="string" id="5277442">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="5277446">&amp;&amp;</span>&nbsp;<span class="ident" id="5277449">b</span>&nbsp;<span class="op" id="5277451">!=</span>&nbsp;<span class="string" id="5277454">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5277458">&amp;&amp;</span>&nbsp;<span class="ident" id="5277461">b</span>&nbsp;<span class="op" id="5277463">!=</span>&nbsp;<span class="string" id="5277466">&#39;&gt;&#39;</span>&nbsp;<span class="op" id="5277470">&amp;&amp;</span>&nbsp;<span class="ident" id="5277473">b</span>&nbsp;<span class="op" id="5277475">!=</span>&nbsp;<span class="string" id="5277478">&#39;&amp;&#39;</span>&nbsp;<span class="op" id="5277482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277488">i</span><span class="op" id="5277489">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277496">continue</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277513">if</span>&nbsp;<span class="ident" id="5277516">start</span>&nbsp;<span class="op" id="5277522">&lt;</span>&nbsp;<span class="ident" id="5277524">i</span>&nbsp;<span class="op" id="5277526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277532">e</span><span class="op" id="5277533">.</span><span class="ident" id="5277534">Write</span><span class="op" id="5277539">(</span><span class="ident" id="5277540">s</span><span class="op" id="5277541">[</span><span class="ident" id="5277542">start</span><span class="op" id="5277547">:</span><span class="ident" id="5277548">i</span><span class="op" id="5277549">]</span><span class="op" id="5277550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5277555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277560">switch</span>&nbsp;<span class="ident" id="5277567">b</span>&nbsp;<span class="op" id="5277569">{</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277574">case</span>&nbsp;<span class="string" id="5277579">&#39;\\&#39;</span><span class="op" id="5277583">,</span>&nbsp;<span class="string" id="5277585">&#39;&#34;&#39;</span><span class="op" id="5277588">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277594">e</span><span class="op" id="5277595">.</span><span class="ident" id="5277596">WriteByte</span><span class="op" id="5277605">(</span><span class="string" id="5277606">&#39;\\&#39;</span><span class="op" id="5277610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277616">e</span><span class="op" id="5277617">.</span><span class="ident" id="5277618">WriteByte</span><span class="op" id="5277627">(</span><span class="ident" id="5277628">b</span><span class="op" id="5277629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277634">case</span>&nbsp;<span class="string" id="5277639">&#39;\n&#39;</span><span class="op" id="5277643">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277649">e</span><span class="op" id="5277650">.</span><span class="ident" id="5277651">WriteByte</span><span class="op" id="5277660">(</span><span class="string" id="5277661">&#39;\\&#39;</span><span class="op" id="5277665">)</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277671">e</span><span class="op" id="5277672">.</span><span class="ident" id="5277673">WriteByte</span><span class="op" id="5277682">(</span><span class="string" id="5277683">&#39;n&#39;</span><span class="op" id="5277686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277691">case</span>&nbsp;<span class="string" id="5277696">&#39;\r&#39;</span><span class="op" id="5277700">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277706">e</span><span class="op" id="5277707">.</span><span class="ident" id="5277708">WriteByte</span><span class="op" id="5277717">(</span><span class="string" id="5277718">&#39;\\&#39;</span><span class="op" id="5277722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277728">e</span><span class="op" id="5277729">.</span><span class="ident" id="5277730">WriteByte</span><span class="op" id="5277739">(</span><span class="string" id="5277740">&#39;r&#39;</span><span class="op" id="5277743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277748">case</span>&nbsp;<span class="string" id="5277753">&#39;\t&#39;</span><span class="op" id="5277757">:</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277763">e</span><span class="op" id="5277764">.</span><span class="ident" id="5277765">WriteByte</span><span class="op" id="5277774">(</span><span class="string" id="5277775">&#39;\\&#39;</span><span class="op" id="5277779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5277785">e</span><span class="op" id="5277786">.</span><span class="ident" id="5277787">WriteByte</span><span class="op" id="5277796">(</span><span class="string" id="5277797">&#39;t&#39;</span><span class="op" id="5277800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5277805">default</span><span class="op" id="5277812">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5277818">//&nbsp;This&nbsp;encodes&nbsp;bytes&nbsp;&lt;&nbsp;0x20&nbsp;except&nbsp;for&nbsp;\n&nbsp;and&nbsp;\r,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5277873">//&nbsp;as&nbsp;well&nbsp;as&nbsp;&lt;,&nbsp;&gt;,&nbsp;and&nbsp;&amp;.&nbsp;The&nbsp;latter&nbsp;are&nbsp;escaped&nbsp;because&nbsp;they</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5277940">//&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;when&nbsp;user-controlled&nbsp;strings</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278003">//&nbsp;are&nbsp;rendered&nbsp;into&nbsp;JSON&nbsp;and&nbsp;served&nbsp;to&nbsp;some&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278062">e</span><span class="op" id="5278063">.</span><span class="ident" id="5278064">WriteString</span><span class="op" id="5278075">(</span><span class="string" id="5278076">`\u00`</span><span class="op" id="5278082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278088">e</span><span class="op" id="5278089">.</span><span class="ident" id="5278090">WriteByte</span><span class="op" id="5278099">(</span><span class="ident" id="5278100">hex</span><span class="op" id="5278103">[</span><span class="ident" id="5278104">b</span><span class="op" id="5278105">&gt;&gt;</span><span class="num" id="5278107">4</span><span class="op" id="5278108">]</span><span class="op" id="5278109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278115">e</span><span class="op" id="5278116">.</span><span class="ident" id="5278117">WriteByte</span><span class="op" id="5278126">(</span><span class="ident" id="5278127">hex</span><span class="op" id="5278130">[</span><span class="ident" id="5278131">b</span><span class="op" id="5278132">&amp;</span><span class="num" id="5278133">0xF</span><span class="op" id="5278136">]</span><span class="op" id="5278137">)</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278147">i</span><span class="op" id="5278148">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278154">start</span>&nbsp;<span class="op" id="5278160">=</span>&nbsp;<span class="ident" id="5278162">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278167">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278178">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278182">c</span><span class="op" id="5278183">,</span>&nbsp;<span class="ident" id="5278185">size</span>&nbsp;<span class="op" id="5278190">:=</span>&nbsp;<span class="ident" id="5278193">utf8</span><span class="op" id="5278197">.</span><span class="ident" id="5278198">DecodeRune</span><span class="op" id="5278208">(</span><span class="ident" id="5278209">s</span><span class="op" id="5278210">[</span><span class="ident" id="5278211">i</span><span class="op" id="5278212">:</span><span class="op" id="5278213">]</span><span class="op" id="5278214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278218">if</span>&nbsp;<span class="ident" id="5278221">c</span>&nbsp;<span class="op" id="5278223">==</span>&nbsp;<span class="ident" id="5278226">utf8</span><span class="op" id="5278230">.</span><span class="ident" id="5278231">RuneError</span>&nbsp;<span class="op" id="5278241">&amp;&amp;</span>&nbsp;<span class="ident" id="5278244">size</span>&nbsp;<span class="op" id="5278249">==</span>&nbsp;<span class="num" id="5278252">1</span>&nbsp;<span class="op" id="5278254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278259">if</span>&nbsp;<span class="ident" id="5278262">start</span>&nbsp;<span class="op" id="5278268">&lt;</span>&nbsp;<span class="ident" id="5278270">i</span>&nbsp;<span class="op" id="5278272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278278">e</span><span class="op" id="5278279">.</span><span class="ident" id="5278280">Write</span><span class="op" id="5278285">(</span><span class="ident" id="5278286">s</span><span class="op" id="5278287">[</span><span class="ident" id="5278288">start</span><span class="op" id="5278293">:</span><span class="ident" id="5278294">i</span><span class="op" id="5278295">]</span><span class="op" id="5278296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278301">}</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278306">e</span><span class="op" id="5278307">.</span><span class="ident" id="5278308">WriteString</span><span class="op" id="5278319">(</span><span class="string" id="5278320">`\ufffd`</span><span class="op" id="5278328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278333">i</span>&nbsp;<span class="op" id="5278335">+=</span>&nbsp;<span class="ident" id="5278338">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278346">start</span>&nbsp;<span class="op" id="5278352">=</span>&nbsp;<span class="ident" id="5278354">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278359">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278370">}</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278374">//&nbsp;U+2028&nbsp;is&nbsp;LINE&nbsp;SEPARATOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278405">//&nbsp;U+2029&nbsp;is&nbsp;PARAGRAPH&nbsp;SEPARATOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278441">//&nbsp;They&nbsp;are&nbsp;both&nbsp;technically&nbsp;valid&nbsp;characters&nbsp;in&nbsp;JSON&nbsp;strings,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278506">//&nbsp;but&nbsp;don&#39;t&nbsp;work&nbsp;in&nbsp;JSONP,&nbsp;which&nbsp;has&nbsp;to&nbsp;be&nbsp;evaluated&nbsp;as&nbsp;JavaScript,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278577">//&nbsp;and&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;there.&nbsp;It&nbsp;is&nbsp;valid&nbsp;JSON&nbsp;to</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278640">//&nbsp;escape&nbsp;them,&nbsp;so&nbsp;we&nbsp;do&nbsp;so&nbsp;unconditionally.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5278687">//&nbsp;See&nbsp;http://timelessrepo.com/json-isnt-a-javascript-subset&nbsp;for&nbsp;discussion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278766">if</span>&nbsp;<span class="ident" id="5278769">c</span>&nbsp;<span class="op" id="5278771">==</span>&nbsp;<span class="string" id="5278774">&#39;\u2028&#39;</span>&nbsp;<span class="op" id="5278783">||</span>&nbsp;<span class="ident" id="5278786">c</span>&nbsp;<span class="op" id="5278788">==</span>&nbsp;<span class="string" id="5278791">&#39;\u2029&#39;</span>&nbsp;<span class="op" id="5278800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278805">if</span>&nbsp;<span class="ident" id="5278808">start</span>&nbsp;<span class="op" id="5278814">&lt;</span>&nbsp;<span class="ident" id="5278816">i</span>&nbsp;<span class="op" id="5278818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278824">e</span><span class="op" id="5278825">.</span><span class="ident" id="5278826">Write</span><span class="op" id="5278831">(</span><span class="ident" id="5278832">s</span><span class="op" id="5278833">[</span><span class="ident" id="5278834">start</span><span class="op" id="5278839">:</span><span class="ident" id="5278840">i</span><span class="op" id="5278841">]</span><span class="op" id="5278842">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278852">e</span><span class="op" id="5278853">.</span><span class="ident" id="5278854">WriteString</span><span class="op" id="5278865">(</span><span class="string" id="5278866">`\u202`</span><span class="op" id="5278873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278878">e</span><span class="op" id="5278879">.</span><span class="ident" id="5278880">WriteByte</span><span class="op" id="5278889">(</span><span class="ident" id="5278890">hex</span><span class="op" id="5278893">[</span><span class="ident" id="5278894">c</span><span class="op" id="5278895">&amp;</span><span class="num" id="5278896">0xF</span><span class="op" id="5278899">]</span><span class="op" id="5278900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278905">i</span>&nbsp;<span class="op" id="5278907">+=</span>&nbsp;<span class="ident" id="5278910">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278918">start</span>&nbsp;<span class="op" id="5278924">=</span>&nbsp;<span class="ident" id="5278926">i</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278931">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278946">i</span>&nbsp;<span class="op" id="5278948">+=</span>&nbsp;<span class="ident" id="5278951">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5278957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5278960">if</span>&nbsp;<span class="ident" id="5278963">start</span>&nbsp;<span class="op" id="5278969">&lt;</span>&nbsp;<span class="builtinfunc" id="5278971">len</span><span class="op" id="5278974">(</span><span class="ident" id="5278975">s</span><span class="op" id="5278976">)</span>&nbsp;<span class="op" id="5278978">{</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5278982">e</span><span class="op" id="5278983">.</span><span class="ident" id="5278984">Write</span><span class="op" id="5278989">(</span><span class="ident" id="5278990">s</span><span class="op" id="5278991">[</span><span class="ident" id="5278992">start</span><span class="op" id="5278997">:</span><span class="op" id="5278998">]</span><span class="op" id="5278999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5279002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279005">e</span><span class="op" id="5279006">.</span><span class="ident" id="5279007">WriteByte</span><span class="op" id="5279016">(</span><span class="string" id="5279017">&#39;&#34;&#39;</span><span class="op" id="5279020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279023">return</span>&nbsp;<span class="ident" id="5279030">e</span><span class="op" id="5279031">.</span><span class="ident" id="5279032">Len</span><span class="op" id="5279035">(</span><span class="op" id="5279036">)</span>&nbsp;<span class="op" id="5279038">-</span>&nbsp;<span class="ident" id="5279040">len0</span><span class="op" id="5279044">,</span>&nbsp;<span class="ident" id="5279046">nil</span><br>
<span class="lineno"></span><span class="op" id="5279050">}</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span><span class="comment" id="5279053">//&nbsp;A&nbsp;field&nbsp;represents&nbsp;a&nbsp;single&nbsp;field&nbsp;found&nbsp;in&nbsp;a&nbsp;struct.</span><br>
<span class="lineno"></span><span class="keyword" id="5279109">type</span>&nbsp;<span class="ident" id="5279114">field</span>&nbsp;<span class="keyword" id="5279120">struct</span>&nbsp;<span class="op" id="5279127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279130">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5279140">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279148">nameBytes</span>&nbsp;<span class="op" id="5279158">[</span><span class="op" id="5279159">]</span><span class="builtintype" id="5279160">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5279181">//&nbsp;[]byte(name)</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279198">equalFold</span>&nbsp;<span class="keyword" id="5279208">func</span><span class="op" id="5279212">(</span><span class="ident" id="5279213">s</span><span class="op" id="5279214">,</span>&nbsp;<span class="ident" id="5279216">t</span>&nbsp;<span class="op" id="5279218">[</span><span class="op" id="5279219">]</span><span class="builtintype" id="5279220">byte</span><span class="op" id="5279224">)</span>&nbsp;<span class="builtintype" id="5279226">bool</span>&nbsp;<span class="comment" id="5279231">//&nbsp;bytes.EqualFold&nbsp;or&nbsp;equivalent</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279266">tag</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5279276">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279282">index</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5279292">[</span><span class="op" id="5279293">]</span><span class="builtintype" id="5279294">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279299">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5279309">reflect</span><span class="op" id="5279316">.</span><span class="ident" id="5279317">Type</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279323">omitEmpty</span>&nbsp;<span class="builtintype" id="5279333">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279339">quoted</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5279349">bool</span><br>
<span class="lineno"></span><span class="op" id="5279354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5279357">func</span>&nbsp;<span class="ident" id="5279362">fillField</span><span class="op" id="5279371">(</span><span class="ident" id="5279372">f</span>&nbsp;<span class="ident" id="5279374">field</span><span class="op" id="5279379">)</span>&nbsp;<span class="ident" id="5279381">field</span>&nbsp;<span class="op" id="5279387">{</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279390">f</span><span class="op" id="5279391">.</span><span class="ident" id="5279392">nameBytes</span>&nbsp;<span class="op" id="5279402">=</span>&nbsp;<span class="op" id="5279404">[</span><span class="op" id="5279405">]</span><span class="builtintype" id="5279406">byte</span><span class="op" id="5279410">(</span><span class="ident" id="5279411">f</span><span class="op" id="5279412">.</span><span class="ident" id="5279413">name</span><span class="op" id="5279417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5279420">f</span><span class="op" id="5279421">.</span><span class="ident" id="5279422">equalFold</span>&nbsp;<span class="op" id="5279432">=</span>&nbsp;<span class="ident" id="5279434">foldFunc</span><span class="op" id="5279442">(</span><span class="ident" id="5279443">f</span><span class="op" id="5279444">.</span><span class="ident" id="5279445">nameBytes</span><span class="op" id="5279454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279457">return</span>&nbsp;<span class="ident" id="5279464">f</span><br>
<span class="lineno"></span><span class="op" id="5279466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">955</span><span class="comment" id="5279469">//&nbsp;byName&nbsp;sorts&nbsp;field&nbsp;by&nbsp;name,&nbsp;breaking&nbsp;ties&nbsp;with&nbsp;depth,</span><br>
<span class="lineno"></span><span class="comment" id="5279526">//&nbsp;then&nbsp;breaking&nbsp;ties&nbsp;with&nbsp;&#34;name&nbsp;came&nbsp;from&nbsp;json&nbsp;tag&#34;,&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="5279585">//&nbsp;breaking&nbsp;ties&nbsp;with&nbsp;index&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="keyword" id="5279623">type</span>&nbsp;<span class="ident" id="5279628">byName</span>&nbsp;<span class="op" id="5279635">[</span><span class="op" id="5279636">]</span><span class="ident" id="5279637">field</span><br>
<span class="lineno"></span><br>
<span class="lineno">960</span><span class="keyword" id="5279644">func</span>&nbsp;<span class="op" id="5279649">(</span><span class="ident" id="5279650">x</span>&nbsp;<span class="ident" id="5279652">byName</span><span class="op" id="5279658">)</span>&nbsp;<span class="ident" id="5279660">Len</span><span class="op" id="5279663">(</span><span class="op" id="5279664">)</span>&nbsp;<span class="builtintype" id="5279666">int</span>&nbsp;<span class="op" id="5279670">{</span>&nbsp;<span class="keyword" id="5279672">return</span>&nbsp;<span class="builtinfunc" id="5279679">len</span><span class="op" id="5279682">(</span><span class="ident" id="5279683">x</span><span class="op" id="5279684">)</span>&nbsp;<span class="op" id="5279686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5279689">func</span>&nbsp;<span class="op" id="5279694">(</span><span class="ident" id="5279695">x</span>&nbsp;<span class="ident" id="5279697">byName</span><span class="op" id="5279703">)</span>&nbsp;<span class="ident" id="5279705">Swap</span><span class="op" id="5279709">(</span><span class="ident" id="5279710">i</span><span class="op" id="5279711">,</span>&nbsp;<span class="ident" id="5279713">j</span>&nbsp;<span class="builtintype" id="5279715">int</span><span class="op" id="5279718">)</span>&nbsp;<span class="op" id="5279720">{</span>&nbsp;<span class="ident" id="5279722">x</span><span class="op" id="5279723">[</span><span class="ident" id="5279724">i</span><span class="op" id="5279725">]</span><span class="op" id="5279726">,</span>&nbsp;<span class="ident" id="5279728">x</span><span class="op" id="5279729">[</span><span class="ident" id="5279730">j</span><span class="op" id="5279731">]</span>&nbsp;<span class="op" id="5279733">=</span>&nbsp;<span class="ident" id="5279735">x</span><span class="op" id="5279736">[</span><span class="ident" id="5279737">j</span><span class="op" id="5279738">]</span><span class="op" id="5279739">,</span>&nbsp;<span class="ident" id="5279741">x</span><span class="op" id="5279742">[</span><span class="ident" id="5279743">i</span><span class="op" id="5279744">]</span>&nbsp;<span class="op" id="5279746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5279749">func</span>&nbsp;<span class="op" id="5279754">(</span><span class="ident" id="5279755">x</span>&nbsp;<span class="ident" id="5279757">byName</span><span class="op" id="5279763">)</span>&nbsp;<span class="ident" id="5279765">Less</span><span class="op" id="5279769">(</span><span class="ident" id="5279770">i</span><span class="op" id="5279771">,</span>&nbsp;<span class="ident" id="5279773">j</span>&nbsp;<span class="builtintype" id="5279775">int</span><span class="op" id="5279778">)</span>&nbsp;<span class="builtintype" id="5279780">bool</span>&nbsp;<span class="op" id="5279785">{</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279788">if</span>&nbsp;<span class="ident" id="5279791">x</span><span class="op" id="5279792">[</span><span class="ident" id="5279793">i</span><span class="op" id="5279794">]</span><span class="op" id="5279795">.</span><span class="ident" id="5279796">name</span>&nbsp;<span class="op" id="5279801">!=</span>&nbsp;<span class="ident" id="5279804">x</span><span class="op" id="5279805">[</span><span class="ident" id="5279806">j</span><span class="op" id="5279807">]</span><span class="op" id="5279808">.</span><span class="ident" id="5279809">name</span>&nbsp;<span class="op" id="5279814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279818">return</span>&nbsp;<span class="ident" id="5279825">x</span><span class="op" id="5279826">[</span><span class="ident" id="5279827">i</span><span class="op" id="5279828">]</span><span class="op" id="5279829">.</span><span class="ident" id="5279830">name</span>&nbsp;<span class="op" id="5279835">&lt;</span>&nbsp;<span class="ident" id="5279837">x</span><span class="op" id="5279838">[</span><span class="ident" id="5279839">j</span><span class="op" id="5279840">]</span><span class="op" id="5279841">.</span><span class="ident" id="5279842">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5279848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279851">if</span>&nbsp;<span class="builtinfunc" id="5279854">len</span><span class="op" id="5279857">(</span><span class="ident" id="5279858">x</span><span class="op" id="5279859">[</span><span class="ident" id="5279860">i</span><span class="op" id="5279861">]</span><span class="op" id="5279862">.</span><span class="ident" id="5279863">index</span><span class="op" id="5279868">)</span>&nbsp;<span class="op" id="5279870">!=</span>&nbsp;<span class="builtinfunc" id="5279873">len</span><span class="op" id="5279876">(</span><span class="ident" id="5279877">x</span><span class="op" id="5279878">[</span><span class="ident" id="5279879">j</span><span class="op" id="5279880">]</span><span class="op" id="5279881">.</span><span class="ident" id="5279882">index</span><span class="op" id="5279887">)</span>&nbsp;<span class="op" id="5279889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279893">return</span>&nbsp;<span class="builtinfunc" id="5279900">len</span><span class="op" id="5279903">(</span><span class="ident" id="5279904">x</span><span class="op" id="5279905">[</span><span class="ident" id="5279906">i</span><span class="op" id="5279907">]</span><span class="op" id="5279908">.</span><span class="ident" id="5279909">index</span><span class="op" id="5279914">)</span>&nbsp;<span class="op" id="5279916">&lt;</span>&nbsp;<span class="builtinfunc" id="5279918">len</span><span class="op" id="5279921">(</span><span class="ident" id="5279922">x</span><span class="op" id="5279923">[</span><span class="ident" id="5279924">j</span><span class="op" id="5279925">]</span><span class="op" id="5279926">.</span><span class="ident" id="5279927">index</span><span class="op" id="5279932">)</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5279935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279938">if</span>&nbsp;<span class="ident" id="5279941">x</span><span class="op" id="5279942">[</span><span class="ident" id="5279943">i</span><span class="op" id="5279944">]</span><span class="op" id="5279945">.</span><span class="ident" id="5279946">tag</span>&nbsp;<span class="op" id="5279950">!=</span>&nbsp;<span class="ident" id="5279953">x</span><span class="op" id="5279954">[</span><span class="ident" id="5279955">j</span><span class="op" id="5279956">]</span><span class="op" id="5279957">.</span><span class="ident" id="5279958">tag</span>&nbsp;<span class="op" id="5279962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279966">return</span>&nbsp;<span class="ident" id="5279973">x</span><span class="op" id="5279974">[</span><span class="ident" id="5279975">i</span><span class="op" id="5279976">]</span><span class="op" id="5279977">.</span><span class="ident" id="5279978">tag</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5279983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5279986">return</span>&nbsp;<span class="ident" id="5279993">byIndex</span><span class="op" id="5280000">(</span><span class="ident" id="5280001">x</span><span class="op" id="5280002">)</span><span class="op" id="5280003">.</span><span class="ident" id="5280004">Less</span><span class="op" id="5280008">(</span><span class="ident" id="5280009">i</span><span class="op" id="5280010">,</span>&nbsp;<span class="ident" id="5280012">j</span><span class="op" id="5280013">)</span><br>
<span class="lineno">975</span><span class="op" id="5280015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5280018">//&nbsp;byIndex&nbsp;sorts&nbsp;field&nbsp;by&nbsp;index&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="keyword" id="5280060">type</span>&nbsp;<span class="ident" id="5280065">byIndex</span>&nbsp;<span class="op" id="5280073">[</span><span class="op" id="5280074">]</span><span class="ident" id="5280075">field</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="5280082">func</span>&nbsp;<span class="op" id="5280087">(</span><span class="ident" id="5280088">x</span>&nbsp;<span class="ident" id="5280090">byIndex</span><span class="op" id="5280097">)</span>&nbsp;<span class="ident" id="5280099">Len</span><span class="op" id="5280102">(</span><span class="op" id="5280103">)</span>&nbsp;<span class="builtintype" id="5280105">int</span>&nbsp;<span class="op" id="5280109">{</span>&nbsp;<span class="keyword" id="5280111">return</span>&nbsp;<span class="builtinfunc" id="5280118">len</span><span class="op" id="5280121">(</span><span class="ident" id="5280122">x</span><span class="op" id="5280123">)</span>&nbsp;<span class="op" id="5280125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5280128">func</span>&nbsp;<span class="op" id="5280133">(</span><span class="ident" id="5280134">x</span>&nbsp;<span class="ident" id="5280136">byIndex</span><span class="op" id="5280143">)</span>&nbsp;<span class="ident" id="5280145">Swap</span><span class="op" id="5280149">(</span><span class="ident" id="5280150">i</span><span class="op" id="5280151">,</span>&nbsp;<span class="ident" id="5280153">j</span>&nbsp;<span class="builtintype" id="5280155">int</span><span class="op" id="5280158">)</span>&nbsp;<span class="op" id="5280160">{</span>&nbsp;<span class="ident" id="5280162">x</span><span class="op" id="5280163">[</span><span class="ident" id="5280164">i</span><span class="op" id="5280165">]</span><span class="op" id="5280166">,</span>&nbsp;<span class="ident" id="5280168">x</span><span class="op" id="5280169">[</span><span class="ident" id="5280170">j</span><span class="op" id="5280171">]</span>&nbsp;<span class="op" id="5280173">=</span>&nbsp;<span class="ident" id="5280175">x</span><span class="op" id="5280176">[</span><span class="ident" id="5280177">j</span><span class="op" id="5280178">]</span><span class="op" id="5280179">,</span>&nbsp;<span class="ident" id="5280181">x</span><span class="op" id="5280182">[</span><span class="ident" id="5280183">i</span><span class="op" id="5280184">]</span>&nbsp;<span class="op" id="5280186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5280189">func</span>&nbsp;<span class="op" id="5280194">(</span><span class="ident" id="5280195">x</span>&nbsp;<span class="ident" id="5280197">byIndex</span><span class="op" id="5280204">)</span>&nbsp;<span class="ident" id="5280206">Less</span><span class="op" id="5280210">(</span><span class="ident" id="5280211">i</span><span class="op" id="5280212">,</span>&nbsp;<span class="ident" id="5280214">j</span>&nbsp;<span class="builtintype" id="5280216">int</span><span class="op" id="5280219">)</span>&nbsp;<span class="builtintype" id="5280221">bool</span>&nbsp;<span class="op" id="5280226">{</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5280229">for</span>&nbsp;<span class="ident" id="5280233">k</span><span class="op" id="5280234">,</span>&nbsp;<span class="ident" id="5280236">xik</span>&nbsp;<span class="op" id="5280240">:=</span>&nbsp;<span class="keyword" id="5280243">range</span>&nbsp;<span class="ident" id="5280249">x</span><span class="op" id="5280250">[</span><span class="ident" id="5280251">i</span><span class="op" id="5280252">]</span><span class="op" id="5280253">.</span><span class="ident" id="5280254">index</span>&nbsp;<span class="op" id="5280260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5280264">if</span>&nbsp;<span class="ident" id="5280267">k</span>&nbsp;<span class="op" id="5280269">&gt;=</span>&nbsp;<span class="builtinfunc" id="5280272">len</span><span class="op" id="5280275">(</span><span class="ident" id="5280276">x</span><span class="op" id="5280277">[</span><span class="ident" id="5280278">j</span><span class="op" id="5280279">]</span><span class="op" id="5280280">.</span><span class="ident" id="5280281">index</span><span class="op" id="5280286">)</span>&nbsp;<span class="op" id="5280288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5280293">return</span>&nbsp;<span class="builtintype" id="5280300">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5280308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5280312">if</span>&nbsp;<span class="ident" id="5280315">xik</span>&nbsp;<span class="op" id="5280319">!=</span>&nbsp;<span class="ident" id="5280322">x</span><span class="op" id="5280323">[</span><span class="ident" id="5280324">j</span><span class="op" id="5280325">]</span><span class="op" id="5280326">.</span><span class="ident" id="5280327">index</span><span class="op" id="5280332">[</span><span class="ident" id="5280333">k</span><span class="op" id="5280334">]</span>&nbsp;<span class="op" id="5280336">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5280341">return</span>&nbsp;<span class="ident" id="5280348">xik</span>&nbsp;<span class="op" id="5280352">&lt;</span>&nbsp;<span class="ident" id="5280354">x</span><span class="op" id="5280355">[</span><span class="ident" id="5280356">j</span><span class="op" id="5280357">]</span><span class="op" id="5280358">.</span><span class="ident" id="5280359">index</span><span class="op" id="5280364">[</span><span class="ident" id="5280365">k</span><span class="op" id="5280366">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5280370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5280373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5280376">return</span>&nbsp;<span class="builtinfunc" id="5280383">len</span><span class="op" id="5280386">(</span><span class="ident" id="5280387">x</span><span class="op" id="5280388">[</span><span class="ident" id="5280389">i</span><span class="op" id="5280390">]</span><span class="op" id="5280391">.</span><span class="ident" id="5280392">index</span><span class="op" id="5280397">)</span>&nbsp;<span class="op" id="5280399">&lt;</span>&nbsp;<span class="builtinfunc" id="5280401">len</span><span class="op" id="5280404">(</span><span class="ident" id="5280405">x</span><span class="op" id="5280406">[</span><span class="ident" id="5280407">j</span><span class="op" id="5280408">]</span><span class="op" id="5280409">.</span><span class="ident" id="5280410">index</span><span class="op" id="5280415">)</span><br>
<span class="lineno"></span><span class="op" id="5280417">}</span><br>
<span class="lineno">995</span><br>
<span class="lineno"></span><span class="comment" id="5280420">//&nbsp;typeFields&nbsp;returns&nbsp;a&nbsp;list&nbsp;of&nbsp;fields&nbsp;that&nbsp;JSON&nbsp;should&nbsp;recognize&nbsp;for&nbsp;the&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="5280506">//&nbsp;The&nbsp;algorithm&nbsp;is&nbsp;breadth-first&nbsp;search&nbsp;over&nbsp;the&nbsp;set&nbsp;of&nbsp;structs&nbsp;to&nbsp;include&nbsp;-&nbsp;the&nbsp;top&nbsp;struct</span><br>
<span class="lineno"></span><span class="comment" id="5280599">//&nbsp;and&nbsp;then&nbsp;any&nbsp;reachable&nbsp;anonymous&nbsp;structs.</span><br>
<span class="lineno"></span><span class="keyword" id="5280644">func</span>&nbsp;<span class="ident" id="5280649">typeFields</span><span class="op" id="5280659">(</span><span class="ident" id="5280660">t</span>&nbsp;<span class="ident" id="5280662">reflect</span><span class="op" id="5280669">.</span><span class="ident" id="5280670">Type</span><span class="op" id="5280674">)</span>&nbsp;<span class="op" id="5280676">[</span><span class="op" id="5280677">]</span><span class="ident" id="5280678">field</span>&nbsp;<span class="op" id="5280684">{</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5280687">//&nbsp;Anonymous&nbsp;fields&nbsp;to&nbsp;explore&nbsp;at&nbsp;the&nbsp;current&nbsp;level&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280754">current</span>&nbsp;<span class="op" id="5280762">:=</span>&nbsp;<span class="op" id="5280765">[</span><span class="op" id="5280766">]</span><span class="ident" id="5280767">field</span><span class="op" id="5280772">{</span><span class="op" id="5280773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280776">next</span>&nbsp;<span class="op" id="5280781">:=</span>&nbsp;<span class="op" id="5280784">[</span><span class="op" id="5280785">]</span><span class="ident" id="5280786">field</span><span class="op" id="5280791">{</span><span class="op" id="5280792">{</span><span class="ident" id="5280793">typ</span><span class="op" id="5280796">:</span>&nbsp;<span class="ident" id="5280798">t</span><span class="op" id="5280799">}</span><span class="op" id="5280800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5280804">//&nbsp;Count&nbsp;of&nbsp;queued&nbsp;names&nbsp;for&nbsp;current&nbsp;level&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280862">count</span>&nbsp;<span class="op" id="5280868">:=</span>&nbsp;<span class="keyword" id="5280871">map</span><span class="op" id="5280874">[</span><span class="ident" id="5280875">reflect</span><span class="op" id="5280882">.</span><span class="ident" id="5280883">Type</span><span class="op" id="5280887">]</span><span class="builtintype" id="5280888">int</span><span class="op" id="5280891">{</span><span class="op" id="5280892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280895">nextCount</span>&nbsp;<span class="op" id="5280905">:=</span>&nbsp;<span class="keyword" id="5280908">map</span><span class="op" id="5280911">[</span><span class="ident" id="5280912">reflect</span><span class="op" id="5280919">.</span><span class="ident" id="5280920">Type</span><span class="op" id="5280924">]</span><span class="builtintype" id="5280925">int</span><span class="op" id="5280928">{</span><span class="op" id="5280929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5280933">//&nbsp;Types&nbsp;already&nbsp;visited&nbsp;at&nbsp;an&nbsp;earlier&nbsp;level.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5280980">visited</span>&nbsp;<span class="op" id="5280988">:=</span>&nbsp;<span class="keyword" id="5280991">map</span><span class="op" id="5280994">[</span><span class="ident" id="5280995">reflect</span><span class="op" id="5281002">.</span><span class="ident" id="5281003">Type</span><span class="op" id="5281007">]</span><span class="builtintype" id="5281008">bool</span><span class="op" id="5281012">{</span><span class="op" id="5281013">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5281017">//&nbsp;Fields&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281035">var</span>&nbsp;<span class="ident" id="5281039">fields</span>&nbsp;<span class="op" id="5281046">[</span><span class="op" id="5281047">]</span><span class="ident" id="5281048">field</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281056">for</span>&nbsp;<span class="builtinfunc" id="5281060">len</span><span class="op" id="5281063">(</span><span class="ident" id="5281064">next</span><span class="op" id="5281068">)</span>&nbsp;<span class="op" id="5281070">&gt;</span>&nbsp;<span class="num" id="5281072">0</span>&nbsp;<span class="op" id="5281074">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281078">current</span><span class="op" id="5281085">,</span>&nbsp;<span class="ident" id="5281087">next</span>&nbsp;<span class="op" id="5281092">=</span>&nbsp;<span class="ident" id="5281094">next</span><span class="op" id="5281098">,</span>&nbsp;<span class="ident" id="5281100">current</span><span class="op" id="5281107">[</span><span class="op" id="5281108">:</span><span class="num" id="5281109">0</span><span class="op" id="5281110">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281114">count</span><span class="op" id="5281119">,</span>&nbsp;<span class="ident" id="5281121">nextCount</span>&nbsp;<span class="op" id="5281131">=</span>&nbsp;<span class="ident" id="5281133">nextCount</span><span class="op" id="5281142">,</span>&nbsp;<span class="keyword" id="5281144">map</span><span class="op" id="5281147">[</span><span class="ident" id="5281148">reflect</span><span class="op" id="5281155">.</span><span class="ident" id="5281156">Type</span><span class="op" id="5281160">]</span><span class="builtintype" id="5281161">int</span><span class="op" id="5281164">{</span><span class="op" id="5281165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281170">for</span>&nbsp;<span class="ident" id="5281174">_</span><span class="op" id="5281175">,</span>&nbsp;<span class="ident" id="5281177">f</span>&nbsp;<span class="op" id="5281179">:=</span>&nbsp;<span class="keyword" id="5281182">range</span>&nbsp;<span class="ident" id="5281188">current</span>&nbsp;<span class="op" id="5281196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281201">if</span>&nbsp;<span class="ident" id="5281204">visited</span><span class="op" id="5281211">[</span><span class="ident" id="5281212">f</span><span class="op" id="5281213">.</span><span class="ident" id="5281214">typ</span><span class="op" id="5281217">]</span>&nbsp;<span class="op" id="5281219">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281225">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5281237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281242">visited</span><span class="op" id="5281249">[</span><span class="ident" id="5281250">f</span><span class="op" id="5281251">.</span><span class="ident" id="5281252">typ</span><span class="op" id="5281255">]</span>&nbsp;<span class="op" id="5281257">=</span>&nbsp;<span class="builtintype" id="5281259">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5281268">//&nbsp;Scan&nbsp;f.typ&nbsp;for&nbsp;fields&nbsp;to&nbsp;include.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281308">for</span>&nbsp;<span class="ident" id="5281312">i</span>&nbsp;<span class="op" id="5281314">:=</span>&nbsp;<span class="num" id="5281317">0</span><span class="op" id="5281318">;</span>&nbsp;<span class="ident" id="5281320">i</span>&nbsp;<span class="op" id="5281322">&lt;</span>&nbsp;<span class="ident" id="5281324">f</span><span class="op" id="5281325">.</span><span class="ident" id="5281326">typ</span><span class="op" id="5281329">.</span><span class="ident" id="5281330">NumField</span><span class="op" id="5281338">(</span><span class="op" id="5281339">)</span><span class="op" id="5281340">;</span>&nbsp;<span class="ident" id="5281342">i</span><span class="op" id="5281343">++</span>&nbsp;<span class="op" id="5281346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281352">sf</span>&nbsp;<span class="op" id="5281355">:=</span>&nbsp;<span class="ident" id="5281358">f</span><span class="op" id="5281359">.</span><span class="ident" id="5281360">typ</span><span class="op" id="5281363">.</span><span class="ident" id="5281364">Field</span><span class="op" id="5281369">(</span><span class="ident" id="5281370">i</span><span class="op" id="5281371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281377">if</span>&nbsp;<span class="ident" id="5281380">sf</span><span class="op" id="5281382">.</span><span class="ident" id="5281383">PkgPath</span>&nbsp;<span class="op" id="5281391">!=</span>&nbsp;<span class="string" id="5281394">&#34;&#34;</span>&nbsp;<span class="op" id="5281397">{</span>&nbsp;<span class="comment" id="5281399">//&nbsp;unexported</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281418">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5281431">}</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281437">tag</span>&nbsp;<span class="op" id="5281441">:=</span>&nbsp;<span class="ident" id="5281444">sf</span><span class="op" id="5281446">.</span><span class="ident" id="5281447">Tag</span><span class="op" id="5281450">.</span><span class="ident" id="5281451">Get</span><span class="op" id="5281454">(</span><span class="string" id="5281455">&#34;json&#34;</span><span class="op" id="5281461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281467">if</span>&nbsp;<span class="ident" id="5281470">tag</span>&nbsp;<span class="op" id="5281474">==</span>&nbsp;<span class="string" id="5281477">&#34;-&#34;</span>&nbsp;<span class="op" id="5281481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281488">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5281501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281507">name</span><span class="op" id="5281511">,</span>&nbsp;<span class="ident" id="5281513">opts</span>&nbsp;<span class="op" id="5281518">:=</span>&nbsp;<span class="ident" id="5281521">parseTag</span><span class="op" id="5281529">(</span><span class="ident" id="5281530">tag</span><span class="op" id="5281533">)</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281539">if</span>&nbsp;<span class="op" id="5281542">!</span><span class="ident" id="5281543">isValidTag</span><span class="op" id="5281553">(</span><span class="ident" id="5281554">name</span><span class="op" id="5281558">)</span>&nbsp;<span class="op" id="5281560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281567">name</span>&nbsp;<span class="op" id="5281572">=</span>&nbsp;<span class="string" id="5281574">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5281581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281587">index</span>&nbsp;<span class="op" id="5281593">:=</span>&nbsp;<span class="builtinfunc" id="5281596">make</span><span class="op" id="5281600">(</span><span class="op" id="5281601">[</span><span class="op" id="5281602">]</span><span class="builtintype" id="5281603">int</span><span class="op" id="5281606">,</span>&nbsp;<span class="builtinfunc" id="5281608">len</span><span class="op" id="5281611">(</span><span class="ident" id="5281612">f</span><span class="op" id="5281613">.</span><span class="ident" id="5281614">index</span><span class="op" id="5281619">)</span><span class="op" id="5281620">+</span><span class="num" id="5281621">1</span><span class="op" id="5281622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5281628">copy</span><span class="op" id="5281632">(</span><span class="ident" id="5281633">index</span><span class="op" id="5281638">,</span>&nbsp;<span class="ident" id="5281640">f</span><span class="op" id="5281641">.</span><span class="ident" id="5281642">index</span><span class="op" id="5281647">)</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281653">index</span><span class="op" id="5281658">[</span><span class="builtinfunc" id="5281659">len</span><span class="op" id="5281662">(</span><span class="ident" id="5281663">f</span><span class="op" id="5281664">.</span><span class="ident" id="5281665">index</span><span class="op" id="5281670">)</span><span class="op" id="5281671">]</span>&nbsp;<span class="op" id="5281673">=</span>&nbsp;<span class="ident" id="5281675">i</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281682">ft</span>&nbsp;<span class="op" id="5281685">:=</span>&nbsp;<span class="ident" id="5281688">sf</span><span class="op" id="5281690">.</span><span class="ident" id="5281691">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281700">if</span>&nbsp;<span class="ident" id="5281703">ft</span><span class="op" id="5281705">.</span><span class="ident" id="5281706">Name</span><span class="op" id="5281710">(</span><span class="op" id="5281711">)</span>&nbsp;<span class="op" id="5281713">==</span>&nbsp;<span class="string" id="5281716">&#34;&#34;</span>&nbsp;<span class="op" id="5281719">&amp;&amp;</span>&nbsp;<span class="ident" id="5281722">ft</span><span class="op" id="5281724">.</span><span class="ident" id="5281725">Kind</span><span class="op" id="5281729">(</span><span class="op" id="5281730">)</span>&nbsp;<span class="op" id="5281732">==</span>&nbsp;<span class="ident" id="5281735">reflect</span><span class="op" id="5281742">.</span><span class="ident" id="5281743">Ptr</span>&nbsp;<span class="op" id="5281747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5281754">//&nbsp;Follow&nbsp;pointer.</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281778">ft</span>&nbsp;<span class="op" id="5281781">=</span>&nbsp;<span class="ident" id="5281783">ft</span><span class="op" id="5281785">.</span><span class="ident" id="5281786">Elem</span><span class="op" id="5281790">(</span><span class="op" id="5281791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5281797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5281804">//&nbsp;Record&nbsp;found&nbsp;field&nbsp;and&nbsp;index&nbsp;sequence.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281850">if</span>&nbsp;<span class="ident" id="5281853">name</span>&nbsp;<span class="op" id="5281858">!=</span>&nbsp;<span class="string" id="5281861">&#34;&#34;</span>&nbsp;<span class="op" id="5281864">||</span>&nbsp;<span class="op" id="5281867">!</span><span class="ident" id="5281868">sf</span><span class="op" id="5281870">.</span><span class="ident" id="5281871">Anonymous</span>&nbsp;<span class="op" id="5281881">||</span>&nbsp;<span class="ident" id="5281884">ft</span><span class="op" id="5281886">.</span><span class="ident" id="5281887">Kind</span><span class="op" id="5281891">(</span><span class="op" id="5281892">)</span>&nbsp;<span class="op" id="5281894">!=</span>&nbsp;<span class="ident" id="5281897">reflect</span><span class="op" id="5281904">.</span><span class="ident" id="5281905">Struct</span>&nbsp;<span class="op" id="5281912">{</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281919">tagged</span>&nbsp;<span class="op" id="5281926">:=</span>&nbsp;<span class="ident" id="5281929">name</span>&nbsp;<span class="op" id="5281934">!=</span>&nbsp;<span class="string" id="5281937">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5281945">if</span>&nbsp;<span class="ident" id="5281948">name</span>&nbsp;<span class="op" id="5281953">==</span>&nbsp;<span class="string" id="5281956">&#34;&#34;</span>&nbsp;<span class="op" id="5281959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281967">name</span>&nbsp;<span class="op" id="5281972">=</span>&nbsp;<span class="ident" id="5281974">sf</span><span class="op" id="5281976">.</span><span class="ident" id="5281977">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5281987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5281994">fields</span>&nbsp;<span class="op" id="5282001">=</span>&nbsp;<span class="builtinfunc" id="5282003">append</span><span class="op" id="5282009">(</span><span class="ident" id="5282010">fields</span><span class="op" id="5282016">,</span>&nbsp;<span class="ident" id="5282018">fillField</span><span class="op" id="5282027">(</span><span class="ident" id="5282028">field</span><span class="op" id="5282033">{</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282041">name</span><span class="op" id="5282045">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5282052">name</span><span class="op" id="5282056">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282064">tag</span><span class="op" id="5282067">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5282075">tagged</span><span class="op" id="5282081">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282089">index</span><span class="op" id="5282094">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5282100">index</span><span class="op" id="5282105">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282113">typ</span><span class="op" id="5282116">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5282124">ft</span><span class="op" id="5282126">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282134">omitEmpty</span><span class="op" id="5282143">:</span>&nbsp;<span class="ident" id="5282145">opts</span><span class="op" id="5282149">.</span><span class="ident" id="5282150">Contains</span><span class="op" id="5282158">(</span><span class="string" id="5282159">&#34;omitempty&#34;</span><span class="op" id="5282170">)</span><span class="op" id="5282171">,</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282179">quoted</span><span class="op" id="5282185">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5282190">opts</span><span class="op" id="5282194">.</span><span class="ident" id="5282195">Contains</span><span class="op" id="5282203">(</span><span class="string" id="5282204">&#34;string&#34;</span><span class="op" id="5282212">)</span><span class="op" id="5282213">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282220">}</span><span class="op" id="5282221">)</span><span class="op" id="5282222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5282229">if</span>&nbsp;<span class="ident" id="5282232">count</span><span class="op" id="5282237">[</span><span class="ident" id="5282238">f</span><span class="op" id="5282239">.</span><span class="ident" id="5282240">typ</span><span class="op" id="5282243">]</span>&nbsp;<span class="op" id="5282245">&gt;</span>&nbsp;<span class="num" id="5282247">1</span>&nbsp;<span class="op" id="5282249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5282257">//&nbsp;If&nbsp;there&nbsp;were&nbsp;multiple&nbsp;instances,&nbsp;add&nbsp;a&nbsp;second,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5282314">//&nbsp;so&nbsp;that&nbsp;the&nbsp;annihilation&nbsp;code&nbsp;will&nbsp;see&nbsp;a&nbsp;duplicate.</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5282375">//&nbsp;It&nbsp;only&nbsp;cares&nbsp;about&nbsp;the&nbsp;distinction&nbsp;between&nbsp;1&nbsp;or&nbsp;2,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5282436">//&nbsp;so&nbsp;don&#39;t&nbsp;bother&nbsp;generating&nbsp;any&nbsp;more&nbsp;copies.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282489">fields</span>&nbsp;<span class="op" id="5282496">=</span>&nbsp;<span class="builtinfunc" id="5282498">append</span><span class="op" id="5282504">(</span><span class="ident" id="5282505">fields</span><span class="op" id="5282511">,</span>&nbsp;<span class="ident" id="5282513">fields</span><span class="op" id="5282519">[</span><span class="builtinfunc" id="5282520">len</span><span class="op" id="5282523">(</span><span class="ident" id="5282524">fields</span><span class="op" id="5282530">)</span><span class="op" id="5282531">-</span><span class="num" id="5282532">1</span><span class="op" id="5282533">]</span><span class="op" id="5282534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5282548">continue</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5282568">//&nbsp;Record&nbsp;new&nbsp;anonymous&nbsp;struct&nbsp;to&nbsp;explore&nbsp;in&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282629">nextCount</span><span class="op" id="5282638">[</span><span class="ident" id="5282639">ft</span><span class="op" id="5282641">]</span><span class="op" id="5282642">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5282649">if</span>&nbsp;<span class="ident" id="5282652">nextCount</span><span class="op" id="5282661">[</span><span class="ident" id="5282662">ft</span><span class="op" id="5282664">]</span>&nbsp;<span class="op" id="5282666">==</span>&nbsp;<span class="num" id="5282669">1</span>&nbsp;<span class="op" id="5282671">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282678">next</span>&nbsp;<span class="op" id="5282683">=</span>&nbsp;<span class="builtinfunc" id="5282685">append</span><span class="op" id="5282691">(</span><span class="ident" id="5282692">next</span><span class="op" id="5282696">,</span>&nbsp;<span class="ident" id="5282698">fillField</span><span class="op" id="5282707">(</span><span class="ident" id="5282708">field</span><span class="op" id="5282713">{</span><span class="ident" id="5282714">name</span><span class="op" id="5282718">:</span>&nbsp;<span class="ident" id="5282720">ft</span><span class="op" id="5282722">.</span><span class="ident" id="5282723">Name</span><span class="op" id="5282727">(</span><span class="op" id="5282728">)</span><span class="op" id="5282729">,</span>&nbsp;<span class="ident" id="5282731">index</span><span class="op" id="5282736">:</span>&nbsp;<span class="ident" id="5282738">index</span><span class="op" id="5282743">,</span>&nbsp;<span class="ident" id="5282745">typ</span><span class="op" id="5282748">:</span>&nbsp;<span class="ident" id="5282750">ft</span><span class="op" id="5282752">}</span><span class="op" id="5282753">)</span><span class="op" id="5282754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5282772">}</span><br>
<span class="lineno">1080</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5282776">sort</span><span class="op" id="5282780">.</span><span class="ident" id="5282781">Sort</span><span class="op" id="5282785">(</span><span class="ident" id="5282786">byName</span><span class="op" id="5282792">(</span><span class="ident" id="5282793">fields</span><span class="op" id="5282799">)</span><span class="op" id="5282800">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5282804">//&nbsp;Delete&nbsp;all&nbsp;fields&nbsp;that&nbsp;are&nbsp;hidden&nbsp;by&nbsp;the&nbsp;Go&nbsp;rules&nbsp;for&nbsp;embedded&nbsp;fields,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5282879">//&nbsp;except&nbsp;that&nbsp;fields&nbsp;with&nbsp;JSON&nbsp;tags&nbsp;are&nbsp;promoted.</span><br>
<span class="lineno">1085</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5282932">//&nbsp;The&nbsp;fields&nbsp;are&nbsp;sorted&nbsp;in&nbsp;primary&nbsp;order&nbsp;of&nbsp;name,&nbsp;secondary&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283000">//&nbsp;of&nbsp;field&nbsp;index&nbsp;length.&nbsp;Loop&nbsp;over&nbsp;names;&nbsp;for&nbsp;each&nbsp;name,&nbsp;delete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283066">//&nbsp;hidden&nbsp;fields&nbsp;by&nbsp;choosing&nbsp;the&nbsp;one&nbsp;dominant&nbsp;field&nbsp;that&nbsp;survives.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283134">out</span>&nbsp;<span class="op" id="5283138">:=</span>&nbsp;<span class="ident" id="5283141">fields</span><span class="op" id="5283147">[</span><span class="op" id="5283148">:</span><span class="num" id="5283149">0</span><span class="op" id="5283150">]</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5283153">for</span>&nbsp;<span class="ident" id="5283157">advance</span><span class="op" id="5283164">,</span>&nbsp;<span class="ident" id="5283166">i</span>&nbsp;<span class="op" id="5283168">:=</span>&nbsp;<span class="num" id="5283171">0</span><span class="op" id="5283172">,</span>&nbsp;<span class="num" id="5283174">0</span><span class="op" id="5283175">;</span>&nbsp;<span class="ident" id="5283177">i</span>&nbsp;<span class="op" id="5283179">&lt;</span>&nbsp;<span class="builtinfunc" id="5283181">len</span><span class="op" id="5283184">(</span><span class="ident" id="5283185">fields</span><span class="op" id="5283191">)</span><span class="op" id="5283192">;</span>&nbsp;<span class="ident" id="5283194">i</span>&nbsp;<span class="op" id="5283196">+=</span>&nbsp;<span class="ident" id="5283199">advance</span>&nbsp;<span class="op" id="5283207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283211">//&nbsp;One&nbsp;iteration&nbsp;per&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5283240">//&nbsp;Find&nbsp;the&nbsp;sequence&nbsp;of&nbsp;fields&nbsp;with&nbsp;the&nbsp;name&nbsp;of&nbsp;this&nbsp;first&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283308">fi</span>&nbsp;<span class="op" id="5283311">:=</span>&nbsp;<span class="ident" id="5283314">fields</span><span class="op" id="5283320">[</span><span class="ident" id="5283321">i</span><span class="op" id="5283322">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283326">name</span>&nbsp;<span class="op" id="5283331">:=</span>&nbsp;<span class="ident" id="5283334">fi</span><span class="op" id="5283336">.</span><span class="ident" id="5283337">name</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5283344">for</span>&nbsp;<span class="ident" id="5283348">advance</span>&nbsp;<span class="op" id="5283356">=</span>&nbsp;<span class="num" id="5283358">1</span><span class="op" id="5283359">;</span>&nbsp;<span class="ident" id="5283361">i</span><span class="op" id="5283362">+</span><span class="ident" id="5283363">advance</span>&nbsp;<span class="op" id="5283371">&lt;</span>&nbsp;<span class="builtinfunc" id="5283373">len</span><span class="op" id="5283376">(</span><span class="ident" id="5283377">fields</span><span class="op" id="5283383">)</span><span class="op" id="5283384">;</span>&nbsp;<span class="ident" id="5283386">advance</span><span class="op" id="5283393">++</span>&nbsp;<span class="op" id="5283396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283401">fj</span>&nbsp;<span class="op" id="5283404">:=</span>&nbsp;<span class="ident" id="5283407">fields</span><span class="op" id="5283413">[</span><span class="ident" id="5283414">i</span><span class="op" id="5283415">+</span><span class="ident" id="5283416">advance</span><span class="op" id="5283423">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5283428">if</span>&nbsp;<span class="ident" id="5283431">fj</span><span class="op" id="5283433">.</span><span class="ident" id="5283434">name</span>&nbsp;<span class="op" id="5283439">!=</span>&nbsp;<span class="ident" id="5283442">name</span>&nbsp;<span class="op" id="5283447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5283453">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5283462">}</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5283466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5283470">if</span>&nbsp;<span class="ident" id="5283473">advance</span>&nbsp;<span class="op" id="5283481">==</span>&nbsp;<span class="num" id="5283484">1</span>&nbsp;<span class="op" id="5283486">{</span>&nbsp;<span class="comment" id="5283488">//&nbsp;Only&nbsp;one&nbsp;field&nbsp;with&nbsp;this&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283524">out</span>&nbsp;<span class="op" id="5283528">=</span>&nbsp;<span class="builtinfunc" id="5283530">append</span><span class="op" id="5283536">(</span><span class="ident" id="5283537">out</span><span class="op" id="5283540">,</span>&nbsp;<span class="ident" id="5283542">fi</span><span class="op" id="5283544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5283549">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5283560">}</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283564">dominant</span><span class="op" id="5283572">,</span>&nbsp;<span class="ident" id="5283574">ok</span>&nbsp;<span class="op" id="5283577">:=</span>&nbsp;<span class="ident" id="5283580">dominantField</span><span class="op" id="5283593">(</span><span class="ident" id="5283594">fields</span><span class="op" id="5283600">[</span><span class="ident" id="5283601">i</span>&nbsp;<span class="op" id="5283603">:</span>&nbsp;<span class="ident" id="5283605">i</span><span class="op" id="5283606">+</span><span class="ident" id="5283607">advance</span><span class="op" id="5283614">]</span><span class="op" id="5283615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5283619">if</span>&nbsp;<span class="ident" id="5283622">ok</span>&nbsp;<span class="op" id="5283625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283630">out</span>&nbsp;<span class="op" id="5283634">=</span>&nbsp;<span class="builtinfunc" id="5283636">append</span><span class="op" id="5283642">(</span><span class="ident" id="5283643">out</span><span class="op" id="5283646">,</span>&nbsp;<span class="ident" id="5283648">dominant</span><span class="op" id="5283656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5283660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5283663">}</span><br>
<span class="lineno">1110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283667">fields</span>&nbsp;<span class="op" id="5283674">=</span>&nbsp;<span class="ident" id="5283676">out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5283681">sort</span><span class="op" id="5283685">.</span><span class="ident" id="5283686">Sort</span><span class="op" id="5283690">(</span><span class="ident" id="5283691">byIndex</span><span class="op" id="5283698">(</span><span class="ident" id="5283699">fields</span><span class="op" id="5283705">)</span><span class="op" id="5283706">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5283710">return</span>&nbsp;<span class="ident" id="5283717">fields</span><br>
<span class="lineno">1115</span><span class="op" id="5283724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5283727">//&nbsp;dominantField&nbsp;looks&nbsp;through&nbsp;the&nbsp;fields,&nbsp;all&nbsp;of&nbsp;which&nbsp;are&nbsp;known&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5283796">//&nbsp;have&nbsp;the&nbsp;same&nbsp;name,&nbsp;to&nbsp;find&nbsp;the&nbsp;single&nbsp;field&nbsp;that&nbsp;dominates&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5283863">//&nbsp;others&nbsp;using&nbsp;Go&#39;s&nbsp;embedding&nbsp;rules,&nbsp;modified&nbsp;by&nbsp;the&nbsp;presence&nbsp;of</span><br>
<span class="lineno">1120</span><span class="comment" id="5283929">//&nbsp;JSON&nbsp;tags.&nbsp;If&nbsp;there&nbsp;are&nbsp;multiple&nbsp;top-level&nbsp;fields,&nbsp;the&nbsp;boolean</span><br>
<span class="lineno"></span><span class="comment" id="5283995">//&nbsp;will&nbsp;be&nbsp;false:&nbsp;This&nbsp;condition&nbsp;is&nbsp;an&nbsp;error&nbsp;in&nbsp;Go&nbsp;and&nbsp;we&nbsp;skip&nbsp;all</span><br>
<span class="lineno"></span><span class="comment" id="5284062">//&nbsp;the&nbsp;fields.</span><br>
<span class="lineno"></span><span class="keyword" id="5284077">func</span>&nbsp;<span class="ident" id="5284082">dominantField</span><span class="op" id="5284095">(</span><span class="ident" id="5284096">fields</span>&nbsp;<span class="op" id="5284103">[</span><span class="op" id="5284104">]</span><span class="ident" id="5284105">field</span><span class="op" id="5284110">)</span>&nbsp;<span class="op" id="5284112">(</span><span class="ident" id="5284113">field</span><span class="op" id="5284118">,</span>&nbsp;<span class="builtintype" id="5284120">bool</span><span class="op" id="5284124">)</span>&nbsp;<span class="op" id="5284126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284129">//&nbsp;The&nbsp;fields&nbsp;are&nbsp;sorted&nbsp;in&nbsp;increasing&nbsp;index-length&nbsp;order.&nbsp;The&nbsp;winner</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284200">//&nbsp;must&nbsp;therefore&nbsp;be&nbsp;one&nbsp;with&nbsp;the&nbsp;shortest&nbsp;index&nbsp;length.&nbsp;Drop&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284267">//&nbsp;longer&nbsp;entries,&nbsp;which&nbsp;is&nbsp;easy:&nbsp;just&nbsp;truncate&nbsp;the&nbsp;slice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284327">length</span>&nbsp;<span class="op" id="5284334">:=</span>&nbsp;<span class="builtinfunc" id="5284337">len</span><span class="op" id="5284340">(</span><span class="ident" id="5284341">fields</span><span class="op" id="5284347">[</span><span class="num" id="5284348">0</span><span class="op" id="5284349">]</span><span class="op" id="5284350">.</span><span class="ident" id="5284351">index</span><span class="op" id="5284356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284359">tagged</span>&nbsp;<span class="op" id="5284366">:=</span>&nbsp;<span class="op" id="5284369">-</span><span class="num" id="5284370">1</span>&nbsp;<span class="comment" id="5284372">//&nbsp;Index&nbsp;of&nbsp;first&nbsp;tagged&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284405">for</span>&nbsp;<span class="ident" id="5284409">i</span><span class="op" id="5284410">,</span>&nbsp;<span class="ident" id="5284412">f</span>&nbsp;<span class="op" id="5284414">:=</span>&nbsp;<span class="keyword" id="5284417">range</span>&nbsp;<span class="ident" id="5284423">fields</span>&nbsp;<span class="op" id="5284430">{</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284434">if</span>&nbsp;<span class="builtinfunc" id="5284437">len</span><span class="op" id="5284440">(</span><span class="ident" id="5284441">f</span><span class="op" id="5284442">.</span><span class="ident" id="5284443">index</span><span class="op" id="5284448">)</span>&nbsp;<span class="op" id="5284450">&gt;</span>&nbsp;<span class="ident" id="5284452">length</span>&nbsp;<span class="op" id="5284459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284464">fields</span>&nbsp;<span class="op" id="5284471">=</span>&nbsp;<span class="ident" id="5284473">fields</span><span class="op" id="5284479">[</span><span class="op" id="5284480">:</span><span class="ident" id="5284481">i</span><span class="op" id="5284482">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284487">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5284495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284499">if</span>&nbsp;<span class="ident" id="5284502">f</span><span class="op" id="5284503">.</span><span class="ident" id="5284504">tag</span>&nbsp;<span class="op" id="5284508">{</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284513">if</span>&nbsp;<span class="ident" id="5284516">tagged</span>&nbsp;<span class="op" id="5284523">&gt;=</span>&nbsp;<span class="num" id="5284526">0</span>&nbsp;<span class="op" id="5284528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284534">//&nbsp;Multiple&nbsp;tagged&nbsp;fields&nbsp;at&nbsp;the&nbsp;same&nbsp;level:&nbsp;conflict.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284593">//&nbsp;Return&nbsp;no&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284617">return</span>&nbsp;<span class="ident" id="5284624">field</span><span class="op" id="5284629">{</span><span class="op" id="5284630">}</span><span class="op" id="5284631">,</span>&nbsp;<span class="builtintype" id="5284633">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5284642">}</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284647">tagged</span>&nbsp;<span class="op" id="5284654">=</span>&nbsp;<span class="ident" id="5284656">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5284660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5284663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284666">if</span>&nbsp;<span class="ident" id="5284669">tagged</span>&nbsp;<span class="op" id="5284676">&gt;=</span>&nbsp;<span class="num" id="5284679">0</span>&nbsp;<span class="op" id="5284681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284685">return</span>&nbsp;<span class="ident" id="5284692">fields</span><span class="op" id="5284698">[</span><span class="ident" id="5284699">tagged</span><span class="op" id="5284705">]</span><span class="op" id="5284706">,</span>&nbsp;<span class="builtintype" id="5284708">true</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5284714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284717">//&nbsp;All&nbsp;remaining&nbsp;fields&nbsp;have&nbsp;the&nbsp;same&nbsp;length.&nbsp;If&nbsp;there&#39;s&nbsp;more&nbsp;than&nbsp;one,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284790">//&nbsp;we&nbsp;have&nbsp;a&nbsp;conflict&nbsp;(two&nbsp;fields&nbsp;named&nbsp;&#34;X&#34;&nbsp;at&nbsp;the&nbsp;same&nbsp;level)&nbsp;and&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5284861">//&nbsp;return&nbsp;no&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284882">if</span>&nbsp;<span class="builtinfunc" id="5284885">len</span><span class="op" id="5284888">(</span><span class="ident" id="5284889">fields</span><span class="op" id="5284895">)</span>&nbsp;<span class="op" id="5284897">&gt;</span>&nbsp;<span class="num" id="5284899">1</span>&nbsp;<span class="op" id="5284901">{</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284905">return</span>&nbsp;<span class="ident" id="5284912">field</span><span class="op" id="5284917">{</span><span class="op" id="5284918">}</span><span class="op" id="5284919">,</span>&nbsp;<span class="builtintype" id="5284921">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5284928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5284931">return</span>&nbsp;<span class="ident" id="5284938">fields</span><span class="op" id="5284944">[</span><span class="num" id="5284945">0</span><span class="op" id="5284946">]</span><span class="op" id="5284947">,</span>&nbsp;<span class="builtintype" id="5284949">true</span><br>
<span class="lineno"></span><span class="op" id="5284954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1155</span><span class="keyword" id="5284957">var</span>&nbsp;<span class="ident" id="5284961">fieldCache</span>&nbsp;<span class="keyword" id="5284972">struct</span>&nbsp;<span class="op" id="5284979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284982">sync</span><span class="op" id="5284986">.</span><span class="ident" id="5284987">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5284996">m</span>&nbsp;<span class="keyword" id="5284998">map</span><span class="op" id="5285001">[</span><span class="ident" id="5285002">reflect</span><span class="op" id="5285009">.</span><span class="ident" id="5285010">Type</span><span class="op" id="5285014">]</span><span class="op" id="5285015">[</span><span class="op" id="5285016">]</span><span class="ident" id="5285017">field</span><br>
<span class="lineno"></span><span class="op" id="5285023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1160</span><span class="comment" id="5285026">//&nbsp;cachedTypeFields&nbsp;is&nbsp;like&nbsp;typeFields&nbsp;but&nbsp;uses&nbsp;a&nbsp;cache&nbsp;to&nbsp;avoid&nbsp;repeated&nbsp;work.</span><br>
<span class="lineno"></span><span class="keyword" id="5285106">func</span>&nbsp;<span class="ident" id="5285111">cachedTypeFields</span><span class="op" id="5285127">(</span><span class="ident" id="5285128">t</span>&nbsp;<span class="ident" id="5285130">reflect</span><span class="op" id="5285137">.</span><span class="ident" id="5285138">Type</span><span class="op" id="5285142">)</span>&nbsp;<span class="op" id="5285144">[</span><span class="op" id="5285145">]</span><span class="ident" id="5285146">field</span>&nbsp;<span class="op" id="5285152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285155">fieldCache</span><span class="op" id="5285165">.</span><span class="ident" id="5285166">RLock</span><span class="op" id="5285171">(</span><span class="op" id="5285172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285175">f</span>&nbsp;<span class="op" id="5285177">:=</span>&nbsp;<span class="ident" id="5285180">fieldCache</span><span class="op" id="5285190">.</span><span class="ident" id="5285191">m</span><span class="op" id="5285192">[</span><span class="ident" id="5285193">t</span><span class="op" id="5285194">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285197">fieldCache</span><span class="op" id="5285207">.</span><span class="ident" id="5285208">RUnlock</span><span class="op" id="5285215">(</span><span class="op" id="5285216">)</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285219">if</span>&nbsp;<span class="ident" id="5285222">f</span>&nbsp;<span class="op" id="5285224">!=</span>&nbsp;<span class="ident" id="5285227">nil</span>&nbsp;<span class="op" id="5285231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285235">return</span>&nbsp;<span class="ident" id="5285242">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5285245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5285249">//&nbsp;Compute&nbsp;fields&nbsp;without&nbsp;lock.</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5285282">//&nbsp;Might&nbsp;duplicate&nbsp;effort&nbsp;but&nbsp;won&#39;t&nbsp;hold&nbsp;other&nbsp;computations&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285349">f</span>&nbsp;<span class="op" id="5285351">=</span>&nbsp;<span class="ident" id="5285353">typeFields</span><span class="op" id="5285363">(</span><span class="ident" id="5285364">t</span><span class="op" id="5285365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285368">if</span>&nbsp;<span class="ident" id="5285371">f</span>&nbsp;<span class="op" id="5285373">==</span>&nbsp;<span class="ident" id="5285376">nil</span>&nbsp;<span class="op" id="5285380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285384">f</span>&nbsp;<span class="op" id="5285386">=</span>&nbsp;<span class="op" id="5285388">[</span><span class="op" id="5285389">]</span><span class="ident" id="5285390">field</span><span class="op" id="5285395">{</span><span class="op" id="5285396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5285399">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285403">fieldCache</span><span class="op" id="5285413">.</span><span class="ident" id="5285414">Lock</span><span class="op" id="5285418">(</span><span class="op" id="5285419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285422">if</span>&nbsp;<span class="ident" id="5285425">fieldCache</span><span class="op" id="5285435">.</span><span class="ident" id="5285436">m</span>&nbsp;<span class="op" id="5285438">==</span>&nbsp;<span class="ident" id="5285441">nil</span>&nbsp;<span class="op" id="5285445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285449">fieldCache</span><span class="op" id="5285459">.</span><span class="ident" id="5285460">m</span>&nbsp;<span class="op" id="5285462">=</span>&nbsp;<span class="keyword" id="5285464">map</span><span class="op" id="5285467">[</span><span class="ident" id="5285468">reflect</span><span class="op" id="5285475">.</span><span class="ident" id="5285476">Type</span><span class="op" id="5285480">]</span><span class="op" id="5285481">[</span><span class="op" id="5285482">]</span><span class="ident" id="5285483">field</span><span class="op" id="5285488">{</span><span class="op" id="5285489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5285492">}</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285495">fieldCache</span><span class="op" id="5285505">.</span><span class="ident" id="5285506">m</span><span class="op" id="5285507">[</span><span class="ident" id="5285508">t</span><span class="op" id="5285509">]</span>&nbsp;<span class="op" id="5285511">=</span>&nbsp;<span class="ident" id="5285513">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5285516">fieldCache</span><span class="op" id="5285526">.</span><span class="ident" id="5285527">Unlock</span><span class="op" id="5285533">(</span><span class="op" id="5285534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5285537">return</span>&nbsp;<span class="ident" id="5285544">f</span><br>
<span class="lineno"></span><span class="op" id="5285546">}</span>
</div>
</body>
</html>
