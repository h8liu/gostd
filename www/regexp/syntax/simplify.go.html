<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword">package</span>&nbsp;<span class="ident">syntax</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Simplify&nbsp;returns&nbsp;a&nbsp;regexp&nbsp;equivalent&nbsp;to&nbsp;re&nbsp;but&nbsp;without&nbsp;counted&nbsp;repetitions</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;and&nbsp;with&nbsp;various&nbsp;other&nbsp;simplifications,&nbsp;such&nbsp;as&nbsp;rewriting&nbsp;/(?:a+)+/&nbsp;to&nbsp;/a+/.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;resulting&nbsp;regexp&nbsp;will&nbsp;execute&nbsp;correctly&nbsp;but&nbsp;its&nbsp;string&nbsp;representation</span><br>
<span class="lineno">10</span><span class="comment">//&nbsp;will&nbsp;not&nbsp;produce&nbsp;the&nbsp;same&nbsp;parse&nbsp;tree,&nbsp;because&nbsp;capturing&nbsp;parentheses</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;may&nbsp;have&nbsp;been&nbsp;duplicated&nbsp;or&nbsp;removed.&nbsp;&nbsp;For&nbsp;example,&nbsp;the&nbsp;simplified&nbsp;form</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;for&nbsp;/(x){1,2}/&nbsp;is&nbsp;/(x)(x)?/&nbsp;but&nbsp;both&nbsp;parentheses&nbsp;capture&nbsp;as&nbsp;$1.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;returned&nbsp;regexp&nbsp;may&nbsp;share&nbsp;structure&nbsp;with&nbsp;or&nbsp;be&nbsp;the&nbsp;original.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">re</span>&nbsp;<span class="op">*</span><span class="ident">Regexp</span><span class="op">)</span>&nbsp;<span class="ident">Simplify</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Regexp</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">re</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">OpCapture</span><span class="op">,</span>&nbsp;<span class="ident">OpConcat</span><span class="op">,</span>&nbsp;<span class="ident">OpAlternate</span><span class="op">:</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Simplify&nbsp;children,&nbsp;building&nbsp;new&nbsp;Regexp&nbsp;if&nbsp;children&nbsp;change.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nre</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">sub</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Sub</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nsub</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">sub</span><span class="op">.</span><span class="ident">Simplify</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">nre</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">re</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">nsub</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">sub</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Start&nbsp;a&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nre</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">Regexp</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">*</span><span class="ident">nre</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">*</span><span class="ident">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nre</span><span class="op">.</span><span class="ident">Rune</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nre</span><span class="op">.</span><span class="ident">Sub</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">nre</span><span class="op">.</span><span class="ident">Sub0</span><span class="op">[</span><span class="op">:</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Sub</span><span class="op">[</span><span class="op">:</span><span class="ident">i</span><span class="op">]</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">nre</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">re</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nre</span><span class="op">.</span><span class="ident">Sub</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">nre</span><span class="op">.</span><span class="ident">Sub</span><span class="op">,</span>&nbsp;<span class="ident">nsub</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nre</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">OpStar</span><span class="op">,</span>&nbsp;<span class="ident">OpPlus</span><span class="op">,</span>&nbsp;<span class="ident">OpQuest</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sub</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Sub</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="ident">Simplify</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">simplify1</span><span class="op">(</span><span class="ident">re</span><span class="op">.</span><span class="ident">Op</span><span class="op">,</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Flags</span><span class="op">,</span>&nbsp;<span class="ident">sub</span><span class="op">,</span>&nbsp;<span class="ident">re</span><span class="op">)</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">OpRepeat</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Special&nbsp;special&nbsp;case:&nbsp;x{0}&nbsp;matches&nbsp;the&nbsp;empty&nbsp;string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;and&nbsp;doesn&#39;t&nbsp;even&nbsp;need&nbsp;to&nbsp;consider&nbsp;x.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Min</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Max</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">Regexp</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="ident">OpEmptyMatch</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;fun&nbsp;begins.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sub</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Sub</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">.</span><span class="ident">Simplify</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;x{n,}&nbsp;means&nbsp;at&nbsp;least&nbsp;n&nbsp;matches&nbsp;of&nbsp;x.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Max</span>&nbsp;<span class="op">==</span>&nbsp;<span class="op">-</span><span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Special&nbsp;case:&nbsp;x{0,}&nbsp;is&nbsp;x*.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Min</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">simplify1</span><span class="op">(</span><span class="ident">OpStar</span><span class="op">,</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Flags</span><span class="op">,</span>&nbsp;<span class="ident">sub</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Special&nbsp;case:&nbsp;x{1,}&nbsp;is&nbsp;x+.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Min</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">simplify1</span><span class="op">(</span><span class="ident">OpPlus</span><span class="op">,</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Flags</span><span class="op">,</span>&nbsp;<span class="ident">sub</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;General&nbsp;case:&nbsp;x{4,}&nbsp;is&nbsp;xxxx+.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nre</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">Regexp</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="ident">OpConcat</span><span class="op">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nre</span><span class="op">.</span><span class="ident">Sub</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nre</span><span class="op">.</span><span class="ident">Sub0</span><span class="op">[</span><span class="op">:</span><span class="num">0</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Min</span><span class="op">-</span><span class="num">1</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nre</span><span class="op">.</span><span class="ident">Sub</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">nre</span><span class="op">.</span><span class="ident">Sub</span><span class="op">,</span>&nbsp;<span class="ident">sub</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nre</span><span class="op">.</span><span class="ident">Sub</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">nre</span><span class="op">.</span><span class="ident">Sub</span><span class="op">,</span>&nbsp;<span class="ident">simplify1</span><span class="op">(</span><span class="ident">OpPlus</span><span class="op">,</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Flags</span><span class="op">,</span>&nbsp;<span class="ident">sub</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nre</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Special&nbsp;case&nbsp;x{0}&nbsp;handled&nbsp;above.</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Special&nbsp;case:&nbsp;x{1}&nbsp;is&nbsp;just&nbsp;x.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Min</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Max</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">sub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;General&nbsp;case:&nbsp;x{n,m}&nbsp;means&nbsp;n&nbsp;copies&nbsp;of&nbsp;x&nbsp;and&nbsp;m&nbsp;copies&nbsp;of&nbsp;x?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;machine&nbsp;will&nbsp;do&nbsp;less&nbsp;work&nbsp;if&nbsp;we&nbsp;nest&nbsp;the&nbsp;final&nbsp;m&nbsp;copies,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;so&nbsp;that&nbsp;x{2,5}&nbsp;=&nbsp;xx(x(x(x)?)?)?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Build&nbsp;leading&nbsp;prefix:&nbsp;xx.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">prefix</span>&nbsp;<span class="op">*</span><span class="ident">Regexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Min</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prefix</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">Regexp</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="ident">OpConcat</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prefix</span><span class="op">.</span><span class="ident">Sub</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">prefix</span><span class="op">.</span><span class="ident">Sub0</span><span class="op">[</span><span class="op">:</span><span class="num">0</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Min</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prefix</span><span class="op">.</span><span class="ident">Sub</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">prefix</span><span class="op">.</span><span class="ident">Sub</span><span class="op">,</span>&nbsp;<span class="ident">sub</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Build&nbsp;and&nbsp;attach&nbsp;suffix:&nbsp;(x(x(x)?)?)?</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Max</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Min</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">suffix</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">simplify1</span><span class="op">(</span><span class="ident">OpQuest</span><span class="op">,</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Flags</span><span class="op">,</span>&nbsp;<span class="ident">sub</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Min</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Max</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nre2</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">Regexp</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="ident">OpConcat</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nre2</span><span class="op">.</span><span class="ident">Sub</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">nre2</span><span class="op">.</span><span class="ident">Sub0</span><span class="op">[</span><span class="op">:</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">sub</span><span class="op">,</span>&nbsp;<span class="ident">suffix</span><span class="op">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">suffix</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">simplify1</span><span class="op">(</span><span class="ident">OpQuest</span><span class="op">,</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Flags</span><span class="op">,</span>&nbsp;<span class="ident">nre2</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">prefix</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">suffix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prefix</span><span class="op">.</span><span class="ident">Sub</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">prefix</span><span class="op">.</span><span class="ident">Sub</span><span class="op">,</span>&nbsp;<span class="ident">suffix</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">prefix</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">prefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Some&nbsp;degenerate&nbsp;case&nbsp;like&nbsp;min&nbsp;&gt;&nbsp;max&nbsp;or&nbsp;min&nbsp;&lt;&nbsp;max&nbsp;&lt;&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Handle&nbsp;as&nbsp;impossible&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">Regexp</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="ident">OpNoMatch</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">re</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;simplify1&nbsp;implements&nbsp;Simplify&nbsp;for&nbsp;the&nbsp;unary&nbsp;OpStar,</span><br>
<span class="lineno">120</span><span class="comment">//&nbsp;OpPlus,&nbsp;and&nbsp;OpQuest&nbsp;operators.&nbsp;&nbsp;It&nbsp;returns&nbsp;the&nbsp;simple&nbsp;regexp</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbspRegexp{Op:&nbsp;op,&nbsp;Flags:&nbsp;flags,&nbsp;Sub:&nbsp;{sub}}</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno">125</span><span class="comment">//&nbsp;under&nbsp;the&nbsp;assumption&nbsp;that&nbsp;sub&nbsp;is&nbsp;already&nbsp;simple,&nbsp;and</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;without&nbsp;first&nbsp;allocating&nbsp;that&nbsp;structure.&nbsp;&nbsp;If&nbsp;the&nbsp;regexp</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;to&nbsp;be&nbsp;returned&nbsp;turns&nbsp;out&nbsp;to&nbsp;be&nbsp;equivalent&nbsp;to&nbsp;re,&nbsp;simplify1</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;returns&nbsp;re&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno">130</span><span class="comment">//&nbsp;simplify1&nbsp;is&nbsp;factored&nbsp;out&nbsp;of&nbsp;Simplify&nbsp;because&nbsp;the&nbsp;implementation</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;for&nbsp;other&nbsp;operators&nbsp;generates&nbsp;these&nbsp;unary&nbsp;expressions.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Letting&nbsp;them&nbsp;call&nbsp;simplify1&nbsp;makes&nbsp;sure&nbsp;the&nbsp;expressions&nbsp;they</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;generate&nbsp;are&nbsp;simple.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">simplify1</span><span class="op">(</span><span class="ident">op</span>&nbsp;<span class="ident">Op</span><span class="op">,</span>&nbsp;<span class="ident">flags</span>&nbsp;<span class="ident">Flags</span><span class="op">,</span>&nbsp;<span class="ident">sub</span><span class="op">,</span>&nbsp;<span class="ident">re</span>&nbsp;<span class="op">*</span><span class="ident">Regexp</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Regexp</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Special&nbsp;case:&nbsp;repeat&nbsp;the&nbsp;empty&nbsp;string&nbsp;as&nbsp;much&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;you&nbsp;want,&nbsp;but&nbsp;it&#39;s&nbsp;still&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">sub</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">OpEmptyMatch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">sub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;operators&nbsp;are&nbsp;idempotent&nbsp;if&nbsp;the&nbsp;flags&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">sub</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">flags</span><span class="op">&amp;</span><span class="ident">NonGreedy</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">sub</span><span class="op">.</span><span class="ident">Flags</span><span class="op">&amp;</span><span class="ident">NonGreedy</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">sub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">re</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Op</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">op</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Flags</span><span class="op">&amp;</span><span class="ident">NonGreedy</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">flags</span><span class="op">&amp;</span><span class="ident">NonGreedy</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">sub</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">re</span><span class="op">.</span><span class="ident">Sub</span><span class="op">[</span><span class="num">0</span><span class="op">]</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">re</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">&amp;</span><span class="ident">Regexp</span><span class="op">{</span><span class="ident">Op</span><span class="op">:</span>&nbsp;<span class="ident">op</span><span class="op">,</span>&nbsp;<span class="ident">Flags</span><span class="op">:</span>&nbsp;<span class="ident">flags</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">re</span><span class="op">.</span><span class="ident">Sub</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">append</span><span class="op">(</span><span class="ident">re</span><span class="op">.</span><span class="ident">Sub0</span><span class="op">[</span><span class="op">:</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">sub</span><span class="op">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">re</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
