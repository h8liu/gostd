<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html" class="current">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1806825">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1806880">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1806934">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1806985">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1807063">package</span>&nbsp;<span class="ident" id="1807071">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1807080">import</span>&nbsp;<span class="string" id="1807087">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1807097">//&nbsp;Integrated&nbsp;network&nbsp;poller&nbsp;(platform-independent&nbsp;part).</span><br>
<span class="lineno"></span><span class="comment" id="1807155">//&nbsp;A&nbsp;particular&nbsp;implementation&nbsp;(epoll/kqueue)&nbsp;must&nbsp;define&nbsp;the&nbsp;following&nbsp;functions:</span><br>
<span class="lineno"></span><span class="comment" id="1807238">//&nbsp;func&nbsp;netpollinit()&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;to&nbsp;initialize&nbsp;the&nbsp;poller</span><br>
<span class="lineno"></span><span class="comment" id="1807290">//&nbsp;func&nbsp;netpollopen(fd&nbsp;uintptr,&nbsp;pd&nbsp;*pollDesc)&nbsp;int32&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;to&nbsp;arm&nbsp;edge-triggered&nbsp;notifications</span><br>
<span class="lineno">15</span><span class="comment" id="1807381">//&nbsp;and&nbsp;associate&nbsp;fd&nbsp;with&nbsp;pd.</span><br>
<span class="lineno"></span><span class="comment" id="1807410">//&nbsp;An&nbsp;implementation&nbsp;must&nbsp;call&nbsp;the&nbsp;following&nbsp;function&nbsp;to&nbsp;denote&nbsp;that&nbsp;the&nbsp;pd&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="comment" id="1807496">//&nbsp;func&nbsp;netpollready(gpp&nbsp;**g,&nbsp;pd&nbsp;*pollDesc,&nbsp;mode&nbsp;int32)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1807553">//&nbsp;pollDesc&nbsp;contains&nbsp;2&nbsp;binary&nbsp;semaphores,&nbsp;rg&nbsp;and&nbsp;wg,&nbsp;to&nbsp;park&nbsp;reader&nbsp;and&nbsp;writer</span><br>
<span class="lineno">20</span><span class="comment" id="1807632">//&nbsp;goroutines&nbsp;respectively.&nbsp;The&nbsp;semaphore&nbsp;can&nbsp;be&nbsp;in&nbsp;the&nbsp;following&nbsp;states:</span><br>
<span class="lineno"></span><span class="comment" id="1807706">//&nbsp;pdReady&nbsp;-&nbsp;io&nbsp;readiness&nbsp;notification&nbsp;is&nbsp;pending;</span><br>
<span class="lineno"></span><span class="comment" id="1807757">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;goroutine&nbsp;consumes&nbsp;the&nbsp;notification&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1807838">//&nbsp;pdWait&nbsp;-&nbsp;a&nbsp;goroutine&nbsp;prepares&nbsp;to&nbsp;park&nbsp;on&nbsp;the&nbsp;semaphore,&nbsp;but&nbsp;not&nbsp;yet&nbsp;parked;</span><br>
<span class="lineno"></span><span class="comment" id="1807917">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;goroutine&nbsp;commits&nbsp;to&nbsp;park&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;G&nbsp;pointer,</span><br>
<span class="lineno">25</span><span class="comment" id="1807995">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;io&nbsp;notification&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY,</span><br>
<span class="lineno"></span><span class="comment" id="1808081">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1808163">//&nbsp;G&nbsp;pointer&nbsp;-&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;blocked&nbsp;on&nbsp;the&nbsp;semaphore;</span><br>
<span class="lineno"></span><span class="comment" id="1808221">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;io&nbsp;notification&nbsp;or&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY&nbsp;or&nbsp;nil&nbsp;respectively</span><br>
<span class="lineno"></span><span class="comment" id="1808316">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;unparks&nbsp;the&nbsp;goroutine.</span><br>
<span class="lineno">30</span><span class="comment" id="1808358">//&nbsp;nil&nbsp;-&nbsp;nothing&nbsp;of&nbsp;the&nbsp;above.</span><br>
<span class="lineno"></span><span class="keyword" id="1808389">const</span>&nbsp;<span class="op" id="1808395">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1808398">pdReady</span>&nbsp;<span class="builtintype" id="1808406">uintptr</span>&nbsp;<span class="op" id="1808414">=</span>&nbsp;<span class="num" id="1808416">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1808419">pdWait</span>&nbsp;&nbsp;<span class="builtintype" id="1808427">uintptr</span>&nbsp;<span class="op" id="1808435">=</span>&nbsp;<span class="num" id="1808437">2</span><br>
<span class="lineno"></span><span class="op" id="1808439">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1808442">const</span>&nbsp;<span class="ident" id="1808448">pollBlockSize</span>&nbsp;<span class="op" id="1808462">=</span>&nbsp;<span class="num" id="1808464">4</span>&nbsp;<span class="op" id="1808466">*</span>&nbsp;<span class="num" id="1808468">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1808474">//&nbsp;Network&nbsp;poller&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="1808504">type</span>&nbsp;<span class="ident" id="1808509">pollDesc</span>&nbsp;<span class="keyword" id="1808518">struct</span>&nbsp;<span class="op" id="1808525">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1808528">link</span>&nbsp;<span class="op" id="1808533">*</span><span class="ident" id="1808534">pollDesc</span>&nbsp;<span class="comment" id="1808543">//&nbsp;in&nbsp;pollcache,&nbsp;protected&nbsp;by&nbsp;pollcache.lock</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1808590">//&nbsp;The&nbsp;lock&nbsp;protects&nbsp;pollOpen,&nbsp;pollSetDeadline,&nbsp;pollUnblock&nbsp;and&nbsp;deadlineimpl&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1808680">//&nbsp;This&nbsp;fully&nbsp;covers&nbsp;seq,&nbsp;rt&nbsp;and&nbsp;wt&nbsp;variables.&nbsp;fd&nbsp;is&nbsp;constant&nbsp;throughout&nbsp;the&nbsp;PollDesc&nbsp;lifetime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1808777">//&nbsp;pollReset,&nbsp;pollWait,&nbsp;pollWaitCanceled&nbsp;and&nbsp;runtimeÂ·netpollready&nbsp;(IO&nbsp;readiness&nbsp;notification)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1808873">//&nbsp;proceed&nbsp;w/o&nbsp;taking&nbsp;the&nbsp;lock.&nbsp;So&nbsp;closing,&nbsp;rg,&nbsp;rd,&nbsp;wg&nbsp;and&nbsp;wd&nbsp;are&nbsp;manipulated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1808952">//&nbsp;in&nbsp;a&nbsp;lock-free&nbsp;way&nbsp;by&nbsp;all&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1808994">//&nbsp;NOTE(dvyukov):&nbsp;the&nbsp;following&nbsp;code&nbsp;uses&nbsp;uintptr&nbsp;to&nbsp;store&nbsp;*g&nbsp;(rg/wg),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1809066">//&nbsp;that&nbsp;will&nbsp;blow&nbsp;up&nbsp;when&nbsp;GC&nbsp;starts&nbsp;moving&nbsp;objects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1809119">lock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1809127">mutex</span>&nbsp;<span class="comment" id="1809133">//&nbsp;protectes&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1809168">fd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1809176">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1809185">closing</span>&nbsp;<span class="builtintype" id="1809193">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1809199">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1809207">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1809222">//&nbsp;protects&nbsp;from&nbsp;stale&nbsp;timers&nbsp;and&nbsp;ready&nbsp;notifications</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1809277">rg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1809285">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1809300">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;read&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1809347">rt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1809355">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1809370">//&nbsp;read&nbsp;deadline&nbsp;timer&nbsp;(set&nbsp;if&nbsp;rt.f&nbsp;!=&nbsp;nil)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1809415">rd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1809423">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1809438">//&nbsp;read&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1809456">wg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1809464">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1809479">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;write&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1809527">wt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1809535">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1809550">//&nbsp;write&nbsp;deadline&nbsp;timer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1809575">wd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1809583">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1809598">//&nbsp;write&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1809617">user</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1809625">unsafe</span><span class="op" id="1809631">.</span><span class="ident" id="1809632">Pointer</span>&nbsp;<span class="comment" id="1809640">//&nbsp;user&nbsp;settable&nbsp;cookie</span><br>
<span class="lineno">60</span><span class="op" id="1809664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1809667">type</span>&nbsp;<span class="ident" id="1809672">pollCache</span>&nbsp;<span class="keyword" id="1809682">struct</span>&nbsp;<span class="op" id="1809689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1809692">lock</span>&nbsp;&nbsp;<span class="ident" id="1809698">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1809705">first</span>&nbsp;<span class="op" id="1809711">*</span><span class="ident" id="1809712">pollDesc</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1809722">//&nbsp;PollDesc&nbsp;objects&nbsp;must&nbsp;be&nbsp;type-stable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1809764">//&nbsp;because&nbsp;we&nbsp;can&nbsp;get&nbsp;ready&nbsp;notification&nbsp;from&nbsp;epoll/kqueue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1809824">//&nbsp;after&nbsp;the&nbsp;descriptor&nbsp;is&nbsp;closed/reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1809867">//&nbsp;Stale&nbsp;notifications&nbsp;are&nbsp;detected&nbsp;using&nbsp;seq&nbsp;variable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1809924">//&nbsp;seq&nbsp;is&nbsp;incremented&nbsp;when&nbsp;deadlines&nbsp;are&nbsp;changed&nbsp;or&nbsp;descriptor&nbsp;is&nbsp;reused.</span><br>
<span class="lineno">70</span><span class="op" id="1809998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1810001">var</span>&nbsp;<span class="ident" id="1810005">pollcache</span>&nbsp;<span class="ident" id="1810015">pollCache</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1810026">func</span>&nbsp;<span class="ident" id="1810031">netpollServerInit</span><span class="op" id="1810048">(</span><span class="op" id="1810049">)</span>&nbsp;<span class="op" id="1810051">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810054">onM</span><span class="op" id="1810057">(</span><span class="ident" id="1810058">netpollinit</span><span class="op" id="1810069">)</span><br>
<span class="lineno"></span><span class="op" id="1810071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1810074">func</span>&nbsp;<span class="ident" id="1810079">netpollOpen</span><span class="op" id="1810090">(</span><span class="ident" id="1810091">fd</span>&nbsp;<span class="builtintype" id="1810094">uintptr</span><span class="op" id="1810101">)</span>&nbsp;<span class="op" id="1810103">(</span><span class="op" id="1810104">*</span><span class="ident" id="1810105">pollDesc</span><span class="op" id="1810113">,</span>&nbsp;<span class="builtintype" id="1810115">int</span><span class="op" id="1810118">)</span>&nbsp;<span class="op" id="1810120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810123">pd</span>&nbsp;<span class="op" id="1810126">:=</span>&nbsp;<span class="ident" id="1810129">pollcache</span><span class="op" id="1810138">.</span><span class="ident" id="1810139">alloc</span><span class="op" id="1810144">(</span><span class="op" id="1810145">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810148">lock</span><span class="op" id="1810152">(</span><span class="op" id="1810153">&amp;</span><span class="ident" id="1810154">pd</span><span class="op" id="1810156">.</span><span class="ident" id="1810157">lock</span><span class="op" id="1810161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1810164">if</span>&nbsp;<span class="ident" id="1810167">pd</span><span class="op" id="1810169">.</span><span class="ident" id="1810170">wg</span>&nbsp;<span class="op" id="1810173">!=</span>&nbsp;<span class="num" id="1810176">0</span>&nbsp;<span class="op" id="1810178">&amp;&amp;</span>&nbsp;<span class="ident" id="1810181">pd</span><span class="op" id="1810183">.</span><span class="ident" id="1810184">wg</span>&nbsp;<span class="op" id="1810187">!=</span>&nbsp;<span class="ident" id="1810190">pdReady</span>&nbsp;<span class="op" id="1810198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810202">gothrow</span><span class="op" id="1810209">(</span><span class="string" id="1810210">&#34;netpollOpen:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1810257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1810260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1810263">if</span>&nbsp;<span class="ident" id="1810266">pd</span><span class="op" id="1810268">.</span><span class="ident" id="1810269">rg</span>&nbsp;<span class="op" id="1810272">!=</span>&nbsp;<span class="num" id="1810275">0</span>&nbsp;<span class="op" id="1810277">&amp;&amp;</span>&nbsp;<span class="ident" id="1810280">pd</span><span class="op" id="1810282">.</span><span class="ident" id="1810283">rg</span>&nbsp;<span class="op" id="1810286">!=</span>&nbsp;<span class="ident" id="1810289">pdReady</span>&nbsp;<span class="op" id="1810297">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810301">gothrow</span><span class="op" id="1810308">(</span><span class="string" id="1810309">&#34;netpollOpen:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1810355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1810358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810361">pd</span><span class="op" id="1810363">.</span><span class="ident" id="1810364">fd</span>&nbsp;<span class="op" id="1810367">=</span>&nbsp;<span class="ident" id="1810369">fd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810373">pd</span><span class="op" id="1810375">.</span><span class="ident" id="1810376">closing</span>&nbsp;<span class="op" id="1810384">=</span>&nbsp;<span class="builtintype" id="1810386">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810393">pd</span><span class="op" id="1810395">.</span><span class="ident" id="1810396">seq</span><span class="op" id="1810399">++</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810403">pd</span><span class="op" id="1810405">.</span><span class="ident" id="1810406">rg</span>&nbsp;<span class="op" id="1810409">=</span>&nbsp;<span class="num" id="1810411">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810414">pd</span><span class="op" id="1810416">.</span><span class="ident" id="1810417">rd</span>&nbsp;<span class="op" id="1810420">=</span>&nbsp;<span class="num" id="1810422">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810425">pd</span><span class="op" id="1810427">.</span><span class="ident" id="1810428">wg</span>&nbsp;<span class="op" id="1810431">=</span>&nbsp;<span class="num" id="1810433">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810436">pd</span><span class="op" id="1810438">.</span><span class="ident" id="1810439">wd</span>&nbsp;<span class="op" id="1810442">=</span>&nbsp;<span class="num" id="1810444">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810447">unlock</span><span class="op" id="1810453">(</span><span class="op" id="1810454">&amp;</span><span class="ident" id="1810455">pd</span><span class="op" id="1810457">.</span><span class="ident" id="1810458">lock</span><span class="op" id="1810462">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1810466">var</span>&nbsp;<span class="ident" id="1810470">errno</span>&nbsp;<span class="builtintype" id="1810476">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810483">onM</span><span class="op" id="1810486">(</span><span class="keyword" id="1810487">func</span><span class="op" id="1810491">(</span><span class="op" id="1810492">)</span>&nbsp;<span class="op" id="1810494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810498">errno</span>&nbsp;<span class="op" id="1810504">=</span>&nbsp;<span class="ident" id="1810506">netpollopen</span><span class="op" id="1810517">(</span><span class="ident" id="1810518">fd</span><span class="op" id="1810520">,</span>&nbsp;<span class="ident" id="1810522">pd</span><span class="op" id="1810524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1810527">}</span><span class="op" id="1810528">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1810531">return</span>&nbsp;<span class="ident" id="1810538">pd</span><span class="op" id="1810540">,</span>&nbsp;<span class="builtintype" id="1810542">int</span><span class="op" id="1810545">(</span><span class="ident" id="1810546">errno</span><span class="op" id="1810551">)</span><br>
<span class="lineno"></span><span class="op" id="1810553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1810556">func</span>&nbsp;<span class="ident" id="1810561">netpollClose</span><span class="op" id="1810573">(</span><span class="ident" id="1810574">pd</span>&nbsp;<span class="op" id="1810577">*</span><span class="ident" id="1810578">pollDesc</span><span class="op" id="1810586">)</span>&nbsp;<span class="op" id="1810588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1810591">if</span>&nbsp;<span class="op" id="1810594">!</span><span class="ident" id="1810595">pd</span><span class="op" id="1810597">.</span><span class="ident" id="1810598">closing</span>&nbsp;<span class="op" id="1810606">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810610">gothrow</span><span class="op" id="1810617">(</span><span class="string" id="1810618">&#34;netpollClose:&nbsp;close&nbsp;w/o&nbsp;unblock&#34;</span><span class="op" id="1810651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1810654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1810657">if</span>&nbsp;<span class="ident" id="1810660">pd</span><span class="op" id="1810662">.</span><span class="ident" id="1810663">wg</span>&nbsp;<span class="op" id="1810666">!=</span>&nbsp;<span class="num" id="1810669">0</span>&nbsp;<span class="op" id="1810671">&amp;&amp;</span>&nbsp;<span class="ident" id="1810674">pd</span><span class="op" id="1810676">.</span><span class="ident" id="1810677">wg</span>&nbsp;<span class="op" id="1810680">!=</span>&nbsp;<span class="ident" id="1810683">pdReady</span>&nbsp;<span class="op" id="1810691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810695">gothrow</span><span class="op" id="1810702">(</span><span class="string" id="1810703">&#34;netpollClose:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1810754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1810757">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1810760">if</span>&nbsp;<span class="ident" id="1810763">pd</span><span class="op" id="1810765">.</span><span class="ident" id="1810766">rg</span>&nbsp;<span class="op" id="1810769">!=</span>&nbsp;<span class="num" id="1810772">0</span>&nbsp;<span class="op" id="1810774">&amp;&amp;</span>&nbsp;<span class="ident" id="1810777">pd</span><span class="op" id="1810779">.</span><span class="ident" id="1810780">rg</span>&nbsp;<span class="op" id="1810783">!=</span>&nbsp;<span class="ident" id="1810786">pdReady</span>&nbsp;<span class="op" id="1810794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810798">gothrow</span><span class="op" id="1810805">(</span><span class="string" id="1810806">&#34;netpollClose:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1810856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1810859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810862">onM</span><span class="op" id="1810865">(</span><span class="keyword" id="1810866">func</span><span class="op" id="1810870">(</span><span class="op" id="1810871">)</span>&nbsp;<span class="op" id="1810873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810877">netpollclose</span><span class="op" id="1810889">(</span><span class="builtintype" id="1810890">uintptr</span><span class="op" id="1810897">(</span><span class="ident" id="1810898">pd</span><span class="op" id="1810900">.</span><span class="ident" id="1810901">fd</span><span class="op" id="1810903">)</span><span class="op" id="1810904">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1810907">}</span><span class="op" id="1810908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810911">pollcache</span><span class="op" id="1810920">.</span><span class="ident" id="1810921">free</span><span class="op" id="1810925">(</span><span class="ident" id="1810926">pd</span><span class="op" id="1810928">)</span><br>
<span class="lineno"></span><span class="op" id="1810930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1810933">func</span>&nbsp;<span class="op" id="1810938">(</span><span class="ident" id="1810939">c</span>&nbsp;<span class="op" id="1810941">*</span><span class="ident" id="1810942">pollCache</span><span class="op" id="1810951">)</span>&nbsp;<span class="ident" id="1810953">free</span><span class="op" id="1810957">(</span><span class="ident" id="1810958">pd</span>&nbsp;<span class="op" id="1810961">*</span><span class="ident" id="1810962">pollDesc</span><span class="op" id="1810970">)</span>&nbsp;<span class="op" id="1810972">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810975">lock</span><span class="op" id="1810979">(</span><span class="op" id="1810980">&amp;</span><span class="ident" id="1810981">c</span><span class="op" id="1810982">.</span><span class="ident" id="1810983">lock</span><span class="op" id="1810987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1810990">pd</span><span class="op" id="1810992">.</span><span class="ident" id="1810993">link</span>&nbsp;<span class="op" id="1810998">=</span>&nbsp;<span class="ident" id="1811000">c</span><span class="op" id="1811001">.</span><span class="ident" id="1811002">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1811009">c</span><span class="op" id="1811010">.</span><span class="ident" id="1811011">first</span>&nbsp;<span class="op" id="1811017">=</span>&nbsp;<span class="ident" id="1811019">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1811023">unlock</span><span class="op" id="1811029">(</span><span class="op" id="1811030">&amp;</span><span class="ident" id="1811031">c</span><span class="op" id="1811032">.</span><span class="ident" id="1811033">lock</span><span class="op" id="1811037">)</span><br>
<span class="lineno"></span><span class="op" id="1811039">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="1811042">func</span>&nbsp;<span class="ident" id="1811047">netpollReset</span><span class="op" id="1811059">(</span><span class="ident" id="1811060">pd</span>&nbsp;<span class="op" id="1811063">*</span><span class="ident" id="1811064">pollDesc</span><span class="op" id="1811072">,</span>&nbsp;<span class="ident" id="1811074">mode</span>&nbsp;<span class="builtintype" id="1811079">int</span><span class="op" id="1811082">)</span>&nbsp;<span class="builtintype" id="1811084">int</span>&nbsp;<span class="op" id="1811088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1811091">err</span>&nbsp;<span class="op" id="1811095">:=</span>&nbsp;<span class="ident" id="1811098">netpollcheckerr</span><span class="op" id="1811113">(</span><span class="ident" id="1811114">pd</span><span class="op" id="1811116">,</span>&nbsp;<span class="builtintype" id="1811118">int32</span><span class="op" id="1811123">(</span><span class="ident" id="1811124">mode</span><span class="op" id="1811128">)</span><span class="op" id="1811129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1811132">if</span>&nbsp;<span class="ident" id="1811135">err</span>&nbsp;<span class="op" id="1811139">!=</span>&nbsp;<span class="num" id="1811142">0</span>&nbsp;<span class="op" id="1811144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1811148">return</span>&nbsp;<span class="ident" id="1811155">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1811160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1811163">if</span>&nbsp;<span class="ident" id="1811166">mode</span>&nbsp;<span class="op" id="1811171">==</span>&nbsp;<span class="string" id="1811174">&#39;r&#39;</span>&nbsp;<span class="op" id="1811178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1811182">pd</span><span class="op" id="1811184">.</span><span class="ident" id="1811185">rg</span>&nbsp;<span class="op" id="1811188">=</span>&nbsp;<span class="num" id="1811190">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1811193">}</span>&nbsp;<span class="keyword" id="1811195">else</span>&nbsp;<span class="keyword" id="1811200">if</span>&nbsp;<span class="ident" id="1811203">mode</span>&nbsp;<span class="op" id="1811208">==</span>&nbsp;<span class="string" id="1811211">&#39;w&#39;</span>&nbsp;<span class="op" id="1811215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1811219">pd</span><span class="op" id="1811221">.</span><span class="ident" id="1811222">wg</span>&nbsp;<span class="op" id="1811225">=</span>&nbsp;<span class="num" id="1811227">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1811230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1811233">return</span>&nbsp;<span class="num" id="1811240">0</span><br>
<span class="lineno"></span><span class="op" id="1811242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1811245">func</span>&nbsp;<span class="ident" id="1811250">netpollWait</span><span class="op" id="1811261">(</span><span class="ident" id="1811262">pd</span>&nbsp;<span class="op" id="1811265">*</span><span class="ident" id="1811266">pollDesc</span><span class="op" id="1811274">,</span>&nbsp;<span class="ident" id="1811276">mode</span>&nbsp;<span class="builtintype" id="1811281">int</span><span class="op" id="1811284">)</span>&nbsp;<span class="builtintype" id="1811286">int</span>&nbsp;<span class="op" id="1811290">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1811293">err</span>&nbsp;<span class="op" id="1811297">:=</span>&nbsp;<span class="ident" id="1811300">netpollcheckerr</span><span class="op" id="1811315">(</span><span class="ident" id="1811316">pd</span><span class="op" id="1811318">,</span>&nbsp;<span class="builtintype" id="1811320">int32</span><span class="op" id="1811325">(</span><span class="ident" id="1811326">mode</span><span class="op" id="1811330">)</span><span class="op" id="1811331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1811334">if</span>&nbsp;<span class="ident" id="1811337">err</span>&nbsp;<span class="op" id="1811341">!=</span>&nbsp;<span class="num" id="1811344">0</span>&nbsp;<span class="op" id="1811346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1811350">return</span>&nbsp;<span class="ident" id="1811357">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1811362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1811365">//&nbsp;As&nbsp;for&nbsp;now&nbsp;only&nbsp;Solaris&nbsp;uses&nbsp;level-triggered&nbsp;IO.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1811418">if</span>&nbsp;<span class="ident" id="1811421">GOOS</span>&nbsp;<span class="op" id="1811426">==</span>&nbsp;<span class="string" id="1811429">&#34;solaris&#34;</span>&nbsp;<span class="op" id="1811439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1811443">onM</span><span class="op" id="1811446">(</span><span class="keyword" id="1811447">func</span><span class="op" id="1811451">(</span><span class="op" id="1811452">)</span>&nbsp;<span class="op" id="1811454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1811459">netpollarm</span><span class="op" id="1811469">(</span><span class="ident" id="1811470">pd</span><span class="op" id="1811472">,</span>&nbsp;<span class="ident" id="1811474">mode</span><span class="op" id="1811478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1811482">}</span><span class="op" id="1811483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1811486">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1811489">for</span>&nbsp;<span class="op" id="1811493">!</span><span class="ident" id="1811494">netpollblock</span><span class="op" id="1811506">(</span><span class="ident" id="1811507">pd</span><span class="op" id="1811509">,</span>&nbsp;<span class="builtintype" id="1811511">int32</span><span class="op" id="1811516">(</span><span class="ident" id="1811517">mode</span><span class="op" id="1811521">)</span><span class="op" id="1811522">,</span>&nbsp;<span class="builtintype" id="1811524">false</span><span class="op" id="1811529">)</span>&nbsp;<span class="op" id="1811531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1811535">err</span>&nbsp;<span class="op" id="1811539">=</span>&nbsp;<span class="ident" id="1811541">netpollcheckerr</span><span class="op" id="1811556">(</span><span class="ident" id="1811557">pd</span><span class="op" id="1811559">,</span>&nbsp;<span class="builtintype" id="1811561">int32</span><span class="op" id="1811566">(</span><span class="ident" id="1811567">mode</span><span class="op" id="1811571">)</span><span class="op" id="1811572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1811576">if</span>&nbsp;<span class="ident" id="1811579">err</span>&nbsp;<span class="op" id="1811583">!=</span>&nbsp;<span class="num" id="1811586">0</span>&nbsp;<span class="op" id="1811588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1811593">return</span>&nbsp;<span class="ident" id="1811600">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1811606">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1811610">//&nbsp;Can&nbsp;happen&nbsp;if&nbsp;timeout&nbsp;has&nbsp;fired&nbsp;and&nbsp;unblocked&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1811665">//&nbsp;but&nbsp;before&nbsp;we&nbsp;had&nbsp;a&nbsp;chance&nbsp;to&nbsp;run,&nbsp;timeout&nbsp;has&nbsp;been&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1811729">//&nbsp;Pretend&nbsp;it&nbsp;has&nbsp;not&nbsp;happened&nbsp;and&nbsp;retry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1811772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1811775">return</span>&nbsp;<span class="num" id="1811782">0</span><br>
<span class="lineno">160</span><span class="op" id="1811784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1811787">func</span>&nbsp;<span class="ident" id="1811792">netpollWaitCanceled</span><span class="op" id="1811811">(</span><span class="ident" id="1811812">pd</span>&nbsp;<span class="op" id="1811815">*</span><span class="ident" id="1811816">pollDesc</span><span class="op" id="1811824">,</span>&nbsp;<span class="ident" id="1811826">mode</span>&nbsp;<span class="builtintype" id="1811831">int</span><span class="op" id="1811834">)</span>&nbsp;<span class="op" id="1811836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1811839">//&nbsp;This&nbsp;function&nbsp;is&nbsp;used&nbsp;only&nbsp;on&nbsp;windows&nbsp;after&nbsp;a&nbsp;failed&nbsp;attempt&nbsp;to&nbsp;cancel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1811914">//&nbsp;a&nbsp;pending&nbsp;async&nbsp;IO&nbsp;operation.&nbsp;Wait&nbsp;for&nbsp;ioready,&nbsp;ignore&nbsp;closing&nbsp;or&nbsp;timeouts.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1811994">for</span>&nbsp;<span class="op" id="1811998">!</span><span class="ident" id="1811999">netpollblock</span><span class="op" id="1812011">(</span><span class="ident" id="1812012">pd</span><span class="op" id="1812014">,</span>&nbsp;<span class="builtintype" id="1812016">int32</span><span class="op" id="1812021">(</span><span class="ident" id="1812022">mode</span><span class="op" id="1812026">)</span><span class="op" id="1812027">,</span>&nbsp;<span class="builtintype" id="1812029">true</span><span class="op" id="1812033">)</span>&nbsp;<span class="op" id="1812035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1812038">}</span><br>
<span class="lineno"></span><span class="op" id="1812040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1812043">func</span>&nbsp;<span class="ident" id="1812048">netpollSetDeadline</span><span class="op" id="1812066">(</span><span class="ident" id="1812067">pd</span>&nbsp;<span class="op" id="1812070">*</span><span class="ident" id="1812071">pollDesc</span><span class="op" id="1812079">,</span>&nbsp;<span class="ident" id="1812081">d</span>&nbsp;<span class="ident" id="1812083">int64</span><span class="op" id="1812088">,</span>&nbsp;<span class="ident" id="1812090">mode</span>&nbsp;<span class="builtintype" id="1812095">int</span><span class="op" id="1812098">)</span>&nbsp;<span class="op" id="1812100">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1812103">lock</span><span class="op" id="1812107">(</span><span class="op" id="1812108">&amp;</span><span class="ident" id="1812109">pd</span><span class="op" id="1812111">.</span><span class="ident" id="1812112">lock</span><span class="op" id="1812116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1812119">if</span>&nbsp;<span class="ident" id="1812122">pd</span><span class="op" id="1812124">.</span><span class="ident" id="1812125">closing</span>&nbsp;<span class="op" id="1812133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1812137">unlock</span><span class="op" id="1812143">(</span><span class="op" id="1812144">&amp;</span><span class="ident" id="1812145">pd</span><span class="op" id="1812147">.</span><span class="ident" id="1812148">lock</span><span class="op" id="1812152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1812156">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1812164">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1812167">pd</span><span class="op" id="1812169">.</span><span class="ident" id="1812170">seq</span><span class="op" id="1812173">++</span>&nbsp;<span class="comment" id="1812176">//&nbsp;invalidate&nbsp;current&nbsp;timers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1812206">//&nbsp;Reset&nbsp;current&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1812232">if</span>&nbsp;<span class="ident" id="1812235">pd</span><span class="op" id="1812237">.</span><span class="ident" id="1812238">rt</span><span class="op" id="1812240">.</span><span class="ident" id="1812241">f</span>&nbsp;<span class="op" id="1812243">!=</span>&nbsp;<span class="ident" id="1812246">nil</span>&nbsp;<span class="op" id="1812250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1812254">deltimer</span><span class="op" id="1812262">(</span><span class="op" id="1812263">&amp;</span><span class="ident" id="1812264">pd</span><span class="op" id="1812266">.</span><span class="ident" id="1812267">rt</span><span class="op" id="1812269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1812273">pd</span><span class="op" id="1812275">.</span><span class="ident" id="1812276">rt</span><span class="op" id="1812278">.</span><span class="ident" id="1812279">f</span>&nbsp;<span class="op" id="1812281">=</span>&nbsp;<span class="ident" id="1812283">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1812288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1812291">if</span>&nbsp;<span class="ident" id="1812294">pd</span><span class="op" id="1812296">.</span><span class="ident" id="1812297">wt</span><span class="op" id="1812299">.</span><span class="ident" id="1812300">f</span>&nbsp;<span class="op" id="1812302">!=</span>&nbsp;<span class="ident" id="1812305">nil</span>&nbsp;<span class="op" id="1812309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1812313">deltimer</span><span class="op" id="1812321">(</span><span class="op" id="1812322">&amp;</span><span class="ident" id="1812323">pd</span><span class="op" id="1812325">.</span><span class="ident" id="1812326">wt</span><span class="op" id="1812328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1812332">pd</span><span class="op" id="1812334">.</span><span class="ident" id="1812335">wt</span><span class="op" id="1812337">.</span><span class="ident" id="1812338">f</span>&nbsp;<span class="op" id="1812340">=</span>&nbsp;<span class="ident" id="1812342">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1812347">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1812350">//&nbsp;Setup&nbsp;new&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1812372">if</span>&nbsp;<span class="ident" id="1812375">d</span>&nbsp;<span class="op" id="1812377">!=</span>&nbsp;<span class="num" id="1812380">0</span>&nbsp;<span class="op" id="1812382">&amp;&amp;</span>&nbsp;<span class="ident" id="1812385">d</span>&nbsp;<span class="op" id="1812387">&lt;=</span>&nbsp;<span class="ident" id="1812390">nanotime</span><span class="op" id="1812398">(</span><span class="op" id="1812399">)</span>&nbsp;<span class="op" id="1812401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1812405">d</span>&nbsp;<span class="op" id="1812407">=</span>&nbsp;<span class="op" id="1812409">-</span><span class="num" id="1812410">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1812413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1812416">if</span>&nbsp;<span class="ident" id="1812419">mode</span>&nbsp;<span class="op" id="1812424">==</span>&nbsp;<span class="string" id="1812427">&#39;r&#39;</span>&nbsp;<span class="op" id="1812431">||</span>&nbsp;<span class="ident" id="1812434">mode</span>&nbsp;<span class="op" id="1812439">==</span>&nbsp;<span class="string" id="1812442">&#39;r&#39;</span><span class="op" id="1812445">+</span><span class="string" id="1812446">&#39;w&#39;</span>&nbsp;<span class="op" id="1812450">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1812454">pd</span><span class="op" id="1812456">.</span><span class="ident" id="1812457">rd</span>&nbsp;<span class="op" id="1812460">=</span>&nbsp;<span class="ident" id="1812462">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1812465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1812468">if</span>&nbsp;<span class="ident" id="1812471">mode</span>&nbsp;<span class="op" id="1812476">==</span>&nbsp;<span class="string" id="1812479">&#39;w&#39;</span>&nbsp;<span class="op" id="1812483">||</span>&nbsp;<span class="ident" id="1812486">mode</span>&nbsp;<span class="op" id="1812491">==</span>&nbsp;<span class="string" id="1812494">&#39;r&#39;</span><span class="op" id="1812497">+</span><span class="string" id="1812498">&#39;w&#39;</span>&nbsp;<span class="op" id="1812502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1812506">pd</span><span class="op" id="1812508">.</span><span class="ident" id="1812509">wd</span>&nbsp;<span class="op" id="1812512">=</span>&nbsp;<span class="ident" id="1812514">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1812517">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1812520">if</span>&nbsp;<span class="ident" id="1812523">pd</span><span class="op" id="1812525">.</span><span class="ident" id="1812526">rd</span>&nbsp;<span class="op" id="1812529">&gt;</span>&nbsp;<span class="num" id="1812531">0</span>&nbsp;<span class="op" id="1812533">&amp;&amp;</span>&nbsp;<span class="ident" id="1812536">pd</span><span class="op" id="1812538">.</span><span class="ident" id="1812539">rd</span>&nbsp;<span class="op" id="1812542">==</span>&nbsp;<span class="ident" id="1812545">pd</span><span class="op" id="1812547">.</span><span class="ident" id="1812548">wd</span>&nbsp;<span class="op" id="1812551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1812555">pd</span><span class="op" id="1812557">.</span><span class="ident" id="1812558">rt</span><span class="op" id="1812560">.</span><span class="ident" id="1812561">f</span>&nbsp;<span class="op" id="1812563">=</span>&nbsp;<span class="ident" id="1812565">netpollDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1812583">pd</span><span class="op" id="1812585">.</span><span class="ident" id="1812586">rt</span><span class="op" id="1812588">.</span><span class="ident" id="1812589">when</span>&nbsp;<span class="op" id="1812594">=</span>&nbsp;<span class="ident" id="1812596">pd</span><span class="op" id="1812598">.</span><span class="ident" id="1812599">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1812604">//&nbsp;Copy&nbsp;current&nbsp;seq&nbsp;into&nbsp;the&nbsp;timer&nbsp;arg.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1812646">//&nbsp;Timer&nbsp;func&nbsp;will&nbsp;check&nbsp;the&nbsp;seq&nbsp;against&nbsp;current&nbsp;descriptor&nbsp;seq,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1812713">//&nbsp;if&nbsp;they&nbsp;differ&nbsp;the&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1812781">pd</span><span class="op" id="1812783">.</span><span class="ident" id="1812784">rt</span><span class="op" id="1812786">.</span><span class="ident" id="1812787">arg</span>&nbsp;<span class="op" id="1812791">=</span>&nbsp;<span class="ident" id="1812793">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1812798">pd</span><span class="op" id="1812800">.</span><span class="ident" id="1812801">rt</span><span class="op" id="1812803">.</span><span class="ident" id="1812804">seq</span>&nbsp;<span class="op" id="1812808">=</span>&nbsp;<span class="ident" id="1812810">pd</span><span class="op" id="1812812">.</span><span class="ident" id="1812813">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1812819">addtimer</span><span class="op" id="1812827">(</span><span class="op" id="1812828">&amp;</span><span class="ident" id="1812829">pd</span><span class="op" id="1812831">.</span><span class="ident" id="1812832">rt</span><span class="op" id="1812834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1812837">}</span>&nbsp;<span class="keyword" id="1812839">else</span>&nbsp;<span class="op" id="1812844">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1812848">if</span>&nbsp;<span class="ident" id="1812851">pd</span><span class="op" id="1812853">.</span><span class="ident" id="1812854">rd</span>&nbsp;<span class="op" id="1812857">&gt;</span>&nbsp;<span class="num" id="1812859">0</span>&nbsp;<span class="op" id="1812861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1812866">pd</span><span class="op" id="1812868">.</span><span class="ident" id="1812869">rt</span><span class="op" id="1812871">.</span><span class="ident" id="1812872">f</span>&nbsp;<span class="op" id="1812874">=</span>&nbsp;<span class="ident" id="1812876">netpollReadDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1812899">pd</span><span class="op" id="1812901">.</span><span class="ident" id="1812902">rt</span><span class="op" id="1812904">.</span><span class="ident" id="1812905">when</span>&nbsp;<span class="op" id="1812910">=</span>&nbsp;<span class="ident" id="1812912">pd</span><span class="op" id="1812914">.</span><span class="ident" id="1812915">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1812921">pd</span><span class="op" id="1812923">.</span><span class="ident" id="1812924">rt</span><span class="op" id="1812926">.</span><span class="ident" id="1812927">arg</span>&nbsp;<span class="op" id="1812931">=</span>&nbsp;<span class="ident" id="1812933">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1812939">pd</span><span class="op" id="1812941">.</span><span class="ident" id="1812942">rt</span><span class="op" id="1812944">.</span><span class="ident" id="1812945">seq</span>&nbsp;<span class="op" id="1812949">=</span>&nbsp;<span class="ident" id="1812951">pd</span><span class="op" id="1812953">.</span><span class="ident" id="1812954">seq</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1812961">addtimer</span><span class="op" id="1812969">(</span><span class="op" id="1812970">&amp;</span><span class="ident" id="1812971">pd</span><span class="op" id="1812973">.</span><span class="ident" id="1812974">rt</span><span class="op" id="1812976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1812980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1812984">if</span>&nbsp;<span class="ident" id="1812987">pd</span><span class="op" id="1812989">.</span><span class="ident" id="1812990">wd</span>&nbsp;<span class="op" id="1812993">&gt;</span>&nbsp;<span class="num" id="1812995">0</span>&nbsp;<span class="op" id="1812997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1813002">pd</span><span class="op" id="1813004">.</span><span class="ident" id="1813005">wt</span><span class="op" id="1813007">.</span><span class="ident" id="1813008">f</span>&nbsp;<span class="op" id="1813010">=</span>&nbsp;<span class="ident" id="1813012">netpollWriteDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1813036">pd</span><span class="op" id="1813038">.</span><span class="ident" id="1813039">wt</span><span class="op" id="1813041">.</span><span class="ident" id="1813042">when</span>&nbsp;<span class="op" id="1813047">=</span>&nbsp;<span class="ident" id="1813049">pd</span><span class="op" id="1813051">.</span><span class="ident" id="1813052">wd</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1813058">pd</span><span class="op" id="1813060">.</span><span class="ident" id="1813061">wt</span><span class="op" id="1813063">.</span><span class="ident" id="1813064">arg</span>&nbsp;<span class="op" id="1813068">=</span>&nbsp;<span class="ident" id="1813070">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1813076">pd</span><span class="op" id="1813078">.</span><span class="ident" id="1813079">wt</span><span class="op" id="1813081">.</span><span class="ident" id="1813082">seq</span>&nbsp;<span class="op" id="1813086">=</span>&nbsp;<span class="ident" id="1813088">pd</span><span class="op" id="1813090">.</span><span class="ident" id="1813091">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1813098">addtimer</span><span class="op" id="1813106">(</span><span class="op" id="1813107">&amp;</span><span class="ident" id="1813108">pd</span><span class="op" id="1813110">.</span><span class="ident" id="1813111">wt</span><span class="op" id="1813113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1813117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1813120">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1813123">//&nbsp;If&nbsp;we&nbsp;set&nbsp;the&nbsp;new&nbsp;deadline&nbsp;in&nbsp;the&nbsp;past,&nbsp;unblock&nbsp;currently&nbsp;pending&nbsp;IO&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1813204">var</span>&nbsp;<span class="ident" id="1813208">rg</span><span class="op" id="1813210">,</span>&nbsp;<span class="ident" id="1813212">wg</span>&nbsp;<span class="op" id="1813215">*</span><span class="ident" id="1813216">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1813219">atomicstorep</span><span class="op" id="1813231">(</span><span class="ident" id="1813232">unsafe</span><span class="op" id="1813238">.</span><span class="ident" id="1813239">Pointer</span><span class="op" id="1813246">(</span><span class="op" id="1813247">&amp;</span><span class="ident" id="1813248">wg</span><span class="op" id="1813250">)</span><span class="op" id="1813251">,</span>&nbsp;<span class="ident" id="1813253">nil</span><span class="op" id="1813256">)</span>&nbsp;<span class="comment" id="1813258">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;stores&nbsp;to&nbsp;rd/wd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1813342">if</span>&nbsp;<span class="ident" id="1813345">pd</span><span class="op" id="1813347">.</span><span class="ident" id="1813348">rd</span>&nbsp;<span class="op" id="1813351">&lt;</span>&nbsp;<span class="num" id="1813353">0</span>&nbsp;<span class="op" id="1813355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1813359">rg</span>&nbsp;<span class="op" id="1813362">=</span>&nbsp;<span class="ident" id="1813364">netpollunblock</span><span class="op" id="1813378">(</span><span class="ident" id="1813379">pd</span><span class="op" id="1813381">,</span>&nbsp;<span class="string" id="1813383">&#39;r&#39;</span><span class="op" id="1813386">,</span>&nbsp;<span class="builtintype" id="1813388">false</span><span class="op" id="1813393">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1813396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1813399">if</span>&nbsp;<span class="ident" id="1813402">pd</span><span class="op" id="1813404">.</span><span class="ident" id="1813405">wd</span>&nbsp;<span class="op" id="1813408">&lt;</span>&nbsp;<span class="num" id="1813410">0</span>&nbsp;<span class="op" id="1813412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1813416">wg</span>&nbsp;<span class="op" id="1813419">=</span>&nbsp;<span class="ident" id="1813421">netpollunblock</span><span class="op" id="1813435">(</span><span class="ident" id="1813436">pd</span><span class="op" id="1813438">,</span>&nbsp;<span class="string" id="1813440">&#39;w&#39;</span><span class="op" id="1813443">,</span>&nbsp;<span class="builtintype" id="1813445">false</span><span class="op" id="1813450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1813453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1813456">unlock</span><span class="op" id="1813462">(</span><span class="op" id="1813463">&amp;</span><span class="ident" id="1813464">pd</span><span class="op" id="1813466">.</span><span class="ident" id="1813467">lock</span><span class="op" id="1813471">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1813474">if</span>&nbsp;<span class="ident" id="1813477">rg</span>&nbsp;<span class="op" id="1813480">!=</span>&nbsp;<span class="ident" id="1813483">nil</span>&nbsp;<span class="op" id="1813487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1813491">goready</span><span class="op" id="1813498">(</span><span class="ident" id="1813499">rg</span><span class="op" id="1813501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1813504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1813507">if</span>&nbsp;<span class="ident" id="1813510">wg</span>&nbsp;<span class="op" id="1813513">!=</span>&nbsp;<span class="ident" id="1813516">nil</span>&nbsp;<span class="op" id="1813520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1813524">goready</span><span class="op" id="1813531">(</span><span class="ident" id="1813532">wg</span><span class="op" id="1813534">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1813537">}</span><br>
<span class="lineno"></span><span class="op" id="1813539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1813542">func</span>&nbsp;<span class="ident" id="1813547">netpollUnblock</span><span class="op" id="1813561">(</span><span class="ident" id="1813562">pd</span>&nbsp;<span class="op" id="1813565">*</span><span class="ident" id="1813566">pollDesc</span><span class="op" id="1813574">)</span>&nbsp;<span class="op" id="1813576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1813579">lock</span><span class="op" id="1813583">(</span><span class="op" id="1813584">&amp;</span><span class="ident" id="1813585">pd</span><span class="op" id="1813587">.</span><span class="ident" id="1813588">lock</span><span class="op" id="1813592">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1813595">if</span>&nbsp;<span class="ident" id="1813598">pd</span><span class="op" id="1813600">.</span><span class="ident" id="1813601">closing</span>&nbsp;<span class="op" id="1813609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1813613">gothrow</span><span class="op" id="1813620">(</span><span class="string" id="1813621">&#34;netpollUnblock:&nbsp;already&nbsp;closing&#34;</span><span class="op" id="1813654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1813657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1813660">pd</span><span class="op" id="1813662">.</span><span class="ident" id="1813663">closing</span>&nbsp;<span class="op" id="1813671">=</span>&nbsp;<span class="builtintype" id="1813673">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1813679">pd</span><span class="op" id="1813681">.</span><span class="ident" id="1813682">seq</span><span class="op" id="1813685">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1813689">var</span>&nbsp;<span class="ident" id="1813693">rg</span><span class="op" id="1813695">,</span>&nbsp;<span class="ident" id="1813697">wg</span>&nbsp;<span class="op" id="1813700">*</span><span class="ident" id="1813701">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1813704">atomicstorep</span><span class="op" id="1813716">(</span><span class="ident" id="1813717">unsafe</span><span class="op" id="1813723">.</span><span class="ident" id="1813724">Pointer</span><span class="op" id="1813731">(</span><span class="op" id="1813732">&amp;</span><span class="ident" id="1813733">rg</span><span class="op" id="1813735">)</span><span class="op" id="1813736">,</span>&nbsp;<span class="ident" id="1813738">nil</span><span class="op" id="1813741">)</span>&nbsp;<span class="comment" id="1813743">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;closing&nbsp;and&nbsp;read&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1813828">rg</span>&nbsp;<span class="op" id="1813831">=</span>&nbsp;<span class="ident" id="1813833">netpollunblock</span><span class="op" id="1813847">(</span><span class="ident" id="1813848">pd</span><span class="op" id="1813850">,</span>&nbsp;<span class="string" id="1813852">&#39;r&#39;</span><span class="op" id="1813855">,</span>&nbsp;<span class="builtintype" id="1813857">false</span><span class="op" id="1813862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1813865">wg</span>&nbsp;<span class="op" id="1813868">=</span>&nbsp;<span class="ident" id="1813870">netpollunblock</span><span class="op" id="1813884">(</span><span class="ident" id="1813885">pd</span><span class="op" id="1813887">,</span>&nbsp;<span class="string" id="1813889">&#39;w&#39;</span><span class="op" id="1813892">,</span>&nbsp;<span class="builtintype" id="1813894">false</span><span class="op" id="1813899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1813902">if</span>&nbsp;<span class="ident" id="1813905">pd</span><span class="op" id="1813907">.</span><span class="ident" id="1813908">rt</span><span class="op" id="1813910">.</span><span class="ident" id="1813911">f</span>&nbsp;<span class="op" id="1813913">!=</span>&nbsp;<span class="ident" id="1813916">nil</span>&nbsp;<span class="op" id="1813920">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1813924">deltimer</span><span class="op" id="1813932">(</span><span class="op" id="1813933">&amp;</span><span class="ident" id="1813934">pd</span><span class="op" id="1813936">.</span><span class="ident" id="1813937">rt</span><span class="op" id="1813939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1813943">pd</span><span class="op" id="1813945">.</span><span class="ident" id="1813946">rt</span><span class="op" id="1813948">.</span><span class="ident" id="1813949">f</span>&nbsp;<span class="op" id="1813951">=</span>&nbsp;<span class="ident" id="1813953">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1813958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1813961">if</span>&nbsp;<span class="ident" id="1813964">pd</span><span class="op" id="1813966">.</span><span class="ident" id="1813967">wt</span><span class="op" id="1813969">.</span><span class="ident" id="1813970">f</span>&nbsp;<span class="op" id="1813972">!=</span>&nbsp;<span class="ident" id="1813975">nil</span>&nbsp;<span class="op" id="1813979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1813983">deltimer</span><span class="op" id="1813991">(</span><span class="op" id="1813992">&amp;</span><span class="ident" id="1813993">pd</span><span class="op" id="1813995">.</span><span class="ident" id="1813996">wt</span><span class="op" id="1813998">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1814002">pd</span><span class="op" id="1814004">.</span><span class="ident" id="1814005">wt</span><span class="op" id="1814007">.</span><span class="ident" id="1814008">f</span>&nbsp;<span class="op" id="1814010">=</span>&nbsp;<span class="ident" id="1814012">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1814017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1814020">unlock</span><span class="op" id="1814026">(</span><span class="op" id="1814027">&amp;</span><span class="ident" id="1814028">pd</span><span class="op" id="1814030">.</span><span class="ident" id="1814031">lock</span><span class="op" id="1814035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1814038">if</span>&nbsp;<span class="ident" id="1814041">rg</span>&nbsp;<span class="op" id="1814044">!=</span>&nbsp;<span class="ident" id="1814047">nil</span>&nbsp;<span class="op" id="1814051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1814055">goready</span><span class="op" id="1814062">(</span><span class="ident" id="1814063">rg</span><span class="op" id="1814065">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1814068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1814071">if</span>&nbsp;<span class="ident" id="1814074">wg</span>&nbsp;<span class="op" id="1814077">!=</span>&nbsp;<span class="ident" id="1814080">nil</span>&nbsp;<span class="op" id="1814084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1814088">goready</span><span class="op" id="1814095">(</span><span class="ident" id="1814096">wg</span><span class="op" id="1814098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1814101">}</span><br>
<span class="lineno"></span><span class="op" id="1814103">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="1814106">func</span>&nbsp;<span class="ident" id="1814111">netpollfd</span><span class="op" id="1814120">(</span><span class="ident" id="1814121">pd</span>&nbsp;<span class="op" id="1814124">*</span><span class="ident" id="1814125">pollDesc</span><span class="op" id="1814133">)</span>&nbsp;<span class="builtintype" id="1814135">uintptr</span>&nbsp;<span class="op" id="1814143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1814146">return</span>&nbsp;<span class="ident" id="1814153">pd</span><span class="op" id="1814155">.</span><span class="ident" id="1814156">fd</span><br>
<span class="lineno"></span><span class="op" id="1814159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1814162">func</span>&nbsp;<span class="ident" id="1814167">netpolluser</span><span class="op" id="1814178">(</span><span class="ident" id="1814179">pd</span>&nbsp;<span class="op" id="1814182">*</span><span class="ident" id="1814183">pollDesc</span><span class="op" id="1814191">)</span>&nbsp;<span class="op" id="1814193">*</span><span class="ident" id="1814194">unsafe</span><span class="op" id="1814200">.</span><span class="ident" id="1814201">Pointer</span>&nbsp;<span class="op" id="1814209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1814212">return</span>&nbsp;<span class="op" id="1814219">&amp;</span><span class="ident" id="1814220">pd</span><span class="op" id="1814222">.</span><span class="ident" id="1814223">user</span><br>
<span class="lineno"></span><span class="op" id="1814228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1814231">func</span>&nbsp;<span class="ident" id="1814236">netpollclosing</span><span class="op" id="1814250">(</span><span class="ident" id="1814251">pd</span>&nbsp;<span class="op" id="1814254">*</span><span class="ident" id="1814255">pollDesc</span><span class="op" id="1814263">)</span>&nbsp;<span class="builtintype" id="1814265">bool</span>&nbsp;<span class="op" id="1814270">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1814273">return</span>&nbsp;<span class="ident" id="1814280">pd</span><span class="op" id="1814282">.</span><span class="ident" id="1814283">closing</span><br>
<span class="lineno"></span><span class="op" id="1814291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1814294">func</span>&nbsp;<span class="ident" id="1814299">netpolllock</span><span class="op" id="1814310">(</span><span class="ident" id="1814311">pd</span>&nbsp;<span class="op" id="1814314">*</span><span class="ident" id="1814315">pollDesc</span><span class="op" id="1814323">)</span>&nbsp;<span class="op" id="1814325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1814328">lock</span><span class="op" id="1814332">(</span><span class="op" id="1814333">&amp;</span><span class="ident" id="1814334">pd</span><span class="op" id="1814336">.</span><span class="ident" id="1814337">lock</span><span class="op" id="1814341">)</span><br>
<span class="lineno">280</span><span class="op" id="1814343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1814346">func</span>&nbsp;<span class="ident" id="1814351">netpollunlock</span><span class="op" id="1814364">(</span><span class="ident" id="1814365">pd</span>&nbsp;<span class="op" id="1814368">*</span><span class="ident" id="1814369">pollDesc</span><span class="op" id="1814377">)</span>&nbsp;<span class="op" id="1814379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1814382">unlock</span><span class="op" id="1814388">(</span><span class="op" id="1814389">&amp;</span><span class="ident" id="1814390">pd</span><span class="op" id="1814392">.</span><span class="ident" id="1814393">lock</span><span class="op" id="1814397">)</span><br>
<span class="lineno"></span><span class="op" id="1814399">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="1814402">//&nbsp;make&nbsp;pd&nbsp;ready,&nbsp;newly&nbsp;runnable&nbsp;goroutines&nbsp;(if&nbsp;any)&nbsp;are&nbsp;returned&nbsp;in&nbsp;rg/wg</span><br>
<span class="lineno"></span><span class="keyword" id="1814477">func</span>&nbsp;<span class="ident" id="1814482">netpollready</span><span class="op" id="1814494">(</span><span class="ident" id="1814495">gpp</span>&nbsp;<span class="op" id="1814499">*</span><span class="op" id="1814500">*</span><span class="ident" id="1814501">g</span><span class="op" id="1814502">,</span>&nbsp;<span class="ident" id="1814504">pd</span>&nbsp;<span class="op" id="1814507">*</span><span class="ident" id="1814508">pollDesc</span><span class="op" id="1814516">,</span>&nbsp;<span class="ident" id="1814518">mode</span>&nbsp;<span class="builtintype" id="1814523">int32</span><span class="op" id="1814528">)</span>&nbsp;<span class="op" id="1814530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1814533">var</span>&nbsp;<span class="ident" id="1814537">rg</span><span class="op" id="1814539">,</span>&nbsp;<span class="ident" id="1814541">wg</span>&nbsp;<span class="op" id="1814544">*</span><span class="ident" id="1814545">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1814548">if</span>&nbsp;<span class="ident" id="1814551">mode</span>&nbsp;<span class="op" id="1814556">==</span>&nbsp;<span class="string" id="1814559">&#39;r&#39;</span>&nbsp;<span class="op" id="1814563">||</span>&nbsp;<span class="ident" id="1814566">mode</span>&nbsp;<span class="op" id="1814571">==</span>&nbsp;<span class="string" id="1814574">&#39;r&#39;</span><span class="op" id="1814577">+</span><span class="string" id="1814578">&#39;w&#39;</span>&nbsp;<span class="op" id="1814582">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1814586">rg</span>&nbsp;<span class="op" id="1814589">=</span>&nbsp;<span class="ident" id="1814591">netpollunblock</span><span class="op" id="1814605">(</span><span class="ident" id="1814606">pd</span><span class="op" id="1814608">,</span>&nbsp;<span class="string" id="1814610">&#39;r&#39;</span><span class="op" id="1814613">,</span>&nbsp;<span class="builtintype" id="1814615">true</span><span class="op" id="1814619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1814622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1814625">if</span>&nbsp;<span class="ident" id="1814628">mode</span>&nbsp;<span class="op" id="1814633">==</span>&nbsp;<span class="string" id="1814636">&#39;w&#39;</span>&nbsp;<span class="op" id="1814640">||</span>&nbsp;<span class="ident" id="1814643">mode</span>&nbsp;<span class="op" id="1814648">==</span>&nbsp;<span class="string" id="1814651">&#39;r&#39;</span><span class="op" id="1814654">+</span><span class="string" id="1814655">&#39;w&#39;</span>&nbsp;<span class="op" id="1814659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1814663">wg</span>&nbsp;<span class="op" id="1814666">=</span>&nbsp;<span class="ident" id="1814668">netpollunblock</span><span class="op" id="1814682">(</span><span class="ident" id="1814683">pd</span><span class="op" id="1814685">,</span>&nbsp;<span class="string" id="1814687">&#39;w&#39;</span><span class="op" id="1814690">,</span>&nbsp;<span class="builtintype" id="1814692">true</span><span class="op" id="1814696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1814699">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1814702">if</span>&nbsp;<span class="ident" id="1814705">rg</span>&nbsp;<span class="op" id="1814708">!=</span>&nbsp;<span class="ident" id="1814711">nil</span>&nbsp;<span class="op" id="1814715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1814719">rg</span><span class="op" id="1814721">.</span><span class="ident" id="1814722">schedlink</span>&nbsp;<span class="op" id="1814732">=</span>&nbsp;<span class="op" id="1814734">*</span><span class="ident" id="1814735">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1814741">*</span><span class="ident" id="1814742">gpp</span>&nbsp;<span class="op" id="1814746">=</span>&nbsp;<span class="ident" id="1814748">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1814752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1814755">if</span>&nbsp;<span class="ident" id="1814758">wg</span>&nbsp;<span class="op" id="1814761">!=</span>&nbsp;<span class="ident" id="1814764">nil</span>&nbsp;<span class="op" id="1814768">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1814772">wg</span><span class="op" id="1814774">.</span><span class="ident" id="1814775">schedlink</span>&nbsp;<span class="op" id="1814785">=</span>&nbsp;<span class="op" id="1814787">*</span><span class="ident" id="1814788">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1814794">*</span><span class="ident" id="1814795">gpp</span>&nbsp;<span class="op" id="1814799">=</span>&nbsp;<span class="ident" id="1814801">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1814805">}</span><br>
<span class="lineno"></span><span class="op" id="1814807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="keyword" id="1814810">func</span>&nbsp;<span class="ident" id="1814815">netpollcheckerr</span><span class="op" id="1814830">(</span><span class="ident" id="1814831">pd</span>&nbsp;<span class="op" id="1814834">*</span><span class="ident" id="1814835">pollDesc</span><span class="op" id="1814843">,</span>&nbsp;<span class="ident" id="1814845">mode</span>&nbsp;<span class="builtintype" id="1814850">int32</span><span class="op" id="1814855">)</span>&nbsp;<span class="builtintype" id="1814857">int</span>&nbsp;<span class="op" id="1814861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1814864">if</span>&nbsp;<span class="ident" id="1814867">pd</span><span class="op" id="1814869">.</span><span class="ident" id="1814870">closing</span>&nbsp;<span class="op" id="1814878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1814882">return</span>&nbsp;<span class="num" id="1814889">1</span>&nbsp;<span class="comment" id="1814891">//&nbsp;errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1814906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1814909">if</span>&nbsp;<span class="op" id="1814912">(</span><span class="ident" id="1814913">mode</span>&nbsp;<span class="op" id="1814918">==</span>&nbsp;<span class="string" id="1814921">&#39;r&#39;</span>&nbsp;<span class="op" id="1814925">&amp;&amp;</span>&nbsp;<span class="ident" id="1814928">pd</span><span class="op" id="1814930">.</span><span class="ident" id="1814931">rd</span>&nbsp;<span class="op" id="1814934">&lt;</span>&nbsp;<span class="num" id="1814936">0</span><span class="op" id="1814937">)</span>&nbsp;<span class="op" id="1814939">||</span>&nbsp;<span class="op" id="1814942">(</span><span class="ident" id="1814943">mode</span>&nbsp;<span class="op" id="1814948">==</span>&nbsp;<span class="string" id="1814951">&#39;w&#39;</span>&nbsp;<span class="op" id="1814955">&amp;&amp;</span>&nbsp;<span class="ident" id="1814958">pd</span><span class="op" id="1814960">.</span><span class="ident" id="1814961">wd</span>&nbsp;<span class="op" id="1814964">&lt;</span>&nbsp;<span class="num" id="1814966">0</span><span class="op" id="1814967">)</span>&nbsp;<span class="op" id="1814969">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1814973">return</span>&nbsp;<span class="num" id="1814980">2</span>&nbsp;<span class="comment" id="1814982">//&nbsp;errTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1814997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1815000">return</span>&nbsp;<span class="num" id="1815007">0</span><br>
<span class="lineno"></span><span class="op" id="1815009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="keyword" id="1815012">func</span>&nbsp;<span class="ident" id="1815017">netpollblockcommit</span><span class="op" id="1815035">(</span><span class="ident" id="1815036">gp</span>&nbsp;<span class="op" id="1815039">*</span><span class="ident" id="1815040">g</span><span class="op" id="1815041">,</span>&nbsp;<span class="ident" id="1815043">gpp</span>&nbsp;<span class="ident" id="1815047">unsafe</span><span class="op" id="1815053">.</span><span class="ident" id="1815054">Pointer</span><span class="op" id="1815061">)</span>&nbsp;<span class="builtintype" id="1815063">bool</span>&nbsp;<span class="op" id="1815068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1815071">return</span>&nbsp;<span class="ident" id="1815078">casuintptr</span><span class="op" id="1815088">(</span><span class="op" id="1815089">(</span><span class="op" id="1815090">*</span><span class="builtintype" id="1815091">uintptr</span><span class="op" id="1815098">)</span><span class="op" id="1815099">(</span><span class="ident" id="1815100">gpp</span><span class="op" id="1815103">)</span><span class="op" id="1815104">,</span>&nbsp;<span class="ident" id="1815106">pdWait</span><span class="op" id="1815112">,</span>&nbsp;<span class="builtintype" id="1815114">uintptr</span><span class="op" id="1815121">(</span><span class="ident" id="1815122">unsafe</span><span class="op" id="1815128">.</span><span class="ident" id="1815129">Pointer</span><span class="op" id="1815136">(</span><span class="ident" id="1815137">gp</span><span class="op" id="1815139">)</span><span class="op" id="1815140">)</span><span class="op" id="1815141">)</span><br>
<span class="lineno"></span><span class="op" id="1815143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1815146">//&nbsp;returns&nbsp;true&nbsp;if&nbsp;IO&nbsp;is&nbsp;ready,&nbsp;or&nbsp;false&nbsp;if&nbsp;timedout&nbsp;or&nbsp;closed</span><br>
<span class="lineno">320</span><span class="comment" id="1815209">//&nbsp;waitio&nbsp;-&nbsp;wait&nbsp;only&nbsp;for&nbsp;completed&nbsp;IO,&nbsp;ignore&nbsp;errors</span><br>
<span class="lineno"></span><span class="keyword" id="1815263">func</span>&nbsp;<span class="ident" id="1815268">netpollblock</span><span class="op" id="1815280">(</span><span class="ident" id="1815281">pd</span>&nbsp;<span class="op" id="1815284">*</span><span class="ident" id="1815285">pollDesc</span><span class="op" id="1815293">,</span>&nbsp;<span class="ident" id="1815295">mode</span>&nbsp;<span class="builtintype" id="1815300">int32</span><span class="op" id="1815305">,</span>&nbsp;<span class="ident" id="1815307">waitio</span>&nbsp;<span class="builtintype" id="1815314">bool</span><span class="op" id="1815318">)</span>&nbsp;<span class="builtintype" id="1815320">bool</span>&nbsp;<span class="op" id="1815325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1815328">gpp</span>&nbsp;<span class="op" id="1815332">:=</span>&nbsp;<span class="op" id="1815335">&amp;</span><span class="ident" id="1815336">pd</span><span class="op" id="1815338">.</span><span class="ident" id="1815339">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1815343">if</span>&nbsp;<span class="ident" id="1815346">mode</span>&nbsp;<span class="op" id="1815351">==</span>&nbsp;<span class="string" id="1815354">&#39;w&#39;</span>&nbsp;<span class="op" id="1815358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1815362">gpp</span>&nbsp;<span class="op" id="1815366">=</span>&nbsp;<span class="op" id="1815368">&amp;</span><span class="ident" id="1815369">pd</span><span class="op" id="1815371">.</span><span class="ident" id="1815372">wg</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1815376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1815380">//&nbsp;set&nbsp;the&nbsp;gpp&nbsp;semaphore&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1815414">for</span>&nbsp;<span class="op" id="1815418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1815422">old</span>&nbsp;<span class="op" id="1815426">:=</span>&nbsp;<span class="op" id="1815429">*</span><span class="ident" id="1815430">gpp</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1815436">if</span>&nbsp;<span class="ident" id="1815439">old</span>&nbsp;<span class="op" id="1815443">==</span>&nbsp;<span class="ident" id="1815446">pdReady</span>&nbsp;<span class="op" id="1815454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1815459">*</span><span class="ident" id="1815460">gpp</span>&nbsp;<span class="op" id="1815464">=</span>&nbsp;<span class="num" id="1815466">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1815471">return</span>&nbsp;<span class="builtintype" id="1815478">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1815485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1815489">if</span>&nbsp;<span class="ident" id="1815492">old</span>&nbsp;<span class="op" id="1815496">!=</span>&nbsp;<span class="num" id="1815499">0</span>&nbsp;<span class="op" id="1815501">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1815506">gothrow</span><span class="op" id="1815513">(</span><span class="string" id="1815514">&#34;netpollblock:&nbsp;double&nbsp;wait&#34;</span><span class="op" id="1815541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1815545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1815549">if</span>&nbsp;<span class="ident" id="1815552">casuintptr</span><span class="op" id="1815562">(</span><span class="ident" id="1815563">gpp</span><span class="op" id="1815566">,</span>&nbsp;<span class="num" id="1815568">0</span><span class="op" id="1815569">,</span>&nbsp;<span class="ident" id="1815571">pdWait</span><span class="op" id="1815577">)</span>&nbsp;<span class="op" id="1815579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1815584">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1815592">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1815595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1815599">//&nbsp;need&nbsp;to&nbsp;recheck&nbsp;error&nbsp;states&nbsp;after&nbsp;setting&nbsp;gpp&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1815658">//&nbsp;this&nbsp;is&nbsp;necessary&nbsp;because&nbsp;runtime_pollUnblock/runtime_pollSetDeadline/deadlineimpl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1815745">//&nbsp;do&nbsp;the&nbsp;opposite:&nbsp;store&nbsp;to&nbsp;closing/rd/wd,&nbsp;membarrier,&nbsp;load&nbsp;of&nbsp;rg/wg</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1815816">if</span>&nbsp;<span class="ident" id="1815819">waitio</span>&nbsp;<span class="op" id="1815826">||</span>&nbsp;<span class="ident" id="1815829">netpollcheckerr</span><span class="op" id="1815844">(</span><span class="ident" id="1815845">pd</span><span class="op" id="1815847">,</span>&nbsp;<span class="ident" id="1815849">mode</span><span class="op" id="1815853">)</span>&nbsp;<span class="op" id="1815855">==</span>&nbsp;<span class="num" id="1815858">0</span>&nbsp;<span class="op" id="1815860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1815864">f</span>&nbsp;<span class="op" id="1815866">:=</span>&nbsp;<span class="ident" id="1815869">netpollblockcommit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1815890">gopark</span><span class="op" id="1815896">(</span><span class="op" id="1815897">*</span><span class="op" id="1815898">*</span><span class="op" id="1815899">(</span><span class="op" id="1815900">*</span><span class="op" id="1815901">*</span><span class="ident" id="1815902">unsafe</span><span class="op" id="1815908">.</span><span class="ident" id="1815909">Pointer</span><span class="op" id="1815916">)</span><span class="op" id="1815917">(</span><span class="ident" id="1815918">unsafe</span><span class="op" id="1815924">.</span><span class="ident" id="1815925">Pointer</span><span class="op" id="1815932">(</span><span class="op" id="1815933">&amp;</span><span class="ident" id="1815934">f</span><span class="op" id="1815935">)</span><span class="op" id="1815936">)</span><span class="op" id="1815937">,</span>&nbsp;<span class="ident" id="1815939">unsafe</span><span class="op" id="1815945">.</span><span class="ident" id="1815946">Pointer</span><span class="op" id="1815953">(</span><span class="ident" id="1815954">gpp</span><span class="op" id="1815957">)</span><span class="op" id="1815958">,</span>&nbsp;<span class="string" id="1815960">&#34;IO&nbsp;wait&#34;</span><span class="op" id="1815969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1815972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1815975">//&nbsp;be&nbsp;careful&nbsp;to&nbsp;not&nbsp;lose&nbsp;concurrent&nbsp;READY&nbsp;notification</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1816032">old</span>&nbsp;<span class="op" id="1816036">:=</span>&nbsp;<span class="ident" id="1816039">xchguintptr</span><span class="op" id="1816050">(</span><span class="ident" id="1816051">gpp</span><span class="op" id="1816054">,</span>&nbsp;<span class="num" id="1816056">0</span><span class="op" id="1816057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816060">if</span>&nbsp;<span class="ident" id="1816063">old</span>&nbsp;<span class="op" id="1816067">&gt;</span>&nbsp;<span class="ident" id="1816069">pdWait</span>&nbsp;<span class="op" id="1816076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1816080">gothrow</span><span class="op" id="1816087">(</span><span class="string" id="1816088">&#34;netpollblock:&nbsp;corrupted&nbsp;state&#34;</span><span class="op" id="1816119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1816122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816125">return</span>&nbsp;<span class="ident" id="1816132">old</span>&nbsp;<span class="op" id="1816136">==</span>&nbsp;<span class="ident" id="1816139">pdReady</span><br>
<span class="lineno">355</span><span class="op" id="1816147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1816150">func</span>&nbsp;<span class="ident" id="1816155">netpollunblock</span><span class="op" id="1816169">(</span><span class="ident" id="1816170">pd</span>&nbsp;<span class="op" id="1816173">*</span><span class="ident" id="1816174">pollDesc</span><span class="op" id="1816182">,</span>&nbsp;<span class="ident" id="1816184">mode</span>&nbsp;<span class="builtintype" id="1816189">int32</span><span class="op" id="1816194">,</span>&nbsp;<span class="ident" id="1816196">ioready</span>&nbsp;<span class="builtintype" id="1816204">bool</span><span class="op" id="1816208">)</span>&nbsp;<span class="op" id="1816210">*</span><span class="ident" id="1816211">g</span>&nbsp;<span class="op" id="1816213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1816216">gpp</span>&nbsp;<span class="op" id="1816220">:=</span>&nbsp;<span class="op" id="1816223">&amp;</span><span class="ident" id="1816224">pd</span><span class="op" id="1816226">.</span><span class="ident" id="1816227">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816231">if</span>&nbsp;<span class="ident" id="1816234">mode</span>&nbsp;<span class="op" id="1816239">==</span>&nbsp;<span class="string" id="1816242">&#39;w&#39;</span>&nbsp;<span class="op" id="1816246">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1816250">gpp</span>&nbsp;<span class="op" id="1816254">=</span>&nbsp;<span class="op" id="1816256">&amp;</span><span class="ident" id="1816257">pd</span><span class="op" id="1816259">.</span><span class="ident" id="1816260">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1816264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816268">for</span>&nbsp;<span class="op" id="1816272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1816276">old</span>&nbsp;<span class="op" id="1816280">:=</span>&nbsp;<span class="op" id="1816283">*</span><span class="ident" id="1816284">gpp</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816290">if</span>&nbsp;<span class="ident" id="1816293">old</span>&nbsp;<span class="op" id="1816297">==</span>&nbsp;<span class="ident" id="1816300">pdReady</span>&nbsp;<span class="op" id="1816308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816313">return</span>&nbsp;<span class="ident" id="1816320">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1816326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816330">if</span>&nbsp;<span class="ident" id="1816333">old</span>&nbsp;<span class="op" id="1816337">==</span>&nbsp;<span class="num" id="1816340">0</span>&nbsp;<span class="op" id="1816342">&amp;&amp;</span>&nbsp;<span class="op" id="1816345">!</span><span class="ident" id="1816346">ioready</span>&nbsp;<span class="op" id="1816354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1816359">//&nbsp;Only&nbsp;set&nbsp;READY&nbsp;for&nbsp;ioready.&nbsp;runtime_pollWait</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1816410">//&nbsp;will&nbsp;check&nbsp;for&nbsp;timeout/cancel&nbsp;before&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816462">return</span>&nbsp;<span class="ident" id="1816469">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1816475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816479">var</span>&nbsp;<span class="builtinfunc" id="1816483">new</span>&nbsp;<span class="builtintype" id="1816487">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816497">if</span>&nbsp;<span class="ident" id="1816500">ioready</span>&nbsp;<span class="op" id="1816508">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1816513">new</span>&nbsp;<span class="op" id="1816517">=</span>&nbsp;<span class="ident" id="1816519">pdReady</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1816529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816533">if</span>&nbsp;<span class="ident" id="1816536">casuintptr</span><span class="op" id="1816546">(</span><span class="ident" id="1816547">gpp</span><span class="op" id="1816550">,</span>&nbsp;<span class="ident" id="1816552">old</span><span class="op" id="1816555">,</span>&nbsp;<span class="builtinfunc" id="1816557">new</span><span class="op" id="1816560">)</span>&nbsp;<span class="op" id="1816562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816567">if</span>&nbsp;<span class="ident" id="1816570">old</span>&nbsp;<span class="op" id="1816574">==</span>&nbsp;<span class="ident" id="1816577">pdReady</span>&nbsp;<span class="op" id="1816585">||</span>&nbsp;<span class="ident" id="1816588">old</span>&nbsp;<span class="op" id="1816592">==</span>&nbsp;<span class="ident" id="1816595">pdWait</span>&nbsp;<span class="op" id="1816602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1816608">old</span>&nbsp;<span class="op" id="1816612">=</span>&nbsp;<span class="num" id="1816614">0</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1816619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816624">return</span>&nbsp;<span class="op" id="1816631">(</span><span class="op" id="1816632">*</span><span class="ident" id="1816633">g</span><span class="op" id="1816634">)</span><span class="op" id="1816635">(</span><span class="ident" id="1816636">unsafe</span><span class="op" id="1816642">.</span><span class="ident" id="1816643">Pointer</span><span class="op" id="1816650">(</span><span class="ident" id="1816651">old</span><span class="op" id="1816654">)</span><span class="op" id="1816655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1816659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1816662">}</span><br>
<span class="lineno"></span><span class="op" id="1816664">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span><span class="keyword" id="1816667">func</span>&nbsp;<span class="ident" id="1816672">netpolldeadlineimpl</span><span class="op" id="1816691">(</span><span class="ident" id="1816692">pd</span>&nbsp;<span class="op" id="1816695">*</span><span class="ident" id="1816696">pollDesc</span><span class="op" id="1816704">,</span>&nbsp;<span class="ident" id="1816706">seq</span>&nbsp;<span class="builtintype" id="1816710">uintptr</span><span class="op" id="1816717">,</span>&nbsp;<span class="ident" id="1816719">read</span><span class="op" id="1816723">,</span>&nbsp;<span class="ident" id="1816725">write</span>&nbsp;<span class="builtintype" id="1816731">bool</span><span class="op" id="1816735">)</span>&nbsp;<span class="op" id="1816737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1816740">lock</span><span class="op" id="1816744">(</span><span class="op" id="1816745">&amp;</span><span class="ident" id="1816746">pd</span><span class="op" id="1816748">.</span><span class="ident" id="1816749">lock</span><span class="op" id="1816753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1816756">//&nbsp;Seq&nbsp;arg&nbsp;is&nbsp;seq&nbsp;when&nbsp;the&nbsp;timer&nbsp;was&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1816799">//&nbsp;If&nbsp;it&#39;s&nbsp;stale,&nbsp;ignore&nbsp;the&nbsp;timer&nbsp;event.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816842">if</span>&nbsp;<span class="ident" id="1816845">seq</span>&nbsp;<span class="op" id="1816849">!=</span>&nbsp;<span class="ident" id="1816852">pd</span><span class="op" id="1816854">.</span><span class="ident" id="1816855">seq</span>&nbsp;<span class="op" id="1816859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1816863">//&nbsp;The&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1816916">unlock</span><span class="op" id="1816922">(</span><span class="op" id="1816923">&amp;</span><span class="ident" id="1816924">pd</span><span class="op" id="1816926">.</span><span class="ident" id="1816927">lock</span><span class="op" id="1816931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816935">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1816943">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816946">var</span>&nbsp;<span class="ident" id="1816950">rg</span>&nbsp;<span class="op" id="1816953">*</span><span class="ident" id="1816954">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816957">if</span>&nbsp;<span class="ident" id="1816960">read</span>&nbsp;<span class="op" id="1816965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816969">if</span>&nbsp;<span class="ident" id="1816972">pd</span><span class="op" id="1816974">.</span><span class="ident" id="1816975">rd</span>&nbsp;<span class="op" id="1816978">&lt;=</span>&nbsp;<span class="num" id="1816981">0</span>&nbsp;<span class="op" id="1816983">||</span>&nbsp;<span class="ident" id="1816986">pd</span><span class="op" id="1816988">.</span><span class="ident" id="1816989">rt</span><span class="op" id="1816991">.</span><span class="ident" id="1816992">f</span>&nbsp;<span class="op" id="1816994">==</span>&nbsp;<span class="ident" id="1816997">nil</span>&nbsp;<span class="op" id="1817001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817006">gothrow</span><span class="op" id="1817013">(</span><span class="string" id="1817014">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;read&nbsp;deadline&#34;</span><span class="op" id="1817063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1817067">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817071">pd</span><span class="op" id="1817073">.</span><span class="ident" id="1817074">rd</span>&nbsp;<span class="op" id="1817077">=</span>&nbsp;<span class="op" id="1817079">-</span><span class="num" id="1817080">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817084">atomicstorep</span><span class="op" id="1817096">(</span><span class="ident" id="1817097">unsafe</span><span class="op" id="1817103">.</span><span class="ident" id="1817104">Pointer</span><span class="op" id="1817111">(</span><span class="op" id="1817112">&amp;</span><span class="ident" id="1817113">pd</span><span class="op" id="1817115">.</span><span class="ident" id="1817116">rt</span><span class="op" id="1817118">.</span><span class="ident" id="1817119">f</span><span class="op" id="1817120">)</span><span class="op" id="1817121">,</span>&nbsp;<span class="ident" id="1817123">nil</span><span class="op" id="1817126">)</span>&nbsp;<span class="comment" id="1817128">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;rd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817206">rg</span>&nbsp;<span class="op" id="1817209">=</span>&nbsp;<span class="ident" id="1817211">netpollunblock</span><span class="op" id="1817225">(</span><span class="ident" id="1817226">pd</span><span class="op" id="1817228">,</span>&nbsp;<span class="string" id="1817230">&#39;r&#39;</span><span class="op" id="1817233">,</span>&nbsp;<span class="builtintype" id="1817235">false</span><span class="op" id="1817240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1817243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1817246">var</span>&nbsp;<span class="ident" id="1817250">wg</span>&nbsp;<span class="op" id="1817253">*</span><span class="ident" id="1817254">g</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1817257">if</span>&nbsp;<span class="ident" id="1817260">write</span>&nbsp;<span class="op" id="1817266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1817270">if</span>&nbsp;<span class="ident" id="1817273">pd</span><span class="op" id="1817275">.</span><span class="ident" id="1817276">wd</span>&nbsp;<span class="op" id="1817279">&lt;=</span>&nbsp;<span class="num" id="1817282">0</span>&nbsp;<span class="op" id="1817284">||</span>&nbsp;<span class="ident" id="1817287">pd</span><span class="op" id="1817289">.</span><span class="ident" id="1817290">wt</span><span class="op" id="1817292">.</span><span class="ident" id="1817293">f</span>&nbsp;<span class="op" id="1817295">==</span>&nbsp;<span class="ident" id="1817298">nil</span>&nbsp;<span class="op" id="1817302">&amp;&amp;</span>&nbsp;<span class="op" id="1817305">!</span><span class="ident" id="1817306">read</span>&nbsp;<span class="op" id="1817311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817316">gothrow</span><span class="op" id="1817323">(</span><span class="string" id="1817324">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;write&nbsp;deadline&#34;</span><span class="op" id="1817374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1817378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817382">pd</span><span class="op" id="1817384">.</span><span class="ident" id="1817385">wd</span>&nbsp;<span class="op" id="1817388">=</span>&nbsp;<span class="op" id="1817390">-</span><span class="num" id="1817391">1</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817395">atomicstorep</span><span class="op" id="1817407">(</span><span class="ident" id="1817408">unsafe</span><span class="op" id="1817414">.</span><span class="ident" id="1817415">Pointer</span><span class="op" id="1817422">(</span><span class="op" id="1817423">&amp;</span><span class="ident" id="1817424">pd</span><span class="op" id="1817426">.</span><span class="ident" id="1817427">wt</span><span class="op" id="1817429">.</span><span class="ident" id="1817430">f</span><span class="op" id="1817431">)</span><span class="op" id="1817432">,</span>&nbsp;<span class="ident" id="1817434">nil</span><span class="op" id="1817437">)</span>&nbsp;<span class="comment" id="1817439">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;wd&nbsp;and&nbsp;load&nbsp;of&nbsp;wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817517">wg</span>&nbsp;<span class="op" id="1817520">=</span>&nbsp;<span class="ident" id="1817522">netpollunblock</span><span class="op" id="1817536">(</span><span class="ident" id="1817537">pd</span><span class="op" id="1817539">,</span>&nbsp;<span class="string" id="1817541">&#39;w&#39;</span><span class="op" id="1817544">,</span>&nbsp;<span class="builtintype" id="1817546">false</span><span class="op" id="1817551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1817554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817557">unlock</span><span class="op" id="1817563">(</span><span class="op" id="1817564">&amp;</span><span class="ident" id="1817565">pd</span><span class="op" id="1817567">.</span><span class="ident" id="1817568">lock</span><span class="op" id="1817572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1817575">if</span>&nbsp;<span class="ident" id="1817578">rg</span>&nbsp;<span class="op" id="1817581">!=</span>&nbsp;<span class="ident" id="1817584">nil</span>&nbsp;<span class="op" id="1817588">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817592">goready</span><span class="op" id="1817599">(</span><span class="ident" id="1817600">rg</span><span class="op" id="1817602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1817605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1817608">if</span>&nbsp;<span class="ident" id="1817611">wg</span>&nbsp;<span class="op" id="1817614">!=</span>&nbsp;<span class="ident" id="1817617">nil</span>&nbsp;<span class="op" id="1817621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817625">goready</span><span class="op" id="1817632">(</span><span class="ident" id="1817633">wg</span><span class="op" id="1817635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1817638">}</span><br>
<span class="lineno">420</span><span class="op" id="1817640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1817643">func</span>&nbsp;<span class="ident" id="1817648">netpollDeadline</span><span class="op" id="1817663">(</span><span class="ident" id="1817664">arg</span>&nbsp;<span class="keyword" id="1817668">interface</span><span class="op" id="1817677">{</span><span class="op" id="1817678">}</span><span class="op" id="1817679">,</span>&nbsp;<span class="ident" id="1817681">seq</span>&nbsp;<span class="builtintype" id="1817685">uintptr</span><span class="op" id="1817692">)</span>&nbsp;<span class="op" id="1817694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817697">netpolldeadlineimpl</span><span class="op" id="1817716">(</span><span class="ident" id="1817717">arg</span><span class="op" id="1817720">.</span><span class="op" id="1817721">(</span><span class="op" id="1817722">*</span><span class="ident" id="1817723">pollDesc</span><span class="op" id="1817731">)</span><span class="op" id="1817732">,</span>&nbsp;<span class="ident" id="1817734">seq</span><span class="op" id="1817737">,</span>&nbsp;<span class="builtintype" id="1817739">true</span><span class="op" id="1817743">,</span>&nbsp;<span class="builtintype" id="1817745">true</span><span class="op" id="1817749">)</span><br>
<span class="lineno"></span><span class="op" id="1817751">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="keyword" id="1817754">func</span>&nbsp;<span class="ident" id="1817759">netpollReadDeadline</span><span class="op" id="1817778">(</span><span class="ident" id="1817779">arg</span>&nbsp;<span class="keyword" id="1817783">interface</span><span class="op" id="1817792">{</span><span class="op" id="1817793">}</span><span class="op" id="1817794">,</span>&nbsp;<span class="ident" id="1817796">seq</span>&nbsp;<span class="builtintype" id="1817800">uintptr</span><span class="op" id="1817807">)</span>&nbsp;<span class="op" id="1817809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817812">netpolldeadlineimpl</span><span class="op" id="1817831">(</span><span class="ident" id="1817832">arg</span><span class="op" id="1817835">.</span><span class="op" id="1817836">(</span><span class="op" id="1817837">*</span><span class="ident" id="1817838">pollDesc</span><span class="op" id="1817846">)</span><span class="op" id="1817847">,</span>&nbsp;<span class="ident" id="1817849">seq</span><span class="op" id="1817852">,</span>&nbsp;<span class="builtintype" id="1817854">true</span><span class="op" id="1817858">,</span>&nbsp;<span class="builtintype" id="1817860">false</span><span class="op" id="1817865">)</span><br>
<span class="lineno"></span><span class="op" id="1817867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span><span class="keyword" id="1817870">func</span>&nbsp;<span class="ident" id="1817875">netpollWriteDeadline</span><span class="op" id="1817895">(</span><span class="ident" id="1817896">arg</span>&nbsp;<span class="keyword" id="1817900">interface</span><span class="op" id="1817909">{</span><span class="op" id="1817910">}</span><span class="op" id="1817911">,</span>&nbsp;<span class="ident" id="1817913">seq</span>&nbsp;<span class="builtintype" id="1817917">uintptr</span><span class="op" id="1817924">)</span>&nbsp;<span class="op" id="1817926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817929">netpolldeadlineimpl</span><span class="op" id="1817948">(</span><span class="ident" id="1817949">arg</span><span class="op" id="1817952">.</span><span class="op" id="1817953">(</span><span class="op" id="1817954">*</span><span class="ident" id="1817955">pollDesc</span><span class="op" id="1817963">)</span><span class="op" id="1817964">,</span>&nbsp;<span class="ident" id="1817966">seq</span><span class="op" id="1817969">,</span>&nbsp;<span class="builtintype" id="1817971">false</span><span class="op" id="1817976">,</span>&nbsp;<span class="builtintype" id="1817978">true</span><span class="op" id="1817982">)</span><br>
<span class="lineno"></span><span class="op" id="1817984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1817987">func</span>&nbsp;<span class="op" id="1817992">(</span><span class="ident" id="1817993">c</span>&nbsp;<span class="op" id="1817995">*</span><span class="ident" id="1817996">pollCache</span><span class="op" id="1818005">)</span>&nbsp;<span class="ident" id="1818007">alloc</span><span class="op" id="1818012">(</span><span class="op" id="1818013">)</span>&nbsp;<span class="op" id="1818015">*</span><span class="ident" id="1818016">pollDesc</span>&nbsp;<span class="op" id="1818025">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1818028">lock</span><span class="op" id="1818032">(</span><span class="op" id="1818033">&amp;</span><span class="ident" id="1818034">c</span><span class="op" id="1818035">.</span><span class="ident" id="1818036">lock</span><span class="op" id="1818040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1818043">if</span>&nbsp;<span class="ident" id="1818046">c</span><span class="op" id="1818047">.</span><span class="ident" id="1818048">first</span>&nbsp;<span class="op" id="1818054">==</span>&nbsp;<span class="ident" id="1818057">nil</span>&nbsp;<span class="op" id="1818061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1818065">const</span>&nbsp;<span class="ident" id="1818071">pdSize</span>&nbsp;<span class="op" id="1818078">=</span>&nbsp;<span class="ident" id="1818080">unsafe</span><span class="op" id="1818086">.</span><span class="ident" id="1818087">Sizeof</span><span class="op" id="1818093">(</span><span class="ident" id="1818094">pollDesc</span><span class="op" id="1818102">{</span><span class="op" id="1818103">}</span><span class="op" id="1818104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1818108">n</span>&nbsp;<span class="op" id="1818110">:=</span>&nbsp;<span class="ident" id="1818113">pollBlockSize</span>&nbsp;<span class="op" id="1818127">/</span>&nbsp;<span class="ident" id="1818129">pdSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1818138">if</span>&nbsp;<span class="ident" id="1818141">n</span>&nbsp;<span class="op" id="1818143">==</span>&nbsp;<span class="num" id="1818146">0</span>&nbsp;<span class="op" id="1818148">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1818153">n</span>&nbsp;<span class="op" id="1818155">=</span>&nbsp;<span class="num" id="1818157">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1818161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1818165">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;non-GC&nbsp;memory&nbsp;because&nbsp;can&nbsp;be&nbsp;referenced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1818221">//&nbsp;only&nbsp;from&nbsp;epoll/kqueue&nbsp;internals.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1818260">mem</span>&nbsp;<span class="op" id="1818264">:=</span>&nbsp;<span class="ident" id="1818267">persistentalloc</span><span class="op" id="1818282">(</span><span class="ident" id="1818283">n</span><span class="op" id="1818284">*</span><span class="ident" id="1818285">pdSize</span><span class="op" id="1818291">,</span>&nbsp;<span class="num" id="1818293">0</span><span class="op" id="1818294">,</span>&nbsp;<span class="op" id="1818296">&amp;</span><span class="ident" id="1818297">memstats</span><span class="op" id="1818305">.</span><span class="ident" id="1818306">other_sys</span><span class="op" id="1818315">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1818319">for</span>&nbsp;<span class="ident" id="1818323">i</span>&nbsp;<span class="op" id="1818325">:=</span>&nbsp;<span class="builtintype" id="1818328">uintptr</span><span class="op" id="1818335">(</span><span class="num" id="1818336">0</span><span class="op" id="1818337">)</span><span class="op" id="1818338">;</span>&nbsp;<span class="ident" id="1818340">i</span>&nbsp;<span class="op" id="1818342">&lt;</span>&nbsp;<span class="ident" id="1818344">n</span><span class="op" id="1818345">;</span>&nbsp;<span class="ident" id="1818347">i</span><span class="op" id="1818348">++</span>&nbsp;<span class="op" id="1818351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1818356">pd</span>&nbsp;<span class="op" id="1818359">:=</span>&nbsp;<span class="op" id="1818362">(</span><span class="op" id="1818363">*</span><span class="ident" id="1818364">pollDesc</span><span class="op" id="1818372">)</span><span class="op" id="1818373">(</span><span class="ident" id="1818374">add</span><span class="op" id="1818377">(</span><span class="ident" id="1818378">mem</span><span class="op" id="1818381">,</span>&nbsp;<span class="ident" id="1818383">i</span><span class="op" id="1818384">*</span><span class="ident" id="1818385">pdSize</span><span class="op" id="1818391">)</span><span class="op" id="1818392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1818397">pd</span><span class="op" id="1818399">.</span><span class="ident" id="1818400">link</span>&nbsp;<span class="op" id="1818405">=</span>&nbsp;<span class="ident" id="1818407">c</span><span class="op" id="1818408">.</span><span class="ident" id="1818409">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1818418">c</span><span class="op" id="1818419">.</span><span class="ident" id="1818420">first</span>&nbsp;<span class="op" id="1818426">=</span>&nbsp;<span class="ident" id="1818428">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1818433">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1818436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1818439">pd</span>&nbsp;<span class="op" id="1818442">:=</span>&nbsp;<span class="ident" id="1818445">c</span><span class="op" id="1818446">.</span><span class="ident" id="1818447">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1818454">c</span><span class="op" id="1818455">.</span><span class="ident" id="1818456">first</span>&nbsp;<span class="op" id="1818462">=</span>&nbsp;<span class="ident" id="1818464">pd</span><span class="op" id="1818466">.</span><span class="ident" id="1818467">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1818473">unlock</span><span class="op" id="1818479">(</span><span class="op" id="1818480">&amp;</span><span class="ident" id="1818481">c</span><span class="op" id="1818482">.</span><span class="ident" id="1818483">lock</span><span class="op" id="1818487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1818490">return</span>&nbsp;<span class="ident" id="1818497">pd</span><br>
<span class="lineno">455</span><span class="op" id="1818500">}</span>
</div>
</body>
</html>
