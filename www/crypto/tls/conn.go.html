<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3902133">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3902188">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3902242">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3902293">//&nbsp;TLS&nbsp;low&nbsp;level&nbsp;connection&nbsp;and&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3902339">package</span>&nbsp;<span class="ident" id="3902347">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3902352">import</span>&nbsp;<span class="op" id="3902359">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3902362">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3902371">&#34;crypto/cipher&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3902388">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3902405">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3902420">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3902430">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3902437">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3902443">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3902450">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3902458">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3902465">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3902468">//&nbsp;A&nbsp;Conn&nbsp;represents&nbsp;a&nbsp;secured&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3902511">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;net.Conn&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3902552">type</span>&nbsp;<span class="ident" id="3902557">Conn</span>&nbsp;<span class="keyword" id="3902562">struct</span>&nbsp;<span class="op" id="3902569">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3902572">//&nbsp;constant</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902585">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902594">net</span><span class="op" id="3902597">.</span><span class="ident" id="3902598">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902604">isClient</span>&nbsp;<span class="builtintype" id="3902613">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3902620">//&nbsp;constant&nbsp;after&nbsp;handshake;&nbsp;protected&nbsp;by&nbsp;handshakeMutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902678">handshakeMutex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902696">sync</span><span class="op" id="3902700">.</span><span class="ident" id="3902701">Mutex</span>&nbsp;<span class="comment" id="3902707">//&nbsp;handshakeMutex&nbsp;&lt;&nbsp;in.Mutex,&nbsp;out.Mutex,&nbsp;errMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902758">handshakeErr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3902776">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3902787">//&nbsp;error&nbsp;resulting&nbsp;from&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902822">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3902840">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3902851">//&nbsp;TLS&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902867">haveVers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3902885">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3902896">//&nbsp;version&nbsp;has&nbsp;been&nbsp;negotiated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902928">config</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3902946">*</span><span class="ident" id="3902947">Config</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3902957">//&nbsp;configuration&nbsp;passed&nbsp;to&nbsp;constructor</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3902997">handshakeComplete</span>&nbsp;<span class="builtintype" id="3903015">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903021">didResume</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3903039">bool</span>&nbsp;<span class="comment" id="3903044">//&nbsp;whether&nbsp;this&nbsp;connection&nbsp;was&nbsp;a&nbsp;session&nbsp;resumption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903097">cipherSuite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3903115">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903123">ocspResponse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3903141">[</span><span class="op" id="3903142">]</span><span class="builtintype" id="3903143">byte</span>&nbsp;<span class="comment" id="3903148">//&nbsp;stapled&nbsp;OCSP&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903174">peerCertificates</span>&nbsp;&nbsp;<span class="op" id="3903192">[</span><span class="op" id="3903193">]</span><span class="op" id="3903194">*</span><span class="ident" id="3903195">x509</span><span class="op" id="3903199">.</span><span class="ident" id="3903200">Certificate</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3903213">//&nbsp;verifiedChains&nbsp;contains&nbsp;the&nbsp;certificate&nbsp;chains&nbsp;that&nbsp;we&nbsp;built,&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3903282">//&nbsp;opposed&nbsp;to&nbsp;the&nbsp;ones&nbsp;presented&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903331">verifiedChains</span>&nbsp;<span class="op" id="3903346">[</span><span class="op" id="3903347">]</span><span class="op" id="3903348">[</span><span class="op" id="3903349">]</span><span class="op" id="3903350">*</span><span class="ident" id="3903351">x509</span><span class="op" id="3903355">.</span><span class="ident" id="3903356">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3903369">//&nbsp;serverName&nbsp;contains&nbsp;the&nbsp;server&nbsp;name&nbsp;indicated&nbsp;by&nbsp;the&nbsp;client,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903442">serverName</span>&nbsp;<span class="builtintype" id="3903453">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3903461">//&nbsp;firstFinished&nbsp;contains&nbsp;the&nbsp;first&nbsp;Finished&nbsp;hash&nbsp;sent&nbsp;during&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3903528">//&nbsp;handshake.&nbsp;This&nbsp;is&nbsp;the&nbsp;&#34;tls-unique&#34;&nbsp;channel&nbsp;binding&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903591">firstFinished</span>&nbsp;<span class="op" id="3903605">[</span><span class="num" id="3903606">12</span><span class="op" id="3903608">]</span><span class="builtintype" id="3903609">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903616">clientProtocol</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3903639">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903647">clientProtocolFallback</span>&nbsp;<span class="builtintype" id="3903670">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3903677">//&nbsp;input/output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903694">in</span><span class="op" id="3903696">,</span>&nbsp;<span class="ident" id="3903698">out</span>&nbsp;&nbsp;<span class="ident" id="3903703">halfConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3903716">//&nbsp;in.Mutex&nbsp;&lt;&nbsp;out.Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903741">rawInput</span>&nbsp;<span class="op" id="3903750">*</span><span class="ident" id="3903751">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3903763">//&nbsp;raw&nbsp;input,&nbsp;right&nbsp;off&nbsp;the&nbsp;wire</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903797">input</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3903806">*</span><span class="ident" id="3903807">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3903819">//&nbsp;application&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903859">hand</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3903868">bytes</span><span class="op" id="3903873">.</span><span class="ident" id="3903874">Buffer</span>&nbsp;<span class="comment" id="3903881">//&nbsp;handshake&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3903920">tmp</span>&nbsp;<span class="op" id="3903924">[</span><span class="num" id="3903925">16</span><span class="op" id="3903927">]</span><span class="builtintype" id="3903928">byte</span><br>
<span class="lineno"></span><span class="op" id="3903933">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="3903936">//&nbsp;Access&nbsp;to&nbsp;net.Conn&nbsp;methods.</span><br>
<span class="lineno"></span><span class="comment" id="3903967">//&nbsp;Cannot&nbsp;just&nbsp;embed&nbsp;net.Conn&nbsp;because&nbsp;that&nbsp;would</span><br>
<span class="lineno"></span><span class="comment" id="3904016">//&nbsp;export&nbsp;the&nbsp;struct&nbsp;field&nbsp;too.</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3904049">//&nbsp;LocalAddr&nbsp;returns&nbsp;the&nbsp;local&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="3904097">func</span>&nbsp;<span class="op" id="3904102">(</span><span class="ident" id="3904103">c</span>&nbsp;<span class="op" id="3904105">*</span><span class="ident" id="3904106">Conn</span><span class="op" id="3904110">)</span>&nbsp;<span class="ident" id="3904112">LocalAddr</span><span class="op" id="3904121">(</span><span class="op" id="3904122">)</span>&nbsp;<span class="ident" id="3904124">net</span><span class="op" id="3904127">.</span><span class="ident" id="3904128">Addr</span>&nbsp;<span class="op" id="3904133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3904136">return</span>&nbsp;<span class="ident" id="3904143">c</span><span class="op" id="3904144">.</span><span class="ident" id="3904145">conn</span><span class="op" id="3904149">.</span><span class="ident" id="3904150">LocalAddr</span><span class="op" id="3904159">(</span><span class="op" id="3904160">)</span><br>
<span class="lineno"></span><span class="op" id="3904162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="3904165">//&nbsp;RemoteAddr&nbsp;returns&nbsp;the&nbsp;remote&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="3904215">func</span>&nbsp;<span class="op" id="3904220">(</span><span class="ident" id="3904221">c</span>&nbsp;<span class="op" id="3904223">*</span><span class="ident" id="3904224">Conn</span><span class="op" id="3904228">)</span>&nbsp;<span class="ident" id="3904230">RemoteAddr</span><span class="op" id="3904240">(</span><span class="op" id="3904241">)</span>&nbsp;<span class="ident" id="3904243">net</span><span class="op" id="3904246">.</span><span class="ident" id="3904247">Addr</span>&nbsp;<span class="op" id="3904252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3904255">return</span>&nbsp;<span class="ident" id="3904262">c</span><span class="op" id="3904263">.</span><span class="ident" id="3904264">conn</span><span class="op" id="3904268">.</span><span class="ident" id="3904269">RemoteAddr</span><span class="op" id="3904279">(</span><span class="op" id="3904280">)</span><br>
<span class="lineno"></span><span class="op" id="3904282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="3904285">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;and&nbsp;write&nbsp;deadlines&nbsp;associated&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3904366">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;and&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="3904428">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3904535">func</span>&nbsp;<span class="op" id="3904540">(</span><span class="ident" id="3904541">c</span>&nbsp;<span class="op" id="3904543">*</span><span class="ident" id="3904544">Conn</span><span class="op" id="3904548">)</span>&nbsp;<span class="ident" id="3904550">SetDeadline</span><span class="op" id="3904561">(</span><span class="ident" id="3904562">t</span>&nbsp;<span class="ident" id="3904564">time</span><span class="op" id="3904568">.</span><span class="ident" id="3904569">Time</span><span class="op" id="3904573">)</span>&nbsp;<span class="builtintype" id="3904575">error</span>&nbsp;<span class="op" id="3904581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3904584">return</span>&nbsp;<span class="ident" id="3904591">c</span><span class="op" id="3904592">.</span><span class="ident" id="3904593">conn</span><span class="op" id="3904597">.</span><span class="ident" id="3904598">SetDeadline</span><span class="op" id="3904609">(</span><span class="ident" id="3904610">t</span><span class="op" id="3904611">)</span><br>
<span class="lineno">80</span><span class="op" id="3904613">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3904616">//&nbsp;SetReadDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3904688">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3904740">func</span>&nbsp;<span class="op" id="3904745">(</span><span class="ident" id="3904746">c</span>&nbsp;<span class="op" id="3904748">*</span><span class="ident" id="3904749">Conn</span><span class="op" id="3904753">)</span>&nbsp;<span class="ident" id="3904755">SetReadDeadline</span><span class="op" id="3904770">(</span><span class="ident" id="3904771">t</span>&nbsp;<span class="ident" id="3904773">time</span><span class="op" id="3904777">.</span><span class="ident" id="3904778">Time</span><span class="op" id="3904782">)</span>&nbsp;<span class="builtintype" id="3904784">error</span>&nbsp;<span class="op" id="3904790">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3904793">return</span>&nbsp;<span class="ident" id="3904800">c</span><span class="op" id="3904801">.</span><span class="ident" id="3904802">conn</span><span class="op" id="3904806">.</span><span class="ident" id="3904807">SetReadDeadline</span><span class="op" id="3904822">(</span><span class="ident" id="3904823">t</span><span class="op" id="3904824">)</span><br>
<span class="lineno"></span><span class="op" id="3904826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3904829">//&nbsp;SetWriteDeadline&nbsp;sets&nbsp;the&nbsp;write&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3904903">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno">90</span><span class="comment" id="3904956">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3905063">func</span>&nbsp;<span class="op" id="3905068">(</span><span class="ident" id="3905069">c</span>&nbsp;<span class="op" id="3905071">*</span><span class="ident" id="3905072">Conn</span><span class="op" id="3905076">)</span>&nbsp;<span class="ident" id="3905078">SetWriteDeadline</span><span class="op" id="3905094">(</span><span class="ident" id="3905095">t</span>&nbsp;<span class="ident" id="3905097">time</span><span class="op" id="3905101">.</span><span class="ident" id="3905102">Time</span><span class="op" id="3905106">)</span>&nbsp;<span class="builtintype" id="3905108">error</span>&nbsp;<span class="op" id="3905114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3905117">return</span>&nbsp;<span class="ident" id="3905124">c</span><span class="op" id="3905125">.</span><span class="ident" id="3905126">conn</span><span class="op" id="3905130">.</span><span class="ident" id="3905131">SetWriteDeadline</span><span class="op" id="3905147">(</span><span class="ident" id="3905148">t</span><span class="op" id="3905149">)</span><br>
<span class="lineno"></span><span class="op" id="3905151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="3905154">//&nbsp;A&nbsp;halfConn&nbsp;represents&nbsp;one&nbsp;direction&nbsp;of&nbsp;the&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><span class="comment" id="3905213">//&nbsp;connection,&nbsp;either&nbsp;sending&nbsp;or&nbsp;receiving.</span><br>
<span class="lineno"></span><span class="keyword" id="3905257">type</span>&nbsp;<span class="ident" id="3905262">halfConn</span>&nbsp;<span class="keyword" id="3905271">struct</span>&nbsp;<span class="op" id="3905278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3905281">sync</span><span class="op" id="3905285">.</span><span class="ident" id="3905286">Mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3905294">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3905302">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3905314">//&nbsp;first&nbsp;permanent&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3905340">version</span>&nbsp;<span class="builtintype" id="3905348">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3905360">//&nbsp;protocol&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3905381">cipher</span>&nbsp;&nbsp;<span class="keyword" id="3905389">interface</span><span class="op" id="3905398">{</span><span class="op" id="3905399">}</span>&nbsp;<span class="comment" id="3905401">//&nbsp;cipher&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3905422">mac</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3905430">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3905443">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3905451">[</span><span class="num" id="3905452">8</span><span class="op" id="3905453">]</span><span class="builtintype" id="3905454">byte</span>&nbsp;<span class="comment" id="3905459">//&nbsp;64-bit&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3905486">bfree</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3905494">*</span><span class="ident" id="3905495">block</span>&nbsp;&nbsp;<span class="comment" id="3905502">//&nbsp;list&nbsp;of&nbsp;free&nbsp;blocks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3905527">nextCipher</span>&nbsp;<span class="keyword" id="3905538">interface</span><span class="op" id="3905547">{</span><span class="op" id="3905548">}</span>&nbsp;<span class="comment" id="3905550">//&nbsp;next&nbsp;encryption&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3905576">nextMac</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3905587">macFunction</span>&nbsp;<span class="comment" id="3905599">//&nbsp;next&nbsp;MAC&nbsp;algorithm</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3905623">//&nbsp;used&nbsp;to&nbsp;save&nbsp;allocating&nbsp;a&nbsp;new&nbsp;buffer&nbsp;for&nbsp;each&nbsp;MAC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3905678">inDigestBuf</span><span class="op" id="3905689">,</span>&nbsp;<span class="ident" id="3905691">outDigestBuf</span>&nbsp;<span class="op" id="3905704">[</span><span class="op" id="3905705">]</span><span class="builtintype" id="3905706">byte</span><br>
<span class="lineno"></span><span class="op" id="3905711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3905714">func</span>&nbsp;<span class="op" id="3905719">(</span><span class="ident" id="3905720">hc</span>&nbsp;<span class="op" id="3905723">*</span><span class="ident" id="3905724">halfConn</span><span class="op" id="3905732">)</span>&nbsp;<span class="ident" id="3905734">setErrorLocked</span><span class="op" id="3905748">(</span><span class="ident" id="3905749">err</span>&nbsp;<span class="builtintype" id="3905753">error</span><span class="op" id="3905758">)</span>&nbsp;<span class="builtintype" id="3905760">error</span>&nbsp;<span class="op" id="3905766">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3905769">hc</span><span class="op" id="3905771">.</span><span class="ident" id="3905772">err</span>&nbsp;<span class="op" id="3905776">=</span>&nbsp;<span class="ident" id="3905778">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3905783">return</span>&nbsp;<span class="ident" id="3905790">err</span><br>
<span class="lineno"></span><span class="op" id="3905794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3905797">func</span>&nbsp;<span class="op" id="3905802">(</span><span class="ident" id="3905803">hc</span>&nbsp;<span class="op" id="3905806">*</span><span class="ident" id="3905807">halfConn</span><span class="op" id="3905815">)</span>&nbsp;<span class="builtintype" id="3905817">error</span><span class="op" id="3905822">(</span><span class="op" id="3905823">)</span>&nbsp;<span class="builtintype" id="3905825">error</span>&nbsp;<span class="op" id="3905831">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3905834">hc</span><span class="op" id="3905836">.</span><span class="ident" id="3905837">Lock</span><span class="op" id="3905841">(</span><span class="op" id="3905842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3905845">err</span>&nbsp;<span class="op" id="3905849">:=</span>&nbsp;<span class="ident" id="3905852">hc</span><span class="op" id="3905854">.</span><span class="ident" id="3905855">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3905860">hc</span><span class="op" id="3905862">.</span><span class="ident" id="3905863">Unlock</span><span class="op" id="3905869">(</span><span class="op" id="3905870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3905873">return</span>&nbsp;<span class="ident" id="3905880">err</span><br>
<span class="lineno"></span><span class="op" id="3905884">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="3905887">//&nbsp;prepareCipherSpec&nbsp;sets&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno"></span><span class="comment" id="3905943">//&nbsp;that&nbsp;a&nbsp;subsequent&nbsp;changeCipherSpec&nbsp;will&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="3905991">func</span>&nbsp;<span class="op" id="3905996">(</span><span class="ident" id="3905997">hc</span>&nbsp;<span class="op" id="3906000">*</span><span class="ident" id="3906001">halfConn</span><span class="op" id="3906009">)</span>&nbsp;<span class="ident" id="3906011">prepareCipherSpec</span><span class="op" id="3906028">(</span><span class="ident" id="3906029">version</span>&nbsp;<span class="builtintype" id="3906037">uint16</span><span class="op" id="3906043">,</span>&nbsp;<span class="ident" id="3906045">cipher</span>&nbsp;<span class="keyword" id="3906052">interface</span><span class="op" id="3906061">{</span><span class="op" id="3906062">}</span><span class="op" id="3906063">,</span>&nbsp;<span class="ident" id="3906065">mac</span>&nbsp;<span class="ident" id="3906069">macFunction</span><span class="op" id="3906080">)</span>&nbsp;<span class="op" id="3906082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906085">hc</span><span class="op" id="3906087">.</span><span class="ident" id="3906088">version</span>&nbsp;<span class="op" id="3906096">=</span>&nbsp;<span class="ident" id="3906098">version</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906107">hc</span><span class="op" id="3906109">.</span><span class="ident" id="3906110">nextCipher</span>&nbsp;<span class="op" id="3906121">=</span>&nbsp;<span class="ident" id="3906123">cipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906131">hc</span><span class="op" id="3906133">.</span><span class="ident" id="3906134">nextMac</span>&nbsp;<span class="op" id="3906142">=</span>&nbsp;<span class="ident" id="3906144">mac</span><br>
<span class="lineno"></span><span class="op" id="3906148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3906151">//&nbsp;changeCipherSpec&nbsp;changes&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno">135</span><span class="comment" id="3906209">//&nbsp;to&nbsp;the&nbsp;ones&nbsp;previously&nbsp;passed&nbsp;to&nbsp;prepareCipherSpec.</span><br>
<span class="lineno"></span><span class="keyword" id="3906264">func</span>&nbsp;<span class="op" id="3906269">(</span><span class="ident" id="3906270">hc</span>&nbsp;<span class="op" id="3906273">*</span><span class="ident" id="3906274">halfConn</span><span class="op" id="3906282">)</span>&nbsp;<span class="ident" id="3906284">changeCipherSpec</span><span class="op" id="3906300">(</span><span class="op" id="3906301">)</span>&nbsp;<span class="builtintype" id="3906303">error</span>&nbsp;<span class="op" id="3906309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906312">if</span>&nbsp;<span class="ident" id="3906315">hc</span><span class="op" id="3906317">.</span><span class="ident" id="3906318">nextCipher</span>&nbsp;<span class="op" id="3906329">==</span>&nbsp;<span class="ident" id="3906332">nil</span>&nbsp;<span class="op" id="3906336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906340">return</span>&nbsp;<span class="ident" id="3906347">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3906367">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906370">hc</span><span class="op" id="3906372">.</span><span class="ident" id="3906373">cipher</span>&nbsp;<span class="op" id="3906380">=</span>&nbsp;<span class="ident" id="3906382">hc</span><span class="op" id="3906384">.</span><span class="ident" id="3906385">nextCipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906397">hc</span><span class="op" id="3906399">.</span><span class="ident" id="3906400">mac</span>&nbsp;<span class="op" id="3906404">=</span>&nbsp;<span class="ident" id="3906406">hc</span><span class="op" id="3906408">.</span><span class="ident" id="3906409">nextMac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906418">hc</span><span class="op" id="3906420">.</span><span class="ident" id="3906421">nextCipher</span>&nbsp;<span class="op" id="3906432">=</span>&nbsp;<span class="ident" id="3906434">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906439">hc</span><span class="op" id="3906441">.</span><span class="ident" id="3906442">nextMac</span>&nbsp;<span class="op" id="3906450">=</span>&nbsp;<span class="ident" id="3906452">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906457">for</span>&nbsp;<span class="ident" id="3906461">i</span>&nbsp;<span class="op" id="3906463">:=</span>&nbsp;<span class="keyword" id="3906466">range</span>&nbsp;<span class="ident" id="3906472">hc</span><span class="op" id="3906474">.</span><span class="ident" id="3906475">seq</span>&nbsp;<span class="op" id="3906479">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906483">hc</span><span class="op" id="3906485">.</span><span class="ident" id="3906486">seq</span><span class="op" id="3906489">[</span><span class="ident" id="3906490">i</span><span class="op" id="3906491">]</span>&nbsp;<span class="op" id="3906493">=</span>&nbsp;<span class="num" id="3906495">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3906498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906501">return</span>&nbsp;<span class="ident" id="3906508">nil</span><br>
<span class="lineno"></span><span class="op" id="3906512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="3906515">//&nbsp;incSeq&nbsp;increments&nbsp;the&nbsp;sequence&nbsp;number.</span><br>
<span class="lineno"></span><span class="keyword" id="3906557">func</span>&nbsp;<span class="op" id="3906562">(</span><span class="ident" id="3906563">hc</span>&nbsp;<span class="op" id="3906566">*</span><span class="ident" id="3906567">halfConn</span><span class="op" id="3906575">)</span>&nbsp;<span class="ident" id="3906577">incSeq</span><span class="op" id="3906583">(</span><span class="op" id="3906584">)</span>&nbsp;<span class="op" id="3906586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906589">for</span>&nbsp;<span class="ident" id="3906593">i</span>&nbsp;<span class="op" id="3906595">:=</span>&nbsp;<span class="num" id="3906598">7</span><span class="op" id="3906599">;</span>&nbsp;<span class="ident" id="3906601">i</span>&nbsp;<span class="op" id="3906603">&gt;=</span>&nbsp;<span class="num" id="3906606">0</span><span class="op" id="3906607">;</span>&nbsp;<span class="ident" id="3906609">i</span><span class="op" id="3906610">--</span>&nbsp;<span class="op" id="3906613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906617">hc</span><span class="op" id="3906619">.</span><span class="ident" id="3906620">seq</span><span class="op" id="3906623">[</span><span class="ident" id="3906624">i</span><span class="op" id="3906625">]</span><span class="op" id="3906626">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906631">if</span>&nbsp;<span class="ident" id="3906634">hc</span><span class="op" id="3906636">.</span><span class="ident" id="3906637">seq</span><span class="op" id="3906640">[</span><span class="ident" id="3906641">i</span><span class="op" id="3906642">]</span>&nbsp;<span class="op" id="3906644">!=</span>&nbsp;<span class="num" id="3906647">0</span>&nbsp;<span class="op" id="3906649">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906654">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3906663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3906666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3906670">//&nbsp;Not&nbsp;allowed&nbsp;to&nbsp;let&nbsp;sequence&nbsp;number&nbsp;wrap.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3906715">//&nbsp;Instead,&nbsp;must&nbsp;renegotiate&nbsp;before&nbsp;it&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3906761">//&nbsp;Not&nbsp;likely&nbsp;enough&nbsp;to&nbsp;bother.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3906794">panic</span><span class="op" id="3906799">(</span><span class="string" id="3906800">&#34;TLS:&nbsp;sequence&nbsp;number&nbsp;wraparound&#34;</span><span class="op" id="3906833">)</span><br>
<span class="lineno"></span><span class="op" id="3906835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="3906838">//&nbsp;resetSeq&nbsp;resets&nbsp;the&nbsp;sequence&nbsp;number&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="3906886">func</span>&nbsp;<span class="op" id="3906891">(</span><span class="ident" id="3906892">hc</span>&nbsp;<span class="op" id="3906895">*</span><span class="ident" id="3906896">halfConn</span><span class="op" id="3906904">)</span>&nbsp;<span class="ident" id="3906906">resetSeq</span><span class="op" id="3906914">(</span><span class="op" id="3906915">)</span>&nbsp;<span class="op" id="3906917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3906920">for</span>&nbsp;<span class="ident" id="3906924">i</span>&nbsp;<span class="op" id="3906926">:=</span>&nbsp;<span class="keyword" id="3906929">range</span>&nbsp;<span class="ident" id="3906935">hc</span><span class="op" id="3906937">.</span><span class="ident" id="3906938">seq</span>&nbsp;<span class="op" id="3906942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3906946">hc</span><span class="op" id="3906948">.</span><span class="ident" id="3906949">seq</span><span class="op" id="3906952">[</span><span class="ident" id="3906953">i</span><span class="op" id="3906954">]</span>&nbsp;<span class="op" id="3906956">=</span>&nbsp;<span class="num" id="3906958">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3906961">}</span><br>
<span class="lineno">170</span><span class="op" id="3906963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3906966">//&nbsp;removePadding&nbsp;returns&nbsp;an&nbsp;unpadded&nbsp;slice,&nbsp;in&nbsp;constant&nbsp;time,&nbsp;which&nbsp;is&nbsp;a&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="3907046">//&nbsp;of&nbsp;the&nbsp;input.&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;byte&nbsp;which&nbsp;is&nbsp;equal&nbsp;to&nbsp;255&nbsp;if&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="3907123">//&nbsp;was&nbsp;valid&nbsp;and&nbsp;0&nbsp;otherwise.&nbsp;See&nbsp;RFC&nbsp;2246,&nbsp;section&nbsp;6.2.3.2</span><br>
<span class="lineno">175</span><span class="keyword" id="3907183">func</span>&nbsp;<span class="ident" id="3907188">removePadding</span><span class="op" id="3907201">(</span><span class="ident" id="3907202">payload</span>&nbsp;<span class="op" id="3907210">[</span><span class="op" id="3907211">]</span><span class="builtintype" id="3907212">byte</span><span class="op" id="3907216">)</span>&nbsp;<span class="op" id="3907218">(</span><span class="op" id="3907219">[</span><span class="op" id="3907220">]</span><span class="builtintype" id="3907221">byte</span><span class="op" id="3907225">,</span>&nbsp;<span class="builtintype" id="3907227">byte</span><span class="op" id="3907231">)</span>&nbsp;<span class="op" id="3907233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907236">if</span>&nbsp;<span class="builtinfunc" id="3907239">len</span><span class="op" id="3907242">(</span><span class="ident" id="3907243">payload</span><span class="op" id="3907250">)</span>&nbsp;<span class="op" id="3907252">&lt;</span>&nbsp;<span class="num" id="3907254">1</span>&nbsp;<span class="op" id="3907256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907260">return</span>&nbsp;<span class="ident" id="3907267">payload</span><span class="op" id="3907274">,</span>&nbsp;<span class="num" id="3907276">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3907279">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907283">paddingLen</span>&nbsp;<span class="op" id="3907294">:=</span>&nbsp;<span class="ident" id="3907297">payload</span><span class="op" id="3907304">[</span><span class="builtinfunc" id="3907305">len</span><span class="op" id="3907308">(</span><span class="ident" id="3907309">payload</span><span class="op" id="3907316">)</span><span class="op" id="3907317">-</span><span class="num" id="3907318">1</span><span class="op" id="3907319">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907322">t</span>&nbsp;<span class="op" id="3907324">:=</span>&nbsp;<span class="builtintype" id="3907327">uint</span><span class="op" id="3907331">(</span><span class="builtinfunc" id="3907332">len</span><span class="op" id="3907335">(</span><span class="ident" id="3907336">payload</span><span class="op" id="3907343">)</span><span class="op" id="3907344">-</span><span class="num" id="3907345">1</span><span class="op" id="3907346">)</span>&nbsp;<span class="op" id="3907348">-</span>&nbsp;<span class="builtintype" id="3907350">uint</span><span class="op" id="3907354">(</span><span class="ident" id="3907355">paddingLen</span><span class="op" id="3907365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3907368">//&nbsp;if&nbsp;len(payload)&nbsp;&gt;=&nbsp;(paddingLen&nbsp;-&nbsp;1)&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907434">good</span>&nbsp;<span class="op" id="3907439">:=</span>&nbsp;<span class="builtintype" id="3907442">byte</span><span class="op" id="3907446">(</span><span class="builtintype" id="3907447">int32</span><span class="op" id="3907452">(</span><span class="op" id="3907453">^</span><span class="ident" id="3907454">t</span><span class="op" id="3907455">)</span>&nbsp;<span class="op" id="3907457">&gt;&gt;</span>&nbsp;<span class="num" id="3907460">31</span><span class="op" id="3907462">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907466">toCheck</span>&nbsp;<span class="op" id="3907474">:=</span>&nbsp;<span class="num" id="3907477">255</span>&nbsp;<span class="comment" id="3907481">//&nbsp;the&nbsp;maximum&nbsp;possible&nbsp;padding&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3907521">//&nbsp;The&nbsp;length&nbsp;of&nbsp;the&nbsp;padded&nbsp;data&nbsp;is&nbsp;public,&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;an&nbsp;if&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907591">if</span>&nbsp;<span class="ident" id="3907594">toCheck</span><span class="op" id="3907601">+</span><span class="num" id="3907602">1</span>&nbsp;<span class="op" id="3907604">&gt;</span>&nbsp;<span class="builtinfunc" id="3907606">len</span><span class="op" id="3907609">(</span><span class="ident" id="3907610">payload</span><span class="op" id="3907617">)</span>&nbsp;<span class="op" id="3907619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907623">toCheck</span>&nbsp;<span class="op" id="3907631">=</span>&nbsp;<span class="builtinfunc" id="3907633">len</span><span class="op" id="3907636">(</span><span class="ident" id="3907637">payload</span><span class="op" id="3907644">)</span>&nbsp;<span class="op" id="3907646">-</span>&nbsp;<span class="num" id="3907648">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3907651">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3907655">for</span>&nbsp;<span class="ident" id="3907659">i</span>&nbsp;<span class="op" id="3907661">:=</span>&nbsp;<span class="num" id="3907664">0</span><span class="op" id="3907665">;</span>&nbsp;<span class="ident" id="3907667">i</span>&nbsp;<span class="op" id="3907669">&lt;</span>&nbsp;<span class="ident" id="3907671">toCheck</span><span class="op" id="3907678">;</span>&nbsp;<span class="ident" id="3907680">i</span><span class="op" id="3907681">++</span>&nbsp;<span class="op" id="3907684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907688">t</span>&nbsp;<span class="op" id="3907690">:=</span>&nbsp;<span class="builtintype" id="3907693">uint</span><span class="op" id="3907697">(</span><span class="ident" id="3907698">paddingLen</span><span class="op" id="3907708">)</span>&nbsp;<span class="op" id="3907710">-</span>&nbsp;<span class="builtintype" id="3907712">uint</span><span class="op" id="3907716">(</span><span class="ident" id="3907717">i</span><span class="op" id="3907718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3907722">//&nbsp;if&nbsp;i&nbsp;&lt;=&nbsp;paddingLen&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907772">mask</span>&nbsp;<span class="op" id="3907777">:=</span>&nbsp;<span class="builtintype" id="3907780">byte</span><span class="op" id="3907784">(</span><span class="builtintype" id="3907785">int32</span><span class="op" id="3907790">(</span><span class="op" id="3907791">^</span><span class="ident" id="3907792">t</span><span class="op" id="3907793">)</span>&nbsp;<span class="op" id="3907795">&gt;&gt;</span>&nbsp;<span class="num" id="3907798">31</span><span class="op" id="3907800">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907804">b</span>&nbsp;<span class="op" id="3907806">:=</span>&nbsp;<span class="ident" id="3907809">payload</span><span class="op" id="3907816">[</span><span class="builtinfunc" id="3907817">len</span><span class="op" id="3907820">(</span><span class="ident" id="3907821">payload</span><span class="op" id="3907828">)</span><span class="op" id="3907829">-</span><span class="num" id="3907830">1</span><span class="op" id="3907831">-</span><span class="ident" id="3907832">i</span><span class="op" id="3907833">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907837">good</span>&nbsp;<span class="op" id="3907842">&amp;^=</span>&nbsp;<span class="ident" id="3907846">mask</span><span class="op" id="3907850">&amp;</span><span class="ident" id="3907851">paddingLen</span>&nbsp;<span class="op" id="3907862">^</span>&nbsp;<span class="ident" id="3907864">mask</span><span class="op" id="3907868">&amp;</span><span class="ident" id="3907869">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3907872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3907876">//&nbsp;We&nbsp;AND&nbsp;together&nbsp;the&nbsp;bits&nbsp;of&nbsp;good&nbsp;and&nbsp;replicate&nbsp;the&nbsp;result&nbsp;across</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3907945">//&nbsp;all&nbsp;the&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907963">good</span>&nbsp;<span class="op" id="3907968">&amp;=</span>&nbsp;<span class="ident" id="3907971">good</span>&nbsp;<span class="op" id="3907976">&lt;&lt;</span>&nbsp;<span class="num" id="3907979">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3907982">good</span>&nbsp;<span class="op" id="3907987">&amp;=</span>&nbsp;<span class="ident" id="3907990">good</span>&nbsp;<span class="op" id="3907995">&lt;&lt;</span>&nbsp;<span class="num" id="3907998">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3908001">good</span>&nbsp;<span class="op" id="3908006">&amp;=</span>&nbsp;<span class="ident" id="3908009">good</span>&nbsp;<span class="op" id="3908014">&lt;&lt;</span>&nbsp;<span class="num" id="3908017">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3908020">good</span>&nbsp;<span class="op" id="3908025">=</span>&nbsp;<span class="builtintype" id="3908027">uint8</span><span class="op" id="3908032">(</span><span class="builtintype" id="3908033">int8</span><span class="op" id="3908037">(</span><span class="ident" id="3908038">good</span><span class="op" id="3908042">)</span>&nbsp;<span class="op" id="3908044">&gt;&gt;</span>&nbsp;<span class="num" id="3908047">7</span><span class="op" id="3908048">)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3908052">toRemove</span>&nbsp;<span class="op" id="3908061">:=</span>&nbsp;<span class="ident" id="3908064">good</span><span class="op" id="3908068">&amp;</span><span class="ident" id="3908069">paddingLen</span>&nbsp;<span class="op" id="3908080">+</span>&nbsp;<span class="num" id="3908082">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908085">return</span>&nbsp;<span class="ident" id="3908092">payload</span><span class="op" id="3908099">[</span><span class="op" id="3908100">:</span><span class="builtinfunc" id="3908101">len</span><span class="op" id="3908104">(</span><span class="ident" id="3908105">payload</span><span class="op" id="3908112">)</span><span class="op" id="3908113">-</span><span class="builtintype" id="3908114">int</span><span class="op" id="3908117">(</span><span class="ident" id="3908118">toRemove</span><span class="op" id="3908126">)</span><span class="op" id="3908127">]</span><span class="op" id="3908128">,</span>&nbsp;<span class="ident" id="3908130">good</span><br>
<span class="lineno"></span><span class="op" id="3908135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="comment" id="3908138">//&nbsp;removePaddingSSL30&nbsp;is&nbsp;a&nbsp;replacement&nbsp;for&nbsp;removePadding&nbsp;in&nbsp;the&nbsp;case&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3908216">//&nbsp;protocol&nbsp;version&nbsp;is&nbsp;SSLv3.&nbsp;In&nbsp;this&nbsp;version,&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="3908291">//&nbsp;are&nbsp;random&nbsp;and&nbsp;cannot&nbsp;be&nbsp;checked.</span><br>
<span class="lineno"></span><span class="keyword" id="3908328">func</span>&nbsp;<span class="ident" id="3908333">removePaddingSSL30</span><span class="op" id="3908351">(</span><span class="ident" id="3908352">payload</span>&nbsp;<span class="op" id="3908360">[</span><span class="op" id="3908361">]</span><span class="builtintype" id="3908362">byte</span><span class="op" id="3908366">)</span>&nbsp;<span class="op" id="3908368">(</span><span class="op" id="3908369">[</span><span class="op" id="3908370">]</span><span class="builtintype" id="3908371">byte</span><span class="op" id="3908375">,</span>&nbsp;<span class="builtintype" id="3908377">byte</span><span class="op" id="3908381">)</span>&nbsp;<span class="op" id="3908383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908386">if</span>&nbsp;<span class="builtinfunc" id="3908389">len</span><span class="op" id="3908392">(</span><span class="ident" id="3908393">payload</span><span class="op" id="3908400">)</span>&nbsp;<span class="op" id="3908402">&lt;</span>&nbsp;<span class="num" id="3908404">1</span>&nbsp;<span class="op" id="3908406">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908410">return</span>&nbsp;<span class="ident" id="3908417">payload</span><span class="op" id="3908424">,</span>&nbsp;<span class="num" id="3908426">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3908429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3908433">paddingLen</span>&nbsp;<span class="op" id="3908444">:=</span>&nbsp;<span class="builtintype" id="3908447">int</span><span class="op" id="3908450">(</span><span class="ident" id="3908451">payload</span><span class="op" id="3908458">[</span><span class="builtinfunc" id="3908459">len</span><span class="op" id="3908462">(</span><span class="ident" id="3908463">payload</span><span class="op" id="3908470">)</span><span class="op" id="3908471">-</span><span class="num" id="3908472">1</span><span class="op" id="3908473">]</span><span class="op" id="3908474">)</span>&nbsp;<span class="op" id="3908476">+</span>&nbsp;<span class="num" id="3908478">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908481">if</span>&nbsp;<span class="ident" id="3908484">paddingLen</span>&nbsp;<span class="op" id="3908495">&gt;</span>&nbsp;<span class="builtinfunc" id="3908497">len</span><span class="op" id="3908500">(</span><span class="ident" id="3908501">payload</span><span class="op" id="3908508">)</span>&nbsp;<span class="op" id="3908510">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908514">return</span>&nbsp;<span class="ident" id="3908521">payload</span><span class="op" id="3908528">,</span>&nbsp;<span class="num" id="3908530">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3908533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908537">return</span>&nbsp;<span class="ident" id="3908544">payload</span><span class="op" id="3908551">[</span><span class="op" id="3908552">:</span><span class="builtinfunc" id="3908553">len</span><span class="op" id="3908556">(</span><span class="ident" id="3908557">payload</span><span class="op" id="3908564">)</span><span class="op" id="3908565">-</span><span class="ident" id="3908566">paddingLen</span><span class="op" id="3908576">]</span><span class="op" id="3908577">,</span>&nbsp;<span class="num" id="3908579">255</span><br>
<span class="lineno"></span><span class="op" id="3908583">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="3908586">func</span>&nbsp;<span class="ident" id="3908591">roundUp</span><span class="op" id="3908598">(</span><span class="ident" id="3908599">a</span><span class="op" id="3908600">,</span>&nbsp;<span class="ident" id="3908602">b</span>&nbsp;<span class="builtintype" id="3908604">int</span><span class="op" id="3908607">)</span>&nbsp;<span class="builtintype" id="3908609">int</span>&nbsp;<span class="op" id="3908613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3908616">return</span>&nbsp;<span class="ident" id="3908623">a</span>&nbsp;<span class="op" id="3908625">+</span>&nbsp;<span class="op" id="3908627">(</span><span class="ident" id="3908628">b</span><span class="op" id="3908629">-</span><span class="ident" id="3908630">a</span><span class="op" id="3908631">%</span><span class="ident" id="3908632">b</span><span class="op" id="3908633">)</span><span class="op" id="3908634">%</span><span class="ident" id="3908635">b</span><br>
<span class="lineno"></span><span class="op" id="3908637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="comment" id="3908640">//&nbsp;cbcMode&nbsp;is&nbsp;an&nbsp;interface&nbsp;for&nbsp;block&nbsp;ciphers&nbsp;using&nbsp;cipher&nbsp;block&nbsp;chaining.</span><br>
<span class="lineno"></span><span class="keyword" id="3908714">type</span>&nbsp;<span class="ident" id="3908719">cbcMode</span>&nbsp;<span class="keyword" id="3908727">interface</span>&nbsp;<span class="op" id="3908737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3908740">cipher</span><span class="op" id="3908746">.</span><span class="ident" id="3908747">BlockMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3908758">SetIV</span><span class="op" id="3908763">(</span><span class="op" id="3908764">[</span><span class="op" id="3908765">]</span><span class="builtintype" id="3908766">byte</span><span class="op" id="3908770">)</span><br>
<span class="lineno"></span><span class="op" id="3908772">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="3908775">//&nbsp;decrypt&nbsp;checks&nbsp;and&nbsp;strips&nbsp;the&nbsp;mac&nbsp;and&nbsp;decrypts&nbsp;the&nbsp;data&nbsp;in&nbsp;b.&nbsp;Returns&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3908850">//&nbsp;success&nbsp;boolean,&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;skip&nbsp;from&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;record&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3908930">//&nbsp;order&nbsp;to&nbsp;get&nbsp;the&nbsp;application&nbsp;payload,&nbsp;and&nbsp;an&nbsp;optional&nbsp;alert&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="3909000">func</span>&nbsp;<span class="op" id="3909005">(</span><span class="ident" id="3909006">hc</span>&nbsp;<span class="op" id="3909009">*</span><span class="ident" id="3909010">halfConn</span><span class="op" id="3909018">)</span>&nbsp;<span class="ident" id="3909020">decrypt</span><span class="op" id="3909027">(</span><span class="ident" id="3909028">b</span>&nbsp;<span class="op" id="3909030">*</span><span class="ident" id="3909031">block</span><span class="op" id="3909036">)</span>&nbsp;<span class="op" id="3909038">(</span><span class="ident" id="3909039">ok</span>&nbsp;<span class="builtintype" id="3909042">bool</span><span class="op" id="3909046">,</span>&nbsp;<span class="ident" id="3909048">prefixLen</span>&nbsp;<span class="builtintype" id="3909058">int</span><span class="op" id="3909061">,</span>&nbsp;<span class="ident" id="3909063">alertValue</span>&nbsp;<span class="ident" id="3909074">alert</span><span class="op" id="3909079">)</span>&nbsp;<span class="op" id="3909081">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3909084">//&nbsp;pull&nbsp;out&nbsp;payload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909105">payload</span>&nbsp;<span class="op" id="3909113">:=</span>&nbsp;<span class="ident" id="3909116">b</span><span class="op" id="3909117">.</span><span class="ident" id="3909118">data</span><span class="op" id="3909122">[</span><span class="ident" id="3909123">recordHeaderLen</span><span class="op" id="3909138">:</span><span class="op" id="3909139">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909143">macSize</span>&nbsp;<span class="op" id="3909151">:=</span>&nbsp;<span class="num" id="3909154">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909157">if</span>&nbsp;<span class="ident" id="3909160">hc</span><span class="op" id="3909162">.</span><span class="ident" id="3909163">mac</span>&nbsp;<span class="op" id="3909167">!=</span>&nbsp;<span class="ident" id="3909170">nil</span>&nbsp;<span class="op" id="3909174">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909178">macSize</span>&nbsp;<span class="op" id="3909186">=</span>&nbsp;<span class="ident" id="3909188">hc</span><span class="op" id="3909190">.</span><span class="ident" id="3909191">mac</span><span class="op" id="3909194">.</span><span class="ident" id="3909195">Size</span><span class="op" id="3909199">(</span><span class="op" id="3909200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909207">paddingGood</span>&nbsp;<span class="op" id="3909219">:=</span>&nbsp;<span class="builtintype" id="3909222">byte</span><span class="op" id="3909226">(</span><span class="num" id="3909227">255</span><span class="op" id="3909230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909233">explicitIVLen</span>&nbsp;<span class="op" id="3909247">:=</span>&nbsp;<span class="num" id="3909250">0</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3909254">//&nbsp;decrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909266">if</span>&nbsp;<span class="ident" id="3909269">hc</span><span class="op" id="3909271">.</span><span class="ident" id="3909272">cipher</span>&nbsp;<span class="op" id="3909279">!=</span>&nbsp;<span class="ident" id="3909282">nil</span>&nbsp;<span class="op" id="3909286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909290">switch</span>&nbsp;<span class="ident" id="3909297">c</span>&nbsp;<span class="op" id="3909299">:=</span>&nbsp;<span class="ident" id="3909302">hc</span><span class="op" id="3909304">.</span><span class="ident" id="3909305">cipher</span><span class="op" id="3909311">.</span><span class="op" id="3909312">(</span><span class="keyword" id="3909313">type</span><span class="op" id="3909317">)</span>&nbsp;<span class="op" id="3909319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909323">case</span>&nbsp;<span class="ident" id="3909328">cipher</span><span class="op" id="3909334">.</span><span class="ident" id="3909335">Stream</span><span class="op" id="3909341">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909346">c</span><span class="op" id="3909347">.</span><span class="ident" id="3909348">XORKeyStream</span><span class="op" id="3909360">(</span><span class="ident" id="3909361">payload</span><span class="op" id="3909368">,</span>&nbsp;<span class="ident" id="3909370">payload</span><span class="op" id="3909377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909381">case</span>&nbsp;<span class="ident" id="3909386">cipher</span><span class="op" id="3909392">.</span><span class="ident" id="3909393">AEAD</span><span class="op" id="3909397">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909402">explicitIVLen</span>&nbsp;<span class="op" id="3909416">=</span>&nbsp;<span class="num" id="3909418">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909423">if</span>&nbsp;<span class="builtinfunc" id="3909426">len</span><span class="op" id="3909429">(</span><span class="ident" id="3909430">payload</span><span class="op" id="3909437">)</span>&nbsp;<span class="op" id="3909439">&lt;</span>&nbsp;<span class="ident" id="3909441">explicitIVLen</span>&nbsp;<span class="op" id="3909455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909461">return</span>&nbsp;<span class="ident" id="3909468">false</span><span class="op" id="3909473">,</span>&nbsp;<span class="num" id="3909475">0</span><span class="op" id="3909476">,</span>&nbsp;<span class="ident" id="3909478">alertBadRecordMAC</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909504">nonce</span>&nbsp;<span class="op" id="3909510">:=</span>&nbsp;<span class="ident" id="3909513">payload</span><span class="op" id="3909520">[</span><span class="op" id="3909521">:</span><span class="num" id="3909522">8</span><span class="op" id="3909523">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909528">payload</span>&nbsp;<span class="op" id="3909536">=</span>&nbsp;<span class="ident" id="3909538">payload</span><span class="op" id="3909545">[</span><span class="num" id="3909546">8</span><span class="op" id="3909547">:</span><span class="op" id="3909548">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909554">var</span>&nbsp;<span class="ident" id="3909558">additionalData</span>&nbsp;<span class="op" id="3909573">[</span><span class="num" id="3909574">13</span><span class="op" id="3909576">]</span><span class="builtintype" id="3909577">byte</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3909585">copy</span><span class="op" id="3909589">(</span><span class="ident" id="3909590">additionalData</span><span class="op" id="3909604">[</span><span class="op" id="3909605">:</span><span class="op" id="3909606">]</span><span class="op" id="3909607">,</span>&nbsp;<span class="ident" id="3909609">hc</span><span class="op" id="3909611">.</span><span class="ident" id="3909612">seq</span><span class="op" id="3909615">[</span><span class="op" id="3909616">:</span><span class="op" id="3909617">]</span><span class="op" id="3909618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3909623">copy</span><span class="op" id="3909627">(</span><span class="ident" id="3909628">additionalData</span><span class="op" id="3909642">[</span><span class="num" id="3909643">8</span><span class="op" id="3909644">:</span><span class="op" id="3909645">]</span><span class="op" id="3909646">,</span>&nbsp;<span class="ident" id="3909648">b</span><span class="op" id="3909649">.</span><span class="ident" id="3909650">data</span><span class="op" id="3909654">[</span><span class="op" id="3909655">:</span><span class="num" id="3909656">3</span><span class="op" id="3909657">]</span><span class="op" id="3909658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909663">n</span>&nbsp;<span class="op" id="3909665">:=</span>&nbsp;<span class="builtinfunc" id="3909668">len</span><span class="op" id="3909671">(</span><span class="ident" id="3909672">payload</span><span class="op" id="3909679">)</span>&nbsp;<span class="op" id="3909681">-</span>&nbsp;<span class="ident" id="3909683">c</span><span class="op" id="3909684">.</span><span class="ident" id="3909685">Overhead</span><span class="op" id="3909693">(</span><span class="op" id="3909694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909699">additionalData</span><span class="op" id="3909713">[</span><span class="num" id="3909714">11</span><span class="op" id="3909716">]</span>&nbsp;<span class="op" id="3909718">=</span>&nbsp;<span class="builtintype" id="3909720">byte</span><span class="op" id="3909724">(</span><span class="ident" id="3909725">n</span>&nbsp;<span class="op" id="3909727">&gt;&gt;</span>&nbsp;<span class="num" id="3909730">8</span><span class="op" id="3909731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909736">additionalData</span><span class="op" id="3909750">[</span><span class="num" id="3909751">12</span><span class="op" id="3909753">]</span>&nbsp;<span class="op" id="3909755">=</span>&nbsp;<span class="builtintype" id="3909757">byte</span><span class="op" id="3909761">(</span><span class="ident" id="3909762">n</span><span class="op" id="3909763">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909768">var</span>&nbsp;<span class="ident" id="3909772">err</span>&nbsp;<span class="builtintype" id="3909776">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909785">payload</span><span class="op" id="3909792">,</span>&nbsp;<span class="ident" id="3909794">err</span>&nbsp;<span class="op" id="3909798">=</span>&nbsp;<span class="ident" id="3909800">c</span><span class="op" id="3909801">.</span><span class="ident" id="3909802">Open</span><span class="op" id="3909806">(</span><span class="ident" id="3909807">payload</span><span class="op" id="3909814">[</span><span class="op" id="3909815">:</span><span class="num" id="3909816">0</span><span class="op" id="3909817">]</span><span class="op" id="3909818">,</span>&nbsp;<span class="ident" id="3909820">nonce</span><span class="op" id="3909825">,</span>&nbsp;<span class="ident" id="3909827">payload</span><span class="op" id="3909834">,</span>&nbsp;<span class="ident" id="3909836">additionalData</span><span class="op" id="3909850">[</span><span class="op" id="3909851">:</span><span class="op" id="3909852">]</span><span class="op" id="3909853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909858">if</span>&nbsp;<span class="ident" id="3909861">err</span>&nbsp;<span class="op" id="3909865">!=</span>&nbsp;<span class="ident" id="3909868">nil</span>&nbsp;<span class="op" id="3909872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909878">return</span>&nbsp;<span class="ident" id="3909885">false</span><span class="op" id="3909890">,</span>&nbsp;<span class="num" id="3909892">0</span><span class="op" id="3909893">,</span>&nbsp;<span class="ident" id="3909895">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3909916">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909921">b</span><span class="op" id="3909922">.</span><span class="ident" id="3909923">resize</span><span class="op" id="3909929">(</span><span class="ident" id="3909930">recordHeaderLen</span>&nbsp;<span class="op" id="3909946">+</span>&nbsp;<span class="ident" id="3909948">explicitIVLen</span>&nbsp;<span class="op" id="3909962">+</span>&nbsp;<span class="builtinfunc" id="3909964">len</span><span class="op" id="3909967">(</span><span class="ident" id="3909968">payload</span><span class="op" id="3909975">)</span><span class="op" id="3909976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3909980">case</span>&nbsp;<span class="ident" id="3909985">cbcMode</span><span class="op" id="3909992">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3909997">blockSize</span>&nbsp;<span class="op" id="3910007">:=</span>&nbsp;<span class="ident" id="3910010">c</span><span class="op" id="3910011">.</span><span class="ident" id="3910012">BlockSize</span><span class="op" id="3910021">(</span><span class="op" id="3910022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910027">if</span>&nbsp;<span class="ident" id="3910030">hc</span><span class="op" id="3910032">.</span><span class="ident" id="3910033">version</span>&nbsp;<span class="op" id="3910041">&gt;=</span>&nbsp;<span class="ident" id="3910044">VersionTLS11</span>&nbsp;<span class="op" id="3910057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910063">explicitIVLen</span>&nbsp;<span class="op" id="3910077">=</span>&nbsp;<span class="ident" id="3910079">blockSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910098">if</span>&nbsp;<span class="builtinfunc" id="3910101">len</span><span class="op" id="3910104">(</span><span class="ident" id="3910105">payload</span><span class="op" id="3910112">)</span><span class="op" id="3910113">%</span><span class="ident" id="3910114">blockSize</span>&nbsp;<span class="op" id="3910124">!=</span>&nbsp;<span class="num" id="3910127">0</span>&nbsp;<span class="op" id="3910129">||</span>&nbsp;<span class="builtinfunc" id="3910132">len</span><span class="op" id="3910135">(</span><span class="ident" id="3910136">payload</span><span class="op" id="3910143">)</span>&nbsp;<span class="op" id="3910145">&lt;</span>&nbsp;<span class="ident" id="3910147">roundUp</span><span class="op" id="3910154">(</span><span class="ident" id="3910155">explicitIVLen</span><span class="op" id="3910168">+</span><span class="ident" id="3910169">macSize</span><span class="op" id="3910176">+</span><span class="num" id="3910177">1</span><span class="op" id="3910178">,</span>&nbsp;<span class="ident" id="3910180">blockSize</span><span class="op" id="3910189">)</span>&nbsp;<span class="op" id="3910191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910197">return</span>&nbsp;<span class="ident" id="3910204">false</span><span class="op" id="3910209">,</span>&nbsp;<span class="num" id="3910211">0</span><span class="op" id="3910212">,</span>&nbsp;<span class="ident" id="3910214">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910235">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910241">if</span>&nbsp;<span class="ident" id="3910244">explicitIVLen</span>&nbsp;<span class="op" id="3910258">&gt;</span>&nbsp;<span class="num" id="3910260">0</span>&nbsp;<span class="op" id="3910262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910268">c</span><span class="op" id="3910269">.</span><span class="ident" id="3910270">SetIV</span><span class="op" id="3910275">(</span><span class="ident" id="3910276">payload</span><span class="op" id="3910283">[</span><span class="op" id="3910284">:</span><span class="ident" id="3910285">explicitIVLen</span><span class="op" id="3910298">]</span><span class="op" id="3910299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910305">payload</span>&nbsp;<span class="op" id="3910313">=</span>&nbsp;<span class="ident" id="3910315">payload</span><span class="op" id="3910322">[</span><span class="ident" id="3910323">explicitIVLen</span><span class="op" id="3910336">:</span><span class="op" id="3910337">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910342">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910347">c</span><span class="op" id="3910348">.</span><span class="ident" id="3910349">CryptBlocks</span><span class="op" id="3910360">(</span><span class="ident" id="3910361">payload</span><span class="op" id="3910368">,</span>&nbsp;<span class="ident" id="3910370">payload</span><span class="op" id="3910377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3910382">if</span>&nbsp;<span class="ident" id="3910385">hc</span><span class="op" id="3910387">.</span><span class="ident" id="3910388">version</span>&nbsp;<span class="op" id="3910396">==</span>&nbsp;<span class="ident" id="3910399">VersionSSL30</span>&nbsp;<span class="op" id="3910412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910418">payload</span><span class="op" id="3910425">,</span>&nbsp;<span class="ident" id="3910427">paddingGood</span>&nbsp;<span class="op" id="3910439">=</span>&nbsp;<span class="ident" id="3910441">removePaddingSSL30</span><span class="op" id="3910459">(</span><span class="ident" id="3910460">payload</span><span class="op" id="3910467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910472">}</span>&nbsp;<span class="keyword" id="3910474">else</span>&nbsp;<span class="op" id="3910479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910485">payload</span><span class="op" id="3910492">,</span>&nbsp;<span class="ident" id="3910494">paddingGood</span>&nbsp;<span class="op" id="3910506">=</span>&nbsp;<span class="ident" id="3910508">removePadding</span><span class="op" id="3910521">(</span><span class="ident" id="3910522">payload</span><span class="op" id="3910529">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3910534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3910539">b</span><span class="op" id="3910540">.</span><span class="ident" id="3910541">resize</span><span class="op" id="3910547">(</span><span class="ident" id="3910548">recordHeaderLen</span>&nbsp;<span class="op" id="3910564">+</span>&nbsp;<span class="ident" id="3910566">explicitIVLen</span>&nbsp;<span class="op" id="3910580">+</span>&nbsp;<span class="builtinfunc" id="3910582">len</span><span class="op" id="3910585">(</span><span class="ident" id="3910586">payload</span><span class="op" id="3910593">)</span><span class="op" id="3910594">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3910600">//&nbsp;note&nbsp;that&nbsp;we&nbsp;still&nbsp;have&nbsp;a&nbsp;timing&nbsp;side-channel&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3910659">//&nbsp;MAC&nbsp;check,&nbsp;below.&nbsp;An&nbsp;attacker&nbsp;can&nbsp;align&nbsp;the&nbsp;record</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3910716">//&nbsp;so&nbsp;that&nbsp;a&nbsp;correct&nbsp;padding&nbsp;will&nbsp;cause&nbsp;one&nbsp;less&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3910773">//&nbsp;block&nbsp;to&nbsp;be&nbsp;calculated.&nbsp;Then&nbsp;they&nbsp;can&nbsp;iteratively</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3910829">//&nbsp;decrypt&nbsp;a&nbsp;record&nbsp;by&nbsp;breaking&nbsp;each&nbsp;byte.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3910879">//&nbsp;&#34;Password&nbsp;Interception&nbsp;in&nbsp;a&nbsp;SSL/TLS&nbsp;Channel&#34;,&nbsp;Brice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3910937">//&nbsp;Canvel&nbsp;et&nbsp;al.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3910957">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3910963">//&nbsp;However,&nbsp;our&nbsp;behavior&nbsp;matches&nbsp;OpenSSL,&nbsp;so&nbsp;we&nbsp;leak</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3911019">//&nbsp;only&nbsp;as&nbsp;much&nbsp;as&nbsp;they&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911049">default</span><span class="op" id="3911056">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3911061">panic</span><span class="op" id="3911066">(</span><span class="string" id="3911067">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="3911088">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3911092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3911095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3911099">//&nbsp;check,&nbsp;strip&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911120">if</span>&nbsp;<span class="ident" id="3911123">hc</span><span class="op" id="3911125">.</span><span class="ident" id="3911126">mac</span>&nbsp;<span class="op" id="3911130">!=</span>&nbsp;<span class="ident" id="3911133">nil</span>&nbsp;<span class="op" id="3911137">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911141">if</span>&nbsp;<span class="builtinfunc" id="3911144">len</span><span class="op" id="3911147">(</span><span class="ident" id="3911148">payload</span><span class="op" id="3911155">)</span>&nbsp;<span class="op" id="3911157">&lt;</span>&nbsp;<span class="ident" id="3911159">macSize</span>&nbsp;<span class="op" id="3911167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911172">return</span>&nbsp;<span class="ident" id="3911179">false</span><span class="op" id="3911184">,</span>&nbsp;<span class="num" id="3911186">0</span><span class="op" id="3911187">,</span>&nbsp;<span class="ident" id="3911189">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3911209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3911214">//&nbsp;strip&nbsp;mac&nbsp;off&nbsp;payload,&nbsp;b.data</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3911249">n</span>&nbsp;<span class="op" id="3911251">:=</span>&nbsp;<span class="builtinfunc" id="3911254">len</span><span class="op" id="3911257">(</span><span class="ident" id="3911258">payload</span><span class="op" id="3911265">)</span>&nbsp;<span class="op" id="3911267">-</span>&nbsp;<span class="ident" id="3911269">macSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3911279">b</span><span class="op" id="3911280">.</span><span class="ident" id="3911281">data</span><span class="op" id="3911285">[</span><span class="num" id="3911286">3</span><span class="op" id="3911287">]</span>&nbsp;<span class="op" id="3911289">=</span>&nbsp;<span class="builtintype" id="3911291">byte</span><span class="op" id="3911295">(</span><span class="ident" id="3911296">n</span>&nbsp;<span class="op" id="3911298">&gt;&gt;</span>&nbsp;<span class="num" id="3911301">8</span><span class="op" id="3911302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3911306">b</span><span class="op" id="3911307">.</span><span class="ident" id="3911308">data</span><span class="op" id="3911312">[</span><span class="num" id="3911313">4</span><span class="op" id="3911314">]</span>&nbsp;<span class="op" id="3911316">=</span>&nbsp;<span class="builtintype" id="3911318">byte</span><span class="op" id="3911322">(</span><span class="ident" id="3911323">n</span><span class="op" id="3911324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3911328">b</span><span class="op" id="3911329">.</span><span class="ident" id="3911330">resize</span><span class="op" id="3911336">(</span><span class="ident" id="3911337">recordHeaderLen</span>&nbsp;<span class="op" id="3911353">+</span>&nbsp;<span class="ident" id="3911355">explicitIVLen</span>&nbsp;<span class="op" id="3911369">+</span>&nbsp;<span class="ident" id="3911371">n</span><span class="op" id="3911372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3911376">remoteMAC</span>&nbsp;<span class="op" id="3911386">:=</span>&nbsp;<span class="ident" id="3911389">payload</span><span class="op" id="3911396">[</span><span class="ident" id="3911397">n</span><span class="op" id="3911398">:</span><span class="op" id="3911399">]</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3911403">localMAC</span>&nbsp;<span class="op" id="3911412">:=</span>&nbsp;<span class="ident" id="3911415">hc</span><span class="op" id="3911417">.</span><span class="ident" id="3911418">mac</span><span class="op" id="3911421">.</span><span class="ident" id="3911422">MAC</span><span class="op" id="3911425">(</span><span class="ident" id="3911426">hc</span><span class="op" id="3911428">.</span><span class="ident" id="3911429">inDigestBuf</span><span class="op" id="3911440">,</span>&nbsp;<span class="ident" id="3911442">hc</span><span class="op" id="3911444">.</span><span class="ident" id="3911445">seq</span><span class="op" id="3911448">[</span><span class="num" id="3911449">0</span><span class="op" id="3911450">:</span><span class="op" id="3911451">]</span><span class="op" id="3911452">,</span>&nbsp;<span class="ident" id="3911454">b</span><span class="op" id="3911455">.</span><span class="ident" id="3911456">data</span><span class="op" id="3911460">[</span><span class="op" id="3911461">:</span><span class="ident" id="3911462">recordHeaderLen</span><span class="op" id="3911477">]</span><span class="op" id="3911478">,</span>&nbsp;<span class="ident" id="3911480">payload</span><span class="op" id="3911487">[</span><span class="op" id="3911488">:</span><span class="ident" id="3911489">n</span><span class="op" id="3911490">]</span><span class="op" id="3911491">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911496">if</span>&nbsp;<span class="ident" id="3911499">subtle</span><span class="op" id="3911505">.</span><span class="ident" id="3911506">ConstantTimeCompare</span><span class="op" id="3911525">(</span><span class="ident" id="3911526">localMAC</span><span class="op" id="3911534">,</span>&nbsp;<span class="ident" id="3911536">remoteMAC</span><span class="op" id="3911545">)</span>&nbsp;<span class="op" id="3911547">!=</span>&nbsp;<span class="num" id="3911550">1</span>&nbsp;<span class="op" id="3911552">||</span>&nbsp;<span class="ident" id="3911555">paddingGood</span>&nbsp;<span class="op" id="3911567">!=</span>&nbsp;<span class="num" id="3911570">255</span>&nbsp;<span class="op" id="3911574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911579">return</span>&nbsp;<span class="ident" id="3911586">false</span><span class="op" id="3911591">,</span>&nbsp;<span class="num" id="3911593">0</span><span class="op" id="3911594">,</span>&nbsp;<span class="ident" id="3911596">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3911616">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3911620">hc</span><span class="op" id="3911622">.</span><span class="ident" id="3911623">inDigestBuf</span>&nbsp;<span class="op" id="3911635">=</span>&nbsp;<span class="ident" id="3911637">localMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3911647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3911650">hc</span><span class="op" id="3911652">.</span><span class="ident" id="3911653">incSeq</span><span class="op" id="3911659">(</span><span class="op" id="3911660">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3911664">return</span>&nbsp;<span class="ident" id="3911671">true</span><span class="op" id="3911675">,</span>&nbsp;<span class="ident" id="3911677">recordHeaderLen</span>&nbsp;<span class="op" id="3911693">+</span>&nbsp;<span class="ident" id="3911695">explicitIVLen</span><span class="op" id="3911708">,</span>&nbsp;<span class="num" id="3911710">0</span><br>
<span class="lineno">335</span><span class="op" id="3911712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3911715">//&nbsp;padToBlockSize&nbsp;calculates&nbsp;the&nbsp;needed&nbsp;padding&nbsp;block,&nbsp;if&nbsp;any,&nbsp;for&nbsp;a&nbsp;payload.</span><br>
<span class="lineno"></span><span class="comment" id="3911793">//&nbsp;On&nbsp;exit,&nbsp;prefix&nbsp;aliases&nbsp;payload&nbsp;and&nbsp;extends&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;last&nbsp;full</span><br>
<span class="lineno"></span><span class="comment" id="3911868">//&nbsp;block&nbsp;of&nbsp;payload.&nbsp;finalBlock&nbsp;is&nbsp;a&nbsp;fresh&nbsp;slice&nbsp;which&nbsp;contains&nbsp;the&nbsp;contents&nbsp;of</span><br>
<span class="lineno">340</span><span class="comment" id="3911948">//&nbsp;any&nbsp;suffix&nbsp;of&nbsp;payload&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;needed&nbsp;padding&nbsp;to&nbsp;make&nbsp;finalBlock&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3912024">//&nbsp;full&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="3912039">func</span>&nbsp;<span class="ident" id="3912044">padToBlockSize</span><span class="op" id="3912058">(</span><span class="ident" id="3912059">payload</span>&nbsp;<span class="op" id="3912067">[</span><span class="op" id="3912068">]</span><span class="builtintype" id="3912069">byte</span><span class="op" id="3912073">,</span>&nbsp;<span class="ident" id="3912075">blockSize</span>&nbsp;<span class="builtintype" id="3912085">int</span><span class="op" id="3912088">)</span>&nbsp;<span class="op" id="3912090">(</span><span class="ident" id="3912091">prefix</span><span class="op" id="3912097">,</span>&nbsp;<span class="ident" id="3912099">finalBlock</span>&nbsp;<span class="op" id="3912110">[</span><span class="op" id="3912111">]</span><span class="builtintype" id="3912112">byte</span><span class="op" id="3912116">)</span>&nbsp;<span class="op" id="3912118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912121">overrun</span>&nbsp;<span class="op" id="3912129">:=</span>&nbsp;<span class="builtinfunc" id="3912132">len</span><span class="op" id="3912135">(</span><span class="ident" id="3912136">payload</span><span class="op" id="3912143">)</span>&nbsp;<span class="op" id="3912145">%</span>&nbsp;<span class="ident" id="3912147">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912158">paddingLen</span>&nbsp;<span class="op" id="3912169">:=</span>&nbsp;<span class="ident" id="3912172">blockSize</span>&nbsp;<span class="op" id="3912182">-</span>&nbsp;<span class="ident" id="3912184">overrun</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912193">prefix</span>&nbsp;<span class="op" id="3912200">=</span>&nbsp;<span class="ident" id="3912202">payload</span><span class="op" id="3912209">[</span><span class="op" id="3912210">:</span><span class="builtinfunc" id="3912211">len</span><span class="op" id="3912214">(</span><span class="ident" id="3912215">payload</span><span class="op" id="3912222">)</span><span class="op" id="3912223">-</span><span class="ident" id="3912224">overrun</span><span class="op" id="3912231">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912234">finalBlock</span>&nbsp;<span class="op" id="3912245">=</span>&nbsp;<span class="builtinfunc" id="3912247">make</span><span class="op" id="3912251">(</span><span class="op" id="3912252">[</span><span class="op" id="3912253">]</span><span class="builtintype" id="3912254">byte</span><span class="op" id="3912258">,</span>&nbsp;<span class="ident" id="3912260">blockSize</span><span class="op" id="3912269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3912272">copy</span><span class="op" id="3912276">(</span><span class="ident" id="3912277">finalBlock</span><span class="op" id="3912287">,</span>&nbsp;<span class="ident" id="3912289">payload</span><span class="op" id="3912296">[</span><span class="builtinfunc" id="3912297">len</span><span class="op" id="3912300">(</span><span class="ident" id="3912301">payload</span><span class="op" id="3912308">)</span><span class="op" id="3912309">-</span><span class="ident" id="3912310">overrun</span><span class="op" id="3912317">:</span><span class="op" id="3912318">]</span><span class="op" id="3912319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3912322">for</span>&nbsp;<span class="ident" id="3912326">i</span>&nbsp;<span class="op" id="3912328">:=</span>&nbsp;<span class="ident" id="3912331">overrun</span><span class="op" id="3912338">;</span>&nbsp;<span class="ident" id="3912340">i</span>&nbsp;<span class="op" id="3912342">&lt;</span>&nbsp;<span class="ident" id="3912344">blockSize</span><span class="op" id="3912353">;</span>&nbsp;<span class="ident" id="3912355">i</span><span class="op" id="3912356">++</span>&nbsp;<span class="op" id="3912359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912363">finalBlock</span><span class="op" id="3912373">[</span><span class="ident" id="3912374">i</span><span class="op" id="3912375">]</span>&nbsp;<span class="op" id="3912377">=</span>&nbsp;<span class="builtintype" id="3912379">byte</span><span class="op" id="3912383">(</span><span class="ident" id="3912384">paddingLen</span>&nbsp;<span class="op" id="3912395">-</span>&nbsp;<span class="num" id="3912397">1</span><span class="op" id="3912398">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3912401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3912404">return</span><br>
<span class="lineno"></span><span class="op" id="3912411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3912414">//&nbsp;encrypt&nbsp;encrypts&nbsp;and&nbsp;macs&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno">355</span><span class="keyword" id="3912458">func</span>&nbsp;<span class="op" id="3912463">(</span><span class="ident" id="3912464">hc</span>&nbsp;<span class="op" id="3912467">*</span><span class="ident" id="3912468">halfConn</span><span class="op" id="3912476">)</span>&nbsp;<span class="ident" id="3912478">encrypt</span><span class="op" id="3912485">(</span><span class="ident" id="3912486">b</span>&nbsp;<span class="op" id="3912488">*</span><span class="ident" id="3912489">block</span><span class="op" id="3912494">,</span>&nbsp;<span class="ident" id="3912496">explicitIVLen</span>&nbsp;<span class="builtintype" id="3912510">int</span><span class="op" id="3912513">)</span>&nbsp;<span class="op" id="3912515">(</span><span class="builtintype" id="3912516">bool</span><span class="op" id="3912520">,</span>&nbsp;<span class="ident" id="3912522">alert</span><span class="op" id="3912527">)</span>&nbsp;<span class="op" id="3912529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3912532">//&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3912540">if</span>&nbsp;<span class="ident" id="3912543">hc</span><span class="op" id="3912545">.</span><span class="ident" id="3912546">mac</span>&nbsp;<span class="op" id="3912550">!=</span>&nbsp;<span class="ident" id="3912553">nil</span>&nbsp;<span class="op" id="3912557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912561">mac</span>&nbsp;<span class="op" id="3912565">:=</span>&nbsp;<span class="ident" id="3912568">hc</span><span class="op" id="3912570">.</span><span class="ident" id="3912571">mac</span><span class="op" id="3912574">.</span><span class="ident" id="3912575">MAC</span><span class="op" id="3912578">(</span><span class="ident" id="3912579">hc</span><span class="op" id="3912581">.</span><span class="ident" id="3912582">outDigestBuf</span><span class="op" id="3912594">,</span>&nbsp;<span class="ident" id="3912596">hc</span><span class="op" id="3912598">.</span><span class="ident" id="3912599">seq</span><span class="op" id="3912602">[</span><span class="num" id="3912603">0</span><span class="op" id="3912604">:</span><span class="op" id="3912605">]</span><span class="op" id="3912606">,</span>&nbsp;<span class="ident" id="3912608">b</span><span class="op" id="3912609">.</span><span class="ident" id="3912610">data</span><span class="op" id="3912614">[</span><span class="op" id="3912615">:</span><span class="ident" id="3912616">recordHeaderLen</span><span class="op" id="3912631">]</span><span class="op" id="3912632">,</span>&nbsp;<span class="ident" id="3912634">b</span><span class="op" id="3912635">.</span><span class="ident" id="3912636">data</span><span class="op" id="3912640">[</span><span class="ident" id="3912641">recordHeaderLen</span><span class="op" id="3912656">+</span><span class="ident" id="3912657">explicitIVLen</span><span class="op" id="3912670">:</span><span class="op" id="3912671">]</span><span class="op" id="3912672">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912677">n</span>&nbsp;<span class="op" id="3912679">:=</span>&nbsp;<span class="builtinfunc" id="3912682">len</span><span class="op" id="3912685">(</span><span class="ident" id="3912686">b</span><span class="op" id="3912687">.</span><span class="ident" id="3912688">data</span><span class="op" id="3912692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912696">b</span><span class="op" id="3912697">.</span><span class="ident" id="3912698">resize</span><span class="op" id="3912704">(</span><span class="ident" id="3912705">n</span>&nbsp;<span class="op" id="3912707">+</span>&nbsp;<span class="builtinfunc" id="3912709">len</span><span class="op" id="3912712">(</span><span class="ident" id="3912713">mac</span><span class="op" id="3912716">)</span><span class="op" id="3912717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3912721">copy</span><span class="op" id="3912725">(</span><span class="ident" id="3912726">b</span><span class="op" id="3912727">.</span><span class="ident" id="3912728">data</span><span class="op" id="3912732">[</span><span class="ident" id="3912733">n</span><span class="op" id="3912734">:</span><span class="op" id="3912735">]</span><span class="op" id="3912736">,</span>&nbsp;<span class="ident" id="3912738">mac</span><span class="op" id="3912741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912745">hc</span><span class="op" id="3912747">.</span><span class="ident" id="3912748">outDigestBuf</span>&nbsp;<span class="op" id="3912761">=</span>&nbsp;<span class="ident" id="3912763">mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3912768">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912772">payload</span>&nbsp;<span class="op" id="3912780">:=</span>&nbsp;<span class="ident" id="3912783">b</span><span class="op" id="3912784">.</span><span class="ident" id="3912785">data</span><span class="op" id="3912789">[</span><span class="ident" id="3912790">recordHeaderLen</span><span class="op" id="3912805">:</span><span class="op" id="3912806">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3912810">//&nbsp;encrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3912822">if</span>&nbsp;<span class="ident" id="3912825">hc</span><span class="op" id="3912827">.</span><span class="ident" id="3912828">cipher</span>&nbsp;<span class="op" id="3912835">!=</span>&nbsp;<span class="ident" id="3912838">nil</span>&nbsp;<span class="op" id="3912842">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3912846">switch</span>&nbsp;<span class="ident" id="3912853">c</span>&nbsp;<span class="op" id="3912855">:=</span>&nbsp;<span class="ident" id="3912858">hc</span><span class="op" id="3912860">.</span><span class="ident" id="3912861">cipher</span><span class="op" id="3912867">.</span><span class="op" id="3912868">(</span><span class="keyword" id="3912869">type</span><span class="op" id="3912873">)</span>&nbsp;<span class="op" id="3912875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3912879">case</span>&nbsp;<span class="ident" id="3912884">cipher</span><span class="op" id="3912890">.</span><span class="ident" id="3912891">Stream</span><span class="op" id="3912897">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912902">c</span><span class="op" id="3912903">.</span><span class="ident" id="3912904">XORKeyStream</span><span class="op" id="3912916">(</span><span class="ident" id="3912917">payload</span><span class="op" id="3912924">,</span>&nbsp;<span class="ident" id="3912926">payload</span><span class="op" id="3912933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3912937">case</span>&nbsp;<span class="ident" id="3912942">cipher</span><span class="op" id="3912948">.</span><span class="ident" id="3912949">AEAD</span><span class="op" id="3912953">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3912958">payloadLen</span>&nbsp;<span class="op" id="3912969">:=</span>&nbsp;<span class="builtinfunc" id="3912972">len</span><span class="op" id="3912975">(</span><span class="ident" id="3912976">b</span><span class="op" id="3912977">.</span><span class="ident" id="3912978">data</span><span class="op" id="3912982">)</span>&nbsp;<span class="op" id="3912984">-</span>&nbsp;<span class="ident" id="3912986">recordHeaderLen</span>&nbsp;<span class="op" id="3913002">-</span>&nbsp;<span class="ident" id="3913004">explicitIVLen</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913021">b</span><span class="op" id="3913022">.</span><span class="ident" id="3913023">resize</span><span class="op" id="3913029">(</span><span class="builtinfunc" id="3913030">len</span><span class="op" id="3913033">(</span><span class="ident" id="3913034">b</span><span class="op" id="3913035">.</span><span class="ident" id="3913036">data</span><span class="op" id="3913040">)</span>&nbsp;<span class="op" id="3913042">+</span>&nbsp;<span class="ident" id="3913044">c</span><span class="op" id="3913045">.</span><span class="ident" id="3913046">Overhead</span><span class="op" id="3913054">(</span><span class="op" id="3913055">)</span><span class="op" id="3913056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913061">nonce</span>&nbsp;<span class="op" id="3913067">:=</span>&nbsp;<span class="ident" id="3913070">b</span><span class="op" id="3913071">.</span><span class="ident" id="3913072">data</span><span class="op" id="3913076">[</span><span class="ident" id="3913077">recordHeaderLen</span>&nbsp;<span class="op" id="3913093">:</span>&nbsp;<span class="ident" id="3913095">recordHeaderLen</span><span class="op" id="3913110">+</span><span class="ident" id="3913111">explicitIVLen</span><span class="op" id="3913124">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913129">payload</span>&nbsp;<span class="op" id="3913137">:=</span>&nbsp;<span class="ident" id="3913140">b</span><span class="op" id="3913141">.</span><span class="ident" id="3913142">data</span><span class="op" id="3913146">[</span><span class="ident" id="3913147">recordHeaderLen</span><span class="op" id="3913162">+</span><span class="ident" id="3913163">explicitIVLen</span><span class="op" id="3913176">:</span><span class="op" id="3913177">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913182">payload</span>&nbsp;<span class="op" id="3913190">=</span>&nbsp;<span class="ident" id="3913192">payload</span><span class="op" id="3913199">[</span><span class="op" id="3913200">:</span><span class="ident" id="3913201">payloadLen</span><span class="op" id="3913211">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3913217">var</span>&nbsp;<span class="ident" id="3913221">additionalData</span>&nbsp;<span class="op" id="3913236">[</span><span class="num" id="3913237">13</span><span class="op" id="3913239">]</span><span class="builtintype" id="3913240">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3913248">copy</span><span class="op" id="3913252">(</span><span class="ident" id="3913253">additionalData</span><span class="op" id="3913267">[</span><span class="op" id="3913268">:</span><span class="op" id="3913269">]</span><span class="op" id="3913270">,</span>&nbsp;<span class="ident" id="3913272">hc</span><span class="op" id="3913274">.</span><span class="ident" id="3913275">seq</span><span class="op" id="3913278">[</span><span class="op" id="3913279">:</span><span class="op" id="3913280">]</span><span class="op" id="3913281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3913286">copy</span><span class="op" id="3913290">(</span><span class="ident" id="3913291">additionalData</span><span class="op" id="3913305">[</span><span class="num" id="3913306">8</span><span class="op" id="3913307">:</span><span class="op" id="3913308">]</span><span class="op" id="3913309">,</span>&nbsp;<span class="ident" id="3913311">b</span><span class="op" id="3913312">.</span><span class="ident" id="3913313">data</span><span class="op" id="3913317">[</span><span class="op" id="3913318">:</span><span class="num" id="3913319">3</span><span class="op" id="3913320">]</span><span class="op" id="3913321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913326">additionalData</span><span class="op" id="3913340">[</span><span class="num" id="3913341">11</span><span class="op" id="3913343">]</span>&nbsp;<span class="op" id="3913345">=</span>&nbsp;<span class="builtintype" id="3913347">byte</span><span class="op" id="3913351">(</span><span class="ident" id="3913352">payloadLen</span>&nbsp;<span class="op" id="3913363">&gt;&gt;</span>&nbsp;<span class="num" id="3913366">8</span><span class="op" id="3913367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913372">additionalData</span><span class="op" id="3913386">[</span><span class="num" id="3913387">12</span><span class="op" id="3913389">]</span>&nbsp;<span class="op" id="3913391">=</span>&nbsp;<span class="builtintype" id="3913393">byte</span><span class="op" id="3913397">(</span><span class="ident" id="3913398">payloadLen</span><span class="op" id="3913408">)</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913414">c</span><span class="op" id="3913415">.</span><span class="ident" id="3913416">Seal</span><span class="op" id="3913420">(</span><span class="ident" id="3913421">payload</span><span class="op" id="3913428">[</span><span class="op" id="3913429">:</span><span class="num" id="3913430">0</span><span class="op" id="3913431">]</span><span class="op" id="3913432">,</span>&nbsp;<span class="ident" id="3913434">nonce</span><span class="op" id="3913439">,</span>&nbsp;<span class="ident" id="3913441">payload</span><span class="op" id="3913448">,</span>&nbsp;<span class="ident" id="3913450">additionalData</span><span class="op" id="3913464">[</span><span class="op" id="3913465">:</span><span class="op" id="3913466">]</span><span class="op" id="3913467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3913471">case</span>&nbsp;<span class="ident" id="3913476">cbcMode</span><span class="op" id="3913483">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913488">blockSize</span>&nbsp;<span class="op" id="3913498">:=</span>&nbsp;<span class="ident" id="3913501">c</span><span class="op" id="3913502">.</span><span class="ident" id="3913503">BlockSize</span><span class="op" id="3913512">(</span><span class="op" id="3913513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3913518">if</span>&nbsp;<span class="ident" id="3913521">explicitIVLen</span>&nbsp;<span class="op" id="3913535">&gt;</span>&nbsp;<span class="num" id="3913537">0</span>&nbsp;<span class="op" id="3913539">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913545">c</span><span class="op" id="3913546">.</span><span class="ident" id="3913547">SetIV</span><span class="op" id="3913552">(</span><span class="ident" id="3913553">payload</span><span class="op" id="3913560">[</span><span class="op" id="3913561">:</span><span class="ident" id="3913562">explicitIVLen</span><span class="op" id="3913575">]</span><span class="op" id="3913576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913582">payload</span>&nbsp;<span class="op" id="3913590">=</span>&nbsp;<span class="ident" id="3913592">payload</span><span class="op" id="3913599">[</span><span class="ident" id="3913600">explicitIVLen</span><span class="op" id="3913613">:</span><span class="op" id="3913614">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3913619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913624">prefix</span><span class="op" id="3913630">,</span>&nbsp;<span class="ident" id="3913632">finalBlock</span>&nbsp;<span class="op" id="3913643">:=</span>&nbsp;<span class="ident" id="3913646">padToBlockSize</span><span class="op" id="3913660">(</span><span class="ident" id="3913661">payload</span><span class="op" id="3913668">,</span>&nbsp;<span class="ident" id="3913670">blockSize</span><span class="op" id="3913679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913684">b</span><span class="op" id="3913685">.</span><span class="ident" id="3913686">resize</span><span class="op" id="3913692">(</span><span class="ident" id="3913693">recordHeaderLen</span>&nbsp;<span class="op" id="3913709">+</span>&nbsp;<span class="ident" id="3913711">explicitIVLen</span>&nbsp;<span class="op" id="3913725">+</span>&nbsp;<span class="builtinfunc" id="3913727">len</span><span class="op" id="3913730">(</span><span class="ident" id="3913731">prefix</span><span class="op" id="3913737">)</span>&nbsp;<span class="op" id="3913739">+</span>&nbsp;<span class="builtinfunc" id="3913741">len</span><span class="op" id="3913744">(</span><span class="ident" id="3913745">finalBlock</span><span class="op" id="3913755">)</span><span class="op" id="3913756">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913761">c</span><span class="op" id="3913762">.</span><span class="ident" id="3913763">CryptBlocks</span><span class="op" id="3913774">(</span><span class="ident" id="3913775">b</span><span class="op" id="3913776">.</span><span class="ident" id="3913777">data</span><span class="op" id="3913781">[</span><span class="ident" id="3913782">recordHeaderLen</span><span class="op" id="3913797">+</span><span class="ident" id="3913798">explicitIVLen</span><span class="op" id="3913811">:</span><span class="op" id="3913812">]</span><span class="op" id="3913813">,</span>&nbsp;<span class="ident" id="3913815">prefix</span><span class="op" id="3913821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3913826">c</span><span class="op" id="3913827">.</span><span class="ident" id="3913828">CryptBlocks</span><span class="op" id="3913839">(</span><span class="ident" id="3913840">b</span><span class="op" id="3913841">.</span><span class="ident" id="3913842">data</span><span class="op" id="3913846">[</span><span class="ident" id="3913847">recordHeaderLen</span><span class="op" id="3913862">+</span><span class="ident" id="3913863">explicitIVLen</span><span class="op" id="3913876">+</span><span class="builtinfunc" id="3913877">len</span><span class="op" id="3913880">(</span><span class="ident" id="3913881">prefix</span><span class="op" id="3913887">)</span><span class="op" id="3913888">:</span><span class="op" id="3913889">]</span><span class="op" id="3913890">,</span>&nbsp;<span class="ident" id="3913892">finalBlock</span><span class="op" id="3913902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3913906">default</span><span class="op" id="3913913">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3913918">panic</span><span class="op" id="3913923">(</span><span class="string" id="3913924">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="3913945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3913949">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3913952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3913956">//&nbsp;update&nbsp;length&nbsp;to&nbsp;include&nbsp;MAC&nbsp;and&nbsp;any&nbsp;block&nbsp;padding&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914019">n</span>&nbsp;<span class="op" id="3914021">:=</span>&nbsp;<span class="builtinfunc" id="3914024">len</span><span class="op" id="3914027">(</span><span class="ident" id="3914028">b</span><span class="op" id="3914029">.</span><span class="ident" id="3914030">data</span><span class="op" id="3914034">)</span>&nbsp;<span class="op" id="3914036">-</span>&nbsp;<span class="ident" id="3914038">recordHeaderLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914055">b</span><span class="op" id="3914056">.</span><span class="ident" id="3914057">data</span><span class="op" id="3914061">[</span><span class="num" id="3914062">3</span><span class="op" id="3914063">]</span>&nbsp;<span class="op" id="3914065">=</span>&nbsp;<span class="builtintype" id="3914067">byte</span><span class="op" id="3914071">(</span><span class="ident" id="3914072">n</span>&nbsp;<span class="op" id="3914074">&gt;&gt;</span>&nbsp;<span class="num" id="3914077">8</span><span class="op" id="3914078">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914081">b</span><span class="op" id="3914082">.</span><span class="ident" id="3914083">data</span><span class="op" id="3914087">[</span><span class="num" id="3914088">4</span><span class="op" id="3914089">]</span>&nbsp;<span class="op" id="3914091">=</span>&nbsp;<span class="builtintype" id="3914093">byte</span><span class="op" id="3914097">(</span><span class="ident" id="3914098">n</span><span class="op" id="3914099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914102">hc</span><span class="op" id="3914104">.</span><span class="ident" id="3914105">incSeq</span><span class="op" id="3914111">(</span><span class="op" id="3914112">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3914116">return</span>&nbsp;<span class="ident" id="3914123">true</span><span class="op" id="3914127">,</span>&nbsp;<span class="num" id="3914129">0</span><br>
<span class="lineno"></span><span class="op" id="3914131">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="3914134">//&nbsp;A&nbsp;block&nbsp;is&nbsp;a&nbsp;simple&nbsp;data&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3914170">type</span>&nbsp;<span class="ident" id="3914175">block</span>&nbsp;<span class="keyword" id="3914181">struct</span>&nbsp;<span class="op" id="3914188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914191">data</span>&nbsp;<span class="op" id="3914196">[</span><span class="op" id="3914197">]</span><span class="builtintype" id="3914198">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914204">off</span>&nbsp;&nbsp;<span class="builtintype" id="3914209">int</span>&nbsp;<span class="comment" id="3914213">//&nbsp;index&nbsp;for&nbsp;Read</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914232">link</span>&nbsp;<span class="op" id="3914237">*</span><span class="ident" id="3914238">block</span><br>
<span class="lineno"></span><span class="op" id="3914244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3914247">//&nbsp;resize&nbsp;resizes&nbsp;block&nbsp;to&nbsp;be&nbsp;n&nbsp;bytes,&nbsp;growing&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="3914308">func</span>&nbsp;<span class="op" id="3914313">(</span><span class="ident" id="3914314">b</span>&nbsp;<span class="op" id="3914316">*</span><span class="ident" id="3914317">block</span><span class="op" id="3914322">)</span>&nbsp;<span class="ident" id="3914324">resize</span><span class="op" id="3914330">(</span><span class="ident" id="3914331">n</span>&nbsp;<span class="builtintype" id="3914333">int</span><span class="op" id="3914336">)</span>&nbsp;<span class="op" id="3914338">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3914341">if</span>&nbsp;<span class="ident" id="3914344">n</span>&nbsp;<span class="op" id="3914346">&gt;</span>&nbsp;<span class="builtinfunc" id="3914348">cap</span><span class="op" id="3914351">(</span><span class="ident" id="3914352">b</span><span class="op" id="3914353">.</span><span class="ident" id="3914354">data</span><span class="op" id="3914358">)</span>&nbsp;<span class="op" id="3914360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914364">b</span><span class="op" id="3914365">.</span><span class="ident" id="3914366">reserve</span><span class="op" id="3914373">(</span><span class="ident" id="3914374">n</span><span class="op" id="3914375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3914378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914381">b</span><span class="op" id="3914382">.</span><span class="ident" id="3914383">data</span>&nbsp;<span class="op" id="3914388">=</span>&nbsp;<span class="ident" id="3914390">b</span><span class="op" id="3914391">.</span><span class="ident" id="3914392">data</span><span class="op" id="3914396">[</span><span class="num" id="3914397">0</span><span class="op" id="3914398">:</span><span class="ident" id="3914399">n</span><span class="op" id="3914400">]</span><br>
<span class="lineno"></span><span class="op" id="3914402">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="3914405">//&nbsp;reserve&nbsp;makes&nbsp;sure&nbsp;that&nbsp;block&nbsp;contains&nbsp;a&nbsp;capacity&nbsp;of&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3914479">func</span>&nbsp;<span class="op" id="3914484">(</span><span class="ident" id="3914485">b</span>&nbsp;<span class="op" id="3914487">*</span><span class="ident" id="3914488">block</span><span class="op" id="3914493">)</span>&nbsp;<span class="ident" id="3914495">reserve</span><span class="op" id="3914502">(</span><span class="ident" id="3914503">n</span>&nbsp;<span class="builtintype" id="3914505">int</span><span class="op" id="3914508">)</span>&nbsp;<span class="op" id="3914510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3914513">if</span>&nbsp;<span class="builtinfunc" id="3914516">cap</span><span class="op" id="3914519">(</span><span class="ident" id="3914520">b</span><span class="op" id="3914521">.</span><span class="ident" id="3914522">data</span><span class="op" id="3914526">)</span>&nbsp;<span class="op" id="3914528">&gt;=</span>&nbsp;<span class="ident" id="3914531">n</span>&nbsp;<span class="op" id="3914533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3914537">return</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3914545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914548">m</span>&nbsp;<span class="op" id="3914550">:=</span>&nbsp;<span class="builtinfunc" id="3914553">cap</span><span class="op" id="3914556">(</span><span class="ident" id="3914557">b</span><span class="op" id="3914558">.</span><span class="ident" id="3914559">data</span><span class="op" id="3914563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3914566">if</span>&nbsp;<span class="ident" id="3914569">m</span>&nbsp;<span class="op" id="3914571">==</span>&nbsp;<span class="num" id="3914574">0</span>&nbsp;<span class="op" id="3914576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914580">m</span>&nbsp;<span class="op" id="3914582">=</span>&nbsp;<span class="num" id="3914584">1024</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3914590">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3914593">for</span>&nbsp;<span class="ident" id="3914597">m</span>&nbsp;<span class="op" id="3914599">&lt;</span>&nbsp;<span class="ident" id="3914601">n</span>&nbsp;<span class="op" id="3914603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914607">m</span>&nbsp;<span class="op" id="3914609">*=</span>&nbsp;<span class="num" id="3914612">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3914615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914618">data</span>&nbsp;<span class="op" id="3914623">:=</span>&nbsp;<span class="builtinfunc" id="3914626">make</span><span class="op" id="3914630">(</span><span class="op" id="3914631">[</span><span class="op" id="3914632">]</span><span class="builtintype" id="3914633">byte</span><span class="op" id="3914637">,</span>&nbsp;<span class="builtinfunc" id="3914639">len</span><span class="op" id="3914642">(</span><span class="ident" id="3914643">b</span><span class="op" id="3914644">.</span><span class="ident" id="3914645">data</span><span class="op" id="3914649">)</span><span class="op" id="3914650">,</span>&nbsp;<span class="ident" id="3914652">m</span><span class="op" id="3914653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3914656">copy</span><span class="op" id="3914660">(</span><span class="ident" id="3914661">data</span><span class="op" id="3914665">,</span>&nbsp;<span class="ident" id="3914667">b</span><span class="op" id="3914668">.</span><span class="ident" id="3914669">data</span><span class="op" id="3914673">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914676">b</span><span class="op" id="3914677">.</span><span class="ident" id="3914678">data</span>&nbsp;<span class="op" id="3914683">=</span>&nbsp;<span class="ident" id="3914685">data</span><br>
<span class="lineno"></span><span class="op" id="3914690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3914693">//&nbsp;readFromUntil&nbsp;reads&nbsp;from&nbsp;r&nbsp;into&nbsp;b&nbsp;until&nbsp;b&nbsp;contains&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes</span><br>
<span class="lineno"></span><span class="comment" id="3914764">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;an&nbsp;error.</span><br>
<span class="lineno">445</span><span class="keyword" id="3914793">func</span>&nbsp;<span class="op" id="3914798">(</span><span class="ident" id="3914799">b</span>&nbsp;<span class="op" id="3914801">*</span><span class="ident" id="3914802">block</span><span class="op" id="3914807">)</span>&nbsp;<span class="ident" id="3914809">readFromUntil</span><span class="op" id="3914822">(</span><span class="ident" id="3914823">r</span>&nbsp;<span class="ident" id="3914825">io</span><span class="op" id="3914827">.</span><span class="ident" id="3914828">Reader</span><span class="op" id="3914834">,</span>&nbsp;<span class="ident" id="3914836">n</span>&nbsp;<span class="builtintype" id="3914838">int</span><span class="op" id="3914841">)</span>&nbsp;<span class="builtintype" id="3914843">error</span>&nbsp;<span class="op" id="3914849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3914852">//&nbsp;quick&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3914867">if</span>&nbsp;<span class="builtinfunc" id="3914870">len</span><span class="op" id="3914873">(</span><span class="ident" id="3914874">b</span><span class="op" id="3914875">.</span><span class="ident" id="3914876">data</span><span class="op" id="3914880">)</span>&nbsp;<span class="op" id="3914882">&gt;=</span>&nbsp;<span class="ident" id="3914885">n</span>&nbsp;<span class="op" id="3914887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3914891">return</span>&nbsp;<span class="ident" id="3914898">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3914903">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3914907">//&nbsp;read&nbsp;until&nbsp;have&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914935">b</span><span class="op" id="3914936">.</span><span class="ident" id="3914937">reserve</span><span class="op" id="3914944">(</span><span class="ident" id="3914945">n</span><span class="op" id="3914946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3914949">for</span>&nbsp;<span class="op" id="3914953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3914957">m</span><span class="op" id="3914958">,</span>&nbsp;<span class="ident" id="3914960">err</span>&nbsp;<span class="op" id="3914964">:=</span>&nbsp;<span class="ident" id="3914967">r</span><span class="op" id="3914968">.</span><span class="ident" id="3914969">Read</span><span class="op" id="3914973">(</span><span class="ident" id="3914974">b</span><span class="op" id="3914975">.</span><span class="ident" id="3914976">data</span><span class="op" id="3914980">[</span><span class="builtinfunc" id="3914981">len</span><span class="op" id="3914984">(</span><span class="ident" id="3914985">b</span><span class="op" id="3914986">.</span><span class="ident" id="3914987">data</span><span class="op" id="3914991">)</span><span class="op" id="3914992">:</span><span class="builtinfunc" id="3914993">cap</span><span class="op" id="3914996">(</span><span class="ident" id="3914997">b</span><span class="op" id="3914998">.</span><span class="ident" id="3914999">data</span><span class="op" id="3915003">)</span><span class="op" id="3915004">]</span><span class="op" id="3915005">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915009">b</span><span class="op" id="3915010">.</span><span class="ident" id="3915011">data</span>&nbsp;<span class="op" id="3915016">=</span>&nbsp;<span class="ident" id="3915018">b</span><span class="op" id="3915019">.</span><span class="ident" id="3915020">data</span><span class="op" id="3915024">[</span><span class="num" id="3915025">0</span>&nbsp;<span class="op" id="3915027">:</span>&nbsp;<span class="builtinfunc" id="3915029">len</span><span class="op" id="3915032">(</span><span class="ident" id="3915033">b</span><span class="op" id="3915034">.</span><span class="ident" id="3915035">data</span><span class="op" id="3915039">)</span><span class="op" id="3915040">+</span><span class="ident" id="3915041">m</span><span class="op" id="3915042">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3915046">if</span>&nbsp;<span class="builtinfunc" id="3915049">len</span><span class="op" id="3915052">(</span><span class="ident" id="3915053">b</span><span class="op" id="3915054">.</span><span class="ident" id="3915055">data</span><span class="op" id="3915059">)</span>&nbsp;<span class="op" id="3915061">&gt;=</span>&nbsp;<span class="ident" id="3915064">n</span>&nbsp;<span class="op" id="3915066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915071">//&nbsp;TODO(bradfitz,agl):&nbsp;slightly&nbsp;suspicious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915117">//&nbsp;that&nbsp;we&#39;re&nbsp;throwing&nbsp;away&nbsp;r.Read&#39;s&nbsp;err&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3915167">break</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3915175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3915179">if</span>&nbsp;<span class="ident" id="3915182">err</span>&nbsp;<span class="op" id="3915186">!=</span>&nbsp;<span class="ident" id="3915189">nil</span>&nbsp;<span class="op" id="3915193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3915198">return</span>&nbsp;<span class="ident" id="3915205">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3915211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3915214">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3915217">return</span>&nbsp;<span class="ident" id="3915224">nil</span><br>
<span class="lineno"></span><span class="op" id="3915228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3915231">func</span>&nbsp;<span class="op" id="3915236">(</span><span class="ident" id="3915237">b</span>&nbsp;<span class="op" id="3915239">*</span><span class="ident" id="3915240">block</span><span class="op" id="3915245">)</span>&nbsp;<span class="ident" id="3915247">Read</span><span class="op" id="3915251">(</span><span class="ident" id="3915252">p</span>&nbsp;<span class="op" id="3915254">[</span><span class="op" id="3915255">]</span><span class="builtintype" id="3915256">byte</span><span class="op" id="3915260">)</span>&nbsp;<span class="op" id="3915262">(</span><span class="ident" id="3915263">n</span>&nbsp;<span class="builtintype" id="3915265">int</span><span class="op" id="3915268">,</span>&nbsp;<span class="ident" id="3915270">err</span>&nbsp;<span class="builtintype" id="3915274">error</span><span class="op" id="3915279">)</span>&nbsp;<span class="op" id="3915281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915284">n</span>&nbsp;<span class="op" id="3915286">=</span>&nbsp;<span class="builtinfunc" id="3915288">copy</span><span class="op" id="3915292">(</span><span class="ident" id="3915293">p</span><span class="op" id="3915294">,</span>&nbsp;<span class="ident" id="3915296">b</span><span class="op" id="3915297">.</span><span class="ident" id="3915298">data</span><span class="op" id="3915302">[</span><span class="ident" id="3915303">b</span><span class="op" id="3915304">.</span><span class="ident" id="3915305">off</span><span class="op" id="3915308">:</span><span class="op" id="3915309">]</span><span class="op" id="3915310">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915313">b</span><span class="op" id="3915314">.</span><span class="ident" id="3915315">off</span>&nbsp;<span class="op" id="3915319">+=</span>&nbsp;<span class="ident" id="3915322">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3915325">return</span><br>
<span class="lineno"></span><span class="op" id="3915332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3915335">//&nbsp;newBlock&nbsp;allocates&nbsp;a&nbsp;new&nbsp;block,&nbsp;from&nbsp;hc&#39;s&nbsp;free&nbsp;list&nbsp;if&nbsp;possible.</span><br>
<span class="lineno">475</span><span class="keyword" id="3915403">func</span>&nbsp;<span class="op" id="3915408">(</span><span class="ident" id="3915409">hc</span>&nbsp;<span class="op" id="3915412">*</span><span class="ident" id="3915413">halfConn</span><span class="op" id="3915421">)</span>&nbsp;<span class="ident" id="3915423">newBlock</span><span class="op" id="3915431">(</span><span class="op" id="3915432">)</span>&nbsp;<span class="op" id="3915434">*</span><span class="ident" id="3915435">block</span>&nbsp;<span class="op" id="3915441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915444">b</span>&nbsp;<span class="op" id="3915446">:=</span>&nbsp;<span class="ident" id="3915449">hc</span><span class="op" id="3915451">.</span><span class="ident" id="3915452">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3915459">if</span>&nbsp;<span class="ident" id="3915462">b</span>&nbsp;<span class="op" id="3915464">==</span>&nbsp;<span class="ident" id="3915467">nil</span>&nbsp;<span class="op" id="3915471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3915475">return</span>&nbsp;<span class="builtinfunc" id="3915482">new</span><span class="op" id="3915485">(</span><span class="ident" id="3915486">block</span><span class="op" id="3915491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3915494">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915497">hc</span><span class="op" id="3915499">.</span><span class="ident" id="3915500">bfree</span>&nbsp;<span class="op" id="3915506">=</span>&nbsp;<span class="ident" id="3915508">b</span><span class="op" id="3915509">.</span><span class="ident" id="3915510">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915516">b</span><span class="op" id="3915517">.</span><span class="ident" id="3915518">link</span>&nbsp;<span class="op" id="3915523">=</span>&nbsp;<span class="ident" id="3915525">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915530">b</span><span class="op" id="3915531">.</span><span class="ident" id="3915532">resize</span><span class="op" id="3915538">(</span><span class="num" id="3915539">0</span><span class="op" id="3915540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3915543">return</span>&nbsp;<span class="ident" id="3915550">b</span><br>
<span class="lineno"></span><span class="op" id="3915552">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="3915555">//&nbsp;freeBlock&nbsp;returns&nbsp;a&nbsp;block&nbsp;to&nbsp;hc&#39;s&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="3915603">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;such&nbsp;that&nbsp;each&nbsp;side&nbsp;only&nbsp;has&nbsp;a&nbsp;block&nbsp;or&nbsp;two&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3915669">//&nbsp;its&nbsp;free&nbsp;list&nbsp;at&nbsp;a&nbsp;time,&nbsp;so&nbsp;there&#39;s&nbsp;no&nbsp;need&nbsp;to&nbsp;worry&nbsp;about</span><br>
<span class="lineno"></span><span class="comment" id="3915731">//&nbsp;trimming&nbsp;the&nbsp;list,&nbsp;etc.</span><br>
<span class="lineno">490</span><span class="keyword" id="3915758">func</span>&nbsp;<span class="op" id="3915763">(</span><span class="ident" id="3915764">hc</span>&nbsp;<span class="op" id="3915767">*</span><span class="ident" id="3915768">halfConn</span><span class="op" id="3915776">)</span>&nbsp;<span class="ident" id="3915778">freeBlock</span><span class="op" id="3915787">(</span><span class="ident" id="3915788">b</span>&nbsp;<span class="op" id="3915790">*</span><span class="ident" id="3915791">block</span><span class="op" id="3915796">)</span>&nbsp;<span class="op" id="3915798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915801">b</span><span class="op" id="3915802">.</span><span class="ident" id="3915803">link</span>&nbsp;<span class="op" id="3915808">=</span>&nbsp;<span class="ident" id="3915810">hc</span><span class="op" id="3915812">.</span><span class="ident" id="3915813">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915820">hc</span><span class="op" id="3915822">.</span><span class="ident" id="3915823">bfree</span>&nbsp;<span class="op" id="3915829">=</span>&nbsp;<span class="ident" id="3915831">b</span><br>
<span class="lineno"></span><span class="op" id="3915833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="3915836">//&nbsp;splitBlock&nbsp;splits&nbsp;a&nbsp;block&nbsp;after&nbsp;the&nbsp;first&nbsp;n&nbsp;bytes,</span><br>
<span class="lineno"></span><span class="comment" id="3915890">//&nbsp;returning&nbsp;a&nbsp;block&nbsp;with&nbsp;those&nbsp;n&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3915936">//&nbsp;block&nbsp;with&nbsp;the&nbsp;remainder.&nbsp;&nbsp;the&nbsp;latter&nbsp;may&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="3915989">func</span>&nbsp;<span class="op" id="3915994">(</span><span class="ident" id="3915995">hc</span>&nbsp;<span class="op" id="3915998">*</span><span class="ident" id="3915999">halfConn</span><span class="op" id="3916007">)</span>&nbsp;<span class="ident" id="3916009">splitBlock</span><span class="op" id="3916019">(</span><span class="ident" id="3916020">b</span>&nbsp;<span class="op" id="3916022">*</span><span class="ident" id="3916023">block</span><span class="op" id="3916028">,</span>&nbsp;<span class="ident" id="3916030">n</span>&nbsp;<span class="builtintype" id="3916032">int</span><span class="op" id="3916035">)</span>&nbsp;<span class="op" id="3916037">(</span><span class="op" id="3916038">*</span><span class="ident" id="3916039">block</span><span class="op" id="3916044">,</span>&nbsp;<span class="op" id="3916046">*</span><span class="ident" id="3916047">block</span><span class="op" id="3916052">)</span>&nbsp;<span class="op" id="3916054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916057">if</span>&nbsp;<span class="builtinfunc" id="3916060">len</span><span class="op" id="3916063">(</span><span class="ident" id="3916064">b</span><span class="op" id="3916065">.</span><span class="ident" id="3916066">data</span><span class="op" id="3916070">)</span>&nbsp;<span class="op" id="3916072">&lt;=</span>&nbsp;<span class="ident" id="3916075">n</span>&nbsp;<span class="op" id="3916077">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916081">return</span>&nbsp;<span class="ident" id="3916088">b</span><span class="op" id="3916089">,</span>&nbsp;<span class="ident" id="3916091">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3916096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916099">bb</span>&nbsp;<span class="op" id="3916102">:=</span>&nbsp;<span class="ident" id="3916105">hc</span><span class="op" id="3916107">.</span><span class="ident" id="3916108">newBlock</span><span class="op" id="3916116">(</span><span class="op" id="3916117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916120">bb</span><span class="op" id="3916122">.</span><span class="ident" id="3916123">resize</span><span class="op" id="3916129">(</span><span class="builtinfunc" id="3916130">len</span><span class="op" id="3916133">(</span><span class="ident" id="3916134">b</span><span class="op" id="3916135">.</span><span class="ident" id="3916136">data</span><span class="op" id="3916140">)</span>&nbsp;<span class="op" id="3916142">-</span>&nbsp;<span class="ident" id="3916144">n</span><span class="op" id="3916145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3916148">copy</span><span class="op" id="3916152">(</span><span class="ident" id="3916153">bb</span><span class="op" id="3916155">.</span><span class="ident" id="3916156">data</span><span class="op" id="3916160">,</span>&nbsp;<span class="ident" id="3916162">b</span><span class="op" id="3916163">.</span><span class="ident" id="3916164">data</span><span class="op" id="3916168">[</span><span class="ident" id="3916169">n</span><span class="op" id="3916170">:</span><span class="op" id="3916171">]</span><span class="op" id="3916172">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916175">b</span><span class="op" id="3916176">.</span><span class="ident" id="3916177">data</span>&nbsp;<span class="op" id="3916182">=</span>&nbsp;<span class="ident" id="3916184">b</span><span class="op" id="3916185">.</span><span class="ident" id="3916186">data</span><span class="op" id="3916190">[</span><span class="num" id="3916191">0</span><span class="op" id="3916192">:</span><span class="ident" id="3916193">n</span><span class="op" id="3916194">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916197">return</span>&nbsp;<span class="ident" id="3916204">b</span><span class="op" id="3916205">,</span>&nbsp;<span class="ident" id="3916207">bb</span><br>
<span class="lineno"></span><span class="op" id="3916210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3916213">//&nbsp;readRecord&nbsp;reads&nbsp;the&nbsp;next&nbsp;TLS&nbsp;record&nbsp;from&nbsp;the&nbsp;connection</span><br>
<span class="lineno">510</span><span class="comment" id="3916273">//&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="3916312">//&nbsp;c.in.Mutex&nbsp;&lt;=&nbsp;L;&nbsp;c.input&nbsp;==&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="3916348">func</span>&nbsp;<span class="op" id="3916353">(</span><span class="ident" id="3916354">c</span>&nbsp;<span class="op" id="3916356">*</span><span class="ident" id="3916357">Conn</span><span class="op" id="3916361">)</span>&nbsp;<span class="ident" id="3916363">readRecord</span><span class="op" id="3916373">(</span><span class="ident" id="3916374">want</span>&nbsp;<span class="ident" id="3916379">recordType</span><span class="op" id="3916389">)</span>&nbsp;<span class="builtintype" id="3916391">error</span>&nbsp;<span class="op" id="3916397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3916400">//&nbsp;Caller&nbsp;must&nbsp;be&nbsp;in&nbsp;sync&nbsp;with&nbsp;connection:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3916444">//&nbsp;handshake&nbsp;data&nbsp;if&nbsp;handshake&nbsp;not&nbsp;yet&nbsp;completed,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3916495">//&nbsp;else&nbsp;application&nbsp;data.&nbsp;&nbsp;(We&nbsp;don&#39;t&nbsp;support&nbsp;renegotiation.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916557">switch</span>&nbsp;<span class="ident" id="3916564">want</span>&nbsp;<span class="op" id="3916569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916572">default</span><span class="op" id="3916579">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916583">c</span><span class="op" id="3916584">.</span><span class="ident" id="3916585">sendAlert</span><span class="op" id="3916594">(</span><span class="ident" id="3916595">alertInternalError</span><span class="op" id="3916613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916617">return</span>&nbsp;<span class="ident" id="3916624">c</span><span class="op" id="3916625">.</span><span class="ident" id="3916626">in</span><span class="op" id="3916628">.</span><span class="ident" id="3916629">setErrorLocked</span><span class="op" id="3916643">(</span><span class="ident" id="3916644">errors</span><span class="op" id="3916650">.</span><span class="ident" id="3916651">New</span><span class="op" id="3916654">(</span><span class="string" id="3916655">&#34;tls:&nbsp;unknown&nbsp;record&nbsp;type&nbsp;requested&#34;</span><span class="op" id="3916691">)</span><span class="op" id="3916692">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916695">case</span>&nbsp;<span class="ident" id="3916700">recordTypeHandshake</span><span class="op" id="3916719">,</span>&nbsp;<span class="ident" id="3916721">recordTypeChangeCipherSpec</span><span class="op" id="3916747">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916751">if</span>&nbsp;<span class="ident" id="3916754">c</span><span class="op" id="3916755">.</span><span class="ident" id="3916756">handshakeComplete</span>&nbsp;<span class="op" id="3916774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916779">c</span><span class="op" id="3916780">.</span><span class="ident" id="3916781">sendAlert</span><span class="op" id="3916790">(</span><span class="ident" id="3916791">alertInternalError</span><span class="op" id="3916809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916814">return</span>&nbsp;<span class="ident" id="3916821">c</span><span class="op" id="3916822">.</span><span class="ident" id="3916823">in</span><span class="op" id="3916825">.</span><span class="ident" id="3916826">setErrorLocked</span><span class="op" id="3916840">(</span><span class="ident" id="3916841">errors</span><span class="op" id="3916847">.</span><span class="ident" id="3916848">New</span><span class="op" id="3916851">(</span><span class="string" id="3916852">&#34;tls:&nbsp;handshake&nbsp;or&nbsp;ChangeCipherSpec&nbsp;requested&nbsp;after&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="3916923">)</span><span class="op" id="3916924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3916928">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916931">case</span>&nbsp;<span class="ident" id="3916936">recordTypeApplicationData</span><span class="op" id="3916961">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916965">if</span>&nbsp;<span class="op" id="3916968">!</span><span class="ident" id="3916969">c</span><span class="op" id="3916970">.</span><span class="ident" id="3916971">handshakeComplete</span>&nbsp;<span class="op" id="3916989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916994">c</span><span class="op" id="3916995">.</span><span class="ident" id="3916996">sendAlert</span><span class="op" id="3917005">(</span><span class="ident" id="3917006">alertInternalError</span><span class="op" id="3917024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917029">return</span>&nbsp;<span class="ident" id="3917036">c</span><span class="op" id="3917037">.</span><span class="ident" id="3917038">in</span><span class="op" id="3917040">.</span><span class="ident" id="3917041">setErrorLocked</span><span class="op" id="3917055">(</span><span class="ident" id="3917056">errors</span><span class="op" id="3917062">.</span><span class="ident" id="3917063">New</span><span class="op" id="3917066">(</span><span class="string" id="3917067">&#34;tls:&nbsp;application&nbsp;data&nbsp;record&nbsp;requested&nbsp;before&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="3917133">)</span><span class="op" id="3917134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3917138">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3917141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="3917144">Again</span><span class="op" id="3917149">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917152">if</span>&nbsp;<span class="ident" id="3917155">c</span><span class="op" id="3917156">.</span><span class="ident" id="3917157">rawInput</span>&nbsp;<span class="op" id="3917166">==</span>&nbsp;<span class="ident" id="3917169">nil</span>&nbsp;<span class="op" id="3917173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917177">c</span><span class="op" id="3917178">.</span><span class="ident" id="3917179">rawInput</span>&nbsp;<span class="op" id="3917188">=</span>&nbsp;<span class="ident" id="3917190">c</span><span class="op" id="3917191">.</span><span class="ident" id="3917192">in</span><span class="op" id="3917194">.</span><span class="ident" id="3917195">newBlock</span><span class="op" id="3917203">(</span><span class="op" id="3917204">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3917207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917210">b</span>&nbsp;<span class="op" id="3917212">:=</span>&nbsp;<span class="ident" id="3917215">c</span><span class="op" id="3917216">.</span><span class="ident" id="3917217">rawInput</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3917228">//&nbsp;Read&nbsp;header,&nbsp;payload.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917254">if</span>&nbsp;<span class="ident" id="3917257">err</span>&nbsp;<span class="op" id="3917261">:=</span>&nbsp;<span class="ident" id="3917264">b</span><span class="op" id="3917265">.</span><span class="ident" id="3917266">readFromUntil</span><span class="op" id="3917279">(</span><span class="ident" id="3917280">c</span><span class="op" id="3917281">.</span><span class="ident" id="3917282">conn</span><span class="op" id="3917286">,</span>&nbsp;<span class="ident" id="3917288">recordHeaderLen</span><span class="op" id="3917303">)</span><span class="op" id="3917304">;</span>&nbsp;<span class="ident" id="3917306">err</span>&nbsp;<span class="op" id="3917310">!=</span>&nbsp;<span class="ident" id="3917313">nil</span>&nbsp;<span class="op" id="3917317">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3917321">//&nbsp;RFC&nbsp;suggests&nbsp;that&nbsp;EOF&nbsp;without&nbsp;an&nbsp;alertCloseNotify&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3917379">//&nbsp;an&nbsp;error,&nbsp;but&nbsp;popular&nbsp;web&nbsp;sites&nbsp;seem&nbsp;to&nbsp;do&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3917433">//&nbsp;so&nbsp;we&nbsp;can&#39;t&nbsp;make&nbsp;it&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3917468">//&nbsp;if&nbsp;err&nbsp;==&nbsp;io.EOF&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3917492">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;=&nbsp;io.ErrUnexpectedEOF</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3917524">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917531">if</span>&nbsp;<span class="ident" id="3917534">e</span><span class="op" id="3917535">,</span>&nbsp;<span class="ident" id="3917537">ok</span>&nbsp;<span class="op" id="3917540">:=</span>&nbsp;<span class="ident" id="3917543">err</span><span class="op" id="3917546">.</span><span class="op" id="3917547">(</span><span class="ident" id="3917548">net</span><span class="op" id="3917551">.</span><span class="ident" id="3917552">Error</span><span class="op" id="3917557">)</span><span class="op" id="3917558">;</span>&nbsp;<span class="op" id="3917560">!</span><span class="ident" id="3917561">ok</span>&nbsp;<span class="op" id="3917564">||</span>&nbsp;<span class="op" id="3917567">!</span><span class="ident" id="3917568">e</span><span class="op" id="3917569">.</span><span class="ident" id="3917570">Temporary</span><span class="op" id="3917579">(</span><span class="op" id="3917580">)</span>&nbsp;<span class="op" id="3917582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917587">c</span><span class="op" id="3917588">.</span><span class="ident" id="3917589">in</span><span class="op" id="3917591">.</span><span class="ident" id="3917592">setErrorLocked</span><span class="op" id="3917606">(</span><span class="ident" id="3917607">err</span><span class="op" id="3917610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3917614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917618">return</span>&nbsp;<span class="ident" id="3917625">err</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3917630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917633">typ</span>&nbsp;<span class="op" id="3917637">:=</span>&nbsp;<span class="ident" id="3917640">recordType</span><span class="op" id="3917650">(</span><span class="ident" id="3917651">b</span><span class="op" id="3917652">.</span><span class="ident" id="3917653">data</span><span class="op" id="3917657">[</span><span class="num" id="3917658">0</span><span class="op" id="3917659">]</span><span class="op" id="3917660">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3917664">//&nbsp;No&nbsp;valid&nbsp;TLS&nbsp;record&nbsp;has&nbsp;a&nbsp;type&nbsp;of&nbsp;0x80,&nbsp;however&nbsp;SSLv2&nbsp;handshakes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3917733">//&nbsp;start&nbsp;with&nbsp;a&nbsp;uint16&nbsp;length&nbsp;where&nbsp;the&nbsp;MSB&nbsp;is&nbsp;set&nbsp;and&nbsp;the&nbsp;first&nbsp;record</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3917806">//&nbsp;is&nbsp;always&nbsp;&lt;&nbsp;256&nbsp;bytes&nbsp;long.&nbsp;Therefore&nbsp;typ&nbsp;==&nbsp;0x80&nbsp;strongly&nbsp;suggests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3917878">//&nbsp;an&nbsp;SSLv2&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917899">if</span>&nbsp;<span class="ident" id="3917902">want</span>&nbsp;<span class="op" id="3917907">==</span>&nbsp;<span class="ident" id="3917910">recordTypeHandshake</span>&nbsp;<span class="op" id="3917930">&amp;&amp;</span>&nbsp;<span class="ident" id="3917933">typ</span>&nbsp;<span class="op" id="3917937">==</span>&nbsp;<span class="num" id="3917940">0x80</span>&nbsp;<span class="op" id="3917945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917949">c</span><span class="op" id="3917950">.</span><span class="ident" id="3917951">sendAlert</span><span class="op" id="3917960">(</span><span class="ident" id="3917961">alertProtocolVersion</span><span class="op" id="3917981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917985">return</span>&nbsp;<span class="ident" id="3917992">c</span><span class="op" id="3917993">.</span><span class="ident" id="3917994">in</span><span class="op" id="3917996">.</span><span class="ident" id="3917997">setErrorLocked</span><span class="op" id="3918011">(</span><span class="ident" id="3918012">errors</span><span class="op" id="3918018">.</span><span class="ident" id="3918019">New</span><span class="op" id="3918022">(</span><span class="string" id="3918023">&#34;tls:&nbsp;unsupported&nbsp;SSLv2&nbsp;handshake&nbsp;received&#34;</span><span class="op" id="3918066">)</span><span class="op" id="3918067">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3918070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918074">vers</span>&nbsp;<span class="op" id="3918079">:=</span>&nbsp;<span class="builtintype" id="3918082">uint16</span><span class="op" id="3918088">(</span><span class="ident" id="3918089">b</span><span class="op" id="3918090">.</span><span class="ident" id="3918091">data</span><span class="op" id="3918095">[</span><span class="num" id="3918096">1</span><span class="op" id="3918097">]</span><span class="op" id="3918098">)</span><span class="op" id="3918099">&lt;&lt;</span><span class="num" id="3918101">8</span>&nbsp;<span class="op" id="3918103">|</span>&nbsp;<span class="builtintype" id="3918105">uint16</span><span class="op" id="3918111">(</span><span class="ident" id="3918112">b</span><span class="op" id="3918113">.</span><span class="ident" id="3918114">data</span><span class="op" id="3918118">[</span><span class="num" id="3918119">2</span><span class="op" id="3918120">]</span><span class="op" id="3918121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918124">n</span>&nbsp;<span class="op" id="3918126">:=</span>&nbsp;<span class="builtintype" id="3918129">int</span><span class="op" id="3918132">(</span><span class="ident" id="3918133">b</span><span class="op" id="3918134">.</span><span class="ident" id="3918135">data</span><span class="op" id="3918139">[</span><span class="num" id="3918140">3</span><span class="op" id="3918141">]</span><span class="op" id="3918142">)</span><span class="op" id="3918143">&lt;&lt;</span><span class="num" id="3918145">8</span>&nbsp;<span class="op" id="3918147">|</span>&nbsp;<span class="builtintype" id="3918149">int</span><span class="op" id="3918152">(</span><span class="ident" id="3918153">b</span><span class="op" id="3918154">.</span><span class="ident" id="3918155">data</span><span class="op" id="3918159">[</span><span class="num" id="3918160">4</span><span class="op" id="3918161">]</span><span class="op" id="3918162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3918165">if</span>&nbsp;<span class="ident" id="3918168">c</span><span class="op" id="3918169">.</span><span class="ident" id="3918170">haveVers</span>&nbsp;<span class="op" id="3918179">&amp;&amp;</span>&nbsp;<span class="ident" id="3918182">vers</span>&nbsp;<span class="op" id="3918187">!=</span>&nbsp;<span class="ident" id="3918190">c</span><span class="op" id="3918191">.</span><span class="ident" id="3918192">vers</span>&nbsp;<span class="op" id="3918197">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918201">c</span><span class="op" id="3918202">.</span><span class="ident" id="3918203">sendAlert</span><span class="op" id="3918212">(</span><span class="ident" id="3918213">alertProtocolVersion</span><span class="op" id="3918233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3918237">return</span>&nbsp;<span class="ident" id="3918244">c</span><span class="op" id="3918245">.</span><span class="ident" id="3918246">in</span><span class="op" id="3918248">.</span><span class="ident" id="3918249">setErrorLocked</span><span class="op" id="3918263">(</span><span class="ident" id="3918264">fmt</span><span class="op" id="3918267">.</span><span class="ident" id="3918268">Errorf</span><span class="op" id="3918274">(</span><span class="string" id="3918275">&#34;tls:&nbsp;received&nbsp;record&nbsp;with&nbsp;version&nbsp;%x&nbsp;when&nbsp;expecting&nbsp;version&nbsp;%x&#34;</span><span class="op" id="3918339">,</span>&nbsp;<span class="ident" id="3918341">vers</span><span class="op" id="3918345">,</span>&nbsp;<span class="ident" id="3918347">c</span><span class="op" id="3918348">.</span><span class="ident" id="3918349">vers</span><span class="op" id="3918353">)</span><span class="op" id="3918354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3918357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3918360">if</span>&nbsp;<span class="ident" id="3918363">n</span>&nbsp;<span class="op" id="3918365">&gt;</span>&nbsp;<span class="ident" id="3918367">maxCiphertext</span>&nbsp;<span class="op" id="3918381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918385">c</span><span class="op" id="3918386">.</span><span class="ident" id="3918387">sendAlert</span><span class="op" id="3918396">(</span><span class="ident" id="3918397">alertRecordOverflow</span><span class="op" id="3918416">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3918420">return</span>&nbsp;<span class="ident" id="3918427">c</span><span class="op" id="3918428">.</span><span class="ident" id="3918429">in</span><span class="op" id="3918431">.</span><span class="ident" id="3918432">setErrorLocked</span><span class="op" id="3918446">(</span><span class="ident" id="3918447">fmt</span><span class="op" id="3918450">.</span><span class="ident" id="3918451">Errorf</span><span class="op" id="3918457">(</span><span class="string" id="3918458">&#34;tls:&nbsp;oversized&nbsp;record&nbsp;received&nbsp;with&nbsp;length&nbsp;%d&#34;</span><span class="op" id="3918505">,</span>&nbsp;<span class="ident" id="3918507">n</span><span class="op" id="3918508">)</span><span class="op" id="3918509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3918512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3918515">if</span>&nbsp;<span class="op" id="3918518">!</span><span class="ident" id="3918519">c</span><span class="op" id="3918520">.</span><span class="ident" id="3918521">haveVers</span>&nbsp;<span class="op" id="3918530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3918534">//&nbsp;First&nbsp;message,&nbsp;be&nbsp;extra&nbsp;suspicious:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3918575">//&nbsp;this&nbsp;might&nbsp;not&nbsp;be&nbsp;a&nbsp;TLS&nbsp;client.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3918612">//&nbsp;Bail&nbsp;out&nbsp;before&nbsp;reading&nbsp;a&nbsp;full&nbsp;&#39;body&#39;,&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3918669">//&nbsp;The&nbsp;current&nbsp;max&nbsp;version&nbsp;is&nbsp;3.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3918706">//&nbsp;If&nbsp;the&nbsp;version&nbsp;is&nbsp;&gt;=&nbsp;16.0,&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3918762">//&nbsp;Similarly,&nbsp;a&nbsp;clientHello&nbsp;message&nbsp;encodes&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3918811">//&nbsp;well&nbsp;under&nbsp;a&nbsp;kilobyte.&nbsp;&nbsp;If&nbsp;the&nbsp;length&nbsp;is&nbsp;&gt;=&nbsp;12&nbsp;kB,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3918867">//&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3918896">if</span>&nbsp;<span class="op" id="3918899">(</span><span class="ident" id="3918900">typ</span>&nbsp;<span class="op" id="3918904">!=</span>&nbsp;<span class="ident" id="3918907">recordTypeAlert</span>&nbsp;<span class="op" id="3918923">&amp;&amp;</span>&nbsp;<span class="ident" id="3918926">typ</span>&nbsp;<span class="op" id="3918930">!=</span>&nbsp;<span class="ident" id="3918933">want</span><span class="op" id="3918937">)</span>&nbsp;<span class="op" id="3918939">||</span>&nbsp;<span class="ident" id="3918942">vers</span>&nbsp;<span class="op" id="3918947">&gt;=</span>&nbsp;<span class="num" id="3918950">0x1000</span>&nbsp;<span class="op" id="3918957">||</span>&nbsp;<span class="ident" id="3918960">n</span>&nbsp;<span class="op" id="3918962">&gt;=</span>&nbsp;<span class="num" id="3918965">0x3000</span>&nbsp;<span class="op" id="3918972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918977">c</span><span class="op" id="3918978">.</span><span class="ident" id="3918979">sendAlert</span><span class="op" id="3918988">(</span><span class="ident" id="3918989">alertUnexpectedMessage</span><span class="op" id="3919011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919016">return</span>&nbsp;<span class="ident" id="3919023">c</span><span class="op" id="3919024">.</span><span class="ident" id="3919025">in</span><span class="op" id="3919027">.</span><span class="ident" id="3919028">setErrorLocked</span><span class="op" id="3919042">(</span><span class="ident" id="3919043">fmt</span><span class="op" id="3919046">.</span><span class="ident" id="3919047">Errorf</span><span class="op" id="3919053">(</span><span class="string" id="3919054">&#34;tls:&nbsp;first&nbsp;record&nbsp;does&nbsp;not&nbsp;look&nbsp;like&nbsp;a&nbsp;TLS&nbsp;handshake&#34;</span><span class="op" id="3919108">)</span><span class="op" id="3919109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3919113">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3919116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919119">if</span>&nbsp;<span class="ident" id="3919122">err</span>&nbsp;<span class="op" id="3919126">:=</span>&nbsp;<span class="ident" id="3919129">b</span><span class="op" id="3919130">.</span><span class="ident" id="3919131">readFromUntil</span><span class="op" id="3919144">(</span><span class="ident" id="3919145">c</span><span class="op" id="3919146">.</span><span class="ident" id="3919147">conn</span><span class="op" id="3919151">,</span>&nbsp;<span class="ident" id="3919153">recordHeaderLen</span><span class="op" id="3919168">+</span><span class="ident" id="3919169">n</span><span class="op" id="3919170">)</span><span class="op" id="3919171">;</span>&nbsp;<span class="ident" id="3919173">err</span>&nbsp;<span class="op" id="3919177">!=</span>&nbsp;<span class="ident" id="3919180">nil</span>&nbsp;<span class="op" id="3919184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919188">if</span>&nbsp;<span class="ident" id="3919191">err</span>&nbsp;<span class="op" id="3919195">==</span>&nbsp;<span class="ident" id="3919198">io</span><span class="op" id="3919200">.</span><span class="ident" id="3919201">EOF</span>&nbsp;<span class="op" id="3919205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919210">err</span>&nbsp;<span class="op" id="3919214">=</span>&nbsp;<span class="ident" id="3919216">io</span><span class="op" id="3919218">.</span><span class="ident" id="3919219">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3919238">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919242">if</span>&nbsp;<span class="ident" id="3919245">e</span><span class="op" id="3919246">,</span>&nbsp;<span class="ident" id="3919248">ok</span>&nbsp;<span class="op" id="3919251">:=</span>&nbsp;<span class="ident" id="3919254">err</span><span class="op" id="3919257">.</span><span class="op" id="3919258">(</span><span class="ident" id="3919259">net</span><span class="op" id="3919262">.</span><span class="ident" id="3919263">Error</span><span class="op" id="3919268">)</span><span class="op" id="3919269">;</span>&nbsp;<span class="op" id="3919271">!</span><span class="ident" id="3919272">ok</span>&nbsp;<span class="op" id="3919275">||</span>&nbsp;<span class="op" id="3919278">!</span><span class="ident" id="3919279">e</span><span class="op" id="3919280">.</span><span class="ident" id="3919281">Temporary</span><span class="op" id="3919290">(</span><span class="op" id="3919291">)</span>&nbsp;<span class="op" id="3919293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919298">c</span><span class="op" id="3919299">.</span><span class="ident" id="3919300">in</span><span class="op" id="3919302">.</span><span class="ident" id="3919303">setErrorLocked</span><span class="op" id="3919317">(</span><span class="ident" id="3919318">err</span><span class="op" id="3919321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3919325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919329">return</span>&nbsp;<span class="ident" id="3919336">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3919341">}</span><br>
<span class="lineno">595</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3919345">//&nbsp;Process&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919366">b</span><span class="op" id="3919367">,</span>&nbsp;<span class="ident" id="3919369">c</span><span class="op" id="3919370">.</span><span class="ident" id="3919371">rawInput</span>&nbsp;<span class="op" id="3919380">=</span>&nbsp;<span class="ident" id="3919382">c</span><span class="op" id="3919383">.</span><span class="ident" id="3919384">in</span><span class="op" id="3919386">.</span><span class="ident" id="3919387">splitBlock</span><span class="op" id="3919397">(</span><span class="ident" id="3919398">b</span><span class="op" id="3919399">,</span>&nbsp;<span class="ident" id="3919401">recordHeaderLen</span><span class="op" id="3919416">+</span><span class="ident" id="3919417">n</span><span class="op" id="3919418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919421">ok</span><span class="op" id="3919423">,</span>&nbsp;<span class="ident" id="3919425">off</span><span class="op" id="3919428">,</span>&nbsp;<span class="ident" id="3919430">err</span>&nbsp;<span class="op" id="3919434">:=</span>&nbsp;<span class="ident" id="3919437">c</span><span class="op" id="3919438">.</span><span class="ident" id="3919439">in</span><span class="op" id="3919441">.</span><span class="ident" id="3919442">decrypt</span><span class="op" id="3919449">(</span><span class="ident" id="3919450">b</span><span class="op" id="3919451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919454">if</span>&nbsp;<span class="op" id="3919457">!</span><span class="ident" id="3919458">ok</span>&nbsp;<span class="op" id="3919461">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919465">c</span><span class="op" id="3919466">.</span><span class="ident" id="3919467">in</span><span class="op" id="3919469">.</span><span class="ident" id="3919470">setErrorLocked</span><span class="op" id="3919484">(</span><span class="ident" id="3919485">c</span><span class="op" id="3919486">.</span><span class="ident" id="3919487">sendAlert</span><span class="op" id="3919496">(</span><span class="ident" id="3919497">err</span><span class="op" id="3919500">)</span><span class="op" id="3919501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3919504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919507">b</span><span class="op" id="3919508">.</span><span class="ident" id="3919509">off</span>&nbsp;<span class="op" id="3919513">=</span>&nbsp;<span class="ident" id="3919515">off</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919520">data</span>&nbsp;<span class="op" id="3919525">:=</span>&nbsp;<span class="ident" id="3919528">b</span><span class="op" id="3919529">.</span><span class="ident" id="3919530">data</span><span class="op" id="3919534">[</span><span class="ident" id="3919535">b</span><span class="op" id="3919536">.</span><span class="ident" id="3919537">off</span><span class="op" id="3919540">:</span><span class="op" id="3919541">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919544">if</span>&nbsp;<span class="builtinfunc" id="3919547">len</span><span class="op" id="3919550">(</span><span class="ident" id="3919551">data</span><span class="op" id="3919555">)</span>&nbsp;<span class="op" id="3919557">&gt;</span>&nbsp;<span class="ident" id="3919559">maxPlaintext</span>&nbsp;<span class="op" id="3919572">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919576">err</span>&nbsp;<span class="op" id="3919580">:=</span>&nbsp;<span class="ident" id="3919583">c</span><span class="op" id="3919584">.</span><span class="ident" id="3919585">sendAlert</span><span class="op" id="3919594">(</span><span class="ident" id="3919595">alertRecordOverflow</span><span class="op" id="3919614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919618">c</span><span class="op" id="3919619">.</span><span class="ident" id="3919620">in</span><span class="op" id="3919622">.</span><span class="ident" id="3919623">freeBlock</span><span class="op" id="3919632">(</span><span class="ident" id="3919633">b</span><span class="op" id="3919634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919638">return</span>&nbsp;<span class="ident" id="3919645">c</span><span class="op" id="3919646">.</span><span class="ident" id="3919647">in</span><span class="op" id="3919649">.</span><span class="ident" id="3919650">setErrorLocked</span><span class="op" id="3919664">(</span><span class="ident" id="3919665">err</span><span class="op" id="3919668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3919671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919675">switch</span>&nbsp;<span class="ident" id="3919682">typ</span>&nbsp;<span class="op" id="3919686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919689">default</span><span class="op" id="3919696">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919700">c</span><span class="op" id="3919701">.</span><span class="ident" id="3919702">in</span><span class="op" id="3919704">.</span><span class="ident" id="3919705">setErrorLocked</span><span class="op" id="3919719">(</span><span class="ident" id="3919720">c</span><span class="op" id="3919721">.</span><span class="ident" id="3919722">sendAlert</span><span class="op" id="3919731">(</span><span class="ident" id="3919732">alertUnexpectedMessage</span><span class="op" id="3919754">)</span><span class="op" id="3919755">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919759">case</span>&nbsp;<span class="ident" id="3919764">recordTypeAlert</span><span class="op" id="3919779">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919783">if</span>&nbsp;<span class="builtinfunc" id="3919786">len</span><span class="op" id="3919789">(</span><span class="ident" id="3919790">data</span><span class="op" id="3919794">)</span>&nbsp;<span class="op" id="3919796">!=</span>&nbsp;<span class="num" id="3919799">2</span>&nbsp;<span class="op" id="3919801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919806">c</span><span class="op" id="3919807">.</span><span class="ident" id="3919808">in</span><span class="op" id="3919810">.</span><span class="ident" id="3919811">setErrorLocked</span><span class="op" id="3919825">(</span><span class="ident" id="3919826">c</span><span class="op" id="3919827">.</span><span class="ident" id="3919828">sendAlert</span><span class="op" id="3919837">(</span><span class="ident" id="3919838">alertUnexpectedMessage</span><span class="op" id="3919860">)</span><span class="op" id="3919861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919866">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3919874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919878">if</span>&nbsp;<span class="ident" id="3919881">alert</span><span class="op" id="3919886">(</span><span class="ident" id="3919887">data</span><span class="op" id="3919891">[</span><span class="num" id="3919892">1</span><span class="op" id="3919893">]</span><span class="op" id="3919894">)</span>&nbsp;<span class="op" id="3919896">==</span>&nbsp;<span class="ident" id="3919899">alertCloseNotify</span>&nbsp;<span class="op" id="3919916">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919921">c</span><span class="op" id="3919922">.</span><span class="ident" id="3919923">in</span><span class="op" id="3919925">.</span><span class="ident" id="3919926">setErrorLocked</span><span class="op" id="3919940">(</span><span class="ident" id="3919941">io</span><span class="op" id="3919943">.</span><span class="ident" id="3919944">EOF</span><span class="op" id="3919947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919952">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3919960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919964">switch</span>&nbsp;<span class="ident" id="3919971">data</span><span class="op" id="3919975">[</span><span class="num" id="3919976">0</span><span class="op" id="3919977">]</span>&nbsp;<span class="op" id="3919979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919983">case</span>&nbsp;<span class="ident" id="3919988">alertLevelWarning</span><span class="op" id="3920005">:</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3920010">//&nbsp;drop&nbsp;on&nbsp;the&nbsp;floor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920034">c</span><span class="op" id="3920035">.</span><span class="ident" id="3920036">in</span><span class="op" id="3920038">.</span><span class="ident" id="3920039">freeBlock</span><span class="op" id="3920048">(</span><span class="ident" id="3920049">b</span><span class="op" id="3920050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920055">goto</span>&nbsp;<span class="ident" id="3920060">Again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920068">case</span>&nbsp;<span class="ident" id="3920073">alertLevelError</span><span class="op" id="3920088">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920093">c</span><span class="op" id="3920094">.</span><span class="ident" id="3920095">in</span><span class="op" id="3920097">.</span><span class="ident" id="3920098">setErrorLocked</span><span class="op" id="3920112">(</span><span class="op" id="3920113">&amp;</span><span class="ident" id="3920114">net</span><span class="op" id="3920117">.</span><span class="ident" id="3920118">OpError</span><span class="op" id="3920125">{</span><span class="ident" id="3920126">Op</span><span class="op" id="3920128">:</span>&nbsp;<span class="string" id="3920130">&#34;remote&nbsp;error&#34;</span><span class="op" id="3920144">,</span>&nbsp;<span class="ident" id="3920146">Err</span><span class="op" id="3920149">:</span>&nbsp;<span class="ident" id="3920151">alert</span><span class="op" id="3920156">(</span><span class="ident" id="3920157">data</span><span class="op" id="3920161">[</span><span class="num" id="3920162">1</span><span class="op" id="3920163">]</span><span class="op" id="3920164">)</span><span class="op" id="3920165">}</span><span class="op" id="3920166">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920170">default</span><span class="op" id="3920177">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920182">c</span><span class="op" id="3920183">.</span><span class="ident" id="3920184">in</span><span class="op" id="3920186">.</span><span class="ident" id="3920187">setErrorLocked</span><span class="op" id="3920201">(</span><span class="ident" id="3920202">c</span><span class="op" id="3920203">.</span><span class="ident" id="3920204">sendAlert</span><span class="op" id="3920213">(</span><span class="ident" id="3920214">alertUnexpectedMessage</span><span class="op" id="3920236">)</span><span class="op" id="3920237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920245">case</span>&nbsp;<span class="ident" id="3920250">recordTypeChangeCipherSpec</span><span class="op" id="3920276">:</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920280">if</span>&nbsp;<span class="ident" id="3920283">typ</span>&nbsp;<span class="op" id="3920287">!=</span>&nbsp;<span class="ident" id="3920290">want</span>&nbsp;<span class="op" id="3920295">||</span>&nbsp;<span class="builtinfunc" id="3920298">len</span><span class="op" id="3920301">(</span><span class="ident" id="3920302">data</span><span class="op" id="3920306">)</span>&nbsp;<span class="op" id="3920308">!=</span>&nbsp;<span class="num" id="3920311">1</span>&nbsp;<span class="op" id="3920313">||</span>&nbsp;<span class="ident" id="3920316">data</span><span class="op" id="3920320">[</span><span class="num" id="3920321">0</span><span class="op" id="3920322">]</span>&nbsp;<span class="op" id="3920324">!=</span>&nbsp;<span class="num" id="3920327">1</span>&nbsp;<span class="op" id="3920329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920334">c</span><span class="op" id="3920335">.</span><span class="ident" id="3920336">in</span><span class="op" id="3920338">.</span><span class="ident" id="3920339">setErrorLocked</span><span class="op" id="3920353">(</span><span class="ident" id="3920354">c</span><span class="op" id="3920355">.</span><span class="ident" id="3920356">sendAlert</span><span class="op" id="3920365">(</span><span class="ident" id="3920366">alertUnexpectedMessage</span><span class="op" id="3920388">)</span><span class="op" id="3920389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920394">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920406">err</span>&nbsp;<span class="op" id="3920410">:=</span>&nbsp;<span class="ident" id="3920413">c</span><span class="op" id="3920414">.</span><span class="ident" id="3920415">in</span><span class="op" id="3920417">.</span><span class="ident" id="3920418">changeCipherSpec</span><span class="op" id="3920434">(</span><span class="op" id="3920435">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920439">if</span>&nbsp;<span class="ident" id="3920442">err</span>&nbsp;<span class="op" id="3920446">!=</span>&nbsp;<span class="ident" id="3920449">nil</span>&nbsp;<span class="op" id="3920453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920458">c</span><span class="op" id="3920459">.</span><span class="ident" id="3920460">in</span><span class="op" id="3920462">.</span><span class="ident" id="3920463">setErrorLocked</span><span class="op" id="3920477">(</span><span class="ident" id="3920478">c</span><span class="op" id="3920479">.</span><span class="ident" id="3920480">sendAlert</span><span class="op" id="3920489">(</span><span class="ident" id="3920490">err</span><span class="op" id="3920493">.</span><span class="op" id="3920494">(</span><span class="ident" id="3920495">alert</span><span class="op" id="3920500">)</span><span class="op" id="3920501">)</span><span class="op" id="3920502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920510">case</span>&nbsp;<span class="ident" id="3920515">recordTypeApplicationData</span><span class="op" id="3920540">:</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920544">if</span>&nbsp;<span class="ident" id="3920547">typ</span>&nbsp;<span class="op" id="3920551">!=</span>&nbsp;<span class="ident" id="3920554">want</span>&nbsp;<span class="op" id="3920559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920564">c</span><span class="op" id="3920565">.</span><span class="ident" id="3920566">in</span><span class="op" id="3920568">.</span><span class="ident" id="3920569">setErrorLocked</span><span class="op" id="3920583">(</span><span class="ident" id="3920584">c</span><span class="op" id="3920585">.</span><span class="ident" id="3920586">sendAlert</span><span class="op" id="3920595">(</span><span class="ident" id="3920596">alertUnexpectedMessage</span><span class="op" id="3920618">)</span><span class="op" id="3920619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920624">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920636">c</span><span class="op" id="3920637">.</span><span class="ident" id="3920638">input</span>&nbsp;<span class="op" id="3920644">=</span>&nbsp;<span class="ident" id="3920646">b</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920650">b</span>&nbsp;<span class="op" id="3920652">=</span>&nbsp;<span class="ident" id="3920654">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920660">case</span>&nbsp;<span class="ident" id="3920665">recordTypeHandshake</span><span class="op" id="3920684">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3920688">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;at&nbsp;least&nbsp;pick&nbsp;off&nbsp;connection&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920747">if</span>&nbsp;<span class="ident" id="3920750">typ</span>&nbsp;<span class="op" id="3920754">!=</span>&nbsp;<span class="ident" id="3920757">want</span>&nbsp;<span class="op" id="3920762">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920767">return</span>&nbsp;<span class="ident" id="3920774">c</span><span class="op" id="3920775">.</span><span class="ident" id="3920776">in</span><span class="op" id="3920778">.</span><span class="ident" id="3920779">setErrorLocked</span><span class="op" id="3920793">(</span><span class="ident" id="3920794">c</span><span class="op" id="3920795">.</span><span class="ident" id="3920796">sendAlert</span><span class="op" id="3920805">(</span><span class="ident" id="3920806">alertNoRenegotiation</span><span class="op" id="3920826">)</span><span class="op" id="3920827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920835">c</span><span class="op" id="3920836">.</span><span class="ident" id="3920837">hand</span><span class="op" id="3920841">.</span><span class="ident" id="3920842">Write</span><span class="op" id="3920847">(</span><span class="ident" id="3920848">data</span><span class="op" id="3920852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920859">if</span>&nbsp;<span class="ident" id="3920862">b</span>&nbsp;<span class="op" id="3920864">!=</span>&nbsp;<span class="ident" id="3920867">nil</span>&nbsp;<span class="op" id="3920871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920875">c</span><span class="op" id="3920876">.</span><span class="ident" id="3920877">in</span><span class="op" id="3920879">.</span><span class="ident" id="3920880">freeBlock</span><span class="op" id="3920889">(</span><span class="ident" id="3920890">b</span><span class="op" id="3920891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920897">return</span>&nbsp;<span class="ident" id="3920904">c</span><span class="op" id="3920905">.</span><span class="ident" id="3920906">in</span><span class="op" id="3920908">.</span><span class="ident" id="3920909">err</span><br>
<span class="lineno"></span><span class="op" id="3920913">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="3920916">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno"></span><span class="comment" id="3920956">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="3920977">func</span>&nbsp;<span class="op" id="3920982">(</span><span class="ident" id="3920983">c</span>&nbsp;<span class="op" id="3920985">*</span><span class="ident" id="3920986">Conn</span><span class="op" id="3920990">)</span>&nbsp;<span class="ident" id="3920992">sendAlertLocked</span><span class="op" id="3921007">(</span><span class="ident" id="3921008">err</span>&nbsp;<span class="ident" id="3921012">alert</span><span class="op" id="3921017">)</span>&nbsp;<span class="builtintype" id="3921019">error</span>&nbsp;<span class="op" id="3921025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921028">switch</span>&nbsp;<span class="ident" id="3921035">err</span>&nbsp;<span class="op" id="3921039">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921042">case</span>&nbsp;<span class="ident" id="3921047">alertNoRenegotiation</span><span class="op" id="3921067">,</span>&nbsp;<span class="ident" id="3921069">alertCloseNotify</span><span class="op" id="3921085">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921089">c</span><span class="op" id="3921090">.</span><span class="ident" id="3921091">tmp</span><span class="op" id="3921094">[</span><span class="num" id="3921095">0</span><span class="op" id="3921096">]</span>&nbsp;<span class="op" id="3921098">=</span>&nbsp;<span class="ident" id="3921100">alertLevelWarning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921119">default</span><span class="op" id="3921126">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921130">c</span><span class="op" id="3921131">.</span><span class="ident" id="3921132">tmp</span><span class="op" id="3921135">[</span><span class="num" id="3921136">0</span><span class="op" id="3921137">]</span>&nbsp;<span class="op" id="3921139">=</span>&nbsp;<span class="ident" id="3921141">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921158">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921161">c</span><span class="op" id="3921162">.</span><span class="ident" id="3921163">tmp</span><span class="op" id="3921166">[</span><span class="num" id="3921167">1</span><span class="op" id="3921168">]</span>&nbsp;<span class="op" id="3921170">=</span>&nbsp;<span class="builtintype" id="3921172">byte</span><span class="op" id="3921176">(</span><span class="ident" id="3921177">err</span><span class="op" id="3921180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921183">c</span><span class="op" id="3921184">.</span><span class="ident" id="3921185">writeRecord</span><span class="op" id="3921196">(</span><span class="ident" id="3921197">recordTypeAlert</span><span class="op" id="3921212">,</span>&nbsp;<span class="ident" id="3921214">c</span><span class="op" id="3921215">.</span><span class="ident" id="3921216">tmp</span><span class="op" id="3921219">[</span><span class="num" id="3921220">0</span><span class="op" id="3921221">:</span><span class="num" id="3921222">2</span><span class="op" id="3921223">]</span><span class="op" id="3921224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3921227">//&nbsp;closeNotify&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;in&nbsp;that&nbsp;it&nbsp;isn&#39;t&nbsp;an&nbsp;error:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921288">if</span>&nbsp;<span class="ident" id="3921291">err</span>&nbsp;<span class="op" id="3921295">!=</span>&nbsp;<span class="ident" id="3921298">alertCloseNotify</span>&nbsp;<span class="op" id="3921315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921319">return</span>&nbsp;<span class="ident" id="3921326">c</span><span class="op" id="3921327">.</span><span class="ident" id="3921328">out</span><span class="op" id="3921331">.</span><span class="ident" id="3921332">setErrorLocked</span><span class="op" id="3921346">(</span><span class="op" id="3921347">&amp;</span><span class="ident" id="3921348">net</span><span class="op" id="3921351">.</span><span class="ident" id="3921352">OpError</span><span class="op" id="3921359">{</span><span class="ident" id="3921360">Op</span><span class="op" id="3921362">:</span>&nbsp;<span class="string" id="3921364">&#34;local&nbsp;error&#34;</span><span class="op" id="3921377">,</span>&nbsp;<span class="ident" id="3921379">Err</span><span class="op" id="3921382">:</span>&nbsp;<span class="ident" id="3921384">err</span><span class="op" id="3921387">}</span><span class="op" id="3921388">)</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921394">return</span>&nbsp;<span class="ident" id="3921401">nil</span><br>
<span class="lineno"></span><span class="op" id="3921405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3921408">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno">685</span><span class="comment" id="3921448">//&nbsp;L&nbsp;&lt;&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="3921468">func</span>&nbsp;<span class="op" id="3921473">(</span><span class="ident" id="3921474">c</span>&nbsp;<span class="op" id="3921476">*</span><span class="ident" id="3921477">Conn</span><span class="op" id="3921481">)</span>&nbsp;<span class="ident" id="3921483">sendAlert</span><span class="op" id="3921492">(</span><span class="ident" id="3921493">err</span>&nbsp;<span class="ident" id="3921497">alert</span><span class="op" id="3921502">)</span>&nbsp;<span class="builtintype" id="3921504">error</span>&nbsp;<span class="op" id="3921510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921513">c</span><span class="op" id="3921514">.</span><span class="ident" id="3921515">out</span><span class="op" id="3921518">.</span><span class="ident" id="3921519">Lock</span><span class="op" id="3921523">(</span><span class="op" id="3921524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921527">defer</span>&nbsp;<span class="ident" id="3921533">c</span><span class="op" id="3921534">.</span><span class="ident" id="3921535">out</span><span class="op" id="3921538">.</span><span class="ident" id="3921539">Unlock</span><span class="op" id="3921545">(</span><span class="op" id="3921546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921549">return</span>&nbsp;<span class="ident" id="3921556">c</span><span class="op" id="3921557">.</span><span class="ident" id="3921558">sendAlertLocked</span><span class="op" id="3921573">(</span><span class="ident" id="3921574">err</span><span class="op" id="3921577">)</span><br>
<span class="lineno">690</span><span class="op" id="3921579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3921582">//&nbsp;writeRecord&nbsp;writes&nbsp;a&nbsp;TLS&nbsp;record&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;payload</span><br>
<span class="lineno"></span><span class="comment" id="3921649">//&nbsp;to&nbsp;the&nbsp;connection&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="3921706">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno">695</span><span class="keyword" id="3921727">func</span>&nbsp;<span class="op" id="3921732">(</span><span class="ident" id="3921733">c</span>&nbsp;<span class="op" id="3921735">*</span><span class="ident" id="3921736">Conn</span><span class="op" id="3921740">)</span>&nbsp;<span class="ident" id="3921742">writeRecord</span><span class="op" id="3921753">(</span><span class="ident" id="3921754">typ</span>&nbsp;<span class="ident" id="3921758">recordType</span><span class="op" id="3921768">,</span>&nbsp;<span class="ident" id="3921770">data</span>&nbsp;<span class="op" id="3921775">[</span><span class="op" id="3921776">]</span><span class="builtintype" id="3921777">byte</span><span class="op" id="3921781">)</span>&nbsp;<span class="op" id="3921783">(</span><span class="ident" id="3921784">n</span>&nbsp;<span class="builtintype" id="3921786">int</span><span class="op" id="3921789">,</span>&nbsp;<span class="ident" id="3921791">err</span>&nbsp;<span class="builtintype" id="3921795">error</span><span class="op" id="3921800">)</span>&nbsp;<span class="op" id="3921802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921805">b</span>&nbsp;<span class="op" id="3921807">:=</span>&nbsp;<span class="ident" id="3921810">c</span><span class="op" id="3921811">.</span><span class="ident" id="3921812">out</span><span class="op" id="3921815">.</span><span class="ident" id="3921816">newBlock</span><span class="op" id="3921824">(</span><span class="op" id="3921825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921828">for</span>&nbsp;<span class="builtinfunc" id="3921832">len</span><span class="op" id="3921835">(</span><span class="ident" id="3921836">data</span><span class="op" id="3921840">)</span>&nbsp;<span class="op" id="3921842">&gt;</span>&nbsp;<span class="num" id="3921844">0</span>&nbsp;<span class="op" id="3921846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921850">m</span>&nbsp;<span class="op" id="3921852">:=</span>&nbsp;<span class="builtinfunc" id="3921855">len</span><span class="op" id="3921858">(</span><span class="ident" id="3921859">data</span><span class="op" id="3921863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921867">if</span>&nbsp;<span class="ident" id="3921870">m</span>&nbsp;<span class="op" id="3921872">&gt;</span>&nbsp;<span class="ident" id="3921874">maxPlaintext</span>&nbsp;<span class="op" id="3921887">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921892">m</span>&nbsp;<span class="op" id="3921894">=</span>&nbsp;<span class="ident" id="3921896">maxPlaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921915">explicitIVLen</span>&nbsp;<span class="op" id="3921929">:=</span>&nbsp;<span class="num" id="3921932">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921936">explicitIVIsSeq</span>&nbsp;<span class="op" id="3921952">:=</span>&nbsp;<span class="ident" id="3921955">false</span><br>
<span class="lineno"></span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921964">var</span>&nbsp;<span class="ident" id="3921968">cbc</span>&nbsp;<span class="ident" id="3921972">cbcMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921982">if</span>&nbsp;<span class="ident" id="3921985">c</span><span class="op" id="3921986">.</span><span class="ident" id="3921987">out</span><span class="op" id="3921990">.</span><span class="ident" id="3921991">version</span>&nbsp;<span class="op" id="3921999">&gt;=</span>&nbsp;<span class="ident" id="3922002">VersionTLS11</span>&nbsp;<span class="op" id="3922015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922020">var</span>&nbsp;<span class="ident" id="3922024">ok</span>&nbsp;<span class="builtintype" id="3922027">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922035">if</span>&nbsp;<span class="ident" id="3922038">cbc</span><span class="op" id="3922041">,</span>&nbsp;<span class="ident" id="3922043">ok</span>&nbsp;<span class="op" id="3922046">=</span>&nbsp;<span class="ident" id="3922048">c</span><span class="op" id="3922049">.</span><span class="ident" id="3922050">out</span><span class="op" id="3922053">.</span><span class="ident" id="3922054">cipher</span><span class="op" id="3922060">.</span><span class="op" id="3922061">(</span><span class="ident" id="3922062">cbcMode</span><span class="op" id="3922069">)</span><span class="op" id="3922070">;</span>&nbsp;<span class="ident" id="3922072">ok</span>&nbsp;<span class="op" id="3922075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922081">explicitIVLen</span>&nbsp;<span class="op" id="3922095">=</span>&nbsp;<span class="ident" id="3922097">cbc</span><span class="op" id="3922100">.</span><span class="ident" id="3922101">BlockSize</span><span class="op" id="3922110">(</span><span class="op" id="3922111">)</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922124">if</span>&nbsp;<span class="ident" id="3922127">explicitIVLen</span>&nbsp;<span class="op" id="3922141">==</span>&nbsp;<span class="num" id="3922144">0</span>&nbsp;<span class="op" id="3922146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922151">if</span>&nbsp;<span class="ident" id="3922154">_</span><span class="op" id="3922155">,</span>&nbsp;<span class="ident" id="3922157">ok</span>&nbsp;<span class="op" id="3922160">:=</span>&nbsp;<span class="ident" id="3922163">c</span><span class="op" id="3922164">.</span><span class="ident" id="3922165">out</span><span class="op" id="3922168">.</span><span class="ident" id="3922169">cipher</span><span class="op" id="3922175">.</span><span class="op" id="3922176">(</span><span class="ident" id="3922177">cipher</span><span class="op" id="3922183">.</span><span class="ident" id="3922184">AEAD</span><span class="op" id="3922188">)</span><span class="op" id="3922189">;</span>&nbsp;<span class="ident" id="3922191">ok</span>&nbsp;<span class="op" id="3922194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922200">explicitIVLen</span>&nbsp;<span class="op" id="3922214">=</span>&nbsp;<span class="num" id="3922216">8</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3922222">//&nbsp;The&nbsp;AES-GCM&nbsp;construction&nbsp;in&nbsp;TLS&nbsp;has&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3922268">//&nbsp;explicit&nbsp;nonce&nbsp;so&nbsp;that&nbsp;the&nbsp;nonce&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3922315">//&nbsp;random.&nbsp;However,&nbsp;the&nbsp;nonce&nbsp;is&nbsp;only&nbsp;8&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3922365">//&nbsp;which&nbsp;is&nbsp;too&nbsp;small&nbsp;for&nbsp;a&nbsp;secure,&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3922412">//&nbsp;nonce.&nbsp;Therefore&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3922463">//&nbsp;as&nbsp;the&nbsp;nonce.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922484">explicitIVIsSeq</span>&nbsp;<span class="op" id="3922500">=</span>&nbsp;<span class="ident" id="3922502">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922518">b</span><span class="op" id="3922519">.</span><span class="ident" id="3922520">resize</span><span class="op" id="3922526">(</span><span class="ident" id="3922527">recordHeaderLen</span>&nbsp;<span class="op" id="3922543">+</span>&nbsp;<span class="ident" id="3922545">explicitIVLen</span>&nbsp;<span class="op" id="3922559">+</span>&nbsp;<span class="ident" id="3922561">m</span><span class="op" id="3922562">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922566">b</span><span class="op" id="3922567">.</span><span class="ident" id="3922568">data</span><span class="op" id="3922572">[</span><span class="num" id="3922573">0</span><span class="op" id="3922574">]</span>&nbsp;<span class="op" id="3922576">=</span>&nbsp;<span class="builtintype" id="3922578">byte</span><span class="op" id="3922582">(</span><span class="ident" id="3922583">typ</span><span class="op" id="3922586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922590">vers</span>&nbsp;<span class="op" id="3922595">:=</span>&nbsp;<span class="ident" id="3922598">c</span><span class="op" id="3922599">.</span><span class="ident" id="3922600">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922607">if</span>&nbsp;<span class="ident" id="3922610">vers</span>&nbsp;<span class="op" id="3922615">==</span>&nbsp;<span class="num" id="3922618">0</span>&nbsp;<span class="op" id="3922620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3922625">//&nbsp;Some&nbsp;TLS&nbsp;servers&nbsp;fail&nbsp;if&nbsp;the&nbsp;record&nbsp;version&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3922678">//&nbsp;greater&nbsp;than&nbsp;TLS&nbsp;1.0&nbsp;for&nbsp;the&nbsp;initial&nbsp;ClientHello.</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922734">vers</span>&nbsp;<span class="op" id="3922739">=</span>&nbsp;<span class="ident" id="3922741">VersionTLS10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922760">b</span><span class="op" id="3922761">.</span><span class="ident" id="3922762">data</span><span class="op" id="3922766">[</span><span class="num" id="3922767">1</span><span class="op" id="3922768">]</span>&nbsp;<span class="op" id="3922770">=</span>&nbsp;<span class="builtintype" id="3922772">byte</span><span class="op" id="3922776">(</span><span class="ident" id="3922777">vers</span>&nbsp;<span class="op" id="3922782">&gt;&gt;</span>&nbsp;<span class="num" id="3922785">8</span><span class="op" id="3922786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922790">b</span><span class="op" id="3922791">.</span><span class="ident" id="3922792">data</span><span class="op" id="3922796">[</span><span class="num" id="3922797">2</span><span class="op" id="3922798">]</span>&nbsp;<span class="op" id="3922800">=</span>&nbsp;<span class="builtintype" id="3922802">byte</span><span class="op" id="3922806">(</span><span class="ident" id="3922807">vers</span><span class="op" id="3922811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922815">b</span><span class="op" id="3922816">.</span><span class="ident" id="3922817">data</span><span class="op" id="3922821">[</span><span class="num" id="3922822">3</span><span class="op" id="3922823">]</span>&nbsp;<span class="op" id="3922825">=</span>&nbsp;<span class="builtintype" id="3922827">byte</span><span class="op" id="3922831">(</span><span class="ident" id="3922832">m</span>&nbsp;<span class="op" id="3922834">&gt;&gt;</span>&nbsp;<span class="num" id="3922837">8</span><span class="op" id="3922838">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922842">b</span><span class="op" id="3922843">.</span><span class="ident" id="3922844">data</span><span class="op" id="3922848">[</span><span class="num" id="3922849">4</span><span class="op" id="3922850">]</span>&nbsp;<span class="op" id="3922852">=</span>&nbsp;<span class="builtintype" id="3922854">byte</span><span class="op" id="3922858">(</span><span class="ident" id="3922859">m</span><span class="op" id="3922860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922864">if</span>&nbsp;<span class="ident" id="3922867">explicitIVLen</span>&nbsp;<span class="op" id="3922881">&gt;</span>&nbsp;<span class="num" id="3922883">0</span>&nbsp;<span class="op" id="3922885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922890">explicitIV</span>&nbsp;<span class="op" id="3922901">:=</span>&nbsp;<span class="ident" id="3922904">b</span><span class="op" id="3922905">.</span><span class="ident" id="3922906">data</span><span class="op" id="3922910">[</span><span class="ident" id="3922911">recordHeaderLen</span>&nbsp;<span class="op" id="3922927">:</span>&nbsp;<span class="ident" id="3922929">recordHeaderLen</span><span class="op" id="3922944">+</span><span class="ident" id="3922945">explicitIVLen</span><span class="op" id="3922958">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922963">if</span>&nbsp;<span class="ident" id="3922966">explicitIVIsSeq</span>&nbsp;<span class="op" id="3922982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3922988">copy</span><span class="op" id="3922992">(</span><span class="ident" id="3922993">explicitIV</span><span class="op" id="3923003">,</span>&nbsp;<span class="ident" id="3923005">c</span><span class="op" id="3923006">.</span><span class="ident" id="3923007">out</span><span class="op" id="3923010">.</span><span class="ident" id="3923011">seq</span><span class="op" id="3923014">[</span><span class="op" id="3923015">:</span><span class="op" id="3923016">]</span><span class="op" id="3923017">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3923022">}</span>&nbsp;<span class="keyword" id="3923024">else</span>&nbsp;<span class="op" id="3923029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923035">if</span>&nbsp;<span class="ident" id="3923038">_</span><span class="op" id="3923039">,</span>&nbsp;<span class="ident" id="3923041">err</span>&nbsp;<span class="op" id="3923045">=</span>&nbsp;<span class="ident" id="3923047">io</span><span class="op" id="3923049">.</span><span class="ident" id="3923050">ReadFull</span><span class="op" id="3923058">(</span><span class="ident" id="3923059">c</span><span class="op" id="3923060">.</span><span class="ident" id="3923061">config</span><span class="op" id="3923067">.</span><span class="ident" id="3923068">rand</span><span class="op" id="3923072">(</span><span class="op" id="3923073">)</span><span class="op" id="3923074">,</span>&nbsp;<span class="ident" id="3923076">explicitIV</span><span class="op" id="3923086">)</span><span class="op" id="3923087">;</span>&nbsp;<span class="ident" id="3923089">err</span>&nbsp;<span class="op" id="3923093">!=</span>&nbsp;<span class="ident" id="3923096">nil</span>&nbsp;<span class="op" id="3923100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923107">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3923117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3923122">}</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3923126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3923130">copy</span><span class="op" id="3923134">(</span><span class="ident" id="3923135">b</span><span class="op" id="3923136">.</span><span class="ident" id="3923137">data</span><span class="op" id="3923141">[</span><span class="ident" id="3923142">recordHeaderLen</span><span class="op" id="3923157">+</span><span class="ident" id="3923158">explicitIVLen</span><span class="op" id="3923171">:</span><span class="op" id="3923172">]</span><span class="op" id="3923173">,</span>&nbsp;<span class="ident" id="3923175">data</span><span class="op" id="3923179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923183">c</span><span class="op" id="3923184">.</span><span class="ident" id="3923185">out</span><span class="op" id="3923188">.</span><span class="ident" id="3923189">encrypt</span><span class="op" id="3923196">(</span><span class="ident" id="3923197">b</span><span class="op" id="3923198">,</span>&nbsp;<span class="ident" id="3923200">explicitIVLen</span><span class="op" id="3923213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923217">_</span><span class="op" id="3923218">,</span>&nbsp;<span class="ident" id="3923220">err</span>&nbsp;<span class="op" id="3923224">=</span>&nbsp;<span class="ident" id="3923226">c</span><span class="op" id="3923227">.</span><span class="ident" id="3923228">conn</span><span class="op" id="3923232">.</span><span class="ident" id="3923233">Write</span><span class="op" id="3923238">(</span><span class="ident" id="3923239">b</span><span class="op" id="3923240">.</span><span class="ident" id="3923241">data</span><span class="op" id="3923245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923249">if</span>&nbsp;<span class="ident" id="3923252">err</span>&nbsp;<span class="op" id="3923256">!=</span>&nbsp;<span class="ident" id="3923259">nil</span>&nbsp;<span class="op" id="3923263">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923268">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3923276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923280">n</span>&nbsp;<span class="op" id="3923282">+=</span>&nbsp;<span class="ident" id="3923285">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923289">data</span>&nbsp;<span class="op" id="3923294">=</span>&nbsp;<span class="ident" id="3923296">data</span><span class="op" id="3923300">[</span><span class="ident" id="3923301">m</span><span class="op" id="3923302">:</span><span class="op" id="3923303">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3923306">}</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923309">c</span><span class="op" id="3923310">.</span><span class="ident" id="3923311">out</span><span class="op" id="3923314">.</span><span class="ident" id="3923315">freeBlock</span><span class="op" id="3923324">(</span><span class="ident" id="3923325">b</span><span class="op" id="3923326">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923330">if</span>&nbsp;<span class="ident" id="3923333">typ</span>&nbsp;<span class="op" id="3923337">==</span>&nbsp;<span class="ident" id="3923340">recordTypeChangeCipherSpec</span>&nbsp;<span class="op" id="3923367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923371">err</span>&nbsp;<span class="op" id="3923375">=</span>&nbsp;<span class="ident" id="3923377">c</span><span class="op" id="3923378">.</span><span class="ident" id="3923379">out</span><span class="op" id="3923382">.</span><span class="ident" id="3923383">changeCipherSpec</span><span class="op" id="3923399">(</span><span class="op" id="3923400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923404">if</span>&nbsp;<span class="ident" id="3923407">err</span>&nbsp;<span class="op" id="3923411">!=</span>&nbsp;<span class="ident" id="3923414">nil</span>&nbsp;<span class="op" id="3923418">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3923423">//&nbsp;Cannot&nbsp;call&nbsp;sendAlert&nbsp;directly,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3923461">//&nbsp;because&nbsp;we&nbsp;already&nbsp;hold&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923504">c</span><span class="op" id="3923505">.</span><span class="ident" id="3923506">tmp</span><span class="op" id="3923509">[</span><span class="num" id="3923510">0</span><span class="op" id="3923511">]</span>&nbsp;<span class="op" id="3923513">=</span>&nbsp;<span class="ident" id="3923515">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923534">c</span><span class="op" id="3923535">.</span><span class="ident" id="3923536">tmp</span><span class="op" id="3923539">[</span><span class="num" id="3923540">1</span><span class="op" id="3923541">]</span>&nbsp;<span class="op" id="3923543">=</span>&nbsp;<span class="builtintype" id="3923545">byte</span><span class="op" id="3923549">(</span><span class="ident" id="3923550">err</span><span class="op" id="3923553">.</span><span class="op" id="3923554">(</span><span class="ident" id="3923555">alert</span><span class="op" id="3923560">)</span><span class="op" id="3923561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923566">c</span><span class="op" id="3923567">.</span><span class="ident" id="3923568">writeRecord</span><span class="op" id="3923579">(</span><span class="ident" id="3923580">recordTypeAlert</span><span class="op" id="3923595">,</span>&nbsp;<span class="ident" id="3923597">c</span><span class="op" id="3923598">.</span><span class="ident" id="3923599">tmp</span><span class="op" id="3923602">[</span><span class="num" id="3923603">0</span><span class="op" id="3923604">:</span><span class="num" id="3923605">2</span><span class="op" id="3923606">]</span><span class="op" id="3923607">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923612">return</span>&nbsp;<span class="ident" id="3923619">n</span><span class="op" id="3923620">,</span>&nbsp;<span class="ident" id="3923622">c</span><span class="op" id="3923623">.</span><span class="ident" id="3923624">out</span><span class="op" id="3923627">.</span><span class="ident" id="3923628">setErrorLocked</span><span class="op" id="3923642">(</span><span class="op" id="3923643">&amp;</span><span class="ident" id="3923644">net</span><span class="op" id="3923647">.</span><span class="ident" id="3923648">OpError</span><span class="op" id="3923655">{</span><span class="ident" id="3923656">Op</span><span class="op" id="3923658">:</span>&nbsp;<span class="string" id="3923660">&#34;local&nbsp;error&#34;</span><span class="op" id="3923673">,</span>&nbsp;<span class="ident" id="3923675">Err</span><span class="op" id="3923678">:</span>&nbsp;<span class="ident" id="3923680">err</span><span class="op" id="3923683">}</span><span class="op" id="3923684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3923688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3923691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923694">return</span><br>
<span class="lineno"></span><span class="op" id="3923701">}</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="3923704">//&nbsp;readHandshake&nbsp;reads&nbsp;the&nbsp;next&nbsp;handshake&nbsp;message&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="3923759">//&nbsp;the&nbsp;record&nbsp;layer.</span><br>
<span class="lineno"></span><span class="comment" id="3923780">//&nbsp;c.in.Mutex&nbsp;&lt;&nbsp;L;&nbsp;c.out.Mutex&nbsp;&lt;&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="3923816">func</span>&nbsp;<span class="op" id="3923821">(</span><span class="ident" id="3923822">c</span>&nbsp;<span class="op" id="3923824">*</span><span class="ident" id="3923825">Conn</span><span class="op" id="3923829">)</span>&nbsp;<span class="ident" id="3923831">readHandshake</span><span class="op" id="3923844">(</span><span class="op" id="3923845">)</span>&nbsp;<span class="op" id="3923847">(</span><span class="keyword" id="3923848">interface</span><span class="op" id="3923857">{</span><span class="op" id="3923858">}</span><span class="op" id="3923859">,</span>&nbsp;<span class="builtintype" id="3923861">error</span><span class="op" id="3923866">)</span>&nbsp;<span class="op" id="3923868">{</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923871">for</span>&nbsp;<span class="ident" id="3923875">c</span><span class="op" id="3923876">.</span><span class="ident" id="3923877">hand</span><span class="op" id="3923881">.</span><span class="ident" id="3923882">Len</span><span class="op" id="3923885">(</span><span class="op" id="3923886">)</span>&nbsp;<span class="op" id="3923888">&lt;</span>&nbsp;<span class="num" id="3923890">4</span>&nbsp;<span class="op" id="3923892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923896">if</span>&nbsp;<span class="ident" id="3923899">err</span>&nbsp;<span class="op" id="3923903">:=</span>&nbsp;<span class="ident" id="3923906">c</span><span class="op" id="3923907">.</span><span class="ident" id="3923908">in</span><span class="op" id="3923910">.</span><span class="ident" id="3923911">err</span><span class="op" id="3923914">;</span>&nbsp;<span class="ident" id="3923916">err</span>&nbsp;<span class="op" id="3923920">!=</span>&nbsp;<span class="ident" id="3923923">nil</span>&nbsp;<span class="op" id="3923927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923932">return</span>&nbsp;<span class="ident" id="3923939">nil</span><span class="op" id="3923942">,</span>&nbsp;<span class="ident" id="3923944">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3923950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923954">if</span>&nbsp;<span class="ident" id="3923957">err</span>&nbsp;<span class="op" id="3923961">:=</span>&nbsp;<span class="ident" id="3923964">c</span><span class="op" id="3923965">.</span><span class="ident" id="3923966">readRecord</span><span class="op" id="3923976">(</span><span class="ident" id="3923977">recordTypeHandshake</span><span class="op" id="3923996">)</span><span class="op" id="3923997">;</span>&nbsp;<span class="ident" id="3923999">err</span>&nbsp;<span class="op" id="3924003">!=</span>&nbsp;<span class="ident" id="3924006">nil</span>&nbsp;<span class="op" id="3924010">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924015">return</span>&nbsp;<span class="ident" id="3924022">nil</span><span class="op" id="3924025">,</span>&nbsp;<span class="ident" id="3924027">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3924033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3924036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924040">data</span>&nbsp;<span class="op" id="3924045">:=</span>&nbsp;<span class="ident" id="3924048">c</span><span class="op" id="3924049">.</span><span class="ident" id="3924050">hand</span><span class="op" id="3924054">.</span><span class="ident" id="3924055">Bytes</span><span class="op" id="3924060">(</span><span class="op" id="3924061">)</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924064">n</span>&nbsp;<span class="op" id="3924066">:=</span>&nbsp;<span class="builtintype" id="3924069">int</span><span class="op" id="3924072">(</span><span class="ident" id="3924073">data</span><span class="op" id="3924077">[</span><span class="num" id="3924078">1</span><span class="op" id="3924079">]</span><span class="op" id="3924080">)</span><span class="op" id="3924081">&lt;&lt;</span><span class="num" id="3924083">16</span>&nbsp;<span class="op" id="3924086">|</span>&nbsp;<span class="builtintype" id="3924088">int</span><span class="op" id="3924091">(</span><span class="ident" id="3924092">data</span><span class="op" id="3924096">[</span><span class="num" id="3924097">2</span><span class="op" id="3924098">]</span><span class="op" id="3924099">)</span><span class="op" id="3924100">&lt;&lt;</span><span class="num" id="3924102">8</span>&nbsp;<span class="op" id="3924104">|</span>&nbsp;<span class="builtintype" id="3924106">int</span><span class="op" id="3924109">(</span><span class="ident" id="3924110">data</span><span class="op" id="3924114">[</span><span class="num" id="3924115">3</span><span class="op" id="3924116">]</span><span class="op" id="3924117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924120">if</span>&nbsp;<span class="ident" id="3924123">n</span>&nbsp;<span class="op" id="3924125">&gt;</span>&nbsp;<span class="ident" id="3924127">maxHandshake</span>&nbsp;<span class="op" id="3924140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924144">return</span>&nbsp;<span class="ident" id="3924151">nil</span><span class="op" id="3924154">,</span>&nbsp;<span class="ident" id="3924156">c</span><span class="op" id="3924157">.</span><span class="ident" id="3924158">in</span><span class="op" id="3924160">.</span><span class="ident" id="3924161">setErrorLocked</span><span class="op" id="3924175">(</span><span class="ident" id="3924176">c</span><span class="op" id="3924177">.</span><span class="ident" id="3924178">sendAlert</span><span class="op" id="3924187">(</span><span class="ident" id="3924188">alertInternalError</span><span class="op" id="3924206">)</span><span class="op" id="3924207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3924210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924213">for</span>&nbsp;<span class="ident" id="3924217">c</span><span class="op" id="3924218">.</span><span class="ident" id="3924219">hand</span><span class="op" id="3924223">.</span><span class="ident" id="3924224">Len</span><span class="op" id="3924227">(</span><span class="op" id="3924228">)</span>&nbsp;<span class="op" id="3924230">&lt;</span>&nbsp;<span class="num" id="3924232">4</span><span class="op" id="3924233">+</span><span class="ident" id="3924234">n</span>&nbsp;<span class="op" id="3924236">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924240">if</span>&nbsp;<span class="ident" id="3924243">err</span>&nbsp;<span class="op" id="3924247">:=</span>&nbsp;<span class="ident" id="3924250">c</span><span class="op" id="3924251">.</span><span class="ident" id="3924252">in</span><span class="op" id="3924254">.</span><span class="ident" id="3924255">err</span><span class="op" id="3924258">;</span>&nbsp;<span class="ident" id="3924260">err</span>&nbsp;<span class="op" id="3924264">!=</span>&nbsp;<span class="ident" id="3924267">nil</span>&nbsp;<span class="op" id="3924271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924276">return</span>&nbsp;<span class="ident" id="3924283">nil</span><span class="op" id="3924286">,</span>&nbsp;<span class="ident" id="3924288">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3924294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924298">if</span>&nbsp;<span class="ident" id="3924301">err</span>&nbsp;<span class="op" id="3924305">:=</span>&nbsp;<span class="ident" id="3924308">c</span><span class="op" id="3924309">.</span><span class="ident" id="3924310">readRecord</span><span class="op" id="3924320">(</span><span class="ident" id="3924321">recordTypeHandshake</span><span class="op" id="3924340">)</span><span class="op" id="3924341">;</span>&nbsp;<span class="ident" id="3924343">err</span>&nbsp;<span class="op" id="3924347">!=</span>&nbsp;<span class="ident" id="3924350">nil</span>&nbsp;<span class="op" id="3924354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924359">return</span>&nbsp;<span class="ident" id="3924366">nil</span><span class="op" id="3924369">,</span>&nbsp;<span class="ident" id="3924371">err</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3924377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3924380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924383">data</span>&nbsp;<span class="op" id="3924388">=</span>&nbsp;<span class="ident" id="3924390">c</span><span class="op" id="3924391">.</span><span class="ident" id="3924392">hand</span><span class="op" id="3924396">.</span><span class="ident" id="3924397">Next</span><span class="op" id="3924401">(</span><span class="num" id="3924402">4</span>&nbsp;<span class="op" id="3924404">+</span>&nbsp;<span class="ident" id="3924406">n</span><span class="op" id="3924407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924410">var</span>&nbsp;<span class="ident" id="3924414">m</span>&nbsp;<span class="ident" id="3924416">handshakeMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924434">switch</span>&nbsp;<span class="ident" id="3924441">data</span><span class="op" id="3924445">[</span><span class="num" id="3924446">0</span><span class="op" id="3924447">]</span>&nbsp;<span class="op" id="3924449">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924452">case</span>&nbsp;<span class="ident" id="3924457">typeClientHello</span><span class="op" id="3924472">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924476">m</span>&nbsp;<span class="op" id="3924478">=</span>&nbsp;<span class="builtinfunc" id="3924480">new</span><span class="op" id="3924483">(</span><span class="ident" id="3924484">clientHelloMsg</span><span class="op" id="3924498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924501">case</span>&nbsp;<span class="ident" id="3924506">typeServerHello</span><span class="op" id="3924521">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924525">m</span>&nbsp;<span class="op" id="3924527">=</span>&nbsp;<span class="builtinfunc" id="3924529">new</span><span class="op" id="3924532">(</span><span class="ident" id="3924533">serverHelloMsg</span><span class="op" id="3924547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924550">case</span>&nbsp;<span class="ident" id="3924555">typeNewSessionTicket</span><span class="op" id="3924575">:</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924579">m</span>&nbsp;<span class="op" id="3924581">=</span>&nbsp;<span class="builtinfunc" id="3924583">new</span><span class="op" id="3924586">(</span><span class="ident" id="3924587">newSessionTicketMsg</span><span class="op" id="3924606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924609">case</span>&nbsp;<span class="ident" id="3924614">typeCertificate</span><span class="op" id="3924629">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924633">m</span>&nbsp;<span class="op" id="3924635">=</span>&nbsp;<span class="builtinfunc" id="3924637">new</span><span class="op" id="3924640">(</span><span class="ident" id="3924641">certificateMsg</span><span class="op" id="3924655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924658">case</span>&nbsp;<span class="ident" id="3924663">typeCertificateRequest</span><span class="op" id="3924685">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924689">m</span>&nbsp;<span class="op" id="3924691">=</span>&nbsp;<span class="op" id="3924693">&amp;</span><span class="ident" id="3924694">certificateRequestMsg</span><span class="op" id="3924715">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924720">hasSignatureAndHash</span><span class="op" id="3924739">:</span>&nbsp;<span class="ident" id="3924741">c</span><span class="op" id="3924742">.</span><span class="ident" id="3924743">vers</span>&nbsp;<span class="op" id="3924748">&gt;=</span>&nbsp;<span class="ident" id="3924751">VersionTLS12</span><span class="op" id="3924763">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3924767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924770">case</span>&nbsp;<span class="ident" id="3924775">typeCertificateStatus</span><span class="op" id="3924796">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924800">m</span>&nbsp;<span class="op" id="3924802">=</span>&nbsp;<span class="builtinfunc" id="3924804">new</span><span class="op" id="3924807">(</span><span class="ident" id="3924808">certificateStatusMsg</span><span class="op" id="3924828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924831">case</span>&nbsp;<span class="ident" id="3924836">typeServerKeyExchange</span><span class="op" id="3924857">:</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924861">m</span>&nbsp;<span class="op" id="3924863">=</span>&nbsp;<span class="builtinfunc" id="3924865">new</span><span class="op" id="3924868">(</span><span class="ident" id="3924869">serverKeyExchangeMsg</span><span class="op" id="3924889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924892">case</span>&nbsp;<span class="ident" id="3924897">typeServerHelloDone</span><span class="op" id="3924916">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924920">m</span>&nbsp;<span class="op" id="3924922">=</span>&nbsp;<span class="builtinfunc" id="3924924">new</span><span class="op" id="3924927">(</span><span class="ident" id="3924928">serverHelloDoneMsg</span><span class="op" id="3924946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924949">case</span>&nbsp;<span class="ident" id="3924954">typeClientKeyExchange</span><span class="op" id="3924975">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924979">m</span>&nbsp;<span class="op" id="3924981">=</span>&nbsp;<span class="builtinfunc" id="3924983">new</span><span class="op" id="3924986">(</span><span class="ident" id="3924987">clientKeyExchangeMsg</span><span class="op" id="3925007">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925010">case</span>&nbsp;<span class="ident" id="3925015">typeCertificateVerify</span><span class="op" id="3925036">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3925040">m</span>&nbsp;<span class="op" id="3925042">=</span>&nbsp;<span class="op" id="3925044">&amp;</span><span class="ident" id="3925045">certificateVerifyMsg</span><span class="op" id="3925065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3925070">hasSignatureAndHash</span><span class="op" id="3925089">:</span>&nbsp;<span class="ident" id="3925091">c</span><span class="op" id="3925092">.</span><span class="ident" id="3925093">vers</span>&nbsp;<span class="op" id="3925098">&gt;=</span>&nbsp;<span class="ident" id="3925101">VersionTLS12</span><span class="op" id="3925113">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3925117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925120">case</span>&nbsp;<span class="ident" id="3925125">typeNextProtocol</span><span class="op" id="3925141">:</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3925145">m</span>&nbsp;<span class="op" id="3925147">=</span>&nbsp;<span class="builtinfunc" id="3925149">new</span><span class="op" id="3925152">(</span><span class="ident" id="3925153">nextProtoMsg</span><span class="op" id="3925165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925168">case</span>&nbsp;<span class="ident" id="3925173">typeFinished</span><span class="op" id="3925185">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3925189">m</span>&nbsp;<span class="op" id="3925191">=</span>&nbsp;<span class="builtinfunc" id="3925193">new</span><span class="op" id="3925196">(</span><span class="ident" id="3925197">finishedMsg</span><span class="op" id="3925208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925211">default</span><span class="op" id="3925218">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925222">return</span>&nbsp;<span class="ident" id="3925229">nil</span><span class="op" id="3925232">,</span>&nbsp;<span class="ident" id="3925234">c</span><span class="op" id="3925235">.</span><span class="ident" id="3925236">in</span><span class="op" id="3925238">.</span><span class="ident" id="3925239">setErrorLocked</span><span class="op" id="3925253">(</span><span class="ident" id="3925254">c</span><span class="op" id="3925255">.</span><span class="ident" id="3925256">sendAlert</span><span class="op" id="3925265">(</span><span class="ident" id="3925266">alertUnexpectedMessage</span><span class="op" id="3925288">)</span><span class="op" id="3925289">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3925292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3925296">//&nbsp;The&nbsp;handshake&nbsp;message&nbsp;unmarshallers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3925336">//&nbsp;expect&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;keep&nbsp;references&nbsp;to&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3925386">//&nbsp;so&nbsp;pass&nbsp;in&nbsp;a&nbsp;fresh&nbsp;copy&nbsp;that&nbsp;won&#39;t&nbsp;be&nbsp;overwritten.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3925441">data</span>&nbsp;<span class="op" id="3925446">=</span>&nbsp;<span class="builtinfunc" id="3925448">append</span><span class="op" id="3925454">(</span><span class="op" id="3925455">[</span><span class="op" id="3925456">]</span><span class="builtintype" id="3925457">byte</span><span class="op" id="3925461">(</span><span class="ident" id="3925462">nil</span><span class="op" id="3925465">)</span><span class="op" id="3925466">,</span>&nbsp;<span class="ident" id="3925468">data</span><span class="op" id="3925472">...</span><span class="op" id="3925475">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925479">if</span>&nbsp;<span class="op" id="3925482">!</span><span class="ident" id="3925483">m</span><span class="op" id="3925484">.</span><span class="ident" id="3925485">unmarshal</span><span class="op" id="3925494">(</span><span class="ident" id="3925495">data</span><span class="op" id="3925499">)</span>&nbsp;<span class="op" id="3925501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925505">return</span>&nbsp;<span class="ident" id="3925512">nil</span><span class="op" id="3925515">,</span>&nbsp;<span class="ident" id="3925517">c</span><span class="op" id="3925518">.</span><span class="ident" id="3925519">in</span><span class="op" id="3925521">.</span><span class="ident" id="3925522">setErrorLocked</span><span class="op" id="3925536">(</span><span class="ident" id="3925537">c</span><span class="op" id="3925538">.</span><span class="ident" id="3925539">sendAlert</span><span class="op" id="3925548">(</span><span class="ident" id="3925549">alertUnexpectedMessage</span><span class="op" id="3925571">)</span><span class="op" id="3925572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3925575">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925578">return</span>&nbsp;<span class="ident" id="3925585">m</span><span class="op" id="3925586">,</span>&nbsp;<span class="ident" id="3925588">nil</span><br>
<span class="lineno"></span><span class="op" id="3925592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3925595">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3925635">func</span>&nbsp;<span class="op" id="3925640">(</span><span class="ident" id="3925641">c</span>&nbsp;<span class="op" id="3925643">*</span><span class="ident" id="3925644">Conn</span><span class="op" id="3925648">)</span>&nbsp;<span class="ident" id="3925650">Write</span><span class="op" id="3925655">(</span><span class="ident" id="3925656">b</span>&nbsp;<span class="op" id="3925658">[</span><span class="op" id="3925659">]</span><span class="builtintype" id="3925660">byte</span><span class="op" id="3925664">)</span>&nbsp;<span class="op" id="3925666">(</span><span class="builtintype" id="3925667">int</span><span class="op" id="3925670">,</span>&nbsp;<span class="builtintype" id="3925672">error</span><span class="op" id="3925677">)</span>&nbsp;<span class="op" id="3925679">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925682">if</span>&nbsp;<span class="ident" id="3925685">err</span>&nbsp;<span class="op" id="3925689">:=</span>&nbsp;<span class="ident" id="3925692">c</span><span class="op" id="3925693">.</span><span class="ident" id="3925694">Handshake</span><span class="op" id="3925703">(</span><span class="op" id="3925704">)</span><span class="op" id="3925705">;</span>&nbsp;<span class="ident" id="3925707">err</span>&nbsp;<span class="op" id="3925711">!=</span>&nbsp;<span class="ident" id="3925714">nil</span>&nbsp;<span class="op" id="3925718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925722">return</span>&nbsp;<span class="num" id="3925729">0</span><span class="op" id="3925730">,</span>&nbsp;<span class="ident" id="3925732">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3925737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3925741">c</span><span class="op" id="3925742">.</span><span class="ident" id="3925743">out</span><span class="op" id="3925746">.</span><span class="ident" id="3925747">Lock</span><span class="op" id="3925751">(</span><span class="op" id="3925752">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925755">defer</span>&nbsp;<span class="ident" id="3925761">c</span><span class="op" id="3925762">.</span><span class="ident" id="3925763">out</span><span class="op" id="3925766">.</span><span class="ident" id="3925767">Unlock</span><span class="op" id="3925773">(</span><span class="op" id="3925774">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925778">if</span>&nbsp;<span class="ident" id="3925781">err</span>&nbsp;<span class="op" id="3925785">:=</span>&nbsp;<span class="ident" id="3925788">c</span><span class="op" id="3925789">.</span><span class="ident" id="3925790">out</span><span class="op" id="3925793">.</span><span class="ident" id="3925794">err</span><span class="op" id="3925797">;</span>&nbsp;<span class="ident" id="3925799">err</span>&nbsp;<span class="op" id="3925803">!=</span>&nbsp;<span class="ident" id="3925806">nil</span>&nbsp;<span class="op" id="3925810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925814">return</span>&nbsp;<span class="num" id="3925821">0</span><span class="op" id="3925822">,</span>&nbsp;<span class="ident" id="3925824">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3925829">}</span><br>
<span class="lineno">855</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925833">if</span>&nbsp;<span class="op" id="3925836">!</span><span class="ident" id="3925837">c</span><span class="op" id="3925838">.</span><span class="ident" id="3925839">handshakeComplete</span>&nbsp;<span class="op" id="3925857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3925861">return</span>&nbsp;<span class="num" id="3925868">0</span><span class="op" id="3925869">,</span>&nbsp;<span class="ident" id="3925871">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3925891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3925895">//&nbsp;SSL&nbsp;3.0&nbsp;and&nbsp;TLS&nbsp;1.0&nbsp;are&nbsp;susceptible&nbsp;to&nbsp;a&nbsp;chosen-plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3925957">//&nbsp;attack&nbsp;when&nbsp;using&nbsp;block&nbsp;mode&nbsp;ciphers&nbsp;due&nbsp;to&nbsp;predictable&nbsp;IVs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926022">//&nbsp;This&nbsp;can&nbsp;be&nbsp;prevented&nbsp;by&nbsp;splitting&nbsp;each&nbsp;Application&nbsp;Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926083">//&nbsp;record&nbsp;into&nbsp;two&nbsp;records,&nbsp;effectively&nbsp;randomizing&nbsp;the&nbsp;IV.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926144">//</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926148">//&nbsp;http://www.openssl.org/~bodo/tls-cbc.txt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926193">//&nbsp;https://bugzilla.mozilla.org/show_bug.cgi?id=665814</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926249">//&nbsp;http://www.imperialviolet.org/2012/01/15/beastfollowup.html</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3926314">var</span>&nbsp;<span class="ident" id="3926318">m</span>&nbsp;<span class="builtintype" id="3926320">int</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3926325">if</span>&nbsp;<span class="builtinfunc" id="3926328">len</span><span class="op" id="3926331">(</span><span class="ident" id="3926332">b</span><span class="op" id="3926333">)</span>&nbsp;<span class="op" id="3926335">&gt;</span>&nbsp;<span class="num" id="3926337">1</span>&nbsp;<span class="op" id="3926339">&amp;&amp;</span>&nbsp;<span class="ident" id="3926342">c</span><span class="op" id="3926343">.</span><span class="ident" id="3926344">vers</span>&nbsp;<span class="op" id="3926349">&lt;=</span>&nbsp;<span class="ident" id="3926352">VersionTLS10</span>&nbsp;<span class="op" id="3926365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3926369">if</span>&nbsp;<span class="ident" id="3926372">_</span><span class="op" id="3926373">,</span>&nbsp;<span class="ident" id="3926375">ok</span>&nbsp;<span class="op" id="3926378">:=</span>&nbsp;<span class="ident" id="3926381">c</span><span class="op" id="3926382">.</span><span class="ident" id="3926383">out</span><span class="op" id="3926386">.</span><span class="ident" id="3926387">cipher</span><span class="op" id="3926393">.</span><span class="op" id="3926394">(</span><span class="ident" id="3926395">cipher</span><span class="op" id="3926401">.</span><span class="ident" id="3926402">BlockMode</span><span class="op" id="3926411">)</span><span class="op" id="3926412">;</span>&nbsp;<span class="ident" id="3926414">ok</span>&nbsp;<span class="op" id="3926417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3926422">n</span><span class="op" id="3926423">,</span>&nbsp;<span class="ident" id="3926425">err</span>&nbsp;<span class="op" id="3926429">:=</span>&nbsp;<span class="ident" id="3926432">c</span><span class="op" id="3926433">.</span><span class="ident" id="3926434">writeRecord</span><span class="op" id="3926445">(</span><span class="ident" id="3926446">recordTypeApplicationData</span><span class="op" id="3926471">,</span>&nbsp;<span class="ident" id="3926473">b</span><span class="op" id="3926474">[</span><span class="op" id="3926475">:</span><span class="num" id="3926476">1</span><span class="op" id="3926477">]</span><span class="op" id="3926478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3926483">if</span>&nbsp;<span class="ident" id="3926486">err</span>&nbsp;<span class="op" id="3926490">!=</span>&nbsp;<span class="ident" id="3926493">nil</span>&nbsp;<span class="op" id="3926497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3926503">return</span>&nbsp;<span class="ident" id="3926510">n</span><span class="op" id="3926511">,</span>&nbsp;<span class="ident" id="3926513">c</span><span class="op" id="3926514">.</span><span class="ident" id="3926515">out</span><span class="op" id="3926518">.</span><span class="ident" id="3926519">setErrorLocked</span><span class="op" id="3926533">(</span><span class="ident" id="3926534">err</span><span class="op" id="3926537">)</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3926542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3926547">m</span><span class="op" id="3926548">,</span>&nbsp;<span class="ident" id="3926550">b</span>&nbsp;<span class="op" id="3926552">=</span>&nbsp;<span class="num" id="3926554">1</span><span class="op" id="3926555">,</span>&nbsp;<span class="ident" id="3926557">b</span><span class="op" id="3926558">[</span><span class="num" id="3926559">1</span><span class="op" id="3926560">:</span><span class="op" id="3926561">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3926565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3926568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3926572">n</span><span class="op" id="3926573">,</span>&nbsp;<span class="ident" id="3926575">err</span>&nbsp;<span class="op" id="3926579">:=</span>&nbsp;<span class="ident" id="3926582">c</span><span class="op" id="3926583">.</span><span class="ident" id="3926584">writeRecord</span><span class="op" id="3926595">(</span><span class="ident" id="3926596">recordTypeApplicationData</span><span class="op" id="3926621">,</span>&nbsp;<span class="ident" id="3926623">b</span><span class="op" id="3926624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3926627">return</span>&nbsp;<span class="ident" id="3926634">n</span>&nbsp;<span class="op" id="3926636">+</span>&nbsp;<span class="ident" id="3926638">m</span><span class="op" id="3926639">,</span>&nbsp;<span class="ident" id="3926641">c</span><span class="op" id="3926642">.</span><span class="ident" id="3926643">out</span><span class="op" id="3926646">.</span><span class="ident" id="3926647">setErrorLocked</span><span class="op" id="3926661">(</span><span class="ident" id="3926662">err</span><span class="op" id="3926665">)</span><br>
<span class="lineno"></span><span class="op" id="3926667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3926670">//&nbsp;Read&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;a&nbsp;net.Error&nbsp;with&nbsp;Timeout()&nbsp;==&nbsp;true</span><br>
<span class="lineno">885</span><span class="comment" id="3926748">//&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and&nbsp;SetReadDeadline.</span><br>
<span class="lineno"></span><span class="keyword" id="3926814">func</span>&nbsp;<span class="op" id="3926819">(</span><span class="ident" id="3926820">c</span>&nbsp;<span class="op" id="3926822">*</span><span class="ident" id="3926823">Conn</span><span class="op" id="3926827">)</span>&nbsp;<span class="ident" id="3926829">Read</span><span class="op" id="3926833">(</span><span class="ident" id="3926834">b</span>&nbsp;<span class="op" id="3926836">[</span><span class="op" id="3926837">]</span><span class="builtintype" id="3926838">byte</span><span class="op" id="3926842">)</span>&nbsp;<span class="op" id="3926844">(</span><span class="ident" id="3926845">n</span>&nbsp;<span class="builtintype" id="3926847">int</span><span class="op" id="3926850">,</span>&nbsp;<span class="ident" id="3926852">err</span>&nbsp;<span class="builtintype" id="3926856">error</span><span class="op" id="3926861">)</span>&nbsp;<span class="op" id="3926863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3926866">if</span>&nbsp;<span class="ident" id="3926869">err</span>&nbsp;<span class="op" id="3926873">=</span>&nbsp;<span class="ident" id="3926875">c</span><span class="op" id="3926876">.</span><span class="ident" id="3926877">Handshake</span><span class="op" id="3926886">(</span><span class="op" id="3926887">)</span><span class="op" id="3926888">;</span>&nbsp;<span class="ident" id="3926890">err</span>&nbsp;<span class="op" id="3926894">!=</span>&nbsp;<span class="ident" id="3926897">nil</span>&nbsp;<span class="op" id="3926901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3926905">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3926913">}</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3926916">if</span>&nbsp;<span class="builtinfunc" id="3926919">len</span><span class="op" id="3926922">(</span><span class="ident" id="3926923">b</span><span class="op" id="3926924">)</span>&nbsp;<span class="op" id="3926926">==</span>&nbsp;<span class="num" id="3926929">0</span>&nbsp;<span class="op" id="3926931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926935">//&nbsp;Put&nbsp;this&nbsp;after&nbsp;Handshake,&nbsp;in&nbsp;case&nbsp;people&nbsp;were&nbsp;calling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3926994">//&nbsp;Read(nil)&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of&nbsp;the&nbsp;Handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3927047">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3927055">}</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927059">c</span><span class="op" id="3927060">.</span><span class="ident" id="3927061">in</span><span class="op" id="3927063">.</span><span class="ident" id="3927064">Lock</span><span class="op" id="3927068">(</span><span class="op" id="3927069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3927072">defer</span>&nbsp;<span class="ident" id="3927078">c</span><span class="op" id="3927079">.</span><span class="ident" id="3927080">in</span><span class="op" id="3927082">.</span><span class="ident" id="3927083">Unlock</span><span class="op" id="3927089">(</span><span class="op" id="3927090">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3927094">//&nbsp;Some&nbsp;OpenSSL&nbsp;servers&nbsp;send&nbsp;empty&nbsp;records&nbsp;in&nbsp;order&nbsp;to&nbsp;randomize&nbsp;the</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3927164">//&nbsp;CBC&nbsp;IV.&nbsp;So&nbsp;this&nbsp;loop&nbsp;ignores&nbsp;a&nbsp;limited&nbsp;number&nbsp;of&nbsp;empty&nbsp;records.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3927232">const</span>&nbsp;<span class="ident" id="3927238">maxConsecutiveEmptyRecords</span>&nbsp;<span class="op" id="3927265">=</span>&nbsp;<span class="num" id="3927267">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3927272">for</span>&nbsp;<span class="ident" id="3927276">emptyRecordCount</span>&nbsp;<span class="op" id="3927293">:=</span>&nbsp;<span class="num" id="3927296">0</span><span class="op" id="3927297">;</span>&nbsp;<span class="ident" id="3927299">emptyRecordCount</span>&nbsp;<span class="op" id="3927316">&lt;=</span>&nbsp;<span class="ident" id="3927319">maxConsecutiveEmptyRecords</span><span class="op" id="3927345">;</span>&nbsp;<span class="ident" id="3927347">emptyRecordCount</span><span class="op" id="3927363">++</span>&nbsp;<span class="op" id="3927366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3927370">for</span>&nbsp;<span class="ident" id="3927374">c</span><span class="op" id="3927375">.</span><span class="ident" id="3927376">input</span>&nbsp;<span class="op" id="3927382">==</span>&nbsp;<span class="ident" id="3927385">nil</span>&nbsp;<span class="op" id="3927389">&amp;&amp;</span>&nbsp;<span class="ident" id="3927392">c</span><span class="op" id="3927393">.</span><span class="ident" id="3927394">in</span><span class="op" id="3927396">.</span><span class="ident" id="3927397">err</span>&nbsp;<span class="op" id="3927401">==</span>&nbsp;<span class="ident" id="3927404">nil</span>&nbsp;<span class="op" id="3927408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3927413">if</span>&nbsp;<span class="ident" id="3927416">err</span>&nbsp;<span class="op" id="3927420">:=</span>&nbsp;<span class="ident" id="3927423">c</span><span class="op" id="3927424">.</span><span class="ident" id="3927425">readRecord</span><span class="op" id="3927435">(</span><span class="ident" id="3927436">recordTypeApplicationData</span><span class="op" id="3927461">)</span><span class="op" id="3927462">;</span>&nbsp;<span class="ident" id="3927464">err</span>&nbsp;<span class="op" id="3927468">!=</span>&nbsp;<span class="ident" id="3927471">nil</span>&nbsp;<span class="op" id="3927475">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3927481">//&nbsp;Soft&nbsp;error,&nbsp;like&nbsp;EAGAIN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3927512">return</span>&nbsp;<span class="num" id="3927519">0</span><span class="op" id="3927520">,</span>&nbsp;<span class="ident" id="3927522">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3927529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3927533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3927537">if</span>&nbsp;<span class="ident" id="3927540">err</span>&nbsp;<span class="op" id="3927544">:=</span>&nbsp;<span class="ident" id="3927547">c</span><span class="op" id="3927548">.</span><span class="ident" id="3927549">in</span><span class="op" id="3927551">.</span><span class="ident" id="3927552">err</span><span class="op" id="3927555">;</span>&nbsp;<span class="ident" id="3927557">err</span>&nbsp;<span class="op" id="3927561">!=</span>&nbsp;<span class="ident" id="3927564">nil</span>&nbsp;<span class="op" id="3927568">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3927573">return</span>&nbsp;<span class="num" id="3927580">0</span><span class="op" id="3927581">,</span>&nbsp;<span class="ident" id="3927583">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3927589">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927594">n</span><span class="op" id="3927595">,</span>&nbsp;<span class="ident" id="3927597">err</span>&nbsp;<span class="op" id="3927601">=</span>&nbsp;<span class="ident" id="3927603">c</span><span class="op" id="3927604">.</span><span class="ident" id="3927605">input</span><span class="op" id="3927610">.</span><span class="ident" id="3927611">Read</span><span class="op" id="3927615">(</span><span class="ident" id="3927616">b</span><span class="op" id="3927617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3927621">if</span>&nbsp;<span class="ident" id="3927624">c</span><span class="op" id="3927625">.</span><span class="ident" id="3927626">input</span><span class="op" id="3927631">.</span><span class="ident" id="3927632">off</span>&nbsp;<span class="op" id="3927636">&gt;=</span>&nbsp;<span class="builtinfunc" id="3927639">len</span><span class="op" id="3927642">(</span><span class="ident" id="3927643">c</span><span class="op" id="3927644">.</span><span class="ident" id="3927645">input</span><span class="op" id="3927650">.</span><span class="ident" id="3927651">data</span><span class="op" id="3927655">)</span>&nbsp;<span class="op" id="3927657">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927662">c</span><span class="op" id="3927663">.</span><span class="ident" id="3927664">in</span><span class="op" id="3927666">.</span><span class="ident" id="3927667">freeBlock</span><span class="op" id="3927676">(</span><span class="ident" id="3927677">c</span><span class="op" id="3927678">.</span><span class="ident" id="3927679">input</span><span class="op" id="3927684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3927689">c</span><span class="op" id="3927690">.</span><span class="ident" id="3927691">input</span>&nbsp;<span class="op" id="3927697">=</span>&nbsp;<span class="ident" id="3927699">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3927705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3927710">//&nbsp;If&nbsp;a&nbsp;close-notify&nbsp;alert&nbsp;is&nbsp;waiting,&nbsp;read&nbsp;it&nbsp;so&nbsp;that</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3927767">//&nbsp;we&nbsp;can&nbsp;return&nbsp;(n,&nbsp;EOF)&nbsp;instead&nbsp;of&nbsp;(n,&nbsp;nil),&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3927826">//&nbsp;to&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3927879">//&nbsp;connection&nbsp;is&nbsp;now&nbsp;closed.&nbsp;This&nbsp;eliminates&nbsp;a&nbsp;race</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3927933">//&nbsp;where&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3927986">//&nbsp;otherwise&nbsp;not&nbsp;observe&nbsp;the&nbsp;EOF&nbsp;until&nbsp;its&nbsp;next&nbsp;read,</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3928042">//&nbsp;by&nbsp;which&nbsp;time&nbsp;a&nbsp;client&nbsp;goroutine&nbsp;might&nbsp;have&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3928099">//&nbsp;tried&nbsp;to&nbsp;reuse&nbsp;the&nbsp;HTTP&nbsp;connection&nbsp;for&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3928149">//&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3928163">//&nbsp;See&nbsp;https://codereview.appspot.com/76400046</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3928212">//&nbsp;and&nbsp;http://golang.org/issue/3514</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928250">if</span>&nbsp;<span class="ident" id="3928253">ri</span>&nbsp;<span class="op" id="3928256">:=</span>&nbsp;<span class="ident" id="3928259">c</span><span class="op" id="3928260">.</span><span class="ident" id="3928261">rawInput</span><span class="op" id="3928269">;</span>&nbsp;<span class="ident" id="3928271">ri</span>&nbsp;<span class="op" id="3928274">!=</span>&nbsp;<span class="ident" id="3928277">nil</span>&nbsp;<span class="op" id="3928281">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928287">n</span>&nbsp;<span class="op" id="3928289">!=</span>&nbsp;<span class="num" id="3928292">0</span>&nbsp;<span class="op" id="3928294">&amp;&amp;</span>&nbsp;<span class="ident" id="3928297">err</span>&nbsp;<span class="op" id="3928301">==</span>&nbsp;<span class="ident" id="3928304">nil</span>&nbsp;<span class="op" id="3928308">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928314">c</span><span class="op" id="3928315">.</span><span class="ident" id="3928316">input</span>&nbsp;<span class="op" id="3928322">==</span>&nbsp;<span class="ident" id="3928325">nil</span>&nbsp;<span class="op" id="3928329">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3928332">len</span><span class="op" id="3928335">(</span><span class="ident" id="3928336">ri</span><span class="op" id="3928338">.</span><span class="ident" id="3928339">data</span><span class="op" id="3928343">)</span>&nbsp;<span class="op" id="3928345">&gt;</span>&nbsp;<span class="num" id="3928347">0</span>&nbsp;<span class="op" id="3928349">&amp;&amp;</span>&nbsp;<span class="ident" id="3928352">recordType</span><span class="op" id="3928362">(</span><span class="ident" id="3928363">ri</span><span class="op" id="3928365">.</span><span class="ident" id="3928366">data</span><span class="op" id="3928370">[</span><span class="num" id="3928371">0</span><span class="op" id="3928372">]</span><span class="op" id="3928373">)</span>&nbsp;<span class="op" id="3928375">==</span>&nbsp;<span class="ident" id="3928378">recordTypeAlert</span>&nbsp;<span class="op" id="3928394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928399">if</span>&nbsp;<span class="ident" id="3928402">recErr</span>&nbsp;<span class="op" id="3928409">:=</span>&nbsp;<span class="ident" id="3928412">c</span><span class="op" id="3928413">.</span><span class="ident" id="3928414">readRecord</span><span class="op" id="3928424">(</span><span class="ident" id="3928425">recordTypeApplicationData</span><span class="op" id="3928450">)</span><span class="op" id="3928451">;</span>&nbsp;<span class="ident" id="3928453">recErr</span>&nbsp;<span class="op" id="3928460">!=</span>&nbsp;<span class="ident" id="3928463">nil</span>&nbsp;<span class="op" id="3928467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928473">err</span>&nbsp;<span class="op" id="3928477">=</span>&nbsp;<span class="ident" id="3928479">recErr</span>&nbsp;<span class="comment" id="3928486">//&nbsp;will&nbsp;be&nbsp;io.EOF&nbsp;on&nbsp;closeNotify</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3928522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3928526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928531">if</span>&nbsp;<span class="ident" id="3928534">n</span>&nbsp;<span class="op" id="3928536">!=</span>&nbsp;<span class="num" id="3928539">0</span>&nbsp;<span class="op" id="3928541">||</span>&nbsp;<span class="ident" id="3928544">err</span>&nbsp;<span class="op" id="3928548">!=</span>&nbsp;<span class="ident" id="3928551">nil</span>&nbsp;<span class="op" id="3928555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928560">return</span>&nbsp;<span class="ident" id="3928567">n</span><span class="op" id="3928568">,</span>&nbsp;<span class="ident" id="3928570">err</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3928576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3928579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928583">return</span>&nbsp;<span class="num" id="3928590">0</span><span class="op" id="3928591">,</span>&nbsp;<span class="ident" id="3928593">io</span><span class="op" id="3928595">.</span><span class="ident" id="3928596">ErrNoProgress</span><br>
<span class="lineno"></span><span class="op" id="3928610">}</span><br>
<span class="lineno">945</span><br>
<span class="lineno"></span><span class="comment" id="3928613">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3928645">func</span>&nbsp;<span class="op" id="3928650">(</span><span class="ident" id="3928651">c</span>&nbsp;<span class="op" id="3928653">*</span><span class="ident" id="3928654">Conn</span><span class="op" id="3928658">)</span>&nbsp;<span class="ident" id="3928660">Close</span><span class="op" id="3928665">(</span><span class="op" id="3928666">)</span>&nbsp;<span class="builtintype" id="3928668">error</span>&nbsp;<span class="op" id="3928674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928677">var</span>&nbsp;<span class="ident" id="3928681">alertErr</span>&nbsp;<span class="builtintype" id="3928690">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928698">c</span><span class="op" id="3928699">.</span><span class="ident" id="3928700">handshakeMutex</span><span class="op" id="3928714">.</span><span class="ident" id="3928715">Lock</span><span class="op" id="3928719">(</span><span class="op" id="3928720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928723">defer</span>&nbsp;<span class="ident" id="3928729">c</span><span class="op" id="3928730">.</span><span class="ident" id="3928731">handshakeMutex</span><span class="op" id="3928745">.</span><span class="ident" id="3928746">Unlock</span><span class="op" id="3928752">(</span><span class="op" id="3928753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928756">if</span>&nbsp;<span class="ident" id="3928759">c</span><span class="op" id="3928760">.</span><span class="ident" id="3928761">handshakeComplete</span>&nbsp;<span class="op" id="3928779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3928783">alertErr</span>&nbsp;<span class="op" id="3928792">=</span>&nbsp;<span class="ident" id="3928794">c</span><span class="op" id="3928795">.</span><span class="ident" id="3928796">sendAlert</span><span class="op" id="3928805">(</span><span class="ident" id="3928806">alertCloseNotify</span><span class="op" id="3928822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3928825">}</span><br>
<span class="lineno">955</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928829">if</span>&nbsp;<span class="ident" id="3928832">err</span>&nbsp;<span class="op" id="3928836">:=</span>&nbsp;<span class="ident" id="3928839">c</span><span class="op" id="3928840">.</span><span class="ident" id="3928841">conn</span><span class="op" id="3928845">.</span><span class="ident" id="3928846">Close</span><span class="op" id="3928851">(</span><span class="op" id="3928852">)</span><span class="op" id="3928853">;</span>&nbsp;<span class="ident" id="3928855">err</span>&nbsp;<span class="op" id="3928859">!=</span>&nbsp;<span class="ident" id="3928862">nil</span>&nbsp;<span class="op" id="3928866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928870">return</span>&nbsp;<span class="ident" id="3928877">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3928882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3928885">return</span>&nbsp;<span class="ident" id="3928892">alertErr</span><br>
<span class="lineno">960</span><span class="op" id="3928901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3928904">//&nbsp;Handshake&nbsp;runs&nbsp;the&nbsp;client&nbsp;or&nbsp;server&nbsp;handshake</span><br>
<span class="lineno"></span><span class="comment" id="3928953">//&nbsp;protocol&nbsp;if&nbsp;it&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="3928993">//&nbsp;Most&nbsp;uses&nbsp;of&nbsp;this&nbsp;package&nbsp;need&nbsp;not&nbsp;call&nbsp;Handshake</span><br>
<span class="lineno">965</span><span class="comment" id="3929046">//&nbsp;explicitly:&nbsp;the&nbsp;first&nbsp;Read&nbsp;or&nbsp;Write&nbsp;will&nbsp;call&nbsp;it&nbsp;automatically.</span><br>
<span class="lineno"></span><span class="keyword" id="3929113">func</span>&nbsp;<span class="op" id="3929118">(</span><span class="ident" id="3929119">c</span>&nbsp;<span class="op" id="3929121">*</span><span class="ident" id="3929122">Conn</span><span class="op" id="3929126">)</span>&nbsp;<span class="ident" id="3929128">Handshake</span><span class="op" id="3929137">(</span><span class="op" id="3929138">)</span>&nbsp;<span class="builtintype" id="3929140">error</span>&nbsp;<span class="op" id="3929146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929149">c</span><span class="op" id="3929150">.</span><span class="ident" id="3929151">handshakeMutex</span><span class="op" id="3929165">.</span><span class="ident" id="3929166">Lock</span><span class="op" id="3929170">(</span><span class="op" id="3929171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929174">defer</span>&nbsp;<span class="ident" id="3929180">c</span><span class="op" id="3929181">.</span><span class="ident" id="3929182">handshakeMutex</span><span class="op" id="3929196">.</span><span class="ident" id="3929197">Unlock</span><span class="op" id="3929203">(</span><span class="op" id="3929204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929207">if</span>&nbsp;<span class="ident" id="3929210">err</span>&nbsp;<span class="op" id="3929214">:=</span>&nbsp;<span class="ident" id="3929217">c</span><span class="op" id="3929218">.</span><span class="ident" id="3929219">handshakeErr</span><span class="op" id="3929231">;</span>&nbsp;<span class="ident" id="3929233">err</span>&nbsp;<span class="op" id="3929237">!=</span>&nbsp;<span class="ident" id="3929240">nil</span>&nbsp;<span class="op" id="3929244">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929248">return</span>&nbsp;<span class="ident" id="3929255">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3929260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929263">if</span>&nbsp;<span class="ident" id="3929266">c</span><span class="op" id="3929267">.</span><span class="ident" id="3929268">handshakeComplete</span>&nbsp;<span class="op" id="3929286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929290">return</span>&nbsp;<span class="ident" id="3929297">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3929302">}</span><br>
<span class="lineno">975</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929306">if</span>&nbsp;<span class="ident" id="3929309">c</span><span class="op" id="3929310">.</span><span class="ident" id="3929311">isClient</span>&nbsp;<span class="op" id="3929320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929324">c</span><span class="op" id="3929325">.</span><span class="ident" id="3929326">handshakeErr</span>&nbsp;<span class="op" id="3929339">=</span>&nbsp;<span class="ident" id="3929341">c</span><span class="op" id="3929342">.</span><span class="ident" id="3929343">clientHandshake</span><span class="op" id="3929358">(</span><span class="op" id="3929359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3929362">}</span>&nbsp;<span class="keyword" id="3929364">else</span>&nbsp;<span class="op" id="3929369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929373">c</span><span class="op" id="3929374">.</span><span class="ident" id="3929375">handshakeErr</span>&nbsp;<span class="op" id="3929388">=</span>&nbsp;<span class="ident" id="3929390">c</span><span class="op" id="3929391">.</span><span class="ident" id="3929392">serverHandshake</span><span class="op" id="3929407">(</span><span class="op" id="3929408">)</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3929411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929414">return</span>&nbsp;<span class="ident" id="3929421">c</span><span class="op" id="3929422">.</span><span class="ident" id="3929423">handshakeErr</span><br>
<span class="lineno"></span><span class="op" id="3929436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3929439">//&nbsp;ConnectionState&nbsp;returns&nbsp;basic&nbsp;TLS&nbsp;details&nbsp;about&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">985</span><span class="keyword" id="3929506">func</span>&nbsp;<span class="op" id="3929511">(</span><span class="ident" id="3929512">c</span>&nbsp;<span class="op" id="3929514">*</span><span class="ident" id="3929515">Conn</span><span class="op" id="3929519">)</span>&nbsp;<span class="ident" id="3929521">ConnectionState</span><span class="op" id="3929536">(</span><span class="op" id="3929537">)</span>&nbsp;<span class="ident" id="3929539">ConnectionState</span>&nbsp;<span class="op" id="3929555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929558">c</span><span class="op" id="3929559">.</span><span class="ident" id="3929560">handshakeMutex</span><span class="op" id="3929574">.</span><span class="ident" id="3929575">Lock</span><span class="op" id="3929579">(</span><span class="op" id="3929580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929583">defer</span>&nbsp;<span class="ident" id="3929589">c</span><span class="op" id="3929590">.</span><span class="ident" id="3929591">handshakeMutex</span><span class="op" id="3929605">.</span><span class="ident" id="3929606">Unlock</span><span class="op" id="3929612">(</span><span class="op" id="3929613">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929617">var</span>&nbsp;<span class="ident" id="3929621">state</span>&nbsp;<span class="ident" id="3929627">ConnectionState</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929644">state</span><span class="op" id="3929649">.</span><span class="ident" id="3929650">HandshakeComplete</span>&nbsp;<span class="op" id="3929668">=</span>&nbsp;<span class="ident" id="3929670">c</span><span class="op" id="3929671">.</span><span class="ident" id="3929672">handshakeComplete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3929691">if</span>&nbsp;<span class="ident" id="3929694">c</span><span class="op" id="3929695">.</span><span class="ident" id="3929696">handshakeComplete</span>&nbsp;<span class="op" id="3929714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929718">state</span><span class="op" id="3929723">.</span><span class="ident" id="3929724">Version</span>&nbsp;<span class="op" id="3929732">=</span>&nbsp;<span class="ident" id="3929734">c</span><span class="op" id="3929735">.</span><span class="ident" id="3929736">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929743">state</span><span class="op" id="3929748">.</span><span class="ident" id="3929749">NegotiatedProtocol</span>&nbsp;<span class="op" id="3929768">=</span>&nbsp;<span class="ident" id="3929770">c</span><span class="op" id="3929771">.</span><span class="ident" id="3929772">clientProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929789">state</span><span class="op" id="3929794">.</span><span class="ident" id="3929795">DidResume</span>&nbsp;<span class="op" id="3929805">=</span>&nbsp;<span class="ident" id="3929807">c</span><span class="op" id="3929808">.</span><span class="ident" id="3929809">didResume</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929821">state</span><span class="op" id="3929826">.</span><span class="ident" id="3929827">NegotiatedProtocolIsMutual</span>&nbsp;<span class="op" id="3929854">=</span>&nbsp;<span class="op" id="3929856">!</span><span class="ident" id="3929857">c</span><span class="op" id="3929858">.</span><span class="ident" id="3929859">clientProtocolFallback</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929884">state</span><span class="op" id="3929889">.</span><span class="ident" id="3929890">CipherSuite</span>&nbsp;<span class="op" id="3929902">=</span>&nbsp;<span class="ident" id="3929904">c</span><span class="op" id="3929905">.</span><span class="ident" id="3929906">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929920">state</span><span class="op" id="3929925">.</span><span class="ident" id="3929926">PeerCertificates</span>&nbsp;<span class="op" id="3929943">=</span>&nbsp;<span class="ident" id="3929945">c</span><span class="op" id="3929946">.</span><span class="ident" id="3929947">peerCertificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3929966">state</span><span class="op" id="3929971">.</span><span class="ident" id="3929972">VerifiedChains</span>&nbsp;<span class="op" id="3929987">=</span>&nbsp;<span class="ident" id="3929989">c</span><span class="op" id="3929990">.</span><span class="ident" id="3929991">verifiedChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3930008">state</span><span class="op" id="3930013">.</span><span class="ident" id="3930014">ServerName</span>&nbsp;<span class="op" id="3930025">=</span>&nbsp;<span class="ident" id="3930027">c</span><span class="op" id="3930028">.</span><span class="ident" id="3930029">serverName</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930042">if</span>&nbsp;<span class="op" id="3930045">!</span><span class="ident" id="3930046">c</span><span class="op" id="3930047">.</span><span class="ident" id="3930048">didResume</span>&nbsp;<span class="op" id="3930058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3930063">state</span><span class="op" id="3930068">.</span><span class="ident" id="3930069">TLSUnique</span>&nbsp;<span class="op" id="3930079">=</span>&nbsp;<span class="ident" id="3930081">c</span><span class="op" id="3930082">.</span><span class="ident" id="3930083">firstFinished</span><span class="op" id="3930096">[</span><span class="op" id="3930097">:</span><span class="op" id="3930098">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3930102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3930105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930109">return</span>&nbsp;<span class="ident" id="3930116">state</span><br>
<span class="lineno"></span><span class="op" id="3930122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3930125">//&nbsp;OCSPResponse&nbsp;returns&nbsp;the&nbsp;stapled&nbsp;OCSP&nbsp;response&nbsp;from&nbsp;the&nbsp;TLS&nbsp;server,&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="3930199">//&nbsp;any.&nbsp;(Only&nbsp;valid&nbsp;for&nbsp;client&nbsp;connections.)</span><br>
<span class="lineno">1010</span><span class="keyword" id="3930244">func</span>&nbsp;<span class="op" id="3930249">(</span><span class="ident" id="3930250">c</span>&nbsp;<span class="op" id="3930252">*</span><span class="ident" id="3930253">Conn</span><span class="op" id="3930257">)</span>&nbsp;<span class="ident" id="3930259">OCSPResponse</span><span class="op" id="3930271">(</span><span class="op" id="3930272">)</span>&nbsp;<span class="op" id="3930274">[</span><span class="op" id="3930275">]</span><span class="builtintype" id="3930276">byte</span>&nbsp;<span class="op" id="3930281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3930284">c</span><span class="op" id="3930285">.</span><span class="ident" id="3930286">handshakeMutex</span><span class="op" id="3930300">.</span><span class="ident" id="3930301">Lock</span><span class="op" id="3930305">(</span><span class="op" id="3930306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930309">defer</span>&nbsp;<span class="ident" id="3930315">c</span><span class="op" id="3930316">.</span><span class="ident" id="3930317">handshakeMutex</span><span class="op" id="3930331">.</span><span class="ident" id="3930332">Unlock</span><span class="op" id="3930338">(</span><span class="op" id="3930339">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930343">return</span>&nbsp;<span class="ident" id="3930350">c</span><span class="op" id="3930351">.</span><span class="ident" id="3930352">ocspResponse</span><br>
<span class="lineno">1015</span><span class="op" id="3930365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3930368">//&nbsp;VerifyHostname&nbsp;checks&nbsp;that&nbsp;the&nbsp;peer&nbsp;certificate&nbsp;chain&nbsp;is&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3930438">//&nbsp;connecting&nbsp;to&nbsp;host.&nbsp;&nbsp;If&nbsp;so,&nbsp;it&nbsp;returns&nbsp;nil;&nbsp;if&nbsp;not,&nbsp;it&nbsp;returns&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="3930513">//&nbsp;describing&nbsp;the&nbsp;problem.</span><br>
<span class="lineno">1020</span><span class="keyword" id="3930540">func</span>&nbsp;<span class="op" id="3930545">(</span><span class="ident" id="3930546">c</span>&nbsp;<span class="op" id="3930548">*</span><span class="ident" id="3930549">Conn</span><span class="op" id="3930553">)</span>&nbsp;<span class="ident" id="3930555">VerifyHostname</span><span class="op" id="3930569">(</span><span class="ident" id="3930570">host</span>&nbsp;<span class="builtintype" id="3930575">string</span><span class="op" id="3930581">)</span>&nbsp;<span class="builtintype" id="3930583">error</span>&nbsp;<span class="op" id="3930589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3930592">c</span><span class="op" id="3930593">.</span><span class="ident" id="3930594">handshakeMutex</span><span class="op" id="3930608">.</span><span class="ident" id="3930609">Lock</span><span class="op" id="3930613">(</span><span class="op" id="3930614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930617">defer</span>&nbsp;<span class="ident" id="3930623">c</span><span class="op" id="3930624">.</span><span class="ident" id="3930625">handshakeMutex</span><span class="op" id="3930639">.</span><span class="ident" id="3930640">Unlock</span><span class="op" id="3930646">(</span><span class="op" id="3930647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930650">if</span>&nbsp;<span class="op" id="3930653">!</span><span class="ident" id="3930654">c</span><span class="op" id="3930655">.</span><span class="ident" id="3930656">isClient</span>&nbsp;<span class="op" id="3930665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930669">return</span>&nbsp;<span class="ident" id="3930676">errors</span><span class="op" id="3930682">.</span><span class="ident" id="3930683">New</span><span class="op" id="3930686">(</span><span class="string" id="3930687">&#34;tls:&nbsp;VerifyHostname&nbsp;called&nbsp;on&nbsp;TLS&nbsp;server&nbsp;connection&#34;</span><span class="op" id="3930740">)</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3930743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930746">if</span>&nbsp;<span class="op" id="3930749">!</span><span class="ident" id="3930750">c</span><span class="op" id="3930751">.</span><span class="ident" id="3930752">handshakeComplete</span>&nbsp;<span class="op" id="3930770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930774">return</span>&nbsp;<span class="ident" id="3930781">errors</span><span class="op" id="3930787">.</span><span class="ident" id="3930788">New</span><span class="op" id="3930791">(</span><span class="string" id="3930792">&#34;tls:&nbsp;handshake&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;performed&#34;</span><span class="op" id="3930835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3930838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3930841">return</span>&nbsp;<span class="ident" id="3930848">c</span><span class="op" id="3930849">.</span><span class="ident" id="3930850">peerCertificates</span><span class="op" id="3930866">[</span><span class="num" id="3930867">0</span><span class="op" id="3930868">]</span><span class="op" id="3930869">.</span><span class="ident" id="3930870">VerifyHostname</span><span class="op" id="3930884">(</span><span class="ident" id="3930885">host</span><span class="op" id="3930889">)</span><br>
<span class="lineno">1030</span><span class="op" id="3930891">}</span>
</div>
</body>
</html>
