<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6084894">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6084950">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6085004">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6085055">package</span>&nbsp;<span class="ident" id="6085063">macho</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6085070">import</span>&nbsp;<span class="op" id="6085077">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6085080">&#34;encoding/binary&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6085099">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6085106">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6085112">&#34;os&#34;</span><br>
<span class="lineno"></span><span class="op" id="6085117">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6085120">//&nbsp;A&nbsp;FatFile&nbsp;is&nbsp;a&nbsp;Mach-O&nbsp;universal&nbsp;binary&nbsp;that&nbsp;contains&nbsp;at&nbsp;least&nbsp;one&nbsp;architecture.</span><br>
<span class="lineno">15</span><span class="keyword" id="6085203">type</span>&nbsp;<span class="ident" id="6085208">FatFile</span>&nbsp;<span class="keyword" id="6085216">struct</span>&nbsp;<span class="op" id="6085223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6085226">Magic</span>&nbsp;&nbsp;<span class="builtintype" id="6085233">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6085241">Arches</span>&nbsp;<span class="op" id="6085248">[</span><span class="op" id="6085249">]</span><span class="ident" id="6085250">FatArch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6085259">closer</span>&nbsp;<span class="ident" id="6085266">io</span><span class="op" id="6085268">.</span><span class="ident" id="6085269">Closer</span><br>
<span class="lineno"></span><span class="op" id="6085276">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="6085279">//&nbsp;A&nbsp;FatArchHeader&nbsp;represents&nbsp;a&nbsp;fat&nbsp;header&nbsp;for&nbsp;a&nbsp;specific&nbsp;image&nbsp;architecture.</span><br>
<span class="lineno"></span><span class="keyword" id="6085357">type</span>&nbsp;<span class="ident" id="6085362">FatArchHeader</span>&nbsp;<span class="keyword" id="6085376">struct</span>&nbsp;<span class="op" id="6085383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6085386">Cpu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6085393">Cpu</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6085398">SubCpu</span>&nbsp;<span class="builtintype" id="6085405">uint32</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6085413">Offset</span>&nbsp;<span class="builtintype" id="6085420">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6085428">Size</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6085435">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6085443">Align</span>&nbsp;&nbsp;<span class="builtintype" id="6085450">uint32</span><br>
<span class="lineno"></span><span class="op" id="6085457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="6085460">const</span>&nbsp;<span class="ident" id="6085466">fatArchHeaderSize</span>&nbsp;<span class="op" id="6085484">=</span>&nbsp;<span class="num" id="6085486">5</span>&nbsp;<span class="op" id="6085488">*</span>&nbsp;<span class="num" id="6085490">4</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6085493">//&nbsp;A&nbsp;FatArch&nbsp;is&nbsp;a&nbsp;Mach-O&nbsp;File&nbsp;inside&nbsp;a&nbsp;FatFile.</span><br>
<span class="lineno"></span><span class="keyword" id="6085541">type</span>&nbsp;<span class="ident" id="6085546">FatArch</span>&nbsp;<span class="keyword" id="6085554">struct</span>&nbsp;<span class="op" id="6085561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6085564">FatArchHeader</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6085579">*</span><span class="ident" id="6085580">File</span><br>
<span class="lineno"></span><span class="op" id="6085585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6085588">//&nbsp;ErrNotFat&nbsp;is&nbsp;returned&nbsp;from&nbsp;NewFatFile&nbsp;or&nbsp;OpenFat&nbsp;when&nbsp;the&nbsp;file&nbsp;is&nbsp;not&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6085663">//&nbsp;universal&nbsp;binary&nbsp;but&nbsp;may&nbsp;be&nbsp;a&nbsp;thin&nbsp;binary,&nbsp;based&nbsp;on&nbsp;its&nbsp;magic&nbsp;number.</span><br>
<span class="lineno">40</span><span class="keyword" id="6085736">var</span>&nbsp;<span class="ident" id="6085740">ErrNotFat</span>&nbsp;<span class="op" id="6085750">=</span>&nbsp;<span class="op" id="6085752">&amp;</span><span class="ident" id="6085753">FormatError</span><span class="op" id="6085764">{</span><span class="num" id="6085765">0</span><span class="op" id="6085766">,</span>&nbsp;<span class="string" id="6085768">&#34;not&nbsp;a&nbsp;fat&nbsp;Mach-O&nbsp;file&#34;</span><span class="op" id="6085791">,</span>&nbsp;<span class="ident" id="6085793">nil</span><span class="op" id="6085796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6085799">//&nbsp;NewFatFile&nbsp;creates&nbsp;a&nbsp;new&nbsp;FatFile&nbsp;for&nbsp;accessing&nbsp;all&nbsp;the&nbsp;Mach-O&nbsp;images&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6085876">//&nbsp;universal&nbsp;binary.&nbsp;The&nbsp;Mach-O&nbsp;binary&nbsp;is&nbsp;expected&nbsp;to&nbsp;start&nbsp;at&nbsp;position&nbsp;0&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="6085953">//&nbsp;the&nbsp;ReaderAt.</span><br>
<span class="lineno">45</span><span class="keyword" id="6085970">func</span>&nbsp;<span class="ident" id="6085975">NewFatFile</span><span class="op" id="6085985">(</span><span class="ident" id="6085986">r</span>&nbsp;<span class="ident" id="6085988">io</span><span class="op" id="6085990">.</span><span class="ident" id="6085991">ReaderAt</span><span class="op" id="6085999">)</span>&nbsp;<span class="op" id="6086001">(</span><span class="op" id="6086002">*</span><span class="ident" id="6086003">FatFile</span><span class="op" id="6086010">,</span>&nbsp;<span class="builtintype" id="6086012">error</span><span class="op" id="6086017">)</span>&nbsp;<span class="op" id="6086019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6086022">var</span>&nbsp;<span class="ident" id="6086026">ff</span>&nbsp;<span class="ident" id="6086029">FatFile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6086038">sr</span>&nbsp;<span class="op" id="6086041">:=</span>&nbsp;<span class="ident" id="6086044">io</span><span class="op" id="6086046">.</span><span class="ident" id="6086047">NewSectionReader</span><span class="op" id="6086063">(</span><span class="ident" id="6086064">r</span><span class="op" id="6086065">,</span>&nbsp;<span class="num" id="6086067">0</span><span class="op" id="6086068">,</span>&nbsp;<span class="num" id="6086070">1</span><span class="op" id="6086071">&lt;&lt;</span><span class="num" id="6086073">63</span><span class="op" id="6086075">-</span><span class="num" id="6086076">1</span><span class="op" id="6086077">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6086081">//&nbsp;Read&nbsp;the&nbsp;fat_header&nbsp;struct,&nbsp;which&nbsp;is&nbsp;always&nbsp;in&nbsp;big&nbsp;endian.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6086144">//&nbsp;Start&nbsp;with&nbsp;the&nbsp;magic&nbsp;number.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6086177">err</span>&nbsp;<span class="op" id="6086181">:=</span>&nbsp;<span class="ident" id="6086184">binary</span><span class="op" id="6086190">.</span><span class="ident" id="6086191">Read</span><span class="op" id="6086195">(</span><span class="ident" id="6086196">sr</span><span class="op" id="6086198">,</span>&nbsp;<span class="ident" id="6086200">binary</span><span class="op" id="6086206">.</span><span class="ident" id="6086207">BigEndian</span><span class="op" id="6086216">,</span>&nbsp;<span class="op" id="6086218">&amp;</span><span class="ident" id="6086219">ff</span><span class="op" id="6086221">.</span><span class="ident" id="6086222">Magic</span><span class="op" id="6086227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6086230">if</span>&nbsp;<span class="ident" id="6086233">err</span>&nbsp;<span class="op" id="6086237">!=</span>&nbsp;<span class="ident" id="6086240">nil</span>&nbsp;<span class="op" id="6086244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6086248">return</span>&nbsp;<span class="ident" id="6086255">nil</span><span class="op" id="6086258">,</span>&nbsp;<span class="op" id="6086260">&amp;</span><span class="ident" id="6086261">FormatError</span><span class="op" id="6086272">{</span><span class="num" id="6086273">0</span><span class="op" id="6086274">,</span>&nbsp;<span class="string" id="6086276">&#34;error&nbsp;reading&nbsp;magic&nbsp;number&#34;</span><span class="op" id="6086304">,</span>&nbsp;<span class="ident" id="6086306">nil</span><span class="op" id="6086309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6086312">}</span>&nbsp;<span class="keyword" id="6086314">else</span>&nbsp;<span class="keyword" id="6086319">if</span>&nbsp;<span class="ident" id="6086322">ff</span><span class="op" id="6086324">.</span><span class="ident" id="6086325">Magic</span>&nbsp;<span class="op" id="6086331">!=</span>&nbsp;<span class="ident" id="6086334">MagicFat</span>&nbsp;<span class="op" id="6086343">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6086347">//&nbsp;See&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;Mach-O&nbsp;file&nbsp;via&nbsp;its&nbsp;magic&nbsp;number.&nbsp;The&nbsp;magic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6086413">//&nbsp;must&nbsp;be&nbsp;converted&nbsp;to&nbsp;little&nbsp;endian&nbsp;first&nbsp;though.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6086467">var</span>&nbsp;<span class="ident" id="6086471">buf</span>&nbsp;<span class="op" id="6086475">[</span><span class="num" id="6086476">4</span><span class="op" id="6086477">]</span><span class="builtintype" id="6086478">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6086485">binary</span><span class="op" id="6086491">.</span><span class="ident" id="6086492">BigEndian</span><span class="op" id="6086501">.</span><span class="ident" id="6086502">PutUint32</span><span class="op" id="6086511">(</span><span class="ident" id="6086512">buf</span><span class="op" id="6086515">[</span><span class="op" id="6086516">:</span><span class="op" id="6086517">]</span><span class="op" id="6086518">,</span>&nbsp;<span class="ident" id="6086520">ff</span><span class="op" id="6086522">.</span><span class="ident" id="6086523">Magic</span><span class="op" id="6086528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6086532">leMagic</span>&nbsp;<span class="op" id="6086540">:=</span>&nbsp;<span class="ident" id="6086543">binary</span><span class="op" id="6086549">.</span><span class="ident" id="6086550">LittleEndian</span><span class="op" id="6086562">.</span><span class="ident" id="6086563">Uint32</span><span class="op" id="6086569">(</span><span class="ident" id="6086570">buf</span><span class="op" id="6086573">[</span><span class="op" id="6086574">:</span><span class="op" id="6086575">]</span><span class="op" id="6086576">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6086580">if</span>&nbsp;<span class="ident" id="6086583">leMagic</span>&nbsp;<span class="op" id="6086591">==</span>&nbsp;<span class="ident" id="6086594">Magic32</span>&nbsp;<span class="op" id="6086602">||</span>&nbsp;<span class="ident" id="6086605">leMagic</span>&nbsp;<span class="op" id="6086613">==</span>&nbsp;<span class="ident" id="6086616">Magic64</span>&nbsp;<span class="op" id="6086624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6086629">return</span>&nbsp;<span class="ident" id="6086636">nil</span><span class="op" id="6086639">,</span>&nbsp;<span class="ident" id="6086641">ErrNotFat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6086653">}</span>&nbsp;<span class="keyword" id="6086655">else</span>&nbsp;<span class="op" id="6086660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6086665">return</span>&nbsp;<span class="ident" id="6086672">nil</span><span class="op" id="6086675">,</span>&nbsp;<span class="op" id="6086677">&amp;</span><span class="ident" id="6086678">FormatError</span><span class="op" id="6086689">{</span><span class="num" id="6086690">0</span><span class="op" id="6086691">,</span>&nbsp;<span class="string" id="6086693">&#34;invalid&nbsp;magic&nbsp;number&#34;</span><span class="op" id="6086715">,</span>&nbsp;<span class="ident" id="6086717">nil</span><span class="op" id="6086720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6086724">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6086727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6086730">offset</span>&nbsp;<span class="op" id="6086737">:=</span>&nbsp;<span class="ident" id="6086740">int64</span><span class="op" id="6086745">(</span><span class="num" id="6086746">4</span><span class="op" id="6086747">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6086751">//&nbsp;Read&nbsp;the&nbsp;number&nbsp;of&nbsp;FatArchHeaders&nbsp;that&nbsp;come&nbsp;after&nbsp;the&nbsp;fat_header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6086821">var</span>&nbsp;<span class="ident" id="6086825">narch</span>&nbsp;<span class="builtintype" id="6086831">uint32</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6086839">err</span>&nbsp;<span class="op" id="6086843">=</span>&nbsp;<span class="ident" id="6086845">binary</span><span class="op" id="6086851">.</span><span class="ident" id="6086852">Read</span><span class="op" id="6086856">(</span><span class="ident" id="6086857">sr</span><span class="op" id="6086859">,</span>&nbsp;<span class="ident" id="6086861">binary</span><span class="op" id="6086867">.</span><span class="ident" id="6086868">BigEndian</span><span class="op" id="6086877">,</span>&nbsp;<span class="op" id="6086879">&amp;</span><span class="ident" id="6086880">narch</span><span class="op" id="6086885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6086888">if</span>&nbsp;<span class="ident" id="6086891">err</span>&nbsp;<span class="op" id="6086895">!=</span>&nbsp;<span class="ident" id="6086898">nil</span>&nbsp;<span class="op" id="6086902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6086906">return</span>&nbsp;<span class="ident" id="6086913">nil</span><span class="op" id="6086916">,</span>&nbsp;<span class="op" id="6086918">&amp;</span><span class="ident" id="6086919">FormatError</span><span class="op" id="6086930">{</span><span class="ident" id="6086931">offset</span><span class="op" id="6086937">,</span>&nbsp;<span class="string" id="6086939">&#34;invalid&nbsp;fat_header&#34;</span><span class="op" id="6086959">,</span>&nbsp;<span class="ident" id="6086961">nil</span><span class="op" id="6086964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6086967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6086970">offset</span>&nbsp;<span class="op" id="6086977">+=</span>&nbsp;<span class="num" id="6086980">4</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6086984">if</span>&nbsp;<span class="ident" id="6086987">narch</span>&nbsp;<span class="op" id="6086993">&lt;</span>&nbsp;<span class="num" id="6086995">1</span>&nbsp;<span class="op" id="6086997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6087001">return</span>&nbsp;<span class="ident" id="6087008">nil</span><span class="op" id="6087011">,</span>&nbsp;<span class="op" id="6087013">&amp;</span><span class="ident" id="6087014">FormatError</span><span class="op" id="6087025">{</span><span class="ident" id="6087026">offset</span><span class="op" id="6087032">,</span>&nbsp;<span class="string" id="6087034">&#34;file&nbsp;contains&nbsp;no&nbsp;images&#34;</span><span class="op" id="6087059">,</span>&nbsp;<span class="ident" id="6087061">nil</span><span class="op" id="6087064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6087067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6087071">//&nbsp;Combine&nbsp;the&nbsp;Cpu&nbsp;and&nbsp;SubCpu&nbsp;(both&nbsp;uint32)&nbsp;into&nbsp;a&nbsp;uint64&nbsp;to&nbsp;make&nbsp;sure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6087143">//&nbsp;there&nbsp;are&nbsp;not&nbsp;duplicate&nbsp;architectures.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6087186">seenArches</span>&nbsp;<span class="op" id="6087197">:=</span>&nbsp;<span class="builtinfunc" id="6087200">make</span><span class="op" id="6087204">(</span><span class="keyword" id="6087205">map</span><span class="op" id="6087208">[</span><span class="ident" id="6087209">uint64</span><span class="op" id="6087215">]</span><span class="builtintype" id="6087216">bool</span><span class="op" id="6087220">,</span>&nbsp;<span class="ident" id="6087222">narch</span><span class="op" id="6087227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6087230">//&nbsp;Make&nbsp;sure&nbsp;that&nbsp;all&nbsp;images&nbsp;are&nbsp;for&nbsp;the&nbsp;same&nbsp;MH_&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6087287">var</span>&nbsp;<span class="ident" id="6087291">machoType</span>&nbsp;<span class="ident" id="6087301">Type</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6087308">//&nbsp;Following&nbsp;the&nbsp;fat_header&nbsp;comes&nbsp;narch&nbsp;fat_arch&nbsp;structs&nbsp;that&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6087377">//&nbsp;Mach-O&nbsp;images&nbsp;further&nbsp;in&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6087416">ff</span><span class="op" id="6087418">.</span><span class="ident" id="6087419">Arches</span>&nbsp;<span class="op" id="6087426">=</span>&nbsp;<span class="builtinfunc" id="6087428">make</span><span class="op" id="6087432">(</span><span class="op" id="6087433">[</span><span class="op" id="6087434">]</span><span class="ident" id="6087435">FatArch</span><span class="op" id="6087442">,</span>&nbsp;<span class="ident" id="6087444">narch</span><span class="op" id="6087449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6087452">for</span>&nbsp;<span class="ident" id="6087456">i</span>&nbsp;<span class="op" id="6087458">:=</span>&nbsp;<span class="builtintype" id="6087461">uint32</span><span class="op" id="6087467">(</span><span class="num" id="6087468">0</span><span class="op" id="6087469">)</span><span class="op" id="6087470">;</span>&nbsp;<span class="ident" id="6087472">i</span>&nbsp;<span class="op" id="6087474">&lt;</span>&nbsp;<span class="ident" id="6087476">narch</span><span class="op" id="6087481">;</span>&nbsp;<span class="ident" id="6087483">i</span><span class="op" id="6087484">++</span>&nbsp;<span class="op" id="6087487">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6087491">fa</span>&nbsp;<span class="op" id="6087494">:=</span>&nbsp;<span class="op" id="6087497">&amp;</span><span class="ident" id="6087498">ff</span><span class="op" id="6087500">.</span><span class="ident" id="6087501">Arches</span><span class="op" id="6087507">[</span><span class="ident" id="6087508">i</span><span class="op" id="6087509">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6087513">err</span>&nbsp;<span class="op" id="6087517">=</span>&nbsp;<span class="ident" id="6087519">binary</span><span class="op" id="6087525">.</span><span class="ident" id="6087526">Read</span><span class="op" id="6087530">(</span><span class="ident" id="6087531">sr</span><span class="op" id="6087533">,</span>&nbsp;<span class="ident" id="6087535">binary</span><span class="op" id="6087541">.</span><span class="ident" id="6087542">BigEndian</span><span class="op" id="6087551">,</span>&nbsp;<span class="op" id="6087553">&amp;</span><span class="ident" id="6087554">fa</span><span class="op" id="6087556">.</span><span class="ident" id="6087557">FatArchHeader</span><span class="op" id="6087570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6087574">if</span>&nbsp;<span class="ident" id="6087577">err</span>&nbsp;<span class="op" id="6087581">!=</span>&nbsp;<span class="ident" id="6087584">nil</span>&nbsp;<span class="op" id="6087588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6087593">return</span>&nbsp;<span class="ident" id="6087600">nil</span><span class="op" id="6087603">,</span>&nbsp;<span class="op" id="6087605">&amp;</span><span class="ident" id="6087606">FormatError</span><span class="op" id="6087617">{</span><span class="ident" id="6087618">offset</span><span class="op" id="6087624">,</span>&nbsp;<span class="string" id="6087626">&#34;invalid&nbsp;fat_arch&nbsp;header&#34;</span><span class="op" id="6087651">,</span>&nbsp;<span class="ident" id="6087653">nil</span><span class="op" id="6087656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6087660">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6087664">offset</span>&nbsp;<span class="op" id="6087671">+=</span>&nbsp;<span class="ident" id="6087674">fatArchHeaderSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6087695">fr</span>&nbsp;<span class="op" id="6087698">:=</span>&nbsp;<span class="ident" id="6087701">io</span><span class="op" id="6087703">.</span><span class="ident" id="6087704">NewSectionReader</span><span class="op" id="6087720">(</span><span class="ident" id="6087721">r</span><span class="op" id="6087722">,</span>&nbsp;<span class="ident" id="6087724">int64</span><span class="op" id="6087729">(</span><span class="ident" id="6087730">fa</span><span class="op" id="6087732">.</span><span class="ident" id="6087733">Offset</span><span class="op" id="6087739">)</span><span class="op" id="6087740">,</span>&nbsp;<span class="ident" id="6087742">int64</span><span class="op" id="6087747">(</span><span class="ident" id="6087748">fa</span><span class="op" id="6087750">.</span><span class="ident" id="6087751">Size</span><span class="op" id="6087755">)</span><span class="op" id="6087756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6087760">fa</span><span class="op" id="6087762">.</span><span class="ident" id="6087763">File</span><span class="op" id="6087767">,</span>&nbsp;<span class="ident" id="6087769">err</span>&nbsp;<span class="op" id="6087773">=</span>&nbsp;<span class="ident" id="6087775">NewFile</span><span class="op" id="6087782">(</span><span class="ident" id="6087783">fr</span><span class="op" id="6087785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6087789">if</span>&nbsp;<span class="ident" id="6087792">err</span>&nbsp;<span class="op" id="6087796">!=</span>&nbsp;<span class="ident" id="6087799">nil</span>&nbsp;<span class="op" id="6087803">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6087808">return</span>&nbsp;<span class="ident" id="6087815">nil</span><span class="op" id="6087818">,</span>&nbsp;<span class="ident" id="6087820">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6087826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6087831">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;architecture&nbsp;for&nbsp;this&nbsp;image&nbsp;is&nbsp;not&nbsp;duplicate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6087896">seenArch</span>&nbsp;<span class="op" id="6087905">:=</span>&nbsp;<span class="op" id="6087908">(</span><span class="ident" id="6087909">uint64</span><span class="op" id="6087915">(</span><span class="ident" id="6087916">fa</span><span class="op" id="6087918">.</span><span class="ident" id="6087919">Cpu</span><span class="op" id="6087922">)</span>&nbsp;<span class="op" id="6087924">&lt;&lt;</span>&nbsp;<span class="num" id="6087927">32</span><span class="op" id="6087929">)</span>&nbsp;<span class="op" id="6087931">|</span>&nbsp;<span class="ident" id="6087933">uint64</span><span class="op" id="6087939">(</span><span class="ident" id="6087940">fa</span><span class="op" id="6087942">.</span><span class="ident" id="6087943">SubCpu</span><span class="op" id="6087949">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6087953">if</span>&nbsp;<span class="ident" id="6087956">o</span><span class="op" id="6087957">,</span>&nbsp;<span class="ident" id="6087959">k</span>&nbsp;<span class="op" id="6087961">:=</span>&nbsp;<span class="ident" id="6087964">seenArches</span><span class="op" id="6087974">[</span><span class="ident" id="6087975">seenArch</span><span class="op" id="6087983">]</span><span class="op" id="6087984">;</span>&nbsp;<span class="ident" id="6087986">o</span>&nbsp;<span class="op" id="6087988">||</span>&nbsp;<span class="ident" id="6087991">k</span>&nbsp;<span class="op" id="6087993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6087998">return</span>&nbsp;<span class="ident" id="6088005">nil</span><span class="op" id="6088008">,</span>&nbsp;<span class="op" id="6088010">&amp;</span><span class="ident" id="6088011">FormatError</span><span class="op" id="6088022">{</span><span class="ident" id="6088023">offset</span><span class="op" id="6088029">,</span>&nbsp;<span class="ident" id="6088031">fmt</span><span class="op" id="6088034">.</span><span class="ident" id="6088035">Sprintf</span><span class="op" id="6088042">(</span><span class="string" id="6088043">&#34;duplicate&nbsp;architecture&nbsp;cpu=%v,&nbsp;subcpu=%#x&#34;</span><span class="op" id="6088086">,</span>&nbsp;<span class="ident" id="6088088">fa</span><span class="op" id="6088090">.</span><span class="ident" id="6088091">Cpu</span><span class="op" id="6088094">,</span>&nbsp;<span class="ident" id="6088096">fa</span><span class="op" id="6088098">.</span><span class="ident" id="6088099">SubCpu</span><span class="op" id="6088105">)</span><span class="op" id="6088106">,</span>&nbsp;<span class="ident" id="6088108">nil</span><span class="op" id="6088111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6088115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6088119">seenArches</span><span class="op" id="6088129">[</span><span class="ident" id="6088130">seenArch</span><span class="op" id="6088138">]</span>&nbsp;<span class="op" id="6088140">=</span>&nbsp;<span class="ident" id="6088142">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6088150">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;Mach-O&nbsp;type&nbsp;matches&nbsp;that&nbsp;of&nbsp;the&nbsp;first&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6088214">if</span>&nbsp;<span class="ident" id="6088217">i</span>&nbsp;<span class="op" id="6088219">==</span>&nbsp;<span class="num" id="6088222">0</span>&nbsp;<span class="op" id="6088224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6088229">machoType</span>&nbsp;<span class="op" id="6088239">=</span>&nbsp;<span class="ident" id="6088241">fa</span><span class="op" id="6088243">.</span><span class="ident" id="6088244">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6088251">}</span>&nbsp;<span class="keyword" id="6088253">else</span>&nbsp;<span class="op" id="6088258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6088263">if</span>&nbsp;<span class="ident" id="6088266">fa</span><span class="op" id="6088268">.</span><span class="ident" id="6088269">Type</span>&nbsp;<span class="op" id="6088274">!=</span>&nbsp;<span class="ident" id="6088277">machoType</span>&nbsp;<span class="op" id="6088287">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6088293">return</span>&nbsp;<span class="ident" id="6088300">nil</span><span class="op" id="6088303">,</span>&nbsp;<span class="op" id="6088305">&amp;</span><span class="ident" id="6088306">FormatError</span><span class="op" id="6088317">{</span><span class="ident" id="6088318">offset</span><span class="op" id="6088324">,</span>&nbsp;<span class="ident" id="6088326">fmt</span><span class="op" id="6088329">.</span><span class="ident" id="6088330">Sprintf</span><span class="op" id="6088337">(</span><span class="string" id="6088338">&#34;Mach-O&nbsp;type&nbsp;for&nbsp;architecture&nbsp;#%d&nbsp;(type=%#x)&nbsp;does&nbsp;not&nbsp;match&nbsp;first&nbsp;(type=%#x)&#34;</span><span class="op" id="6088415">,</span>&nbsp;<span class="ident" id="6088417">i</span><span class="op" id="6088418">,</span>&nbsp;<span class="ident" id="6088420">fa</span><span class="op" id="6088422">.</span><span class="ident" id="6088423">Type</span><span class="op" id="6088427">,</span>&nbsp;<span class="ident" id="6088429">machoType</span><span class="op" id="6088438">)</span><span class="op" id="6088439">,</span>&nbsp;<span class="ident" id="6088441">nil</span><span class="op" id="6088444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6088449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6088453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6088456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6088460">return</span>&nbsp;<span class="op" id="6088467">&amp;</span><span class="ident" id="6088468">ff</span><span class="op" id="6088470">,</span>&nbsp;<span class="ident" id="6088472">nil</span><br>
<span class="lineno"></span><span class="op" id="6088476">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6088479">//&nbsp;OpenFat&nbsp;opens&nbsp;the&nbsp;named&nbsp;file&nbsp;using&nbsp;os.Open&nbsp;and&nbsp;prepares&nbsp;it&nbsp;for&nbsp;use&nbsp;as&nbsp;a&nbsp;Mach-O</span><br>
<span class="lineno"></span><span class="comment" id="6088561">//&nbsp;universal&nbsp;binary.</span><br>
<span class="lineno">125</span><span class="keyword" id="6088582">func</span>&nbsp;<span class="ident" id="6088587">OpenFat</span><span class="op" id="6088594">(</span><span class="ident" id="6088595">name</span>&nbsp;<span class="builtintype" id="6088600">string</span><span class="op" id="6088606">)</span>&nbsp;<span class="op" id="6088608">(</span><span class="ident" id="6088609">ff</span>&nbsp;<span class="op" id="6088612">*</span><span class="ident" id="6088613">FatFile</span><span class="op" id="6088620">,</span>&nbsp;<span class="ident" id="6088622">err</span>&nbsp;<span class="builtintype" id="6088626">error</span><span class="op" id="6088631">)</span>&nbsp;<span class="op" id="6088633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6088636">f</span><span class="op" id="6088637">,</span>&nbsp;<span class="ident" id="6088639">err</span>&nbsp;<span class="op" id="6088643">:=</span>&nbsp;<span class="ident" id="6088646">os</span><span class="op" id="6088648">.</span><span class="ident" id="6088649">Open</span><span class="op" id="6088653">(</span><span class="ident" id="6088654">name</span><span class="op" id="6088658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6088661">if</span>&nbsp;<span class="ident" id="6088664">err</span>&nbsp;<span class="op" id="6088668">!=</span>&nbsp;<span class="ident" id="6088671">nil</span>&nbsp;<span class="op" id="6088675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6088679">return</span>&nbsp;<span class="ident" id="6088686">nil</span><span class="op" id="6088689">,</span>&nbsp;<span class="ident" id="6088691">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6088696">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6088699">ff</span><span class="op" id="6088701">,</span>&nbsp;<span class="ident" id="6088703">err</span>&nbsp;<span class="op" id="6088707">=</span>&nbsp;<span class="ident" id="6088709">NewFatFile</span><span class="op" id="6088719">(</span><span class="ident" id="6088720">f</span><span class="op" id="6088721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6088724">if</span>&nbsp;<span class="ident" id="6088727">err</span>&nbsp;<span class="op" id="6088731">!=</span>&nbsp;<span class="ident" id="6088734">nil</span>&nbsp;<span class="op" id="6088738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6088742">f</span><span class="op" id="6088743">.</span><span class="ident" id="6088744">Close</span><span class="op" id="6088749">(</span><span class="op" id="6088750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6088754">return</span>&nbsp;<span class="ident" id="6088761">nil</span><span class="op" id="6088764">,</span>&nbsp;<span class="ident" id="6088766">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6088771">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6088774">ff</span><span class="op" id="6088776">.</span><span class="ident" id="6088777">closer</span>&nbsp;<span class="op" id="6088784">=</span>&nbsp;<span class="ident" id="6088786">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6088789">return</span><br>
<span class="lineno"></span><span class="op" id="6088796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6088799">func</span>&nbsp;<span class="op" id="6088804">(</span><span class="ident" id="6088805">ff</span>&nbsp;<span class="op" id="6088808">*</span><span class="ident" id="6088809">FatFile</span><span class="op" id="6088816">)</span>&nbsp;<span class="ident" id="6088818">Close</span><span class="op" id="6088823">(</span><span class="op" id="6088824">)</span>&nbsp;<span class="builtintype" id="6088826">error</span>&nbsp;<span class="op" id="6088832">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6088835">var</span>&nbsp;<span class="ident" id="6088839">err</span>&nbsp;<span class="builtintype" id="6088843">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6088850">if</span>&nbsp;<span class="ident" id="6088853">ff</span><span class="op" id="6088855">.</span><span class="ident" id="6088856">closer</span>&nbsp;<span class="op" id="6088863">!=</span>&nbsp;<span class="ident" id="6088866">nil</span>&nbsp;<span class="op" id="6088870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6088874">err</span>&nbsp;<span class="op" id="6088878">=</span>&nbsp;<span class="ident" id="6088880">ff</span><span class="op" id="6088882">.</span><span class="ident" id="6088883">closer</span><span class="op" id="6088889">.</span><span class="ident" id="6088890">Close</span><span class="op" id="6088895">(</span><span class="op" id="6088896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6088900">ff</span><span class="op" id="6088902">.</span><span class="ident" id="6088903">closer</span>&nbsp;<span class="op" id="6088910">=</span>&nbsp;<span class="ident" id="6088912">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6088917">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6088920">return</span>&nbsp;<span class="ident" id="6088927">err</span><br>
<span class="lineno"></span><span class="op" id="6088931">}</span>
</div>
</body>
</html>
