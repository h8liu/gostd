<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7823658">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7823713">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7823767">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7823818">package</span>&nbsp;<span class="ident" id="7823826">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7823831">import</span>&nbsp;<span class="op" id="7823838">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7823841">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7823850">&#34;flag&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7823858">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7823865">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7823871">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7823877">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7823888">&#34;reflect&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7823899">&#34;regexp&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7823909">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7823920">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7823931">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7823939">&#34;testing&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7823950">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7823957">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7823960">func</span>&nbsp;<span class="ident" id="7823965">newLocalListener</span><span class="op" id="7823981">(</span><span class="ident" id="7823982">t</span>&nbsp;<span class="op" id="7823984">*</span><span class="ident" id="7823985">testing</span><span class="op" id="7823992">.</span><span class="ident" id="7823993">T</span><span class="op" id="7823994">)</span>&nbsp;<span class="ident" id="7823996">Listener</span>&nbsp;<span class="op" id="7824005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7824008">ln</span><span class="op" id="7824010">,</span>&nbsp;<span class="ident" id="7824012">err</span>&nbsp;<span class="op" id="7824016">:=</span>&nbsp;<span class="ident" id="7824019">Listen</span><span class="op" id="7824025">(</span><span class="string" id="7824026">&#34;tcp&#34;</span><span class="op" id="7824031">,</span>&nbsp;<span class="string" id="7824033">&#34;127.0.0.1:0&#34;</span><span class="op" id="7824046">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7824049">if</span>&nbsp;<span class="ident" id="7824052">err</span>&nbsp;<span class="op" id="7824056">!=</span>&nbsp;<span class="ident" id="7824059">nil</span>&nbsp;<span class="op" id="7824063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7824067">ln</span><span class="op" id="7824069">,</span>&nbsp;<span class="ident" id="7824071">err</span>&nbsp;<span class="op" id="7824075">=</span>&nbsp;<span class="ident" id="7824077">Listen</span><span class="op" id="7824083">(</span><span class="string" id="7824084">&#34;tcp6&#34;</span><span class="op" id="7824090">,</span>&nbsp;<span class="string" id="7824092">&#34;[::1]:0&#34;</span><span class="op" id="7824101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7824104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7824107">if</span>&nbsp;<span class="ident" id="7824110">err</span>&nbsp;<span class="op" id="7824114">!=</span>&nbsp;<span class="ident" id="7824117">nil</span>&nbsp;<span class="op" id="7824121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7824125">t</span><span class="op" id="7824126">.</span><span class="ident" id="7824127">Fatal</span><span class="op" id="7824132">(</span><span class="ident" id="7824133">err</span><span class="op" id="7824136">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7824139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7824142">return</span>&nbsp;<span class="ident" id="7824149">ln</span><br>
<span class="lineno"></span><span class="op" id="7824152">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7824155">func</span>&nbsp;<span class="ident" id="7824160">TestDialTimeout</span><span class="op" id="7824175">(</span><span class="ident" id="7824176">t</span>&nbsp;<span class="op" id="7824178">*</span><span class="ident" id="7824179">testing</span><span class="op" id="7824186">.</span><span class="ident" id="7824187">T</span><span class="op" id="7824188">)</span>&nbsp;<span class="op" id="7824190">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7824193">origBacklog</span>&nbsp;<span class="op" id="7824205">:=</span>&nbsp;<span class="ident" id="7824208">listenerBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7824225">defer</span>&nbsp;<span class="keyword" id="7824231">func</span><span class="op" id="7824235">(</span><span class="op" id="7824236">)</span>&nbsp;<span class="op" id="7824238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7824242">listenerBacklog</span>&nbsp;<span class="op" id="7824258">=</span>&nbsp;<span class="ident" id="7824260">origBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7824273">}</span><span class="op" id="7824274">(</span><span class="op" id="7824275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7824278">listenerBacklog</span>&nbsp;<span class="op" id="7824294">=</span>&nbsp;<span class="num" id="7824296">1</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7824300">ln</span>&nbsp;<span class="op" id="7824303">:=</span>&nbsp;<span class="ident" id="7824306">newLocalListener</span><span class="op" id="7824322">(</span><span class="ident" id="7824323">t</span><span class="op" id="7824324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7824327">defer</span>&nbsp;<span class="ident" id="7824333">ln</span><span class="op" id="7824335">.</span><span class="ident" id="7824336">Close</span><span class="op" id="7824341">(</span><span class="op" id="7824342">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7824346">errc</span>&nbsp;<span class="op" id="7824351">:=</span>&nbsp;<span class="builtinfunc" id="7824354">make</span><span class="op" id="7824358">(</span><span class="keyword" id="7824359">chan</span>&nbsp;<span class="builtintype" id="7824364">error</span><span class="op" id="7824369">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7824373">numConns</span>&nbsp;<span class="op" id="7824382">:=</span>&nbsp;<span class="ident" id="7824385">listenerBacklog</span>&nbsp;<span class="op" id="7824401">+</span>&nbsp;<span class="num" id="7824403">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7824409">//&nbsp;TODO(bradfitz):&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;test&nbsp;this&nbsp;in&nbsp;a&nbsp;portable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7824466">//&nbsp;way.&nbsp;This&nbsp;is&nbsp;unfortunate,&nbsp;but&nbsp;works&nbsp;for&nbsp;now.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7824515">switch</span>&nbsp;<span class="ident" id="7824522">runtime</span><span class="op" id="7824529">.</span><span class="ident" id="7824530">GOOS</span>&nbsp;<span class="op" id="7824535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7824538">case</span>&nbsp;<span class="string" id="7824543">&#34;linux&#34;</span><span class="op" id="7824550">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7824554">//&nbsp;The&nbsp;kernel&nbsp;will&nbsp;start&nbsp;accepting&nbsp;TCP&nbsp;connections&nbsp;before&nbsp;userspace</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7824624">//&nbsp;gets&nbsp;a&nbsp;chance&nbsp;to&nbsp;not&nbsp;accept&nbsp;them,&nbsp;so&nbsp;fire&nbsp;off&nbsp;a&nbsp;bunch&nbsp;to&nbsp;fill&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7824694">//&nbsp;the&nbsp;kernel&#39;s&nbsp;backlog.&nbsp;&nbsp;Then&nbsp;we&nbsp;test&nbsp;we&nbsp;get&nbsp;a&nbsp;failure&nbsp;after&nbsp;that.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7824764">for</span>&nbsp;<span class="ident" id="7824768">i</span>&nbsp;<span class="op" id="7824770">:=</span>&nbsp;<span class="num" id="7824773">0</span><span class="op" id="7824774">;</span>&nbsp;<span class="ident" id="7824776">i</span>&nbsp;<span class="op" id="7824778">&lt;</span>&nbsp;<span class="ident" id="7824780">numConns</span><span class="op" id="7824788">;</span>&nbsp;<span class="ident" id="7824790">i</span><span class="op" id="7824791">++</span>&nbsp;<span class="op" id="7824794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7824799">go</span>&nbsp;<span class="keyword" id="7824802">func</span><span class="op" id="7824806">(</span><span class="op" id="7824807">)</span>&nbsp;<span class="op" id="7824809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7824815">_</span><span class="op" id="7824816">,</span>&nbsp;<span class="ident" id="7824818">err</span>&nbsp;<span class="op" id="7824822">:=</span>&nbsp;<span class="ident" id="7824825">DialTimeout</span><span class="op" id="7824836">(</span><span class="string" id="7824837">&#34;tcp&#34;</span><span class="op" id="7824842">,</span>&nbsp;<span class="ident" id="7824844">ln</span><span class="op" id="7824846">.</span><span class="ident" id="7824847">Addr</span><span class="op" id="7824851">(</span><span class="op" id="7824852">)</span><span class="op" id="7824853">.</span><span class="ident" id="7824854">String</span><span class="op" id="7824860">(</span><span class="op" id="7824861">)</span><span class="op" id="7824862">,</span>&nbsp;<span class="num" id="7824864">200</span><span class="op" id="7824867">*</span><span class="ident" id="7824868">time</span><span class="op" id="7824872">.</span><span class="ident" id="7824873">Millisecond</span><span class="op" id="7824884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7824890">errc</span>&nbsp;<span class="op" id="7824895">&lt;-</span>&nbsp;<span class="ident" id="7824898">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7824905">}</span><span class="op" id="7824906">(</span><span class="op" id="7824907">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7824911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7824914">case</span>&nbsp;<span class="string" id="7824919">&#34;darwin&#34;</span><span class="op" id="7824927">,</span>&nbsp;<span class="string" id="7824929">&#34;plan9&#34;</span><span class="op" id="7824936">,</span>&nbsp;<span class="string" id="7824938">&#34;windows&#34;</span><span class="op" id="7824947">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7824951">//&nbsp;At&nbsp;least&nbsp;OS&nbsp;X&nbsp;10.7&nbsp;seems&nbsp;to&nbsp;accept&nbsp;any&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7825005">//&nbsp;connections,&nbsp;ignoring&nbsp;listen&#39;s&nbsp;backlog,&nbsp;so&nbsp;resort</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7825060">//&nbsp;to&nbsp;connecting&nbsp;to&nbsp;a&nbsp;hopefully-dead&nbsp;127/8&nbsp;address.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7825114">//&nbsp;Same&nbsp;for&nbsp;windows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7825137">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7825142">//&nbsp;Use&nbsp;an&nbsp;IANA&nbsp;reserved&nbsp;port&nbsp;(49151)&nbsp;instead&nbsp;of&nbsp;80,&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7825204">//&nbsp;on&nbsp;our&nbsp;386&nbsp;builder,&nbsp;this&nbsp;Dial&nbsp;succeeds,&nbsp;connecting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7825260">//&nbsp;to&nbsp;an&nbsp;IIS&nbsp;web&nbsp;server&nbsp;somewhere.&nbsp;&nbsp;The&nbsp;data&nbsp;center</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7825314">//&nbsp;or&nbsp;VM&nbsp;or&nbsp;firewall&nbsp;must&nbsp;be&nbsp;stealing&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7825374">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7825379">//&nbsp;IANA&nbsp;Service&nbsp;Name&nbsp;and&nbsp;Transport&nbsp;Protocol&nbsp;Port&nbsp;Number&nbsp;Registry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7825446">//&nbsp;&lt;http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xml&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7825543">go</span>&nbsp;<span class="keyword" id="7825546">func</span><span class="op" id="7825550">(</span><span class="op" id="7825551">)</span>&nbsp;<span class="op" id="7825553">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7825558">c</span><span class="op" id="7825559">,</span>&nbsp;<span class="ident" id="7825561">err</span>&nbsp;<span class="op" id="7825565">:=</span>&nbsp;<span class="ident" id="7825568">DialTimeout</span><span class="op" id="7825579">(</span><span class="string" id="7825580">&#34;tcp&#34;</span><span class="op" id="7825585">,</span>&nbsp;<span class="string" id="7825587">&#34;127.0.71.111:49151&#34;</span><span class="op" id="7825607">,</span>&nbsp;<span class="num" id="7825609">200</span><span class="op" id="7825612">*</span><span class="ident" id="7825613">time</span><span class="op" id="7825617">.</span><span class="ident" id="7825618">Millisecond</span><span class="op" id="7825629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7825634">if</span>&nbsp;<span class="ident" id="7825637">err</span>&nbsp;<span class="op" id="7825641">==</span>&nbsp;<span class="ident" id="7825644">nil</span>&nbsp;<span class="op" id="7825648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7825654">err</span>&nbsp;<span class="op" id="7825658">=</span>&nbsp;<span class="ident" id="7825660">fmt</span><span class="op" id="7825663">.</span><span class="ident" id="7825664">Errorf</span><span class="op" id="7825670">(</span><span class="string" id="7825671">&#34;unexpected:&nbsp;connected&nbsp;to&nbsp;%s!&#34;</span><span class="op" id="7825701">,</span>&nbsp;<span class="ident" id="7825703">c</span><span class="op" id="7825704">.</span><span class="ident" id="7825705">RemoteAddr</span><span class="op" id="7825715">(</span><span class="op" id="7825716">)</span><span class="op" id="7825717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7825723">c</span><span class="op" id="7825724">.</span><span class="ident" id="7825725">Close</span><span class="op" id="7825730">(</span><span class="op" id="7825731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7825736">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7825741">errc</span>&nbsp;<span class="op" id="7825746">&lt;-</span>&nbsp;<span class="ident" id="7825749">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7825755">}</span><span class="op" id="7825756">(</span><span class="op" id="7825757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7825760">default</span><span class="op" id="7825767">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7825771">//&nbsp;TODO(bradfitz):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7825792">//&nbsp;OpenBSD&nbsp;may&nbsp;have&nbsp;a&nbsp;reject&nbsp;route&nbsp;to&nbsp;127/8&nbsp;except&nbsp;127.0.0.1/32</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7825858">//&nbsp;by&nbsp;default.&nbsp;FreeBSD&nbsp;likely&nbsp;works,&nbsp;but&nbsp;is&nbsp;untested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7825914">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7825930">//&nbsp;The&nbsp;timeout&nbsp;never&nbsp;happens&nbsp;on&nbsp;Windows.&nbsp;&nbsp;Why?&nbsp;&nbsp;Issue&nbsp;3016.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7825992">t</span><span class="op" id="7825993">.</span><span class="ident" id="7825994">Skipf</span><span class="op" id="7825999">(</span><span class="string" id="7826000">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q;&nbsp;untested.&#34;</span><span class="op" id="7826032">,</span>&nbsp;<span class="ident" id="7826034">runtime</span><span class="op" id="7826041">.</span><span class="ident" id="7826042">GOOS</span><span class="op" id="7826046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7826049">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7826053">connected</span>&nbsp;<span class="op" id="7826063">:=</span>&nbsp;<span class="num" id="7826066">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7826069">for</span>&nbsp;<span class="op" id="7826073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7826077">select</span>&nbsp;<span class="op" id="7826084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7826088">case</span>&nbsp;<span class="op" id="7826093">&lt;-</span><span class="ident" id="7826095">time</span><span class="op" id="7826099">.</span><span class="ident" id="7826100">After</span><span class="op" id="7826105">(</span><span class="num" id="7826106">15</span>&nbsp;<span class="op" id="7826109">*</span>&nbsp;<span class="ident" id="7826111">time</span><span class="op" id="7826115">.</span><span class="ident" id="7826116">Second</span><span class="op" id="7826122">)</span><span class="op" id="7826123">:</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7826128">t</span><span class="op" id="7826129">.</span><span class="ident" id="7826130">Fatal</span><span class="op" id="7826135">(</span><span class="string" id="7826136">&#34;too&nbsp;slow&#34;</span><span class="op" id="7826146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7826150">case</span>&nbsp;<span class="ident" id="7826155">err</span>&nbsp;<span class="op" id="7826159">:=</span>&nbsp;<span class="op" id="7826162">&lt;-</span><span class="ident" id="7826164">errc</span><span class="op" id="7826168">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7826173">if</span>&nbsp;<span class="ident" id="7826176">err</span>&nbsp;<span class="op" id="7826180">==</span>&nbsp;<span class="ident" id="7826183">nil</span>&nbsp;<span class="op" id="7826187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7826193">connected</span><span class="op" id="7826202">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7826209">if</span>&nbsp;<span class="ident" id="7826212">connected</span>&nbsp;<span class="op" id="7826222">==</span>&nbsp;<span class="ident" id="7826225">numConns</span>&nbsp;<span class="op" id="7826234">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7826241">t</span><span class="op" id="7826242">.</span><span class="ident" id="7826243">Fatal</span><span class="op" id="7826248">(</span><span class="string" id="7826249">&#34;all&nbsp;connections&nbsp;connected;&nbsp;expected&nbsp;some&nbsp;to&nbsp;time&nbsp;out&#34;</span><span class="op" id="7826303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7826309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7826314">}</span>&nbsp;<span class="keyword" id="7826316">else</span>&nbsp;<span class="op" id="7826321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7826327">terr</span><span class="op" id="7826331">,</span>&nbsp;<span class="ident" id="7826333">ok</span>&nbsp;<span class="op" id="7826336">:=</span>&nbsp;<span class="ident" id="7826339">err</span><span class="op" id="7826342">.</span><span class="op" id="7826343">(</span><span class="ident" id="7826344">timeout</span><span class="op" id="7826351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7826357">if</span>&nbsp;<span class="op" id="7826360">!</span><span class="ident" id="7826361">ok</span>&nbsp;<span class="op" id="7826364">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7826371">t</span><span class="op" id="7826372">.</span><span class="ident" id="7826373">Fatalf</span><span class="op" id="7826379">(</span><span class="string" id="7826380">&#34;got&nbsp;error&nbsp;%q;&nbsp;want&nbsp;error&nbsp;with&nbsp;timeout&nbsp;interface&#34;</span><span class="op" id="7826429">,</span>&nbsp;<span class="ident" id="7826431">err</span><span class="op" id="7826434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7826440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7826446">if</span>&nbsp;<span class="op" id="7826449">!</span><span class="ident" id="7826450">terr</span><span class="op" id="7826454">.</span><span class="ident" id="7826455">Timeout</span><span class="op" id="7826462">(</span><span class="op" id="7826463">)</span>&nbsp;<span class="op" id="7826465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7826472">t</span><span class="op" id="7826473">.</span><span class="ident" id="7826474">Fatalf</span><span class="op" id="7826480">(</span><span class="string" id="7826481">&#34;got&nbsp;error&nbsp;%q;&nbsp;not&nbsp;a&nbsp;timeout&#34;</span><span class="op" id="7826510">,</span>&nbsp;<span class="ident" id="7826512">err</span><span class="op" id="7826515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7826521">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7826527">//&nbsp;Pass.&nbsp;We&nbsp;saw&nbsp;a&nbsp;timeout&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7826564">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7826574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7826578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7826581">}</span><br>
<span class="lineno">115</span><span class="op" id="7826583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7826586">func</span>&nbsp;<span class="ident" id="7826591">TestSelfConnect</span><span class="op" id="7826606">(</span><span class="ident" id="7826607">t</span>&nbsp;<span class="op" id="7826609">*</span><span class="ident" id="7826610">testing</span><span class="op" id="7826617">.</span><span class="ident" id="7826618">T</span><span class="op" id="7826619">)</span>&nbsp;<span class="op" id="7826621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7826624">if</span>&nbsp;<span class="ident" id="7826627">runtime</span><span class="op" id="7826634">.</span><span class="ident" id="7826635">GOOS</span>&nbsp;<span class="op" id="7826640">==</span>&nbsp;<span class="string" id="7826643">&#34;windows&#34;</span>&nbsp;<span class="op" id="7826653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7826657">//&nbsp;TODO(brainman):&nbsp;do&nbsp;not&nbsp;know&nbsp;why&nbsp;it&nbsp;hangs.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7826704">t</span><span class="op" id="7826705">.</span><span class="ident" id="7826706">Skip</span><span class="op" id="7826710">(</span><span class="string" id="7826711">&#34;skipping&nbsp;known-broken&nbsp;test&nbsp;on&nbsp;windows&#34;</span><span class="op" id="7826750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7826753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7826757">//&nbsp;Test&nbsp;that&nbsp;Dial&nbsp;does&nbsp;not&nbsp;honor&nbsp;self-connects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7826806">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;DialTCP.</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7826839">//&nbsp;Find&nbsp;a&nbsp;port&nbsp;that&nbsp;would&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;local&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7826894">l</span><span class="op" id="7826895">,</span>&nbsp;<span class="ident" id="7826897">err</span>&nbsp;<span class="op" id="7826901">:=</span>&nbsp;<span class="ident" id="7826904">Listen</span><span class="op" id="7826910">(</span><span class="string" id="7826911">&#34;tcp&#34;</span><span class="op" id="7826916">,</span>&nbsp;<span class="string" id="7826918">&#34;127.0.0.1:0&#34;</span><span class="op" id="7826931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7826934">if</span>&nbsp;<span class="ident" id="7826937">err</span>&nbsp;<span class="op" id="7826941">!=</span>&nbsp;<span class="ident" id="7826944">nil</span>&nbsp;<span class="op" id="7826948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7826952">t</span><span class="op" id="7826953">.</span><span class="ident" id="7826954">Fatal</span><span class="op" id="7826959">(</span><span class="ident" id="7826960">err</span><span class="op" id="7826963">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7826966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7826969">c</span><span class="op" id="7826970">,</span>&nbsp;<span class="ident" id="7826972">err</span>&nbsp;<span class="op" id="7826976">:=</span>&nbsp;<span class="ident" id="7826979">Dial</span><span class="op" id="7826983">(</span><span class="string" id="7826984">&#34;tcp&#34;</span><span class="op" id="7826989">,</span>&nbsp;<span class="ident" id="7826991">l</span><span class="op" id="7826992">.</span><span class="ident" id="7826993">Addr</span><span class="op" id="7826997">(</span><span class="op" id="7826998">)</span><span class="op" id="7826999">.</span><span class="ident" id="7827000">String</span><span class="op" id="7827006">(</span><span class="op" id="7827007">)</span><span class="op" id="7827008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7827011">if</span>&nbsp;<span class="ident" id="7827014">err</span>&nbsp;<span class="op" id="7827018">!=</span>&nbsp;<span class="ident" id="7827021">nil</span>&nbsp;<span class="op" id="7827025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7827029">t</span><span class="op" id="7827030">.</span><span class="ident" id="7827031">Fatal</span><span class="op" id="7827036">(</span><span class="ident" id="7827037">err</span><span class="op" id="7827040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7827043">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7827046">addr</span>&nbsp;<span class="op" id="7827051">:=</span>&nbsp;<span class="ident" id="7827054">c</span><span class="op" id="7827055">.</span><span class="ident" id="7827056">LocalAddr</span><span class="op" id="7827065">(</span><span class="op" id="7827066">)</span><span class="op" id="7827067">.</span><span class="ident" id="7827068">String</span><span class="op" id="7827074">(</span><span class="op" id="7827075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7827078">c</span><span class="op" id="7827079">.</span><span class="ident" id="7827080">Close</span><span class="op" id="7827085">(</span><span class="op" id="7827086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7827089">l</span><span class="op" id="7827090">.</span><span class="ident" id="7827091">Close</span><span class="op" id="7827096">(</span><span class="op" id="7827097">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7827101">//&nbsp;Try&nbsp;to&nbsp;connect&nbsp;to&nbsp;that&nbsp;address&nbsp;repeatedly.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7827148">n</span>&nbsp;<span class="op" id="7827150">:=</span>&nbsp;<span class="num" id="7827153">100000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7827161">if</span>&nbsp;<span class="ident" id="7827164">testing</span><span class="op" id="7827171">.</span><span class="ident" id="7827172">Short</span><span class="op" id="7827177">(</span><span class="op" id="7827178">)</span>&nbsp;<span class="op" id="7827180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7827184">n</span>&nbsp;<span class="op" id="7827186">=</span>&nbsp;<span class="num" id="7827188">1000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7827194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7827197">switch</span>&nbsp;<span class="ident" id="7827204">runtime</span><span class="op" id="7827211">.</span><span class="ident" id="7827212">GOOS</span>&nbsp;<span class="op" id="7827217">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7827220">case</span>&nbsp;<span class="string" id="7827225">&#34;darwin&#34;</span><span class="op" id="7827233">,</span>&nbsp;<span class="string" id="7827235">&#34;dragonfly&#34;</span><span class="op" id="7827246">,</span>&nbsp;<span class="string" id="7827248">&#34;freebsd&#34;</span><span class="op" id="7827257">,</span>&nbsp;<span class="string" id="7827259">&#34;netbsd&#34;</span><span class="op" id="7827267">,</span>&nbsp;<span class="string" id="7827269">&#34;openbsd&#34;</span><span class="op" id="7827278">,</span>&nbsp;<span class="string" id="7827280">&#34;plan9&#34;</span><span class="op" id="7827287">,</span>&nbsp;<span class="string" id="7827289">&#34;solaris&#34;</span><span class="op" id="7827298">,</span>&nbsp;<span class="string" id="7827300">&#34;windows&#34;</span><span class="op" id="7827309">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7827313">//&nbsp;Non-Linux&nbsp;systems&nbsp;take&nbsp;a&nbsp;long&nbsp;time&nbsp;to&nbsp;figure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7827363">//&nbsp;out&nbsp;that&nbsp;there&nbsp;is&nbsp;nothing&nbsp;listening&nbsp;on&nbsp;localhost.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7827418">n</span>&nbsp;<span class="op" id="7827420">=</span>&nbsp;<span class="num" id="7827422">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7827427">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7827430">for</span>&nbsp;<span class="ident" id="7827434">i</span>&nbsp;<span class="op" id="7827436">:=</span>&nbsp;<span class="num" id="7827439">0</span><span class="op" id="7827440">;</span>&nbsp;<span class="ident" id="7827442">i</span>&nbsp;<span class="op" id="7827444">&lt;</span>&nbsp;<span class="ident" id="7827446">n</span><span class="op" id="7827447">;</span>&nbsp;<span class="ident" id="7827449">i</span><span class="op" id="7827450">++</span>&nbsp;<span class="op" id="7827453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7827457">c</span><span class="op" id="7827458">,</span>&nbsp;<span class="ident" id="7827460">err</span>&nbsp;<span class="op" id="7827464">:=</span>&nbsp;<span class="ident" id="7827467">DialTimeout</span><span class="op" id="7827478">(</span><span class="string" id="7827479">&#34;tcp&#34;</span><span class="op" id="7827484">,</span>&nbsp;<span class="ident" id="7827486">addr</span><span class="op" id="7827490">,</span>&nbsp;<span class="ident" id="7827492">time</span><span class="op" id="7827496">.</span><span class="ident" id="7827497">Millisecond</span><span class="op" id="7827508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7827512">if</span>&nbsp;<span class="ident" id="7827515">err</span>&nbsp;<span class="op" id="7827519">==</span>&nbsp;<span class="ident" id="7827522">nil</span>&nbsp;<span class="op" id="7827526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7827531">if</span>&nbsp;<span class="ident" id="7827534">c</span><span class="op" id="7827535">.</span><span class="ident" id="7827536">LocalAddr</span><span class="op" id="7827545">(</span><span class="op" id="7827546">)</span><span class="op" id="7827547">.</span><span class="ident" id="7827548">String</span><span class="op" id="7827554">(</span><span class="op" id="7827555">)</span>&nbsp;<span class="op" id="7827557">==</span>&nbsp;<span class="ident" id="7827560">addr</span>&nbsp;<span class="op" id="7827565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7827571">t</span><span class="op" id="7827572">.</span><span class="ident" id="7827573">Errorf</span><span class="op" id="7827579">(</span><span class="string" id="7827580">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;self-connect&#34;</span><span class="op" id="7827607">,</span>&nbsp;<span class="ident" id="7827609">i</span><span class="op" id="7827610">,</span>&nbsp;<span class="ident" id="7827612">addr</span><span class="op" id="7827616">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7827621">}</span>&nbsp;<span class="keyword" id="7827623">else</span>&nbsp;<span class="op" id="7827628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7827634">t</span><span class="op" id="7827635">.</span><span class="ident" id="7827636">Logf</span><span class="op" id="7827640">(</span><span class="string" id="7827641">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;succeeded&nbsp;-&nbsp;possibly&nbsp;racing&nbsp;with&nbsp;other&nbsp;listener&#34;</span><span class="op" id="7827703">,</span>&nbsp;<span class="ident" id="7827705">i</span><span class="op" id="7827706">,</span>&nbsp;<span class="ident" id="7827708">addr</span><span class="op" id="7827712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7827717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7827722">c</span><span class="op" id="7827723">.</span><span class="ident" id="7827724">Close</span><span class="op" id="7827729">(</span><span class="op" id="7827730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7827734">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7827737">}</span><br>
<span class="lineno"></span><span class="op" id="7827739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7827742">var</span>&nbsp;<span class="ident" id="7827746">runErrorTest</span>&nbsp;<span class="op" id="7827759">=</span>&nbsp;<span class="ident" id="7827761">flag</span><span class="op" id="7827765">.</span><span class="ident" id="7827766">Bool</span><span class="op" id="7827770">(</span><span class="string" id="7827771">&#34;run_error_test&#34;</span><span class="op" id="7827787">,</span>&nbsp;<span class="builtintype" id="7827789">false</span><span class="op" id="7827794">,</span>&nbsp;<span class="string" id="7827796">&#34;let&nbsp;TestDialError&nbsp;check&nbsp;for&nbsp;dns&nbsp;errors&#34;</span><span class="op" id="7827836">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="7827839">type</span>&nbsp;<span class="ident" id="7827844">DialErrorTest</span>&nbsp;<span class="keyword" id="7827858">struct</span>&nbsp;<span class="op" id="7827865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7827868">Net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7827876">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7827884">Raddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7827892">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7827900">Pattern</span>&nbsp;<span class="builtintype" id="7827908">string</span><br>
<span class="lineno"></span><span class="op" id="7827915">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="7827918">var</span>&nbsp;<span class="ident" id="7827922">dialErrorTests</span>&nbsp;<span class="op" id="7827937">=</span>&nbsp;<span class="op" id="7827939">[</span><span class="op" id="7827940">]</span><span class="ident" id="7827941">DialErrorTest</span><span class="op" id="7827954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7827957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7827961">&#34;datakit&#34;</span><span class="op" id="7827970">,</span>&nbsp;<span class="string" id="7827972">&#34;mh/astro/r70&#34;</span><span class="op" id="7827986">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7827990">&#34;dial&nbsp;datakit&nbsp;mh/astro/r70:&nbsp;unknown&nbsp;network&nbsp;datakit&#34;</span><span class="op" id="7828042">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7828045">}</span><span class="op" id="7828046">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7828049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7828053">&#34;tcp&#34;</span><span class="op" id="7828058">,</span>&nbsp;<span class="string" id="7828060">&#34;127.0.0.1:☺&#34;</span><span class="op" id="7828075">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7828079">&#34;dial&nbsp;tcp&nbsp;127.0.0.1:☺:&nbsp;unknown&nbsp;port&nbsp;tcp/☺&#34;</span><span class="op" id="7828125">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7828128">}</span><span class="op" id="7828129">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7828132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7828136">&#34;tcp&#34;</span><span class="op" id="7828141">,</span>&nbsp;<span class="string" id="7828143">&#34;no-such-name.google.com.:80&#34;</span><span class="op" id="7828172">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7828176">&#34;dial&nbsp;tcp&nbsp;no-such-name.google.com.:80:&nbsp;lookup&nbsp;no-such-name.google.com.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="7828265">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7828268">}</span><span class="op" id="7828269">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7828272">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7828276">&#34;tcp&#34;</span><span class="op" id="7828281">,</span>&nbsp;<span class="string" id="7828283">&#34;no-such-name.no-such-top-level-domain.:80&#34;</span><span class="op" id="7828326">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7828330">&#34;dial&nbsp;tcp&nbsp;no-such-name.no-such-top-level-domain.:80:&nbsp;lookup&nbsp;no-such-name.no-such-top-level-domain.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="7828447">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7828450">}</span><span class="op" id="7828451">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7828454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7828458">&#34;tcp&#34;</span><span class="op" id="7828463">,</span>&nbsp;<span class="string" id="7828465">&#34;no-such-name:80&#34;</span><span class="op" id="7828482">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7828486">`dial&nbsp;tcp&nbsp;no-such-name:80:&nbsp;lookup&nbsp;no-such-name\.(.*\.)?(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)`</span><span class="op" id="7828560">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7828563">}</span><span class="op" id="7828564">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7828567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7828571">&#34;tcp&#34;</span><span class="op" id="7828576">,</span>&nbsp;<span class="string" id="7828578">&#34;mh/astro/r70:http&#34;</span><span class="op" id="7828597">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7828601">&#34;dial&nbsp;tcp&nbsp;mh/astro/r70:http:&nbsp;lookup&nbsp;mh/astro/r70:&nbsp;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="7828671">,</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7828674">}</span><span class="op" id="7828675">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7828678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7828682">&#34;unix&#34;</span><span class="op" id="7828688">,</span>&nbsp;<span class="string" id="7828690">&#34;/etc/file-not-found&#34;</span><span class="op" id="7828711">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7828715">&#34;dial&nbsp;unix&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="7828773">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7828776">}</span><span class="op" id="7828777">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7828780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7828784">&#34;unix&#34;</span><span class="op" id="7828790">,</span>&nbsp;<span class="string" id="7828792">&#34;/etc/&#34;</span><span class="op" id="7828799">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7828803">&#34;dial&nbsp;unix&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="7828891">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7828894">}</span><span class="op" id="7828895">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7828898">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7828902">&#34;unixpacket&#34;</span><span class="op" id="7828914">,</span>&nbsp;<span class="string" id="7828916">&#34;/etc/file-not-found&#34;</span><span class="op" id="7828937">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7828941">&#34;dial&nbsp;unixpacket&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="7829005">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7829008">}</span><span class="op" id="7829009">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7829012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7829016">&#34;unixpacket&#34;</span><span class="op" id="7829028">,</span>&nbsp;<span class="string" id="7829030">&#34;/etc/&#34;</span><span class="op" id="7829037">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7829041">&#34;dial&nbsp;unixpacket&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="7829135">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7829138">}</span><span class="op" id="7829139">,</span><br>
<span class="lineno"></span><span class="op" id="7829141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7829144">var</span>&nbsp;<span class="ident" id="7829148">duplicateErrorPattern</span>&nbsp;<span class="op" id="7829170">=</span>&nbsp;<span class="string" id="7829172">`dial&nbsp;(.*)&nbsp;dial&nbsp;(.*)`</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="7829195">func</span>&nbsp;<span class="ident" id="7829200">TestDialError</span><span class="op" id="7829213">(</span><span class="ident" id="7829214">t</span>&nbsp;<span class="op" id="7829216">*</span><span class="ident" id="7829217">testing</span><span class="op" id="7829224">.</span><span class="ident" id="7829225">T</span><span class="op" id="7829226">)</span>&nbsp;<span class="op" id="7829228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7829231">if</span>&nbsp;<span class="op" id="7829234">!</span><span class="op" id="7829235">*</span><span class="ident" id="7829236">runErrorTest</span>&nbsp;<span class="op" id="7829249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7829253">t</span><span class="op" id="7829254">.</span><span class="ident" id="7829255">Logf</span><span class="op" id="7829259">(</span><span class="string" id="7829260">&#34;test&nbsp;disabled;&nbsp;use&nbsp;-run_error_test&nbsp;to&nbsp;enable&#34;</span><span class="op" id="7829306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7829310">return</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7829318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7829321">for</span>&nbsp;<span class="ident" id="7829325">i</span><span class="op" id="7829326">,</span>&nbsp;<span class="ident" id="7829328">tt</span>&nbsp;<span class="op" id="7829331">:=</span>&nbsp;<span class="keyword" id="7829334">range</span>&nbsp;<span class="ident" id="7829340">dialErrorTests</span>&nbsp;<span class="op" id="7829355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7829359">c</span><span class="op" id="7829360">,</span>&nbsp;<span class="ident" id="7829362">err</span>&nbsp;<span class="op" id="7829366">:=</span>&nbsp;<span class="ident" id="7829369">Dial</span><span class="op" id="7829373">(</span><span class="ident" id="7829374">tt</span><span class="op" id="7829376">.</span><span class="ident" id="7829377">Net</span><span class="op" id="7829380">,</span>&nbsp;<span class="ident" id="7829382">tt</span><span class="op" id="7829384">.</span><span class="ident" id="7829385">Raddr</span><span class="op" id="7829390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7829394">if</span>&nbsp;<span class="ident" id="7829397">c</span>&nbsp;<span class="op" id="7829399">!=</span>&nbsp;<span class="ident" id="7829402">nil</span>&nbsp;<span class="op" id="7829406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7829411">c</span><span class="op" id="7829412">.</span><span class="ident" id="7829413">Close</span><span class="op" id="7829418">(</span><span class="op" id="7829419">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7829423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7829427">if</span>&nbsp;<span class="ident" id="7829430">err</span>&nbsp;<span class="op" id="7829434">==</span>&nbsp;<span class="ident" id="7829437">nil</span>&nbsp;<span class="op" id="7829441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7829446">t</span><span class="op" id="7829447">.</span><span class="ident" id="7829448">Errorf</span><span class="op" id="7829454">(</span><span class="string" id="7829455">&#34;#%d:&nbsp;nil&nbsp;error,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="7829491">,</span>&nbsp;<span class="ident" id="7829493">i</span><span class="op" id="7829494">,</span>&nbsp;<span class="ident" id="7829496">tt</span><span class="op" id="7829498">.</span><span class="ident" id="7829499">Pattern</span><span class="op" id="7829506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7829511">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7829522">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7829526">s</span>&nbsp;<span class="op" id="7829528">:=</span>&nbsp;<span class="ident" id="7829531">err</span><span class="op" id="7829534">.</span><span class="ident" id="7829535">Error</span><span class="op" id="7829540">(</span><span class="op" id="7829541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7829545">match</span><span class="op" id="7829550">,</span>&nbsp;<span class="ident" id="7829552">_</span>&nbsp;<span class="op" id="7829554">:=</span>&nbsp;<span class="ident" id="7829557">regexp</span><span class="op" id="7829563">.</span><span class="ident" id="7829564">MatchString</span><span class="op" id="7829575">(</span><span class="ident" id="7829576">tt</span><span class="op" id="7829578">.</span><span class="ident" id="7829579">Pattern</span><span class="op" id="7829586">,</span>&nbsp;<span class="ident" id="7829588">s</span><span class="op" id="7829589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7829593">if</span>&nbsp;<span class="op" id="7829596">!</span><span class="ident" id="7829597">match</span>&nbsp;<span class="op" id="7829603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7829608">t</span><span class="op" id="7829609">.</span><span class="ident" id="7829610">Errorf</span><span class="op" id="7829616">(</span><span class="string" id="7829617">&#34;#%d:&nbsp;%q,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="7829646">,</span>&nbsp;<span class="ident" id="7829648">i</span><span class="op" id="7829649">,</span>&nbsp;<span class="ident" id="7829651">s</span><span class="op" id="7829652">,</span>&nbsp;<span class="ident" id="7829654">tt</span><span class="op" id="7829656">.</span><span class="ident" id="7829657">Pattern</span><span class="op" id="7829664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7829668">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7829672">match</span><span class="op" id="7829677">,</span>&nbsp;<span class="ident" id="7829679">_</span>&nbsp;<span class="op" id="7829681">=</span>&nbsp;<span class="ident" id="7829683">regexp</span><span class="op" id="7829689">.</span><span class="ident" id="7829690">MatchString</span><span class="op" id="7829701">(</span><span class="ident" id="7829702">duplicateErrorPattern</span><span class="op" id="7829723">,</span>&nbsp;<span class="ident" id="7829725">s</span><span class="op" id="7829726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7829730">if</span>&nbsp;<span class="ident" id="7829733">match</span>&nbsp;<span class="op" id="7829739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7829744">t</span><span class="op" id="7829745">.</span><span class="ident" id="7829746">Errorf</span><span class="op" id="7829752">(</span><span class="string" id="7829753">&#34;#%d:&nbsp;%q,&nbsp;duplicate&nbsp;error&nbsp;return&nbsp;from&nbsp;Dial&#34;</span><span class="op" id="7829796">,</span>&nbsp;<span class="ident" id="7829798">i</span><span class="op" id="7829799">,</span>&nbsp;<span class="ident" id="7829801">s</span><span class="op" id="7829802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7829806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7829809">}</span><br>
<span class="lineno">240</span><span class="op" id="7829811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7829814">var</span>&nbsp;<span class="ident" id="7829818">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="7829847">=</span>&nbsp;<span class="op" id="7829849">[</span><span class="op" id="7829850">]</span><span class="keyword" id="7829851">struct</span>&nbsp;<span class="op" id="7829858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7829861">net</span>&nbsp;&nbsp;<span class="builtintype" id="7829866">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7829874">addr</span>&nbsp;<span class="builtintype" id="7829879">string</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7829887">err</span>&nbsp;&nbsp;<span class="builtintype" id="7829892">error</span><br>
<span class="lineno"></span><span class="op" id="7829898">}</span><span class="op" id="7829899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7829902">{</span><span class="string" id="7829903">&#34;foo&#34;</span><span class="op" id="7829908">,</span>&nbsp;<span class="string" id="7829910">&#34;bar&#34;</span><span class="op" id="7829915">,</span>&nbsp;<span class="op" id="7829917">&amp;</span><span class="ident" id="7829918">OpError</span><span class="op" id="7829925">{</span><span class="ident" id="7829926">Op</span><span class="op" id="7829928">:</span>&nbsp;<span class="string" id="7829930">&#34;dial&#34;</span><span class="op" id="7829936">,</span>&nbsp;<span class="ident" id="7829938">Net</span><span class="op" id="7829941">:</span>&nbsp;<span class="string" id="7829943">&#34;foo&#34;</span><span class="op" id="7829948">,</span>&nbsp;<span class="ident" id="7829950">Addr</span><span class="op" id="7829954">:</span>&nbsp;<span class="ident" id="7829956">nil</span><span class="op" id="7829959">,</span>&nbsp;<span class="ident" id="7829961">Err</span><span class="op" id="7829964">:</span>&nbsp;<span class="ident" id="7829966">UnknownNetworkError</span><span class="op" id="7829985">(</span><span class="string" id="7829986">&#34;foo&#34;</span><span class="op" id="7829991">)</span><span class="op" id="7829992">}</span><span class="op" id="7829993">}</span><span class="op" id="7829994">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7829997">{</span><span class="string" id="7829998">&#34;baz&#34;</span><span class="op" id="7830003">,</span>&nbsp;<span class="string" id="7830005">&#34;&#34;</span><span class="op" id="7830007">,</span>&nbsp;<span class="op" id="7830009">&amp;</span><span class="ident" id="7830010">OpError</span><span class="op" id="7830017">{</span><span class="ident" id="7830018">Op</span><span class="op" id="7830020">:</span>&nbsp;<span class="string" id="7830022">&#34;listen&#34;</span><span class="op" id="7830030">,</span>&nbsp;<span class="ident" id="7830032">Net</span><span class="op" id="7830035">:</span>&nbsp;<span class="string" id="7830037">&#34;baz&#34;</span><span class="op" id="7830042">,</span>&nbsp;<span class="ident" id="7830044">Addr</span><span class="op" id="7830048">:</span>&nbsp;<span class="ident" id="7830050">nil</span><span class="op" id="7830053">,</span>&nbsp;<span class="ident" id="7830055">Err</span><span class="op" id="7830058">:</span>&nbsp;<span class="ident" id="7830060">UnknownNetworkError</span><span class="op" id="7830079">(</span><span class="string" id="7830080">&#34;baz&#34;</span><span class="op" id="7830085">)</span><span class="op" id="7830086">}</span><span class="op" id="7830087">}</span><span class="op" id="7830088">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7830091">{</span><span class="string" id="7830092">&#34;tcp&#34;</span><span class="op" id="7830097">,</span>&nbsp;<span class="string" id="7830099">&#34;&#34;</span><span class="op" id="7830101">,</span>&nbsp;<span class="op" id="7830103">&amp;</span><span class="ident" id="7830104">OpError</span><span class="op" id="7830111">{</span><span class="ident" id="7830112">Op</span><span class="op" id="7830114">:</span>&nbsp;<span class="string" id="7830116">&#34;dial&#34;</span><span class="op" id="7830122">,</span>&nbsp;<span class="ident" id="7830124">Net</span><span class="op" id="7830127">:</span>&nbsp;<span class="string" id="7830129">&#34;tcp&#34;</span><span class="op" id="7830134">,</span>&nbsp;<span class="ident" id="7830136">Addr</span><span class="op" id="7830140">:</span>&nbsp;<span class="ident" id="7830142">nil</span><span class="op" id="7830145">,</span>&nbsp;<span class="ident" id="7830147">Err</span><span class="op" id="7830150">:</span>&nbsp;<span class="ident" id="7830152">errMissingAddress</span><span class="op" id="7830169">}</span><span class="op" id="7830170">}</span><span class="op" id="7830171">,</span><br>
<span class="lineno">250</span><span class="op" id="7830173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7830176">func</span>&nbsp;<span class="ident" id="7830181">TestInvalidDialAndListenArgs</span><span class="op" id="7830209">(</span><span class="ident" id="7830210">t</span>&nbsp;<span class="op" id="7830212">*</span><span class="ident" id="7830213">testing</span><span class="op" id="7830220">.</span><span class="ident" id="7830221">T</span><span class="op" id="7830222">)</span>&nbsp;<span class="op" id="7830224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7830227">for</span>&nbsp;<span class="ident" id="7830231">_</span><span class="op" id="7830232">,</span>&nbsp;<span class="ident" id="7830234">tt</span>&nbsp;<span class="op" id="7830237">:=</span>&nbsp;<span class="keyword" id="7830240">range</span>&nbsp;<span class="ident" id="7830246">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="7830275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7830279">var</span>&nbsp;<span class="ident" id="7830283">err</span>&nbsp;<span class="builtintype" id="7830287">error</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7830295">switch</span>&nbsp;<span class="ident" id="7830302">tt</span><span class="op" id="7830304">.</span><span class="ident" id="7830305">err</span><span class="op" id="7830308">.</span><span class="op" id="7830309">(</span><span class="op" id="7830310">*</span><span class="ident" id="7830311">OpError</span><span class="op" id="7830318">)</span><span class="op" id="7830319">.</span><span class="ident" id="7830320">Op</span>&nbsp;<span class="op" id="7830323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7830327">case</span>&nbsp;<span class="string" id="7830332">&#34;dial&#34;</span><span class="op" id="7830338">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7830343">_</span><span class="op" id="7830344">,</span>&nbsp;<span class="ident" id="7830346">err</span>&nbsp;<span class="op" id="7830350">=</span>&nbsp;<span class="ident" id="7830352">Dial</span><span class="op" id="7830356">(</span><span class="ident" id="7830357">tt</span><span class="op" id="7830359">.</span><span class="ident" id="7830360">net</span><span class="op" id="7830363">,</span>&nbsp;<span class="ident" id="7830365">tt</span><span class="op" id="7830367">.</span><span class="ident" id="7830368">addr</span><span class="op" id="7830372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7830376">case</span>&nbsp;<span class="string" id="7830381">&#34;listen&#34;</span><span class="op" id="7830389">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7830394">_</span><span class="op" id="7830395">,</span>&nbsp;<span class="ident" id="7830397">err</span>&nbsp;<span class="op" id="7830401">=</span>&nbsp;<span class="ident" id="7830403">Listen</span><span class="op" id="7830409">(</span><span class="ident" id="7830410">tt</span><span class="op" id="7830412">.</span><span class="ident" id="7830413">net</span><span class="op" id="7830416">,</span>&nbsp;<span class="ident" id="7830418">tt</span><span class="op" id="7830420">.</span><span class="ident" id="7830421">addr</span><span class="op" id="7830425">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7830429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7830433">if</span>&nbsp;<span class="op" id="7830436">!</span><span class="ident" id="7830437">reflect</span><span class="op" id="7830444">.</span><span class="ident" id="7830445">DeepEqual</span><span class="op" id="7830454">(</span><span class="ident" id="7830455">tt</span><span class="op" id="7830457">.</span><span class="ident" id="7830458">err</span><span class="op" id="7830461">,</span>&nbsp;<span class="ident" id="7830463">err</span><span class="op" id="7830466">)</span>&nbsp;<span class="op" id="7830468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7830473">t</span><span class="op" id="7830474">.</span><span class="ident" id="7830475">Fatalf</span><span class="op" id="7830481">(</span><span class="string" id="7830482">&#34;got&nbsp;%#v;&nbsp;expected&nbsp;%#v&#34;</span><span class="op" id="7830505">,</span>&nbsp;<span class="ident" id="7830507">err</span><span class="op" id="7830510">,</span>&nbsp;<span class="ident" id="7830512">tt</span><span class="op" id="7830514">.</span><span class="ident" id="7830515">err</span><span class="op" id="7830518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7830522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7830525">}</span><br>
<span class="lineno">265</span><span class="op" id="7830527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7830530">func</span>&nbsp;<span class="ident" id="7830535">TestDialTimeoutFDLeak</span><span class="op" id="7830556">(</span><span class="ident" id="7830557">t</span>&nbsp;<span class="op" id="7830559">*</span><span class="ident" id="7830560">testing</span><span class="op" id="7830567">.</span><span class="ident" id="7830568">T</span><span class="op" id="7830569">)</span>&nbsp;<span class="op" id="7830571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7830574">if</span>&nbsp;<span class="ident" id="7830577">runtime</span><span class="op" id="7830584">.</span><span class="ident" id="7830585">GOOS</span>&nbsp;<span class="op" id="7830590">!=</span>&nbsp;<span class="string" id="7830593">&#34;linux&#34;</span>&nbsp;<span class="op" id="7830601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7830605">//&nbsp;TODO(bradfitz):&nbsp;test&nbsp;on&nbsp;other&nbsp;platforms</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7830650">t</span><span class="op" id="7830651">.</span><span class="ident" id="7830652">Skipf</span><span class="op" id="7830657">(</span><span class="string" id="7830658">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7830679">,</span>&nbsp;<span class="ident" id="7830681">runtime</span><span class="op" id="7830688">.</span><span class="ident" id="7830689">GOOS</span><span class="op" id="7830693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7830696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7830700">ln</span>&nbsp;<span class="op" id="7830703">:=</span>&nbsp;<span class="ident" id="7830706">newLocalListener</span><span class="op" id="7830722">(</span><span class="ident" id="7830723">t</span><span class="op" id="7830724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7830727">defer</span>&nbsp;<span class="ident" id="7830733">ln</span><span class="op" id="7830735">.</span><span class="ident" id="7830736">Close</span><span class="op" id="7830741">(</span><span class="op" id="7830742">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7830746">type</span>&nbsp;<span class="ident" id="7830751">connErr</span>&nbsp;<span class="keyword" id="7830759">struct</span>&nbsp;<span class="op" id="7830766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7830770">conn</span>&nbsp;<span class="ident" id="7830775">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7830782">err</span>&nbsp;&nbsp;<span class="builtintype" id="7830787">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7830794">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7830797">dials</span>&nbsp;<span class="op" id="7830803">:=</span>&nbsp;<span class="ident" id="7830806">listenerBacklog</span>&nbsp;<span class="op" id="7830822">+</span>&nbsp;<span class="num" id="7830824">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7830829">//&nbsp;used&nbsp;to&nbsp;be&nbsp;listenerBacklog&nbsp;+&nbsp;5,&nbsp;but&nbsp;was&nbsp;found&nbsp;to&nbsp;be&nbsp;unreliable,&nbsp;issue&nbsp;4384.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7830909">maxGoodConnect</span>&nbsp;<span class="op" id="7830924">:=</span>&nbsp;<span class="ident" id="7830927">listenerBacklog</span>&nbsp;<span class="op" id="7830943">+</span>&nbsp;<span class="ident" id="7830945">runtime</span><span class="op" id="7830952">.</span><span class="ident" id="7830953">NumCPU</span><span class="op" id="7830959">(</span><span class="op" id="7830960">)</span><span class="op" id="7830961">*</span><span class="num" id="7830962">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7830966">resc</span>&nbsp;<span class="op" id="7830971">:=</span>&nbsp;<span class="builtinfunc" id="7830974">make</span><span class="op" id="7830978">(</span><span class="keyword" id="7830979">chan</span>&nbsp;<span class="ident" id="7830984">connErr</span><span class="op" id="7830991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7830994">for</span>&nbsp;<span class="ident" id="7830998">i</span>&nbsp;<span class="op" id="7831000">:=</span>&nbsp;<span class="num" id="7831003">0</span><span class="op" id="7831004">;</span>&nbsp;<span class="ident" id="7831006">i</span>&nbsp;<span class="op" id="7831008">&lt;</span>&nbsp;<span class="ident" id="7831010">dials</span><span class="op" id="7831015">;</span>&nbsp;<span class="ident" id="7831017">i</span><span class="op" id="7831018">++</span>&nbsp;<span class="op" id="7831021">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7831025">go</span>&nbsp;<span class="keyword" id="7831028">func</span><span class="op" id="7831032">(</span><span class="op" id="7831033">)</span>&nbsp;<span class="op" id="7831035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7831040">conn</span><span class="op" id="7831044">,</span>&nbsp;<span class="ident" id="7831046">err</span>&nbsp;<span class="op" id="7831050">:=</span>&nbsp;<span class="ident" id="7831053">DialTimeout</span><span class="op" id="7831064">(</span><span class="string" id="7831065">&#34;tcp&#34;</span><span class="op" id="7831070">,</span>&nbsp;<span class="ident" id="7831072">ln</span><span class="op" id="7831074">.</span><span class="ident" id="7831075">Addr</span><span class="op" id="7831079">(</span><span class="op" id="7831080">)</span><span class="op" id="7831081">.</span><span class="ident" id="7831082">String</span><span class="op" id="7831088">(</span><span class="op" id="7831089">)</span><span class="op" id="7831090">,</span>&nbsp;<span class="num" id="7831092">500</span><span class="op" id="7831095">*</span><span class="ident" id="7831096">time</span><span class="op" id="7831100">.</span><span class="ident" id="7831101">Millisecond</span><span class="op" id="7831112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7831117">resc</span>&nbsp;<span class="op" id="7831122">&lt;-</span>&nbsp;<span class="ident" id="7831125">connErr</span><span class="op" id="7831132">{</span><span class="ident" id="7831133">conn</span><span class="op" id="7831137">,</span>&nbsp;<span class="ident" id="7831139">err</span><span class="op" id="7831142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7831146">}</span><span class="op" id="7831147">(</span><span class="op" id="7831148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7831151">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7831155">var</span>&nbsp;<span class="ident" id="7831159">firstErr</span>&nbsp;<span class="builtintype" id="7831168">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7831176">var</span>&nbsp;<span class="ident" id="7831180">ngood</span>&nbsp;<span class="builtintype" id="7831186">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7831191">var</span>&nbsp;<span class="ident" id="7831195">toClose</span>&nbsp;<span class="op" id="7831203">[</span><span class="op" id="7831204">]</span><span class="ident" id="7831205">io</span><span class="op" id="7831207">.</span><span class="ident" id="7831208">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7831216">for</span>&nbsp;<span class="ident" id="7831220">i</span>&nbsp;<span class="op" id="7831222">:=</span>&nbsp;<span class="num" id="7831225">0</span><span class="op" id="7831226">;</span>&nbsp;<span class="ident" id="7831228">i</span>&nbsp;<span class="op" id="7831230">&lt;</span>&nbsp;<span class="ident" id="7831232">dials</span><span class="op" id="7831237">;</span>&nbsp;<span class="ident" id="7831239">i</span><span class="op" id="7831240">++</span>&nbsp;<span class="op" id="7831243">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7831247">ce</span>&nbsp;<span class="op" id="7831250">:=</span>&nbsp;<span class="op" id="7831253">&lt;-</span><span class="ident" id="7831255">resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7831262">if</span>&nbsp;<span class="ident" id="7831265">ce</span><span class="op" id="7831267">.</span><span class="ident" id="7831268">err</span>&nbsp;<span class="op" id="7831272">==</span>&nbsp;<span class="ident" id="7831275">nil</span>&nbsp;<span class="op" id="7831279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7831284">ngood</span><span class="op" id="7831289">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7831295">if</span>&nbsp;<span class="ident" id="7831298">ngood</span>&nbsp;<span class="op" id="7831304">&gt;</span>&nbsp;<span class="ident" id="7831306">maxGoodConnect</span>&nbsp;<span class="op" id="7831321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7831327">t</span><span class="op" id="7831328">.</span><span class="ident" id="7831329">Errorf</span><span class="op" id="7831335">(</span><span class="string" id="7831336">&#34;%d&nbsp;good&nbsp;connects;&nbsp;expected&nbsp;at&nbsp;most&nbsp;%d&#34;</span><span class="op" id="7831375">,</span>&nbsp;<span class="ident" id="7831377">ngood</span><span class="op" id="7831382">,</span>&nbsp;<span class="ident" id="7831384">maxGoodConnect</span><span class="op" id="7831398">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7831403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7831408">toClose</span>&nbsp;<span class="op" id="7831416">=</span>&nbsp;<span class="builtinfunc" id="7831418">append</span><span class="op" id="7831424">(</span><span class="ident" id="7831425">toClose</span><span class="op" id="7831432">,</span>&nbsp;<span class="ident" id="7831434">ce</span><span class="op" id="7831436">.</span><span class="ident" id="7831437">conn</span><span class="op" id="7831441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7831446">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7831457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7831461">err</span>&nbsp;<span class="op" id="7831465">:=</span>&nbsp;<span class="ident" id="7831468">ce</span><span class="op" id="7831470">.</span><span class="ident" id="7831471">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7831477">if</span>&nbsp;<span class="ident" id="7831480">firstErr</span>&nbsp;<span class="op" id="7831489">==</span>&nbsp;<span class="string" id="7831492">&#34;&#34;</span>&nbsp;<span class="op" id="7831495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7831500">firstErr</span>&nbsp;<span class="op" id="7831509">=</span>&nbsp;<span class="ident" id="7831511">err</span><span class="op" id="7831514">.</span><span class="ident" id="7831515">Error</span><span class="op" id="7831520">(</span><span class="op" id="7831521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7831525">}</span>&nbsp;<span class="keyword" id="7831527">else</span>&nbsp;<span class="keyword" id="7831532">if</span>&nbsp;<span class="ident" id="7831535">err</span><span class="op" id="7831538">.</span><span class="ident" id="7831539">Error</span><span class="op" id="7831544">(</span><span class="op" id="7831545">)</span>&nbsp;<span class="op" id="7831547">!=</span>&nbsp;<span class="ident" id="7831550">firstErr</span>&nbsp;<span class="op" id="7831559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7831564">t</span><span class="op" id="7831565">.</span><span class="ident" id="7831566">Fatalf</span><span class="op" id="7831572">(</span><span class="string" id="7831573">&#34;inconsistent&nbsp;error&nbsp;messages:&nbsp;first&nbsp;was&nbsp;%q,&nbsp;then&nbsp;later&nbsp;%q&#34;</span><span class="op" id="7831631">,</span>&nbsp;<span class="ident" id="7831633">firstErr</span><span class="op" id="7831641">,</span>&nbsp;<span class="ident" id="7831643">err</span><span class="op" id="7831646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7831650">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7831653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7831656">for</span>&nbsp;<span class="ident" id="7831660">_</span><span class="op" id="7831661">,</span>&nbsp;<span class="ident" id="7831663">c</span>&nbsp;<span class="op" id="7831665">:=</span>&nbsp;<span class="keyword" id="7831668">range</span>&nbsp;<span class="ident" id="7831674">toClose</span>&nbsp;<span class="op" id="7831682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7831686">c</span><span class="op" id="7831687">.</span><span class="ident" id="7831688">Close</span><span class="op" id="7831693">(</span><span class="op" id="7831694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7831697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7831700">for</span>&nbsp;<span class="ident" id="7831704">i</span>&nbsp;<span class="op" id="7831706">:=</span>&nbsp;<span class="num" id="7831709">0</span><span class="op" id="7831710">;</span>&nbsp;<span class="ident" id="7831712">i</span>&nbsp;<span class="op" id="7831714">&lt;</span>&nbsp;<span class="num" id="7831716">100</span><span class="op" id="7831719">;</span>&nbsp;<span class="ident" id="7831721">i</span><span class="op" id="7831722">++</span>&nbsp;<span class="op" id="7831725">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7831729">if</span>&nbsp;<span class="ident" id="7831732">got</span>&nbsp;<span class="op" id="7831736">:=</span>&nbsp;<span class="ident" id="7831739">numFD</span><span class="op" id="7831744">(</span><span class="op" id="7831745">)</span><span class="op" id="7831746">;</span>&nbsp;<span class="ident" id="7831748">got</span>&nbsp;<span class="op" id="7831752">&lt;</span>&nbsp;<span class="ident" id="7831754">dials</span>&nbsp;<span class="op" id="7831760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7831765">//&nbsp;Test&nbsp;passes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7831784">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7831793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7831797">time</span><span class="op" id="7831801">.</span><span class="ident" id="7831802">Sleep</span><span class="op" id="7831807">(</span><span class="num" id="7831808">10</span>&nbsp;<span class="op" id="7831811">*</span>&nbsp;<span class="ident" id="7831813">time</span><span class="op" id="7831817">.</span><span class="ident" id="7831818">Millisecond</span><span class="op" id="7831829">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7831832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7831835">if</span>&nbsp;<span class="ident" id="7831838">got</span>&nbsp;<span class="op" id="7831842">:=</span>&nbsp;<span class="ident" id="7831845">numFD</span><span class="op" id="7831850">(</span><span class="op" id="7831851">)</span><span class="op" id="7831852">;</span>&nbsp;<span class="ident" id="7831854">got</span>&nbsp;<span class="op" id="7831858">&gt;=</span>&nbsp;<span class="ident" id="7831861">dials</span>&nbsp;<span class="op" id="7831867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7831871">t</span><span class="op" id="7831872">.</span><span class="ident" id="7831873">Errorf</span><span class="op" id="7831879">(</span><span class="string" id="7831880">&#34;num&nbsp;fds&nbsp;after&nbsp;%d&nbsp;timeouts&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;%d&#34;</span><span class="op" id="7831922">,</span>&nbsp;<span class="ident" id="7831924">dials</span><span class="op" id="7831929">,</span>&nbsp;<span class="ident" id="7831931">got</span><span class="op" id="7831934">,</span>&nbsp;<span class="ident" id="7831936">dials</span><span class="op" id="7831941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7831944">}</span><br>
<span class="lineno"></span><span class="op" id="7831946">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="7831949">func</span>&nbsp;<span class="ident" id="7831954">numTCP</span><span class="op" id="7831960">(</span><span class="op" id="7831961">)</span>&nbsp;<span class="op" id="7831963">(</span><span class="ident" id="7831964">ntcp</span><span class="op" id="7831968">,</span>&nbsp;<span class="ident" id="7831970">nopen</span><span class="op" id="7831975">,</span>&nbsp;<span class="ident" id="7831977">nclose</span>&nbsp;<span class="builtintype" id="7831984">int</span><span class="op" id="7831987">,</span>&nbsp;<span class="ident" id="7831989">err</span>&nbsp;<span class="builtintype" id="7831993">error</span><span class="op" id="7831998">)</span>&nbsp;<span class="op" id="7832000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7832003">lsof</span><span class="op" id="7832007">,</span>&nbsp;<span class="ident" id="7832009">err</span>&nbsp;<span class="op" id="7832013">:=</span>&nbsp;<span class="ident" id="7832016">exec</span><span class="op" id="7832020">.</span><span class="ident" id="7832021">Command</span><span class="op" id="7832028">(</span><span class="string" id="7832029">&#34;lsof&#34;</span><span class="op" id="7832035">,</span>&nbsp;<span class="string" id="7832037">&#34;-n&#34;</span><span class="op" id="7832041">,</span>&nbsp;<span class="string" id="7832043">&#34;-p&#34;</span><span class="op" id="7832047">,</span>&nbsp;<span class="ident" id="7832049">strconv</span><span class="op" id="7832056">.</span><span class="ident" id="7832057">Itoa</span><span class="op" id="7832061">(</span><span class="ident" id="7832062">os</span><span class="op" id="7832064">.</span><span class="ident" id="7832065">Getpid</span><span class="op" id="7832071">(</span><span class="op" id="7832072">)</span><span class="op" id="7832073">)</span><span class="op" id="7832074">)</span><span class="op" id="7832075">.</span><span class="ident" id="7832076">Output</span><span class="op" id="7832082">(</span><span class="op" id="7832083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7832086">if</span>&nbsp;<span class="ident" id="7832089">err</span>&nbsp;<span class="op" id="7832093">!=</span>&nbsp;<span class="ident" id="7832096">nil</span>&nbsp;<span class="op" id="7832100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7832104">return</span>&nbsp;<span class="num" id="7832111">0</span><span class="op" id="7832112">,</span>&nbsp;<span class="num" id="7832114">0</span><span class="op" id="7832115">,</span>&nbsp;<span class="num" id="7832117">0</span><span class="op" id="7832118">,</span>&nbsp;<span class="ident" id="7832120">err</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7832125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7832128">ntcp</span>&nbsp;<span class="op" id="7832133">+=</span>&nbsp;<span class="ident" id="7832136">bytes</span><span class="op" id="7832141">.</span><span class="ident" id="7832142">Count</span><span class="op" id="7832147">(</span><span class="ident" id="7832148">lsof</span><span class="op" id="7832152">,</span>&nbsp;<span class="op" id="7832154">[</span><span class="op" id="7832155">]</span><span class="builtintype" id="7832156">byte</span><span class="op" id="7832160">(</span><span class="string" id="7832161">&#34;TCP&#34;</span><span class="op" id="7832166">)</span><span class="op" id="7832167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7832170">for</span>&nbsp;<span class="ident" id="7832174">_</span><span class="op" id="7832175">,</span>&nbsp;<span class="ident" id="7832177">state</span>&nbsp;<span class="op" id="7832183">:=</span>&nbsp;<span class="keyword" id="7832186">range</span>&nbsp;<span class="op" id="7832192">[</span><span class="op" id="7832193">]</span><span class="builtintype" id="7832194">string</span><span class="op" id="7832200">{</span><span class="string" id="7832201">&#34;LISTEN&#34;</span><span class="op" id="7832209">,</span>&nbsp;<span class="string" id="7832211">&#34;SYN_SENT&#34;</span><span class="op" id="7832221">,</span>&nbsp;<span class="string" id="7832223">&#34;SYN_RECEIVED&#34;</span><span class="op" id="7832237">,</span>&nbsp;<span class="string" id="7832239">&#34;ESTABLISHED&#34;</span><span class="op" id="7832252">}</span>&nbsp;<span class="op" id="7832254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7832258">nopen</span>&nbsp;<span class="op" id="7832264">+=</span>&nbsp;<span class="ident" id="7832267">bytes</span><span class="op" id="7832272">.</span><span class="ident" id="7832273">Count</span><span class="op" id="7832278">(</span><span class="ident" id="7832279">lsof</span><span class="op" id="7832283">,</span>&nbsp;<span class="op" id="7832285">[</span><span class="op" id="7832286">]</span><span class="builtintype" id="7832287">byte</span><span class="op" id="7832291">(</span><span class="ident" id="7832292">state</span><span class="op" id="7832297">)</span><span class="op" id="7832298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7832301">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7832304">for</span>&nbsp;<span class="ident" id="7832308">_</span><span class="op" id="7832309">,</span>&nbsp;<span class="ident" id="7832311">state</span>&nbsp;<span class="op" id="7832317">:=</span>&nbsp;<span class="keyword" id="7832320">range</span>&nbsp;<span class="op" id="7832326">[</span><span class="op" id="7832327">]</span><span class="builtintype" id="7832328">string</span><span class="op" id="7832334">{</span><span class="string" id="7832335">&#34;CLOSED&#34;</span><span class="op" id="7832343">,</span>&nbsp;<span class="string" id="7832345">&#34;CLOSE_WAIT&#34;</span><span class="op" id="7832357">,</span>&nbsp;<span class="string" id="7832359">&#34;LAST_ACK&#34;</span><span class="op" id="7832369">,</span>&nbsp;<span class="string" id="7832371">&#34;FIN_WAIT_1&#34;</span><span class="op" id="7832383">,</span>&nbsp;<span class="string" id="7832385">&#34;FIN_WAIT_2&#34;</span><span class="op" id="7832397">,</span>&nbsp;<span class="string" id="7832399">&#34;CLOSING&#34;</span><span class="op" id="7832408">,</span>&nbsp;<span class="string" id="7832410">&#34;TIME_WAIT&#34;</span><span class="op" id="7832421">}</span>&nbsp;<span class="op" id="7832423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7832427">nclose</span>&nbsp;<span class="op" id="7832434">+=</span>&nbsp;<span class="ident" id="7832437">bytes</span><span class="op" id="7832442">.</span><span class="ident" id="7832443">Count</span><span class="op" id="7832448">(</span><span class="ident" id="7832449">lsof</span><span class="op" id="7832453">,</span>&nbsp;<span class="op" id="7832455">[</span><span class="op" id="7832456">]</span><span class="builtintype" id="7832457">byte</span><span class="op" id="7832461">(</span><span class="ident" id="7832462">state</span><span class="op" id="7832467">)</span><span class="op" id="7832468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7832471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7832474">return</span>&nbsp;<span class="ident" id="7832481">ntcp</span><span class="op" id="7832485">,</span>&nbsp;<span class="ident" id="7832487">nopen</span><span class="op" id="7832492">,</span>&nbsp;<span class="ident" id="7832494">nclose</span><span class="op" id="7832500">,</span>&nbsp;<span class="ident" id="7832502">nil</span><br>
<span class="lineno"></span><span class="op" id="7832506">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="keyword" id="7832509">func</span>&nbsp;<span class="ident" id="7832514">TestDialMultiFDLeak</span><span class="op" id="7832533">(</span><span class="ident" id="7832534">t</span>&nbsp;<span class="op" id="7832536">*</span><span class="ident" id="7832537">testing</span><span class="op" id="7832544">.</span><span class="ident" id="7832545">T</span><span class="op" id="7832546">)</span>&nbsp;<span class="op" id="7832548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7832551">t</span><span class="op" id="7832552">.</span><span class="ident" id="7832553">Skip</span><span class="op" id="7832557">(</span><span class="string" id="7832558">&#34;flaky&nbsp;test&nbsp;-&nbsp;golang.org/issue/8764&#34;</span><span class="op" id="7832594">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7832598">if</span>&nbsp;<span class="op" id="7832601">!</span><span class="ident" id="7832602">supportsIPv4</span>&nbsp;<span class="op" id="7832615">||</span>&nbsp;<span class="op" id="7832618">!</span><span class="ident" id="7832619">supportsIPv6</span>&nbsp;<span class="op" id="7832632">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7832636">t</span><span class="op" id="7832637">.</span><span class="ident" id="7832638">Skip</span><span class="op" id="7832642">(</span><span class="string" id="7832643">&#34;neither&nbsp;ipv4&nbsp;nor&nbsp;ipv6&nbsp;is&nbsp;supported&#34;</span><span class="op" id="7832679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7832682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7832686">halfDeadServer</span>&nbsp;<span class="op" id="7832701">:=</span>&nbsp;<span class="keyword" id="7832704">func</span><span class="op" id="7832708">(</span><span class="ident" id="7832709">dss</span>&nbsp;<span class="op" id="7832713">*</span><span class="ident" id="7832714">dualStackServer</span><span class="op" id="7832729">,</span>&nbsp;<span class="ident" id="7832731">ln</span>&nbsp;<span class="ident" id="7832734">Listener</span><span class="op" id="7832742">)</span>&nbsp;<span class="op" id="7832744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7832748">for</span>&nbsp;<span class="op" id="7832752">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7832757">if</span>&nbsp;<span class="ident" id="7832760">c</span><span class="op" id="7832761">,</span>&nbsp;<span class="ident" id="7832763">err</span>&nbsp;<span class="op" id="7832767">:=</span>&nbsp;<span class="ident" id="7832770">ln</span><span class="op" id="7832772">.</span><span class="ident" id="7832773">Accept</span><span class="op" id="7832779">(</span><span class="op" id="7832780">)</span><span class="op" id="7832781">;</span>&nbsp;<span class="ident" id="7832783">err</span>&nbsp;<span class="op" id="7832787">!=</span>&nbsp;<span class="ident" id="7832790">nil</span>&nbsp;<span class="op" id="7832794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7832800">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7832810">}</span>&nbsp;<span class="keyword" id="7832812">else</span>&nbsp;<span class="op" id="7832817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7832823">//&nbsp;It&nbsp;just&nbsp;keeps&nbsp;established</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7832856">//&nbsp;connections&nbsp;like&nbsp;a&nbsp;half-dead&nbsp;server</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7832899">//&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7832912">dss</span><span class="op" id="7832915">.</span><span class="ident" id="7832916">putConn</span><span class="op" id="7832923">(</span><span class="ident" id="7832924">c</span><span class="op" id="7832925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7832930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7832934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7832937">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7832940">dss</span><span class="op" id="7832943">,</span>&nbsp;<span class="ident" id="7832945">err</span>&nbsp;<span class="op" id="7832949">:=</span>&nbsp;<span class="ident" id="7832952">newDualStackServer</span><span class="op" id="7832970">(</span><span class="op" id="7832971">[</span><span class="op" id="7832972">]</span><span class="ident" id="7832973">streamListener</span><span class="op" id="7832987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7832991">{</span><span class="ident" id="7832992">net</span><span class="op" id="7832995">:</span>&nbsp;<span class="string" id="7832997">&#34;tcp4&#34;</span><span class="op" id="7833003">,</span>&nbsp;<span class="ident" id="7833005">addr</span><span class="op" id="7833009">:</span>&nbsp;<span class="string" id="7833011">&#34;127.0.0.1&#34;</span><span class="op" id="7833022">}</span><span class="op" id="7833023">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7833027">{</span><span class="ident" id="7833028">net</span><span class="op" id="7833031">:</span>&nbsp;<span class="string" id="7833033">&#34;tcp6&#34;</span><span class="op" id="7833039">,</span>&nbsp;<span class="ident" id="7833041">addr</span><span class="op" id="7833045">:</span>&nbsp;<span class="string" id="7833047">&#34;[::1]&#34;</span><span class="op" id="7833054">}</span><span class="op" id="7833055">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7833058">}</span><span class="op" id="7833059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7833062">if</span>&nbsp;<span class="ident" id="7833065">err</span>&nbsp;<span class="op" id="7833069">!=</span>&nbsp;<span class="ident" id="7833072">nil</span>&nbsp;<span class="op" id="7833076">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7833080">t</span><span class="op" id="7833081">.</span><span class="ident" id="7833082">Fatalf</span><span class="op" id="7833088">(</span><span class="string" id="7833089">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7833120">,</span>&nbsp;<span class="ident" id="7833122">err</span><span class="op" id="7833125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7833128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7833131">defer</span>&nbsp;<span class="ident" id="7833137">dss</span><span class="op" id="7833140">.</span><span class="ident" id="7833141">teardown</span><span class="op" id="7833149">(</span><span class="op" id="7833150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7833153">if</span>&nbsp;<span class="ident" id="7833156">err</span>&nbsp;<span class="op" id="7833160">:=</span>&nbsp;<span class="ident" id="7833163">dss</span><span class="op" id="7833166">.</span><span class="ident" id="7833167">buildup</span><span class="op" id="7833174">(</span><span class="ident" id="7833175">halfDeadServer</span><span class="op" id="7833189">)</span><span class="op" id="7833190">;</span>&nbsp;<span class="ident" id="7833192">err</span>&nbsp;<span class="op" id="7833196">!=</span>&nbsp;<span class="ident" id="7833199">nil</span>&nbsp;<span class="op" id="7833203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7833207">t</span><span class="op" id="7833208">.</span><span class="ident" id="7833209">Fatalf</span><span class="op" id="7833215">(</span><span class="string" id="7833216">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7833252">,</span>&nbsp;<span class="ident" id="7833254">err</span><span class="op" id="7833257">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7833260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7833264">_</span><span class="op" id="7833265">,</span>&nbsp;<span class="ident" id="7833267">before</span><span class="op" id="7833273">,</span>&nbsp;<span class="ident" id="7833275">_</span><span class="op" id="7833276">,</span>&nbsp;<span class="ident" id="7833278">err</span>&nbsp;<span class="op" id="7833282">:=</span>&nbsp;<span class="ident" id="7833285">numTCP</span><span class="op" id="7833291">(</span><span class="op" id="7833292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7833295">if</span>&nbsp;<span class="ident" id="7833298">err</span>&nbsp;<span class="op" id="7833302">!=</span>&nbsp;<span class="ident" id="7833305">nil</span>&nbsp;<span class="op" id="7833309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7833313">t</span><span class="op" id="7833314">.</span><span class="ident" id="7833315">Skipf</span><span class="op" id="7833320">(</span><span class="string" id="7833321">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="7833371">,</span>&nbsp;<span class="ident" id="7833373">err</span><span class="op" id="7833376">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7833379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7833383">var</span>&nbsp;<span class="ident" id="7833387">wg</span>&nbsp;<span class="ident" id="7833390">sync</span><span class="op" id="7833394">.</span><span class="ident" id="7833395">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7833406">portnum</span><span class="op" id="7833413">,</span>&nbsp;<span class="ident" id="7833415">_</span><span class="op" id="7833416">,</span>&nbsp;<span class="ident" id="7833418">_</span>&nbsp;<span class="op" id="7833420">:=</span>&nbsp;<span class="ident" id="7833423">dtoi</span><span class="op" id="7833427">(</span><span class="ident" id="7833428">dss</span><span class="op" id="7833431">.</span><span class="ident" id="7833432">port</span><span class="op" id="7833436">,</span>&nbsp;<span class="num" id="7833438">0</span><span class="op" id="7833439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7833442">ras</span>&nbsp;<span class="op" id="7833446">:=</span>&nbsp;<span class="ident" id="7833449">addrList</span><span class="op" id="7833457">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7833461">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;fail&nbsp;to&nbsp;connect,&nbsp;see&nbsp;RFC&nbsp;6890.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7833514">&amp;</span><span class="ident" id="7833515">TCPAddr</span><span class="op" id="7833522">{</span><span class="ident" id="7833523">IP</span><span class="op" id="7833525">:</span>&nbsp;<span class="ident" id="7833527">IPv4</span><span class="op" id="7833531">(</span><span class="num" id="7833532">198</span><span class="op" id="7833535">,</span>&nbsp;<span class="num" id="7833537">18</span><span class="op" id="7833539">,</span>&nbsp;<span class="num" id="7833541">0</span><span class="op" id="7833542">,</span>&nbsp;<span class="num" id="7833544">254</span><span class="op" id="7833547">)</span><span class="op" id="7833548">,</span>&nbsp;<span class="ident" id="7833550">Port</span><span class="op" id="7833554">:</span>&nbsp;<span class="ident" id="7833556">portnum</span><span class="op" id="7833563">}</span><span class="op" id="7833564">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7833568">&amp;</span><span class="ident" id="7833569">TCPAddr</span><span class="op" id="7833576">{</span><span class="ident" id="7833577">IP</span><span class="op" id="7833579">:</span>&nbsp;<span class="ident" id="7833581">ParseIP</span><span class="op" id="7833588">(</span><span class="string" id="7833589">&#34;2001:2::254&#34;</span><span class="op" id="7833602">)</span><span class="op" id="7833603">,</span>&nbsp;<span class="ident" id="7833605">Port</span><span class="op" id="7833609">:</span>&nbsp;<span class="ident" id="7833611">portnum</span><span class="op" id="7833618">}</span><span class="op" id="7833619">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7833624">//&nbsp;Winner&nbsp;candidates&nbsp;of&nbsp;this&nbsp;race.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7833661">&amp;</span><span class="ident" id="7833662">TCPAddr</span><span class="op" id="7833669">{</span><span class="ident" id="7833670">IP</span><span class="op" id="7833672">:</span>&nbsp;<span class="ident" id="7833674">IPv4</span><span class="op" id="7833678">(</span><span class="num" id="7833679">127</span><span class="op" id="7833682">,</span>&nbsp;<span class="num" id="7833684">0</span><span class="op" id="7833685">,</span>&nbsp;<span class="num" id="7833687">0</span><span class="op" id="7833688">,</span>&nbsp;<span class="num" id="7833690">1</span><span class="op" id="7833691">)</span><span class="op" id="7833692">,</span>&nbsp;<span class="ident" id="7833694">Port</span><span class="op" id="7833698">:</span>&nbsp;<span class="ident" id="7833700">portnum</span><span class="op" id="7833707">}</span><span class="op" id="7833708">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7833712">&amp;</span><span class="ident" id="7833713">TCPAddr</span><span class="op" id="7833720">{</span><span class="ident" id="7833721">IP</span><span class="op" id="7833723">:</span>&nbsp;<span class="ident" id="7833725">IPv6loopback</span><span class="op" id="7833737">,</span>&nbsp;<span class="ident" id="7833739">Port</span><span class="op" id="7833743">:</span>&nbsp;<span class="ident" id="7833745">portnum</span><span class="op" id="7833752">}</span><span class="op" id="7833753">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7833758">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;have&nbsp;established&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7833810">&amp;</span><span class="ident" id="7833811">TCPAddr</span><span class="op" id="7833818">{</span><span class="ident" id="7833819">IP</span><span class="op" id="7833821">:</span>&nbsp;<span class="ident" id="7833823">IPv4</span><span class="op" id="7833827">(</span><span class="num" id="7833828">127</span><span class="op" id="7833831">,</span>&nbsp;<span class="num" id="7833833">0</span><span class="op" id="7833834">,</span>&nbsp;<span class="num" id="7833836">0</span><span class="op" id="7833837">,</span>&nbsp;<span class="num" id="7833839">1</span><span class="op" id="7833840">)</span><span class="op" id="7833841">,</span>&nbsp;<span class="ident" id="7833843">Port</span><span class="op" id="7833847">:</span>&nbsp;<span class="ident" id="7833849">portnum</span><span class="op" id="7833856">}</span><span class="op" id="7833857">,</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7833861">&amp;</span><span class="ident" id="7833862">TCPAddr</span><span class="op" id="7833869">{</span><span class="ident" id="7833870">IP</span><span class="op" id="7833872">:</span>&nbsp;<span class="ident" id="7833874">IPv6loopback</span><span class="op" id="7833886">,</span>&nbsp;<span class="ident" id="7833888">Port</span><span class="op" id="7833892">:</span>&nbsp;<span class="ident" id="7833894">portnum</span><span class="op" id="7833901">}</span><span class="op" id="7833902">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7833905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7833908">const</span>&nbsp;<span class="ident" id="7833914">T1</span>&nbsp;<span class="op" id="7833917">=</span>&nbsp;<span class="num" id="7833919">10</span>&nbsp;<span class="op" id="7833922">*</span>&nbsp;<span class="ident" id="7833924">time</span><span class="op" id="7833928">.</span><span class="ident" id="7833929">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7833942">const</span>&nbsp;<span class="ident" id="7833948">T2</span>&nbsp;<span class="op" id="7833951">=</span>&nbsp;<span class="num" id="7833953">2</span>&nbsp;<span class="op" id="7833955">*</span>&nbsp;<span class="ident" id="7833957">T1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7833961">const</span>&nbsp;<span class="ident" id="7833967">N</span>&nbsp;<span class="op" id="7833969">=</span>&nbsp;<span class="num" id="7833971">10</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7833975">for</span>&nbsp;<span class="ident" id="7833979">i</span>&nbsp;<span class="op" id="7833981">:=</span>&nbsp;<span class="num" id="7833984">0</span><span class="op" id="7833985">;</span>&nbsp;<span class="ident" id="7833987">i</span>&nbsp;<span class="op" id="7833989">&lt;</span>&nbsp;<span class="ident" id="7833991">N</span><span class="op" id="7833992">;</span>&nbsp;<span class="ident" id="7833994">i</span><span class="op" id="7833995">++</span>&nbsp;<span class="op" id="7833998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7834002">wg</span><span class="op" id="7834004">.</span><span class="ident" id="7834005">Add</span><span class="op" id="7834008">(</span><span class="num" id="7834009">1</span><span class="op" id="7834010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7834014">go</span>&nbsp;<span class="keyword" id="7834017">func</span><span class="op" id="7834021">(</span><span class="op" id="7834022">)</span>&nbsp;<span class="op" id="7834024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7834029">defer</span>&nbsp;<span class="ident" id="7834035">wg</span><span class="op" id="7834037">.</span><span class="ident" id="7834038">Done</span><span class="op" id="7834042">(</span><span class="op" id="7834043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7834048">if</span>&nbsp;<span class="ident" id="7834051">c</span><span class="op" id="7834052">,</span>&nbsp;<span class="ident" id="7834054">err</span>&nbsp;<span class="op" id="7834058">:=</span>&nbsp;<span class="ident" id="7834061">dialMulti</span><span class="op" id="7834070">(</span><span class="string" id="7834071">&#34;tcp&#34;</span><span class="op" id="7834076">,</span>&nbsp;<span class="string" id="7834078">&#34;fast&nbsp;failover&nbsp;test&#34;</span><span class="op" id="7834098">,</span>&nbsp;<span class="ident" id="7834100">nil</span><span class="op" id="7834103">,</span>&nbsp;<span class="ident" id="7834105">ras</span><span class="op" id="7834108">,</span>&nbsp;<span class="ident" id="7834110">time</span><span class="op" id="7834114">.</span><span class="ident" id="7834115">Now</span><span class="op" id="7834118">(</span><span class="op" id="7834119">)</span><span class="op" id="7834120">.</span><span class="ident" id="7834121">Add</span><span class="op" id="7834124">(</span><span class="ident" id="7834125">T1</span><span class="op" id="7834127">)</span><span class="op" id="7834128">)</span><span class="op" id="7834129">;</span>&nbsp;<span class="ident" id="7834131">err</span>&nbsp;<span class="op" id="7834135">==</span>&nbsp;<span class="ident" id="7834138">nil</span>&nbsp;<span class="op" id="7834142">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7834148">c</span><span class="op" id="7834149">.</span><span class="ident" id="7834150">Close</span><span class="op" id="7834155">(</span><span class="op" id="7834156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7834161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7834165">}</span><span class="op" id="7834166">(</span><span class="op" id="7834167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7834170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7834173">wg</span><span class="op" id="7834175">.</span><span class="ident" id="7834176">Wait</span><span class="op" id="7834180">(</span><span class="op" id="7834181">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7834184">time</span><span class="op" id="7834188">.</span><span class="ident" id="7834189">Sleep</span><span class="op" id="7834194">(</span><span class="ident" id="7834195">T2</span><span class="op" id="7834197">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7834201">ntcp</span><span class="op" id="7834205">,</span>&nbsp;<span class="ident" id="7834207">after</span><span class="op" id="7834212">,</span>&nbsp;<span class="ident" id="7834214">nclose</span><span class="op" id="7834220">,</span>&nbsp;<span class="ident" id="7834222">err</span>&nbsp;<span class="op" id="7834226">:=</span>&nbsp;<span class="ident" id="7834229">numTCP</span><span class="op" id="7834235">(</span><span class="op" id="7834236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7834239">if</span>&nbsp;<span class="ident" id="7834242">err</span>&nbsp;<span class="op" id="7834246">!=</span>&nbsp;<span class="ident" id="7834249">nil</span>&nbsp;<span class="op" id="7834253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7834257">t</span><span class="op" id="7834258">.</span><span class="ident" id="7834259">Skipf</span><span class="op" id="7834264">(</span><span class="string" id="7834265">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="7834315">,</span>&nbsp;<span class="ident" id="7834317">err</span><span class="op" id="7834320">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7834323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7834326">t</span><span class="op" id="7834327">.</span><span class="ident" id="7834328">Logf</span><span class="op" id="7834332">(</span><span class="string" id="7834333">&#34;tcp&nbsp;sessions:&nbsp;%v,&nbsp;open&nbsp;sessions:&nbsp;%v,&nbsp;closing&nbsp;sessions:&nbsp;%v&#34;</span><span class="op" id="7834392">,</span>&nbsp;<span class="ident" id="7834394">ntcp</span><span class="op" id="7834398">,</span>&nbsp;<span class="ident" id="7834400">after</span><span class="op" id="7834405">,</span>&nbsp;<span class="ident" id="7834407">nclose</span><span class="op" id="7834413">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7834417">if</span>&nbsp;<span class="ident" id="7834420">after</span>&nbsp;<span class="op" id="7834426">!=</span>&nbsp;<span class="ident" id="7834429">before</span>&nbsp;<span class="op" id="7834436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7834440">t</span><span class="op" id="7834441">.</span><span class="ident" id="7834442">Fatalf</span><span class="op" id="7834448">(</span><span class="string" id="7834449">&#34;got&nbsp;%v&nbsp;open&nbsp;sessions;&nbsp;expected&nbsp;%v&#34;</span><span class="op" id="7834484">,</span>&nbsp;<span class="ident" id="7834486">after</span><span class="op" id="7834491">,</span>&nbsp;<span class="ident" id="7834493">before</span><span class="op" id="7834499">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7834502">}</span><br>
<span class="lineno"></span><span class="op" id="7834504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7834507">func</span>&nbsp;<span class="ident" id="7834512">numFD</span><span class="op" id="7834517">(</span><span class="op" id="7834518">)</span>&nbsp;<span class="builtintype" id="7834520">int</span>&nbsp;<span class="op" id="7834524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7834527">if</span>&nbsp;<span class="ident" id="7834530">runtime</span><span class="op" id="7834537">.</span><span class="ident" id="7834538">GOOS</span>&nbsp;<span class="op" id="7834543">==</span>&nbsp;<span class="string" id="7834546">&#34;linux&#34;</span>&nbsp;<span class="op" id="7834554">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7834558">f</span><span class="op" id="7834559">,</span>&nbsp;<span class="ident" id="7834561">err</span>&nbsp;<span class="op" id="7834565">:=</span>&nbsp;<span class="ident" id="7834568">os</span><span class="op" id="7834570">.</span><span class="ident" id="7834571">Open</span><span class="op" id="7834575">(</span><span class="string" id="7834576">&#34;/proc/self/fd&#34;</span><span class="op" id="7834591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7834595">if</span>&nbsp;<span class="ident" id="7834598">err</span>&nbsp;<span class="op" id="7834602">!=</span>&nbsp;<span class="ident" id="7834605">nil</span>&nbsp;<span class="op" id="7834609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7834614">panic</span><span class="op" id="7834619">(</span><span class="ident" id="7834620">err</span><span class="op" id="7834623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7834627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7834631">defer</span>&nbsp;<span class="ident" id="7834637">f</span><span class="op" id="7834638">.</span><span class="ident" id="7834639">Close</span><span class="op" id="7834644">(</span><span class="op" id="7834645">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7834649">names</span><span class="op" id="7834654">,</span>&nbsp;<span class="ident" id="7834656">err</span>&nbsp;<span class="op" id="7834660">:=</span>&nbsp;<span class="ident" id="7834663">f</span><span class="op" id="7834664">.</span><span class="ident" id="7834665">Readdirnames</span><span class="op" id="7834677">(</span><span class="num" id="7834678">0</span><span class="op" id="7834679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7834683">if</span>&nbsp;<span class="ident" id="7834686">err</span>&nbsp;<span class="op" id="7834690">!=</span>&nbsp;<span class="ident" id="7834693">nil</span>&nbsp;<span class="op" id="7834697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7834702">panic</span><span class="op" id="7834707">(</span><span class="ident" id="7834708">err</span><span class="op" id="7834711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7834715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7834719">return</span>&nbsp;<span class="builtinfunc" id="7834726">len</span><span class="op" id="7834729">(</span><span class="ident" id="7834730">names</span><span class="op" id="7834735">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7834738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7834741">//&nbsp;All&nbsp;tests&nbsp;using&nbsp;this&nbsp;should&nbsp;be&nbsp;skipped&nbsp;anyway,&nbsp;but:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7834797">panic</span><span class="op" id="7834802">(</span><span class="string" id="7834803">&#34;numFDs&nbsp;not&nbsp;implemented&nbsp;on&nbsp;&#34;</span>&nbsp;<span class="op" id="7834832">+</span>&nbsp;<span class="ident" id="7834834">runtime</span><span class="op" id="7834841">.</span><span class="ident" id="7834842">GOOS</span><span class="op" id="7834846">)</span><br>
<span class="lineno"></span><span class="op" id="7834848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="7834851">func</span>&nbsp;<span class="ident" id="7834856">TestDialer</span><span class="op" id="7834866">(</span><span class="ident" id="7834867">t</span>&nbsp;<span class="op" id="7834869">*</span><span class="ident" id="7834870">testing</span><span class="op" id="7834877">.</span><span class="ident" id="7834878">T</span><span class="op" id="7834879">)</span>&nbsp;<span class="op" id="7834881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7834884">ln</span><span class="op" id="7834886">,</span>&nbsp;<span class="ident" id="7834888">err</span>&nbsp;<span class="op" id="7834892">:=</span>&nbsp;<span class="ident" id="7834895">Listen</span><span class="op" id="7834901">(</span><span class="string" id="7834902">&#34;tcp4&#34;</span><span class="op" id="7834908">,</span>&nbsp;<span class="string" id="7834910">&#34;127.0.0.1:0&#34;</span><span class="op" id="7834923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7834926">if</span>&nbsp;<span class="ident" id="7834929">err</span>&nbsp;<span class="op" id="7834933">!=</span>&nbsp;<span class="ident" id="7834936">nil</span>&nbsp;<span class="op" id="7834940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7834944">t</span><span class="op" id="7834945">.</span><span class="ident" id="7834946">Fatalf</span><span class="op" id="7834952">(</span><span class="string" id="7834953">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7834972">,</span>&nbsp;<span class="ident" id="7834974">err</span><span class="op" id="7834977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7834980">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7834983">defer</span>&nbsp;<span class="ident" id="7834989">ln</span><span class="op" id="7834991">.</span><span class="ident" id="7834992">Close</span><span class="op" id="7834997">(</span><span class="op" id="7834998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7835001">ch</span>&nbsp;<span class="op" id="7835004">:=</span>&nbsp;<span class="builtinfunc" id="7835007">make</span><span class="op" id="7835011">(</span><span class="keyword" id="7835012">chan</span>&nbsp;<span class="builtintype" id="7835017">error</span><span class="op" id="7835022">,</span>&nbsp;<span class="num" id="7835024">1</span><span class="op" id="7835025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7835028">go</span>&nbsp;<span class="keyword" id="7835031">func</span><span class="op" id="7835035">(</span><span class="op" id="7835036">)</span>&nbsp;<span class="op" id="7835038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7835042">c</span><span class="op" id="7835043">,</span>&nbsp;<span class="ident" id="7835045">err</span>&nbsp;<span class="op" id="7835049">:=</span>&nbsp;<span class="ident" id="7835052">ln</span><span class="op" id="7835054">.</span><span class="ident" id="7835055">Accept</span><span class="op" id="7835061">(</span><span class="op" id="7835062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7835066">if</span>&nbsp;<span class="ident" id="7835069">err</span>&nbsp;<span class="op" id="7835073">!=</span>&nbsp;<span class="ident" id="7835076">nil</span>&nbsp;<span class="op" id="7835080">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7835085">ch</span>&nbsp;<span class="op" id="7835088">&lt;-</span>&nbsp;<span class="ident" id="7835091">fmt</span><span class="op" id="7835094">.</span><span class="ident" id="7835095">Errorf</span><span class="op" id="7835101">(</span><span class="string" id="7835102">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7835121">,</span>&nbsp;<span class="ident" id="7835123">err</span><span class="op" id="7835126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7835131">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7835140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7835144">defer</span>&nbsp;<span class="ident" id="7835150">c</span><span class="op" id="7835151">.</span><span class="ident" id="7835152">Close</span><span class="op" id="7835157">(</span><span class="op" id="7835158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7835162">ch</span>&nbsp;<span class="op" id="7835165">&lt;-</span>&nbsp;<span class="ident" id="7835168">nil</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7835173">}</span><span class="op" id="7835174">(</span><span class="op" id="7835175">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7835179">laddr</span><span class="op" id="7835184">,</span>&nbsp;<span class="ident" id="7835186">err</span>&nbsp;<span class="op" id="7835190">:=</span>&nbsp;<span class="ident" id="7835193">ResolveTCPAddr</span><span class="op" id="7835207">(</span><span class="string" id="7835208">&#34;tcp4&#34;</span><span class="op" id="7835214">,</span>&nbsp;<span class="string" id="7835216">&#34;127.0.0.1:0&#34;</span><span class="op" id="7835229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7835232">if</span>&nbsp;<span class="ident" id="7835235">err</span>&nbsp;<span class="op" id="7835239">!=</span>&nbsp;<span class="ident" id="7835242">nil</span>&nbsp;<span class="op" id="7835246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7835250">t</span><span class="op" id="7835251">.</span><span class="ident" id="7835252">Fatalf</span><span class="op" id="7835258">(</span><span class="string" id="7835259">&#34;ResolveTCPAddr&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7835286">,</span>&nbsp;<span class="ident" id="7835288">err</span><span class="op" id="7835291">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7835294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7835297">d</span>&nbsp;<span class="op" id="7835299">:=</span>&nbsp;<span class="op" id="7835302">&amp;</span><span class="ident" id="7835303">Dialer</span><span class="op" id="7835309">{</span><span class="ident" id="7835310">LocalAddr</span><span class="op" id="7835319">:</span>&nbsp;<span class="ident" id="7835321">laddr</span><span class="op" id="7835326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7835329">c</span><span class="op" id="7835330">,</span>&nbsp;<span class="ident" id="7835332">err</span>&nbsp;<span class="op" id="7835336">:=</span>&nbsp;<span class="ident" id="7835339">d</span><span class="op" id="7835340">.</span><span class="ident" id="7835341">Dial</span><span class="op" id="7835345">(</span><span class="string" id="7835346">&#34;tcp4&#34;</span><span class="op" id="7835352">,</span>&nbsp;<span class="ident" id="7835354">ln</span><span class="op" id="7835356">.</span><span class="ident" id="7835357">Addr</span><span class="op" id="7835361">(</span><span class="op" id="7835362">)</span><span class="op" id="7835363">.</span><span class="ident" id="7835364">String</span><span class="op" id="7835370">(</span><span class="op" id="7835371">)</span><span class="op" id="7835372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7835375">if</span>&nbsp;<span class="ident" id="7835378">err</span>&nbsp;<span class="op" id="7835382">!=</span>&nbsp;<span class="ident" id="7835385">nil</span>&nbsp;<span class="op" id="7835389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7835393">t</span><span class="op" id="7835394">.</span><span class="ident" id="7835395">Fatalf</span><span class="op" id="7835401">(</span><span class="string" id="7835402">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7835419">,</span>&nbsp;<span class="ident" id="7835421">err</span><span class="op" id="7835424">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7835427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7835430">defer</span>&nbsp;<span class="ident" id="7835436">c</span><span class="op" id="7835437">.</span><span class="ident" id="7835438">Close</span><span class="op" id="7835443">(</span><span class="op" id="7835444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7835447">c</span><span class="op" id="7835448">.</span><span class="ident" id="7835449">Read</span><span class="op" id="7835453">(</span><span class="builtinfunc" id="7835454">make</span><span class="op" id="7835458">(</span><span class="op" id="7835459">[</span><span class="op" id="7835460">]</span><span class="builtintype" id="7835461">byte</span><span class="op" id="7835465">,</span>&nbsp;<span class="num" id="7835467">1</span><span class="op" id="7835468">)</span><span class="op" id="7835469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7835472">err</span>&nbsp;<span class="op" id="7835476">=</span>&nbsp;<span class="op" id="7835478">&lt;-</span><span class="ident" id="7835480">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7835484">if</span>&nbsp;<span class="ident" id="7835487">err</span>&nbsp;<span class="op" id="7835491">!=</span>&nbsp;<span class="ident" id="7835494">nil</span>&nbsp;<span class="op" id="7835498">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7835502">t</span><span class="op" id="7835503">.</span><span class="ident" id="7835504">Error</span><span class="op" id="7835509">(</span><span class="ident" id="7835510">err</span><span class="op" id="7835513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7835516">}</span><br>
<span class="lineno"></span><span class="op" id="7835518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7835521">func</span>&nbsp;<span class="ident" id="7835526">TestDialDualStackLocalhost</span><span class="op" id="7835552">(</span><span class="ident" id="7835553">t</span>&nbsp;<span class="op" id="7835555">*</span><span class="ident" id="7835556">testing</span><span class="op" id="7835563">.</span><span class="ident" id="7835564">T</span><span class="op" id="7835565">)</span>&nbsp;<span class="op" id="7835567">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7835570">switch</span>&nbsp;<span class="ident" id="7835577">runtime</span><span class="op" id="7835584">.</span><span class="ident" id="7835585">GOOS</span>&nbsp;<span class="op" id="7835590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7835593">case</span>&nbsp;<span class="string" id="7835598">&#34;nacl&#34;</span><span class="op" id="7835604">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7835608">t</span><span class="op" id="7835609">.</span><span class="ident" id="7835610">Skipf</span><span class="op" id="7835615">(</span><span class="string" id="7835616">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7835637">,</span>&nbsp;<span class="ident" id="7835639">runtime</span><span class="op" id="7835646">.</span><span class="ident" id="7835647">GOOS</span><span class="op" id="7835651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7835654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7835658">if</span>&nbsp;<span class="ident" id="7835661">ips</span><span class="op" id="7835664">,</span>&nbsp;<span class="ident" id="7835666">err</span>&nbsp;<span class="op" id="7835670">:=</span>&nbsp;<span class="ident" id="7835673">LookupIP</span><span class="op" id="7835681">(</span><span class="string" id="7835682">&#34;localhost&#34;</span><span class="op" id="7835693">)</span><span class="op" id="7835694">;</span>&nbsp;<span class="ident" id="7835696">err</span>&nbsp;<span class="op" id="7835700">!=</span>&nbsp;<span class="ident" id="7835703">nil</span>&nbsp;<span class="op" id="7835707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7835711">t</span><span class="op" id="7835712">.</span><span class="ident" id="7835713">Fatalf</span><span class="op" id="7835719">(</span><span class="string" id="7835720">&#34;LookupIP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7835741">,</span>&nbsp;<span class="ident" id="7835743">err</span><span class="op" id="7835746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7835749">}</span>&nbsp;<span class="keyword" id="7835751">else</span>&nbsp;<span class="keyword" id="7835756">if</span>&nbsp;<span class="builtinfunc" id="7835759">len</span><span class="op" id="7835762">(</span><span class="ident" id="7835763">ips</span><span class="op" id="7835766">)</span>&nbsp;<span class="op" id="7835768">&lt;</span>&nbsp;<span class="num" id="7835770">2</span>&nbsp;<span class="op" id="7835772">||</span>&nbsp;<span class="op" id="7835775">!</span><span class="ident" id="7835776">supportsIPv4</span>&nbsp;<span class="op" id="7835789">||</span>&nbsp;<span class="op" id="7835792">!</span><span class="ident" id="7835793">supportsIPv6</span>&nbsp;<span class="op" id="7835806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7835810">t</span><span class="op" id="7835811">.</span><span class="ident" id="7835812">Skip</span><span class="op" id="7835816">(</span><span class="string" id="7835817">&#34;localhost&nbsp;doesn&#39;t&nbsp;have&nbsp;a&nbsp;pair&nbsp;of&nbsp;different&nbsp;address&nbsp;family&nbsp;IP&nbsp;addresses&#34;</span><span class="op" id="7835889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7835892">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7835896">touchAndByeServer</span>&nbsp;<span class="op" id="7835914">:=</span>&nbsp;<span class="keyword" id="7835917">func</span><span class="op" id="7835921">(</span><span class="ident" id="7835922">dss</span>&nbsp;<span class="op" id="7835926">*</span><span class="ident" id="7835927">dualStackServer</span><span class="op" id="7835942">,</span>&nbsp;<span class="ident" id="7835944">ln</span>&nbsp;<span class="ident" id="7835947">Listener</span><span class="op" id="7835955">)</span>&nbsp;<span class="op" id="7835957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7835961">for</span>&nbsp;<span class="op" id="7835965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7835970">if</span>&nbsp;<span class="ident" id="7835973">c</span><span class="op" id="7835974">,</span>&nbsp;<span class="ident" id="7835976">err</span>&nbsp;<span class="op" id="7835980">:=</span>&nbsp;<span class="ident" id="7835983">ln</span><span class="op" id="7835985">.</span><span class="ident" id="7835986">Accept</span><span class="op" id="7835992">(</span><span class="op" id="7835993">)</span><span class="op" id="7835994">;</span>&nbsp;<span class="ident" id="7835996">err</span>&nbsp;<span class="op" id="7836000">!=</span>&nbsp;<span class="ident" id="7836003">nil</span>&nbsp;<span class="op" id="7836007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7836013">return</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7836023">}</span>&nbsp;<span class="keyword" id="7836025">else</span>&nbsp;<span class="op" id="7836030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7836036">c</span><span class="op" id="7836037">.</span><span class="ident" id="7836038">Close</span><span class="op" id="7836043">(</span><span class="op" id="7836044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7836049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7836053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7836056">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7836059">dss</span><span class="op" id="7836062">,</span>&nbsp;<span class="ident" id="7836064">err</span>&nbsp;<span class="op" id="7836068">:=</span>&nbsp;<span class="ident" id="7836071">newDualStackServer</span><span class="op" id="7836089">(</span><span class="op" id="7836090">[</span><span class="op" id="7836091">]</span><span class="ident" id="7836092">streamListener</span><span class="op" id="7836106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7836110">{</span><span class="ident" id="7836111">net</span><span class="op" id="7836114">:</span>&nbsp;<span class="string" id="7836116">&#34;tcp4&#34;</span><span class="op" id="7836122">,</span>&nbsp;<span class="ident" id="7836124">addr</span><span class="op" id="7836128">:</span>&nbsp;<span class="string" id="7836130">&#34;127.0.0.1&#34;</span><span class="op" id="7836141">}</span><span class="op" id="7836142">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7836146">{</span><span class="ident" id="7836147">net</span><span class="op" id="7836150">:</span>&nbsp;<span class="string" id="7836152">&#34;tcp6&#34;</span><span class="op" id="7836158">,</span>&nbsp;<span class="ident" id="7836160">addr</span><span class="op" id="7836164">:</span>&nbsp;<span class="string" id="7836166">&#34;[::1]&#34;</span><span class="op" id="7836173">}</span><span class="op" id="7836174">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7836177">}</span><span class="op" id="7836178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7836181">if</span>&nbsp;<span class="ident" id="7836184">err</span>&nbsp;<span class="op" id="7836188">!=</span>&nbsp;<span class="ident" id="7836191">nil</span>&nbsp;<span class="op" id="7836195">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7836199">t</span><span class="op" id="7836200">.</span><span class="ident" id="7836201">Fatalf</span><span class="op" id="7836207">(</span><span class="string" id="7836208">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7836239">,</span>&nbsp;<span class="ident" id="7836241">err</span><span class="op" id="7836244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7836247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7836250">defer</span>&nbsp;<span class="ident" id="7836256">dss</span><span class="op" id="7836259">.</span><span class="ident" id="7836260">teardown</span><span class="op" id="7836268">(</span><span class="op" id="7836269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7836272">if</span>&nbsp;<span class="ident" id="7836275">err</span>&nbsp;<span class="op" id="7836279">:=</span>&nbsp;<span class="ident" id="7836282">dss</span><span class="op" id="7836285">.</span><span class="ident" id="7836286">buildup</span><span class="op" id="7836293">(</span><span class="ident" id="7836294">touchAndByeServer</span><span class="op" id="7836311">)</span><span class="op" id="7836312">;</span>&nbsp;<span class="ident" id="7836314">err</span>&nbsp;<span class="op" id="7836318">!=</span>&nbsp;<span class="ident" id="7836321">nil</span>&nbsp;<span class="op" id="7836325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7836329">t</span><span class="op" id="7836330">.</span><span class="ident" id="7836331">Fatalf</span><span class="op" id="7836337">(</span><span class="string" id="7836338">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7836374">,</span>&nbsp;<span class="ident" id="7836376">err</span><span class="op" id="7836379">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7836382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7836386">d</span>&nbsp;<span class="op" id="7836388">:=</span>&nbsp;<span class="op" id="7836391">&amp;</span><span class="ident" id="7836392">Dialer</span><span class="op" id="7836398">{</span><span class="ident" id="7836399">DualStack</span><span class="op" id="7836408">:</span>&nbsp;<span class="builtintype" id="7836410">true</span><span class="op" id="7836414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7836417">for</span>&nbsp;<span class="keyword" id="7836421">range</span>&nbsp;<span class="ident" id="7836427">dss</span><span class="op" id="7836430">.</span><span class="ident" id="7836431">lns</span>&nbsp;<span class="op" id="7836435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7836439">if</span>&nbsp;<span class="ident" id="7836442">c</span><span class="op" id="7836443">,</span>&nbsp;<span class="ident" id="7836445">err</span>&nbsp;<span class="op" id="7836449">:=</span>&nbsp;<span class="ident" id="7836452">d</span><span class="op" id="7836453">.</span><span class="ident" id="7836454">Dial</span><span class="op" id="7836458">(</span><span class="string" id="7836459">&#34;tcp&#34;</span><span class="op" id="7836464">,</span>&nbsp;<span class="string" id="7836466">&#34;localhost:&#34;</span><span class="op" id="7836478">+</span><span class="ident" id="7836479">dss</span><span class="op" id="7836482">.</span><span class="ident" id="7836483">port</span><span class="op" id="7836487">)</span><span class="op" id="7836488">;</span>&nbsp;<span class="ident" id="7836490">err</span>&nbsp;<span class="op" id="7836494">!=</span>&nbsp;<span class="ident" id="7836497">nil</span>&nbsp;<span class="op" id="7836501">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7836506">t</span><span class="op" id="7836507">.</span><span class="ident" id="7836508">Errorf</span><span class="op" id="7836514">(</span><span class="string" id="7836515">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7836532">,</span>&nbsp;<span class="ident" id="7836534">err</span><span class="op" id="7836537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7836541">}</span>&nbsp;<span class="keyword" id="7836543">else</span>&nbsp;<span class="op" id="7836548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7836553">if</span>&nbsp;<span class="ident" id="7836556">addr</span>&nbsp;<span class="op" id="7836561">:=</span>&nbsp;<span class="ident" id="7836564">c</span><span class="op" id="7836565">.</span><span class="ident" id="7836566">LocalAddr</span><span class="op" id="7836575">(</span><span class="op" id="7836576">)</span><span class="op" id="7836577">.</span><span class="op" id="7836578">(</span><span class="op" id="7836579">*</span><span class="ident" id="7836580">TCPAddr</span><span class="op" id="7836587">)</span><span class="op" id="7836588">;</span>&nbsp;<span class="ident" id="7836590">addr</span><span class="op" id="7836594">.</span><span class="ident" id="7836595">IP</span><span class="op" id="7836597">.</span><span class="ident" id="7836598">To4</span><span class="op" id="7836601">(</span><span class="op" id="7836602">)</span>&nbsp;<span class="op" id="7836604">!=</span>&nbsp;<span class="ident" id="7836607">nil</span>&nbsp;<span class="op" id="7836611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7836617">dss</span><span class="op" id="7836620">.</span><span class="ident" id="7836621">teardownNetwork</span><span class="op" id="7836636">(</span><span class="string" id="7836637">&#34;tcp4&#34;</span><span class="op" id="7836643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7836648">}</span>&nbsp;<span class="keyword" id="7836650">else</span>&nbsp;<span class="keyword" id="7836655">if</span>&nbsp;<span class="ident" id="7836658">addr</span><span class="op" id="7836662">.</span><span class="ident" id="7836663">IP</span><span class="op" id="7836665">.</span><span class="ident" id="7836666">To16</span><span class="op" id="7836670">(</span><span class="op" id="7836671">)</span>&nbsp;<span class="op" id="7836673">!=</span>&nbsp;<span class="ident" id="7836676">nil</span>&nbsp;<span class="op" id="7836680">&amp;&amp;</span>&nbsp;<span class="ident" id="7836683">addr</span><span class="op" id="7836687">.</span><span class="ident" id="7836688">IP</span><span class="op" id="7836690">.</span><span class="ident" id="7836691">To4</span><span class="op" id="7836694">(</span><span class="op" id="7836695">)</span>&nbsp;<span class="op" id="7836697">==</span>&nbsp;<span class="ident" id="7836700">nil</span>&nbsp;<span class="op" id="7836704">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7836710">dss</span><span class="op" id="7836713">.</span><span class="ident" id="7836714">teardownNetwork</span><span class="op" id="7836729">(</span><span class="string" id="7836730">&#34;tcp6&#34;</span><span class="op" id="7836736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7836741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7836746">c</span><span class="op" id="7836747">.</span><span class="ident" id="7836748">Close</span><span class="op" id="7836753">(</span><span class="op" id="7836754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7836758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7836761">}</span><br>
<span class="lineno">515</span><span class="op" id="7836763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7836766">func</span>&nbsp;<span class="ident" id="7836771">TestDialerKeepAlive</span><span class="op" id="7836790">(</span><span class="ident" id="7836791">t</span>&nbsp;<span class="op" id="7836793">*</span><span class="ident" id="7836794">testing</span><span class="op" id="7836801">.</span><span class="ident" id="7836802">T</span><span class="op" id="7836803">)</span>&nbsp;<span class="op" id="7836805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7836808">ln</span>&nbsp;<span class="op" id="7836811">:=</span>&nbsp;<span class="ident" id="7836814">newLocalListener</span><span class="op" id="7836830">(</span><span class="ident" id="7836831">t</span><span class="op" id="7836832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7836835">defer</span>&nbsp;<span class="ident" id="7836841">ln</span><span class="op" id="7836843">.</span><span class="ident" id="7836844">Close</span><span class="op" id="7836849">(</span><span class="op" id="7836850">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7836853">defer</span>&nbsp;<span class="keyword" id="7836859">func</span><span class="op" id="7836863">(</span><span class="op" id="7836864">)</span>&nbsp;<span class="op" id="7836866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7836870">testHookSetKeepAlive</span>&nbsp;<span class="op" id="7836891">=</span>&nbsp;<span class="keyword" id="7836893">func</span><span class="op" id="7836897">(</span><span class="op" id="7836898">)</span>&nbsp;<span class="op" id="7836900">{</span><span class="op" id="7836901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7836904">}</span><span class="op" id="7836905">(</span><span class="op" id="7836906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7836909">go</span>&nbsp;<span class="keyword" id="7836912">func</span><span class="op" id="7836916">(</span><span class="op" id="7836917">)</span>&nbsp;<span class="op" id="7836919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7836923">for</span>&nbsp;<span class="op" id="7836927">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7836932">c</span><span class="op" id="7836933">,</span>&nbsp;<span class="ident" id="7836935">err</span>&nbsp;<span class="op" id="7836939">:=</span>&nbsp;<span class="ident" id="7836942">ln</span><span class="op" id="7836944">.</span><span class="ident" id="7836945">Accept</span><span class="op" id="7836951">(</span><span class="op" id="7836952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7836957">if</span>&nbsp;<span class="ident" id="7836960">err</span>&nbsp;<span class="op" id="7836964">!=</span>&nbsp;<span class="ident" id="7836967">nil</span>&nbsp;<span class="op" id="7836971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7836977">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7836987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7836992">c</span><span class="op" id="7836993">.</span><span class="ident" id="7836994">Close</span><span class="op" id="7836999">(</span><span class="op" id="7837000">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7837004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7837007">}</span><span class="op" id="7837008">(</span><span class="op" id="7837009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7837012">for</span>&nbsp;<span class="ident" id="7837016">_</span><span class="op" id="7837017">,</span>&nbsp;<span class="ident" id="7837019">keepAlive</span>&nbsp;<span class="op" id="7837029">:=</span>&nbsp;<span class="keyword" id="7837032">range</span>&nbsp;<span class="op" id="7837038">[</span><span class="op" id="7837039">]</span><span class="builtintype" id="7837040">bool</span><span class="op" id="7837044">{</span><span class="builtintype" id="7837045">false</span><span class="op" id="7837050">,</span>&nbsp;<span class="builtintype" id="7837052">true</span><span class="op" id="7837056">}</span>&nbsp;<span class="op" id="7837058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7837062">got</span>&nbsp;<span class="op" id="7837066">:=</span>&nbsp;<span class="builtintype" id="7837069">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7837077">testHookSetKeepAlive</span>&nbsp;<span class="op" id="7837098">=</span>&nbsp;<span class="keyword" id="7837100">func</span><span class="op" id="7837104">(</span><span class="op" id="7837105">)</span>&nbsp;<span class="op" id="7837107">{</span>&nbsp;<span class="ident" id="7837109">got</span>&nbsp;<span class="op" id="7837113">=</span>&nbsp;<span class="builtintype" id="7837115">true</span>&nbsp;<span class="op" id="7837120">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7837124">var</span>&nbsp;<span class="ident" id="7837128">d</span>&nbsp;<span class="ident" id="7837130">Dialer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7837139">if</span>&nbsp;<span class="ident" id="7837142">keepAlive</span>&nbsp;<span class="op" id="7837152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7837157">d</span><span class="op" id="7837158">.</span><span class="ident" id="7837159">KeepAlive</span>&nbsp;<span class="op" id="7837169">=</span>&nbsp;<span class="num" id="7837171">30</span>&nbsp;<span class="op" id="7837174">*</span>&nbsp;<span class="ident" id="7837176">time</span><span class="op" id="7837180">.</span><span class="ident" id="7837181">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7837190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7837194">c</span><span class="op" id="7837195">,</span>&nbsp;<span class="ident" id="7837197">err</span>&nbsp;<span class="op" id="7837201">:=</span>&nbsp;<span class="ident" id="7837204">d</span><span class="op" id="7837205">.</span><span class="ident" id="7837206">Dial</span><span class="op" id="7837210">(</span><span class="string" id="7837211">&#34;tcp&#34;</span><span class="op" id="7837216">,</span>&nbsp;<span class="ident" id="7837218">ln</span><span class="op" id="7837220">.</span><span class="ident" id="7837221">Addr</span><span class="op" id="7837225">(</span><span class="op" id="7837226">)</span><span class="op" id="7837227">.</span><span class="ident" id="7837228">String</span><span class="op" id="7837234">(</span><span class="op" id="7837235">)</span><span class="op" id="7837236">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7837240">if</span>&nbsp;<span class="ident" id="7837243">err</span>&nbsp;<span class="op" id="7837247">!=</span>&nbsp;<span class="ident" id="7837250">nil</span>&nbsp;<span class="op" id="7837254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7837259">t</span><span class="op" id="7837260">.</span><span class="ident" id="7837261">Fatal</span><span class="op" id="7837266">(</span><span class="ident" id="7837267">err</span><span class="op" id="7837270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7837274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7837278">c</span><span class="op" id="7837279">.</span><span class="ident" id="7837280">Close</span><span class="op" id="7837285">(</span><span class="op" id="7837286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7837290">if</span>&nbsp;<span class="ident" id="7837293">got</span>&nbsp;<span class="op" id="7837297">!=</span>&nbsp;<span class="ident" id="7837300">keepAlive</span>&nbsp;<span class="op" id="7837310">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7837315">t</span><span class="op" id="7837316">.</span><span class="ident" id="7837317">Errorf</span><span class="op" id="7837323">(</span><span class="string" id="7837324">&#34;Dialer.KeepAlive&nbsp;=&nbsp;%v:&nbsp;SetKeepAlive&nbsp;called&nbsp;=&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7837382">,</span>&nbsp;<span class="ident" id="7837384">d</span><span class="op" id="7837385">.</span><span class="ident" id="7837386">KeepAlive</span><span class="op" id="7837395">,</span>&nbsp;<span class="ident" id="7837397">got</span><span class="op" id="7837400">,</span>&nbsp;<span class="op" id="7837402">!</span><span class="ident" id="7837403">got</span><span class="op" id="7837406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7837410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7837413">}</span><br>
<span class="lineno"></span><span class="op" id="7837415">}</span>
</div>
</body>
</html>
