<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6371837">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6371892">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6371946">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6371997">package</span>&nbsp;<span class="ident" id="6372005">png</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6372010">import</span>&nbsp;<span class="op" id="6372017">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6372020">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6372029">&#34;compress/zlib&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6372046">&#34;hash/crc32&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6372060">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6372069">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6372084">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6372090">&#34;strconv&#34;</span><br>
<span class="lineno">15</span><span class="op" id="6372100">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6372103">//&nbsp;Encoder&nbsp;configures&nbsp;encoding&nbsp;PNG&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="6372146">type</span>&nbsp;<span class="ident" id="6372151">Encoder</span>&nbsp;<span class="keyword" id="6372159">struct</span>&nbsp;<span class="op" id="6372166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372169">CompressionLevel</span>&nbsp;<span class="ident" id="6372186">CompressionLevel</span><br>
<span class="lineno">20</span><span class="op" id="6372203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6372206">type</span>&nbsp;<span class="ident" id="6372211">encoder</span>&nbsp;<span class="keyword" id="6372219">struct</span>&nbsp;<span class="op" id="6372226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372229">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6372236">*</span><span class="ident" id="6372237">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372246">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6372253">io</span><span class="op" id="6372255">.</span><span class="ident" id="6372256">Writer</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372264">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6372271">image</span><span class="op" id="6372276">.</span><span class="ident" id="6372277">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372284">cb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6372291">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372296">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6372303">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372310">header</span>&nbsp;<span class="op" id="6372317">[</span><span class="num" id="6372318">8</span><span class="op" id="6372319">]</span><span class="builtintype" id="6372320">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372326">footer</span>&nbsp;<span class="op" id="6372333">[</span><span class="num" id="6372334">4</span><span class="op" id="6372335">]</span><span class="builtintype" id="6372336">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372342">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6372349">[</span><span class="num" id="6372350">4</span>&nbsp;<span class="op" id="6372352">*</span>&nbsp;<span class="num" id="6372354">256</span><span class="op" id="6372357">]</span><span class="builtintype" id="6372358">byte</span><br>
<span class="lineno"></span><span class="op" id="6372363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6372366">type</span>&nbsp;<span class="ident" id="6372371">CompressionLevel</span>&nbsp;<span class="builtintype" id="6372388">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="6372393">const</span>&nbsp;<span class="op" id="6372399">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372402">DefaultCompression</span>&nbsp;<span class="ident" id="6372421">CompressionLevel</span>&nbsp;<span class="op" id="6372438">=</span>&nbsp;<span class="num" id="6372440">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372443">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6372462">CompressionLevel</span>&nbsp;<span class="op" id="6372479">=</span>&nbsp;<span class="op" id="6372481">-</span><span class="num" id="6372482">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372485">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6372504">CompressionLevel</span>&nbsp;<span class="op" id="6372521">=</span>&nbsp;<span class="op" id="6372523">-</span><span class="num" id="6372524">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372527">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6372546">CompressionLevel</span>&nbsp;<span class="op" id="6372563">=</span>&nbsp;<span class="op" id="6372565">-</span><span class="num" id="6372566">3</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6372570">//&nbsp;Positive&nbsp;CompressionLevel&nbsp;values&nbsp;are&nbsp;reserved&nbsp;to&nbsp;mean&nbsp;a&nbsp;numeric&nbsp;zlib</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6372643">//&nbsp;compression&nbsp;level,&nbsp;although&nbsp;that&nbsp;is&nbsp;not&nbsp;implemented&nbsp;yet.</span><br>
<span class="lineno"></span><span class="op" id="6372703">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="6372706">//&nbsp;Big-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="6372721">func</span>&nbsp;<span class="ident" id="6372726">writeUint32</span><span class="op" id="6372737">(</span><span class="ident" id="6372738">b</span>&nbsp;<span class="op" id="6372740">[</span><span class="op" id="6372741">]</span><span class="builtintype" id="6372742">uint8</span><span class="op" id="6372747">,</span>&nbsp;<span class="ident" id="6372749">u</span>&nbsp;<span class="builtintype" id="6372751">uint32</span><span class="op" id="6372757">)</span>&nbsp;<span class="op" id="6372759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372762">b</span><span class="op" id="6372763">[</span><span class="num" id="6372764">0</span><span class="op" id="6372765">]</span>&nbsp;<span class="op" id="6372767">=</span>&nbsp;<span class="builtintype" id="6372769">uint8</span><span class="op" id="6372774">(</span><span class="ident" id="6372775">u</span>&nbsp;<span class="op" id="6372777">&gt;&gt;</span>&nbsp;<span class="num" id="6372780">24</span><span class="op" id="6372782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372785">b</span><span class="op" id="6372786">[</span><span class="num" id="6372787">1</span><span class="op" id="6372788">]</span>&nbsp;<span class="op" id="6372790">=</span>&nbsp;<span class="builtintype" id="6372792">uint8</span><span class="op" id="6372797">(</span><span class="ident" id="6372798">u</span>&nbsp;<span class="op" id="6372800">&gt;&gt;</span>&nbsp;<span class="num" id="6372803">16</span><span class="op" id="6372805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372808">b</span><span class="op" id="6372809">[</span><span class="num" id="6372810">2</span><span class="op" id="6372811">]</span>&nbsp;<span class="op" id="6372813">=</span>&nbsp;<span class="builtintype" id="6372815">uint8</span><span class="op" id="6372820">(</span><span class="ident" id="6372821">u</span>&nbsp;<span class="op" id="6372823">&gt;&gt;</span>&nbsp;<span class="num" id="6372826">8</span><span class="op" id="6372827">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372830">b</span><span class="op" id="6372831">[</span><span class="num" id="6372832">3</span><span class="op" id="6372833">]</span>&nbsp;<span class="op" id="6372835">=</span>&nbsp;<span class="builtintype" id="6372837">uint8</span><span class="op" id="6372842">(</span><span class="ident" id="6372843">u</span>&nbsp;<span class="op" id="6372845">&gt;&gt;</span>&nbsp;<span class="num" id="6372848">0</span><span class="op" id="6372849">)</span><br>
<span class="lineno"></span><span class="op" id="6372851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6372854">type</span>&nbsp;<span class="ident" id="6372859">opaquer</span>&nbsp;<span class="keyword" id="6372867">interface</span>&nbsp;<span class="op" id="6372877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6372880">Opaque</span><span class="op" id="6372886">(</span><span class="op" id="6372887">)</span>&nbsp;<span class="builtintype" id="6372889">bool</span><br>
<span class="lineno">55</span><span class="op" id="6372894">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6372897">//&nbsp;Returns&nbsp;whether&nbsp;or&nbsp;not&nbsp;the&nbsp;image&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="6372950">func</span>&nbsp;<span class="ident" id="6372955">opaque</span><span class="op" id="6372961">(</span><span class="ident" id="6372962">m</span>&nbsp;<span class="ident" id="6372964">image</span><span class="op" id="6372969">.</span><span class="ident" id="6372970">Image</span><span class="op" id="6372975">)</span>&nbsp;<span class="builtintype" id="6372977">bool</span>&nbsp;<span class="op" id="6372982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6372985">if</span>&nbsp;<span class="ident" id="6372988">o</span><span class="op" id="6372989">,</span>&nbsp;<span class="ident" id="6372991">ok</span>&nbsp;<span class="op" id="6372994">:=</span>&nbsp;<span class="ident" id="6372997">m</span><span class="op" id="6372998">.</span><span class="op" id="6372999">(</span><span class="ident" id="6373000">opaquer</span><span class="op" id="6373007">)</span><span class="op" id="6373008">;</span>&nbsp;<span class="ident" id="6373010">ok</span>&nbsp;<span class="op" id="6373013">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373017">return</span>&nbsp;<span class="ident" id="6373024">o</span><span class="op" id="6373025">.</span><span class="ident" id="6373026">Opaque</span><span class="op" id="6373032">(</span><span class="op" id="6373033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6373036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373039">b</span>&nbsp;<span class="op" id="6373041">:=</span>&nbsp;<span class="ident" id="6373044">m</span><span class="op" id="6373045">.</span><span class="ident" id="6373046">Bounds</span><span class="op" id="6373052">(</span><span class="op" id="6373053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373056">for</span>&nbsp;<span class="ident" id="6373060">y</span>&nbsp;<span class="op" id="6373062">:=</span>&nbsp;<span class="ident" id="6373065">b</span><span class="op" id="6373066">.</span><span class="ident" id="6373067">Min</span><span class="op" id="6373070">.</span><span class="ident" id="6373071">Y</span><span class="op" id="6373072">;</span>&nbsp;<span class="ident" id="6373074">y</span>&nbsp;<span class="op" id="6373076">&lt;</span>&nbsp;<span class="ident" id="6373078">b</span><span class="op" id="6373079">.</span><span class="ident" id="6373080">Max</span><span class="op" id="6373083">.</span><span class="ident" id="6373084">Y</span><span class="op" id="6373085">;</span>&nbsp;<span class="ident" id="6373087">y</span><span class="op" id="6373088">++</span>&nbsp;<span class="op" id="6373091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373095">for</span>&nbsp;<span class="ident" id="6373099">x</span>&nbsp;<span class="op" id="6373101">:=</span>&nbsp;<span class="ident" id="6373104">b</span><span class="op" id="6373105">.</span><span class="ident" id="6373106">Min</span><span class="op" id="6373109">.</span><span class="ident" id="6373110">X</span><span class="op" id="6373111">;</span>&nbsp;<span class="ident" id="6373113">x</span>&nbsp;<span class="op" id="6373115">&lt;</span>&nbsp;<span class="ident" id="6373117">b</span><span class="op" id="6373118">.</span><span class="ident" id="6373119">Max</span><span class="op" id="6373122">.</span><span class="ident" id="6373123">X</span><span class="op" id="6373124">;</span>&nbsp;<span class="ident" id="6373126">x</span><span class="op" id="6373127">++</span>&nbsp;<span class="op" id="6373130">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373135">_</span><span class="op" id="6373136">,</span>&nbsp;<span class="ident" id="6373138">_</span><span class="op" id="6373139">,</span>&nbsp;<span class="ident" id="6373141">_</span><span class="op" id="6373142">,</span>&nbsp;<span class="ident" id="6373144">a</span>&nbsp;<span class="op" id="6373146">:=</span>&nbsp;<span class="ident" id="6373149">m</span><span class="op" id="6373150">.</span><span class="ident" id="6373151">At</span><span class="op" id="6373153">(</span><span class="ident" id="6373154">x</span><span class="op" id="6373155">,</span>&nbsp;<span class="ident" id="6373157">y</span><span class="op" id="6373158">)</span><span class="op" id="6373159">.</span><span class="ident" id="6373160">RGBA</span><span class="op" id="6373164">(</span><span class="op" id="6373165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373170">if</span>&nbsp;<span class="ident" id="6373173">a</span>&nbsp;<span class="op" id="6373175">!=</span>&nbsp;<span class="num" id="6373178">0xffff</span>&nbsp;<span class="op" id="6373185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373191">return</span>&nbsp;<span class="ident" id="6373198">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6373207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6373211">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6373214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373217">return</span>&nbsp;<span class="ident" id="6373224">true</span><br>
<span class="lineno"></span><span class="op" id="6373229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6373232">//&nbsp;The&nbsp;absolute&nbsp;value&nbsp;of&nbsp;a&nbsp;byte&nbsp;interpreted&nbsp;as&nbsp;a&nbsp;signed&nbsp;int8.</span><br>
<span class="lineno">75</span><span class="keyword" id="6373294">func</span>&nbsp;<span class="ident" id="6373299">abs8</span><span class="op" id="6373303">(</span><span class="ident" id="6373304">d</span>&nbsp;<span class="builtintype" id="6373306">uint8</span><span class="op" id="6373311">)</span>&nbsp;<span class="builtintype" id="6373313">int</span>&nbsp;<span class="op" id="6373317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373320">if</span>&nbsp;<span class="ident" id="6373323">d</span>&nbsp;<span class="op" id="6373325">&lt;</span>&nbsp;<span class="num" id="6373327">128</span>&nbsp;<span class="op" id="6373331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373335">return</span>&nbsp;<span class="builtintype" id="6373342">int</span><span class="op" id="6373345">(</span><span class="ident" id="6373346">d</span><span class="op" id="6373347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6373350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373353">return</span>&nbsp;<span class="num" id="6373360">256</span>&nbsp;<span class="op" id="6373364">-</span>&nbsp;<span class="builtintype" id="6373366">int</span><span class="op" id="6373369">(</span><span class="ident" id="6373370">d</span><span class="op" id="6373371">)</span><br>
<span class="lineno">80</span><span class="op" id="6373373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6373376">func</span>&nbsp;<span class="op" id="6373381">(</span><span class="ident" id="6373382">e</span>&nbsp;<span class="op" id="6373384">*</span><span class="ident" id="6373385">encoder</span><span class="op" id="6373392">)</span>&nbsp;<span class="ident" id="6373394">writeChunk</span><span class="op" id="6373404">(</span><span class="ident" id="6373405">b</span>&nbsp;<span class="op" id="6373407">[</span><span class="op" id="6373408">]</span><span class="builtintype" id="6373409">byte</span><span class="op" id="6373413">,</span>&nbsp;<span class="ident" id="6373415">name</span>&nbsp;<span class="builtintype" id="6373420">string</span><span class="op" id="6373426">)</span>&nbsp;<span class="op" id="6373428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373431">if</span>&nbsp;<span class="ident" id="6373434">e</span><span class="op" id="6373435">.</span><span class="ident" id="6373436">err</span>&nbsp;<span class="op" id="6373440">!=</span>&nbsp;<span class="ident" id="6373443">nil</span>&nbsp;<span class="op" id="6373447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373451">return</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6373459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373462">n</span>&nbsp;<span class="op" id="6373464">:=</span>&nbsp;<span class="builtintype" id="6373467">uint32</span><span class="op" id="6373473">(</span><span class="builtinfunc" id="6373474">len</span><span class="op" id="6373477">(</span><span class="ident" id="6373478">b</span><span class="op" id="6373479">)</span><span class="op" id="6373480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373483">if</span>&nbsp;<span class="builtintype" id="6373486">int</span><span class="op" id="6373489">(</span><span class="ident" id="6373490">n</span><span class="op" id="6373491">)</span>&nbsp;<span class="op" id="6373493">!=</span>&nbsp;<span class="builtinfunc" id="6373496">len</span><span class="op" id="6373499">(</span><span class="ident" id="6373500">b</span><span class="op" id="6373501">)</span>&nbsp;<span class="op" id="6373503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373507">e</span><span class="op" id="6373508">.</span><span class="ident" id="6373509">err</span>&nbsp;<span class="op" id="6373513">=</span>&nbsp;<span class="ident" id="6373515">UnsupportedError</span><span class="op" id="6373531">(</span><span class="ident" id="6373532">name</span>&nbsp;<span class="op" id="6373537">+</span>&nbsp;<span class="string" id="6373539">&#34;&nbsp;chunk&nbsp;is&nbsp;too&nbsp;large:&nbsp;&#34;</span>&nbsp;<span class="op" id="6373563">+</span>&nbsp;<span class="ident" id="6373565">strconv</span><span class="op" id="6373572">.</span><span class="ident" id="6373573">Itoa</span><span class="op" id="6373577">(</span><span class="builtinfunc" id="6373578">len</span><span class="op" id="6373581">(</span><span class="ident" id="6373582">b</span><span class="op" id="6373583">)</span><span class="op" id="6373584">)</span><span class="op" id="6373585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373589">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6373597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373600">writeUint32</span><span class="op" id="6373611">(</span><span class="ident" id="6373612">e</span><span class="op" id="6373613">.</span><span class="ident" id="6373614">header</span><span class="op" id="6373620">[</span><span class="op" id="6373621">:</span><span class="num" id="6373622">4</span><span class="op" id="6373623">]</span><span class="op" id="6373624">,</span>&nbsp;<span class="ident" id="6373626">n</span><span class="op" id="6373627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373630">e</span><span class="op" id="6373631">.</span><span class="ident" id="6373632">header</span><span class="op" id="6373638">[</span><span class="num" id="6373639">4</span><span class="op" id="6373640">]</span>&nbsp;<span class="op" id="6373642">=</span>&nbsp;<span class="ident" id="6373644">name</span><span class="op" id="6373648">[</span><span class="num" id="6373649">0</span><span class="op" id="6373650">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373653">e</span><span class="op" id="6373654">.</span><span class="ident" id="6373655">header</span><span class="op" id="6373661">[</span><span class="num" id="6373662">5</span><span class="op" id="6373663">]</span>&nbsp;<span class="op" id="6373665">=</span>&nbsp;<span class="ident" id="6373667">name</span><span class="op" id="6373671">[</span><span class="num" id="6373672">1</span><span class="op" id="6373673">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373676">e</span><span class="op" id="6373677">.</span><span class="ident" id="6373678">header</span><span class="op" id="6373684">[</span><span class="num" id="6373685">6</span><span class="op" id="6373686">]</span>&nbsp;<span class="op" id="6373688">=</span>&nbsp;<span class="ident" id="6373690">name</span><span class="op" id="6373694">[</span><span class="num" id="6373695">2</span><span class="op" id="6373696">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373699">e</span><span class="op" id="6373700">.</span><span class="ident" id="6373701">header</span><span class="op" id="6373707">[</span><span class="num" id="6373708">7</span><span class="op" id="6373709">]</span>&nbsp;<span class="op" id="6373711">=</span>&nbsp;<span class="ident" id="6373713">name</span><span class="op" id="6373717">[</span><span class="num" id="6373718">3</span><span class="op" id="6373719">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373722">crc</span>&nbsp;<span class="op" id="6373726">:=</span>&nbsp;<span class="ident" id="6373729">crc32</span><span class="op" id="6373734">.</span><span class="ident" id="6373735">NewIEEE</span><span class="op" id="6373742">(</span><span class="op" id="6373743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373746">crc</span><span class="op" id="6373749">.</span><span class="ident" id="6373750">Write</span><span class="op" id="6373755">(</span><span class="ident" id="6373756">e</span><span class="op" id="6373757">.</span><span class="ident" id="6373758">header</span><span class="op" id="6373764">[</span><span class="num" id="6373765">4</span><span class="op" id="6373766">:</span><span class="num" id="6373767">8</span><span class="op" id="6373768">]</span><span class="op" id="6373769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373772">crc</span><span class="op" id="6373775">.</span><span class="ident" id="6373776">Write</span><span class="op" id="6373781">(</span><span class="ident" id="6373782">b</span><span class="op" id="6373783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373786">writeUint32</span><span class="op" id="6373797">(</span><span class="ident" id="6373798">e</span><span class="op" id="6373799">.</span><span class="ident" id="6373800">footer</span><span class="op" id="6373806">[</span><span class="op" id="6373807">:</span><span class="num" id="6373808">4</span><span class="op" id="6373809">]</span><span class="op" id="6373810">,</span>&nbsp;<span class="ident" id="6373812">crc</span><span class="op" id="6373815">.</span><span class="ident" id="6373816">Sum32</span><span class="op" id="6373821">(</span><span class="op" id="6373822">)</span><span class="op" id="6373823">)</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373827">_</span><span class="op" id="6373828">,</span>&nbsp;<span class="ident" id="6373830">e</span><span class="op" id="6373831">.</span><span class="ident" id="6373832">err</span>&nbsp;<span class="op" id="6373836">=</span>&nbsp;<span class="ident" id="6373838">e</span><span class="op" id="6373839">.</span><span class="ident" id="6373840">w</span><span class="op" id="6373841">.</span><span class="ident" id="6373842">Write</span><span class="op" id="6373847">(</span><span class="ident" id="6373848">e</span><span class="op" id="6373849">.</span><span class="ident" id="6373850">header</span><span class="op" id="6373856">[</span><span class="op" id="6373857">:</span><span class="num" id="6373858">8</span><span class="op" id="6373859">]</span><span class="op" id="6373860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373863">if</span>&nbsp;<span class="ident" id="6373866">e</span><span class="op" id="6373867">.</span><span class="ident" id="6373868">err</span>&nbsp;<span class="op" id="6373872">!=</span>&nbsp;<span class="ident" id="6373875">nil</span>&nbsp;<span class="op" id="6373879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373883">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6373891">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373894">_</span><span class="op" id="6373895">,</span>&nbsp;<span class="ident" id="6373897">e</span><span class="op" id="6373898">.</span><span class="ident" id="6373899">err</span>&nbsp;<span class="op" id="6373903">=</span>&nbsp;<span class="ident" id="6373905">e</span><span class="op" id="6373906">.</span><span class="ident" id="6373907">w</span><span class="op" id="6373908">.</span><span class="ident" id="6373909">Write</span><span class="op" id="6373914">(</span><span class="ident" id="6373915">b</span><span class="op" id="6373916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373919">if</span>&nbsp;<span class="ident" id="6373922">e</span><span class="op" id="6373923">.</span><span class="ident" id="6373924">err</span>&nbsp;<span class="op" id="6373928">!=</span>&nbsp;<span class="ident" id="6373931">nil</span>&nbsp;<span class="op" id="6373935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6373939">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6373947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6373950">_</span><span class="op" id="6373951">,</span>&nbsp;<span class="ident" id="6373953">e</span><span class="op" id="6373954">.</span><span class="ident" id="6373955">err</span>&nbsp;<span class="op" id="6373959">=</span>&nbsp;<span class="ident" id="6373961">e</span><span class="op" id="6373962">.</span><span class="ident" id="6373963">w</span><span class="op" id="6373964">.</span><span class="ident" id="6373965">Write</span><span class="op" id="6373970">(</span><span class="ident" id="6373971">e</span><span class="op" id="6373972">.</span><span class="ident" id="6373973">footer</span><span class="op" id="6373979">[</span><span class="op" id="6373980">:</span><span class="num" id="6373981">4</span><span class="op" id="6373982">]</span><span class="op" id="6373983">)</span><br>
<span class="lineno">110</span><span class="op" id="6373985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6373988">func</span>&nbsp;<span class="op" id="6373993">(</span><span class="ident" id="6373994">e</span>&nbsp;<span class="op" id="6373996">*</span><span class="ident" id="6373997">encoder</span><span class="op" id="6374004">)</span>&nbsp;<span class="ident" id="6374006">writeIHDR</span><span class="op" id="6374015">(</span><span class="op" id="6374016">)</span>&nbsp;<span class="op" id="6374018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374021">b</span>&nbsp;<span class="op" id="6374023">:=</span>&nbsp;<span class="ident" id="6374026">e</span><span class="op" id="6374027">.</span><span class="ident" id="6374028">m</span><span class="op" id="6374029">.</span><span class="ident" id="6374030">Bounds</span><span class="op" id="6374036">(</span><span class="op" id="6374037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374040">writeUint32</span><span class="op" id="6374051">(</span><span class="ident" id="6374052">e</span><span class="op" id="6374053">.</span><span class="ident" id="6374054">tmp</span><span class="op" id="6374057">[</span><span class="num" id="6374058">0</span><span class="op" id="6374059">:</span><span class="num" id="6374060">4</span><span class="op" id="6374061">]</span><span class="op" id="6374062">,</span>&nbsp;<span class="builtintype" id="6374064">uint32</span><span class="op" id="6374070">(</span><span class="ident" id="6374071">b</span><span class="op" id="6374072">.</span><span class="ident" id="6374073">Dx</span><span class="op" id="6374075">(</span><span class="op" id="6374076">)</span><span class="op" id="6374077">)</span><span class="op" id="6374078">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374081">writeUint32</span><span class="op" id="6374092">(</span><span class="ident" id="6374093">e</span><span class="op" id="6374094">.</span><span class="ident" id="6374095">tmp</span><span class="op" id="6374098">[</span><span class="num" id="6374099">4</span><span class="op" id="6374100">:</span><span class="num" id="6374101">8</span><span class="op" id="6374102">]</span><span class="op" id="6374103">,</span>&nbsp;<span class="builtintype" id="6374105">uint32</span><span class="op" id="6374111">(</span><span class="ident" id="6374112">b</span><span class="op" id="6374113">.</span><span class="ident" id="6374114">Dy</span><span class="op" id="6374116">(</span><span class="op" id="6374117">)</span><span class="op" id="6374118">)</span><span class="op" id="6374119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6374122">//&nbsp;Set&nbsp;bit&nbsp;depth&nbsp;and&nbsp;color&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374156">switch</span>&nbsp;<span class="ident" id="6374163">e</span><span class="op" id="6374164">.</span><span class="ident" id="6374165">cb</span>&nbsp;<span class="op" id="6374168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374171">case</span>&nbsp;<span class="ident" id="6374176">cbG8</span><span class="op" id="6374180">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374184">e</span><span class="op" id="6374185">.</span><span class="ident" id="6374186">tmp</span><span class="op" id="6374189">[</span><span class="num" id="6374190">8</span><span class="op" id="6374191">]</span>&nbsp;<span class="op" id="6374193">=</span>&nbsp;<span class="num" id="6374195">8</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374199">e</span><span class="op" id="6374200">.</span><span class="ident" id="6374201">tmp</span><span class="op" id="6374204">[</span><span class="num" id="6374205">9</span><span class="op" id="6374206">]</span>&nbsp;<span class="op" id="6374208">=</span>&nbsp;<span class="ident" id="6374210">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374223">case</span>&nbsp;<span class="ident" id="6374228">cbTC8</span><span class="op" id="6374233">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374237">e</span><span class="op" id="6374238">.</span><span class="ident" id="6374239">tmp</span><span class="op" id="6374242">[</span><span class="num" id="6374243">8</span><span class="op" id="6374244">]</span>&nbsp;<span class="op" id="6374246">=</span>&nbsp;<span class="num" id="6374248">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374252">e</span><span class="op" id="6374253">.</span><span class="ident" id="6374254">tmp</span><span class="op" id="6374257">[</span><span class="num" id="6374258">9</span><span class="op" id="6374259">]</span>&nbsp;<span class="op" id="6374261">=</span>&nbsp;<span class="ident" id="6374263">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374276">case</span>&nbsp;<span class="ident" id="6374281">cbP8</span><span class="op" id="6374285">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374289">e</span><span class="op" id="6374290">.</span><span class="ident" id="6374291">tmp</span><span class="op" id="6374294">[</span><span class="num" id="6374295">8</span><span class="op" id="6374296">]</span>&nbsp;<span class="op" id="6374298">=</span>&nbsp;<span class="num" id="6374300">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374304">e</span><span class="op" id="6374305">.</span><span class="ident" id="6374306">tmp</span><span class="op" id="6374309">[</span><span class="num" id="6374310">9</span><span class="op" id="6374311">]</span>&nbsp;<span class="op" id="6374313">=</span>&nbsp;<span class="ident" id="6374315">ctPaletted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374327">case</span>&nbsp;<span class="ident" id="6374332">cbTCA8</span><span class="op" id="6374338">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374342">e</span><span class="op" id="6374343">.</span><span class="ident" id="6374344">tmp</span><span class="op" id="6374347">[</span><span class="num" id="6374348">8</span><span class="op" id="6374349">]</span>&nbsp;<span class="op" id="6374351">=</span>&nbsp;<span class="num" id="6374353">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374357">e</span><span class="op" id="6374358">.</span><span class="ident" id="6374359">tmp</span><span class="op" id="6374362">[</span><span class="num" id="6374363">9</span><span class="op" id="6374364">]</span>&nbsp;<span class="op" id="6374366">=</span>&nbsp;<span class="ident" id="6374368">ctTrueColorAlpha</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374386">case</span>&nbsp;<span class="ident" id="6374391">cbG16</span><span class="op" id="6374396">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374400">e</span><span class="op" id="6374401">.</span><span class="ident" id="6374402">tmp</span><span class="op" id="6374405">[</span><span class="num" id="6374406">8</span><span class="op" id="6374407">]</span>&nbsp;<span class="op" id="6374409">=</span>&nbsp;<span class="num" id="6374411">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374416">e</span><span class="op" id="6374417">.</span><span class="ident" id="6374418">tmp</span><span class="op" id="6374421">[</span><span class="num" id="6374422">9</span><span class="op" id="6374423">]</span>&nbsp;<span class="op" id="6374425">=</span>&nbsp;<span class="ident" id="6374427">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374440">case</span>&nbsp;<span class="ident" id="6374445">cbTC16</span><span class="op" id="6374451">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374455">e</span><span class="op" id="6374456">.</span><span class="ident" id="6374457">tmp</span><span class="op" id="6374460">[</span><span class="num" id="6374461">8</span><span class="op" id="6374462">]</span>&nbsp;<span class="op" id="6374464">=</span>&nbsp;<span class="num" id="6374466">16</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374471">e</span><span class="op" id="6374472">.</span><span class="ident" id="6374473">tmp</span><span class="op" id="6374476">[</span><span class="num" id="6374477">9</span><span class="op" id="6374478">]</span>&nbsp;<span class="op" id="6374480">=</span>&nbsp;<span class="ident" id="6374482">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374495">case</span>&nbsp;<span class="ident" id="6374500">cbTCA16</span><span class="op" id="6374507">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374511">e</span><span class="op" id="6374512">.</span><span class="ident" id="6374513">tmp</span><span class="op" id="6374516">[</span><span class="num" id="6374517">8</span><span class="op" id="6374518">]</span>&nbsp;<span class="op" id="6374520">=</span>&nbsp;<span class="num" id="6374522">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374527">e</span><span class="op" id="6374528">.</span><span class="ident" id="6374529">tmp</span><span class="op" id="6374532">[</span><span class="num" id="6374533">9</span><span class="op" id="6374534">]</span>&nbsp;<span class="op" id="6374536">=</span>&nbsp;<span class="ident" id="6374538">ctTrueColorAlpha</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6374556">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374559">e</span><span class="op" id="6374560">.</span><span class="ident" id="6374561">tmp</span><span class="op" id="6374564">[</span><span class="num" id="6374565">10</span><span class="op" id="6374567">]</span>&nbsp;<span class="op" id="6374569">=</span>&nbsp;<span class="num" id="6374571">0</span>&nbsp;<span class="comment" id="6374573">//&nbsp;default&nbsp;compression&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374604">e</span><span class="op" id="6374605">.</span><span class="ident" id="6374606">tmp</span><span class="op" id="6374609">[</span><span class="num" id="6374610">11</span><span class="op" id="6374612">]</span>&nbsp;<span class="op" id="6374614">=</span>&nbsp;<span class="num" id="6374616">0</span>&nbsp;<span class="comment" id="6374618">//&nbsp;default&nbsp;filter&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374644">e</span><span class="op" id="6374645">.</span><span class="ident" id="6374646">tmp</span><span class="op" id="6374649">[</span><span class="num" id="6374650">12</span><span class="op" id="6374652">]</span>&nbsp;<span class="op" id="6374654">=</span>&nbsp;<span class="num" id="6374656">0</span>&nbsp;<span class="comment" id="6374658">//&nbsp;non-interlaced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374677">e</span><span class="op" id="6374678">.</span><span class="ident" id="6374679">writeChunk</span><span class="op" id="6374689">(</span><span class="ident" id="6374690">e</span><span class="op" id="6374691">.</span><span class="ident" id="6374692">tmp</span><span class="op" id="6374695">[</span><span class="op" id="6374696">:</span><span class="num" id="6374697">13</span><span class="op" id="6374699">]</span><span class="op" id="6374700">,</span>&nbsp;<span class="string" id="6374702">&#34;IHDR&#34;</span><span class="op" id="6374708">)</span><br>
<span class="lineno"></span><span class="op" id="6374710">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="keyword" id="6374713">func</span>&nbsp;<span class="op" id="6374718">(</span><span class="ident" id="6374719">e</span>&nbsp;<span class="op" id="6374721">*</span><span class="ident" id="6374722">encoder</span><span class="op" id="6374729">)</span>&nbsp;<span class="ident" id="6374731">writePLTEAndTRNS</span><span class="op" id="6374747">(</span><span class="ident" id="6374748">p</span>&nbsp;<span class="ident" id="6374750">color</span><span class="op" id="6374755">.</span><span class="ident" id="6374756">Palette</span><span class="op" id="6374763">)</span>&nbsp;<span class="op" id="6374765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374768">if</span>&nbsp;<span class="builtinfunc" id="6374771">len</span><span class="op" id="6374774">(</span><span class="ident" id="6374775">p</span><span class="op" id="6374776">)</span>&nbsp;<span class="op" id="6374778">&lt;</span>&nbsp;<span class="num" id="6374780">1</span>&nbsp;<span class="op" id="6374782">||</span>&nbsp;<span class="builtinfunc" id="6374785">len</span><span class="op" id="6374788">(</span><span class="ident" id="6374789">p</span><span class="op" id="6374790">)</span>&nbsp;<span class="op" id="6374792">&gt;</span>&nbsp;<span class="num" id="6374794">256</span>&nbsp;<span class="op" id="6374798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374802">e</span><span class="op" id="6374803">.</span><span class="ident" id="6374804">err</span>&nbsp;<span class="op" id="6374808">=</span>&nbsp;<span class="ident" id="6374810">FormatError</span><span class="op" id="6374821">(</span><span class="string" id="6374822">&#34;bad&nbsp;palette&nbsp;length:&nbsp;&#34;</span>&nbsp;<span class="op" id="6374845">+</span>&nbsp;<span class="ident" id="6374847">strconv</span><span class="op" id="6374854">.</span><span class="ident" id="6374855">Itoa</span><span class="op" id="6374859">(</span><span class="builtinfunc" id="6374860">len</span><span class="op" id="6374863">(</span><span class="ident" id="6374864">p</span><span class="op" id="6374865">)</span><span class="op" id="6374866">)</span><span class="op" id="6374867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374871">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6374879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374882">last</span>&nbsp;<span class="op" id="6374887">:=</span>&nbsp;<span class="op" id="6374890">-</span><span class="num" id="6374891">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6374894">for</span>&nbsp;<span class="ident" id="6374898">i</span><span class="op" id="6374899">,</span>&nbsp;<span class="ident" id="6374901">c</span>&nbsp;<span class="op" id="6374903">:=</span>&nbsp;<span class="keyword" id="6374906">range</span>&nbsp;<span class="ident" id="6374912">p</span>&nbsp;<span class="op" id="6374914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374918">c1</span>&nbsp;<span class="op" id="6374921">:=</span>&nbsp;<span class="ident" id="6374924">color</span><span class="op" id="6374929">.</span><span class="ident" id="6374930">NRGBAModel</span><span class="op" id="6374940">.</span><span class="ident" id="6374941">Convert</span><span class="op" id="6374948">(</span><span class="ident" id="6374949">c</span><span class="op" id="6374950">)</span><span class="op" id="6374951">.</span><span class="op" id="6374952">(</span><span class="ident" id="6374953">color</span><span class="op" id="6374958">.</span><span class="ident" id="6374959">NRGBA</span><span class="op" id="6374964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374968">e</span><span class="op" id="6374969">.</span><span class="ident" id="6374970">tmp</span><span class="op" id="6374973">[</span><span class="num" id="6374974">3</span><span class="op" id="6374975">*</span><span class="ident" id="6374976">i</span><span class="op" id="6374977">+</span><span class="num" id="6374978">0</span><span class="op" id="6374979">]</span>&nbsp;<span class="op" id="6374981">=</span>&nbsp;<span class="ident" id="6374983">c1</span><span class="op" id="6374985">.</span><span class="ident" id="6374986">R</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6374990">e</span><span class="op" id="6374991">.</span><span class="ident" id="6374992">tmp</span><span class="op" id="6374995">[</span><span class="num" id="6374996">3</span><span class="op" id="6374997">*</span><span class="ident" id="6374998">i</span><span class="op" id="6374999">+</span><span class="num" id="6375000">1</span><span class="op" id="6375001">]</span>&nbsp;<span class="op" id="6375003">=</span>&nbsp;<span class="ident" id="6375005">c1</span><span class="op" id="6375007">.</span><span class="ident" id="6375008">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6375012">e</span><span class="op" id="6375013">.</span><span class="ident" id="6375014">tmp</span><span class="op" id="6375017">[</span><span class="num" id="6375018">3</span><span class="op" id="6375019">*</span><span class="ident" id="6375020">i</span><span class="op" id="6375021">+</span><span class="num" id="6375022">2</span><span class="op" id="6375023">]</span>&nbsp;<span class="op" id="6375025">=</span>&nbsp;<span class="ident" id="6375027">c1</span><span class="op" id="6375029">.</span><span class="ident" id="6375030">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6375034">if</span>&nbsp;<span class="ident" id="6375037">c1</span><span class="op" id="6375039">.</span><span class="ident" id="6375040">A</span>&nbsp;<span class="op" id="6375042">!=</span>&nbsp;<span class="num" id="6375045">0xff</span>&nbsp;<span class="op" id="6375050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6375055">last</span>&nbsp;<span class="op" id="6375060">=</span>&nbsp;<span class="ident" id="6375062">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6375066">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6375070">e</span><span class="op" id="6375071">.</span><span class="ident" id="6375072">tmp</span><span class="op" id="6375075">[</span><span class="num" id="6375076">3</span><span class="op" id="6375077">*</span><span class="num" id="6375078">256</span><span class="op" id="6375081">+</span><span class="ident" id="6375082">i</span><span class="op" id="6375083">]</span>&nbsp;<span class="op" id="6375085">=</span>&nbsp;<span class="ident" id="6375087">c1</span><span class="op" id="6375089">.</span><span class="ident" id="6375090">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6375093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6375096">e</span><span class="op" id="6375097">.</span><span class="ident" id="6375098">writeChunk</span><span class="op" id="6375108">(</span><span class="ident" id="6375109">e</span><span class="op" id="6375110">.</span><span class="ident" id="6375111">tmp</span><span class="op" id="6375114">[</span><span class="op" id="6375115">:</span><span class="num" id="6375116">3</span><span class="op" id="6375117">*</span><span class="builtinfunc" id="6375118">len</span><span class="op" id="6375121">(</span><span class="ident" id="6375122">p</span><span class="op" id="6375123">)</span><span class="op" id="6375124">]</span><span class="op" id="6375125">,</span>&nbsp;<span class="string" id="6375127">&#34;PLTE&#34;</span><span class="op" id="6375133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6375136">if</span>&nbsp;<span class="ident" id="6375139">last</span>&nbsp;<span class="op" id="6375144">!=</span>&nbsp;<span class="op" id="6375147">-</span><span class="num" id="6375148">1</span>&nbsp;<span class="op" id="6375150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6375154">e</span><span class="op" id="6375155">.</span><span class="ident" id="6375156">writeChunk</span><span class="op" id="6375166">(</span><span class="ident" id="6375167">e</span><span class="op" id="6375168">.</span><span class="ident" id="6375169">tmp</span><span class="op" id="6375172">[</span><span class="num" id="6375173">3</span><span class="op" id="6375174">*</span><span class="num" id="6375175">256</span><span class="op" id="6375178">:</span><span class="num" id="6375179">3</span><span class="op" id="6375180">*</span><span class="num" id="6375181">256</span><span class="op" id="6375184">+</span><span class="num" id="6375185">1</span><span class="op" id="6375186">+</span><span class="ident" id="6375187">last</span><span class="op" id="6375191">]</span><span class="op" id="6375192">,</span>&nbsp;<span class="string" id="6375194">&#34;tRNS&#34;</span><span class="op" id="6375200">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6375203">}</span><br>
<span class="lineno"></span><span class="op" id="6375205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6375208">//&nbsp;An&nbsp;encoder&nbsp;is&nbsp;an&nbsp;io.Writer&nbsp;that&nbsp;satisfies&nbsp;writes&nbsp;by&nbsp;writing&nbsp;PNG&nbsp;IDAT&nbsp;chunks,</span><br>
<span class="lineno"></span><span class="comment" id="6375288">//&nbsp;including&nbsp;an&nbsp;8-byte&nbsp;header&nbsp;and&nbsp;4-byte&nbsp;CRC&nbsp;checksum&nbsp;per&nbsp;Write&nbsp;call.&nbsp;Such&nbsp;calls</span><br>
<span class="lineno">170</span><span class="comment" id="6375369">//&nbsp;should&nbsp;be&nbsp;relatively&nbsp;infrequent,&nbsp;since&nbsp;writeIDATs&nbsp;uses&nbsp;a&nbsp;bufio.Writer.</span><br>
<span class="lineno"></span><span class="comment" id="6375443">//</span><br>
<span class="lineno"></span><span class="comment" id="6375446">//&nbsp;This&nbsp;method&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;writeIDATs&nbsp;(via&nbsp;writeImage).</span><br>
<span class="lineno"></span><span class="comment" id="6375517">//&nbsp;No&nbsp;other&nbsp;code&nbsp;should&nbsp;treat&nbsp;an&nbsp;encoder&nbsp;as&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="6375575">func</span>&nbsp;<span class="op" id="6375580">(</span><span class="ident" id="6375581">e</span>&nbsp;<span class="op" id="6375583">*</span><span class="ident" id="6375584">encoder</span><span class="op" id="6375591">)</span>&nbsp;<span class="ident" id="6375593">Write</span><span class="op" id="6375598">(</span><span class="ident" id="6375599">b</span>&nbsp;<span class="op" id="6375601">[</span><span class="op" id="6375602">]</span><span class="builtintype" id="6375603">byte</span><span class="op" id="6375607">)</span>&nbsp;<span class="op" id="6375609">(</span><span class="builtintype" id="6375610">int</span><span class="op" id="6375613">,</span>&nbsp;<span class="builtintype" id="6375615">error</span><span class="op" id="6375620">)</span>&nbsp;<span class="op" id="6375622">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6375625">e</span><span class="op" id="6375626">.</span><span class="ident" id="6375627">writeChunk</span><span class="op" id="6375637">(</span><span class="ident" id="6375638">b</span><span class="op" id="6375639">,</span>&nbsp;<span class="string" id="6375641">&#34;IDAT&#34;</span><span class="op" id="6375647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6375650">if</span>&nbsp;<span class="ident" id="6375653">e</span><span class="op" id="6375654">.</span><span class="ident" id="6375655">err</span>&nbsp;<span class="op" id="6375659">!=</span>&nbsp;<span class="ident" id="6375662">nil</span>&nbsp;<span class="op" id="6375666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6375670">return</span>&nbsp;<span class="num" id="6375677">0</span><span class="op" id="6375678">,</span>&nbsp;<span class="ident" id="6375680">e</span><span class="op" id="6375681">.</span><span class="ident" id="6375682">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6375687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6375690">return</span>&nbsp;<span class="builtinfunc" id="6375697">len</span><span class="op" id="6375700">(</span><span class="ident" id="6375701">b</span><span class="op" id="6375702">)</span><span class="op" id="6375703">,</span>&nbsp;<span class="ident" id="6375705">nil</span><br>
<span class="lineno">180</span><span class="op" id="6375709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6375712">//&nbsp;Chooses&nbsp;the&nbsp;filter&nbsp;to&nbsp;use&nbsp;for&nbsp;encoding&nbsp;the&nbsp;current&nbsp;row,&nbsp;and&nbsp;applies&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="6375787">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;filter&nbsp;and&nbsp;also&nbsp;of&nbsp;the&nbsp;row&nbsp;in&nbsp;cr&nbsp;that&nbsp;has&nbsp;had&nbsp;it&nbsp;applied.</span><br>
<span class="lineno"></span><span class="keyword" id="6375885">func</span>&nbsp;<span class="ident" id="6375890">filter</span><span class="op" id="6375896">(</span><span class="ident" id="6375897">cr</span>&nbsp;<span class="op" id="6375900">*</span><span class="op" id="6375901">[</span><span class="ident" id="6375902">nFilter</span><span class="op" id="6375909">]</span><span class="op" id="6375910">[</span><span class="op" id="6375911">]</span><span class="builtintype" id="6375912">byte</span><span class="op" id="6375916">,</span>&nbsp;<span class="ident" id="6375918">pr</span>&nbsp;<span class="op" id="6375921">[</span><span class="op" id="6375922">]</span><span class="builtintype" id="6375923">byte</span><span class="op" id="6375927">,</span>&nbsp;<span class="ident" id="6375929">bpp</span>&nbsp;<span class="builtintype" id="6375933">int</span><span class="op" id="6375936">)</span>&nbsp;<span class="builtintype" id="6375938">int</span>&nbsp;<span class="op" id="6375942">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6375945">//&nbsp;We&nbsp;try&nbsp;all&nbsp;five&nbsp;filter&nbsp;types,&nbsp;and&nbsp;pick&nbsp;the&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;the&nbsp;sum&nbsp;of&nbsp;absolute&nbsp;differences.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6376044">//&nbsp;This&nbsp;is&nbsp;the&nbsp;same&nbsp;heuristic&nbsp;that&nbsp;libpng&nbsp;uses,&nbsp;although&nbsp;the&nbsp;filters&nbsp;are&nbsp;attempted&nbsp;in&nbsp;order&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6376140">//&nbsp;estimated&nbsp;most&nbsp;likely&nbsp;to&nbsp;be&nbsp;minimal&nbsp;(ftUp,&nbsp;ftPaeth,&nbsp;ftNone,&nbsp;ftSub,&nbsp;ftAverage),&nbsp;rather&nbsp;than</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6376235">//&nbsp;in&nbsp;their&nbsp;enumeration&nbsp;order&nbsp;(ftNone,&nbsp;ftSub,&nbsp;ftUp,&nbsp;ftAverage,&nbsp;ftPaeth).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376309">cdat0</span>&nbsp;<span class="op" id="6376315">:=</span>&nbsp;<span class="ident" id="6376318">cr</span><span class="op" id="6376320">[</span><span class="num" id="6376321">0</span><span class="op" id="6376322">]</span><span class="op" id="6376323">[</span><span class="num" id="6376324">1</span><span class="op" id="6376325">:</span><span class="op" id="6376326">]</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376329">cdat1</span>&nbsp;<span class="op" id="6376335">:=</span>&nbsp;<span class="ident" id="6376338">cr</span><span class="op" id="6376340">[</span><span class="num" id="6376341">1</span><span class="op" id="6376342">]</span><span class="op" id="6376343">[</span><span class="num" id="6376344">1</span><span class="op" id="6376345">:</span><span class="op" id="6376346">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376349">cdat2</span>&nbsp;<span class="op" id="6376355">:=</span>&nbsp;<span class="ident" id="6376358">cr</span><span class="op" id="6376360">[</span><span class="num" id="6376361">2</span><span class="op" id="6376362">]</span><span class="op" id="6376363">[</span><span class="num" id="6376364">1</span><span class="op" id="6376365">:</span><span class="op" id="6376366">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376369">cdat3</span>&nbsp;<span class="op" id="6376375">:=</span>&nbsp;<span class="ident" id="6376378">cr</span><span class="op" id="6376380">[</span><span class="num" id="6376381">3</span><span class="op" id="6376382">]</span><span class="op" id="6376383">[</span><span class="num" id="6376384">1</span><span class="op" id="6376385">:</span><span class="op" id="6376386">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376389">cdat4</span>&nbsp;<span class="op" id="6376395">:=</span>&nbsp;<span class="ident" id="6376398">cr</span><span class="op" id="6376400">[</span><span class="num" id="6376401">4</span><span class="op" id="6376402">]</span><span class="op" id="6376403">[</span><span class="num" id="6376404">1</span><span class="op" id="6376405">:</span><span class="op" id="6376406">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376409">pdat</span>&nbsp;<span class="op" id="6376414">:=</span>&nbsp;<span class="ident" id="6376417">pr</span><span class="op" id="6376419">[</span><span class="num" id="6376420">1</span><span class="op" id="6376421">:</span><span class="op" id="6376422">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376425">n</span>&nbsp;<span class="op" id="6376427">:=</span>&nbsp;<span class="builtinfunc" id="6376430">len</span><span class="op" id="6376433">(</span><span class="ident" id="6376434">cdat0</span><span class="op" id="6376439">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6376443">//&nbsp;The&nbsp;up&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376462">sum</span>&nbsp;<span class="op" id="6376466">:=</span>&nbsp;<span class="num" id="6376469">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6376472">for</span>&nbsp;<span class="ident" id="6376476">i</span>&nbsp;<span class="op" id="6376478">:=</span>&nbsp;<span class="num" id="6376481">0</span><span class="op" id="6376482">;</span>&nbsp;<span class="ident" id="6376484">i</span>&nbsp;<span class="op" id="6376486">&lt;</span>&nbsp;<span class="ident" id="6376488">n</span><span class="op" id="6376489">;</span>&nbsp;<span class="ident" id="6376491">i</span><span class="op" id="6376492">++</span>&nbsp;<span class="op" id="6376495">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376499">cdat2</span><span class="op" id="6376504">[</span><span class="ident" id="6376505">i</span><span class="op" id="6376506">]</span>&nbsp;<span class="op" id="6376508">=</span>&nbsp;<span class="ident" id="6376510">cdat0</span><span class="op" id="6376515">[</span><span class="ident" id="6376516">i</span><span class="op" id="6376517">]</span>&nbsp;<span class="op" id="6376519">-</span>&nbsp;<span class="ident" id="6376521">pdat</span><span class="op" id="6376525">[</span><span class="ident" id="6376526">i</span><span class="op" id="6376527">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376531">sum</span>&nbsp;<span class="op" id="6376535">+=</span>&nbsp;<span class="ident" id="6376538">abs8</span><span class="op" id="6376542">(</span><span class="ident" id="6376543">cdat2</span><span class="op" id="6376548">[</span><span class="ident" id="6376549">i</span><span class="op" id="6376550">]</span><span class="op" id="6376551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6376554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376557">best</span>&nbsp;<span class="op" id="6376562">:=</span>&nbsp;<span class="ident" id="6376565">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376570">filter</span>&nbsp;<span class="op" id="6376577">:=</span>&nbsp;<span class="ident" id="6376580">ftUp</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6376587">//&nbsp;The&nbsp;Paeth&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376609">sum</span>&nbsp;<span class="op" id="6376613">=</span>&nbsp;<span class="num" id="6376615">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6376618">for</span>&nbsp;<span class="ident" id="6376622">i</span>&nbsp;<span class="op" id="6376624">:=</span>&nbsp;<span class="num" id="6376627">0</span><span class="op" id="6376628">;</span>&nbsp;<span class="ident" id="6376630">i</span>&nbsp;<span class="op" id="6376632">&lt;</span>&nbsp;<span class="ident" id="6376634">bpp</span><span class="op" id="6376637">;</span>&nbsp;<span class="ident" id="6376639">i</span><span class="op" id="6376640">++</span>&nbsp;<span class="op" id="6376643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376647">cdat4</span><span class="op" id="6376652">[</span><span class="ident" id="6376653">i</span><span class="op" id="6376654">]</span>&nbsp;<span class="op" id="6376656">=</span>&nbsp;<span class="ident" id="6376658">cdat0</span><span class="op" id="6376663">[</span><span class="ident" id="6376664">i</span><span class="op" id="6376665">]</span>&nbsp;<span class="op" id="6376667">-</span>&nbsp;<span class="ident" id="6376669">pdat</span><span class="op" id="6376673">[</span><span class="ident" id="6376674">i</span><span class="op" id="6376675">]</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376679">sum</span>&nbsp;<span class="op" id="6376683">+=</span>&nbsp;<span class="ident" id="6376686">abs8</span><span class="op" id="6376690">(</span><span class="ident" id="6376691">cdat4</span><span class="op" id="6376696">[</span><span class="ident" id="6376697">i</span><span class="op" id="6376698">]</span><span class="op" id="6376699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6376702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6376705">for</span>&nbsp;<span class="ident" id="6376709">i</span>&nbsp;<span class="op" id="6376711">:=</span>&nbsp;<span class="ident" id="6376714">bpp</span><span class="op" id="6376717">;</span>&nbsp;<span class="ident" id="6376719">i</span>&nbsp;<span class="op" id="6376721">&lt;</span>&nbsp;<span class="ident" id="6376723">n</span><span class="op" id="6376724">;</span>&nbsp;<span class="ident" id="6376726">i</span><span class="op" id="6376727">++</span>&nbsp;<span class="op" id="6376730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376734">cdat4</span><span class="op" id="6376739">[</span><span class="ident" id="6376740">i</span><span class="op" id="6376741">]</span>&nbsp;<span class="op" id="6376743">=</span>&nbsp;<span class="ident" id="6376745">cdat0</span><span class="op" id="6376750">[</span><span class="ident" id="6376751">i</span><span class="op" id="6376752">]</span>&nbsp;<span class="op" id="6376754">-</span>&nbsp;<span class="ident" id="6376756">paeth</span><span class="op" id="6376761">(</span><span class="ident" id="6376762">cdat0</span><span class="op" id="6376767">[</span><span class="ident" id="6376768">i</span><span class="op" id="6376769">-</span><span class="ident" id="6376770">bpp</span><span class="op" id="6376773">]</span><span class="op" id="6376774">,</span>&nbsp;<span class="ident" id="6376776">pdat</span><span class="op" id="6376780">[</span><span class="ident" id="6376781">i</span><span class="op" id="6376782">]</span><span class="op" id="6376783">,</span>&nbsp;<span class="ident" id="6376785">pdat</span><span class="op" id="6376789">[</span><span class="ident" id="6376790">i</span><span class="op" id="6376791">-</span><span class="ident" id="6376792">bpp</span><span class="op" id="6376795">]</span><span class="op" id="6376796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376800">sum</span>&nbsp;<span class="op" id="6376804">+=</span>&nbsp;<span class="ident" id="6376807">abs8</span><span class="op" id="6376811">(</span><span class="ident" id="6376812">cdat4</span><span class="op" id="6376817">[</span><span class="ident" id="6376818">i</span><span class="op" id="6376819">]</span><span class="op" id="6376820">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6376824">if</span>&nbsp;<span class="ident" id="6376827">sum</span>&nbsp;<span class="op" id="6376831">&gt;=</span>&nbsp;<span class="ident" id="6376834">best</span>&nbsp;<span class="op" id="6376839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6376844">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6376852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6376855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6376858">if</span>&nbsp;<span class="ident" id="6376861">sum</span>&nbsp;<span class="op" id="6376865">&lt;</span>&nbsp;<span class="ident" id="6376867">best</span>&nbsp;<span class="op" id="6376872">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376876">best</span>&nbsp;<span class="op" id="6376881">=</span>&nbsp;<span class="ident" id="6376883">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376889">filter</span>&nbsp;<span class="op" id="6376896">=</span>&nbsp;<span class="ident" id="6376898">ftPaeth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6376907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6376911">//&nbsp;The&nbsp;none&nbsp;filter.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376932">sum</span>&nbsp;<span class="op" id="6376936">=</span>&nbsp;<span class="num" id="6376938">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6376941">for</span>&nbsp;<span class="ident" id="6376945">i</span>&nbsp;<span class="op" id="6376947">:=</span>&nbsp;<span class="num" id="6376950">0</span><span class="op" id="6376951">;</span>&nbsp;<span class="ident" id="6376953">i</span>&nbsp;<span class="op" id="6376955">&lt;</span>&nbsp;<span class="ident" id="6376957">n</span><span class="op" id="6376958">;</span>&nbsp;<span class="ident" id="6376960">i</span><span class="op" id="6376961">++</span>&nbsp;<span class="op" id="6376964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6376968">sum</span>&nbsp;<span class="op" id="6376972">+=</span>&nbsp;<span class="ident" id="6376975">abs8</span><span class="op" id="6376979">(</span><span class="ident" id="6376980">cdat0</span><span class="op" id="6376985">[</span><span class="ident" id="6376986">i</span><span class="op" id="6376987">]</span><span class="op" id="6376988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6376992">if</span>&nbsp;<span class="ident" id="6376995">sum</span>&nbsp;<span class="op" id="6376999">&gt;=</span>&nbsp;<span class="ident" id="6377002">best</span>&nbsp;<span class="op" id="6377007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377012">break</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377026">if</span>&nbsp;<span class="ident" id="6377029">sum</span>&nbsp;<span class="op" id="6377033">&lt;</span>&nbsp;<span class="ident" id="6377035">best</span>&nbsp;<span class="op" id="6377040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377044">best</span>&nbsp;<span class="op" id="6377049">=</span>&nbsp;<span class="ident" id="6377051">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377057">filter</span>&nbsp;<span class="op" id="6377064">=</span>&nbsp;<span class="ident" id="6377066">ftNone</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6377078">//&nbsp;The&nbsp;sub&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377098">sum</span>&nbsp;<span class="op" id="6377102">=</span>&nbsp;<span class="num" id="6377104">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377107">for</span>&nbsp;<span class="ident" id="6377111">i</span>&nbsp;<span class="op" id="6377113">:=</span>&nbsp;<span class="num" id="6377116">0</span><span class="op" id="6377117">;</span>&nbsp;<span class="ident" id="6377119">i</span>&nbsp;<span class="op" id="6377121">&lt;</span>&nbsp;<span class="ident" id="6377123">bpp</span><span class="op" id="6377126">;</span>&nbsp;<span class="ident" id="6377128">i</span><span class="op" id="6377129">++</span>&nbsp;<span class="op" id="6377132">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377136">cdat1</span><span class="op" id="6377141">[</span><span class="ident" id="6377142">i</span><span class="op" id="6377143">]</span>&nbsp;<span class="op" id="6377145">=</span>&nbsp;<span class="ident" id="6377147">cdat0</span><span class="op" id="6377152">[</span><span class="ident" id="6377153">i</span><span class="op" id="6377154">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377158">sum</span>&nbsp;<span class="op" id="6377162">+=</span>&nbsp;<span class="ident" id="6377165">abs8</span><span class="op" id="6377169">(</span><span class="ident" id="6377170">cdat1</span><span class="op" id="6377175">[</span><span class="ident" id="6377176">i</span><span class="op" id="6377177">]</span><span class="op" id="6377178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377184">for</span>&nbsp;<span class="ident" id="6377188">i</span>&nbsp;<span class="op" id="6377190">:=</span>&nbsp;<span class="ident" id="6377193">bpp</span><span class="op" id="6377196">;</span>&nbsp;<span class="ident" id="6377198">i</span>&nbsp;<span class="op" id="6377200">&lt;</span>&nbsp;<span class="ident" id="6377202">n</span><span class="op" id="6377203">;</span>&nbsp;<span class="ident" id="6377205">i</span><span class="op" id="6377206">++</span>&nbsp;<span class="op" id="6377209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377213">cdat1</span><span class="op" id="6377218">[</span><span class="ident" id="6377219">i</span><span class="op" id="6377220">]</span>&nbsp;<span class="op" id="6377222">=</span>&nbsp;<span class="ident" id="6377224">cdat0</span><span class="op" id="6377229">[</span><span class="ident" id="6377230">i</span><span class="op" id="6377231">]</span>&nbsp;<span class="op" id="6377233">-</span>&nbsp;<span class="ident" id="6377235">cdat0</span><span class="op" id="6377240">[</span><span class="ident" id="6377241">i</span><span class="op" id="6377242">-</span><span class="ident" id="6377243">bpp</span><span class="op" id="6377246">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377250">sum</span>&nbsp;<span class="op" id="6377254">+=</span>&nbsp;<span class="ident" id="6377257">abs8</span><span class="op" id="6377261">(</span><span class="ident" id="6377262">cdat1</span><span class="op" id="6377267">[</span><span class="ident" id="6377268">i</span><span class="op" id="6377269">]</span><span class="op" id="6377270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377274">if</span>&nbsp;<span class="ident" id="6377277">sum</span>&nbsp;<span class="op" id="6377281">&gt;=</span>&nbsp;<span class="ident" id="6377284">best</span>&nbsp;<span class="op" id="6377289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377294">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377305">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377308">if</span>&nbsp;<span class="ident" id="6377311">sum</span>&nbsp;<span class="op" id="6377315">&lt;</span>&nbsp;<span class="ident" id="6377317">best</span>&nbsp;<span class="op" id="6377322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377326">best</span>&nbsp;<span class="op" id="6377331">=</span>&nbsp;<span class="ident" id="6377333">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377339">filter</span>&nbsp;<span class="op" id="6377346">=</span>&nbsp;<span class="ident" id="6377348">ftSub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6377359">//&nbsp;The&nbsp;average&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377383">sum</span>&nbsp;<span class="op" id="6377387">=</span>&nbsp;<span class="num" id="6377389">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377392">for</span>&nbsp;<span class="ident" id="6377396">i</span>&nbsp;<span class="op" id="6377398">:=</span>&nbsp;<span class="num" id="6377401">0</span><span class="op" id="6377402">;</span>&nbsp;<span class="ident" id="6377404">i</span>&nbsp;<span class="op" id="6377406">&lt;</span>&nbsp;<span class="ident" id="6377408">bpp</span><span class="op" id="6377411">;</span>&nbsp;<span class="ident" id="6377413">i</span><span class="op" id="6377414">++</span>&nbsp;<span class="op" id="6377417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377421">cdat3</span><span class="op" id="6377426">[</span><span class="ident" id="6377427">i</span><span class="op" id="6377428">]</span>&nbsp;<span class="op" id="6377430">=</span>&nbsp;<span class="ident" id="6377432">cdat0</span><span class="op" id="6377437">[</span><span class="ident" id="6377438">i</span><span class="op" id="6377439">]</span>&nbsp;<span class="op" id="6377441">-</span>&nbsp;<span class="ident" id="6377443">pdat</span><span class="op" id="6377447">[</span><span class="ident" id="6377448">i</span><span class="op" id="6377449">]</span><span class="op" id="6377450">/</span><span class="num" id="6377451">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377455">sum</span>&nbsp;<span class="op" id="6377459">+=</span>&nbsp;<span class="ident" id="6377462">abs8</span><span class="op" id="6377466">(</span><span class="ident" id="6377467">cdat3</span><span class="op" id="6377472">[</span><span class="ident" id="6377473">i</span><span class="op" id="6377474">]</span><span class="op" id="6377475">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377481">for</span>&nbsp;<span class="ident" id="6377485">i</span>&nbsp;<span class="op" id="6377487">:=</span>&nbsp;<span class="ident" id="6377490">bpp</span><span class="op" id="6377493">;</span>&nbsp;<span class="ident" id="6377495">i</span>&nbsp;<span class="op" id="6377497">&lt;</span>&nbsp;<span class="ident" id="6377499">n</span><span class="op" id="6377500">;</span>&nbsp;<span class="ident" id="6377502">i</span><span class="op" id="6377503">++</span>&nbsp;<span class="op" id="6377506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377510">cdat3</span><span class="op" id="6377515">[</span><span class="ident" id="6377516">i</span><span class="op" id="6377517">]</span>&nbsp;<span class="op" id="6377519">=</span>&nbsp;<span class="ident" id="6377521">cdat0</span><span class="op" id="6377526">[</span><span class="ident" id="6377527">i</span><span class="op" id="6377528">]</span>&nbsp;<span class="op" id="6377530">-</span>&nbsp;<span class="builtintype" id="6377532">uint8</span><span class="op" id="6377537">(</span><span class="op" id="6377538">(</span><span class="builtintype" id="6377539">int</span><span class="op" id="6377542">(</span><span class="ident" id="6377543">cdat0</span><span class="op" id="6377548">[</span><span class="ident" id="6377549">i</span><span class="op" id="6377550">-</span><span class="ident" id="6377551">bpp</span><span class="op" id="6377554">]</span><span class="op" id="6377555">)</span><span class="op" id="6377556">+</span><span class="builtintype" id="6377557">int</span><span class="op" id="6377560">(</span><span class="ident" id="6377561">pdat</span><span class="op" id="6377565">[</span><span class="ident" id="6377566">i</span><span class="op" id="6377567">]</span><span class="op" id="6377568">)</span><span class="op" id="6377569">)</span><span class="op" id="6377570">/</span><span class="num" id="6377571">2</span><span class="op" id="6377572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377576">sum</span>&nbsp;<span class="op" id="6377580">+=</span>&nbsp;<span class="ident" id="6377583">abs8</span><span class="op" id="6377587">(</span><span class="ident" id="6377588">cdat3</span><span class="op" id="6377593">[</span><span class="ident" id="6377594">i</span><span class="op" id="6377595">]</span><span class="op" id="6377596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377600">if</span>&nbsp;<span class="ident" id="6377603">sum</span>&nbsp;<span class="op" id="6377607">&gt;=</span>&nbsp;<span class="ident" id="6377610">best</span>&nbsp;<span class="op" id="6377615">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377620">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377634">if</span>&nbsp;<span class="ident" id="6377637">sum</span>&nbsp;<span class="op" id="6377641">&lt;</span>&nbsp;<span class="ident" id="6377643">best</span>&nbsp;<span class="op" id="6377648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377652">best</span>&nbsp;<span class="op" id="6377657">=</span>&nbsp;<span class="ident" id="6377659">sum</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377665">filter</span>&nbsp;<span class="op" id="6377672">=</span>&nbsp;<span class="ident" id="6377674">ftAverage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377689">return</span>&nbsp;<span class="ident" id="6377696">filter</span><br>
<span class="lineno"></span><span class="op" id="6377703">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span><span class="keyword" id="6377706">func</span>&nbsp;<span class="ident" id="6377711">writeImage</span><span class="op" id="6377721">(</span><span class="ident" id="6377722">w</span>&nbsp;<span class="ident" id="6377724">io</span><span class="op" id="6377726">.</span><span class="ident" id="6377727">Writer</span><span class="op" id="6377733">,</span>&nbsp;<span class="ident" id="6377735">m</span>&nbsp;<span class="ident" id="6377737">image</span><span class="op" id="6377742">.</span><span class="ident" id="6377743">Image</span><span class="op" id="6377748">,</span>&nbsp;<span class="ident" id="6377750">cb</span>&nbsp;<span class="builtintype" id="6377753">int</span><span class="op" id="6377756">,</span>&nbsp;<span class="ident" id="6377758">level</span>&nbsp;<span class="builtintype" id="6377764">int</span><span class="op" id="6377767">)</span>&nbsp;<span class="builtintype" id="6377769">error</span>&nbsp;<span class="op" id="6377775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377778">zw</span><span class="op" id="6377780">,</span>&nbsp;<span class="ident" id="6377782">err</span>&nbsp;<span class="op" id="6377786">:=</span>&nbsp;<span class="ident" id="6377789">zlib</span><span class="op" id="6377793">.</span><span class="ident" id="6377794">NewWriterLevel</span><span class="op" id="6377808">(</span><span class="ident" id="6377809">w</span><span class="op" id="6377810">,</span>&nbsp;<span class="ident" id="6377812">level</span><span class="op" id="6377817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377820">if</span>&nbsp;<span class="ident" id="6377823">err</span>&nbsp;<span class="op" id="6377827">!=</span>&nbsp;<span class="ident" id="6377830">nil</span>&nbsp;<span class="op" id="6377834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377838">return</span>&nbsp;<span class="ident" id="6377845">err</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6377850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377853">defer</span>&nbsp;<span class="ident" id="6377859">zw</span><span class="op" id="6377861">.</span><span class="ident" id="6377862">Close</span><span class="op" id="6377867">(</span><span class="op" id="6377868">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377872">bpp</span>&nbsp;<span class="op" id="6377876">:=</span>&nbsp;<span class="num" id="6377879">0</span>&nbsp;<span class="comment" id="6377881">//&nbsp;Bytes&nbsp;per&nbsp;pixel.</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377903">switch</span>&nbsp;<span class="ident" id="6377910">cb</span>&nbsp;<span class="op" id="6377913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377916">case</span>&nbsp;<span class="ident" id="6377921">cbG8</span><span class="op" id="6377925">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377929">bpp</span>&nbsp;<span class="op" id="6377933">=</span>&nbsp;<span class="num" id="6377935">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377938">case</span>&nbsp;<span class="ident" id="6377943">cbTC8</span><span class="op" id="6377948">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377952">bpp</span>&nbsp;<span class="op" id="6377956">=</span>&nbsp;<span class="num" id="6377958">3</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377961">case</span>&nbsp;<span class="ident" id="6377966">cbP8</span><span class="op" id="6377970">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377974">bpp</span>&nbsp;<span class="op" id="6377978">=</span>&nbsp;<span class="num" id="6377980">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6377983">case</span>&nbsp;<span class="ident" id="6377988">cbTCA8</span><span class="op" id="6377994">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6377998">bpp</span>&nbsp;<span class="op" id="6378002">=</span>&nbsp;<span class="num" id="6378004">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378007">case</span>&nbsp;<span class="ident" id="6378012">cbTC16</span><span class="op" id="6378018">:</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378022">bpp</span>&nbsp;<span class="op" id="6378026">=</span>&nbsp;<span class="num" id="6378028">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378031">case</span>&nbsp;<span class="ident" id="6378036">cbTCA16</span><span class="op" id="6378043">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378047">bpp</span>&nbsp;<span class="op" id="6378051">=</span>&nbsp;<span class="num" id="6378053">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378056">case</span>&nbsp;<span class="ident" id="6378061">cbG16</span><span class="op" id="6378066">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378070">bpp</span>&nbsp;<span class="op" id="6378074">=</span>&nbsp;<span class="num" id="6378076">2</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6378079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6378082">//&nbsp;cr[*]&nbsp;and&nbsp;pr&nbsp;are&nbsp;the&nbsp;bytes&nbsp;for&nbsp;the&nbsp;current&nbsp;and&nbsp;previous&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6378147">//&nbsp;cr[0]&nbsp;is&nbsp;unfiltered&nbsp;(or&nbsp;equivalently,&nbsp;filtered&nbsp;with&nbsp;the&nbsp;ftNone&nbsp;filter).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6378223">//&nbsp;cr[ft],&nbsp;for&nbsp;non-zero&nbsp;filter&nbsp;types&nbsp;ft,&nbsp;are&nbsp;buffers&nbsp;for&nbsp;transforming&nbsp;cr[0]&nbsp;under&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6378310">//&nbsp;other&nbsp;PNG&nbsp;filter&nbsp;types.&nbsp;These&nbsp;buffers&nbsp;are&nbsp;allocated&nbsp;once&nbsp;and&nbsp;re-used&nbsp;for&nbsp;each&nbsp;row.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6378397">//&nbsp;The&nbsp;+1&nbsp;is&nbsp;for&nbsp;the&nbsp;per-row&nbsp;filter&nbsp;type,&nbsp;which&nbsp;is&nbsp;at&nbsp;cr[*][0].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378462">b</span>&nbsp;<span class="op" id="6378464">:=</span>&nbsp;<span class="ident" id="6378467">m</span><span class="op" id="6378468">.</span><span class="ident" id="6378469">Bounds</span><span class="op" id="6378475">(</span><span class="op" id="6378476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378479">var</span>&nbsp;<span class="ident" id="6378483">cr</span>&nbsp;<span class="op" id="6378486">[</span><span class="ident" id="6378487">nFilter</span><span class="op" id="6378494">]</span><span class="op" id="6378495">[</span><span class="op" id="6378496">]</span><span class="builtintype" id="6378497">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378504">for</span>&nbsp;<span class="ident" id="6378508">i</span>&nbsp;<span class="op" id="6378510">:=</span>&nbsp;<span class="keyword" id="6378513">range</span>&nbsp;<span class="ident" id="6378519">cr</span>&nbsp;<span class="op" id="6378522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378526">cr</span><span class="op" id="6378528">[</span><span class="ident" id="6378529">i</span><span class="op" id="6378530">]</span>&nbsp;<span class="op" id="6378532">=</span>&nbsp;<span class="builtinfunc" id="6378534">make</span><span class="op" id="6378538">(</span><span class="op" id="6378539">[</span><span class="op" id="6378540">]</span><span class="builtintype" id="6378541">uint8</span><span class="op" id="6378546">,</span>&nbsp;<span class="num" id="6378548">1</span><span class="op" id="6378549">+</span><span class="ident" id="6378550">bpp</span><span class="op" id="6378553">*</span><span class="ident" id="6378554">b</span><span class="op" id="6378555">.</span><span class="ident" id="6378556">Dx</span><span class="op" id="6378558">(</span><span class="op" id="6378559">)</span><span class="op" id="6378560">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378564">cr</span><span class="op" id="6378566">[</span><span class="ident" id="6378567">i</span><span class="op" id="6378568">]</span><span class="op" id="6378569">[</span><span class="num" id="6378570">0</span><span class="op" id="6378571">]</span>&nbsp;<span class="op" id="6378573">=</span>&nbsp;<span class="builtintype" id="6378575">uint8</span><span class="op" id="6378580">(</span><span class="ident" id="6378581">i</span><span class="op" id="6378582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6378585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378588">pr</span>&nbsp;<span class="op" id="6378591">:=</span>&nbsp;<span class="builtinfunc" id="6378594">make</span><span class="op" id="6378598">(</span><span class="op" id="6378599">[</span><span class="op" id="6378600">]</span><span class="builtintype" id="6378601">uint8</span><span class="op" id="6378606">,</span>&nbsp;<span class="num" id="6378608">1</span><span class="op" id="6378609">+</span><span class="ident" id="6378610">bpp</span><span class="op" id="6378613">*</span><span class="ident" id="6378614">b</span><span class="op" id="6378615">.</span><span class="ident" id="6378616">Dx</span><span class="op" id="6378618">(</span><span class="op" id="6378619">)</span><span class="op" id="6378620">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378624">gray</span><span class="op" id="6378628">,</span>&nbsp;<span class="ident" id="6378630">_</span>&nbsp;<span class="op" id="6378632">:=</span>&nbsp;<span class="ident" id="6378635">m</span><span class="op" id="6378636">.</span><span class="op" id="6378637">(</span><span class="op" id="6378638">*</span><span class="ident" id="6378639">image</span><span class="op" id="6378644">.</span><span class="ident" id="6378645">Gray</span><span class="op" id="6378649">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378652">rgba</span><span class="op" id="6378656">,</span>&nbsp;<span class="ident" id="6378658">_</span>&nbsp;<span class="op" id="6378660">:=</span>&nbsp;<span class="ident" id="6378663">m</span><span class="op" id="6378664">.</span><span class="op" id="6378665">(</span><span class="op" id="6378666">*</span><span class="ident" id="6378667">image</span><span class="op" id="6378672">.</span><span class="ident" id="6378673">RGBA</span><span class="op" id="6378677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378680">paletted</span><span class="op" id="6378688">,</span>&nbsp;<span class="ident" id="6378690">_</span>&nbsp;<span class="op" id="6378692">:=</span>&nbsp;<span class="ident" id="6378695">m</span><span class="op" id="6378696">.</span><span class="op" id="6378697">(</span><span class="op" id="6378698">*</span><span class="ident" id="6378699">image</span><span class="op" id="6378704">.</span><span class="ident" id="6378705">Paletted</span><span class="op" id="6378713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378716">nrgba</span><span class="op" id="6378721">,</span>&nbsp;<span class="ident" id="6378723">_</span>&nbsp;<span class="op" id="6378725">:=</span>&nbsp;<span class="ident" id="6378728">m</span><span class="op" id="6378729">.</span><span class="op" id="6378730">(</span><span class="op" id="6378731">*</span><span class="ident" id="6378732">image</span><span class="op" id="6378737">.</span><span class="ident" id="6378738">NRGBA</span><span class="op" id="6378743">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378747">for</span>&nbsp;<span class="ident" id="6378751">y</span>&nbsp;<span class="op" id="6378753">:=</span>&nbsp;<span class="ident" id="6378756">b</span><span class="op" id="6378757">.</span><span class="ident" id="6378758">Min</span><span class="op" id="6378761">.</span><span class="ident" id="6378762">Y</span><span class="op" id="6378763">;</span>&nbsp;<span class="ident" id="6378765">y</span>&nbsp;<span class="op" id="6378767">&lt;</span>&nbsp;<span class="ident" id="6378769">b</span><span class="op" id="6378770">.</span><span class="ident" id="6378771">Max</span><span class="op" id="6378774">.</span><span class="ident" id="6378775">Y</span><span class="op" id="6378776">;</span>&nbsp;<span class="ident" id="6378778">y</span><span class="op" id="6378779">++</span>&nbsp;<span class="op" id="6378782">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6378786">//&nbsp;Convert&nbsp;from&nbsp;colors&nbsp;to&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378821">i</span>&nbsp;<span class="op" id="6378823">:=</span>&nbsp;<span class="num" id="6378826">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378830">switch</span>&nbsp;<span class="ident" id="6378837">cb</span>&nbsp;<span class="op" id="6378840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378844">case</span>&nbsp;<span class="ident" id="6378849">cbG8</span><span class="op" id="6378853">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378858">if</span>&nbsp;<span class="ident" id="6378861">gray</span>&nbsp;<span class="op" id="6378866">!=</span>&nbsp;<span class="ident" id="6378869">nil</span>&nbsp;<span class="op" id="6378873">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6378879">offset</span>&nbsp;<span class="op" id="6378886">:=</span>&nbsp;<span class="op" id="6378889">(</span><span class="ident" id="6378890">y</span>&nbsp;<span class="op" id="6378892">-</span>&nbsp;<span class="ident" id="6378894">b</span><span class="op" id="6378895">.</span><span class="ident" id="6378896">Min</span><span class="op" id="6378899">.</span><span class="ident" id="6378900">Y</span><span class="op" id="6378901">)</span>&nbsp;<span class="op" id="6378903">*</span>&nbsp;<span class="ident" id="6378905">gray</span><span class="op" id="6378909">.</span><span class="ident" id="6378910">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6378921">copy</span><span class="op" id="6378925">(</span><span class="ident" id="6378926">cr</span><span class="op" id="6378928">[</span><span class="num" id="6378929">0</span><span class="op" id="6378930">]</span><span class="op" id="6378931">[</span><span class="num" id="6378932">1</span><span class="op" id="6378933">:</span><span class="op" id="6378934">]</span><span class="op" id="6378935">,</span>&nbsp;<span class="ident" id="6378937">gray</span><span class="op" id="6378941">.</span><span class="ident" id="6378942">Pix</span><span class="op" id="6378945">[</span><span class="ident" id="6378946">offset</span><span class="op" id="6378952">:</span><span class="ident" id="6378953">offset</span><span class="op" id="6378959">+</span><span class="ident" id="6378960">b</span><span class="op" id="6378961">.</span><span class="ident" id="6378962">Dx</span><span class="op" id="6378964">(</span><span class="op" id="6378965">)</span><span class="op" id="6378966">]</span><span class="op" id="6378967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6378972">}</span>&nbsp;<span class="keyword" id="6378974">else</span>&nbsp;<span class="op" id="6378979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6378985">for</span>&nbsp;<span class="ident" id="6378989">x</span>&nbsp;<span class="op" id="6378991">:=</span>&nbsp;<span class="ident" id="6378994">b</span><span class="op" id="6378995">.</span><span class="ident" id="6378996">Min</span><span class="op" id="6378999">.</span><span class="ident" id="6379000">X</span><span class="op" id="6379001">;</span>&nbsp;<span class="ident" id="6379003">x</span>&nbsp;<span class="op" id="6379005">&lt;</span>&nbsp;<span class="ident" id="6379007">b</span><span class="op" id="6379008">.</span><span class="ident" id="6379009">Max</span><span class="op" id="6379012">.</span><span class="ident" id="6379013">X</span><span class="op" id="6379014">;</span>&nbsp;<span class="ident" id="6379016">x</span><span class="op" id="6379017">++</span>&nbsp;<span class="op" id="6379020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379027">c</span>&nbsp;<span class="op" id="6379029">:=</span>&nbsp;<span class="ident" id="6379032">color</span><span class="op" id="6379037">.</span><span class="ident" id="6379038">GrayModel</span><span class="op" id="6379047">.</span><span class="ident" id="6379048">Convert</span><span class="op" id="6379055">(</span><span class="ident" id="6379056">m</span><span class="op" id="6379057">.</span><span class="ident" id="6379058">At</span><span class="op" id="6379060">(</span><span class="ident" id="6379061">x</span><span class="op" id="6379062">,</span>&nbsp;<span class="ident" id="6379064">y</span><span class="op" id="6379065">)</span><span class="op" id="6379066">)</span><span class="op" id="6379067">.</span><span class="op" id="6379068">(</span><span class="ident" id="6379069">color</span><span class="op" id="6379074">.</span><span class="ident" id="6379075">Gray</span><span class="op" id="6379079">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379086">cr</span><span class="op" id="6379088">[</span><span class="num" id="6379089">0</span><span class="op" id="6379090">]</span><span class="op" id="6379091">[</span><span class="ident" id="6379092">i</span><span class="op" id="6379093">]</span>&nbsp;<span class="op" id="6379095">=</span>&nbsp;<span class="ident" id="6379097">c</span><span class="op" id="6379098">.</span><span class="ident" id="6379099">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379106">i</span><span class="op" id="6379107">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379123">case</span>&nbsp;<span class="ident" id="6379128">cbTC8</span><span class="op" id="6379133">:</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6379138">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379210">cr0</span>&nbsp;<span class="op" id="6379214">:=</span>&nbsp;<span class="ident" id="6379217">cr</span><span class="op" id="6379219">[</span><span class="num" id="6379220">0</span><span class="op" id="6379221">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379226">stride</span><span class="op" id="6379232">,</span>&nbsp;<span class="ident" id="6379234">pix</span>&nbsp;<span class="op" id="6379238">:=</span>&nbsp;<span class="num" id="6379241">0</span><span class="op" id="6379242">,</span>&nbsp;<span class="op" id="6379244">[</span><span class="op" id="6379245">]</span><span class="builtintype" id="6379246">byte</span><span class="op" id="6379250">(</span><span class="ident" id="6379251">nil</span><span class="op" id="6379254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379259">if</span>&nbsp;<span class="ident" id="6379262">rgba</span>&nbsp;<span class="op" id="6379267">!=</span>&nbsp;<span class="ident" id="6379270">nil</span>&nbsp;<span class="op" id="6379274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379280">stride</span><span class="op" id="6379286">,</span>&nbsp;<span class="ident" id="6379288">pix</span>&nbsp;<span class="op" id="6379292">=</span>&nbsp;<span class="ident" id="6379294">rgba</span><span class="op" id="6379298">.</span><span class="ident" id="6379299">Stride</span><span class="op" id="6379305">,</span>&nbsp;<span class="ident" id="6379307">rgba</span><span class="op" id="6379311">.</span><span class="ident" id="6379312">Pix</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379319">}</span>&nbsp;<span class="keyword" id="6379321">else</span>&nbsp;<span class="keyword" id="6379326">if</span>&nbsp;<span class="ident" id="6379329">nrgba</span>&nbsp;<span class="op" id="6379335">!=</span>&nbsp;<span class="ident" id="6379338">nil</span>&nbsp;<span class="op" id="6379342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379348">stride</span><span class="op" id="6379354">,</span>&nbsp;<span class="ident" id="6379356">pix</span>&nbsp;<span class="op" id="6379360">=</span>&nbsp;<span class="ident" id="6379362">nrgba</span><span class="op" id="6379367">.</span><span class="ident" id="6379368">Stride</span><span class="op" id="6379374">,</span>&nbsp;<span class="ident" id="6379376">nrgba</span><span class="op" id="6379381">.</span><span class="ident" id="6379382">Pix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379394">if</span>&nbsp;<span class="ident" id="6379397">stride</span>&nbsp;<span class="op" id="6379404">!=</span>&nbsp;<span class="num" id="6379407">0</span>&nbsp;<span class="op" id="6379409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379415">j0</span>&nbsp;<span class="op" id="6379418">:=</span>&nbsp;<span class="op" id="6379421">(</span><span class="ident" id="6379422">y</span>&nbsp;<span class="op" id="6379424">-</span>&nbsp;<span class="ident" id="6379426">b</span><span class="op" id="6379427">.</span><span class="ident" id="6379428">Min</span><span class="op" id="6379431">.</span><span class="ident" id="6379432">Y</span><span class="op" id="6379433">)</span>&nbsp;<span class="op" id="6379435">*</span>&nbsp;<span class="ident" id="6379437">stride</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379448">j1</span>&nbsp;<span class="op" id="6379451">:=</span>&nbsp;<span class="ident" id="6379454">j0</span>&nbsp;<span class="op" id="6379457">+</span>&nbsp;<span class="ident" id="6379459">b</span><span class="op" id="6379460">.</span><span class="ident" id="6379461">Dx</span><span class="op" id="6379463">(</span><span class="op" id="6379464">)</span><span class="op" id="6379465">*</span><span class="num" id="6379466">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379472">for</span>&nbsp;<span class="ident" id="6379476">j</span>&nbsp;<span class="op" id="6379478">:=</span>&nbsp;<span class="ident" id="6379481">j0</span><span class="op" id="6379483">;</span>&nbsp;<span class="ident" id="6379485">j</span>&nbsp;<span class="op" id="6379487">&lt;</span>&nbsp;<span class="ident" id="6379489">j1</span><span class="op" id="6379491">;</span>&nbsp;<span class="ident" id="6379493">j</span>&nbsp;<span class="op" id="6379495">+=</span>&nbsp;<span class="num" id="6379498">4</span>&nbsp;<span class="op" id="6379500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379507">cr0</span><span class="op" id="6379510">[</span><span class="ident" id="6379511">i</span><span class="op" id="6379512">+</span><span class="num" id="6379513">0</span><span class="op" id="6379514">]</span>&nbsp;<span class="op" id="6379516">=</span>&nbsp;<span class="ident" id="6379518">pix</span><span class="op" id="6379521">[</span><span class="ident" id="6379522">j</span><span class="op" id="6379523">+</span><span class="num" id="6379524">0</span><span class="op" id="6379525">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379532">cr0</span><span class="op" id="6379535">[</span><span class="ident" id="6379536">i</span><span class="op" id="6379537">+</span><span class="num" id="6379538">1</span><span class="op" id="6379539">]</span>&nbsp;<span class="op" id="6379541">=</span>&nbsp;<span class="ident" id="6379543">pix</span><span class="op" id="6379546">[</span><span class="ident" id="6379547">j</span><span class="op" id="6379548">+</span><span class="num" id="6379549">1</span><span class="op" id="6379550">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379557">cr0</span><span class="op" id="6379560">[</span><span class="ident" id="6379561">i</span><span class="op" id="6379562">+</span><span class="num" id="6379563">2</span><span class="op" id="6379564">]</span>&nbsp;<span class="op" id="6379566">=</span>&nbsp;<span class="ident" id="6379568">pix</span><span class="op" id="6379571">[</span><span class="ident" id="6379572">j</span><span class="op" id="6379573">+</span><span class="num" id="6379574">2</span><span class="op" id="6379575">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379582">i</span>&nbsp;<span class="op" id="6379584">+=</span>&nbsp;<span class="num" id="6379587">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379598">}</span>&nbsp;<span class="keyword" id="6379600">else</span>&nbsp;<span class="op" id="6379605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379611">for</span>&nbsp;<span class="ident" id="6379615">x</span>&nbsp;<span class="op" id="6379617">:=</span>&nbsp;<span class="ident" id="6379620">b</span><span class="op" id="6379621">.</span><span class="ident" id="6379622">Min</span><span class="op" id="6379625">.</span><span class="ident" id="6379626">X</span><span class="op" id="6379627">;</span>&nbsp;<span class="ident" id="6379629">x</span>&nbsp;<span class="op" id="6379631">&lt;</span>&nbsp;<span class="ident" id="6379633">b</span><span class="op" id="6379634">.</span><span class="ident" id="6379635">Max</span><span class="op" id="6379638">.</span><span class="ident" id="6379639">X</span><span class="op" id="6379640">;</span>&nbsp;<span class="ident" id="6379642">x</span><span class="op" id="6379643">++</span>&nbsp;<span class="op" id="6379646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379653">r</span><span class="op" id="6379654">,</span>&nbsp;<span class="ident" id="6379656">g</span><span class="op" id="6379657">,</span>&nbsp;<span class="ident" id="6379659">b</span><span class="op" id="6379660">,</span>&nbsp;<span class="ident" id="6379662">_</span>&nbsp;<span class="op" id="6379664">:=</span>&nbsp;<span class="ident" id="6379667">m</span><span class="op" id="6379668">.</span><span class="ident" id="6379669">At</span><span class="op" id="6379671">(</span><span class="ident" id="6379672">x</span><span class="op" id="6379673">,</span>&nbsp;<span class="ident" id="6379675">y</span><span class="op" id="6379676">)</span><span class="op" id="6379677">.</span><span class="ident" id="6379678">RGBA</span><span class="op" id="6379682">(</span><span class="op" id="6379683">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379690">cr0</span><span class="op" id="6379693">[</span><span class="ident" id="6379694">i</span><span class="op" id="6379695">+</span><span class="num" id="6379696">0</span><span class="op" id="6379697">]</span>&nbsp;<span class="op" id="6379699">=</span>&nbsp;<span class="builtintype" id="6379701">uint8</span><span class="op" id="6379706">(</span><span class="ident" id="6379707">r</span>&nbsp;<span class="op" id="6379709">&gt;&gt;</span>&nbsp;<span class="num" id="6379712">8</span><span class="op" id="6379713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379720">cr0</span><span class="op" id="6379723">[</span><span class="ident" id="6379724">i</span><span class="op" id="6379725">+</span><span class="num" id="6379726">1</span><span class="op" id="6379727">]</span>&nbsp;<span class="op" id="6379729">=</span>&nbsp;<span class="builtintype" id="6379731">uint8</span><span class="op" id="6379736">(</span><span class="ident" id="6379737">g</span>&nbsp;<span class="op" id="6379739">&gt;&gt;</span>&nbsp;<span class="num" id="6379742">8</span><span class="op" id="6379743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379750">cr0</span><span class="op" id="6379753">[</span><span class="ident" id="6379754">i</span><span class="op" id="6379755">+</span><span class="num" id="6379756">2</span><span class="op" id="6379757">]</span>&nbsp;<span class="op" id="6379759">=</span>&nbsp;<span class="builtintype" id="6379761">uint8</span><span class="op" id="6379766">(</span><span class="ident" id="6379767">b</span>&nbsp;<span class="op" id="6379769">&gt;&gt;</span>&nbsp;<span class="num" id="6379772">8</span><span class="op" id="6379773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379780">i</span>&nbsp;<span class="op" id="6379782">+=</span>&nbsp;<span class="num" id="6379785">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379791">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379800">case</span>&nbsp;<span class="ident" id="6379805">cbP8</span><span class="op" id="6379809">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379814">if</span>&nbsp;<span class="ident" id="6379817">paletted</span>&nbsp;<span class="op" id="6379826">!=</span>&nbsp;<span class="ident" id="6379829">nil</span>&nbsp;<span class="op" id="6379833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379839">offset</span>&nbsp;<span class="op" id="6379846">:=</span>&nbsp;<span class="op" id="6379849">(</span><span class="ident" id="6379850">y</span>&nbsp;<span class="op" id="6379852">-</span>&nbsp;<span class="ident" id="6379854">b</span><span class="op" id="6379855">.</span><span class="ident" id="6379856">Min</span><span class="op" id="6379859">.</span><span class="ident" id="6379860">Y</span><span class="op" id="6379861">)</span>&nbsp;<span class="op" id="6379863">*</span>&nbsp;<span class="ident" id="6379865">paletted</span><span class="op" id="6379873">.</span><span class="ident" id="6379874">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6379885">copy</span><span class="op" id="6379889">(</span><span class="ident" id="6379890">cr</span><span class="op" id="6379892">[</span><span class="num" id="6379893">0</span><span class="op" id="6379894">]</span><span class="op" id="6379895">[</span><span class="num" id="6379896">1</span><span class="op" id="6379897">:</span><span class="op" id="6379898">]</span><span class="op" id="6379899">,</span>&nbsp;<span class="ident" id="6379901">paletted</span><span class="op" id="6379909">.</span><span class="ident" id="6379910">Pix</span><span class="op" id="6379913">[</span><span class="ident" id="6379914">offset</span><span class="op" id="6379920">:</span><span class="ident" id="6379921">offset</span><span class="op" id="6379927">+</span><span class="ident" id="6379928">b</span><span class="op" id="6379929">.</span><span class="ident" id="6379930">Dx</span><span class="op" id="6379932">(</span><span class="op" id="6379933">)</span><span class="op" id="6379934">]</span><span class="op" id="6379935">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6379940">}</span>&nbsp;<span class="keyword" id="6379942">else</span>&nbsp;<span class="op" id="6379947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6379953">pi</span>&nbsp;<span class="op" id="6379956">:=</span>&nbsp;<span class="ident" id="6379959">m</span><span class="op" id="6379960">.</span><span class="op" id="6379961">(</span><span class="ident" id="6379962">image</span><span class="op" id="6379967">.</span><span class="ident" id="6379968">PalettedImage</span><span class="op" id="6379981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6379987">for</span>&nbsp;<span class="ident" id="6379991">x</span>&nbsp;<span class="op" id="6379993">:=</span>&nbsp;<span class="ident" id="6379996">b</span><span class="op" id="6379997">.</span><span class="ident" id="6379998">Min</span><span class="op" id="6380001">.</span><span class="ident" id="6380002">X</span><span class="op" id="6380003">;</span>&nbsp;<span class="ident" id="6380005">x</span>&nbsp;<span class="op" id="6380007">&lt;</span>&nbsp;<span class="ident" id="6380009">b</span><span class="op" id="6380010">.</span><span class="ident" id="6380011">Max</span><span class="op" id="6380014">.</span><span class="ident" id="6380015">X</span><span class="op" id="6380016">;</span>&nbsp;<span class="ident" id="6380018">x</span><span class="op" id="6380019">++</span>&nbsp;<span class="op" id="6380022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380029">cr</span><span class="op" id="6380031">[</span><span class="num" id="6380032">0</span><span class="op" id="6380033">]</span><span class="op" id="6380034">[</span><span class="ident" id="6380035">i</span><span class="op" id="6380036">]</span>&nbsp;<span class="op" id="6380038">=</span>&nbsp;<span class="ident" id="6380040">pi</span><span class="op" id="6380042">.</span><span class="ident" id="6380043">ColorIndexAt</span><span class="op" id="6380055">(</span><span class="ident" id="6380056">x</span><span class="op" id="6380057">,</span>&nbsp;<span class="ident" id="6380059">y</span><span class="op" id="6380060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380067">i</span>&nbsp;<span class="op" id="6380069">+=</span>&nbsp;<span class="num" id="6380072">1</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6380078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6380083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380087">case</span>&nbsp;<span class="ident" id="6380092">cbTCA8</span><span class="op" id="6380098">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380103">if</span>&nbsp;<span class="ident" id="6380106">nrgba</span>&nbsp;<span class="op" id="6380112">!=</span>&nbsp;<span class="ident" id="6380115">nil</span>&nbsp;<span class="op" id="6380119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380125">offset</span>&nbsp;<span class="op" id="6380132">:=</span>&nbsp;<span class="op" id="6380135">(</span><span class="ident" id="6380136">y</span>&nbsp;<span class="op" id="6380138">-</span>&nbsp;<span class="ident" id="6380140">b</span><span class="op" id="6380141">.</span><span class="ident" id="6380142">Min</span><span class="op" id="6380145">.</span><span class="ident" id="6380146">Y</span><span class="op" id="6380147">)</span>&nbsp;<span class="op" id="6380149">*</span>&nbsp;<span class="ident" id="6380151">nrgba</span><span class="op" id="6380156">.</span><span class="ident" id="6380157">Stride</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6380168">copy</span><span class="op" id="6380172">(</span><span class="ident" id="6380173">cr</span><span class="op" id="6380175">[</span><span class="num" id="6380176">0</span><span class="op" id="6380177">]</span><span class="op" id="6380178">[</span><span class="num" id="6380179">1</span><span class="op" id="6380180">:</span><span class="op" id="6380181">]</span><span class="op" id="6380182">,</span>&nbsp;<span class="ident" id="6380184">nrgba</span><span class="op" id="6380189">.</span><span class="ident" id="6380190">Pix</span><span class="op" id="6380193">[</span><span class="ident" id="6380194">offset</span><span class="op" id="6380200">:</span><span class="ident" id="6380201">offset</span><span class="op" id="6380207">+</span><span class="ident" id="6380208">b</span><span class="op" id="6380209">.</span><span class="ident" id="6380210">Dx</span><span class="op" id="6380212">(</span><span class="op" id="6380213">)</span><span class="op" id="6380214">*</span><span class="num" id="6380215">4</span><span class="op" id="6380216">]</span><span class="op" id="6380217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6380222">}</span>&nbsp;<span class="keyword" id="6380224">else</span>&nbsp;<span class="op" id="6380229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6380235">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380332">for</span>&nbsp;<span class="ident" id="6380336">x</span>&nbsp;<span class="op" id="6380338">:=</span>&nbsp;<span class="ident" id="6380341">b</span><span class="op" id="6380342">.</span><span class="ident" id="6380343">Min</span><span class="op" id="6380346">.</span><span class="ident" id="6380347">X</span><span class="op" id="6380348">;</span>&nbsp;<span class="ident" id="6380350">x</span>&nbsp;<span class="op" id="6380352">&lt;</span>&nbsp;<span class="ident" id="6380354">b</span><span class="op" id="6380355">.</span><span class="ident" id="6380356">Max</span><span class="op" id="6380359">.</span><span class="ident" id="6380360">X</span><span class="op" id="6380361">;</span>&nbsp;<span class="ident" id="6380363">x</span><span class="op" id="6380364">++</span>&nbsp;<span class="op" id="6380367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380374">c</span>&nbsp;<span class="op" id="6380376">:=</span>&nbsp;<span class="ident" id="6380379">color</span><span class="op" id="6380384">.</span><span class="ident" id="6380385">NRGBAModel</span><span class="op" id="6380395">.</span><span class="ident" id="6380396">Convert</span><span class="op" id="6380403">(</span><span class="ident" id="6380404">m</span><span class="op" id="6380405">.</span><span class="ident" id="6380406">At</span><span class="op" id="6380408">(</span><span class="ident" id="6380409">x</span><span class="op" id="6380410">,</span>&nbsp;<span class="ident" id="6380412">y</span><span class="op" id="6380413">)</span><span class="op" id="6380414">)</span><span class="op" id="6380415">.</span><span class="op" id="6380416">(</span><span class="ident" id="6380417">color</span><span class="op" id="6380422">.</span><span class="ident" id="6380423">NRGBA</span><span class="op" id="6380428">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380435">cr</span><span class="op" id="6380437">[</span><span class="num" id="6380438">0</span><span class="op" id="6380439">]</span><span class="op" id="6380440">[</span><span class="ident" id="6380441">i</span><span class="op" id="6380442">+</span><span class="num" id="6380443">0</span><span class="op" id="6380444">]</span>&nbsp;<span class="op" id="6380446">=</span>&nbsp;<span class="ident" id="6380448">c</span><span class="op" id="6380449">.</span><span class="ident" id="6380450">R</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380457">cr</span><span class="op" id="6380459">[</span><span class="num" id="6380460">0</span><span class="op" id="6380461">]</span><span class="op" id="6380462">[</span><span class="ident" id="6380463">i</span><span class="op" id="6380464">+</span><span class="num" id="6380465">1</span><span class="op" id="6380466">]</span>&nbsp;<span class="op" id="6380468">=</span>&nbsp;<span class="ident" id="6380470">c</span><span class="op" id="6380471">.</span><span class="ident" id="6380472">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380479">cr</span><span class="op" id="6380481">[</span><span class="num" id="6380482">0</span><span class="op" id="6380483">]</span><span class="op" id="6380484">[</span><span class="ident" id="6380485">i</span><span class="op" id="6380486">+</span><span class="num" id="6380487">2</span><span class="op" id="6380488">]</span>&nbsp;<span class="op" id="6380490">=</span>&nbsp;<span class="ident" id="6380492">c</span><span class="op" id="6380493">.</span><span class="ident" id="6380494">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380501">cr</span><span class="op" id="6380503">[</span><span class="num" id="6380504">0</span><span class="op" id="6380505">]</span><span class="op" id="6380506">[</span><span class="ident" id="6380507">i</span><span class="op" id="6380508">+</span><span class="num" id="6380509">3</span><span class="op" id="6380510">]</span>&nbsp;<span class="op" id="6380512">=</span>&nbsp;<span class="ident" id="6380514">c</span><span class="op" id="6380515">.</span><span class="ident" id="6380516">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380523">i</span>&nbsp;<span class="op" id="6380525">+=</span>&nbsp;<span class="num" id="6380528">4</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6380534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6380539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380543">case</span>&nbsp;<span class="ident" id="6380548">cbG16</span><span class="op" id="6380553">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380558">for</span>&nbsp;<span class="ident" id="6380562">x</span>&nbsp;<span class="op" id="6380564">:=</span>&nbsp;<span class="ident" id="6380567">b</span><span class="op" id="6380568">.</span><span class="ident" id="6380569">Min</span><span class="op" id="6380572">.</span><span class="ident" id="6380573">X</span><span class="op" id="6380574">;</span>&nbsp;<span class="ident" id="6380576">x</span>&nbsp;<span class="op" id="6380578">&lt;</span>&nbsp;<span class="ident" id="6380580">b</span><span class="op" id="6380581">.</span><span class="ident" id="6380582">Max</span><span class="op" id="6380585">.</span><span class="ident" id="6380586">X</span><span class="op" id="6380587">;</span>&nbsp;<span class="ident" id="6380589">x</span><span class="op" id="6380590">++</span>&nbsp;<span class="op" id="6380593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380599">c</span>&nbsp;<span class="op" id="6380601">:=</span>&nbsp;<span class="ident" id="6380604">color</span><span class="op" id="6380609">.</span><span class="ident" id="6380610">Gray16Model</span><span class="op" id="6380621">.</span><span class="ident" id="6380622">Convert</span><span class="op" id="6380629">(</span><span class="ident" id="6380630">m</span><span class="op" id="6380631">.</span><span class="ident" id="6380632">At</span><span class="op" id="6380634">(</span><span class="ident" id="6380635">x</span><span class="op" id="6380636">,</span>&nbsp;<span class="ident" id="6380638">y</span><span class="op" id="6380639">)</span><span class="op" id="6380640">)</span><span class="op" id="6380641">.</span><span class="op" id="6380642">(</span><span class="ident" id="6380643">color</span><span class="op" id="6380648">.</span><span class="ident" id="6380649">Gray16</span><span class="op" id="6380655">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380661">cr</span><span class="op" id="6380663">[</span><span class="num" id="6380664">0</span><span class="op" id="6380665">]</span><span class="op" id="6380666">[</span><span class="ident" id="6380667">i</span><span class="op" id="6380668">+</span><span class="num" id="6380669">0</span><span class="op" id="6380670">]</span>&nbsp;<span class="op" id="6380672">=</span>&nbsp;<span class="builtintype" id="6380674">uint8</span><span class="op" id="6380679">(</span><span class="ident" id="6380680">c</span><span class="op" id="6380681">.</span><span class="ident" id="6380682">Y</span>&nbsp;<span class="op" id="6380684">&gt;&gt;</span>&nbsp;<span class="num" id="6380687">8</span><span class="op" id="6380688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380694">cr</span><span class="op" id="6380696">[</span><span class="num" id="6380697">0</span><span class="op" id="6380698">]</span><span class="op" id="6380699">[</span><span class="ident" id="6380700">i</span><span class="op" id="6380701">+</span><span class="num" id="6380702">1</span><span class="op" id="6380703">]</span>&nbsp;<span class="op" id="6380705">=</span>&nbsp;<span class="builtintype" id="6380707">uint8</span><span class="op" id="6380712">(</span><span class="ident" id="6380713">c</span><span class="op" id="6380714">.</span><span class="ident" id="6380715">Y</span><span class="op" id="6380716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380722">i</span>&nbsp;<span class="op" id="6380724">+=</span>&nbsp;<span class="num" id="6380727">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6380732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380736">case</span>&nbsp;<span class="ident" id="6380741">cbTC16</span><span class="op" id="6380747">:</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6380752">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6380824">for</span>&nbsp;<span class="ident" id="6380828">x</span>&nbsp;<span class="op" id="6380830">:=</span>&nbsp;<span class="ident" id="6380833">b</span><span class="op" id="6380834">.</span><span class="ident" id="6380835">Min</span><span class="op" id="6380838">.</span><span class="ident" id="6380839">X</span><span class="op" id="6380840">;</span>&nbsp;<span class="ident" id="6380842">x</span>&nbsp;<span class="op" id="6380844">&lt;</span>&nbsp;<span class="ident" id="6380846">b</span><span class="op" id="6380847">.</span><span class="ident" id="6380848">Max</span><span class="op" id="6380851">.</span><span class="ident" id="6380852">X</span><span class="op" id="6380853">;</span>&nbsp;<span class="ident" id="6380855">x</span><span class="op" id="6380856">++</span>&nbsp;<span class="op" id="6380859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380865">r</span><span class="op" id="6380866">,</span>&nbsp;<span class="ident" id="6380868">g</span><span class="op" id="6380869">,</span>&nbsp;<span class="ident" id="6380871">b</span><span class="op" id="6380872">,</span>&nbsp;<span class="ident" id="6380874">_</span>&nbsp;<span class="op" id="6380876">:=</span>&nbsp;<span class="ident" id="6380879">m</span><span class="op" id="6380880">.</span><span class="ident" id="6380881">At</span><span class="op" id="6380883">(</span><span class="ident" id="6380884">x</span><span class="op" id="6380885">,</span>&nbsp;<span class="ident" id="6380887">y</span><span class="op" id="6380888">)</span><span class="op" id="6380889">.</span><span class="ident" id="6380890">RGBA</span><span class="op" id="6380894">(</span><span class="op" id="6380895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380901">cr</span><span class="op" id="6380903">[</span><span class="num" id="6380904">0</span><span class="op" id="6380905">]</span><span class="op" id="6380906">[</span><span class="ident" id="6380907">i</span><span class="op" id="6380908">+</span><span class="num" id="6380909">0</span><span class="op" id="6380910">]</span>&nbsp;<span class="op" id="6380912">=</span>&nbsp;<span class="builtintype" id="6380914">uint8</span><span class="op" id="6380919">(</span><span class="ident" id="6380920">r</span>&nbsp;<span class="op" id="6380922">&gt;&gt;</span>&nbsp;<span class="num" id="6380925">8</span><span class="op" id="6380926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380932">cr</span><span class="op" id="6380934">[</span><span class="num" id="6380935">0</span><span class="op" id="6380936">]</span><span class="op" id="6380937">[</span><span class="ident" id="6380938">i</span><span class="op" id="6380939">+</span><span class="num" id="6380940">1</span><span class="op" id="6380941">]</span>&nbsp;<span class="op" id="6380943">=</span>&nbsp;<span class="builtintype" id="6380945">uint8</span><span class="op" id="6380950">(</span><span class="ident" id="6380951">r</span><span class="op" id="6380952">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380958">cr</span><span class="op" id="6380960">[</span><span class="num" id="6380961">0</span><span class="op" id="6380962">]</span><span class="op" id="6380963">[</span><span class="ident" id="6380964">i</span><span class="op" id="6380965">+</span><span class="num" id="6380966">2</span><span class="op" id="6380967">]</span>&nbsp;<span class="op" id="6380969">=</span>&nbsp;<span class="builtintype" id="6380971">uint8</span><span class="op" id="6380976">(</span><span class="ident" id="6380977">g</span>&nbsp;<span class="op" id="6380979">&gt;&gt;</span>&nbsp;<span class="num" id="6380982">8</span><span class="op" id="6380983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6380989">cr</span><span class="op" id="6380991">[</span><span class="num" id="6380992">0</span><span class="op" id="6380993">]</span><span class="op" id="6380994">[</span><span class="ident" id="6380995">i</span><span class="op" id="6380996">+</span><span class="num" id="6380997">3</span><span class="op" id="6380998">]</span>&nbsp;<span class="op" id="6381000">=</span>&nbsp;<span class="builtintype" id="6381002">uint8</span><span class="op" id="6381007">(</span><span class="ident" id="6381008">g</span><span class="op" id="6381009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381015">cr</span><span class="op" id="6381017">[</span><span class="num" id="6381018">0</span><span class="op" id="6381019">]</span><span class="op" id="6381020">[</span><span class="ident" id="6381021">i</span><span class="op" id="6381022">+</span><span class="num" id="6381023">4</span><span class="op" id="6381024">]</span>&nbsp;<span class="op" id="6381026">=</span>&nbsp;<span class="builtintype" id="6381028">uint8</span><span class="op" id="6381033">(</span><span class="ident" id="6381034">b</span>&nbsp;<span class="op" id="6381036">&gt;&gt;</span>&nbsp;<span class="num" id="6381039">8</span><span class="op" id="6381040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381046">cr</span><span class="op" id="6381048">[</span><span class="num" id="6381049">0</span><span class="op" id="6381050">]</span><span class="op" id="6381051">[</span><span class="ident" id="6381052">i</span><span class="op" id="6381053">+</span><span class="num" id="6381054">5</span><span class="op" id="6381055">]</span>&nbsp;<span class="op" id="6381057">=</span>&nbsp;<span class="builtintype" id="6381059">uint8</span><span class="op" id="6381064">(</span><span class="ident" id="6381065">b</span><span class="op" id="6381066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381072">i</span>&nbsp;<span class="op" id="6381074">+=</span>&nbsp;<span class="num" id="6381077">6</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6381082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381086">case</span>&nbsp;<span class="ident" id="6381091">cbTCA16</span><span class="op" id="6381098">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6381103">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381199">for</span>&nbsp;<span class="ident" id="6381203">x</span>&nbsp;<span class="op" id="6381205">:=</span>&nbsp;<span class="ident" id="6381208">b</span><span class="op" id="6381209">.</span><span class="ident" id="6381210">Min</span><span class="op" id="6381213">.</span><span class="ident" id="6381214">X</span><span class="op" id="6381215">;</span>&nbsp;<span class="ident" id="6381217">x</span>&nbsp;<span class="op" id="6381219">&lt;</span>&nbsp;<span class="ident" id="6381221">b</span><span class="op" id="6381222">.</span><span class="ident" id="6381223">Max</span><span class="op" id="6381226">.</span><span class="ident" id="6381227">X</span><span class="op" id="6381228">;</span>&nbsp;<span class="ident" id="6381230">x</span><span class="op" id="6381231">++</span>&nbsp;<span class="op" id="6381234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381240">c</span>&nbsp;<span class="op" id="6381242">:=</span>&nbsp;<span class="ident" id="6381245">color</span><span class="op" id="6381250">.</span><span class="ident" id="6381251">NRGBA64Model</span><span class="op" id="6381263">.</span><span class="ident" id="6381264">Convert</span><span class="op" id="6381271">(</span><span class="ident" id="6381272">m</span><span class="op" id="6381273">.</span><span class="ident" id="6381274">At</span><span class="op" id="6381276">(</span><span class="ident" id="6381277">x</span><span class="op" id="6381278">,</span>&nbsp;<span class="ident" id="6381280">y</span><span class="op" id="6381281">)</span><span class="op" id="6381282">)</span><span class="op" id="6381283">.</span><span class="op" id="6381284">(</span><span class="ident" id="6381285">color</span><span class="op" id="6381290">.</span><span class="ident" id="6381291">NRGBA64</span><span class="op" id="6381298">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381304">cr</span><span class="op" id="6381306">[</span><span class="num" id="6381307">0</span><span class="op" id="6381308">]</span><span class="op" id="6381309">[</span><span class="ident" id="6381310">i</span><span class="op" id="6381311">+</span><span class="num" id="6381312">0</span><span class="op" id="6381313">]</span>&nbsp;<span class="op" id="6381315">=</span>&nbsp;<span class="builtintype" id="6381317">uint8</span><span class="op" id="6381322">(</span><span class="ident" id="6381323">c</span><span class="op" id="6381324">.</span><span class="ident" id="6381325">R</span>&nbsp;<span class="op" id="6381327">&gt;&gt;</span>&nbsp;<span class="num" id="6381330">8</span><span class="op" id="6381331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381337">cr</span><span class="op" id="6381339">[</span><span class="num" id="6381340">0</span><span class="op" id="6381341">]</span><span class="op" id="6381342">[</span><span class="ident" id="6381343">i</span><span class="op" id="6381344">+</span><span class="num" id="6381345">1</span><span class="op" id="6381346">]</span>&nbsp;<span class="op" id="6381348">=</span>&nbsp;<span class="builtintype" id="6381350">uint8</span><span class="op" id="6381355">(</span><span class="ident" id="6381356">c</span><span class="op" id="6381357">.</span><span class="ident" id="6381358">R</span><span class="op" id="6381359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381365">cr</span><span class="op" id="6381367">[</span><span class="num" id="6381368">0</span><span class="op" id="6381369">]</span><span class="op" id="6381370">[</span><span class="ident" id="6381371">i</span><span class="op" id="6381372">+</span><span class="num" id="6381373">2</span><span class="op" id="6381374">]</span>&nbsp;<span class="op" id="6381376">=</span>&nbsp;<span class="builtintype" id="6381378">uint8</span><span class="op" id="6381383">(</span><span class="ident" id="6381384">c</span><span class="op" id="6381385">.</span><span class="ident" id="6381386">G</span>&nbsp;<span class="op" id="6381388">&gt;&gt;</span>&nbsp;<span class="num" id="6381391">8</span><span class="op" id="6381392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381398">cr</span><span class="op" id="6381400">[</span><span class="num" id="6381401">0</span><span class="op" id="6381402">]</span><span class="op" id="6381403">[</span><span class="ident" id="6381404">i</span><span class="op" id="6381405">+</span><span class="num" id="6381406">3</span><span class="op" id="6381407">]</span>&nbsp;<span class="op" id="6381409">=</span>&nbsp;<span class="builtintype" id="6381411">uint8</span><span class="op" id="6381416">(</span><span class="ident" id="6381417">c</span><span class="op" id="6381418">.</span><span class="ident" id="6381419">G</span><span class="op" id="6381420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381426">cr</span><span class="op" id="6381428">[</span><span class="num" id="6381429">0</span><span class="op" id="6381430">]</span><span class="op" id="6381431">[</span><span class="ident" id="6381432">i</span><span class="op" id="6381433">+</span><span class="num" id="6381434">4</span><span class="op" id="6381435">]</span>&nbsp;<span class="op" id="6381437">=</span>&nbsp;<span class="builtintype" id="6381439">uint8</span><span class="op" id="6381444">(</span><span class="ident" id="6381445">c</span><span class="op" id="6381446">.</span><span class="ident" id="6381447">B</span>&nbsp;<span class="op" id="6381449">&gt;&gt;</span>&nbsp;<span class="num" id="6381452">8</span><span class="op" id="6381453">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381459">cr</span><span class="op" id="6381461">[</span><span class="num" id="6381462">0</span><span class="op" id="6381463">]</span><span class="op" id="6381464">[</span><span class="ident" id="6381465">i</span><span class="op" id="6381466">+</span><span class="num" id="6381467">5</span><span class="op" id="6381468">]</span>&nbsp;<span class="op" id="6381470">=</span>&nbsp;<span class="builtintype" id="6381472">uint8</span><span class="op" id="6381477">(</span><span class="ident" id="6381478">c</span><span class="op" id="6381479">.</span><span class="ident" id="6381480">B</span><span class="op" id="6381481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381487">cr</span><span class="op" id="6381489">[</span><span class="num" id="6381490">0</span><span class="op" id="6381491">]</span><span class="op" id="6381492">[</span><span class="ident" id="6381493">i</span><span class="op" id="6381494">+</span><span class="num" id="6381495">6</span><span class="op" id="6381496">]</span>&nbsp;<span class="op" id="6381498">=</span>&nbsp;<span class="builtintype" id="6381500">uint8</span><span class="op" id="6381505">(</span><span class="ident" id="6381506">c</span><span class="op" id="6381507">.</span><span class="ident" id="6381508">A</span>&nbsp;<span class="op" id="6381510">&gt;&gt;</span>&nbsp;<span class="num" id="6381513">8</span><span class="op" id="6381514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381520">cr</span><span class="op" id="6381522">[</span><span class="num" id="6381523">0</span><span class="op" id="6381524">]</span><span class="op" id="6381525">[</span><span class="ident" id="6381526">i</span><span class="op" id="6381527">+</span><span class="num" id="6381528">7</span><span class="op" id="6381529">]</span>&nbsp;<span class="op" id="6381531">=</span>&nbsp;<span class="builtintype" id="6381533">uint8</span><span class="op" id="6381538">(</span><span class="ident" id="6381539">c</span><span class="op" id="6381540">.</span><span class="ident" id="6381541">A</span><span class="op" id="6381542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381548">i</span>&nbsp;<span class="op" id="6381550">+=</span>&nbsp;<span class="num" id="6381553">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6381558">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6381562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6381567">//&nbsp;Apply&nbsp;the&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381590">f</span>&nbsp;<span class="op" id="6381592">:=</span>&nbsp;<span class="ident" id="6381595">ftNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381604">if</span>&nbsp;<span class="ident" id="6381607">level</span>&nbsp;<span class="op" id="6381613">!=</span>&nbsp;<span class="ident" id="6381616">zlib</span><span class="op" id="6381620">.</span><span class="ident" id="6381621">NoCompression</span>&nbsp;<span class="op" id="6381635">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381640">f</span>&nbsp;<span class="op" id="6381642">=</span>&nbsp;<span class="ident" id="6381644">filter</span><span class="op" id="6381650">(</span><span class="op" id="6381651">&amp;</span><span class="ident" id="6381652">cr</span><span class="op" id="6381654">,</span>&nbsp;<span class="ident" id="6381656">pr</span><span class="op" id="6381658">,</span>&nbsp;<span class="ident" id="6381660">bpp</span><span class="op" id="6381663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6381667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6381672">//&nbsp;Write&nbsp;the&nbsp;compressed&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381705">if</span>&nbsp;<span class="ident" id="6381708">_</span><span class="op" id="6381709">,</span>&nbsp;<span class="ident" id="6381711">err</span>&nbsp;<span class="op" id="6381715">:=</span>&nbsp;<span class="ident" id="6381718">zw</span><span class="op" id="6381720">.</span><span class="ident" id="6381721">Write</span><span class="op" id="6381726">(</span><span class="ident" id="6381727">cr</span><span class="op" id="6381729">[</span><span class="ident" id="6381730">f</span><span class="op" id="6381731">]</span><span class="op" id="6381732">)</span><span class="op" id="6381733">;</span>&nbsp;<span class="ident" id="6381735">err</span>&nbsp;<span class="op" id="6381739">!=</span>&nbsp;<span class="ident" id="6381742">nil</span>&nbsp;<span class="op" id="6381746">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381751">return</span>&nbsp;<span class="ident" id="6381758">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6381764">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6381769">//&nbsp;The&nbsp;current&nbsp;row&nbsp;for&nbsp;y&nbsp;is&nbsp;the&nbsp;previous&nbsp;row&nbsp;for&nbsp;y+1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6381825">pr</span><span class="op" id="6381827">,</span>&nbsp;<span class="ident" id="6381829">cr</span><span class="op" id="6381831">[</span><span class="num" id="6381832">0</span><span class="op" id="6381833">]</span>&nbsp;<span class="op" id="6381835">=</span>&nbsp;<span class="ident" id="6381837">cr</span><span class="op" id="6381839">[</span><span class="num" id="6381840">0</span><span class="op" id="6381841">]</span><span class="op" id="6381842">,</span>&nbsp;<span class="ident" id="6381844">pr</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6381848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381851">return</span>&nbsp;<span class="ident" id="6381858">nil</span><br>
<span class="lineno"></span><span class="op" id="6381862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6381865">//&nbsp;Write&nbsp;the&nbsp;actual&nbsp;image&nbsp;data&nbsp;to&nbsp;one&nbsp;or&nbsp;more&nbsp;IDAT&nbsp;chunks.</span><br>
<span class="lineno">440</span><span class="keyword" id="6381924">func</span>&nbsp;<span class="op" id="6381929">(</span><span class="ident" id="6381930">e</span>&nbsp;<span class="op" id="6381932">*</span><span class="ident" id="6381933">encoder</span><span class="op" id="6381940">)</span>&nbsp;<span class="ident" id="6381942">writeIDATs</span><span class="op" id="6381952">(</span><span class="op" id="6381953">)</span>&nbsp;<span class="op" id="6381955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381958">if</span>&nbsp;<span class="ident" id="6381961">e</span><span class="op" id="6381962">.</span><span class="ident" id="6381963">err</span>&nbsp;<span class="op" id="6381967">!=</span>&nbsp;<span class="ident" id="6381970">nil</span>&nbsp;<span class="op" id="6381974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381978">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6381986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6381989">var</span>&nbsp;<span class="ident" id="6381993">bw</span>&nbsp;<span class="op" id="6381996">*</span><span class="ident" id="6381997">bufio</span><span class="op" id="6382002">.</span><span class="ident" id="6382003">Writer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6382011">bw</span>&nbsp;<span class="op" id="6382014">=</span>&nbsp;<span class="ident" id="6382016">bufio</span><span class="op" id="6382021">.</span><span class="ident" id="6382022">NewWriterSize</span><span class="op" id="6382035">(</span><span class="ident" id="6382036">e</span><span class="op" id="6382037">,</span>&nbsp;<span class="num" id="6382039">1</span><span class="op" id="6382040">&lt;&lt;</span><span class="num" id="6382042">15</span><span class="op" id="6382044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6382047">e</span><span class="op" id="6382048">.</span><span class="ident" id="6382049">err</span>&nbsp;<span class="op" id="6382053">=</span>&nbsp;<span class="ident" id="6382055">writeImage</span><span class="op" id="6382065">(</span><span class="ident" id="6382066">bw</span><span class="op" id="6382068">,</span>&nbsp;<span class="ident" id="6382070">e</span><span class="op" id="6382071">.</span><span class="ident" id="6382072">m</span><span class="op" id="6382073">,</span>&nbsp;<span class="ident" id="6382075">e</span><span class="op" id="6382076">.</span><span class="ident" id="6382077">cb</span><span class="op" id="6382079">,</span>&nbsp;<span class="ident" id="6382081">levelToZlib</span><span class="op" id="6382092">(</span><span class="ident" id="6382093">e</span><span class="op" id="6382094">.</span><span class="ident" id="6382095">enc</span><span class="op" id="6382098">.</span><span class="ident" id="6382099">CompressionLevel</span><span class="op" id="6382115">)</span><span class="op" id="6382116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382119">if</span>&nbsp;<span class="ident" id="6382122">e</span><span class="op" id="6382123">.</span><span class="ident" id="6382124">err</span>&nbsp;<span class="op" id="6382128">!=</span>&nbsp;<span class="ident" id="6382131">nil</span>&nbsp;<span class="op" id="6382135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382139">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6382147">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6382150">e</span><span class="op" id="6382151">.</span><span class="ident" id="6382152">err</span>&nbsp;<span class="op" id="6382156">=</span>&nbsp;<span class="ident" id="6382158">bw</span><span class="op" id="6382160">.</span><span class="ident" id="6382161">Flush</span><span class="op" id="6382166">(</span><span class="op" id="6382167">)</span><br>
<span class="lineno"></span><span class="op" id="6382169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6382172">//&nbsp;This&nbsp;function&nbsp;is&nbsp;required&nbsp;because&nbsp;we&nbsp;want&nbsp;the&nbsp;zero&nbsp;value&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="6382235">//&nbsp;Encoder.CompressionLevel&nbsp;to&nbsp;map&nbsp;to&nbsp;zlib.DefaultCompression.</span><br>
<span class="lineno">455</span><span class="keyword" id="6382298">func</span>&nbsp;<span class="ident" id="6382303">levelToZlib</span><span class="op" id="6382314">(</span><span class="ident" id="6382315">l</span>&nbsp;<span class="ident" id="6382317">CompressionLevel</span><span class="op" id="6382333">)</span>&nbsp;<span class="builtintype" id="6382335">int</span>&nbsp;<span class="op" id="6382339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382342">switch</span>&nbsp;<span class="ident" id="6382349">l</span>&nbsp;<span class="op" id="6382351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382354">case</span>&nbsp;<span class="ident" id="6382359">DefaultCompression</span><span class="op" id="6382377">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382381">return</span>&nbsp;<span class="ident" id="6382388">zlib</span><span class="op" id="6382392">.</span><span class="ident" id="6382393">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382413">case</span>&nbsp;<span class="ident" id="6382418">NoCompression</span><span class="op" id="6382431">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382435">return</span>&nbsp;<span class="ident" id="6382442">zlib</span><span class="op" id="6382446">.</span><span class="ident" id="6382447">NoCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382462">case</span>&nbsp;<span class="ident" id="6382467">BestSpeed</span><span class="op" id="6382476">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382480">return</span>&nbsp;<span class="ident" id="6382487">zlib</span><span class="op" id="6382491">.</span><span class="ident" id="6382492">BestSpeed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382503">case</span>&nbsp;<span class="ident" id="6382508">BestCompression</span><span class="op" id="6382523">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382527">return</span>&nbsp;<span class="ident" id="6382534">zlib</span><span class="op" id="6382538">.</span><span class="ident" id="6382539">BestCompression</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382556">default</span><span class="op" id="6382563">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382567">return</span>&nbsp;<span class="ident" id="6382574">zlib</span><span class="op" id="6382578">.</span><span class="ident" id="6382579">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6382599">}</span><br>
<span class="lineno"></span><span class="op" id="6382601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="keyword" id="6382604">func</span>&nbsp;<span class="op" id="6382609">(</span><span class="ident" id="6382610">e</span>&nbsp;<span class="op" id="6382612">*</span><span class="ident" id="6382613">encoder</span><span class="op" id="6382620">)</span>&nbsp;<span class="ident" id="6382622">writeIEND</span><span class="op" id="6382631">(</span><span class="op" id="6382632">)</span>&nbsp;<span class="op" id="6382634">{</span>&nbsp;<span class="ident" id="6382636">e</span><span class="op" id="6382637">.</span><span class="ident" id="6382638">writeChunk</span><span class="op" id="6382648">(</span><span class="ident" id="6382649">nil</span><span class="op" id="6382652">,</span>&nbsp;<span class="string" id="6382654">&#34;IEND&#34;</span><span class="op" id="6382660">)</span>&nbsp;<span class="op" id="6382662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6382665">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.&nbsp;Any&nbsp;Image&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6382731">//&nbsp;encoded,&nbsp;but&nbsp;images&nbsp;that&nbsp;are&nbsp;not&nbsp;image.NRGBA&nbsp;might&nbsp;be&nbsp;encoded&nbsp;lossily.</span><br>
<span class="lineno"></span><span class="keyword" id="6382805">func</span>&nbsp;<span class="ident" id="6382810">Encode</span><span class="op" id="6382816">(</span><span class="ident" id="6382817">w</span>&nbsp;<span class="ident" id="6382819">io</span><span class="op" id="6382821">.</span><span class="ident" id="6382822">Writer</span><span class="op" id="6382828">,</span>&nbsp;<span class="ident" id="6382830">m</span>&nbsp;<span class="ident" id="6382832">image</span><span class="op" id="6382837">.</span><span class="ident" id="6382838">Image</span><span class="op" id="6382843">)</span>&nbsp;<span class="builtintype" id="6382845">error</span>&nbsp;<span class="op" id="6382851">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382854">var</span>&nbsp;<span class="ident" id="6382858">e</span>&nbsp;<span class="ident" id="6382860">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6382869">return</span>&nbsp;<span class="ident" id="6382876">e</span><span class="op" id="6382877">.</span><span class="ident" id="6382878">Encode</span><span class="op" id="6382884">(</span><span class="ident" id="6382885">w</span><span class="op" id="6382886">,</span>&nbsp;<span class="ident" id="6382888">m</span><span class="op" id="6382889">)</span><br>
<span class="lineno"></span><span class="op" id="6382891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6382894">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.</span><br>
<span class="lineno">480</span><span class="keyword" id="6382943">func</span>&nbsp;<span class="op" id="6382948">(</span><span class="ident" id="6382949">enc</span>&nbsp;<span class="op" id="6382953">*</span><span class="ident" id="6382954">Encoder</span><span class="op" id="6382961">)</span>&nbsp;<span class="ident" id="6382963">Encode</span><span class="op" id="6382969">(</span><span class="ident" id="6382970">w</span>&nbsp;<span class="ident" id="6382972">io</span><span class="op" id="6382974">.</span><span class="ident" id="6382975">Writer</span><span class="op" id="6382981">,</span>&nbsp;<span class="ident" id="6382983">m</span>&nbsp;<span class="ident" id="6382985">image</span><span class="op" id="6382990">.</span><span class="ident" id="6382991">Image</span><span class="op" id="6382996">)</span>&nbsp;<span class="builtintype" id="6382998">error</span>&nbsp;<span class="op" id="6383004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6383007">//&nbsp;Obviously,&nbsp;negative&nbsp;widths&nbsp;and&nbsp;heights&nbsp;are&nbsp;invalid.&nbsp;Furthermore,&nbsp;the&nbsp;PNG</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6383084">//&nbsp;spec&nbsp;section&nbsp;11.2.2&nbsp;says&nbsp;that&nbsp;zero&nbsp;is&nbsp;invalid.&nbsp;Excessively&nbsp;large&nbsp;images&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6383164">//&nbsp;also&nbsp;rejected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383183">mw</span><span class="op" id="6383185">,</span>&nbsp;<span class="ident" id="6383187">mh</span>&nbsp;<span class="op" id="6383190">:=</span>&nbsp;<span class="ident" id="6383193">int64</span><span class="op" id="6383198">(</span><span class="ident" id="6383199">m</span><span class="op" id="6383200">.</span><span class="ident" id="6383201">Bounds</span><span class="op" id="6383207">(</span><span class="op" id="6383208">)</span><span class="op" id="6383209">.</span><span class="ident" id="6383210">Dx</span><span class="op" id="6383212">(</span><span class="op" id="6383213">)</span><span class="op" id="6383214">)</span><span class="op" id="6383215">,</span>&nbsp;<span class="ident" id="6383217">int64</span><span class="op" id="6383222">(</span><span class="ident" id="6383223">m</span><span class="op" id="6383224">.</span><span class="ident" id="6383225">Bounds</span><span class="op" id="6383231">(</span><span class="op" id="6383232">)</span><span class="op" id="6383233">.</span><span class="ident" id="6383234">Dy</span><span class="op" id="6383236">(</span><span class="op" id="6383237">)</span><span class="op" id="6383238">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383241">if</span>&nbsp;<span class="ident" id="6383244">mw</span>&nbsp;<span class="op" id="6383247">&lt;=</span>&nbsp;<span class="num" id="6383250">0</span>&nbsp;<span class="op" id="6383252">||</span>&nbsp;<span class="ident" id="6383255">mh</span>&nbsp;<span class="op" id="6383258">&lt;=</span>&nbsp;<span class="num" id="6383261">0</span>&nbsp;<span class="op" id="6383263">||</span>&nbsp;<span class="ident" id="6383266">mw</span>&nbsp;<span class="op" id="6383269">&gt;=</span>&nbsp;<span class="num" id="6383272">1</span><span class="op" id="6383273">&lt;&lt;</span><span class="num" id="6383275">32</span>&nbsp;<span class="op" id="6383278">||</span>&nbsp;<span class="ident" id="6383281">mh</span>&nbsp;<span class="op" id="6383284">&gt;=</span>&nbsp;<span class="num" id="6383287">1</span><span class="op" id="6383288">&lt;&lt;</span><span class="num" id="6383290">32</span>&nbsp;<span class="op" id="6383293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383297">return</span>&nbsp;<span class="ident" id="6383304">FormatError</span><span class="op" id="6383315">(</span><span class="string" id="6383316">&#34;invalid&nbsp;image&nbsp;size:&nbsp;&#34;</span>&nbsp;<span class="op" id="6383339">+</span>&nbsp;<span class="ident" id="6383341">strconv</span><span class="op" id="6383348">.</span><span class="ident" id="6383349">FormatInt</span><span class="op" id="6383358">(</span><span class="ident" id="6383359">mw</span><span class="op" id="6383361">,</span>&nbsp;<span class="num" id="6383363">10</span><span class="op" id="6383365">)</span>&nbsp;<span class="op" id="6383367">+</span>&nbsp;<span class="string" id="6383369">&#34;x&#34;</span>&nbsp;<span class="op" id="6383373">+</span>&nbsp;<span class="ident" id="6383375">strconv</span><span class="op" id="6383382">.</span><span class="ident" id="6383383">FormatInt</span><span class="op" id="6383392">(</span><span class="ident" id="6383393">mh</span><span class="op" id="6383395">,</span>&nbsp;<span class="num" id="6383397">10</span><span class="op" id="6383399">)</span><span class="op" id="6383400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6383403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383407">var</span>&nbsp;<span class="ident" id="6383411">e</span>&nbsp;<span class="ident" id="6383413">encoder</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383422">e</span><span class="op" id="6383423">.</span><span class="ident" id="6383424">enc</span>&nbsp;<span class="op" id="6383428">=</span>&nbsp;<span class="ident" id="6383430">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383435">e</span><span class="op" id="6383436">.</span><span class="ident" id="6383437">w</span>&nbsp;<span class="op" id="6383439">=</span>&nbsp;<span class="ident" id="6383441">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383444">e</span><span class="op" id="6383445">.</span><span class="ident" id="6383446">m</span>&nbsp;<span class="op" id="6383448">=</span>&nbsp;<span class="ident" id="6383450">m</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383454">var</span>&nbsp;<span class="ident" id="6383458">pal</span>&nbsp;<span class="ident" id="6383462">color</span><span class="op" id="6383467">.</span><span class="ident" id="6383468">Palette</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6383477">//&nbsp;cbP8&nbsp;encoding&nbsp;needs&nbsp;PalettedImage&#39;s&nbsp;ColorIndexAt&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383538">if</span>&nbsp;<span class="ident" id="6383541">_</span><span class="op" id="6383542">,</span>&nbsp;<span class="ident" id="6383544">ok</span>&nbsp;<span class="op" id="6383547">:=</span>&nbsp;<span class="ident" id="6383550">m</span><span class="op" id="6383551">.</span><span class="op" id="6383552">(</span><span class="ident" id="6383553">image</span><span class="op" id="6383558">.</span><span class="ident" id="6383559">PalettedImage</span><span class="op" id="6383572">)</span><span class="op" id="6383573">;</span>&nbsp;<span class="ident" id="6383575">ok</span>&nbsp;<span class="op" id="6383578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383582">pal</span><span class="op" id="6383585">,</span>&nbsp;<span class="ident" id="6383587">_</span>&nbsp;<span class="op" id="6383589">=</span>&nbsp;<span class="ident" id="6383591">m</span><span class="op" id="6383592">.</span><span class="ident" id="6383593">ColorModel</span><span class="op" id="6383603">(</span><span class="op" id="6383604">)</span><span class="op" id="6383605">.</span><span class="op" id="6383606">(</span><span class="ident" id="6383607">color</span><span class="op" id="6383612">.</span><span class="ident" id="6383613">Palette</span><span class="op" id="6383620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6383623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383626">if</span>&nbsp;<span class="ident" id="6383629">pal</span>&nbsp;<span class="op" id="6383633">!=</span>&nbsp;<span class="ident" id="6383636">nil</span>&nbsp;<span class="op" id="6383640">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383644">e</span><span class="op" id="6383645">.</span><span class="ident" id="6383646">cb</span>&nbsp;<span class="op" id="6383649">=</span>&nbsp;<span class="ident" id="6383651">cbP8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6383657">}</span>&nbsp;<span class="keyword" id="6383659">else</span>&nbsp;<span class="op" id="6383664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383668">switch</span>&nbsp;<span class="ident" id="6383675">m</span><span class="op" id="6383676">.</span><span class="ident" id="6383677">ColorModel</span><span class="op" id="6383687">(</span><span class="op" id="6383688">)</span>&nbsp;<span class="op" id="6383690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383694">case</span>&nbsp;<span class="ident" id="6383699">color</span><span class="op" id="6383704">.</span><span class="ident" id="6383705">GrayModel</span><span class="op" id="6383714">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383719">e</span><span class="op" id="6383720">.</span><span class="ident" id="6383721">cb</span>&nbsp;<span class="op" id="6383724">=</span>&nbsp;<span class="ident" id="6383726">cbG8</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383733">case</span>&nbsp;<span class="ident" id="6383738">color</span><span class="op" id="6383743">.</span><span class="ident" id="6383744">Gray16Model</span><span class="op" id="6383755">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383760">e</span><span class="op" id="6383761">.</span><span class="ident" id="6383762">cb</span>&nbsp;<span class="op" id="6383765">=</span>&nbsp;<span class="ident" id="6383767">cbG16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383775">case</span>&nbsp;<span class="ident" id="6383780">color</span><span class="op" id="6383785">.</span><span class="ident" id="6383786">RGBAModel</span><span class="op" id="6383795">,</span>&nbsp;<span class="ident" id="6383797">color</span><span class="op" id="6383802">.</span><span class="ident" id="6383803">NRGBAModel</span><span class="op" id="6383813">,</span>&nbsp;<span class="ident" id="6383815">color</span><span class="op" id="6383820">.</span><span class="ident" id="6383821">AlphaModel</span><span class="op" id="6383831">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383836">if</span>&nbsp;<span class="ident" id="6383839">opaque</span><span class="op" id="6383845">(</span><span class="ident" id="6383846">m</span><span class="op" id="6383847">)</span>&nbsp;<span class="op" id="6383849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383855">e</span><span class="op" id="6383856">.</span><span class="ident" id="6383857">cb</span>&nbsp;<span class="op" id="6383860">=</span>&nbsp;<span class="ident" id="6383862">cbTC8</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6383871">}</span>&nbsp;<span class="keyword" id="6383873">else</span>&nbsp;<span class="op" id="6383878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383884">e</span><span class="op" id="6383885">.</span><span class="ident" id="6383886">cb</span>&nbsp;<span class="op" id="6383889">=</span>&nbsp;<span class="ident" id="6383891">cbTCA8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6383901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383905">default</span><span class="op" id="6383912">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6383917">if</span>&nbsp;<span class="ident" id="6383920">opaque</span><span class="op" id="6383926">(</span><span class="ident" id="6383927">m</span><span class="op" id="6383928">)</span>&nbsp;<span class="op" id="6383930">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383936">e</span><span class="op" id="6383937">.</span><span class="ident" id="6383938">cb</span>&nbsp;<span class="op" id="6383941">=</span>&nbsp;<span class="ident" id="6383943">cbTC16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6383953">}</span>&nbsp;<span class="keyword" id="6383955">else</span>&nbsp;<span class="op" id="6383960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383966">e</span><span class="op" id="6383967">.</span><span class="ident" id="6383968">cb</span>&nbsp;<span class="op" id="6383971">=</span>&nbsp;<span class="ident" id="6383973">cbTCA16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6383984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6383988">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6383991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6383995">_</span><span class="op" id="6383996">,</span>&nbsp;<span class="ident" id="6383998">e</span><span class="op" id="6383999">.</span><span class="ident" id="6384000">err</span>&nbsp;<span class="op" id="6384004">=</span>&nbsp;<span class="ident" id="6384006">io</span><span class="op" id="6384008">.</span><span class="ident" id="6384009">WriteString</span><span class="op" id="6384020">(</span><span class="ident" id="6384021">w</span><span class="op" id="6384022">,</span>&nbsp;<span class="ident" id="6384024">pngHeader</span><span class="op" id="6384033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6384036">e</span><span class="op" id="6384037">.</span><span class="ident" id="6384038">writeIHDR</span><span class="op" id="6384047">(</span><span class="op" id="6384048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6384051">if</span>&nbsp;<span class="ident" id="6384054">pal</span>&nbsp;<span class="op" id="6384058">!=</span>&nbsp;<span class="ident" id="6384061">nil</span>&nbsp;<span class="op" id="6384065">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6384069">e</span><span class="op" id="6384070">.</span><span class="ident" id="6384071">writePLTEAndTRNS</span><span class="op" id="6384087">(</span><span class="ident" id="6384088">pal</span><span class="op" id="6384091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6384094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6384097">e</span><span class="op" id="6384098">.</span><span class="ident" id="6384099">writeIDATs</span><span class="op" id="6384109">(</span><span class="op" id="6384110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6384113">e</span><span class="op" id="6384114">.</span><span class="ident" id="6384115">writeIEND</span><span class="op" id="6384124">(</span><span class="op" id="6384125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6384128">return</span>&nbsp;<span class="ident" id="6384135">e</span><span class="op" id="6384136">.</span><span class="ident" id="6384137">err</span><br>
<span class="lineno">530</span><span class="op" id="6384141">}</span>
</div>
</body>
</html>
