<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/bzip2</h2>
<ul>
<li><a href="/gostd/compress/bzip2/bit_reader.go.html">bit_reader.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2.go.html">bzip2.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2_test.go.html">bzip2_test.go</a></li>
<li><a href="/gostd/compress/bzip2/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/compress/bzip2/move_to_front.go.html">move_to_front.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4902885">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4902940">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4902994">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4903045">//&nbsp;Package&nbsp;bzip2&nbsp;implements&nbsp;bzip2&nbsp;decompression.</span><br>
<span class="lineno"></span><span class="keyword" id="4903094">package</span>&nbsp;<span class="ident" id="4903102">bzip2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4903109">import</span>&nbsp;<span class="string" id="4903116">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="4903122">//&nbsp;There&#39;s&nbsp;no&nbsp;RFC&nbsp;for&nbsp;bzip2.&nbsp;I&nbsp;used&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for&nbsp;reference&nbsp;and&nbsp;a&nbsp;lot</span><br>
<span class="lineno"></span><span class="comment" id="4903201">//&nbsp;of&nbsp;guessing:&nbsp;http://en.wikipedia.org/wiki/Bzip2</span><br>
<span class="lineno"></span><span class="comment" id="4903252">//&nbsp;The&nbsp;source&nbsp;code&nbsp;to&nbsp;pyflate&nbsp;was&nbsp;useful&nbsp;for&nbsp;debugging:</span><br>
<span class="lineno"></span><span class="comment" id="4903308">//&nbsp;http://www.paul.sladen.org/projects/pyflate</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="4903356">//&nbsp;A&nbsp;StructuralError&nbsp;is&nbsp;returned&nbsp;when&nbsp;the&nbsp;bzip2&nbsp;data&nbsp;is&nbsp;found&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4903424">//&nbsp;syntactically&nbsp;invalid.</span><br>
<span class="lineno"></span><span class="keyword" id="4903450">type</span>&nbsp;<span class="ident" id="4903455">StructuralError</span>&nbsp;<span class="builtintype" id="4903471">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4903479">func</span>&nbsp;<span class="op" id="4903484">(</span><span class="ident" id="4903485">s</span>&nbsp;<span class="ident" id="4903487">StructuralError</span><span class="op" id="4903502">)</span>&nbsp;<span class="ident" id="4903504">Error</span><span class="op" id="4903509">(</span><span class="op" id="4903510">)</span>&nbsp;<span class="builtintype" id="4903512">string</span>&nbsp;<span class="op" id="4903519">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4903522">return</span>&nbsp;<span class="string" id="4903529">&#34;bzip2&nbsp;data&nbsp;invalid:&nbsp;&#34;</span>&nbsp;<span class="op" id="4903552">+</span>&nbsp;<span class="builtintype" id="4903554">string</span><span class="op" id="4903560">(</span><span class="ident" id="4903561">s</span><span class="op" id="4903562">)</span><br>
<span class="lineno"></span><span class="op" id="4903564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4903567">//&nbsp;A&nbsp;reader&nbsp;decompresses&nbsp;bzip2&nbsp;compressed&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="4903615">type</span>&nbsp;<span class="ident" id="4903620">reader</span>&nbsp;<span class="keyword" id="4903627">struct</span>&nbsp;<span class="op" id="4903634">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903637">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4903650">bitReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903661">fileCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4903674">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903682">blockCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4903695">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903703">wantBlockCRC</span>&nbsp;<span class="builtintype" id="4903716">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903724">setupDone</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4903737">bool</span>&nbsp;<span class="comment" id="4903742">//&nbsp;true&nbsp;if&nbsp;we&nbsp;have&nbsp;parsed&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903787">blockSize</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4903800">int</span>&nbsp;&nbsp;<span class="comment" id="4903805">//&nbsp;blockSize&nbsp;in&nbsp;bytes,&nbsp;i.e.&nbsp;900&nbsp;*&nbsp;1024.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903846">eof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4903859">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903865">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4903878">[</span><span class="op" id="4903879">]</span><span class="builtintype" id="4903880">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4903888">//&nbsp;stores&nbsp;Burrows-Wheeler&nbsp;transformed&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903933">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4903946">[</span><span class="num" id="4903947">256</span><span class="op" id="4903950">]</span><span class="builtintype" id="4903951">uint</span>&nbsp;<span class="comment" id="4903956">//&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;for&nbsp;the&nbsp;inverse&nbsp;BWT.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4903995">tt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4904008">[</span><span class="op" id="4904009">]</span><span class="builtintype" id="4904010">uint32</span>&nbsp;&nbsp;<span class="comment" id="4904018">//&nbsp;mirrors&nbsp;the&nbsp;`tt&#39;&nbsp;array&nbsp;in&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;and&nbsp;contains&nbsp;the&nbsp;P&nbsp;array&nbsp;in&nbsp;the&nbsp;upper&nbsp;24&nbsp;bits.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904112">tPos</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4904125">uint32</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4904135">//&nbsp;Index&nbsp;of&nbsp;the&nbsp;next&nbsp;output&nbsp;byte&nbsp;in&nbsp;tt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904177">preRLE</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4904189">[</span><span class="op" id="4904190">]</span><span class="builtintype" id="4904191">uint32</span>&nbsp;<span class="comment" id="4904198">//&nbsp;contains&nbsp;the&nbsp;RLE&nbsp;data&nbsp;still&nbsp;to&nbsp;be&nbsp;processed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904247">preRLEUsed</span>&nbsp;&nbsp;<span class="builtintype" id="4904259">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4904268">//&nbsp;number&nbsp;of&nbsp;entries&nbsp;of&nbsp;preRLE&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904306">lastByte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4904318">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4904327">//&nbsp;the&nbsp;last&nbsp;byte&nbsp;value&nbsp;seen.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904357">byteRepeats</span>&nbsp;<span class="builtintype" id="4904369">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4904378">//&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;lastByte&nbsp;seen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904422">repeats</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4904434">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4904443">//&nbsp;the&nbsp;number&nbsp;of&nbsp;copies&nbsp;of&nbsp;lastByte&nbsp;to&nbsp;output.</span><br>
<span class="lineno"></span><span class="op" id="4904490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4904493">//&nbsp;NewReader&nbsp;returns&nbsp;an&nbsp;io.Reader&nbsp;which&nbsp;decompresses&nbsp;bzip2&nbsp;data&nbsp;from&nbsp;r.</span><br>
<span class="lineno">45</span><span class="comment" id="4904565">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,</span><br>
<span class="lineno"></span><span class="comment" id="4904612">//&nbsp;the&nbsp;decompressor&nbsp;may&nbsp;read&nbsp;more&nbsp;data&nbsp;than&nbsp;necessary&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="4904674">func</span>&nbsp;<span class="ident" id="4904679">NewReader</span><span class="op" id="4904688">(</span><span class="ident" id="4904689">r</span>&nbsp;<span class="ident" id="4904691">io</span><span class="op" id="4904693">.</span><span class="ident" id="4904694">Reader</span><span class="op" id="4904700">)</span>&nbsp;<span class="ident" id="4904702">io</span><span class="op" id="4904704">.</span><span class="ident" id="4904705">Reader</span>&nbsp;<span class="op" id="4904712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904715">bz2</span>&nbsp;<span class="op" id="4904719">:=</span>&nbsp;<span class="builtinfunc" id="4904722">new</span><span class="op" id="4904725">(</span><span class="ident" id="4904726">reader</span><span class="op" id="4904732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904735">bz2</span><span class="op" id="4904738">.</span><span class="ident" id="4904739">br</span>&nbsp;<span class="op" id="4904742">=</span>&nbsp;<span class="ident" id="4904744">newBitReader</span><span class="op" id="4904756">(</span><span class="ident" id="4904757">r</span><span class="op" id="4904758">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904761">return</span>&nbsp;<span class="ident" id="4904768">bz2</span><br>
<span class="lineno"></span><span class="op" id="4904772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4904775">const</span>&nbsp;<span class="ident" id="4904781">bzip2FileMagic</span>&nbsp;<span class="op" id="4904796">=</span>&nbsp;<span class="num" id="4904798">0x425a</span>&nbsp;<span class="comment" id="4904805">//&nbsp;&#34;BZ&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="4904813">const</span>&nbsp;<span class="ident" id="4904819">bzip2BlockMagic</span>&nbsp;<span class="op" id="4904835">=</span>&nbsp;<span class="num" id="4904837">0x314159265359</span><br>
<span class="lineno">55</span><span class="keyword" id="4904852">const</span>&nbsp;<span class="ident" id="4904858">bzip2FinalMagic</span>&nbsp;<span class="op" id="4904874">=</span>&nbsp;<span class="num" id="4904876">0x177245385090</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4904892">//&nbsp;setup&nbsp;parses&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="4904926">func</span>&nbsp;<span class="op" id="4904931">(</span><span class="ident" id="4904932">bz2</span>&nbsp;<span class="op" id="4904936">*</span><span class="ident" id="4904937">reader</span><span class="op" id="4904943">)</span>&nbsp;<span class="ident" id="4904945">setup</span><span class="op" id="4904950">(</span><span class="ident" id="4904951">needMagic</span>&nbsp;<span class="builtintype" id="4904961">bool</span><span class="op" id="4904965">)</span>&nbsp;<span class="builtintype" id="4904967">error</span>&nbsp;<span class="op" id="4904973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4904976">br</span>&nbsp;<span class="op" id="4904979">:=</span>&nbsp;<span class="op" id="4904982">&amp;</span><span class="ident" id="4904983">bz2</span><span class="op" id="4904986">.</span><span class="ident" id="4904987">br</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4904992">if</span>&nbsp;<span class="ident" id="4904995">needMagic</span>&nbsp;<span class="op" id="4905005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905009">magic</span>&nbsp;<span class="op" id="4905015">:=</span>&nbsp;<span class="ident" id="4905018">br</span><span class="op" id="4905020">.</span><span class="ident" id="4905021">ReadBits</span><span class="op" id="4905029">(</span><span class="num" id="4905030">16</span><span class="op" id="4905032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905036">if</span>&nbsp;<span class="ident" id="4905039">magic</span>&nbsp;<span class="op" id="4905045">!=</span>&nbsp;<span class="ident" id="4905048">bzip2FileMagic</span>&nbsp;<span class="op" id="4905063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905068">return</span>&nbsp;<span class="ident" id="4905075">StructuralError</span><span class="op" id="4905090">(</span><span class="string" id="4905091">&#34;bad&nbsp;magic&nbsp;value&#34;</span><span class="op" id="4905108">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4905112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4905115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905119">t</span>&nbsp;<span class="op" id="4905121">:=</span>&nbsp;<span class="ident" id="4905124">br</span><span class="op" id="4905126">.</span><span class="ident" id="4905127">ReadBits</span><span class="op" id="4905135">(</span><span class="num" id="4905136">8</span><span class="op" id="4905137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905140">if</span>&nbsp;<span class="ident" id="4905143">t</span>&nbsp;<span class="op" id="4905145">!=</span>&nbsp;<span class="string" id="4905148">&#39;h&#39;</span>&nbsp;<span class="op" id="4905152">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905156">return</span>&nbsp;<span class="ident" id="4905163">StructuralError</span><span class="op" id="4905178">(</span><span class="string" id="4905179">&#34;non-Huffman&nbsp;entropy&nbsp;encoding&#34;</span><span class="op" id="4905209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4905212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905216">level</span>&nbsp;<span class="op" id="4905222">:=</span>&nbsp;<span class="ident" id="4905225">br</span><span class="op" id="4905227">.</span><span class="ident" id="4905228">ReadBits</span><span class="op" id="4905236">(</span><span class="num" id="4905237">8</span><span class="op" id="4905238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905241">if</span>&nbsp;<span class="ident" id="4905244">level</span>&nbsp;<span class="op" id="4905250">&lt;</span>&nbsp;<span class="string" id="4905252">&#39;1&#39;</span>&nbsp;<span class="op" id="4905256">||</span>&nbsp;<span class="ident" id="4905259">level</span>&nbsp;<span class="op" id="4905265">&gt;</span>&nbsp;<span class="string" id="4905267">&#39;9&#39;</span>&nbsp;<span class="op" id="4905271">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905275">return</span>&nbsp;<span class="ident" id="4905282">StructuralError</span><span class="op" id="4905297">(</span><span class="string" id="4905298">&#34;invalid&nbsp;compression&nbsp;level&#34;</span><span class="op" id="4905325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4905328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905332">bz2</span><span class="op" id="4905335">.</span><span class="ident" id="4905336">fileCRC</span>&nbsp;<span class="op" id="4905344">=</span>&nbsp;<span class="num" id="4905346">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905349">bz2</span><span class="op" id="4905352">.</span><span class="ident" id="4905353">blockSize</span>&nbsp;<span class="op" id="4905363">=</span>&nbsp;<span class="num" id="4905365">100</span>&nbsp;<span class="op" id="4905369">*</span>&nbsp;<span class="num" id="4905371">1024</span>&nbsp;<span class="op" id="4905376">*</span>&nbsp;<span class="op" id="4905378">(</span><span class="builtintype" id="4905379">int</span><span class="op" id="4905382">(</span><span class="ident" id="4905383">level</span><span class="op" id="4905388">)</span>&nbsp;<span class="op" id="4905390">-</span>&nbsp;<span class="string" id="4905392">&#39;0&#39;</span><span class="op" id="4905395">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905398">if</span>&nbsp;<span class="ident" id="4905401">bz2</span><span class="op" id="4905404">.</span><span class="ident" id="4905405">blockSize</span>&nbsp;<span class="op" id="4905415">&gt;</span>&nbsp;<span class="builtinfunc" id="4905417">len</span><span class="op" id="4905420">(</span><span class="ident" id="4905421">bz2</span><span class="op" id="4905424">.</span><span class="ident" id="4905425">tt</span><span class="op" id="4905427">)</span>&nbsp;<span class="op" id="4905429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905433">bz2</span><span class="op" id="4905436">.</span><span class="ident" id="4905437">tt</span>&nbsp;<span class="op" id="4905440">=</span>&nbsp;<span class="builtinfunc" id="4905442">make</span><span class="op" id="4905446">(</span><span class="op" id="4905447">[</span><span class="op" id="4905448">]</span><span class="builtintype" id="4905449">uint32</span><span class="op" id="4905455">,</span>&nbsp;<span class="ident" id="4905457">bz2</span><span class="op" id="4905460">.</span><span class="ident" id="4905461">blockSize</span><span class="op" id="4905470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4905473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905476">return</span>&nbsp;<span class="ident" id="4905483">nil</span><br>
<span class="lineno"></span><span class="op" id="4905487">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="4905490">func</span>&nbsp;<span class="op" id="4905495">(</span><span class="ident" id="4905496">bz2</span>&nbsp;<span class="op" id="4905500">*</span><span class="ident" id="4905501">reader</span><span class="op" id="4905507">)</span>&nbsp;<span class="ident" id="4905509">Read</span><span class="op" id="4905513">(</span><span class="ident" id="4905514">buf</span>&nbsp;<span class="op" id="4905518">[</span><span class="op" id="4905519">]</span><span class="builtintype" id="4905520">byte</span><span class="op" id="4905524">)</span>&nbsp;<span class="op" id="4905526">(</span><span class="ident" id="4905527">n</span>&nbsp;<span class="builtintype" id="4905529">int</span><span class="op" id="4905532">,</span>&nbsp;<span class="ident" id="4905534">err</span>&nbsp;<span class="builtintype" id="4905538">error</span><span class="op" id="4905543">)</span>&nbsp;<span class="op" id="4905545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905548">if</span>&nbsp;<span class="ident" id="4905551">bz2</span><span class="op" id="4905554">.</span><span class="ident" id="4905555">eof</span>&nbsp;<span class="op" id="4905559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905563">return</span>&nbsp;<span class="num" id="4905570">0</span><span class="op" id="4905571">,</span>&nbsp;<span class="ident" id="4905573">io</span><span class="op" id="4905575">.</span><span class="ident" id="4905576">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4905581">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905585">if</span>&nbsp;<span class="op" id="4905588">!</span><span class="ident" id="4905589">bz2</span><span class="op" id="4905592">.</span><span class="ident" id="4905593">setupDone</span>&nbsp;<span class="op" id="4905603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905607">err</span>&nbsp;<span class="op" id="4905611">=</span>&nbsp;<span class="ident" id="4905613">bz2</span><span class="op" id="4905616">.</span><span class="ident" id="4905617">setup</span><span class="op" id="4905622">(</span><span class="builtintype" id="4905623">true</span><span class="op" id="4905627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905631">brErr</span>&nbsp;<span class="op" id="4905637">:=</span>&nbsp;<span class="ident" id="4905640">bz2</span><span class="op" id="4905643">.</span><span class="ident" id="4905644">br</span><span class="op" id="4905646">.</span><span class="ident" id="4905647">Err</span><span class="op" id="4905650">(</span><span class="op" id="4905651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905655">if</span>&nbsp;<span class="ident" id="4905658">brErr</span>&nbsp;<span class="op" id="4905664">!=</span>&nbsp;<span class="ident" id="4905667">nil</span>&nbsp;<span class="op" id="4905671">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905676">err</span>&nbsp;<span class="op" id="4905680">=</span>&nbsp;<span class="ident" id="4905682">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4905690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905694">if</span>&nbsp;<span class="ident" id="4905697">err</span>&nbsp;<span class="op" id="4905701">!=</span>&nbsp;<span class="ident" id="4905704">nil</span>&nbsp;<span class="op" id="4905708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905713">return</span>&nbsp;<span class="num" id="4905720">0</span><span class="op" id="4905721">,</span>&nbsp;<span class="ident" id="4905723">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4905729">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905733">bz2</span><span class="op" id="4905736">.</span><span class="ident" id="4905737">setupDone</span>&nbsp;<span class="op" id="4905747">=</span>&nbsp;<span class="builtintype" id="4905749">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4905755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905759">n</span><span class="op" id="4905760">,</span>&nbsp;<span class="ident" id="4905762">err</span>&nbsp;<span class="op" id="4905766">=</span>&nbsp;<span class="ident" id="4905768">bz2</span><span class="op" id="4905771">.</span><span class="ident" id="4905772">read</span><span class="op" id="4905776">(</span><span class="ident" id="4905777">buf</span><span class="op" id="4905780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905783">brErr</span>&nbsp;<span class="op" id="4905789">:=</span>&nbsp;<span class="ident" id="4905792">bz2</span><span class="op" id="4905795">.</span><span class="ident" id="4905796">br</span><span class="op" id="4905798">.</span><span class="ident" id="4905799">Err</span><span class="op" id="4905802">(</span><span class="op" id="4905803">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905806">if</span>&nbsp;<span class="ident" id="4905809">brErr</span>&nbsp;<span class="op" id="4905815">!=</span>&nbsp;<span class="ident" id="4905818">nil</span>&nbsp;<span class="op" id="4905822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4905826">err</span>&nbsp;<span class="op" id="4905830">=</span>&nbsp;<span class="ident" id="4905832">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4905839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4905842">return</span><br>
<span class="lineno"></span><span class="op" id="4905849">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="4905852">func</span>&nbsp;<span class="op" id="4905857">(</span><span class="ident" id="4905858">bz2</span>&nbsp;<span class="op" id="4905862">*</span><span class="ident" id="4905863">reader</span><span class="op" id="4905869">)</span>&nbsp;<span class="ident" id="4905871">readFromBlock</span><span class="op" id="4905884">(</span><span class="ident" id="4905885">buf</span>&nbsp;<span class="op" id="4905889">[</span><span class="op" id="4905890">]</span><span class="builtintype" id="4905891">byte</span><span class="op" id="4905895">)</span>&nbsp;<span class="builtintype" id="4905897">int</span>&nbsp;<span class="op" id="4905901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905904">//&nbsp;bzip2&nbsp;is&nbsp;a&nbsp;block&nbsp;based&nbsp;compressor,&nbsp;except&nbsp;that&nbsp;it&nbsp;has&nbsp;a&nbsp;run-length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4905975">//&nbsp;preprocessing&nbsp;step.&nbsp;The&nbsp;block&nbsp;based&nbsp;nature&nbsp;means&nbsp;that&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906040">//&nbsp;preallocate&nbsp;fixed-size&nbsp;buffers&nbsp;and&nbsp;reuse&nbsp;them.&nbsp;However,&nbsp;the&nbsp;RLE</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906108">//&nbsp;preprocessing&nbsp;would&nbsp;require&nbsp;allocating&nbsp;huge&nbsp;buffers&nbsp;to&nbsp;store&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906177">//&nbsp;maximum&nbsp;expansion.&nbsp;Thus&nbsp;we&nbsp;process&nbsp;blocks&nbsp;all&nbsp;at&nbsp;once,&nbsp;except&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906247">//&nbsp;the&nbsp;RLE&nbsp;which&nbsp;we&nbsp;decompress&nbsp;as&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906292">n</span>&nbsp;<span class="op" id="4906294">:=</span>&nbsp;<span class="num" id="4906297">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906300">for</span>&nbsp;<span class="op" id="4906304">(</span><span class="ident" id="4906305">bz2</span><span class="op" id="4906308">.</span><span class="ident" id="4906309">repeats</span>&nbsp;<span class="op" id="4906317">&gt;</span>&nbsp;<span class="num" id="4906319">0</span>&nbsp;<span class="op" id="4906321">||</span>&nbsp;<span class="ident" id="4906324">bz2</span><span class="op" id="4906327">.</span><span class="ident" id="4906328">preRLEUsed</span>&nbsp;<span class="op" id="4906339">&lt;</span>&nbsp;<span class="builtinfunc" id="4906341">len</span><span class="op" id="4906344">(</span><span class="ident" id="4906345">bz2</span><span class="op" id="4906348">.</span><span class="ident" id="4906349">preRLE</span><span class="op" id="4906355">)</span><span class="op" id="4906356">)</span>&nbsp;<span class="op" id="4906358">&amp;&amp;</span>&nbsp;<span class="ident" id="4906361">n</span>&nbsp;<span class="op" id="4906363">&lt;</span>&nbsp;<span class="builtinfunc" id="4906365">len</span><span class="op" id="4906368">(</span><span class="ident" id="4906369">buf</span><span class="op" id="4906372">)</span>&nbsp;<span class="op" id="4906374">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906378">//&nbsp;We&nbsp;have&nbsp;RLE&nbsp;data&nbsp;pending.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906410">//&nbsp;The&nbsp;run-length&nbsp;encoding&nbsp;works&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906456">//&nbsp;Any&nbsp;sequence&nbsp;of&nbsp;four&nbsp;equal&nbsp;bytes&nbsp;is&nbsp;followed&nbsp;by&nbsp;a&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906518">//&nbsp;byte&nbsp;which&nbsp;contains&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;that&nbsp;byte&nbsp;to</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906581">//&nbsp;include.&nbsp;(The&nbsp;number&nbsp;of&nbsp;repeats&nbsp;can&nbsp;be&nbsp;zero.)&nbsp;Because&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906647">//&nbsp;decompressing&nbsp;on-demand&nbsp;our&nbsp;state&nbsp;is&nbsp;kept&nbsp;in&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4906708">//&nbsp;object.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906722">if</span>&nbsp;<span class="ident" id="4906725">bz2</span><span class="op" id="4906728">.</span><span class="ident" id="4906729">repeats</span>&nbsp;<span class="op" id="4906737">&gt;</span>&nbsp;<span class="num" id="4906739">0</span>&nbsp;<span class="op" id="4906741">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906746">buf</span><span class="op" id="4906749">[</span><span class="ident" id="4906750">n</span><span class="op" id="4906751">]</span>&nbsp;<span class="op" id="4906753">=</span>&nbsp;<span class="builtintype" id="4906755">byte</span><span class="op" id="4906759">(</span><span class="ident" id="4906760">bz2</span><span class="op" id="4906763">.</span><span class="ident" id="4906764">lastByte</span><span class="op" id="4906772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906777">n</span><span class="op" id="4906778">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906784">bz2</span><span class="op" id="4906787">.</span><span class="ident" id="4906788">repeats</span><span class="op" id="4906795">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906801">if</span>&nbsp;<span class="ident" id="4906804">bz2</span><span class="op" id="4906807">.</span><span class="ident" id="4906808">repeats</span>&nbsp;<span class="op" id="4906816">==</span>&nbsp;<span class="num" id="4906819">0</span>&nbsp;<span class="op" id="4906821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906827">bz2</span><span class="op" id="4906830">.</span><span class="ident" id="4906831">lastByte</span>&nbsp;<span class="op" id="4906840">=</span>&nbsp;<span class="op" id="4906842">-</span><span class="num" id="4906843">1</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906853">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4906864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906869">bz2</span><span class="op" id="4906872">.</span><span class="ident" id="4906873">tPos</span>&nbsp;<span class="op" id="4906878">=</span>&nbsp;<span class="ident" id="4906880">bz2</span><span class="op" id="4906883">.</span><span class="ident" id="4906884">preRLE</span><span class="op" id="4906890">[</span><span class="ident" id="4906891">bz2</span><span class="op" id="4906894">.</span><span class="ident" id="4906895">tPos</span><span class="op" id="4906899">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906903">b</span>&nbsp;<span class="op" id="4906905">:=</span>&nbsp;<span class="builtintype" id="4906908">byte</span><span class="op" id="4906912">(</span><span class="ident" id="4906913">bz2</span><span class="op" id="4906916">.</span><span class="ident" id="4906917">tPos</span><span class="op" id="4906921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906925">bz2</span><span class="op" id="4906928">.</span><span class="ident" id="4906929">tPos</span>&nbsp;<span class="op" id="4906934">&gt;&gt;=</span>&nbsp;<span class="num" id="4906938">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906942">bz2</span><span class="op" id="4906945">.</span><span class="ident" id="4906946">preRLEUsed</span><span class="op" id="4906956">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4906962">if</span>&nbsp;<span class="ident" id="4906965">bz2</span><span class="op" id="4906968">.</span><span class="ident" id="4906969">byteRepeats</span>&nbsp;<span class="op" id="4906981">==</span>&nbsp;<span class="num" id="4906984">3</span>&nbsp;<span class="op" id="4906986">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4906991">bz2</span><span class="op" id="4906994">.</span><span class="ident" id="4906995">repeats</span>&nbsp;<span class="op" id="4907003">=</span>&nbsp;<span class="builtintype" id="4907005">uint</span><span class="op" id="4907009">(</span><span class="ident" id="4907010">b</span><span class="op" id="4907011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907016">bz2</span><span class="op" id="4907019">.</span><span class="ident" id="4907020">byteRepeats</span>&nbsp;<span class="op" id="4907032">=</span>&nbsp;<span class="num" id="4907034">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907039">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4907050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907055">if</span>&nbsp;<span class="ident" id="4907058">bz2</span><span class="op" id="4907061">.</span><span class="ident" id="4907062">lastByte</span>&nbsp;<span class="op" id="4907071">==</span>&nbsp;<span class="builtintype" id="4907074">int</span><span class="op" id="4907077">(</span><span class="ident" id="4907078">b</span><span class="op" id="4907079">)</span>&nbsp;<span class="op" id="4907081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907086">bz2</span><span class="op" id="4907089">.</span><span class="ident" id="4907090">byteRepeats</span><span class="op" id="4907101">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4907106">}</span>&nbsp;<span class="keyword" id="4907108">else</span>&nbsp;<span class="op" id="4907113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907118">bz2</span><span class="op" id="4907121">.</span><span class="ident" id="4907122">byteRepeats</span>&nbsp;<span class="op" id="4907134">=</span>&nbsp;<span class="num" id="4907136">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4907140">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907144">bz2</span><span class="op" id="4907147">.</span><span class="ident" id="4907148">lastByte</span>&nbsp;<span class="op" id="4907157">=</span>&nbsp;<span class="builtintype" id="4907159">int</span><span class="op" id="4907162">(</span><span class="ident" id="4907163">b</span><span class="op" id="4907164">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907169">buf</span><span class="op" id="4907172">[</span><span class="ident" id="4907173">n</span><span class="op" id="4907174">]</span>&nbsp;<span class="op" id="4907176">=</span>&nbsp;<span class="ident" id="4907178">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907182">n</span><span class="op" id="4907183">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4907187">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907191">return</span>&nbsp;<span class="ident" id="4907198">n</span><br>
<span class="lineno"></span><span class="op" id="4907200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4907203">func</span>&nbsp;<span class="op" id="4907208">(</span><span class="ident" id="4907209">bz2</span>&nbsp;<span class="op" id="4907213">*</span><span class="ident" id="4907214">reader</span><span class="op" id="4907220">)</span>&nbsp;<span class="ident" id="4907222">read</span><span class="op" id="4907226">(</span><span class="ident" id="4907227">buf</span>&nbsp;<span class="op" id="4907231">[</span><span class="op" id="4907232">]</span><span class="builtintype" id="4907233">byte</span><span class="op" id="4907237">)</span>&nbsp;<span class="op" id="4907239">(</span><span class="builtintype" id="4907240">int</span><span class="op" id="4907243">,</span>&nbsp;<span class="builtintype" id="4907245">error</span><span class="op" id="4907250">)</span>&nbsp;<span class="op" id="4907252">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907255">for</span>&nbsp;<span class="op" id="4907259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907263">n</span>&nbsp;<span class="op" id="4907265">:=</span>&nbsp;<span class="ident" id="4907268">bz2</span><span class="op" id="4907271">.</span><span class="ident" id="4907272">readFromBlock</span><span class="op" id="4907285">(</span><span class="ident" id="4907286">buf</span><span class="op" id="4907289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907293">if</span>&nbsp;<span class="ident" id="4907296">n</span>&nbsp;<span class="op" id="4907298">&gt;</span>&nbsp;<span class="num" id="4907300">0</span>&nbsp;<span class="op" id="4907302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907307">bz2</span><span class="op" id="4907310">.</span><span class="ident" id="4907311">blockCRC</span>&nbsp;<span class="op" id="4907320">=</span>&nbsp;<span class="ident" id="4907322">updateCRC</span><span class="op" id="4907331">(</span><span class="ident" id="4907332">bz2</span><span class="op" id="4907335">.</span><span class="ident" id="4907336">blockCRC</span><span class="op" id="4907344">,</span>&nbsp;<span class="ident" id="4907346">buf</span><span class="op" id="4907349">[</span><span class="op" id="4907350">:</span><span class="ident" id="4907351">n</span><span class="op" id="4907352">]</span><span class="op" id="4907353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907358">return</span>&nbsp;<span class="ident" id="4907365">n</span><span class="op" id="4907366">,</span>&nbsp;<span class="ident" id="4907368">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4907374">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4907379">//&nbsp;End&nbsp;of&nbsp;block.&nbsp;Check&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907409">if</span>&nbsp;<span class="ident" id="4907412">bz2</span><span class="op" id="4907415">.</span><span class="ident" id="4907416">blockCRC</span>&nbsp;<span class="op" id="4907425">!=</span>&nbsp;<span class="ident" id="4907428">bz2</span><span class="op" id="4907431">.</span><span class="ident" id="4907432">wantBlockCRC</span>&nbsp;<span class="op" id="4907445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907450">bz2</span><span class="op" id="4907453">.</span><span class="ident" id="4907454">br</span><span class="op" id="4907456">.</span><span class="ident" id="4907457">err</span>&nbsp;<span class="op" id="4907461">=</span>&nbsp;<span class="ident" id="4907463">StructuralError</span><span class="op" id="4907478">(</span><span class="string" id="4907479">&#34;block&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="4907504">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907509">return</span>&nbsp;<span class="num" id="4907516">0</span><span class="op" id="4907517">,</span>&nbsp;<span class="ident" id="4907519">bz2</span><span class="op" id="4907522">.</span><span class="ident" id="4907523">br</span><span class="op" id="4907525">.</span><span class="ident" id="4907526">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4907532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4907537">//&nbsp;Find&nbsp;next&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907559">br</span>&nbsp;<span class="op" id="4907562">:=</span>&nbsp;<span class="op" id="4907565">&amp;</span><span class="ident" id="4907566">bz2</span><span class="op" id="4907569">.</span><span class="ident" id="4907570">br</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907575">switch</span>&nbsp;<span class="ident" id="4907582">br</span><span class="op" id="4907584">.</span><span class="ident" id="4907585">ReadBits64</span><span class="op" id="4907595">(</span><span class="num" id="4907596">48</span><span class="op" id="4907598">)</span>&nbsp;<span class="op" id="4907600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907604">default</span><span class="op" id="4907611">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907616">return</span>&nbsp;<span class="num" id="4907623">0</span><span class="op" id="4907624">,</span>&nbsp;<span class="ident" id="4907626">StructuralError</span><span class="op" id="4907641">(</span><span class="string" id="4907642">&#34;bad&nbsp;magic&nbsp;value&nbsp;found&#34;</span><span class="op" id="4907665">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907670">case</span>&nbsp;<span class="ident" id="4907675">bzip2BlockMagic</span><span class="op" id="4907690">:</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4907695">//&nbsp;Start&nbsp;of&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907717">err</span>&nbsp;<span class="op" id="4907721">:=</span>&nbsp;<span class="ident" id="4907724">bz2</span><span class="op" id="4907727">.</span><span class="ident" id="4907728">readBlock</span><span class="op" id="4907737">(</span><span class="op" id="4907738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907743">if</span>&nbsp;<span class="ident" id="4907746">err</span>&nbsp;<span class="op" id="4907750">!=</span>&nbsp;<span class="ident" id="4907753">nil</span>&nbsp;<span class="op" id="4907757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907763">return</span>&nbsp;<span class="num" id="4907770">0</span><span class="op" id="4907771">,</span>&nbsp;<span class="ident" id="4907773">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4907780">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907785">case</span>&nbsp;<span class="ident" id="4907790">bzip2FinalMagic</span><span class="op" id="4907805">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4907810">//&nbsp;Check&nbsp;end-of-file&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907839">wantFileCRC</span>&nbsp;<span class="op" id="4907851">:=</span>&nbsp;<span class="builtintype" id="4907854">uint32</span><span class="op" id="4907860">(</span><span class="ident" id="4907861">br</span><span class="op" id="4907863">.</span><span class="ident" id="4907864">ReadBits64</span><span class="op" id="4907874">(</span><span class="num" id="4907875">32</span><span class="op" id="4907877">)</span><span class="op" id="4907878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907883">if</span>&nbsp;<span class="ident" id="4907886">br</span><span class="op" id="4907888">.</span><span class="ident" id="4907889">err</span>&nbsp;<span class="op" id="4907893">!=</span>&nbsp;<span class="ident" id="4907896">nil</span>&nbsp;<span class="op" id="4907900">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907906">return</span>&nbsp;<span class="num" id="4907913">0</span><span class="op" id="4907914">,</span>&nbsp;<span class="ident" id="4907916">br</span><span class="op" id="4907918">.</span><span class="ident" id="4907919">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4907926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4907931">if</span>&nbsp;<span class="ident" id="4907934">bz2</span><span class="op" id="4907937">.</span><span class="ident" id="4907938">fileCRC</span>&nbsp;<span class="op" id="4907946">!=</span>&nbsp;<span class="ident" id="4907949">wantFileCRC</span>&nbsp;<span class="op" id="4907961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4907967">br</span><span class="op" id="4907969">.</span><span class="ident" id="4907970">err</span>&nbsp;<span class="op" id="4907974">=</span>&nbsp;<span class="ident" id="4907976">StructuralError</span><span class="op" id="4907991">(</span><span class="string" id="4907992">&#34;file&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="4908016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908022">return</span>&nbsp;<span class="num" id="4908029">0</span><span class="op" id="4908030">,</span>&nbsp;<span class="ident" id="4908032">br</span><span class="op" id="4908034">.</span><span class="ident" id="4908035">err</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4908048">//&nbsp;Skip&nbsp;ahead&nbsp;to&nbsp;byte&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4908083">//&nbsp;Is&nbsp;there&nbsp;a&nbsp;file&nbsp;concatenated&nbsp;to&nbsp;this&nbsp;one?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4908131">//&nbsp;It&nbsp;would&nbsp;start&nbsp;with&nbsp;BZ.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908161">if</span>&nbsp;<span class="ident" id="4908164">br</span><span class="op" id="4908166">.</span><span class="ident" id="4908167">bits</span><span class="op" id="4908171">%</span><span class="num" id="4908172">8</span>&nbsp;<span class="op" id="4908174">!=</span>&nbsp;<span class="num" id="4908177">0</span>&nbsp;<span class="op" id="4908179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908185">br</span><span class="op" id="4908187">.</span><span class="ident" id="4908188">ReadBits</span><span class="op" id="4908196">(</span><span class="ident" id="4908197">br</span><span class="op" id="4908199">.</span><span class="ident" id="4908200">bits</span>&nbsp;<span class="op" id="4908205">%</span>&nbsp;<span class="num" id="4908207">8</span><span class="op" id="4908208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908218">b</span><span class="op" id="4908219">,</span>&nbsp;<span class="ident" id="4908221">err</span>&nbsp;<span class="op" id="4908225">:=</span>&nbsp;<span class="ident" id="4908228">br</span><span class="op" id="4908230">.</span><span class="ident" id="4908231">r</span><span class="op" id="4908232">.</span><span class="ident" id="4908233">ReadByte</span><span class="op" id="4908241">(</span><span class="op" id="4908242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908247">if</span>&nbsp;<span class="ident" id="4908250">err</span>&nbsp;<span class="op" id="4908254">==</span>&nbsp;<span class="ident" id="4908257">io</span><span class="op" id="4908259">.</span><span class="ident" id="4908260">EOF</span>&nbsp;<span class="op" id="4908264">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908270">br</span><span class="op" id="4908272">.</span><span class="ident" id="4908273">err</span>&nbsp;<span class="op" id="4908277">=</span>&nbsp;<span class="ident" id="4908279">io</span><span class="op" id="4908281">.</span><span class="ident" id="4908282">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908290">bz2</span><span class="op" id="4908293">.</span><span class="ident" id="4908294">eof</span>&nbsp;<span class="op" id="4908298">=</span>&nbsp;<span class="builtintype" id="4908300">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908309">return</span>&nbsp;<span class="num" id="4908316">0</span><span class="op" id="4908317">,</span>&nbsp;<span class="ident" id="4908319">io</span><span class="op" id="4908321">.</span><span class="ident" id="4908322">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908334">if</span>&nbsp;<span class="ident" id="4908337">err</span>&nbsp;<span class="op" id="4908341">!=</span>&nbsp;<span class="ident" id="4908344">nil</span>&nbsp;<span class="op" id="4908348">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908354">br</span><span class="op" id="4908356">.</span><span class="ident" id="4908357">err</span>&nbsp;<span class="op" id="4908361">=</span>&nbsp;<span class="ident" id="4908363">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908371">return</span>&nbsp;<span class="num" id="4908378">0</span><span class="op" id="4908379">,</span>&nbsp;<span class="ident" id="4908381">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908393">z</span><span class="op" id="4908394">,</span>&nbsp;<span class="ident" id="4908396">err</span>&nbsp;<span class="op" id="4908400">:=</span>&nbsp;<span class="ident" id="4908403">br</span><span class="op" id="4908405">.</span><span class="ident" id="4908406">r</span><span class="op" id="4908407">.</span><span class="ident" id="4908408">ReadByte</span><span class="op" id="4908416">(</span><span class="op" id="4908417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908422">if</span>&nbsp;<span class="ident" id="4908425">err</span>&nbsp;<span class="op" id="4908429">!=</span>&nbsp;<span class="ident" id="4908432">nil</span>&nbsp;<span class="op" id="4908436">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908442">if</span>&nbsp;<span class="ident" id="4908445">err</span>&nbsp;<span class="op" id="4908449">==</span>&nbsp;<span class="ident" id="4908452">io</span><span class="op" id="4908454">.</span><span class="ident" id="4908455">EOF</span>&nbsp;<span class="op" id="4908459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908466">err</span>&nbsp;<span class="op" id="4908470">=</span>&nbsp;<span class="ident" id="4908472">io</span><span class="op" id="4908474">.</span><span class="ident" id="4908475">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908502">br</span><span class="op" id="4908504">.</span><span class="ident" id="4908505">err</span>&nbsp;<span class="op" id="4908509">=</span>&nbsp;<span class="ident" id="4908511">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908519">return</span>&nbsp;<span class="num" id="4908526">0</span><span class="op" id="4908527">,</span>&nbsp;<span class="ident" id="4908529">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908541">if</span>&nbsp;<span class="ident" id="4908544">b</span>&nbsp;<span class="op" id="4908546">!=</span>&nbsp;<span class="string" id="4908549">&#39;B&#39;</span>&nbsp;<span class="op" id="4908553">||</span>&nbsp;<span class="ident" id="4908556">z</span>&nbsp;<span class="op" id="4908558">!=</span>&nbsp;<span class="string" id="4908561">&#39;Z&#39;</span>&nbsp;<span class="op" id="4908565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908571">return</span>&nbsp;<span class="num" id="4908578">0</span><span class="op" id="4908579">,</span>&nbsp;<span class="ident" id="4908581">StructuralError</span><span class="op" id="4908596">(</span><span class="string" id="4908597">&#34;bad&nbsp;magic&nbsp;value&nbsp;in&nbsp;continuation&nbsp;file&#34;</span><span class="op" id="4908635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908645">if</span>&nbsp;<span class="ident" id="4908648">err</span>&nbsp;<span class="op" id="4908652">:=</span>&nbsp;<span class="ident" id="4908655">bz2</span><span class="op" id="4908658">.</span><span class="ident" id="4908659">setup</span><span class="op" id="4908664">(</span><span class="builtintype" id="4908665">false</span><span class="op" id="4908670">)</span><span class="op" id="4908671">;</span>&nbsp;<span class="ident" id="4908673">err</span>&nbsp;<span class="op" id="4908677">!=</span>&nbsp;<span class="ident" id="4908680">nil</span>&nbsp;<span class="op" id="4908684">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4908690">return</span>&nbsp;<span class="num" id="4908697">0</span><span class="op" id="4908698">,</span>&nbsp;<span class="ident" id="4908700">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4908714">}</span><br>
<span class="lineno"></span><span class="op" id="4908716">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="4908719">//&nbsp;readBlock&nbsp;reads&nbsp;a&nbsp;bzip2&nbsp;block.&nbsp;The&nbsp;magic&nbsp;number&nbsp;should&nbsp;already&nbsp;have&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span><span class="keyword" id="4908805">func</span>&nbsp;<span class="op" id="4908810">(</span><span class="ident" id="4908811">bz2</span>&nbsp;<span class="op" id="4908815">*</span><span class="ident" id="4908816">reader</span><span class="op" id="4908822">)</span>&nbsp;<span class="ident" id="4908824">readBlock</span><span class="op" id="4908833">(</span><span class="op" id="4908834">)</span>&nbsp;<span class="op" id="4908836">(</span><span class="ident" id="4908837">err</span>&nbsp;<span class="builtintype" id="4908841">error</span><span class="op" id="4908846">)</span>&nbsp;<span class="op" id="4908848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908851">br</span>&nbsp;<span class="op" id="4908854">:=</span>&nbsp;<span class="op" id="4908857">&amp;</span><span class="ident" id="4908858">bz2</span><span class="op" id="4908861">.</span><span class="ident" id="4908862">br</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908866">bz2</span><span class="op" id="4908869">.</span><span class="ident" id="4908870">wantBlockCRC</span>&nbsp;<span class="op" id="4908883">=</span>&nbsp;<span class="builtintype" id="4908885">uint32</span><span class="op" id="4908891">(</span><span class="ident" id="4908892">br</span><span class="op" id="4908894">.</span><span class="ident" id="4908895">ReadBits64</span><span class="op" id="4908905">(</span><span class="num" id="4908906">32</span><span class="op" id="4908908">)</span><span class="op" id="4908909">)</span>&nbsp;<span class="comment" id="4908911">//&nbsp;skip&nbsp;checksum.&nbsp;TODO:&nbsp;check&nbsp;it&nbsp;if&nbsp;we&nbsp;can&nbsp;figure&nbsp;out&nbsp;what&nbsp;it&nbsp;is.</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908978">bz2</span><span class="op" id="4908981">.</span><span class="ident" id="4908982">blockCRC</span>&nbsp;<span class="op" id="4908991">=</span>&nbsp;<span class="num" id="4908993">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4908996">bz2</span><span class="op" id="4908999">.</span><span class="ident" id="4909000">fileCRC</span>&nbsp;<span class="op" id="4909008">=</span>&nbsp;<span class="op" id="4909010">(</span><span class="ident" id="4909011">bz2</span><span class="op" id="4909014">.</span><span class="ident" id="4909015">fileCRC</span><span class="op" id="4909022">&lt;&lt;</span><span class="num" id="4909024">1</span>&nbsp;<span class="op" id="4909026">|</span>&nbsp;<span class="ident" id="4909028">bz2</span><span class="op" id="4909031">.</span><span class="ident" id="4909032">fileCRC</span><span class="op" id="4909039">&gt;&gt;</span><span class="num" id="4909041">31</span><span class="op" id="4909043">)</span>&nbsp;<span class="op" id="4909045">^</span>&nbsp;<span class="ident" id="4909047">bz2</span><span class="op" id="4909050">.</span><span class="ident" id="4909051">wantBlockCRC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909065">randomized</span>&nbsp;<span class="op" id="4909076">:=</span>&nbsp;<span class="ident" id="4909079">br</span><span class="op" id="4909081">.</span><span class="ident" id="4909082">ReadBits</span><span class="op" id="4909090">(</span><span class="num" id="4909091">1</span><span class="op" id="4909092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909095">if</span>&nbsp;<span class="ident" id="4909098">randomized</span>&nbsp;<span class="op" id="4909109">!=</span>&nbsp;<span class="num" id="4909112">0</span>&nbsp;<span class="op" id="4909114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909118">return</span>&nbsp;<span class="ident" id="4909125">StructuralError</span><span class="op" id="4909140">(</span><span class="string" id="4909141">&#34;deprecated&nbsp;randomized&nbsp;files&#34;</span><span class="op" id="4909170">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909176">origPtr</span>&nbsp;<span class="op" id="4909184">:=</span>&nbsp;<span class="builtintype" id="4909187">uint</span><span class="op" id="4909191">(</span><span class="ident" id="4909192">br</span><span class="op" id="4909194">.</span><span class="ident" id="4909195">ReadBits</span><span class="op" id="4909203">(</span><span class="num" id="4909204">24</span><span class="op" id="4909206">)</span><span class="op" id="4909207">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4909211">//&nbsp;If&nbsp;not&nbsp;every&nbsp;byte&nbsp;value&nbsp;is&nbsp;used&nbsp;in&nbsp;the&nbsp;block&nbsp;(i.e.,&nbsp;it&#39;s&nbsp;text)&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4909283">//&nbsp;the&nbsp;symbol&nbsp;set&nbsp;is&nbsp;reduced.&nbsp;The&nbsp;symbols&nbsp;used&nbsp;are&nbsp;stored&nbsp;as&nbsp;a</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4909347">//&nbsp;two-level,&nbsp;16x16&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909376">symbolRangeUsedBitmap</span>&nbsp;<span class="op" id="4909398">:=</span>&nbsp;<span class="ident" id="4909401">br</span><span class="op" id="4909403">.</span><span class="ident" id="4909404">ReadBits</span><span class="op" id="4909412">(</span><span class="num" id="4909413">16</span><span class="op" id="4909415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909418">symbolPresent</span>&nbsp;<span class="op" id="4909432">:=</span>&nbsp;<span class="builtinfunc" id="4909435">make</span><span class="op" id="4909439">(</span><span class="op" id="4909440">[</span><span class="op" id="4909441">]</span><span class="builtintype" id="4909442">bool</span><span class="op" id="4909446">,</span>&nbsp;<span class="num" id="4909448">256</span><span class="op" id="4909451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909454">numSymbols</span>&nbsp;<span class="op" id="4909465">:=</span>&nbsp;<span class="num" id="4909468">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909471">for</span>&nbsp;<span class="ident" id="4909475">symRange</span>&nbsp;<span class="op" id="4909484">:=</span>&nbsp;<span class="builtintype" id="4909487">uint</span><span class="op" id="4909491">(</span><span class="num" id="4909492">0</span><span class="op" id="4909493">)</span><span class="op" id="4909494">;</span>&nbsp;<span class="ident" id="4909496">symRange</span>&nbsp;<span class="op" id="4909505">&lt;</span>&nbsp;<span class="num" id="4909507">16</span><span class="op" id="4909509">;</span>&nbsp;<span class="ident" id="4909511">symRange</span><span class="op" id="4909519">++</span>&nbsp;<span class="op" id="4909522">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909526">if</span>&nbsp;<span class="ident" id="4909529">symbolRangeUsedBitmap</span><span class="op" id="4909550">&amp;</span><span class="op" id="4909551">(</span><span class="num" id="4909552">1</span><span class="op" id="4909553">&lt;&lt;</span><span class="op" id="4909555">(</span><span class="num" id="4909556">15</span><span class="op" id="4909558">-</span><span class="ident" id="4909559">symRange</span><span class="op" id="4909567">)</span><span class="op" id="4909568">)</span>&nbsp;<span class="op" id="4909570">!=</span>&nbsp;<span class="num" id="4909573">0</span>&nbsp;<span class="op" id="4909575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909580">bits</span>&nbsp;<span class="op" id="4909585">:=</span>&nbsp;<span class="ident" id="4909588">br</span><span class="op" id="4909590">.</span><span class="ident" id="4909591">ReadBits</span><span class="op" id="4909599">(</span><span class="num" id="4909600">16</span><span class="op" id="4909602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909607">for</span>&nbsp;<span class="ident" id="4909611">symbol</span>&nbsp;<span class="op" id="4909618">:=</span>&nbsp;<span class="builtintype" id="4909621">uint</span><span class="op" id="4909625">(</span><span class="num" id="4909626">0</span><span class="op" id="4909627">)</span><span class="op" id="4909628">;</span>&nbsp;<span class="ident" id="4909630">symbol</span>&nbsp;<span class="op" id="4909637">&lt;</span>&nbsp;<span class="num" id="4909639">16</span><span class="op" id="4909641">;</span>&nbsp;<span class="ident" id="4909643">symbol</span><span class="op" id="4909649">++</span>&nbsp;<span class="op" id="4909652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909658">if</span>&nbsp;<span class="ident" id="4909661">bits</span><span class="op" id="4909665">&amp;</span><span class="op" id="4909666">(</span><span class="num" id="4909667">1</span><span class="op" id="4909668">&lt;&lt;</span><span class="op" id="4909670">(</span><span class="num" id="4909671">15</span><span class="op" id="4909673">-</span><span class="ident" id="4909674">symbol</span><span class="op" id="4909680">)</span><span class="op" id="4909681">)</span>&nbsp;<span class="op" id="4909683">!=</span>&nbsp;<span class="num" id="4909686">0</span>&nbsp;<span class="op" id="4909688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909695">symbolPresent</span><span class="op" id="4909708">[</span><span class="num" id="4909709">16</span><span class="op" id="4909711">*</span><span class="ident" id="4909712">symRange</span><span class="op" id="4909720">+</span><span class="ident" id="4909721">symbol</span><span class="op" id="4909727">]</span>&nbsp;<span class="op" id="4909729">=</span>&nbsp;<span class="builtintype" id="4909731">true</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909741">numSymbols</span><span class="op" id="4909751">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909770">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909774">if</span>&nbsp;<span class="ident" id="4909777">numSymbols</span>&nbsp;<span class="op" id="4909788">==</span>&nbsp;<span class="num" id="4909791">0</span>&nbsp;<span class="op" id="4909793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4909797">//&nbsp;There&nbsp;must&nbsp;be&nbsp;an&nbsp;EOF&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909831">return</span>&nbsp;<span class="ident" id="4909838">StructuralError</span><span class="op" id="4909853">(</span><span class="string" id="4909854">&#34;no&nbsp;symbols&nbsp;in&nbsp;input&#34;</span><span class="op" id="4909875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4909878">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4909882">//&nbsp;A&nbsp;block&nbsp;uses&nbsp;between&nbsp;two&nbsp;and&nbsp;six&nbsp;different&nbsp;Huffman&nbsp;trees.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4909944">numHuffmanTrees</span>&nbsp;<span class="op" id="4909960">:=</span>&nbsp;<span class="ident" id="4909963">br</span><span class="op" id="4909965">.</span><span class="ident" id="4909966">ReadBits</span><span class="op" id="4909974">(</span><span class="num" id="4909975">3</span><span class="op" id="4909976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4909979">if</span>&nbsp;<span class="ident" id="4909982">numHuffmanTrees</span>&nbsp;<span class="op" id="4909998">&lt;</span>&nbsp;<span class="num" id="4910000">2</span>&nbsp;<span class="op" id="4910002">||</span>&nbsp;<span class="ident" id="4910005">numHuffmanTrees</span>&nbsp;<span class="op" id="4910021">&gt;</span>&nbsp;<span class="num" id="4910023">6</span>&nbsp;<span class="op" id="4910025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910029">return</span>&nbsp;<span class="ident" id="4910036">StructuralError</span><span class="op" id="4910051">(</span><span class="string" id="4910052">&#34;invalid&nbsp;number&nbsp;of&nbsp;Huffman&nbsp;trees&#34;</span><span class="op" id="4910085">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4910088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4910092">//&nbsp;The&nbsp;Huffman&nbsp;tree&nbsp;can&nbsp;switch&nbsp;every&nbsp;50&nbsp;symbols&nbsp;so&nbsp;there&#39;s&nbsp;a&nbsp;list&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4910162">//&nbsp;tree&nbsp;indexes&nbsp;telling&nbsp;us&nbsp;which&nbsp;tree&nbsp;to&nbsp;use&nbsp;for&nbsp;each&nbsp;50&nbsp;symbol&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910234">numSelectors</span>&nbsp;<span class="op" id="4910247">:=</span>&nbsp;<span class="ident" id="4910250">br</span><span class="op" id="4910252">.</span><span class="ident" id="4910253">ReadBits</span><span class="op" id="4910261">(</span><span class="num" id="4910262">15</span><span class="op" id="4910264">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910267">treeIndexes</span>&nbsp;<span class="op" id="4910279">:=</span>&nbsp;<span class="builtinfunc" id="4910282">make</span><span class="op" id="4910286">(</span><span class="op" id="4910287">[</span><span class="op" id="4910288">]</span><span class="builtintype" id="4910289">uint8</span><span class="op" id="4910294">,</span>&nbsp;<span class="ident" id="4910296">numSelectors</span><span class="op" id="4910308">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4910312">//&nbsp;The&nbsp;tree&nbsp;indexes&nbsp;are&nbsp;move-to-front&nbsp;transformed&nbsp;and&nbsp;stored&nbsp;as&nbsp;unary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4910383">//&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910396">mtfTreeDecoder</span>&nbsp;<span class="op" id="4910411">:=</span>&nbsp;<span class="ident" id="4910414">newMTFDecoderWithRange</span><span class="op" id="4910436">(</span><span class="ident" id="4910437">numHuffmanTrees</span><span class="op" id="4910452">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910455">for</span>&nbsp;<span class="ident" id="4910459">i</span>&nbsp;<span class="op" id="4910461">:=</span>&nbsp;<span class="keyword" id="4910464">range</span>&nbsp;<span class="ident" id="4910470">treeIndexes</span>&nbsp;<span class="op" id="4910482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910486">c</span>&nbsp;<span class="op" id="4910488">:=</span>&nbsp;<span class="num" id="4910491">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910495">for</span>&nbsp;<span class="op" id="4910499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910504">inc</span>&nbsp;<span class="op" id="4910508">:=</span>&nbsp;<span class="ident" id="4910511">br</span><span class="op" id="4910513">.</span><span class="ident" id="4910514">ReadBits</span><span class="op" id="4910522">(</span><span class="num" id="4910523">1</span><span class="op" id="4910524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910529">if</span>&nbsp;<span class="ident" id="4910532">inc</span>&nbsp;<span class="op" id="4910536">==</span>&nbsp;<span class="num" id="4910539">0</span>&nbsp;<span class="op" id="4910541">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910547">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4910556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910561">c</span><span class="op" id="4910562">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4910567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910571">if</span>&nbsp;<span class="ident" id="4910574">c</span>&nbsp;<span class="op" id="4910576">&gt;=</span>&nbsp;<span class="ident" id="4910579">numHuffmanTrees</span>&nbsp;<span class="op" id="4910595">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910600">return</span>&nbsp;<span class="ident" id="4910607">StructuralError</span><span class="op" id="4910622">(</span><span class="string" id="4910623">&#34;tree&nbsp;index&nbsp;too&nbsp;large&#34;</span><span class="op" id="4910645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4910649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910653">treeIndexes</span><span class="op" id="4910664">[</span><span class="ident" id="4910665">i</span><span class="op" id="4910666">]</span>&nbsp;<span class="op" id="4910668">=</span>&nbsp;<span class="builtintype" id="4910670">uint8</span><span class="op" id="4910675">(</span><span class="ident" id="4910676">mtfTreeDecoder</span><span class="op" id="4910690">.</span><span class="ident" id="4910691">Decode</span><span class="op" id="4910697">(</span><span class="ident" id="4910698">c</span><span class="op" id="4910699">)</span><span class="op" id="4910700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4910703">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4910707">//&nbsp;The&nbsp;list&nbsp;of&nbsp;symbols&nbsp;for&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;taken&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4910777">//&nbsp;the&nbsp;previously&nbsp;decoded&nbsp;symbol&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910819">symbols</span>&nbsp;<span class="op" id="4910827">:=</span>&nbsp;<span class="builtinfunc" id="4910830">make</span><span class="op" id="4910834">(</span><span class="op" id="4910835">[</span><span class="op" id="4910836">]</span><span class="builtintype" id="4910837">byte</span><span class="op" id="4910841">,</span>&nbsp;<span class="ident" id="4910843">numSymbols</span><span class="op" id="4910853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910856">nextSymbol</span>&nbsp;<span class="op" id="4910867">:=</span>&nbsp;<span class="num" id="4910870">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910873">for</span>&nbsp;<span class="ident" id="4910877">i</span>&nbsp;<span class="op" id="4910879">:=</span>&nbsp;<span class="num" id="4910882">0</span><span class="op" id="4910883">;</span>&nbsp;<span class="ident" id="4910885">i</span>&nbsp;<span class="op" id="4910887">&lt;</span>&nbsp;<span class="num" id="4910889">256</span><span class="op" id="4910892">;</span>&nbsp;<span class="ident" id="4910894">i</span><span class="op" id="4910895">++</span>&nbsp;<span class="op" id="4910898">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4910902">if</span>&nbsp;<span class="ident" id="4910905">symbolPresent</span><span class="op" id="4910918">[</span><span class="ident" id="4910919">i</span><span class="op" id="4910920">]</span>&nbsp;<span class="op" id="4910922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910927">symbols</span><span class="op" id="4910934">[</span><span class="ident" id="4910935">nextSymbol</span><span class="op" id="4910945">]</span>&nbsp;<span class="op" id="4910947">=</span>&nbsp;<span class="builtintype" id="4910949">byte</span><span class="op" id="4910953">(</span><span class="ident" id="4910954">i</span><span class="op" id="4910955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910960">nextSymbol</span><span class="op" id="4910970">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4910975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4910978">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4910981">mtf</span>&nbsp;<span class="op" id="4910985">:=</span>&nbsp;<span class="ident" id="4910988">newMTFDecoder</span><span class="op" id="4911001">(</span><span class="ident" id="4911002">symbols</span><span class="op" id="4911009">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911013">numSymbols</span>&nbsp;<span class="op" id="4911024">+=</span>&nbsp;<span class="num" id="4911027">2</span>&nbsp;<span class="comment" id="4911029">//&nbsp;to&nbsp;account&nbsp;for&nbsp;RUNA&nbsp;and&nbsp;RUNB&nbsp;symbols</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911070">huffmanTrees</span>&nbsp;<span class="op" id="4911083">:=</span>&nbsp;<span class="builtinfunc" id="4911086">make</span><span class="op" id="4911090">(</span><span class="op" id="4911091">[</span><span class="op" id="4911092">]</span><span class="ident" id="4911093">huffmanTree</span><span class="op" id="4911104">,</span>&nbsp;<span class="ident" id="4911106">numHuffmanTrees</span><span class="op" id="4911121">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4911125">//&nbsp;Now&nbsp;we&nbsp;decode&nbsp;the&nbsp;arrays&nbsp;of&nbsp;code-lengths&nbsp;for&nbsp;each&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911185">lengths</span>&nbsp;<span class="op" id="4911193">:=</span>&nbsp;<span class="builtinfunc" id="4911196">make</span><span class="op" id="4911200">(</span><span class="op" id="4911201">[</span><span class="op" id="4911202">]</span><span class="builtintype" id="4911203">uint8</span><span class="op" id="4911208">,</span>&nbsp;<span class="ident" id="4911210">numSymbols</span><span class="op" id="4911220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911223">for</span>&nbsp;<span class="ident" id="4911227">i</span>&nbsp;<span class="op" id="4911229">:=</span>&nbsp;<span class="keyword" id="4911232">range</span>&nbsp;<span class="ident" id="4911238">huffmanTrees</span>&nbsp;<span class="op" id="4911251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4911255">//&nbsp;The&nbsp;code&nbsp;lengths&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;from&nbsp;a&nbsp;5-bit&nbsp;base&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911320">length</span>&nbsp;<span class="op" id="4911327">:=</span>&nbsp;<span class="ident" id="4911330">br</span><span class="op" id="4911332">.</span><span class="ident" id="4911333">ReadBits</span><span class="op" id="4911341">(</span><span class="num" id="4911342">5</span><span class="op" id="4911343">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911347">for</span>&nbsp;<span class="ident" id="4911351">j</span>&nbsp;<span class="op" id="4911353">:=</span>&nbsp;<span class="keyword" id="4911356">range</span>&nbsp;<span class="ident" id="4911362">lengths</span>&nbsp;<span class="op" id="4911370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911375">for</span>&nbsp;<span class="op" id="4911379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911385">if</span>&nbsp;<span class="op" id="4911388">!</span><span class="ident" id="4911389">br</span><span class="op" id="4911391">.</span><span class="ident" id="4911392">ReadBit</span><span class="op" id="4911399">(</span><span class="op" id="4911400">)</span>&nbsp;<span class="op" id="4911402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911409">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911419">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911425">if</span>&nbsp;<span class="ident" id="4911428">br</span><span class="op" id="4911430">.</span><span class="ident" id="4911431">ReadBit</span><span class="op" id="4911438">(</span><span class="op" id="4911439">)</span>&nbsp;<span class="op" id="4911441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911448">length</span><span class="op" id="4911454">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911461">}</span>&nbsp;<span class="keyword" id="4911463">else</span>&nbsp;<span class="op" id="4911468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911475">length</span><span class="op" id="4911481">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911488">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911498">if</span>&nbsp;<span class="ident" id="4911501">length</span>&nbsp;<span class="op" id="4911508">&lt;</span>&nbsp;<span class="num" id="4911510">0</span>&nbsp;<span class="op" id="4911512">||</span>&nbsp;<span class="ident" id="4911515">length</span>&nbsp;<span class="op" id="4911522">&gt;</span>&nbsp;<span class="num" id="4911524">20</span>&nbsp;<span class="op" id="4911527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911533">return</span>&nbsp;<span class="ident" id="4911540">StructuralError</span><span class="op" id="4911555">(</span><span class="string" id="4911556">&#34;Huffman&nbsp;length&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="4911585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911595">lengths</span><span class="op" id="4911602">[</span><span class="ident" id="4911603">j</span><span class="op" id="4911604">]</span>&nbsp;<span class="op" id="4911606">=</span>&nbsp;<span class="builtintype" id="4911608">uint8</span><span class="op" id="4911613">(</span><span class="ident" id="4911614">length</span><span class="op" id="4911620">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911628">huffmanTrees</span><span class="op" id="4911640">[</span><span class="ident" id="4911641">i</span><span class="op" id="4911642">]</span><span class="op" id="4911643">,</span>&nbsp;<span class="ident" id="4911645">err</span>&nbsp;<span class="op" id="4911649">=</span>&nbsp;<span class="ident" id="4911651">newHuffmanTree</span><span class="op" id="4911665">(</span><span class="ident" id="4911666">lengths</span><span class="op" id="4911673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911677">if</span>&nbsp;<span class="ident" id="4911680">err</span>&nbsp;<span class="op" id="4911684">!=</span>&nbsp;<span class="ident" id="4911687">nil</span>&nbsp;<span class="op" id="4911691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911696">return</span>&nbsp;<span class="ident" id="4911703">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911709">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911716">selectorIndex</span>&nbsp;<span class="op" id="4911730">:=</span>&nbsp;<span class="num" id="4911733">1</span>&nbsp;<span class="comment" id="4911735">//&nbsp;the&nbsp;next&nbsp;tree&nbsp;index&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911766">if</span>&nbsp;<span class="builtinfunc" id="4911769">len</span><span class="op" id="4911772">(</span><span class="ident" id="4911773">treeIndexes</span><span class="op" id="4911784">)</span>&nbsp;<span class="op" id="4911786">==</span>&nbsp;<span class="num" id="4911789">0</span>&nbsp;<span class="op" id="4911791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911795">return</span>&nbsp;<span class="ident" id="4911802">StructuralError</span><span class="op" id="4911817">(</span><span class="string" id="4911818">&#34;no&nbsp;tree&nbsp;selectors&nbsp;given&#34;</span><span class="op" id="4911843">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911849">if</span>&nbsp;<span class="builtintype" id="4911852">int</span><span class="op" id="4911855">(</span><span class="ident" id="4911856">treeIndexes</span><span class="op" id="4911867">[</span><span class="num" id="4911868">0</span><span class="op" id="4911869">]</span><span class="op" id="4911870">)</span>&nbsp;<span class="op" id="4911872">&gt;=</span>&nbsp;<span class="builtinfunc" id="4911875">len</span><span class="op" id="4911878">(</span><span class="ident" id="4911879">huffmanTrees</span><span class="op" id="4911891">)</span>&nbsp;<span class="op" id="4911893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4911897">return</span>&nbsp;<span class="ident" id="4911904">StructuralError</span><span class="op" id="4911919">(</span><span class="string" id="4911920">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="4911948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4911951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4911954">currentHuffmanTree</span>&nbsp;<span class="op" id="4911973">:=</span>&nbsp;<span class="ident" id="4911976">huffmanTrees</span><span class="op" id="4911988">[</span><span class="ident" id="4911989">treeIndexes</span><span class="op" id="4912000">[</span><span class="num" id="4912001">0</span><span class="op" id="4912002">]</span><span class="op" id="4912003">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912006">bufIndex</span>&nbsp;<span class="op" id="4912015">:=</span>&nbsp;<span class="num" id="4912018">0</span>&nbsp;<span class="comment" id="4912020">//&nbsp;indexes&nbsp;bz2.buf,&nbsp;the&nbsp;output&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912060">//&nbsp;The&nbsp;output&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;run-length&nbsp;encoded&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912132">//&nbsp;we&nbsp;merge&nbsp;the&nbsp;decoding&nbsp;into&nbsp;the&nbsp;Huffman&nbsp;parsing&nbsp;loop.&nbsp;These&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912199">//&nbsp;variables&nbsp;accumulate&nbsp;the&nbsp;repeat&nbsp;count.&nbsp;See&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912269">//&nbsp;details.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912282">repeat</span>&nbsp;<span class="op" id="4912289">:=</span>&nbsp;<span class="num" id="4912292">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912295">repeat_power</span>&nbsp;<span class="op" id="4912308">:=</span>&nbsp;<span class="num" id="4912311">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912315">//&nbsp;The&nbsp;`C&#39;&nbsp;array&nbsp;(used&nbsp;by&nbsp;the&nbsp;inverse&nbsp;BWT)&nbsp;needs&nbsp;to&nbsp;be&nbsp;zero&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912389">for</span>&nbsp;<span class="ident" id="4912393">i</span>&nbsp;<span class="op" id="4912395">:=</span>&nbsp;<span class="keyword" id="4912398">range</span>&nbsp;<span class="ident" id="4912404">bz2</span><span class="op" id="4912407">.</span><span class="ident" id="4912408">c</span>&nbsp;<span class="op" id="4912410">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912414">bz2</span><span class="op" id="4912417">.</span><span class="ident" id="4912418">c</span><span class="op" id="4912419">[</span><span class="ident" id="4912420">i</span><span class="op" id="4912421">]</span>&nbsp;<span class="op" id="4912423">=</span>&nbsp;<span class="num" id="4912425">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4912428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912432">decoded</span>&nbsp;<span class="op" id="4912440">:=</span>&nbsp;<span class="num" id="4912443">0</span>&nbsp;<span class="comment" id="4912445">//&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;symbols&nbsp;decoded&nbsp;by&nbsp;the&nbsp;current&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912507">for</span>&nbsp;<span class="op" id="4912511">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912515">if</span>&nbsp;<span class="ident" id="4912518">decoded</span>&nbsp;<span class="op" id="4912526">==</span>&nbsp;<span class="num" id="4912529">50</span>&nbsp;<span class="op" id="4912532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912537">if</span>&nbsp;<span class="ident" id="4912540">selectorIndex</span>&nbsp;<span class="op" id="4912554">&gt;=</span>&nbsp;<span class="ident" id="4912557">numSelectors</span>&nbsp;<span class="op" id="4912570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912576">return</span>&nbsp;<span class="ident" id="4912583">StructuralError</span><span class="op" id="4912598">(</span><span class="string" id="4912599">&#34;insufficient&nbsp;selector&nbsp;indices&nbsp;for&nbsp;number&nbsp;of&nbsp;symbols&#34;</span><span class="op" id="4912652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4912657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912662">if</span>&nbsp;<span class="builtintype" id="4912665">int</span><span class="op" id="4912668">(</span><span class="ident" id="4912669">treeIndexes</span><span class="op" id="4912680">[</span><span class="ident" id="4912681">selectorIndex</span><span class="op" id="4912694">]</span><span class="op" id="4912695">)</span>&nbsp;<span class="op" id="4912697">&gt;=</span>&nbsp;<span class="builtinfunc" id="4912700">len</span><span class="op" id="4912703">(</span><span class="ident" id="4912704">huffmanTrees</span><span class="op" id="4912716">)</span>&nbsp;<span class="op" id="4912718">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912724">return</span>&nbsp;<span class="ident" id="4912731">StructuralError</span><span class="op" id="4912746">(</span><span class="string" id="4912747">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="4912775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4912780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912785">currentHuffmanTree</span>&nbsp;<span class="op" id="4912804">=</span>&nbsp;<span class="ident" id="4912806">huffmanTrees</span><span class="op" id="4912818">[</span><span class="ident" id="4912819">treeIndexes</span><span class="op" id="4912830">[</span><span class="ident" id="4912831">selectorIndex</span><span class="op" id="4912844">]</span><span class="op" id="4912845">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912850">selectorIndex</span><span class="op" id="4912863">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912869">decoded</span>&nbsp;<span class="op" id="4912877">=</span>&nbsp;<span class="num" id="4912879">0</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4912883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912888">v</span>&nbsp;<span class="op" id="4912890">:=</span>&nbsp;<span class="ident" id="4912893">currentHuffmanTree</span><span class="op" id="4912911">.</span><span class="ident" id="4912912">Decode</span><span class="op" id="4912918">(</span><span class="ident" id="4912919">br</span><span class="op" id="4912921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4912925">decoded</span><span class="op" id="4912932">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912938">if</span>&nbsp;<span class="ident" id="4912941">v</span>&nbsp;<span class="op" id="4912943">&lt;</span>&nbsp;<span class="num" id="4912945">2</span>&nbsp;<span class="op" id="4912947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4912952">//&nbsp;This&nbsp;is&nbsp;either&nbsp;the&nbsp;RUNA&nbsp;or&nbsp;RUNB&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4912998">if</span>&nbsp;<span class="ident" id="4913001">repeat</span>&nbsp;<span class="op" id="4913008">==</span>&nbsp;<span class="num" id="4913011">0</span>&nbsp;<span class="op" id="4913013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913019">repeat_power</span>&nbsp;<span class="op" id="4913032">=</span>&nbsp;<span class="num" id="4913034">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4913039">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913044">repeat</span>&nbsp;<span class="op" id="4913051">+=</span>&nbsp;<span class="ident" id="4913054">repeat_power</span>&nbsp;<span class="op" id="4913067">&lt;&lt;</span>&nbsp;<span class="ident" id="4913070">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913075">repeat_power</span>&nbsp;<span class="op" id="4913088">&lt;&lt;=</span>&nbsp;<span class="num" id="4913092">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913098">//&nbsp;This&nbsp;limit&nbsp;of&nbsp;2&nbsp;million&nbsp;comes&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913156">//&nbsp;code.&nbsp;It&nbsp;prevents&nbsp;repeat&nbsp;from&nbsp;overflowing.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4913205">if</span>&nbsp;<span class="ident" id="4913208">repeat</span>&nbsp;<span class="op" id="4913215">&gt;</span>&nbsp;<span class="num" id="4913217">2</span><span class="op" id="4913218">*</span><span class="num" id="4913219">1024</span><span class="op" id="4913223">*</span><span class="num" id="4913224">1024</span>&nbsp;<span class="op" id="4913229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4913235">return</span>&nbsp;<span class="ident" id="4913242">StructuralError</span><span class="op" id="4913257">(</span><span class="string" id="4913258">&#34;repeat&nbsp;count&nbsp;too&nbsp;large&#34;</span><span class="op" id="4913282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4913287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4913292">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4913303">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4913308">if</span>&nbsp;<span class="ident" id="4913311">repeat</span>&nbsp;<span class="op" id="4913318">&gt;</span>&nbsp;<span class="num" id="4913320">0</span>&nbsp;<span class="op" id="4913322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913327">//&nbsp;We&nbsp;have&nbsp;decoded&nbsp;a&nbsp;complete&nbsp;run-length&nbsp;so&nbsp;we&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913385">//&nbsp;replicate&nbsp;the&nbsp;last&nbsp;output&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4913425">if</span>&nbsp;<span class="ident" id="4913428">repeat</span>&nbsp;<span class="op" id="4913435">&gt;</span>&nbsp;<span class="ident" id="4913437">bz2</span><span class="op" id="4913440">.</span><span class="ident" id="4913441">blockSize</span><span class="op" id="4913450">-</span><span class="ident" id="4913451">bufIndex</span>&nbsp;<span class="op" id="4913460">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4913466">return</span>&nbsp;<span class="ident" id="4913473">StructuralError</span><span class="op" id="4913488">(</span><span class="string" id="4913489">&#34;repeats&nbsp;past&nbsp;end&nbsp;of&nbsp;block&#34;</span><span class="op" id="4913516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4913521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4913526">for</span>&nbsp;<span class="ident" id="4913530">i</span>&nbsp;<span class="op" id="4913532">:=</span>&nbsp;<span class="num" id="4913535">0</span><span class="op" id="4913536">;</span>&nbsp;<span class="ident" id="4913538">i</span>&nbsp;<span class="op" id="4913540">&lt;</span>&nbsp;<span class="ident" id="4913542">repeat</span><span class="op" id="4913548">;</span>&nbsp;<span class="ident" id="4913550">i</span><span class="op" id="4913551">++</span>&nbsp;<span class="op" id="4913554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913560">b</span>&nbsp;<span class="op" id="4913562">:=</span>&nbsp;<span class="builtintype" id="4913565">byte</span><span class="op" id="4913569">(</span><span class="ident" id="4913570">mtf</span><span class="op" id="4913573">.</span><span class="ident" id="4913574">First</span><span class="op" id="4913579">(</span><span class="op" id="4913580">)</span><span class="op" id="4913581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913587">bz2</span><span class="op" id="4913590">.</span><span class="ident" id="4913591">tt</span><span class="op" id="4913593">[</span><span class="ident" id="4913594">bufIndex</span><span class="op" id="4913602">]</span>&nbsp;<span class="op" id="4913604">=</span>&nbsp;<span class="builtintype" id="4913606">uint32</span><span class="op" id="4913612">(</span><span class="ident" id="4913613">b</span><span class="op" id="4913614">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913620">bz2</span><span class="op" id="4913623">.</span><span class="ident" id="4913624">c</span><span class="op" id="4913625">[</span><span class="ident" id="4913626">b</span><span class="op" id="4913627">]</span><span class="op" id="4913628">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913635">bufIndex</span><span class="op" id="4913643">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4913649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4913654">repeat</span>&nbsp;<span class="op" id="4913661">=</span>&nbsp;<span class="num" id="4913663">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4913667">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4913672">if</span>&nbsp;<span class="builtintype" id="4913675">int</span><span class="op" id="4913678">(</span><span class="ident" id="4913679">v</span><span class="op" id="4913680">)</span>&nbsp;<span class="op" id="4913682">==</span>&nbsp;<span class="ident" id="4913685">numSymbols</span><span class="op" id="4913695">-</span><span class="num" id="4913696">1</span>&nbsp;<span class="op" id="4913698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913703">//&nbsp;This&nbsp;is&nbsp;the&nbsp;EOF&nbsp;symbol.&nbsp;Because&nbsp;it&#39;s&nbsp;always&nbsp;at&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913760">//&nbsp;end&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;list,&nbsp;and&nbsp;never&nbsp;gets&nbsp;moved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913818">//&nbsp;to&nbsp;the&nbsp;front,&nbsp;it&nbsp;has&nbsp;this&nbsp;unique&nbsp;value.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4913864">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4913872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913877">//&nbsp;Since&nbsp;two&nbsp;metasymbols&nbsp;(RUNA&nbsp;and&nbsp;RUNB)&nbsp;have&nbsp;values&nbsp;0&nbsp;and&nbsp;1,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4913941">//&nbsp;one&nbsp;would&nbsp;expect&nbsp;|v-2|&nbsp;to&nbsp;be&nbsp;passed&nbsp;to&nbsp;the&nbsp;MTF&nbsp;decoder.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4914002">//&nbsp;However,&nbsp;the&nbsp;front&nbsp;of&nbsp;the&nbsp;MTF&nbsp;list&nbsp;is&nbsp;never&nbsp;referenced&nbsp;as&nbsp;0,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4914068">//&nbsp;it&#39;s&nbsp;always&nbsp;referenced&nbsp;with&nbsp;a&nbsp;run-length&nbsp;of&nbsp;1.&nbsp;Thus&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4914127">//&nbsp;doesn&#39;t&nbsp;need&nbsp;to&nbsp;be&nbsp;encoded&nbsp;and&nbsp;we&nbsp;have&nbsp;|v-1|&nbsp;in&nbsp;the&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4914189">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4914200">b</span>&nbsp;<span class="op" id="4914202">:=</span>&nbsp;<span class="builtintype" id="4914205">byte</span><span class="op" id="4914209">(</span><span class="ident" id="4914210">mtf</span><span class="op" id="4914213">.</span><span class="ident" id="4914214">Decode</span><span class="op" id="4914220">(</span><span class="builtintype" id="4914221">int</span><span class="op" id="4914224">(</span><span class="ident" id="4914225">v</span>&nbsp;<span class="op" id="4914227">-</span>&nbsp;<span class="num" id="4914229">1</span><span class="op" id="4914230">)</span><span class="op" id="4914231">)</span><span class="op" id="4914232">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4914236">if</span>&nbsp;<span class="ident" id="4914239">bufIndex</span>&nbsp;<span class="op" id="4914248">&gt;=</span>&nbsp;<span class="ident" id="4914251">bz2</span><span class="op" id="4914254">.</span><span class="ident" id="4914255">blockSize</span>&nbsp;<span class="op" id="4914265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4914270">return</span>&nbsp;<span class="ident" id="4914277">StructuralError</span><span class="op" id="4914292">(</span><span class="string" id="4914293">&#34;data&nbsp;exceeds&nbsp;block&nbsp;size&#34;</span><span class="op" id="4914318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4914322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4914326">bz2</span><span class="op" id="4914329">.</span><span class="ident" id="4914330">tt</span><span class="op" id="4914332">[</span><span class="ident" id="4914333">bufIndex</span><span class="op" id="4914341">]</span>&nbsp;<span class="op" id="4914343">=</span>&nbsp;<span class="builtintype" id="4914345">uint32</span><span class="op" id="4914351">(</span><span class="ident" id="4914352">b</span><span class="op" id="4914353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4914357">bz2</span><span class="op" id="4914360">.</span><span class="ident" id="4914361">c</span><span class="op" id="4914362">[</span><span class="ident" id="4914363">b</span><span class="op" id="4914364">]</span><span class="op" id="4914365">++</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4914370">bufIndex</span><span class="op" id="4914378">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4914382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4914386">if</span>&nbsp;<span class="ident" id="4914389">origPtr</span>&nbsp;<span class="op" id="4914397">&gt;=</span>&nbsp;<span class="builtintype" id="4914400">uint</span><span class="op" id="4914404">(</span><span class="ident" id="4914405">bufIndex</span><span class="op" id="4914413">)</span>&nbsp;<span class="op" id="4914415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4914419">return</span>&nbsp;<span class="ident" id="4914426">StructuralError</span><span class="op" id="4914441">(</span><span class="string" id="4914442">&#34;origPtr&nbsp;out&nbsp;of&nbsp;bounds&#34;</span><span class="op" id="4914465">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4914468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4914472">//&nbsp;We&nbsp;have&nbsp;completed&nbsp;the&nbsp;entropy&nbsp;decoding.&nbsp;Now&nbsp;we&nbsp;can&nbsp;perform&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4914539">//&nbsp;inverse&nbsp;BWT&nbsp;and&nbsp;setup&nbsp;the&nbsp;RLE&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4914581">bz2</span><span class="op" id="4914584">.</span><span class="ident" id="4914585">preRLE</span>&nbsp;<span class="op" id="4914592">=</span>&nbsp;<span class="ident" id="4914594">bz2</span><span class="op" id="4914597">.</span><span class="ident" id="4914598">tt</span><span class="op" id="4914600">[</span><span class="op" id="4914601">:</span><span class="ident" id="4914602">bufIndex</span><span class="op" id="4914610">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4914613">bz2</span><span class="op" id="4914616">.</span><span class="ident" id="4914617">preRLEUsed</span>&nbsp;<span class="op" id="4914628">=</span>&nbsp;<span class="num" id="4914630">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4914633">bz2</span><span class="op" id="4914636">.</span><span class="ident" id="4914637">tPos</span>&nbsp;<span class="op" id="4914642">=</span>&nbsp;<span class="ident" id="4914644">inverseBWT</span><span class="op" id="4914654">(</span><span class="ident" id="4914655">bz2</span><span class="op" id="4914658">.</span><span class="ident" id="4914659">preRLE</span><span class="op" id="4914665">,</span>&nbsp;<span class="ident" id="4914667">origPtr</span><span class="op" id="4914674">,</span>&nbsp;<span class="ident" id="4914676">bz2</span><span class="op" id="4914679">.</span><span class="ident" id="4914680">c</span><span class="op" id="4914681">[</span><span class="op" id="4914682">:</span><span class="op" id="4914683">]</span><span class="op" id="4914684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4914687">bz2</span><span class="op" id="4914690">.</span><span class="ident" id="4914691">lastByte</span>&nbsp;<span class="op" id="4914700">=</span>&nbsp;<span class="op" id="4914702">-</span><span class="num" id="4914703">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4914706">bz2</span><span class="op" id="4914709">.</span><span class="ident" id="4914710">byteRepeats</span>&nbsp;<span class="op" id="4914722">=</span>&nbsp;<span class="num" id="4914724">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4914727">bz2</span><span class="op" id="4914730">.</span><span class="ident" id="4914731">repeats</span>&nbsp;<span class="op" id="4914739">=</span>&nbsp;<span class="num" id="4914741">0</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4914745">return</span>&nbsp;<span class="ident" id="4914752">nil</span><br>
<span class="lineno"></span><span class="op" id="4914756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4914759">//&nbsp;inverseBWT&nbsp;implements&nbsp;the&nbsp;inverse&nbsp;Burrows-Wheeler&nbsp;transform&nbsp;as&nbsp;described&nbsp;in</span><br>
<span class="lineno">450</span><span class="comment" id="4914838">//&nbsp;http://www.hpl.hp.com/techreports/Compaq-DEC/SRC-RR-124.pdf,&nbsp;section&nbsp;4.2.</span><br>
<span class="lineno"></span><span class="comment" id="4914915">//&nbsp;In&nbsp;that&nbsp;document,&nbsp;origPtr&nbsp;is&nbsp;called&nbsp;`I&#39;&nbsp;and&nbsp;c&nbsp;is&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4914991">//&nbsp;first&nbsp;pass&nbsp;over&nbsp;the&nbsp;data.&nbsp;It&#39;s&nbsp;an&nbsp;argument&nbsp;here&nbsp;because&nbsp;we&nbsp;merge&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="4915069">//&nbsp;pass&nbsp;with&nbsp;the&nbsp;Huffman&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="comment" id="4915104">//</span><br>
<span class="lineno">455</span><span class="comment" id="4915107">//&nbsp;This&nbsp;also&nbsp;implements&nbsp;the&nbsp;`single&nbsp;array&#39;&nbsp;method&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="4915184">//&nbsp;which&nbsp;leaves&nbsp;the&nbsp;output,&nbsp;still&nbsp;shuffled,&nbsp;in&nbsp;the&nbsp;bottom&nbsp;8&nbsp;bits&nbsp;of&nbsp;tt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4915264">//&nbsp;index&nbsp;of&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;top&nbsp;24-bits.&nbsp;The&nbsp;index&nbsp;of&nbsp;the&nbsp;first&nbsp;byte&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4915341">//&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="4915354">func</span>&nbsp;<span class="ident" id="4915359">inverseBWT</span><span class="op" id="4915369">(</span><span class="ident" id="4915370">tt</span>&nbsp;<span class="op" id="4915373">[</span><span class="op" id="4915374">]</span><span class="builtintype" id="4915375">uint32</span><span class="op" id="4915381">,</span>&nbsp;<span class="ident" id="4915383">origPtr</span>&nbsp;<span class="builtintype" id="4915391">uint</span><span class="op" id="4915395">,</span>&nbsp;<span class="ident" id="4915397">c</span>&nbsp;<span class="op" id="4915399">[</span><span class="op" id="4915400">]</span><span class="builtintype" id="4915401">uint</span><span class="op" id="4915405">)</span>&nbsp;<span class="builtintype" id="4915407">uint32</span>&nbsp;<span class="op" id="4915414">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4915417">sum</span>&nbsp;<span class="op" id="4915421">:=</span>&nbsp;<span class="builtintype" id="4915424">uint</span><span class="op" id="4915428">(</span><span class="num" id="4915429">0</span><span class="op" id="4915430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4915433">for</span>&nbsp;<span class="ident" id="4915437">i</span>&nbsp;<span class="op" id="4915439">:=</span>&nbsp;<span class="num" id="4915442">0</span><span class="op" id="4915443">;</span>&nbsp;<span class="ident" id="4915445">i</span>&nbsp;<span class="op" id="4915447">&lt;</span>&nbsp;<span class="num" id="4915449">256</span><span class="op" id="4915452">;</span>&nbsp;<span class="ident" id="4915454">i</span><span class="op" id="4915455">++</span>&nbsp;<span class="op" id="4915458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4915462">sum</span>&nbsp;<span class="op" id="4915466">+=</span>&nbsp;<span class="ident" id="4915469">c</span><span class="op" id="4915470">[</span><span class="ident" id="4915471">i</span><span class="op" id="4915472">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4915476">c</span><span class="op" id="4915477">[</span><span class="ident" id="4915478">i</span><span class="op" id="4915479">]</span>&nbsp;<span class="op" id="4915481">=</span>&nbsp;<span class="ident" id="4915483">sum</span>&nbsp;<span class="op" id="4915487">-</span>&nbsp;<span class="ident" id="4915489">c</span><span class="op" id="4915490">[</span><span class="ident" id="4915491">i</span><span class="op" id="4915492">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4915495">}</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4915499">for</span>&nbsp;<span class="ident" id="4915503">i</span>&nbsp;<span class="op" id="4915505">:=</span>&nbsp;<span class="keyword" id="4915508">range</span>&nbsp;<span class="ident" id="4915514">tt</span>&nbsp;<span class="op" id="4915517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4915521">b</span>&nbsp;<span class="op" id="4915523">:=</span>&nbsp;<span class="ident" id="4915526">tt</span><span class="op" id="4915528">[</span><span class="ident" id="4915529">i</span><span class="op" id="4915530">]</span>&nbsp;<span class="op" id="4915532">&amp;</span>&nbsp;<span class="num" id="4915534">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4915541">tt</span><span class="op" id="4915543">[</span><span class="ident" id="4915544">c</span><span class="op" id="4915545">[</span><span class="ident" id="4915546">b</span><span class="op" id="4915547">]</span><span class="op" id="4915548">]</span>&nbsp;<span class="op" id="4915550">|=</span>&nbsp;<span class="builtintype" id="4915553">uint32</span><span class="op" id="4915559">(</span><span class="ident" id="4915560">i</span><span class="op" id="4915561">)</span>&nbsp;<span class="op" id="4915563">&lt;&lt;</span>&nbsp;<span class="num" id="4915566">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4915570">c</span><span class="op" id="4915571">[</span><span class="ident" id="4915572">b</span><span class="op" id="4915573">]</span><span class="op" id="4915574">++</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4915578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4915582">return</span>&nbsp;<span class="ident" id="4915589">tt</span><span class="op" id="4915591">[</span><span class="ident" id="4915592">origPtr</span><span class="op" id="4915599">]</span>&nbsp;<span class="op" id="4915601">&gt;&gt;</span>&nbsp;<span class="num" id="4915604">8</span><br>
<span class="lineno"></span><span class="op" id="4915606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span><span class="comment" id="4915609">//&nbsp;This&nbsp;is&nbsp;a&nbsp;standard&nbsp;CRC32&nbsp;like&nbsp;in&nbsp;hash/crc32&nbsp;except&nbsp;that&nbsp;all&nbsp;the&nbsp;shifts&nbsp;are&nbsp;reversed,</span><br>
<span class="lineno"></span><span class="comment" id="4915697">//&nbsp;causing&nbsp;the&nbsp;bits&nbsp;in&nbsp;the&nbsp;input&nbsp;to&nbsp;be&nbsp;processed&nbsp;in&nbsp;the&nbsp;reverse&nbsp;of&nbsp;the&nbsp;usual&nbsp;order.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4915782">var</span>&nbsp;<span class="ident" id="4915786">crctab</span>&nbsp;<span class="op" id="4915793">[</span><span class="num" id="4915794">256</span><span class="op" id="4915797">]</span><span class="builtintype" id="4915798">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span><span class="keyword" id="4915806">func</span>&nbsp;<span class="ident" id="4915811">init</span><span class="op" id="4915815">(</span><span class="op" id="4915816">)</span>&nbsp;<span class="op" id="4915818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4915821">const</span>&nbsp;<span class="ident" id="4915827">poly</span>&nbsp;<span class="op" id="4915832">=</span>&nbsp;<span class="num" id="4915834">0x04C11DB7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4915846">for</span>&nbsp;<span class="ident" id="4915850">i</span>&nbsp;<span class="op" id="4915852">:=</span>&nbsp;<span class="keyword" id="4915855">range</span>&nbsp;<span class="ident" id="4915861">crctab</span>&nbsp;<span class="op" id="4915868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4915872">crc</span>&nbsp;<span class="op" id="4915876">:=</span>&nbsp;<span class="builtintype" id="4915879">uint32</span><span class="op" id="4915885">(</span><span class="ident" id="4915886">i</span><span class="op" id="4915887">)</span>&nbsp;<span class="op" id="4915889">&lt;&lt;</span>&nbsp;<span class="num" id="4915892">24</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4915897">for</span>&nbsp;<span class="ident" id="4915901">j</span>&nbsp;<span class="op" id="4915903">:=</span>&nbsp;<span class="num" id="4915906">0</span><span class="op" id="4915907">;</span>&nbsp;<span class="ident" id="4915909">j</span>&nbsp;<span class="op" id="4915911">&lt;</span>&nbsp;<span class="num" id="4915913">8</span><span class="op" id="4915914">;</span>&nbsp;<span class="ident" id="4915916">j</span><span class="op" id="4915917">++</span>&nbsp;<span class="op" id="4915920">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4915925">if</span>&nbsp;<span class="ident" id="4915928">crc</span><span class="op" id="4915931">&amp;</span><span class="num" id="4915932">0x80000000</span>&nbsp;<span class="op" id="4915943">!=</span>&nbsp;<span class="num" id="4915946">0</span>&nbsp;<span class="op" id="4915948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4915954">crc</span>&nbsp;<span class="op" id="4915958">=</span>&nbsp;<span class="op" id="4915960">(</span><span class="ident" id="4915961">crc</span>&nbsp;<span class="op" id="4915965">&lt;&lt;</span>&nbsp;<span class="num" id="4915968">1</span><span class="op" id="4915969">)</span>&nbsp;<span class="op" id="4915971">^</span>&nbsp;<span class="ident" id="4915973">poly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4915981">}</span>&nbsp;<span class="keyword" id="4915983">else</span>&nbsp;<span class="op" id="4915988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4915994">crc</span>&nbsp;<span class="op" id="4915998">&lt;&lt;=</span>&nbsp;<span class="num" id="4916002">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4916007">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4916011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916015">crctab</span><span class="op" id="4916021">[</span><span class="ident" id="4916022">i</span><span class="op" id="4916023">]</span>&nbsp;<span class="op" id="4916025">=</span>&nbsp;<span class="ident" id="4916027">crc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4916032">}</span><br>
<span class="lineno"></span><span class="op" id="4916034">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="4916037">//&nbsp;updateCRC&nbsp;updates&nbsp;the&nbsp;crc&nbsp;value&nbsp;to&nbsp;incorporate&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="4916102">//&nbsp;The&nbsp;initial&nbsp;value&nbsp;is&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="4916129">func</span>&nbsp;<span class="ident" id="4916134">updateCRC</span><span class="op" id="4916143">(</span><span class="ident" id="4916144">val</span>&nbsp;<span class="builtintype" id="4916148">uint32</span><span class="op" id="4916154">,</span>&nbsp;<span class="ident" id="4916156">b</span>&nbsp;<span class="op" id="4916158">[</span><span class="op" id="4916159">]</span><span class="builtintype" id="4916160">byte</span><span class="op" id="4916164">)</span>&nbsp;<span class="builtintype" id="4916166">uint32</span>&nbsp;<span class="op" id="4916173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916176">crc</span>&nbsp;<span class="op" id="4916180">:=</span>&nbsp;<span class="op" id="4916183">^</span><span class="ident" id="4916184">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4916189">for</span>&nbsp;<span class="ident" id="4916193">_</span><span class="op" id="4916194">,</span>&nbsp;<span class="ident" id="4916196">v</span>&nbsp;<span class="op" id="4916198">:=</span>&nbsp;<span class="keyword" id="4916201">range</span>&nbsp;<span class="ident" id="4916207">b</span>&nbsp;<span class="op" id="4916209">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4916213">crc</span>&nbsp;<span class="op" id="4916217">=</span>&nbsp;<span class="ident" id="4916219">crctab</span><span class="op" id="4916225">[</span><span class="builtintype" id="4916226">byte</span><span class="op" id="4916230">(</span><span class="ident" id="4916231">crc</span><span class="op" id="4916234">&gt;&gt;</span><span class="num" id="4916236">24</span><span class="op" id="4916238">)</span><span class="op" id="4916239">^</span><span class="ident" id="4916240">v</span><span class="op" id="4916241">]</span>&nbsp;<span class="op" id="4916243">^</span>&nbsp;<span class="op" id="4916245">(</span><span class="ident" id="4916246">crc</span>&nbsp;<span class="op" id="4916250">&lt;&lt;</span>&nbsp;<span class="num" id="4916253">8</span><span class="op" id="4916254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4916257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4916260">return</span>&nbsp;<span class="op" id="4916267">^</span><span class="ident" id="4916268">crc</span><br>
<span class="lineno"></span><span class="op" id="4916272">}</span>
</div>
</body>
</html>
