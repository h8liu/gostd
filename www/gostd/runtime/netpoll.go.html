<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html" class="current">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1596263">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1596318">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1596372">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1596423">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1596501">package</span>&nbsp;<span class="ident" id="1596509">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1596518">import</span>&nbsp;<span class="string" id="1596525">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1596535">//&nbsp;Integrated&nbsp;network&nbsp;poller&nbsp;(platform-independent&nbsp;part).</span><br>
<span class="lineno"></span><span class="comment" id="1596593">//&nbsp;A&nbsp;particular&nbsp;implementation&nbsp;(epoll/kqueue)&nbsp;must&nbsp;define&nbsp;the&nbsp;following&nbsp;functions:</span><br>
<span class="lineno"></span><span class="comment" id="1596676">//&nbsp;func&nbsp;netpollinit()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;to&nbsp;initialize&nbsp;the&nbsp;poller</span><br>
<span class="lineno"></span><span class="comment" id="1596728">//&nbsp;func&nbsp;netpollopen(fd&nbsp;uintptr,&nbsp;pd&nbsp;*pollDesc)&nbsp;int32&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;to&nbsp;arm&nbsp;edge-triggered&nbsp;notifications</span><br>
<span class="lineno">15</span><span class="comment" id="1596819">//&nbsp;and&nbsp;associate&nbsp;fd&nbsp;with&nbsp;pd.</span><br>
<span class="lineno"></span><span class="comment" id="1596848">//&nbsp;An&nbsp;implementation&nbsp;must&nbsp;call&nbsp;the&nbsp;following&nbsp;function&nbsp;to&nbsp;denote&nbsp;that&nbsp;the&nbsp;pd&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="comment" id="1596934">//&nbsp;func&nbsp;netpollready(gpp&nbsp;**g,&nbsp;pd&nbsp;*pollDesc,&nbsp;mode&nbsp;int32)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1596991">//&nbsp;pollDesc&nbsp;contains&nbsp;2&nbsp;binary&nbsp;semaphores,&nbsp;rg&nbsp;and&nbsp;wg,&nbsp;to&nbsp;park&nbsp;reader&nbsp;and&nbsp;writer</span><br>
<span class="lineno">20</span><span class="comment" id="1597070">//&nbsp;goroutines&nbsp;respectively.&nbsp;The&nbsp;semaphore&nbsp;can&nbsp;be&nbsp;in&nbsp;the&nbsp;following&nbsp;states:</span><br>
<span class="lineno"></span><span class="comment" id="1597144">//&nbsp;pdReady&nbsp;-&nbsp;io&nbsp;readiness&nbsp;notification&nbsp;is&nbsp;pending;</span><br>
<span class="lineno"></span><span class="comment" id="1597195">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;goroutine&nbsp;consumes&nbsp;the&nbsp;notification&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1597276">//&nbsp;pdWait&nbsp;-&nbsp;a&nbsp;goroutine&nbsp;prepares&nbsp;to&nbsp;park&nbsp;on&nbsp;the&nbsp;semaphore,&nbsp;but&nbsp;not&nbsp;yet&nbsp;parked;</span><br>
<span class="lineno"></span><span class="comment" id="1597355">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;goroutine&nbsp;commits&nbsp;to&nbsp;park&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;G&nbsp;pointer,</span><br>
<span class="lineno">25</span><span class="comment" id="1597433">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;io&nbsp;notification&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY,</span><br>
<span class="lineno"></span><span class="comment" id="1597519">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1597601">//&nbsp;G&nbsp;pointer&nbsp;-&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;blocked&nbsp;on&nbsp;the&nbsp;semaphore;</span><br>
<span class="lineno"></span><span class="comment" id="1597659">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;io&nbsp;notification&nbsp;or&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY&nbsp;or&nbsp;nil&nbsp;respectively</span><br>
<span class="lineno"></span><span class="comment" id="1597754">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;unparks&nbsp;the&nbsp;goroutine.</span><br>
<span class="lineno">30</span><span class="comment" id="1597796">//&nbsp;nil&nbsp;-&nbsp;nothing&nbsp;of&nbsp;the&nbsp;above.</span><br>
<span class="lineno"></span><span class="keyword" id="1597827">const</span>&nbsp;<span class="op" id="1597833">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1597836">pdReady</span>&nbsp;<span class="builtintype" id="1597844">uintptr</span>&nbsp;<span class="op" id="1597852">=</span>&nbsp;<span class="num" id="1597854">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1597857">pdWait</span>&nbsp;&nbsp;<span class="builtintype" id="1597865">uintptr</span>&nbsp;<span class="op" id="1597873">=</span>&nbsp;<span class="num" id="1597875">2</span><br>
<span class="lineno"></span><span class="op" id="1597877">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1597880">const</span>&nbsp;<span class="ident" id="1597886">pollBlockSize</span>&nbsp;<span class="op" id="1597900">=</span>&nbsp;<span class="num" id="1597902">4</span>&nbsp;<span class="op" id="1597904">*</span>&nbsp;<span class="num" id="1597906">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1597912">//&nbsp;Network&nbsp;poller&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="1597942">type</span>&nbsp;<span class="ident" id="1597947">pollDesc</span>&nbsp;<span class="keyword" id="1597956">struct</span>&nbsp;<span class="op" id="1597963">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1597966">link</span>&nbsp;<span class="op" id="1597971">*</span><span class="ident" id="1597972">pollDesc</span>&nbsp;<span class="comment" id="1597981">//&nbsp;in&nbsp;pollcache,&nbsp;protected&nbsp;by&nbsp;pollcache.lock</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1598028">//&nbsp;The&nbsp;lock&nbsp;protects&nbsp;pollOpen,&nbsp;pollSetDeadline,&nbsp;pollUnblock&nbsp;and&nbsp;deadlineimpl&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1598118">//&nbsp;This&nbsp;fully&nbsp;covers&nbsp;seq,&nbsp;rt&nbsp;and&nbsp;wt&nbsp;variables.&nbsp;fd&nbsp;is&nbsp;constant&nbsp;throughout&nbsp;the&nbsp;PollDesc&nbsp;lifetime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1598215">//&nbsp;pollReset,&nbsp;pollWait,&nbsp;pollWaitCanceled&nbsp;and&nbsp;runtimeÂ·netpollready&nbsp;(IO&nbsp;readiness&nbsp;notification)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1598311">//&nbsp;proceed&nbsp;w/o&nbsp;taking&nbsp;the&nbsp;lock.&nbsp;So&nbsp;closing,&nbsp;rg,&nbsp;rd,&nbsp;wg&nbsp;and&nbsp;wd&nbsp;are&nbsp;manipulated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1598390">//&nbsp;in&nbsp;a&nbsp;lock-free&nbsp;way&nbsp;by&nbsp;all&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1598432">//&nbsp;NOTE(dvyukov):&nbsp;the&nbsp;following&nbsp;code&nbsp;uses&nbsp;uintptr&nbsp;to&nbsp;store&nbsp;*g&nbsp;(rg/wg),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1598504">//&nbsp;that&nbsp;will&nbsp;blow&nbsp;up&nbsp;when&nbsp;GC&nbsp;starts&nbsp;moving&nbsp;objects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598557">lock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598565">mutex</span>&nbsp;<span class="comment" id="1598571">//&nbsp;protectes&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598606">fd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1598614">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598623">closing</span>&nbsp;<span class="builtintype" id="1598631">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598637">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1598645">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1598660">//&nbsp;protects&nbsp;from&nbsp;stale&nbsp;timers&nbsp;and&nbsp;ready&nbsp;notifications</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598715">rg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1598723">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1598738">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;read&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598785">rt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598793">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1598808">//&nbsp;read&nbsp;deadline&nbsp;timer&nbsp;(set&nbsp;if&nbsp;rt.f&nbsp;!=&nbsp;nil)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598853">rd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598861">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1598876">//&nbsp;read&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598894">wg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1598902">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1598917">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;write&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598965">wt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1598973">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1598988">//&nbsp;write&nbsp;deadline&nbsp;timer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599013">wd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599021">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1599036">//&nbsp;write&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599055">user</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599063">unsafe</span><span class="op" id="1599069">.</span><span class="ident" id="1599070">Pointer</span>&nbsp;<span class="comment" id="1599078">//&nbsp;user&nbsp;settable&nbsp;cookie</span><br>
<span class="lineno">60</span><span class="op" id="1599102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1599105">type</span>&nbsp;<span class="ident" id="1599110">pollCache</span>&nbsp;<span class="keyword" id="1599120">struct</span>&nbsp;<span class="op" id="1599127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599130">lock</span>&nbsp;&nbsp;<span class="ident" id="1599136">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599143">first</span>&nbsp;<span class="op" id="1599149">*</span><span class="ident" id="1599150">pollDesc</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1599160">//&nbsp;PollDesc&nbsp;objects&nbsp;must&nbsp;be&nbsp;type-stable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1599202">//&nbsp;because&nbsp;we&nbsp;can&nbsp;get&nbsp;ready&nbsp;notification&nbsp;from&nbsp;epoll/kqueue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1599262">//&nbsp;after&nbsp;the&nbsp;descriptor&nbsp;is&nbsp;closed/reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1599305">//&nbsp;Stale&nbsp;notifications&nbsp;are&nbsp;detected&nbsp;using&nbsp;seq&nbsp;variable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1599362">//&nbsp;seq&nbsp;is&nbsp;incremented&nbsp;when&nbsp;deadlines&nbsp;are&nbsp;changed&nbsp;or&nbsp;descriptor&nbsp;is&nbsp;reused.</span><br>
<span class="lineno">70</span><span class="op" id="1599436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1599439">var</span>&nbsp;<span class="ident" id="1599443">pollcache</span>&nbsp;<span class="ident" id="1599453">pollCache</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1599464">func</span>&nbsp;<span class="ident" id="1599469">netpollServerInit</span><span class="op" id="1599486">(</span><span class="op" id="1599487">)</span>&nbsp;<span class="op" id="1599489">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599492">onM</span><span class="op" id="1599495">(</span><span class="ident" id="1599496">netpollinit</span><span class="op" id="1599507">)</span><br>
<span class="lineno"></span><span class="op" id="1599509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1599512">func</span>&nbsp;<span class="ident" id="1599517">netpollOpen</span><span class="op" id="1599528">(</span><span class="ident" id="1599529">fd</span>&nbsp;<span class="builtintype" id="1599532">uintptr</span><span class="op" id="1599539">)</span>&nbsp;<span class="op" id="1599541">(</span><span class="op" id="1599542">*</span><span class="ident" id="1599543">pollDesc</span><span class="op" id="1599551">,</span>&nbsp;<span class="builtintype" id="1599553">int</span><span class="op" id="1599556">)</span>&nbsp;<span class="op" id="1599558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599561">pd</span>&nbsp;<span class="op" id="1599564">:=</span>&nbsp;<span class="ident" id="1599567">pollcache</span><span class="op" id="1599576">.</span><span class="ident" id="1599577">alloc</span><span class="op" id="1599582">(</span><span class="op" id="1599583">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599586">lock</span><span class="op" id="1599590">(</span><span class="op" id="1599591">&amp;</span><span class="ident" id="1599592">pd</span><span class="op" id="1599594">.</span><span class="ident" id="1599595">lock</span><span class="op" id="1599599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1599602">if</span>&nbsp;<span class="ident" id="1599605">pd</span><span class="op" id="1599607">.</span><span class="ident" id="1599608">wg</span>&nbsp;<span class="op" id="1599611">!=</span>&nbsp;<span class="num" id="1599614">0</span>&nbsp;<span class="op" id="1599616">&amp;&amp;</span>&nbsp;<span class="ident" id="1599619">pd</span><span class="op" id="1599621">.</span><span class="ident" id="1599622">wg</span>&nbsp;<span class="op" id="1599625">!=</span>&nbsp;<span class="ident" id="1599628">pdReady</span>&nbsp;<span class="op" id="1599636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599640">gothrow</span><span class="op" id="1599647">(</span><span class="string" id="1599648">&#34;netpollOpen:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1599695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1599698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1599701">if</span>&nbsp;<span class="ident" id="1599704">pd</span><span class="op" id="1599706">.</span><span class="ident" id="1599707">rg</span>&nbsp;<span class="op" id="1599710">!=</span>&nbsp;<span class="num" id="1599713">0</span>&nbsp;<span class="op" id="1599715">&amp;&amp;</span>&nbsp;<span class="ident" id="1599718">pd</span><span class="op" id="1599720">.</span><span class="ident" id="1599721">rg</span>&nbsp;<span class="op" id="1599724">!=</span>&nbsp;<span class="ident" id="1599727">pdReady</span>&nbsp;<span class="op" id="1599735">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599739">gothrow</span><span class="op" id="1599746">(</span><span class="string" id="1599747">&#34;netpollOpen:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1599793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1599796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599799">pd</span><span class="op" id="1599801">.</span><span class="ident" id="1599802">fd</span>&nbsp;<span class="op" id="1599805">=</span>&nbsp;<span class="ident" id="1599807">fd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599811">pd</span><span class="op" id="1599813">.</span><span class="ident" id="1599814">closing</span>&nbsp;<span class="op" id="1599822">=</span>&nbsp;<span class="builtintype" id="1599824">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599831">pd</span><span class="op" id="1599833">.</span><span class="ident" id="1599834">seq</span><span class="op" id="1599837">++</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599841">pd</span><span class="op" id="1599843">.</span><span class="ident" id="1599844">rg</span>&nbsp;<span class="op" id="1599847">=</span>&nbsp;<span class="num" id="1599849">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599852">pd</span><span class="op" id="1599854">.</span><span class="ident" id="1599855">rd</span>&nbsp;<span class="op" id="1599858">=</span>&nbsp;<span class="num" id="1599860">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599863">pd</span><span class="op" id="1599865">.</span><span class="ident" id="1599866">wg</span>&nbsp;<span class="op" id="1599869">=</span>&nbsp;<span class="num" id="1599871">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599874">pd</span><span class="op" id="1599876">.</span><span class="ident" id="1599877">wd</span>&nbsp;<span class="op" id="1599880">=</span>&nbsp;<span class="num" id="1599882">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599885">unlock</span><span class="op" id="1599891">(</span><span class="op" id="1599892">&amp;</span><span class="ident" id="1599893">pd</span><span class="op" id="1599895">.</span><span class="ident" id="1599896">lock</span><span class="op" id="1599900">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1599904">var</span>&nbsp;<span class="ident" id="1599908">errno</span>&nbsp;<span class="builtintype" id="1599914">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599921">onM</span><span class="op" id="1599924">(</span><span class="keyword" id="1599925">func</span><span class="op" id="1599929">(</span><span class="op" id="1599930">)</span>&nbsp;<span class="op" id="1599932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1599936">errno</span>&nbsp;<span class="op" id="1599942">=</span>&nbsp;<span class="ident" id="1599944">netpollopen</span><span class="op" id="1599955">(</span><span class="ident" id="1599956">fd</span><span class="op" id="1599958">,</span>&nbsp;<span class="ident" id="1599960">pd</span><span class="op" id="1599962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1599965">}</span><span class="op" id="1599966">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1599969">return</span>&nbsp;<span class="ident" id="1599976">pd</span><span class="op" id="1599978">,</span>&nbsp;<span class="builtintype" id="1599980">int</span><span class="op" id="1599983">(</span><span class="ident" id="1599984">errno</span><span class="op" id="1599989">)</span><br>
<span class="lineno"></span><span class="op" id="1599991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1599994">func</span>&nbsp;<span class="ident" id="1599999">netpollClose</span><span class="op" id="1600011">(</span><span class="ident" id="1600012">pd</span>&nbsp;<span class="op" id="1600015">*</span><span class="ident" id="1600016">pollDesc</span><span class="op" id="1600024">)</span>&nbsp;<span class="op" id="1600026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600029">if</span>&nbsp;<span class="op" id="1600032">!</span><span class="ident" id="1600033">pd</span><span class="op" id="1600035">.</span><span class="ident" id="1600036">closing</span>&nbsp;<span class="op" id="1600044">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600048">gothrow</span><span class="op" id="1600055">(</span><span class="string" id="1600056">&#34;netpollClose:&nbsp;close&nbsp;w/o&nbsp;unblock&#34;</span><span class="op" id="1600089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600095">if</span>&nbsp;<span class="ident" id="1600098">pd</span><span class="op" id="1600100">.</span><span class="ident" id="1600101">wg</span>&nbsp;<span class="op" id="1600104">!=</span>&nbsp;<span class="num" id="1600107">0</span>&nbsp;<span class="op" id="1600109">&amp;&amp;</span>&nbsp;<span class="ident" id="1600112">pd</span><span class="op" id="1600114">.</span><span class="ident" id="1600115">wg</span>&nbsp;<span class="op" id="1600118">!=</span>&nbsp;<span class="ident" id="1600121">pdReady</span>&nbsp;<span class="op" id="1600129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600133">gothrow</span><span class="op" id="1600140">(</span><span class="string" id="1600141">&#34;netpollClose:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1600192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600195">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600198">if</span>&nbsp;<span class="ident" id="1600201">pd</span><span class="op" id="1600203">.</span><span class="ident" id="1600204">rg</span>&nbsp;<span class="op" id="1600207">!=</span>&nbsp;<span class="num" id="1600210">0</span>&nbsp;<span class="op" id="1600212">&amp;&amp;</span>&nbsp;<span class="ident" id="1600215">pd</span><span class="op" id="1600217">.</span><span class="ident" id="1600218">rg</span>&nbsp;<span class="op" id="1600221">!=</span>&nbsp;<span class="ident" id="1600224">pdReady</span>&nbsp;<span class="op" id="1600232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600236">gothrow</span><span class="op" id="1600243">(</span><span class="string" id="1600244">&#34;netpollClose:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1600294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600300">onM</span><span class="op" id="1600303">(</span><span class="keyword" id="1600304">func</span><span class="op" id="1600308">(</span><span class="op" id="1600309">)</span>&nbsp;<span class="op" id="1600311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600315">netpollclose</span><span class="op" id="1600327">(</span><span class="builtintype" id="1600328">uintptr</span><span class="op" id="1600335">(</span><span class="ident" id="1600336">pd</span><span class="op" id="1600338">.</span><span class="ident" id="1600339">fd</span><span class="op" id="1600341">)</span><span class="op" id="1600342">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600345">}</span><span class="op" id="1600346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600349">pollcache</span><span class="op" id="1600358">.</span><span class="ident" id="1600359">free</span><span class="op" id="1600363">(</span><span class="ident" id="1600364">pd</span><span class="op" id="1600366">)</span><br>
<span class="lineno"></span><span class="op" id="1600368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1600371">func</span>&nbsp;<span class="op" id="1600376">(</span><span class="ident" id="1600377">c</span>&nbsp;<span class="op" id="1600379">*</span><span class="ident" id="1600380">pollCache</span><span class="op" id="1600389">)</span>&nbsp;<span class="ident" id="1600391">free</span><span class="op" id="1600395">(</span><span class="ident" id="1600396">pd</span>&nbsp;<span class="op" id="1600399">*</span><span class="ident" id="1600400">pollDesc</span><span class="op" id="1600408">)</span>&nbsp;<span class="op" id="1600410">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600413">lock</span><span class="op" id="1600417">(</span><span class="op" id="1600418">&amp;</span><span class="ident" id="1600419">c</span><span class="op" id="1600420">.</span><span class="ident" id="1600421">lock</span><span class="op" id="1600425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600428">pd</span><span class="op" id="1600430">.</span><span class="ident" id="1600431">link</span>&nbsp;<span class="op" id="1600436">=</span>&nbsp;<span class="ident" id="1600438">c</span><span class="op" id="1600439">.</span><span class="ident" id="1600440">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600447">c</span><span class="op" id="1600448">.</span><span class="ident" id="1600449">first</span>&nbsp;<span class="op" id="1600455">=</span>&nbsp;<span class="ident" id="1600457">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600461">unlock</span><span class="op" id="1600467">(</span><span class="op" id="1600468">&amp;</span><span class="ident" id="1600469">c</span><span class="op" id="1600470">.</span><span class="ident" id="1600471">lock</span><span class="op" id="1600475">)</span><br>
<span class="lineno"></span><span class="op" id="1600477">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="1600480">func</span>&nbsp;<span class="ident" id="1600485">netpollReset</span><span class="op" id="1600497">(</span><span class="ident" id="1600498">pd</span>&nbsp;<span class="op" id="1600501">*</span><span class="ident" id="1600502">pollDesc</span><span class="op" id="1600510">,</span>&nbsp;<span class="ident" id="1600512">mode</span>&nbsp;<span class="builtintype" id="1600517">int</span><span class="op" id="1600520">)</span>&nbsp;<span class="builtintype" id="1600522">int</span>&nbsp;<span class="op" id="1600526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600529">err</span>&nbsp;<span class="op" id="1600533">:=</span>&nbsp;<span class="ident" id="1600536">netpollcheckerr</span><span class="op" id="1600551">(</span><span class="ident" id="1600552">pd</span><span class="op" id="1600554">,</span>&nbsp;<span class="builtintype" id="1600556">int32</span><span class="op" id="1600561">(</span><span class="ident" id="1600562">mode</span><span class="op" id="1600566">)</span><span class="op" id="1600567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600570">if</span>&nbsp;<span class="ident" id="1600573">err</span>&nbsp;<span class="op" id="1600577">!=</span>&nbsp;<span class="num" id="1600580">0</span>&nbsp;<span class="op" id="1600582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600586">return</span>&nbsp;<span class="ident" id="1600593">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600601">if</span>&nbsp;<span class="ident" id="1600604">mode</span>&nbsp;<span class="op" id="1600609">==</span>&nbsp;<span class="string" id="1600612">&#39;r&#39;</span>&nbsp;<span class="op" id="1600616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600620">pd</span><span class="op" id="1600622">.</span><span class="ident" id="1600623">rg</span>&nbsp;<span class="op" id="1600626">=</span>&nbsp;<span class="num" id="1600628">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600631">}</span>&nbsp;<span class="keyword" id="1600633">else</span>&nbsp;<span class="keyword" id="1600638">if</span>&nbsp;<span class="ident" id="1600641">mode</span>&nbsp;<span class="op" id="1600646">==</span>&nbsp;<span class="string" id="1600649">&#39;w&#39;</span>&nbsp;<span class="op" id="1600653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600657">pd</span><span class="op" id="1600659">.</span><span class="ident" id="1600660">wg</span>&nbsp;<span class="op" id="1600663">=</span>&nbsp;<span class="num" id="1600665">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600671">return</span>&nbsp;<span class="num" id="1600678">0</span><br>
<span class="lineno"></span><span class="op" id="1600680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1600683">func</span>&nbsp;<span class="ident" id="1600688">netpollWait</span><span class="op" id="1600699">(</span><span class="ident" id="1600700">pd</span>&nbsp;<span class="op" id="1600703">*</span><span class="ident" id="1600704">pollDesc</span><span class="op" id="1600712">,</span>&nbsp;<span class="ident" id="1600714">mode</span>&nbsp;<span class="builtintype" id="1600719">int</span><span class="op" id="1600722">)</span>&nbsp;<span class="builtintype" id="1600724">int</span>&nbsp;<span class="op" id="1600728">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600731">err</span>&nbsp;<span class="op" id="1600735">:=</span>&nbsp;<span class="ident" id="1600738">netpollcheckerr</span><span class="op" id="1600753">(</span><span class="ident" id="1600754">pd</span><span class="op" id="1600756">,</span>&nbsp;<span class="builtintype" id="1600758">int32</span><span class="op" id="1600763">(</span><span class="ident" id="1600764">mode</span><span class="op" id="1600768">)</span><span class="op" id="1600769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600772">if</span>&nbsp;<span class="ident" id="1600775">err</span>&nbsp;<span class="op" id="1600779">!=</span>&nbsp;<span class="num" id="1600782">0</span>&nbsp;<span class="op" id="1600784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600788">return</span>&nbsp;<span class="ident" id="1600795">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1600803">//&nbsp;As&nbsp;for&nbsp;now&nbsp;only&nbsp;Solaris&nbsp;uses&nbsp;level-triggered&nbsp;IO.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600856">if</span>&nbsp;<span class="ident" id="1600859">GOOS</span>&nbsp;<span class="op" id="1600864">==</span>&nbsp;<span class="string" id="1600867">&#34;solaris&#34;</span>&nbsp;<span class="op" id="1600877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600881">onM</span><span class="op" id="1600884">(</span><span class="keyword" id="1600885">func</span><span class="op" id="1600889">(</span><span class="op" id="1600890">)</span>&nbsp;<span class="op" id="1600892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600897">netpollarm</span><span class="op" id="1600907">(</span><span class="ident" id="1600908">pd</span><span class="op" id="1600910">,</span>&nbsp;<span class="ident" id="1600912">mode</span><span class="op" id="1600916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600920">}</span><span class="op" id="1600921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1600924">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1600927">for</span>&nbsp;<span class="op" id="1600931">!</span><span class="ident" id="1600932">netpollblock</span><span class="op" id="1600944">(</span><span class="ident" id="1600945">pd</span><span class="op" id="1600947">,</span>&nbsp;<span class="builtintype" id="1600949">int32</span><span class="op" id="1600954">(</span><span class="ident" id="1600955">mode</span><span class="op" id="1600959">)</span><span class="op" id="1600960">,</span>&nbsp;<span class="builtintype" id="1600962">false</span><span class="op" id="1600967">)</span>&nbsp;<span class="op" id="1600969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1600973">err</span>&nbsp;<span class="op" id="1600977">=</span>&nbsp;<span class="ident" id="1600979">netpollcheckerr</span><span class="op" id="1600994">(</span><span class="ident" id="1600995">pd</span><span class="op" id="1600997">,</span>&nbsp;<span class="builtintype" id="1600999">int32</span><span class="op" id="1601004">(</span><span class="ident" id="1601005">mode</span><span class="op" id="1601009">)</span><span class="op" id="1601010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601014">if</span>&nbsp;<span class="ident" id="1601017">err</span>&nbsp;<span class="op" id="1601021">!=</span>&nbsp;<span class="num" id="1601024">0</span>&nbsp;<span class="op" id="1601026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601031">return</span>&nbsp;<span class="ident" id="1601038">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601044">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1601048">//&nbsp;Can&nbsp;happen&nbsp;if&nbsp;timeout&nbsp;has&nbsp;fired&nbsp;and&nbsp;unblocked&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1601103">//&nbsp;but&nbsp;before&nbsp;we&nbsp;had&nbsp;a&nbsp;chance&nbsp;to&nbsp;run,&nbsp;timeout&nbsp;has&nbsp;been&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1601167">//&nbsp;Pretend&nbsp;it&nbsp;has&nbsp;not&nbsp;happened&nbsp;and&nbsp;retry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601213">return</span>&nbsp;<span class="num" id="1601220">0</span><br>
<span class="lineno">160</span><span class="op" id="1601222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1601225">func</span>&nbsp;<span class="ident" id="1601230">netpollWaitCanceled</span><span class="op" id="1601249">(</span><span class="ident" id="1601250">pd</span>&nbsp;<span class="op" id="1601253">*</span><span class="ident" id="1601254">pollDesc</span><span class="op" id="1601262">,</span>&nbsp;<span class="ident" id="1601264">mode</span>&nbsp;<span class="builtintype" id="1601269">int</span><span class="op" id="1601272">)</span>&nbsp;<span class="op" id="1601274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1601277">//&nbsp;This&nbsp;function&nbsp;is&nbsp;used&nbsp;only&nbsp;on&nbsp;windows&nbsp;after&nbsp;a&nbsp;failed&nbsp;attempt&nbsp;to&nbsp;cancel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1601352">//&nbsp;a&nbsp;pending&nbsp;async&nbsp;IO&nbsp;operation.&nbsp;Wait&nbsp;for&nbsp;ioready,&nbsp;ignore&nbsp;closing&nbsp;or&nbsp;timeouts.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601432">for</span>&nbsp;<span class="op" id="1601436">!</span><span class="ident" id="1601437">netpollblock</span><span class="op" id="1601449">(</span><span class="ident" id="1601450">pd</span><span class="op" id="1601452">,</span>&nbsp;<span class="builtintype" id="1601454">int32</span><span class="op" id="1601459">(</span><span class="ident" id="1601460">mode</span><span class="op" id="1601464">)</span><span class="op" id="1601465">,</span>&nbsp;<span class="builtintype" id="1601467">true</span><span class="op" id="1601471">)</span>&nbsp;<span class="op" id="1601473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601476">}</span><br>
<span class="lineno"></span><span class="op" id="1601478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1601481">func</span>&nbsp;<span class="ident" id="1601486">netpollSetDeadline</span><span class="op" id="1601504">(</span><span class="ident" id="1601505">pd</span>&nbsp;<span class="op" id="1601508">*</span><span class="ident" id="1601509">pollDesc</span><span class="op" id="1601517">,</span>&nbsp;<span class="ident" id="1601519">d</span>&nbsp;<span class="ident" id="1601521">int64</span><span class="op" id="1601526">,</span>&nbsp;<span class="ident" id="1601528">mode</span>&nbsp;<span class="builtintype" id="1601533">int</span><span class="op" id="1601536">)</span>&nbsp;<span class="op" id="1601538">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601541">lock</span><span class="op" id="1601545">(</span><span class="op" id="1601546">&amp;</span><span class="ident" id="1601547">pd</span><span class="op" id="1601549">.</span><span class="ident" id="1601550">lock</span><span class="op" id="1601554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601557">if</span>&nbsp;<span class="ident" id="1601560">pd</span><span class="op" id="1601562">.</span><span class="ident" id="1601563">closing</span>&nbsp;<span class="op" id="1601571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601575">unlock</span><span class="op" id="1601581">(</span><span class="op" id="1601582">&amp;</span><span class="ident" id="1601583">pd</span><span class="op" id="1601585">.</span><span class="ident" id="1601586">lock</span><span class="op" id="1601590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601594">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601602">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601605">pd</span><span class="op" id="1601607">.</span><span class="ident" id="1601608">seq</span><span class="op" id="1601611">++</span>&nbsp;<span class="comment" id="1601614">//&nbsp;invalidate&nbsp;current&nbsp;timers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1601644">//&nbsp;Reset&nbsp;current&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601670">if</span>&nbsp;<span class="ident" id="1601673">pd</span><span class="op" id="1601675">.</span><span class="ident" id="1601676">rt</span><span class="op" id="1601678">.</span><span class="ident" id="1601679">f</span>&nbsp;<span class="op" id="1601681">!=</span>&nbsp;<span class="builtintype" id="1601684">nil</span>&nbsp;<span class="op" id="1601688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601692">deltimer</span><span class="op" id="1601700">(</span><span class="op" id="1601701">&amp;</span><span class="ident" id="1601702">pd</span><span class="op" id="1601704">.</span><span class="ident" id="1601705">rt</span><span class="op" id="1601707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601711">pd</span><span class="op" id="1601713">.</span><span class="ident" id="1601714">rt</span><span class="op" id="1601716">.</span><span class="ident" id="1601717">f</span>&nbsp;<span class="op" id="1601719">=</span>&nbsp;<span class="builtintype" id="1601721">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601729">if</span>&nbsp;<span class="ident" id="1601732">pd</span><span class="op" id="1601734">.</span><span class="ident" id="1601735">wt</span><span class="op" id="1601737">.</span><span class="ident" id="1601738">f</span>&nbsp;<span class="op" id="1601740">!=</span>&nbsp;<span class="builtintype" id="1601743">nil</span>&nbsp;<span class="op" id="1601747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601751">deltimer</span><span class="op" id="1601759">(</span><span class="op" id="1601760">&amp;</span><span class="ident" id="1601761">pd</span><span class="op" id="1601763">.</span><span class="ident" id="1601764">wt</span><span class="op" id="1601766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601770">pd</span><span class="op" id="1601772">.</span><span class="ident" id="1601773">wt</span><span class="op" id="1601775">.</span><span class="ident" id="1601776">f</span>&nbsp;<span class="op" id="1601778">=</span>&nbsp;<span class="builtintype" id="1601780">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601785">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1601788">//&nbsp;Setup&nbsp;new&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601810">if</span>&nbsp;<span class="ident" id="1601813">d</span>&nbsp;<span class="op" id="1601815">!=</span>&nbsp;<span class="num" id="1601818">0</span>&nbsp;<span class="op" id="1601820">&amp;&amp;</span>&nbsp;<span class="ident" id="1601823">d</span>&nbsp;<span class="op" id="1601825">&lt;=</span>&nbsp;<span class="ident" id="1601828">nanotime</span><span class="op" id="1601836">(</span><span class="op" id="1601837">)</span>&nbsp;<span class="op" id="1601839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601843">d</span>&nbsp;<span class="op" id="1601845">=</span>&nbsp;<span class="op" id="1601847">-</span><span class="num" id="1601848">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601854">if</span>&nbsp;<span class="ident" id="1601857">mode</span>&nbsp;<span class="op" id="1601862">==</span>&nbsp;<span class="string" id="1601865">&#39;r&#39;</span>&nbsp;<span class="op" id="1601869">||</span>&nbsp;<span class="ident" id="1601872">mode</span>&nbsp;<span class="op" id="1601877">==</span>&nbsp;<span class="string" id="1601880">&#39;r&#39;</span><span class="op" id="1601883">+</span><span class="string" id="1601884">&#39;w&#39;</span>&nbsp;<span class="op" id="1601888">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601892">pd</span><span class="op" id="1601894">.</span><span class="ident" id="1601895">rd</span>&nbsp;<span class="op" id="1601898">=</span>&nbsp;<span class="ident" id="1601900">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601906">if</span>&nbsp;<span class="ident" id="1601909">mode</span>&nbsp;<span class="op" id="1601914">==</span>&nbsp;<span class="string" id="1601917">&#39;w&#39;</span>&nbsp;<span class="op" id="1601921">||</span>&nbsp;<span class="ident" id="1601924">mode</span>&nbsp;<span class="op" id="1601929">==</span>&nbsp;<span class="string" id="1601932">&#39;r&#39;</span><span class="op" id="1601935">+</span><span class="string" id="1601936">&#39;w&#39;</span>&nbsp;<span class="op" id="1601940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601944">pd</span><span class="op" id="1601946">.</span><span class="ident" id="1601947">wd</span>&nbsp;<span class="op" id="1601950">=</span>&nbsp;<span class="ident" id="1601952">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1601955">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1601958">if</span>&nbsp;<span class="ident" id="1601961">pd</span><span class="op" id="1601963">.</span><span class="ident" id="1601964">rd</span>&nbsp;<span class="op" id="1601967">&gt;</span>&nbsp;<span class="num" id="1601969">0</span>&nbsp;<span class="op" id="1601971">&amp;&amp;</span>&nbsp;<span class="ident" id="1601974">pd</span><span class="op" id="1601976">.</span><span class="ident" id="1601977">rd</span>&nbsp;<span class="op" id="1601980">==</span>&nbsp;<span class="ident" id="1601983">pd</span><span class="op" id="1601985">.</span><span class="ident" id="1601986">wd</span>&nbsp;<span class="op" id="1601989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1601993">pd</span><span class="op" id="1601995">.</span><span class="ident" id="1601996">rt</span><span class="op" id="1601998">.</span><span class="ident" id="1601999">f</span>&nbsp;<span class="op" id="1602001">=</span>&nbsp;<span class="ident" id="1602003">netpollDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602021">pd</span><span class="op" id="1602023">.</span><span class="ident" id="1602024">rt</span><span class="op" id="1602026">.</span><span class="ident" id="1602027">when</span>&nbsp;<span class="op" id="1602032">=</span>&nbsp;<span class="ident" id="1602034">pd</span><span class="op" id="1602036">.</span><span class="ident" id="1602037">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1602042">//&nbsp;Copy&nbsp;current&nbsp;seq&nbsp;into&nbsp;the&nbsp;timer&nbsp;arg.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1602084">//&nbsp;Timer&nbsp;func&nbsp;will&nbsp;check&nbsp;the&nbsp;seq&nbsp;against&nbsp;current&nbsp;descriptor&nbsp;seq,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1602151">//&nbsp;if&nbsp;they&nbsp;differ&nbsp;the&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602219">pd</span><span class="op" id="1602221">.</span><span class="ident" id="1602222">rt</span><span class="op" id="1602224">.</span><span class="ident" id="1602225">arg</span>&nbsp;<span class="op" id="1602229">=</span>&nbsp;<span class="ident" id="1602231">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602236">pd</span><span class="op" id="1602238">.</span><span class="ident" id="1602239">rt</span><span class="op" id="1602241">.</span><span class="ident" id="1602242">seq</span>&nbsp;<span class="op" id="1602246">=</span>&nbsp;<span class="ident" id="1602248">pd</span><span class="op" id="1602250">.</span><span class="ident" id="1602251">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602257">addtimer</span><span class="op" id="1602265">(</span><span class="op" id="1602266">&amp;</span><span class="ident" id="1602267">pd</span><span class="op" id="1602269">.</span><span class="ident" id="1602270">rt</span><span class="op" id="1602272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1602275">}</span>&nbsp;<span class="keyword" id="1602277">else</span>&nbsp;<span class="op" id="1602282">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1602286">if</span>&nbsp;<span class="ident" id="1602289">pd</span><span class="op" id="1602291">.</span><span class="ident" id="1602292">rd</span>&nbsp;<span class="op" id="1602295">&gt;</span>&nbsp;<span class="num" id="1602297">0</span>&nbsp;<span class="op" id="1602299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602304">pd</span><span class="op" id="1602306">.</span><span class="ident" id="1602307">rt</span><span class="op" id="1602309">.</span><span class="ident" id="1602310">f</span>&nbsp;<span class="op" id="1602312">=</span>&nbsp;<span class="ident" id="1602314">netpollReadDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602337">pd</span><span class="op" id="1602339">.</span><span class="ident" id="1602340">rt</span><span class="op" id="1602342">.</span><span class="ident" id="1602343">when</span>&nbsp;<span class="op" id="1602348">=</span>&nbsp;<span class="ident" id="1602350">pd</span><span class="op" id="1602352">.</span><span class="ident" id="1602353">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602359">pd</span><span class="op" id="1602361">.</span><span class="ident" id="1602362">rt</span><span class="op" id="1602364">.</span><span class="ident" id="1602365">arg</span>&nbsp;<span class="op" id="1602369">=</span>&nbsp;<span class="ident" id="1602371">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602377">pd</span><span class="op" id="1602379">.</span><span class="ident" id="1602380">rt</span><span class="op" id="1602382">.</span><span class="ident" id="1602383">seq</span>&nbsp;<span class="op" id="1602387">=</span>&nbsp;<span class="ident" id="1602389">pd</span><span class="op" id="1602391">.</span><span class="ident" id="1602392">seq</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602399">addtimer</span><span class="op" id="1602407">(</span><span class="op" id="1602408">&amp;</span><span class="ident" id="1602409">pd</span><span class="op" id="1602411">.</span><span class="ident" id="1602412">rt</span><span class="op" id="1602414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1602418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1602422">if</span>&nbsp;<span class="ident" id="1602425">pd</span><span class="op" id="1602427">.</span><span class="ident" id="1602428">wd</span>&nbsp;<span class="op" id="1602431">&gt;</span>&nbsp;<span class="num" id="1602433">0</span>&nbsp;<span class="op" id="1602435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602440">pd</span><span class="op" id="1602442">.</span><span class="ident" id="1602443">wt</span><span class="op" id="1602445">.</span><span class="ident" id="1602446">f</span>&nbsp;<span class="op" id="1602448">=</span>&nbsp;<span class="ident" id="1602450">netpollWriteDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602474">pd</span><span class="op" id="1602476">.</span><span class="ident" id="1602477">wt</span><span class="op" id="1602479">.</span><span class="ident" id="1602480">when</span>&nbsp;<span class="op" id="1602485">=</span>&nbsp;<span class="ident" id="1602487">pd</span><span class="op" id="1602489">.</span><span class="ident" id="1602490">wd</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602496">pd</span><span class="op" id="1602498">.</span><span class="ident" id="1602499">wt</span><span class="op" id="1602501">.</span><span class="ident" id="1602502">arg</span>&nbsp;<span class="op" id="1602506">=</span>&nbsp;<span class="ident" id="1602508">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602514">pd</span><span class="op" id="1602516">.</span><span class="ident" id="1602517">wt</span><span class="op" id="1602519">.</span><span class="ident" id="1602520">seq</span>&nbsp;<span class="op" id="1602524">=</span>&nbsp;<span class="ident" id="1602526">pd</span><span class="op" id="1602528">.</span><span class="ident" id="1602529">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602536">addtimer</span><span class="op" id="1602544">(</span><span class="op" id="1602545">&amp;</span><span class="ident" id="1602546">pd</span><span class="op" id="1602548">.</span><span class="ident" id="1602549">wt</span><span class="op" id="1602551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1602555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1602558">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1602561">//&nbsp;If&nbsp;we&nbsp;set&nbsp;the&nbsp;new&nbsp;deadline&nbsp;in&nbsp;the&nbsp;past,&nbsp;unblock&nbsp;currently&nbsp;pending&nbsp;IO&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1602642">var</span>&nbsp;<span class="ident" id="1602646">rg</span><span class="op" id="1602648">,</span>&nbsp;<span class="ident" id="1602650">wg</span>&nbsp;<span class="op" id="1602653">*</span><span class="ident" id="1602654">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602657">atomicstorep</span><span class="op" id="1602669">(</span><span class="ident" id="1602670">unsafe</span><span class="op" id="1602676">.</span><span class="ident" id="1602677">Pointer</span><span class="op" id="1602684">(</span><span class="op" id="1602685">&amp;</span><span class="ident" id="1602686">wg</span><span class="op" id="1602688">)</span><span class="op" id="1602689">,</span>&nbsp;<span class="builtintype" id="1602691">nil</span><span class="op" id="1602694">)</span>&nbsp;<span class="comment" id="1602696">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;stores&nbsp;to&nbsp;rd/wd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1602780">if</span>&nbsp;<span class="ident" id="1602783">pd</span><span class="op" id="1602785">.</span><span class="ident" id="1602786">rd</span>&nbsp;<span class="op" id="1602789">&lt;</span>&nbsp;<span class="num" id="1602791">0</span>&nbsp;<span class="op" id="1602793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602797">rg</span>&nbsp;<span class="op" id="1602800">=</span>&nbsp;<span class="ident" id="1602802">netpollunblock</span><span class="op" id="1602816">(</span><span class="ident" id="1602817">pd</span><span class="op" id="1602819">,</span>&nbsp;<span class="string" id="1602821">&#39;r&#39;</span><span class="op" id="1602824">,</span>&nbsp;<span class="builtintype" id="1602826">false</span><span class="op" id="1602831">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1602834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1602837">if</span>&nbsp;<span class="ident" id="1602840">pd</span><span class="op" id="1602842">.</span><span class="ident" id="1602843">wd</span>&nbsp;<span class="op" id="1602846">&lt;</span>&nbsp;<span class="num" id="1602848">0</span>&nbsp;<span class="op" id="1602850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602854">wg</span>&nbsp;<span class="op" id="1602857">=</span>&nbsp;<span class="ident" id="1602859">netpollunblock</span><span class="op" id="1602873">(</span><span class="ident" id="1602874">pd</span><span class="op" id="1602876">,</span>&nbsp;<span class="string" id="1602878">&#39;w&#39;</span><span class="op" id="1602881">,</span>&nbsp;<span class="builtintype" id="1602883">false</span><span class="op" id="1602888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1602891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602894">unlock</span><span class="op" id="1602900">(</span><span class="op" id="1602901">&amp;</span><span class="ident" id="1602902">pd</span><span class="op" id="1602904">.</span><span class="ident" id="1602905">lock</span><span class="op" id="1602909">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1602912">if</span>&nbsp;<span class="ident" id="1602915">rg</span>&nbsp;<span class="op" id="1602918">!=</span>&nbsp;<span class="builtintype" id="1602921">nil</span>&nbsp;<span class="op" id="1602925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602929">goready</span><span class="op" id="1602936">(</span><span class="ident" id="1602937">rg</span><span class="op" id="1602939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1602942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1602945">if</span>&nbsp;<span class="ident" id="1602948">wg</span>&nbsp;<span class="op" id="1602951">!=</span>&nbsp;<span class="builtintype" id="1602954">nil</span>&nbsp;<span class="op" id="1602958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1602962">goready</span><span class="op" id="1602969">(</span><span class="ident" id="1602970">wg</span><span class="op" id="1602972">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1602975">}</span><br>
<span class="lineno"></span><span class="op" id="1602977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1602980">func</span>&nbsp;<span class="ident" id="1602985">netpollUnblock</span><span class="op" id="1602999">(</span><span class="ident" id="1603000">pd</span>&nbsp;<span class="op" id="1603003">*</span><span class="ident" id="1603004">pollDesc</span><span class="op" id="1603012">)</span>&nbsp;<span class="op" id="1603014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603017">lock</span><span class="op" id="1603021">(</span><span class="op" id="1603022">&amp;</span><span class="ident" id="1603023">pd</span><span class="op" id="1603025">.</span><span class="ident" id="1603026">lock</span><span class="op" id="1603030">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1603033">if</span>&nbsp;<span class="ident" id="1603036">pd</span><span class="op" id="1603038">.</span><span class="ident" id="1603039">closing</span>&nbsp;<span class="op" id="1603047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603051">gothrow</span><span class="op" id="1603058">(</span><span class="string" id="1603059">&#34;netpollUnblock:&nbsp;already&nbsp;closing&#34;</span><span class="op" id="1603092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1603095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603098">pd</span><span class="op" id="1603100">.</span><span class="ident" id="1603101">closing</span>&nbsp;<span class="op" id="1603109">=</span>&nbsp;<span class="builtintype" id="1603111">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603117">pd</span><span class="op" id="1603119">.</span><span class="ident" id="1603120">seq</span><span class="op" id="1603123">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1603127">var</span>&nbsp;<span class="ident" id="1603131">rg</span><span class="op" id="1603133">,</span>&nbsp;<span class="ident" id="1603135">wg</span>&nbsp;<span class="op" id="1603138">*</span><span class="ident" id="1603139">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603142">atomicstorep</span><span class="op" id="1603154">(</span><span class="ident" id="1603155">unsafe</span><span class="op" id="1603161">.</span><span class="ident" id="1603162">Pointer</span><span class="op" id="1603169">(</span><span class="op" id="1603170">&amp;</span><span class="ident" id="1603171">rg</span><span class="op" id="1603173">)</span><span class="op" id="1603174">,</span>&nbsp;<span class="builtintype" id="1603176">nil</span><span class="op" id="1603179">)</span>&nbsp;<span class="comment" id="1603181">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;closing&nbsp;and&nbsp;read&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603266">rg</span>&nbsp;<span class="op" id="1603269">=</span>&nbsp;<span class="ident" id="1603271">netpollunblock</span><span class="op" id="1603285">(</span><span class="ident" id="1603286">pd</span><span class="op" id="1603288">,</span>&nbsp;<span class="string" id="1603290">&#39;r&#39;</span><span class="op" id="1603293">,</span>&nbsp;<span class="builtintype" id="1603295">false</span><span class="op" id="1603300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603303">wg</span>&nbsp;<span class="op" id="1603306">=</span>&nbsp;<span class="ident" id="1603308">netpollunblock</span><span class="op" id="1603322">(</span><span class="ident" id="1603323">pd</span><span class="op" id="1603325">,</span>&nbsp;<span class="string" id="1603327">&#39;w&#39;</span><span class="op" id="1603330">,</span>&nbsp;<span class="builtintype" id="1603332">false</span><span class="op" id="1603337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1603340">if</span>&nbsp;<span class="ident" id="1603343">pd</span><span class="op" id="1603345">.</span><span class="ident" id="1603346">rt</span><span class="op" id="1603348">.</span><span class="ident" id="1603349">f</span>&nbsp;<span class="op" id="1603351">!=</span>&nbsp;<span class="builtintype" id="1603354">nil</span>&nbsp;<span class="op" id="1603358">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603362">deltimer</span><span class="op" id="1603370">(</span><span class="op" id="1603371">&amp;</span><span class="ident" id="1603372">pd</span><span class="op" id="1603374">.</span><span class="ident" id="1603375">rt</span><span class="op" id="1603377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603381">pd</span><span class="op" id="1603383">.</span><span class="ident" id="1603384">rt</span><span class="op" id="1603386">.</span><span class="ident" id="1603387">f</span>&nbsp;<span class="op" id="1603389">=</span>&nbsp;<span class="builtintype" id="1603391">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1603396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1603399">if</span>&nbsp;<span class="ident" id="1603402">pd</span><span class="op" id="1603404">.</span><span class="ident" id="1603405">wt</span><span class="op" id="1603407">.</span><span class="ident" id="1603408">f</span>&nbsp;<span class="op" id="1603410">!=</span>&nbsp;<span class="builtintype" id="1603413">nil</span>&nbsp;<span class="op" id="1603417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603421">deltimer</span><span class="op" id="1603429">(</span><span class="op" id="1603430">&amp;</span><span class="ident" id="1603431">pd</span><span class="op" id="1603433">.</span><span class="ident" id="1603434">wt</span><span class="op" id="1603436">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603440">pd</span><span class="op" id="1603442">.</span><span class="ident" id="1603443">wt</span><span class="op" id="1603445">.</span><span class="ident" id="1603446">f</span>&nbsp;<span class="op" id="1603448">=</span>&nbsp;<span class="builtintype" id="1603450">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1603455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603458">unlock</span><span class="op" id="1603464">(</span><span class="op" id="1603465">&amp;</span><span class="ident" id="1603466">pd</span><span class="op" id="1603468">.</span><span class="ident" id="1603469">lock</span><span class="op" id="1603473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1603476">if</span>&nbsp;<span class="ident" id="1603479">rg</span>&nbsp;<span class="op" id="1603482">!=</span>&nbsp;<span class="builtintype" id="1603485">nil</span>&nbsp;<span class="op" id="1603489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603493">goready</span><span class="op" id="1603500">(</span><span class="ident" id="1603501">rg</span><span class="op" id="1603503">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1603506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1603509">if</span>&nbsp;<span class="ident" id="1603512">wg</span>&nbsp;<span class="op" id="1603515">!=</span>&nbsp;<span class="builtintype" id="1603518">nil</span>&nbsp;<span class="op" id="1603522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603526">goready</span><span class="op" id="1603533">(</span><span class="ident" id="1603534">wg</span><span class="op" id="1603536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1603539">}</span><br>
<span class="lineno"></span><span class="op" id="1603541">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="1603544">func</span>&nbsp;<span class="ident" id="1603549">netpollfd</span><span class="op" id="1603558">(</span><span class="ident" id="1603559">pd</span>&nbsp;<span class="op" id="1603562">*</span><span class="ident" id="1603563">pollDesc</span><span class="op" id="1603571">)</span>&nbsp;<span class="builtintype" id="1603573">uintptr</span>&nbsp;<span class="op" id="1603581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1603584">return</span>&nbsp;<span class="ident" id="1603591">pd</span><span class="op" id="1603593">.</span><span class="ident" id="1603594">fd</span><br>
<span class="lineno"></span><span class="op" id="1603597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1603600">func</span>&nbsp;<span class="ident" id="1603605">netpolluser</span><span class="op" id="1603616">(</span><span class="ident" id="1603617">pd</span>&nbsp;<span class="op" id="1603620">*</span><span class="ident" id="1603621">pollDesc</span><span class="op" id="1603629">)</span>&nbsp;<span class="op" id="1603631">*</span><span class="ident" id="1603632">unsafe</span><span class="op" id="1603638">.</span><span class="ident" id="1603639">Pointer</span>&nbsp;<span class="op" id="1603647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1603650">return</span>&nbsp;<span class="op" id="1603657">&amp;</span><span class="ident" id="1603658">pd</span><span class="op" id="1603660">.</span><span class="ident" id="1603661">user</span><br>
<span class="lineno"></span><span class="op" id="1603666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1603669">func</span>&nbsp;<span class="ident" id="1603674">netpollclosing</span><span class="op" id="1603688">(</span><span class="ident" id="1603689">pd</span>&nbsp;<span class="op" id="1603692">*</span><span class="ident" id="1603693">pollDesc</span><span class="op" id="1603701">)</span>&nbsp;<span class="builtintype" id="1603703">bool</span>&nbsp;<span class="op" id="1603708">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1603711">return</span>&nbsp;<span class="ident" id="1603718">pd</span><span class="op" id="1603720">.</span><span class="ident" id="1603721">closing</span><br>
<span class="lineno"></span><span class="op" id="1603729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1603732">func</span>&nbsp;<span class="ident" id="1603737">netpolllock</span><span class="op" id="1603748">(</span><span class="ident" id="1603749">pd</span>&nbsp;<span class="op" id="1603752">*</span><span class="ident" id="1603753">pollDesc</span><span class="op" id="1603761">)</span>&nbsp;<span class="op" id="1603763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603766">lock</span><span class="op" id="1603770">(</span><span class="op" id="1603771">&amp;</span><span class="ident" id="1603772">pd</span><span class="op" id="1603774">.</span><span class="ident" id="1603775">lock</span><span class="op" id="1603779">)</span><br>
<span class="lineno">280</span><span class="op" id="1603781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1603784">func</span>&nbsp;<span class="ident" id="1603789">netpollunlock</span><span class="op" id="1603802">(</span><span class="ident" id="1603803">pd</span>&nbsp;<span class="op" id="1603806">*</span><span class="ident" id="1603807">pollDesc</span><span class="op" id="1603815">)</span>&nbsp;<span class="op" id="1603817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1603820">unlock</span><span class="op" id="1603826">(</span><span class="op" id="1603827">&amp;</span><span class="ident" id="1603828">pd</span><span class="op" id="1603830">.</span><span class="ident" id="1603831">lock</span><span class="op" id="1603835">)</span><br>
<span class="lineno"></span><span class="op" id="1603837">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="1603840">//&nbsp;make&nbsp;pd&nbsp;ready,&nbsp;newly&nbsp;runnable&nbsp;goroutines&nbsp;(if&nbsp;any)&nbsp;are&nbsp;returned&nbsp;in&nbsp;rg/wg</span><br>
<span class="lineno"></span><span class="keyword" id="1603915">func</span>&nbsp;<span class="ident" id="1603920">netpollready</span><span class="op" id="1603932">(</span><span class="ident" id="1603933">gpp</span>&nbsp;<span class="op" id="1603937">*</span><span class="op" id="1603938">*</span><span class="ident" id="1603939">g</span><span class="op" id="1603940">,</span>&nbsp;<span class="ident" id="1603942">pd</span>&nbsp;<span class="op" id="1603945">*</span><span class="ident" id="1603946">pollDesc</span><span class="op" id="1603954">,</span>&nbsp;<span class="ident" id="1603956">mode</span>&nbsp;<span class="builtintype" id="1603961">int32</span><span class="op" id="1603966">)</span>&nbsp;<span class="op" id="1603968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1603971">var</span>&nbsp;<span class="ident" id="1603975">rg</span><span class="op" id="1603977">,</span>&nbsp;<span class="ident" id="1603979">wg</span>&nbsp;<span class="op" id="1603982">*</span><span class="ident" id="1603983">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1603986">if</span>&nbsp;<span class="ident" id="1603989">mode</span>&nbsp;<span class="op" id="1603994">==</span>&nbsp;<span class="string" id="1603997">&#39;r&#39;</span>&nbsp;<span class="op" id="1604001">||</span>&nbsp;<span class="ident" id="1604004">mode</span>&nbsp;<span class="op" id="1604009">==</span>&nbsp;<span class="string" id="1604012">&#39;r&#39;</span><span class="op" id="1604015">+</span><span class="string" id="1604016">&#39;w&#39;</span>&nbsp;<span class="op" id="1604020">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604024">rg</span>&nbsp;<span class="op" id="1604027">=</span>&nbsp;<span class="ident" id="1604029">netpollunblock</span><span class="op" id="1604043">(</span><span class="ident" id="1604044">pd</span><span class="op" id="1604046">,</span>&nbsp;<span class="string" id="1604048">&#39;r&#39;</span><span class="op" id="1604051">,</span>&nbsp;<span class="builtintype" id="1604053">true</span><span class="op" id="1604057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1604060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604063">if</span>&nbsp;<span class="ident" id="1604066">mode</span>&nbsp;<span class="op" id="1604071">==</span>&nbsp;<span class="string" id="1604074">&#39;w&#39;</span>&nbsp;<span class="op" id="1604078">||</span>&nbsp;<span class="ident" id="1604081">mode</span>&nbsp;<span class="op" id="1604086">==</span>&nbsp;<span class="string" id="1604089">&#39;r&#39;</span><span class="op" id="1604092">+</span><span class="string" id="1604093">&#39;w&#39;</span>&nbsp;<span class="op" id="1604097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604101">wg</span>&nbsp;<span class="op" id="1604104">=</span>&nbsp;<span class="ident" id="1604106">netpollunblock</span><span class="op" id="1604120">(</span><span class="ident" id="1604121">pd</span><span class="op" id="1604123">,</span>&nbsp;<span class="string" id="1604125">&#39;w&#39;</span><span class="op" id="1604128">,</span>&nbsp;<span class="builtintype" id="1604130">true</span><span class="op" id="1604134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1604137">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604140">if</span>&nbsp;<span class="ident" id="1604143">rg</span>&nbsp;<span class="op" id="1604146">!=</span>&nbsp;<span class="builtintype" id="1604149">nil</span>&nbsp;<span class="op" id="1604153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604157">rg</span><span class="op" id="1604159">.</span><span class="ident" id="1604160">schedlink</span>&nbsp;<span class="op" id="1604170">=</span>&nbsp;<span class="op" id="1604172">*</span><span class="ident" id="1604173">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1604179">*</span><span class="ident" id="1604180">gpp</span>&nbsp;<span class="op" id="1604184">=</span>&nbsp;<span class="ident" id="1604186">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1604190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604193">if</span>&nbsp;<span class="ident" id="1604196">wg</span>&nbsp;<span class="op" id="1604199">!=</span>&nbsp;<span class="builtintype" id="1604202">nil</span>&nbsp;<span class="op" id="1604206">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604210">wg</span><span class="op" id="1604212">.</span><span class="ident" id="1604213">schedlink</span>&nbsp;<span class="op" id="1604223">=</span>&nbsp;<span class="op" id="1604225">*</span><span class="ident" id="1604226">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1604232">*</span><span class="ident" id="1604233">gpp</span>&nbsp;<span class="op" id="1604237">=</span>&nbsp;<span class="ident" id="1604239">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1604243">}</span><br>
<span class="lineno"></span><span class="op" id="1604245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="keyword" id="1604248">func</span>&nbsp;<span class="ident" id="1604253">netpollcheckerr</span><span class="op" id="1604268">(</span><span class="ident" id="1604269">pd</span>&nbsp;<span class="op" id="1604272">*</span><span class="ident" id="1604273">pollDesc</span><span class="op" id="1604281">,</span>&nbsp;<span class="ident" id="1604283">mode</span>&nbsp;<span class="builtintype" id="1604288">int32</span><span class="op" id="1604293">)</span>&nbsp;<span class="builtintype" id="1604295">int</span>&nbsp;<span class="op" id="1604299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604302">if</span>&nbsp;<span class="ident" id="1604305">pd</span><span class="op" id="1604307">.</span><span class="ident" id="1604308">closing</span>&nbsp;<span class="op" id="1604316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604320">return</span>&nbsp;<span class="num" id="1604327">1</span>&nbsp;<span class="comment" id="1604329">//&nbsp;errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1604344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604347">if</span>&nbsp;<span class="op" id="1604350">(</span><span class="ident" id="1604351">mode</span>&nbsp;<span class="op" id="1604356">==</span>&nbsp;<span class="string" id="1604359">&#39;r&#39;</span>&nbsp;<span class="op" id="1604363">&amp;&amp;</span>&nbsp;<span class="ident" id="1604366">pd</span><span class="op" id="1604368">.</span><span class="ident" id="1604369">rd</span>&nbsp;<span class="op" id="1604372">&lt;</span>&nbsp;<span class="num" id="1604374">0</span><span class="op" id="1604375">)</span>&nbsp;<span class="op" id="1604377">||</span>&nbsp;<span class="op" id="1604380">(</span><span class="ident" id="1604381">mode</span>&nbsp;<span class="op" id="1604386">==</span>&nbsp;<span class="string" id="1604389">&#39;w&#39;</span>&nbsp;<span class="op" id="1604393">&amp;&amp;</span>&nbsp;<span class="ident" id="1604396">pd</span><span class="op" id="1604398">.</span><span class="ident" id="1604399">wd</span>&nbsp;<span class="op" id="1604402">&lt;</span>&nbsp;<span class="num" id="1604404">0</span><span class="op" id="1604405">)</span>&nbsp;<span class="op" id="1604407">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604411">return</span>&nbsp;<span class="num" id="1604418">2</span>&nbsp;<span class="comment" id="1604420">//&nbsp;errTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1604435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604438">return</span>&nbsp;<span class="num" id="1604445">0</span><br>
<span class="lineno"></span><span class="op" id="1604447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="keyword" id="1604450">func</span>&nbsp;<span class="ident" id="1604455">netpollblockcommit</span><span class="op" id="1604473">(</span><span class="ident" id="1604474">gp</span>&nbsp;<span class="op" id="1604477">*</span><span class="ident" id="1604478">g</span><span class="op" id="1604479">,</span>&nbsp;<span class="ident" id="1604481">gpp</span>&nbsp;<span class="ident" id="1604485">unsafe</span><span class="op" id="1604491">.</span><span class="ident" id="1604492">Pointer</span><span class="op" id="1604499">)</span>&nbsp;<span class="builtintype" id="1604501">bool</span>&nbsp;<span class="op" id="1604506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604509">return</span>&nbsp;<span class="ident" id="1604516">casuintptr</span><span class="op" id="1604526">(</span><span class="op" id="1604527">(</span><span class="op" id="1604528">*</span><span class="builtintype" id="1604529">uintptr</span><span class="op" id="1604536">)</span><span class="op" id="1604537">(</span><span class="ident" id="1604538">gpp</span><span class="op" id="1604541">)</span><span class="op" id="1604542">,</span>&nbsp;<span class="ident" id="1604544">pdWait</span><span class="op" id="1604550">,</span>&nbsp;<span class="builtintype" id="1604552">uintptr</span><span class="op" id="1604559">(</span><span class="ident" id="1604560">unsafe</span><span class="op" id="1604566">.</span><span class="ident" id="1604567">Pointer</span><span class="op" id="1604574">(</span><span class="ident" id="1604575">gp</span><span class="op" id="1604577">)</span><span class="op" id="1604578">)</span><span class="op" id="1604579">)</span><br>
<span class="lineno"></span><span class="op" id="1604581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1604584">//&nbsp;returns&nbsp;true&nbsp;if&nbsp;IO&nbsp;is&nbsp;ready,&nbsp;or&nbsp;false&nbsp;if&nbsp;timedout&nbsp;or&nbsp;closed</span><br>
<span class="lineno">320</span><span class="comment" id="1604647">//&nbsp;waitio&nbsp;-&nbsp;wait&nbsp;only&nbsp;for&nbsp;completed&nbsp;IO,&nbsp;ignore&nbsp;errors</span><br>
<span class="lineno"></span><span class="keyword" id="1604701">func</span>&nbsp;<span class="ident" id="1604706">netpollblock</span><span class="op" id="1604718">(</span><span class="ident" id="1604719">pd</span>&nbsp;<span class="op" id="1604722">*</span><span class="ident" id="1604723">pollDesc</span><span class="op" id="1604731">,</span>&nbsp;<span class="ident" id="1604733">mode</span>&nbsp;<span class="builtintype" id="1604738">int32</span><span class="op" id="1604743">,</span>&nbsp;<span class="ident" id="1604745">waitio</span>&nbsp;<span class="builtintype" id="1604752">bool</span><span class="op" id="1604756">)</span>&nbsp;<span class="builtintype" id="1604758">bool</span>&nbsp;<span class="op" id="1604763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604766">gpp</span>&nbsp;<span class="op" id="1604770">:=</span>&nbsp;<span class="op" id="1604773">&amp;</span><span class="ident" id="1604774">pd</span><span class="op" id="1604776">.</span><span class="ident" id="1604777">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604781">if</span>&nbsp;<span class="ident" id="1604784">mode</span>&nbsp;<span class="op" id="1604789">==</span>&nbsp;<span class="string" id="1604792">&#39;w&#39;</span>&nbsp;<span class="op" id="1604796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604800">gpp</span>&nbsp;<span class="op" id="1604804">=</span>&nbsp;<span class="op" id="1604806">&amp;</span><span class="ident" id="1604807">pd</span><span class="op" id="1604809">.</span><span class="ident" id="1604810">wg</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1604814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1604818">//&nbsp;set&nbsp;the&nbsp;gpp&nbsp;semaphore&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604852">for</span>&nbsp;<span class="op" id="1604856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604860">old</span>&nbsp;<span class="op" id="1604864">:=</span>&nbsp;<span class="op" id="1604867">*</span><span class="ident" id="1604868">gpp</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604874">if</span>&nbsp;<span class="ident" id="1604877">old</span>&nbsp;<span class="op" id="1604881">==</span>&nbsp;<span class="ident" id="1604884">pdReady</span>&nbsp;<span class="op" id="1604892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1604897">*</span><span class="ident" id="1604898">gpp</span>&nbsp;<span class="op" id="1604902">=</span>&nbsp;<span class="num" id="1604904">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604909">return</span>&nbsp;<span class="builtintype" id="1604916">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1604923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604927">if</span>&nbsp;<span class="ident" id="1604930">old</span>&nbsp;<span class="op" id="1604934">!=</span>&nbsp;<span class="num" id="1604937">0</span>&nbsp;<span class="op" id="1604939">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1604944">gothrow</span><span class="op" id="1604951">(</span><span class="string" id="1604952">&#34;netpollblock:&nbsp;double&nbsp;wait&#34;</span><span class="op" id="1604979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1604983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1604987">if</span>&nbsp;<span class="ident" id="1604990">casuintptr</span><span class="op" id="1605000">(</span><span class="ident" id="1605001">gpp</span><span class="op" id="1605004">,</span>&nbsp;<span class="num" id="1605006">0</span><span class="op" id="1605007">,</span>&nbsp;<span class="ident" id="1605009">pdWait</span><span class="op" id="1605015">)</span>&nbsp;<span class="op" id="1605017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605022">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605030">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1605037">//&nbsp;need&nbsp;to&nbsp;recheck&nbsp;error&nbsp;states&nbsp;after&nbsp;setting&nbsp;gpp&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1605096">//&nbsp;this&nbsp;is&nbsp;necessary&nbsp;because&nbsp;runtime_pollUnblock/runtime_pollSetDeadline/deadlineimpl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1605183">//&nbsp;do&nbsp;the&nbsp;opposite:&nbsp;store&nbsp;to&nbsp;closing/rd/wd,&nbsp;membarrier,&nbsp;load&nbsp;of&nbsp;rg/wg</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605254">if</span>&nbsp;<span class="ident" id="1605257">waitio</span>&nbsp;<span class="op" id="1605264">||</span>&nbsp;<span class="ident" id="1605267">netpollcheckerr</span><span class="op" id="1605282">(</span><span class="ident" id="1605283">pd</span><span class="op" id="1605285">,</span>&nbsp;<span class="ident" id="1605287">mode</span><span class="op" id="1605291">)</span>&nbsp;<span class="op" id="1605293">==</span>&nbsp;<span class="num" id="1605296">0</span>&nbsp;<span class="op" id="1605298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605302">f</span>&nbsp;<span class="op" id="1605304">:=</span>&nbsp;<span class="ident" id="1605307">netpollblockcommit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605328">gopark</span><span class="op" id="1605334">(</span><span class="op" id="1605335">*</span><span class="op" id="1605336">*</span><span class="op" id="1605337">(</span><span class="op" id="1605338">*</span><span class="op" id="1605339">*</span><span class="ident" id="1605340">unsafe</span><span class="op" id="1605346">.</span><span class="ident" id="1605347">Pointer</span><span class="op" id="1605354">)</span><span class="op" id="1605355">(</span><span class="ident" id="1605356">unsafe</span><span class="op" id="1605362">.</span><span class="ident" id="1605363">Pointer</span><span class="op" id="1605370">(</span><span class="op" id="1605371">&amp;</span><span class="ident" id="1605372">f</span><span class="op" id="1605373">)</span><span class="op" id="1605374">)</span><span class="op" id="1605375">,</span>&nbsp;<span class="ident" id="1605377">unsafe</span><span class="op" id="1605383">.</span><span class="ident" id="1605384">Pointer</span><span class="op" id="1605391">(</span><span class="ident" id="1605392">gpp</span><span class="op" id="1605395">)</span><span class="op" id="1605396">,</span>&nbsp;<span class="string" id="1605398">&#34;IO&nbsp;wait&#34;</span><span class="op" id="1605407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1605413">//&nbsp;be&nbsp;careful&nbsp;to&nbsp;not&nbsp;lose&nbsp;concurrent&nbsp;READY&nbsp;notification</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605470">old</span>&nbsp;<span class="op" id="1605474">:=</span>&nbsp;<span class="ident" id="1605477">xchguintptr</span><span class="op" id="1605488">(</span><span class="ident" id="1605489">gpp</span><span class="op" id="1605492">,</span>&nbsp;<span class="num" id="1605494">0</span><span class="op" id="1605495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605498">if</span>&nbsp;<span class="ident" id="1605501">old</span>&nbsp;<span class="op" id="1605505">&gt;</span>&nbsp;<span class="ident" id="1605507">pdWait</span>&nbsp;<span class="op" id="1605514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605518">gothrow</span><span class="op" id="1605525">(</span><span class="string" id="1605526">&#34;netpollblock:&nbsp;corrupted&nbsp;state&#34;</span><span class="op" id="1605557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605563">return</span>&nbsp;<span class="ident" id="1605570">old</span>&nbsp;<span class="op" id="1605574">==</span>&nbsp;<span class="ident" id="1605577">pdReady</span><br>
<span class="lineno">355</span><span class="op" id="1605585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1605588">func</span>&nbsp;<span class="ident" id="1605593">netpollunblock</span><span class="op" id="1605607">(</span><span class="ident" id="1605608">pd</span>&nbsp;<span class="op" id="1605611">*</span><span class="ident" id="1605612">pollDesc</span><span class="op" id="1605620">,</span>&nbsp;<span class="ident" id="1605622">mode</span>&nbsp;<span class="builtintype" id="1605627">int32</span><span class="op" id="1605632">,</span>&nbsp;<span class="ident" id="1605634">ioready</span>&nbsp;<span class="builtintype" id="1605642">bool</span><span class="op" id="1605646">)</span>&nbsp;<span class="op" id="1605648">*</span><span class="ident" id="1605649">g</span>&nbsp;<span class="op" id="1605651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605654">gpp</span>&nbsp;<span class="op" id="1605658">:=</span>&nbsp;<span class="op" id="1605661">&amp;</span><span class="ident" id="1605662">pd</span><span class="op" id="1605664">.</span><span class="ident" id="1605665">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605669">if</span>&nbsp;<span class="ident" id="1605672">mode</span>&nbsp;<span class="op" id="1605677">==</span>&nbsp;<span class="string" id="1605680">&#39;w&#39;</span>&nbsp;<span class="op" id="1605684">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605688">gpp</span>&nbsp;<span class="op" id="1605692">=</span>&nbsp;<span class="op" id="1605694">&amp;</span><span class="ident" id="1605695">pd</span><span class="op" id="1605697">.</span><span class="ident" id="1605698">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605706">for</span>&nbsp;<span class="op" id="1605710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1605714">old</span>&nbsp;<span class="op" id="1605718">:=</span>&nbsp;<span class="op" id="1605721">*</span><span class="ident" id="1605722">gpp</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605728">if</span>&nbsp;<span class="ident" id="1605731">old</span>&nbsp;<span class="op" id="1605735">==</span>&nbsp;<span class="ident" id="1605738">pdReady</span>&nbsp;<span class="op" id="1605746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605751">return</span>&nbsp;<span class="builtintype" id="1605758">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605768">if</span>&nbsp;<span class="ident" id="1605771">old</span>&nbsp;<span class="op" id="1605775">==</span>&nbsp;<span class="num" id="1605778">0</span>&nbsp;<span class="op" id="1605780">&amp;&amp;</span>&nbsp;<span class="op" id="1605783">!</span><span class="ident" id="1605784">ioready</span>&nbsp;<span class="op" id="1605792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1605797">//&nbsp;Only&nbsp;set&nbsp;READY&nbsp;for&nbsp;ioready.&nbsp;runtime_pollWait</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1605848">//&nbsp;will&nbsp;check&nbsp;for&nbsp;timeout/cancel&nbsp;before&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605900">return</span>&nbsp;<span class="builtintype" id="1605907">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605917">var</span>&nbsp;<span class="builtinfunc" id="1605921">new</span>&nbsp;<span class="builtintype" id="1605925">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605935">if</span>&nbsp;<span class="ident" id="1605938">ioready</span>&nbsp;<span class="op" id="1605946">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1605951">new</span>&nbsp;<span class="op" id="1605955">=</span>&nbsp;<span class="ident" id="1605957">pdReady</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1605967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1605971">if</span>&nbsp;<span class="ident" id="1605974">casuintptr</span><span class="op" id="1605984">(</span><span class="ident" id="1605985">gpp</span><span class="op" id="1605988">,</span>&nbsp;<span class="ident" id="1605990">old</span><span class="op" id="1605993">,</span>&nbsp;<span class="builtinfunc" id="1605995">new</span><span class="op" id="1605998">)</span>&nbsp;<span class="op" id="1606000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606005">if</span>&nbsp;<span class="ident" id="1606008">old</span>&nbsp;<span class="op" id="1606012">==</span>&nbsp;<span class="ident" id="1606015">pdReady</span>&nbsp;<span class="op" id="1606023">||</span>&nbsp;<span class="ident" id="1606026">old</span>&nbsp;<span class="op" id="1606030">==</span>&nbsp;<span class="ident" id="1606033">pdWait</span>&nbsp;<span class="op" id="1606040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606046">old</span>&nbsp;<span class="op" id="1606050">=</span>&nbsp;<span class="num" id="1606052">0</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606062">return</span>&nbsp;<span class="op" id="1606069">(</span><span class="op" id="1606070">*</span><span class="ident" id="1606071">g</span><span class="op" id="1606072">)</span><span class="op" id="1606073">(</span><span class="ident" id="1606074">unsafe</span><span class="op" id="1606080">.</span><span class="ident" id="1606081">Pointer</span><span class="op" id="1606088">(</span><span class="ident" id="1606089">old</span><span class="op" id="1606092">)</span><span class="op" id="1606093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606100">}</span><br>
<span class="lineno"></span><span class="op" id="1606102">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span><span class="keyword" id="1606105">func</span>&nbsp;<span class="ident" id="1606110">netpolldeadlineimpl</span><span class="op" id="1606129">(</span><span class="ident" id="1606130">pd</span>&nbsp;<span class="op" id="1606133">*</span><span class="ident" id="1606134">pollDesc</span><span class="op" id="1606142">,</span>&nbsp;<span class="ident" id="1606144">seq</span>&nbsp;<span class="builtintype" id="1606148">uintptr</span><span class="op" id="1606155">,</span>&nbsp;<span class="ident" id="1606157">read</span><span class="op" id="1606161">,</span>&nbsp;<span class="ident" id="1606163">write</span>&nbsp;<span class="builtintype" id="1606169">bool</span><span class="op" id="1606173">)</span>&nbsp;<span class="op" id="1606175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606178">lock</span><span class="op" id="1606182">(</span><span class="op" id="1606183">&amp;</span><span class="ident" id="1606184">pd</span><span class="op" id="1606186">.</span><span class="ident" id="1606187">lock</span><span class="op" id="1606191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1606194">//&nbsp;Seq&nbsp;arg&nbsp;is&nbsp;seq&nbsp;when&nbsp;the&nbsp;timer&nbsp;was&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1606237">//&nbsp;If&nbsp;it&#39;s&nbsp;stale,&nbsp;ignore&nbsp;the&nbsp;timer&nbsp;event.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606280">if</span>&nbsp;<span class="ident" id="1606283">seq</span>&nbsp;<span class="op" id="1606287">!=</span>&nbsp;<span class="ident" id="1606290">pd</span><span class="op" id="1606292">.</span><span class="ident" id="1606293">seq</span>&nbsp;<span class="op" id="1606297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1606301">//&nbsp;The&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606354">unlock</span><span class="op" id="1606360">(</span><span class="op" id="1606361">&amp;</span><span class="ident" id="1606362">pd</span><span class="op" id="1606364">.</span><span class="ident" id="1606365">lock</span><span class="op" id="1606369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606373">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606381">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606384">var</span>&nbsp;<span class="ident" id="1606388">rg</span>&nbsp;<span class="op" id="1606391">*</span><span class="ident" id="1606392">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606395">if</span>&nbsp;<span class="ident" id="1606398">read</span>&nbsp;<span class="op" id="1606403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606407">if</span>&nbsp;<span class="ident" id="1606410">pd</span><span class="op" id="1606412">.</span><span class="ident" id="1606413">rd</span>&nbsp;<span class="op" id="1606416">&lt;=</span>&nbsp;<span class="num" id="1606419">0</span>&nbsp;<span class="op" id="1606421">||</span>&nbsp;<span class="ident" id="1606424">pd</span><span class="op" id="1606426">.</span><span class="ident" id="1606427">rt</span><span class="op" id="1606429">.</span><span class="ident" id="1606430">f</span>&nbsp;<span class="op" id="1606432">==</span>&nbsp;<span class="builtintype" id="1606435">nil</span>&nbsp;<span class="op" id="1606439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606444">gothrow</span><span class="op" id="1606451">(</span><span class="string" id="1606452">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;read&nbsp;deadline&#34;</span><span class="op" id="1606501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606505">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606509">pd</span><span class="op" id="1606511">.</span><span class="ident" id="1606512">rd</span>&nbsp;<span class="op" id="1606515">=</span>&nbsp;<span class="op" id="1606517">-</span><span class="num" id="1606518">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606522">atomicstorep</span><span class="op" id="1606534">(</span><span class="ident" id="1606535">unsafe</span><span class="op" id="1606541">.</span><span class="ident" id="1606542">Pointer</span><span class="op" id="1606549">(</span><span class="op" id="1606550">&amp;</span><span class="ident" id="1606551">pd</span><span class="op" id="1606553">.</span><span class="ident" id="1606554">rt</span><span class="op" id="1606556">.</span><span class="ident" id="1606557">f</span><span class="op" id="1606558">)</span><span class="op" id="1606559">,</span>&nbsp;<span class="builtintype" id="1606561">nil</span><span class="op" id="1606564">)</span>&nbsp;<span class="comment" id="1606566">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;rd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606644">rg</span>&nbsp;<span class="op" id="1606647">=</span>&nbsp;<span class="ident" id="1606649">netpollunblock</span><span class="op" id="1606663">(</span><span class="ident" id="1606664">pd</span><span class="op" id="1606666">,</span>&nbsp;<span class="string" id="1606668">&#39;r&#39;</span><span class="op" id="1606671">,</span>&nbsp;<span class="builtintype" id="1606673">false</span><span class="op" id="1606678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606684">var</span>&nbsp;<span class="ident" id="1606688">wg</span>&nbsp;<span class="op" id="1606691">*</span><span class="ident" id="1606692">g</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606695">if</span>&nbsp;<span class="ident" id="1606698">write</span>&nbsp;<span class="op" id="1606704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1606708">if</span>&nbsp;<span class="ident" id="1606711">pd</span><span class="op" id="1606713">.</span><span class="ident" id="1606714">wd</span>&nbsp;<span class="op" id="1606717">&lt;=</span>&nbsp;<span class="num" id="1606720">0</span>&nbsp;<span class="op" id="1606722">||</span>&nbsp;<span class="ident" id="1606725">pd</span><span class="op" id="1606727">.</span><span class="ident" id="1606728">wt</span><span class="op" id="1606730">.</span><span class="ident" id="1606731">f</span>&nbsp;<span class="op" id="1606733">==</span>&nbsp;<span class="builtintype" id="1606736">nil</span>&nbsp;<span class="op" id="1606740">&amp;&amp;</span>&nbsp;<span class="op" id="1606743">!</span><span class="ident" id="1606744">read</span>&nbsp;<span class="op" id="1606749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606754">gothrow</span><span class="op" id="1606761">(</span><span class="string" id="1606762">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;write&nbsp;deadline&#34;</span><span class="op" id="1606812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606820">pd</span><span class="op" id="1606822">.</span><span class="ident" id="1606823">wd</span>&nbsp;<span class="op" id="1606826">=</span>&nbsp;<span class="op" id="1606828">-</span><span class="num" id="1606829">1</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606833">atomicstorep</span><span class="op" id="1606845">(</span><span class="ident" id="1606846">unsafe</span><span class="op" id="1606852">.</span><span class="ident" id="1606853">Pointer</span><span class="op" id="1606860">(</span><span class="op" id="1606861">&amp;</span><span class="ident" id="1606862">pd</span><span class="op" id="1606864">.</span><span class="ident" id="1606865">wt</span><span class="op" id="1606867">.</span><span class="ident" id="1606868">f</span><span class="op" id="1606869">)</span><span class="op" id="1606870">,</span>&nbsp;<span class="builtintype" id="1606872">nil</span><span class="op" id="1606875">)</span>&nbsp;<span class="comment" id="1606877">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;wd&nbsp;and&nbsp;load&nbsp;of&nbsp;wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606955">wg</span>&nbsp;<span class="op" id="1606958">=</span>&nbsp;<span class="ident" id="1606960">netpollunblock</span><span class="op" id="1606974">(</span><span class="ident" id="1606975">pd</span><span class="op" id="1606977">,</span>&nbsp;<span class="string" id="1606979">&#39;w&#39;</span><span class="op" id="1606982">,</span>&nbsp;<span class="builtintype" id="1606984">false</span><span class="op" id="1606989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1606992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1606995">unlock</span><span class="op" id="1607001">(</span><span class="op" id="1607002">&amp;</span><span class="ident" id="1607003">pd</span><span class="op" id="1607005">.</span><span class="ident" id="1607006">lock</span><span class="op" id="1607010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607013">if</span>&nbsp;<span class="ident" id="1607016">rg</span>&nbsp;<span class="op" id="1607019">!=</span>&nbsp;<span class="builtintype" id="1607022">nil</span>&nbsp;<span class="op" id="1607026">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607030">goready</span><span class="op" id="1607037">(</span><span class="ident" id="1607038">rg</span><span class="op" id="1607040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607046">if</span>&nbsp;<span class="ident" id="1607049">wg</span>&nbsp;<span class="op" id="1607052">!=</span>&nbsp;<span class="builtintype" id="1607055">nil</span>&nbsp;<span class="op" id="1607059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607063">goready</span><span class="op" id="1607070">(</span><span class="ident" id="1607071">wg</span><span class="op" id="1607073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607076">}</span><br>
<span class="lineno">420</span><span class="op" id="1607078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1607081">func</span>&nbsp;<span class="ident" id="1607086">netpollDeadline</span><span class="op" id="1607101">(</span><span class="ident" id="1607102">arg</span>&nbsp;<span class="keyword" id="1607106">interface</span><span class="op" id="1607115">{</span><span class="op" id="1607116">}</span><span class="op" id="1607117">,</span>&nbsp;<span class="ident" id="1607119">seq</span>&nbsp;<span class="builtintype" id="1607123">uintptr</span><span class="op" id="1607130">)</span>&nbsp;<span class="op" id="1607132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607135">netpolldeadlineimpl</span><span class="op" id="1607154">(</span><span class="ident" id="1607155">arg</span><span class="op" id="1607158">.</span><span class="op" id="1607159">(</span><span class="op" id="1607160">*</span><span class="ident" id="1607161">pollDesc</span><span class="op" id="1607169">)</span><span class="op" id="1607170">,</span>&nbsp;<span class="ident" id="1607172">seq</span><span class="op" id="1607175">,</span>&nbsp;<span class="builtintype" id="1607177">true</span><span class="op" id="1607181">,</span>&nbsp;<span class="builtintype" id="1607183">true</span><span class="op" id="1607187">)</span><br>
<span class="lineno"></span><span class="op" id="1607189">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="keyword" id="1607192">func</span>&nbsp;<span class="ident" id="1607197">netpollReadDeadline</span><span class="op" id="1607216">(</span><span class="ident" id="1607217">arg</span>&nbsp;<span class="keyword" id="1607221">interface</span><span class="op" id="1607230">{</span><span class="op" id="1607231">}</span><span class="op" id="1607232">,</span>&nbsp;<span class="ident" id="1607234">seq</span>&nbsp;<span class="builtintype" id="1607238">uintptr</span><span class="op" id="1607245">)</span>&nbsp;<span class="op" id="1607247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607250">netpolldeadlineimpl</span><span class="op" id="1607269">(</span><span class="ident" id="1607270">arg</span><span class="op" id="1607273">.</span><span class="op" id="1607274">(</span><span class="op" id="1607275">*</span><span class="ident" id="1607276">pollDesc</span><span class="op" id="1607284">)</span><span class="op" id="1607285">,</span>&nbsp;<span class="ident" id="1607287">seq</span><span class="op" id="1607290">,</span>&nbsp;<span class="builtintype" id="1607292">true</span><span class="op" id="1607296">,</span>&nbsp;<span class="builtintype" id="1607298">false</span><span class="op" id="1607303">)</span><br>
<span class="lineno"></span><span class="op" id="1607305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span><span class="keyword" id="1607308">func</span>&nbsp;<span class="ident" id="1607313">netpollWriteDeadline</span><span class="op" id="1607333">(</span><span class="ident" id="1607334">arg</span>&nbsp;<span class="keyword" id="1607338">interface</span><span class="op" id="1607347">{</span><span class="op" id="1607348">}</span><span class="op" id="1607349">,</span>&nbsp;<span class="ident" id="1607351">seq</span>&nbsp;<span class="builtintype" id="1607355">uintptr</span><span class="op" id="1607362">)</span>&nbsp;<span class="op" id="1607364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607367">netpolldeadlineimpl</span><span class="op" id="1607386">(</span><span class="ident" id="1607387">arg</span><span class="op" id="1607390">.</span><span class="op" id="1607391">(</span><span class="op" id="1607392">*</span><span class="ident" id="1607393">pollDesc</span><span class="op" id="1607401">)</span><span class="op" id="1607402">,</span>&nbsp;<span class="ident" id="1607404">seq</span><span class="op" id="1607407">,</span>&nbsp;<span class="builtintype" id="1607409">false</span><span class="op" id="1607414">,</span>&nbsp;<span class="builtintype" id="1607416">true</span><span class="op" id="1607420">)</span><br>
<span class="lineno"></span><span class="op" id="1607422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1607425">func</span>&nbsp;<span class="op" id="1607430">(</span><span class="ident" id="1607431">c</span>&nbsp;<span class="op" id="1607433">*</span><span class="ident" id="1607434">pollCache</span><span class="op" id="1607443">)</span>&nbsp;<span class="ident" id="1607445">alloc</span><span class="op" id="1607450">(</span><span class="op" id="1607451">)</span>&nbsp;<span class="op" id="1607453">*</span><span class="ident" id="1607454">pollDesc</span>&nbsp;<span class="op" id="1607463">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607466">lock</span><span class="op" id="1607470">(</span><span class="op" id="1607471">&amp;</span><span class="ident" id="1607472">c</span><span class="op" id="1607473">.</span><span class="ident" id="1607474">lock</span><span class="op" id="1607478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607481">if</span>&nbsp;<span class="ident" id="1607484">c</span><span class="op" id="1607485">.</span><span class="ident" id="1607486">first</span>&nbsp;<span class="op" id="1607492">==</span>&nbsp;<span class="builtintype" id="1607495">nil</span>&nbsp;<span class="op" id="1607499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607503">const</span>&nbsp;<span class="ident" id="1607509">pdSize</span>&nbsp;<span class="op" id="1607516">=</span>&nbsp;<span class="ident" id="1607518">unsafe</span><span class="op" id="1607524">.</span><span class="ident" id="1607525">Sizeof</span><span class="op" id="1607531">(</span><span class="ident" id="1607532">pollDesc</span><span class="op" id="1607540">{</span><span class="op" id="1607541">}</span><span class="op" id="1607542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607546">n</span>&nbsp;<span class="op" id="1607548">:=</span>&nbsp;<span class="ident" id="1607551">pollBlockSize</span>&nbsp;<span class="op" id="1607565">/</span>&nbsp;<span class="ident" id="1607567">pdSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607576">if</span>&nbsp;<span class="ident" id="1607579">n</span>&nbsp;<span class="op" id="1607581">==</span>&nbsp;<span class="num" id="1607584">0</span>&nbsp;<span class="op" id="1607586">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607591">n</span>&nbsp;<span class="op" id="1607593">=</span>&nbsp;<span class="num" id="1607595">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1607603">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;non-GC&nbsp;memory&nbsp;because&nbsp;can&nbsp;be&nbsp;referenced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1607659">//&nbsp;only&nbsp;from&nbsp;epoll/kqueue&nbsp;internals.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607698">mem</span>&nbsp;<span class="op" id="1607702">:=</span>&nbsp;<span class="ident" id="1607705">persistentalloc</span><span class="op" id="1607720">(</span><span class="ident" id="1607721">n</span><span class="op" id="1607722">*</span><span class="ident" id="1607723">pdSize</span><span class="op" id="1607729">,</span>&nbsp;<span class="num" id="1607731">0</span><span class="op" id="1607732">,</span>&nbsp;<span class="op" id="1607734">&amp;</span><span class="ident" id="1607735">memstats</span><span class="op" id="1607743">.</span><span class="ident" id="1607744">other_sys</span><span class="op" id="1607753">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607757">for</span>&nbsp;<span class="ident" id="1607761">i</span>&nbsp;<span class="op" id="1607763">:=</span>&nbsp;<span class="builtintype" id="1607766">uintptr</span><span class="op" id="1607773">(</span><span class="num" id="1607774">0</span><span class="op" id="1607775">)</span><span class="op" id="1607776">;</span>&nbsp;<span class="ident" id="1607778">i</span>&nbsp;<span class="op" id="1607780">&lt;</span>&nbsp;<span class="ident" id="1607782">n</span><span class="op" id="1607783">;</span>&nbsp;<span class="ident" id="1607785">i</span><span class="op" id="1607786">++</span>&nbsp;<span class="op" id="1607789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607794">pd</span>&nbsp;<span class="op" id="1607797">:=</span>&nbsp;<span class="op" id="1607800">(</span><span class="op" id="1607801">*</span><span class="ident" id="1607802">pollDesc</span><span class="op" id="1607810">)</span><span class="op" id="1607811">(</span><span class="ident" id="1607812">add</span><span class="op" id="1607815">(</span><span class="ident" id="1607816">mem</span><span class="op" id="1607819">,</span>&nbsp;<span class="ident" id="1607821">i</span><span class="op" id="1607822">*</span><span class="ident" id="1607823">pdSize</span><span class="op" id="1607829">)</span><span class="op" id="1607830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607835">pd</span><span class="op" id="1607837">.</span><span class="ident" id="1607838">link</span>&nbsp;<span class="op" id="1607843">=</span>&nbsp;<span class="ident" id="1607845">c</span><span class="op" id="1607846">.</span><span class="ident" id="1607847">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607856">c</span><span class="op" id="1607857">.</span><span class="ident" id="1607858">first</span>&nbsp;<span class="op" id="1607864">=</span>&nbsp;<span class="ident" id="1607866">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607871">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1607874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607877">pd</span>&nbsp;<span class="op" id="1607880">:=</span>&nbsp;<span class="ident" id="1607883">c</span><span class="op" id="1607884">.</span><span class="ident" id="1607885">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607892">c</span><span class="op" id="1607893">.</span><span class="ident" id="1607894">first</span>&nbsp;<span class="op" id="1607900">=</span>&nbsp;<span class="ident" id="1607902">pd</span><span class="op" id="1607904">.</span><span class="ident" id="1607905">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1607911">unlock</span><span class="op" id="1607917">(</span><span class="op" id="1607918">&amp;</span><span class="ident" id="1607919">c</span><span class="op" id="1607920">.</span><span class="ident" id="1607921">lock</span><span class="op" id="1607925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1607928">return</span>&nbsp;<span class="ident" id="1607935">pd</span><br>
<span class="lineno">455</span><span class="op" id="1607938">}</span>
</div>
</body>
</html>
