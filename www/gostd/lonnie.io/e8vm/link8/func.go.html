<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>lonnie.io/e8vm/link8</h2>
<ul>
<li><a href="/gostd/lonnie.io/e8vm/link8/func.go.html">func.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/link8/layout.go.html">layout.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/link8/link.go.html">link.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/link8/linker.go.html">linker.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/link8/package.go.html">package.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/link8/pkg_sym.go.html">pkg_sym.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/link8/symbol.go.html">symbol.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/link8/trace_used.go.html">trace_used.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/link8/var.go.html">var.go</a></li>
<li><a href="/gostd/lonnie.io/e8vm/link8/writer.go.html">writer.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="keyword" id="3672113">package</span>&nbsp;<span class="ident" id="3672121">link8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3672128">import</span>&nbsp;<span class="op" id="3672135">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3672138">&#34;math&#34;</span><br>
<span class="lineno">5</span><span class="op" id="3672145">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3672148">//&nbsp;link&nbsp;is&nbsp;a&nbsp;piece&nbsp;of&nbsp;linking&nbsp;information&nbsp;for&nbsp;an&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="3672209">//&nbsp;in&nbsp;a&nbsp;code&nbsp;section&nbsp;at&nbsp;a&nbsp;particular&nbsp;offset.</span><br>
<span class="lineno"></span><span class="comment" id="3672254">//&nbsp;it&nbsp;uses&nbsp;the&nbsp;indices&nbsp;in&nbsp;the&nbsp;package&nbsp;for&nbsp;symbol&nbsp;lookup</span><br>
<span class="lineno">10</span><span class="keyword" id="3672310">type</span>&nbsp;<span class="ident" id="3672315">link</span>&nbsp;<span class="keyword" id="3672320">struct</span>&nbsp;<span class="op" id="3672327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672330">offset</span>&nbsp;<span class="builtintype" id="3672337">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672345">pkg</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3672352">uint32</span>&nbsp;<span class="comment" id="3672359">//&nbsp;relative&nbsp;package&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672386">sym</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3672393">uint32</span><br>
<span class="lineno"></span><span class="op" id="3672400">}</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="3672403">//&nbsp;Func&nbsp;is&nbsp;a&nbsp;relocatable&nbsp;code&nbsp;section</span><br>
<span class="lineno"></span><span class="keyword" id="3672441">type</span>&nbsp;<span class="ident" id="3672446">Func</span>&nbsp;<span class="keyword" id="3672451">struct</span>&nbsp;<span class="op" id="3672458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672461">insts</span>&nbsp;<span class="op" id="3672467">[</span><span class="op" id="3672468">]</span><span class="builtintype" id="3672469">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672477">links</span>&nbsp;<span class="op" id="3672483">[</span><span class="op" id="3672484">]</span><span class="op" id="3672485">*</span><span class="ident" id="3672486">link</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672493">addr</span>&nbsp;<span class="builtintype" id="3672498">uint32</span><br>
<span class="lineno"></span><span class="op" id="3672505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3672508">//&nbsp;NewFunc&nbsp;creates&nbsp;a&nbsp;new&nbsp;relocatable&nbsp;code&nbsp;section.</span><br>
<span class="lineno">25</span><span class="keyword" id="3672559">func</span>&nbsp;<span class="ident" id="3672564">NewFunc</span><span class="op" id="3672571">(</span><span class="op" id="3672572">)</span>&nbsp;<span class="op" id="3672574">*</span><span class="ident" id="3672575">Func</span>&nbsp;<span class="op" id="3672580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672583">return</span>&nbsp;<span class="builtinfunc" id="3672590">new</span><span class="op" id="3672593">(</span><span class="ident" id="3672594">Func</span><span class="op" id="3672598">)</span><br>
<span class="lineno"></span><span class="op" id="3672600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3672603">//&nbsp;AddInst&nbsp;appends&nbsp;an&nbsp;instruction&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;function.</span><br>
<span class="lineno">30</span><span class="keyword" id="3672665">func</span>&nbsp;<span class="op" id="3672670">(</span><span class="ident" id="3672671">f</span>&nbsp;<span class="op" id="3672673">*</span><span class="ident" id="3672674">Func</span><span class="op" id="3672678">)</span>&nbsp;<span class="ident" id="3672680">AddInst</span><span class="op" id="3672687">(</span><span class="ident" id="3672688">i</span>&nbsp;<span class="builtintype" id="3672690">uint32</span><span class="op" id="3672696">)</span>&nbsp;<span class="op" id="3672698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672701">f</span><span class="op" id="3672702">.</span><span class="ident" id="3672703">insts</span>&nbsp;<span class="op" id="3672709">=</span>&nbsp;<span class="builtinfunc" id="3672711">append</span><span class="op" id="3672717">(</span><span class="ident" id="3672718">f</span><span class="op" id="3672719">.</span><span class="ident" id="3672720">insts</span><span class="op" id="3672725">,</span>&nbsp;<span class="ident" id="3672727">i</span><span class="op" id="3672728">)</span><br>
<span class="lineno"></span><span class="op" id="3672730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3672733">//&nbsp;TooLarge&nbsp;checks&nbsp;if&nbsp;the&nbsp;function&nbsp;size&nbsp;is&nbsp;larger&nbsp;than&nbsp;4GB.</span><br>
<span class="lineno">35</span><span class="keyword" id="3672793">func</span>&nbsp;<span class="op" id="3672798">(</span><span class="ident" id="3672799">f</span>&nbsp;<span class="op" id="3672801">*</span><span class="ident" id="3672802">Func</span><span class="op" id="3672806">)</span>&nbsp;<span class="ident" id="3672808">TooLarge</span><span class="op" id="3672816">(</span><span class="op" id="3672817">)</span>&nbsp;<span class="builtintype" id="3672819">bool</span>&nbsp;<span class="op" id="3672824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672827">return</span>&nbsp;<span class="builtinfunc" id="3672834">len</span><span class="op" id="3672837">(</span><span class="ident" id="3672838">f</span><span class="op" id="3672839">.</span><span class="ident" id="3672840">insts</span><span class="op" id="3672845">)</span><span class="op" id="3672846">*</span><span class="num" id="3672847">4</span>&nbsp;<span class="op" id="3672849">&gt;=</span>&nbsp;<span class="ident" id="3672852">math</span><span class="op" id="3672856">.</span><span class="ident" id="3672857">MaxInt32</span><br>
<span class="lineno"></span><span class="op" id="3672866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3672869">//&nbsp;Size&nbsp;returns&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;function.</span><br>
<span class="lineno">40</span><span class="keyword" id="3672911">func</span>&nbsp;<span class="op" id="3672916">(</span><span class="ident" id="3672917">f</span>&nbsp;<span class="op" id="3672919">*</span><span class="ident" id="3672920">Func</span><span class="op" id="3672924">)</span>&nbsp;<span class="ident" id="3672926">Size</span><span class="op" id="3672930">(</span><span class="op" id="3672931">)</span>&nbsp;<span class="builtintype" id="3672933">uint32</span>&nbsp;<span class="op" id="3672940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672943">return</span>&nbsp;<span class="builtintype" id="3672950">uint32</span><span class="op" id="3672956">(</span><span class="builtinfunc" id="3672957">len</span><span class="op" id="3672960">(</span><span class="ident" id="3672961">f</span><span class="op" id="3672962">.</span><span class="ident" id="3672963">insts</span><span class="op" id="3672968">)</span>&nbsp;<span class="op" id="3672970">*</span>&nbsp;<span class="num" id="3672972">4</span><span class="op" id="3672973">)</span><br>
<span class="lineno"></span><span class="op" id="3672975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3672978">//&nbsp;AddLink&nbsp;links&nbsp;the&nbsp;last&nbsp;instruction&nbsp;in&nbsp;inst&nbsp;to</span><br>
<span class="lineno">45</span><span class="comment" id="3673027">//&nbsp;the&nbsp;symbol&nbsp;pkg.sym,&nbsp;where&nbsp;pkg&nbsp;and&nbsp;sym&nbsp;are&nbsp;using&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3673082">//&nbsp;indexing&nbsp;of&nbsp;the&nbsp;object&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="3673114">//&nbsp;fill&nbsp;field&nbsp;must&nbsp;be&nbsp;less&nbsp;than&nbsp;4&nbsp;so&nbsp;that&nbsp;it&nbsp;fits&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3673171">//&nbsp;lowest&nbsp;2&nbsp;bits&nbsp;in&nbsp;the&nbsp;offset&nbsp;field.&nbsp;The&nbsp;other&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="3673224">//&nbsp;of&nbsp;the&nbsp;offset&nbsp;fields&nbsp;will&nbsp;be&nbsp;automatically&nbsp;calculated</span><br>
<span class="lineno">50</span><span class="comment" id="3673281">//&nbsp;based&nbsp;on&nbsp;the&nbsp;number&nbsp;of&nbsp;instructions&nbsp;in&nbsp;insts.</span><br>
<span class="lineno"></span><span class="keyword" id="3673330">func</span>&nbsp;<span class="op" id="3673335">(</span><span class="ident" id="3673336">f</span>&nbsp;<span class="op" id="3673338">*</span><span class="ident" id="3673339">Func</span><span class="op" id="3673343">)</span>&nbsp;<span class="ident" id="3673345">AddLink</span><span class="op" id="3673352">(</span><span class="ident" id="3673353">fill</span>&nbsp;<span class="builtintype" id="3673358">int</span><span class="op" id="3673361">,</span>&nbsp;<span class="ident" id="3673363">pkg</span><span class="op" id="3673366">,</span>&nbsp;<span class="ident" id="3673368">sym</span>&nbsp;<span class="builtintype" id="3673372">uint32</span><span class="op" id="3673378">)</span>&nbsp;<span class="op" id="3673380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673383">if</span>&nbsp;<span class="builtinfunc" id="3673386">len</span><span class="op" id="3673389">(</span><span class="ident" id="3673390">f</span><span class="op" id="3673391">.</span><span class="ident" id="3673392">insts</span><span class="op" id="3673397">)</span>&nbsp;<span class="op" id="3673399">==</span>&nbsp;<span class="num" id="3673402">0</span>&nbsp;<span class="op" id="3673404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3673408">panic</span><span class="op" id="3673413">(</span><span class="string" id="3673414">&#34;no&nbsp;inst&nbsp;to&nbsp;link&#34;</span><span class="op" id="3673431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3673434">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673437">if</span>&nbsp;<span class="op" id="3673440">!</span><span class="op" id="3673441">(</span><span class="ident" id="3673442">fill</span>&nbsp;<span class="op" id="3673447">&gt;</span>&nbsp;<span class="num" id="3673449">0</span>&nbsp;<span class="op" id="3673451">&amp;&amp;</span>&nbsp;<span class="ident" id="3673454">fill</span>&nbsp;<span class="op" id="3673459">&lt;=</span>&nbsp;<span class="num" id="3673462">3</span><span class="op" id="3673463">)</span>&nbsp;<span class="op" id="3673465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3673469">panic</span><span class="op" id="3673474">(</span><span class="string" id="3673475">&#34;invalid&nbsp;fill&#34;</span><span class="op" id="3673489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3673492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673496">offset</span>&nbsp;<span class="op" id="3673503">:=</span>&nbsp;<span class="builtintype" id="3673506">uint32</span><span class="op" id="3673512">(</span><span class="builtinfunc" id="3673513">len</span><span class="op" id="3673516">(</span><span class="ident" id="3673517">f</span><span class="op" id="3673518">.</span><span class="ident" id="3673519">insts</span><span class="op" id="3673524">)</span><span class="op" id="3673525">)</span><span class="op" id="3673526">*</span><span class="num" id="3673527">4</span>&nbsp;<span class="op" id="3673529">-</span>&nbsp;<span class="num" id="3673531">4</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673534">offset</span>&nbsp;<span class="op" id="3673541">|=</span>&nbsp;<span class="builtintype" id="3673544">uint32</span><span class="op" id="3673550">(</span><span class="ident" id="3673551">fill</span><span class="op" id="3673555">)</span>&nbsp;<span class="op" id="3673557">&amp;</span>&nbsp;<span class="num" id="3673559">0x3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673564">link</span>&nbsp;<span class="op" id="3673569">:=</span>&nbsp;<span class="op" id="3673572">&amp;</span><span class="ident" id="3673573">link</span><span class="op" id="3673577">{</span><span class="ident" id="3673578">offset</span><span class="op" id="3673584">:</span>&nbsp;<span class="ident" id="3673586">offset</span><span class="op" id="3673592">,</span>&nbsp;<span class="ident" id="3673594">pkg</span><span class="op" id="3673597">:</span>&nbsp;<span class="ident" id="3673599">pkg</span><span class="op" id="3673602">,</span>&nbsp;<span class="ident" id="3673604">sym</span><span class="op" id="3673607">:</span>&nbsp;<span class="ident" id="3673609">sym</span><span class="op" id="3673612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673615">f</span><span class="op" id="3673616">.</span><span class="ident" id="3673617">links</span>&nbsp;<span class="op" id="3673623">=</span>&nbsp;<span class="builtinfunc" id="3673625">append</span><span class="op" id="3673631">(</span><span class="ident" id="3673632">f</span><span class="op" id="3673633">.</span><span class="ident" id="3673634">links</span><span class="op" id="3673639">,</span>&nbsp;<span class="ident" id="3673641">link</span><span class="op" id="3673645">)</span><br>
<span class="lineno"></span><span class="op" id="3673647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3673650">//&nbsp;Constant&nbsp;fill-later&nbsp;methods.</span><br>
<span class="lineno"></span><span class="keyword" id="3673682">const</span>&nbsp;<span class="op" id="3673688">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673691">FillNone</span>&nbsp;<span class="op" id="3673700">=</span>&nbsp;<span class="ident" id="3673702">iota</span>&nbsp;<span class="comment" id="3673707">//&nbsp;no&nbsp;fill</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673719">FillLink</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3673735">//&nbsp;fill&nbsp;as&nbsp;linking&nbsp;offset&nbsp;for&nbsp;jump&nbsp;instructions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673784">FillLow</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3673800">//&nbsp;fill&nbsp;with&nbsp;the&nbsp;lower&nbsp;16&nbsp;bits</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673832">FillHigh</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3673848">//&nbsp;fill&nbsp;with&nbsp;the&nbsp;higher&nbsp;16&nbsp;bits</span><br>
<span class="lineno"></span><span class="op" id="3673880">)</span>
</div>
</body>
</html>
