<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/fcgi</h2>
<ul>
<li><a href="/gostd/net/http/fcgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi.go.html">fcgi.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi_test.go.html">fcgi_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6312855">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6312910">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6312964">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6313015">package</span>&nbsp;<span class="ident" id="6313023">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6313029">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;FastCGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6313103">import</span>&nbsp;<span class="op" id="6313110">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6313113">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6313123">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6313130">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6313136">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6313149">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6313156">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6313168">&#34;net/http/cgi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6313184">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6313190">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6313201">&#34;sync&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6313209">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6313216">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6313219">//&nbsp;request&nbsp;holds&nbsp;the&nbsp;state&nbsp;for&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;As&nbsp;soon&nbsp;as&nbsp;it&#39;s&nbsp;complete,</span><br>
<span class="lineno"></span><span class="comment" id="6313300">//&nbsp;it&#39;s&nbsp;converted&nbsp;to&nbsp;an&nbsp;http.Request.</span><br>
<span class="lineno">25</span><span class="keyword" id="6313338">type</span>&nbsp;<span class="ident" id="6313343">request</span>&nbsp;<span class="keyword" id="6313351">struct</span>&nbsp;<span class="op" id="6313358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6313361">pw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6313371">*</span><span class="ident" id="6313372">io</span><span class="op" id="6313374">.</span><span class="ident" id="6313375">PipeWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6313387">reqId</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6313397">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6313405">params</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6313415">map</span><span class="op" id="6313418">[</span><span class="builtintype" id="6313419">string</span><span class="op" id="6313425">]</span><span class="builtintype" id="6313426">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6313434">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6313444">[</span><span class="num" id="6313445">1024</span><span class="op" id="6313449">]</span><span class="builtintype" id="6313450">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6313456">rawParams</span>&nbsp;<span class="op" id="6313466">[</span><span class="op" id="6313467">]</span><span class="builtintype" id="6313468">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6313474">keepConn</span>&nbsp;&nbsp;<span class="builtintype" id="6313484">bool</span><br>
<span class="lineno"></span><span class="op" id="6313489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6313492">func</span>&nbsp;<span class="ident" id="6313497">newRequest</span><span class="op" id="6313507">(</span><span class="ident" id="6313508">reqId</span>&nbsp;<span class="builtintype" id="6313514">uint16</span><span class="op" id="6313520">,</span>&nbsp;<span class="ident" id="6313522">flags</span>&nbsp;<span class="builtintype" id="6313528">uint8</span><span class="op" id="6313533">)</span>&nbsp;<span class="op" id="6313535">*</span><span class="ident" id="6313536">request</span>&nbsp;<span class="op" id="6313544">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6313547">r</span>&nbsp;<span class="op" id="6313549">:=</span>&nbsp;<span class="op" id="6313552">&amp;</span><span class="ident" id="6313553">request</span><span class="op" id="6313560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6313564">reqId</span><span class="op" id="6313569">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6313574">reqId</span><span class="op" id="6313579">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6313583">params</span><span class="op" id="6313589">:</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="6313593">map</span><span class="op" id="6313596">[</span><span class="builtintype" id="6313597">string</span><span class="op" id="6313603">]</span><span class="builtintype" id="6313604">string</span><span class="op" id="6313610">{</span><span class="op" id="6313611">}</span><span class="op" id="6313612">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6313616">keepConn</span><span class="op" id="6313624">:</span>&nbsp;<span class="ident" id="6313626">flags</span><span class="op" id="6313631">&amp;</span><span class="ident" id="6313632">flagKeepConn</span>&nbsp;<span class="op" id="6313645">!=</span>&nbsp;<span class="num" id="6313648">0</span><span class="op" id="6313649">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6313652">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6313655">r</span><span class="op" id="6313656">.</span><span class="ident" id="6313657">rawParams</span>&nbsp;<span class="op" id="6313667">=</span>&nbsp;<span class="ident" id="6313669">r</span><span class="op" id="6313670">.</span><span class="ident" id="6313671">buf</span><span class="op" id="6313674">[</span><span class="op" id="6313675">:</span><span class="num" id="6313676">0</span><span class="op" id="6313677">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6313680">return</span>&nbsp;<span class="ident" id="6313687">r</span><br>
<span class="lineno"></span><span class="op" id="6313689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6313692">//&nbsp;parseParams&nbsp;reads&nbsp;an&nbsp;encoded&nbsp;[]byte&nbsp;into&nbsp;Params.</span><br>
<span class="lineno">45</span><span class="keyword" id="6313744">func</span>&nbsp;<span class="op" id="6313749">(</span><span class="ident" id="6313750">r</span>&nbsp;<span class="op" id="6313752">*</span><span class="ident" id="6313753">request</span><span class="op" id="6313760">)</span>&nbsp;<span class="ident" id="6313762">parseParams</span><span class="op" id="6313773">(</span><span class="op" id="6313774">)</span>&nbsp;<span class="op" id="6313776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6313779">text</span>&nbsp;<span class="op" id="6313784">:=</span>&nbsp;<span class="ident" id="6313787">r</span><span class="op" id="6313788">.</span><span class="ident" id="6313789">rawParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6313800">r</span><span class="op" id="6313801">.</span><span class="ident" id="6313802">rawParams</span>&nbsp;<span class="op" id="6313812">=</span>&nbsp;<span class="ident" id="6313814">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6313819">for</span>&nbsp;<span class="builtinfunc" id="6313823">len</span><span class="op" id="6313826">(</span><span class="ident" id="6313827">text</span><span class="op" id="6313831">)</span>&nbsp;<span class="op" id="6313833">&gt;</span>&nbsp;<span class="num" id="6313835">0</span>&nbsp;<span class="op" id="6313837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6313841">keyLen</span><span class="op" id="6313847">,</span>&nbsp;<span class="ident" id="6313849">n</span>&nbsp;<span class="op" id="6313851">:=</span>&nbsp;<span class="ident" id="6313854">readSize</span><span class="op" id="6313862">(</span><span class="ident" id="6313863">text</span><span class="op" id="6313867">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6313871">if</span>&nbsp;<span class="ident" id="6313874">n</span>&nbsp;<span class="op" id="6313876">==</span>&nbsp;<span class="num" id="6313879">0</span>&nbsp;<span class="op" id="6313881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6313886">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6313895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6313899">text</span>&nbsp;<span class="op" id="6313904">=</span>&nbsp;<span class="ident" id="6313906">text</span><span class="op" id="6313910">[</span><span class="ident" id="6313911">n</span><span class="op" id="6313912">:</span><span class="op" id="6313913">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6313917">valLen</span><span class="op" id="6313923">,</span>&nbsp;<span class="ident" id="6313925">n</span>&nbsp;<span class="op" id="6313927">:=</span>&nbsp;<span class="ident" id="6313930">readSize</span><span class="op" id="6313938">(</span><span class="ident" id="6313939">text</span><span class="op" id="6313943">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6313947">if</span>&nbsp;<span class="ident" id="6313950">n</span>&nbsp;<span class="op" id="6313952">==</span>&nbsp;<span class="num" id="6313955">0</span>&nbsp;<span class="op" id="6313957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6313962">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6313971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6313975">text</span>&nbsp;<span class="op" id="6313980">=</span>&nbsp;<span class="ident" id="6313982">text</span><span class="op" id="6313986">[</span><span class="ident" id="6313987">n</span><span class="op" id="6313988">:</span><span class="op" id="6313989">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6313993">key</span>&nbsp;<span class="op" id="6313997">:=</span>&nbsp;<span class="ident" id="6314000">readString</span><span class="op" id="6314010">(</span><span class="ident" id="6314011">text</span><span class="op" id="6314015">,</span>&nbsp;<span class="ident" id="6314017">keyLen</span><span class="op" id="6314023">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6314027">text</span>&nbsp;<span class="op" id="6314032">=</span>&nbsp;<span class="ident" id="6314034">text</span><span class="op" id="6314038">[</span><span class="ident" id="6314039">keyLen</span><span class="op" id="6314045">:</span><span class="op" id="6314046">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6314050">val</span>&nbsp;<span class="op" id="6314054">:=</span>&nbsp;<span class="ident" id="6314057">readString</span><span class="op" id="6314067">(</span><span class="ident" id="6314068">text</span><span class="op" id="6314072">,</span>&nbsp;<span class="ident" id="6314074">valLen</span><span class="op" id="6314080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6314084">text</span>&nbsp;<span class="op" id="6314089">=</span>&nbsp;<span class="ident" id="6314091">text</span><span class="op" id="6314095">[</span><span class="ident" id="6314096">valLen</span><span class="op" id="6314102">:</span><span class="op" id="6314103">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6314107">r</span><span class="op" id="6314108">.</span><span class="ident" id="6314109">params</span><span class="op" id="6314115">[</span><span class="ident" id="6314116">key</span><span class="op" id="6314119">]</span>&nbsp;<span class="op" id="6314121">=</span>&nbsp;<span class="ident" id="6314123">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6314128">}</span><br>
<span class="lineno">65</span><span class="op" id="6314130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6314133">//&nbsp;response&nbsp;implements&nbsp;http.ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="6314177">type</span>&nbsp;<span class="ident" id="6314182">response</span>&nbsp;<span class="keyword" id="6314191">struct</span>&nbsp;<span class="op" id="6314198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6314201">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6314213">*</span><span class="ident" id="6314214">request</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6314223">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6314235">http</span><span class="op" id="6314239">.</span><span class="ident" id="6314240">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6314248">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6314260">*</span><span class="ident" id="6314261">bufWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6314272">wroteHeader</span>&nbsp;<span class="builtintype" id="6314284">bool</span><br>
<span class="lineno"></span><span class="op" id="6314289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="6314292">func</span>&nbsp;<span class="ident" id="6314297">newResponse</span><span class="op" id="6314308">(</span><span class="ident" id="6314309">c</span>&nbsp;<span class="op" id="6314311">*</span><span class="ident" id="6314312">child</span><span class="op" id="6314317">,</span>&nbsp;<span class="ident" id="6314319">req</span>&nbsp;<span class="op" id="6314323">*</span><span class="ident" id="6314324">request</span><span class="op" id="6314331">)</span>&nbsp;<span class="op" id="6314333">*</span><span class="ident" id="6314334">response</span>&nbsp;<span class="op" id="6314343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6314346">return</span>&nbsp;<span class="op" id="6314353">&amp;</span><span class="ident" id="6314354">response</span><span class="op" id="6314362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6314366">req</span><span class="op" id="6314369">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6314374">req</span><span class="op" id="6314377">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6314381">header</span><span class="op" id="6314387">:</span>&nbsp;<span class="ident" id="6314389">http</span><span class="op" id="6314393">.</span><span class="ident" id="6314394">Header</span><span class="op" id="6314400">{</span><span class="op" id="6314401">}</span><span class="op" id="6314402">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6314406">w</span><span class="op" id="6314407">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6314414">newWriter</span><span class="op" id="6314423">(</span><span class="ident" id="6314424">c</span><span class="op" id="6314425">.</span><span class="ident" id="6314426">conn</span><span class="op" id="6314430">,</span>&nbsp;<span class="ident" id="6314432">typeStdout</span><span class="op" id="6314442">,</span>&nbsp;<span class="ident" id="6314444">req</span><span class="op" id="6314447">.</span><span class="ident" id="6314448">reqId</span><span class="op" id="6314453">)</span><span class="op" id="6314454">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6314457">}</span><br>
<span class="lineno"></span><span class="op" id="6314459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6314462">func</span>&nbsp;<span class="op" id="6314467">(</span><span class="ident" id="6314468">r</span>&nbsp;<span class="op" id="6314470">*</span><span class="ident" id="6314471">response</span><span class="op" id="6314479">)</span>&nbsp;<span class="ident" id="6314481">Header</span><span class="op" id="6314487">(</span><span class="op" id="6314488">)</span>&nbsp;<span class="ident" id="6314490">http</span><span class="op" id="6314494">.</span><span class="ident" id="6314495">Header</span>&nbsp;<span class="op" id="6314502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6314505">return</span>&nbsp;<span class="ident" id="6314512">r</span><span class="op" id="6314513">.</span><span class="ident" id="6314514">header</span><br>
<span class="lineno">85</span><span class="op" id="6314521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6314524">func</span>&nbsp;<span class="op" id="6314529">(</span><span class="ident" id="6314530">r</span>&nbsp;<span class="op" id="6314532">*</span><span class="ident" id="6314533">response</span><span class="op" id="6314541">)</span>&nbsp;<span class="ident" id="6314543">Write</span><span class="op" id="6314548">(</span><span class="ident" id="6314549">data</span>&nbsp;<span class="op" id="6314554">[</span><span class="op" id="6314555">]</span><span class="builtintype" id="6314556">byte</span><span class="op" id="6314560">)</span>&nbsp;<span class="op" id="6314562">(</span><span class="builtintype" id="6314563">int</span><span class="op" id="6314566">,</span>&nbsp;<span class="builtintype" id="6314568">error</span><span class="op" id="6314573">)</span>&nbsp;<span class="op" id="6314575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6314578">if</span>&nbsp;<span class="op" id="6314581">!</span><span class="ident" id="6314582">r</span><span class="op" id="6314583">.</span><span class="ident" id="6314584">wroteHeader</span>&nbsp;<span class="op" id="6314596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6314600">r</span><span class="op" id="6314601">.</span><span class="ident" id="6314602">WriteHeader</span><span class="op" id="6314613">(</span><span class="ident" id="6314614">http</span><span class="op" id="6314618">.</span><span class="ident" id="6314619">StatusOK</span><span class="op" id="6314627">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6314630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6314633">return</span>&nbsp;<span class="ident" id="6314640">r</span><span class="op" id="6314641">.</span><span class="ident" id="6314642">w</span><span class="op" id="6314643">.</span><span class="ident" id="6314644">Write</span><span class="op" id="6314649">(</span><span class="ident" id="6314650">data</span><span class="op" id="6314654">)</span><br>
<span class="lineno"></span><span class="op" id="6314656">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6314659">func</span>&nbsp;<span class="op" id="6314664">(</span><span class="ident" id="6314665">r</span>&nbsp;<span class="op" id="6314667">*</span><span class="ident" id="6314668">response</span><span class="op" id="6314676">)</span>&nbsp;<span class="ident" id="6314678">WriteHeader</span><span class="op" id="6314689">(</span><span class="ident" id="6314690">code</span>&nbsp;<span class="builtintype" id="6314695">int</span><span class="op" id="6314698">)</span>&nbsp;<span class="op" id="6314700">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6314703">if</span>&nbsp;<span class="ident" id="6314706">r</span><span class="op" id="6314707">.</span><span class="ident" id="6314708">wroteHeader</span>&nbsp;<span class="op" id="6314720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6314724">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6314732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6314735">r</span><span class="op" id="6314736">.</span><span class="ident" id="6314737">wroteHeader</span>&nbsp;<span class="op" id="6314749">=</span>&nbsp;<span class="builtintype" id="6314751">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6314757">if</span>&nbsp;<span class="ident" id="6314760">code</span>&nbsp;<span class="op" id="6314765">==</span>&nbsp;<span class="ident" id="6314768">http</span><span class="op" id="6314772">.</span><span class="ident" id="6314773">StatusNotModified</span>&nbsp;<span class="op" id="6314791">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6314795">//&nbsp;Must&nbsp;not&nbsp;have&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6314820">r</span><span class="op" id="6314821">.</span><span class="ident" id="6314822">header</span><span class="op" id="6314828">.</span><span class="ident" id="6314829">Del</span><span class="op" id="6314832">(</span><span class="string" id="6314833">&#34;Content-Type&#34;</span><span class="op" id="6314847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6314851">r</span><span class="op" id="6314852">.</span><span class="ident" id="6314853">header</span><span class="op" id="6314859">.</span><span class="ident" id="6314860">Del</span><span class="op" id="6314863">(</span><span class="string" id="6314864">&#34;Content-Length&#34;</span><span class="op" id="6314880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6314884">r</span><span class="op" id="6314885">.</span><span class="ident" id="6314886">header</span><span class="op" id="6314892">.</span><span class="ident" id="6314893">Del</span><span class="op" id="6314896">(</span><span class="string" id="6314897">&#34;Transfer-Encoding&#34;</span><span class="op" id="6314916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6314919">}</span>&nbsp;<span class="keyword" id="6314921">else</span>&nbsp;<span class="keyword" id="6314926">if</span>&nbsp;<span class="ident" id="6314929">r</span><span class="op" id="6314930">.</span><span class="ident" id="6314931">header</span><span class="op" id="6314937">.</span><span class="ident" id="6314938">Get</span><span class="op" id="6314941">(</span><span class="string" id="6314942">&#34;Content-Type&#34;</span><span class="op" id="6314956">)</span>&nbsp;<span class="op" id="6314958">==</span>&nbsp;<span class="string" id="6314961">&#34;&#34;</span>&nbsp;<span class="op" id="6314964">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6314968">r</span><span class="op" id="6314969">.</span><span class="ident" id="6314970">header</span><span class="op" id="6314976">.</span><span class="ident" id="6314977">Set</span><span class="op" id="6314980">(</span><span class="string" id="6314981">&#34;Content-Type&#34;</span><span class="op" id="6314995">,</span>&nbsp;<span class="string" id="6314997">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="6315023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6315026">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6315030">if</span>&nbsp;<span class="ident" id="6315033">r</span><span class="op" id="6315034">.</span><span class="ident" id="6315035">header</span><span class="op" id="6315041">.</span><span class="ident" id="6315042">Get</span><span class="op" id="6315045">(</span><span class="string" id="6315046">&#34;Date&#34;</span><span class="op" id="6315052">)</span>&nbsp;<span class="op" id="6315054">==</span>&nbsp;<span class="string" id="6315057">&#34;&#34;</span>&nbsp;<span class="op" id="6315060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6315064">r</span><span class="op" id="6315065">.</span><span class="ident" id="6315066">header</span><span class="op" id="6315072">.</span><span class="ident" id="6315073">Set</span><span class="op" id="6315076">(</span><span class="string" id="6315077">&#34;Date&#34;</span><span class="op" id="6315083">,</span>&nbsp;<span class="ident" id="6315085">time</span><span class="op" id="6315089">.</span><span class="ident" id="6315090">Now</span><span class="op" id="6315093">(</span><span class="op" id="6315094">)</span><span class="op" id="6315095">.</span><span class="ident" id="6315096">UTC</span><span class="op" id="6315099">(</span><span class="op" id="6315100">)</span><span class="op" id="6315101">.</span><span class="ident" id="6315102">Format</span><span class="op" id="6315108">(</span><span class="ident" id="6315109">http</span><span class="op" id="6315113">.</span><span class="ident" id="6315114">TimeFormat</span><span class="op" id="6315124">)</span><span class="op" id="6315125">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6315128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6315132">fmt</span><span class="op" id="6315135">.</span><span class="ident" id="6315136">Fprintf</span><span class="op" id="6315143">(</span><span class="ident" id="6315144">r</span><span class="op" id="6315145">.</span><span class="ident" id="6315146">w</span><span class="op" id="6315147">,</span>&nbsp;<span class="string" id="6315149">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="6315168">,</span>&nbsp;<span class="ident" id="6315170">code</span><span class="op" id="6315174">,</span>&nbsp;<span class="ident" id="6315176">http</span><span class="op" id="6315180">.</span><span class="ident" id="6315181">StatusText</span><span class="op" id="6315191">(</span><span class="ident" id="6315192">code</span><span class="op" id="6315196">)</span><span class="op" id="6315197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6315200">r</span><span class="op" id="6315201">.</span><span class="ident" id="6315202">header</span><span class="op" id="6315208">.</span><span class="ident" id="6315209">Write</span><span class="op" id="6315214">(</span><span class="ident" id="6315215">r</span><span class="op" id="6315216">.</span><span class="ident" id="6315217">w</span><span class="op" id="6315218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6315221">r</span><span class="op" id="6315222">.</span><span class="ident" id="6315223">w</span><span class="op" id="6315224">.</span><span class="ident" id="6315225">WriteString</span><span class="op" id="6315236">(</span><span class="string" id="6315237">&#34;\r\n&#34;</span><span class="op" id="6315243">)</span><br>
<span class="lineno">115</span><span class="op" id="6315245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6315248">func</span>&nbsp;<span class="op" id="6315253">(</span><span class="ident" id="6315254">r</span>&nbsp;<span class="op" id="6315256">*</span><span class="ident" id="6315257">response</span><span class="op" id="6315265">)</span>&nbsp;<span class="ident" id="6315267">Flush</span><span class="op" id="6315272">(</span><span class="op" id="6315273">)</span>&nbsp;<span class="op" id="6315275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6315278">if</span>&nbsp;<span class="op" id="6315281">!</span><span class="ident" id="6315282">r</span><span class="op" id="6315283">.</span><span class="ident" id="6315284">wroteHeader</span>&nbsp;<span class="op" id="6315296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6315300">r</span><span class="op" id="6315301">.</span><span class="ident" id="6315302">WriteHeader</span><span class="op" id="6315313">(</span><span class="ident" id="6315314">http</span><span class="op" id="6315318">.</span><span class="ident" id="6315319">StatusOK</span><span class="op" id="6315327">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6315330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6315333">r</span><span class="op" id="6315334">.</span><span class="ident" id="6315335">w</span><span class="op" id="6315336">.</span><span class="ident" id="6315337">Flush</span><span class="op" id="6315342">(</span><span class="op" id="6315343">)</span><br>
<span class="lineno"></span><span class="op" id="6315345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6315348">func</span>&nbsp;<span class="op" id="6315353">(</span><span class="ident" id="6315354">r</span>&nbsp;<span class="op" id="6315356">*</span><span class="ident" id="6315357">response</span><span class="op" id="6315365">)</span>&nbsp;<span class="ident" id="6315367">Close</span><span class="op" id="6315372">(</span><span class="op" id="6315373">)</span>&nbsp;<span class="builtintype" id="6315375">error</span>&nbsp;<span class="op" id="6315381">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6315384">r</span><span class="op" id="6315385">.</span><span class="ident" id="6315386">Flush</span><span class="op" id="6315391">(</span><span class="op" id="6315392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6315395">return</span>&nbsp;<span class="ident" id="6315402">r</span><span class="op" id="6315403">.</span><span class="ident" id="6315404">w</span><span class="op" id="6315405">.</span><span class="ident" id="6315406">Close</span><span class="op" id="6315411">(</span><span class="op" id="6315412">)</span><br>
<span class="lineno"></span><span class="op" id="6315414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6315417">type</span>&nbsp;<span class="ident" id="6315422">child</span>&nbsp;<span class="keyword" id="6315428">struct</span>&nbsp;<span class="op" id="6315435">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6315438">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6315446">*</span><span class="ident" id="6315447">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6315453">handler</span>&nbsp;<span class="ident" id="6315461">http</span><span class="op" id="6315465">.</span><span class="ident" id="6315466">Handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6315476">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6315485">sync</span><span class="op" id="6315489">.</span><span class="ident" id="6315490">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6315505">//&nbsp;protects&nbsp;requests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6315528">requests</span>&nbsp;<span class="keyword" id="6315537">map</span><span class="op" id="6315540">[</span><span class="builtintype" id="6315541">uint16</span><span class="op" id="6315547">]</span><span class="op" id="6315548">*</span><span class="ident" id="6315549">request</span>&nbsp;<span class="comment" id="6315557">//&nbsp;keyed&nbsp;by&nbsp;request&nbsp;ID</span><br>
<span class="lineno">135</span><span class="op" id="6315580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6315583">func</span>&nbsp;<span class="ident" id="6315588">newChild</span><span class="op" id="6315596">(</span><span class="ident" id="6315597">rwc</span>&nbsp;<span class="ident" id="6315601">io</span><span class="op" id="6315603">.</span><span class="ident" id="6315604">ReadWriteCloser</span><span class="op" id="6315619">,</span>&nbsp;<span class="ident" id="6315621">handler</span>&nbsp;<span class="ident" id="6315629">http</span><span class="op" id="6315633">.</span><span class="ident" id="6315634">Handler</span><span class="op" id="6315641">)</span>&nbsp;<span class="op" id="6315643">*</span><span class="ident" id="6315644">child</span>&nbsp;<span class="op" id="6315650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6315653">return</span>&nbsp;<span class="op" id="6315660">&amp;</span><span class="ident" id="6315661">child</span><span class="op" id="6315666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6315670">conn</span><span class="op" id="6315674">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6315680">newConn</span><span class="op" id="6315687">(</span><span class="ident" id="6315688">rwc</span><span class="op" id="6315691">)</span><span class="op" id="6315692">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6315696">handler</span><span class="op" id="6315703">:</span>&nbsp;&nbsp;<span class="ident" id="6315706">handler</span><span class="op" id="6315713">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6315717">requests</span><span class="op" id="6315725">:</span>&nbsp;<span class="builtinfunc" id="6315727">make</span><span class="op" id="6315731">(</span><span class="keyword" id="6315732">map</span><span class="op" id="6315735">[</span><span class="builtintype" id="6315736">uint16</span><span class="op" id="6315742">]</span><span class="op" id="6315743">*</span><span class="ident" id="6315744">request</span><span class="op" id="6315751">)</span><span class="op" id="6315752">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6315755">}</span><br>
<span class="lineno"></span><span class="op" id="6315757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="6315760">func</span>&nbsp;<span class="op" id="6315765">(</span><span class="ident" id="6315766">c</span>&nbsp;<span class="op" id="6315768">*</span><span class="ident" id="6315769">child</span><span class="op" id="6315774">)</span>&nbsp;<span class="ident" id="6315776">serve</span><span class="op" id="6315781">(</span><span class="op" id="6315782">)</span>&nbsp;<span class="op" id="6315784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6315787">defer</span>&nbsp;<span class="ident" id="6315793">c</span><span class="op" id="6315794">.</span><span class="ident" id="6315795">conn</span><span class="op" id="6315799">.</span><span class="ident" id="6315800">Close</span><span class="op" id="6315805">(</span><span class="op" id="6315806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6315809">var</span>&nbsp;<span class="ident" id="6315813">rec</span>&nbsp;<span class="ident" id="6315817">record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6315825">for</span>&nbsp;<span class="op" id="6315829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6315833">if</span>&nbsp;<span class="ident" id="6315836">err</span>&nbsp;<span class="op" id="6315840">:=</span>&nbsp;<span class="ident" id="6315843">rec</span><span class="op" id="6315846">.</span><span class="ident" id="6315847">read</span><span class="op" id="6315851">(</span><span class="ident" id="6315852">c</span><span class="op" id="6315853">.</span><span class="ident" id="6315854">conn</span><span class="op" id="6315858">.</span><span class="ident" id="6315859">rwc</span><span class="op" id="6315862">)</span><span class="op" id="6315863">;</span>&nbsp;<span class="ident" id="6315865">err</span>&nbsp;<span class="op" id="6315869">!=</span>&nbsp;<span class="ident" id="6315872">nil</span>&nbsp;<span class="op" id="6315876">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6315881">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6315890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6315894">if</span>&nbsp;<span class="ident" id="6315897">err</span>&nbsp;<span class="op" id="6315901">:=</span>&nbsp;<span class="ident" id="6315904">c</span><span class="op" id="6315905">.</span><span class="ident" id="6315906">handleRecord</span><span class="op" id="6315918">(</span><span class="op" id="6315919">&amp;</span><span class="ident" id="6315920">rec</span><span class="op" id="6315923">)</span><span class="op" id="6315924">;</span>&nbsp;<span class="ident" id="6315926">err</span>&nbsp;<span class="op" id="6315930">!=</span>&nbsp;<span class="ident" id="6315933">nil</span>&nbsp;<span class="op" id="6315937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6315942">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6315951">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6315954">}</span><br>
<span class="lineno"></span><span class="op" id="6315956">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6315959">var</span>&nbsp;<span class="ident" id="6315963">errCloseConn</span>&nbsp;<span class="op" id="6315976">=</span>&nbsp;<span class="ident" id="6315978">errors</span><span class="op" id="6315984">.</span><span class="ident" id="6315985">New</span><span class="op" id="6315988">(</span><span class="string" id="6315989">&#34;fcgi:&nbsp;connection&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="6316024">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="6316027">var</span>&nbsp;<span class="ident" id="6316031">emptyBody</span>&nbsp;<span class="op" id="6316041">=</span>&nbsp;<span class="ident" id="6316043">ioutil</span><span class="op" id="6316049">.</span><span class="ident" id="6316050">NopCloser</span><span class="op" id="6316059">(</span><span class="ident" id="6316060">strings</span><span class="op" id="6316067">.</span><span class="ident" id="6316068">NewReader</span><span class="op" id="6316077">(</span><span class="string" id="6316078">&#34;&#34;</span><span class="op" id="6316080">)</span><span class="op" id="6316081">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6316084">func</span>&nbsp;<span class="op" id="6316089">(</span><span class="ident" id="6316090">c</span>&nbsp;<span class="op" id="6316092">*</span><span class="ident" id="6316093">child</span><span class="op" id="6316098">)</span>&nbsp;<span class="ident" id="6316100">handleRecord</span><span class="op" id="6316112">(</span><span class="ident" id="6316113">rec</span>&nbsp;<span class="op" id="6316117">*</span><span class="ident" id="6316118">record</span><span class="op" id="6316124">)</span>&nbsp;<span class="builtintype" id="6316126">error</span>&nbsp;<span class="op" id="6316132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6316135">c</span><span class="op" id="6316136">.</span><span class="ident" id="6316137">mu</span><span class="op" id="6316139">.</span><span class="ident" id="6316140">Lock</span><span class="op" id="6316144">(</span><span class="op" id="6316145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6316148">req</span><span class="op" id="6316151">,</span>&nbsp;<span class="ident" id="6316153">ok</span>&nbsp;<span class="op" id="6316156">:=</span>&nbsp;<span class="ident" id="6316159">c</span><span class="op" id="6316160">.</span><span class="ident" id="6316161">requests</span><span class="op" id="6316169">[</span><span class="ident" id="6316170">rec</span><span class="op" id="6316173">.</span><span class="ident" id="6316174">h</span><span class="op" id="6316175">.</span><span class="ident" id="6316176">Id</span><span class="op" id="6316178">]</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6316181">c</span><span class="op" id="6316182">.</span><span class="ident" id="6316183">mu</span><span class="op" id="6316185">.</span><span class="ident" id="6316186">Unlock</span><span class="op" id="6316192">(</span><span class="op" id="6316193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6316196">if</span>&nbsp;<span class="op" id="6316199">!</span><span class="ident" id="6316200">ok</span>&nbsp;<span class="op" id="6316203">&amp;&amp;</span>&nbsp;<span class="ident" id="6316206">rec</span><span class="op" id="6316209">.</span><span class="ident" id="6316210">h</span><span class="op" id="6316211">.</span><span class="ident" id="6316212">Type</span>&nbsp;<span class="op" id="6316217">!=</span>&nbsp;<span class="ident" id="6316220">typeBeginRequest</span>&nbsp;<span class="op" id="6316237">&amp;&amp;</span>&nbsp;<span class="ident" id="6316240">rec</span><span class="op" id="6316243">.</span><span class="ident" id="6316244">h</span><span class="op" id="6316245">.</span><span class="ident" id="6316246">Type</span>&nbsp;<span class="op" id="6316251">!=</span>&nbsp;<span class="ident" id="6316254">typeGetValues</span>&nbsp;<span class="op" id="6316268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6316272">//&nbsp;The&nbsp;spec&nbsp;says&nbsp;to&nbsp;ignore&nbsp;unknown&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6316322">return</span>&nbsp;<span class="ident" id="6316329">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6316334">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6316338">switch</span>&nbsp;<span class="ident" id="6316345">rec</span><span class="op" id="6316348">.</span><span class="ident" id="6316349">h</span><span class="op" id="6316350">.</span><span class="ident" id="6316351">Type</span>&nbsp;<span class="op" id="6316356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6316359">case</span>&nbsp;<span class="ident" id="6316364">typeBeginRequest</span><span class="op" id="6316380">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6316384">if</span>&nbsp;<span class="ident" id="6316387">req</span>&nbsp;<span class="op" id="6316391">!=</span>&nbsp;<span class="ident" id="6316394">nil</span>&nbsp;<span class="op" id="6316398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6316403">//&nbsp;The&nbsp;server&nbsp;is&nbsp;trying&nbsp;to&nbsp;begin&nbsp;a&nbsp;request&nbsp;with&nbsp;the&nbsp;same&nbsp;ID</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6316466">//&nbsp;as&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;This&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6316517">return</span>&nbsp;<span class="ident" id="6316524">errors</span><span class="op" id="6316530">.</span><span class="ident" id="6316531">New</span><span class="op" id="6316534">(</span><span class="string" id="6316535">&#34;fcgi:&nbsp;received&nbsp;ID&nbsp;that&nbsp;is&nbsp;already&nbsp;in-flight&#34;</span><span class="op" id="6316580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6316584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6316589">var</span>&nbsp;<span class="ident" id="6316593">br</span>&nbsp;<span class="ident" id="6316596">beginRequest</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6316611">if</span>&nbsp;<span class="ident" id="6316614">err</span>&nbsp;<span class="op" id="6316618">:=</span>&nbsp;<span class="ident" id="6316621">br</span><span class="op" id="6316623">.</span><span class="ident" id="6316624">read</span><span class="op" id="6316628">(</span><span class="ident" id="6316629">rec</span><span class="op" id="6316632">.</span><span class="ident" id="6316633">content</span><span class="op" id="6316640">(</span><span class="op" id="6316641">)</span><span class="op" id="6316642">)</span><span class="op" id="6316643">;</span>&nbsp;<span class="ident" id="6316645">err</span>&nbsp;<span class="op" id="6316649">!=</span>&nbsp;<span class="ident" id="6316652">nil</span>&nbsp;<span class="op" id="6316656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6316661">return</span>&nbsp;<span class="ident" id="6316668">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6316674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6316678">if</span>&nbsp;<span class="ident" id="6316681">br</span><span class="op" id="6316683">.</span><span class="ident" id="6316684">role</span>&nbsp;<span class="op" id="6316689">!=</span>&nbsp;<span class="ident" id="6316692">roleResponder</span>&nbsp;<span class="op" id="6316706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6316711">c</span><span class="op" id="6316712">.</span><span class="ident" id="6316713">conn</span><span class="op" id="6316717">.</span><span class="ident" id="6316718">writeEndRequest</span><span class="op" id="6316733">(</span><span class="ident" id="6316734">rec</span><span class="op" id="6316737">.</span><span class="ident" id="6316738">h</span><span class="op" id="6316739">.</span><span class="ident" id="6316740">Id</span><span class="op" id="6316742">,</span>&nbsp;<span class="num" id="6316744">0</span><span class="op" id="6316745">,</span>&nbsp;<span class="ident" id="6316747">statusUnknownRole</span><span class="op" id="6316764">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6316769">return</span>&nbsp;<span class="ident" id="6316776">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6316782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6316786">req</span>&nbsp;<span class="op" id="6316790">=</span>&nbsp;<span class="ident" id="6316792">newRequest</span><span class="op" id="6316802">(</span><span class="ident" id="6316803">rec</span><span class="op" id="6316806">.</span><span class="ident" id="6316807">h</span><span class="op" id="6316808">.</span><span class="ident" id="6316809">Id</span><span class="op" id="6316811">,</span>&nbsp;<span class="ident" id="6316813">br</span><span class="op" id="6316815">.</span><span class="ident" id="6316816">flags</span><span class="op" id="6316821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6316825">c</span><span class="op" id="6316826">.</span><span class="ident" id="6316827">mu</span><span class="op" id="6316829">.</span><span class="ident" id="6316830">Lock</span><span class="op" id="6316834">(</span><span class="op" id="6316835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6316839">c</span><span class="op" id="6316840">.</span><span class="ident" id="6316841">requests</span><span class="op" id="6316849">[</span><span class="ident" id="6316850">rec</span><span class="op" id="6316853">.</span><span class="ident" id="6316854">h</span><span class="op" id="6316855">.</span><span class="ident" id="6316856">Id</span><span class="op" id="6316858">]</span>&nbsp;<span class="op" id="6316860">=</span>&nbsp;<span class="ident" id="6316862">req</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6316868">c</span><span class="op" id="6316869">.</span><span class="ident" id="6316870">mu</span><span class="op" id="6316872">.</span><span class="ident" id="6316873">Unlock</span><span class="op" id="6316879">(</span><span class="op" id="6316880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6316884">return</span>&nbsp;<span class="ident" id="6316891">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6316896">case</span>&nbsp;<span class="ident" id="6316901">typeParams</span><span class="op" id="6316911">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6316915">//&nbsp;NOTE(eds):&nbsp;Technically&nbsp;a&nbsp;key-value&nbsp;pair&nbsp;can&nbsp;straddle&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6316986">//&nbsp;between&nbsp;two&nbsp;packets.&nbsp;We&nbsp;buffer&nbsp;until&nbsp;we&#39;ve&nbsp;received&nbsp;all&nbsp;parameters.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6317059">if</span>&nbsp;<span class="builtinfunc" id="6317062">len</span><span class="op" id="6317065">(</span><span class="ident" id="6317066">rec</span><span class="op" id="6317069">.</span><span class="ident" id="6317070">content</span><span class="op" id="6317077">(</span><span class="op" id="6317078">)</span><span class="op" id="6317079">)</span>&nbsp;<span class="op" id="6317081">&gt;</span>&nbsp;<span class="num" id="6317083">0</span>&nbsp;<span class="op" id="6317085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6317090">req</span><span class="op" id="6317093">.</span><span class="ident" id="6317094">rawParams</span>&nbsp;<span class="op" id="6317104">=</span>&nbsp;<span class="builtinfunc" id="6317106">append</span><span class="op" id="6317112">(</span><span class="ident" id="6317113">req</span><span class="op" id="6317116">.</span><span class="ident" id="6317117">rawParams</span><span class="op" id="6317126">,</span>&nbsp;<span class="ident" id="6317128">rec</span><span class="op" id="6317131">.</span><span class="ident" id="6317132">content</span><span class="op" id="6317139">(</span><span class="op" id="6317140">)</span><span class="op" id="6317141">...</span><span class="op" id="6317144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6317149">return</span>&nbsp;<span class="ident" id="6317156">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6317162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6317166">req</span><span class="op" id="6317169">.</span><span class="ident" id="6317170">parseParams</span><span class="op" id="6317181">(</span><span class="op" id="6317182">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6317186">return</span>&nbsp;<span class="ident" id="6317193">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6317198">case</span>&nbsp;<span class="ident" id="6317203">typeStdin</span><span class="op" id="6317212">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6317216">content</span>&nbsp;<span class="op" id="6317224">:=</span>&nbsp;<span class="ident" id="6317227">rec</span><span class="op" id="6317230">.</span><span class="ident" id="6317231">content</span><span class="op" id="6317238">(</span><span class="op" id="6317239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6317243">if</span>&nbsp;<span class="ident" id="6317246">req</span><span class="op" id="6317249">.</span><span class="ident" id="6317250">pw</span>&nbsp;<span class="op" id="6317253">==</span>&nbsp;<span class="ident" id="6317256">nil</span>&nbsp;<span class="op" id="6317260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6317265">var</span>&nbsp;<span class="ident" id="6317269">body</span>&nbsp;<span class="ident" id="6317274">io</span><span class="op" id="6317276">.</span><span class="ident" id="6317277">ReadCloser</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6317291">if</span>&nbsp;<span class="builtinfunc" id="6317294">len</span><span class="op" id="6317297">(</span><span class="ident" id="6317298">content</span><span class="op" id="6317305">)</span>&nbsp;<span class="op" id="6317307">&gt;</span>&nbsp;<span class="num" id="6317309">0</span>&nbsp;<span class="op" id="6317311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6317317">//&nbsp;body&nbsp;could&nbsp;be&nbsp;an&nbsp;io.LimitReader,&nbsp;but&nbsp;it&nbsp;shouldn&#39;t&nbsp;matter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6317381">//&nbsp;as&nbsp;long&nbsp;as&nbsp;both&nbsp;sides&nbsp;are&nbsp;behaving.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6317424">body</span><span class="op" id="6317428">,</span>&nbsp;<span class="ident" id="6317430">req</span><span class="op" id="6317433">.</span><span class="ident" id="6317434">pw</span>&nbsp;<span class="op" id="6317437">=</span>&nbsp;<span class="ident" id="6317439">io</span><span class="op" id="6317441">.</span><span class="ident" id="6317442">Pipe</span><span class="op" id="6317446">(</span><span class="op" id="6317447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6317452">}</span>&nbsp;<span class="keyword" id="6317454">else</span>&nbsp;<span class="op" id="6317459">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6317465">body</span>&nbsp;<span class="op" id="6317470">=</span>&nbsp;<span class="ident" id="6317472">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6317485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6317490">go</span>&nbsp;<span class="ident" id="6317493">c</span><span class="op" id="6317494">.</span><span class="ident" id="6317495">serveRequest</span><span class="op" id="6317507">(</span><span class="ident" id="6317508">req</span><span class="op" id="6317511">,</span>&nbsp;<span class="ident" id="6317513">body</span><span class="op" id="6317517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6317521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6317525">if</span>&nbsp;<span class="builtinfunc" id="6317528">len</span><span class="op" id="6317531">(</span><span class="ident" id="6317532">content</span><span class="op" id="6317539">)</span>&nbsp;<span class="op" id="6317541">&gt;</span>&nbsp;<span class="num" id="6317543">0</span>&nbsp;<span class="op" id="6317545">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6317550">//&nbsp;TODO(eds):&nbsp;This&nbsp;blocks&nbsp;until&nbsp;the&nbsp;handler&nbsp;reads&nbsp;from&nbsp;the&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6317618">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;takes&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;might&nbsp;be&nbsp;a&nbsp;problem.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6317681">req</span><span class="op" id="6317684">.</span><span class="ident" id="6317685">pw</span><span class="op" id="6317687">.</span><span class="ident" id="6317688">Write</span><span class="op" id="6317693">(</span><span class="ident" id="6317694">content</span><span class="op" id="6317701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6317705">}</span>&nbsp;<span class="keyword" id="6317707">else</span>&nbsp;<span class="keyword" id="6317712">if</span>&nbsp;<span class="ident" id="6317715">req</span><span class="op" id="6317718">.</span><span class="ident" id="6317719">pw</span>&nbsp;<span class="op" id="6317722">!=</span>&nbsp;<span class="ident" id="6317725">nil</span>&nbsp;<span class="op" id="6317729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6317734">req</span><span class="op" id="6317737">.</span><span class="ident" id="6317738">pw</span><span class="op" id="6317740">.</span><span class="ident" id="6317741">Close</span><span class="op" id="6317746">(</span><span class="op" id="6317747">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6317751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6317755">return</span>&nbsp;<span class="ident" id="6317762">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6317767">case</span>&nbsp;<span class="ident" id="6317772">typeGetValues</span><span class="op" id="6317785">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6317789">values</span>&nbsp;<span class="op" id="6317796">:=</span>&nbsp;<span class="keyword" id="6317799">map</span><span class="op" id="6317802">[</span><span class="builtintype" id="6317803">string</span><span class="op" id="6317809">]</span><span class="builtintype" id="6317810">string</span><span class="op" id="6317816">{</span><span class="string" id="6317817">&#34;FCGI_MPXS_CONNS&#34;</span><span class="op" id="6317834">:</span>&nbsp;<span class="string" id="6317836">&#34;1&#34;</span><span class="op" id="6317839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6317843">c</span><span class="op" id="6317844">.</span><span class="ident" id="6317845">conn</span><span class="op" id="6317849">.</span><span class="ident" id="6317850">writePairs</span><span class="op" id="6317860">(</span><span class="ident" id="6317861">typeGetValuesResult</span><span class="op" id="6317880">,</span>&nbsp;<span class="num" id="6317882">0</span><span class="op" id="6317883">,</span>&nbsp;<span class="ident" id="6317885">values</span><span class="op" id="6317891">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6317895">return</span>&nbsp;<span class="ident" id="6317902">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6317907">case</span>&nbsp;<span class="ident" id="6317912">typeData</span><span class="op" id="6317920">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6317924">//&nbsp;If&nbsp;the&nbsp;filter&nbsp;role&nbsp;is&nbsp;implemented,&nbsp;read&nbsp;the&nbsp;data&nbsp;stream&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6317991">return</span>&nbsp;<span class="ident" id="6317998">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6318003">case</span>&nbsp;<span class="ident" id="6318008">typeAbortRequest</span><span class="op" id="6318024">:</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6318028">println</span><span class="op" id="6318035">(</span><span class="string" id="6318036">&#34;abort&#34;</span><span class="op" id="6318043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318047">c</span><span class="op" id="6318048">.</span><span class="ident" id="6318049">mu</span><span class="op" id="6318051">.</span><span class="ident" id="6318052">Lock</span><span class="op" id="6318056">(</span><span class="op" id="6318057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6318061">delete</span><span class="op" id="6318067">(</span><span class="ident" id="6318068">c</span><span class="op" id="6318069">.</span><span class="ident" id="6318070">requests</span><span class="op" id="6318078">,</span>&nbsp;<span class="ident" id="6318080">rec</span><span class="op" id="6318083">.</span><span class="ident" id="6318084">h</span><span class="op" id="6318085">.</span><span class="ident" id="6318086">Id</span><span class="op" id="6318088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318092">c</span><span class="op" id="6318093">.</span><span class="ident" id="6318094">mu</span><span class="op" id="6318096">.</span><span class="ident" id="6318097">Unlock</span><span class="op" id="6318103">(</span><span class="op" id="6318104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318108">c</span><span class="op" id="6318109">.</span><span class="ident" id="6318110">conn</span><span class="op" id="6318114">.</span><span class="ident" id="6318115">writeEndRequest</span><span class="op" id="6318130">(</span><span class="ident" id="6318131">rec</span><span class="op" id="6318134">.</span><span class="ident" id="6318135">h</span><span class="op" id="6318136">.</span><span class="ident" id="6318137">Id</span><span class="op" id="6318139">,</span>&nbsp;<span class="num" id="6318141">0</span><span class="op" id="6318142">,</span>&nbsp;<span class="ident" id="6318144">statusRequestComplete</span><span class="op" id="6318165">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6318169">if</span>&nbsp;<span class="op" id="6318172">!</span><span class="ident" id="6318173">req</span><span class="op" id="6318176">.</span><span class="ident" id="6318177">keepConn</span>&nbsp;<span class="op" id="6318186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6318191">//&nbsp;connection&nbsp;will&nbsp;close&nbsp;upon&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6318231">return</span>&nbsp;<span class="ident" id="6318238">errCloseConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6318253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6318257">return</span>&nbsp;<span class="ident" id="6318264">nil</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6318269">default</span><span class="op" id="6318276">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318280">b</span>&nbsp;<span class="op" id="6318282">:=</span>&nbsp;<span class="builtinfunc" id="6318285">make</span><span class="op" id="6318289">(</span><span class="op" id="6318290">[</span><span class="op" id="6318291">]</span><span class="builtintype" id="6318292">byte</span><span class="op" id="6318296">,</span>&nbsp;<span class="num" id="6318298">8</span><span class="op" id="6318299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318303">b</span><span class="op" id="6318304">[</span><span class="num" id="6318305">0</span><span class="op" id="6318306">]</span>&nbsp;<span class="op" id="6318308">=</span>&nbsp;<span class="builtintype" id="6318310">byte</span><span class="op" id="6318314">(</span><span class="ident" id="6318315">rec</span><span class="op" id="6318318">.</span><span class="ident" id="6318319">h</span><span class="op" id="6318320">.</span><span class="ident" id="6318321">Type</span><span class="op" id="6318325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318329">c</span><span class="op" id="6318330">.</span><span class="ident" id="6318331">conn</span><span class="op" id="6318335">.</span><span class="ident" id="6318336">writeRecord</span><span class="op" id="6318347">(</span><span class="ident" id="6318348">typeUnknownType</span><span class="op" id="6318363">,</span>&nbsp;<span class="num" id="6318365">0</span><span class="op" id="6318366">,</span>&nbsp;<span class="ident" id="6318368">b</span><span class="op" id="6318369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6318373">return</span>&nbsp;<span class="ident" id="6318380">nil</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6318385">}</span><br>
<span class="lineno"></span><span class="op" id="6318387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6318390">func</span>&nbsp;<span class="op" id="6318395">(</span><span class="ident" id="6318396">c</span>&nbsp;<span class="op" id="6318398">*</span><span class="ident" id="6318399">child</span><span class="op" id="6318404">)</span>&nbsp;<span class="ident" id="6318406">serveRequest</span><span class="op" id="6318418">(</span><span class="ident" id="6318419">req</span>&nbsp;<span class="op" id="6318423">*</span><span class="ident" id="6318424">request</span><span class="op" id="6318431">,</span>&nbsp;<span class="ident" id="6318433">body</span>&nbsp;<span class="ident" id="6318438">io</span><span class="op" id="6318440">.</span><span class="ident" id="6318441">ReadCloser</span><span class="op" id="6318451">)</span>&nbsp;<span class="op" id="6318453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318456">r</span>&nbsp;<span class="op" id="6318458">:=</span>&nbsp;<span class="ident" id="6318461">newResponse</span><span class="op" id="6318472">(</span><span class="ident" id="6318473">c</span><span class="op" id="6318474">,</span>&nbsp;<span class="ident" id="6318476">req</span><span class="op" id="6318479">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318482">httpReq</span><span class="op" id="6318489">,</span>&nbsp;<span class="ident" id="6318491">err</span>&nbsp;<span class="op" id="6318495">:=</span>&nbsp;<span class="ident" id="6318498">cgi</span><span class="op" id="6318501">.</span><span class="ident" id="6318502">RequestFromMap</span><span class="op" id="6318516">(</span><span class="ident" id="6318517">req</span><span class="op" id="6318520">.</span><span class="ident" id="6318521">params</span><span class="op" id="6318527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6318530">if</span>&nbsp;<span class="ident" id="6318533">err</span>&nbsp;<span class="op" id="6318537">!=</span>&nbsp;<span class="ident" id="6318540">nil</span>&nbsp;<span class="op" id="6318544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6318548">//&nbsp;there&nbsp;was&nbsp;an&nbsp;error&nbsp;reading&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318592">r</span><span class="op" id="6318593">.</span><span class="ident" id="6318594">WriteHeader</span><span class="op" id="6318605">(</span><span class="ident" id="6318606">http</span><span class="op" id="6318610">.</span><span class="ident" id="6318611">StatusInternalServerError</span><span class="op" id="6318636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318640">c</span><span class="op" id="6318641">.</span><span class="ident" id="6318642">conn</span><span class="op" id="6318646">.</span><span class="ident" id="6318647">writeRecord</span><span class="op" id="6318658">(</span><span class="ident" id="6318659">typeStderr</span><span class="op" id="6318669">,</span>&nbsp;<span class="ident" id="6318671">req</span><span class="op" id="6318674">.</span><span class="ident" id="6318675">reqId</span><span class="op" id="6318680">,</span>&nbsp;<span class="op" id="6318682">[</span><span class="op" id="6318683">]</span><span class="builtintype" id="6318684">byte</span><span class="op" id="6318688">(</span><span class="ident" id="6318689">err</span><span class="op" id="6318692">.</span><span class="ident" id="6318693">Error</span><span class="op" id="6318698">(</span><span class="op" id="6318699">)</span><span class="op" id="6318700">)</span><span class="op" id="6318701">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6318704">}</span>&nbsp;<span class="keyword" id="6318706">else</span>&nbsp;<span class="op" id="6318711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318715">httpReq</span><span class="op" id="6318722">.</span><span class="ident" id="6318723">Body</span>&nbsp;<span class="op" id="6318728">=</span>&nbsp;<span class="ident" id="6318730">body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318737">c</span><span class="op" id="6318738">.</span><span class="ident" id="6318739">handler</span><span class="op" id="6318746">.</span><span class="ident" id="6318747">ServeHTTP</span><span class="op" id="6318756">(</span><span class="ident" id="6318757">r</span><span class="op" id="6318758">,</span>&nbsp;<span class="ident" id="6318760">httpReq</span><span class="op" id="6318767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6318770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318773">r</span><span class="op" id="6318774">.</span><span class="ident" id="6318775">Close</span><span class="op" id="6318780">(</span><span class="op" id="6318781">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318784">c</span><span class="op" id="6318785">.</span><span class="ident" id="6318786">mu</span><span class="op" id="6318788">.</span><span class="ident" id="6318789">Lock</span><span class="op" id="6318793">(</span><span class="op" id="6318794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6318797">delete</span><span class="op" id="6318803">(</span><span class="ident" id="6318804">c</span><span class="op" id="6318805">.</span><span class="ident" id="6318806">requests</span><span class="op" id="6318814">,</span>&nbsp;<span class="ident" id="6318816">req</span><span class="op" id="6318819">.</span><span class="ident" id="6318820">reqId</span><span class="op" id="6318825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318828">c</span><span class="op" id="6318829">.</span><span class="ident" id="6318830">mu</span><span class="op" id="6318832">.</span><span class="ident" id="6318833">Unlock</span><span class="op" id="6318839">(</span><span class="op" id="6318840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6318843">c</span><span class="op" id="6318844">.</span><span class="ident" id="6318845">conn</span><span class="op" id="6318849">.</span><span class="ident" id="6318850">writeEndRequest</span><span class="op" id="6318865">(</span><span class="ident" id="6318866">req</span><span class="op" id="6318869">.</span><span class="ident" id="6318870">reqId</span><span class="op" id="6318875">,</span>&nbsp;<span class="num" id="6318877">0</span><span class="op" id="6318878">,</span>&nbsp;<span class="ident" id="6318880">statusRequestComplete</span><span class="op" id="6318901">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6318905">//&nbsp;Consume&nbsp;the&nbsp;entire&nbsp;body,&nbsp;so&nbsp;the&nbsp;host&nbsp;isn&#39;t&nbsp;still&nbsp;writing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6318969">//&nbsp;us&nbsp;when&nbsp;we&nbsp;close&nbsp;the&nbsp;socket&nbsp;below&nbsp;in&nbsp;the&nbsp;!keepConn&nbsp;case,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6319030">//&nbsp;otherwise&nbsp;we&#39;d&nbsp;send&nbsp;a&nbsp;RST.&nbsp;(golang.org/issue/4183)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6319085">//&nbsp;TODO(bradfitz):&nbsp;also&nbsp;bound&nbsp;this&nbsp;copy&nbsp;in&nbsp;time.&nbsp;Or&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6319143">//&nbsp;some&nbsp;sort&nbsp;of&nbsp;abort&nbsp;request&nbsp;to&nbsp;the&nbsp;host,&nbsp;so&nbsp;the&nbsp;host</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6319199">//&nbsp;can&nbsp;properly&nbsp;cut&nbsp;off&nbsp;the&nbsp;client&nbsp;sending&nbsp;all&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6319257">//&nbsp;For&nbsp;now&nbsp;just&nbsp;bound&nbsp;it&nbsp;a&nbsp;little&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319296">io</span><span class="op" id="6319298">.</span><span class="ident" id="6319299">CopyN</span><span class="op" id="6319304">(</span><span class="ident" id="6319305">ioutil</span><span class="op" id="6319311">.</span><span class="ident" id="6319312">Discard</span><span class="op" id="6319319">,</span>&nbsp;<span class="ident" id="6319321">body</span><span class="op" id="6319325">,</span>&nbsp;<span class="num" id="6319327">100</span><span class="op" id="6319330">&lt;&lt;</span><span class="num" id="6319332">20</span><span class="op" id="6319334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319337">body</span><span class="op" id="6319341">.</span><span class="ident" id="6319342">Close</span><span class="op" id="6319347">(</span><span class="op" id="6319348">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6319352">if</span>&nbsp;<span class="op" id="6319355">!</span><span class="ident" id="6319356">req</span><span class="op" id="6319359">.</span><span class="ident" id="6319360">keepConn</span>&nbsp;<span class="op" id="6319369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319373">c</span><span class="op" id="6319374">.</span><span class="ident" id="6319375">conn</span><span class="op" id="6319379">.</span><span class="ident" id="6319380">Close</span><span class="op" id="6319385">(</span><span class="op" id="6319386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6319389">}</span><br>
<span class="lineno"></span><span class="op" id="6319391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="6319394">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;FastCGI&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,&nbsp;creating&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="6319474">//&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;The&nbsp;goroutine&nbsp;reads&nbsp;requests&nbsp;and&nbsp;then&nbsp;calls&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="6319549">//&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="6319570">//&nbsp;If&nbsp;l&nbsp;is&nbsp;nil,&nbsp;Serve&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;os.Stdin.</span><br>
<span class="lineno"></span><span class="comment" id="6319627">//&nbsp;If&nbsp;handler&nbsp;is&nbsp;nil,&nbsp;http.DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno">285</span><span class="keyword" id="6319679">func</span>&nbsp;<span class="ident" id="6319684">Serve</span><span class="op" id="6319689">(</span><span class="ident" id="6319690">l</span>&nbsp;<span class="ident" id="6319692">net</span><span class="op" id="6319695">.</span><span class="ident" id="6319696">Listener</span><span class="op" id="6319704">,</span>&nbsp;<span class="ident" id="6319706">handler</span>&nbsp;<span class="ident" id="6319714">http</span><span class="op" id="6319718">.</span><span class="ident" id="6319719">Handler</span><span class="op" id="6319726">)</span>&nbsp;<span class="builtintype" id="6319728">error</span>&nbsp;<span class="op" id="6319734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6319737">if</span>&nbsp;<span class="ident" id="6319740">l</span>&nbsp;<span class="op" id="6319742">==</span>&nbsp;<span class="ident" id="6319745">nil</span>&nbsp;<span class="op" id="6319749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6319753">var</span>&nbsp;<span class="ident" id="6319757">err</span>&nbsp;<span class="builtintype" id="6319761">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319769">l</span><span class="op" id="6319770">,</span>&nbsp;<span class="ident" id="6319772">err</span>&nbsp;<span class="op" id="6319776">=</span>&nbsp;<span class="ident" id="6319778">net</span><span class="op" id="6319781">.</span><span class="ident" id="6319782">FileListener</span><span class="op" id="6319794">(</span><span class="ident" id="6319795">os</span><span class="op" id="6319797">.</span><span class="ident" id="6319798">Stdin</span><span class="op" id="6319803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6319807">if</span>&nbsp;<span class="ident" id="6319810">err</span>&nbsp;<span class="op" id="6319814">!=</span>&nbsp;<span class="ident" id="6319817">nil</span>&nbsp;<span class="op" id="6319821">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6319826">return</span>&nbsp;<span class="ident" id="6319833">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6319839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6319843">defer</span>&nbsp;<span class="ident" id="6319849">l</span><span class="op" id="6319850">.</span><span class="ident" id="6319851">Close</span><span class="op" id="6319856">(</span><span class="op" id="6319857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6319860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6319863">if</span>&nbsp;<span class="ident" id="6319866">handler</span>&nbsp;<span class="op" id="6319874">==</span>&nbsp;<span class="ident" id="6319877">nil</span>&nbsp;<span class="op" id="6319881">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319885">handler</span>&nbsp;<span class="op" id="6319893">=</span>&nbsp;<span class="ident" id="6319895">http</span><span class="op" id="6319899">.</span><span class="ident" id="6319900">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6319917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6319920">for</span>&nbsp;<span class="op" id="6319924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319928">rw</span><span class="op" id="6319930">,</span>&nbsp;<span class="ident" id="6319932">err</span>&nbsp;<span class="op" id="6319936">:=</span>&nbsp;<span class="ident" id="6319939">l</span><span class="op" id="6319940">.</span><span class="ident" id="6319941">Accept</span><span class="op" id="6319947">(</span><span class="op" id="6319948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6319952">if</span>&nbsp;<span class="ident" id="6319955">err</span>&nbsp;<span class="op" id="6319959">!=</span>&nbsp;<span class="ident" id="6319962">nil</span>&nbsp;<span class="op" id="6319966">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6319971">return</span>&nbsp;<span class="ident" id="6319978">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6319984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6319988">c</span>&nbsp;<span class="op" id="6319990">:=</span>&nbsp;<span class="ident" id="6319993">newChild</span><span class="op" id="6320001">(</span><span class="ident" id="6320002">rw</span><span class="op" id="6320004">,</span>&nbsp;<span class="ident" id="6320006">handler</span><span class="op" id="6320013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6320017">go</span>&nbsp;<span class="ident" id="6320020">c</span><span class="op" id="6320021">.</span><span class="ident" id="6320022">serve</span><span class="op" id="6320027">(</span><span class="op" id="6320028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6320031">}</span><br>
<span class="lineno">305</span><span class="op" id="6320033">}</span>
</div>
</body>
</html>
