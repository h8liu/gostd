<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/gob</h2>
<ul>
<li><a href="/gostd/encoding/gob/codec_test.go.html">codec_test.go</a></li>
<li><a href="/gostd/encoding/gob/dec_helpers.go.html">dec_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/gob/decoder.go.html">decoder.go</a></li>
<li><a href="/gostd/encoding/gob/doc.go.html">doc.go</a></li>
<li><a href="/gostd/encoding/gob/enc_helpers.go.html">enc_helpers.go</a></li>
<li><a href="/gostd/encoding/gob/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/gob/encoder.go.html">encoder.go</a></li>
<li><a href="/gostd/encoding/gob/encoder_test.go.html">encoder_test.go</a></li>
<li><a href="/gostd/encoding/gob/error.go.html">error.go</a></li>
<li><a href="/gostd/encoding/gob/example_encdec_test.go.html">example_encdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_interface_test.go.html">example_interface_test.go</a></li>
<li><a href="/gostd/encoding/gob/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/gob/gobencdec_test.go.html">gobencdec_test.go</a></li>
<li><a href="/gostd/encoding/gob/timing_test.go.html">timing_test.go</a></li>
<li><a href="/gostd/encoding/gob/type.go.html">type.go</a></li>
<li><a href="/gostd/encoding/gob/type_test.go.html">type_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3124940">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3124995">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3125049">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3125100">//go:generate&nbsp;go&nbsp;run&nbsp;encgen.go&nbsp;-output&nbsp;enc_helpers.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3125155">package</span>&nbsp;<span class="ident" id="3125163">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3125168">import</span>&nbsp;<span class="op" id="3125175">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3125178">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3125190">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3125198">&#34;reflect&#34;</span><br>
<span class="lineno"></span><span class="op" id="3125208">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="3125211">const</span>&nbsp;<span class="ident" id="3125217">uint64Size</span>&nbsp;<span class="op" id="3125228">=</span>&nbsp;<span class="num" id="3125230">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3125233">type</span>&nbsp;<span class="ident" id="3125238">encHelper</span>&nbsp;<span class="keyword" id="3125248">func</span><span class="op" id="3125252">(</span><span class="ident" id="3125253">state</span>&nbsp;<span class="op" id="3125259">*</span><span class="ident" id="3125260">encoderState</span><span class="op" id="3125272">,</span>&nbsp;<span class="ident" id="3125274">v</span>&nbsp;<span class="ident" id="3125276">reflect</span><span class="op" id="3125283">.</span><span class="ident" id="3125284">Value</span><span class="op" id="3125289">)</span>&nbsp;<span class="builtintype" id="3125291">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3125297">//&nbsp;encoderState&nbsp;is&nbsp;the&nbsp;global&nbsp;execution&nbsp;state&nbsp;of&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno">20</span><span class="comment" id="3125374">//&nbsp;Field&nbsp;numbers&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;and&nbsp;always&nbsp;increase.&nbsp;The&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="3125440">//&nbsp;number&nbsp;is&nbsp;initialized&nbsp;to&nbsp;-1&nbsp;so&nbsp;0&nbsp;comes&nbsp;out&nbsp;as&nbsp;delta(1).&nbsp;A&nbsp;delta&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3125510">//&nbsp;0&nbsp;terminates&nbsp;the&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="3125541">type</span>&nbsp;<span class="ident" id="3125546">encoderState</span>&nbsp;<span class="keyword" id="3125559">struct</span>&nbsp;<span class="op" id="3125566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3125569">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3125578">*</span><span class="ident" id="3125579">Encoder</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3125588">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3125597">*</span><span class="ident" id="3125598">encBuffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3125609">sendZero</span>&nbsp;<span class="builtintype" id="3125618">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125639">//&nbsp;encoding&nbsp;an&nbsp;array&nbsp;element&nbsp;or&nbsp;map&nbsp;key/value&nbsp;pair;&nbsp;send&nbsp;zero&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3125709">fieldnum</span>&nbsp;<span class="builtintype" id="3125718">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125739">//&nbsp;the&nbsp;last&nbsp;field&nbsp;number&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3125774">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3125783">[</span><span class="num" id="3125784">1</span>&nbsp;<span class="op" id="3125786">+</span>&nbsp;<span class="ident" id="3125788">uint64Size</span><span class="op" id="3125798">]</span><span class="builtintype" id="3125799">byte</span>&nbsp;<span class="comment" id="3125804">//&nbsp;buffer&nbsp;used&nbsp;by&nbsp;the&nbsp;encoder;&nbsp;here&nbsp;to&nbsp;avoid&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3125862">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3125871">*</span><span class="ident" id="3125872">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125892">//&nbsp;for&nbsp;free&nbsp;list</span><br>
<span class="lineno">30</span><span class="op" id="3125909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3125912">//&nbsp;encBuffer&nbsp;is&nbsp;an&nbsp;extremely&nbsp;simple,&nbsp;fast&nbsp;implementation&nbsp;of&nbsp;a&nbsp;write-only&nbsp;byte&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment" id="3125998">//&nbsp;It&nbsp;never&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;but&nbsp;Write&nbsp;returns&nbsp;an&nbsp;error&nbsp;value&nbsp;so&nbsp;it&nbsp;matches&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="3126093">type</span>&nbsp;<span class="ident" id="3126098">encBuffer</span>&nbsp;<span class="keyword" id="3126108">struct</span>&nbsp;<span class="op" id="3126115">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126118">data</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3126126">[</span><span class="op" id="3126127">]</span><span class="builtintype" id="3126128">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126134">scratch</span>&nbsp;<span class="op" id="3126142">[</span><span class="num" id="3126143">64</span><span class="op" id="3126145">]</span><span class="builtintype" id="3126146">byte</span><br>
<span class="lineno"></span><span class="op" id="3126151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3126154">func</span>&nbsp;<span class="op" id="3126159">(</span><span class="ident" id="3126160">e</span>&nbsp;<span class="op" id="3126162">*</span><span class="ident" id="3126163">encBuffer</span><span class="op" id="3126172">)</span>&nbsp;<span class="ident" id="3126174">WriteByte</span><span class="op" id="3126183">(</span><span class="ident" id="3126184">c</span>&nbsp;<span class="builtintype" id="3126186">byte</span><span class="op" id="3126190">)</span>&nbsp;<span class="op" id="3126192">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126195">e</span><span class="op" id="3126196">.</span><span class="ident" id="3126197">data</span>&nbsp;<span class="op" id="3126202">=</span>&nbsp;<span class="builtinfunc" id="3126204">append</span><span class="op" id="3126210">(</span><span class="ident" id="3126211">e</span><span class="op" id="3126212">.</span><span class="ident" id="3126213">data</span><span class="op" id="3126217">,</span>&nbsp;<span class="ident" id="3126219">c</span><span class="op" id="3126220">)</span><br>
<span class="lineno"></span><span class="op" id="3126222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3126225">func</span>&nbsp;<span class="op" id="3126230">(</span><span class="ident" id="3126231">e</span>&nbsp;<span class="op" id="3126233">*</span><span class="ident" id="3126234">encBuffer</span><span class="op" id="3126243">)</span>&nbsp;<span class="ident" id="3126245">Write</span><span class="op" id="3126250">(</span><span class="ident" id="3126251">p</span>&nbsp;<span class="op" id="3126253">[</span><span class="op" id="3126254">]</span><span class="builtintype" id="3126255">byte</span><span class="op" id="3126259">)</span>&nbsp;<span class="op" id="3126261">(</span><span class="builtintype" id="3126262">int</span><span class="op" id="3126265">,</span>&nbsp;<span class="builtintype" id="3126267">error</span><span class="op" id="3126272">)</span>&nbsp;<span class="op" id="3126274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126277">e</span><span class="op" id="3126278">.</span><span class="ident" id="3126279">data</span>&nbsp;<span class="op" id="3126284">=</span>&nbsp;<span class="builtinfunc" id="3126286">append</span><span class="op" id="3126292">(</span><span class="ident" id="3126293">e</span><span class="op" id="3126294">.</span><span class="ident" id="3126295">data</span><span class="op" id="3126299">,</span>&nbsp;<span class="ident" id="3126301">p</span><span class="op" id="3126302">...</span><span class="op" id="3126305">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3126308">return</span>&nbsp;<span class="builtinfunc" id="3126315">len</span><span class="op" id="3126318">(</span><span class="ident" id="3126319">p</span><span class="op" id="3126320">)</span><span class="op" id="3126321">,</span>&nbsp;<span class="ident" id="3126323">nil</span><br>
<span class="lineno"></span><span class="op" id="3126327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3126330">func</span>&nbsp;<span class="op" id="3126335">(</span><span class="ident" id="3126336">e</span>&nbsp;<span class="op" id="3126338">*</span><span class="ident" id="3126339">encBuffer</span><span class="op" id="3126348">)</span>&nbsp;<span class="ident" id="3126350">WriteString</span><span class="op" id="3126361">(</span><span class="ident" id="3126362">s</span>&nbsp;<span class="builtintype" id="3126364">string</span><span class="op" id="3126370">)</span>&nbsp;<span class="op" id="3126372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126375">e</span><span class="op" id="3126376">.</span><span class="ident" id="3126377">data</span>&nbsp;<span class="op" id="3126382">=</span>&nbsp;<span class="builtinfunc" id="3126384">append</span><span class="op" id="3126390">(</span><span class="ident" id="3126391">e</span><span class="op" id="3126392">.</span><span class="ident" id="3126393">data</span><span class="op" id="3126397">,</span>&nbsp;<span class="ident" id="3126399">s</span><span class="op" id="3126400">...</span><span class="op" id="3126403">)</span><br>
<span class="lineno">50</span><span class="op" id="3126405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3126408">func</span>&nbsp;<span class="op" id="3126413">(</span><span class="ident" id="3126414">e</span>&nbsp;<span class="op" id="3126416">*</span><span class="ident" id="3126417">encBuffer</span><span class="op" id="3126426">)</span>&nbsp;<span class="ident" id="3126428">Len</span><span class="op" id="3126431">(</span><span class="op" id="3126432">)</span>&nbsp;<span class="builtintype" id="3126434">int</span>&nbsp;<span class="op" id="3126438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3126441">return</span>&nbsp;<span class="builtinfunc" id="3126448">len</span><span class="op" id="3126451">(</span><span class="ident" id="3126452">e</span><span class="op" id="3126453">.</span><span class="ident" id="3126454">data</span><span class="op" id="3126458">)</span><br>
<span class="lineno"></span><span class="op" id="3126460">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="3126463">func</span>&nbsp;<span class="op" id="3126468">(</span><span class="ident" id="3126469">e</span>&nbsp;<span class="op" id="3126471">*</span><span class="ident" id="3126472">encBuffer</span><span class="op" id="3126481">)</span>&nbsp;<span class="ident" id="3126483">Bytes</span><span class="op" id="3126488">(</span><span class="op" id="3126489">)</span>&nbsp;<span class="op" id="3126491">[</span><span class="op" id="3126492">]</span><span class="builtintype" id="3126493">byte</span>&nbsp;<span class="op" id="3126498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3126501">return</span>&nbsp;<span class="ident" id="3126508">e</span><span class="op" id="3126509">.</span><span class="ident" id="3126510">data</span><br>
<span class="lineno"></span><span class="op" id="3126515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="3126518">func</span>&nbsp;<span class="op" id="3126523">(</span><span class="ident" id="3126524">e</span>&nbsp;<span class="op" id="3126526">*</span><span class="ident" id="3126527">encBuffer</span><span class="op" id="3126536">)</span>&nbsp;<span class="ident" id="3126538">Reset</span><span class="op" id="3126543">(</span><span class="op" id="3126544">)</span>&nbsp;<span class="op" id="3126546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126549">e</span><span class="op" id="3126550">.</span><span class="ident" id="3126551">data</span>&nbsp;<span class="op" id="3126556">=</span>&nbsp;<span class="ident" id="3126558">e</span><span class="op" id="3126559">.</span><span class="ident" id="3126560">data</span><span class="op" id="3126564">[</span><span class="num" id="3126565">0</span><span class="op" id="3126566">:</span><span class="num" id="3126567">0</span><span class="op" id="3126568">]</span><br>
<span class="lineno"></span><span class="op" id="3126570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3126573">func</span>&nbsp;<span class="op" id="3126578">(</span><span class="ident" id="3126579">enc</span>&nbsp;<span class="op" id="3126583">*</span><span class="ident" id="3126584">Encoder</span><span class="op" id="3126591">)</span>&nbsp;<span class="ident" id="3126593">newEncoderState</span><span class="op" id="3126608">(</span><span class="ident" id="3126609">b</span>&nbsp;<span class="op" id="3126611">*</span><span class="ident" id="3126612">encBuffer</span><span class="op" id="3126621">)</span>&nbsp;<span class="op" id="3126623">*</span><span class="ident" id="3126624">encoderState</span>&nbsp;<span class="op" id="3126637">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126640">e</span>&nbsp;<span class="op" id="3126642">:=</span>&nbsp;<span class="ident" id="3126645">enc</span><span class="op" id="3126648">.</span><span class="ident" id="3126649">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3126659">if</span>&nbsp;<span class="ident" id="3126662">e</span>&nbsp;<span class="op" id="3126664">==</span>&nbsp;<span class="ident" id="3126667">nil</span>&nbsp;<span class="op" id="3126671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126675">e</span>&nbsp;<span class="op" id="3126677">=</span>&nbsp;<span class="builtinfunc" id="3126679">new</span><span class="op" id="3126682">(</span><span class="ident" id="3126683">encoderState</span><span class="op" id="3126695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126699">e</span><span class="op" id="3126700">.</span><span class="ident" id="3126701">enc</span>&nbsp;<span class="op" id="3126705">=</span>&nbsp;<span class="ident" id="3126707">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3126712">}</span>&nbsp;<span class="keyword" id="3126714">else</span>&nbsp;<span class="op" id="3126719">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126723">enc</span><span class="op" id="3126726">.</span><span class="ident" id="3126727">freeList</span>&nbsp;<span class="op" id="3126736">=</span>&nbsp;<span class="ident" id="3126738">e</span><span class="op" id="3126739">.</span><span class="ident" id="3126740">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3126746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126749">e</span><span class="op" id="3126750">.</span><span class="ident" id="3126751">sendZero</span>&nbsp;<span class="op" id="3126760">=</span>&nbsp;<span class="builtintype" id="3126762">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126769">e</span><span class="op" id="3126770">.</span><span class="ident" id="3126771">fieldnum</span>&nbsp;<span class="op" id="3126780">=</span>&nbsp;<span class="num" id="3126782">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126785">e</span><span class="op" id="3126786">.</span><span class="ident" id="3126787">b</span>&nbsp;<span class="op" id="3126789">=</span>&nbsp;<span class="ident" id="3126791">b</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3126794">if</span>&nbsp;<span class="builtinfunc" id="3126797">len</span><span class="op" id="3126800">(</span><span class="ident" id="3126801">b</span><span class="op" id="3126802">.</span><span class="ident" id="3126803">data</span><span class="op" id="3126807">)</span>&nbsp;<span class="op" id="3126809">==</span>&nbsp;<span class="num" id="3126812">0</span>&nbsp;<span class="op" id="3126814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126818">b</span><span class="op" id="3126819">.</span><span class="ident" id="3126820">data</span>&nbsp;<span class="op" id="3126825">=</span>&nbsp;<span class="ident" id="3126827">b</span><span class="op" id="3126828">.</span><span class="ident" id="3126829">scratch</span><span class="op" id="3126836">[</span><span class="num" id="3126837">0</span><span class="op" id="3126838">:</span><span class="num" id="3126839">0</span><span class="op" id="3126840">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3126843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3126846">return</span>&nbsp;<span class="ident" id="3126853">e</span><br>
<span class="lineno"></span><span class="op" id="3126855">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="3126858">func</span>&nbsp;<span class="op" id="3126863">(</span><span class="ident" id="3126864">enc</span>&nbsp;<span class="op" id="3126868">*</span><span class="ident" id="3126869">Encoder</span><span class="op" id="3126876">)</span>&nbsp;<span class="ident" id="3126878">freeEncoderState</span><span class="op" id="3126894">(</span><span class="ident" id="3126895">e</span>&nbsp;<span class="op" id="3126897">*</span><span class="ident" id="3126898">encoderState</span><span class="op" id="3126910">)</span>&nbsp;<span class="op" id="3126912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126915">e</span><span class="op" id="3126916">.</span><span class="ident" id="3126917">next</span>&nbsp;<span class="op" id="3126922">=</span>&nbsp;<span class="ident" id="3126924">enc</span><span class="op" id="3126927">.</span><span class="ident" id="3126928">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3126938">enc</span><span class="op" id="3126941">.</span><span class="ident" id="3126942">freeList</span>&nbsp;<span class="op" id="3126951">=</span>&nbsp;<span class="ident" id="3126953">e</span><br>
<span class="lineno"></span><span class="op" id="3126955">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="3126958">//&nbsp;Unsigned&nbsp;integers&nbsp;have&nbsp;a&nbsp;two-state&nbsp;encoding.&nbsp;&nbsp;If&nbsp;the&nbsp;number&nbsp;is&nbsp;less</span><br>
<span class="lineno"></span><span class="comment" id="3127029">//&nbsp;than&nbsp;128&nbsp;(0&nbsp;through&nbsp;0x7F),&nbsp;its&nbsp;value&nbsp;is&nbsp;written&nbsp;directly.</span><br>
<span class="lineno"></span><span class="comment" id="3127090">//&nbsp;Otherwise&nbsp;the&nbsp;value&nbsp;is&nbsp;written&nbsp;in&nbsp;big-endian&nbsp;byte&nbsp;order&nbsp;preceded</span><br>
<span class="lineno"></span><span class="comment" id="3127158">//&nbsp;by&nbsp;the&nbsp;byte&nbsp;length,&nbsp;negated.</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="3127191">//&nbsp;encodeUint&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;unsigned&nbsp;integer&nbsp;to&nbsp;state.b.</span><br>
<span class="lineno"></span><span class="keyword" id="3127252">func</span>&nbsp;<span class="op" id="3127257">(</span><span class="ident" id="3127258">state</span>&nbsp;<span class="op" id="3127264">*</span><span class="ident" id="3127265">encoderState</span><span class="op" id="3127277">)</span>&nbsp;<span class="ident" id="3127279">encodeUint</span><span class="op" id="3127289">(</span><span class="ident" id="3127290">x</span>&nbsp;<span class="ident" id="3127292">uint64</span><span class="op" id="3127298">)</span>&nbsp;<span class="op" id="3127300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3127303">if</span>&nbsp;<span class="ident" id="3127306">x</span>&nbsp;<span class="op" id="3127308">&lt;=</span>&nbsp;<span class="num" id="3127311">0x7F</span>&nbsp;<span class="op" id="3127316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127320">state</span><span class="op" id="3127325">.</span><span class="ident" id="3127326">b</span><span class="op" id="3127327">.</span><span class="ident" id="3127328">WriteByte</span><span class="op" id="3127337">(</span><span class="builtintype" id="3127338">uint8</span><span class="op" id="3127343">(</span><span class="ident" id="3127344">x</span><span class="op" id="3127345">)</span><span class="op" id="3127346">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3127350">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3127358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127361">i</span>&nbsp;<span class="op" id="3127363">:=</span>&nbsp;<span class="ident" id="3127366">uint64Size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3127378">for</span>&nbsp;<span class="ident" id="3127382">x</span>&nbsp;<span class="op" id="3127384">&gt;</span>&nbsp;<span class="num" id="3127386">0</span>&nbsp;<span class="op" id="3127388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127392">state</span><span class="op" id="3127397">.</span><span class="ident" id="3127398">buf</span><span class="op" id="3127401">[</span><span class="ident" id="3127402">i</span><span class="op" id="3127403">]</span>&nbsp;<span class="op" id="3127405">=</span>&nbsp;<span class="builtintype" id="3127407">uint8</span><span class="op" id="3127412">(</span><span class="ident" id="3127413">x</span><span class="op" id="3127414">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127418">x</span>&nbsp;<span class="op" id="3127420">&gt;&gt;=</span>&nbsp;<span class="num" id="3127424">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127428">i</span><span class="op" id="3127429">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3127433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127436">state</span><span class="op" id="3127441">.</span><span class="ident" id="3127442">buf</span><span class="op" id="3127445">[</span><span class="ident" id="3127446">i</span><span class="op" id="3127447">]</span>&nbsp;<span class="op" id="3127449">=</span>&nbsp;<span class="builtintype" id="3127451">uint8</span><span class="op" id="3127456">(</span><span class="ident" id="3127457">i</span>&nbsp;<span class="op" id="3127459">-</span>&nbsp;<span class="ident" id="3127461">uint64Size</span><span class="op" id="3127471">)</span>&nbsp;<span class="comment" id="3127473">//&nbsp;=&nbsp;loop&nbsp;count,&nbsp;negated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127499">state</span><span class="op" id="3127504">.</span><span class="ident" id="3127505">b</span><span class="op" id="3127506">.</span><span class="ident" id="3127507">Write</span><span class="op" id="3127512">(</span><span class="ident" id="3127513">state</span><span class="op" id="3127518">.</span><span class="ident" id="3127519">buf</span><span class="op" id="3127522">[</span><span class="ident" id="3127523">i</span>&nbsp;<span class="op" id="3127525">:</span>&nbsp;<span class="ident" id="3127527">uint64Size</span><span class="op" id="3127537">+</span><span class="num" id="3127538">1</span><span class="op" id="3127539">]</span><span class="op" id="3127540">)</span><br>
<span class="lineno">105</span><span class="op" id="3127542">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3127545">//&nbsp;encodeInt&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;signed&nbsp;integer&nbsp;to&nbsp;state.w.</span><br>
<span class="lineno"></span><span class="comment" id="3127603">//&nbsp;The&nbsp;low&nbsp;bit&nbsp;of&nbsp;the&nbsp;encoding&nbsp;says&nbsp;whether&nbsp;to&nbsp;bit&nbsp;complement&nbsp;the&nbsp;(other&nbsp;bits&nbsp;of&nbsp;the)</span><br>
<span class="lineno"></span><span class="comment" id="3127689">//&nbsp;uint&nbsp;to&nbsp;recover&nbsp;the&nbsp;int.</span><br>
<span class="lineno">110</span><span class="keyword" id="3127717">func</span>&nbsp;<span class="op" id="3127722">(</span><span class="ident" id="3127723">state</span>&nbsp;<span class="op" id="3127729">*</span><span class="ident" id="3127730">encoderState</span><span class="op" id="3127742">)</span>&nbsp;<span class="ident" id="3127744">encodeInt</span><span class="op" id="3127753">(</span><span class="ident" id="3127754">i</span>&nbsp;<span class="ident" id="3127756">int64</span><span class="op" id="3127761">)</span>&nbsp;<span class="op" id="3127763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3127766">var</span>&nbsp;<span class="ident" id="3127770">x</span>&nbsp;<span class="ident" id="3127772">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3127780">if</span>&nbsp;<span class="ident" id="3127783">i</span>&nbsp;<span class="op" id="3127785">&lt;</span>&nbsp;<span class="num" id="3127787">0</span>&nbsp;<span class="op" id="3127789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127793">x</span>&nbsp;<span class="op" id="3127795">=</span>&nbsp;<span class="ident" id="3127797">uint64</span><span class="op" id="3127803">(</span><span class="op" id="3127804">^</span><span class="ident" id="3127805">i</span><span class="op" id="3127806">&lt;&lt;</span><span class="num" id="3127808">1</span><span class="op" id="3127809">)</span>&nbsp;<span class="op" id="3127811">|</span>&nbsp;<span class="num" id="3127813">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3127816">}</span>&nbsp;<span class="keyword" id="3127818">else</span>&nbsp;<span class="op" id="3127823">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127827">x</span>&nbsp;<span class="op" id="3127829">=</span>&nbsp;<span class="ident" id="3127831">uint64</span><span class="op" id="3127837">(</span><span class="ident" id="3127838">i</span>&nbsp;<span class="op" id="3127840">&lt;&lt;</span>&nbsp;<span class="num" id="3127843">1</span><span class="op" id="3127844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3127847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3127850">state</span><span class="op" id="3127855">.</span><span class="ident" id="3127856">encodeUint</span><span class="op" id="3127866">(</span><span class="ident" id="3127867">uint64</span><span class="op" id="3127873">(</span><span class="ident" id="3127874">x</span><span class="op" id="3127875">)</span><span class="op" id="3127876">)</span><br>
<span class="lineno"></span><span class="op" id="3127878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="3127881">//&nbsp;encOp&nbsp;is&nbsp;the&nbsp;signature&nbsp;of&nbsp;an&nbsp;encoding&nbsp;operator&nbsp;for&nbsp;a&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3127949">type</span>&nbsp;<span class="ident" id="3127954">encOp</span>&nbsp;<span class="keyword" id="3127960">func</span><span class="op" id="3127964">(</span><span class="ident" id="3127965">i</span>&nbsp;<span class="op" id="3127967">*</span><span class="ident" id="3127968">encInstr</span><span class="op" id="3127976">,</span>&nbsp;<span class="ident" id="3127978">state</span>&nbsp;<span class="op" id="3127984">*</span><span class="ident" id="3127985">encoderState</span><span class="op" id="3127997">,</span>&nbsp;<span class="ident" id="3127999">v</span>&nbsp;<span class="ident" id="3128001">reflect</span><span class="op" id="3128008">.</span><span class="ident" id="3128009">Value</span><span class="op" id="3128014">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3128017">//&nbsp;The&nbsp;&#39;instructions&#39;&nbsp;of&nbsp;the&nbsp;encoding&nbsp;machine</span><br>
<span class="lineno"></span><span class="keyword" id="3128063">type</span>&nbsp;<span class="ident" id="3128068">encInstr</span>&nbsp;<span class="keyword" id="3128077">struct</span>&nbsp;<span class="op" id="3128084">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128087">op</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128093">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128100">field</span>&nbsp;<span class="builtintype" id="3128106">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3128112">//&nbsp;field&nbsp;number&nbsp;in&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128138">index</span>&nbsp;<span class="op" id="3128144">[</span><span class="op" id="3128145">]</span><span class="builtintype" id="3128146">int</span>&nbsp;<span class="comment" id="3128150">//&nbsp;struct&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128167">indir</span>&nbsp;<span class="builtintype" id="3128173">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3128179">//&nbsp;how&nbsp;many&nbsp;pointer&nbsp;indirections&nbsp;to&nbsp;reach&nbsp;the&nbsp;value&nbsp;in&nbsp;the&nbsp;struct</span><br>
<span class="lineno"></span><span class="op" id="3128245">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="3128248">//&nbsp;update&nbsp;emits&nbsp;a&nbsp;field&nbsp;number&nbsp;and&nbsp;updates&nbsp;the&nbsp;state&nbsp;to&nbsp;record&nbsp;its&nbsp;value&nbsp;for&nbsp;delta&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="comment" id="3128341">//&nbsp;If&nbsp;the&nbsp;instruction&nbsp;pointer&nbsp;is&nbsp;nil,&nbsp;it&nbsp;does&nbsp;nothing</span><br>
<span class="lineno"></span><span class="keyword" id="3128395">func</span>&nbsp;<span class="op" id="3128400">(</span><span class="ident" id="3128401">state</span>&nbsp;<span class="op" id="3128407">*</span><span class="ident" id="3128408">encoderState</span><span class="op" id="3128420">)</span>&nbsp;<span class="ident" id="3128422">update</span><span class="op" id="3128428">(</span><span class="ident" id="3128429">instr</span>&nbsp;<span class="op" id="3128435">*</span><span class="ident" id="3128436">encInstr</span><span class="op" id="3128444">)</span>&nbsp;<span class="op" id="3128446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3128449">if</span>&nbsp;<span class="ident" id="3128452">instr</span>&nbsp;<span class="op" id="3128458">!=</span>&nbsp;<span class="ident" id="3128461">nil</span>&nbsp;<span class="op" id="3128465">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128469">state</span><span class="op" id="3128474">.</span><span class="ident" id="3128475">encodeUint</span><span class="op" id="3128485">(</span><span class="ident" id="3128486">uint64</span><span class="op" id="3128492">(</span><span class="ident" id="3128493">instr</span><span class="op" id="3128498">.</span><span class="ident" id="3128499">field</span>&nbsp;<span class="op" id="3128505">-</span>&nbsp;<span class="ident" id="3128507">state</span><span class="op" id="3128512">.</span><span class="ident" id="3128513">fieldnum</span><span class="op" id="3128521">)</span><span class="op" id="3128522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3128526">state</span><span class="op" id="3128531">.</span><span class="ident" id="3128532">fieldnum</span>&nbsp;<span class="op" id="3128541">=</span>&nbsp;<span class="ident" id="3128543">instr</span><span class="op" id="3128548">.</span><span class="ident" id="3128549">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3128556">}</span><br>
<span class="lineno"></span><span class="op" id="3128558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3128561">//&nbsp;Each&nbsp;encoder&nbsp;for&nbsp;a&nbsp;composite&nbsp;is&nbsp;responsible&nbsp;for&nbsp;handling&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="3128625">//&nbsp;indirections&nbsp;associated&nbsp;with&nbsp;the&nbsp;elements&nbsp;of&nbsp;the&nbsp;data&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="3128693">//&nbsp;If&nbsp;any&nbsp;pointer&nbsp;so&nbsp;reached&nbsp;is&nbsp;nil,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3128760">//&nbsp;data&nbsp;item&nbsp;is&nbsp;zero,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;Single&nbsp;values&nbsp;-&nbsp;ints,</span><br>
<span class="lineno"></span><span class="comment" id="3128827">//&nbsp;strings&nbsp;etc.&nbsp;-&nbsp;are&nbsp;indirected&nbsp;before&nbsp;calling&nbsp;their&nbsp;encoders.</span><br>
<span class="lineno">145</span><span class="comment" id="3128891">//&nbsp;Otherwise,&nbsp;the&nbsp;output&nbsp;(for&nbsp;a&nbsp;scalar)&nbsp;is&nbsp;the&nbsp;field&nbsp;number,&nbsp;as&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="3128958">//&nbsp;encoded&nbsp;integer,&nbsp;followed&nbsp;by&nbsp;the&nbsp;field&nbsp;data&nbsp;in&nbsp;its&nbsp;appropriate</span><br>
<span class="lineno"></span><span class="comment" id="3129024">//&nbsp;format.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3129036">//&nbsp;encIndirect&nbsp;dereferences&nbsp;pv&nbsp;indir&nbsp;times&nbsp;and&nbsp;returns&nbsp;the&nbsp;result.</span><br>
<span class="lineno">150</span><span class="keyword" id="3129103">func</span>&nbsp;<span class="ident" id="3129108">encIndirect</span><span class="op" id="3129119">(</span><span class="ident" id="3129120">pv</span>&nbsp;<span class="ident" id="3129123">reflect</span><span class="op" id="3129130">.</span><span class="ident" id="3129131">Value</span><span class="op" id="3129136">,</span>&nbsp;<span class="ident" id="3129138">indir</span>&nbsp;<span class="builtintype" id="3129144">int</span><span class="op" id="3129147">)</span>&nbsp;<span class="ident" id="3129149">reflect</span><span class="op" id="3129156">.</span><span class="ident" id="3129157">Value</span>&nbsp;<span class="op" id="3129163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129166">for</span>&nbsp;<span class="op" id="3129170">;</span>&nbsp;<span class="ident" id="3129172">indir</span>&nbsp;<span class="op" id="3129178">&gt;</span>&nbsp;<span class="num" id="3129180">0</span><span class="op" id="3129181">;</span>&nbsp;<span class="ident" id="3129183">indir</span><span class="op" id="3129188">--</span>&nbsp;<span class="op" id="3129191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129195">if</span>&nbsp;<span class="ident" id="3129198">pv</span><span class="op" id="3129200">.</span><span class="ident" id="3129201">IsNil</span><span class="op" id="3129206">(</span><span class="op" id="3129207">)</span>&nbsp;<span class="op" id="3129209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129214">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3129222">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3129226">pv</span>&nbsp;<span class="op" id="3129229">=</span>&nbsp;<span class="ident" id="3129231">pv</span><span class="op" id="3129233">.</span><span class="ident" id="3129234">Elem</span><span class="op" id="3129238">(</span><span class="op" id="3129239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3129242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129245">return</span>&nbsp;<span class="ident" id="3129252">pv</span><br>
<span class="lineno"></span><span class="op" id="3129255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="3129258">//&nbsp;encBool&nbsp;encodes&nbsp;the&nbsp;bool&nbsp;referenced&nbsp;by&nbsp;v&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;0&nbsp;or&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="3129325">func</span>&nbsp;<span class="ident" id="3129330">encBool</span><span class="op" id="3129337">(</span><span class="ident" id="3129338">i</span>&nbsp;<span class="op" id="3129340">*</span><span class="ident" id="3129341">encInstr</span><span class="op" id="3129349">,</span>&nbsp;<span class="ident" id="3129351">state</span>&nbsp;<span class="op" id="3129357">*</span><span class="ident" id="3129358">encoderState</span><span class="op" id="3129370">,</span>&nbsp;<span class="ident" id="3129372">v</span>&nbsp;<span class="ident" id="3129374">reflect</span><span class="op" id="3129381">.</span><span class="ident" id="3129382">Value</span><span class="op" id="3129387">)</span>&nbsp;<span class="op" id="3129389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3129392">b</span>&nbsp;<span class="op" id="3129394">:=</span>&nbsp;<span class="ident" id="3129397">v</span><span class="op" id="3129398">.</span><span class="ident" id="3129399">Bool</span><span class="op" id="3129403">(</span><span class="op" id="3129404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129407">if</span>&nbsp;<span class="ident" id="3129410">b</span>&nbsp;<span class="op" id="3129412">||</span>&nbsp;<span class="ident" id="3129415">state</span><span class="op" id="3129420">.</span><span class="ident" id="3129421">sendZero</span>&nbsp;<span class="op" id="3129430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3129434">state</span><span class="op" id="3129439">.</span><span class="ident" id="3129440">update</span><span class="op" id="3129446">(</span><span class="ident" id="3129447">i</span><span class="op" id="3129448">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129452">if</span>&nbsp;<span class="ident" id="3129455">b</span>&nbsp;<span class="op" id="3129457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3129462">state</span><span class="op" id="3129467">.</span><span class="ident" id="3129468">encodeUint</span><span class="op" id="3129478">(</span><span class="num" id="3129479">1</span><span class="op" id="3129480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3129484">}</span>&nbsp;<span class="keyword" id="3129486">else</span>&nbsp;<span class="op" id="3129491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3129496">state</span><span class="op" id="3129501">.</span><span class="ident" id="3129502">encodeUint</span><span class="op" id="3129512">(</span><span class="num" id="3129513">0</span><span class="op" id="3129514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3129518">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3129521">}</span><br>
<span class="lineno"></span><span class="op" id="3129523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3129526">//&nbsp;encInt&nbsp;encodes&nbsp;the&nbsp;signed&nbsp;integer&nbsp;(int&nbsp;int8&nbsp;int16&nbsp;int32&nbsp;int64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="3129609">func</span>&nbsp;<span class="ident" id="3129614">encInt</span><span class="op" id="3129620">(</span><span class="ident" id="3129621">i</span>&nbsp;<span class="op" id="3129623">*</span><span class="ident" id="3129624">encInstr</span><span class="op" id="3129632">,</span>&nbsp;<span class="ident" id="3129634">state</span>&nbsp;<span class="op" id="3129640">*</span><span class="ident" id="3129641">encoderState</span><span class="op" id="3129653">,</span>&nbsp;<span class="ident" id="3129655">v</span>&nbsp;<span class="ident" id="3129657">reflect</span><span class="op" id="3129664">.</span><span class="ident" id="3129665">Value</span><span class="op" id="3129670">)</span>&nbsp;<span class="op" id="3129672">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3129675">value</span>&nbsp;<span class="op" id="3129681">:=</span>&nbsp;<span class="ident" id="3129684">v</span><span class="op" id="3129685">.</span><span class="ident" id="3129686">Int</span><span class="op" id="3129689">(</span><span class="op" id="3129690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129693">if</span>&nbsp;<span class="ident" id="3129696">value</span>&nbsp;<span class="op" id="3129702">!=</span>&nbsp;<span class="num" id="3129705">0</span>&nbsp;<span class="op" id="3129707">||</span>&nbsp;<span class="ident" id="3129710">state</span><span class="op" id="3129715">.</span><span class="ident" id="3129716">sendZero</span>&nbsp;<span class="op" id="3129725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3129729">state</span><span class="op" id="3129734">.</span><span class="ident" id="3129735">update</span><span class="op" id="3129741">(</span><span class="ident" id="3129742">i</span><span class="op" id="3129743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3129747">state</span><span class="op" id="3129752">.</span><span class="ident" id="3129753">encodeInt</span><span class="op" id="3129762">(</span><span class="ident" id="3129763">value</span><span class="op" id="3129768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3129771">}</span><br>
<span class="lineno">180</span><span class="op" id="3129773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3129776">//&nbsp;encUint&nbsp;encodes&nbsp;the&nbsp;unsigned&nbsp;integer&nbsp;(uint&nbsp;uint8&nbsp;uint16&nbsp;uint32&nbsp;uint64&nbsp;uintptr)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="3129875">func</span>&nbsp;<span class="ident" id="3129880">encUint</span><span class="op" id="3129887">(</span><span class="ident" id="3129888">i</span>&nbsp;<span class="op" id="3129890">*</span><span class="ident" id="3129891">encInstr</span><span class="op" id="3129899">,</span>&nbsp;<span class="ident" id="3129901">state</span>&nbsp;<span class="op" id="3129907">*</span><span class="ident" id="3129908">encoderState</span><span class="op" id="3129920">,</span>&nbsp;<span class="ident" id="3129922">v</span>&nbsp;<span class="ident" id="3129924">reflect</span><span class="op" id="3129931">.</span><span class="ident" id="3129932">Value</span><span class="op" id="3129937">)</span>&nbsp;<span class="op" id="3129939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3129942">value</span>&nbsp;<span class="op" id="3129948">:=</span>&nbsp;<span class="ident" id="3129951">v</span><span class="op" id="3129952">.</span><span class="ident" id="3129953">Uint</span><span class="op" id="3129957">(</span><span class="op" id="3129958">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3129961">if</span>&nbsp;<span class="ident" id="3129964">value</span>&nbsp;<span class="op" id="3129970">!=</span>&nbsp;<span class="num" id="3129973">0</span>&nbsp;<span class="op" id="3129975">||</span>&nbsp;<span class="ident" id="3129978">state</span><span class="op" id="3129983">.</span><span class="ident" id="3129984">sendZero</span>&nbsp;<span class="op" id="3129993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3129997">state</span><span class="op" id="3130002">.</span><span class="ident" id="3130003">update</span><span class="op" id="3130009">(</span><span class="ident" id="3130010">i</span><span class="op" id="3130011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3130015">state</span><span class="op" id="3130020">.</span><span class="ident" id="3130021">encodeUint</span><span class="op" id="3130031">(</span><span class="ident" id="3130032">value</span><span class="op" id="3130037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3130040">}</span><br>
<span class="lineno"></span><span class="op" id="3130042">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="3130045">//&nbsp;floatBits&nbsp;returns&nbsp;a&nbsp;uint64&nbsp;holding&nbsp;the&nbsp;bits&nbsp;of&nbsp;a&nbsp;floating-point&nbsp;number.</span><br>
<span class="lineno"></span><span class="comment" id="3130120">//&nbsp;Floating-point&nbsp;numbers&nbsp;are&nbsp;transmitted&nbsp;as&nbsp;uint64s&nbsp;holding&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="3130190">//&nbsp;of&nbsp;the&nbsp;underlying&nbsp;representation.&nbsp;&nbsp;They&nbsp;are&nbsp;sent&nbsp;byte-reversed,&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="3130262">//&nbsp;the&nbsp;exponent&nbsp;end&nbsp;coming&nbsp;out&nbsp;first,&nbsp;so&nbsp;integer&nbsp;floating&nbsp;point&nbsp;numbers</span><br>
<span class="lineno">195</span><span class="comment" id="3130334">//&nbsp;(for&nbsp;example)&nbsp;transmit&nbsp;more&nbsp;compactly.&nbsp;&nbsp;This&nbsp;routine&nbsp;does&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3130399">//&nbsp;swizzling.</span><br>
<span class="lineno"></span><span class="keyword" id="3130413">func</span>&nbsp;<span class="ident" id="3130418">floatBits</span><span class="op" id="3130427">(</span><span class="ident" id="3130428">f</span>&nbsp;<span class="builtintype" id="3130430">float64</span><span class="op" id="3130437">)</span>&nbsp;<span class="ident" id="3130439">uint64</span>&nbsp;<span class="op" id="3130446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3130449">u</span>&nbsp;<span class="op" id="3130451">:=</span>&nbsp;<span class="ident" id="3130454">math</span><span class="op" id="3130458">.</span><span class="ident" id="3130459">Float64bits</span><span class="op" id="3130470">(</span><span class="ident" id="3130471">f</span><span class="op" id="3130472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3130475">var</span>&nbsp;<span class="ident" id="3130479">v</span>&nbsp;<span class="ident" id="3130481">uint64</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3130489">for</span>&nbsp;<span class="ident" id="3130493">i</span>&nbsp;<span class="op" id="3130495">:=</span>&nbsp;<span class="num" id="3130498">0</span><span class="op" id="3130499">;</span>&nbsp;<span class="ident" id="3130501">i</span>&nbsp;<span class="op" id="3130503">&lt;</span>&nbsp;<span class="num" id="3130505">8</span><span class="op" id="3130506">;</span>&nbsp;<span class="ident" id="3130508">i</span><span class="op" id="3130509">++</span>&nbsp;<span class="op" id="3130512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3130516">v</span>&nbsp;<span class="op" id="3130518">&lt;&lt;=</span>&nbsp;<span class="num" id="3130522">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3130526">v</span>&nbsp;<span class="op" id="3130528">|=</span>&nbsp;<span class="ident" id="3130531">u</span>&nbsp;<span class="op" id="3130533">&amp;</span>&nbsp;<span class="num" id="3130535">0xFF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3130542">u</span>&nbsp;<span class="op" id="3130544">&gt;&gt;=</span>&nbsp;<span class="num" id="3130548">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3130551">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3130554">return</span>&nbsp;<span class="ident" id="3130561">v</span><br>
<span class="lineno"></span><span class="op" id="3130563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3130566">//&nbsp;encFloat&nbsp;encodes&nbsp;the&nbsp;floating&nbsp;point&nbsp;value&nbsp;(float32&nbsp;float64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="3130646">func</span>&nbsp;<span class="ident" id="3130651">encFloat</span><span class="op" id="3130659">(</span><span class="ident" id="3130660">i</span>&nbsp;<span class="op" id="3130662">*</span><span class="ident" id="3130663">encInstr</span><span class="op" id="3130671">,</span>&nbsp;<span class="ident" id="3130673">state</span>&nbsp;<span class="op" id="3130679">*</span><span class="ident" id="3130680">encoderState</span><span class="op" id="3130692">,</span>&nbsp;<span class="ident" id="3130694">v</span>&nbsp;<span class="ident" id="3130696">reflect</span><span class="op" id="3130703">.</span><span class="ident" id="3130704">Value</span><span class="op" id="3130709">)</span>&nbsp;<span class="op" id="3130711">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3130714">f</span>&nbsp;<span class="op" id="3130716">:=</span>&nbsp;<span class="ident" id="3130719">v</span><span class="op" id="3130720">.</span><span class="ident" id="3130721">Float</span><span class="op" id="3130726">(</span><span class="op" id="3130727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3130730">if</span>&nbsp;<span class="ident" id="3130733">f</span>&nbsp;<span class="op" id="3130735">!=</span>&nbsp;<span class="num" id="3130738">0</span>&nbsp;<span class="op" id="3130740">||</span>&nbsp;<span class="ident" id="3130743">state</span><span class="op" id="3130748">.</span><span class="ident" id="3130749">sendZero</span>&nbsp;<span class="op" id="3130758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3130762">bits</span>&nbsp;<span class="op" id="3130767">:=</span>&nbsp;<span class="ident" id="3130770">floatBits</span><span class="op" id="3130779">(</span><span class="ident" id="3130780">f</span><span class="op" id="3130781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3130785">state</span><span class="op" id="3130790">.</span><span class="ident" id="3130791">update</span><span class="op" id="3130797">(</span><span class="ident" id="3130798">i</span><span class="op" id="3130799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3130803">state</span><span class="op" id="3130808">.</span><span class="ident" id="3130809">encodeUint</span><span class="op" id="3130819">(</span><span class="ident" id="3130820">bits</span><span class="op" id="3130824">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3130827">}</span><br>
<span class="lineno"></span><span class="op" id="3130829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3130832">//&nbsp;encComplex&nbsp;encodes&nbsp;the&nbsp;complex&nbsp;value&nbsp;(complex64&nbsp;complex128)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="3130912">//&nbsp;Complex&nbsp;numbers&nbsp;are&nbsp;just&nbsp;a&nbsp;pair&nbsp;of&nbsp;floating-point&nbsp;numbers,&nbsp;real&nbsp;part&nbsp;first.</span><br>
<span class="lineno">220</span><span class="keyword" id="3130991">func</span>&nbsp;<span class="ident" id="3130996">encComplex</span><span class="op" id="3131006">(</span><span class="ident" id="3131007">i</span>&nbsp;<span class="op" id="3131009">*</span><span class="ident" id="3131010">encInstr</span><span class="op" id="3131018">,</span>&nbsp;<span class="ident" id="3131020">state</span>&nbsp;<span class="op" id="3131026">*</span><span class="ident" id="3131027">encoderState</span><span class="op" id="3131039">,</span>&nbsp;<span class="ident" id="3131041">v</span>&nbsp;<span class="ident" id="3131043">reflect</span><span class="op" id="3131050">.</span><span class="ident" id="3131051">Value</span><span class="op" id="3131056">)</span>&nbsp;<span class="op" id="3131058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131061">c</span>&nbsp;<span class="op" id="3131063">:=</span>&nbsp;<span class="ident" id="3131066">v</span><span class="op" id="3131067">.</span><span class="ident" id="3131068">Complex</span><span class="op" id="3131075">(</span><span class="op" id="3131076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3131079">if</span>&nbsp;<span class="ident" id="3131082">c</span>&nbsp;<span class="op" id="3131084">!=</span>&nbsp;<span class="num" id="3131087">0</span><span class="op" id="3131088">+</span><span class="num" id="3131089">0i</span>&nbsp;<span class="op" id="3131092">||</span>&nbsp;<span class="ident" id="3131095">state</span><span class="op" id="3131100">.</span><span class="ident" id="3131101">sendZero</span>&nbsp;<span class="op" id="3131110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131114">rpart</span>&nbsp;<span class="op" id="3131120">:=</span>&nbsp;<span class="ident" id="3131123">floatBits</span><span class="op" id="3131132">(</span><span class="builtinfunc" id="3131133">real</span><span class="op" id="3131137">(</span><span class="ident" id="3131138">c</span><span class="op" id="3131139">)</span><span class="op" id="3131140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131144">ipart</span>&nbsp;<span class="op" id="3131150">:=</span>&nbsp;<span class="ident" id="3131153">floatBits</span><span class="op" id="3131162">(</span><span class="builtinfunc" id="3131163">imag</span><span class="op" id="3131167">(</span><span class="ident" id="3131168">c</span><span class="op" id="3131169">)</span><span class="op" id="3131170">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131174">state</span><span class="op" id="3131179">.</span><span class="ident" id="3131180">update</span><span class="op" id="3131186">(</span><span class="ident" id="3131187">i</span><span class="op" id="3131188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131192">state</span><span class="op" id="3131197">.</span><span class="ident" id="3131198">encodeUint</span><span class="op" id="3131208">(</span><span class="ident" id="3131209">rpart</span><span class="op" id="3131214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131218">state</span><span class="op" id="3131223">.</span><span class="ident" id="3131224">encodeUint</span><span class="op" id="3131234">(</span><span class="ident" id="3131235">ipart</span><span class="op" id="3131240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3131243">}</span><br>
<span class="lineno"></span><span class="op" id="3131245">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="3131248">//&nbsp;encUint8Array&nbsp;encodes&nbsp;the&nbsp;byte&nbsp;array&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="3131305">//&nbsp;Byte&nbsp;arrays&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3131380">func</span>&nbsp;<span class="ident" id="3131385">encUint8Array</span><span class="op" id="3131398">(</span><span class="ident" id="3131399">i</span>&nbsp;<span class="op" id="3131401">*</span><span class="ident" id="3131402">encInstr</span><span class="op" id="3131410">,</span>&nbsp;<span class="ident" id="3131412">state</span>&nbsp;<span class="op" id="3131418">*</span><span class="ident" id="3131419">encoderState</span><span class="op" id="3131431">,</span>&nbsp;<span class="ident" id="3131433">v</span>&nbsp;<span class="ident" id="3131435">reflect</span><span class="op" id="3131442">.</span><span class="ident" id="3131443">Value</span><span class="op" id="3131448">)</span>&nbsp;<span class="op" id="3131450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131453">b</span>&nbsp;<span class="op" id="3131455">:=</span>&nbsp;<span class="ident" id="3131458">v</span><span class="op" id="3131459">.</span><span class="ident" id="3131460">Bytes</span><span class="op" id="3131465">(</span><span class="op" id="3131466">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3131469">if</span>&nbsp;<span class="builtinfunc" id="3131472">len</span><span class="op" id="3131475">(</span><span class="ident" id="3131476">b</span><span class="op" id="3131477">)</span>&nbsp;<span class="op" id="3131479">&gt;</span>&nbsp;<span class="num" id="3131481">0</span>&nbsp;<span class="op" id="3131483">||</span>&nbsp;<span class="ident" id="3131486">state</span><span class="op" id="3131491">.</span><span class="ident" id="3131492">sendZero</span>&nbsp;<span class="op" id="3131501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131505">state</span><span class="op" id="3131510">.</span><span class="ident" id="3131511">update</span><span class="op" id="3131517">(</span><span class="ident" id="3131518">i</span><span class="op" id="3131519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131523">state</span><span class="op" id="3131528">.</span><span class="ident" id="3131529">encodeUint</span><span class="op" id="3131539">(</span><span class="ident" id="3131540">uint64</span><span class="op" id="3131546">(</span><span class="builtinfunc" id="3131547">len</span><span class="op" id="3131550">(</span><span class="ident" id="3131551">b</span><span class="op" id="3131552">)</span><span class="op" id="3131553">)</span><span class="op" id="3131554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131558">state</span><span class="op" id="3131563">.</span><span class="ident" id="3131564">b</span><span class="op" id="3131565">.</span><span class="ident" id="3131566">Write</span><span class="op" id="3131571">(</span><span class="ident" id="3131572">b</span><span class="op" id="3131573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3131576">}</span><br>
<span class="lineno">240</span><span class="op" id="3131578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3131581">//&nbsp;encString&nbsp;encodes&nbsp;the&nbsp;string&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="3131630">//&nbsp;Strings&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3131701">func</span>&nbsp;<span class="ident" id="3131706">encString</span><span class="op" id="3131715">(</span><span class="ident" id="3131716">i</span>&nbsp;<span class="op" id="3131718">*</span><span class="ident" id="3131719">encInstr</span><span class="op" id="3131727">,</span>&nbsp;<span class="ident" id="3131729">state</span>&nbsp;<span class="op" id="3131735">*</span><span class="ident" id="3131736">encoderState</span><span class="op" id="3131748">,</span>&nbsp;<span class="ident" id="3131750">v</span>&nbsp;<span class="ident" id="3131752">reflect</span><span class="op" id="3131759">.</span><span class="ident" id="3131760">Value</span><span class="op" id="3131765">)</span>&nbsp;<span class="op" id="3131767">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131770">s</span>&nbsp;<span class="op" id="3131772">:=</span>&nbsp;<span class="ident" id="3131775">v</span><span class="op" id="3131776">.</span><span class="ident" id="3131777">String</span><span class="op" id="3131783">(</span><span class="op" id="3131784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3131787">if</span>&nbsp;<span class="builtinfunc" id="3131790">len</span><span class="op" id="3131793">(</span><span class="ident" id="3131794">s</span><span class="op" id="3131795">)</span>&nbsp;<span class="op" id="3131797">&gt;</span>&nbsp;<span class="num" id="3131799">0</span>&nbsp;<span class="op" id="3131801">||</span>&nbsp;<span class="ident" id="3131804">state</span><span class="op" id="3131809">.</span><span class="ident" id="3131810">sendZero</span>&nbsp;<span class="op" id="3131819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131823">state</span><span class="op" id="3131828">.</span><span class="ident" id="3131829">update</span><span class="op" id="3131835">(</span><span class="ident" id="3131836">i</span><span class="op" id="3131837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131841">state</span><span class="op" id="3131846">.</span><span class="ident" id="3131847">encodeUint</span><span class="op" id="3131857">(</span><span class="ident" id="3131858">uint64</span><span class="op" id="3131864">(</span><span class="builtinfunc" id="3131865">len</span><span class="op" id="3131868">(</span><span class="ident" id="3131869">s</span><span class="op" id="3131870">)</span><span class="op" id="3131871">)</span><span class="op" id="3131872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3131876">state</span><span class="op" id="3131881">.</span><span class="ident" id="3131882">b</span><span class="op" id="3131883">.</span><span class="ident" id="3131884">WriteString</span><span class="op" id="3131895">(</span><span class="ident" id="3131896">s</span><span class="op" id="3131897">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3131900">}</span><br>
<span class="lineno"></span><span class="op" id="3131902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3131905">//&nbsp;encStructTerminator&nbsp;encodes&nbsp;the&nbsp;end&nbsp;of&nbsp;an&nbsp;encoded&nbsp;struct</span><br>
<span class="lineno"></span><span class="comment" id="3131965">//&nbsp;as&nbsp;delta&nbsp;field&nbsp;number&nbsp;of&nbsp;0.</span><br>
<span class="lineno">255</span><span class="keyword" id="3131996">func</span>&nbsp;<span class="ident" id="3132001">encStructTerminator</span><span class="op" id="3132020">(</span><span class="ident" id="3132021">i</span>&nbsp;<span class="op" id="3132023">*</span><span class="ident" id="3132024">encInstr</span><span class="op" id="3132032">,</span>&nbsp;<span class="ident" id="3132034">state</span>&nbsp;<span class="op" id="3132040">*</span><span class="ident" id="3132041">encoderState</span><span class="op" id="3132053">,</span>&nbsp;<span class="ident" id="3132055">v</span>&nbsp;<span class="ident" id="3132057">reflect</span><span class="op" id="3132064">.</span><span class="ident" id="3132065">Value</span><span class="op" id="3132070">)</span>&nbsp;<span class="op" id="3132072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132075">state</span><span class="op" id="3132080">.</span><span class="ident" id="3132081">encodeUint</span><span class="op" id="3132091">(</span><span class="num" id="3132092">0</span><span class="op" id="3132093">)</span><br>
<span class="lineno"></span><span class="op" id="3132095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3132098">//&nbsp;Execution&nbsp;engine</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="3132119">//&nbsp;encEngine&nbsp;an&nbsp;array&nbsp;of&nbsp;instructions&nbsp;indexed&nbsp;by&nbsp;field&nbsp;number&nbsp;of&nbsp;the&nbsp;encoding</span><br>
<span class="lineno"></span><span class="comment" id="3132197">//&nbsp;data,&nbsp;typically&nbsp;a&nbsp;struct.&nbsp;&nbsp;It&nbsp;is&nbsp;executed&nbsp;top&nbsp;to&nbsp;bottom,&nbsp;walking&nbsp;the&nbsp;struct.</span><br>
<span class="lineno"></span><span class="keyword" id="3132277">type</span>&nbsp;<span class="ident" id="3132282">encEngine</span>&nbsp;<span class="keyword" id="3132292">struct</span>&nbsp;<span class="op" id="3132299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132302">instr</span>&nbsp;<span class="op" id="3132308">[</span><span class="op" id="3132309">]</span><span class="ident" id="3132310">encInstr</span><br>
<span class="lineno">265</span><span class="op" id="3132319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3132322">const</span>&nbsp;<span class="ident" id="3132328">singletonField</span>&nbsp;<span class="op" id="3132343">=</span>&nbsp;<span class="num" id="3132345">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3132348">//&nbsp;valid&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;valid&nbsp;and&nbsp;a&nbsp;non-nil&nbsp;pointer.</span><br>
<span class="lineno">270</span><span class="comment" id="3132415">//&nbsp;(Slices,&nbsp;maps,&nbsp;and&nbsp;chans&nbsp;take&nbsp;care&nbsp;of&nbsp;themselves.)</span><br>
<span class="lineno"></span><span class="keyword" id="3132469">func</span>&nbsp;<span class="ident" id="3132474">valid</span><span class="op" id="3132479">(</span><span class="ident" id="3132480">v</span>&nbsp;<span class="ident" id="3132482">reflect</span><span class="op" id="3132489">.</span><span class="ident" id="3132490">Value</span><span class="op" id="3132495">)</span>&nbsp;<span class="builtintype" id="3132497">bool</span>&nbsp;<span class="op" id="3132502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132505">switch</span>&nbsp;<span class="ident" id="3132512">v</span><span class="op" id="3132513">.</span><span class="ident" id="3132514">Kind</span><span class="op" id="3132518">(</span><span class="op" id="3132519">)</span>&nbsp;<span class="op" id="3132521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132524">case</span>&nbsp;<span class="ident" id="3132529">reflect</span><span class="op" id="3132536">.</span><span class="ident" id="3132537">Invalid</span><span class="op" id="3132544">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132548">return</span>&nbsp;<span class="builtintype" id="3132555">false</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132562">case</span>&nbsp;<span class="ident" id="3132567">reflect</span><span class="op" id="3132574">.</span><span class="ident" id="3132575">Ptr</span><span class="op" id="3132578">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132582">return</span>&nbsp;<span class="op" id="3132589">!</span><span class="ident" id="3132590">v</span><span class="op" id="3132591">.</span><span class="ident" id="3132592">IsNil</span><span class="op" id="3132597">(</span><span class="op" id="3132598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3132601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132604">return</span>&nbsp;<span class="builtintype" id="3132611">true</span><br>
<span class="lineno"></span><span class="op" id="3132616">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="3132619">//&nbsp;encodeSingle&nbsp;encodes&nbsp;a&nbsp;single&nbsp;top-level&nbsp;non-struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="3132680">func</span>&nbsp;<span class="op" id="3132685">(</span><span class="ident" id="3132686">enc</span>&nbsp;<span class="op" id="3132690">*</span><span class="ident" id="3132691">Encoder</span><span class="op" id="3132698">)</span>&nbsp;<span class="ident" id="3132700">encodeSingle</span><span class="op" id="3132712">(</span><span class="ident" id="3132713">b</span>&nbsp;<span class="op" id="3132715">*</span><span class="ident" id="3132716">encBuffer</span><span class="op" id="3132725">,</span>&nbsp;<span class="ident" id="3132727">engine</span>&nbsp;<span class="op" id="3132734">*</span><span class="ident" id="3132735">encEngine</span><span class="op" id="3132744">,</span>&nbsp;<span class="ident" id="3132746">value</span>&nbsp;<span class="ident" id="3132752">reflect</span><span class="op" id="3132759">.</span><span class="ident" id="3132760">Value</span><span class="op" id="3132765">)</span>&nbsp;<span class="op" id="3132767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132770">state</span>&nbsp;<span class="op" id="3132776">:=</span>&nbsp;<span class="ident" id="3132779">enc</span><span class="op" id="3132782">.</span><span class="ident" id="3132783">newEncoderState</span><span class="op" id="3132798">(</span><span class="ident" id="3132799">b</span><span class="op" id="3132800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3132803">defer</span>&nbsp;<span class="ident" id="3132809">enc</span><span class="op" id="3132812">.</span><span class="ident" id="3132813">freeEncoderState</span><span class="op" id="3132829">(</span><span class="ident" id="3132830">state</span><span class="op" id="3132835">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3132838">state</span><span class="op" id="3132843">.</span><span class="ident" id="3132844">fieldnum</span>&nbsp;<span class="op" id="3132853">=</span>&nbsp;<span class="ident" id="3132855">singletonField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3132871">//&nbsp;There&nbsp;is&nbsp;no&nbsp;surrounding&nbsp;struct&nbsp;to&nbsp;frame&nbsp;the&nbsp;transmission,&nbsp;so&nbsp;we&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3132944">//&nbsp;generate&nbsp;data&nbsp;even&nbsp;if&nbsp;the&nbsp;item&nbsp;is&nbsp;zero.&nbsp;&nbsp;To&nbsp;do&nbsp;this,&nbsp;set&nbsp;sendZero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133015">state</span><span class="op" id="3133020">.</span><span class="ident" id="3133021">sendZero</span>&nbsp;<span class="op" id="3133030">=</span>&nbsp;<span class="builtintype" id="3133032">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133038">instr</span>&nbsp;<span class="op" id="3133044">:=</span>&nbsp;<span class="op" id="3133047">&amp;</span><span class="ident" id="3133048">engine</span><span class="op" id="3133054">.</span><span class="ident" id="3133055">instr</span><span class="op" id="3133060">[</span><span class="ident" id="3133061">singletonField</span><span class="op" id="3133075">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133078">if</span>&nbsp;<span class="ident" id="3133081">instr</span><span class="op" id="3133086">.</span><span class="ident" id="3133087">indir</span>&nbsp;<span class="op" id="3133093">&gt;</span>&nbsp;<span class="num" id="3133095">0</span>&nbsp;<span class="op" id="3133097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133101">value</span>&nbsp;<span class="op" id="3133107">=</span>&nbsp;<span class="ident" id="3133109">encIndirect</span><span class="op" id="3133120">(</span><span class="ident" id="3133121">value</span><span class="op" id="3133126">,</span>&nbsp;<span class="ident" id="3133128">instr</span><span class="op" id="3133133">.</span><span class="ident" id="3133134">indir</span><span class="op" id="3133139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3133142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133145">if</span>&nbsp;<span class="ident" id="3133148">valid</span><span class="op" id="3133153">(</span><span class="ident" id="3133154">value</span><span class="op" id="3133159">)</span>&nbsp;<span class="op" id="3133161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133165">instr</span><span class="op" id="3133170">.</span><span class="ident" id="3133171">op</span><span class="op" id="3133173">(</span><span class="ident" id="3133174">instr</span><span class="op" id="3133179">,</span>&nbsp;<span class="ident" id="3133181">state</span><span class="op" id="3133186">,</span>&nbsp;<span class="ident" id="3133188">value</span><span class="op" id="3133193">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3133196">}</span><br>
<span class="lineno"></span><span class="op" id="3133198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3133201">//&nbsp;encodeStruct&nbsp;encodes&nbsp;a&nbsp;single&nbsp;struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="3133248">func</span>&nbsp;<span class="op" id="3133253">(</span><span class="ident" id="3133254">enc</span>&nbsp;<span class="op" id="3133258">*</span><span class="ident" id="3133259">Encoder</span><span class="op" id="3133266">)</span>&nbsp;<span class="ident" id="3133268">encodeStruct</span><span class="op" id="3133280">(</span><span class="ident" id="3133281">b</span>&nbsp;<span class="op" id="3133283">*</span><span class="ident" id="3133284">encBuffer</span><span class="op" id="3133293">,</span>&nbsp;<span class="ident" id="3133295">engine</span>&nbsp;<span class="op" id="3133302">*</span><span class="ident" id="3133303">encEngine</span><span class="op" id="3133312">,</span>&nbsp;<span class="ident" id="3133314">value</span>&nbsp;<span class="ident" id="3133320">reflect</span><span class="op" id="3133327">.</span><span class="ident" id="3133328">Value</span><span class="op" id="3133333">)</span>&nbsp;<span class="op" id="3133335">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133338">if</span>&nbsp;<span class="op" id="3133341">!</span><span class="ident" id="3133342">valid</span><span class="op" id="3133347">(</span><span class="ident" id="3133348">value</span><span class="op" id="3133353">)</span>&nbsp;<span class="op" id="3133355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133359">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3133367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133370">state</span>&nbsp;<span class="op" id="3133376">:=</span>&nbsp;<span class="ident" id="3133379">enc</span><span class="op" id="3133382">.</span><span class="ident" id="3133383">newEncoderState</span><span class="op" id="3133398">(</span><span class="ident" id="3133399">b</span><span class="op" id="3133400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133403">defer</span>&nbsp;<span class="ident" id="3133409">enc</span><span class="op" id="3133412">.</span><span class="ident" id="3133413">freeEncoderState</span><span class="op" id="3133429">(</span><span class="ident" id="3133430">state</span><span class="op" id="3133435">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133438">state</span><span class="op" id="3133443">.</span><span class="ident" id="3133444">fieldnum</span>&nbsp;<span class="op" id="3133453">=</span>&nbsp;<span class="op" id="3133455">-</span><span class="num" id="3133456">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133459">for</span>&nbsp;<span class="ident" id="3133463">i</span>&nbsp;<span class="op" id="3133465">:=</span>&nbsp;<span class="num" id="3133468">0</span><span class="op" id="3133469">;</span>&nbsp;<span class="ident" id="3133471">i</span>&nbsp;<span class="op" id="3133473">&lt;</span>&nbsp;<span class="builtinfunc" id="3133475">len</span><span class="op" id="3133478">(</span><span class="ident" id="3133479">engine</span><span class="op" id="3133485">.</span><span class="ident" id="3133486">instr</span><span class="op" id="3133491">)</span><span class="op" id="3133492">;</span>&nbsp;<span class="ident" id="3133494">i</span><span class="op" id="3133495">++</span>&nbsp;<span class="op" id="3133498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133502">instr</span>&nbsp;<span class="op" id="3133508">:=</span>&nbsp;<span class="op" id="3133511">&amp;</span><span class="ident" id="3133512">engine</span><span class="op" id="3133518">.</span><span class="ident" id="3133519">instr</span><span class="op" id="3133524">[</span><span class="ident" id="3133525">i</span><span class="op" id="3133526">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133530">if</span>&nbsp;<span class="ident" id="3133533">i</span>&nbsp;<span class="op" id="3133535">&gt;=</span>&nbsp;<span class="ident" id="3133538">value</span><span class="op" id="3133543">.</span><span class="ident" id="3133544">NumField</span><span class="op" id="3133552">(</span><span class="op" id="3133553">)</span>&nbsp;<span class="op" id="3133555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3133560">//&nbsp;encStructTerminator</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133586">instr</span><span class="op" id="3133591">.</span><span class="ident" id="3133592">op</span><span class="op" id="3133594">(</span><span class="ident" id="3133595">instr</span><span class="op" id="3133600">,</span>&nbsp;<span class="ident" id="3133602">state</span><span class="op" id="3133607">,</span>&nbsp;<span class="ident" id="3133609">reflect</span><span class="op" id="3133616">.</span><span class="ident" id="3133617">Value</span><span class="op" id="3133622">{</span><span class="op" id="3133623">}</span><span class="op" id="3133624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133629">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3133637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133641">field</span>&nbsp;<span class="op" id="3133647">:=</span>&nbsp;<span class="ident" id="3133650">value</span><span class="op" id="3133655">.</span><span class="ident" id="3133656">FieldByIndex</span><span class="op" id="3133668">(</span><span class="ident" id="3133669">instr</span><span class="op" id="3133674">.</span><span class="ident" id="3133675">index</span><span class="op" id="3133680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133684">if</span>&nbsp;<span class="ident" id="3133687">instr</span><span class="op" id="3133692">.</span><span class="ident" id="3133693">indir</span>&nbsp;<span class="op" id="3133699">&gt;</span>&nbsp;<span class="num" id="3133701">0</span>&nbsp;<span class="op" id="3133703">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133708">field</span>&nbsp;<span class="op" id="3133714">=</span>&nbsp;<span class="ident" id="3133716">encIndirect</span><span class="op" id="3133727">(</span><span class="ident" id="3133728">field</span><span class="op" id="3133733">,</span>&nbsp;<span class="ident" id="3133735">instr</span><span class="op" id="3133740">.</span><span class="ident" id="3133741">indir</span><span class="op" id="3133746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3133751">//&nbsp;TODO:&nbsp;Is&nbsp;field&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133823">if</span>&nbsp;<span class="op" id="3133826">!</span><span class="ident" id="3133827">valid</span><span class="op" id="3133832">(</span><span class="ident" id="3133833">field</span><span class="op" id="3133838">)</span>&nbsp;<span class="op" id="3133840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3133846">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3133858">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3133862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3133866">instr</span><span class="op" id="3133871">.</span><span class="ident" id="3133872">op</span><span class="op" id="3133874">(</span><span class="ident" id="3133875">instr</span><span class="op" id="3133880">,</span>&nbsp;<span class="ident" id="3133882">state</span><span class="op" id="3133887">,</span>&nbsp;<span class="ident" id="3133889">field</span><span class="op" id="3133894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3133897">}</span><br>
<span class="lineno"></span><span class="op" id="3133899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="3133902">//&nbsp;encodeArray&nbsp;encodes&nbsp;an&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="3133935">func</span>&nbsp;<span class="op" id="3133940">(</span><span class="ident" id="3133941">enc</span>&nbsp;<span class="op" id="3133945">*</span><span class="ident" id="3133946">Encoder</span><span class="op" id="3133953">)</span>&nbsp;<span class="ident" id="3133955">encodeArray</span><span class="op" id="3133966">(</span><span class="ident" id="3133967">b</span>&nbsp;<span class="op" id="3133969">*</span><span class="ident" id="3133970">encBuffer</span><span class="op" id="3133979">,</span>&nbsp;<span class="ident" id="3133981">value</span>&nbsp;<span class="ident" id="3133987">reflect</span><span class="op" id="3133994">.</span><span class="ident" id="3133995">Value</span><span class="op" id="3134000">,</span>&nbsp;<span class="ident" id="3134002">op</span>&nbsp;<span class="ident" id="3134005">encOp</span><span class="op" id="3134010">,</span>&nbsp;<span class="ident" id="3134012">elemIndir</span>&nbsp;<span class="builtintype" id="3134022">int</span><span class="op" id="3134025">,</span>&nbsp;<span class="ident" id="3134027">length</span>&nbsp;<span class="builtintype" id="3134034">int</span><span class="op" id="3134037">,</span>&nbsp;<span class="ident" id="3134039">helper</span>&nbsp;<span class="ident" id="3134046">encHelper</span><span class="op" id="3134055">)</span>&nbsp;<span class="op" id="3134057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134060">state</span>&nbsp;<span class="op" id="3134066">:=</span>&nbsp;<span class="ident" id="3134069">enc</span><span class="op" id="3134072">.</span><span class="ident" id="3134073">newEncoderState</span><span class="op" id="3134088">(</span><span class="ident" id="3134089">b</span><span class="op" id="3134090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134093">defer</span>&nbsp;<span class="ident" id="3134099">enc</span><span class="op" id="3134102">.</span><span class="ident" id="3134103">freeEncoderState</span><span class="op" id="3134119">(</span><span class="ident" id="3134120">state</span><span class="op" id="3134125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134128">state</span><span class="op" id="3134133">.</span><span class="ident" id="3134134">fieldnum</span>&nbsp;<span class="op" id="3134143">=</span>&nbsp;<span class="op" id="3134145">-</span><span class="num" id="3134146">1</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134149">state</span><span class="op" id="3134154">.</span><span class="ident" id="3134155">sendZero</span>&nbsp;<span class="op" id="3134164">=</span>&nbsp;<span class="builtintype" id="3134166">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134172">state</span><span class="op" id="3134177">.</span><span class="ident" id="3134178">encodeUint</span><span class="op" id="3134188">(</span><span class="ident" id="3134189">uint64</span><span class="op" id="3134195">(</span><span class="ident" id="3134196">length</span><span class="op" id="3134202">)</span><span class="op" id="3134203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134206">if</span>&nbsp;<span class="ident" id="3134209">helper</span>&nbsp;<span class="op" id="3134216">!=</span>&nbsp;<span class="ident" id="3134219">nil</span>&nbsp;<span class="op" id="3134223">&amp;&amp;</span>&nbsp;<span class="ident" id="3134226">helper</span><span class="op" id="3134232">(</span><span class="ident" id="3134233">state</span><span class="op" id="3134238">,</span>&nbsp;<span class="ident" id="3134240">value</span><span class="op" id="3134245">)</span>&nbsp;<span class="op" id="3134247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134251">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134259">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134262">for</span>&nbsp;<span class="ident" id="3134266">i</span>&nbsp;<span class="op" id="3134268">:=</span>&nbsp;<span class="num" id="3134271">0</span><span class="op" id="3134272">;</span>&nbsp;<span class="ident" id="3134274">i</span>&nbsp;<span class="op" id="3134276">&lt;</span>&nbsp;<span class="ident" id="3134278">length</span><span class="op" id="3134284">;</span>&nbsp;<span class="ident" id="3134286">i</span><span class="op" id="3134287">++</span>&nbsp;<span class="op" id="3134290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134294">elem</span>&nbsp;<span class="op" id="3134299">:=</span>&nbsp;<span class="ident" id="3134302">value</span><span class="op" id="3134307">.</span><span class="ident" id="3134308">Index</span><span class="op" id="3134313">(</span><span class="ident" id="3134314">i</span><span class="op" id="3134315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134319">if</span>&nbsp;<span class="ident" id="3134322">elemIndir</span>&nbsp;<span class="op" id="3134332">&gt;</span>&nbsp;<span class="num" id="3134334">0</span>&nbsp;<span class="op" id="3134336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134341">elem</span>&nbsp;<span class="op" id="3134346">=</span>&nbsp;<span class="ident" id="3134348">encIndirect</span><span class="op" id="3134359">(</span><span class="ident" id="3134360">elem</span><span class="op" id="3134364">,</span>&nbsp;<span class="ident" id="3134366">elemIndir</span><span class="op" id="3134375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3134380">//&nbsp;TODO:&nbsp;Is&nbsp;elem&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134451">if</span>&nbsp;<span class="op" id="3134454">!</span><span class="ident" id="3134455">valid</span><span class="op" id="3134460">(</span><span class="ident" id="3134461">elem</span><span class="op" id="3134465">)</span>&nbsp;<span class="op" id="3134467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134473">errorf</span><span class="op" id="3134479">(</span><span class="string" id="3134480">&#34;encodeArray:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="3134506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134519">op</span><span class="op" id="3134521">(</span><span class="ident" id="3134522">nil</span><span class="op" id="3134525">,</span>&nbsp;<span class="ident" id="3134527">state</span><span class="op" id="3134532">,</span>&nbsp;<span class="ident" id="3134534">elem</span><span class="op" id="3134538">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134541">}</span><br>
<span class="lineno"></span><span class="op" id="3134543">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3134546">//&nbsp;encodeReflectValue&nbsp;is&nbsp;a&nbsp;helper&nbsp;for&nbsp;maps.&nbsp;It&nbsp;encodes&nbsp;the&nbsp;value&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="3134614">func</span>&nbsp;<span class="ident" id="3134619">encodeReflectValue</span><span class="op" id="3134637">(</span><span class="ident" id="3134638">state</span>&nbsp;<span class="op" id="3134644">*</span><span class="ident" id="3134645">encoderState</span><span class="op" id="3134657">,</span>&nbsp;<span class="ident" id="3134659">v</span>&nbsp;<span class="ident" id="3134661">reflect</span><span class="op" id="3134668">.</span><span class="ident" id="3134669">Value</span><span class="op" id="3134674">,</span>&nbsp;<span class="ident" id="3134676">op</span>&nbsp;<span class="ident" id="3134679">encOp</span><span class="op" id="3134684">,</span>&nbsp;<span class="ident" id="3134686">indir</span>&nbsp;<span class="builtintype" id="3134692">int</span><span class="op" id="3134695">)</span>&nbsp;<span class="op" id="3134697">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134700">for</span>&nbsp;<span class="ident" id="3134704">i</span>&nbsp;<span class="op" id="3134706">:=</span>&nbsp;<span class="num" id="3134709">0</span><span class="op" id="3134710">;</span>&nbsp;<span class="ident" id="3134712">i</span>&nbsp;<span class="op" id="3134714">&lt;</span>&nbsp;<span class="ident" id="3134716">indir</span>&nbsp;<span class="op" id="3134722">&amp;&amp;</span>&nbsp;<span class="ident" id="3134725">v</span><span class="op" id="3134726">.</span><span class="ident" id="3134727">IsValid</span><span class="op" id="3134734">(</span><span class="op" id="3134735">)</span><span class="op" id="3134736">;</span>&nbsp;<span class="ident" id="3134738">i</span><span class="op" id="3134739">++</span>&nbsp;<span class="op" id="3134742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134746">v</span>&nbsp;<span class="op" id="3134748">=</span>&nbsp;<span class="ident" id="3134750">reflect</span><span class="op" id="3134757">.</span><span class="ident" id="3134758">Indirect</span><span class="op" id="3134766">(</span><span class="ident" id="3134767">v</span><span class="op" id="3134768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3134774">if</span>&nbsp;<span class="op" id="3134777">!</span><span class="ident" id="3134778">v</span><span class="op" id="3134779">.</span><span class="ident" id="3134780">IsValid</span><span class="op" id="3134787">(</span><span class="op" id="3134788">)</span>&nbsp;<span class="op" id="3134790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134794">errorf</span><span class="op" id="3134800">(</span><span class="string" id="3134801">&#34;encodeReflectValue:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="3134834">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3134837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3134840">op</span><span class="op" id="3134842">(</span><span class="ident" id="3134843">nil</span><span class="op" id="3134846">,</span>&nbsp;<span class="ident" id="3134848">state</span><span class="op" id="3134853">,</span>&nbsp;<span class="ident" id="3134855">v</span><span class="op" id="3134856">)</span><br>
<span class="lineno"></span><span class="op" id="3134858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3134861">//&nbsp;encodeMap&nbsp;encodes&nbsp;a&nbsp;map&nbsp;as&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;key:value&nbsp;pairs.</span><br>
<span class="lineno">360</span><span class="keyword" id="3134935">func</span>&nbsp;<span class="op" id="3134940">(</span><span class="ident" id="3134941">enc</span>&nbsp;<span class="op" id="3134945">*</span><span class="ident" id="3134946">Encoder</span><span class="op" id="3134953">)</span>&nbsp;<span class="ident" id="3134955">encodeMap</span><span class="op" id="3134964">(</span><span class="ident" id="3134965">b</span>&nbsp;<span class="op" id="3134967">*</span><span class="ident" id="3134968">encBuffer</span><span class="op" id="3134977">,</span>&nbsp;<span class="ident" id="3134979">mv</span>&nbsp;<span class="ident" id="3134982">reflect</span><span class="op" id="3134989">.</span><span class="ident" id="3134990">Value</span><span class="op" id="3134995">,</span>&nbsp;<span class="ident" id="3134997">keyOp</span><span class="op" id="3135002">,</span>&nbsp;<span class="ident" id="3135004">elemOp</span>&nbsp;<span class="ident" id="3135011">encOp</span><span class="op" id="3135016">,</span>&nbsp;<span class="ident" id="3135018">keyIndir</span><span class="op" id="3135026">,</span>&nbsp;<span class="ident" id="3135028">elemIndir</span>&nbsp;<span class="builtintype" id="3135038">int</span><span class="op" id="3135041">)</span>&nbsp;<span class="op" id="3135043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135046">state</span>&nbsp;<span class="op" id="3135052">:=</span>&nbsp;<span class="ident" id="3135055">enc</span><span class="op" id="3135058">.</span><span class="ident" id="3135059">newEncoderState</span><span class="op" id="3135074">(</span><span class="ident" id="3135075">b</span><span class="op" id="3135076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135079">state</span><span class="op" id="3135084">.</span><span class="ident" id="3135085">fieldnum</span>&nbsp;<span class="op" id="3135094">=</span>&nbsp;<span class="op" id="3135096">-</span><span class="num" id="3135097">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135100">state</span><span class="op" id="3135105">.</span><span class="ident" id="3135106">sendZero</span>&nbsp;<span class="op" id="3135115">=</span>&nbsp;<span class="builtintype" id="3135117">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135123">keys</span>&nbsp;<span class="op" id="3135128">:=</span>&nbsp;<span class="ident" id="3135131">mv</span><span class="op" id="3135133">.</span><span class="ident" id="3135134">MapKeys</span><span class="op" id="3135141">(</span><span class="op" id="3135142">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135145">state</span><span class="op" id="3135150">.</span><span class="ident" id="3135151">encodeUint</span><span class="op" id="3135161">(</span><span class="ident" id="3135162">uint64</span><span class="op" id="3135168">(</span><span class="builtinfunc" id="3135169">len</span><span class="op" id="3135172">(</span><span class="ident" id="3135173">keys</span><span class="op" id="3135177">)</span><span class="op" id="3135178">)</span><span class="op" id="3135179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135182">for</span>&nbsp;<span class="ident" id="3135186">_</span><span class="op" id="3135187">,</span>&nbsp;<span class="ident" id="3135189">key</span>&nbsp;<span class="op" id="3135193">:=</span>&nbsp;<span class="keyword" id="3135196">range</span>&nbsp;<span class="ident" id="3135202">keys</span>&nbsp;<span class="op" id="3135207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135211">encodeReflectValue</span><span class="op" id="3135229">(</span><span class="ident" id="3135230">state</span><span class="op" id="3135235">,</span>&nbsp;<span class="ident" id="3135237">key</span><span class="op" id="3135240">,</span>&nbsp;<span class="ident" id="3135242">keyOp</span><span class="op" id="3135247">,</span>&nbsp;<span class="ident" id="3135249">keyIndir</span><span class="op" id="3135257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135261">encodeReflectValue</span><span class="op" id="3135279">(</span><span class="ident" id="3135280">state</span><span class="op" id="3135285">,</span>&nbsp;<span class="ident" id="3135287">mv</span><span class="op" id="3135289">.</span><span class="ident" id="3135290">MapIndex</span><span class="op" id="3135298">(</span><span class="ident" id="3135299">key</span><span class="op" id="3135302">)</span><span class="op" id="3135303">,</span>&nbsp;<span class="ident" id="3135305">elemOp</span><span class="op" id="3135311">,</span>&nbsp;<span class="ident" id="3135313">elemIndir</span><span class="op" id="3135322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3135325">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135328">enc</span><span class="op" id="3135331">.</span><span class="ident" id="3135332">freeEncoderState</span><span class="op" id="3135348">(</span><span class="ident" id="3135349">state</span><span class="op" id="3135354">)</span><br>
<span class="lineno"></span><span class="op" id="3135356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3135359">//&nbsp;encodeInterface&nbsp;encodes&nbsp;the&nbsp;interface&nbsp;value&nbsp;iv.</span><br>
<span class="lineno"></span><span class="comment" id="3135410">//&nbsp;To&nbsp;send&nbsp;an&nbsp;interface,&nbsp;we&nbsp;send&nbsp;a&nbsp;string&nbsp;identifying&nbsp;the&nbsp;concrete&nbsp;type,&nbsp;followed</span><br>
<span class="lineno">375</span><span class="comment" id="3135492">//&nbsp;by&nbsp;the&nbsp;type&nbsp;identifier&nbsp;(which&nbsp;might&nbsp;require&nbsp;defining&nbsp;that&nbsp;type&nbsp;right&nbsp;now),&nbsp;followed</span><br>
<span class="lineno"></span><span class="comment" id="3135579">//&nbsp;by&nbsp;the&nbsp;concrete&nbsp;value.&nbsp;&nbsp;A&nbsp;nil&nbsp;value&nbsp;gets&nbsp;sent&nbsp;as&nbsp;the&nbsp;empty&nbsp;string&nbsp;for&nbsp;the&nbsp;name,</span><br>
<span class="lineno"></span><span class="comment" id="3135662">//&nbsp;followed&nbsp;by&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="3135687">func</span>&nbsp;<span class="op" id="3135692">(</span><span class="ident" id="3135693">enc</span>&nbsp;<span class="op" id="3135697">*</span><span class="ident" id="3135698">Encoder</span><span class="op" id="3135705">)</span>&nbsp;<span class="ident" id="3135707">encodeInterface</span><span class="op" id="3135722">(</span><span class="ident" id="3135723">b</span>&nbsp;<span class="op" id="3135725">*</span><span class="ident" id="3135726">encBuffer</span><span class="op" id="3135735">,</span>&nbsp;<span class="ident" id="3135737">iv</span>&nbsp;<span class="ident" id="3135740">reflect</span><span class="op" id="3135747">.</span><span class="ident" id="3135748">Value</span><span class="op" id="3135753">)</span>&nbsp;<span class="op" id="3135755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3135758">//&nbsp;Gobs&nbsp;can&nbsp;encode&nbsp;nil&nbsp;interface&nbsp;values&nbsp;but&nbsp;not&nbsp;typed&nbsp;interface</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3135823">//&nbsp;values&nbsp;holding&nbsp;nil&nbsp;pointers,&nbsp;since&nbsp;nil&nbsp;pointers&nbsp;point&nbsp;to&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135894">elem</span>&nbsp;<span class="op" id="3135899">:=</span>&nbsp;<span class="ident" id="3135902">iv</span><span class="op" id="3135904">.</span><span class="ident" id="3135905">Elem</span><span class="op" id="3135909">(</span><span class="op" id="3135910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3135913">if</span>&nbsp;<span class="ident" id="3135916">elem</span><span class="op" id="3135920">.</span><span class="ident" id="3135921">Kind</span><span class="op" id="3135925">(</span><span class="op" id="3135926">)</span>&nbsp;<span class="op" id="3135928">==</span>&nbsp;<span class="ident" id="3135931">reflect</span><span class="op" id="3135938">.</span><span class="ident" id="3135939">Ptr</span>&nbsp;<span class="op" id="3135943">&amp;&amp;</span>&nbsp;<span class="ident" id="3135946">elem</span><span class="op" id="3135950">.</span><span class="ident" id="3135951">IsNil</span><span class="op" id="3135956">(</span><span class="op" id="3135957">)</span>&nbsp;<span class="op" id="3135959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3135963">errorf</span><span class="op" id="3135969">(</span><span class="string" id="3135970">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;%s&nbsp;inside&nbsp;interface&#34;</span><span class="op" id="3136030">,</span>&nbsp;<span class="ident" id="3136032">iv</span><span class="op" id="3136034">.</span><span class="ident" id="3136035">Elem</span><span class="op" id="3136039">(</span><span class="op" id="3136040">)</span><span class="op" id="3136041">.</span><span class="ident" id="3136042">Type</span><span class="op" id="3136046">(</span><span class="op" id="3136047">)</span><span class="op" id="3136048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3136051">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136054">state</span>&nbsp;<span class="op" id="3136060">:=</span>&nbsp;<span class="ident" id="3136063">enc</span><span class="op" id="3136066">.</span><span class="ident" id="3136067">newEncoderState</span><span class="op" id="3136082">(</span><span class="ident" id="3136083">b</span><span class="op" id="3136084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136087">state</span><span class="op" id="3136092">.</span><span class="ident" id="3136093">fieldnum</span>&nbsp;<span class="op" id="3136102">=</span>&nbsp;<span class="op" id="3136104">-</span><span class="num" id="3136105">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136108">state</span><span class="op" id="3136113">.</span><span class="ident" id="3136114">sendZero</span>&nbsp;<span class="op" id="3136123">=</span>&nbsp;<span class="builtintype" id="3136125">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136131">if</span>&nbsp;<span class="ident" id="3136134">iv</span><span class="op" id="3136136">.</span><span class="ident" id="3136137">IsNil</span><span class="op" id="3136142">(</span><span class="op" id="3136143">)</span>&nbsp;<span class="op" id="3136145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136149">state</span><span class="op" id="3136154">.</span><span class="ident" id="3136155">encodeUint</span><span class="op" id="3136165">(</span><span class="num" id="3136166">0</span><span class="op" id="3136167">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136171">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3136179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136183">ut</span>&nbsp;<span class="op" id="3136186">:=</span>&nbsp;<span class="ident" id="3136189">userType</span><span class="op" id="3136197">(</span><span class="ident" id="3136198">iv</span><span class="op" id="3136200">.</span><span class="ident" id="3136201">Elem</span><span class="op" id="3136205">(</span><span class="op" id="3136206">)</span><span class="op" id="3136207">.</span><span class="ident" id="3136208">Type</span><span class="op" id="3136212">(</span><span class="op" id="3136213">)</span><span class="op" id="3136214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136217">registerLock</span><span class="op" id="3136229">.</span><span class="ident" id="3136230">RLock</span><span class="op" id="3136235">(</span><span class="op" id="3136236">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136239">name</span><span class="op" id="3136243">,</span>&nbsp;<span class="ident" id="3136245">ok</span>&nbsp;<span class="op" id="3136248">:=</span>&nbsp;<span class="ident" id="3136251">concreteTypeToName</span><span class="op" id="3136269">[</span><span class="ident" id="3136270">ut</span><span class="op" id="3136272">.</span><span class="ident" id="3136273">base</span><span class="op" id="3136277">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136280">registerLock</span><span class="op" id="3136292">.</span><span class="ident" id="3136293">RUnlock</span><span class="op" id="3136300">(</span><span class="op" id="3136301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136304">if</span>&nbsp;<span class="op" id="3136307">!</span><span class="ident" id="3136308">ok</span>&nbsp;<span class="op" id="3136311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136315">errorf</span><span class="op" id="3136321">(</span><span class="string" id="3136322">&#34;type&nbsp;not&nbsp;registered&nbsp;for&nbsp;interface:&nbsp;%s&#34;</span><span class="op" id="3136361">,</span>&nbsp;<span class="ident" id="3136363">ut</span><span class="op" id="3136365">.</span><span class="ident" id="3136366">base</span><span class="op" id="3136370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3136373">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3136376">//&nbsp;Send&nbsp;the&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136395">state</span><span class="op" id="3136400">.</span><span class="ident" id="3136401">encodeUint</span><span class="op" id="3136411">(</span><span class="ident" id="3136412">uint64</span><span class="op" id="3136418">(</span><span class="builtinfunc" id="3136419">len</span><span class="op" id="3136422">(</span><span class="ident" id="3136423">name</span><span class="op" id="3136427">)</span><span class="op" id="3136428">)</span><span class="op" id="3136429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136432">state</span><span class="op" id="3136437">.</span><span class="ident" id="3136438">b</span><span class="op" id="3136439">.</span><span class="ident" id="3136440">WriteString</span><span class="op" id="3136451">(</span><span class="ident" id="3136452">name</span><span class="op" id="3136456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3136459">//&nbsp;Define&nbsp;the&nbsp;type&nbsp;id&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136496">enc</span><span class="op" id="3136499">.</span><span class="ident" id="3136500">sendTypeDescriptor</span><span class="op" id="3136518">(</span><span class="ident" id="3136519">enc</span><span class="op" id="3136522">.</span><span class="ident" id="3136523">writer</span><span class="op" id="3136529">(</span><span class="op" id="3136530">)</span><span class="op" id="3136531">,</span>&nbsp;<span class="ident" id="3136533">state</span><span class="op" id="3136538">,</span>&nbsp;<span class="ident" id="3136540">ut</span><span class="op" id="3136542">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3136545">//&nbsp;Send&nbsp;the&nbsp;type&nbsp;id.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136567">enc</span><span class="op" id="3136570">.</span><span class="ident" id="3136571">sendTypeId</span><span class="op" id="3136581">(</span><span class="ident" id="3136582">state</span><span class="op" id="3136587">,</span>&nbsp;<span class="ident" id="3136589">ut</span><span class="op" id="3136591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3136594">//&nbsp;Encode&nbsp;the&nbsp;value&nbsp;into&nbsp;a&nbsp;new&nbsp;buffer.&nbsp;&nbsp;Any&nbsp;nested&nbsp;type&nbsp;definitions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3136663">//&nbsp;should&nbsp;be&nbsp;written&nbsp;to&nbsp;b,&nbsp;before&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136717">enc</span><span class="op" id="3136720">.</span><span class="ident" id="3136721">pushWriter</span><span class="op" id="3136731">(</span><span class="ident" id="3136732">b</span><span class="op" id="3136733">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136736">data</span>&nbsp;<span class="op" id="3136741">:=</span>&nbsp;<span class="builtinfunc" id="3136744">new</span><span class="op" id="3136747">(</span><span class="ident" id="3136748">encBuffer</span><span class="op" id="3136757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136760">data</span><span class="op" id="3136764">.</span><span class="ident" id="3136765">Write</span><span class="op" id="3136770">(</span><span class="ident" id="3136771">spaceForLength</span><span class="op" id="3136785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136788">enc</span><span class="op" id="3136791">.</span><span class="ident" id="3136792">encode</span><span class="op" id="3136798">(</span><span class="ident" id="3136799">data</span><span class="op" id="3136803">,</span>&nbsp;<span class="ident" id="3136805">elem</span><span class="op" id="3136809">,</span>&nbsp;<span class="ident" id="3136811">ut</span><span class="op" id="3136813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136816">if</span>&nbsp;<span class="ident" id="3136819">enc</span><span class="op" id="3136822">.</span><span class="ident" id="3136823">err</span>&nbsp;<span class="op" id="3136827">!=</span>&nbsp;<span class="ident" id="3136830">nil</span>&nbsp;<span class="op" id="3136834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136838">error_</span><span class="op" id="3136844">(</span><span class="ident" id="3136845">enc</span><span class="op" id="3136848">.</span><span class="ident" id="3136849">err</span><span class="op" id="3136852">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3136855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136858">enc</span><span class="op" id="3136861">.</span><span class="ident" id="3136862">popWriter</span><span class="op" id="3136871">(</span><span class="op" id="3136872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136875">enc</span><span class="op" id="3136878">.</span><span class="ident" id="3136879">writeMessage</span><span class="op" id="3136891">(</span><span class="ident" id="3136892">b</span><span class="op" id="3136893">,</span>&nbsp;<span class="ident" id="3136895">data</span><span class="op" id="3136899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3136902">if</span>&nbsp;<span class="ident" id="3136905">enc</span><span class="op" id="3136908">.</span><span class="ident" id="3136909">err</span>&nbsp;<span class="op" id="3136913">!=</span>&nbsp;<span class="ident" id="3136916">nil</span>&nbsp;<span class="op" id="3136920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136924">error_</span><span class="op" id="3136930">(</span><span class="ident" id="3136931">enc</span><span class="op" id="3136934">.</span><span class="ident" id="3136935">err</span><span class="op" id="3136938">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3136941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3136944">enc</span><span class="op" id="3136947">.</span><span class="ident" id="3136948">freeEncoderState</span><span class="op" id="3136964">(</span><span class="ident" id="3136965">state</span><span class="op" id="3136970">)</span><br>
<span class="lineno"></span><span class="op" id="3136972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3136975">//&nbsp;isZero&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;the&nbsp;zero&nbsp;of&nbsp;its&nbsp;type.</span><br>
<span class="lineno">425</span><span class="keyword" id="3137036">func</span>&nbsp;<span class="ident" id="3137041">isZero</span><span class="op" id="3137047">(</span><span class="ident" id="3137048">val</span>&nbsp;<span class="ident" id="3137052">reflect</span><span class="op" id="3137059">.</span><span class="ident" id="3137060">Value</span><span class="op" id="3137065">)</span>&nbsp;<span class="builtintype" id="3137067">bool</span>&nbsp;<span class="op" id="3137072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137075">switch</span>&nbsp;<span class="ident" id="3137082">val</span><span class="op" id="3137085">.</span><span class="ident" id="3137086">Kind</span><span class="op" id="3137090">(</span><span class="op" id="3137091">)</span>&nbsp;<span class="op" id="3137093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137096">case</span>&nbsp;<span class="ident" id="3137101">reflect</span><span class="op" id="3137108">.</span><span class="ident" id="3137109">Array</span><span class="op" id="3137114">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137118">for</span>&nbsp;<span class="ident" id="3137122">i</span>&nbsp;<span class="op" id="3137124">:=</span>&nbsp;<span class="num" id="3137127">0</span><span class="op" id="3137128">;</span>&nbsp;<span class="ident" id="3137130">i</span>&nbsp;<span class="op" id="3137132">&lt;</span>&nbsp;<span class="ident" id="3137134">val</span><span class="op" id="3137137">.</span><span class="ident" id="3137138">Len</span><span class="op" id="3137141">(</span><span class="op" id="3137142">)</span><span class="op" id="3137143">;</span>&nbsp;<span class="ident" id="3137145">i</span><span class="op" id="3137146">++</span>&nbsp;<span class="op" id="3137149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137154">if</span>&nbsp;<span class="op" id="3137157">!</span><span class="ident" id="3137158">isZero</span><span class="op" id="3137164">(</span><span class="ident" id="3137165">val</span><span class="op" id="3137168">.</span><span class="ident" id="3137169">Index</span><span class="op" id="3137174">(</span><span class="ident" id="3137175">i</span><span class="op" id="3137176">)</span><span class="op" id="3137177">)</span>&nbsp;<span class="op" id="3137179">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137185">return</span>&nbsp;<span class="builtintype" id="3137192">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137209">return</span>&nbsp;<span class="builtintype" id="3137216">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137222">case</span>&nbsp;<span class="ident" id="3137227">reflect</span><span class="op" id="3137234">.</span><span class="ident" id="3137235">Map</span><span class="op" id="3137238">,</span>&nbsp;<span class="ident" id="3137240">reflect</span><span class="op" id="3137247">.</span><span class="ident" id="3137248">Slice</span><span class="op" id="3137253">,</span>&nbsp;<span class="ident" id="3137255">reflect</span><span class="op" id="3137262">.</span><span class="ident" id="3137263">String</span><span class="op" id="3137269">:</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137273">return</span>&nbsp;<span class="ident" id="3137280">val</span><span class="op" id="3137283">.</span><span class="ident" id="3137284">Len</span><span class="op" id="3137287">(</span><span class="op" id="3137288">)</span>&nbsp;<span class="op" id="3137290">==</span>&nbsp;<span class="num" id="3137293">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137296">case</span>&nbsp;<span class="ident" id="3137301">reflect</span><span class="op" id="3137308">.</span><span class="ident" id="3137309">Bool</span><span class="op" id="3137313">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137317">return</span>&nbsp;<span class="op" id="3137324">!</span><span class="ident" id="3137325">val</span><span class="op" id="3137328">.</span><span class="ident" id="3137329">Bool</span><span class="op" id="3137333">(</span><span class="op" id="3137334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137337">case</span>&nbsp;<span class="ident" id="3137342">reflect</span><span class="op" id="3137349">.</span><span class="ident" id="3137350">Complex64</span><span class="op" id="3137359">,</span>&nbsp;<span class="ident" id="3137361">reflect</span><span class="op" id="3137368">.</span><span class="ident" id="3137369">Complex128</span><span class="op" id="3137379">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137383">return</span>&nbsp;<span class="ident" id="3137390">val</span><span class="op" id="3137393">.</span><span class="ident" id="3137394">Complex</span><span class="op" id="3137401">(</span><span class="op" id="3137402">)</span>&nbsp;<span class="op" id="3137404">==</span>&nbsp;<span class="num" id="3137407">0</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137410">case</span>&nbsp;<span class="ident" id="3137415">reflect</span><span class="op" id="3137422">.</span><span class="ident" id="3137423">Chan</span><span class="op" id="3137427">,</span>&nbsp;<span class="ident" id="3137429">reflect</span><span class="op" id="3137436">.</span><span class="ident" id="3137437">Func</span><span class="op" id="3137441">,</span>&nbsp;<span class="ident" id="3137443">reflect</span><span class="op" id="3137450">.</span><span class="ident" id="3137451">Interface</span><span class="op" id="3137460">,</span>&nbsp;<span class="ident" id="3137462">reflect</span><span class="op" id="3137469">.</span><span class="ident" id="3137470">Ptr</span><span class="op" id="3137473">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137477">return</span>&nbsp;<span class="ident" id="3137484">val</span><span class="op" id="3137487">.</span><span class="ident" id="3137488">IsNil</span><span class="op" id="3137493">(</span><span class="op" id="3137494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137497">case</span>&nbsp;<span class="ident" id="3137502">reflect</span><span class="op" id="3137509">.</span><span class="ident" id="3137510">Int</span><span class="op" id="3137513">,</span>&nbsp;<span class="ident" id="3137515">reflect</span><span class="op" id="3137522">.</span><span class="ident" id="3137523">Int8</span><span class="op" id="3137527">,</span>&nbsp;<span class="ident" id="3137529">reflect</span><span class="op" id="3137536">.</span><span class="ident" id="3137537">Int16</span><span class="op" id="3137542">,</span>&nbsp;<span class="ident" id="3137544">reflect</span><span class="op" id="3137551">.</span><span class="ident" id="3137552">Int32</span><span class="op" id="3137557">,</span>&nbsp;<span class="ident" id="3137559">reflect</span><span class="op" id="3137566">.</span><span class="ident" id="3137567">Int64</span><span class="op" id="3137572">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137576">return</span>&nbsp;<span class="ident" id="3137583">val</span><span class="op" id="3137586">.</span><span class="ident" id="3137587">Int</span><span class="op" id="3137590">(</span><span class="op" id="3137591">)</span>&nbsp;<span class="op" id="3137593">==</span>&nbsp;<span class="num" id="3137596">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137599">case</span>&nbsp;<span class="ident" id="3137604">reflect</span><span class="op" id="3137611">.</span><span class="ident" id="3137612">Float32</span><span class="op" id="3137619">,</span>&nbsp;<span class="ident" id="3137621">reflect</span><span class="op" id="3137628">.</span><span class="ident" id="3137629">Float64</span><span class="op" id="3137636">:</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137640">return</span>&nbsp;<span class="ident" id="3137647">val</span><span class="op" id="3137650">.</span><span class="ident" id="3137651">Float</span><span class="op" id="3137656">(</span><span class="op" id="3137657">)</span>&nbsp;<span class="op" id="3137659">==</span>&nbsp;<span class="num" id="3137662">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137665">case</span>&nbsp;<span class="ident" id="3137670">reflect</span><span class="op" id="3137677">.</span><span class="ident" id="3137678">Uint</span><span class="op" id="3137682">,</span>&nbsp;<span class="ident" id="3137684">reflect</span><span class="op" id="3137691">.</span><span class="ident" id="3137692">Uint8</span><span class="op" id="3137697">,</span>&nbsp;<span class="ident" id="3137699">reflect</span><span class="op" id="3137706">.</span><span class="ident" id="3137707">Uint16</span><span class="op" id="3137713">,</span>&nbsp;<span class="ident" id="3137715">reflect</span><span class="op" id="3137722">.</span><span class="ident" id="3137723">Uint32</span><span class="op" id="3137729">,</span>&nbsp;<span class="ident" id="3137731">reflect</span><span class="op" id="3137738">.</span><span class="ident" id="3137739">Uint64</span><span class="op" id="3137745">,</span>&nbsp;<span class="ident" id="3137747">reflect</span><span class="op" id="3137754">.</span><span class="ident" id="3137755">Uintptr</span><span class="op" id="3137762">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137766">return</span>&nbsp;<span class="ident" id="3137773">val</span><span class="op" id="3137776">.</span><span class="ident" id="3137777">Uint</span><span class="op" id="3137781">(</span><span class="op" id="3137782">)</span>&nbsp;<span class="op" id="3137784">==</span>&nbsp;<span class="num" id="3137787">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137790">case</span>&nbsp;<span class="ident" id="3137795">reflect</span><span class="op" id="3137802">.</span><span class="ident" id="3137803">Struct</span><span class="op" id="3137809">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137813">for</span>&nbsp;<span class="ident" id="3137817">i</span>&nbsp;<span class="op" id="3137819">:=</span>&nbsp;<span class="num" id="3137822">0</span><span class="op" id="3137823">;</span>&nbsp;<span class="ident" id="3137825">i</span>&nbsp;<span class="op" id="3137827">&lt;</span>&nbsp;<span class="ident" id="3137829">val</span><span class="op" id="3137832">.</span><span class="ident" id="3137833">NumField</span><span class="op" id="3137841">(</span><span class="op" id="3137842">)</span><span class="op" id="3137843">;</span>&nbsp;<span class="ident" id="3137845">i</span><span class="op" id="3137846">++</span>&nbsp;<span class="op" id="3137849">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137854">if</span>&nbsp;<span class="op" id="3137857">!</span><span class="ident" id="3137858">isZero</span><span class="op" id="3137864">(</span><span class="ident" id="3137865">val</span><span class="op" id="3137868">.</span><span class="ident" id="3137869">Field</span><span class="op" id="3137874">(</span><span class="ident" id="3137875">i</span><span class="op" id="3137876">)</span><span class="op" id="3137877">)</span>&nbsp;<span class="op" id="3137879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137885">return</span>&nbsp;<span class="builtintype" id="3137892">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3137909">return</span>&nbsp;<span class="builtintype" id="3137916">true</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3137922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3137925">panic</span><span class="op" id="3137930">(</span><span class="string" id="3137931">&#34;unknown&nbsp;type&nbsp;in&nbsp;isZero&nbsp;&#34;</span>&nbsp;<span class="op" id="3137957">+</span>&nbsp;<span class="ident" id="3137959">val</span><span class="op" id="3137962">.</span><span class="ident" id="3137963">Type</span><span class="op" id="3137967">(</span><span class="op" id="3137968">)</span><span class="op" id="3137969">.</span><span class="ident" id="3137970">String</span><span class="op" id="3137976">(</span><span class="op" id="3137977">)</span><span class="op" id="3137978">)</span><br>
<span class="lineno"></span><span class="op" id="3137980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3137983">//&nbsp;encGobEncoder&nbsp;encodes&nbsp;a&nbsp;value&nbsp;that&nbsp;implements&nbsp;the&nbsp;GobEncoder&nbsp;interface.</span><br>
<span class="lineno">460</span><span class="comment" id="3138058">//&nbsp;The&nbsp;data&nbsp;is&nbsp;sent&nbsp;as&nbsp;a&nbsp;byte&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="3138095">func</span>&nbsp;<span class="op" id="3138100">(</span><span class="ident" id="3138101">enc</span>&nbsp;<span class="op" id="3138105">*</span><span class="ident" id="3138106">Encoder</span><span class="op" id="3138113">)</span>&nbsp;<span class="ident" id="3138115">encodeGobEncoder</span><span class="op" id="3138131">(</span><span class="ident" id="3138132">b</span>&nbsp;<span class="op" id="3138134">*</span><span class="ident" id="3138135">encBuffer</span><span class="op" id="3138144">,</span>&nbsp;<span class="ident" id="3138146">ut</span>&nbsp;<span class="op" id="3138149">*</span><span class="ident" id="3138150">userTypeInfo</span><span class="op" id="3138162">,</span>&nbsp;<span class="ident" id="3138164">v</span>&nbsp;<span class="ident" id="3138166">reflect</span><span class="op" id="3138173">.</span><span class="ident" id="3138174">Value</span><span class="op" id="3138179">)</span>&nbsp;<span class="op" id="3138181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3138184">//&nbsp;TODO:&nbsp;should&nbsp;we&nbsp;catch&nbsp;panics&nbsp;from&nbsp;the&nbsp;called&nbsp;method?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138242">var</span>&nbsp;<span class="ident" id="3138246">data</span>&nbsp;<span class="op" id="3138251">[</span><span class="op" id="3138252">]</span><span class="builtintype" id="3138253">byte</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138259">var</span>&nbsp;<span class="ident" id="3138263">err</span>&nbsp;<span class="builtintype" id="3138267">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3138274">//&nbsp;We&nbsp;know&nbsp;it&#39;s&nbsp;one&nbsp;of&nbsp;these.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138305">switch</span>&nbsp;<span class="ident" id="3138312">ut</span><span class="op" id="3138314">.</span><span class="ident" id="3138315">externalEnc</span>&nbsp;<span class="op" id="3138327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138330">case</span>&nbsp;<span class="ident" id="3138335">xGob</span><span class="op" id="3138339">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138343">data</span><span class="op" id="3138347">,</span>&nbsp;<span class="ident" id="3138349">err</span>&nbsp;<span class="op" id="3138353">=</span>&nbsp;<span class="ident" id="3138355">v</span><span class="op" id="3138356">.</span><span class="ident" id="3138357">Interface</span><span class="op" id="3138366">(</span><span class="op" id="3138367">)</span><span class="op" id="3138368">.</span><span class="op" id="3138369">(</span><span class="ident" id="3138370">GobEncoder</span><span class="op" id="3138380">)</span><span class="op" id="3138381">.</span><span class="ident" id="3138382">GobEncode</span><span class="op" id="3138391">(</span><span class="op" id="3138392">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138395">case</span>&nbsp;<span class="ident" id="3138400">xBinary</span><span class="op" id="3138407">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138411">data</span><span class="op" id="3138415">,</span>&nbsp;<span class="ident" id="3138417">err</span>&nbsp;<span class="op" id="3138421">=</span>&nbsp;<span class="ident" id="3138423">v</span><span class="op" id="3138424">.</span><span class="ident" id="3138425">Interface</span><span class="op" id="3138434">(</span><span class="op" id="3138435">)</span><span class="op" id="3138436">.</span><span class="op" id="3138437">(</span><span class="ident" id="3138438">encoding</span><span class="op" id="3138446">.</span><span class="ident" id="3138447">BinaryMarshaler</span><span class="op" id="3138462">)</span><span class="op" id="3138463">.</span><span class="ident" id="3138464">MarshalBinary</span><span class="op" id="3138477">(</span><span class="op" id="3138478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138481">case</span>&nbsp;<span class="ident" id="3138486">xText</span><span class="op" id="3138491">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138495">data</span><span class="op" id="3138499">,</span>&nbsp;<span class="ident" id="3138501">err</span>&nbsp;<span class="op" id="3138505">=</span>&nbsp;<span class="ident" id="3138507">v</span><span class="op" id="3138508">.</span><span class="ident" id="3138509">Interface</span><span class="op" id="3138518">(</span><span class="op" id="3138519">)</span><span class="op" id="3138520">.</span><span class="op" id="3138521">(</span><span class="ident" id="3138522">encoding</span><span class="op" id="3138530">.</span><span class="ident" id="3138531">TextMarshaler</span><span class="op" id="3138544">)</span><span class="op" id="3138545">.</span><span class="ident" id="3138546">MarshalText</span><span class="op" id="3138557">(</span><span class="op" id="3138558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3138561">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3138564">if</span>&nbsp;<span class="ident" id="3138567">err</span>&nbsp;<span class="op" id="3138571">!=</span>&nbsp;<span class="ident" id="3138574">nil</span>&nbsp;<span class="op" id="3138578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138582">error_</span><span class="op" id="3138588">(</span><span class="ident" id="3138589">err</span><span class="op" id="3138592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3138595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138598">state</span>&nbsp;<span class="op" id="3138604">:=</span>&nbsp;<span class="ident" id="3138607">enc</span><span class="op" id="3138610">.</span><span class="ident" id="3138611">newEncoderState</span><span class="op" id="3138626">(</span><span class="ident" id="3138627">b</span><span class="op" id="3138628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138631">state</span><span class="op" id="3138636">.</span><span class="ident" id="3138637">fieldnum</span>&nbsp;<span class="op" id="3138646">=</span>&nbsp;<span class="op" id="3138648">-</span><span class="num" id="3138649">1</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138652">state</span><span class="op" id="3138657">.</span><span class="ident" id="3138658">encodeUint</span><span class="op" id="3138668">(</span><span class="ident" id="3138669">uint64</span><span class="op" id="3138675">(</span><span class="builtinfunc" id="3138676">len</span><span class="op" id="3138679">(</span><span class="ident" id="3138680">data</span><span class="op" id="3138684">)</span><span class="op" id="3138685">)</span><span class="op" id="3138686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138689">state</span><span class="op" id="3138694">.</span><span class="ident" id="3138695">b</span><span class="op" id="3138696">.</span><span class="ident" id="3138697">Write</span><span class="op" id="3138702">(</span><span class="ident" id="3138703">data</span><span class="op" id="3138707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138710">enc</span><span class="op" id="3138713">.</span><span class="ident" id="3138714">freeEncoderState</span><span class="op" id="3138730">(</span><span class="ident" id="3138731">state</span><span class="op" id="3138736">)</span><br>
<span class="lineno"></span><span class="op" id="3138738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">485</span><span class="keyword" id="3138741">var</span>&nbsp;<span class="ident" id="3138745">encOpTable</span>&nbsp;<span class="op" id="3138756">=</span>&nbsp;<span class="op" id="3138758">[</span><span class="op" id="3138759">...</span><span class="op" id="3138762">]</span><span class="ident" id="3138763">encOp</span><span class="op" id="3138768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138771">reflect</span><span class="op" id="3138778">.</span><span class="ident" id="3138779">Bool</span><span class="op" id="3138783">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3138791">encBool</span><span class="op" id="3138798">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138801">reflect</span><span class="op" id="3138808">.</span><span class="ident" id="3138809">Int</span><span class="op" id="3138812">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3138821">encInt</span><span class="op" id="3138827">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138830">reflect</span><span class="op" id="3138837">.</span><span class="ident" id="3138838">Int8</span><span class="op" id="3138842">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3138850">encInt</span><span class="op" id="3138856">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138859">reflect</span><span class="op" id="3138866">.</span><span class="ident" id="3138867">Int16</span><span class="op" id="3138872">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3138879">encInt</span><span class="op" id="3138885">,</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138888">reflect</span><span class="op" id="3138895">.</span><span class="ident" id="3138896">Int32</span><span class="op" id="3138901">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3138908">encInt</span><span class="op" id="3138914">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138917">reflect</span><span class="op" id="3138924">.</span><span class="ident" id="3138925">Int64</span><span class="op" id="3138930">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3138937">encInt</span><span class="op" id="3138943">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138946">reflect</span><span class="op" id="3138953">.</span><span class="ident" id="3138954">Uint</span><span class="op" id="3138958">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3138966">encUint</span><span class="op" id="3138973">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3138976">reflect</span><span class="op" id="3138983">.</span><span class="ident" id="3138984">Uint8</span><span class="op" id="3138989">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3138996">encUint</span><span class="op" id="3139003">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139006">reflect</span><span class="op" id="3139013">.</span><span class="ident" id="3139014">Uint16</span><span class="op" id="3139020">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3139026">encUint</span><span class="op" id="3139033">,</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139036">reflect</span><span class="op" id="3139043">.</span><span class="ident" id="3139044">Uint32</span><span class="op" id="3139050">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3139056">encUint</span><span class="op" id="3139063">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139066">reflect</span><span class="op" id="3139073">.</span><span class="ident" id="3139074">Uint64</span><span class="op" id="3139080">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3139086">encUint</span><span class="op" id="3139093">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139096">reflect</span><span class="op" id="3139103">.</span><span class="ident" id="3139104">Uintptr</span><span class="op" id="3139111">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3139116">encUint</span><span class="op" id="3139123">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139126">reflect</span><span class="op" id="3139133">.</span><span class="ident" id="3139134">Float32</span><span class="op" id="3139141">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3139146">encFloat</span><span class="op" id="3139154">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139157">reflect</span><span class="op" id="3139164">.</span><span class="ident" id="3139165">Float64</span><span class="op" id="3139172">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3139177">encFloat</span><span class="op" id="3139185">,</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139188">reflect</span><span class="op" id="3139195">.</span><span class="ident" id="3139196">Complex64</span><span class="op" id="3139205">:</span>&nbsp;&nbsp;<span class="ident" id="3139208">encComplex</span><span class="op" id="3139218">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139221">reflect</span><span class="op" id="3139228">.</span><span class="ident" id="3139229">Complex128</span><span class="op" id="3139239">:</span>&nbsp;<span class="ident" id="3139241">encComplex</span><span class="op" id="3139251">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139254">reflect</span><span class="op" id="3139261">.</span><span class="ident" id="3139262">String</span><span class="op" id="3139268">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3139274">encString</span><span class="op" id="3139283">,</span><br>
<span class="lineno"></span><span class="op" id="3139285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span><span class="comment" id="3139288">//&nbsp;encOpFor&nbsp;returns&nbsp;(a&nbsp;pointer&nbsp;to)&nbsp;the&nbsp;encoding&nbsp;op&nbsp;for&nbsp;the&nbsp;base&nbsp;type&nbsp;under&nbsp;rt&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3139370">//&nbsp;the&nbsp;indirection&nbsp;count&nbsp;to&nbsp;reach&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="3139408">func</span>&nbsp;<span class="ident" id="3139413">encOpFor</span><span class="op" id="3139421">(</span><span class="ident" id="3139422">rt</span>&nbsp;<span class="ident" id="3139425">reflect</span><span class="op" id="3139432">.</span><span class="ident" id="3139433">Type</span><span class="op" id="3139437">,</span>&nbsp;<span class="ident" id="3139439">inProgress</span>&nbsp;<span class="keyword" id="3139450">map</span><span class="op" id="3139453">[</span><span class="ident" id="3139454">reflect</span><span class="op" id="3139461">.</span><span class="ident" id="3139462">Type</span><span class="op" id="3139466">]</span><span class="op" id="3139467">*</span><span class="ident" id="3139468">encOp</span><span class="op" id="3139473">,</span>&nbsp;<span class="ident" id="3139475">building</span>&nbsp;<span class="keyword" id="3139484">map</span><span class="op" id="3139487">[</span><span class="op" id="3139488">*</span><span class="ident" id="3139489">typeInfo</span><span class="op" id="3139497">]</span><span class="builtintype" id="3139498">bool</span><span class="op" id="3139502">)</span>&nbsp;<span class="op" id="3139504">(</span><span class="op" id="3139505">*</span><span class="ident" id="3139506">encOp</span><span class="op" id="3139511">,</span>&nbsp;<span class="builtintype" id="3139513">int</span><span class="op" id="3139516">)</span>&nbsp;<span class="op" id="3139518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139521">ut</span>&nbsp;<span class="op" id="3139524">:=</span>&nbsp;<span class="ident" id="3139527">userType</span><span class="op" id="3139535">(</span><span class="ident" id="3139536">rt</span><span class="op" id="3139538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3139541">//&nbsp;If&nbsp;the&nbsp;type&nbsp;implements&nbsp;GobEncoder,&nbsp;we&nbsp;handle&nbsp;it&nbsp;without&nbsp;further&nbsp;processing.</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139621">if</span>&nbsp;<span class="ident" id="3139624">ut</span><span class="op" id="3139626">.</span><span class="ident" id="3139627">externalEnc</span>&nbsp;<span class="op" id="3139639">!=</span>&nbsp;<span class="num" id="3139642">0</span>&nbsp;<span class="op" id="3139644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139648">return</span>&nbsp;<span class="ident" id="3139655">gobEncodeOpFor</span><span class="op" id="3139669">(</span><span class="ident" id="3139670">ut</span><span class="op" id="3139672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3139675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3139678">//&nbsp;If&nbsp;this&nbsp;type&nbsp;is&nbsp;already&nbsp;in&nbsp;progress,&nbsp;it&#39;s&nbsp;a&nbsp;recursive&nbsp;type&nbsp;(e.g.&nbsp;map[string]*T).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3139763">//&nbsp;Return&nbsp;the&nbsp;pointer&nbsp;to&nbsp;the&nbsp;op&nbsp;we&#39;re&nbsp;already&nbsp;building.</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139820">if</span>&nbsp;<span class="ident" id="3139823">opPtr</span>&nbsp;<span class="op" id="3139829">:=</span>&nbsp;<span class="ident" id="3139832">inProgress</span><span class="op" id="3139842">[</span><span class="ident" id="3139843">rt</span><span class="op" id="3139845">]</span><span class="op" id="3139846">;</span>&nbsp;<span class="ident" id="3139848">opPtr</span>&nbsp;<span class="op" id="3139854">!=</span>&nbsp;<span class="ident" id="3139857">nil</span>&nbsp;<span class="op" id="3139861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139865">return</span>&nbsp;<span class="ident" id="3139872">opPtr</span><span class="op" id="3139877">,</span>&nbsp;<span class="ident" id="3139879">ut</span><span class="op" id="3139881">.</span><span class="ident" id="3139882">indir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3139889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139892">typ</span>&nbsp;<span class="op" id="3139896">:=</span>&nbsp;<span class="ident" id="3139899">ut</span><span class="op" id="3139901">.</span><span class="ident" id="3139902">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139908">indir</span>&nbsp;<span class="op" id="3139914">:=</span>&nbsp;<span class="ident" id="3139917">ut</span><span class="op" id="3139919">.</span><span class="ident" id="3139920">indir</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139927">k</span>&nbsp;<span class="op" id="3139929">:=</span>&nbsp;<span class="ident" id="3139932">typ</span><span class="op" id="3139935">.</span><span class="ident" id="3139936">Kind</span><span class="op" id="3139940">(</span><span class="op" id="3139941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139944">var</span>&nbsp;<span class="ident" id="3139948">op</span>&nbsp;<span class="ident" id="3139951">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3139958">if</span>&nbsp;<span class="builtintype" id="3139961">int</span><span class="op" id="3139964">(</span><span class="ident" id="3139965">k</span><span class="op" id="3139966">)</span>&nbsp;<span class="op" id="3139968">&lt;</span>&nbsp;<span class="builtinfunc" id="3139970">len</span><span class="op" id="3139973">(</span><span class="ident" id="3139974">encOpTable</span><span class="op" id="3139984">)</span>&nbsp;<span class="op" id="3139986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3139990">op</span>&nbsp;<span class="op" id="3139993">=</span>&nbsp;<span class="ident" id="3139995">encOpTable</span><span class="op" id="3140005">[</span><span class="ident" id="3140006">k</span><span class="op" id="3140007">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3140010">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140013">if</span>&nbsp;<span class="ident" id="3140016">op</span>&nbsp;<span class="op" id="3140019">==</span>&nbsp;<span class="ident" id="3140022">nil</span>&nbsp;<span class="op" id="3140026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140030">inProgress</span><span class="op" id="3140040">[</span><span class="ident" id="3140041">rt</span><span class="op" id="3140043">]</span>&nbsp;<span class="op" id="3140045">=</span>&nbsp;<span class="op" id="3140047">&amp;</span><span class="ident" id="3140048">op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3140053">//&nbsp;Special&nbsp;cases</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140072">switch</span>&nbsp;<span class="ident" id="3140079">t</span>&nbsp;<span class="op" id="3140081">:=</span>&nbsp;<span class="ident" id="3140084">typ</span><span class="op" id="3140087">;</span>&nbsp;<span class="ident" id="3140089">t</span><span class="op" id="3140090">.</span><span class="ident" id="3140091">Kind</span><span class="op" id="3140095">(</span><span class="op" id="3140096">)</span>&nbsp;<span class="op" id="3140098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140102">case</span>&nbsp;<span class="ident" id="3140107">reflect</span><span class="op" id="3140114">.</span><span class="ident" id="3140115">Slice</span><span class="op" id="3140120">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140125">if</span>&nbsp;<span class="ident" id="3140128">t</span><span class="op" id="3140129">.</span><span class="ident" id="3140130">Elem</span><span class="op" id="3140134">(</span><span class="op" id="3140135">)</span><span class="op" id="3140136">.</span><span class="ident" id="3140137">Kind</span><span class="op" id="3140141">(</span><span class="op" id="3140142">)</span>&nbsp;<span class="op" id="3140144">==</span>&nbsp;<span class="ident" id="3140147">reflect</span><span class="op" id="3140154">.</span><span class="ident" id="3140155">Uint8</span>&nbsp;<span class="op" id="3140161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140167">op</span>&nbsp;<span class="op" id="3140170">=</span>&nbsp;<span class="ident" id="3140172">encUint8Array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140190">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3140199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3140204">//&nbsp;Slices&nbsp;have&nbsp;a&nbsp;header;&nbsp;we&nbsp;decode&nbsp;it&nbsp;to&nbsp;find&nbsp;the&nbsp;underlying&nbsp;array.</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140275">elemOp</span><span class="op" id="3140281">,</span>&nbsp;<span class="ident" id="3140283">elemIndir</span>&nbsp;<span class="op" id="3140293">:=</span>&nbsp;<span class="ident" id="3140296">encOpFor</span><span class="op" id="3140304">(</span><span class="ident" id="3140305">t</span><span class="op" id="3140306">.</span><span class="ident" id="3140307">Elem</span><span class="op" id="3140311">(</span><span class="op" id="3140312">)</span><span class="op" id="3140313">,</span>&nbsp;<span class="ident" id="3140315">inProgress</span><span class="op" id="3140325">,</span>&nbsp;<span class="ident" id="3140327">building</span><span class="op" id="3140335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140340">helper</span>&nbsp;<span class="op" id="3140347">:=</span>&nbsp;<span class="ident" id="3140350">encSliceHelper</span><span class="op" id="3140364">[</span><span class="ident" id="3140365">t</span><span class="op" id="3140366">.</span><span class="ident" id="3140367">Elem</span><span class="op" id="3140371">(</span><span class="op" id="3140372">)</span><span class="op" id="3140373">.</span><span class="ident" id="3140374">Kind</span><span class="op" id="3140378">(</span><span class="op" id="3140379">)</span><span class="op" id="3140380">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140385">op</span>&nbsp;<span class="op" id="3140388">=</span>&nbsp;<span class="keyword" id="3140390">func</span><span class="op" id="3140394">(</span><span class="ident" id="3140395">i</span>&nbsp;<span class="op" id="3140397">*</span><span class="ident" id="3140398">encInstr</span><span class="op" id="3140406">,</span>&nbsp;<span class="ident" id="3140408">state</span>&nbsp;<span class="op" id="3140414">*</span><span class="ident" id="3140415">encoderState</span><span class="op" id="3140427">,</span>&nbsp;<span class="ident" id="3140429">slice</span>&nbsp;<span class="ident" id="3140435">reflect</span><span class="op" id="3140442">.</span><span class="ident" id="3140443">Value</span><span class="op" id="3140448">)</span>&nbsp;<span class="op" id="3140450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140456">if</span>&nbsp;<span class="op" id="3140459">!</span><span class="ident" id="3140460">state</span><span class="op" id="3140465">.</span><span class="ident" id="3140466">sendZero</span>&nbsp;<span class="op" id="3140475">&amp;&amp;</span>&nbsp;<span class="ident" id="3140478">slice</span><span class="op" id="3140483">.</span><span class="ident" id="3140484">Len</span><span class="op" id="3140487">(</span><span class="op" id="3140488">)</span>&nbsp;<span class="op" id="3140490">==</span>&nbsp;<span class="num" id="3140493">0</span>&nbsp;<span class="op" id="3140495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140502">return</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3140513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140519">state</span><span class="op" id="3140524">.</span><span class="ident" id="3140525">update</span><span class="op" id="3140531">(</span><span class="ident" id="3140532">i</span><span class="op" id="3140533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140539">state</span><span class="op" id="3140544">.</span><span class="ident" id="3140545">enc</span><span class="op" id="3140548">.</span><span class="ident" id="3140549">encodeArray</span><span class="op" id="3140560">(</span><span class="ident" id="3140561">state</span><span class="op" id="3140566">.</span><span class="ident" id="3140567">b</span><span class="op" id="3140568">,</span>&nbsp;<span class="ident" id="3140570">slice</span><span class="op" id="3140575">,</span>&nbsp;<span class="op" id="3140577">*</span><span class="ident" id="3140578">elemOp</span><span class="op" id="3140584">,</span>&nbsp;<span class="ident" id="3140586">elemIndir</span><span class="op" id="3140595">,</span>&nbsp;<span class="ident" id="3140597">slice</span><span class="op" id="3140602">.</span><span class="ident" id="3140603">Len</span><span class="op" id="3140606">(</span><span class="op" id="3140607">)</span><span class="op" id="3140608">,</span>&nbsp;<span class="ident" id="3140610">helper</span><span class="op" id="3140616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3140621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140625">case</span>&nbsp;<span class="ident" id="3140630">reflect</span><span class="op" id="3140637">.</span><span class="ident" id="3140638">Array</span><span class="op" id="3140643">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3140648">//&nbsp;True&nbsp;arrays&nbsp;have&nbsp;size&nbsp;in&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140689">elemOp</span><span class="op" id="3140695">,</span>&nbsp;<span class="ident" id="3140697">elemIndir</span>&nbsp;<span class="op" id="3140707">:=</span>&nbsp;<span class="ident" id="3140710">encOpFor</span><span class="op" id="3140718">(</span><span class="ident" id="3140719">t</span><span class="op" id="3140720">.</span><span class="ident" id="3140721">Elem</span><span class="op" id="3140725">(</span><span class="op" id="3140726">)</span><span class="op" id="3140727">,</span>&nbsp;<span class="ident" id="3140729">inProgress</span><span class="op" id="3140739">,</span>&nbsp;<span class="ident" id="3140741">building</span><span class="op" id="3140749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140754">helper</span>&nbsp;<span class="op" id="3140761">:=</span>&nbsp;<span class="ident" id="3140764">encArrayHelper</span><span class="op" id="3140778">[</span><span class="ident" id="3140779">t</span><span class="op" id="3140780">.</span><span class="ident" id="3140781">Elem</span><span class="op" id="3140785">(</span><span class="op" id="3140786">)</span><span class="op" id="3140787">.</span><span class="ident" id="3140788">Kind</span><span class="op" id="3140792">(</span><span class="op" id="3140793">)</span><span class="op" id="3140794">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140799">op</span>&nbsp;<span class="op" id="3140802">=</span>&nbsp;<span class="keyword" id="3140804">func</span><span class="op" id="3140808">(</span><span class="ident" id="3140809">i</span>&nbsp;<span class="op" id="3140811">*</span><span class="ident" id="3140812">encInstr</span><span class="op" id="3140820">,</span>&nbsp;<span class="ident" id="3140822">state</span>&nbsp;<span class="op" id="3140828">*</span><span class="ident" id="3140829">encoderState</span><span class="op" id="3140841">,</span>&nbsp;<span class="ident" id="3140843">array</span>&nbsp;<span class="ident" id="3140849">reflect</span><span class="op" id="3140856">.</span><span class="ident" id="3140857">Value</span><span class="op" id="3140862">)</span>&nbsp;<span class="op" id="3140864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140870">state</span><span class="op" id="3140875">.</span><span class="ident" id="3140876">update</span><span class="op" id="3140882">(</span><span class="ident" id="3140883">i</span><span class="op" id="3140884">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140890">state</span><span class="op" id="3140895">.</span><span class="ident" id="3140896">enc</span><span class="op" id="3140899">.</span><span class="ident" id="3140900">encodeArray</span><span class="op" id="3140911">(</span><span class="ident" id="3140912">state</span><span class="op" id="3140917">.</span><span class="ident" id="3140918">b</span><span class="op" id="3140919">,</span>&nbsp;<span class="ident" id="3140921">array</span><span class="op" id="3140926">,</span>&nbsp;<span class="op" id="3140928">*</span><span class="ident" id="3140929">elemOp</span><span class="op" id="3140935">,</span>&nbsp;<span class="ident" id="3140937">elemIndir</span><span class="op" id="3140946">,</span>&nbsp;<span class="ident" id="3140948">array</span><span class="op" id="3140953">.</span><span class="ident" id="3140954">Len</span><span class="op" id="3140957">(</span><span class="op" id="3140958">)</span><span class="op" id="3140959">,</span>&nbsp;<span class="ident" id="3140961">helper</span><span class="op" id="3140967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3140972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3140976">case</span>&nbsp;<span class="ident" id="3140981">reflect</span><span class="op" id="3140988">.</span><span class="ident" id="3140989">Map</span><span class="op" id="3140992">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3140997">keyOp</span><span class="op" id="3141002">,</span>&nbsp;<span class="ident" id="3141004">keyIndir</span>&nbsp;<span class="op" id="3141013">:=</span>&nbsp;<span class="ident" id="3141016">encOpFor</span><span class="op" id="3141024">(</span><span class="ident" id="3141025">t</span><span class="op" id="3141026">.</span><span class="ident" id="3141027">Key</span><span class="op" id="3141030">(</span><span class="op" id="3141031">)</span><span class="op" id="3141032">,</span>&nbsp;<span class="ident" id="3141034">inProgress</span><span class="op" id="3141044">,</span>&nbsp;<span class="ident" id="3141046">building</span><span class="op" id="3141054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141059">elemOp</span><span class="op" id="3141065">,</span>&nbsp;<span class="ident" id="3141067">elemIndir</span>&nbsp;<span class="op" id="3141077">:=</span>&nbsp;<span class="ident" id="3141080">encOpFor</span><span class="op" id="3141088">(</span><span class="ident" id="3141089">t</span><span class="op" id="3141090">.</span><span class="ident" id="3141091">Elem</span><span class="op" id="3141095">(</span><span class="op" id="3141096">)</span><span class="op" id="3141097">,</span>&nbsp;<span class="ident" id="3141099">inProgress</span><span class="op" id="3141109">,</span>&nbsp;<span class="ident" id="3141111">building</span><span class="op" id="3141119">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141124">op</span>&nbsp;<span class="op" id="3141127">=</span>&nbsp;<span class="keyword" id="3141129">func</span><span class="op" id="3141133">(</span><span class="ident" id="3141134">i</span>&nbsp;<span class="op" id="3141136">*</span><span class="ident" id="3141137">encInstr</span><span class="op" id="3141145">,</span>&nbsp;<span class="ident" id="3141147">state</span>&nbsp;<span class="op" id="3141153">*</span><span class="ident" id="3141154">encoderState</span><span class="op" id="3141166">,</span>&nbsp;<span class="ident" id="3141168">mv</span>&nbsp;<span class="ident" id="3141171">reflect</span><span class="op" id="3141178">.</span><span class="ident" id="3141179">Value</span><span class="op" id="3141184">)</span>&nbsp;<span class="op" id="3141186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3141192">//&nbsp;We&nbsp;send&nbsp;zero-length&nbsp;(but&nbsp;non-nil)&nbsp;maps&nbsp;because&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3141250">//&nbsp;receiver&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;the&nbsp;map.&nbsp;&nbsp;(Maps&nbsp;don&#39;t&nbsp;use&nbsp;append.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141319">if</span>&nbsp;<span class="op" id="3141322">!</span><span class="ident" id="3141323">state</span><span class="op" id="3141328">.</span><span class="ident" id="3141329">sendZero</span>&nbsp;<span class="op" id="3141338">&amp;&amp;</span>&nbsp;<span class="ident" id="3141341">mv</span><span class="op" id="3141343">.</span><span class="ident" id="3141344">IsNil</span><span class="op" id="3141349">(</span><span class="op" id="3141350">)</span>&nbsp;<span class="op" id="3141352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141359">return</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3141370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141376">state</span><span class="op" id="3141381">.</span><span class="ident" id="3141382">update</span><span class="op" id="3141388">(</span><span class="ident" id="3141389">i</span><span class="op" id="3141390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141396">state</span><span class="op" id="3141401">.</span><span class="ident" id="3141402">enc</span><span class="op" id="3141405">.</span><span class="ident" id="3141406">encodeMap</span><span class="op" id="3141415">(</span><span class="ident" id="3141416">state</span><span class="op" id="3141421">.</span><span class="ident" id="3141422">b</span><span class="op" id="3141423">,</span>&nbsp;<span class="ident" id="3141425">mv</span><span class="op" id="3141427">,</span>&nbsp;<span class="op" id="3141429">*</span><span class="ident" id="3141430">keyOp</span><span class="op" id="3141435">,</span>&nbsp;<span class="op" id="3141437">*</span><span class="ident" id="3141438">elemOp</span><span class="op" id="3141444">,</span>&nbsp;<span class="ident" id="3141446">keyIndir</span><span class="op" id="3141454">,</span>&nbsp;<span class="ident" id="3141456">elemIndir</span><span class="op" id="3141465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3141470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141474">case</span>&nbsp;<span class="ident" id="3141479">reflect</span><span class="op" id="3141486">.</span><span class="ident" id="3141487">Struct</span><span class="op" id="3141493">:</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3141498">//&nbsp;Generate&nbsp;a&nbsp;closure&nbsp;that&nbsp;calls&nbsp;out&nbsp;to&nbsp;the&nbsp;engine&nbsp;for&nbsp;the&nbsp;nested&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141573">getEncEngine</span><span class="op" id="3141585">(</span><span class="ident" id="3141586">userType</span><span class="op" id="3141594">(</span><span class="ident" id="3141595">typ</span><span class="op" id="3141598">)</span><span class="op" id="3141599">,</span>&nbsp;<span class="ident" id="3141601">building</span><span class="op" id="3141609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141614">info</span>&nbsp;<span class="op" id="3141619">:=</span>&nbsp;<span class="ident" id="3141622">mustGetTypeInfo</span><span class="op" id="3141637">(</span><span class="ident" id="3141638">typ</span><span class="op" id="3141641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141646">op</span>&nbsp;<span class="op" id="3141649">=</span>&nbsp;<span class="keyword" id="3141651">func</span><span class="op" id="3141655">(</span><span class="ident" id="3141656">i</span>&nbsp;<span class="op" id="3141658">*</span><span class="ident" id="3141659">encInstr</span><span class="op" id="3141667">,</span>&nbsp;<span class="ident" id="3141669">state</span>&nbsp;<span class="op" id="3141675">*</span><span class="ident" id="3141676">encoderState</span><span class="op" id="3141688">,</span>&nbsp;<span class="ident" id="3141690">sv</span>&nbsp;<span class="ident" id="3141693">reflect</span><span class="op" id="3141700">.</span><span class="ident" id="3141701">Value</span><span class="op" id="3141706">)</span>&nbsp;<span class="op" id="3141708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141714">state</span><span class="op" id="3141719">.</span><span class="ident" id="3141720">update</span><span class="op" id="3141726">(</span><span class="ident" id="3141727">i</span><span class="op" id="3141728">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3141734">//&nbsp;indirect&nbsp;through&nbsp;info&nbsp;to&nbsp;delay&nbsp;evaluation&nbsp;for&nbsp;recursive&nbsp;structs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141805">enc</span>&nbsp;<span class="op" id="3141809">:=</span>&nbsp;<span class="ident" id="3141812">info</span><span class="op" id="3141816">.</span><span class="ident" id="3141817">encoder</span><span class="op" id="3141824">.</span><span class="ident" id="3141825">Load</span><span class="op" id="3141829">(</span><span class="op" id="3141830">)</span><span class="op" id="3141831">.</span><span class="op" id="3141832">(</span><span class="op" id="3141833">*</span><span class="ident" id="3141834">encEngine</span><span class="op" id="3141843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141849">state</span><span class="op" id="3141854">.</span><span class="ident" id="3141855">enc</span><span class="op" id="3141858">.</span><span class="ident" id="3141859">encodeStruct</span><span class="op" id="3141871">(</span><span class="ident" id="3141872">state</span><span class="op" id="3141877">.</span><span class="ident" id="3141878">b</span><span class="op" id="3141879">,</span>&nbsp;<span class="ident" id="3141881">enc</span><span class="op" id="3141884">,</span>&nbsp;<span class="ident" id="3141886">sv</span><span class="op" id="3141888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3141893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141897">case</span>&nbsp;<span class="ident" id="3141902">reflect</span><span class="op" id="3141909">.</span><span class="ident" id="3141910">Interface</span><span class="op" id="3141919">:</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3141924">op</span>&nbsp;<span class="op" id="3141927">=</span>&nbsp;<span class="keyword" id="3141929">func</span><span class="op" id="3141933">(</span><span class="ident" id="3141934">i</span>&nbsp;<span class="op" id="3141936">*</span><span class="ident" id="3141937">encInstr</span><span class="op" id="3141945">,</span>&nbsp;<span class="ident" id="3141947">state</span>&nbsp;<span class="op" id="3141953">*</span><span class="ident" id="3141954">encoderState</span><span class="op" id="3141966">,</span>&nbsp;<span class="ident" id="3141968">iv</span>&nbsp;<span class="ident" id="3141971">reflect</span><span class="op" id="3141978">.</span><span class="ident" id="3141979">Value</span><span class="op" id="3141984">)</span>&nbsp;<span class="op" id="3141986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3141992">if</span>&nbsp;<span class="op" id="3141995">!</span><span class="ident" id="3141996">state</span><span class="op" id="3142001">.</span><span class="ident" id="3142002">sendZero</span>&nbsp;<span class="op" id="3142011">&amp;&amp;</span>&nbsp;<span class="op" id="3142014">(</span><span class="op" id="3142015">!</span><span class="ident" id="3142016">iv</span><span class="op" id="3142018">.</span><span class="ident" id="3142019">IsValid</span><span class="op" id="3142026">(</span><span class="op" id="3142027">)</span>&nbsp;<span class="op" id="3142029">||</span>&nbsp;<span class="ident" id="3142032">iv</span><span class="op" id="3142034">.</span><span class="ident" id="3142035">IsNil</span><span class="op" id="3142040">(</span><span class="op" id="3142041">)</span><span class="op" id="3142042">)</span>&nbsp;<span class="op" id="3142044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142051">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3142068">state</span><span class="op" id="3142073">.</span><span class="ident" id="3142074">update</span><span class="op" id="3142080">(</span><span class="ident" id="3142081">i</span><span class="op" id="3142082">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3142088">state</span><span class="op" id="3142093">.</span><span class="ident" id="3142094">enc</span><span class="op" id="3142097">.</span><span class="ident" id="3142098">encodeInterface</span><span class="op" id="3142113">(</span><span class="ident" id="3142114">state</span><span class="op" id="3142119">.</span><span class="ident" id="3142120">b</span><span class="op" id="3142121">,</span>&nbsp;<span class="ident" id="3142123">iv</span><span class="op" id="3142125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142140">if</span>&nbsp;<span class="ident" id="3142143">op</span>&nbsp;<span class="op" id="3142146">==</span>&nbsp;<span class="ident" id="3142149">nil</span>&nbsp;<span class="op" id="3142153">{</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3142157">errorf</span><span class="op" id="3142163">(</span><span class="string" id="3142164">&#34;can&#39;t&nbsp;happen:&nbsp;encode&nbsp;type&nbsp;%s&#34;</span><span class="op" id="3142194">,</span>&nbsp;<span class="ident" id="3142196">rt</span><span class="op" id="3142198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142204">return</span>&nbsp;<span class="op" id="3142211">&amp;</span><span class="ident" id="3142212">op</span><span class="op" id="3142214">,</span>&nbsp;<span class="ident" id="3142216">indir</span><br>
<span class="lineno"></span><span class="op" id="3142222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="comment" id="3142225">//&nbsp;gobEncodeOpFor&nbsp;returns&nbsp;the&nbsp;op&nbsp;for&nbsp;a&nbsp;type&nbsp;that&nbsp;is&nbsp;known&nbsp;to&nbsp;implement&nbsp;GobEncoder.</span><br>
<span class="lineno"></span><span class="keyword" id="3142308">func</span>&nbsp;<span class="ident" id="3142313">gobEncodeOpFor</span><span class="op" id="3142327">(</span><span class="ident" id="3142328">ut</span>&nbsp;<span class="op" id="3142331">*</span><span class="ident" id="3142332">userTypeInfo</span><span class="op" id="3142344">)</span>&nbsp;<span class="op" id="3142346">(</span><span class="op" id="3142347">*</span><span class="ident" id="3142348">encOp</span><span class="op" id="3142353">,</span>&nbsp;<span class="builtintype" id="3142355">int</span><span class="op" id="3142358">)</span>&nbsp;<span class="op" id="3142360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3142363">rt</span>&nbsp;<span class="op" id="3142366">:=</span>&nbsp;<span class="ident" id="3142369">ut</span><span class="op" id="3142371">.</span><span class="ident" id="3142372">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142378">if</span>&nbsp;<span class="ident" id="3142381">ut</span><span class="op" id="3142383">.</span><span class="ident" id="3142384">encIndir</span>&nbsp;<span class="op" id="3142393">==</span>&nbsp;<span class="op" id="3142396">-</span><span class="num" id="3142397">1</span>&nbsp;<span class="op" id="3142399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3142403">rt</span>&nbsp;<span class="op" id="3142406">=</span>&nbsp;<span class="ident" id="3142408">reflect</span><span class="op" id="3142415">.</span><span class="ident" id="3142416">PtrTo</span><span class="op" id="3142421">(</span><span class="ident" id="3142422">rt</span><span class="op" id="3142424">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142427">}</span>&nbsp;<span class="keyword" id="3142429">else</span>&nbsp;<span class="keyword" id="3142434">if</span>&nbsp;<span class="ident" id="3142437">ut</span><span class="op" id="3142439">.</span><span class="ident" id="3142440">encIndir</span>&nbsp;<span class="op" id="3142449">&gt;</span>&nbsp;<span class="num" id="3142451">0</span>&nbsp;<span class="op" id="3142453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142457">for</span>&nbsp;<span class="ident" id="3142461">i</span>&nbsp;<span class="op" id="3142463">:=</span>&nbsp;<span class="builtintype" id="3142466">int8</span><span class="op" id="3142470">(</span><span class="num" id="3142471">0</span><span class="op" id="3142472">)</span><span class="op" id="3142473">;</span>&nbsp;<span class="ident" id="3142475">i</span>&nbsp;<span class="op" id="3142477">&lt;</span>&nbsp;<span class="ident" id="3142479">ut</span><span class="op" id="3142481">.</span><span class="ident" id="3142482">encIndir</span><span class="op" id="3142490">;</span>&nbsp;<span class="ident" id="3142492">i</span><span class="op" id="3142493">++</span>&nbsp;<span class="op" id="3142496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3142501">rt</span>&nbsp;<span class="op" id="3142504">=</span>&nbsp;<span class="ident" id="3142506">rt</span><span class="op" id="3142508">.</span><span class="ident" id="3142509">Elem</span><span class="op" id="3142513">(</span><span class="op" id="3142514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142521">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142524">var</span>&nbsp;<span class="ident" id="3142528">op</span>&nbsp;<span class="ident" id="3142531">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3142538">op</span>&nbsp;<span class="op" id="3142541">=</span>&nbsp;<span class="keyword" id="3142543">func</span><span class="op" id="3142547">(</span><span class="ident" id="3142548">i</span>&nbsp;<span class="op" id="3142550">*</span><span class="ident" id="3142551">encInstr</span><span class="op" id="3142559">,</span>&nbsp;<span class="ident" id="3142561">state</span>&nbsp;<span class="op" id="3142567">*</span><span class="ident" id="3142568">encoderState</span><span class="op" id="3142580">,</span>&nbsp;<span class="ident" id="3142582">v</span>&nbsp;<span class="ident" id="3142584">reflect</span><span class="op" id="3142591">.</span><span class="ident" id="3142592">Value</span><span class="op" id="3142597">)</span>&nbsp;<span class="op" id="3142599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142603">if</span>&nbsp;<span class="ident" id="3142606">ut</span><span class="op" id="3142608">.</span><span class="ident" id="3142609">encIndir</span>&nbsp;<span class="op" id="3142618">==</span>&nbsp;<span class="op" id="3142621">-</span><span class="num" id="3142622">1</span>&nbsp;<span class="op" id="3142624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3142629">//&nbsp;Need&nbsp;to&nbsp;climb&nbsp;up&nbsp;one&nbsp;level&nbsp;to&nbsp;turn&nbsp;value&nbsp;into&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142690">if</span>&nbsp;<span class="op" id="3142693">!</span><span class="ident" id="3142694">v</span><span class="op" id="3142695">.</span><span class="ident" id="3142696">CanAddr</span><span class="op" id="3142703">(</span><span class="op" id="3142704">)</span>&nbsp;<span class="op" id="3142706">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3142712">errorf</span><span class="op" id="3142718">(</span><span class="string" id="3142719">&#34;unaddressable&nbsp;value&nbsp;of&nbsp;type&nbsp;%s&#34;</span><span class="op" id="3142751">,</span>&nbsp;<span class="ident" id="3142753">rt</span><span class="op" id="3142755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3142765">v</span>&nbsp;<span class="op" id="3142767">=</span>&nbsp;<span class="ident" id="3142769">v</span><span class="op" id="3142770">.</span><span class="ident" id="3142771">Addr</span><span class="op" id="3142775">(</span><span class="op" id="3142776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142784">if</span>&nbsp;<span class="op" id="3142787">!</span><span class="ident" id="3142788">state</span><span class="op" id="3142793">.</span><span class="ident" id="3142794">sendZero</span>&nbsp;<span class="op" id="3142803">&amp;&amp;</span>&nbsp;<span class="ident" id="3142806">isZero</span><span class="op" id="3142812">(</span><span class="ident" id="3142813">v</span><span class="op" id="3142814">)</span>&nbsp;<span class="op" id="3142816">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142821">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3142834">state</span><span class="op" id="3142839">.</span><span class="ident" id="3142840">update</span><span class="op" id="3142846">(</span><span class="ident" id="3142847">i</span><span class="op" id="3142848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3142852">state</span><span class="op" id="3142857">.</span><span class="ident" id="3142858">enc</span><span class="op" id="3142861">.</span><span class="ident" id="3142862">encodeGobEncoder</span><span class="op" id="3142878">(</span><span class="ident" id="3142879">state</span><span class="op" id="3142884">.</span><span class="ident" id="3142885">b</span><span class="op" id="3142886">,</span>&nbsp;<span class="ident" id="3142888">ut</span><span class="op" id="3142890">,</span>&nbsp;<span class="ident" id="3142892">v</span><span class="op" id="3142893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3142896">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3142899">return</span>&nbsp;<span class="op" id="3142906">&amp;</span><span class="ident" id="3142907">op</span><span class="op" id="3142909">,</span>&nbsp;<span class="builtintype" id="3142911">int</span><span class="op" id="3142914">(</span><span class="ident" id="3142915">ut</span><span class="op" id="3142917">.</span><span class="ident" id="3142918">encIndir</span><span class="op" id="3142926">)</span>&nbsp;<span class="comment" id="3142928">//&nbsp;encIndir:&nbsp;op&nbsp;will&nbsp;get&nbsp;called&nbsp;with&nbsp;p&nbsp;==&nbsp;address&nbsp;of&nbsp;receiver.</span><br>
<span class="lineno"></span><span class="op" id="3142991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3142994">//&nbsp;compileEnc&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3143048">func</span>&nbsp;<span class="ident" id="3143053">compileEnc</span><span class="op" id="3143063">(</span><span class="ident" id="3143064">ut</span>&nbsp;<span class="op" id="3143067">*</span><span class="ident" id="3143068">userTypeInfo</span><span class="op" id="3143080">,</span>&nbsp;<span class="ident" id="3143082">building</span>&nbsp;<span class="keyword" id="3143091">map</span><span class="op" id="3143094">[</span><span class="op" id="3143095">*</span><span class="ident" id="3143096">typeInfo</span><span class="op" id="3143104">]</span><span class="builtintype" id="3143105">bool</span><span class="op" id="3143109">)</span>&nbsp;<span class="op" id="3143111">*</span><span class="ident" id="3143112">encEngine</span>&nbsp;<span class="op" id="3143122">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143125">srt</span>&nbsp;<span class="op" id="3143129">:=</span>&nbsp;<span class="ident" id="3143132">ut</span><span class="op" id="3143134">.</span><span class="ident" id="3143135">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143141">engine</span>&nbsp;<span class="op" id="3143148">:=</span>&nbsp;<span class="builtinfunc" id="3143151">new</span><span class="op" id="3143154">(</span><span class="ident" id="3143155">encEngine</span><span class="op" id="3143164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143167">seen</span>&nbsp;<span class="op" id="3143172">:=</span>&nbsp;<span class="builtinfunc" id="3143175">make</span><span class="op" id="3143179">(</span><span class="keyword" id="3143180">map</span><span class="op" id="3143183">[</span><span class="ident" id="3143184">reflect</span><span class="op" id="3143191">.</span><span class="ident" id="3143192">Type</span><span class="op" id="3143196">]</span><span class="op" id="3143197">*</span><span class="ident" id="3143198">encOp</span><span class="op" id="3143203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143206">rt</span>&nbsp;<span class="op" id="3143209">:=</span>&nbsp;<span class="ident" id="3143212">ut</span><span class="op" id="3143214">.</span><span class="ident" id="3143215">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143221">if</span>&nbsp;<span class="ident" id="3143224">ut</span><span class="op" id="3143226">.</span><span class="ident" id="3143227">externalEnc</span>&nbsp;<span class="op" id="3143239">!=</span>&nbsp;<span class="num" id="3143242">0</span>&nbsp;<span class="op" id="3143244">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143248">rt</span>&nbsp;<span class="op" id="3143251">=</span>&nbsp;<span class="ident" id="3143253">ut</span><span class="op" id="3143255">.</span><span class="ident" id="3143256">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3143262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143265">if</span>&nbsp;<span class="ident" id="3143268">ut</span><span class="op" id="3143270">.</span><span class="ident" id="3143271">externalEnc</span>&nbsp;<span class="op" id="3143283">==</span>&nbsp;<span class="num" id="3143286">0</span>&nbsp;<span class="op" id="3143288">&amp;&amp;</span>&nbsp;<span class="ident" id="3143291">srt</span><span class="op" id="3143294">.</span><span class="ident" id="3143295">Kind</span><span class="op" id="3143299">(</span><span class="op" id="3143300">)</span>&nbsp;<span class="op" id="3143302">==</span>&nbsp;<span class="ident" id="3143305">reflect</span><span class="op" id="3143312">.</span><span class="ident" id="3143313">Struct</span>&nbsp;<span class="op" id="3143320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143324">for</span>&nbsp;<span class="ident" id="3143328">fieldNum</span><span class="op" id="3143336">,</span>&nbsp;<span class="ident" id="3143338">wireFieldNum</span>&nbsp;<span class="op" id="3143351">:=</span>&nbsp;<span class="num" id="3143354">0</span><span class="op" id="3143355">,</span>&nbsp;<span class="num" id="3143357">0</span><span class="op" id="3143358">;</span>&nbsp;<span class="ident" id="3143360">fieldNum</span>&nbsp;<span class="op" id="3143369">&lt;</span>&nbsp;<span class="ident" id="3143371">srt</span><span class="op" id="3143374">.</span><span class="ident" id="3143375">NumField</span><span class="op" id="3143383">(</span><span class="op" id="3143384">)</span><span class="op" id="3143385">;</span>&nbsp;<span class="ident" id="3143387">fieldNum</span><span class="op" id="3143395">++</span>&nbsp;<span class="op" id="3143398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143403">f</span>&nbsp;<span class="op" id="3143405">:=</span>&nbsp;<span class="ident" id="3143408">srt</span><span class="op" id="3143411">.</span><span class="ident" id="3143412">Field</span><span class="op" id="3143417">(</span><span class="ident" id="3143418">fieldNum</span><span class="op" id="3143426">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143431">if</span>&nbsp;<span class="op" id="3143434">!</span><span class="ident" id="3143435">isSent</span><span class="op" id="3143441">(</span><span class="op" id="3143442">&amp;</span><span class="ident" id="3143443">f</span><span class="op" id="3143444">)</span>&nbsp;<span class="op" id="3143446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143452">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3143464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143469">op</span><span class="op" id="3143471">,</span>&nbsp;<span class="ident" id="3143473">indir</span>&nbsp;<span class="op" id="3143479">:=</span>&nbsp;<span class="ident" id="3143482">encOpFor</span><span class="op" id="3143490">(</span><span class="ident" id="3143491">f</span><span class="op" id="3143492">.</span><span class="ident" id="3143493">Type</span><span class="op" id="3143497">,</span>&nbsp;<span class="ident" id="3143499">seen</span><span class="op" id="3143503">,</span>&nbsp;<span class="ident" id="3143505">building</span><span class="op" id="3143513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143518">engine</span><span class="op" id="3143524">.</span><span class="ident" id="3143525">instr</span>&nbsp;<span class="op" id="3143531">=</span>&nbsp;<span class="builtinfunc" id="3143533">append</span><span class="op" id="3143539">(</span><span class="ident" id="3143540">engine</span><span class="op" id="3143546">.</span><span class="ident" id="3143547">instr</span><span class="op" id="3143552">,</span>&nbsp;<span class="ident" id="3143554">encInstr</span><span class="op" id="3143562">{</span><span class="op" id="3143563">*</span><span class="ident" id="3143564">op</span><span class="op" id="3143566">,</span>&nbsp;<span class="ident" id="3143568">wireFieldNum</span><span class="op" id="3143580">,</span>&nbsp;<span class="ident" id="3143582">f</span><span class="op" id="3143583">.</span><span class="ident" id="3143584">Index</span><span class="op" id="3143589">,</span>&nbsp;<span class="ident" id="3143591">indir</span><span class="op" id="3143596">}</span><span class="op" id="3143597">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143602">wireFieldNum</span><span class="op" id="3143614">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3143619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143623">if</span>&nbsp;<span class="ident" id="3143626">srt</span><span class="op" id="3143629">.</span><span class="ident" id="3143630">NumField</span><span class="op" id="3143638">(</span><span class="op" id="3143639">)</span>&nbsp;<span class="op" id="3143641">&gt;</span>&nbsp;<span class="num" id="3143643">0</span>&nbsp;<span class="op" id="3143645">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3143648">len</span><span class="op" id="3143651">(</span><span class="ident" id="3143652">engine</span><span class="op" id="3143658">.</span><span class="ident" id="3143659">instr</span><span class="op" id="3143664">)</span>&nbsp;<span class="op" id="3143666">==</span>&nbsp;<span class="num" id="3143669">0</span>&nbsp;<span class="op" id="3143671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143676">errorf</span><span class="op" id="3143682">(</span><span class="string" id="3143683">&#34;type&nbsp;%s&nbsp;has&nbsp;no&nbsp;exported&nbsp;fields&#34;</span><span class="op" id="3143715">,</span>&nbsp;<span class="ident" id="3143717">rt</span><span class="op" id="3143719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3143723">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143727">engine</span><span class="op" id="3143733">.</span><span class="ident" id="3143734">instr</span>&nbsp;<span class="op" id="3143740">=</span>&nbsp;<span class="builtinfunc" id="3143742">append</span><span class="op" id="3143748">(</span><span class="ident" id="3143749">engine</span><span class="op" id="3143755">.</span><span class="ident" id="3143756">instr</span><span class="op" id="3143761">,</span>&nbsp;<span class="ident" id="3143763">encInstr</span><span class="op" id="3143771">{</span><span class="ident" id="3143772">encStructTerminator</span><span class="op" id="3143791">,</span>&nbsp;<span class="num" id="3143793">0</span><span class="op" id="3143794">,</span>&nbsp;<span class="ident" id="3143796">nil</span><span class="op" id="3143799">,</span>&nbsp;<span class="num" id="3143801">0</span><span class="op" id="3143802">}</span><span class="op" id="3143803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3143806">}</span>&nbsp;<span class="keyword" id="3143808">else</span>&nbsp;<span class="op" id="3143813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143817">engine</span><span class="op" id="3143823">.</span><span class="ident" id="3143824">instr</span>&nbsp;<span class="op" id="3143830">=</span>&nbsp;<span class="builtinfunc" id="3143832">make</span><span class="op" id="3143836">(</span><span class="op" id="3143837">[</span><span class="op" id="3143838">]</span><span class="ident" id="3143839">encInstr</span><span class="op" id="3143847">,</span>&nbsp;<span class="num" id="3143849">1</span><span class="op" id="3143850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143854">op</span><span class="op" id="3143856">,</span>&nbsp;<span class="ident" id="3143858">indir</span>&nbsp;<span class="op" id="3143864">:=</span>&nbsp;<span class="ident" id="3143867">encOpFor</span><span class="op" id="3143875">(</span><span class="ident" id="3143876">rt</span><span class="op" id="3143878">,</span>&nbsp;<span class="ident" id="3143880">seen</span><span class="op" id="3143884">,</span>&nbsp;<span class="ident" id="3143886">building</span><span class="op" id="3143894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3143898">engine</span><span class="op" id="3143904">.</span><span class="ident" id="3143905">instr</span><span class="op" id="3143910">[</span><span class="num" id="3143911">0</span><span class="op" id="3143912">]</span>&nbsp;<span class="op" id="3143914">=</span>&nbsp;<span class="ident" id="3143916">encInstr</span><span class="op" id="3143924">{</span><span class="op" id="3143925">*</span><span class="ident" id="3143926">op</span><span class="op" id="3143928">,</span>&nbsp;<span class="ident" id="3143930">singletonField</span><span class="op" id="3143944">,</span>&nbsp;<span class="ident" id="3143946">nil</span><span class="op" id="3143949">,</span>&nbsp;<span class="ident" id="3143951">indir</span><span class="op" id="3143956">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3143959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3143962">return</span>&nbsp;<span class="ident" id="3143969">engine</span><br>
<span class="lineno"></span><span class="op" id="3143976">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3143979">//&nbsp;getEncEngine&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno">650</span><span class="keyword" id="3144035">func</span>&nbsp;<span class="ident" id="3144040">getEncEngine</span><span class="op" id="3144052">(</span><span class="ident" id="3144053">ut</span>&nbsp;<span class="op" id="3144056">*</span><span class="ident" id="3144057">userTypeInfo</span><span class="op" id="3144069">,</span>&nbsp;<span class="ident" id="3144071">building</span>&nbsp;<span class="keyword" id="3144080">map</span><span class="op" id="3144083">[</span><span class="op" id="3144084">*</span><span class="ident" id="3144085">typeInfo</span><span class="op" id="3144093">]</span><span class="builtintype" id="3144094">bool</span><span class="op" id="3144098">)</span>&nbsp;<span class="op" id="3144100">*</span><span class="ident" id="3144101">encEngine</span>&nbsp;<span class="op" id="3144111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144114">info</span><span class="op" id="3144118">,</span>&nbsp;<span class="ident" id="3144120">err</span>&nbsp;<span class="op" id="3144124">:=</span>&nbsp;<span class="ident" id="3144127">getTypeInfo</span><span class="op" id="3144138">(</span><span class="ident" id="3144139">ut</span><span class="op" id="3144141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144144">if</span>&nbsp;<span class="ident" id="3144147">err</span>&nbsp;<span class="op" id="3144151">!=</span>&nbsp;<span class="ident" id="3144154">nil</span>&nbsp;<span class="op" id="3144158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144162">error_</span><span class="op" id="3144168">(</span><span class="ident" id="3144169">err</span><span class="op" id="3144172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3144175">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144178">enc</span><span class="op" id="3144181">,</span>&nbsp;<span class="ident" id="3144183">ok</span>&nbsp;<span class="op" id="3144186">:=</span>&nbsp;<span class="ident" id="3144189">info</span><span class="op" id="3144193">.</span><span class="ident" id="3144194">encoder</span><span class="op" id="3144201">.</span><span class="ident" id="3144202">Load</span><span class="op" id="3144206">(</span><span class="op" id="3144207">)</span><span class="op" id="3144208">.</span><span class="op" id="3144209">(</span><span class="op" id="3144210">*</span><span class="ident" id="3144211">encEngine</span><span class="op" id="3144220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144223">if</span>&nbsp;<span class="op" id="3144226">!</span><span class="ident" id="3144227">ok</span>&nbsp;<span class="op" id="3144230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144234">enc</span>&nbsp;<span class="op" id="3144238">=</span>&nbsp;<span class="ident" id="3144240">buildEncEngine</span><span class="op" id="3144254">(</span><span class="ident" id="3144255">info</span><span class="op" id="3144259">,</span>&nbsp;<span class="ident" id="3144261">ut</span><span class="op" id="3144263">,</span>&nbsp;<span class="ident" id="3144265">building</span><span class="op" id="3144273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3144276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144279">return</span>&nbsp;<span class="ident" id="3144286">enc</span><br>
<span class="lineno">660</span><span class="op" id="3144290">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3144293">func</span>&nbsp;<span class="ident" id="3144298">buildEncEngine</span><span class="op" id="3144312">(</span><span class="ident" id="3144313">info</span>&nbsp;<span class="op" id="3144318">*</span><span class="ident" id="3144319">typeInfo</span><span class="op" id="3144327">,</span>&nbsp;<span class="ident" id="3144329">ut</span>&nbsp;<span class="op" id="3144332">*</span><span class="ident" id="3144333">userTypeInfo</span><span class="op" id="3144345">,</span>&nbsp;<span class="ident" id="3144347">building</span>&nbsp;<span class="keyword" id="3144356">map</span><span class="op" id="3144359">[</span><span class="op" id="3144360">*</span><span class="ident" id="3144361">typeInfo</span><span class="op" id="3144369">]</span><span class="builtintype" id="3144370">bool</span><span class="op" id="3144374">)</span>&nbsp;<span class="op" id="3144376">*</span><span class="ident" id="3144377">encEngine</span>&nbsp;<span class="op" id="3144387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3144390">//&nbsp;Check&nbsp;for&nbsp;recursive&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144421">if</span>&nbsp;<span class="ident" id="3144424">building</span>&nbsp;<span class="op" id="3144433">!=</span>&nbsp;<span class="ident" id="3144436">nil</span>&nbsp;<span class="op" id="3144440">&amp;&amp;</span>&nbsp;<span class="ident" id="3144443">building</span><span class="op" id="3144451">[</span><span class="ident" id="3144452">info</span><span class="op" id="3144456">]</span>&nbsp;<span class="op" id="3144458">{</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144462">return</span>&nbsp;<span class="ident" id="3144469">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3144474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144477">info</span><span class="op" id="3144481">.</span><span class="ident" id="3144482">encInit</span><span class="op" id="3144489">.</span><span class="ident" id="3144490">Lock</span><span class="op" id="3144494">(</span><span class="op" id="3144495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144498">defer</span>&nbsp;<span class="ident" id="3144504">info</span><span class="op" id="3144508">.</span><span class="ident" id="3144509">encInit</span><span class="op" id="3144516">.</span><span class="ident" id="3144517">Unlock</span><span class="op" id="3144523">(</span><span class="op" id="3144524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144527">enc</span><span class="op" id="3144530">,</span>&nbsp;<span class="ident" id="3144532">ok</span>&nbsp;<span class="op" id="3144535">:=</span>&nbsp;<span class="ident" id="3144538">info</span><span class="op" id="3144542">.</span><span class="ident" id="3144543">encoder</span><span class="op" id="3144550">.</span><span class="ident" id="3144551">Load</span><span class="op" id="3144555">(</span><span class="op" id="3144556">)</span><span class="op" id="3144557">.</span><span class="op" id="3144558">(</span><span class="op" id="3144559">*</span><span class="ident" id="3144560">encEngine</span><span class="op" id="3144569">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144572">if</span>&nbsp;<span class="op" id="3144575">!</span><span class="ident" id="3144576">ok</span>&nbsp;<span class="op" id="3144579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144583">if</span>&nbsp;<span class="ident" id="3144586">building</span>&nbsp;<span class="op" id="3144595">==</span>&nbsp;<span class="ident" id="3144598">nil</span>&nbsp;<span class="op" id="3144602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144607">building</span>&nbsp;<span class="op" id="3144616">=</span>&nbsp;<span class="builtinfunc" id="3144618">make</span><span class="op" id="3144622">(</span><span class="keyword" id="3144623">map</span><span class="op" id="3144626">[</span><span class="op" id="3144627">*</span><span class="ident" id="3144628">typeInfo</span><span class="op" id="3144636">]</span><span class="builtintype" id="3144637">bool</span><span class="op" id="3144641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3144645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144649">building</span><span class="op" id="3144657">[</span><span class="ident" id="3144658">info</span><span class="op" id="3144662">]</span>&nbsp;<span class="op" id="3144664">=</span>&nbsp;<span class="builtintype" id="3144666">true</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144673">enc</span>&nbsp;<span class="op" id="3144677">=</span>&nbsp;<span class="ident" id="3144679">compileEnc</span><span class="op" id="3144689">(</span><span class="ident" id="3144690">ut</span><span class="op" id="3144692">,</span>&nbsp;<span class="ident" id="3144694">building</span><span class="op" id="3144702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144706">info</span><span class="op" id="3144710">.</span><span class="ident" id="3144711">encoder</span><span class="op" id="3144718">.</span><span class="ident" id="3144719">Store</span><span class="op" id="3144724">(</span><span class="ident" id="3144725">enc</span><span class="op" id="3144728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3144731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144734">return</span>&nbsp;<span class="ident" id="3144741">enc</span><br>
<span class="lineno"></span><span class="op" id="3144745">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="3144748">func</span>&nbsp;<span class="op" id="3144753">(</span><span class="ident" id="3144754">enc</span>&nbsp;<span class="op" id="3144758">*</span><span class="ident" id="3144759">Encoder</span><span class="op" id="3144766">)</span>&nbsp;<span class="ident" id="3144768">encode</span><span class="op" id="3144774">(</span><span class="ident" id="3144775">b</span>&nbsp;<span class="op" id="3144777">*</span><span class="ident" id="3144778">encBuffer</span><span class="op" id="3144787">,</span>&nbsp;<span class="ident" id="3144789">value</span>&nbsp;<span class="ident" id="3144795">reflect</span><span class="op" id="3144802">.</span><span class="ident" id="3144803">Value</span><span class="op" id="3144808">,</span>&nbsp;<span class="ident" id="3144810">ut</span>&nbsp;<span class="op" id="3144813">*</span><span class="ident" id="3144814">userTypeInfo</span><span class="op" id="3144826">)</span>&nbsp;<span class="op" id="3144828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144831">defer</span>&nbsp;<span class="ident" id="3144837">catchError</span><span class="op" id="3144847">(</span><span class="op" id="3144848">&amp;</span><span class="ident" id="3144849">enc</span><span class="op" id="3144852">.</span><span class="ident" id="3144853">err</span><span class="op" id="3144856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144859">engine</span>&nbsp;<span class="op" id="3144866">:=</span>&nbsp;<span class="ident" id="3144869">getEncEngine</span><span class="op" id="3144881">(</span><span class="ident" id="3144882">ut</span><span class="op" id="3144884">,</span>&nbsp;<span class="ident" id="3144886">nil</span><span class="op" id="3144889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144892">indir</span>&nbsp;<span class="op" id="3144898">:=</span>&nbsp;<span class="ident" id="3144901">ut</span><span class="op" id="3144903">.</span><span class="ident" id="3144904">indir</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144911">if</span>&nbsp;<span class="ident" id="3144914">ut</span><span class="op" id="3144916">.</span><span class="ident" id="3144917">externalEnc</span>&nbsp;<span class="op" id="3144929">!=</span>&nbsp;<span class="num" id="3144932">0</span>&nbsp;<span class="op" id="3144934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144938">indir</span>&nbsp;<span class="op" id="3144944">=</span>&nbsp;<span class="builtintype" id="3144946">int</span><span class="op" id="3144949">(</span><span class="ident" id="3144950">ut</span><span class="op" id="3144952">.</span><span class="ident" id="3144953">encIndir</span><span class="op" id="3144961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3144964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3144967">for</span>&nbsp;<span class="ident" id="3144971">i</span>&nbsp;<span class="op" id="3144973">:=</span>&nbsp;<span class="num" id="3144976">0</span><span class="op" id="3144977">;</span>&nbsp;<span class="ident" id="3144979">i</span>&nbsp;<span class="op" id="3144981">&lt;</span>&nbsp;<span class="ident" id="3144983">indir</span><span class="op" id="3144988">;</span>&nbsp;<span class="ident" id="3144990">i</span><span class="op" id="3144991">++</span>&nbsp;<span class="op" id="3144994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3144998">value</span>&nbsp;<span class="op" id="3145004">=</span>&nbsp;<span class="ident" id="3145006">reflect</span><span class="op" id="3145013">.</span><span class="ident" id="3145014">Indirect</span><span class="op" id="3145022">(</span><span class="ident" id="3145023">value</span><span class="op" id="3145028">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3145031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3145034">if</span>&nbsp;<span class="ident" id="3145037">ut</span><span class="op" id="3145039">.</span><span class="ident" id="3145040">externalEnc</span>&nbsp;<span class="op" id="3145052">==</span>&nbsp;<span class="num" id="3145055">0</span>&nbsp;<span class="op" id="3145057">&amp;&amp;</span>&nbsp;<span class="ident" id="3145060">value</span><span class="op" id="3145065">.</span><span class="ident" id="3145066">Type</span><span class="op" id="3145070">(</span><span class="op" id="3145071">)</span><span class="op" id="3145072">.</span><span class="ident" id="3145073">Kind</span><span class="op" id="3145077">(</span><span class="op" id="3145078">)</span>&nbsp;<span class="op" id="3145080">==</span>&nbsp;<span class="ident" id="3145083">reflect</span><span class="op" id="3145090">.</span><span class="ident" id="3145091">Struct</span>&nbsp;<span class="op" id="3145098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3145102">enc</span><span class="op" id="3145105">.</span><span class="ident" id="3145106">encodeStruct</span><span class="op" id="3145118">(</span><span class="ident" id="3145119">b</span><span class="op" id="3145120">,</span>&nbsp;<span class="ident" id="3145122">engine</span><span class="op" id="3145128">,</span>&nbsp;<span class="ident" id="3145130">value</span><span class="op" id="3145135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3145138">}</span>&nbsp;<span class="keyword" id="3145140">else</span>&nbsp;<span class="op" id="3145145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3145149">enc</span><span class="op" id="3145152">.</span><span class="ident" id="3145153">encodeSingle</span><span class="op" id="3145165">(</span><span class="ident" id="3145166">b</span><span class="op" id="3145167">,</span>&nbsp;<span class="ident" id="3145169">engine</span><span class="op" id="3145175">,</span>&nbsp;<span class="ident" id="3145177">value</span><span class="op" id="3145182">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3145185">}</span><br>
<span class="lineno"></span><span class="op" id="3145187">}</span>
</div>
</body>
</html>
