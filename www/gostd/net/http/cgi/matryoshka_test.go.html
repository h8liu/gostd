<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html" class="current">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8521951">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8522006">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8522060">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8522111">//&nbsp;Tests&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;program&nbsp;running&nbsp;under&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;host&nbsp;process.</span><br>
<span class="lineno"></span><span class="comment" id="8522174">//&nbsp;Further,&nbsp;the&nbsp;two&nbsp;programs&nbsp;are&nbsp;the&nbsp;same&nbsp;binary,&nbsp;just&nbsp;checking</span><br>
<span class="lineno"></span><span class="comment" id="8522238">//&nbsp;their&nbsp;environment&nbsp;to&nbsp;figure&nbsp;out&nbsp;what&nbsp;mode&nbsp;to&nbsp;run&nbsp;in.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8522295">package</span>&nbsp;<span class="ident" id="8522303">cgi</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="8522308">import</span>&nbsp;<span class="op" id="8522315">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8522318">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8522327">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8522337">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8522344">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8522350">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8522362">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8522383">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8522389">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8522400">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8522411">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8522418">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8522421">//&nbsp;This&nbsp;test&nbsp;is&nbsp;a&nbsp;CGI&nbsp;host&nbsp;(testing&nbsp;host.go)&nbsp;that&nbsp;runs&nbsp;its&nbsp;own&nbsp;binary</span><br>
<span class="lineno">25</span><span class="comment" id="8522491">//&nbsp;as&nbsp;a&nbsp;child&nbsp;process&nbsp;testing&nbsp;the&nbsp;other&nbsp;half&nbsp;of&nbsp;CGI&nbsp;(child.go).</span><br>
<span class="lineno"></span><span class="keyword" id="8522555">func</span>&nbsp;<span class="ident" id="8522560">TestHostingOurselves</span><span class="op" id="8522580">(</span><span class="ident" id="8522581">t</span>&nbsp;<span class="op" id="8522583">*</span><span class="ident" id="8522584">testing</span><span class="op" id="8522591">.</span><span class="ident" id="8522592">T</span><span class="op" id="8522593">)</span>&nbsp;<span class="op" id="8522595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8522598">if</span>&nbsp;<span class="ident" id="8522601">runtime</span><span class="op" id="8522608">.</span><span class="ident" id="8522609">GOOS</span>&nbsp;<span class="op" id="8522614">==</span>&nbsp;<span class="string" id="8522617">&#34;nacl&#34;</span>&nbsp;<span class="op" id="8522624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522628">t</span><span class="op" id="8522629">.</span><span class="ident" id="8522630">Skip</span><span class="op" id="8522634">(</span><span class="string" id="8522635">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="8522653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8522656">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522660">h</span>&nbsp;<span class="op" id="8522662">:=</span>&nbsp;<span class="op" id="8522665">&amp;</span><span class="ident" id="8522666">Handler</span><span class="op" id="8522673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522677">Path</span><span class="op" id="8522681">:</span>&nbsp;<span class="ident" id="8522683">os</span><span class="op" id="8522685">.</span><span class="ident" id="8522686">Args</span><span class="op" id="8522690">[</span><span class="num" id="8522691">0</span><span class="op" id="8522692">]</span><span class="op" id="8522693">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522697">Root</span><span class="op" id="8522701">:</span>&nbsp;<span class="string" id="8522703">&#34;/test.go&#34;</span><span class="op" id="8522713">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522717">Args</span><span class="op" id="8522721">:</span>&nbsp;<span class="op" id="8522723">[</span><span class="op" id="8522724">]</span><span class="builtintype" id="8522725">string</span><span class="op" id="8522731">{</span><span class="string" id="8522732">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="8522765">}</span><span class="op" id="8522766">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8522769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8522772">expectedMap</span>&nbsp;<span class="op" id="8522784">:=</span>&nbsp;<span class="keyword" id="8522787">map</span><span class="op" id="8522790">[</span><span class="builtintype" id="8522791">string</span><span class="op" id="8522797">]</span><span class="builtintype" id="8522798">string</span><span class="op" id="8522804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8522808">&#34;test&#34;</span><span class="op" id="8522814">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8522833">&#34;Hello&nbsp;CGI-in-CGI&#34;</span><span class="op" id="8522851">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8522855">&#34;param-a&#34;</span><span class="op" id="8522864">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8522880">&#34;b&#34;</span><span class="op" id="8522883">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8522887">&#34;param-foo&#34;</span><span class="op" id="8522898">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8522912">&#34;bar&#34;</span><span class="op" id="8522917">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8522921">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="8522944">:</span>&nbsp;<span class="string" id="8522946">&#34;CGI/1.1&#34;</span><span class="op" id="8522955">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8522959">&#34;env-HTTP_HOST&#34;</span><span class="op" id="8522974">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8522984">&#34;example.com&#34;</span><span class="op" id="8522997">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8523001">&#34;env-PATH_INFO&#34;</span><span class="op" id="8523016">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8523026">&#34;&#34;</span><span class="op" id="8523028">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8523032">&#34;env-QUERY_STRING&#34;</span><span class="op" id="8523050">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8523057">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="8523070">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8523074">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="8523091">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8523099">&#34;1.2.3.4&#34;</span><span class="op" id="8523108">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8523112">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="8523129">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8523137">&#34;1.2.3.4&#34;</span><span class="op" id="8523146">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8523150">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="8523170">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8523175">&#34;GET&#34;</span><span class="op" id="8523180">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8523184">&#34;env-REQUEST_URI&#34;</span><span class="op" id="8523201">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8523209">&#34;/test.go?foo=bar&amp;a=b&#34;</span><span class="op" id="8523231">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8523235">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="8523256">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="8523260">os</span><span class="op" id="8523262">.</span><span class="ident" id="8523263">Args</span><span class="op" id="8523267">[</span><span class="num" id="8523268">0</span><span class="op" id="8523269">]</span><span class="op" id="8523270">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8523274">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="8523291">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8523299">&#34;/test.go&#34;</span><span class="op" id="8523309">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8523313">&#34;env-SERVER_NAME&#34;</span><span class="op" id="8523330">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8523338">&#34;example.com&#34;</span><span class="op" id="8523351">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8523355">&#34;env-SERVER_PORT&#34;</span><span class="op" id="8523372">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8523380">&#34;80&#34;</span><span class="op" id="8523384">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8523388">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="8523409">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="8523413">&#34;go&#34;</span><span class="op" id="8523417">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8523420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8523423">replay</span>&nbsp;<span class="op" id="8523430">:=</span>&nbsp;<span class="ident" id="8523433">runCgiTest</span><span class="op" id="8523443">(</span><span class="ident" id="8523444">t</span><span class="op" id="8523445">,</span>&nbsp;<span class="ident" id="8523447">h</span><span class="op" id="8523448">,</span>&nbsp;<span class="string" id="8523450">&#34;GET&nbsp;/test.go?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8523508">,</span>&nbsp;<span class="ident" id="8523510">expectedMap</span><span class="op" id="8523521">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8523525">if</span>&nbsp;<span class="ident" id="8523528">expected</span><span class="op" id="8523536">,</span>&nbsp;<span class="ident" id="8523538">got</span>&nbsp;<span class="op" id="8523542">:=</span>&nbsp;<span class="string" id="8523545">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="8523571">,</span>&nbsp;<span class="ident" id="8523573">replay</span><span class="op" id="8523579">.</span><span class="ident" id="8523580">Header</span><span class="op" id="8523586">(</span><span class="op" id="8523587">)</span><span class="op" id="8523588">.</span><span class="ident" id="8523589">Get</span><span class="op" id="8523592">(</span><span class="string" id="8523593">&#34;Content-Type&#34;</span><span class="op" id="8523607">)</span><span class="op" id="8523608">;</span>&nbsp;<span class="ident" id="8523610">got</span>&nbsp;<span class="op" id="8523614">!=</span>&nbsp;<span class="ident" id="8523617">expected</span>&nbsp;<span class="op" id="8523626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8523630">t</span><span class="op" id="8523631">.</span><span class="ident" id="8523632">Errorf</span><span class="op" id="8523638">(</span><span class="string" id="8523639">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8523678">,</span>&nbsp;<span class="ident" id="8523680">got</span><span class="op" id="8523683">,</span>&nbsp;<span class="ident" id="8523685">expected</span><span class="op" id="8523693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8523696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8523699">if</span>&nbsp;<span class="ident" id="8523702">expected</span><span class="op" id="8523710">,</span>&nbsp;<span class="ident" id="8523712">got</span>&nbsp;<span class="op" id="8523716">:=</span>&nbsp;<span class="string" id="8523719">&#34;X-Test-Value&#34;</span><span class="op" id="8523733">,</span>&nbsp;<span class="ident" id="8523735">replay</span><span class="op" id="8523741">.</span><span class="ident" id="8523742">Header</span><span class="op" id="8523748">(</span><span class="op" id="8523749">)</span><span class="op" id="8523750">.</span><span class="ident" id="8523751">Get</span><span class="op" id="8523754">(</span><span class="string" id="8523755">&#34;X-Test-Header&#34;</span><span class="op" id="8523770">)</span><span class="op" id="8523771">;</span>&nbsp;<span class="ident" id="8523773">got</span>&nbsp;<span class="op" id="8523777">!=</span>&nbsp;<span class="ident" id="8523780">expected</span>&nbsp;<span class="op" id="8523789">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8523793">t</span><span class="op" id="8523794">.</span><span class="ident" id="8523795">Errorf</span><span class="op" id="8523801">(</span><span class="string" id="8523802">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8523842">,</span>&nbsp;<span class="ident" id="8523844">got</span><span class="op" id="8523847">,</span>&nbsp;<span class="ident" id="8523849">expected</span><span class="op" id="8523857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8523860">}</span><br>
<span class="lineno"></span><span class="op" id="8523862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8523865">type</span>&nbsp;<span class="ident" id="8523870">customWriterRecorder</span>&nbsp;<span class="keyword" id="8523891">struct</span>&nbsp;<span class="op" id="8523898">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8523901">w</span>&nbsp;<span class="ident" id="8523903">io</span><span class="op" id="8523905">.</span><span class="ident" id="8523906">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8523914">*</span><span class="ident" id="8523915">httptest</span><span class="op" id="8523923">.</span><span class="ident" id="8523924">ResponseRecorder</span><br>
<span class="lineno"></span><span class="op" id="8523941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8523944">func</span>&nbsp;<span class="op" id="8523949">(</span><span class="ident" id="8523950">r</span>&nbsp;<span class="op" id="8523952">*</span><span class="ident" id="8523953">customWriterRecorder</span><span class="op" id="8523973">)</span>&nbsp;<span class="ident" id="8523975">Write</span><span class="op" id="8523980">(</span><span class="ident" id="8523981">p</span>&nbsp;<span class="op" id="8523983">[</span><span class="op" id="8523984">]</span><span class="builtintype" id="8523985">byte</span><span class="op" id="8523989">)</span>&nbsp;<span class="op" id="8523991">(</span><span class="ident" id="8523992">n</span>&nbsp;<span class="builtintype" id="8523994">int</span><span class="op" id="8523997">,</span>&nbsp;<span class="ident" id="8523999">err</span>&nbsp;<span class="builtintype" id="8524003">error</span><span class="op" id="8524008">)</span>&nbsp;<span class="op" id="8524010">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8524013">return</span>&nbsp;<span class="ident" id="8524020">r</span><span class="op" id="8524021">.</span><span class="ident" id="8524022">w</span><span class="op" id="8524023">.</span><span class="ident" id="8524024">Write</span><span class="op" id="8524029">(</span><span class="ident" id="8524030">p</span><span class="op" id="8524031">)</span><br>
<span class="lineno"></span><span class="op" id="8524033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8524036">type</span>&nbsp;<span class="ident" id="8524041">limitWriter</span>&nbsp;<span class="keyword" id="8524053">struct</span>&nbsp;<span class="op" id="8524060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8524063">w</span>&nbsp;<span class="ident" id="8524065">io</span><span class="op" id="8524067">.</span><span class="ident" id="8524068">Writer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8524076">n</span>&nbsp;<span class="builtintype" id="8524078">int</span><br>
<span class="lineno"></span><span class="op" id="8524082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8524085">func</span>&nbsp;<span class="op" id="8524090">(</span><span class="ident" id="8524091">w</span>&nbsp;<span class="op" id="8524093">*</span><span class="ident" id="8524094">limitWriter</span><span class="op" id="8524105">)</span>&nbsp;<span class="ident" id="8524107">Write</span><span class="op" id="8524112">(</span><span class="ident" id="8524113">p</span>&nbsp;<span class="op" id="8524115">[</span><span class="op" id="8524116">]</span><span class="builtintype" id="8524117">byte</span><span class="op" id="8524121">)</span>&nbsp;<span class="op" id="8524123">(</span><span class="ident" id="8524124">n</span>&nbsp;<span class="builtintype" id="8524126">int</span><span class="op" id="8524129">,</span>&nbsp;<span class="ident" id="8524131">err</span>&nbsp;<span class="builtintype" id="8524135">error</span><span class="op" id="8524140">)</span>&nbsp;<span class="op" id="8524142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8524145">if</span>&nbsp;<span class="builtinfunc" id="8524148">len</span><span class="op" id="8524151">(</span><span class="ident" id="8524152">p</span><span class="op" id="8524153">)</span>&nbsp;<span class="op" id="8524155">&gt;</span>&nbsp;<span class="ident" id="8524157">w</span><span class="op" id="8524158">.</span><span class="ident" id="8524159">n</span>&nbsp;<span class="op" id="8524161">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8524165">p</span>&nbsp;<span class="op" id="8524167">=</span>&nbsp;<span class="ident" id="8524169">p</span><span class="op" id="8524170">[</span><span class="op" id="8524171">:</span><span class="ident" id="8524172">w</span><span class="op" id="8524173">.</span><span class="ident" id="8524174">n</span><span class="op" id="8524175">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8524178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8524181">if</span>&nbsp;<span class="builtinfunc" id="8524184">len</span><span class="op" id="8524187">(</span><span class="ident" id="8524188">p</span><span class="op" id="8524189">)</span>&nbsp;<span class="op" id="8524191">&gt;</span>&nbsp;<span class="num" id="8524193">0</span>&nbsp;<span class="op" id="8524195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8524199">n</span><span class="op" id="8524200">,</span>&nbsp;<span class="ident" id="8524202">err</span>&nbsp;<span class="op" id="8524206">=</span>&nbsp;<span class="ident" id="8524208">w</span><span class="op" id="8524209">.</span><span class="ident" id="8524210">w</span><span class="op" id="8524211">.</span><span class="ident" id="8524212">Write</span><span class="op" id="8524217">(</span><span class="ident" id="8524218">p</span><span class="op" id="8524219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8524223">w</span><span class="op" id="8524224">.</span><span class="ident" id="8524225">n</span>&nbsp;<span class="op" id="8524227">-=</span>&nbsp;<span class="ident" id="8524230">n</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8524233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8524236">if</span>&nbsp;<span class="ident" id="8524239">w</span><span class="op" id="8524240">.</span><span class="ident" id="8524241">n</span>&nbsp;<span class="op" id="8524243">==</span>&nbsp;<span class="num" id="8524246">0</span>&nbsp;<span class="op" id="8524248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8524252">err</span>&nbsp;<span class="op" id="8524256">=</span>&nbsp;<span class="ident" id="8524258">errors</span><span class="op" id="8524264">.</span><span class="ident" id="8524265">New</span><span class="op" id="8524268">(</span><span class="string" id="8524269">&#34;past&nbsp;write&nbsp;limit&#34;</span><span class="op" id="8524287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8524290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8524293">return</span><br>
<span class="lineno">90</span><span class="op" id="8524300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8524303">//&nbsp;If&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying&nbsp;the&nbsp;child&#39;s&nbsp;output&nbsp;to&nbsp;the&nbsp;parent,&nbsp;test</span><br>
<span class="lineno"></span><span class="comment" id="8524373">//&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;child.</span><br>
<span class="lineno"></span><span class="keyword" id="8524400">func</span>&nbsp;<span class="ident" id="8524405">TestKillChildAfterCopyError</span><span class="op" id="8524432">(</span><span class="ident" id="8524433">t</span>&nbsp;<span class="op" id="8524435">*</span><span class="ident" id="8524436">testing</span><span class="op" id="8524443">.</span><span class="ident" id="8524444">T</span><span class="op" id="8524445">)</span>&nbsp;<span class="op" id="8524447">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8524450">if</span>&nbsp;<span class="ident" id="8524453">runtime</span><span class="op" id="8524460">.</span><span class="ident" id="8524461">GOOS</span>&nbsp;<span class="op" id="8524466">==</span>&nbsp;<span class="string" id="8524469">&#34;nacl&#34;</span>&nbsp;<span class="op" id="8524476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8524480">t</span><span class="op" id="8524481">.</span><span class="ident" id="8524482">Skip</span><span class="op" id="8524486">(</span><span class="string" id="8524487">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="8524505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8524508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8524512">defer</span>&nbsp;<span class="keyword" id="8524518">func</span><span class="op" id="8524522">(</span><span class="op" id="8524523">)</span>&nbsp;<span class="op" id="8524525">{</span>&nbsp;<span class="ident" id="8524527">testHookStartProcess</span>&nbsp;<span class="op" id="8524548">=</span>&nbsp;<span class="ident" id="8524550">nil</span>&nbsp;<span class="op" id="8524554">}</span><span class="op" id="8524555">(</span><span class="op" id="8524556">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8524559">proc</span>&nbsp;<span class="op" id="8524564">:=</span>&nbsp;<span class="builtinfunc" id="8524567">make</span><span class="op" id="8524571">(</span><span class="keyword" id="8524572">chan</span>&nbsp;<span class="op" id="8524577">*</span><span class="ident" id="8524578">os</span><span class="op" id="8524580">.</span><span class="ident" id="8524581">Process</span><span class="op" id="8524588">,</span>&nbsp;<span class="num" id="8524590">1</span><span class="op" id="8524591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8524594">testHookStartProcess</span>&nbsp;<span class="op" id="8524615">=</span>&nbsp;<span class="keyword" id="8524617">func</span><span class="op" id="8524621">(</span><span class="ident" id="8524622">p</span>&nbsp;<span class="op" id="8524624">*</span><span class="ident" id="8524625">os</span><span class="op" id="8524627">.</span><span class="ident" id="8524628">Process</span><span class="op" id="8524635">)</span>&nbsp;<span class="op" id="8524637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8524641">proc</span>&nbsp;<span class="op" id="8524646">&lt;-</span>&nbsp;<span class="ident" id="8524649">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8524652">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8524656">h</span>&nbsp;<span class="op" id="8524658">:=</span>&nbsp;<span class="op" id="8524661">&amp;</span><span class="ident" id="8524662">Handler</span><span class="op" id="8524669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8524673">Path</span><span class="op" id="8524677">:</span>&nbsp;<span class="ident" id="8524679">os</span><span class="op" id="8524681">.</span><span class="ident" id="8524682">Args</span><span class="op" id="8524686">[</span><span class="num" id="8524687">0</span><span class="op" id="8524688">]</span><span class="op" id="8524689">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8524693">Root</span><span class="op" id="8524697">:</span>&nbsp;<span class="string" id="8524699">&#34;/test.go&#34;</span><span class="op" id="8524709">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8524713">Args</span><span class="op" id="8524717">:</span>&nbsp;<span class="op" id="8524719">[</span><span class="op" id="8524720">]</span><span class="builtintype" id="8524721">string</span><span class="op" id="8524727">{</span><span class="string" id="8524728">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="8524761">}</span><span class="op" id="8524762">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8524765">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8524768">req</span><span class="op" id="8524771">,</span>&nbsp;<span class="ident" id="8524773">_</span>&nbsp;<span class="op" id="8524775">:=</span>&nbsp;<span class="ident" id="8524778">http</span><span class="op" id="8524782">.</span><span class="ident" id="8524783">NewRequest</span><span class="op" id="8524793">(</span><span class="string" id="8524794">&#34;GET&#34;</span><span class="op" id="8524799">,</span>&nbsp;<span class="string" id="8524801">&#34;http://example.com/test.cgi?write-forever=1&#34;</span><span class="op" id="8524846">,</span>&nbsp;<span class="ident" id="8524848">nil</span><span class="op" id="8524851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8524854">rec</span>&nbsp;<span class="op" id="8524858">:=</span>&nbsp;<span class="ident" id="8524861">httptest</span><span class="op" id="8524869">.</span><span class="ident" id="8524870">NewRecorder</span><span class="op" id="8524881">(</span><span class="op" id="8524882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8524885">var</span>&nbsp;<span class="ident" id="8524889">out</span>&nbsp;<span class="ident" id="8524893">bytes</span><span class="op" id="8524898">.</span><span class="ident" id="8524899">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8524907">const</span>&nbsp;<span class="ident" id="8524913">writeLen</span>&nbsp;<span class="op" id="8524922">=</span>&nbsp;<span class="num" id="8524924">50</span>&nbsp;<span class="op" id="8524927">&lt;&lt;</span>&nbsp;<span class="num" id="8524930">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8524934">rw</span>&nbsp;<span class="op" id="8524937">:=</span>&nbsp;<span class="op" id="8524940">&amp;</span><span class="ident" id="8524941">customWriterRecorder</span><span class="op" id="8524961">{</span><span class="op" id="8524962">&amp;</span><span class="ident" id="8524963">limitWriter</span><span class="op" id="8524974">{</span><span class="op" id="8524975">&amp;</span><span class="ident" id="8524976">out</span><span class="op" id="8524979">,</span>&nbsp;<span class="ident" id="8524981">writeLen</span><span class="op" id="8524989">}</span><span class="op" id="8524990">,</span>&nbsp;<span class="ident" id="8524992">rec</span><span class="op" id="8524995">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8524999">donec</span>&nbsp;<span class="op" id="8525005">:=</span>&nbsp;<span class="builtinfunc" id="8525008">make</span><span class="op" id="8525012">(</span><span class="keyword" id="8525013">chan</span>&nbsp;<span class="builtintype" id="8525018">bool</span><span class="op" id="8525022">,</span>&nbsp;<span class="num" id="8525024">1</span><span class="op" id="8525025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8525028">go</span>&nbsp;<span class="keyword" id="8525031">func</span><span class="op" id="8525035">(</span><span class="op" id="8525036">)</span>&nbsp;<span class="op" id="8525038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8525042">h</span><span class="op" id="8525043">.</span><span class="ident" id="8525044">ServeHTTP</span><span class="op" id="8525053">(</span><span class="ident" id="8525054">rw</span><span class="op" id="8525056">,</span>&nbsp;<span class="ident" id="8525058">req</span><span class="op" id="8525061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8525065">donec</span>&nbsp;<span class="op" id="8525071">&lt;-</span>&nbsp;<span class="builtintype" id="8525074">true</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8525080">}</span><span class="op" id="8525081">(</span><span class="op" id="8525082">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8525086">select</span>&nbsp;<span class="op" id="8525093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8525096">case</span>&nbsp;<span class="op" id="8525101">&lt;-</span><span class="ident" id="8525103">donec</span><span class="op" id="8525108">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8525112">if</span>&nbsp;<span class="ident" id="8525115">out</span><span class="op" id="8525118">.</span><span class="ident" id="8525119">Len</span><span class="op" id="8525122">(</span><span class="op" id="8525123">)</span>&nbsp;<span class="op" id="8525125">!=</span>&nbsp;<span class="ident" id="8525128">writeLen</span>&nbsp;<span class="op" id="8525137">||</span>&nbsp;<span class="ident" id="8525140">out</span><span class="op" id="8525143">.</span><span class="ident" id="8525144">Bytes</span><span class="op" id="8525149">(</span><span class="op" id="8525150">)</span><span class="op" id="8525151">[</span><span class="num" id="8525152">0</span><span class="op" id="8525153">]</span>&nbsp;<span class="op" id="8525155">!=</span>&nbsp;<span class="string" id="8525158">&#39;a&#39;</span>&nbsp;<span class="op" id="8525162">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8525167">t</span><span class="op" id="8525168">.</span><span class="ident" id="8525169">Errorf</span><span class="op" id="8525175">(</span><span class="string" id="8525176">&#34;unexpected&nbsp;output:&nbsp;%q&#34;</span><span class="op" id="8525199">,</span>&nbsp;<span class="ident" id="8525201">out</span><span class="op" id="8525204">.</span><span class="ident" id="8525205">Bytes</span><span class="op" id="8525210">(</span><span class="op" id="8525211">)</span><span class="op" id="8525212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8525216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8525219">case</span>&nbsp;<span class="op" id="8525224">&lt;-</span><span class="ident" id="8525226">time</span><span class="op" id="8525230">.</span><span class="ident" id="8525231">After</span><span class="op" id="8525236">(</span><span class="num" id="8525237">5</span>&nbsp;<span class="op" id="8525239">*</span>&nbsp;<span class="ident" id="8525241">time</span><span class="op" id="8525245">.</span><span class="ident" id="8525246">Second</span><span class="op" id="8525252">)</span><span class="op" id="8525253">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8525257">t</span><span class="op" id="8525258">.</span><span class="ident" id="8525259">Errorf</span><span class="op" id="8525265">(</span><span class="string" id="8525266">&#34;timeout.&nbsp;ServeHTTP&nbsp;hung&nbsp;and&nbsp;didn&#39;t&nbsp;kill&nbsp;the&nbsp;child&nbsp;process?&#34;</span><span class="op" id="8525326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8525330">select</span>&nbsp;<span class="op" id="8525337">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8525341">case</span>&nbsp;<span class="ident" id="8525346">p</span>&nbsp;<span class="op" id="8525348">:=</span>&nbsp;<span class="op" id="8525351">&lt;-</span><span class="ident" id="8525353">proc</span><span class="op" id="8525357">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8525362">p</span><span class="op" id="8525363">.</span><span class="ident" id="8525364">Kill</span><span class="op" id="8525368">(</span><span class="op" id="8525369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8525374">t</span><span class="op" id="8525375">.</span><span class="ident" id="8525376">Logf</span><span class="op" id="8525380">(</span><span class="string" id="8525381">&#34;killed&nbsp;process&#34;</span><span class="op" id="8525397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8525401">default</span><span class="op" id="8525408">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8525413">t</span><span class="op" id="8525414">.</span><span class="ident" id="8525415">Logf</span><span class="op" id="8525419">(</span><span class="string" id="8525420">&#34;didn&#39;t&nbsp;kill&nbsp;process&#34;</span><span class="op" id="8525441">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8525445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8525448">}</span><br>
<span class="lineno"></span><span class="op" id="8525450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8525453">//&nbsp;Test&nbsp;that&nbsp;a&nbsp;child&nbsp;handler&nbsp;writing&nbsp;only&nbsp;headers&nbsp;works.</span><br>
<span class="lineno">140</span><span class="comment" id="8525510">//&nbsp;golang.org/issue/7196</span><br>
<span class="lineno"></span><span class="keyword" id="8525535">func</span>&nbsp;<span class="ident" id="8525540">TestChildOnlyHeaders</span><span class="op" id="8525560">(</span><span class="ident" id="8525561">t</span>&nbsp;<span class="op" id="8525563">*</span><span class="ident" id="8525564">testing</span><span class="op" id="8525571">.</span><span class="ident" id="8525572">T</span><span class="op" id="8525573">)</span>&nbsp;<span class="op" id="8525575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8525578">if</span>&nbsp;<span class="ident" id="8525581">runtime</span><span class="op" id="8525588">.</span><span class="ident" id="8525589">GOOS</span>&nbsp;<span class="op" id="8525594">==</span>&nbsp;<span class="string" id="8525597">&#34;nacl&#34;</span>&nbsp;<span class="op" id="8525604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8525608">t</span><span class="op" id="8525609">.</span><span class="ident" id="8525610">Skip</span><span class="op" id="8525614">(</span><span class="string" id="8525615">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="8525633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8525636">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8525640">h</span>&nbsp;<span class="op" id="8525642">:=</span>&nbsp;<span class="op" id="8525645">&amp;</span><span class="ident" id="8525646">Handler</span><span class="op" id="8525653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8525657">Path</span><span class="op" id="8525661">:</span>&nbsp;<span class="ident" id="8525663">os</span><span class="op" id="8525665">.</span><span class="ident" id="8525666">Args</span><span class="op" id="8525670">[</span><span class="num" id="8525671">0</span><span class="op" id="8525672">]</span><span class="op" id="8525673">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8525677">Root</span><span class="op" id="8525681">:</span>&nbsp;<span class="string" id="8525683">&#34;/test.go&#34;</span><span class="op" id="8525693">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8525697">Args</span><span class="op" id="8525701">:</span>&nbsp;<span class="op" id="8525703">[</span><span class="op" id="8525704">]</span><span class="builtintype" id="8525705">string</span><span class="op" id="8525711">{</span><span class="string" id="8525712">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="8525745">}</span><span class="op" id="8525746">,</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8525749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8525752">expectedMap</span>&nbsp;<span class="op" id="8525764">:=</span>&nbsp;<span class="keyword" id="8525767">map</span><span class="op" id="8525770">[</span><span class="builtintype" id="8525771">string</span><span class="op" id="8525777">]</span><span class="builtintype" id="8525778">string</span><span class="op" id="8525784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8525788">&#34;_body&#34;</span><span class="op" id="8525795">:</span>&nbsp;<span class="string" id="8525797">&#34;&#34;</span><span class="op" id="8525799">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8525802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8525805">replay</span>&nbsp;<span class="op" id="8525812">:=</span>&nbsp;<span class="ident" id="8525815">runCgiTest</span><span class="op" id="8525825">(</span><span class="ident" id="8525826">t</span><span class="op" id="8525827">,</span>&nbsp;<span class="ident" id="8525829">h</span><span class="op" id="8525830">,</span>&nbsp;<span class="string" id="8525832">&#34;GET&nbsp;/test.go?no-body=1&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8525888">,</span>&nbsp;<span class="ident" id="8525890">expectedMap</span><span class="op" id="8525901">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8525904">if</span>&nbsp;<span class="ident" id="8525907">expected</span><span class="op" id="8525915">,</span>&nbsp;<span class="ident" id="8525917">got</span>&nbsp;<span class="op" id="8525921">:=</span>&nbsp;<span class="string" id="8525924">&#34;X-Test-Value&#34;</span><span class="op" id="8525938">,</span>&nbsp;<span class="ident" id="8525940">replay</span><span class="op" id="8525946">.</span><span class="ident" id="8525947">Header</span><span class="op" id="8525953">(</span><span class="op" id="8525954">)</span><span class="op" id="8525955">.</span><span class="ident" id="8525956">Get</span><span class="op" id="8525959">(</span><span class="string" id="8525960">&#34;X-Test-Header&#34;</span><span class="op" id="8525975">)</span><span class="op" id="8525976">;</span>&nbsp;<span class="ident" id="8525978">got</span>&nbsp;<span class="op" id="8525982">!=</span>&nbsp;<span class="ident" id="8525985">expected</span>&nbsp;<span class="op" id="8525994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8525998">t</span><span class="op" id="8525999">.</span><span class="ident" id="8526000">Errorf</span><span class="op" id="8526006">(</span><span class="string" id="8526007">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8526047">,</span>&nbsp;<span class="ident" id="8526049">got</span><span class="op" id="8526052">,</span>&nbsp;<span class="ident" id="8526054">expected</span><span class="op" id="8526062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8526065">}</span><br>
<span class="lineno"></span><span class="op" id="8526067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="8526070">//&nbsp;golang.org/issue/7198</span><br>
<span class="lineno"></span><span class="keyword" id="8526095">func</span>&nbsp;<span class="ident" id="8526100">Test500WithNoHeaders</span><span class="op" id="8526120">(</span><span class="ident" id="8526121">t</span>&nbsp;<span class="op" id="8526123">*</span><span class="ident" id="8526124">testing</span><span class="op" id="8526131">.</span><span class="ident" id="8526132">T</span><span class="op" id="8526133">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8526139">{</span>&nbsp;<span class="ident" id="8526141">want500Test</span><span class="op" id="8526152">(</span><span class="ident" id="8526153">t</span><span class="op" id="8526154">,</span>&nbsp;<span class="string" id="8526156">&#34;/immediate-disconnect&#34;</span><span class="op" id="8526179">)</span>&nbsp;<span class="op" id="8526181">}</span><br>
<span class="lineno"></span><span class="keyword" id="8526183">func</span>&nbsp;<span class="ident" id="8526188">Test500WithNoContentType</span><span class="op" id="8526212">(</span><span class="ident" id="8526213">t</span>&nbsp;<span class="op" id="8526215">*</span><span class="ident" id="8526216">testing</span><span class="op" id="8526223">.</span><span class="ident" id="8526224">T</span><span class="op" id="8526225">)</span>&nbsp;<span class="op" id="8526227">{</span>&nbsp;<span class="ident" id="8526229">want500Test</span><span class="op" id="8526240">(</span><span class="ident" id="8526241">t</span><span class="op" id="8526242">,</span>&nbsp;<span class="string" id="8526244">&#34;/no-content-type&#34;</span><span class="op" id="8526262">)</span>&nbsp;<span class="op" id="8526264">}</span><br>
<span class="lineno"></span><span class="keyword" id="8526266">func</span>&nbsp;<span class="ident" id="8526271">Test500WithEmptyHeaders</span><span class="op" id="8526294">(</span><span class="ident" id="8526295">t</span>&nbsp;<span class="op" id="8526297">*</span><span class="ident" id="8526298">testing</span><span class="op" id="8526305">.</span><span class="ident" id="8526306">T</span><span class="op" id="8526307">)</span>&nbsp;&nbsp;<span class="op" id="8526310">{</span>&nbsp;<span class="ident" id="8526312">want500Test</span><span class="op" id="8526323">(</span><span class="ident" id="8526324">t</span><span class="op" id="8526325">,</span>&nbsp;<span class="string" id="8526327">&#34;/empty-headers&#34;</span><span class="op" id="8526343">)</span>&nbsp;<span class="op" id="8526345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="8526348">func</span>&nbsp;<span class="ident" id="8526353">want500Test</span><span class="op" id="8526364">(</span><span class="ident" id="8526365">t</span>&nbsp;<span class="op" id="8526367">*</span><span class="ident" id="8526368">testing</span><span class="op" id="8526375">.</span><span class="ident" id="8526376">T</span><span class="op" id="8526377">,</span>&nbsp;<span class="ident" id="8526379">path</span>&nbsp;<span class="builtintype" id="8526384">string</span><span class="op" id="8526390">)</span>&nbsp;<span class="op" id="8526392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8526395">h</span>&nbsp;<span class="op" id="8526397">:=</span>&nbsp;<span class="op" id="8526400">&amp;</span><span class="ident" id="8526401">Handler</span><span class="op" id="8526408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8526412">Path</span><span class="op" id="8526416">:</span>&nbsp;<span class="ident" id="8526418">os</span><span class="op" id="8526420">.</span><span class="ident" id="8526421">Args</span><span class="op" id="8526425">[</span><span class="num" id="8526426">0</span><span class="op" id="8526427">]</span><span class="op" id="8526428">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8526432">Root</span><span class="op" id="8526436">:</span>&nbsp;<span class="string" id="8526438">&#34;/test.go&#34;</span><span class="op" id="8526448">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8526452">Args</span><span class="op" id="8526456">:</span>&nbsp;<span class="op" id="8526458">[</span><span class="op" id="8526459">]</span><span class="builtintype" id="8526460">string</span><span class="op" id="8526466">{</span><span class="string" id="8526467">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="8526500">}</span><span class="op" id="8526501">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8526504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8526507">expectedMap</span>&nbsp;<span class="op" id="8526519">:=</span>&nbsp;<span class="keyword" id="8526522">map</span><span class="op" id="8526525">[</span><span class="builtintype" id="8526526">string</span><span class="op" id="8526532">]</span><span class="builtintype" id="8526533">string</span><span class="op" id="8526539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8526543">&#34;_body&#34;</span><span class="op" id="8526550">:</span>&nbsp;<span class="string" id="8526552">&#34;&#34;</span><span class="op" id="8526554">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8526557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8526560">replay</span>&nbsp;<span class="op" id="8526567">:=</span>&nbsp;<span class="ident" id="8526570">runCgiTest</span><span class="op" id="8526580">(</span><span class="ident" id="8526581">t</span><span class="op" id="8526582">,</span>&nbsp;<span class="ident" id="8526584">h</span><span class="op" id="8526585">,</span>&nbsp;<span class="string" id="8526587">&#34;GET&nbsp;&#34;</span><span class="op" id="8526593">+</span><span class="ident" id="8526594">path</span><span class="op" id="8526598">+</span><span class="string" id="8526599">&#34;&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="8526633">,</span>&nbsp;<span class="ident" id="8526635">expectedMap</span><span class="op" id="8526646">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8526649">if</span>&nbsp;<span class="ident" id="8526652">replay</span><span class="op" id="8526658">.</span><span class="ident" id="8526659">Code</span>&nbsp;<span class="op" id="8526664">!=</span>&nbsp;<span class="num" id="8526667">500</span>&nbsp;<span class="op" id="8526671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8526675">t</span><span class="op" id="8526676">.</span><span class="ident" id="8526677">Errorf</span><span class="op" id="8526683">(</span><span class="string" id="8526684">&#34;Got&nbsp;code&nbsp;%d;&nbsp;want&nbsp;500&#34;</span><span class="op" id="8526707">,</span>&nbsp;<span class="ident" id="8526709">replay</span><span class="op" id="8526715">.</span><span class="ident" id="8526716">Code</span><span class="op" id="8526720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8526723">}</span><br>
<span class="lineno"></span><span class="op" id="8526725">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="8526728">type</span>&nbsp;<span class="ident" id="8526733">neverEnding</span>&nbsp;<span class="builtintype" id="8526745">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8526751">func</span>&nbsp;<span class="op" id="8526756">(</span><span class="ident" id="8526757">b</span>&nbsp;<span class="ident" id="8526759">neverEnding</span><span class="op" id="8526770">)</span>&nbsp;<span class="ident" id="8526772">Read</span><span class="op" id="8526776">(</span><span class="ident" id="8526777">p</span>&nbsp;<span class="op" id="8526779">[</span><span class="op" id="8526780">]</span><span class="builtintype" id="8526781">byte</span><span class="op" id="8526785">)</span>&nbsp;<span class="op" id="8526787">(</span><span class="ident" id="8526788">n</span>&nbsp;<span class="builtintype" id="8526790">int</span><span class="op" id="8526793">,</span>&nbsp;<span class="ident" id="8526795">err</span>&nbsp;<span class="builtintype" id="8526799">error</span><span class="op" id="8526804">)</span>&nbsp;<span class="op" id="8526806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8526809">for</span>&nbsp;<span class="ident" id="8526813">i</span>&nbsp;<span class="op" id="8526815">:=</span>&nbsp;<span class="keyword" id="8526818">range</span>&nbsp;<span class="ident" id="8526824">p</span>&nbsp;<span class="op" id="8526826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8526830">p</span><span class="op" id="8526831">[</span><span class="ident" id="8526832">i</span><span class="op" id="8526833">]</span>&nbsp;<span class="op" id="8526835">=</span>&nbsp;<span class="builtintype" id="8526837">byte</span><span class="op" id="8526841">(</span><span class="ident" id="8526842">b</span><span class="op" id="8526843">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8526846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8526849">return</span>&nbsp;<span class="builtinfunc" id="8526856">len</span><span class="op" id="8526859">(</span><span class="ident" id="8526860">p</span><span class="op" id="8526861">)</span><span class="op" id="8526862">,</span>&nbsp;<span class="ident" id="8526864">nil</span><br>
<span class="lineno"></span><span class="op" id="8526868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8526871">//&nbsp;Note:&nbsp;not&nbsp;actually&nbsp;a&nbsp;test.</span><br>
<span class="lineno">190</span><span class="keyword" id="8526901">func</span>&nbsp;<span class="ident" id="8526906">TestBeChildCGIProcess</span><span class="op" id="8526927">(</span><span class="ident" id="8526928">t</span>&nbsp;<span class="op" id="8526930">*</span><span class="ident" id="8526931">testing</span><span class="op" id="8526938">.</span><span class="ident" id="8526939">T</span><span class="op" id="8526940">)</span>&nbsp;<span class="op" id="8526942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8526945">if</span>&nbsp;<span class="ident" id="8526948">os</span><span class="op" id="8526950">.</span><span class="ident" id="8526951">Getenv</span><span class="op" id="8526957">(</span><span class="string" id="8526958">&#34;REQUEST_METHOD&#34;</span><span class="op" id="8526974">)</span>&nbsp;<span class="op" id="8526976">==</span>&nbsp;<span class="string" id="8526979">&#34;&#34;</span>&nbsp;<span class="op" id="8526982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8526986">//&nbsp;Not&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment;&nbsp;skipping&nbsp;test.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8527032">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8527040">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8527043">switch</span>&nbsp;<span class="ident" id="8527050">os</span><span class="op" id="8527052">.</span><span class="ident" id="8527053">Getenv</span><span class="op" id="8527059">(</span><span class="string" id="8527060">&#34;REQUEST_URI&#34;</span><span class="op" id="8527073">)</span>&nbsp;<span class="op" id="8527075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8527078">case</span>&nbsp;<span class="string" id="8527083">&#34;/immediate-disconnect&#34;</span><span class="op" id="8527106">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8527110">os</span><span class="op" id="8527112">.</span><span class="ident" id="8527113">Exit</span><span class="op" id="8527117">(</span><span class="num" id="8527118">0</span><span class="op" id="8527119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8527122">case</span>&nbsp;<span class="string" id="8527127">&#34;/no-content-type&#34;</span><span class="op" id="8527145">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8527149">fmt</span><span class="op" id="8527152">.</span><span class="ident" id="8527153">Printf</span><span class="op" id="8527159">(</span><span class="string" id="8527160">&#34;Content-Length:&nbsp;6\n\nHello\n&#34;</span><span class="op" id="8527190">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8527194">os</span><span class="op" id="8527196">.</span><span class="ident" id="8527197">Exit</span><span class="op" id="8527201">(</span><span class="num" id="8527202">0</span><span class="op" id="8527203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8527206">case</span>&nbsp;<span class="string" id="8527211">&#34;/empty-headers&#34;</span><span class="op" id="8527227">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8527231">fmt</span><span class="op" id="8527234">.</span><span class="ident" id="8527235">Printf</span><span class="op" id="8527241">(</span><span class="string" id="8527242">&#34;\nHello&#34;</span><span class="op" id="8527251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8527255">os</span><span class="op" id="8527257">.</span><span class="ident" id="8527258">Exit</span><span class="op" id="8527262">(</span><span class="num" id="8527263">0</span><span class="op" id="8527264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8527267">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8527270">Serve</span><span class="op" id="8527275">(</span><span class="ident" id="8527276">http</span><span class="op" id="8527280">.</span><span class="ident" id="8527281">HandlerFunc</span><span class="op" id="8527292">(</span><span class="keyword" id="8527293">func</span><span class="op" id="8527297">(</span><span class="ident" id="8527298">rw</span>&nbsp;<span class="ident" id="8527301">http</span><span class="op" id="8527305">.</span><span class="ident" id="8527306">ResponseWriter</span><span class="op" id="8527320">,</span>&nbsp;<span class="ident" id="8527322">req</span>&nbsp;<span class="op" id="8527326">*</span><span class="ident" id="8527327">http</span><span class="op" id="8527331">.</span><span class="ident" id="8527332">Request</span><span class="op" id="8527339">)</span>&nbsp;<span class="op" id="8527341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8527345">rw</span><span class="op" id="8527347">.</span><span class="ident" id="8527348">Header</span><span class="op" id="8527354">(</span><span class="op" id="8527355">)</span><span class="op" id="8527356">.</span><span class="ident" id="8527357">Set</span><span class="op" id="8527360">(</span><span class="string" id="8527361">&#34;X-Test-Header&#34;</span><span class="op" id="8527376">,</span>&nbsp;<span class="string" id="8527378">&#34;X-Test-Value&#34;</span><span class="op" id="8527392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8527396">req</span><span class="op" id="8527399">.</span><span class="ident" id="8527400">ParseForm</span><span class="op" id="8527409">(</span><span class="op" id="8527410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8527414">if</span>&nbsp;<span class="ident" id="8527417">req</span><span class="op" id="8527420">.</span><span class="ident" id="8527421">FormValue</span><span class="op" id="8527430">(</span><span class="string" id="8527431">&#34;no-body&#34;</span><span class="op" id="8527440">)</span>&nbsp;<span class="op" id="8527442">==</span>&nbsp;<span class="string" id="8527445">&#34;1&#34;</span>&nbsp;<span class="op" id="8527449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8527454">return</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8527463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8527467">if</span>&nbsp;<span class="ident" id="8527470">req</span><span class="op" id="8527473">.</span><span class="ident" id="8527474">FormValue</span><span class="op" id="8527483">(</span><span class="string" id="8527484">&#34;write-forever&#34;</span><span class="op" id="8527499">)</span>&nbsp;<span class="op" id="8527501">==</span>&nbsp;<span class="string" id="8527504">&#34;1&#34;</span>&nbsp;<span class="op" id="8527508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8527513">io</span><span class="op" id="8527515">.</span><span class="ident" id="8527516">Copy</span><span class="op" id="8527520">(</span><span class="ident" id="8527521">rw</span><span class="op" id="8527523">,</span>&nbsp;<span class="ident" id="8527525">neverEnding</span><span class="op" id="8527536">(</span><span class="string" id="8527537">&#39;a&#39;</span><span class="op" id="8527540">)</span><span class="op" id="8527541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8527546">for</span>&nbsp;<span class="op" id="8527550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8527556">time</span><span class="op" id="8527560">.</span><span class="ident" id="8527561">Sleep</span><span class="op" id="8527566">(</span><span class="num" id="8527567">5</span>&nbsp;<span class="op" id="8527569">*</span>&nbsp;<span class="ident" id="8527571">time</span><span class="op" id="8527575">.</span><span class="ident" id="8527576">Second</span><span class="op" id="8527582">)</span>&nbsp;<span class="comment" id="8527584">//&nbsp;hang&nbsp;forever,&nbsp;until&nbsp;killed</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8527617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8527621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8527625">fmt</span><span class="op" id="8527628">.</span><span class="ident" id="8527629">Fprintf</span><span class="op" id="8527636">(</span><span class="ident" id="8527637">rw</span><span class="op" id="8527639">,</span>&nbsp;<span class="string" id="8527641">&#34;test=Hello&nbsp;CGI-in-CGI\n&#34;</span><span class="op" id="8527666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8527670">for</span>&nbsp;<span class="ident" id="8527674">k</span><span class="op" id="8527675">,</span>&nbsp;<span class="ident" id="8527677">vv</span>&nbsp;<span class="op" id="8527680">:=</span>&nbsp;<span class="keyword" id="8527683">range</span>&nbsp;<span class="ident" id="8527689">req</span><span class="op" id="8527692">.</span><span class="ident" id="8527693">Form</span>&nbsp;<span class="op" id="8527698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8527703">for</span>&nbsp;<span class="ident" id="8527707">_</span><span class="op" id="8527708">,</span>&nbsp;<span class="ident" id="8527710">v</span>&nbsp;<span class="op" id="8527712">:=</span>&nbsp;<span class="keyword" id="8527715">range</span>&nbsp;<span class="ident" id="8527721">vv</span>&nbsp;<span class="op" id="8527724">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8527730">fmt</span><span class="op" id="8527733">.</span><span class="ident" id="8527734">Fprintf</span><span class="op" id="8527741">(</span><span class="ident" id="8527742">rw</span><span class="op" id="8527744">,</span>&nbsp;<span class="string" id="8527746">&#34;param-%s=%s\n&#34;</span><span class="op" id="8527761">,</span>&nbsp;<span class="ident" id="8527763">k</span><span class="op" id="8527764">,</span>&nbsp;<span class="ident" id="8527766">v</span><span class="op" id="8527767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8527772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8527776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8527780">for</span>&nbsp;<span class="ident" id="8527784">_</span><span class="op" id="8527785">,</span>&nbsp;<span class="ident" id="8527787">kv</span>&nbsp;<span class="op" id="8527790">:=</span>&nbsp;<span class="keyword" id="8527793">range</span>&nbsp;<span class="ident" id="8527799">os</span><span class="op" id="8527801">.</span><span class="ident" id="8527802">Environ</span><span class="op" id="8527809">(</span><span class="op" id="8527810">)</span>&nbsp;<span class="op" id="8527812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8527817">fmt</span><span class="op" id="8527820">.</span><span class="ident" id="8527821">Fprintf</span><span class="op" id="8527828">(</span><span class="ident" id="8527829">rw</span><span class="op" id="8527831">,</span>&nbsp;<span class="string" id="8527833">&#34;env-%s\n&#34;</span><span class="op" id="8527843">,</span>&nbsp;<span class="ident" id="8527845">kv</span><span class="op" id="8527847">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8527851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8527854">}</span><span class="op" id="8527855">)</span><span class="op" id="8527856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8527859">os</span><span class="op" id="8527861">.</span><span class="ident" id="8527862">Exit</span><span class="op" id="8527866">(</span><span class="num" id="8527867">0</span><span class="op" id="8527868">)</span><br>
<span class="lineno"></span><span class="op" id="8527870">}</span>
</div>
</body>
</html>
