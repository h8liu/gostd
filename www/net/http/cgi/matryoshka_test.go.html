<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="7549237">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7549292">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7549346">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7549397">//&nbsp;Tests&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;program&nbsp;running&nbsp;under&nbsp;a&nbsp;Go&nbsp;CGI&nbsp;host&nbsp;process.</span><br>
<span class="lineno"></span><span class="comment" id="7549460">//&nbsp;Further,&nbsp;the&nbsp;two&nbsp;programs&nbsp;are&nbsp;the&nbsp;same&nbsp;binary,&nbsp;just&nbsp;checking</span><br>
<span class="lineno"></span><span class="comment" id="7549524">//&nbsp;their&nbsp;environment&nbsp;to&nbsp;figure&nbsp;out&nbsp;what&nbsp;mode&nbsp;to&nbsp;run&nbsp;in.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7549581">package</span>&nbsp;<span class="ident" id="7549589">cgi</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="7549594">import</span>&nbsp;<span class="op" id="7549601">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7549604">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7549613">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7549623">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7549630">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7549636">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7549648">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7549669">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7549675">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7549686">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7549697">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7549704">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7549707">//&nbsp;This&nbsp;test&nbsp;is&nbsp;a&nbsp;CGI&nbsp;host&nbsp;(testing&nbsp;host.go)&nbsp;that&nbsp;runs&nbsp;its&nbsp;own&nbsp;binary</span><br>
<span class="lineno">25</span><span class="comment" id="7549777">//&nbsp;as&nbsp;a&nbsp;child&nbsp;process&nbsp;testing&nbsp;the&nbsp;other&nbsp;half&nbsp;of&nbsp;CGI&nbsp;(child.go).</span><br>
<span class="lineno"></span><span class="keyword" id="7549841">func</span>&nbsp;<span class="ident" id="7549846">TestHostingOurselves</span><span class="op" id="7549866">(</span><span class="ident" id="7549867">t</span>&nbsp;<span class="op" id="7549869">*</span><span class="ident" id="7549870"><a href="/net/http/cgi/matryoshka_test.go.html#7549686">testing</a></span><span class="op" id="7549877">.</span><span class="ident" id="7549878">T</span><span class="op" id="7549879">)</span>&nbsp;<span class="op" id="7549881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7549884">if</span>&nbsp;<span class="ident" id="7549887"><a href="/net/http/cgi/matryoshka_test.go.html#7549675">runtime</a></span><span class="op" id="7549894">.</span><span class="ident" id="7549895">GOOS</span>&nbsp;<span class="op" id="7549900">==</span>&nbsp;<span class="string" id="7549903">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7549910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7549914"><a href="/net/http/cgi/matryoshka_test.go.html#7549867">t</a></span><span class="op" id="7549915">.</span><span class="ident" id="7549916">Skip</span><span class="op" id="7549920">(</span><span class="string" id="7549921">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="7549939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7549942">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7549946">h</span>&nbsp;<span class="op" id="7549948">:=</span>&nbsp;<span class="op" id="7549951">&amp;</span><span class="ident" id="7549952"><a href="/net/http/cgi/host.go.html#5493520">Handler</a></span><span class="op" id="7549959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7549963">Path</span><span class="op" id="7549967">:</span>&nbsp;<span class="ident" id="7549969"><a href="/net/http/cgi/matryoshka_test.go.html#7549669">os</a></span><span class="op" id="7549971">.</span><span class="ident" id="7549972">Args</span><span class="op" id="7549976">[</span><span class="num" id="7549977">0</span><span class="op" id="7549978">]</span><span class="op" id="7549979">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7549983">Root</span><span class="op" id="7549987">:</span>&nbsp;<span class="string" id="7549989">&#34;/test.go&#34;</span><span class="op" id="7549999">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7550003">Args</span><span class="op" id="7550007">:</span>&nbsp;<span class="op" id="7550009">[</span><span class="op" id="7550010">]</span><span class="builtintype" id="7550011">string</span><span class="op" id="7550017">{</span><span class="string" id="7550018">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7550051">}</span><span class="op" id="7550052">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7550055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7550058">expectedMap</span>&nbsp;<span class="op" id="7550070">:=</span>&nbsp;<span class="keyword" id="7550073">map</span><span class="op" id="7550076">[</span><span class="builtintype" id="7550077">string</span><span class="op" id="7550083">]</span><span class="builtintype" id="7550084">string</span><span class="op" id="7550090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7550094">&#34;test&#34;</span><span class="op" id="7550100">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7550119">&#34;Hello&nbsp;CGI-in-CGI&#34;</span><span class="op" id="7550137">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7550141">&#34;param-a&#34;</span><span class="op" id="7550150">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7550166">&#34;b&#34;</span><span class="op" id="7550169">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7550173">&#34;param-foo&#34;</span><span class="op" id="7550184">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7550198">&#34;bar&#34;</span><span class="op" id="7550203">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7550207">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="7550230">:</span>&nbsp;<span class="string" id="7550232">&#34;CGI/1.1&#34;</span><span class="op" id="7550241">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7550245">&#34;env-HTTP_HOST&#34;</span><span class="op" id="7550260">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7550270">&#34;example.com&#34;</span><span class="op" id="7550283">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7550287">&#34;env-PATH_INFO&#34;</span><span class="op" id="7550302">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7550312">&#34;&#34;</span><span class="op" id="7550314">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7550318">&#34;env-QUERY_STRING&#34;</span><span class="op" id="7550336">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7550343">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="7550356">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7550360">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="7550377">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7550385">&#34;1.2.3.4&#34;</span><span class="op" id="7550394">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7550398">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="7550415">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7550423">&#34;1.2.3.4&#34;</span><span class="op" id="7550432">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7550436">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="7550456">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7550461">&#34;GET&#34;</span><span class="op" id="7550466">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7550470">&#34;env-REQUEST_URI&#34;</span><span class="op" id="7550487">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7550495">&#34;/test.go?foo=bar&amp;a=b&#34;</span><span class="op" id="7550517">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7550521">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="7550542">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7550546"><a href="/net/http/cgi/matryoshka_test.go.html#7549669">os</a></span><span class="op" id="7550548">.</span><span class="ident" id="7550549">Args</span><span class="op" id="7550553">[</span><span class="num" id="7550554">0</span><span class="op" id="7550555">]</span><span class="op" id="7550556">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7550560">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="7550577">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7550585">&#34;/test.go&#34;</span><span class="op" id="7550595">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7550599">&#34;env-SERVER_NAME&#34;</span><span class="op" id="7550616">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7550624">&#34;example.com&#34;</span><span class="op" id="7550637">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7550641">&#34;env-SERVER_PORT&#34;</span><span class="op" id="7550658">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7550666">&#34;80&#34;</span><span class="op" id="7550670">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7550674">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="7550695">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="7550699">&#34;go&#34;</span><span class="op" id="7550703">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7550706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7550709">replay</span>&nbsp;<span class="op" id="7550716">:=</span>&nbsp;<span class="ident" id="7550719"><a href="/net/http/cgi/host_test.go.html#7538217">runCgiTest</a></span><span class="op" id="7550729">(</span><span class="ident" id="7550730"><a href="/net/http/cgi/matryoshka_test.go.html#7549867">t</a></span><span class="op" id="7550731">,</span>&nbsp;<span class="ident" id="7550733"><a href="/net/http/cgi/matryoshka_test.go.html#7549946">h</a></span><span class="op" id="7550734">,</span>&nbsp;<span class="string" id="7550736">&#34;GET&nbsp;/test.go?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7550794">,</span>&nbsp;<span class="ident" id="7550796"><a href="/net/http/cgi/matryoshka_test.go.html#7550058">expectedMap</a></span><span class="op" id="7550807">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7550811">if</span>&nbsp;<span class="ident" id="7550814">expected</span><span class="op" id="7550822">,</span>&nbsp;<span class="ident" id="7550824">got</span>&nbsp;<span class="op" id="7550828">:=</span>&nbsp;<span class="string" id="7550831">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="7550857">,</span>&nbsp;<span class="ident" id="7550859"><a href="/net/http/cgi/matryoshka_test.go.html#7550709">replay</a></span><span class="op" id="7550865">.</span><span class="ident" id="7550866">Header</span><span class="op" id="7550872">(</span><span class="op" id="7550873">)</span><span class="op" id="7550874">.</span><span class="ident" id="7550875">Get</span><span class="op" id="7550878">(</span><span class="string" id="7550879">&#34;Content-Type&#34;</span><span class="op" id="7550893">)</span><span class="op" id="7550894">;</span>&nbsp;<span class="ident" id="7550896"><a href="/net/http/cgi/matryoshka_test.go.html#7550824">got</a></span>&nbsp;<span class="op" id="7550900">!=</span>&nbsp;<span class="ident" id="7550903"><a href="/net/http/cgi/matryoshka_test.go.html#7550814">expected</a></span>&nbsp;<span class="op" id="7550912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7550916"><a href="/net/http/cgi/matryoshka_test.go.html#7549867">t</a></span><span class="op" id="7550917">.</span><span class="ident" id="7550918">Errorf</span><span class="op" id="7550924">(</span><span class="string" id="7550925">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7550964">,</span>&nbsp;<span class="ident" id="7550966"><a href="/net/http/cgi/matryoshka_test.go.html#7550824">got</a></span><span class="op" id="7550969">,</span>&nbsp;<span class="ident" id="7550971"><a href="/net/http/cgi/matryoshka_test.go.html#7550814">expected</a></span><span class="op" id="7550979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7550982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7550985">if</span>&nbsp;<span class="ident" id="7550988">expected</span><span class="op" id="7550996">,</span>&nbsp;<span class="ident" id="7550998">got</span>&nbsp;<span class="op" id="7551002">:=</span>&nbsp;<span class="string" id="7551005">&#34;X-Test-Value&#34;</span><span class="op" id="7551019">,</span>&nbsp;<span class="ident" id="7551021"><a href="/net/http/cgi/matryoshka_test.go.html#7550709">replay</a></span><span class="op" id="7551027">.</span><span class="ident" id="7551028">Header</span><span class="op" id="7551034">(</span><span class="op" id="7551035">)</span><span class="op" id="7551036">.</span><span class="ident" id="7551037">Get</span><span class="op" id="7551040">(</span><span class="string" id="7551041">&#34;X-Test-Header&#34;</span><span class="op" id="7551056">)</span><span class="op" id="7551057">;</span>&nbsp;<span class="ident" id="7551059"><a href="/net/http/cgi/matryoshka_test.go.html#7550998">got</a></span>&nbsp;<span class="op" id="7551063">!=</span>&nbsp;<span class="ident" id="7551066"><a href="/net/http/cgi/matryoshka_test.go.html#7550988">expected</a></span>&nbsp;<span class="op" id="7551075">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551079"><a href="/net/http/cgi/matryoshka_test.go.html#7549867">t</a></span><span class="op" id="7551080">.</span><span class="ident" id="7551081">Errorf</span><span class="op" id="7551087">(</span><span class="string" id="7551088">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7551128">,</span>&nbsp;<span class="ident" id="7551130"><a href="/net/http/cgi/matryoshka_test.go.html#7550998">got</a></span><span class="op" id="7551133">,</span>&nbsp;<span class="ident" id="7551135"><a href="/net/http/cgi/matryoshka_test.go.html#7550988">expected</a></span><span class="op" id="7551143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7551146">}</span><br>
<span class="lineno"></span><span class="op" id="7551148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7551151">type</span>&nbsp;<span class="ident" id="7551156">customWriterRecorder</span>&nbsp;<span class="keyword" id="7551177">struct</span>&nbsp;<span class="op" id="7551184">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551187">w</span>&nbsp;<span class="ident" id="7551189"><a href="/net/http/cgi/matryoshka_test.go.html#7549630">io</a></span><span class="op" id="7551191">.</span><span class="ident" id="7551192">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7551200">*</span><span class="ident" id="7551201"><a href="/net/http/cgi/matryoshka_test.go.html#7549648">httptest</a></span><span class="op" id="7551209">.</span><span class="ident" id="7551210">ResponseRecorder</span><br>
<span class="lineno"></span><span class="op" id="7551227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7551230">func</span>&nbsp;<span class="op" id="7551235">(</span><span class="ident" id="7551236">r</span>&nbsp;<span class="op" id="7551238">*</span><span class="ident" id="7551239"><a href="/net/http/cgi/matryoshka_test.go.html#7551156">customWriterRecorder</a></span><span class="op" id="7551259">)</span>&nbsp;<span class="ident" id="7551261">Write</span><span class="op" id="7551266">(</span><span class="ident" id="7551267">p</span>&nbsp;<span class="op" id="7551269">[</span><span class="op" id="7551270">]</span><span class="builtintype" id="7551271">byte</span><span class="op" id="7551275">)</span>&nbsp;<span class="op" id="7551277">(</span><span class="ident" id="7551278">n</span>&nbsp;<span class="builtintype" id="7551280">int</span><span class="op" id="7551283">,</span>&nbsp;<span class="ident" id="7551285">err</span>&nbsp;<span class="builtintype" id="7551289">error</span><span class="op" id="7551294">)</span>&nbsp;<span class="op" id="7551296">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7551299">return</span>&nbsp;<span class="ident" id="7551306"><a href="/net/http/cgi/matryoshka_test.go.html#7551236">r</a></span><span class="op" id="7551307">.</span><span class="ident" id="7551308">w</span><span class="op" id="7551309">.</span><span class="ident" id="7551310">Write</span><span class="op" id="7551315">(</span><span class="ident" id="7551316"><a href="/net/http/cgi/matryoshka_test.go.html#7551267">p</a></span><span class="op" id="7551317">)</span><br>
<span class="lineno"></span><span class="op" id="7551319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7551322">type</span>&nbsp;<span class="ident" id="7551327">limitWriter</span>&nbsp;<span class="keyword" id="7551339">struct</span>&nbsp;<span class="op" id="7551346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551349">w</span>&nbsp;<span class="ident" id="7551351"><a href="/net/http/cgi/matryoshka_test.go.html#7549630">io</a></span><span class="op" id="7551353">.</span><span class="ident" id="7551354">Writer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551362">n</span>&nbsp;<span class="builtintype" id="7551364">int</span><br>
<span class="lineno"></span><span class="op" id="7551368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7551371">func</span>&nbsp;<span class="op" id="7551376">(</span><span class="ident" id="7551377">w</span>&nbsp;<span class="op" id="7551379">*</span><span class="ident" id="7551380"><a href="/net/http/cgi/matryoshka_test.go.html#7551327">limitWriter</a></span><span class="op" id="7551391">)</span>&nbsp;<span class="ident" id="7551393">Write</span><span class="op" id="7551398">(</span><span class="ident" id="7551399">p</span>&nbsp;<span class="op" id="7551401">[</span><span class="op" id="7551402">]</span><span class="builtintype" id="7551403">byte</span><span class="op" id="7551407">)</span>&nbsp;<span class="op" id="7551409">(</span><span class="ident" id="7551410">n</span>&nbsp;<span class="builtintype" id="7551412">int</span><span class="op" id="7551415">,</span>&nbsp;<span class="ident" id="7551417">err</span>&nbsp;<span class="builtintype" id="7551421">error</span><span class="op" id="7551426">)</span>&nbsp;<span class="op" id="7551428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7551431">if</span>&nbsp;<span class="builtinfunc" id="7551434">len</span><span class="op" id="7551437">(</span><span class="ident" id="7551438"><a href="/net/http/cgi/matryoshka_test.go.html#7551399">p</a></span><span class="op" id="7551439">)</span>&nbsp;<span class="op" id="7551441">&gt;</span>&nbsp;<span class="ident" id="7551443"><a href="/net/http/cgi/matryoshka_test.go.html#7551377">w</a></span><span class="op" id="7551444">.</span><span class="ident" id="7551445">n</span>&nbsp;<span class="op" id="7551447">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551451"><a href="/net/http/cgi/matryoshka_test.go.html#7551399">p</a></span>&nbsp;<span class="op" id="7551453">=</span>&nbsp;<span class="ident" id="7551455"><a href="/net/http/cgi/matryoshka_test.go.html#7551399">p</a></span><span class="op" id="7551456">[</span><span class="op" id="7551457">:</span><span class="ident" id="7551458"><a href="/net/http/cgi/matryoshka_test.go.html#7551377">w</a></span><span class="op" id="7551459">.</span><span class="ident" id="7551460">n</span><span class="op" id="7551461">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7551464">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7551467">if</span>&nbsp;<span class="builtinfunc" id="7551470">len</span><span class="op" id="7551473">(</span><span class="ident" id="7551474"><a href="/net/http/cgi/matryoshka_test.go.html#7551399">p</a></span><span class="op" id="7551475">)</span>&nbsp;<span class="op" id="7551477">&gt;</span>&nbsp;<span class="num" id="7551479">0</span>&nbsp;<span class="op" id="7551481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551485"><a href="/net/http/cgi/matryoshka_test.go.html#7551410">n</a></span><span class="op" id="7551486">,</span>&nbsp;<span class="ident" id="7551488"><a href="/net/http/cgi/matryoshka_test.go.html#7551417">err</a></span>&nbsp;<span class="op" id="7551492">=</span>&nbsp;<span class="ident" id="7551494"><a href="/net/http/cgi/matryoshka_test.go.html#7551377">w</a></span><span class="op" id="7551495">.</span><span class="ident" id="7551496">w</span><span class="op" id="7551497">.</span><span class="ident" id="7551498">Write</span><span class="op" id="7551503">(</span><span class="ident" id="7551504"><a href="/net/http/cgi/matryoshka_test.go.html#7551399">p</a></span><span class="op" id="7551505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551509"><a href="/net/http/cgi/matryoshka_test.go.html#7551377">w</a></span><span class="op" id="7551510">.</span><span class="ident" id="7551511">n</span>&nbsp;<span class="op" id="7551513">-=</span>&nbsp;<span class="ident" id="7551516"><a href="/net/http/cgi/matryoshka_test.go.html#7551410">n</a></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7551519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7551522">if</span>&nbsp;<span class="ident" id="7551525"><a href="/net/http/cgi/matryoshka_test.go.html#7551377">w</a></span><span class="op" id="7551526">.</span><span class="ident" id="7551527">n</span>&nbsp;<span class="op" id="7551529">==</span>&nbsp;<span class="num" id="7551532">0</span>&nbsp;<span class="op" id="7551534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551538"><a href="/net/http/cgi/matryoshka_test.go.html#7551417">err</a></span>&nbsp;<span class="op" id="7551542">=</span>&nbsp;<span class="ident" id="7551544"><a href="/net/http/cgi/matryoshka_test.go.html#7549613">errors</a></span><span class="op" id="7551550">.</span><span class="ident" id="7551551">New</span><span class="op" id="7551554">(</span><span class="string" id="7551555">&#34;past&nbsp;write&nbsp;limit&#34;</span><span class="op" id="7551573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7551576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7551579">return</span><br>
<span class="lineno">90</span><span class="op" id="7551586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7551589">//&nbsp;If&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying&nbsp;the&nbsp;child&#39;s&nbsp;output&nbsp;to&nbsp;the&nbsp;parent,&nbsp;test</span><br>
<span class="lineno"></span><span class="comment" id="7551659">//&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;child.</span><br>
<span class="lineno"></span><span class="keyword" id="7551686">func</span>&nbsp;<span class="ident" id="7551691">TestKillChildAfterCopyError</span><span class="op" id="7551718">(</span><span class="ident" id="7551719">t</span>&nbsp;<span class="op" id="7551721">*</span><span class="ident" id="7551722"><a href="/net/http/cgi/matryoshka_test.go.html#7549686">testing</a></span><span class="op" id="7551729">.</span><span class="ident" id="7551730">T</span><span class="op" id="7551731">)</span>&nbsp;<span class="op" id="7551733">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7551736">if</span>&nbsp;<span class="ident" id="7551739"><a href="/net/http/cgi/matryoshka_test.go.html#7549675">runtime</a></span><span class="op" id="7551746">.</span><span class="ident" id="7551747">GOOS</span>&nbsp;<span class="op" id="7551752">==</span>&nbsp;<span class="string" id="7551755">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7551762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551766"><a href="/net/http/cgi/matryoshka_test.go.html#7551719">t</a></span><span class="op" id="7551767">.</span><span class="ident" id="7551768">Skip</span><span class="op" id="7551772">(</span><span class="string" id="7551773">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="7551791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7551794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7551798">defer</span>&nbsp;<span class="keyword" id="7551804">func</span><span class="op" id="7551808">(</span><span class="op" id="7551809">)</span>&nbsp;<span class="op" id="7551811">{</span>&nbsp;<span class="ident" id="7551813"><a href="/net/http/cgi/host.go.html#5501939">testHookStartProcess</a></span>&nbsp;<span class="op" id="7551834">=</span>&nbsp;<span class="ident" id="7551836">nil</span>&nbsp;<span class="op" id="7551840">}</span><span class="op" id="7551841">(</span><span class="op" id="7551842">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551845">proc</span>&nbsp;<span class="op" id="7551850">:=</span>&nbsp;<span class="builtinfunc" id="7551853">make</span><span class="op" id="7551857">(</span><span class="keyword" id="7551858">chan</span>&nbsp;<span class="op" id="7551863">*</span><span class="ident" id="7551864"><a href="/net/http/cgi/matryoshka_test.go.html#7549669">os</a></span><span class="op" id="7551866">.</span><span class="ident" id="7551867">Process</span><span class="op" id="7551874">,</span>&nbsp;<span class="num" id="7551876">1</span><span class="op" id="7551877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551880"><a href="/net/http/cgi/host.go.html#5501939">testHookStartProcess</a></span>&nbsp;<span class="op" id="7551901">=</span>&nbsp;<span class="keyword" id="7551903">func</span><span class="op" id="7551907">(</span><span class="ident" id="7551908">p</span>&nbsp;<span class="op" id="7551910">*</span><span class="ident" id="7551911"><a href="/net/http/cgi/matryoshka_test.go.html#7549669">os</a></span><span class="op" id="7551913">.</span><span class="ident" id="7551914">Process</span><span class="op" id="7551921">)</span>&nbsp;<span class="op" id="7551923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551927"><a href="/net/http/cgi/matryoshka_test.go.html#7551845">proc</a></span>&nbsp;<span class="op" id="7551932">&lt;-</span>&nbsp;<span class="ident" id="7551935"><a href="/net/http/cgi/matryoshka_test.go.html#7551908">p</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7551938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551942">h</span>&nbsp;<span class="op" id="7551944">:=</span>&nbsp;<span class="op" id="7551947">&amp;</span><span class="ident" id="7551948"><a href="/net/http/cgi/host.go.html#5493520">Handler</a></span><span class="op" id="7551955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551959">Path</span><span class="op" id="7551963">:</span>&nbsp;<span class="ident" id="7551965"><a href="/net/http/cgi/matryoshka_test.go.html#7549669">os</a></span><span class="op" id="7551967">.</span><span class="ident" id="7551968">Args</span><span class="op" id="7551972">[</span><span class="num" id="7551973">0</span><span class="op" id="7551974">]</span><span class="op" id="7551975">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551979">Root</span><span class="op" id="7551983">:</span>&nbsp;<span class="string" id="7551985">&#34;/test.go&#34;</span><span class="op" id="7551995">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7551999">Args</span><span class="op" id="7552003">:</span>&nbsp;<span class="op" id="7552005">[</span><span class="op" id="7552006">]</span><span class="builtintype" id="7552007">string</span><span class="op" id="7552013">{</span><span class="string" id="7552014">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7552047">}</span><span class="op" id="7552048">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7552051">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552054">req</span><span class="op" id="7552057">,</span>&nbsp;<span class="ident" id="7552059">_</span>&nbsp;<span class="op" id="7552061">:=</span>&nbsp;<span class="ident" id="7552064"><a href="/net/http/cgi/matryoshka_test.go.html#7549636">http</a></span><span class="op" id="7552068">.</span><span class="ident" id="7552069">NewRequest</span><span class="op" id="7552079">(</span><span class="string" id="7552080">&#34;GET&#34;</span><span class="op" id="7552085">,</span>&nbsp;<span class="string" id="7552087">&#34;http://example.com/test.cgi?write-forever=1&#34;</span><span class="op" id="7552132">,</span>&nbsp;<span class="ident" id="7552134">nil</span><span class="op" id="7552137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552140">rec</span>&nbsp;<span class="op" id="7552144">:=</span>&nbsp;<span class="ident" id="7552147"><a href="/net/http/cgi/matryoshka_test.go.html#7549648">httptest</a></span><span class="op" id="7552155">.</span><span class="ident" id="7552156">NewRecorder</span><span class="op" id="7552167">(</span><span class="op" id="7552168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552171">var</span>&nbsp;<span class="ident" id="7552175">out</span>&nbsp;<span class="ident" id="7552179"><a href="/net/http/cgi/matryoshka_test.go.html#7549604">bytes</a></span><span class="op" id="7552184">.</span><span class="ident" id="7552185">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552193">const</span>&nbsp;<span class="ident" id="7552199">writeLen</span>&nbsp;<span class="op" id="7552208">=</span>&nbsp;<span class="num" id="7552210">50</span>&nbsp;<span class="op" id="7552213">&lt;&lt;</span>&nbsp;<span class="num" id="7552216">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552220">rw</span>&nbsp;<span class="op" id="7552223">:=</span>&nbsp;<span class="op" id="7552226">&amp;</span><span class="ident" id="7552227"><a href="/net/http/cgi/matryoshka_test.go.html#7551156">customWriterRecorder</a></span><span class="op" id="7552247">{</span><span class="op" id="7552248">&amp;</span><span class="ident" id="7552249"><a href="/net/http/cgi/matryoshka_test.go.html#7551327">limitWriter</a></span><span class="op" id="7552260">{</span><span class="op" id="7552261">&amp;</span><span class="ident" id="7552262"><a href="/net/http/cgi/matryoshka_test.go.html#7552175">out</a></span><span class="op" id="7552265">,</span>&nbsp;<span class="ident" id="7552267"><a href="/net/http/cgi/matryoshka_test.go.html#7552199">writeLen</a></span><span class="op" id="7552275">}</span><span class="op" id="7552276">,</span>&nbsp;<span class="ident" id="7552278"><a href="/net/http/cgi/matryoshka_test.go.html#7552140">rec</a></span><span class="op" id="7552281">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552285">donec</span>&nbsp;<span class="op" id="7552291">:=</span>&nbsp;<span class="builtinfunc" id="7552294">make</span><span class="op" id="7552298">(</span><span class="keyword" id="7552299">chan</span>&nbsp;<span class="builtintype" id="7552304">bool</span><span class="op" id="7552308">,</span>&nbsp;<span class="num" id="7552310">1</span><span class="op" id="7552311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552314">go</span>&nbsp;<span class="keyword" id="7552317">func</span><span class="op" id="7552321">(</span><span class="op" id="7552322">)</span>&nbsp;<span class="op" id="7552324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552328"><a href="/net/http/cgi/matryoshka_test.go.html#7551942">h</a></span><span class="op" id="7552329">.</span><span class="ident" id="7552330">ServeHTTP</span><span class="op" id="7552339">(</span><span class="ident" id="7552340"><a href="/net/http/cgi/matryoshka_test.go.html#7552220">rw</a></span><span class="op" id="7552342">,</span>&nbsp;<span class="ident" id="7552344"><a href="/net/http/cgi/matryoshka_test.go.html#7552054">req</a></span><span class="op" id="7552347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552351"><a href="/net/http/cgi/matryoshka_test.go.html#7552285">donec</a></span>&nbsp;<span class="op" id="7552357">&lt;-</span>&nbsp;<span class="ident" id="7552360">true</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7552366">}</span><span class="op" id="7552367">(</span><span class="op" id="7552368">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552372">select</span>&nbsp;<span class="op" id="7552379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552382">case</span>&nbsp;<span class="op" id="7552387">&lt;-</span><span class="ident" id="7552389"><a href="/net/http/cgi/matryoshka_test.go.html#7552285">donec</a></span><span class="op" id="7552394">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552398">if</span>&nbsp;<span class="ident" id="7552401"><a href="/net/http/cgi/matryoshka_test.go.html#7552175">out</a></span><span class="op" id="7552404">.</span><span class="ident" id="7552405">Len</span><span class="op" id="7552408">(</span><span class="op" id="7552409">)</span>&nbsp;<span class="op" id="7552411">!=</span>&nbsp;<span class="ident" id="7552414"><a href="/net/http/cgi/matryoshka_test.go.html#7552199">writeLen</a></span>&nbsp;<span class="op" id="7552423">||</span>&nbsp;<span class="ident" id="7552426"><a href="/net/http/cgi/matryoshka_test.go.html#7552175">out</a></span><span class="op" id="7552429">.</span><span class="ident" id="7552430">Bytes</span><span class="op" id="7552435">(</span><span class="op" id="7552436">)</span><span class="op" id="7552437">[</span><span class="num" id="7552438">0</span><span class="op" id="7552439">]</span>&nbsp;<span class="op" id="7552441">!=</span>&nbsp;<span class="string" id="7552444">&#39;a&#39;</span>&nbsp;<span class="op" id="7552448">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552453"><a href="/net/http/cgi/matryoshka_test.go.html#7551719">t</a></span><span class="op" id="7552454">.</span><span class="ident" id="7552455">Errorf</span><span class="op" id="7552461">(</span><span class="string" id="7552462">&#34;unexpected&nbsp;output:&nbsp;%q&#34;</span><span class="op" id="7552485">,</span>&nbsp;<span class="ident" id="7552487"><a href="/net/http/cgi/matryoshka_test.go.html#7552175">out</a></span><span class="op" id="7552490">.</span><span class="ident" id="7552491">Bytes</span><span class="op" id="7552496">(</span><span class="op" id="7552497">)</span><span class="op" id="7552498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7552502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552505">case</span>&nbsp;<span class="op" id="7552510">&lt;-</span><span class="ident" id="7552512"><a href="/net/http/cgi/matryoshka_test.go.html#7549697">time</a></span><span class="op" id="7552516">.</span><span class="ident" id="7552517">After</span><span class="op" id="7552522">(</span><span class="num" id="7552523">5</span>&nbsp;<span class="op" id="7552525">*</span>&nbsp;<span class="ident" id="7552527"><a href="/net/http/cgi/matryoshka_test.go.html#7549697">time</a></span><span class="op" id="7552531">.</span><span class="ident" id="7552532">Second</span><span class="op" id="7552538">)</span><span class="op" id="7552539">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552543"><a href="/net/http/cgi/matryoshka_test.go.html#7551719">t</a></span><span class="op" id="7552544">.</span><span class="ident" id="7552545">Errorf</span><span class="op" id="7552551">(</span><span class="string" id="7552552">&#34;timeout.&nbsp;ServeHTTP&nbsp;hung&nbsp;and&nbsp;didn&#39;t&nbsp;kill&nbsp;the&nbsp;child&nbsp;process?&#34;</span><span class="op" id="7552612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552616">select</span>&nbsp;<span class="op" id="7552623">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552627">case</span>&nbsp;<span class="ident" id="7552632">p</span>&nbsp;<span class="op" id="7552634">:=</span>&nbsp;<span class="op" id="7552637">&lt;-</span><span class="ident" id="7552639"><a href="/net/http/cgi/matryoshka_test.go.html#7551845">proc</a></span><span class="op" id="7552643">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552648"><a href="/net/http/cgi/matryoshka_test.go.html#7552632">p</a></span><span class="op" id="7552649">.</span><span class="ident" id="7552650">Kill</span><span class="op" id="7552654">(</span><span class="op" id="7552655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552660"><a href="/net/http/cgi/matryoshka_test.go.html#7551719">t</a></span><span class="op" id="7552661">.</span><span class="ident" id="7552662">Logf</span><span class="op" id="7552666">(</span><span class="string" id="7552667">&#34;killed&nbsp;process&#34;</span><span class="op" id="7552683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552687">default</span><span class="op" id="7552694">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552699"><a href="/net/http/cgi/matryoshka_test.go.html#7551719">t</a></span><span class="op" id="7552700">.</span><span class="ident" id="7552701">Logf</span><span class="op" id="7552705">(</span><span class="string" id="7552706">&#34;didn&#39;t&nbsp;kill&nbsp;process&#34;</span><span class="op" id="7552727">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7552731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7552734">}</span><br>
<span class="lineno"></span><span class="op" id="7552736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7552739">//&nbsp;Test&nbsp;that&nbsp;a&nbsp;child&nbsp;handler&nbsp;writing&nbsp;only&nbsp;headers&nbsp;works.</span><br>
<span class="lineno">140</span><span class="comment" id="7552796">//&nbsp;golang.org/issue/7196</span><br>
<span class="lineno"></span><span class="keyword" id="7552821">func</span>&nbsp;<span class="ident" id="7552826">TestChildOnlyHeaders</span><span class="op" id="7552846">(</span><span class="ident" id="7552847">t</span>&nbsp;<span class="op" id="7552849">*</span><span class="ident" id="7552850"><a href="/net/http/cgi/matryoshka_test.go.html#7549686">testing</a></span><span class="op" id="7552857">.</span><span class="ident" id="7552858">T</span><span class="op" id="7552859">)</span>&nbsp;<span class="op" id="7552861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7552864">if</span>&nbsp;<span class="ident" id="7552867"><a href="/net/http/cgi/matryoshka_test.go.html#7549675">runtime</a></span><span class="op" id="7552874">.</span><span class="ident" id="7552875">GOOS</span>&nbsp;<span class="op" id="7552880">==</span>&nbsp;<span class="string" id="7552883">&#34;nacl&#34;</span>&nbsp;<span class="op" id="7552890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552894"><a href="/net/http/cgi/matryoshka_test.go.html#7552847">t</a></span><span class="op" id="7552895">.</span><span class="ident" id="7552896">Skip</span><span class="op" id="7552900">(</span><span class="string" id="7552901">&#34;skipping&nbsp;on&nbsp;nacl&#34;</span><span class="op" id="7552919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7552922">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552926">h</span>&nbsp;<span class="op" id="7552928">:=</span>&nbsp;<span class="op" id="7552931">&amp;</span><span class="ident" id="7552932"><a href="/net/http/cgi/host.go.html#5493520">Handler</a></span><span class="op" id="7552939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552943">Path</span><span class="op" id="7552947">:</span>&nbsp;<span class="ident" id="7552949"><a href="/net/http/cgi/matryoshka_test.go.html#7549669">os</a></span><span class="op" id="7552951">.</span><span class="ident" id="7552952">Args</span><span class="op" id="7552956">[</span><span class="num" id="7552957">0</span><span class="op" id="7552958">]</span><span class="op" id="7552959">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552963">Root</span><span class="op" id="7552967">:</span>&nbsp;<span class="string" id="7552969">&#34;/test.go&#34;</span><span class="op" id="7552979">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7552983">Args</span><span class="op" id="7552987">:</span>&nbsp;<span class="op" id="7552989">[</span><span class="op" id="7552990">]</span><span class="builtintype" id="7552991">string</span><span class="op" id="7552997">{</span><span class="string" id="7552998">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7553031">}</span><span class="op" id="7553032">,</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7553035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553038">expectedMap</span>&nbsp;<span class="op" id="7553050">:=</span>&nbsp;<span class="keyword" id="7553053">map</span><span class="op" id="7553056">[</span><span class="builtintype" id="7553057">string</span><span class="op" id="7553063">]</span><span class="builtintype" id="7553064">string</span><span class="op" id="7553070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7553074">&#34;_body&#34;</span><span class="op" id="7553081">:</span>&nbsp;<span class="string" id="7553083">&#34;&#34;</span><span class="op" id="7553085">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7553088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553091">replay</span>&nbsp;<span class="op" id="7553098">:=</span>&nbsp;<span class="ident" id="7553101"><a href="/net/http/cgi/host_test.go.html#7538217">runCgiTest</a></span><span class="op" id="7553111">(</span><span class="ident" id="7553112"><a href="/net/http/cgi/matryoshka_test.go.html#7552847">t</a></span><span class="op" id="7553113">,</span>&nbsp;<span class="ident" id="7553115"><a href="/net/http/cgi/matryoshka_test.go.html#7552926">h</a></span><span class="op" id="7553116">,</span>&nbsp;<span class="string" id="7553118">&#34;GET&nbsp;/test.go?no-body=1&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7553174">,</span>&nbsp;<span class="ident" id="7553176"><a href="/net/http/cgi/matryoshka_test.go.html#7553038">expectedMap</a></span><span class="op" id="7553187">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7553190">if</span>&nbsp;<span class="ident" id="7553193">expected</span><span class="op" id="7553201">,</span>&nbsp;<span class="ident" id="7553203">got</span>&nbsp;<span class="op" id="7553207">:=</span>&nbsp;<span class="string" id="7553210">&#34;X-Test-Value&#34;</span><span class="op" id="7553224">,</span>&nbsp;<span class="ident" id="7553226"><a href="/net/http/cgi/matryoshka_test.go.html#7553091">replay</a></span><span class="op" id="7553232">.</span><span class="ident" id="7553233">Header</span><span class="op" id="7553239">(</span><span class="op" id="7553240">)</span><span class="op" id="7553241">.</span><span class="ident" id="7553242">Get</span><span class="op" id="7553245">(</span><span class="string" id="7553246">&#34;X-Test-Header&#34;</span><span class="op" id="7553261">)</span><span class="op" id="7553262">;</span>&nbsp;<span class="ident" id="7553264"><a href="/net/http/cgi/matryoshka_test.go.html#7553203">got</a></span>&nbsp;<span class="op" id="7553268">!=</span>&nbsp;<span class="ident" id="7553271"><a href="/net/http/cgi/matryoshka_test.go.html#7553193">expected</a></span>&nbsp;<span class="op" id="7553280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553284"><a href="/net/http/cgi/matryoshka_test.go.html#7552847">t</a></span><span class="op" id="7553285">.</span><span class="ident" id="7553286">Errorf</span><span class="op" id="7553292">(</span><span class="string" id="7553293">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="7553333">,</span>&nbsp;<span class="ident" id="7553335"><a href="/net/http/cgi/matryoshka_test.go.html#7553203">got</a></span><span class="op" id="7553338">,</span>&nbsp;<span class="ident" id="7553340"><a href="/net/http/cgi/matryoshka_test.go.html#7553193">expected</a></span><span class="op" id="7553348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7553351">}</span><br>
<span class="lineno"></span><span class="op" id="7553353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="7553356">//&nbsp;golang.org/issue/7198</span><br>
<span class="lineno"></span><span class="keyword" id="7553381">func</span>&nbsp;<span class="ident" id="7553386">Test500WithNoHeaders</span><span class="op" id="7553406">(</span><span class="ident" id="7553407">t</span>&nbsp;<span class="op" id="7553409">*</span><span class="ident" id="7553410"><a href="/net/http/cgi/matryoshka_test.go.html#7549686">testing</a></span><span class="op" id="7553417">.</span><span class="ident" id="7553418">T</span><span class="op" id="7553419">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7553425">{</span>&nbsp;<span class="ident" id="7553427"><a href="/net/http/cgi/matryoshka_test.go.html#7553639">want500Test</a></span><span class="op" id="7553438">(</span><span class="ident" id="7553439"><a href="/net/http/cgi/matryoshka_test.go.html#7553407">t</a></span><span class="op" id="7553440">,</span>&nbsp;<span class="string" id="7553442">&#34;/immediate-disconnect&#34;</span><span class="op" id="7553465">)</span>&nbsp;<span class="op" id="7553467">}</span><br>
<span class="lineno"></span><span class="keyword" id="7553469">func</span>&nbsp;<span class="ident" id="7553474">Test500WithNoContentType</span><span class="op" id="7553498">(</span><span class="ident" id="7553499">t</span>&nbsp;<span class="op" id="7553501">*</span><span class="ident" id="7553502"><a href="/net/http/cgi/matryoshka_test.go.html#7549686">testing</a></span><span class="op" id="7553509">.</span><span class="ident" id="7553510">T</span><span class="op" id="7553511">)</span>&nbsp;<span class="op" id="7553513">{</span>&nbsp;<span class="ident" id="7553515"><a href="/net/http/cgi/matryoshka_test.go.html#7553639">want500Test</a></span><span class="op" id="7553526">(</span><span class="ident" id="7553527"><a href="/net/http/cgi/matryoshka_test.go.html#7553499">t</a></span><span class="op" id="7553528">,</span>&nbsp;<span class="string" id="7553530">&#34;/no-content-type&#34;</span><span class="op" id="7553548">)</span>&nbsp;<span class="op" id="7553550">}</span><br>
<span class="lineno"></span><span class="keyword" id="7553552">func</span>&nbsp;<span class="ident" id="7553557">Test500WithEmptyHeaders</span><span class="op" id="7553580">(</span><span class="ident" id="7553581">t</span>&nbsp;<span class="op" id="7553583">*</span><span class="ident" id="7553584"><a href="/net/http/cgi/matryoshka_test.go.html#7549686">testing</a></span><span class="op" id="7553591">.</span><span class="ident" id="7553592">T</span><span class="op" id="7553593">)</span>&nbsp;&nbsp;<span class="op" id="7553596">{</span>&nbsp;<span class="ident" id="7553598"><a href="/net/http/cgi/matryoshka_test.go.html#7553639">want500Test</a></span><span class="op" id="7553609">(</span><span class="ident" id="7553610"><a href="/net/http/cgi/matryoshka_test.go.html#7553581">t</a></span><span class="op" id="7553611">,</span>&nbsp;<span class="string" id="7553613">&#34;/empty-headers&#34;</span><span class="op" id="7553629">)</span>&nbsp;<span class="op" id="7553631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="7553634">func</span>&nbsp;<span class="ident" id="7553639">want500Test</span><span class="op" id="7553650">(</span><span class="ident" id="7553651">t</span>&nbsp;<span class="op" id="7553653">*</span><span class="ident" id="7553654"><a href="/net/http/cgi/matryoshka_test.go.html#7549686">testing</a></span><span class="op" id="7553661">.</span><span class="ident" id="7553662">T</span><span class="op" id="7553663">,</span>&nbsp;<span class="ident" id="7553665">path</span>&nbsp;<span class="builtintype" id="7553670">string</span><span class="op" id="7553676">)</span>&nbsp;<span class="op" id="7553678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553681">h</span>&nbsp;<span class="op" id="7553683">:=</span>&nbsp;<span class="op" id="7553686">&amp;</span><span class="ident" id="7553687"><a href="/net/http/cgi/host.go.html#5493520">Handler</a></span><span class="op" id="7553694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553698">Path</span><span class="op" id="7553702">:</span>&nbsp;<span class="ident" id="7553704"><a href="/net/http/cgi/matryoshka_test.go.html#7549669">os</a></span><span class="op" id="7553706">.</span><span class="ident" id="7553707">Args</span><span class="op" id="7553711">[</span><span class="num" id="7553712">0</span><span class="op" id="7553713">]</span><span class="op" id="7553714">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553718">Root</span><span class="op" id="7553722">:</span>&nbsp;<span class="string" id="7553724">&#34;/test.go&#34;</span><span class="op" id="7553734">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553738">Args</span><span class="op" id="7553742">:</span>&nbsp;<span class="op" id="7553744">[</span><span class="op" id="7553745">]</span><span class="builtintype" id="7553746">string</span><span class="op" id="7553752">{</span><span class="string" id="7553753">&#34;-test.run=TestBeChildCGIProcess&#34;</span><span class="op" id="7553786">}</span><span class="op" id="7553787">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7553790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553793">expectedMap</span>&nbsp;<span class="op" id="7553805">:=</span>&nbsp;<span class="keyword" id="7553808">map</span><span class="op" id="7553811">[</span><span class="builtintype" id="7553812">string</span><span class="op" id="7553818">]</span><span class="builtintype" id="7553819">string</span><span class="op" id="7553825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7553829">&#34;_body&#34;</span><span class="op" id="7553836">:</span>&nbsp;<span class="string" id="7553838">&#34;&#34;</span><span class="op" id="7553840">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7553843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553846">replay</span>&nbsp;<span class="op" id="7553853">:=</span>&nbsp;<span class="ident" id="7553856"><a href="/net/http/cgi/host_test.go.html#7538217">runCgiTest</a></span><span class="op" id="7553866">(</span><span class="ident" id="7553867"><a href="/net/http/cgi/matryoshka_test.go.html#7553651">t</a></span><span class="op" id="7553868">,</span>&nbsp;<span class="ident" id="7553870"><a href="/net/http/cgi/matryoshka_test.go.html#7553681">h</a></span><span class="op" id="7553871">,</span>&nbsp;<span class="string" id="7553873">&#34;GET&nbsp;&#34;</span><span class="op" id="7553879">+</span><span class="ident" id="7553880"><a href="/net/http/cgi/matryoshka_test.go.html#7553665">path</a></span><span class="op" id="7553884">+</span><span class="string" id="7553885">&#34;&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="7553919">,</span>&nbsp;<span class="ident" id="7553921"><a href="/net/http/cgi/matryoshka_test.go.html#7553793">expectedMap</a></span><span class="op" id="7553932">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7553935">if</span>&nbsp;<span class="ident" id="7553938"><a href="/net/http/cgi/matryoshka_test.go.html#7553846">replay</a></span><span class="op" id="7553944">.</span><span class="ident" id="7553945">Code</span>&nbsp;<span class="op" id="7553950">!=</span>&nbsp;<span class="num" id="7553953">500</span>&nbsp;<span class="op" id="7553957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7553961"><a href="/net/http/cgi/matryoshka_test.go.html#7553651">t</a></span><span class="op" id="7553962">.</span><span class="ident" id="7553963">Errorf</span><span class="op" id="7553969">(</span><span class="string" id="7553970">&#34;Got&nbsp;code&nbsp;%d;&nbsp;want&nbsp;500&#34;</span><span class="op" id="7553993">,</span>&nbsp;<span class="ident" id="7553995"><a href="/net/http/cgi/matryoshka_test.go.html#7553846">replay</a></span><span class="op" id="7554001">.</span><span class="ident" id="7554002">Code</span><span class="op" id="7554006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7554009">}</span><br>
<span class="lineno"></span><span class="op" id="7554011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="7554014">type</span>&nbsp;<span class="ident" id="7554019">neverEnding</span>&nbsp;<span class="builtintype" id="7554031">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7554037">func</span>&nbsp;<span class="op" id="7554042">(</span><span class="ident" id="7554043">b</span>&nbsp;<span class="ident" id="7554045"><a href="/net/http/cgi/matryoshka_test.go.html#7554019">neverEnding</a></span><span class="op" id="7554056">)</span>&nbsp;<span class="ident" id="7554058">Read</span><span class="op" id="7554062">(</span><span class="ident" id="7554063">p</span>&nbsp;<span class="op" id="7554065">[</span><span class="op" id="7554066">]</span><span class="builtintype" id="7554067">byte</span><span class="op" id="7554071">)</span>&nbsp;<span class="op" id="7554073">(</span><span class="ident" id="7554074">n</span>&nbsp;<span class="builtintype" id="7554076">int</span><span class="op" id="7554079">,</span>&nbsp;<span class="ident" id="7554081">err</span>&nbsp;<span class="builtintype" id="7554085">error</span><span class="op" id="7554090">)</span>&nbsp;<span class="op" id="7554092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554095">for</span>&nbsp;<span class="ident" id="7554099">i</span>&nbsp;<span class="op" id="7554101">:=</span>&nbsp;<span class="keyword" id="7554104">range</span>&nbsp;<span class="ident" id="7554110"><a href="/net/http/cgi/matryoshka_test.go.html#7554063">p</a></span>&nbsp;<span class="op" id="7554112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554116"><a href="/net/http/cgi/matryoshka_test.go.html#7554063">p</a></span><span class="op" id="7554117">[</span><span class="ident" id="7554118"><a href="/net/http/cgi/matryoshka_test.go.html#7554099">i</a></span><span class="op" id="7554119">]</span>&nbsp;<span class="op" id="7554121">=</span>&nbsp;<span class="builtintype" id="7554123">byte</span><span class="op" id="7554127">(</span><span class="ident" id="7554128"><a href="/net/http/cgi/matryoshka_test.go.html#7554043">b</a></span><span class="op" id="7554129">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7554132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554135">return</span>&nbsp;<span class="builtinfunc" id="7554142">len</span><span class="op" id="7554145">(</span><span class="ident" id="7554146"><a href="/net/http/cgi/matryoshka_test.go.html#7554063">p</a></span><span class="op" id="7554147">)</span><span class="op" id="7554148">,</span>&nbsp;<span class="ident" id="7554150">nil</span><br>
<span class="lineno"></span><span class="op" id="7554154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7554157">//&nbsp;Note:&nbsp;not&nbsp;actually&nbsp;a&nbsp;test.</span><br>
<span class="lineno">190</span><span class="keyword" id="7554187">func</span>&nbsp;<span class="ident" id="7554192">TestBeChildCGIProcess</span><span class="op" id="7554213">(</span><span class="ident" id="7554214">t</span>&nbsp;<span class="op" id="7554216">*</span><span class="ident" id="7554217"><a href="/net/http/cgi/matryoshka_test.go.html#7549686">testing</a></span><span class="op" id="7554224">.</span><span class="ident" id="7554225">T</span><span class="op" id="7554226">)</span>&nbsp;<span class="op" id="7554228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554231">if</span>&nbsp;<span class="ident" id="7554234"><a href="/net/http/cgi/matryoshka_test.go.html#7549669">os</a></span><span class="op" id="7554236">.</span><span class="ident" id="7554237">Getenv</span><span class="op" id="7554243">(</span><span class="string" id="7554244">&#34;REQUEST_METHOD&#34;</span><span class="op" id="7554260">)</span>&nbsp;<span class="op" id="7554262">==</span>&nbsp;<span class="string" id="7554265">&#34;&#34;</span>&nbsp;<span class="op" id="7554268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7554272">//&nbsp;Not&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment;&nbsp;skipping&nbsp;test.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554318">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7554326">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554329">switch</span>&nbsp;<span class="ident" id="7554336"><a href="/net/http/cgi/matryoshka_test.go.html#7549669">os</a></span><span class="op" id="7554338">.</span><span class="ident" id="7554339">Getenv</span><span class="op" id="7554345">(</span><span class="string" id="7554346">&#34;REQUEST_URI&#34;</span><span class="op" id="7554359">)</span>&nbsp;<span class="op" id="7554361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554364">case</span>&nbsp;<span class="string" id="7554369">&#34;/immediate-disconnect&#34;</span><span class="op" id="7554392">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554396"><a href="/net/http/cgi/matryoshka_test.go.html#7549669">os</a></span><span class="op" id="7554398">.</span><span class="ident" id="7554399">Exit</span><span class="op" id="7554403">(</span><span class="num" id="7554404">0</span><span class="op" id="7554405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554408">case</span>&nbsp;<span class="string" id="7554413">&#34;/no-content-type&#34;</span><span class="op" id="7554431">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554435"><a href="/net/http/cgi/matryoshka_test.go.html#7549623">fmt</a></span><span class="op" id="7554438">.</span><span class="ident" id="7554439">Printf</span><span class="op" id="7554445">(</span><span class="string" id="7554446">&#34;Content-Length:&nbsp;6\n\nHello\n&#34;</span><span class="op" id="7554476">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554480"><a href="/net/http/cgi/matryoshka_test.go.html#7549669">os</a></span><span class="op" id="7554482">.</span><span class="ident" id="7554483">Exit</span><span class="op" id="7554487">(</span><span class="num" id="7554488">0</span><span class="op" id="7554489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554492">case</span>&nbsp;<span class="string" id="7554497">&#34;/empty-headers&#34;</span><span class="op" id="7554513">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554517"><a href="/net/http/cgi/matryoshka_test.go.html#7549623">fmt</a></span><span class="op" id="7554520">.</span><span class="ident" id="7554521">Printf</span><span class="op" id="7554527">(</span><span class="string" id="7554528">&#34;\nHello&#34;</span><span class="op" id="7554537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554541"><a href="/net/http/cgi/matryoshka_test.go.html#7549669">os</a></span><span class="op" id="7554543">.</span><span class="ident" id="7554544">Exit</span><span class="op" id="7554548">(</span><span class="num" id="7554549">0</span><span class="op" id="7554550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7554553">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554556"><a href="/net/http/cgi/child.go.html#5490929">Serve</a></span><span class="op" id="7554561">(</span><span class="ident" id="7554562"><a href="/net/http/cgi/matryoshka_test.go.html#7549636">http</a></span><span class="op" id="7554566">.</span><span class="ident" id="7554567">HandlerFunc</span><span class="op" id="7554578">(</span><span class="keyword" id="7554579">func</span><span class="op" id="7554583">(</span><span class="ident" id="7554584">rw</span>&nbsp;<span class="ident" id="7554587"><a href="/net/http/cgi/matryoshka_test.go.html#7549636">http</a></span><span class="op" id="7554591">.</span><span class="ident" id="7554592">ResponseWriter</span><span class="op" id="7554606">,</span>&nbsp;<span class="ident" id="7554608">req</span>&nbsp;<span class="op" id="7554612">*</span><span class="ident" id="7554613"><a href="/net/http/cgi/matryoshka_test.go.html#7549636">http</a></span><span class="op" id="7554617">.</span><span class="ident" id="7554618">Request</span><span class="op" id="7554625">)</span>&nbsp;<span class="op" id="7554627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554631"><a href="/net/http/cgi/matryoshka_test.go.html#7554584">rw</a></span><span class="op" id="7554633">.</span><span class="ident" id="7554634">Header</span><span class="op" id="7554640">(</span><span class="op" id="7554641">)</span><span class="op" id="7554642">.</span><span class="ident" id="7554643">Set</span><span class="op" id="7554646">(</span><span class="string" id="7554647">&#34;X-Test-Header&#34;</span><span class="op" id="7554662">,</span>&nbsp;<span class="string" id="7554664">&#34;X-Test-Value&#34;</span><span class="op" id="7554678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554682"><a href="/net/http/cgi/matryoshka_test.go.html#7554608">req</a></span><span class="op" id="7554685">.</span><span class="ident" id="7554686">ParseForm</span><span class="op" id="7554695">(</span><span class="op" id="7554696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554700">if</span>&nbsp;<span class="ident" id="7554703"><a href="/net/http/cgi/matryoshka_test.go.html#7554608">req</a></span><span class="op" id="7554706">.</span><span class="ident" id="7554707">FormValue</span><span class="op" id="7554716">(</span><span class="string" id="7554717">&#34;no-body&#34;</span><span class="op" id="7554726">)</span>&nbsp;<span class="op" id="7554728">==</span>&nbsp;<span class="string" id="7554731">&#34;1&#34;</span>&nbsp;<span class="op" id="7554735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554740">return</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7554749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554753">if</span>&nbsp;<span class="ident" id="7554756"><a href="/net/http/cgi/matryoshka_test.go.html#7554608">req</a></span><span class="op" id="7554759">.</span><span class="ident" id="7554760">FormValue</span><span class="op" id="7554769">(</span><span class="string" id="7554770">&#34;write-forever&#34;</span><span class="op" id="7554785">)</span>&nbsp;<span class="op" id="7554787">==</span>&nbsp;<span class="string" id="7554790">&#34;1&#34;</span>&nbsp;<span class="op" id="7554794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554799"><a href="/net/http/cgi/matryoshka_test.go.html#7549630">io</a></span><span class="op" id="7554801">.</span><span class="ident" id="7554802">Copy</span><span class="op" id="7554806">(</span><span class="ident" id="7554807"><a href="/net/http/cgi/matryoshka_test.go.html#7554584">rw</a></span><span class="op" id="7554809">,</span>&nbsp;<span class="ident" id="7554811"><a href="/net/http/cgi/matryoshka_test.go.html#7554019">neverEnding</a></span><span class="op" id="7554822">(</span><span class="string" id="7554823">&#39;a&#39;</span><span class="op" id="7554826">)</span><span class="op" id="7554827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554832">for</span>&nbsp;<span class="op" id="7554836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554842"><a href="/net/http/cgi/matryoshka_test.go.html#7549697">time</a></span><span class="op" id="7554846">.</span><span class="ident" id="7554847">Sleep</span><span class="op" id="7554852">(</span><span class="num" id="7554853">5</span>&nbsp;<span class="op" id="7554855">*</span>&nbsp;<span class="ident" id="7554857"><a href="/net/http/cgi/matryoshka_test.go.html#7549697">time</a></span><span class="op" id="7554861">.</span><span class="ident" id="7554862">Second</span><span class="op" id="7554868">)</span>&nbsp;<span class="comment" id="7554870">//&nbsp;hang&nbsp;forever,&nbsp;until&nbsp;killed</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7554903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7554907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7554911"><a href="/net/http/cgi/matryoshka_test.go.html#7549623">fmt</a></span><span class="op" id="7554914">.</span><span class="ident" id="7554915">Fprintf</span><span class="op" id="7554922">(</span><span class="ident" id="7554923"><a href="/net/http/cgi/matryoshka_test.go.html#7554584">rw</a></span><span class="op" id="7554925">,</span>&nbsp;<span class="string" id="7554927">&#34;test=Hello&nbsp;CGI-in-CGI\n&#34;</span><span class="op" id="7554952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554956">for</span>&nbsp;<span class="ident" id="7554960">k</span><span class="op" id="7554961">,</span>&nbsp;<span class="ident" id="7554963">vv</span>&nbsp;<span class="op" id="7554966">:=</span>&nbsp;<span class="keyword" id="7554969">range</span>&nbsp;<span class="ident" id="7554975"><a href="/net/http/cgi/matryoshka_test.go.html#7554608">req</a></span><span class="op" id="7554978">.</span><span class="ident" id="7554979">Form</span>&nbsp;<span class="op" id="7554984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7554989">for</span>&nbsp;<span class="ident" id="7554993">_</span><span class="op" id="7554994">,</span>&nbsp;<span class="ident" id="7554996">v</span>&nbsp;<span class="op" id="7554998">:=</span>&nbsp;<span class="keyword" id="7555001">range</span>&nbsp;<span class="ident" id="7555007"><a href="/net/http/cgi/matryoshka_test.go.html#7554963">vv</a></span>&nbsp;<span class="op" id="7555010">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7555016"><a href="/net/http/cgi/matryoshka_test.go.html#7549623">fmt</a></span><span class="op" id="7555019">.</span><span class="ident" id="7555020">Fprintf</span><span class="op" id="7555027">(</span><span class="ident" id="7555028"><a href="/net/http/cgi/matryoshka_test.go.html#7554584">rw</a></span><span class="op" id="7555030">,</span>&nbsp;<span class="string" id="7555032">&#34;param-%s=%s\n&#34;</span><span class="op" id="7555047">,</span>&nbsp;<span class="ident" id="7555049"><a href="/net/http/cgi/matryoshka_test.go.html#7554960">k</a></span><span class="op" id="7555050">,</span>&nbsp;<span class="ident" id="7555052"><a href="/net/http/cgi/matryoshka_test.go.html#7554996">v</a></span><span class="op" id="7555053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7555058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7555062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7555066">for</span>&nbsp;<span class="ident" id="7555070">_</span><span class="op" id="7555071">,</span>&nbsp;<span class="ident" id="7555073">kv</span>&nbsp;<span class="op" id="7555076">:=</span>&nbsp;<span class="keyword" id="7555079">range</span>&nbsp;<span class="ident" id="7555085"><a href="/net/http/cgi/matryoshka_test.go.html#7549669">os</a></span><span class="op" id="7555087">.</span><span class="ident" id="7555088">Environ</span><span class="op" id="7555095">(</span><span class="op" id="7555096">)</span>&nbsp;<span class="op" id="7555098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7555103"><a href="/net/http/cgi/matryoshka_test.go.html#7549623">fmt</a></span><span class="op" id="7555106">.</span><span class="ident" id="7555107">Fprintf</span><span class="op" id="7555114">(</span><span class="ident" id="7555115"><a href="/net/http/cgi/matryoshka_test.go.html#7554584">rw</a></span><span class="op" id="7555117">,</span>&nbsp;<span class="string" id="7555119">&#34;env-%s\n&#34;</span><span class="op" id="7555129">,</span>&nbsp;<span class="ident" id="7555131"><a href="/net/http/cgi/matryoshka_test.go.html#7555073">kv</a></span><span class="op" id="7555133">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7555137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7555140">}</span><span class="op" id="7555141">)</span><span class="op" id="7555142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7555145"><a href="/net/http/cgi/matryoshka_test.go.html#7549669">os</a></span><span class="op" id="7555147">.</span><span class="ident" id="7555148">Exit</span><span class="op" id="7555152">(</span><span class="num" id="7555153">0</span><span class="op" id="7555154">)</span><br>
<span class="lineno"></span><span class="op" id="7555156">}</span>
</div>
</body>
</html>
