<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/lzw</h2>
<ul>
<li><a href="/gostd/compress/lzw/reader.go.html">reader.go</a></li>
<li><a href="/gostd/compress/lzw/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/lzw/writer.go.html" class="current">writer.go</a></li>
<li><a href="/gostd/compress/lzw/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6209515">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6209570">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6209624">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6209675">package</span>&nbsp;<span class="ident" id="6209683">lzw</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6209688">import</span>&nbsp;<span class="op" id="6209695">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6209698">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6209707">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6209717">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6209724">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="6209729">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6209732">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered,&nbsp;flushable&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="keyword" id="6209777">type</span>&nbsp;<span class="ident" id="6209782">writer</span>&nbsp;<span class="keyword" id="6209789">interface</span>&nbsp;<span class="op" id="6209799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6209802">io</span><span class="op" id="6209804">.</span><span class="ident" id="6209805">ByteWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6209817">Flush</span><span class="op" id="6209822">(</span><span class="op" id="6209823">)</span>&nbsp;<span class="builtintype" id="6209825">error</span><br>
<span class="lineno"></span><span class="op" id="6209831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="6209834">//&nbsp;An&nbsp;errWriteCloser&nbsp;is&nbsp;an&nbsp;io.WriteCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;a&nbsp;given&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="6209911">type</span>&nbsp;<span class="ident" id="6209916">errWriteCloser</span>&nbsp;<span class="keyword" id="6209931">struct</span>&nbsp;<span class="op" id="6209938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6209941">err</span>&nbsp;<span class="builtintype" id="6209945">error</span><br>
<span class="lineno"></span><span class="op" id="6209951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="6209954">func</span>&nbsp;<span class="op" id="6209959">(</span><span class="ident" id="6209960">e</span>&nbsp;<span class="op" id="6209962">*</span><span class="ident" id="6209963">errWriteCloser</span><span class="op" id="6209977">)</span>&nbsp;<span class="ident" id="6209979">Write</span><span class="op" id="6209984">(</span><span class="op" id="6209985">[</span><span class="op" id="6209986">]</span><span class="builtintype" id="6209987">byte</span><span class="op" id="6209991">)</span>&nbsp;<span class="op" id="6209993">(</span><span class="builtintype" id="6209994">int</span><span class="op" id="6209997">,</span>&nbsp;<span class="builtintype" id="6209999">error</span><span class="op" id="6210004">)</span>&nbsp;<span class="op" id="6210006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6210009">return</span>&nbsp;<span class="num" id="6210016">0</span><span class="op" id="6210017">,</span>&nbsp;<span class="ident" id="6210019">e</span><span class="op" id="6210020">.</span><span class="ident" id="6210021">err</span><br>
<span class="lineno"></span><span class="op" id="6210025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6210028">func</span>&nbsp;<span class="op" id="6210033">(</span><span class="ident" id="6210034">e</span>&nbsp;<span class="op" id="6210036">*</span><span class="ident" id="6210037">errWriteCloser</span><span class="op" id="6210051">)</span>&nbsp;<span class="ident" id="6210053">Close</span><span class="op" id="6210058">(</span><span class="op" id="6210059">)</span>&nbsp;<span class="builtintype" id="6210061">error</span>&nbsp;<span class="op" id="6210067">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6210070">return</span>&nbsp;<span class="ident" id="6210077">e</span><span class="op" id="6210078">.</span><span class="ident" id="6210079">err</span><br>
<span class="lineno"></span><span class="op" id="6210083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6210086">const</span>&nbsp;<span class="op" id="6210092">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6210095">//&nbsp;A&nbsp;code&nbsp;is&nbsp;a&nbsp;12&nbsp;bit&nbsp;value,&nbsp;stored&nbsp;as&nbsp;a&nbsp;uint32&nbsp;when&nbsp;encoding&nbsp;to&nbsp;avoid</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6210167">//&nbsp;type&nbsp;conversions&nbsp;when&nbsp;shifting&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6210208">maxCode</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6210220">=</span>&nbsp;<span class="num" id="6210222">1</span><span class="op" id="6210223">&lt;&lt;</span><span class="num" id="6210225">12</span>&nbsp;<span class="op" id="6210228">-</span>&nbsp;<span class="num" id="6210230">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6210233">invalidCode</span>&nbsp;<span class="op" id="6210245">=</span>&nbsp;<span class="num" id="6210247">1</span><span class="op" id="6210248">&lt;&lt;</span><span class="num" id="6210250">32</span>&nbsp;<span class="op" id="6210253">-</span>&nbsp;<span class="num" id="6210255">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6210258">//&nbsp;There&nbsp;are&nbsp;1&lt;&lt;12&nbsp;possible&nbsp;codes,&nbsp;which&nbsp;is&nbsp;an&nbsp;upper&nbsp;bound&nbsp;on&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6210335">//&nbsp;valid&nbsp;hash&nbsp;table&nbsp;entries&nbsp;at&nbsp;any&nbsp;given&nbsp;point&nbsp;in&nbsp;time.&nbsp;tableSize&nbsp;is&nbsp;4x&nbsp;that.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6210414">tableSize</span>&nbsp;<span class="op" id="6210424">=</span>&nbsp;<span class="num" id="6210426">4</span>&nbsp;<span class="op" id="6210428">*</span>&nbsp;<span class="num" id="6210430">1</span>&nbsp;<span class="op" id="6210432">&lt;&lt;</span>&nbsp;<span class="num" id="6210435">12</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6210439">tableMask</span>&nbsp;<span class="op" id="6210449">=</span>&nbsp;<span class="ident" id="6210451">tableSize</span>&nbsp;<span class="op" id="6210461">-</span>&nbsp;<span class="num" id="6210463">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6210466">//&nbsp;A&nbsp;hash&nbsp;table&nbsp;entry&nbsp;is&nbsp;a&nbsp;uint32.&nbsp;Zero&nbsp;is&nbsp;an&nbsp;invalid&nbsp;entry&nbsp;since&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6210537">//&nbsp;lower&nbsp;12&nbsp;bits&nbsp;of&nbsp;a&nbsp;valid&nbsp;entry&nbsp;must&nbsp;be&nbsp;a&nbsp;non-literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6210600">invalidEntry</span>&nbsp;<span class="op" id="6210613">=</span>&nbsp;<span class="num" id="6210615">0</span><br>
<span class="lineno">45</span><span class="op" id="6210617">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6210620">//&nbsp;encoder&nbsp;is&nbsp;LZW&nbsp;compressor.</span><br>
<span class="lineno"></span><span class="keyword" id="6210650">type</span>&nbsp;<span class="ident" id="6210655">encoder</span>&nbsp;<span class="keyword" id="6210663">struct</span>&nbsp;<span class="op" id="6210670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6210673">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;that&nbsp;compressed&nbsp;bytes&nbsp;are&nbsp;written&nbsp;to.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6210731">w</span>&nbsp;<span class="ident" id="6210733">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6210741">//&nbsp;order,&nbsp;write,&nbsp;bits,&nbsp;nBits&nbsp;and&nbsp;width&nbsp;are&nbsp;the&nbsp;state&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6210799">//&nbsp;converting&nbsp;a&nbsp;code&nbsp;stream&nbsp;into&nbsp;a&nbsp;byte&nbsp;stream.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6210848">order</span>&nbsp;<span class="ident" id="6210854">Order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6210861">write</span>&nbsp;<span class="keyword" id="6210867">func</span><span class="op" id="6210871">(</span><span class="op" id="6210872">*</span><span class="ident" id="6210873">encoder</span><span class="op" id="6210880">,</span>&nbsp;<span class="builtintype" id="6210882">uint32</span><span class="op" id="6210888">)</span>&nbsp;<span class="builtintype" id="6210890">error</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6210897">bits</span>&nbsp;&nbsp;<span class="builtintype" id="6210903">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6210911">nBits</span>&nbsp;<span class="builtintype" id="6210917">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6210923">width</span>&nbsp;<span class="builtintype" id="6210929">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6210935">//&nbsp;litWidth&nbsp;is&nbsp;the&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6210987">litWidth</span>&nbsp;<span class="builtintype" id="6210996">uint</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6211002">//&nbsp;hi&nbsp;is&nbsp;the&nbsp;code&nbsp;implied&nbsp;by&nbsp;the&nbsp;next&nbsp;code&nbsp;emission.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6211056">//&nbsp;overflow&nbsp;is&nbsp;the&nbsp;code&nbsp;at&nbsp;which&nbsp;hi&nbsp;overflows&nbsp;the&nbsp;code&nbsp;width.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6211119">hi</span><span class="op" id="6211121">,</span>&nbsp;<span class="ident" id="6211123">overflow</span>&nbsp;<span class="builtintype" id="6211132">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6211140">//&nbsp;savedCode&nbsp;is&nbsp;the&nbsp;accumulated&nbsp;code&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;most&nbsp;recent&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6211214">//&nbsp;call.&nbsp;It&nbsp;is&nbsp;equal&nbsp;to&nbsp;invalidCode&nbsp;if&nbsp;there&nbsp;was&nbsp;no&nbsp;such&nbsp;call.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6211278">savedCode</span>&nbsp;<span class="builtintype" id="6211288">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6211296">//&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during&nbsp;writing.&nbsp;Closing&nbsp;the&nbsp;encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6211371">//&nbsp;will&nbsp;make&nbsp;any&nbsp;future&nbsp;Write&nbsp;calls&nbsp;return&nbsp;errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6211425">err</span>&nbsp;<span class="builtintype" id="6211429">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6211436">//&nbsp;table&nbsp;is&nbsp;the&nbsp;hash&nbsp;table&nbsp;from&nbsp;20-bit&nbsp;keys&nbsp;to&nbsp;12-bit&nbsp;values.&nbsp;Each&nbsp;table</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6211510">//&nbsp;entry&nbsp;contains&nbsp;key&lt;&lt;12|val&nbsp;and&nbsp;collisions&nbsp;resolve&nbsp;by&nbsp;linear&nbsp;probing.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6211583">//&nbsp;The&nbsp;keys&nbsp;consist&nbsp;of&nbsp;a&nbsp;12-bit&nbsp;code&nbsp;prefix&nbsp;and&nbsp;an&nbsp;8-bit&nbsp;byte&nbsp;suffix.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6211654">//&nbsp;The&nbsp;values&nbsp;are&nbsp;a&nbsp;12-bit&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6211688">table</span>&nbsp;<span class="op" id="6211694">[</span><span class="ident" id="6211695">tableSize</span><span class="op" id="6211704">]</span><span class="builtintype" id="6211705">uint32</span><br>
<span class="lineno"></span><span class="op" id="6211712">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="6211715">//&nbsp;writeLSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Least&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="6211786">func</span>&nbsp;<span class="op" id="6211791">(</span><span class="ident" id="6211792">e</span>&nbsp;<span class="op" id="6211794">*</span><span class="ident" id="6211795">encoder</span><span class="op" id="6211802">)</span>&nbsp;<span class="ident" id="6211804">writeLSB</span><span class="op" id="6211812">(</span><span class="ident" id="6211813">c</span>&nbsp;<span class="builtintype" id="6211815">uint32</span><span class="op" id="6211821">)</span>&nbsp;<span class="builtintype" id="6211823">error</span>&nbsp;<span class="op" id="6211829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6211832">e</span><span class="op" id="6211833">.</span><span class="ident" id="6211834">bits</span>&nbsp;<span class="op" id="6211839">|=</span>&nbsp;<span class="ident" id="6211842">c</span>&nbsp;<span class="op" id="6211844">&lt;&lt;</span>&nbsp;<span class="ident" id="6211847">e</span><span class="op" id="6211848">.</span><span class="ident" id="6211849">nBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6211856">e</span><span class="op" id="6211857">.</span><span class="ident" id="6211858">nBits</span>&nbsp;<span class="op" id="6211864">+=</span>&nbsp;<span class="ident" id="6211867">e</span><span class="op" id="6211868">.</span><span class="ident" id="6211869">width</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6211876">for</span>&nbsp;<span class="ident" id="6211880">e</span><span class="op" id="6211881">.</span><span class="ident" id="6211882">nBits</span>&nbsp;<span class="op" id="6211888">&gt;=</span>&nbsp;<span class="num" id="6211891">8</span>&nbsp;<span class="op" id="6211893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6211897">if</span>&nbsp;<span class="ident" id="6211900">err</span>&nbsp;<span class="op" id="6211904">:=</span>&nbsp;<span class="ident" id="6211907">e</span><span class="op" id="6211908">.</span><span class="ident" id="6211909">w</span><span class="op" id="6211910">.</span><span class="ident" id="6211911">WriteByte</span><span class="op" id="6211920">(</span><span class="builtintype" id="6211921">uint8</span><span class="op" id="6211926">(</span><span class="ident" id="6211927">e</span><span class="op" id="6211928">.</span><span class="ident" id="6211929">bits</span><span class="op" id="6211933">)</span><span class="op" id="6211934">)</span><span class="op" id="6211935">;</span>&nbsp;<span class="ident" id="6211937">err</span>&nbsp;<span class="op" id="6211941">!=</span>&nbsp;<span class="ident" id="6211944">nil</span>&nbsp;<span class="op" id="6211948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6211953">return</span>&nbsp;<span class="ident" id="6211960">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6211966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6211970">e</span><span class="op" id="6211971">.</span><span class="ident" id="6211972">bits</span>&nbsp;<span class="op" id="6211977">&gt;&gt;=</span>&nbsp;<span class="num" id="6211981">8</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6211985">e</span><span class="op" id="6211986">.</span><span class="ident" id="6211987">nBits</span>&nbsp;<span class="op" id="6211993">-=</span>&nbsp;<span class="num" id="6211996">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6211999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6212002">return</span>&nbsp;<span class="ident" id="6212009">nil</span><br>
<span class="lineno"></span><span class="op" id="6212013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="6212016">//&nbsp;writeMSB&nbsp;writes&nbsp;the&nbsp;code&nbsp;c&nbsp;for&nbsp;&#34;Most&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="6212086">func</span>&nbsp;<span class="op" id="6212091">(</span><span class="ident" id="6212092">e</span>&nbsp;<span class="op" id="6212094">*</span><span class="ident" id="6212095">encoder</span><span class="op" id="6212102">)</span>&nbsp;<span class="ident" id="6212104">writeMSB</span><span class="op" id="6212112">(</span><span class="ident" id="6212113">c</span>&nbsp;<span class="builtintype" id="6212115">uint32</span><span class="op" id="6212121">)</span>&nbsp;<span class="builtintype" id="6212123">error</span>&nbsp;<span class="op" id="6212129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6212132">e</span><span class="op" id="6212133">.</span><span class="ident" id="6212134">bits</span>&nbsp;<span class="op" id="6212139">|=</span>&nbsp;<span class="ident" id="6212142">c</span>&nbsp;<span class="op" id="6212144">&lt;&lt;</span>&nbsp;<span class="op" id="6212147">(</span><span class="num" id="6212148">32</span>&nbsp;<span class="op" id="6212151">-</span>&nbsp;<span class="ident" id="6212153">e</span><span class="op" id="6212154">.</span><span class="ident" id="6212155">width</span>&nbsp;<span class="op" id="6212161">-</span>&nbsp;<span class="ident" id="6212163">e</span><span class="op" id="6212164">.</span><span class="ident" id="6212165">nBits</span><span class="op" id="6212170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6212173">e</span><span class="op" id="6212174">.</span><span class="ident" id="6212175">nBits</span>&nbsp;<span class="op" id="6212181">+=</span>&nbsp;<span class="ident" id="6212184">e</span><span class="op" id="6212185">.</span><span class="ident" id="6212186">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6212193">for</span>&nbsp;<span class="ident" id="6212197">e</span><span class="op" id="6212198">.</span><span class="ident" id="6212199">nBits</span>&nbsp;<span class="op" id="6212205">&gt;=</span>&nbsp;<span class="num" id="6212208">8</span>&nbsp;<span class="op" id="6212210">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6212214">if</span>&nbsp;<span class="ident" id="6212217">err</span>&nbsp;<span class="op" id="6212221">:=</span>&nbsp;<span class="ident" id="6212224">e</span><span class="op" id="6212225">.</span><span class="ident" id="6212226">w</span><span class="op" id="6212227">.</span><span class="ident" id="6212228">WriteByte</span><span class="op" id="6212237">(</span><span class="builtintype" id="6212238">uint8</span><span class="op" id="6212243">(</span><span class="ident" id="6212244">e</span><span class="op" id="6212245">.</span><span class="ident" id="6212246">bits</span>&nbsp;<span class="op" id="6212251">&gt;&gt;</span>&nbsp;<span class="num" id="6212254">24</span><span class="op" id="6212256">)</span><span class="op" id="6212257">)</span><span class="op" id="6212258">;</span>&nbsp;<span class="ident" id="6212260">err</span>&nbsp;<span class="op" id="6212264">!=</span>&nbsp;<span class="ident" id="6212267">nil</span>&nbsp;<span class="op" id="6212271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6212276">return</span>&nbsp;<span class="ident" id="6212283">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6212289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6212293">e</span><span class="op" id="6212294">.</span><span class="ident" id="6212295">bits</span>&nbsp;<span class="op" id="6212300">&lt;&lt;=</span>&nbsp;<span class="num" id="6212304">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6212308">e</span><span class="op" id="6212309">.</span><span class="ident" id="6212310">nBits</span>&nbsp;<span class="op" id="6212316">-=</span>&nbsp;<span class="num" id="6212319">8</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6212322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6212325">return</span>&nbsp;<span class="ident" id="6212332">nil</span><br>
<span class="lineno"></span><span class="op" id="6212336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6212339">//&nbsp;errOutOfCodes&nbsp;is&nbsp;an&nbsp;internal&nbsp;error&nbsp;that&nbsp;means&nbsp;that&nbsp;the&nbsp;encoder&nbsp;has&nbsp;run&nbsp;out</span><br>
<span class="lineno">105</span><span class="comment" id="6212417">//&nbsp;of&nbsp;unused&nbsp;codes&nbsp;and&nbsp;a&nbsp;clear&nbsp;code&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;next.</span><br>
<span class="lineno"></span><span class="keyword" id="6212476">var</span>&nbsp;<span class="ident" id="6212480">errOutOfCodes</span>&nbsp;<span class="op" id="6212494">=</span>&nbsp;<span class="ident" id="6212496">errors</span><span class="op" id="6212502">.</span><span class="ident" id="6212503">New</span><span class="op" id="6212506">(</span><span class="string" id="6212507">&#34;lzw:&nbsp;out&nbsp;of&nbsp;codes&#34;</span><span class="op" id="6212526">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6212529">//&nbsp;incHi&nbsp;increments&nbsp;e.hi&nbsp;and&nbsp;checks&nbsp;for&nbsp;both&nbsp;overflow&nbsp;and&nbsp;running&nbsp;out&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="6212602">//&nbsp;unused&nbsp;codes.&nbsp;In&nbsp;the&nbsp;latter&nbsp;case,&nbsp;incHi&nbsp;sends&nbsp;a&nbsp;clear&nbsp;code,&nbsp;resets&nbsp;the</span><br>
<span class="lineno">110</span><span class="comment" id="6212676">//&nbsp;encoder&nbsp;state&nbsp;and&nbsp;returns&nbsp;errOutOfCodes.</span><br>
<span class="lineno"></span><span class="keyword" id="6212720">func</span>&nbsp;<span class="op" id="6212725">(</span><span class="ident" id="6212726">e</span>&nbsp;<span class="op" id="6212728">*</span><span class="ident" id="6212729">encoder</span><span class="op" id="6212736">)</span>&nbsp;<span class="ident" id="6212738">incHi</span><span class="op" id="6212743">(</span><span class="op" id="6212744">)</span>&nbsp;<span class="builtintype" id="6212746">error</span>&nbsp;<span class="op" id="6212752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6212755">e</span><span class="op" id="6212756">.</span><span class="ident" id="6212757">hi</span><span class="op" id="6212759">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6212763">if</span>&nbsp;<span class="ident" id="6212766">e</span><span class="op" id="6212767">.</span><span class="ident" id="6212768">hi</span>&nbsp;<span class="op" id="6212771">==</span>&nbsp;<span class="ident" id="6212774">e</span><span class="op" id="6212775">.</span><span class="ident" id="6212776">overflow</span>&nbsp;<span class="op" id="6212785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6212789">e</span><span class="op" id="6212790">.</span><span class="ident" id="6212791">width</span><span class="op" id="6212796">++</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6212801">e</span><span class="op" id="6212802">.</span><span class="ident" id="6212803">overflow</span>&nbsp;<span class="op" id="6212812">&lt;&lt;=</span>&nbsp;<span class="num" id="6212816">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6212819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6212822">if</span>&nbsp;<span class="ident" id="6212825">e</span><span class="op" id="6212826">.</span><span class="ident" id="6212827">hi</span>&nbsp;<span class="op" id="6212830">==</span>&nbsp;<span class="ident" id="6212833">maxCode</span>&nbsp;<span class="op" id="6212841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6212845">clear</span>&nbsp;<span class="op" id="6212851">:=</span>&nbsp;<span class="builtintype" id="6212854">uint32</span><span class="op" id="6212860">(</span><span class="num" id="6212861">1</span><span class="op" id="6212862">)</span>&nbsp;<span class="op" id="6212864">&lt;&lt;</span>&nbsp;<span class="ident" id="6212867">e</span><span class="op" id="6212868">.</span><span class="ident" id="6212869">litWidth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6212880">if</span>&nbsp;<span class="ident" id="6212883">err</span>&nbsp;<span class="op" id="6212887">:=</span>&nbsp;<span class="ident" id="6212890">e</span><span class="op" id="6212891">.</span><span class="ident" id="6212892">write</span><span class="op" id="6212897">(</span><span class="ident" id="6212898">e</span><span class="op" id="6212899">,</span>&nbsp;<span class="ident" id="6212901">clear</span><span class="op" id="6212906">)</span><span class="op" id="6212907">;</span>&nbsp;<span class="ident" id="6212909">err</span>&nbsp;<span class="op" id="6212913">!=</span>&nbsp;<span class="ident" id="6212916">nil</span>&nbsp;<span class="op" id="6212920">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6212925">return</span>&nbsp;<span class="ident" id="6212932">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6212938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6212942">e</span><span class="op" id="6212943">.</span><span class="ident" id="6212944">width</span>&nbsp;<span class="op" id="6212950">=</span>&nbsp;<span class="builtintype" id="6212952">uint</span><span class="op" id="6212956">(</span><span class="ident" id="6212957">e</span><span class="op" id="6212958">.</span><span class="ident" id="6212959">litWidth</span><span class="op" id="6212967">)</span>&nbsp;<span class="op" id="6212969">+</span>&nbsp;<span class="num" id="6212971">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6212975">e</span><span class="op" id="6212976">.</span><span class="ident" id="6212977">hi</span>&nbsp;<span class="op" id="6212980">=</span>&nbsp;<span class="ident" id="6212982">clear</span>&nbsp;<span class="op" id="6212988">+</span>&nbsp;<span class="num" id="6212990">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6212994">e</span><span class="op" id="6212995">.</span><span class="ident" id="6212996">overflow</span>&nbsp;<span class="op" id="6213005">=</span>&nbsp;<span class="ident" id="6213007">clear</span>&nbsp;<span class="op" id="6213013">&lt;&lt;</span>&nbsp;<span class="num" id="6213016">1</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6213020">for</span>&nbsp;<span class="ident" id="6213024">i</span>&nbsp;<span class="op" id="6213026">:=</span>&nbsp;<span class="keyword" id="6213029">range</span>&nbsp;<span class="ident" id="6213035">e</span><span class="op" id="6213036">.</span><span class="ident" id="6213037">table</span>&nbsp;<span class="op" id="6213043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6213048">e</span><span class="op" id="6213049">.</span><span class="ident" id="6213050">table</span><span class="op" id="6213055">[</span><span class="ident" id="6213056">i</span><span class="op" id="6213057">]</span>&nbsp;<span class="op" id="6213059">=</span>&nbsp;<span class="ident" id="6213061">invalidEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6213076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6213080">return</span>&nbsp;<span class="ident" id="6213087">errOutOfCodes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6213102">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6213105">return</span>&nbsp;<span class="ident" id="6213112">nil</span><br>
<span class="lineno"></span><span class="op" id="6213116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6213119">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;compressed&nbsp;representation&nbsp;of&nbsp;p&nbsp;to&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="6213194">func</span>&nbsp;<span class="op" id="6213199">(</span><span class="ident" id="6213200">e</span>&nbsp;<span class="op" id="6213202">*</span><span class="ident" id="6213203">encoder</span><span class="op" id="6213210">)</span>&nbsp;<span class="ident" id="6213212">Write</span><span class="op" id="6213217">(</span><span class="ident" id="6213218">p</span>&nbsp;<span class="op" id="6213220">[</span><span class="op" id="6213221">]</span><span class="builtintype" id="6213222">byte</span><span class="op" id="6213226">)</span>&nbsp;<span class="op" id="6213228">(</span><span class="ident" id="6213229">n</span>&nbsp;<span class="builtintype" id="6213231">int</span><span class="op" id="6213234">,</span>&nbsp;<span class="ident" id="6213236">err</span>&nbsp;<span class="builtintype" id="6213240">error</span><span class="op" id="6213245">)</span>&nbsp;<span class="op" id="6213247">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6213250">if</span>&nbsp;<span class="ident" id="6213253">e</span><span class="op" id="6213254">.</span><span class="ident" id="6213255">err</span>&nbsp;<span class="op" id="6213259">!=</span>&nbsp;<span class="ident" id="6213262">nil</span>&nbsp;<span class="op" id="6213266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6213270">return</span>&nbsp;<span class="num" id="6213277">0</span><span class="op" id="6213278">,</span>&nbsp;<span class="ident" id="6213280">e</span><span class="op" id="6213281">.</span><span class="ident" id="6213282">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6213287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6213290">if</span>&nbsp;<span class="builtinfunc" id="6213293">len</span><span class="op" id="6213296">(</span><span class="ident" id="6213297">p</span><span class="op" id="6213298">)</span>&nbsp;<span class="op" id="6213300">==</span>&nbsp;<span class="num" id="6213303">0</span>&nbsp;<span class="op" id="6213305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6213309">return</span>&nbsp;<span class="num" id="6213316">0</span><span class="op" id="6213317">,</span>&nbsp;<span class="ident" id="6213319">nil</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6213324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6213327">n</span>&nbsp;<span class="op" id="6213329">=</span>&nbsp;<span class="builtinfunc" id="6213331">len</span><span class="op" id="6213334">(</span><span class="ident" id="6213335">p</span><span class="op" id="6213336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6213339">litMask</span>&nbsp;<span class="op" id="6213347">:=</span>&nbsp;<span class="builtintype" id="6213350">uint32</span><span class="op" id="6213356">(</span><span class="num" id="6213357">1</span><span class="op" id="6213358">&lt;&lt;</span><span class="ident" id="6213360">e</span><span class="op" id="6213361">.</span><span class="ident" id="6213362">litWidth</span>&nbsp;<span class="op" id="6213371">-</span>&nbsp;<span class="num" id="6213373">1</span><span class="op" id="6213374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6213377">code</span>&nbsp;<span class="op" id="6213382">:=</span>&nbsp;<span class="ident" id="6213385">e</span><span class="op" id="6213386">.</span><span class="ident" id="6213387">savedCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6213398">if</span>&nbsp;<span class="ident" id="6213401">code</span>&nbsp;<span class="op" id="6213406">==</span>&nbsp;<span class="ident" id="6213409">invalidCode</span>&nbsp;<span class="op" id="6213421">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6213425">//&nbsp;The&nbsp;first&nbsp;code&nbsp;sent&nbsp;is&nbsp;always&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6213476">code</span><span class="op" id="6213480">,</span>&nbsp;<span class="ident" id="6213482">p</span>&nbsp;<span class="op" id="6213484">=</span>&nbsp;<span class="builtintype" id="6213486">uint32</span><span class="op" id="6213492">(</span><span class="ident" id="6213493">p</span><span class="op" id="6213494">[</span><span class="num" id="6213495">0</span><span class="op" id="6213496">]</span><span class="op" id="6213497">)</span><span class="op" id="6213498">&amp;</span><span class="ident" id="6213499">litMask</span><span class="op" id="6213506">,</span>&nbsp;<span class="ident" id="6213508">p</span><span class="op" id="6213509">[</span><span class="num" id="6213510">1</span><span class="op" id="6213511">:</span><span class="op" id="6213512">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6213515">}</span><br>
<span class="lineno"></span><span class="ident" id="6213517">loop</span><span class="op" id="6213521">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6213524">for</span>&nbsp;<span class="ident" id="6213528">_</span><span class="op" id="6213529">,</span>&nbsp;<span class="ident" id="6213531">x</span>&nbsp;<span class="op" id="6213533">:=</span>&nbsp;<span class="keyword" id="6213536">range</span>&nbsp;<span class="ident" id="6213542">p</span>&nbsp;<span class="op" id="6213544">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6213548">literal</span>&nbsp;<span class="op" id="6213556">:=</span>&nbsp;<span class="builtintype" id="6213559">uint32</span><span class="op" id="6213565">(</span><span class="ident" id="6213566">x</span><span class="op" id="6213567">)</span>&nbsp;<span class="op" id="6213569">&amp;</span>&nbsp;<span class="ident" id="6213571">litMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6213581">key</span>&nbsp;<span class="op" id="6213585">:=</span>&nbsp;<span class="ident" id="6213588">code</span><span class="op" id="6213592">&lt;&lt;</span><span class="num" id="6213594">8</span>&nbsp;<span class="op" id="6213596">|</span>&nbsp;<span class="ident" id="6213598">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6213608">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;hash&nbsp;table&nbsp;hit&nbsp;for&nbsp;this&nbsp;key&nbsp;then&nbsp;we&nbsp;continue&nbsp;the&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6213681">//&nbsp;and&nbsp;do&nbsp;not&nbsp;emit&nbsp;a&nbsp;code&nbsp;yet.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6213714">hash</span>&nbsp;<span class="op" id="6213719">:=</span>&nbsp;<span class="op" id="6213722">(</span><span class="ident" id="6213723">key</span><span class="op" id="6213726">&gt;&gt;</span><span class="num" id="6213728">12</span>&nbsp;<span class="op" id="6213731">^</span>&nbsp;<span class="ident" id="6213733">key</span><span class="op" id="6213736">)</span>&nbsp;<span class="op" id="6213738">&amp;</span>&nbsp;<span class="ident" id="6213740">tableMask</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6213752">for</span>&nbsp;<span class="ident" id="6213756">h</span><span class="op" id="6213757">,</span>&nbsp;<span class="ident" id="6213759">t</span>&nbsp;<span class="op" id="6213761">:=</span>&nbsp;<span class="ident" id="6213764">hash</span><span class="op" id="6213768">,</span>&nbsp;<span class="ident" id="6213770">e</span><span class="op" id="6213771">.</span><span class="ident" id="6213772">table</span><span class="op" id="6213777">[</span><span class="ident" id="6213778">hash</span><span class="op" id="6213782">]</span><span class="op" id="6213783">;</span>&nbsp;<span class="ident" id="6213785">t</span>&nbsp;<span class="op" id="6213787">!=</span>&nbsp;<span class="ident" id="6213790">invalidEntry</span><span class="op" id="6213802">;</span>&nbsp;<span class="op" id="6213804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6213809">if</span>&nbsp;<span class="ident" id="6213812">key</span>&nbsp;<span class="op" id="6213816">==</span>&nbsp;<span class="ident" id="6213819">t</span><span class="op" id="6213820">&gt;&gt;</span><span class="num" id="6213822">12</span>&nbsp;<span class="op" id="6213825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6213831">code</span>&nbsp;<span class="op" id="6213836">=</span>&nbsp;<span class="ident" id="6213838">t</span>&nbsp;<span class="op" id="6213840">&amp;</span>&nbsp;<span class="ident" id="6213842">maxCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6213854">continue</span>&nbsp;<span class="ident" id="6213863">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6213871">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6213876">h</span>&nbsp;<span class="op" id="6213878">=</span>&nbsp;<span class="op" id="6213880">(</span><span class="ident" id="6213881">h</span>&nbsp;<span class="op" id="6213883">+</span>&nbsp;<span class="num" id="6213885">1</span><span class="op" id="6213886">)</span>&nbsp;<span class="op" id="6213888">&amp;</span>&nbsp;<span class="ident" id="6213890">tableMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6213903">t</span>&nbsp;<span class="op" id="6213905">=</span>&nbsp;<span class="ident" id="6213907">e</span><span class="op" id="6213908">.</span><span class="ident" id="6213909">table</span><span class="op" id="6213914">[</span><span class="ident" id="6213915">h</span><span class="op" id="6213916">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6213920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6213924">//&nbsp;Otherwise,&nbsp;write&nbsp;the&nbsp;current&nbsp;code,&nbsp;and&nbsp;literal&nbsp;becomes&nbsp;the&nbsp;start&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6213997">//&nbsp;the&nbsp;next&nbsp;emitted&nbsp;code.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6214025">if</span>&nbsp;<span class="ident" id="6214028">e</span><span class="op" id="6214029">.</span><span class="ident" id="6214030">err</span>&nbsp;<span class="op" id="6214034">=</span>&nbsp;<span class="ident" id="6214036">e</span><span class="op" id="6214037">.</span><span class="ident" id="6214038">write</span><span class="op" id="6214043">(</span><span class="ident" id="6214044">e</span><span class="op" id="6214045">,</span>&nbsp;<span class="ident" id="6214047">code</span><span class="op" id="6214051">)</span><span class="op" id="6214052">;</span>&nbsp;<span class="ident" id="6214054">e</span><span class="op" id="6214055">.</span><span class="ident" id="6214056">err</span>&nbsp;<span class="op" id="6214060">!=</span>&nbsp;<span class="ident" id="6214063">nil</span>&nbsp;<span class="op" id="6214067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6214072">return</span>&nbsp;<span class="num" id="6214079">0</span><span class="op" id="6214080">,</span>&nbsp;<span class="ident" id="6214082">e</span><span class="op" id="6214083">.</span><span class="ident" id="6214084">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6214090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6214094">code</span>&nbsp;<span class="op" id="6214099">=</span>&nbsp;<span class="ident" id="6214101">literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6214111">//&nbsp;Increment&nbsp;e.hi,&nbsp;the&nbsp;next&nbsp;implied&nbsp;code.&nbsp;If&nbsp;we&nbsp;run&nbsp;out&nbsp;of&nbsp;codes,&nbsp;reset</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6214185">//&nbsp;the&nbsp;encoder&nbsp;state&nbsp;(including&nbsp;clearing&nbsp;the&nbsp;hash&nbsp;table)&nbsp;and&nbsp;continue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6214258">if</span>&nbsp;<span class="ident" id="6214261">err1</span>&nbsp;<span class="op" id="6214266">:=</span>&nbsp;<span class="ident" id="6214269">e</span><span class="op" id="6214270">.</span><span class="ident" id="6214271">incHi</span><span class="op" id="6214276">(</span><span class="op" id="6214277">)</span><span class="op" id="6214278">;</span>&nbsp;<span class="ident" id="6214280">err1</span>&nbsp;<span class="op" id="6214285">!=</span>&nbsp;<span class="ident" id="6214288">nil</span>&nbsp;<span class="op" id="6214292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6214297">if</span>&nbsp;<span class="ident" id="6214300">err1</span>&nbsp;<span class="op" id="6214305">==</span>&nbsp;<span class="ident" id="6214308">errOutOfCodes</span>&nbsp;<span class="op" id="6214322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6214328">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6214340">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6214345">e</span><span class="op" id="6214346">.</span><span class="ident" id="6214347">err</span>&nbsp;<span class="op" id="6214351">=</span>&nbsp;<span class="ident" id="6214353">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6214361">return</span>&nbsp;<span class="num" id="6214368">0</span><span class="op" id="6214369">,</span>&nbsp;<span class="ident" id="6214371">e</span><span class="op" id="6214372">.</span><span class="ident" id="6214373">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6214379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6214383">//&nbsp;Otherwise,&nbsp;insert&nbsp;key&nbsp;-&gt;&nbsp;e.hi&nbsp;into&nbsp;the&nbsp;map&nbsp;that&nbsp;e.table&nbsp;represents.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6214456">for</span>&nbsp;<span class="op" id="6214460">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6214465">if</span>&nbsp;<span class="ident" id="6214468">e</span><span class="op" id="6214469">.</span><span class="ident" id="6214470">table</span><span class="op" id="6214475">[</span><span class="ident" id="6214476">hash</span><span class="op" id="6214480">]</span>&nbsp;<span class="op" id="6214482">==</span>&nbsp;<span class="ident" id="6214485">invalidEntry</span>&nbsp;<span class="op" id="6214498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6214504">e</span><span class="op" id="6214505">.</span><span class="ident" id="6214506">table</span><span class="op" id="6214511">[</span><span class="ident" id="6214512">hash</span><span class="op" id="6214516">]</span>&nbsp;<span class="op" id="6214518">=</span>&nbsp;<span class="op" id="6214520">(</span><span class="ident" id="6214521">key</span>&nbsp;<span class="op" id="6214525">&lt;&lt;</span>&nbsp;<span class="num" id="6214528">12</span><span class="op" id="6214530">)</span>&nbsp;<span class="op" id="6214532">|</span>&nbsp;<span class="ident" id="6214534">e</span><span class="op" id="6214535">.</span><span class="ident" id="6214536">hi</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6214543">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6214552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6214557">hash</span>&nbsp;<span class="op" id="6214562">=</span>&nbsp;<span class="op" id="6214564">(</span><span class="ident" id="6214565">hash</span>&nbsp;<span class="op" id="6214570">+</span>&nbsp;<span class="num" id="6214572">1</span><span class="op" id="6214573">)</span>&nbsp;<span class="op" id="6214575">&amp;</span>&nbsp;<span class="ident" id="6214577">tableMask</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6214589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6214592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6214595">e</span><span class="op" id="6214596">.</span><span class="ident" id="6214597">savedCode</span>&nbsp;<span class="op" id="6214607">=</span>&nbsp;<span class="ident" id="6214609">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6214615">return</span>&nbsp;<span class="ident" id="6214622">n</span><span class="op" id="6214623">,</span>&nbsp;<span class="ident" id="6214625">nil</span><br>
<span class="lineno"></span><span class="op" id="6214629">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="6214632">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;encoder,&nbsp;flushing&nbsp;any&nbsp;pending&nbsp;output.&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6214711">//&nbsp;flush&nbsp;e&#39;s&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="6214743">func</span>&nbsp;<span class="op" id="6214748">(</span><span class="ident" id="6214749">e</span>&nbsp;<span class="op" id="6214751">*</span><span class="ident" id="6214752">encoder</span><span class="op" id="6214759">)</span>&nbsp;<span class="ident" id="6214761">Close</span><span class="op" id="6214766">(</span><span class="op" id="6214767">)</span>&nbsp;<span class="builtintype" id="6214769">error</span>&nbsp;<span class="op" id="6214775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6214778">if</span>&nbsp;<span class="ident" id="6214781">e</span><span class="op" id="6214782">.</span><span class="ident" id="6214783">err</span>&nbsp;<span class="op" id="6214787">!=</span>&nbsp;<span class="ident" id="6214790">nil</span>&nbsp;<span class="op" id="6214794">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6214798">if</span>&nbsp;<span class="ident" id="6214801">e</span><span class="op" id="6214802">.</span><span class="ident" id="6214803">err</span>&nbsp;<span class="op" id="6214807">==</span>&nbsp;<span class="ident" id="6214810">errClosed</span>&nbsp;<span class="op" id="6214820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6214825">return</span>&nbsp;<span class="ident" id="6214832">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6214838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6214842">return</span>&nbsp;<span class="ident" id="6214849">e</span><span class="op" id="6214850">.</span><span class="ident" id="6214851">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6214856">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6214859">//&nbsp;Make&nbsp;any&nbsp;future&nbsp;calls&nbsp;to&nbsp;Write&nbsp;return&nbsp;errClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6214912">e</span><span class="op" id="6214913">.</span><span class="ident" id="6214914">err</span>&nbsp;<span class="op" id="6214918">=</span>&nbsp;<span class="ident" id="6214920">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6214931">//&nbsp;Write&nbsp;the&nbsp;savedCode&nbsp;if&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6214965">if</span>&nbsp;<span class="ident" id="6214968">e</span><span class="op" id="6214969">.</span><span class="ident" id="6214970">savedCode</span>&nbsp;<span class="op" id="6214980">!=</span>&nbsp;<span class="ident" id="6214983">invalidCode</span>&nbsp;<span class="op" id="6214995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6214999">if</span>&nbsp;<span class="ident" id="6215002">err</span>&nbsp;<span class="op" id="6215006">:=</span>&nbsp;<span class="ident" id="6215009">e</span><span class="op" id="6215010">.</span><span class="ident" id="6215011">write</span><span class="op" id="6215016">(</span><span class="ident" id="6215017">e</span><span class="op" id="6215018">,</span>&nbsp;<span class="ident" id="6215020">e</span><span class="op" id="6215021">.</span><span class="ident" id="6215022">savedCode</span><span class="op" id="6215031">)</span><span class="op" id="6215032">;</span>&nbsp;<span class="ident" id="6215034">err</span>&nbsp;<span class="op" id="6215038">!=</span>&nbsp;<span class="ident" id="6215041">nil</span>&nbsp;<span class="op" id="6215045">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6215050">return</span>&nbsp;<span class="ident" id="6215057">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6215063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6215067">if</span>&nbsp;<span class="ident" id="6215070">err</span>&nbsp;<span class="op" id="6215074">:=</span>&nbsp;<span class="ident" id="6215077">e</span><span class="op" id="6215078">.</span><span class="ident" id="6215079">incHi</span><span class="op" id="6215084">(</span><span class="op" id="6215085">)</span><span class="op" id="6215086">;</span>&nbsp;<span class="ident" id="6215088">err</span>&nbsp;<span class="op" id="6215092">!=</span>&nbsp;<span class="ident" id="6215095">nil</span>&nbsp;<span class="op" id="6215099">&amp;&amp;</span>&nbsp;<span class="ident" id="6215102">err</span>&nbsp;<span class="op" id="6215106">!=</span>&nbsp;<span class="ident" id="6215109">errOutOfCodes</span>&nbsp;<span class="op" id="6215123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6215128">return</span>&nbsp;<span class="ident" id="6215135">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6215141">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6215144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6215147">//&nbsp;Write&nbsp;the&nbsp;eof&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6215171">eof</span>&nbsp;<span class="op" id="6215175">:=</span>&nbsp;<span class="builtintype" id="6215178">uint32</span><span class="op" id="6215184">(</span><span class="num" id="6215185">1</span><span class="op" id="6215186">)</span><span class="op" id="6215187">&lt;&lt;</span><span class="ident" id="6215189">e</span><span class="op" id="6215190">.</span><span class="ident" id="6215191">litWidth</span>&nbsp;<span class="op" id="6215200">+</span>&nbsp;<span class="num" id="6215202">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6215205">if</span>&nbsp;<span class="ident" id="6215208">err</span>&nbsp;<span class="op" id="6215212">:=</span>&nbsp;<span class="ident" id="6215215">e</span><span class="op" id="6215216">.</span><span class="ident" id="6215217">write</span><span class="op" id="6215222">(</span><span class="ident" id="6215223">e</span><span class="op" id="6215224">,</span>&nbsp;<span class="ident" id="6215226">eof</span><span class="op" id="6215229">)</span><span class="op" id="6215230">;</span>&nbsp;<span class="ident" id="6215232">err</span>&nbsp;<span class="op" id="6215236">!=</span>&nbsp;<span class="ident" id="6215239">nil</span>&nbsp;<span class="op" id="6215243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6215247">return</span>&nbsp;<span class="ident" id="6215254">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6215259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6215262">//&nbsp;Write&nbsp;the&nbsp;final&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6215288">if</span>&nbsp;<span class="ident" id="6215291">e</span><span class="op" id="6215292">.</span><span class="ident" id="6215293">nBits</span>&nbsp;<span class="op" id="6215299">&gt;</span>&nbsp;<span class="num" id="6215301">0</span>&nbsp;<span class="op" id="6215303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6215307">if</span>&nbsp;<span class="ident" id="6215310">e</span><span class="op" id="6215311">.</span><span class="ident" id="6215312">order</span>&nbsp;<span class="op" id="6215318">==</span>&nbsp;<span class="ident" id="6215321">MSB</span>&nbsp;<span class="op" id="6215325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6215330">e</span><span class="op" id="6215331">.</span><span class="ident" id="6215332">bits</span>&nbsp;<span class="op" id="6215337">&gt;&gt;=</span>&nbsp;<span class="num" id="6215341">24</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6215346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6215350">if</span>&nbsp;<span class="ident" id="6215353">err</span>&nbsp;<span class="op" id="6215357">:=</span>&nbsp;<span class="ident" id="6215360">e</span><span class="op" id="6215361">.</span><span class="ident" id="6215362">w</span><span class="op" id="6215363">.</span><span class="ident" id="6215364">WriteByte</span><span class="op" id="6215373">(</span><span class="builtintype" id="6215374">uint8</span><span class="op" id="6215379">(</span><span class="ident" id="6215380">e</span><span class="op" id="6215381">.</span><span class="ident" id="6215382">bits</span><span class="op" id="6215386">)</span><span class="op" id="6215387">)</span><span class="op" id="6215388">;</span>&nbsp;<span class="ident" id="6215390">err</span>&nbsp;<span class="op" id="6215394">!=</span>&nbsp;<span class="ident" id="6215397">nil</span>&nbsp;<span class="op" id="6215401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6215406">return</span>&nbsp;<span class="ident" id="6215413">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6215419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6215422">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6215425">return</span>&nbsp;<span class="ident" id="6215432">e</span><span class="op" id="6215433">.</span><span class="ident" id="6215434">w</span><span class="op" id="6215435">.</span><span class="ident" id="6215436">Flush</span><span class="op" id="6215441">(</span><span class="op" id="6215442">)</span><br>
<span class="lineno"></span><span class="op" id="6215444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6215447">//&nbsp;NewWriter&nbsp;creates&nbsp;a&nbsp;new&nbsp;io.WriteCloser.</span><br>
<span class="lineno"></span><span class="comment" id="6215490">//&nbsp;Writes&nbsp;to&nbsp;the&nbsp;returned&nbsp;io.WriteCloser&nbsp;are&nbsp;compressed&nbsp;and&nbsp;written&nbsp;to&nbsp;w.</span><br>
<span class="lineno">230</span><span class="comment" id="6215564">//&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;call&nbsp;Close&nbsp;on&nbsp;the&nbsp;WriteCloser&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="6215639">//&nbsp;finished&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="6215660">//&nbsp;The&nbsp;number&nbsp;of&nbsp;bits&nbsp;to&nbsp;use&nbsp;for&nbsp;literal&nbsp;codes,&nbsp;litWidth,&nbsp;must&nbsp;be&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6215733">//&nbsp;range&nbsp;[2,8]&nbsp;and&nbsp;is&nbsp;typically&nbsp;8.</span><br>
<span class="lineno"></span><span class="keyword" id="6215768">func</span>&nbsp;<span class="ident" id="6215773">NewWriter</span><span class="op" id="6215782">(</span><span class="ident" id="6215783">w</span>&nbsp;<span class="ident" id="6215785">io</span><span class="op" id="6215787">.</span><span class="ident" id="6215788">Writer</span><span class="op" id="6215794">,</span>&nbsp;<span class="ident" id="6215796">order</span>&nbsp;<span class="ident" id="6215802">Order</span><span class="op" id="6215807">,</span>&nbsp;<span class="ident" id="6215809">litWidth</span>&nbsp;<span class="builtintype" id="6215818">int</span><span class="op" id="6215821">)</span>&nbsp;<span class="ident" id="6215823">io</span><span class="op" id="6215825">.</span><span class="ident" id="6215826">WriteCloser</span>&nbsp;<span class="op" id="6215838">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6215841">var</span>&nbsp;<span class="ident" id="6215845">write</span>&nbsp;<span class="keyword" id="6215851">func</span><span class="op" id="6215855">(</span><span class="op" id="6215856">*</span><span class="ident" id="6215857">encoder</span><span class="op" id="6215864">,</span>&nbsp;<span class="builtintype" id="6215866">uint32</span><span class="op" id="6215872">)</span>&nbsp;<span class="builtintype" id="6215874">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6215881">switch</span>&nbsp;<span class="ident" id="6215888">order</span>&nbsp;<span class="op" id="6215894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6215897">case</span>&nbsp;<span class="ident" id="6215902">LSB</span><span class="op" id="6215905">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6215909">write</span>&nbsp;<span class="op" id="6215915">=</span>&nbsp;<span class="op" id="6215917">(</span><span class="op" id="6215918">*</span><span class="ident" id="6215919">encoder</span><span class="op" id="6215926">)</span><span class="op" id="6215927">.</span><span class="ident" id="6215928">writeLSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6215938">case</span>&nbsp;<span class="ident" id="6215943">MSB</span><span class="op" id="6215946">:</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6215950">write</span>&nbsp;<span class="op" id="6215956">=</span>&nbsp;<span class="op" id="6215958">(</span><span class="op" id="6215959">*</span><span class="ident" id="6215960">encoder</span><span class="op" id="6215967">)</span><span class="op" id="6215968">.</span><span class="ident" id="6215969">writeMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6215979">default</span><span class="op" id="6215986">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6215990">return</span>&nbsp;<span class="op" id="6215997">&amp;</span><span class="ident" id="6215998">errWriteCloser</span><span class="op" id="6216012">{</span><span class="ident" id="6216013">errors</span><span class="op" id="6216019">.</span><span class="ident" id="6216020">New</span><span class="op" id="6216023">(</span><span class="string" id="6216024">&#34;lzw:&nbsp;unknown&nbsp;order&#34;</span><span class="op" id="6216044">)</span><span class="op" id="6216045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6216048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6216051">if</span>&nbsp;<span class="ident" id="6216054">litWidth</span>&nbsp;<span class="op" id="6216063">&lt;</span>&nbsp;<span class="num" id="6216065">2</span>&nbsp;<span class="op" id="6216067">||</span>&nbsp;<span class="num" id="6216070">8</span>&nbsp;<span class="op" id="6216072">&lt;</span>&nbsp;<span class="ident" id="6216074">litWidth</span>&nbsp;<span class="op" id="6216083">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6216087">return</span>&nbsp;<span class="op" id="6216094">&amp;</span><span class="ident" id="6216095">errWriteCloser</span><span class="op" id="6216109">{</span><span class="ident" id="6216110">fmt</span><span class="op" id="6216113">.</span><span class="ident" id="6216114">Errorf</span><span class="op" id="6216120">(</span><span class="string" id="6216121">&#34;lzw:&nbsp;litWidth&nbsp;%d&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="6216152">,</span>&nbsp;<span class="ident" id="6216154">litWidth</span><span class="op" id="6216162">)</span><span class="op" id="6216163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6216166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6216169">bw</span><span class="op" id="6216171">,</span>&nbsp;<span class="ident" id="6216173">ok</span>&nbsp;<span class="op" id="6216176">:=</span>&nbsp;<span class="ident" id="6216179">w</span><span class="op" id="6216180">.</span><span class="op" id="6216181">(</span><span class="ident" id="6216182">writer</span><span class="op" id="6216188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6216191">if</span>&nbsp;<span class="op" id="6216194">!</span><span class="ident" id="6216195">ok</span>&nbsp;<span class="op" id="6216198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6216202">bw</span>&nbsp;<span class="op" id="6216205">=</span>&nbsp;<span class="ident" id="6216207">bufio</span><span class="op" id="6216212">.</span><span class="ident" id="6216213">NewWriter</span><span class="op" id="6216222">(</span><span class="ident" id="6216223">w</span><span class="op" id="6216224">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6216227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6216230">lw</span>&nbsp;<span class="op" id="6216233">:=</span>&nbsp;<span class="builtintype" id="6216236">uint</span><span class="op" id="6216240">(</span><span class="ident" id="6216241">litWidth</span><span class="op" id="6216249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6216252">return</span>&nbsp;<span class="op" id="6216259">&amp;</span><span class="ident" id="6216260">encoder</span><span class="op" id="6216267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6216271">w</span><span class="op" id="6216272">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6216282">bw</span><span class="op" id="6216284">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6216288">order</span><span class="op" id="6216293">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6216299">order</span><span class="op" id="6216304">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6216308">write</span><span class="op" id="6216313">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6216319">write</span><span class="op" id="6216324">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6216328">width</span><span class="op" id="6216333">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="6216339">1</span>&nbsp;<span class="op" id="6216341">+</span>&nbsp;<span class="ident" id="6216343">lw</span><span class="op" id="6216345">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6216349">litWidth</span><span class="op" id="6216357">:</span>&nbsp;&nbsp;<span class="ident" id="6216360">lw</span><span class="op" id="6216362">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6216366">hi</span><span class="op" id="6216368">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="6216377">1</span><span class="op" id="6216378">&lt;&lt;</span><span class="ident" id="6216380">lw</span>&nbsp;<span class="op" id="6216383">+</span>&nbsp;<span class="num" id="6216385">1</span><span class="op" id="6216386">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6216390">overflow</span><span class="op" id="6216398">:</span>&nbsp;&nbsp;<span class="num" id="6216401">1</span>&nbsp;<span class="op" id="6216403">&lt;&lt;</span>&nbsp;<span class="op" id="6216406">(</span><span class="ident" id="6216407">lw</span>&nbsp;<span class="op" id="6216410">+</span>&nbsp;<span class="num" id="6216412">1</span><span class="op" id="6216413">)</span><span class="op" id="6216414">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6216418">savedCode</span><span class="op" id="6216427">:</span>&nbsp;<span class="ident" id="6216429">invalidCode</span><span class="op" id="6216440">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6216443">}</span><br>
<span class="lineno"></span><span class="op" id="6216445">}</span>
</div>
</body>
</html>
