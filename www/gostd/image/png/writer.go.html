<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5460373">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5460428">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5460482">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5460533">package</span>&nbsp;<span class="ident" id="5460541">png</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5460546">import</span>&nbsp;<span class="op" id="5460553">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5460556">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5460565">&#34;compress/zlib&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5460582">&#34;hash/crc32&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5460596">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5460605">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5460620">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5460626">&#34;strconv&#34;</span><br>
<span class="lineno">15</span><span class="op" id="5460636">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5460639">//&nbsp;Encoder&nbsp;configures&nbsp;encoding&nbsp;PNG&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="5460682">type</span>&nbsp;<span class="ident" id="5460687">Encoder</span>&nbsp;<span class="keyword" id="5460695">struct</span>&nbsp;<span class="op" id="5460702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460705">CompressionLevel</span>&nbsp;<span class="ident" id="5460722">CompressionLevel</span><br>
<span class="lineno">20</span><span class="op" id="5460739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5460742">type</span>&nbsp;<span class="ident" id="5460747">encoder</span>&nbsp;<span class="keyword" id="5460755">struct</span>&nbsp;<span class="op" id="5460762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460765">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5460772">*</span><span class="ident" id="5460773">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460782">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5460789">io</span><span class="op" id="5460791">.</span><span class="ident" id="5460792">Writer</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460800">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5460807">image</span><span class="op" id="5460812">.</span><span class="ident" id="5460813">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460820">cb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5460827">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460832">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5460839">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460846">header</span>&nbsp;<span class="op" id="5460853">[</span><span class="num" id="5460854">8</span><span class="op" id="5460855">]</span><span class="builtintype" id="5460856">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460862">footer</span>&nbsp;<span class="op" id="5460869">[</span><span class="num" id="5460870">4</span><span class="op" id="5460871">]</span><span class="builtintype" id="5460872">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460878">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5460885">[</span><span class="num" id="5460886">4</span>&nbsp;<span class="op" id="5460888">*</span>&nbsp;<span class="num" id="5460890">256</span><span class="op" id="5460893">]</span><span class="builtintype" id="5460894">byte</span><br>
<span class="lineno"></span><span class="op" id="5460899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5460902">type</span>&nbsp;<span class="ident" id="5460907">CompressionLevel</span>&nbsp;<span class="builtintype" id="5460924">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="5460929">const</span>&nbsp;<span class="op" id="5460935">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460938">DefaultCompression</span>&nbsp;<span class="ident" id="5460957">CompressionLevel</span>&nbsp;<span class="op" id="5460974">=</span>&nbsp;<span class="num" id="5460976">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5460979">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5460998">CompressionLevel</span>&nbsp;<span class="op" id="5461015">=</span>&nbsp;<span class="op" id="5461017">-</span><span class="num" id="5461018">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461021">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5461040">CompressionLevel</span>&nbsp;<span class="op" id="5461057">=</span>&nbsp;<span class="op" id="5461059">-</span><span class="num" id="5461060">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461063">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5461082">CompressionLevel</span>&nbsp;<span class="op" id="5461099">=</span>&nbsp;<span class="op" id="5461101">-</span><span class="num" id="5461102">3</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5461106">//&nbsp;Positive&nbsp;CompressionLevel&nbsp;values&nbsp;are&nbsp;reserved&nbsp;to&nbsp;mean&nbsp;a&nbsp;numeric&nbsp;zlib</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5461179">//&nbsp;compression&nbsp;level,&nbsp;although&nbsp;that&nbsp;is&nbsp;not&nbsp;implemented&nbsp;yet.</span><br>
<span class="lineno"></span><span class="op" id="5461239">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5461242">//&nbsp;Big-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="5461257">func</span>&nbsp;<span class="ident" id="5461262">writeUint32</span><span class="op" id="5461273">(</span><span class="ident" id="5461274">b</span>&nbsp;<span class="op" id="5461276">[</span><span class="op" id="5461277">]</span><span class="builtintype" id="5461278">uint8</span><span class="op" id="5461283">,</span>&nbsp;<span class="ident" id="5461285">u</span>&nbsp;<span class="builtintype" id="5461287">uint32</span><span class="op" id="5461293">)</span>&nbsp;<span class="op" id="5461295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461298">b</span><span class="op" id="5461299">[</span><span class="num" id="5461300">0</span><span class="op" id="5461301">]</span>&nbsp;<span class="op" id="5461303">=</span>&nbsp;<span class="builtintype" id="5461305">uint8</span><span class="op" id="5461310">(</span><span class="ident" id="5461311">u</span>&nbsp;<span class="op" id="5461313">&gt;&gt;</span>&nbsp;<span class="num" id="5461316">24</span><span class="op" id="5461318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461321">b</span><span class="op" id="5461322">[</span><span class="num" id="5461323">1</span><span class="op" id="5461324">]</span>&nbsp;<span class="op" id="5461326">=</span>&nbsp;<span class="builtintype" id="5461328">uint8</span><span class="op" id="5461333">(</span><span class="ident" id="5461334">u</span>&nbsp;<span class="op" id="5461336">&gt;&gt;</span>&nbsp;<span class="num" id="5461339">16</span><span class="op" id="5461341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461344">b</span><span class="op" id="5461345">[</span><span class="num" id="5461346">2</span><span class="op" id="5461347">]</span>&nbsp;<span class="op" id="5461349">=</span>&nbsp;<span class="builtintype" id="5461351">uint8</span><span class="op" id="5461356">(</span><span class="ident" id="5461357">u</span>&nbsp;<span class="op" id="5461359">&gt;&gt;</span>&nbsp;<span class="num" id="5461362">8</span><span class="op" id="5461363">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461366">b</span><span class="op" id="5461367">[</span><span class="num" id="5461368">3</span><span class="op" id="5461369">]</span>&nbsp;<span class="op" id="5461371">=</span>&nbsp;<span class="builtintype" id="5461373">uint8</span><span class="op" id="5461378">(</span><span class="ident" id="5461379">u</span>&nbsp;<span class="op" id="5461381">&gt;&gt;</span>&nbsp;<span class="num" id="5461384">0</span><span class="op" id="5461385">)</span><br>
<span class="lineno"></span><span class="op" id="5461387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5461390">type</span>&nbsp;<span class="ident" id="5461395">opaquer</span>&nbsp;<span class="keyword" id="5461403">interface</span>&nbsp;<span class="op" id="5461413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461416">Opaque</span><span class="op" id="5461422">(</span><span class="op" id="5461423">)</span>&nbsp;<span class="builtintype" id="5461425">bool</span><br>
<span class="lineno">55</span><span class="op" id="5461430">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5461433">//&nbsp;Returns&nbsp;whether&nbsp;or&nbsp;not&nbsp;the&nbsp;image&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="5461486">func</span>&nbsp;<span class="ident" id="5461491">opaque</span><span class="op" id="5461497">(</span><span class="ident" id="5461498">m</span>&nbsp;<span class="ident" id="5461500">image</span><span class="op" id="5461505">.</span><span class="ident" id="5461506">Image</span><span class="op" id="5461511">)</span>&nbsp;<span class="builtintype" id="5461513">bool</span>&nbsp;<span class="op" id="5461518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461521">if</span>&nbsp;<span class="ident" id="5461524">o</span><span class="op" id="5461525">,</span>&nbsp;<span class="ident" id="5461527">ok</span>&nbsp;<span class="op" id="5461530">:=</span>&nbsp;<span class="ident" id="5461533">m</span><span class="op" id="5461534">.</span><span class="op" id="5461535">(</span><span class="ident" id="5461536">opaquer</span><span class="op" id="5461543">)</span><span class="op" id="5461544">;</span>&nbsp;<span class="ident" id="5461546">ok</span>&nbsp;<span class="op" id="5461549">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461553">return</span>&nbsp;<span class="ident" id="5461560">o</span><span class="op" id="5461561">.</span><span class="ident" id="5461562">Opaque</span><span class="op" id="5461568">(</span><span class="op" id="5461569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5461572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461575">b</span>&nbsp;<span class="op" id="5461577">:=</span>&nbsp;<span class="ident" id="5461580">m</span><span class="op" id="5461581">.</span><span class="ident" id="5461582">Bounds</span><span class="op" id="5461588">(</span><span class="op" id="5461589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461592">for</span>&nbsp;<span class="ident" id="5461596">y</span>&nbsp;<span class="op" id="5461598">:=</span>&nbsp;<span class="ident" id="5461601">b</span><span class="op" id="5461602">.</span><span class="ident" id="5461603">Min</span><span class="op" id="5461606">.</span><span class="ident" id="5461607">Y</span><span class="op" id="5461608">;</span>&nbsp;<span class="ident" id="5461610">y</span>&nbsp;<span class="op" id="5461612">&lt;</span>&nbsp;<span class="ident" id="5461614">b</span><span class="op" id="5461615">.</span><span class="ident" id="5461616">Max</span><span class="op" id="5461619">.</span><span class="ident" id="5461620">Y</span><span class="op" id="5461621">;</span>&nbsp;<span class="ident" id="5461623">y</span><span class="op" id="5461624">++</span>&nbsp;<span class="op" id="5461627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461631">for</span>&nbsp;<span class="ident" id="5461635">x</span>&nbsp;<span class="op" id="5461637">:=</span>&nbsp;<span class="ident" id="5461640">b</span><span class="op" id="5461641">.</span><span class="ident" id="5461642">Min</span><span class="op" id="5461645">.</span><span class="ident" id="5461646">X</span><span class="op" id="5461647">;</span>&nbsp;<span class="ident" id="5461649">x</span>&nbsp;<span class="op" id="5461651">&lt;</span>&nbsp;<span class="ident" id="5461653">b</span><span class="op" id="5461654">.</span><span class="ident" id="5461655">Max</span><span class="op" id="5461658">.</span><span class="ident" id="5461659">X</span><span class="op" id="5461660">;</span>&nbsp;<span class="ident" id="5461662">x</span><span class="op" id="5461663">++</span>&nbsp;<span class="op" id="5461666">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461671">_</span><span class="op" id="5461672">,</span>&nbsp;<span class="ident" id="5461674">_</span><span class="op" id="5461675">,</span>&nbsp;<span class="ident" id="5461677">_</span><span class="op" id="5461678">,</span>&nbsp;<span class="ident" id="5461680">a</span>&nbsp;<span class="op" id="5461682">:=</span>&nbsp;<span class="ident" id="5461685">m</span><span class="op" id="5461686">.</span><span class="ident" id="5461687">At</span><span class="op" id="5461689">(</span><span class="ident" id="5461690">x</span><span class="op" id="5461691">,</span>&nbsp;<span class="ident" id="5461693">y</span><span class="op" id="5461694">)</span><span class="op" id="5461695">.</span><span class="ident" id="5461696">RGBA</span><span class="op" id="5461700">(</span><span class="op" id="5461701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461706">if</span>&nbsp;<span class="ident" id="5461709">a</span>&nbsp;<span class="op" id="5461711">!=</span>&nbsp;<span class="num" id="5461714">0xffff</span>&nbsp;<span class="op" id="5461721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461727">return</span>&nbsp;<span class="builtintype" id="5461734">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5461743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5461747">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5461750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461753">return</span>&nbsp;<span class="builtintype" id="5461760">true</span><br>
<span class="lineno"></span><span class="op" id="5461765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5461768">//&nbsp;The&nbsp;absolute&nbsp;value&nbsp;of&nbsp;a&nbsp;byte&nbsp;interpreted&nbsp;as&nbsp;a&nbsp;signed&nbsp;int8.</span><br>
<span class="lineno">75</span><span class="keyword" id="5461830">func</span>&nbsp;<span class="ident" id="5461835">abs8</span><span class="op" id="5461839">(</span><span class="ident" id="5461840">d</span>&nbsp;<span class="builtintype" id="5461842">uint8</span><span class="op" id="5461847">)</span>&nbsp;<span class="builtintype" id="5461849">int</span>&nbsp;<span class="op" id="5461853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461856">if</span>&nbsp;<span class="ident" id="5461859">d</span>&nbsp;<span class="op" id="5461861">&lt;</span>&nbsp;<span class="num" id="5461863">128</span>&nbsp;<span class="op" id="5461867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461871">return</span>&nbsp;<span class="builtintype" id="5461878">int</span><span class="op" id="5461881">(</span><span class="ident" id="5461882">d</span><span class="op" id="5461883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5461886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461889">return</span>&nbsp;<span class="num" id="5461896">256</span>&nbsp;<span class="op" id="5461900">-</span>&nbsp;<span class="builtintype" id="5461902">int</span><span class="op" id="5461905">(</span><span class="ident" id="5461906">d</span><span class="op" id="5461907">)</span><br>
<span class="lineno">80</span><span class="op" id="5461909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5461912">func</span>&nbsp;<span class="op" id="5461917">(</span><span class="ident" id="5461918">e</span>&nbsp;<span class="op" id="5461920">*</span><span class="ident" id="5461921">encoder</span><span class="op" id="5461928">)</span>&nbsp;<span class="ident" id="5461930">writeChunk</span><span class="op" id="5461940">(</span><span class="ident" id="5461941">b</span>&nbsp;<span class="op" id="5461943">[</span><span class="op" id="5461944">]</span><span class="builtintype" id="5461945">byte</span><span class="op" id="5461949">,</span>&nbsp;<span class="ident" id="5461951">name</span>&nbsp;<span class="builtintype" id="5461956">string</span><span class="op" id="5461962">)</span>&nbsp;<span class="op" id="5461964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461967">if</span>&nbsp;<span class="ident" id="5461970">e</span><span class="op" id="5461971">.</span><span class="ident" id="5461972">err</span>&nbsp;<span class="op" id="5461976">!=</span>&nbsp;<span class="ident" id="5461979">nil</span>&nbsp;<span class="op" id="5461983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5461987">return</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5461995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5461998">n</span>&nbsp;<span class="op" id="5462000">:=</span>&nbsp;<span class="builtintype" id="5462003">uint32</span><span class="op" id="5462009">(</span><span class="builtinfunc" id="5462010">len</span><span class="op" id="5462013">(</span><span class="ident" id="5462014">b</span><span class="op" id="5462015">)</span><span class="op" id="5462016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462019">if</span>&nbsp;<span class="builtintype" id="5462022">int</span><span class="op" id="5462025">(</span><span class="ident" id="5462026">n</span><span class="op" id="5462027">)</span>&nbsp;<span class="op" id="5462029">!=</span>&nbsp;<span class="builtinfunc" id="5462032">len</span><span class="op" id="5462035">(</span><span class="ident" id="5462036">b</span><span class="op" id="5462037">)</span>&nbsp;<span class="op" id="5462039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462043">e</span><span class="op" id="5462044">.</span><span class="ident" id="5462045">err</span>&nbsp;<span class="op" id="5462049">=</span>&nbsp;<span class="ident" id="5462051">UnsupportedError</span><span class="op" id="5462067">(</span><span class="ident" id="5462068">name</span>&nbsp;<span class="op" id="5462073">+</span>&nbsp;<span class="string" id="5462075">&#34;&nbsp;chunk&nbsp;is&nbsp;too&nbsp;large:&nbsp;&#34;</span>&nbsp;<span class="op" id="5462099">+</span>&nbsp;<span class="ident" id="5462101">strconv</span><span class="op" id="5462108">.</span><span class="ident" id="5462109">Itoa</span><span class="op" id="5462113">(</span><span class="builtinfunc" id="5462114">len</span><span class="op" id="5462117">(</span><span class="ident" id="5462118">b</span><span class="op" id="5462119">)</span><span class="op" id="5462120">)</span><span class="op" id="5462121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462125">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5462133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462136">writeUint32</span><span class="op" id="5462147">(</span><span class="ident" id="5462148">e</span><span class="op" id="5462149">.</span><span class="ident" id="5462150">header</span><span class="op" id="5462156">[</span><span class="op" id="5462157">:</span><span class="num" id="5462158">4</span><span class="op" id="5462159">]</span><span class="op" id="5462160">,</span>&nbsp;<span class="ident" id="5462162">n</span><span class="op" id="5462163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462166">e</span><span class="op" id="5462167">.</span><span class="ident" id="5462168">header</span><span class="op" id="5462174">[</span><span class="num" id="5462175">4</span><span class="op" id="5462176">]</span>&nbsp;<span class="op" id="5462178">=</span>&nbsp;<span class="ident" id="5462180">name</span><span class="op" id="5462184">[</span><span class="num" id="5462185">0</span><span class="op" id="5462186">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462189">e</span><span class="op" id="5462190">.</span><span class="ident" id="5462191">header</span><span class="op" id="5462197">[</span><span class="num" id="5462198">5</span><span class="op" id="5462199">]</span>&nbsp;<span class="op" id="5462201">=</span>&nbsp;<span class="ident" id="5462203">name</span><span class="op" id="5462207">[</span><span class="num" id="5462208">1</span><span class="op" id="5462209">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462212">e</span><span class="op" id="5462213">.</span><span class="ident" id="5462214">header</span><span class="op" id="5462220">[</span><span class="num" id="5462221">6</span><span class="op" id="5462222">]</span>&nbsp;<span class="op" id="5462224">=</span>&nbsp;<span class="ident" id="5462226">name</span><span class="op" id="5462230">[</span><span class="num" id="5462231">2</span><span class="op" id="5462232">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462235">e</span><span class="op" id="5462236">.</span><span class="ident" id="5462237">header</span><span class="op" id="5462243">[</span><span class="num" id="5462244">7</span><span class="op" id="5462245">]</span>&nbsp;<span class="op" id="5462247">=</span>&nbsp;<span class="ident" id="5462249">name</span><span class="op" id="5462253">[</span><span class="num" id="5462254">3</span><span class="op" id="5462255">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462258">crc</span>&nbsp;<span class="op" id="5462262">:=</span>&nbsp;<span class="ident" id="5462265">crc32</span><span class="op" id="5462270">.</span><span class="ident" id="5462271">NewIEEE</span><span class="op" id="5462278">(</span><span class="op" id="5462279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462282">crc</span><span class="op" id="5462285">.</span><span class="ident" id="5462286">Write</span><span class="op" id="5462291">(</span><span class="ident" id="5462292">e</span><span class="op" id="5462293">.</span><span class="ident" id="5462294">header</span><span class="op" id="5462300">[</span><span class="num" id="5462301">4</span><span class="op" id="5462302">:</span><span class="num" id="5462303">8</span><span class="op" id="5462304">]</span><span class="op" id="5462305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462308">crc</span><span class="op" id="5462311">.</span><span class="ident" id="5462312">Write</span><span class="op" id="5462317">(</span><span class="ident" id="5462318">b</span><span class="op" id="5462319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462322">writeUint32</span><span class="op" id="5462333">(</span><span class="ident" id="5462334">e</span><span class="op" id="5462335">.</span><span class="ident" id="5462336">footer</span><span class="op" id="5462342">[</span><span class="op" id="5462343">:</span><span class="num" id="5462344">4</span><span class="op" id="5462345">]</span><span class="op" id="5462346">,</span>&nbsp;<span class="ident" id="5462348">crc</span><span class="op" id="5462351">.</span><span class="ident" id="5462352">Sum32</span><span class="op" id="5462357">(</span><span class="op" id="5462358">)</span><span class="op" id="5462359">)</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462363">_</span><span class="op" id="5462364">,</span>&nbsp;<span class="ident" id="5462366">e</span><span class="op" id="5462367">.</span><span class="ident" id="5462368">err</span>&nbsp;<span class="op" id="5462372">=</span>&nbsp;<span class="ident" id="5462374">e</span><span class="op" id="5462375">.</span><span class="ident" id="5462376">w</span><span class="op" id="5462377">.</span><span class="ident" id="5462378">Write</span><span class="op" id="5462383">(</span><span class="ident" id="5462384">e</span><span class="op" id="5462385">.</span><span class="ident" id="5462386">header</span><span class="op" id="5462392">[</span><span class="op" id="5462393">:</span><span class="num" id="5462394">8</span><span class="op" id="5462395">]</span><span class="op" id="5462396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462399">if</span>&nbsp;<span class="ident" id="5462402">e</span><span class="op" id="5462403">.</span><span class="ident" id="5462404">err</span>&nbsp;<span class="op" id="5462408">!=</span>&nbsp;<span class="ident" id="5462411">nil</span>&nbsp;<span class="op" id="5462415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462419">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5462427">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462430">_</span><span class="op" id="5462431">,</span>&nbsp;<span class="ident" id="5462433">e</span><span class="op" id="5462434">.</span><span class="ident" id="5462435">err</span>&nbsp;<span class="op" id="5462439">=</span>&nbsp;<span class="ident" id="5462441">e</span><span class="op" id="5462442">.</span><span class="ident" id="5462443">w</span><span class="op" id="5462444">.</span><span class="ident" id="5462445">Write</span><span class="op" id="5462450">(</span><span class="ident" id="5462451">b</span><span class="op" id="5462452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462455">if</span>&nbsp;<span class="ident" id="5462458">e</span><span class="op" id="5462459">.</span><span class="ident" id="5462460">err</span>&nbsp;<span class="op" id="5462464">!=</span>&nbsp;<span class="ident" id="5462467">nil</span>&nbsp;<span class="op" id="5462471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462475">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5462483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462486">_</span><span class="op" id="5462487">,</span>&nbsp;<span class="ident" id="5462489">e</span><span class="op" id="5462490">.</span><span class="ident" id="5462491">err</span>&nbsp;<span class="op" id="5462495">=</span>&nbsp;<span class="ident" id="5462497">e</span><span class="op" id="5462498">.</span><span class="ident" id="5462499">w</span><span class="op" id="5462500">.</span><span class="ident" id="5462501">Write</span><span class="op" id="5462506">(</span><span class="ident" id="5462507">e</span><span class="op" id="5462508">.</span><span class="ident" id="5462509">footer</span><span class="op" id="5462515">[</span><span class="op" id="5462516">:</span><span class="num" id="5462517">4</span><span class="op" id="5462518">]</span><span class="op" id="5462519">)</span><br>
<span class="lineno">110</span><span class="op" id="5462521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5462524">func</span>&nbsp;<span class="op" id="5462529">(</span><span class="ident" id="5462530">e</span>&nbsp;<span class="op" id="5462532">*</span><span class="ident" id="5462533">encoder</span><span class="op" id="5462540">)</span>&nbsp;<span class="ident" id="5462542">writeIHDR</span><span class="op" id="5462551">(</span><span class="op" id="5462552">)</span>&nbsp;<span class="op" id="5462554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462557">b</span>&nbsp;<span class="op" id="5462559">:=</span>&nbsp;<span class="ident" id="5462562">e</span><span class="op" id="5462563">.</span><span class="ident" id="5462564">m</span><span class="op" id="5462565">.</span><span class="ident" id="5462566">Bounds</span><span class="op" id="5462572">(</span><span class="op" id="5462573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462576">writeUint32</span><span class="op" id="5462587">(</span><span class="ident" id="5462588">e</span><span class="op" id="5462589">.</span><span class="ident" id="5462590">tmp</span><span class="op" id="5462593">[</span><span class="num" id="5462594">0</span><span class="op" id="5462595">:</span><span class="num" id="5462596">4</span><span class="op" id="5462597">]</span><span class="op" id="5462598">,</span>&nbsp;<span class="builtintype" id="5462600">uint32</span><span class="op" id="5462606">(</span><span class="ident" id="5462607">b</span><span class="op" id="5462608">.</span><span class="ident" id="5462609">Dx</span><span class="op" id="5462611">(</span><span class="op" id="5462612">)</span><span class="op" id="5462613">)</span><span class="op" id="5462614">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462617">writeUint32</span><span class="op" id="5462628">(</span><span class="ident" id="5462629">e</span><span class="op" id="5462630">.</span><span class="ident" id="5462631">tmp</span><span class="op" id="5462634">[</span><span class="num" id="5462635">4</span><span class="op" id="5462636">:</span><span class="num" id="5462637">8</span><span class="op" id="5462638">]</span><span class="op" id="5462639">,</span>&nbsp;<span class="builtintype" id="5462641">uint32</span><span class="op" id="5462647">(</span><span class="ident" id="5462648">b</span><span class="op" id="5462649">.</span><span class="ident" id="5462650">Dy</span><span class="op" id="5462652">(</span><span class="op" id="5462653">)</span><span class="op" id="5462654">)</span><span class="op" id="5462655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5462658">//&nbsp;Set&nbsp;bit&nbsp;depth&nbsp;and&nbsp;color&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462692">switch</span>&nbsp;<span class="ident" id="5462699">e</span><span class="op" id="5462700">.</span><span class="ident" id="5462701">cb</span>&nbsp;<span class="op" id="5462704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462707">case</span>&nbsp;<span class="ident" id="5462712">cbG8</span><span class="op" id="5462716">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462720">e</span><span class="op" id="5462721">.</span><span class="ident" id="5462722">tmp</span><span class="op" id="5462725">[</span><span class="num" id="5462726">8</span><span class="op" id="5462727">]</span>&nbsp;<span class="op" id="5462729">=</span>&nbsp;<span class="num" id="5462731">8</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462735">e</span><span class="op" id="5462736">.</span><span class="ident" id="5462737">tmp</span><span class="op" id="5462740">[</span><span class="num" id="5462741">9</span><span class="op" id="5462742">]</span>&nbsp;<span class="op" id="5462744">=</span>&nbsp;<span class="ident" id="5462746">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462759">case</span>&nbsp;<span class="ident" id="5462764">cbTC8</span><span class="op" id="5462769">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462773">e</span><span class="op" id="5462774">.</span><span class="ident" id="5462775">tmp</span><span class="op" id="5462778">[</span><span class="num" id="5462779">8</span><span class="op" id="5462780">]</span>&nbsp;<span class="op" id="5462782">=</span>&nbsp;<span class="num" id="5462784">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462788">e</span><span class="op" id="5462789">.</span><span class="ident" id="5462790">tmp</span><span class="op" id="5462793">[</span><span class="num" id="5462794">9</span><span class="op" id="5462795">]</span>&nbsp;<span class="op" id="5462797">=</span>&nbsp;<span class="ident" id="5462799">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462812">case</span>&nbsp;<span class="ident" id="5462817">cbP8</span><span class="op" id="5462821">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462825">e</span><span class="op" id="5462826">.</span><span class="ident" id="5462827">tmp</span><span class="op" id="5462830">[</span><span class="num" id="5462831">8</span><span class="op" id="5462832">]</span>&nbsp;<span class="op" id="5462834">=</span>&nbsp;<span class="num" id="5462836">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462840">e</span><span class="op" id="5462841">.</span><span class="ident" id="5462842">tmp</span><span class="op" id="5462845">[</span><span class="num" id="5462846">9</span><span class="op" id="5462847">]</span>&nbsp;<span class="op" id="5462849">=</span>&nbsp;<span class="ident" id="5462851">ctPaletted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462863">case</span>&nbsp;<span class="ident" id="5462868">cbTCA8</span><span class="op" id="5462874">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462878">e</span><span class="op" id="5462879">.</span><span class="ident" id="5462880">tmp</span><span class="op" id="5462883">[</span><span class="num" id="5462884">8</span><span class="op" id="5462885">]</span>&nbsp;<span class="op" id="5462887">=</span>&nbsp;<span class="num" id="5462889">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462893">e</span><span class="op" id="5462894">.</span><span class="ident" id="5462895">tmp</span><span class="op" id="5462898">[</span><span class="num" id="5462899">9</span><span class="op" id="5462900">]</span>&nbsp;<span class="op" id="5462902">=</span>&nbsp;<span class="ident" id="5462904">ctTrueColorAlpha</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462922">case</span>&nbsp;<span class="ident" id="5462927">cbG16</span><span class="op" id="5462932">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462936">e</span><span class="op" id="5462937">.</span><span class="ident" id="5462938">tmp</span><span class="op" id="5462941">[</span><span class="num" id="5462942">8</span><span class="op" id="5462943">]</span>&nbsp;<span class="op" id="5462945">=</span>&nbsp;<span class="num" id="5462947">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462952">e</span><span class="op" id="5462953">.</span><span class="ident" id="5462954">tmp</span><span class="op" id="5462957">[</span><span class="num" id="5462958">9</span><span class="op" id="5462959">]</span>&nbsp;<span class="op" id="5462961">=</span>&nbsp;<span class="ident" id="5462963">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5462976">case</span>&nbsp;<span class="ident" id="5462981">cbTC16</span><span class="op" id="5462987">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5462991">e</span><span class="op" id="5462992">.</span><span class="ident" id="5462993">tmp</span><span class="op" id="5462996">[</span><span class="num" id="5462997">8</span><span class="op" id="5462998">]</span>&nbsp;<span class="op" id="5463000">=</span>&nbsp;<span class="num" id="5463002">16</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463007">e</span><span class="op" id="5463008">.</span><span class="ident" id="5463009">tmp</span><span class="op" id="5463012">[</span><span class="num" id="5463013">9</span><span class="op" id="5463014">]</span>&nbsp;<span class="op" id="5463016">=</span>&nbsp;<span class="ident" id="5463018">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463031">case</span>&nbsp;<span class="ident" id="5463036">cbTCA16</span><span class="op" id="5463043">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463047">e</span><span class="op" id="5463048">.</span><span class="ident" id="5463049">tmp</span><span class="op" id="5463052">[</span><span class="num" id="5463053">8</span><span class="op" id="5463054">]</span>&nbsp;<span class="op" id="5463056">=</span>&nbsp;<span class="num" id="5463058">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463063">e</span><span class="op" id="5463064">.</span><span class="ident" id="5463065">tmp</span><span class="op" id="5463068">[</span><span class="num" id="5463069">9</span><span class="op" id="5463070">]</span>&nbsp;<span class="op" id="5463072">=</span>&nbsp;<span class="ident" id="5463074">ctTrueColorAlpha</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5463092">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463095">e</span><span class="op" id="5463096">.</span><span class="ident" id="5463097">tmp</span><span class="op" id="5463100">[</span><span class="num" id="5463101">10</span><span class="op" id="5463103">]</span>&nbsp;<span class="op" id="5463105">=</span>&nbsp;<span class="num" id="5463107">0</span>&nbsp;<span class="comment" id="5463109">//&nbsp;default&nbsp;compression&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463140">e</span><span class="op" id="5463141">.</span><span class="ident" id="5463142">tmp</span><span class="op" id="5463145">[</span><span class="num" id="5463146">11</span><span class="op" id="5463148">]</span>&nbsp;<span class="op" id="5463150">=</span>&nbsp;<span class="num" id="5463152">0</span>&nbsp;<span class="comment" id="5463154">//&nbsp;default&nbsp;filter&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463180">e</span><span class="op" id="5463181">.</span><span class="ident" id="5463182">tmp</span><span class="op" id="5463185">[</span><span class="num" id="5463186">12</span><span class="op" id="5463188">]</span>&nbsp;<span class="op" id="5463190">=</span>&nbsp;<span class="num" id="5463192">0</span>&nbsp;<span class="comment" id="5463194">//&nbsp;non-interlaced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463213">e</span><span class="op" id="5463214">.</span><span class="ident" id="5463215">writeChunk</span><span class="op" id="5463225">(</span><span class="ident" id="5463226">e</span><span class="op" id="5463227">.</span><span class="ident" id="5463228">tmp</span><span class="op" id="5463231">[</span><span class="op" id="5463232">:</span><span class="num" id="5463233">13</span><span class="op" id="5463235">]</span><span class="op" id="5463236">,</span>&nbsp;<span class="string" id="5463238">&#34;IHDR&#34;</span><span class="op" id="5463244">)</span><br>
<span class="lineno"></span><span class="op" id="5463246">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="keyword" id="5463249">func</span>&nbsp;<span class="op" id="5463254">(</span><span class="ident" id="5463255">e</span>&nbsp;<span class="op" id="5463257">*</span><span class="ident" id="5463258">encoder</span><span class="op" id="5463265">)</span>&nbsp;<span class="ident" id="5463267">writePLTEAndTRNS</span><span class="op" id="5463283">(</span><span class="ident" id="5463284">p</span>&nbsp;<span class="ident" id="5463286">color</span><span class="op" id="5463291">.</span><span class="ident" id="5463292">Palette</span><span class="op" id="5463299">)</span>&nbsp;<span class="op" id="5463301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463304">if</span>&nbsp;<span class="builtinfunc" id="5463307">len</span><span class="op" id="5463310">(</span><span class="ident" id="5463311">p</span><span class="op" id="5463312">)</span>&nbsp;<span class="op" id="5463314">&lt;</span>&nbsp;<span class="num" id="5463316">1</span>&nbsp;<span class="op" id="5463318">||</span>&nbsp;<span class="builtinfunc" id="5463321">len</span><span class="op" id="5463324">(</span><span class="ident" id="5463325">p</span><span class="op" id="5463326">)</span>&nbsp;<span class="op" id="5463328">&gt;</span>&nbsp;<span class="num" id="5463330">256</span>&nbsp;<span class="op" id="5463334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463338">e</span><span class="op" id="5463339">.</span><span class="ident" id="5463340">err</span>&nbsp;<span class="op" id="5463344">=</span>&nbsp;<span class="ident" id="5463346">FormatError</span><span class="op" id="5463357">(</span><span class="string" id="5463358">&#34;bad&nbsp;palette&nbsp;length:&nbsp;&#34;</span>&nbsp;<span class="op" id="5463381">+</span>&nbsp;<span class="ident" id="5463383">strconv</span><span class="op" id="5463390">.</span><span class="ident" id="5463391">Itoa</span><span class="op" id="5463395">(</span><span class="builtinfunc" id="5463396">len</span><span class="op" id="5463399">(</span><span class="ident" id="5463400">p</span><span class="op" id="5463401">)</span><span class="op" id="5463402">)</span><span class="op" id="5463403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463407">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5463415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463418">last</span>&nbsp;<span class="op" id="5463423">:=</span>&nbsp;<span class="op" id="5463426">-</span><span class="num" id="5463427">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463430">for</span>&nbsp;<span class="ident" id="5463434">i</span><span class="op" id="5463435">,</span>&nbsp;<span class="ident" id="5463437">c</span>&nbsp;<span class="op" id="5463439">:=</span>&nbsp;<span class="keyword" id="5463442">range</span>&nbsp;<span class="ident" id="5463448">p</span>&nbsp;<span class="op" id="5463450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463454">c1</span>&nbsp;<span class="op" id="5463457">:=</span>&nbsp;<span class="ident" id="5463460">color</span><span class="op" id="5463465">.</span><span class="ident" id="5463466">NRGBAModel</span><span class="op" id="5463476">.</span><span class="ident" id="5463477">Convert</span><span class="op" id="5463484">(</span><span class="ident" id="5463485">c</span><span class="op" id="5463486">)</span><span class="op" id="5463487">.</span><span class="op" id="5463488">(</span><span class="ident" id="5463489">color</span><span class="op" id="5463494">.</span><span class="ident" id="5463495">NRGBA</span><span class="op" id="5463500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463504">e</span><span class="op" id="5463505">.</span><span class="ident" id="5463506">tmp</span><span class="op" id="5463509">[</span><span class="num" id="5463510">3</span><span class="op" id="5463511">*</span><span class="ident" id="5463512">i</span><span class="op" id="5463513">+</span><span class="num" id="5463514">0</span><span class="op" id="5463515">]</span>&nbsp;<span class="op" id="5463517">=</span>&nbsp;<span class="ident" id="5463519">c1</span><span class="op" id="5463521">.</span><span class="ident" id="5463522">R</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463526">e</span><span class="op" id="5463527">.</span><span class="ident" id="5463528">tmp</span><span class="op" id="5463531">[</span><span class="num" id="5463532">3</span><span class="op" id="5463533">*</span><span class="ident" id="5463534">i</span><span class="op" id="5463535">+</span><span class="num" id="5463536">1</span><span class="op" id="5463537">]</span>&nbsp;<span class="op" id="5463539">=</span>&nbsp;<span class="ident" id="5463541">c1</span><span class="op" id="5463543">.</span><span class="ident" id="5463544">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463548">e</span><span class="op" id="5463549">.</span><span class="ident" id="5463550">tmp</span><span class="op" id="5463553">[</span><span class="num" id="5463554">3</span><span class="op" id="5463555">*</span><span class="ident" id="5463556">i</span><span class="op" id="5463557">+</span><span class="num" id="5463558">2</span><span class="op" id="5463559">]</span>&nbsp;<span class="op" id="5463561">=</span>&nbsp;<span class="ident" id="5463563">c1</span><span class="op" id="5463565">.</span><span class="ident" id="5463566">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463570">if</span>&nbsp;<span class="ident" id="5463573">c1</span><span class="op" id="5463575">.</span><span class="ident" id="5463576">A</span>&nbsp;<span class="op" id="5463578">!=</span>&nbsp;<span class="num" id="5463581">0xff</span>&nbsp;<span class="op" id="5463586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463591">last</span>&nbsp;<span class="op" id="5463596">=</span>&nbsp;<span class="ident" id="5463598">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5463602">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463606">e</span><span class="op" id="5463607">.</span><span class="ident" id="5463608">tmp</span><span class="op" id="5463611">[</span><span class="num" id="5463612">3</span><span class="op" id="5463613">*</span><span class="num" id="5463614">256</span><span class="op" id="5463617">+</span><span class="ident" id="5463618">i</span><span class="op" id="5463619">]</span>&nbsp;<span class="op" id="5463621">=</span>&nbsp;<span class="ident" id="5463623">c1</span><span class="op" id="5463625">.</span><span class="ident" id="5463626">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5463629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463632">e</span><span class="op" id="5463633">.</span><span class="ident" id="5463634">writeChunk</span><span class="op" id="5463644">(</span><span class="ident" id="5463645">e</span><span class="op" id="5463646">.</span><span class="ident" id="5463647">tmp</span><span class="op" id="5463650">[</span><span class="op" id="5463651">:</span><span class="num" id="5463652">3</span><span class="op" id="5463653">*</span><span class="builtinfunc" id="5463654">len</span><span class="op" id="5463657">(</span><span class="ident" id="5463658">p</span><span class="op" id="5463659">)</span><span class="op" id="5463660">]</span><span class="op" id="5463661">,</span>&nbsp;<span class="string" id="5463663">&#34;PLTE&#34;</span><span class="op" id="5463669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5463672">if</span>&nbsp;<span class="ident" id="5463675">last</span>&nbsp;<span class="op" id="5463680">!=</span>&nbsp;<span class="op" id="5463683">-</span><span class="num" id="5463684">1</span>&nbsp;<span class="op" id="5463686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463690">e</span><span class="op" id="5463691">.</span><span class="ident" id="5463692">writeChunk</span><span class="op" id="5463702">(</span><span class="ident" id="5463703">e</span><span class="op" id="5463704">.</span><span class="ident" id="5463705">tmp</span><span class="op" id="5463708">[</span><span class="num" id="5463709">3</span><span class="op" id="5463710">*</span><span class="num" id="5463711">256</span><span class="op" id="5463714">:</span><span class="num" id="5463715">3</span><span class="op" id="5463716">*</span><span class="num" id="5463717">256</span><span class="op" id="5463720">+</span><span class="num" id="5463721">1</span><span class="op" id="5463722">+</span><span class="ident" id="5463723">last</span><span class="op" id="5463727">]</span><span class="op" id="5463728">,</span>&nbsp;<span class="string" id="5463730">&#34;tRNS&#34;</span><span class="op" id="5463736">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5463739">}</span><br>
<span class="lineno"></span><span class="op" id="5463741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5463744">//&nbsp;An&nbsp;encoder&nbsp;is&nbsp;an&nbsp;io.Writer&nbsp;that&nbsp;satisfies&nbsp;writes&nbsp;by&nbsp;writing&nbsp;PNG&nbsp;IDAT&nbsp;chunks,</span><br>
<span class="lineno"></span><span class="comment" id="5463824">//&nbsp;including&nbsp;an&nbsp;8-byte&nbsp;header&nbsp;and&nbsp;4-byte&nbsp;CRC&nbsp;checksum&nbsp;per&nbsp;Write&nbsp;call.&nbsp;Such&nbsp;calls</span><br>
<span class="lineno">170</span><span class="comment" id="5463905">//&nbsp;should&nbsp;be&nbsp;relatively&nbsp;infrequent,&nbsp;since&nbsp;writeIDATs&nbsp;uses&nbsp;a&nbsp;bufio.Writer.</span><br>
<span class="lineno"></span><span class="comment" id="5463979">//</span><br>
<span class="lineno"></span><span class="comment" id="5463982">//&nbsp;This&nbsp;method&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;writeIDATs&nbsp;(via&nbsp;writeImage).</span><br>
<span class="lineno"></span><span class="comment" id="5464053">//&nbsp;No&nbsp;other&nbsp;code&nbsp;should&nbsp;treat&nbsp;an&nbsp;encoder&nbsp;as&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5464111">func</span>&nbsp;<span class="op" id="5464116">(</span><span class="ident" id="5464117">e</span>&nbsp;<span class="op" id="5464119">*</span><span class="ident" id="5464120">encoder</span><span class="op" id="5464127">)</span>&nbsp;<span class="ident" id="5464129">Write</span><span class="op" id="5464134">(</span><span class="ident" id="5464135">b</span>&nbsp;<span class="op" id="5464137">[</span><span class="op" id="5464138">]</span><span class="builtintype" id="5464139">byte</span><span class="op" id="5464143">)</span>&nbsp;<span class="op" id="5464145">(</span><span class="builtintype" id="5464146">int</span><span class="op" id="5464149">,</span>&nbsp;<span class="builtintype" id="5464151">error</span><span class="op" id="5464156">)</span>&nbsp;<span class="op" id="5464158">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464161">e</span><span class="op" id="5464162">.</span><span class="ident" id="5464163">writeChunk</span><span class="op" id="5464173">(</span><span class="ident" id="5464174">b</span><span class="op" id="5464175">,</span>&nbsp;<span class="string" id="5464177">&#34;IDAT&#34;</span><span class="op" id="5464183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5464186">if</span>&nbsp;<span class="ident" id="5464189">e</span><span class="op" id="5464190">.</span><span class="ident" id="5464191">err</span>&nbsp;<span class="op" id="5464195">!=</span>&nbsp;<span class="ident" id="5464198">nil</span>&nbsp;<span class="op" id="5464202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5464206">return</span>&nbsp;<span class="num" id="5464213">0</span><span class="op" id="5464214">,</span>&nbsp;<span class="ident" id="5464216">e</span><span class="op" id="5464217">.</span><span class="ident" id="5464218">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5464223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5464226">return</span>&nbsp;<span class="builtinfunc" id="5464233">len</span><span class="op" id="5464236">(</span><span class="ident" id="5464237">b</span><span class="op" id="5464238">)</span><span class="op" id="5464239">,</span>&nbsp;<span class="ident" id="5464241">nil</span><br>
<span class="lineno">180</span><span class="op" id="5464245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5464248">//&nbsp;Chooses&nbsp;the&nbsp;filter&nbsp;to&nbsp;use&nbsp;for&nbsp;encoding&nbsp;the&nbsp;current&nbsp;row,&nbsp;and&nbsp;applies&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="5464323">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;filter&nbsp;and&nbsp;also&nbsp;of&nbsp;the&nbsp;row&nbsp;in&nbsp;cr&nbsp;that&nbsp;has&nbsp;had&nbsp;it&nbsp;applied.</span><br>
<span class="lineno"></span><span class="keyword" id="5464421">func</span>&nbsp;<span class="ident" id="5464426">filter</span><span class="op" id="5464432">(</span><span class="ident" id="5464433">cr</span>&nbsp;<span class="op" id="5464436">*</span><span class="op" id="5464437">[</span><span class="ident" id="5464438">nFilter</span><span class="op" id="5464445">]</span><span class="op" id="5464446">[</span><span class="op" id="5464447">]</span><span class="builtintype" id="5464448">byte</span><span class="op" id="5464452">,</span>&nbsp;<span class="ident" id="5464454">pr</span>&nbsp;<span class="op" id="5464457">[</span><span class="op" id="5464458">]</span><span class="builtintype" id="5464459">byte</span><span class="op" id="5464463">,</span>&nbsp;<span class="ident" id="5464465">bpp</span>&nbsp;<span class="builtintype" id="5464469">int</span><span class="op" id="5464472">)</span>&nbsp;<span class="builtintype" id="5464474">int</span>&nbsp;<span class="op" id="5464478">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5464481">//&nbsp;We&nbsp;try&nbsp;all&nbsp;five&nbsp;filter&nbsp;types,&nbsp;and&nbsp;pick&nbsp;the&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;the&nbsp;sum&nbsp;of&nbsp;absolute&nbsp;differences.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5464580">//&nbsp;This&nbsp;is&nbsp;the&nbsp;same&nbsp;heuristic&nbsp;that&nbsp;libpng&nbsp;uses,&nbsp;although&nbsp;the&nbsp;filters&nbsp;are&nbsp;attempted&nbsp;in&nbsp;order&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5464676">//&nbsp;estimated&nbsp;most&nbsp;likely&nbsp;to&nbsp;be&nbsp;minimal&nbsp;(ftUp,&nbsp;ftPaeth,&nbsp;ftNone,&nbsp;ftSub,&nbsp;ftAverage),&nbsp;rather&nbsp;than</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5464771">//&nbsp;in&nbsp;their&nbsp;enumeration&nbsp;order&nbsp;(ftNone,&nbsp;ftSub,&nbsp;ftUp,&nbsp;ftAverage,&nbsp;ftPaeth).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464845">cdat0</span>&nbsp;<span class="op" id="5464851">:=</span>&nbsp;<span class="ident" id="5464854">cr</span><span class="op" id="5464856">[</span><span class="num" id="5464857">0</span><span class="op" id="5464858">]</span><span class="op" id="5464859">[</span><span class="num" id="5464860">1</span><span class="op" id="5464861">:</span><span class="op" id="5464862">]</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464865">cdat1</span>&nbsp;<span class="op" id="5464871">:=</span>&nbsp;<span class="ident" id="5464874">cr</span><span class="op" id="5464876">[</span><span class="num" id="5464877">1</span><span class="op" id="5464878">]</span><span class="op" id="5464879">[</span><span class="num" id="5464880">1</span><span class="op" id="5464881">:</span><span class="op" id="5464882">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464885">cdat2</span>&nbsp;<span class="op" id="5464891">:=</span>&nbsp;<span class="ident" id="5464894">cr</span><span class="op" id="5464896">[</span><span class="num" id="5464897">2</span><span class="op" id="5464898">]</span><span class="op" id="5464899">[</span><span class="num" id="5464900">1</span><span class="op" id="5464901">:</span><span class="op" id="5464902">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464905">cdat3</span>&nbsp;<span class="op" id="5464911">:=</span>&nbsp;<span class="ident" id="5464914">cr</span><span class="op" id="5464916">[</span><span class="num" id="5464917">3</span><span class="op" id="5464918">]</span><span class="op" id="5464919">[</span><span class="num" id="5464920">1</span><span class="op" id="5464921">:</span><span class="op" id="5464922">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464925">cdat4</span>&nbsp;<span class="op" id="5464931">:=</span>&nbsp;<span class="ident" id="5464934">cr</span><span class="op" id="5464936">[</span><span class="num" id="5464937">4</span><span class="op" id="5464938">]</span><span class="op" id="5464939">[</span><span class="num" id="5464940">1</span><span class="op" id="5464941">:</span><span class="op" id="5464942">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464945">pdat</span>&nbsp;<span class="op" id="5464950">:=</span>&nbsp;<span class="ident" id="5464953">pr</span><span class="op" id="5464955">[</span><span class="num" id="5464956">1</span><span class="op" id="5464957">:</span><span class="op" id="5464958">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464961">n</span>&nbsp;<span class="op" id="5464963">:=</span>&nbsp;<span class="builtinfunc" id="5464966">len</span><span class="op" id="5464969">(</span><span class="ident" id="5464970">cdat0</span><span class="op" id="5464975">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5464979">//&nbsp;The&nbsp;up&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464998">sum</span>&nbsp;<span class="op" id="5465002">:=</span>&nbsp;<span class="num" id="5465005">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465008">for</span>&nbsp;<span class="ident" id="5465012">i</span>&nbsp;<span class="op" id="5465014">:=</span>&nbsp;<span class="num" id="5465017">0</span><span class="op" id="5465018">;</span>&nbsp;<span class="ident" id="5465020">i</span>&nbsp;<span class="op" id="5465022">&lt;</span>&nbsp;<span class="ident" id="5465024">n</span><span class="op" id="5465025">;</span>&nbsp;<span class="ident" id="5465027">i</span><span class="op" id="5465028">++</span>&nbsp;<span class="op" id="5465031">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465035">cdat2</span><span class="op" id="5465040">[</span><span class="ident" id="5465041">i</span><span class="op" id="5465042">]</span>&nbsp;<span class="op" id="5465044">=</span>&nbsp;<span class="ident" id="5465046">cdat0</span><span class="op" id="5465051">[</span><span class="ident" id="5465052">i</span><span class="op" id="5465053">]</span>&nbsp;<span class="op" id="5465055">-</span>&nbsp;<span class="ident" id="5465057">pdat</span><span class="op" id="5465061">[</span><span class="ident" id="5465062">i</span><span class="op" id="5465063">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465067">sum</span>&nbsp;<span class="op" id="5465071">+=</span>&nbsp;<span class="ident" id="5465074">abs8</span><span class="op" id="5465078">(</span><span class="ident" id="5465079">cdat2</span><span class="op" id="5465084">[</span><span class="ident" id="5465085">i</span><span class="op" id="5465086">]</span><span class="op" id="5465087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465093">best</span>&nbsp;<span class="op" id="5465098">:=</span>&nbsp;<span class="ident" id="5465101">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465106">filter</span>&nbsp;<span class="op" id="5465113">:=</span>&nbsp;<span class="ident" id="5465116">ftUp</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5465123">//&nbsp;The&nbsp;Paeth&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465145">sum</span>&nbsp;<span class="op" id="5465149">=</span>&nbsp;<span class="num" id="5465151">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465154">for</span>&nbsp;<span class="ident" id="5465158">i</span>&nbsp;<span class="op" id="5465160">:=</span>&nbsp;<span class="num" id="5465163">0</span><span class="op" id="5465164">;</span>&nbsp;<span class="ident" id="5465166">i</span>&nbsp;<span class="op" id="5465168">&lt;</span>&nbsp;<span class="ident" id="5465170">bpp</span><span class="op" id="5465173">;</span>&nbsp;<span class="ident" id="5465175">i</span><span class="op" id="5465176">++</span>&nbsp;<span class="op" id="5465179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465183">cdat4</span><span class="op" id="5465188">[</span><span class="ident" id="5465189">i</span><span class="op" id="5465190">]</span>&nbsp;<span class="op" id="5465192">=</span>&nbsp;<span class="ident" id="5465194">cdat0</span><span class="op" id="5465199">[</span><span class="ident" id="5465200">i</span><span class="op" id="5465201">]</span>&nbsp;<span class="op" id="5465203">-</span>&nbsp;<span class="ident" id="5465205">pdat</span><span class="op" id="5465209">[</span><span class="ident" id="5465210">i</span><span class="op" id="5465211">]</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465215">sum</span>&nbsp;<span class="op" id="5465219">+=</span>&nbsp;<span class="ident" id="5465222">abs8</span><span class="op" id="5465226">(</span><span class="ident" id="5465227">cdat4</span><span class="op" id="5465232">[</span><span class="ident" id="5465233">i</span><span class="op" id="5465234">]</span><span class="op" id="5465235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465241">for</span>&nbsp;<span class="ident" id="5465245">i</span>&nbsp;<span class="op" id="5465247">:=</span>&nbsp;<span class="ident" id="5465250">bpp</span><span class="op" id="5465253">;</span>&nbsp;<span class="ident" id="5465255">i</span>&nbsp;<span class="op" id="5465257">&lt;</span>&nbsp;<span class="ident" id="5465259">n</span><span class="op" id="5465260">;</span>&nbsp;<span class="ident" id="5465262">i</span><span class="op" id="5465263">++</span>&nbsp;<span class="op" id="5465266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465270">cdat4</span><span class="op" id="5465275">[</span><span class="ident" id="5465276">i</span><span class="op" id="5465277">]</span>&nbsp;<span class="op" id="5465279">=</span>&nbsp;<span class="ident" id="5465281">cdat0</span><span class="op" id="5465286">[</span><span class="ident" id="5465287">i</span><span class="op" id="5465288">]</span>&nbsp;<span class="op" id="5465290">-</span>&nbsp;<span class="ident" id="5465292">paeth</span><span class="op" id="5465297">(</span><span class="ident" id="5465298">cdat0</span><span class="op" id="5465303">[</span><span class="ident" id="5465304">i</span><span class="op" id="5465305">-</span><span class="ident" id="5465306">bpp</span><span class="op" id="5465309">]</span><span class="op" id="5465310">,</span>&nbsp;<span class="ident" id="5465312">pdat</span><span class="op" id="5465316">[</span><span class="ident" id="5465317">i</span><span class="op" id="5465318">]</span><span class="op" id="5465319">,</span>&nbsp;<span class="ident" id="5465321">pdat</span><span class="op" id="5465325">[</span><span class="ident" id="5465326">i</span><span class="op" id="5465327">-</span><span class="ident" id="5465328">bpp</span><span class="op" id="5465331">]</span><span class="op" id="5465332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465336">sum</span>&nbsp;<span class="op" id="5465340">+=</span>&nbsp;<span class="ident" id="5465343">abs8</span><span class="op" id="5465347">(</span><span class="ident" id="5465348">cdat4</span><span class="op" id="5465353">[</span><span class="ident" id="5465354">i</span><span class="op" id="5465355">]</span><span class="op" id="5465356">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465360">if</span>&nbsp;<span class="ident" id="5465363">sum</span>&nbsp;<span class="op" id="5465367">&gt;=</span>&nbsp;<span class="ident" id="5465370">best</span>&nbsp;<span class="op" id="5465375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465380">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465394">if</span>&nbsp;<span class="ident" id="5465397">sum</span>&nbsp;<span class="op" id="5465401">&lt;</span>&nbsp;<span class="ident" id="5465403">best</span>&nbsp;<span class="op" id="5465408">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465412">best</span>&nbsp;<span class="op" id="5465417">=</span>&nbsp;<span class="ident" id="5465419">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465425">filter</span>&nbsp;<span class="op" id="5465432">=</span>&nbsp;<span class="ident" id="5465434">ftPaeth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5465447">//&nbsp;The&nbsp;none&nbsp;filter.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465468">sum</span>&nbsp;<span class="op" id="5465472">=</span>&nbsp;<span class="num" id="5465474">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465477">for</span>&nbsp;<span class="ident" id="5465481">i</span>&nbsp;<span class="op" id="5465483">:=</span>&nbsp;<span class="num" id="5465486">0</span><span class="op" id="5465487">;</span>&nbsp;<span class="ident" id="5465489">i</span>&nbsp;<span class="op" id="5465491">&lt;</span>&nbsp;<span class="ident" id="5465493">n</span><span class="op" id="5465494">;</span>&nbsp;<span class="ident" id="5465496">i</span><span class="op" id="5465497">++</span>&nbsp;<span class="op" id="5465500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465504">sum</span>&nbsp;<span class="op" id="5465508">+=</span>&nbsp;<span class="ident" id="5465511">abs8</span><span class="op" id="5465515">(</span><span class="ident" id="5465516">cdat0</span><span class="op" id="5465521">[</span><span class="ident" id="5465522">i</span><span class="op" id="5465523">]</span><span class="op" id="5465524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465528">if</span>&nbsp;<span class="ident" id="5465531">sum</span>&nbsp;<span class="op" id="5465535">&gt;=</span>&nbsp;<span class="ident" id="5465538">best</span>&nbsp;<span class="op" id="5465543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465548">break</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465562">if</span>&nbsp;<span class="ident" id="5465565">sum</span>&nbsp;<span class="op" id="5465569">&lt;</span>&nbsp;<span class="ident" id="5465571">best</span>&nbsp;<span class="op" id="5465576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465580">best</span>&nbsp;<span class="op" id="5465585">=</span>&nbsp;<span class="ident" id="5465587">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465593">filter</span>&nbsp;<span class="op" id="5465600">=</span>&nbsp;<span class="ident" id="5465602">ftNone</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5465614">//&nbsp;The&nbsp;sub&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465634">sum</span>&nbsp;<span class="op" id="5465638">=</span>&nbsp;<span class="num" id="5465640">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465643">for</span>&nbsp;<span class="ident" id="5465647">i</span>&nbsp;<span class="op" id="5465649">:=</span>&nbsp;<span class="num" id="5465652">0</span><span class="op" id="5465653">;</span>&nbsp;<span class="ident" id="5465655">i</span>&nbsp;<span class="op" id="5465657">&lt;</span>&nbsp;<span class="ident" id="5465659">bpp</span><span class="op" id="5465662">;</span>&nbsp;<span class="ident" id="5465664">i</span><span class="op" id="5465665">++</span>&nbsp;<span class="op" id="5465668">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465672">cdat1</span><span class="op" id="5465677">[</span><span class="ident" id="5465678">i</span><span class="op" id="5465679">]</span>&nbsp;<span class="op" id="5465681">=</span>&nbsp;<span class="ident" id="5465683">cdat0</span><span class="op" id="5465688">[</span><span class="ident" id="5465689">i</span><span class="op" id="5465690">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465694">sum</span>&nbsp;<span class="op" id="5465698">+=</span>&nbsp;<span class="ident" id="5465701">abs8</span><span class="op" id="5465705">(</span><span class="ident" id="5465706">cdat1</span><span class="op" id="5465711">[</span><span class="ident" id="5465712">i</span><span class="op" id="5465713">]</span><span class="op" id="5465714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465720">for</span>&nbsp;<span class="ident" id="5465724">i</span>&nbsp;<span class="op" id="5465726">:=</span>&nbsp;<span class="ident" id="5465729">bpp</span><span class="op" id="5465732">;</span>&nbsp;<span class="ident" id="5465734">i</span>&nbsp;<span class="op" id="5465736">&lt;</span>&nbsp;<span class="ident" id="5465738">n</span><span class="op" id="5465739">;</span>&nbsp;<span class="ident" id="5465741">i</span><span class="op" id="5465742">++</span>&nbsp;<span class="op" id="5465745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465749">cdat1</span><span class="op" id="5465754">[</span><span class="ident" id="5465755">i</span><span class="op" id="5465756">]</span>&nbsp;<span class="op" id="5465758">=</span>&nbsp;<span class="ident" id="5465760">cdat0</span><span class="op" id="5465765">[</span><span class="ident" id="5465766">i</span><span class="op" id="5465767">]</span>&nbsp;<span class="op" id="5465769">-</span>&nbsp;<span class="ident" id="5465771">cdat0</span><span class="op" id="5465776">[</span><span class="ident" id="5465777">i</span><span class="op" id="5465778">-</span><span class="ident" id="5465779">bpp</span><span class="op" id="5465782">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465786">sum</span>&nbsp;<span class="op" id="5465790">+=</span>&nbsp;<span class="ident" id="5465793">abs8</span><span class="op" id="5465797">(</span><span class="ident" id="5465798">cdat1</span><span class="op" id="5465803">[</span><span class="ident" id="5465804">i</span><span class="op" id="5465805">]</span><span class="op" id="5465806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465810">if</span>&nbsp;<span class="ident" id="5465813">sum</span>&nbsp;<span class="op" id="5465817">&gt;=</span>&nbsp;<span class="ident" id="5465820">best</span>&nbsp;<span class="op" id="5465825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465830">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465841">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465844">if</span>&nbsp;<span class="ident" id="5465847">sum</span>&nbsp;<span class="op" id="5465851">&lt;</span>&nbsp;<span class="ident" id="5465853">best</span>&nbsp;<span class="op" id="5465858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465862">best</span>&nbsp;<span class="op" id="5465867">=</span>&nbsp;<span class="ident" id="5465869">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465875">filter</span>&nbsp;<span class="op" id="5465882">=</span>&nbsp;<span class="ident" id="5465884">ftSub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5465895">//&nbsp;The&nbsp;average&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465919">sum</span>&nbsp;<span class="op" id="5465923">=</span>&nbsp;<span class="num" id="5465925">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465928">for</span>&nbsp;<span class="ident" id="5465932">i</span>&nbsp;<span class="op" id="5465934">:=</span>&nbsp;<span class="num" id="5465937">0</span><span class="op" id="5465938">;</span>&nbsp;<span class="ident" id="5465940">i</span>&nbsp;<span class="op" id="5465942">&lt;</span>&nbsp;<span class="ident" id="5465944">bpp</span><span class="op" id="5465947">;</span>&nbsp;<span class="ident" id="5465949">i</span><span class="op" id="5465950">++</span>&nbsp;<span class="op" id="5465953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465957">cdat3</span><span class="op" id="5465962">[</span><span class="ident" id="5465963">i</span><span class="op" id="5465964">]</span>&nbsp;<span class="op" id="5465966">=</span>&nbsp;<span class="ident" id="5465968">cdat0</span><span class="op" id="5465973">[</span><span class="ident" id="5465974">i</span><span class="op" id="5465975">]</span>&nbsp;<span class="op" id="5465977">-</span>&nbsp;<span class="ident" id="5465979">pdat</span><span class="op" id="5465983">[</span><span class="ident" id="5465984">i</span><span class="op" id="5465985">]</span><span class="op" id="5465986">/</span><span class="num" id="5465987">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465991">sum</span>&nbsp;<span class="op" id="5465995">+=</span>&nbsp;<span class="ident" id="5465998">abs8</span><span class="op" id="5466002">(</span><span class="ident" id="5466003">cdat3</span><span class="op" id="5466008">[</span><span class="ident" id="5466009">i</span><span class="op" id="5466010">]</span><span class="op" id="5466011">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5466014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466017">for</span>&nbsp;<span class="ident" id="5466021">i</span>&nbsp;<span class="op" id="5466023">:=</span>&nbsp;<span class="ident" id="5466026">bpp</span><span class="op" id="5466029">;</span>&nbsp;<span class="ident" id="5466031">i</span>&nbsp;<span class="op" id="5466033">&lt;</span>&nbsp;<span class="ident" id="5466035">n</span><span class="op" id="5466036">;</span>&nbsp;<span class="ident" id="5466038">i</span><span class="op" id="5466039">++</span>&nbsp;<span class="op" id="5466042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466046">cdat3</span><span class="op" id="5466051">[</span><span class="ident" id="5466052">i</span><span class="op" id="5466053">]</span>&nbsp;<span class="op" id="5466055">=</span>&nbsp;<span class="ident" id="5466057">cdat0</span><span class="op" id="5466062">[</span><span class="ident" id="5466063">i</span><span class="op" id="5466064">]</span>&nbsp;<span class="op" id="5466066">-</span>&nbsp;<span class="builtintype" id="5466068">uint8</span><span class="op" id="5466073">(</span><span class="op" id="5466074">(</span><span class="builtintype" id="5466075">int</span><span class="op" id="5466078">(</span><span class="ident" id="5466079">cdat0</span><span class="op" id="5466084">[</span><span class="ident" id="5466085">i</span><span class="op" id="5466086">-</span><span class="ident" id="5466087">bpp</span><span class="op" id="5466090">]</span><span class="op" id="5466091">)</span><span class="op" id="5466092">+</span><span class="builtintype" id="5466093">int</span><span class="op" id="5466096">(</span><span class="ident" id="5466097">pdat</span><span class="op" id="5466101">[</span><span class="ident" id="5466102">i</span><span class="op" id="5466103">]</span><span class="op" id="5466104">)</span><span class="op" id="5466105">)</span><span class="op" id="5466106">/</span><span class="num" id="5466107">2</span><span class="op" id="5466108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466112">sum</span>&nbsp;<span class="op" id="5466116">+=</span>&nbsp;<span class="ident" id="5466119">abs8</span><span class="op" id="5466123">(</span><span class="ident" id="5466124">cdat3</span><span class="op" id="5466129">[</span><span class="ident" id="5466130">i</span><span class="op" id="5466131">]</span><span class="op" id="5466132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466136">if</span>&nbsp;<span class="ident" id="5466139">sum</span>&nbsp;<span class="op" id="5466143">&gt;=</span>&nbsp;<span class="ident" id="5466146">best</span>&nbsp;<span class="op" id="5466151">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466156">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5466164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5466167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466170">if</span>&nbsp;<span class="ident" id="5466173">sum</span>&nbsp;<span class="op" id="5466177">&lt;</span>&nbsp;<span class="ident" id="5466179">best</span>&nbsp;<span class="op" id="5466184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466188">best</span>&nbsp;<span class="op" id="5466193">=</span>&nbsp;<span class="ident" id="5466195">sum</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466201">filter</span>&nbsp;<span class="op" id="5466208">=</span>&nbsp;<span class="ident" id="5466210">ftAverage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5466221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466225">return</span>&nbsp;<span class="ident" id="5466232">filter</span><br>
<span class="lineno"></span><span class="op" id="5466239">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span><span class="keyword" id="5466242">func</span>&nbsp;<span class="ident" id="5466247">writeImage</span><span class="op" id="5466257">(</span><span class="ident" id="5466258">w</span>&nbsp;<span class="ident" id="5466260">io</span><span class="op" id="5466262">.</span><span class="ident" id="5466263">Writer</span><span class="op" id="5466269">,</span>&nbsp;<span class="ident" id="5466271">m</span>&nbsp;<span class="ident" id="5466273">image</span><span class="op" id="5466278">.</span><span class="ident" id="5466279">Image</span><span class="op" id="5466284">,</span>&nbsp;<span class="ident" id="5466286">cb</span>&nbsp;<span class="builtintype" id="5466289">int</span><span class="op" id="5466292">,</span>&nbsp;<span class="ident" id="5466294">level</span>&nbsp;<span class="builtintype" id="5466300">int</span><span class="op" id="5466303">)</span>&nbsp;<span class="builtintype" id="5466305">error</span>&nbsp;<span class="op" id="5466311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466314">zw</span><span class="op" id="5466316">,</span>&nbsp;<span class="ident" id="5466318">err</span>&nbsp;<span class="op" id="5466322">:=</span>&nbsp;<span class="ident" id="5466325">zlib</span><span class="op" id="5466329">.</span><span class="ident" id="5466330">NewWriterLevel</span><span class="op" id="5466344">(</span><span class="ident" id="5466345">w</span><span class="op" id="5466346">,</span>&nbsp;<span class="ident" id="5466348">level</span><span class="op" id="5466353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466356">if</span>&nbsp;<span class="ident" id="5466359">err</span>&nbsp;<span class="op" id="5466363">!=</span>&nbsp;<span class="ident" id="5466366">nil</span>&nbsp;<span class="op" id="5466370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466374">return</span>&nbsp;<span class="ident" id="5466381">err</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5466386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466389">defer</span>&nbsp;<span class="ident" id="5466395">zw</span><span class="op" id="5466397">.</span><span class="ident" id="5466398">Close</span><span class="op" id="5466403">(</span><span class="op" id="5466404">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466408">bpp</span>&nbsp;<span class="op" id="5466412">:=</span>&nbsp;<span class="num" id="5466415">0</span>&nbsp;<span class="comment" id="5466417">//&nbsp;Bytes&nbsp;per&nbsp;pixel.</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466439">switch</span>&nbsp;<span class="ident" id="5466446">cb</span>&nbsp;<span class="op" id="5466449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466452">case</span>&nbsp;<span class="ident" id="5466457">cbG8</span><span class="op" id="5466461">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466465">bpp</span>&nbsp;<span class="op" id="5466469">=</span>&nbsp;<span class="num" id="5466471">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466474">case</span>&nbsp;<span class="ident" id="5466479">cbTC8</span><span class="op" id="5466484">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466488">bpp</span>&nbsp;<span class="op" id="5466492">=</span>&nbsp;<span class="num" id="5466494">3</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466497">case</span>&nbsp;<span class="ident" id="5466502">cbP8</span><span class="op" id="5466506">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466510">bpp</span>&nbsp;<span class="op" id="5466514">=</span>&nbsp;<span class="num" id="5466516">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466519">case</span>&nbsp;<span class="ident" id="5466524">cbTCA8</span><span class="op" id="5466530">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466534">bpp</span>&nbsp;<span class="op" id="5466538">=</span>&nbsp;<span class="num" id="5466540">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466543">case</span>&nbsp;<span class="ident" id="5466548">cbTC16</span><span class="op" id="5466554">:</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466558">bpp</span>&nbsp;<span class="op" id="5466562">=</span>&nbsp;<span class="num" id="5466564">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466567">case</span>&nbsp;<span class="ident" id="5466572">cbTCA16</span><span class="op" id="5466579">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466583">bpp</span>&nbsp;<span class="op" id="5466587">=</span>&nbsp;<span class="num" id="5466589">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466592">case</span>&nbsp;<span class="ident" id="5466597">cbG16</span><span class="op" id="5466602">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466606">bpp</span>&nbsp;<span class="op" id="5466610">=</span>&nbsp;<span class="num" id="5466612">2</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5466615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5466618">//&nbsp;cr[*]&nbsp;and&nbsp;pr&nbsp;are&nbsp;the&nbsp;bytes&nbsp;for&nbsp;the&nbsp;current&nbsp;and&nbsp;previous&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5466683">//&nbsp;cr[0]&nbsp;is&nbsp;unfiltered&nbsp;(or&nbsp;equivalently,&nbsp;filtered&nbsp;with&nbsp;the&nbsp;ftNone&nbsp;filter).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5466759">//&nbsp;cr[ft],&nbsp;for&nbsp;non-zero&nbsp;filter&nbsp;types&nbsp;ft,&nbsp;are&nbsp;buffers&nbsp;for&nbsp;transforming&nbsp;cr[0]&nbsp;under&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5466846">//&nbsp;other&nbsp;PNG&nbsp;filter&nbsp;types.&nbsp;These&nbsp;buffers&nbsp;are&nbsp;allocated&nbsp;once&nbsp;and&nbsp;re-used&nbsp;for&nbsp;each&nbsp;row.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5466933">//&nbsp;The&nbsp;+1&nbsp;is&nbsp;for&nbsp;the&nbsp;per-row&nbsp;filter&nbsp;type,&nbsp;which&nbsp;is&nbsp;at&nbsp;cr[*][0].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466998">b</span>&nbsp;<span class="op" id="5467000">:=</span>&nbsp;<span class="ident" id="5467003">m</span><span class="op" id="5467004">.</span><span class="ident" id="5467005">Bounds</span><span class="op" id="5467011">(</span><span class="op" id="5467012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467015">var</span>&nbsp;<span class="ident" id="5467019">cr</span>&nbsp;<span class="op" id="5467022">[</span><span class="ident" id="5467023">nFilter</span><span class="op" id="5467030">]</span><span class="op" id="5467031">[</span><span class="op" id="5467032">]</span><span class="builtintype" id="5467033">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467040">for</span>&nbsp;<span class="ident" id="5467044">i</span>&nbsp;<span class="op" id="5467046">:=</span>&nbsp;<span class="keyword" id="5467049">range</span>&nbsp;<span class="ident" id="5467055">cr</span>&nbsp;<span class="op" id="5467058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467062">cr</span><span class="op" id="5467064">[</span><span class="ident" id="5467065">i</span><span class="op" id="5467066">]</span>&nbsp;<span class="op" id="5467068">=</span>&nbsp;<span class="builtinfunc" id="5467070">make</span><span class="op" id="5467074">(</span><span class="op" id="5467075">[</span><span class="op" id="5467076">]</span><span class="builtintype" id="5467077">uint8</span><span class="op" id="5467082">,</span>&nbsp;<span class="num" id="5467084">1</span><span class="op" id="5467085">+</span><span class="ident" id="5467086">bpp</span><span class="op" id="5467089">*</span><span class="ident" id="5467090">b</span><span class="op" id="5467091">.</span><span class="ident" id="5467092">Dx</span><span class="op" id="5467094">(</span><span class="op" id="5467095">)</span><span class="op" id="5467096">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467100">cr</span><span class="op" id="5467102">[</span><span class="ident" id="5467103">i</span><span class="op" id="5467104">]</span><span class="op" id="5467105">[</span><span class="num" id="5467106">0</span><span class="op" id="5467107">]</span>&nbsp;<span class="op" id="5467109">=</span>&nbsp;<span class="builtintype" id="5467111">uint8</span><span class="op" id="5467116">(</span><span class="ident" id="5467117">i</span><span class="op" id="5467118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5467121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467124">pr</span>&nbsp;<span class="op" id="5467127">:=</span>&nbsp;<span class="builtinfunc" id="5467130">make</span><span class="op" id="5467134">(</span><span class="op" id="5467135">[</span><span class="op" id="5467136">]</span><span class="builtintype" id="5467137">uint8</span><span class="op" id="5467142">,</span>&nbsp;<span class="num" id="5467144">1</span><span class="op" id="5467145">+</span><span class="ident" id="5467146">bpp</span><span class="op" id="5467149">*</span><span class="ident" id="5467150">b</span><span class="op" id="5467151">.</span><span class="ident" id="5467152">Dx</span><span class="op" id="5467154">(</span><span class="op" id="5467155">)</span><span class="op" id="5467156">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467160">gray</span><span class="op" id="5467164">,</span>&nbsp;<span class="ident" id="5467166">_</span>&nbsp;<span class="op" id="5467168">:=</span>&nbsp;<span class="ident" id="5467171">m</span><span class="op" id="5467172">.</span><span class="op" id="5467173">(</span><span class="op" id="5467174">*</span><span class="ident" id="5467175">image</span><span class="op" id="5467180">.</span><span class="ident" id="5467181">Gray</span><span class="op" id="5467185">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467188">rgba</span><span class="op" id="5467192">,</span>&nbsp;<span class="ident" id="5467194">_</span>&nbsp;<span class="op" id="5467196">:=</span>&nbsp;<span class="ident" id="5467199">m</span><span class="op" id="5467200">.</span><span class="op" id="5467201">(</span><span class="op" id="5467202">*</span><span class="ident" id="5467203">image</span><span class="op" id="5467208">.</span><span class="ident" id="5467209">RGBA</span><span class="op" id="5467213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467216">paletted</span><span class="op" id="5467224">,</span>&nbsp;<span class="ident" id="5467226">_</span>&nbsp;<span class="op" id="5467228">:=</span>&nbsp;<span class="ident" id="5467231">m</span><span class="op" id="5467232">.</span><span class="op" id="5467233">(</span><span class="op" id="5467234">*</span><span class="ident" id="5467235">image</span><span class="op" id="5467240">.</span><span class="ident" id="5467241">Paletted</span><span class="op" id="5467249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467252">nrgba</span><span class="op" id="5467257">,</span>&nbsp;<span class="ident" id="5467259">_</span>&nbsp;<span class="op" id="5467261">:=</span>&nbsp;<span class="ident" id="5467264">m</span><span class="op" id="5467265">.</span><span class="op" id="5467266">(</span><span class="op" id="5467267">*</span><span class="ident" id="5467268">image</span><span class="op" id="5467273">.</span><span class="ident" id="5467274">NRGBA</span><span class="op" id="5467279">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467283">for</span>&nbsp;<span class="ident" id="5467287">y</span>&nbsp;<span class="op" id="5467289">:=</span>&nbsp;<span class="ident" id="5467292">b</span><span class="op" id="5467293">.</span><span class="ident" id="5467294">Min</span><span class="op" id="5467297">.</span><span class="ident" id="5467298">Y</span><span class="op" id="5467299">;</span>&nbsp;<span class="ident" id="5467301">y</span>&nbsp;<span class="op" id="5467303">&lt;</span>&nbsp;<span class="ident" id="5467305">b</span><span class="op" id="5467306">.</span><span class="ident" id="5467307">Max</span><span class="op" id="5467310">.</span><span class="ident" id="5467311">Y</span><span class="op" id="5467312">;</span>&nbsp;<span class="ident" id="5467314">y</span><span class="op" id="5467315">++</span>&nbsp;<span class="op" id="5467318">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5467322">//&nbsp;Convert&nbsp;from&nbsp;colors&nbsp;to&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467357">i</span>&nbsp;<span class="op" id="5467359">:=</span>&nbsp;<span class="num" id="5467362">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467366">switch</span>&nbsp;<span class="ident" id="5467373">cb</span>&nbsp;<span class="op" id="5467376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467380">case</span>&nbsp;<span class="ident" id="5467385">cbG8</span><span class="op" id="5467389">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467394">if</span>&nbsp;<span class="ident" id="5467397">gray</span>&nbsp;<span class="op" id="5467402">!=</span>&nbsp;<span class="ident" id="5467405">nil</span>&nbsp;<span class="op" id="5467409">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467415">offset</span>&nbsp;<span class="op" id="5467422">:=</span>&nbsp;<span class="op" id="5467425">(</span><span class="ident" id="5467426">y</span>&nbsp;<span class="op" id="5467428">-</span>&nbsp;<span class="ident" id="5467430">b</span><span class="op" id="5467431">.</span><span class="ident" id="5467432">Min</span><span class="op" id="5467435">.</span><span class="ident" id="5467436">Y</span><span class="op" id="5467437">)</span>&nbsp;<span class="op" id="5467439">*</span>&nbsp;<span class="ident" id="5467441">gray</span><span class="op" id="5467445">.</span><span class="ident" id="5467446">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5467457">copy</span><span class="op" id="5467461">(</span><span class="ident" id="5467462">cr</span><span class="op" id="5467464">[</span><span class="num" id="5467465">0</span><span class="op" id="5467466">]</span><span class="op" id="5467467">[</span><span class="num" id="5467468">1</span><span class="op" id="5467469">:</span><span class="op" id="5467470">]</span><span class="op" id="5467471">,</span>&nbsp;<span class="ident" id="5467473">gray</span><span class="op" id="5467477">.</span><span class="ident" id="5467478">Pix</span><span class="op" id="5467481">[</span><span class="ident" id="5467482">offset</span><span class="op" id="5467488">:</span><span class="ident" id="5467489">offset</span><span class="op" id="5467495">+</span><span class="ident" id="5467496">b</span><span class="op" id="5467497">.</span><span class="ident" id="5467498">Dx</span><span class="op" id="5467500">(</span><span class="op" id="5467501">)</span><span class="op" id="5467502">]</span><span class="op" id="5467503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5467508">}</span>&nbsp;<span class="keyword" id="5467510">else</span>&nbsp;<span class="op" id="5467515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467521">for</span>&nbsp;<span class="ident" id="5467525">x</span>&nbsp;<span class="op" id="5467527">:=</span>&nbsp;<span class="ident" id="5467530">b</span><span class="op" id="5467531">.</span><span class="ident" id="5467532">Min</span><span class="op" id="5467535">.</span><span class="ident" id="5467536">X</span><span class="op" id="5467537">;</span>&nbsp;<span class="ident" id="5467539">x</span>&nbsp;<span class="op" id="5467541">&lt;</span>&nbsp;<span class="ident" id="5467543">b</span><span class="op" id="5467544">.</span><span class="ident" id="5467545">Max</span><span class="op" id="5467548">.</span><span class="ident" id="5467549">X</span><span class="op" id="5467550">;</span>&nbsp;<span class="ident" id="5467552">x</span><span class="op" id="5467553">++</span>&nbsp;<span class="op" id="5467556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467563">c</span>&nbsp;<span class="op" id="5467565">:=</span>&nbsp;<span class="ident" id="5467568">color</span><span class="op" id="5467573">.</span><span class="ident" id="5467574">GrayModel</span><span class="op" id="5467583">.</span><span class="ident" id="5467584">Convert</span><span class="op" id="5467591">(</span><span class="ident" id="5467592">m</span><span class="op" id="5467593">.</span><span class="ident" id="5467594">At</span><span class="op" id="5467596">(</span><span class="ident" id="5467597">x</span><span class="op" id="5467598">,</span>&nbsp;<span class="ident" id="5467600">y</span><span class="op" id="5467601">)</span><span class="op" id="5467602">)</span><span class="op" id="5467603">.</span><span class="op" id="5467604">(</span><span class="ident" id="5467605">color</span><span class="op" id="5467610">.</span><span class="ident" id="5467611">Gray</span><span class="op" id="5467615">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467622">cr</span><span class="op" id="5467624">[</span><span class="num" id="5467625">0</span><span class="op" id="5467626">]</span><span class="op" id="5467627">[</span><span class="ident" id="5467628">i</span><span class="op" id="5467629">]</span>&nbsp;<span class="op" id="5467631">=</span>&nbsp;<span class="ident" id="5467633">c</span><span class="op" id="5467634">.</span><span class="ident" id="5467635">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467642">i</span><span class="op" id="5467643">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5467650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5467655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467659">case</span>&nbsp;<span class="ident" id="5467664">cbTC8</span><span class="op" id="5467669">:</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5467674">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467746">cr0</span>&nbsp;<span class="op" id="5467750">:=</span>&nbsp;<span class="ident" id="5467753">cr</span><span class="op" id="5467755">[</span><span class="num" id="5467756">0</span><span class="op" id="5467757">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467762">stride</span><span class="op" id="5467768">,</span>&nbsp;<span class="ident" id="5467770">pix</span>&nbsp;<span class="op" id="5467774">:=</span>&nbsp;<span class="num" id="5467777">0</span><span class="op" id="5467778">,</span>&nbsp;<span class="op" id="5467780">[</span><span class="op" id="5467781">]</span><span class="builtintype" id="5467782">byte</span><span class="op" id="5467786">(</span><span class="ident" id="5467787">nil</span><span class="op" id="5467790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467795">if</span>&nbsp;<span class="ident" id="5467798">rgba</span>&nbsp;<span class="op" id="5467803">!=</span>&nbsp;<span class="ident" id="5467806">nil</span>&nbsp;<span class="op" id="5467810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467816">stride</span><span class="op" id="5467822">,</span>&nbsp;<span class="ident" id="5467824">pix</span>&nbsp;<span class="op" id="5467828">=</span>&nbsp;<span class="ident" id="5467830">rgba</span><span class="op" id="5467834">.</span><span class="ident" id="5467835">Stride</span><span class="op" id="5467841">,</span>&nbsp;<span class="ident" id="5467843">rgba</span><span class="op" id="5467847">.</span><span class="ident" id="5467848">Pix</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5467855">}</span>&nbsp;<span class="keyword" id="5467857">else</span>&nbsp;<span class="keyword" id="5467862">if</span>&nbsp;<span class="ident" id="5467865">nrgba</span>&nbsp;<span class="op" id="5467871">!=</span>&nbsp;<span class="ident" id="5467874">nil</span>&nbsp;<span class="op" id="5467878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467884">stride</span><span class="op" id="5467890">,</span>&nbsp;<span class="ident" id="5467892">pix</span>&nbsp;<span class="op" id="5467896">=</span>&nbsp;<span class="ident" id="5467898">nrgba</span><span class="op" id="5467903">.</span><span class="ident" id="5467904">Stride</span><span class="op" id="5467910">,</span>&nbsp;<span class="ident" id="5467912">nrgba</span><span class="op" id="5467917">.</span><span class="ident" id="5467918">Pix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5467925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467930">if</span>&nbsp;<span class="ident" id="5467933">stride</span>&nbsp;<span class="op" id="5467940">!=</span>&nbsp;<span class="num" id="5467943">0</span>&nbsp;<span class="op" id="5467945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467951">j0</span>&nbsp;<span class="op" id="5467954">:=</span>&nbsp;<span class="op" id="5467957">(</span><span class="ident" id="5467958">y</span>&nbsp;<span class="op" id="5467960">-</span>&nbsp;<span class="ident" id="5467962">b</span><span class="op" id="5467963">.</span><span class="ident" id="5467964">Min</span><span class="op" id="5467967">.</span><span class="ident" id="5467968">Y</span><span class="op" id="5467969">)</span>&nbsp;<span class="op" id="5467971">*</span>&nbsp;<span class="ident" id="5467973">stride</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467984">j1</span>&nbsp;<span class="op" id="5467987">:=</span>&nbsp;<span class="ident" id="5467990">j0</span>&nbsp;<span class="op" id="5467993">+</span>&nbsp;<span class="ident" id="5467995">b</span><span class="op" id="5467996">.</span><span class="ident" id="5467997">Dx</span><span class="op" id="5467999">(</span><span class="op" id="5468000">)</span><span class="op" id="5468001">*</span><span class="num" id="5468002">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5468008">for</span>&nbsp;<span class="ident" id="5468012">j</span>&nbsp;<span class="op" id="5468014">:=</span>&nbsp;<span class="ident" id="5468017">j0</span><span class="op" id="5468019">;</span>&nbsp;<span class="ident" id="5468021">j</span>&nbsp;<span class="op" id="5468023">&lt;</span>&nbsp;<span class="ident" id="5468025">j1</span><span class="op" id="5468027">;</span>&nbsp;<span class="ident" id="5468029">j</span>&nbsp;<span class="op" id="5468031">+=</span>&nbsp;<span class="num" id="5468034">4</span>&nbsp;<span class="op" id="5468036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468043">cr0</span><span class="op" id="5468046">[</span><span class="ident" id="5468047">i</span><span class="op" id="5468048">+</span><span class="num" id="5468049">0</span><span class="op" id="5468050">]</span>&nbsp;<span class="op" id="5468052">=</span>&nbsp;<span class="ident" id="5468054">pix</span><span class="op" id="5468057">[</span><span class="ident" id="5468058">j</span><span class="op" id="5468059">+</span><span class="num" id="5468060">0</span><span class="op" id="5468061">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468068">cr0</span><span class="op" id="5468071">[</span><span class="ident" id="5468072">i</span><span class="op" id="5468073">+</span><span class="num" id="5468074">1</span><span class="op" id="5468075">]</span>&nbsp;<span class="op" id="5468077">=</span>&nbsp;<span class="ident" id="5468079">pix</span><span class="op" id="5468082">[</span><span class="ident" id="5468083">j</span><span class="op" id="5468084">+</span><span class="num" id="5468085">1</span><span class="op" id="5468086">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468093">cr0</span><span class="op" id="5468096">[</span><span class="ident" id="5468097">i</span><span class="op" id="5468098">+</span><span class="num" id="5468099">2</span><span class="op" id="5468100">]</span>&nbsp;<span class="op" id="5468102">=</span>&nbsp;<span class="ident" id="5468104">pix</span><span class="op" id="5468107">[</span><span class="ident" id="5468108">j</span><span class="op" id="5468109">+</span><span class="num" id="5468110">2</span><span class="op" id="5468111">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468118">i</span>&nbsp;<span class="op" id="5468120">+=</span>&nbsp;<span class="num" id="5468123">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5468129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5468134">}</span>&nbsp;<span class="keyword" id="5468136">else</span>&nbsp;<span class="op" id="5468141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5468147">for</span>&nbsp;<span class="ident" id="5468151">x</span>&nbsp;<span class="op" id="5468153">:=</span>&nbsp;<span class="ident" id="5468156">b</span><span class="op" id="5468157">.</span><span class="ident" id="5468158">Min</span><span class="op" id="5468161">.</span><span class="ident" id="5468162">X</span><span class="op" id="5468163">;</span>&nbsp;<span class="ident" id="5468165">x</span>&nbsp;<span class="op" id="5468167">&lt;</span>&nbsp;<span class="ident" id="5468169">b</span><span class="op" id="5468170">.</span><span class="ident" id="5468171">Max</span><span class="op" id="5468174">.</span><span class="ident" id="5468175">X</span><span class="op" id="5468176">;</span>&nbsp;<span class="ident" id="5468178">x</span><span class="op" id="5468179">++</span>&nbsp;<span class="op" id="5468182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468189">r</span><span class="op" id="5468190">,</span>&nbsp;<span class="ident" id="5468192">g</span><span class="op" id="5468193">,</span>&nbsp;<span class="ident" id="5468195">b</span><span class="op" id="5468196">,</span>&nbsp;<span class="ident" id="5468198">_</span>&nbsp;<span class="op" id="5468200">:=</span>&nbsp;<span class="ident" id="5468203">m</span><span class="op" id="5468204">.</span><span class="ident" id="5468205">At</span><span class="op" id="5468207">(</span><span class="ident" id="5468208">x</span><span class="op" id="5468209">,</span>&nbsp;<span class="ident" id="5468211">y</span><span class="op" id="5468212">)</span><span class="op" id="5468213">.</span><span class="ident" id="5468214">RGBA</span><span class="op" id="5468218">(</span><span class="op" id="5468219">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468226">cr0</span><span class="op" id="5468229">[</span><span class="ident" id="5468230">i</span><span class="op" id="5468231">+</span><span class="num" id="5468232">0</span><span class="op" id="5468233">]</span>&nbsp;<span class="op" id="5468235">=</span>&nbsp;<span class="builtintype" id="5468237">uint8</span><span class="op" id="5468242">(</span><span class="ident" id="5468243">r</span>&nbsp;<span class="op" id="5468245">&gt;&gt;</span>&nbsp;<span class="num" id="5468248">8</span><span class="op" id="5468249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468256">cr0</span><span class="op" id="5468259">[</span><span class="ident" id="5468260">i</span><span class="op" id="5468261">+</span><span class="num" id="5468262">1</span><span class="op" id="5468263">]</span>&nbsp;<span class="op" id="5468265">=</span>&nbsp;<span class="builtintype" id="5468267">uint8</span><span class="op" id="5468272">(</span><span class="ident" id="5468273">g</span>&nbsp;<span class="op" id="5468275">&gt;&gt;</span>&nbsp;<span class="num" id="5468278">8</span><span class="op" id="5468279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468286">cr0</span><span class="op" id="5468289">[</span><span class="ident" id="5468290">i</span><span class="op" id="5468291">+</span><span class="num" id="5468292">2</span><span class="op" id="5468293">]</span>&nbsp;<span class="op" id="5468295">=</span>&nbsp;<span class="builtintype" id="5468297">uint8</span><span class="op" id="5468302">(</span><span class="ident" id="5468303">b</span>&nbsp;<span class="op" id="5468305">&gt;&gt;</span>&nbsp;<span class="num" id="5468308">8</span><span class="op" id="5468309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468316">i</span>&nbsp;<span class="op" id="5468318">+=</span>&nbsp;<span class="num" id="5468321">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5468327">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5468332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5468336">case</span>&nbsp;<span class="ident" id="5468341">cbP8</span><span class="op" id="5468345">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5468350">if</span>&nbsp;<span class="ident" id="5468353">paletted</span>&nbsp;<span class="op" id="5468362">!=</span>&nbsp;<span class="ident" id="5468365">nil</span>&nbsp;<span class="op" id="5468369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468375">offset</span>&nbsp;<span class="op" id="5468382">:=</span>&nbsp;<span class="op" id="5468385">(</span><span class="ident" id="5468386">y</span>&nbsp;<span class="op" id="5468388">-</span>&nbsp;<span class="ident" id="5468390">b</span><span class="op" id="5468391">.</span><span class="ident" id="5468392">Min</span><span class="op" id="5468395">.</span><span class="ident" id="5468396">Y</span><span class="op" id="5468397">)</span>&nbsp;<span class="op" id="5468399">*</span>&nbsp;<span class="ident" id="5468401">paletted</span><span class="op" id="5468409">.</span><span class="ident" id="5468410">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5468421">copy</span><span class="op" id="5468425">(</span><span class="ident" id="5468426">cr</span><span class="op" id="5468428">[</span><span class="num" id="5468429">0</span><span class="op" id="5468430">]</span><span class="op" id="5468431">[</span><span class="num" id="5468432">1</span><span class="op" id="5468433">:</span><span class="op" id="5468434">]</span><span class="op" id="5468435">,</span>&nbsp;<span class="ident" id="5468437">paletted</span><span class="op" id="5468445">.</span><span class="ident" id="5468446">Pix</span><span class="op" id="5468449">[</span><span class="ident" id="5468450">offset</span><span class="op" id="5468456">:</span><span class="ident" id="5468457">offset</span><span class="op" id="5468463">+</span><span class="ident" id="5468464">b</span><span class="op" id="5468465">.</span><span class="ident" id="5468466">Dx</span><span class="op" id="5468468">(</span><span class="op" id="5468469">)</span><span class="op" id="5468470">]</span><span class="op" id="5468471">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5468476">}</span>&nbsp;<span class="keyword" id="5468478">else</span>&nbsp;<span class="op" id="5468483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468489">pi</span>&nbsp;<span class="op" id="5468492">:=</span>&nbsp;<span class="ident" id="5468495">m</span><span class="op" id="5468496">.</span><span class="op" id="5468497">(</span><span class="ident" id="5468498">image</span><span class="op" id="5468503">.</span><span class="ident" id="5468504">PalettedImage</span><span class="op" id="5468517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5468523">for</span>&nbsp;<span class="ident" id="5468527">x</span>&nbsp;<span class="op" id="5468529">:=</span>&nbsp;<span class="ident" id="5468532">b</span><span class="op" id="5468533">.</span><span class="ident" id="5468534">Min</span><span class="op" id="5468537">.</span><span class="ident" id="5468538">X</span><span class="op" id="5468539">;</span>&nbsp;<span class="ident" id="5468541">x</span>&nbsp;<span class="op" id="5468543">&lt;</span>&nbsp;<span class="ident" id="5468545">b</span><span class="op" id="5468546">.</span><span class="ident" id="5468547">Max</span><span class="op" id="5468550">.</span><span class="ident" id="5468551">X</span><span class="op" id="5468552">;</span>&nbsp;<span class="ident" id="5468554">x</span><span class="op" id="5468555">++</span>&nbsp;<span class="op" id="5468558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468565">cr</span><span class="op" id="5468567">[</span><span class="num" id="5468568">0</span><span class="op" id="5468569">]</span><span class="op" id="5468570">[</span><span class="ident" id="5468571">i</span><span class="op" id="5468572">]</span>&nbsp;<span class="op" id="5468574">=</span>&nbsp;<span class="ident" id="5468576">pi</span><span class="op" id="5468578">.</span><span class="ident" id="5468579">ColorIndexAt</span><span class="op" id="5468591">(</span><span class="ident" id="5468592">x</span><span class="op" id="5468593">,</span>&nbsp;<span class="ident" id="5468595">y</span><span class="op" id="5468596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468603">i</span>&nbsp;<span class="op" id="5468605">+=</span>&nbsp;<span class="num" id="5468608">1</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5468614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5468619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5468623">case</span>&nbsp;<span class="ident" id="5468628">cbTCA8</span><span class="op" id="5468634">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5468639">if</span>&nbsp;<span class="ident" id="5468642">nrgba</span>&nbsp;<span class="op" id="5468648">!=</span>&nbsp;<span class="ident" id="5468651">nil</span>&nbsp;<span class="op" id="5468655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468661">offset</span>&nbsp;<span class="op" id="5468668">:=</span>&nbsp;<span class="op" id="5468671">(</span><span class="ident" id="5468672">y</span>&nbsp;<span class="op" id="5468674">-</span>&nbsp;<span class="ident" id="5468676">b</span><span class="op" id="5468677">.</span><span class="ident" id="5468678">Min</span><span class="op" id="5468681">.</span><span class="ident" id="5468682">Y</span><span class="op" id="5468683">)</span>&nbsp;<span class="op" id="5468685">*</span>&nbsp;<span class="ident" id="5468687">nrgba</span><span class="op" id="5468692">.</span><span class="ident" id="5468693">Stride</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5468704">copy</span><span class="op" id="5468708">(</span><span class="ident" id="5468709">cr</span><span class="op" id="5468711">[</span><span class="num" id="5468712">0</span><span class="op" id="5468713">]</span><span class="op" id="5468714">[</span><span class="num" id="5468715">1</span><span class="op" id="5468716">:</span><span class="op" id="5468717">]</span><span class="op" id="5468718">,</span>&nbsp;<span class="ident" id="5468720">nrgba</span><span class="op" id="5468725">.</span><span class="ident" id="5468726">Pix</span><span class="op" id="5468729">[</span><span class="ident" id="5468730">offset</span><span class="op" id="5468736">:</span><span class="ident" id="5468737">offset</span><span class="op" id="5468743">+</span><span class="ident" id="5468744">b</span><span class="op" id="5468745">.</span><span class="ident" id="5468746">Dx</span><span class="op" id="5468748">(</span><span class="op" id="5468749">)</span><span class="op" id="5468750">*</span><span class="num" id="5468751">4</span><span class="op" id="5468752">]</span><span class="op" id="5468753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5468758">}</span>&nbsp;<span class="keyword" id="5468760">else</span>&nbsp;<span class="op" id="5468765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5468771">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5468868">for</span>&nbsp;<span class="ident" id="5468872">x</span>&nbsp;<span class="op" id="5468874">:=</span>&nbsp;<span class="ident" id="5468877">b</span><span class="op" id="5468878">.</span><span class="ident" id="5468879">Min</span><span class="op" id="5468882">.</span><span class="ident" id="5468883">X</span><span class="op" id="5468884">;</span>&nbsp;<span class="ident" id="5468886">x</span>&nbsp;<span class="op" id="5468888">&lt;</span>&nbsp;<span class="ident" id="5468890">b</span><span class="op" id="5468891">.</span><span class="ident" id="5468892">Max</span><span class="op" id="5468895">.</span><span class="ident" id="5468896">X</span><span class="op" id="5468897">;</span>&nbsp;<span class="ident" id="5468899">x</span><span class="op" id="5468900">++</span>&nbsp;<span class="op" id="5468903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468910">c</span>&nbsp;<span class="op" id="5468912">:=</span>&nbsp;<span class="ident" id="5468915">color</span><span class="op" id="5468920">.</span><span class="ident" id="5468921">NRGBAModel</span><span class="op" id="5468931">.</span><span class="ident" id="5468932">Convert</span><span class="op" id="5468939">(</span><span class="ident" id="5468940">m</span><span class="op" id="5468941">.</span><span class="ident" id="5468942">At</span><span class="op" id="5468944">(</span><span class="ident" id="5468945">x</span><span class="op" id="5468946">,</span>&nbsp;<span class="ident" id="5468948">y</span><span class="op" id="5468949">)</span><span class="op" id="5468950">)</span><span class="op" id="5468951">.</span><span class="op" id="5468952">(</span><span class="ident" id="5468953">color</span><span class="op" id="5468958">.</span><span class="ident" id="5468959">NRGBA</span><span class="op" id="5468964">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468971">cr</span><span class="op" id="5468973">[</span><span class="num" id="5468974">0</span><span class="op" id="5468975">]</span><span class="op" id="5468976">[</span><span class="ident" id="5468977">i</span><span class="op" id="5468978">+</span><span class="num" id="5468979">0</span><span class="op" id="5468980">]</span>&nbsp;<span class="op" id="5468982">=</span>&nbsp;<span class="ident" id="5468984">c</span><span class="op" id="5468985">.</span><span class="ident" id="5468986">R</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468993">cr</span><span class="op" id="5468995">[</span><span class="num" id="5468996">0</span><span class="op" id="5468997">]</span><span class="op" id="5468998">[</span><span class="ident" id="5468999">i</span><span class="op" id="5469000">+</span><span class="num" id="5469001">1</span><span class="op" id="5469002">]</span>&nbsp;<span class="op" id="5469004">=</span>&nbsp;<span class="ident" id="5469006">c</span><span class="op" id="5469007">.</span><span class="ident" id="5469008">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469015">cr</span><span class="op" id="5469017">[</span><span class="num" id="5469018">0</span><span class="op" id="5469019">]</span><span class="op" id="5469020">[</span><span class="ident" id="5469021">i</span><span class="op" id="5469022">+</span><span class="num" id="5469023">2</span><span class="op" id="5469024">]</span>&nbsp;<span class="op" id="5469026">=</span>&nbsp;<span class="ident" id="5469028">c</span><span class="op" id="5469029">.</span><span class="ident" id="5469030">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469037">cr</span><span class="op" id="5469039">[</span><span class="num" id="5469040">0</span><span class="op" id="5469041">]</span><span class="op" id="5469042">[</span><span class="ident" id="5469043">i</span><span class="op" id="5469044">+</span><span class="num" id="5469045">3</span><span class="op" id="5469046">]</span>&nbsp;<span class="op" id="5469048">=</span>&nbsp;<span class="ident" id="5469050">c</span><span class="op" id="5469051">.</span><span class="ident" id="5469052">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469059">i</span>&nbsp;<span class="op" id="5469061">+=</span>&nbsp;<span class="num" id="5469064">4</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5469070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5469075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5469079">case</span>&nbsp;<span class="ident" id="5469084">cbG16</span><span class="op" id="5469089">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5469094">for</span>&nbsp;<span class="ident" id="5469098">x</span>&nbsp;<span class="op" id="5469100">:=</span>&nbsp;<span class="ident" id="5469103">b</span><span class="op" id="5469104">.</span><span class="ident" id="5469105">Min</span><span class="op" id="5469108">.</span><span class="ident" id="5469109">X</span><span class="op" id="5469110">;</span>&nbsp;<span class="ident" id="5469112">x</span>&nbsp;<span class="op" id="5469114">&lt;</span>&nbsp;<span class="ident" id="5469116">b</span><span class="op" id="5469117">.</span><span class="ident" id="5469118">Max</span><span class="op" id="5469121">.</span><span class="ident" id="5469122">X</span><span class="op" id="5469123">;</span>&nbsp;<span class="ident" id="5469125">x</span><span class="op" id="5469126">++</span>&nbsp;<span class="op" id="5469129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469135">c</span>&nbsp;<span class="op" id="5469137">:=</span>&nbsp;<span class="ident" id="5469140">color</span><span class="op" id="5469145">.</span><span class="ident" id="5469146">Gray16Model</span><span class="op" id="5469157">.</span><span class="ident" id="5469158">Convert</span><span class="op" id="5469165">(</span><span class="ident" id="5469166">m</span><span class="op" id="5469167">.</span><span class="ident" id="5469168">At</span><span class="op" id="5469170">(</span><span class="ident" id="5469171">x</span><span class="op" id="5469172">,</span>&nbsp;<span class="ident" id="5469174">y</span><span class="op" id="5469175">)</span><span class="op" id="5469176">)</span><span class="op" id="5469177">.</span><span class="op" id="5469178">(</span><span class="ident" id="5469179">color</span><span class="op" id="5469184">.</span><span class="ident" id="5469185">Gray16</span><span class="op" id="5469191">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469197">cr</span><span class="op" id="5469199">[</span><span class="num" id="5469200">0</span><span class="op" id="5469201">]</span><span class="op" id="5469202">[</span><span class="ident" id="5469203">i</span><span class="op" id="5469204">+</span><span class="num" id="5469205">0</span><span class="op" id="5469206">]</span>&nbsp;<span class="op" id="5469208">=</span>&nbsp;<span class="builtintype" id="5469210">uint8</span><span class="op" id="5469215">(</span><span class="ident" id="5469216">c</span><span class="op" id="5469217">.</span><span class="ident" id="5469218">Y</span>&nbsp;<span class="op" id="5469220">&gt;&gt;</span>&nbsp;<span class="num" id="5469223">8</span><span class="op" id="5469224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469230">cr</span><span class="op" id="5469232">[</span><span class="num" id="5469233">0</span><span class="op" id="5469234">]</span><span class="op" id="5469235">[</span><span class="ident" id="5469236">i</span><span class="op" id="5469237">+</span><span class="num" id="5469238">1</span><span class="op" id="5469239">]</span>&nbsp;<span class="op" id="5469241">=</span>&nbsp;<span class="builtintype" id="5469243">uint8</span><span class="op" id="5469248">(</span><span class="ident" id="5469249">c</span><span class="op" id="5469250">.</span><span class="ident" id="5469251">Y</span><span class="op" id="5469252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469258">i</span>&nbsp;<span class="op" id="5469260">+=</span>&nbsp;<span class="num" id="5469263">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5469268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5469272">case</span>&nbsp;<span class="ident" id="5469277">cbTC16</span><span class="op" id="5469283">:</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5469288">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5469360">for</span>&nbsp;<span class="ident" id="5469364">x</span>&nbsp;<span class="op" id="5469366">:=</span>&nbsp;<span class="ident" id="5469369">b</span><span class="op" id="5469370">.</span><span class="ident" id="5469371">Min</span><span class="op" id="5469374">.</span><span class="ident" id="5469375">X</span><span class="op" id="5469376">;</span>&nbsp;<span class="ident" id="5469378">x</span>&nbsp;<span class="op" id="5469380">&lt;</span>&nbsp;<span class="ident" id="5469382">b</span><span class="op" id="5469383">.</span><span class="ident" id="5469384">Max</span><span class="op" id="5469387">.</span><span class="ident" id="5469388">X</span><span class="op" id="5469389">;</span>&nbsp;<span class="ident" id="5469391">x</span><span class="op" id="5469392">++</span>&nbsp;<span class="op" id="5469395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469401">r</span><span class="op" id="5469402">,</span>&nbsp;<span class="ident" id="5469404">g</span><span class="op" id="5469405">,</span>&nbsp;<span class="ident" id="5469407">b</span><span class="op" id="5469408">,</span>&nbsp;<span class="ident" id="5469410">_</span>&nbsp;<span class="op" id="5469412">:=</span>&nbsp;<span class="ident" id="5469415">m</span><span class="op" id="5469416">.</span><span class="ident" id="5469417">At</span><span class="op" id="5469419">(</span><span class="ident" id="5469420">x</span><span class="op" id="5469421">,</span>&nbsp;<span class="ident" id="5469423">y</span><span class="op" id="5469424">)</span><span class="op" id="5469425">.</span><span class="ident" id="5469426">RGBA</span><span class="op" id="5469430">(</span><span class="op" id="5469431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469437">cr</span><span class="op" id="5469439">[</span><span class="num" id="5469440">0</span><span class="op" id="5469441">]</span><span class="op" id="5469442">[</span><span class="ident" id="5469443">i</span><span class="op" id="5469444">+</span><span class="num" id="5469445">0</span><span class="op" id="5469446">]</span>&nbsp;<span class="op" id="5469448">=</span>&nbsp;<span class="builtintype" id="5469450">uint8</span><span class="op" id="5469455">(</span><span class="ident" id="5469456">r</span>&nbsp;<span class="op" id="5469458">&gt;&gt;</span>&nbsp;<span class="num" id="5469461">8</span><span class="op" id="5469462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469468">cr</span><span class="op" id="5469470">[</span><span class="num" id="5469471">0</span><span class="op" id="5469472">]</span><span class="op" id="5469473">[</span><span class="ident" id="5469474">i</span><span class="op" id="5469475">+</span><span class="num" id="5469476">1</span><span class="op" id="5469477">]</span>&nbsp;<span class="op" id="5469479">=</span>&nbsp;<span class="builtintype" id="5469481">uint8</span><span class="op" id="5469486">(</span><span class="ident" id="5469487">r</span><span class="op" id="5469488">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469494">cr</span><span class="op" id="5469496">[</span><span class="num" id="5469497">0</span><span class="op" id="5469498">]</span><span class="op" id="5469499">[</span><span class="ident" id="5469500">i</span><span class="op" id="5469501">+</span><span class="num" id="5469502">2</span><span class="op" id="5469503">]</span>&nbsp;<span class="op" id="5469505">=</span>&nbsp;<span class="builtintype" id="5469507">uint8</span><span class="op" id="5469512">(</span><span class="ident" id="5469513">g</span>&nbsp;<span class="op" id="5469515">&gt;&gt;</span>&nbsp;<span class="num" id="5469518">8</span><span class="op" id="5469519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469525">cr</span><span class="op" id="5469527">[</span><span class="num" id="5469528">0</span><span class="op" id="5469529">]</span><span class="op" id="5469530">[</span><span class="ident" id="5469531">i</span><span class="op" id="5469532">+</span><span class="num" id="5469533">3</span><span class="op" id="5469534">]</span>&nbsp;<span class="op" id="5469536">=</span>&nbsp;<span class="builtintype" id="5469538">uint8</span><span class="op" id="5469543">(</span><span class="ident" id="5469544">g</span><span class="op" id="5469545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469551">cr</span><span class="op" id="5469553">[</span><span class="num" id="5469554">0</span><span class="op" id="5469555">]</span><span class="op" id="5469556">[</span><span class="ident" id="5469557">i</span><span class="op" id="5469558">+</span><span class="num" id="5469559">4</span><span class="op" id="5469560">]</span>&nbsp;<span class="op" id="5469562">=</span>&nbsp;<span class="builtintype" id="5469564">uint8</span><span class="op" id="5469569">(</span><span class="ident" id="5469570">b</span>&nbsp;<span class="op" id="5469572">&gt;&gt;</span>&nbsp;<span class="num" id="5469575">8</span><span class="op" id="5469576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469582">cr</span><span class="op" id="5469584">[</span><span class="num" id="5469585">0</span><span class="op" id="5469586">]</span><span class="op" id="5469587">[</span><span class="ident" id="5469588">i</span><span class="op" id="5469589">+</span><span class="num" id="5469590">5</span><span class="op" id="5469591">]</span>&nbsp;<span class="op" id="5469593">=</span>&nbsp;<span class="builtintype" id="5469595">uint8</span><span class="op" id="5469600">(</span><span class="ident" id="5469601">b</span><span class="op" id="5469602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469608">i</span>&nbsp;<span class="op" id="5469610">+=</span>&nbsp;<span class="num" id="5469613">6</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5469618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5469622">case</span>&nbsp;<span class="ident" id="5469627">cbTCA16</span><span class="op" id="5469634">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5469639">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5469735">for</span>&nbsp;<span class="ident" id="5469739">x</span>&nbsp;<span class="op" id="5469741">:=</span>&nbsp;<span class="ident" id="5469744">b</span><span class="op" id="5469745">.</span><span class="ident" id="5469746">Min</span><span class="op" id="5469749">.</span><span class="ident" id="5469750">X</span><span class="op" id="5469751">;</span>&nbsp;<span class="ident" id="5469753">x</span>&nbsp;<span class="op" id="5469755">&lt;</span>&nbsp;<span class="ident" id="5469757">b</span><span class="op" id="5469758">.</span><span class="ident" id="5469759">Max</span><span class="op" id="5469762">.</span><span class="ident" id="5469763">X</span><span class="op" id="5469764">;</span>&nbsp;<span class="ident" id="5469766">x</span><span class="op" id="5469767">++</span>&nbsp;<span class="op" id="5469770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469776">c</span>&nbsp;<span class="op" id="5469778">:=</span>&nbsp;<span class="ident" id="5469781">color</span><span class="op" id="5469786">.</span><span class="ident" id="5469787">NRGBA64Model</span><span class="op" id="5469799">.</span><span class="ident" id="5469800">Convert</span><span class="op" id="5469807">(</span><span class="ident" id="5469808">m</span><span class="op" id="5469809">.</span><span class="ident" id="5469810">At</span><span class="op" id="5469812">(</span><span class="ident" id="5469813">x</span><span class="op" id="5469814">,</span>&nbsp;<span class="ident" id="5469816">y</span><span class="op" id="5469817">)</span><span class="op" id="5469818">)</span><span class="op" id="5469819">.</span><span class="op" id="5469820">(</span><span class="ident" id="5469821">color</span><span class="op" id="5469826">.</span><span class="ident" id="5469827">NRGBA64</span><span class="op" id="5469834">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469840">cr</span><span class="op" id="5469842">[</span><span class="num" id="5469843">0</span><span class="op" id="5469844">]</span><span class="op" id="5469845">[</span><span class="ident" id="5469846">i</span><span class="op" id="5469847">+</span><span class="num" id="5469848">0</span><span class="op" id="5469849">]</span>&nbsp;<span class="op" id="5469851">=</span>&nbsp;<span class="builtintype" id="5469853">uint8</span><span class="op" id="5469858">(</span><span class="ident" id="5469859">c</span><span class="op" id="5469860">.</span><span class="ident" id="5469861">R</span>&nbsp;<span class="op" id="5469863">&gt;&gt;</span>&nbsp;<span class="num" id="5469866">8</span><span class="op" id="5469867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469873">cr</span><span class="op" id="5469875">[</span><span class="num" id="5469876">0</span><span class="op" id="5469877">]</span><span class="op" id="5469878">[</span><span class="ident" id="5469879">i</span><span class="op" id="5469880">+</span><span class="num" id="5469881">1</span><span class="op" id="5469882">]</span>&nbsp;<span class="op" id="5469884">=</span>&nbsp;<span class="builtintype" id="5469886">uint8</span><span class="op" id="5469891">(</span><span class="ident" id="5469892">c</span><span class="op" id="5469893">.</span><span class="ident" id="5469894">R</span><span class="op" id="5469895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469901">cr</span><span class="op" id="5469903">[</span><span class="num" id="5469904">0</span><span class="op" id="5469905">]</span><span class="op" id="5469906">[</span><span class="ident" id="5469907">i</span><span class="op" id="5469908">+</span><span class="num" id="5469909">2</span><span class="op" id="5469910">]</span>&nbsp;<span class="op" id="5469912">=</span>&nbsp;<span class="builtintype" id="5469914">uint8</span><span class="op" id="5469919">(</span><span class="ident" id="5469920">c</span><span class="op" id="5469921">.</span><span class="ident" id="5469922">G</span>&nbsp;<span class="op" id="5469924">&gt;&gt;</span>&nbsp;<span class="num" id="5469927">8</span><span class="op" id="5469928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469934">cr</span><span class="op" id="5469936">[</span><span class="num" id="5469937">0</span><span class="op" id="5469938">]</span><span class="op" id="5469939">[</span><span class="ident" id="5469940">i</span><span class="op" id="5469941">+</span><span class="num" id="5469942">3</span><span class="op" id="5469943">]</span>&nbsp;<span class="op" id="5469945">=</span>&nbsp;<span class="builtintype" id="5469947">uint8</span><span class="op" id="5469952">(</span><span class="ident" id="5469953">c</span><span class="op" id="5469954">.</span><span class="ident" id="5469955">G</span><span class="op" id="5469956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469962">cr</span><span class="op" id="5469964">[</span><span class="num" id="5469965">0</span><span class="op" id="5469966">]</span><span class="op" id="5469967">[</span><span class="ident" id="5469968">i</span><span class="op" id="5469969">+</span><span class="num" id="5469970">4</span><span class="op" id="5469971">]</span>&nbsp;<span class="op" id="5469973">=</span>&nbsp;<span class="builtintype" id="5469975">uint8</span><span class="op" id="5469980">(</span><span class="ident" id="5469981">c</span><span class="op" id="5469982">.</span><span class="ident" id="5469983">B</span>&nbsp;<span class="op" id="5469985">&gt;&gt;</span>&nbsp;<span class="num" id="5469988">8</span><span class="op" id="5469989">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469995">cr</span><span class="op" id="5469997">[</span><span class="num" id="5469998">0</span><span class="op" id="5469999">]</span><span class="op" id="5470000">[</span><span class="ident" id="5470001">i</span><span class="op" id="5470002">+</span><span class="num" id="5470003">5</span><span class="op" id="5470004">]</span>&nbsp;<span class="op" id="5470006">=</span>&nbsp;<span class="builtintype" id="5470008">uint8</span><span class="op" id="5470013">(</span><span class="ident" id="5470014">c</span><span class="op" id="5470015">.</span><span class="ident" id="5470016">B</span><span class="op" id="5470017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470023">cr</span><span class="op" id="5470025">[</span><span class="num" id="5470026">0</span><span class="op" id="5470027">]</span><span class="op" id="5470028">[</span><span class="ident" id="5470029">i</span><span class="op" id="5470030">+</span><span class="num" id="5470031">6</span><span class="op" id="5470032">]</span>&nbsp;<span class="op" id="5470034">=</span>&nbsp;<span class="builtintype" id="5470036">uint8</span><span class="op" id="5470041">(</span><span class="ident" id="5470042">c</span><span class="op" id="5470043">.</span><span class="ident" id="5470044">A</span>&nbsp;<span class="op" id="5470046">&gt;&gt;</span>&nbsp;<span class="num" id="5470049">8</span><span class="op" id="5470050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470056">cr</span><span class="op" id="5470058">[</span><span class="num" id="5470059">0</span><span class="op" id="5470060">]</span><span class="op" id="5470061">[</span><span class="ident" id="5470062">i</span><span class="op" id="5470063">+</span><span class="num" id="5470064">7</span><span class="op" id="5470065">]</span>&nbsp;<span class="op" id="5470067">=</span>&nbsp;<span class="builtintype" id="5470069">uint8</span><span class="op" id="5470074">(</span><span class="ident" id="5470075">c</span><span class="op" id="5470076">.</span><span class="ident" id="5470077">A</span><span class="op" id="5470078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470084">i</span>&nbsp;<span class="op" id="5470086">+=</span>&nbsp;<span class="num" id="5470089">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5470094">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5470098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5470103">//&nbsp;Apply&nbsp;the&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470126">f</span>&nbsp;<span class="op" id="5470128">:=</span>&nbsp;<span class="ident" id="5470131">ftNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5470140">if</span>&nbsp;<span class="ident" id="5470143">level</span>&nbsp;<span class="op" id="5470149">!=</span>&nbsp;<span class="ident" id="5470152">zlib</span><span class="op" id="5470156">.</span><span class="ident" id="5470157">NoCompression</span>&nbsp;<span class="op" id="5470171">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470176">f</span>&nbsp;<span class="op" id="5470178">=</span>&nbsp;<span class="ident" id="5470180">filter</span><span class="op" id="5470186">(</span><span class="op" id="5470187">&amp;</span><span class="ident" id="5470188">cr</span><span class="op" id="5470190">,</span>&nbsp;<span class="ident" id="5470192">pr</span><span class="op" id="5470194">,</span>&nbsp;<span class="ident" id="5470196">bpp</span><span class="op" id="5470199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5470203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5470208">//&nbsp;Write&nbsp;the&nbsp;compressed&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5470241">if</span>&nbsp;<span class="ident" id="5470244">_</span><span class="op" id="5470245">,</span>&nbsp;<span class="ident" id="5470247">err</span>&nbsp;<span class="op" id="5470251">:=</span>&nbsp;<span class="ident" id="5470254">zw</span><span class="op" id="5470256">.</span><span class="ident" id="5470257">Write</span><span class="op" id="5470262">(</span><span class="ident" id="5470263">cr</span><span class="op" id="5470265">[</span><span class="ident" id="5470266">f</span><span class="op" id="5470267">]</span><span class="op" id="5470268">)</span><span class="op" id="5470269">;</span>&nbsp;<span class="ident" id="5470271">err</span>&nbsp;<span class="op" id="5470275">!=</span>&nbsp;<span class="ident" id="5470278">nil</span>&nbsp;<span class="op" id="5470282">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5470287">return</span>&nbsp;<span class="ident" id="5470294">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5470300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5470305">//&nbsp;The&nbsp;current&nbsp;row&nbsp;for&nbsp;y&nbsp;is&nbsp;the&nbsp;previous&nbsp;row&nbsp;for&nbsp;y+1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470361">pr</span><span class="op" id="5470363">,</span>&nbsp;<span class="ident" id="5470365">cr</span><span class="op" id="5470367">[</span><span class="num" id="5470368">0</span><span class="op" id="5470369">]</span>&nbsp;<span class="op" id="5470371">=</span>&nbsp;<span class="ident" id="5470373">cr</span><span class="op" id="5470375">[</span><span class="num" id="5470376">0</span><span class="op" id="5470377">]</span><span class="op" id="5470378">,</span>&nbsp;<span class="ident" id="5470380">pr</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5470384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5470387">return</span>&nbsp;<span class="ident" id="5470394">nil</span><br>
<span class="lineno"></span><span class="op" id="5470398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5470401">//&nbsp;Write&nbsp;the&nbsp;actual&nbsp;image&nbsp;data&nbsp;to&nbsp;one&nbsp;or&nbsp;more&nbsp;IDAT&nbsp;chunks.</span><br>
<span class="lineno">440</span><span class="keyword" id="5470460">func</span>&nbsp;<span class="op" id="5470465">(</span><span class="ident" id="5470466">e</span>&nbsp;<span class="op" id="5470468">*</span><span class="ident" id="5470469">encoder</span><span class="op" id="5470476">)</span>&nbsp;<span class="ident" id="5470478">writeIDATs</span><span class="op" id="5470488">(</span><span class="op" id="5470489">)</span>&nbsp;<span class="op" id="5470491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5470494">if</span>&nbsp;<span class="ident" id="5470497">e</span><span class="op" id="5470498">.</span><span class="ident" id="5470499">err</span>&nbsp;<span class="op" id="5470503">!=</span>&nbsp;<span class="ident" id="5470506">nil</span>&nbsp;<span class="op" id="5470510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5470514">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5470522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5470525">var</span>&nbsp;<span class="ident" id="5470529">bw</span>&nbsp;<span class="op" id="5470532">*</span><span class="ident" id="5470533">bufio</span><span class="op" id="5470538">.</span><span class="ident" id="5470539">Writer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470547">bw</span>&nbsp;<span class="op" id="5470550">=</span>&nbsp;<span class="ident" id="5470552">bufio</span><span class="op" id="5470557">.</span><span class="ident" id="5470558">NewWriterSize</span><span class="op" id="5470571">(</span><span class="ident" id="5470572">e</span><span class="op" id="5470573">,</span>&nbsp;<span class="num" id="5470575">1</span><span class="op" id="5470576">&lt;&lt;</span><span class="num" id="5470578">15</span><span class="op" id="5470580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470583">e</span><span class="op" id="5470584">.</span><span class="ident" id="5470585">err</span>&nbsp;<span class="op" id="5470589">=</span>&nbsp;<span class="ident" id="5470591">writeImage</span><span class="op" id="5470601">(</span><span class="ident" id="5470602">bw</span><span class="op" id="5470604">,</span>&nbsp;<span class="ident" id="5470606">e</span><span class="op" id="5470607">.</span><span class="ident" id="5470608">m</span><span class="op" id="5470609">,</span>&nbsp;<span class="ident" id="5470611">e</span><span class="op" id="5470612">.</span><span class="ident" id="5470613">cb</span><span class="op" id="5470615">,</span>&nbsp;<span class="ident" id="5470617">levelToZlib</span><span class="op" id="5470628">(</span><span class="ident" id="5470629">e</span><span class="op" id="5470630">.</span><span class="ident" id="5470631">enc</span><span class="op" id="5470634">.</span><span class="ident" id="5470635">CompressionLevel</span><span class="op" id="5470651">)</span><span class="op" id="5470652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5470655">if</span>&nbsp;<span class="ident" id="5470658">e</span><span class="op" id="5470659">.</span><span class="ident" id="5470660">err</span>&nbsp;<span class="op" id="5470664">!=</span>&nbsp;<span class="ident" id="5470667">nil</span>&nbsp;<span class="op" id="5470671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5470675">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5470683">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470686">e</span><span class="op" id="5470687">.</span><span class="ident" id="5470688">err</span>&nbsp;<span class="op" id="5470692">=</span>&nbsp;<span class="ident" id="5470694">bw</span><span class="op" id="5470696">.</span><span class="ident" id="5470697">Flush</span><span class="op" id="5470702">(</span><span class="op" id="5470703">)</span><br>
<span class="lineno"></span><span class="op" id="5470705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5470708">//&nbsp;This&nbsp;function&nbsp;is&nbsp;required&nbsp;because&nbsp;we&nbsp;want&nbsp;the&nbsp;zero&nbsp;value&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5470771">//&nbsp;Encoder.CompressionLevel&nbsp;to&nbsp;map&nbsp;to&nbsp;zlib.DefaultCompression.</span><br>
<span class="lineno">455</span><span class="keyword" id="5470834">func</span>&nbsp;<span class="ident" id="5470839">levelToZlib</span><span class="op" id="5470850">(</span><span class="ident" id="5470851">l</span>&nbsp;<span class="ident" id="5470853">CompressionLevel</span><span class="op" id="5470869">)</span>&nbsp;<span class="builtintype" id="5470871">int</span>&nbsp;<span class="op" id="5470875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5470878">switch</span>&nbsp;<span class="ident" id="5470885">l</span>&nbsp;<span class="op" id="5470887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5470890">case</span>&nbsp;<span class="ident" id="5470895">DefaultCompression</span><span class="op" id="5470913">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5470917">return</span>&nbsp;<span class="ident" id="5470924">zlib</span><span class="op" id="5470928">.</span><span class="ident" id="5470929">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5470949">case</span>&nbsp;<span class="ident" id="5470954">NoCompression</span><span class="op" id="5470967">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5470971">return</span>&nbsp;<span class="ident" id="5470978">zlib</span><span class="op" id="5470982">.</span><span class="ident" id="5470983">NoCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5470998">case</span>&nbsp;<span class="ident" id="5471003">BestSpeed</span><span class="op" id="5471012">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5471016">return</span>&nbsp;<span class="ident" id="5471023">zlib</span><span class="op" id="5471027">.</span><span class="ident" id="5471028">BestSpeed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5471039">case</span>&nbsp;<span class="ident" id="5471044">BestCompression</span><span class="op" id="5471059">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5471063">return</span>&nbsp;<span class="ident" id="5471070">zlib</span><span class="op" id="5471074">.</span><span class="ident" id="5471075">BestCompression</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5471092">default</span><span class="op" id="5471099">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5471103">return</span>&nbsp;<span class="ident" id="5471110">zlib</span><span class="op" id="5471114">.</span><span class="ident" id="5471115">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5471135">}</span><br>
<span class="lineno"></span><span class="op" id="5471137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="keyword" id="5471140">func</span>&nbsp;<span class="op" id="5471145">(</span><span class="ident" id="5471146">e</span>&nbsp;<span class="op" id="5471148">*</span><span class="ident" id="5471149">encoder</span><span class="op" id="5471156">)</span>&nbsp;<span class="ident" id="5471158">writeIEND</span><span class="op" id="5471167">(</span><span class="op" id="5471168">)</span>&nbsp;<span class="op" id="5471170">{</span>&nbsp;<span class="ident" id="5471172">e</span><span class="op" id="5471173">.</span><span class="ident" id="5471174">writeChunk</span><span class="op" id="5471184">(</span><span class="ident" id="5471185">nil</span><span class="op" id="5471188">,</span>&nbsp;<span class="string" id="5471190">&#34;IEND&#34;</span><span class="op" id="5471196">)</span>&nbsp;<span class="op" id="5471198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5471201">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.&nbsp;Any&nbsp;Image&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5471267">//&nbsp;encoded,&nbsp;but&nbsp;images&nbsp;that&nbsp;are&nbsp;not&nbsp;image.NRGBA&nbsp;might&nbsp;be&nbsp;encoded&nbsp;lossily.</span><br>
<span class="lineno"></span><span class="keyword" id="5471341">func</span>&nbsp;<span class="ident" id="5471346">Encode</span><span class="op" id="5471352">(</span><span class="ident" id="5471353">w</span>&nbsp;<span class="ident" id="5471355">io</span><span class="op" id="5471357">.</span><span class="ident" id="5471358">Writer</span><span class="op" id="5471364">,</span>&nbsp;<span class="ident" id="5471366">m</span>&nbsp;<span class="ident" id="5471368">image</span><span class="op" id="5471373">.</span><span class="ident" id="5471374">Image</span><span class="op" id="5471379">)</span>&nbsp;<span class="builtintype" id="5471381">error</span>&nbsp;<span class="op" id="5471387">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5471390">var</span>&nbsp;<span class="ident" id="5471394">e</span>&nbsp;<span class="ident" id="5471396">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5471405">return</span>&nbsp;<span class="ident" id="5471412">e</span><span class="op" id="5471413">.</span><span class="ident" id="5471414">Encode</span><span class="op" id="5471420">(</span><span class="ident" id="5471421">w</span><span class="op" id="5471422">,</span>&nbsp;<span class="ident" id="5471424">m</span><span class="op" id="5471425">)</span><br>
<span class="lineno"></span><span class="op" id="5471427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5471430">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.</span><br>
<span class="lineno">480</span><span class="keyword" id="5471479">func</span>&nbsp;<span class="op" id="5471484">(</span><span class="ident" id="5471485">enc</span>&nbsp;<span class="op" id="5471489">*</span><span class="ident" id="5471490">Encoder</span><span class="op" id="5471497">)</span>&nbsp;<span class="ident" id="5471499">Encode</span><span class="op" id="5471505">(</span><span class="ident" id="5471506">w</span>&nbsp;<span class="ident" id="5471508">io</span><span class="op" id="5471510">.</span><span class="ident" id="5471511">Writer</span><span class="op" id="5471517">,</span>&nbsp;<span class="ident" id="5471519">m</span>&nbsp;<span class="ident" id="5471521">image</span><span class="op" id="5471526">.</span><span class="ident" id="5471527">Image</span><span class="op" id="5471532">)</span>&nbsp;<span class="builtintype" id="5471534">error</span>&nbsp;<span class="op" id="5471540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5471543">//&nbsp;Obviously,&nbsp;negative&nbsp;widths&nbsp;and&nbsp;heights&nbsp;are&nbsp;invalid.&nbsp;Furthermore,&nbsp;the&nbsp;PNG</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5471620">//&nbsp;spec&nbsp;section&nbsp;11.2.2&nbsp;says&nbsp;that&nbsp;zero&nbsp;is&nbsp;invalid.&nbsp;Excessively&nbsp;large&nbsp;images&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5471700">//&nbsp;also&nbsp;rejected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471719">mw</span><span class="op" id="5471721">,</span>&nbsp;<span class="ident" id="5471723">mh</span>&nbsp;<span class="op" id="5471726">:=</span>&nbsp;<span class="ident" id="5471729">int64</span><span class="op" id="5471734">(</span><span class="ident" id="5471735">m</span><span class="op" id="5471736">.</span><span class="ident" id="5471737">Bounds</span><span class="op" id="5471743">(</span><span class="op" id="5471744">)</span><span class="op" id="5471745">.</span><span class="ident" id="5471746">Dx</span><span class="op" id="5471748">(</span><span class="op" id="5471749">)</span><span class="op" id="5471750">)</span><span class="op" id="5471751">,</span>&nbsp;<span class="ident" id="5471753">int64</span><span class="op" id="5471758">(</span><span class="ident" id="5471759">m</span><span class="op" id="5471760">.</span><span class="ident" id="5471761">Bounds</span><span class="op" id="5471767">(</span><span class="op" id="5471768">)</span><span class="op" id="5471769">.</span><span class="ident" id="5471770">Dy</span><span class="op" id="5471772">(</span><span class="op" id="5471773">)</span><span class="op" id="5471774">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5471777">if</span>&nbsp;<span class="ident" id="5471780">mw</span>&nbsp;<span class="op" id="5471783">&lt;=</span>&nbsp;<span class="num" id="5471786">0</span>&nbsp;<span class="op" id="5471788">||</span>&nbsp;<span class="ident" id="5471791">mh</span>&nbsp;<span class="op" id="5471794">&lt;=</span>&nbsp;<span class="num" id="5471797">0</span>&nbsp;<span class="op" id="5471799">||</span>&nbsp;<span class="ident" id="5471802">mw</span>&nbsp;<span class="op" id="5471805">&gt;=</span>&nbsp;<span class="num" id="5471808">1</span><span class="op" id="5471809">&lt;&lt;</span><span class="num" id="5471811">32</span>&nbsp;<span class="op" id="5471814">||</span>&nbsp;<span class="ident" id="5471817">mh</span>&nbsp;<span class="op" id="5471820">&gt;=</span>&nbsp;<span class="num" id="5471823">1</span><span class="op" id="5471824">&lt;&lt;</span><span class="num" id="5471826">32</span>&nbsp;<span class="op" id="5471829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5471833">return</span>&nbsp;<span class="ident" id="5471840">FormatError</span><span class="op" id="5471851">(</span><span class="string" id="5471852">&#34;invalid&nbsp;image&nbsp;size:&nbsp;&#34;</span>&nbsp;<span class="op" id="5471875">+</span>&nbsp;<span class="ident" id="5471877">strconv</span><span class="op" id="5471884">.</span><span class="ident" id="5471885">FormatInt</span><span class="op" id="5471894">(</span><span class="ident" id="5471895">mw</span><span class="op" id="5471897">,</span>&nbsp;<span class="num" id="5471899">10</span><span class="op" id="5471901">)</span>&nbsp;<span class="op" id="5471903">+</span>&nbsp;<span class="string" id="5471905">&#34;x&#34;</span>&nbsp;<span class="op" id="5471909">+</span>&nbsp;<span class="ident" id="5471911">strconv</span><span class="op" id="5471918">.</span><span class="ident" id="5471919">FormatInt</span><span class="op" id="5471928">(</span><span class="ident" id="5471929">mh</span><span class="op" id="5471931">,</span>&nbsp;<span class="num" id="5471933">10</span><span class="op" id="5471935">)</span><span class="op" id="5471936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5471939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5471943">var</span>&nbsp;<span class="ident" id="5471947">e</span>&nbsp;<span class="ident" id="5471949">encoder</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471958">e</span><span class="op" id="5471959">.</span><span class="ident" id="5471960">enc</span>&nbsp;<span class="op" id="5471964">=</span>&nbsp;<span class="ident" id="5471966">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471971">e</span><span class="op" id="5471972">.</span><span class="ident" id="5471973">w</span>&nbsp;<span class="op" id="5471975">=</span>&nbsp;<span class="ident" id="5471977">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471980">e</span><span class="op" id="5471981">.</span><span class="ident" id="5471982">m</span>&nbsp;<span class="op" id="5471984">=</span>&nbsp;<span class="ident" id="5471986">m</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5471990">var</span>&nbsp;<span class="ident" id="5471994">pal</span>&nbsp;<span class="ident" id="5471998">color</span><span class="op" id="5472003">.</span><span class="ident" id="5472004">Palette</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5472013">//&nbsp;cbP8&nbsp;encoding&nbsp;needs&nbsp;PalettedImage&#39;s&nbsp;ColorIndexAt&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5472074">if</span>&nbsp;<span class="ident" id="5472077">_</span><span class="op" id="5472078">,</span>&nbsp;<span class="ident" id="5472080">ok</span>&nbsp;<span class="op" id="5472083">:=</span>&nbsp;<span class="ident" id="5472086">m</span><span class="op" id="5472087">.</span><span class="op" id="5472088">(</span><span class="ident" id="5472089">image</span><span class="op" id="5472094">.</span><span class="ident" id="5472095">PalettedImage</span><span class="op" id="5472108">)</span><span class="op" id="5472109">;</span>&nbsp;<span class="ident" id="5472111">ok</span>&nbsp;<span class="op" id="5472114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472118">pal</span><span class="op" id="5472121">,</span>&nbsp;<span class="ident" id="5472123">_</span>&nbsp;<span class="op" id="5472125">=</span>&nbsp;<span class="ident" id="5472127">m</span><span class="op" id="5472128">.</span><span class="ident" id="5472129">ColorModel</span><span class="op" id="5472139">(</span><span class="op" id="5472140">)</span><span class="op" id="5472141">.</span><span class="op" id="5472142">(</span><span class="ident" id="5472143">color</span><span class="op" id="5472148">.</span><span class="ident" id="5472149">Palette</span><span class="op" id="5472156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5472159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5472162">if</span>&nbsp;<span class="ident" id="5472165">pal</span>&nbsp;<span class="op" id="5472169">!=</span>&nbsp;<span class="ident" id="5472172">nil</span>&nbsp;<span class="op" id="5472176">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472180">e</span><span class="op" id="5472181">.</span><span class="ident" id="5472182">cb</span>&nbsp;<span class="op" id="5472185">=</span>&nbsp;<span class="ident" id="5472187">cbP8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5472193">}</span>&nbsp;<span class="keyword" id="5472195">else</span>&nbsp;<span class="op" id="5472200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5472204">switch</span>&nbsp;<span class="ident" id="5472211">m</span><span class="op" id="5472212">.</span><span class="ident" id="5472213">ColorModel</span><span class="op" id="5472223">(</span><span class="op" id="5472224">)</span>&nbsp;<span class="op" id="5472226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5472230">case</span>&nbsp;<span class="ident" id="5472235">color</span><span class="op" id="5472240">.</span><span class="ident" id="5472241">GrayModel</span><span class="op" id="5472250">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472255">e</span><span class="op" id="5472256">.</span><span class="ident" id="5472257">cb</span>&nbsp;<span class="op" id="5472260">=</span>&nbsp;<span class="ident" id="5472262">cbG8</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5472269">case</span>&nbsp;<span class="ident" id="5472274">color</span><span class="op" id="5472279">.</span><span class="ident" id="5472280">Gray16Model</span><span class="op" id="5472291">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472296">e</span><span class="op" id="5472297">.</span><span class="ident" id="5472298">cb</span>&nbsp;<span class="op" id="5472301">=</span>&nbsp;<span class="ident" id="5472303">cbG16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5472311">case</span>&nbsp;<span class="ident" id="5472316">color</span><span class="op" id="5472321">.</span><span class="ident" id="5472322">RGBAModel</span><span class="op" id="5472331">,</span>&nbsp;<span class="ident" id="5472333">color</span><span class="op" id="5472338">.</span><span class="ident" id="5472339">NRGBAModel</span><span class="op" id="5472349">,</span>&nbsp;<span class="ident" id="5472351">color</span><span class="op" id="5472356">.</span><span class="ident" id="5472357">AlphaModel</span><span class="op" id="5472367">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5472372">if</span>&nbsp;<span class="ident" id="5472375">opaque</span><span class="op" id="5472381">(</span><span class="ident" id="5472382">m</span><span class="op" id="5472383">)</span>&nbsp;<span class="op" id="5472385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472391">e</span><span class="op" id="5472392">.</span><span class="ident" id="5472393">cb</span>&nbsp;<span class="op" id="5472396">=</span>&nbsp;<span class="ident" id="5472398">cbTC8</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5472407">}</span>&nbsp;<span class="keyword" id="5472409">else</span>&nbsp;<span class="op" id="5472414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472420">e</span><span class="op" id="5472421">.</span><span class="ident" id="5472422">cb</span>&nbsp;<span class="op" id="5472425">=</span>&nbsp;<span class="ident" id="5472427">cbTCA8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5472437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5472441">default</span><span class="op" id="5472448">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5472453">if</span>&nbsp;<span class="ident" id="5472456">opaque</span><span class="op" id="5472462">(</span><span class="ident" id="5472463">m</span><span class="op" id="5472464">)</span>&nbsp;<span class="op" id="5472466">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472472">e</span><span class="op" id="5472473">.</span><span class="ident" id="5472474">cb</span>&nbsp;<span class="op" id="5472477">=</span>&nbsp;<span class="ident" id="5472479">cbTC16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5472489">}</span>&nbsp;<span class="keyword" id="5472491">else</span>&nbsp;<span class="op" id="5472496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472502">e</span><span class="op" id="5472503">.</span><span class="ident" id="5472504">cb</span>&nbsp;<span class="op" id="5472507">=</span>&nbsp;<span class="ident" id="5472509">cbTCA16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5472520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5472524">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5472527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472531">_</span><span class="op" id="5472532">,</span>&nbsp;<span class="ident" id="5472534">e</span><span class="op" id="5472535">.</span><span class="ident" id="5472536">err</span>&nbsp;<span class="op" id="5472540">=</span>&nbsp;<span class="ident" id="5472542">io</span><span class="op" id="5472544">.</span><span class="ident" id="5472545">WriteString</span><span class="op" id="5472556">(</span><span class="ident" id="5472557">w</span><span class="op" id="5472558">,</span>&nbsp;<span class="ident" id="5472560">pngHeader</span><span class="op" id="5472569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472572">e</span><span class="op" id="5472573">.</span><span class="ident" id="5472574">writeIHDR</span><span class="op" id="5472583">(</span><span class="op" id="5472584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5472587">if</span>&nbsp;<span class="ident" id="5472590">pal</span>&nbsp;<span class="op" id="5472594">!=</span>&nbsp;<span class="ident" id="5472597">nil</span>&nbsp;<span class="op" id="5472601">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472605">e</span><span class="op" id="5472606">.</span><span class="ident" id="5472607">writePLTEAndTRNS</span><span class="op" id="5472623">(</span><span class="ident" id="5472624">pal</span><span class="op" id="5472627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5472630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472633">e</span><span class="op" id="5472634">.</span><span class="ident" id="5472635">writeIDATs</span><span class="op" id="5472645">(</span><span class="op" id="5472646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472649">e</span><span class="op" id="5472650">.</span><span class="ident" id="5472651">writeIEND</span><span class="op" id="5472660">(</span><span class="op" id="5472661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5472664">return</span>&nbsp;<span class="ident" id="5472671">e</span><span class="op" id="5472672">.</span><span class="ident" id="5472673">err</span><br>
<span class="lineno">530</span><span class="op" id="5472677">}</span>
</div>
</body>
</html>
