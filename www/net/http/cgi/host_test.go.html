<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6876774">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6876829">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6876883">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6876934">//&nbsp;Tests&nbsp;for&nbsp;package&nbsp;cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6876960">package</span>&nbsp;<span class="ident" id="6876968">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6876973">import</span>&nbsp;<span class="op" id="6876980">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6876983">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6876992">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6876999">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6877005">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6877012">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6877024">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6877045">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6877051">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6877062">&#34;path/filepath&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6877079">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6877090">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6877101">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6877112">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6877123">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6877130">)</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="6877133">func</span>&nbsp;<span class="ident" id="6877138">newRequest</span><span class="op" id="6877148">(</span><span class="ident" id="6877149">httpreq</span>&nbsp;<span class="builtintype" id="6877157">string</span><span class="op" id="6877163">)</span>&nbsp;<span class="op" id="6877165">*</span><span class="ident" id="6877166">http</span><span class="op" id="6877170">.</span><span class="ident" id="6877171">Request</span>&nbsp;<span class="op" id="6877179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877182">buf</span>&nbsp;<span class="op" id="6877186">:=</span>&nbsp;<span class="ident" id="6877189">bufio</span><span class="op" id="6877194">.</span><span class="ident" id="6877195">NewReader</span><span class="op" id="6877204">(</span><span class="ident" id="6877205">strings</span><span class="op" id="6877212">.</span><span class="ident" id="6877213">NewReader</span><span class="op" id="6877222">(</span><span class="ident" id="6877223">httpreq</span><span class="op" id="6877230">)</span><span class="op" id="6877231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877234">req</span><span class="op" id="6877237">,</span>&nbsp;<span class="ident" id="6877239">err</span>&nbsp;<span class="op" id="6877243">:=</span>&nbsp;<span class="ident" id="6877246">http</span><span class="op" id="6877250">.</span><span class="ident" id="6877251">ReadRequest</span><span class="op" id="6877262">(</span><span class="ident" id="6877263">buf</span><span class="op" id="6877266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877269">if</span>&nbsp;<span class="ident" id="6877272">err</span>&nbsp;<span class="op" id="6877276">!=</span>&nbsp;<span class="ident" id="6877279">nil</span>&nbsp;<span class="op" id="6877283">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6877287">panic</span><span class="op" id="6877292">(</span><span class="string" id="6877293">&#34;cgi:&nbsp;bogus&nbsp;http&nbsp;request&nbsp;in&nbsp;test:&nbsp;&#34;</span>&nbsp;<span class="op" id="6877329">+</span>&nbsp;<span class="ident" id="6877331">httpreq</span><span class="op" id="6877338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877344">req</span><span class="op" id="6877347">.</span><span class="ident" id="6877348">RemoteAddr</span>&nbsp;<span class="op" id="6877359">=</span>&nbsp;<span class="string" id="6877361">&#34;1.2.3.4&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877372">return</span>&nbsp;<span class="ident" id="6877379">req</span><br>
<span class="lineno"></span><span class="op" id="6877383">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="6877386">func</span>&nbsp;<span class="ident" id="6877391">runCgiTest</span><span class="op" id="6877401">(</span><span class="ident" id="6877402">t</span>&nbsp;<span class="op" id="6877404">*</span><span class="ident" id="6877405">testing</span><span class="op" id="6877412">.</span><span class="ident" id="6877413">T</span><span class="op" id="6877414">,</span>&nbsp;<span class="ident" id="6877416">h</span>&nbsp;<span class="op" id="6877418">*</span><span class="ident" id="6877419">Handler</span><span class="op" id="6877426">,</span>&nbsp;<span class="ident" id="6877428">httpreq</span>&nbsp;<span class="builtintype" id="6877436">string</span><span class="op" id="6877442">,</span>&nbsp;<span class="ident" id="6877444">expectedMap</span>&nbsp;<span class="keyword" id="6877456">map</span><span class="op" id="6877459">[</span><span class="builtintype" id="6877460">string</span><span class="op" id="6877466">]</span><span class="builtintype" id="6877467">string</span><span class="op" id="6877473">)</span>&nbsp;<span class="op" id="6877475">*</span><span class="ident" id="6877476">httptest</span><span class="op" id="6877484">.</span><span class="ident" id="6877485">ResponseRecorder</span>&nbsp;<span class="op" id="6877502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877505">rw</span>&nbsp;<span class="op" id="6877508">:=</span>&nbsp;<span class="ident" id="6877511">httptest</span><span class="op" id="6877519">.</span><span class="ident" id="6877520">NewRecorder</span><span class="op" id="6877531">(</span><span class="op" id="6877532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877535">req</span>&nbsp;<span class="op" id="6877539">:=</span>&nbsp;<span class="ident" id="6877542">newRequest</span><span class="op" id="6877552">(</span><span class="ident" id="6877553">httpreq</span><span class="op" id="6877560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877563">h</span><span class="op" id="6877564">.</span><span class="ident" id="6877565">ServeHTTP</span><span class="op" id="6877574">(</span><span class="ident" id="6877575">rw</span><span class="op" id="6877577">,</span>&nbsp;<span class="ident" id="6877579">req</span><span class="op" id="6877582">)</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6877586">//&nbsp;Make&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;the&nbsp;test&nbsp;map&nbsp;that&nbsp;the&nbsp;CGI&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877644">m</span>&nbsp;<span class="op" id="6877646">:=</span>&nbsp;<span class="builtinfunc" id="6877649">make</span><span class="op" id="6877653">(</span><span class="keyword" id="6877654">map</span><span class="op" id="6877657">[</span><span class="builtintype" id="6877658">string</span><span class="op" id="6877664">]</span><span class="builtintype" id="6877665">string</span><span class="op" id="6877671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877674">m</span><span class="op" id="6877675">[</span><span class="string" id="6877676">&#34;_body&#34;</span><span class="op" id="6877683">]</span>&nbsp;<span class="op" id="6877685">=</span>&nbsp;<span class="ident" id="6877687">rw</span><span class="op" id="6877689">.</span><span class="ident" id="6877690">Body</span><span class="op" id="6877694">.</span><span class="ident" id="6877695">String</span><span class="op" id="6877701">(</span><span class="op" id="6877702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877705">linesRead</span>&nbsp;<span class="op" id="6877715">:=</span>&nbsp;<span class="num" id="6877718">0</span><br>
<span class="lineno">45</span><span class="ident" id="6877720">readlines</span><span class="op" id="6877729">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877732">for</span>&nbsp;<span class="op" id="6877736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877740">line</span><span class="op" id="6877744">,</span>&nbsp;<span class="ident" id="6877746">err</span>&nbsp;<span class="op" id="6877750">:=</span>&nbsp;<span class="ident" id="6877753">rw</span><span class="op" id="6877755">.</span><span class="ident" id="6877756">Body</span><span class="op" id="6877760">.</span><span class="ident" id="6877761">ReadString</span><span class="op" id="6877771">(</span><span class="string" id="6877772">&#39;\n&#39;</span><span class="op" id="6877776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877780">switch</span>&nbsp;<span class="op" id="6877787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877791">case</span>&nbsp;<span class="ident" id="6877796">err</span>&nbsp;<span class="op" id="6877800">==</span>&nbsp;<span class="ident" id="6877803">io</span><span class="op" id="6877805">.</span><span class="ident" id="6877806">EOF</span><span class="op" id="6877809">:</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877814">break</span>&nbsp;<span class="ident" id="6877820">readlines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877832">case</span>&nbsp;<span class="ident" id="6877837">err</span>&nbsp;<span class="op" id="6877841">!=</span>&nbsp;<span class="ident" id="6877844">nil</span><span class="op" id="6877847">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877852">t</span><span class="op" id="6877853">.</span><span class="ident" id="6877854">Fatalf</span><span class="op" id="6877860">(</span><span class="string" id="6877861">&#34;unexpected&nbsp;error&nbsp;reading&nbsp;from&nbsp;CGI:&nbsp;%v&#34;</span><span class="op" id="6877900">,</span>&nbsp;<span class="ident" id="6877902">err</span><span class="op" id="6877905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877913">linesRead</span><span class="op" id="6877922">++</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877927">trimmedLine</span>&nbsp;<span class="op" id="6877939">:=</span>&nbsp;<span class="ident" id="6877942">strings</span><span class="op" id="6877949">.</span><span class="ident" id="6877950">TrimRight</span><span class="op" id="6877959">(</span><span class="ident" id="6877960">line</span><span class="op" id="6877964">,</span>&nbsp;<span class="string" id="6877966">&#34;\r\n&#34;</span><span class="op" id="6877972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877976">split</span>&nbsp;<span class="op" id="6877982">:=</span>&nbsp;<span class="ident" id="6877985">strings</span><span class="op" id="6877992">.</span><span class="ident" id="6877993">SplitN</span><span class="op" id="6877999">(</span><span class="ident" id="6878000">trimmedLine</span><span class="op" id="6878011">,</span>&nbsp;<span class="string" id="6878013">&#34;=&#34;</span><span class="op" id="6878016">,</span>&nbsp;<span class="num" id="6878018">2</span><span class="op" id="6878019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878023">if</span>&nbsp;<span class="builtinfunc" id="6878026">len</span><span class="op" id="6878029">(</span><span class="ident" id="6878030">split</span><span class="op" id="6878035">)</span>&nbsp;<span class="op" id="6878037">!=</span>&nbsp;<span class="num" id="6878040">2</span>&nbsp;<span class="op" id="6878042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878047">t</span><span class="op" id="6878048">.</span><span class="ident" id="6878049">Fatalf</span><span class="op" id="6878055">(</span><span class="string" id="6878056">&#34;Unexpected&nbsp;%d&nbsp;parts&nbsp;from&nbsp;invalid&nbsp;line&nbsp;number&nbsp;%v:&nbsp;%q;&nbsp;existing&nbsp;map=%v&#34;</span><span class="op" id="6878126">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6878132">len</span><span class="op" id="6878135">(</span><span class="ident" id="6878136">split</span><span class="op" id="6878141">)</span><span class="op" id="6878142">,</span>&nbsp;<span class="ident" id="6878144">linesRead</span><span class="op" id="6878153">,</span>&nbsp;<span class="ident" id="6878155">line</span><span class="op" id="6878159">,</span>&nbsp;<span class="ident" id="6878161">m</span><span class="op" id="6878162">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878170">m</span><span class="op" id="6878171">[</span><span class="ident" id="6878172">split</span><span class="op" id="6878177">[</span><span class="num" id="6878178">0</span><span class="op" id="6878179">]</span><span class="op" id="6878180">]</span>&nbsp;<span class="op" id="6878182">=</span>&nbsp;<span class="ident" id="6878184">split</span><span class="op" id="6878189">[</span><span class="num" id="6878190">1</span><span class="op" id="6878191">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878198">for</span>&nbsp;<span class="ident" id="6878202">key</span><span class="op" id="6878205">,</span>&nbsp;<span class="ident" id="6878207">expected</span>&nbsp;<span class="op" id="6878216">:=</span>&nbsp;<span class="keyword" id="6878219">range</span>&nbsp;<span class="ident" id="6878225">expectedMap</span>&nbsp;<span class="op" id="6878237">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878241">got</span>&nbsp;<span class="op" id="6878245">:=</span>&nbsp;<span class="ident" id="6878248">m</span><span class="op" id="6878249">[</span><span class="ident" id="6878250">key</span><span class="op" id="6878253">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878257">if</span>&nbsp;<span class="ident" id="6878260">key</span>&nbsp;<span class="op" id="6878264">==</span>&nbsp;<span class="string" id="6878267">&#34;cwd&#34;</span>&nbsp;<span class="op" id="6878273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6878278">//&nbsp;For&nbsp;Windows.&nbsp;golang.org/issue/4645.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878320">fi1</span><span class="op" id="6878323">,</span>&nbsp;<span class="ident" id="6878325">_</span>&nbsp;<span class="op" id="6878327">:=</span>&nbsp;<span class="ident" id="6878330">os</span><span class="op" id="6878332">.</span><span class="ident" id="6878333">Stat</span><span class="op" id="6878337">(</span><span class="ident" id="6878338">got</span><span class="op" id="6878341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878346">fi2</span><span class="op" id="6878349">,</span>&nbsp;<span class="ident" id="6878351">_</span>&nbsp;<span class="op" id="6878353">:=</span>&nbsp;<span class="ident" id="6878356">os</span><span class="op" id="6878358">.</span><span class="ident" id="6878359">Stat</span><span class="op" id="6878363">(</span><span class="ident" id="6878364">expected</span><span class="op" id="6878372">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878377">if</span>&nbsp;<span class="ident" id="6878380">os</span><span class="op" id="6878382">.</span><span class="ident" id="6878383">SameFile</span><span class="op" id="6878391">(</span><span class="ident" id="6878392">fi1</span><span class="op" id="6878395">,</span>&nbsp;<span class="ident" id="6878397">fi2</span><span class="op" id="6878400">)</span>&nbsp;<span class="op" id="6878402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878408">got</span>&nbsp;<span class="op" id="6878412">=</span>&nbsp;<span class="ident" id="6878414">expected</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878434">if</span>&nbsp;<span class="ident" id="6878437">got</span>&nbsp;<span class="op" id="6878441">!=</span>&nbsp;<span class="ident" id="6878444">expected</span>&nbsp;<span class="op" id="6878453">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878458">t</span><span class="op" id="6878459">.</span><span class="ident" id="6878460">Errorf</span><span class="op" id="6878466">(</span><span class="string" id="6878467">&#34;for&nbsp;key&nbsp;%q&nbsp;got&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6878499">,</span>&nbsp;<span class="ident" id="6878501">key</span><span class="op" id="6878504">,</span>&nbsp;<span class="ident" id="6878506">got</span><span class="op" id="6878509">,</span>&nbsp;<span class="ident" id="6878511">expected</span><span class="op" id="6878519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878529">return</span>&nbsp;<span class="ident" id="6878536">rw</span><br>
<span class="lineno"></span><span class="op" id="6878539">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="6878542">var</span>&nbsp;<span class="ident" id="6878546">cgiTested</span><span class="op" id="6878555">,</span>&nbsp;<span class="ident" id="6878557">cgiWorks</span>&nbsp;<span class="builtintype" id="6878566">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6878572">func</span>&nbsp;<span class="ident" id="6878577">check</span><span class="op" id="6878582">(</span><span class="ident" id="6878583">t</span>&nbsp;<span class="op" id="6878585">*</span><span class="ident" id="6878586">testing</span><span class="op" id="6878593">.</span><span class="ident" id="6878594">T</span><span class="op" id="6878595">)</span>&nbsp;<span class="op" id="6878597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878600">if</span>&nbsp;<span class="op" id="6878603">!</span><span class="ident" id="6878604">cgiTested</span>&nbsp;<span class="op" id="6878614">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878618">cgiTested</span>&nbsp;<span class="op" id="6878628">=</span>&nbsp;<span class="ident" id="6878630">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878637">cgiWorks</span>&nbsp;<span class="op" id="6878646">=</span>&nbsp;<span class="ident" id="6878648">exec</span><span class="op" id="6878652">.</span><span class="ident" id="6878653">Command</span><span class="op" id="6878660">(</span><span class="string" id="6878661">&#34;./testdata/test.cgi&#34;</span><span class="op" id="6878682">)</span><span class="op" id="6878683">.</span><span class="ident" id="6878684">Run</span><span class="op" id="6878687">(</span><span class="op" id="6878688">)</span>&nbsp;<span class="op" id="6878690">==</span>&nbsp;<span class="ident" id="6878693">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878701">if</span>&nbsp;<span class="op" id="6878704">!</span><span class="ident" id="6878705">cgiWorks</span>&nbsp;<span class="op" id="6878714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6878718">//&nbsp;No&nbsp;Perl&nbsp;on&nbsp;Windows,&nbsp;needed&nbsp;by&nbsp;test.cgi</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6878762">//&nbsp;TODO:&nbsp;make&nbsp;the&nbsp;child&nbsp;process&nbsp;be&nbsp;Go,&nbsp;not&nbsp;Perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878813">t</span><span class="op" id="6878814">.</span><span class="ident" id="6878815">Skip</span><span class="op" id="6878819">(</span><span class="string" id="6878820">&#34;Skipping&nbsp;test:&nbsp;test.cgi&nbsp;failed.&#34;</span><span class="op" id="6878853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878856">}</span><br>
<span class="lineno"></span><span class="op" id="6878858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="6878861">func</span>&nbsp;<span class="ident" id="6878866">TestCGIBasicGet</span><span class="op" id="6878881">(</span><span class="ident" id="6878882">t</span>&nbsp;<span class="op" id="6878884">*</span><span class="ident" id="6878885">testing</span><span class="op" id="6878892">.</span><span class="ident" id="6878893">T</span><span class="op" id="6878894">)</span>&nbsp;<span class="op" id="6878896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878899">check</span><span class="op" id="6878904">(</span><span class="ident" id="6878905">t</span><span class="op" id="6878906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878909">h</span>&nbsp;<span class="op" id="6878911">:=</span>&nbsp;<span class="op" id="6878914">&amp;</span><span class="ident" id="6878915">Handler</span><span class="op" id="6878922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878926">Path</span><span class="op" id="6878930">:</span>&nbsp;<span class="string" id="6878932">&#34;testdata/test.cgi&#34;</span><span class="op" id="6878951">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878955">Root</span><span class="op" id="6878959">:</span>&nbsp;<span class="string" id="6878961">&#34;/test.cgi&#34;</span><span class="op" id="6878972">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878978">expectedMap</span>&nbsp;<span class="op" id="6878990">:=</span>&nbsp;<span class="keyword" id="6878993">map</span><span class="op" id="6878996">[</span><span class="builtintype" id="6878997">string</span><span class="op" id="6879003">]</span><span class="builtintype" id="6879004">string</span><span class="op" id="6879010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879014">&#34;test&#34;</span><span class="op" id="6879020">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6879039">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="6879050">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879054">&#34;param-a&#34;</span><span class="op" id="6879063">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6879079">&#34;b&#34;</span><span class="op" id="6879082">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879086">&#34;param-foo&#34;</span><span class="op" id="6879097">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6879111">&#34;bar&#34;</span><span class="op" id="6879116">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879120">&#34;env-GATEWAY_INTERFACE&#34;</span><span class="op" id="6879143">:</span>&nbsp;<span class="string" id="6879145">&#34;CGI/1.1&#34;</span><span class="op" id="6879154">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879158">&#34;env-HTTP_HOST&#34;</span><span class="op" id="6879173">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6879183">&#34;example.com&#34;</span><span class="op" id="6879196">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879200">&#34;env-PATH_INFO&#34;</span><span class="op" id="6879215">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6879225">&#34;&#34;</span><span class="op" id="6879227">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879231">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6879249">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6879256">&#34;foo=bar&amp;a=b&#34;</span><span class="op" id="6879269">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879273">&#34;env-REMOTE_ADDR&#34;</span><span class="op" id="6879290">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6879298">&#34;1.2.3.4&#34;</span><span class="op" id="6879307">,</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879311">&#34;env-REMOTE_HOST&#34;</span><span class="op" id="6879328">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6879336">&#34;1.2.3.4&#34;</span><span class="op" id="6879345">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879349">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="6879369">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6879374">&#34;GET&#34;</span><span class="op" id="6879379">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879383">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6879400">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6879408">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="6879431">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879435">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6879456">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="6879460">&#34;testdata/test.cgi&#34;</span><span class="op" id="6879479">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879483">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6879500">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6879508">&#34;/test.cgi&#34;</span><span class="op" id="6879519">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879523">&#34;env-SERVER_NAME&#34;</span><span class="op" id="6879540">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6879548">&#34;example.com&#34;</span><span class="op" id="6879561">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879565">&#34;env-SERVER_PORT&#34;</span><span class="op" id="6879582">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6879590">&#34;80&#34;</span><span class="op" id="6879594">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6879598">&#34;env-SERVER_SOFTWARE&#34;</span><span class="op" id="6879619">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="6879623">&#34;go&#34;</span><span class="op" id="6879627">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879633">replay</span>&nbsp;<span class="op" id="6879640">:=</span>&nbsp;<span class="ident" id="6879643">runCgiTest</span><span class="op" id="6879653">(</span><span class="ident" id="6879654">t</span><span class="op" id="6879655">,</span>&nbsp;<span class="ident" id="6879657">h</span><span class="op" id="6879658">,</span>&nbsp;<span class="string" id="6879660">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6879719">,</span>&nbsp;<span class="ident" id="6879721">expectedMap</span><span class="op" id="6879732">)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879736">if</span>&nbsp;<span class="ident" id="6879739">expected</span><span class="op" id="6879747">,</span>&nbsp;<span class="ident" id="6879749">got</span>&nbsp;<span class="op" id="6879753">:=</span>&nbsp;<span class="string" id="6879756">&#34;text/html&#34;</span><span class="op" id="6879767">,</span>&nbsp;<span class="ident" id="6879769">replay</span><span class="op" id="6879775">.</span><span class="ident" id="6879776">Header</span><span class="op" id="6879782">(</span><span class="op" id="6879783">)</span><span class="op" id="6879784">.</span><span class="ident" id="6879785">Get</span><span class="op" id="6879788">(</span><span class="string" id="6879789">&#34;Content-Type&#34;</span><span class="op" id="6879803">)</span><span class="op" id="6879804">;</span>&nbsp;<span class="ident" id="6879806">got</span>&nbsp;<span class="op" id="6879810">!=</span>&nbsp;<span class="ident" id="6879813">expected</span>&nbsp;<span class="op" id="6879822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879826">t</span><span class="op" id="6879827">.</span><span class="ident" id="6879828">Errorf</span><span class="op" id="6879834">(</span><span class="string" id="6879835">&#34;got&nbsp;a&nbsp;Content-Type&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6879874">,</span>&nbsp;<span class="ident" id="6879876">got</span><span class="op" id="6879879">,</span>&nbsp;<span class="ident" id="6879881">expected</span><span class="op" id="6879889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879895">if</span>&nbsp;<span class="ident" id="6879898">expected</span><span class="op" id="6879906">,</span>&nbsp;<span class="ident" id="6879908">got</span>&nbsp;<span class="op" id="6879912">:=</span>&nbsp;<span class="string" id="6879915">&#34;X-Test-Value&#34;</span><span class="op" id="6879929">,</span>&nbsp;<span class="ident" id="6879931">replay</span><span class="op" id="6879937">.</span><span class="ident" id="6879938">Header</span><span class="op" id="6879944">(</span><span class="op" id="6879945">)</span><span class="op" id="6879946">.</span><span class="ident" id="6879947">Get</span><span class="op" id="6879950">(</span><span class="string" id="6879951">&#34;X-Test-Header&#34;</span><span class="op" id="6879966">)</span><span class="op" id="6879967">;</span>&nbsp;<span class="ident" id="6879969">got</span>&nbsp;<span class="op" id="6879973">!=</span>&nbsp;<span class="ident" id="6879976">expected</span>&nbsp;<span class="op" id="6879985">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879989">t</span><span class="op" id="6879990">.</span><span class="ident" id="6879991">Errorf</span><span class="op" id="6879997">(</span><span class="string" id="6879998">&#34;got&nbsp;a&nbsp;X-Test-Header&nbsp;of&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6880038">,</span>&nbsp;<span class="ident" id="6880040">got</span><span class="op" id="6880043">,</span>&nbsp;<span class="ident" id="6880045">expected</span><span class="op" id="6880053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880056">}</span><br>
<span class="lineno"></span><span class="op" id="6880058">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6880061">func</span>&nbsp;<span class="ident" id="6880066">TestCGIBasicGetAbsPath</span><span class="op" id="6880088">(</span><span class="ident" id="6880089">t</span>&nbsp;<span class="op" id="6880091">*</span><span class="ident" id="6880092">testing</span><span class="op" id="6880099">.</span><span class="ident" id="6880100">T</span><span class="op" id="6880101">)</span>&nbsp;<span class="op" id="6880103">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880106">check</span><span class="op" id="6880111">(</span><span class="ident" id="6880112">t</span><span class="op" id="6880113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880116">pwd</span><span class="op" id="6880119">,</span>&nbsp;<span class="ident" id="6880121">err</span>&nbsp;<span class="op" id="6880125">:=</span>&nbsp;<span class="ident" id="6880128">os</span><span class="op" id="6880130">.</span><span class="ident" id="6880131">Getwd</span><span class="op" id="6880136">(</span><span class="op" id="6880137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880140">if</span>&nbsp;<span class="ident" id="6880143">err</span>&nbsp;<span class="op" id="6880147">!=</span>&nbsp;<span class="ident" id="6880150">nil</span>&nbsp;<span class="op" id="6880154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880158">t</span><span class="op" id="6880159">.</span><span class="ident" id="6880160">Fatalf</span><span class="op" id="6880166">(</span><span class="string" id="6880167">&#34;getwd&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6880184">,</span>&nbsp;<span class="ident" id="6880186">err</span><span class="op" id="6880189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880192">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880195">h</span>&nbsp;<span class="op" id="6880197">:=</span>&nbsp;<span class="op" id="6880200">&amp;</span><span class="ident" id="6880201">Handler</span><span class="op" id="6880208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880212">Path</span><span class="op" id="6880216">:</span>&nbsp;<span class="ident" id="6880218">pwd</span>&nbsp;<span class="op" id="6880222">+</span>&nbsp;<span class="string" id="6880224">&#34;/testdata/test.cgi&#34;</span><span class="op" id="6880244">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880248">Root</span><span class="op" id="6880252">:</span>&nbsp;<span class="string" id="6880254">&#34;/test.cgi&#34;</span><span class="op" id="6880265">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880271">expectedMap</span>&nbsp;<span class="op" id="6880283">:=</span>&nbsp;<span class="keyword" id="6880286">map</span><span class="op" id="6880289">[</span><span class="builtintype" id="6880290">string</span><span class="op" id="6880296">]</span><span class="builtintype" id="6880297">string</span><span class="op" id="6880303">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6880307">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6880324">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6880330">&#34;/test.cgi?foo=bar&amp;a=b&#34;</span><span class="op" id="6880353">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6880357">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6880378">:</span>&nbsp;<span class="ident" id="6880380">pwd</span>&nbsp;<span class="op" id="6880384">+</span>&nbsp;<span class="string" id="6880386">&#34;/testdata/test.cgi&#34;</span><span class="op" id="6880406">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6880410">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6880427">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6880433">&#34;/test.cgi&#34;</span><span class="op" id="6880444">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880450">runCgiTest</span><span class="op" id="6880460">(</span><span class="ident" id="6880461">t</span><span class="op" id="6880462">,</span>&nbsp;<span class="ident" id="6880464">h</span><span class="op" id="6880465">,</span>&nbsp;<span class="string" id="6880467">&#34;GET&nbsp;/test.cgi?foo=bar&amp;a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6880526">,</span>&nbsp;<span class="ident" id="6880528">expectedMap</span><span class="op" id="6880539">)</span><br>
<span class="lineno">145</span><span class="op" id="6880541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6880544">func</span>&nbsp;<span class="ident" id="6880549">TestPathInfo</span><span class="op" id="6880561">(</span><span class="ident" id="6880562">t</span>&nbsp;<span class="op" id="6880564">*</span><span class="ident" id="6880565">testing</span><span class="op" id="6880572">.</span><span class="ident" id="6880573">T</span><span class="op" id="6880574">)</span>&nbsp;<span class="op" id="6880576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880579">check</span><span class="op" id="6880584">(</span><span class="ident" id="6880585">t</span><span class="op" id="6880586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880589">h</span>&nbsp;<span class="op" id="6880591">:=</span>&nbsp;<span class="op" id="6880594">&amp;</span><span class="ident" id="6880595">Handler</span><span class="op" id="6880602">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880606">Path</span><span class="op" id="6880610">:</span>&nbsp;<span class="string" id="6880612">&#34;testdata/test.cgi&#34;</span><span class="op" id="6880631">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880635">Root</span><span class="op" id="6880639">:</span>&nbsp;<span class="string" id="6880641">&#34;/test.cgi&#34;</span><span class="op" id="6880652">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880658">expectedMap</span>&nbsp;<span class="op" id="6880670">:=</span>&nbsp;<span class="keyword" id="6880673">map</span><span class="op" id="6880676">[</span><span class="builtintype" id="6880677">string</span><span class="op" id="6880683">]</span><span class="builtintype" id="6880684">string</span><span class="op" id="6880690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6880694">&#34;param-a&#34;</span><span class="op" id="6880703">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6880717">&#34;b&#34;</span><span class="op" id="6880720">,</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6880724">&#34;env-PATH_INFO&#34;</span><span class="op" id="6880739">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6880747">&#34;/extrapath&#34;</span><span class="op" id="6880759">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6880763">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6880781">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6880786">&#34;a=b&#34;</span><span class="op" id="6880791">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6880795">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6880812">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6880818">&#34;/test.cgi/extrapath?a=b&#34;</span><span class="op" id="6880843">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6880847">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6880868">:</span>&nbsp;<span class="string" id="6880870">&#34;testdata/test.cgi&#34;</span><span class="op" id="6880889">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6880893">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6880910">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6880916">&#34;/test.cgi&#34;</span><span class="op" id="6880927">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880933">runCgiTest</span><span class="op" id="6880943">(</span><span class="ident" id="6880944">t</span><span class="op" id="6880945">,</span>&nbsp;<span class="ident" id="6880947">h</span><span class="op" id="6880948">,</span>&nbsp;<span class="string" id="6880950">&#34;GET&nbsp;/test.cgi/extrapath?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6881011">,</span>&nbsp;<span class="ident" id="6881013">expectedMap</span><span class="op" id="6881024">)</span><br>
<span class="lineno"></span><span class="op" id="6881026">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6881029">func</span>&nbsp;<span class="ident" id="6881034">TestPathInfoDirRoot</span><span class="op" id="6881053">(</span><span class="ident" id="6881054">t</span>&nbsp;<span class="op" id="6881056">*</span><span class="ident" id="6881057">testing</span><span class="op" id="6881064">.</span><span class="ident" id="6881065">T</span><span class="op" id="6881066">)</span>&nbsp;<span class="op" id="6881068">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881071">check</span><span class="op" id="6881076">(</span><span class="ident" id="6881077">t</span><span class="op" id="6881078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881081">h</span>&nbsp;<span class="op" id="6881083">:=</span>&nbsp;<span class="op" id="6881086">&amp;</span><span class="ident" id="6881087">Handler</span><span class="op" id="6881094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881098">Path</span><span class="op" id="6881102">:</span>&nbsp;<span class="string" id="6881104">&#34;testdata/test.cgi&#34;</span><span class="op" id="6881123">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881127">Root</span><span class="op" id="6881131">:</span>&nbsp;<span class="string" id="6881133">&#34;/myscript/&#34;</span><span class="op" id="6881145">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881148">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881151">expectedMap</span>&nbsp;<span class="op" id="6881163">:=</span>&nbsp;<span class="keyword" id="6881166">map</span><span class="op" id="6881169">[</span><span class="builtintype" id="6881170">string</span><span class="op" id="6881176">]</span><span class="builtintype" id="6881177">string</span><span class="op" id="6881183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6881187">&#34;env-PATH_INFO&#34;</span><span class="op" id="6881202">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6881210">&#34;bar&#34;</span><span class="op" id="6881215">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6881219">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6881237">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6881242">&#34;a=b&#34;</span><span class="op" id="6881247">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6881251">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6881268">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6881274">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="6881293">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6881297">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6881318">:</span>&nbsp;<span class="string" id="6881320">&#34;testdata/test.cgi&#34;</span><span class="op" id="6881339">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6881343">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6881360">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6881366">&#34;/myscript/&#34;</span><span class="op" id="6881378">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881384">runCgiTest</span><span class="op" id="6881394">(</span><span class="ident" id="6881395">t</span><span class="op" id="6881396">,</span>&nbsp;<span class="ident" id="6881398">h</span><span class="op" id="6881399">,</span>&nbsp;<span class="string" id="6881401">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6881456">,</span>&nbsp;<span class="ident" id="6881458">expectedMap</span><span class="op" id="6881469">)</span><br>
<span class="lineno"></span><span class="op" id="6881471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="6881474">func</span>&nbsp;<span class="ident" id="6881479">TestDupHeaders</span><span class="op" id="6881493">(</span><span class="ident" id="6881494">t</span>&nbsp;<span class="op" id="6881496">*</span><span class="ident" id="6881497">testing</span><span class="op" id="6881504">.</span><span class="ident" id="6881505">T</span><span class="op" id="6881506">)</span>&nbsp;<span class="op" id="6881508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881511">check</span><span class="op" id="6881516">(</span><span class="ident" id="6881517">t</span><span class="op" id="6881518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881521">h</span>&nbsp;<span class="op" id="6881523">:=</span>&nbsp;<span class="op" id="6881526">&amp;</span><span class="ident" id="6881527">Handler</span><span class="op" id="6881534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881538">Path</span><span class="op" id="6881542">:</span>&nbsp;<span class="string" id="6881544">&#34;testdata/test.cgi&#34;</span><span class="op" id="6881563">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881566">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881569">expectedMap</span>&nbsp;<span class="op" id="6881581">:=</span>&nbsp;<span class="keyword" id="6881584">map</span><span class="op" id="6881587">[</span><span class="builtintype" id="6881588">string</span><span class="op" id="6881594">]</span><span class="builtintype" id="6881595">string</span><span class="op" id="6881601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6881605">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6881622">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6881628">&#34;/myscript/bar?a=b&#34;</span><span class="op" id="6881647">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6881651">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6881672">:</span>&nbsp;<span class="string" id="6881674">&#34;testdata/test.cgi&#34;</span><span class="op" id="6881693">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6881697">&#34;env-HTTP_COOKIE&#34;</span><span class="op" id="6881714">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6881720">&#34;nom=NOM;&nbsp;yum=YUM&#34;</span><span class="op" id="6881738">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6881742">&#34;env-HTTP_X_FOO&#34;</span><span class="op" id="6881758">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6881765">&#34;val1,&nbsp;val2&#34;</span><span class="op" id="6881777">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881783">runCgiTest</span><span class="op" id="6881793">(</span><span class="ident" id="6881794">t</span><span class="op" id="6881795">,</span>&nbsp;<span class="ident" id="6881797">h</span><span class="op" id="6881798">,</span>&nbsp;<span class="string" id="6881800">&#34;GET&nbsp;/myscript/bar?a=b&nbsp;HTTP/1.0\n&#34;</span><span class="op" id="6881834">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6881838">&#34;Cookie:&nbsp;nom=NOM\n&#34;</span><span class="op" id="6881857">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6881861">&#34;Cookie:&nbsp;yum=YUM\n&#34;</span><span class="op" id="6881880">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6881884">&#34;X-Foo:&nbsp;val1\n&#34;</span><span class="op" id="6881899">+</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6881903">&#34;X-Foo:&nbsp;val2\n&#34;</span><span class="op" id="6881918">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6881922">&#34;Host:&nbsp;example.com\n\n&#34;</span><span class="op" id="6881945">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881949">expectedMap</span><span class="op" id="6881960">)</span><br>
<span class="lineno"></span><span class="op" id="6881962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="6881965">func</span>&nbsp;<span class="ident" id="6881970">TestPathInfoNoRoot</span><span class="op" id="6881988">(</span><span class="ident" id="6881989">t</span>&nbsp;<span class="op" id="6881991">*</span><span class="ident" id="6881992">testing</span><span class="op" id="6881999">.</span><span class="ident" id="6882000">T</span><span class="op" id="6882001">)</span>&nbsp;<span class="op" id="6882003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882006">check</span><span class="op" id="6882011">(</span><span class="ident" id="6882012">t</span><span class="op" id="6882013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882016">h</span>&nbsp;<span class="op" id="6882018">:=</span>&nbsp;<span class="op" id="6882021">&amp;</span><span class="ident" id="6882022">Handler</span><span class="op" id="6882029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882033">Path</span><span class="op" id="6882037">:</span>&nbsp;<span class="string" id="6882039">&#34;testdata/test.cgi&#34;</span><span class="op" id="6882058">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882062">Root</span><span class="op" id="6882066">:</span>&nbsp;<span class="string" id="6882068">&#34;&#34;</span><span class="op" id="6882070">,</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882076">expectedMap</span>&nbsp;<span class="op" id="6882088">:=</span>&nbsp;<span class="keyword" id="6882091">map</span><span class="op" id="6882094">[</span><span class="builtintype" id="6882095">string</span><span class="op" id="6882101">]</span><span class="builtintype" id="6882102">string</span><span class="op" id="6882108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6882112">&#34;env-PATH_INFO&#34;</span><span class="op" id="6882127">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6882135">&#34;/bar&#34;</span><span class="op" id="6882141">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6882145">&#34;env-QUERY_STRING&#34;</span><span class="op" id="6882163">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6882168">&#34;a=b&#34;</span><span class="op" id="6882173">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6882177">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6882194">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6882200">&#34;/bar?a=b&#34;</span><span class="op" id="6882210">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6882214">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6882235">:</span>&nbsp;<span class="string" id="6882237">&#34;testdata/test.cgi&#34;</span><span class="op" id="6882256">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6882260">&#34;env-SCRIPT_NAME&#34;</span><span class="op" id="6882277">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6882283">&#34;/&#34;</span><span class="op" id="6882286">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882292">runCgiTest</span><span class="op" id="6882302">(</span><span class="ident" id="6882303">t</span><span class="op" id="6882304">,</span>&nbsp;<span class="ident" id="6882306">h</span><span class="op" id="6882307">,</span>&nbsp;<span class="string" id="6882309">&#34;GET&nbsp;/bar?a=b&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6882355">,</span>&nbsp;<span class="ident" id="6882357">expectedMap</span><span class="op" id="6882368">)</span><br>
<span class="lineno"></span><span class="op" id="6882370">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="6882373">func</span>&nbsp;<span class="ident" id="6882378">TestCGIBasicPost</span><span class="op" id="6882394">(</span><span class="ident" id="6882395">t</span>&nbsp;<span class="op" id="6882397">*</span><span class="ident" id="6882398">testing</span><span class="op" id="6882405">.</span><span class="ident" id="6882406">T</span><span class="op" id="6882407">)</span>&nbsp;<span class="op" id="6882409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882412">check</span><span class="op" id="6882417">(</span><span class="ident" id="6882418">t</span><span class="op" id="6882419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882422">postReq</span>&nbsp;<span class="op" id="6882430">:=</span>&nbsp;<span class="string" id="6882433">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.0<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno">220</span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Content-Length:&nbsp;15<br>
<span class="lineno"></span><br>
<span class="lineno"></span>postfoo=postbar`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882566">h</span>&nbsp;<span class="op" id="6882568">:=</span>&nbsp;<span class="op" id="6882571">&amp;</span><span class="ident" id="6882572">Handler</span><span class="op" id="6882579">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882583">Path</span><span class="op" id="6882587">:</span>&nbsp;<span class="string" id="6882589">&#34;testdata/test.cgi&#34;</span><span class="op" id="6882608">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882612">Root</span><span class="op" id="6882616">:</span>&nbsp;<span class="string" id="6882618">&#34;/test.cgi&#34;</span><span class="op" id="6882629">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882635">expectedMap</span>&nbsp;<span class="op" id="6882647">:=</span>&nbsp;<span class="keyword" id="6882650">map</span><span class="op" id="6882653">[</span><span class="builtintype" id="6882654">string</span><span class="op" id="6882660">]</span><span class="builtintype" id="6882661">string</span><span class="op" id="6882667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6882671">&#34;test&#34;</span><span class="op" id="6882677">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6882693">&#34;Hello&nbsp;CGI&#34;</span><span class="op" id="6882704">,</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6882708">&#34;param-postfoo&#34;</span><span class="op" id="6882723">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6882730">&#34;postbar&#34;</span><span class="op" id="6882739">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6882743">&#34;env-REQUEST_METHOD&#34;</span><span class="op" id="6882763">:</span>&nbsp;<span class="string" id="6882765">&#34;POST&#34;</span><span class="op" id="6882771">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6882775">&#34;env-CONTENT_LENGTH&#34;</span><span class="op" id="6882795">:</span>&nbsp;<span class="string" id="6882797">&#34;15&#34;</span><span class="op" id="6882801">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6882805">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6882822">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6882827">&#34;/test.cgi?a=b&#34;</span><span class="op" id="6882842">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882845">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882848">runCgiTest</span><span class="op" id="6882858">(</span><span class="ident" id="6882859">t</span><span class="op" id="6882860">,</span>&nbsp;<span class="ident" id="6882862">h</span><span class="op" id="6882863">,</span>&nbsp;<span class="ident" id="6882865">postReq</span><span class="op" id="6882872">,</span>&nbsp;<span class="ident" id="6882874">expectedMap</span><span class="op" id="6882885">)</span><br>
<span class="lineno"></span><span class="op" id="6882887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6882890">func</span>&nbsp;<span class="ident" id="6882895">chunk</span><span class="op" id="6882900">(</span><span class="ident" id="6882901">s</span>&nbsp;<span class="builtintype" id="6882903">string</span><span class="op" id="6882909">)</span>&nbsp;<span class="builtintype" id="6882911">string</span>&nbsp;<span class="op" id="6882918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882921">return</span>&nbsp;<span class="ident" id="6882928">fmt</span><span class="op" id="6882931">.</span><span class="ident" id="6882932">Sprintf</span><span class="op" id="6882939">(</span><span class="string" id="6882940">&#34;%x\r\n%s\r\n&#34;</span><span class="op" id="6882954">,</span>&nbsp;<span class="builtinfunc" id="6882956">len</span><span class="op" id="6882959">(</span><span class="ident" id="6882960">s</span><span class="op" id="6882961">)</span><span class="op" id="6882962">,</span>&nbsp;<span class="ident" id="6882964">s</span><span class="op" id="6882965">)</span><br>
<span class="lineno">240</span><span class="op" id="6882967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6882970">//&nbsp;The&nbsp;CGI&nbsp;spec&nbsp;doesn&#39;t&nbsp;allow&nbsp;chunked&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="6883018">func</span>&nbsp;<span class="ident" id="6883023">TestCGIPostChunked</span><span class="op" id="6883041">(</span><span class="ident" id="6883042">t</span>&nbsp;<span class="op" id="6883044">*</span><span class="ident" id="6883045">testing</span><span class="op" id="6883052">.</span><span class="ident" id="6883053">T</span><span class="op" id="6883054">)</span>&nbsp;<span class="op" id="6883056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883059">check</span><span class="op" id="6883064">(</span><span class="ident" id="6883065">t</span><span class="op" id="6883066">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883069">postReq</span>&nbsp;<span class="op" id="6883077">:=</span>&nbsp;<span class="string" id="6883080">`POST&nbsp;/test.cgi?a=b&nbsp;HTTP/1.1<br>
<span class="lineno"></span>Host:&nbsp;example.com<br>
<span class="lineno"></span>Content-Type:&nbsp;application/x-www-form-urlencoded<br>
<span class="lineno"></span>Transfer-Encoding:&nbsp;chunked<br>
<span class="lineno"></span><br>
<span class="lineno">250</span>`</span>&nbsp;<span class="op" id="6883205">+</span>&nbsp;<span class="ident" id="6883207">chunk</span><span class="op" id="6883212">(</span><span class="string" id="6883213">&#34;postfoo&#34;</span><span class="op" id="6883222">)</span>&nbsp;<span class="op" id="6883224">+</span>&nbsp;<span class="ident" id="6883226">chunk</span><span class="op" id="6883231">(</span><span class="string" id="6883232">&#34;=&#34;</span><span class="op" id="6883235">)</span>&nbsp;<span class="op" id="6883237">+</span>&nbsp;<span class="ident" id="6883239">chunk</span><span class="op" id="6883244">(</span><span class="string" id="6883245">&#34;postbar&#34;</span><span class="op" id="6883254">)</span>&nbsp;<span class="op" id="6883256">+</span>&nbsp;<span class="ident" id="6883258">chunk</span><span class="op" id="6883263">(</span><span class="string" id="6883264">&#34;&#34;</span><span class="op" id="6883266">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883270">h</span>&nbsp;<span class="op" id="6883272">:=</span>&nbsp;<span class="op" id="6883275">&amp;</span><span class="ident" id="6883276">Handler</span><span class="op" id="6883283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883287">Path</span><span class="op" id="6883291">:</span>&nbsp;<span class="string" id="6883293">&#34;testdata/test.cgi&#34;</span><span class="op" id="6883312">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883316">Root</span><span class="op" id="6883320">:</span>&nbsp;<span class="string" id="6883322">&#34;/test.cgi&#34;</span><span class="op" id="6883333">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883339">expectedMap</span>&nbsp;<span class="op" id="6883351">:=</span>&nbsp;<span class="keyword" id="6883354">map</span><span class="op" id="6883357">[</span><span class="builtintype" id="6883358">string</span><span class="op" id="6883364">]</span><span class="builtintype" id="6883365">string</span><span class="op" id="6883371">{</span><span class="op" id="6883372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883375">resp</span>&nbsp;<span class="op" id="6883380">:=</span>&nbsp;<span class="ident" id="6883383">runCgiTest</span><span class="op" id="6883393">(</span><span class="ident" id="6883394">t</span><span class="op" id="6883395">,</span>&nbsp;<span class="ident" id="6883397">h</span><span class="op" id="6883398">,</span>&nbsp;<span class="ident" id="6883400">postReq</span><span class="op" id="6883407">,</span>&nbsp;<span class="ident" id="6883409">expectedMap</span><span class="op" id="6883420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883423">if</span>&nbsp;<span class="ident" id="6883426">got</span><span class="op" id="6883429">,</span>&nbsp;<span class="ident" id="6883431">expected</span>&nbsp;<span class="op" id="6883440">:=</span>&nbsp;<span class="ident" id="6883443">resp</span><span class="op" id="6883447">.</span><span class="ident" id="6883448">Code</span><span class="op" id="6883452">,</span>&nbsp;<span class="ident" id="6883454">http</span><span class="op" id="6883458">.</span><span class="ident" id="6883459">StatusBadRequest</span><span class="op" id="6883475">;</span>&nbsp;<span class="ident" id="6883477">got</span>&nbsp;<span class="op" id="6883481">!=</span>&nbsp;<span class="ident" id="6883484">expected</span>&nbsp;<span class="op" id="6883493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883497">t</span><span class="op" id="6883498">.</span><span class="ident" id="6883499">Fatalf</span><span class="op" id="6883505">(</span><span class="string" id="6883506">&#34;Expected&nbsp;%v&nbsp;response&nbsp;code&nbsp;from&nbsp;chunked&nbsp;request&nbsp;body;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6883567">,</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883572">expected</span><span class="op" id="6883580">,</span>&nbsp;<span class="ident" id="6883582">got</span><span class="op" id="6883585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883588">}</span><br>
<span class="lineno"></span><span class="op" id="6883590">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6883593">func</span>&nbsp;<span class="ident" id="6883598">TestRedirect</span><span class="op" id="6883610">(</span><span class="ident" id="6883611">t</span>&nbsp;<span class="op" id="6883613">*</span><span class="ident" id="6883614">testing</span><span class="op" id="6883621">.</span><span class="ident" id="6883622">T</span><span class="op" id="6883623">)</span>&nbsp;<span class="op" id="6883625">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883628">check</span><span class="op" id="6883633">(</span><span class="ident" id="6883634">t</span><span class="op" id="6883635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883638">h</span>&nbsp;<span class="op" id="6883640">:=</span>&nbsp;<span class="op" id="6883643">&amp;</span><span class="ident" id="6883644">Handler</span><span class="op" id="6883651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883655">Path</span><span class="op" id="6883659">:</span>&nbsp;<span class="string" id="6883661">&#34;testdata/test.cgi&#34;</span><span class="op" id="6883680">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883684">Root</span><span class="op" id="6883688">:</span>&nbsp;<span class="string" id="6883690">&#34;/test.cgi&#34;</span><span class="op" id="6883701">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883704">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883707">rec</span>&nbsp;<span class="op" id="6883711">:=</span>&nbsp;<span class="ident" id="6883714">runCgiTest</span><span class="op" id="6883724">(</span><span class="ident" id="6883725">t</span><span class="op" id="6883726">,</span>&nbsp;<span class="ident" id="6883728">h</span><span class="op" id="6883729">,</span>&nbsp;<span class="string" id="6883731">&#34;GET&nbsp;/test.cgi?loc=http://foo.com/&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6883798">,</span>&nbsp;<span class="ident" id="6883800">nil</span><span class="op" id="6883803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883806">if</span>&nbsp;<span class="ident" id="6883809">e</span><span class="op" id="6883810">,</span>&nbsp;<span class="ident" id="6883812">g</span>&nbsp;<span class="op" id="6883814">:=</span>&nbsp;<span class="num" id="6883817">302</span><span class="op" id="6883820">,</span>&nbsp;<span class="ident" id="6883822">rec</span><span class="op" id="6883825">.</span><span class="ident" id="6883826">Code</span><span class="op" id="6883830">;</span>&nbsp;<span class="ident" id="6883832">e</span>&nbsp;<span class="op" id="6883834">!=</span>&nbsp;<span class="ident" id="6883837">g</span>&nbsp;<span class="op" id="6883839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883843">t</span><span class="op" id="6883844">.</span><span class="ident" id="6883845">Errorf</span><span class="op" id="6883851">(</span><span class="string" id="6883852">&#34;expected&nbsp;status&nbsp;code&nbsp;%d;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="6883885">,</span>&nbsp;<span class="ident" id="6883887">e</span><span class="op" id="6883888">,</span>&nbsp;<span class="ident" id="6883890">g</span><span class="op" id="6883891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883897">if</span>&nbsp;<span class="ident" id="6883900">e</span><span class="op" id="6883901">,</span>&nbsp;<span class="ident" id="6883903">g</span>&nbsp;<span class="op" id="6883905">:=</span>&nbsp;<span class="string" id="6883908">&#34;http://foo.com/&#34;</span><span class="op" id="6883925">,</span>&nbsp;<span class="ident" id="6883927">rec</span><span class="op" id="6883930">.</span><span class="ident" id="6883931">Header</span><span class="op" id="6883937">(</span><span class="op" id="6883938">)</span><span class="op" id="6883939">.</span><span class="ident" id="6883940">Get</span><span class="op" id="6883943">(</span><span class="string" id="6883944">&#34;Location&#34;</span><span class="op" id="6883954">)</span><span class="op" id="6883955">;</span>&nbsp;<span class="ident" id="6883957">e</span>&nbsp;<span class="op" id="6883959">!=</span>&nbsp;<span class="ident" id="6883962">g</span>&nbsp;<span class="op" id="6883964">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883968">t</span><span class="op" id="6883969">.</span><span class="ident" id="6883970">Errorf</span><span class="op" id="6883976">(</span><span class="string" id="6883977">&#34;expected&nbsp;Location&nbsp;header&nbsp;of&nbsp;%q;&nbsp;got&nbsp;%q&#34;</span><span class="op" id="6884017">,</span>&nbsp;<span class="ident" id="6884019">e</span><span class="op" id="6884020">,</span>&nbsp;<span class="ident" id="6884022">g</span><span class="op" id="6884023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884026">}</span><br>
<span class="lineno"></span><span class="op" id="6884028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6884031">func</span>&nbsp;<span class="ident" id="6884036">TestInternalRedirect</span><span class="op" id="6884056">(</span><span class="ident" id="6884057">t</span>&nbsp;<span class="op" id="6884059">*</span><span class="ident" id="6884060">testing</span><span class="op" id="6884067">.</span><span class="ident" id="6884068">T</span><span class="op" id="6884069">)</span>&nbsp;<span class="op" id="6884071">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884074">check</span><span class="op" id="6884079">(</span><span class="ident" id="6884080">t</span><span class="op" id="6884081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884084">baseHandler</span>&nbsp;<span class="op" id="6884096">:=</span>&nbsp;<span class="ident" id="6884099">http</span><span class="op" id="6884103">.</span><span class="ident" id="6884104">HandlerFunc</span><span class="op" id="6884115">(</span><span class="keyword" id="6884116">func</span><span class="op" id="6884120">(</span><span class="ident" id="6884121">rw</span>&nbsp;<span class="ident" id="6884124">http</span><span class="op" id="6884128">.</span><span class="ident" id="6884129">ResponseWriter</span><span class="op" id="6884143">,</span>&nbsp;<span class="ident" id="6884145">req</span>&nbsp;<span class="op" id="6884149">*</span><span class="ident" id="6884150">http</span><span class="op" id="6884154">.</span><span class="ident" id="6884155">Request</span><span class="op" id="6884162">)</span>&nbsp;<span class="op" id="6884164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884168">fmt</span><span class="op" id="6884171">.</span><span class="ident" id="6884172">Fprintf</span><span class="op" id="6884179">(</span><span class="ident" id="6884180">rw</span><span class="op" id="6884182">,</span>&nbsp;<span class="string" id="6884184">&#34;basepath=%s\n&#34;</span><span class="op" id="6884199">,</span>&nbsp;<span class="ident" id="6884201">req</span><span class="op" id="6884204">.</span><span class="ident" id="6884205">URL</span><span class="op" id="6884208">.</span><span class="ident" id="6884209">Path</span><span class="op" id="6884213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884217">fmt</span><span class="op" id="6884220">.</span><span class="ident" id="6884221">Fprintf</span><span class="op" id="6884228">(</span><span class="ident" id="6884229">rw</span><span class="op" id="6884231">,</span>&nbsp;<span class="string" id="6884233">&#34;remoteaddr=%s\n&#34;</span><span class="op" id="6884250">,</span>&nbsp;<span class="ident" id="6884252">req</span><span class="op" id="6884255">.</span><span class="ident" id="6884256">RemoteAddr</span><span class="op" id="6884266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884269">}</span><span class="op" id="6884270">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884273">h</span>&nbsp;<span class="op" id="6884275">:=</span>&nbsp;<span class="op" id="6884278">&amp;</span><span class="ident" id="6884279">Handler</span><span class="op" id="6884286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884290">Path</span><span class="op" id="6884294">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6884311">&#34;testdata/test.cgi&#34;</span><span class="op" id="6884330">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884334">Root</span><span class="op" id="6884338">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6884355">&#34;/test.cgi&#34;</span><span class="op" id="6884366">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884370">PathLocationHandler</span><span class="op" id="6884389">:</span>&nbsp;<span class="ident" id="6884391">baseHandler</span><span class="op" id="6884402">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884405">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884408">expectedMap</span>&nbsp;<span class="op" id="6884420">:=</span>&nbsp;<span class="keyword" id="6884423">map</span><span class="op" id="6884426">[</span><span class="builtintype" id="6884427">string</span><span class="op" id="6884433">]</span><span class="builtintype" id="6884434">string</span><span class="op" id="6884440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6884444">&#34;basepath&#34;</span><span class="op" id="6884454">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="6884458">&#34;/foo&#34;</span><span class="op" id="6884464">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6884468">&#34;remoteaddr&#34;</span><span class="op" id="6884480">:</span>&nbsp;<span class="string" id="6884482">&#34;1.2.3.4&#34;</span><span class="op" id="6884491">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884497">runCgiTest</span><span class="op" id="6884507">(</span><span class="ident" id="6884508">t</span><span class="op" id="6884509">,</span>&nbsp;<span class="ident" id="6884511">h</span><span class="op" id="6884512">,</span>&nbsp;<span class="string" id="6884514">&#34;GET&nbsp;/test.cgi?loc=/foo&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6884570">,</span>&nbsp;<span class="ident" id="6884572">expectedMap</span><span class="op" id="6884583">)</span><br>
<span class="lineno">295</span><span class="op" id="6884585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6884588">//&nbsp;TestCopyError&nbsp;tests&nbsp;that&nbsp;we&nbsp;kill&nbsp;the&nbsp;process&nbsp;if&nbsp;there&#39;s&nbsp;an&nbsp;error&nbsp;copying</span><br>
<span class="lineno"></span><span class="comment" id="6884664">//&nbsp;its&nbsp;output.&nbsp;(for&nbsp;example,&nbsp;from&nbsp;the&nbsp;client&nbsp;having&nbsp;gone&nbsp;away)</span><br>
<span class="lineno"></span><span class="keyword" id="6884727">func</span>&nbsp;<span class="ident" id="6884732">TestCopyError</span><span class="op" id="6884745">(</span><span class="ident" id="6884746">t</span>&nbsp;<span class="op" id="6884748">*</span><span class="ident" id="6884749">testing</span><span class="op" id="6884756">.</span><span class="ident" id="6884757">T</span><span class="op" id="6884758">)</span>&nbsp;<span class="op" id="6884760">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884763">check</span><span class="op" id="6884768">(</span><span class="ident" id="6884769">t</span><span class="op" id="6884770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884773">if</span>&nbsp;<span class="ident" id="6884776">runtime</span><span class="op" id="6884783">.</span><span class="ident" id="6884784">GOOS</span>&nbsp;<span class="op" id="6884789">==</span>&nbsp;<span class="string" id="6884792">&#34;windows&#34;</span>&nbsp;<span class="op" id="6884802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884806">t</span><span class="op" id="6884807">.</span><span class="ident" id="6884808">Skipf</span><span class="op" id="6884813">(</span><span class="string" id="6884814">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="6884835">,</span>&nbsp;<span class="ident" id="6884837">runtime</span><span class="op" id="6884844">.</span><span class="ident" id="6884845">GOOS</span><span class="op" id="6884849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884855">h</span>&nbsp;<span class="op" id="6884857">:=</span>&nbsp;<span class="op" id="6884860">&amp;</span><span class="ident" id="6884861">Handler</span><span class="op" id="6884868">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884872">Path</span><span class="op" id="6884876">:</span>&nbsp;<span class="string" id="6884878">&#34;testdata/test.cgi&#34;</span><span class="op" id="6884897">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884901">Root</span><span class="op" id="6884905">:</span>&nbsp;<span class="string" id="6884907">&#34;/test.cgi&#34;</span><span class="op" id="6884918">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884924">ts</span>&nbsp;<span class="op" id="6884927">:=</span>&nbsp;<span class="ident" id="6884930">httptest</span><span class="op" id="6884938">.</span><span class="ident" id="6884939">NewServer</span><span class="op" id="6884948">(</span><span class="ident" id="6884949">h</span><span class="op" id="6884950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884953">defer</span>&nbsp;<span class="ident" id="6884959">ts</span><span class="op" id="6884961">.</span><span class="ident" id="6884962">Close</span><span class="op" id="6884967">(</span><span class="op" id="6884968">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884972">conn</span><span class="op" id="6884976">,</span>&nbsp;<span class="ident" id="6884978">err</span>&nbsp;<span class="op" id="6884982">:=</span>&nbsp;<span class="ident" id="6884985">net</span><span class="op" id="6884988">.</span><span class="ident" id="6884989">Dial</span><span class="op" id="6884993">(</span><span class="string" id="6884994">&#34;tcp&#34;</span><span class="op" id="6884999">,</span>&nbsp;<span class="ident" id="6885001">ts</span><span class="op" id="6885003">.</span><span class="ident" id="6885004">Listener</span><span class="op" id="6885012">.</span><span class="ident" id="6885013">Addr</span><span class="op" id="6885017">(</span><span class="op" id="6885018">)</span><span class="op" id="6885019">.</span><span class="ident" id="6885020">String</span><span class="op" id="6885026">(</span><span class="op" id="6885027">)</span><span class="op" id="6885028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885031">if</span>&nbsp;<span class="ident" id="6885034">err</span>&nbsp;<span class="op" id="6885038">!=</span>&nbsp;<span class="ident" id="6885041">nil</span>&nbsp;<span class="op" id="6885045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885049">t</span><span class="op" id="6885050">.</span><span class="ident" id="6885051">Fatal</span><span class="op" id="6885056">(</span><span class="ident" id="6885057">err</span><span class="op" id="6885060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885063">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885066">req</span><span class="op" id="6885069">,</span>&nbsp;<span class="ident" id="6885071">_</span>&nbsp;<span class="op" id="6885073">:=</span>&nbsp;<span class="ident" id="6885076">http</span><span class="op" id="6885080">.</span><span class="ident" id="6885081">NewRequest</span><span class="op" id="6885091">(</span><span class="string" id="6885092">&#34;GET&#34;</span><span class="op" id="6885097">,</span>&nbsp;<span class="string" id="6885099">&#34;http://example.com/test.cgi?bigresponse=1&#34;</span><span class="op" id="6885142">,</span>&nbsp;<span class="ident" id="6885144">nil</span><span class="op" id="6885147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885150">err</span>&nbsp;<span class="op" id="6885154">=</span>&nbsp;<span class="ident" id="6885156">req</span><span class="op" id="6885159">.</span><span class="ident" id="6885160">Write</span><span class="op" id="6885165">(</span><span class="ident" id="6885166">conn</span><span class="op" id="6885170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885173">if</span>&nbsp;<span class="ident" id="6885176">err</span>&nbsp;<span class="op" id="6885180">!=</span>&nbsp;<span class="ident" id="6885183">nil</span>&nbsp;<span class="op" id="6885187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885191">t</span><span class="op" id="6885192">.</span><span class="ident" id="6885193">Fatalf</span><span class="op" id="6885199">(</span><span class="string" id="6885200">&#34;Write:&nbsp;%v&#34;</span><span class="op" id="6885211">,</span>&nbsp;<span class="ident" id="6885213">err</span><span class="op" id="6885216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885219">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885223">res</span><span class="op" id="6885226">,</span>&nbsp;<span class="ident" id="6885228">err</span>&nbsp;<span class="op" id="6885232">:=</span>&nbsp;<span class="ident" id="6885235">http</span><span class="op" id="6885239">.</span><span class="ident" id="6885240">ReadResponse</span><span class="op" id="6885252">(</span><span class="ident" id="6885253">bufio</span><span class="op" id="6885258">.</span><span class="ident" id="6885259">NewReader</span><span class="op" id="6885268">(</span><span class="ident" id="6885269">conn</span><span class="op" id="6885273">)</span><span class="op" id="6885274">,</span>&nbsp;<span class="ident" id="6885276">req</span><span class="op" id="6885279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885282">if</span>&nbsp;<span class="ident" id="6885285">err</span>&nbsp;<span class="op" id="6885289">!=</span>&nbsp;<span class="ident" id="6885292">nil</span>&nbsp;<span class="op" id="6885296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885300">t</span><span class="op" id="6885301">.</span><span class="ident" id="6885302">Fatalf</span><span class="op" id="6885308">(</span><span class="string" id="6885309">&#34;ReadResponse:&nbsp;%v&#34;</span><span class="op" id="6885327">,</span>&nbsp;<span class="ident" id="6885329">err</span><span class="op" id="6885332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885335">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885339">pidstr</span>&nbsp;<span class="op" id="6885346">:=</span>&nbsp;<span class="ident" id="6885349">res</span><span class="op" id="6885352">.</span><span class="ident" id="6885353">Header</span><span class="op" id="6885359">.</span><span class="ident" id="6885360">Get</span><span class="op" id="6885363">(</span><span class="string" id="6885364">&#34;X-CGI-Pid&#34;</span><span class="op" id="6885375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885378">if</span>&nbsp;<span class="ident" id="6885381">pidstr</span>&nbsp;<span class="op" id="6885388">==</span>&nbsp;<span class="string" id="6885391">&#34;&#34;</span>&nbsp;<span class="op" id="6885394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885398">t</span><span class="op" id="6885399">.</span><span class="ident" id="6885400">Fatalf</span><span class="op" id="6885406">(</span><span class="string" id="6885407">&#34;expected&nbsp;an&nbsp;X-CGI-Pid&nbsp;header&nbsp;in&nbsp;response&#34;</span><span class="op" id="6885449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885452">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885455">pid</span><span class="op" id="6885458">,</span>&nbsp;<span class="ident" id="6885460">err</span>&nbsp;<span class="op" id="6885464">:=</span>&nbsp;<span class="ident" id="6885467">strconv</span><span class="op" id="6885474">.</span><span class="ident" id="6885475">Atoi</span><span class="op" id="6885479">(</span><span class="ident" id="6885480">pidstr</span><span class="op" id="6885486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885489">if</span>&nbsp;<span class="ident" id="6885492">err</span>&nbsp;<span class="op" id="6885496">!=</span>&nbsp;<span class="ident" id="6885499">nil</span>&nbsp;<span class="op" id="6885503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885507">t</span><span class="op" id="6885508">.</span><span class="ident" id="6885509">Fatalf</span><span class="op" id="6885515">(</span><span class="string" id="6885516">&#34;invalid&nbsp;X-CGI-Pid&nbsp;value&#34;</span><span class="op" id="6885541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885548">var</span>&nbsp;<span class="ident" id="6885552">buf</span>&nbsp;<span class="op" id="6885556">[</span><span class="num" id="6885557">5000</span><span class="op" id="6885561">]</span><span class="builtintype" id="6885562">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885568">n</span><span class="op" id="6885569">,</span>&nbsp;<span class="ident" id="6885571">err</span>&nbsp;<span class="op" id="6885575">:=</span>&nbsp;<span class="ident" id="6885578">io</span><span class="op" id="6885580">.</span><span class="ident" id="6885581">ReadFull</span><span class="op" id="6885589">(</span><span class="ident" id="6885590">res</span><span class="op" id="6885593">.</span><span class="ident" id="6885594">Body</span><span class="op" id="6885598">,</span>&nbsp;<span class="ident" id="6885600">buf</span><span class="op" id="6885603">[</span><span class="op" id="6885604">:</span><span class="op" id="6885605">]</span><span class="op" id="6885606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885609">if</span>&nbsp;<span class="ident" id="6885612">err</span>&nbsp;<span class="op" id="6885616">!=</span>&nbsp;<span class="ident" id="6885619">nil</span>&nbsp;<span class="op" id="6885623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885627">t</span><span class="op" id="6885628">.</span><span class="ident" id="6885629">Fatalf</span><span class="op" id="6885635">(</span><span class="string" id="6885636">&#34;ReadFull:&nbsp;%d&nbsp;bytes,&nbsp;%v&#34;</span><span class="op" id="6885660">,</span>&nbsp;<span class="ident" id="6885662">n</span><span class="op" id="6885663">,</span>&nbsp;<span class="ident" id="6885665">err</span><span class="op" id="6885668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885671">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885675">childRunning</span>&nbsp;<span class="op" id="6885688">:=</span>&nbsp;<span class="keyword" id="6885691">func</span><span class="op" id="6885695">(</span><span class="op" id="6885696">)</span>&nbsp;<span class="builtintype" id="6885698">bool</span>&nbsp;<span class="op" id="6885703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885707">return</span>&nbsp;<span class="ident" id="6885714">isProcessRunning</span><span class="op" id="6885730">(</span><span class="ident" id="6885731">t</span><span class="op" id="6885732">,</span>&nbsp;<span class="ident" id="6885734">pid</span><span class="op" id="6885737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885744">if</span>&nbsp;<span class="op" id="6885747">!</span><span class="ident" id="6885748">childRunning</span><span class="op" id="6885760">(</span><span class="op" id="6885761">)</span>&nbsp;<span class="op" id="6885763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885767">t</span><span class="op" id="6885768">.</span><span class="ident" id="6885769">Fatalf</span><span class="op" id="6885775">(</span><span class="string" id="6885776">&#34;pre-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;running&#34;</span><span class="op" id="6885822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885828">conn</span><span class="op" id="6885832">.</span><span class="ident" id="6885833">Close</span><span class="op" id="6885838">(</span><span class="op" id="6885839">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885843">tries</span>&nbsp;<span class="op" id="6885849">:=</span>&nbsp;<span class="num" id="6885852">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885855">for</span>&nbsp;<span class="ident" id="6885859">tries</span>&nbsp;<span class="op" id="6885865">&lt;</span>&nbsp;<span class="num" id="6885867">25</span>&nbsp;<span class="op" id="6885870">&amp;&amp;</span>&nbsp;<span class="ident" id="6885873">childRunning</span><span class="op" id="6885885">(</span><span class="op" id="6885886">)</span>&nbsp;<span class="op" id="6885888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885892">time</span><span class="op" id="6885896">.</span><span class="ident" id="6885897">Sleep</span><span class="op" id="6885902">(</span><span class="num" id="6885903">50</span>&nbsp;<span class="op" id="6885906">*</span>&nbsp;<span class="ident" id="6885908">time</span><span class="op" id="6885912">.</span><span class="ident" id="6885913">Millisecond</span>&nbsp;<span class="op" id="6885925">*</span>&nbsp;<span class="ident" id="6885927">time</span><span class="op" id="6885931">.</span><span class="ident" id="6885932">Duration</span><span class="op" id="6885940">(</span><span class="ident" id="6885941">tries</span><span class="op" id="6885946">)</span><span class="op" id="6885947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885951">tries</span><span class="op" id="6885956">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885960">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885963">if</span>&nbsp;<span class="ident" id="6885966">childRunning</span><span class="op" id="6885978">(</span><span class="op" id="6885979">)</span>&nbsp;<span class="op" id="6885981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885985">t</span><span class="op" id="6885986">.</span><span class="ident" id="6885987">Fatalf</span><span class="op" id="6885993">(</span><span class="string" id="6885994">&#34;post-conn.Close,&nbsp;expected&nbsp;child&nbsp;to&nbsp;be&nbsp;gone&#34;</span><span class="op" id="6886038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6886041">}</span><br>
<span class="lineno"></span><span class="op" id="6886043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="keyword" id="6886046">func</span>&nbsp;<span class="ident" id="6886051">TestDirUnix</span><span class="op" id="6886062">(</span><span class="ident" id="6886063">t</span>&nbsp;<span class="op" id="6886065">*</span><span class="ident" id="6886066">testing</span><span class="op" id="6886073">.</span><span class="ident" id="6886074">T</span><span class="op" id="6886075">)</span>&nbsp;<span class="op" id="6886077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886080">check</span><span class="op" id="6886085">(</span><span class="ident" id="6886086">t</span><span class="op" id="6886087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886090">if</span>&nbsp;<span class="ident" id="6886093">runtime</span><span class="op" id="6886100">.</span><span class="ident" id="6886101">GOOS</span>&nbsp;<span class="op" id="6886106">==</span>&nbsp;<span class="string" id="6886109">&#34;windows&#34;</span>&nbsp;<span class="op" id="6886119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886123">t</span><span class="op" id="6886124">.</span><span class="ident" id="6886125">Skipf</span><span class="op" id="6886130">(</span><span class="string" id="6886131">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="6886152">,</span>&nbsp;<span class="ident" id="6886154">runtime</span><span class="op" id="6886161">.</span><span class="ident" id="6886162">GOOS</span><span class="op" id="6886166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6886169">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886172">cwd</span><span class="op" id="6886175">,</span>&nbsp;<span class="ident" id="6886177">_</span>&nbsp;<span class="op" id="6886179">:=</span>&nbsp;<span class="ident" id="6886182">os</span><span class="op" id="6886184">.</span><span class="ident" id="6886185">Getwd</span><span class="op" id="6886190">(</span><span class="op" id="6886191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886194">h</span>&nbsp;<span class="op" id="6886196">:=</span>&nbsp;<span class="op" id="6886199">&amp;</span><span class="ident" id="6886200">Handler</span><span class="op" id="6886207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886211">Path</span><span class="op" id="6886215">:</span>&nbsp;<span class="string" id="6886217">&#34;testdata/test.cgi&#34;</span><span class="op" id="6886236">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886240">Root</span><span class="op" id="6886244">:</span>&nbsp;<span class="string" id="6886246">&#34;/test.cgi&#34;</span><span class="op" id="6886257">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886261">Dir</span><span class="op" id="6886264">:</span>&nbsp;&nbsp;<span class="ident" id="6886267">cwd</span><span class="op" id="6886270">,</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6886273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886276">expectedMap</span>&nbsp;<span class="op" id="6886288">:=</span>&nbsp;<span class="keyword" id="6886291">map</span><span class="op" id="6886294">[</span><span class="builtintype" id="6886295">string</span><span class="op" id="6886301">]</span><span class="builtintype" id="6886302">string</span><span class="op" id="6886308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6886312">&#34;cwd&#34;</span><span class="op" id="6886317">:</span>&nbsp;<span class="ident" id="6886319">cwd</span><span class="op" id="6886322">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6886325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886328">runCgiTest</span><span class="op" id="6886338">(</span><span class="ident" id="6886339">t</span><span class="op" id="6886340">,</span>&nbsp;<span class="ident" id="6886342">h</span><span class="op" id="6886343">,</span>&nbsp;<span class="string" id="6886345">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6886392">,</span>&nbsp;<span class="ident" id="6886394">expectedMap</span><span class="op" id="6886405">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886409">cwd</span><span class="op" id="6886412">,</span>&nbsp;<span class="ident" id="6886414">_</span>&nbsp;<span class="op" id="6886416">=</span>&nbsp;<span class="ident" id="6886418">os</span><span class="op" id="6886420">.</span><span class="ident" id="6886421">Getwd</span><span class="op" id="6886426">(</span><span class="op" id="6886427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886430">cwd</span>&nbsp;<span class="op" id="6886434">=</span>&nbsp;<span class="ident" id="6886436">filepath</span><span class="op" id="6886444">.</span><span class="ident" id="6886445">Join</span><span class="op" id="6886449">(</span><span class="ident" id="6886450">cwd</span><span class="op" id="6886453">,</span>&nbsp;<span class="string" id="6886455">&#34;testdata&#34;</span><span class="op" id="6886465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886468">h</span>&nbsp;<span class="op" id="6886470">=</span>&nbsp;<span class="op" id="6886472">&amp;</span><span class="ident" id="6886473">Handler</span><span class="op" id="6886480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886484">Path</span><span class="op" id="6886488">:</span>&nbsp;<span class="string" id="6886490">&#34;testdata/test.cgi&#34;</span><span class="op" id="6886509">,</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886513">Root</span><span class="op" id="6886517">:</span>&nbsp;<span class="string" id="6886519">&#34;/test.cgi&#34;</span><span class="op" id="6886530">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6886533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886536">expectedMap</span>&nbsp;<span class="op" id="6886548">=</span>&nbsp;<span class="keyword" id="6886550">map</span><span class="op" id="6886553">[</span><span class="builtintype" id="6886554">string</span><span class="op" id="6886560">]</span><span class="builtintype" id="6886561">string</span><span class="op" id="6886567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6886571">&#34;cwd&#34;</span><span class="op" id="6886576">:</span>&nbsp;<span class="ident" id="6886578">cwd</span><span class="op" id="6886581">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6886584">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886587">runCgiTest</span><span class="op" id="6886597">(</span><span class="ident" id="6886598">t</span><span class="op" id="6886599">,</span>&nbsp;<span class="ident" id="6886601">h</span><span class="op" id="6886602">,</span>&nbsp;<span class="string" id="6886604">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6886651">,</span>&nbsp;<span class="ident" id="6886653">expectedMap</span><span class="op" id="6886664">)</span><br>
<span class="lineno"></span><span class="op" id="6886666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6886669">func</span>&nbsp;<span class="ident" id="6886674">TestDirWindows</span><span class="op" id="6886688">(</span><span class="ident" id="6886689">t</span>&nbsp;<span class="op" id="6886691">*</span><span class="ident" id="6886692">testing</span><span class="op" id="6886699">.</span><span class="ident" id="6886700">T</span><span class="op" id="6886701">)</span>&nbsp;<span class="op" id="6886703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886706">if</span>&nbsp;<span class="ident" id="6886709">runtime</span><span class="op" id="6886716">.</span><span class="ident" id="6886717">GOOS</span>&nbsp;<span class="op" id="6886722">!=</span>&nbsp;<span class="string" id="6886725">&#34;windows&#34;</span>&nbsp;<span class="op" id="6886735">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886739">t</span><span class="op" id="6886740">.</span><span class="ident" id="6886741">Skip</span><span class="op" id="6886745">(</span><span class="string" id="6886746">&#34;Skipping&nbsp;windows&nbsp;specific&nbsp;test.&#34;</span><span class="op" id="6886779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6886782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886786">cgifile</span><span class="op" id="6886793">,</span>&nbsp;<span class="ident" id="6886795">_</span>&nbsp;<span class="op" id="6886797">:=</span>&nbsp;<span class="ident" id="6886800">filepath</span><span class="op" id="6886808">.</span><span class="ident" id="6886809">Abs</span><span class="op" id="6886812">(</span><span class="string" id="6886813">&#34;testdata/test.cgi&#34;</span><span class="op" id="6886832">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886836">var</span>&nbsp;<span class="ident" id="6886840">perl</span>&nbsp;<span class="builtintype" id="6886845">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886853">var</span>&nbsp;<span class="ident" id="6886857">err</span>&nbsp;<span class="builtintype" id="6886861">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886868">perl</span><span class="op" id="6886872">,</span>&nbsp;<span class="ident" id="6886874">err</span>&nbsp;<span class="op" id="6886878">=</span>&nbsp;<span class="ident" id="6886880">exec</span><span class="op" id="6886884">.</span><span class="ident" id="6886885">LookPath</span><span class="op" id="6886893">(</span><span class="string" id="6886894">&#34;perl&#34;</span><span class="op" id="6886900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886903">if</span>&nbsp;<span class="ident" id="6886906">err</span>&nbsp;<span class="op" id="6886910">!=</span>&nbsp;<span class="ident" id="6886913">nil</span>&nbsp;<span class="op" id="6886917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886921">t</span><span class="op" id="6886922">.</span><span class="ident" id="6886923">Skip</span><span class="op" id="6886927">(</span><span class="string" id="6886928">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="6886960">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6886963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886966">perl</span><span class="op" id="6886970">,</span>&nbsp;<span class="ident" id="6886972">_</span>&nbsp;<span class="op" id="6886974">=</span>&nbsp;<span class="ident" id="6886976">filepath</span><span class="op" id="6886984">.</span><span class="ident" id="6886985">Abs</span><span class="op" id="6886988">(</span><span class="ident" id="6886989">perl</span><span class="op" id="6886993">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6886997">cwd</span><span class="op" id="6887000">,</span>&nbsp;<span class="ident" id="6887002">_</span>&nbsp;<span class="op" id="6887004">:=</span>&nbsp;<span class="ident" id="6887007">os</span><span class="op" id="6887009">.</span><span class="ident" id="6887010">Getwd</span><span class="op" id="6887015">(</span><span class="op" id="6887016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887019">h</span>&nbsp;<span class="op" id="6887021">:=</span>&nbsp;<span class="op" id="6887024">&amp;</span><span class="ident" id="6887025">Handler</span><span class="op" id="6887032">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887036">Path</span><span class="op" id="6887040">:</span>&nbsp;<span class="ident" id="6887042">perl</span><span class="op" id="6887046">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887050">Root</span><span class="op" id="6887054">:</span>&nbsp;<span class="string" id="6887056">&#34;/test.cgi&#34;</span><span class="op" id="6887067">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887071">Dir</span><span class="op" id="6887074">:</span>&nbsp;&nbsp;<span class="ident" id="6887077">cwd</span><span class="op" id="6887080">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887084">Args</span><span class="op" id="6887088">:</span>&nbsp;<span class="op" id="6887090">[</span><span class="op" id="6887091">]</span><span class="builtintype" id="6887092">string</span><span class="op" id="6887098">{</span><span class="ident" id="6887099">cgifile</span><span class="op" id="6887106">}</span><span class="op" id="6887107">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887111">Env</span><span class="op" id="6887114">:</span>&nbsp;&nbsp;<span class="op" id="6887117">[</span><span class="op" id="6887118">]</span><span class="builtintype" id="6887119">string</span><span class="op" id="6887125">{</span><span class="string" id="6887126">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="6887145">+</span>&nbsp;<span class="ident" id="6887147">cgifile</span><span class="op" id="6887154">}</span><span class="op" id="6887155">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6887158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887161">expectedMap</span>&nbsp;<span class="op" id="6887173">:=</span>&nbsp;<span class="keyword" id="6887176">map</span><span class="op" id="6887179">[</span><span class="builtintype" id="6887180">string</span><span class="op" id="6887186">]</span><span class="builtintype" id="6887187">string</span><span class="op" id="6887193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6887197">&#34;cwd&#34;</span><span class="op" id="6887202">:</span>&nbsp;<span class="ident" id="6887204">cwd</span><span class="op" id="6887207">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6887210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887213">runCgiTest</span><span class="op" id="6887223">(</span><span class="ident" id="6887224">t</span><span class="op" id="6887225">,</span>&nbsp;<span class="ident" id="6887227">h</span><span class="op" id="6887228">,</span>&nbsp;<span class="string" id="6887230">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6887277">,</span>&nbsp;<span class="ident" id="6887279">expectedMap</span><span class="op" id="6887290">)</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6887294">//&nbsp;If&nbsp;not&nbsp;specify&nbsp;Dir&nbsp;on&nbsp;windows,&nbsp;working&nbsp;directory&nbsp;should&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6887357">//&nbsp;base&nbsp;directory&nbsp;of&nbsp;perl.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887385">cwd</span><span class="op" id="6887388">,</span>&nbsp;<span class="ident" id="6887390">_</span>&nbsp;<span class="op" id="6887392">=</span>&nbsp;<span class="ident" id="6887394">filepath</span><span class="op" id="6887402">.</span><span class="ident" id="6887403">Split</span><span class="op" id="6887408">(</span><span class="ident" id="6887409">perl</span><span class="op" id="6887413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887416">if</span>&nbsp;<span class="ident" id="6887419">cwd</span>&nbsp;<span class="op" id="6887423">!=</span>&nbsp;<span class="string" id="6887426">&#34;&#34;</span>&nbsp;<span class="op" id="6887429">&amp;&amp;</span>&nbsp;<span class="ident" id="6887432">cwd</span><span class="op" id="6887435">[</span><span class="builtinfunc" id="6887436">len</span><span class="op" id="6887439">(</span><span class="ident" id="6887440">cwd</span><span class="op" id="6887443">)</span><span class="op" id="6887444">-</span><span class="num" id="6887445">1</span><span class="op" id="6887446">]</span>&nbsp;<span class="op" id="6887448">==</span>&nbsp;<span class="ident" id="6887451">filepath</span><span class="op" id="6887459">.</span><span class="ident" id="6887460">Separator</span>&nbsp;<span class="op" id="6887470">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887474">cwd</span>&nbsp;<span class="op" id="6887478">=</span>&nbsp;<span class="ident" id="6887480">cwd</span><span class="op" id="6887483">[</span><span class="op" id="6887484">:</span><span class="builtinfunc" id="6887485">len</span><span class="op" id="6887488">(</span><span class="ident" id="6887489">cwd</span><span class="op" id="6887492">)</span><span class="op" id="6887493">-</span><span class="num" id="6887494">1</span><span class="op" id="6887495">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6887498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887501">h</span>&nbsp;<span class="op" id="6887503">=</span>&nbsp;<span class="op" id="6887505">&amp;</span><span class="ident" id="6887506">Handler</span><span class="op" id="6887513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887517">Path</span><span class="op" id="6887521">:</span>&nbsp;<span class="ident" id="6887523">perl</span><span class="op" id="6887527">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887531">Root</span><span class="op" id="6887535">:</span>&nbsp;<span class="string" id="6887537">&#34;/test.cgi&#34;</span><span class="op" id="6887548">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887552">Args</span><span class="op" id="6887556">:</span>&nbsp;<span class="op" id="6887558">[</span><span class="op" id="6887559">]</span><span class="builtintype" id="6887560">string</span><span class="op" id="6887566">{</span><span class="ident" id="6887567">cgifile</span><span class="op" id="6887574">}</span><span class="op" id="6887575">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887579">Env</span><span class="op" id="6887582">:</span>&nbsp;&nbsp;<span class="op" id="6887585">[</span><span class="op" id="6887586">]</span><span class="builtintype" id="6887587">string</span><span class="op" id="6887593">{</span><span class="string" id="6887594">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="6887613">+</span>&nbsp;<span class="ident" id="6887615">cgifile</span><span class="op" id="6887622">}</span><span class="op" id="6887623">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6887626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887629">expectedMap</span>&nbsp;<span class="op" id="6887641">=</span>&nbsp;<span class="keyword" id="6887643">map</span><span class="op" id="6887646">[</span><span class="builtintype" id="6887647">string</span><span class="op" id="6887653">]</span><span class="builtintype" id="6887654">string</span><span class="op" id="6887660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6887664">&#34;cwd&#34;</span><span class="op" id="6887669">:</span>&nbsp;<span class="ident" id="6887671">cwd</span><span class="op" id="6887674">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6887677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887680">runCgiTest</span><span class="op" id="6887690">(</span><span class="ident" id="6887691">t</span><span class="op" id="6887692">,</span>&nbsp;<span class="ident" id="6887694">h</span><span class="op" id="6887695">,</span>&nbsp;<span class="string" id="6887697">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6887744">,</span>&nbsp;<span class="ident" id="6887746">expectedMap</span><span class="op" id="6887757">)</span><br>
<span class="lineno"></span><span class="op" id="6887759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6887762">func</span>&nbsp;<span class="ident" id="6887767">TestEnvOverride</span><span class="op" id="6887782">(</span><span class="ident" id="6887783">t</span>&nbsp;<span class="op" id="6887785">*</span><span class="ident" id="6887786">testing</span><span class="op" id="6887793">.</span><span class="ident" id="6887794">T</span><span class="op" id="6887795">)</span>&nbsp;<span class="op" id="6887797">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887800">cgifile</span><span class="op" id="6887807">,</span>&nbsp;<span class="ident" id="6887809">_</span>&nbsp;<span class="op" id="6887811">:=</span>&nbsp;<span class="ident" id="6887814">filepath</span><span class="op" id="6887822">.</span><span class="ident" id="6887823">Abs</span><span class="op" id="6887826">(</span><span class="string" id="6887827">&#34;testdata/test.cgi&#34;</span><span class="op" id="6887846">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887850">var</span>&nbsp;<span class="ident" id="6887854">perl</span>&nbsp;<span class="builtintype" id="6887859">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887867">var</span>&nbsp;<span class="ident" id="6887871">err</span>&nbsp;<span class="builtintype" id="6887875">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887882">perl</span><span class="op" id="6887886">,</span>&nbsp;<span class="ident" id="6887888">err</span>&nbsp;<span class="op" id="6887892">=</span>&nbsp;<span class="ident" id="6887894">exec</span><span class="op" id="6887898">.</span><span class="ident" id="6887899">LookPath</span><span class="op" id="6887907">(</span><span class="string" id="6887908">&#34;perl&#34;</span><span class="op" id="6887914">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887917">if</span>&nbsp;<span class="ident" id="6887920">err</span>&nbsp;<span class="op" id="6887924">!=</span>&nbsp;<span class="ident" id="6887927">nil</span>&nbsp;<span class="op" id="6887931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887935">t</span><span class="op" id="6887936">.</span><span class="ident" id="6887937">Skipf</span><span class="op" id="6887942">(</span><span class="string" id="6887943">&#34;Skipping&nbsp;test:&nbsp;perl&nbsp;not&nbsp;found.&#34;</span><span class="op" id="6887975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6887978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6887981">perl</span><span class="op" id="6887985">,</span>&nbsp;<span class="ident" id="6887987">_</span>&nbsp;<span class="op" id="6887989">=</span>&nbsp;<span class="ident" id="6887991">filepath</span><span class="op" id="6887999">.</span><span class="ident" id="6888000">Abs</span><span class="op" id="6888003">(</span><span class="ident" id="6888004">perl</span><span class="op" id="6888008">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888012">cwd</span><span class="op" id="6888015">,</span>&nbsp;<span class="ident" id="6888017">_</span>&nbsp;<span class="op" id="6888019">:=</span>&nbsp;<span class="ident" id="6888022">os</span><span class="op" id="6888024">.</span><span class="ident" id="6888025">Getwd</span><span class="op" id="6888030">(</span><span class="op" id="6888031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888034">h</span>&nbsp;<span class="op" id="6888036">:=</span>&nbsp;<span class="op" id="6888039">&amp;</span><span class="ident" id="6888040">Handler</span><span class="op" id="6888047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888051">Path</span><span class="op" id="6888055">:</span>&nbsp;<span class="ident" id="6888057">perl</span><span class="op" id="6888061">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888065">Root</span><span class="op" id="6888069">:</span>&nbsp;<span class="string" id="6888071">&#34;/test.cgi&#34;</span><span class="op" id="6888082">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888086">Dir</span><span class="op" id="6888089">:</span>&nbsp;&nbsp;<span class="ident" id="6888092">cwd</span><span class="op" id="6888095">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888099">Args</span><span class="op" id="6888103">:</span>&nbsp;<span class="op" id="6888105">[</span><span class="op" id="6888106">]</span><span class="builtintype" id="6888107">string</span><span class="op" id="6888113">{</span><span class="ident" id="6888114">cgifile</span><span class="op" id="6888121">}</span><span class="op" id="6888122">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888126">Env</span><span class="op" id="6888129">:</span>&nbsp;<span class="op" id="6888131">[</span><span class="op" id="6888132">]</span><span class="builtintype" id="6888133">string</span><span class="op" id="6888139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6888144">&#34;SCRIPT_FILENAME=&#34;</span>&nbsp;<span class="op" id="6888163">+</span>&nbsp;<span class="ident" id="6888165">cgifile</span><span class="op" id="6888172">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6888177">&#34;REQUEST_URI=/foo/bar&#34;</span><span class="op" id="6888199">}</span><span class="op" id="6888200">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6888203">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888206">expectedMap</span>&nbsp;<span class="op" id="6888218">:=</span>&nbsp;<span class="keyword" id="6888221">map</span><span class="op" id="6888224">[</span><span class="builtintype" id="6888225">string</span><span class="op" id="6888231">]</span><span class="builtintype" id="6888232">string</span><span class="op" id="6888238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6888242">&#34;cwd&#34;</span><span class="op" id="6888247">:</span>&nbsp;<span class="ident" id="6888249">cwd</span><span class="op" id="6888252">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6888256">&#34;env-SCRIPT_FILENAME&#34;</span><span class="op" id="6888277">:</span>&nbsp;<span class="ident" id="6888279">cgifile</span><span class="op" id="6888286">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6888290">&#34;env-REQUEST_URI&#34;</span><span class="op" id="6888307">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6888313">&#34;/foo/bar&#34;</span><span class="op" id="6888323">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6888326">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6888329">runCgiTest</span><span class="op" id="6888339">(</span><span class="ident" id="6888340">t</span><span class="op" id="6888341">,</span>&nbsp;<span class="ident" id="6888343">h</span><span class="op" id="6888344">,</span>&nbsp;<span class="string" id="6888346">&#34;GET&nbsp;/test.cgi&nbsp;HTTP/1.0\nHost:&nbsp;example.com\n\n&#34;</span><span class="op" id="6888393">,</span>&nbsp;<span class="ident" id="6888395">expectedMap</span><span class="op" id="6888406">)</span><br>
<span class="lineno"></span><span class="op" id="6888408">}</span>
</div>
</body>
</html>
