<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html" class="current">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7481725">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7481780">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7481834">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7481885">package</span>&nbsp;<span class="ident" id="7481893">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7481898">import</span>&nbsp;<span class="op" id="7481905">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7481908">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7481917">&#34;flag&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7481925">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7481932">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7481938">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7481944">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7481955">&#34;reflect&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7481966">&#34;regexp&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7481976">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7481987">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7481998">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7482006">&#34;testing&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7482017">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7482024">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7482027">func</span>&nbsp;<span class="ident" id="7482032">newLocalListener</span><span class="op" id="7482048">(</span><span class="ident" id="7482049">t</span>&nbsp;<span class="op" id="7482051">*</span><span class="ident" id="7482052">testing</span><span class="op" id="7482059">.</span><span class="ident" id="7482060">T</span><span class="op" id="7482061">)</span>&nbsp;<span class="ident" id="7482063">Listener</span>&nbsp;<span class="op" id="7482072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7482075">ln</span><span class="op" id="7482077">,</span>&nbsp;<span class="ident" id="7482079">err</span>&nbsp;<span class="op" id="7482083">:=</span>&nbsp;<span class="ident" id="7482086">Listen</span><span class="op" id="7482092">(</span><span class="string" id="7482093">&#34;tcp&#34;</span><span class="op" id="7482098">,</span>&nbsp;<span class="string" id="7482100">&#34;127.0.0.1:0&#34;</span><span class="op" id="7482113">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7482116">if</span>&nbsp;<span class="ident" id="7482119">err</span>&nbsp;<span class="op" id="7482123">!=</span>&nbsp;<span class="ident" id="7482126">nil</span>&nbsp;<span class="op" id="7482130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7482134">ln</span><span class="op" id="7482136">,</span>&nbsp;<span class="ident" id="7482138">err</span>&nbsp;<span class="op" id="7482142">=</span>&nbsp;<span class="ident" id="7482144">Listen</span><span class="op" id="7482150">(</span><span class="string" id="7482151">&#34;tcp6&#34;</span><span class="op" id="7482157">,</span>&nbsp;<span class="string" id="7482159">&#34;[::1]:0&#34;</span><span class="op" id="7482168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7482171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7482174">if</span>&nbsp;<span class="ident" id="7482177">err</span>&nbsp;<span class="op" id="7482181">!=</span>&nbsp;<span class="ident" id="7482184">nil</span>&nbsp;<span class="op" id="7482188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7482192">t</span><span class="op" id="7482193">.</span><span class="ident" id="7482194">Fatal</span><span class="op" id="7482199">(</span><span class="ident" id="7482200">err</span><span class="op" id="7482203">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7482206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7482209">return</span>&nbsp;<span class="ident" id="7482216">ln</span><br>
<span class="lineno"></span><span class="op" id="7482219">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7482222">func</span>&nbsp;<span class="ident" id="7482227">TestDialTimeout</span><span class="op" id="7482242">(</span><span class="ident" id="7482243">t</span>&nbsp;<span class="op" id="7482245">*</span><span class="ident" id="7482246">testing</span><span class="op" id="7482253">.</span><span class="ident" id="7482254">T</span><span class="op" id="7482255">)</span>&nbsp;<span class="op" id="7482257">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7482260">origBacklog</span>&nbsp;<span class="op" id="7482272">:=</span>&nbsp;<span class="ident" id="7482275">listenerBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7482292">defer</span>&nbsp;<span class="keyword" id="7482298">func</span><span class="op" id="7482302">(</span><span class="op" id="7482303">)</span>&nbsp;<span class="op" id="7482305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7482309">listenerBacklog</span>&nbsp;<span class="op" id="7482325">=</span>&nbsp;<span class="ident" id="7482327">origBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7482340">}</span><span class="op" id="7482341">(</span><span class="op" id="7482342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7482345">listenerBacklog</span>&nbsp;<span class="op" id="7482361">=</span>&nbsp;<span class="num" id="7482363">1</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7482367">ln</span>&nbsp;<span class="op" id="7482370">:=</span>&nbsp;<span class="ident" id="7482373">newLocalListener</span><span class="op" id="7482389">(</span><span class="ident" id="7482390">t</span><span class="op" id="7482391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7482394">defer</span>&nbsp;<span class="ident" id="7482400">ln</span><span class="op" id="7482402">.</span><span class="ident" id="7482403">Close</span><span class="op" id="7482408">(</span><span class="op" id="7482409">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7482413">errc</span>&nbsp;<span class="op" id="7482418">:=</span>&nbsp;<span class="builtinfunc" id="7482421">make</span><span class="op" id="7482425">(</span><span class="keyword" id="7482426">chan</span>&nbsp;<span class="builtintype" id="7482431">error</span><span class="op" id="7482436">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7482440">numConns</span>&nbsp;<span class="op" id="7482449">:=</span>&nbsp;<span class="ident" id="7482452">listenerBacklog</span>&nbsp;<span class="op" id="7482468">+</span>&nbsp;<span class="num" id="7482470">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7482476">//&nbsp;TODO(bradfitz):&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;test&nbsp;this&nbsp;in&nbsp;a&nbsp;portable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7482533">//&nbsp;way.&nbsp;This&nbsp;is&nbsp;unfortunate,&nbsp;but&nbsp;works&nbsp;for&nbsp;now.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7482582">switch</span>&nbsp;<span class="ident" id="7482589">runtime</span><span class="op" id="7482596">.</span><span class="ident" id="7482597">GOOS</span>&nbsp;<span class="op" id="7482602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7482605">case</span>&nbsp;<span class="string" id="7482610">&#34;linux&#34;</span><span class="op" id="7482617">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7482621">//&nbsp;The&nbsp;kernel&nbsp;will&nbsp;start&nbsp;accepting&nbsp;TCP&nbsp;connections&nbsp;before&nbsp;userspace</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7482691">//&nbsp;gets&nbsp;a&nbsp;chance&nbsp;to&nbsp;not&nbsp;accept&nbsp;them,&nbsp;so&nbsp;fire&nbsp;off&nbsp;a&nbsp;bunch&nbsp;to&nbsp;fill&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7482761">//&nbsp;the&nbsp;kernel&#39;s&nbsp;backlog.&nbsp;&nbsp;Then&nbsp;we&nbsp;test&nbsp;we&nbsp;get&nbsp;a&nbsp;failure&nbsp;after&nbsp;that.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7482831">for</span>&nbsp;<span class="ident" id="7482835">i</span>&nbsp;<span class="op" id="7482837">:=</span>&nbsp;<span class="num" id="7482840">0</span><span class="op" id="7482841">;</span>&nbsp;<span class="ident" id="7482843">i</span>&nbsp;<span class="op" id="7482845">&lt;</span>&nbsp;<span class="ident" id="7482847">numConns</span><span class="op" id="7482855">;</span>&nbsp;<span class="ident" id="7482857">i</span><span class="op" id="7482858">++</span>&nbsp;<span class="op" id="7482861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7482866">go</span>&nbsp;<span class="keyword" id="7482869">func</span><span class="op" id="7482873">(</span><span class="op" id="7482874">)</span>&nbsp;<span class="op" id="7482876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7482882">_</span><span class="op" id="7482883">,</span>&nbsp;<span class="ident" id="7482885">err</span>&nbsp;<span class="op" id="7482889">:=</span>&nbsp;<span class="ident" id="7482892">DialTimeout</span><span class="op" id="7482903">(</span><span class="string" id="7482904">&#34;tcp&#34;</span><span class="op" id="7482909">,</span>&nbsp;<span class="ident" id="7482911">ln</span><span class="op" id="7482913">.</span><span class="ident" id="7482914">Addr</span><span class="op" id="7482918">(</span><span class="op" id="7482919">)</span><span class="op" id="7482920">.</span><span class="ident" id="7482921">String</span><span class="op" id="7482927">(</span><span class="op" id="7482928">)</span><span class="op" id="7482929">,</span>&nbsp;<span class="num" id="7482931">200</span><span class="op" id="7482934">*</span><span class="ident" id="7482935">time</span><span class="op" id="7482939">.</span><span class="ident" id="7482940">Millisecond</span><span class="op" id="7482951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7482957">errc</span>&nbsp;<span class="op" id="7482962">&lt;-</span>&nbsp;<span class="ident" id="7482965">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7482972">}</span><span class="op" id="7482973">(</span><span class="op" id="7482974">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7482978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7482981">case</span>&nbsp;<span class="string" id="7482986">&#34;darwin&#34;</span><span class="op" id="7482994">,</span>&nbsp;<span class="string" id="7482996">&#34;plan9&#34;</span><span class="op" id="7483003">,</span>&nbsp;<span class="string" id="7483005">&#34;windows&#34;</span><span class="op" id="7483014">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7483018">//&nbsp;At&nbsp;least&nbsp;OS&nbsp;X&nbsp;10.7&nbsp;seems&nbsp;to&nbsp;accept&nbsp;any&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7483072">//&nbsp;connections,&nbsp;ignoring&nbsp;listen&#39;s&nbsp;backlog,&nbsp;so&nbsp;resort</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7483127">//&nbsp;to&nbsp;connecting&nbsp;to&nbsp;a&nbsp;hopefully-dead&nbsp;127/8&nbsp;address.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7483181">//&nbsp;Same&nbsp;for&nbsp;windows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7483204">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7483209">//&nbsp;Use&nbsp;an&nbsp;IANA&nbsp;reserved&nbsp;port&nbsp;(49151)&nbsp;instead&nbsp;of&nbsp;80,&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7483271">//&nbsp;on&nbsp;our&nbsp;386&nbsp;builder,&nbsp;this&nbsp;Dial&nbsp;succeeds,&nbsp;connecting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7483327">//&nbsp;to&nbsp;an&nbsp;IIS&nbsp;web&nbsp;server&nbsp;somewhere.&nbsp;&nbsp;The&nbsp;data&nbsp;center</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7483381">//&nbsp;or&nbsp;VM&nbsp;or&nbsp;firewall&nbsp;must&nbsp;be&nbsp;stealing&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7483441">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7483446">//&nbsp;IANA&nbsp;Service&nbsp;Name&nbsp;and&nbsp;Transport&nbsp;Protocol&nbsp;Port&nbsp;Number&nbsp;Registry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7483513">//&nbsp;&lt;http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xml&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7483610">go</span>&nbsp;<span class="keyword" id="7483613">func</span><span class="op" id="7483617">(</span><span class="op" id="7483618">)</span>&nbsp;<span class="op" id="7483620">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7483625">c</span><span class="op" id="7483626">,</span>&nbsp;<span class="ident" id="7483628">err</span>&nbsp;<span class="op" id="7483632">:=</span>&nbsp;<span class="ident" id="7483635">DialTimeout</span><span class="op" id="7483646">(</span><span class="string" id="7483647">&#34;tcp&#34;</span><span class="op" id="7483652">,</span>&nbsp;<span class="string" id="7483654">&#34;127.0.71.111:49151&#34;</span><span class="op" id="7483674">,</span>&nbsp;<span class="num" id="7483676">200</span><span class="op" id="7483679">*</span><span class="ident" id="7483680">time</span><span class="op" id="7483684">.</span><span class="ident" id="7483685">Millisecond</span><span class="op" id="7483696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7483701">if</span>&nbsp;<span class="ident" id="7483704">err</span>&nbsp;<span class="op" id="7483708">==</span>&nbsp;<span class="ident" id="7483711">nil</span>&nbsp;<span class="op" id="7483715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7483721">err</span>&nbsp;<span class="op" id="7483725">=</span>&nbsp;<span class="ident" id="7483727">fmt</span><span class="op" id="7483730">.</span><span class="ident" id="7483731">Errorf</span><span class="op" id="7483737">(</span><span class="string" id="7483738">&#34;unexpected:&nbsp;connected&nbsp;to&nbsp;%s!&#34;</span><span class="op" id="7483768">,</span>&nbsp;<span class="ident" id="7483770">c</span><span class="op" id="7483771">.</span><span class="ident" id="7483772">RemoteAddr</span><span class="op" id="7483782">(</span><span class="op" id="7483783">)</span><span class="op" id="7483784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7483790">c</span><span class="op" id="7483791">.</span><span class="ident" id="7483792">Close</span><span class="op" id="7483797">(</span><span class="op" id="7483798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7483803">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7483808">errc</span>&nbsp;<span class="op" id="7483813">&lt;-</span>&nbsp;<span class="ident" id="7483816">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7483822">}</span><span class="op" id="7483823">(</span><span class="op" id="7483824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7483827">default</span><span class="op" id="7483834">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7483838">//&nbsp;TODO(bradfitz):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7483859">//&nbsp;OpenBSD&nbsp;may&nbsp;have&nbsp;a&nbsp;reject&nbsp;route&nbsp;to&nbsp;127/8&nbsp;except&nbsp;127.0.0.1/32</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7483925">//&nbsp;by&nbsp;default.&nbsp;FreeBSD&nbsp;likely&nbsp;works,&nbsp;but&nbsp;is&nbsp;untested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7483981">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7483997">//&nbsp;The&nbsp;timeout&nbsp;never&nbsp;happens&nbsp;on&nbsp;Windows.&nbsp;&nbsp;Why?&nbsp;&nbsp;Issue&nbsp;3016.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7484059">t</span><span class="op" id="7484060">.</span><span class="ident" id="7484061">Skipf</span><span class="op" id="7484066">(</span><span class="string" id="7484067">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q;&nbsp;untested.&#34;</span><span class="op" id="7484099">,</span>&nbsp;<span class="ident" id="7484101">runtime</span><span class="op" id="7484108">.</span><span class="ident" id="7484109">GOOS</span><span class="op" id="7484113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7484116">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7484120">connected</span>&nbsp;<span class="op" id="7484130">:=</span>&nbsp;<span class="num" id="7484133">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7484136">for</span>&nbsp;<span class="op" id="7484140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7484144">select</span>&nbsp;<span class="op" id="7484151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7484155">case</span>&nbsp;<span class="op" id="7484160">&lt;-</span><span class="ident" id="7484162">time</span><span class="op" id="7484166">.</span><span class="ident" id="7484167">After</span><span class="op" id="7484172">(</span><span class="num" id="7484173">15</span>&nbsp;<span class="op" id="7484176">*</span>&nbsp;<span class="ident" id="7484178">time</span><span class="op" id="7484182">.</span><span class="ident" id="7484183">Second</span><span class="op" id="7484189">)</span><span class="op" id="7484190">:</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7484195">t</span><span class="op" id="7484196">.</span><span class="ident" id="7484197">Fatal</span><span class="op" id="7484202">(</span><span class="string" id="7484203">&#34;too&nbsp;slow&#34;</span><span class="op" id="7484213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7484217">case</span>&nbsp;<span class="ident" id="7484222">err</span>&nbsp;<span class="op" id="7484226">:=</span>&nbsp;<span class="op" id="7484229">&lt;-</span><span class="ident" id="7484231">errc</span><span class="op" id="7484235">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7484240">if</span>&nbsp;<span class="ident" id="7484243">err</span>&nbsp;<span class="op" id="7484247">==</span>&nbsp;<span class="ident" id="7484250">nil</span>&nbsp;<span class="op" id="7484254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7484260">connected</span><span class="op" id="7484269">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7484276">if</span>&nbsp;<span class="ident" id="7484279">connected</span>&nbsp;<span class="op" id="7484289">==</span>&nbsp;<span class="ident" id="7484292">numConns</span>&nbsp;<span class="op" id="7484301">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7484308">t</span><span class="op" id="7484309">.</span><span class="ident" id="7484310">Fatal</span><span class="op" id="7484315">(</span><span class="string" id="7484316">&#34;all&nbsp;connections&nbsp;connected;&nbsp;expected&nbsp;some&nbsp;to&nbsp;time&nbsp;out&#34;</span><span class="op" id="7484370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7484376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7484381">}</span>&nbsp;<span class="keyword" id="7484383">else</span>&nbsp;<span class="op" id="7484388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7484394">terr</span><span class="op" id="7484398">,</span>&nbsp;<span class="ident" id="7484400">ok</span>&nbsp;<span class="op" id="7484403">:=</span>&nbsp;<span class="ident" id="7484406">err</span><span class="op" id="7484409">.</span><span class="op" id="7484410">(</span><span class="ident" id="7484411">timeout</span><span class="op" id="7484418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7484424">if</span>&nbsp;<span class="op" id="7484427">!</span><span class="ident" id="7484428">ok</span>&nbsp;<span class="op" id="7484431">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7484438">t</span><span class="op" id="7484439">.</span><span class="ident" id="7484440">Fatalf</span><span class="op" id="7484446">(</span><span class="string" id="7484447">&#34;got&nbsp;error&nbsp;%q;&nbsp;want&nbsp;error&nbsp;with&nbsp;timeout&nbsp;interface&#34;</span><span class="op" id="7484496">,</span>&nbsp;<span class="ident" id="7484498">err</span><span class="op" id="7484501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7484507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7484513">if</span>&nbsp;<span class="op" id="7484516">!</span><span class="ident" id="7484517">terr</span><span class="op" id="7484521">.</span><span class="ident" id="7484522">Timeout</span><span class="op" id="7484529">(</span><span class="op" id="7484530">)</span>&nbsp;<span class="op" id="7484532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7484539">t</span><span class="op" id="7484540">.</span><span class="ident" id="7484541">Fatalf</span><span class="op" id="7484547">(</span><span class="string" id="7484548">&#34;got&nbsp;error&nbsp;%q;&nbsp;not&nbsp;a&nbsp;timeout&#34;</span><span class="op" id="7484577">,</span>&nbsp;<span class="ident" id="7484579">err</span><span class="op" id="7484582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7484588">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7484594">//&nbsp;Pass.&nbsp;We&nbsp;saw&nbsp;a&nbsp;timeout&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7484631">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7484641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7484645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7484648">}</span><br>
<span class="lineno">115</span><span class="op" id="7484650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7484653">func</span>&nbsp;<span class="ident" id="7484658">TestSelfConnect</span><span class="op" id="7484673">(</span><span class="ident" id="7484674">t</span>&nbsp;<span class="op" id="7484676">*</span><span class="ident" id="7484677">testing</span><span class="op" id="7484684">.</span><span class="ident" id="7484685">T</span><span class="op" id="7484686">)</span>&nbsp;<span class="op" id="7484688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7484691">if</span>&nbsp;<span class="ident" id="7484694">runtime</span><span class="op" id="7484701">.</span><span class="ident" id="7484702">GOOS</span>&nbsp;<span class="op" id="7484707">==</span>&nbsp;<span class="string" id="7484710">&#34;windows&#34;</span>&nbsp;<span class="op" id="7484720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7484724">//&nbsp;TODO(brainman):&nbsp;do&nbsp;not&nbsp;know&nbsp;why&nbsp;it&nbsp;hangs.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7484771">t</span><span class="op" id="7484772">.</span><span class="ident" id="7484773">Skip</span><span class="op" id="7484777">(</span><span class="string" id="7484778">&#34;skipping&nbsp;known-broken&nbsp;test&nbsp;on&nbsp;windows&#34;</span><span class="op" id="7484817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7484820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7484824">//&nbsp;Test&nbsp;that&nbsp;Dial&nbsp;does&nbsp;not&nbsp;honor&nbsp;self-connects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7484873">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;DialTCP.</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7484906">//&nbsp;Find&nbsp;a&nbsp;port&nbsp;that&nbsp;would&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;local&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7484961">l</span><span class="op" id="7484962">,</span>&nbsp;<span class="ident" id="7484964">err</span>&nbsp;<span class="op" id="7484968">:=</span>&nbsp;<span class="ident" id="7484971">Listen</span><span class="op" id="7484977">(</span><span class="string" id="7484978">&#34;tcp&#34;</span><span class="op" id="7484983">,</span>&nbsp;<span class="string" id="7484985">&#34;127.0.0.1:0&#34;</span><span class="op" id="7484998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7485001">if</span>&nbsp;<span class="ident" id="7485004">err</span>&nbsp;<span class="op" id="7485008">!=</span>&nbsp;<span class="ident" id="7485011">nil</span>&nbsp;<span class="op" id="7485015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7485019">t</span><span class="op" id="7485020">.</span><span class="ident" id="7485021">Fatal</span><span class="op" id="7485026">(</span><span class="ident" id="7485027">err</span><span class="op" id="7485030">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7485033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7485036">c</span><span class="op" id="7485037">,</span>&nbsp;<span class="ident" id="7485039">err</span>&nbsp;<span class="op" id="7485043">:=</span>&nbsp;<span class="ident" id="7485046">Dial</span><span class="op" id="7485050">(</span><span class="string" id="7485051">&#34;tcp&#34;</span><span class="op" id="7485056">,</span>&nbsp;<span class="ident" id="7485058">l</span><span class="op" id="7485059">.</span><span class="ident" id="7485060">Addr</span><span class="op" id="7485064">(</span><span class="op" id="7485065">)</span><span class="op" id="7485066">.</span><span class="ident" id="7485067">String</span><span class="op" id="7485073">(</span><span class="op" id="7485074">)</span><span class="op" id="7485075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7485078">if</span>&nbsp;<span class="ident" id="7485081">err</span>&nbsp;<span class="op" id="7485085">!=</span>&nbsp;<span class="ident" id="7485088">nil</span>&nbsp;<span class="op" id="7485092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7485096">t</span><span class="op" id="7485097">.</span><span class="ident" id="7485098">Fatal</span><span class="op" id="7485103">(</span><span class="ident" id="7485104">err</span><span class="op" id="7485107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7485110">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7485113">addr</span>&nbsp;<span class="op" id="7485118">:=</span>&nbsp;<span class="ident" id="7485121">c</span><span class="op" id="7485122">.</span><span class="ident" id="7485123">LocalAddr</span><span class="op" id="7485132">(</span><span class="op" id="7485133">)</span><span class="op" id="7485134">.</span><span class="ident" id="7485135">String</span><span class="op" id="7485141">(</span><span class="op" id="7485142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7485145">c</span><span class="op" id="7485146">.</span><span class="ident" id="7485147">Close</span><span class="op" id="7485152">(</span><span class="op" id="7485153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7485156">l</span><span class="op" id="7485157">.</span><span class="ident" id="7485158">Close</span><span class="op" id="7485163">(</span><span class="op" id="7485164">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7485168">//&nbsp;Try&nbsp;to&nbsp;connect&nbsp;to&nbsp;that&nbsp;address&nbsp;repeatedly.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7485215">n</span>&nbsp;<span class="op" id="7485217">:=</span>&nbsp;<span class="num" id="7485220">100000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7485228">if</span>&nbsp;<span class="ident" id="7485231">testing</span><span class="op" id="7485238">.</span><span class="ident" id="7485239">Short</span><span class="op" id="7485244">(</span><span class="op" id="7485245">)</span>&nbsp;<span class="op" id="7485247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7485251">n</span>&nbsp;<span class="op" id="7485253">=</span>&nbsp;<span class="num" id="7485255">1000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7485261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7485264">switch</span>&nbsp;<span class="ident" id="7485271">runtime</span><span class="op" id="7485278">.</span><span class="ident" id="7485279">GOOS</span>&nbsp;<span class="op" id="7485284">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7485287">case</span>&nbsp;<span class="string" id="7485292">&#34;darwin&#34;</span><span class="op" id="7485300">,</span>&nbsp;<span class="string" id="7485302">&#34;dragonfly&#34;</span><span class="op" id="7485313">,</span>&nbsp;<span class="string" id="7485315">&#34;freebsd&#34;</span><span class="op" id="7485324">,</span>&nbsp;<span class="string" id="7485326">&#34;netbsd&#34;</span><span class="op" id="7485334">,</span>&nbsp;<span class="string" id="7485336">&#34;openbsd&#34;</span><span class="op" id="7485345">,</span>&nbsp;<span class="string" id="7485347">&#34;plan9&#34;</span><span class="op" id="7485354">,</span>&nbsp;<span class="string" id="7485356">&#34;solaris&#34;</span><span class="op" id="7485365">,</span>&nbsp;<span class="string" id="7485367">&#34;windows&#34;</span><span class="op" id="7485376">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7485380">//&nbsp;Non-Linux&nbsp;systems&nbsp;take&nbsp;a&nbsp;long&nbsp;time&nbsp;to&nbsp;figure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7485430">//&nbsp;out&nbsp;that&nbsp;there&nbsp;is&nbsp;nothing&nbsp;listening&nbsp;on&nbsp;localhost.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7485485">n</span>&nbsp;<span class="op" id="7485487">=</span>&nbsp;<span class="num" id="7485489">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7485494">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7485497">for</span>&nbsp;<span class="ident" id="7485501">i</span>&nbsp;<span class="op" id="7485503">:=</span>&nbsp;<span class="num" id="7485506">0</span><span class="op" id="7485507">;</span>&nbsp;<span class="ident" id="7485509">i</span>&nbsp;<span class="op" id="7485511">&lt;</span>&nbsp;<span class="ident" id="7485513">n</span><span class="op" id="7485514">;</span>&nbsp;<span class="ident" id="7485516">i</span><span class="op" id="7485517">++</span>&nbsp;<span class="op" id="7485520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7485524">c</span><span class="op" id="7485525">,</span>&nbsp;<span class="ident" id="7485527">err</span>&nbsp;<span class="op" id="7485531">:=</span>&nbsp;<span class="ident" id="7485534">DialTimeout</span><span class="op" id="7485545">(</span><span class="string" id="7485546">&#34;tcp&#34;</span><span class="op" id="7485551">,</span>&nbsp;<span class="ident" id="7485553">addr</span><span class="op" id="7485557">,</span>&nbsp;<span class="ident" id="7485559">time</span><span class="op" id="7485563">.</span><span class="ident" id="7485564">Millisecond</span><span class="op" id="7485575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7485579">if</span>&nbsp;<span class="ident" id="7485582">err</span>&nbsp;<span class="op" id="7485586">==</span>&nbsp;<span class="ident" id="7485589">nil</span>&nbsp;<span class="op" id="7485593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7485598">if</span>&nbsp;<span class="ident" id="7485601">c</span><span class="op" id="7485602">.</span><span class="ident" id="7485603">LocalAddr</span><span class="op" id="7485612">(</span><span class="op" id="7485613">)</span><span class="op" id="7485614">.</span><span class="ident" id="7485615">String</span><span class="op" id="7485621">(</span><span class="op" id="7485622">)</span>&nbsp;<span class="op" id="7485624">==</span>&nbsp;<span class="ident" id="7485627">addr</span>&nbsp;<span class="op" id="7485632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7485638">t</span><span class="op" id="7485639">.</span><span class="ident" id="7485640">Errorf</span><span class="op" id="7485646">(</span><span class="string" id="7485647">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;self-connect&#34;</span><span class="op" id="7485674">,</span>&nbsp;<span class="ident" id="7485676">i</span><span class="op" id="7485677">,</span>&nbsp;<span class="ident" id="7485679">addr</span><span class="op" id="7485683">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7485688">}</span>&nbsp;<span class="keyword" id="7485690">else</span>&nbsp;<span class="op" id="7485695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7485701">t</span><span class="op" id="7485702">.</span><span class="ident" id="7485703">Logf</span><span class="op" id="7485707">(</span><span class="string" id="7485708">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;succeeded&nbsp;-&nbsp;possibly&nbsp;racing&nbsp;with&nbsp;other&nbsp;listener&#34;</span><span class="op" id="7485770">,</span>&nbsp;<span class="ident" id="7485772">i</span><span class="op" id="7485773">,</span>&nbsp;<span class="ident" id="7485775">addr</span><span class="op" id="7485779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7485784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7485789">c</span><span class="op" id="7485790">.</span><span class="ident" id="7485791">Close</span><span class="op" id="7485796">(</span><span class="op" id="7485797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7485801">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7485804">}</span><br>
<span class="lineno"></span><span class="op" id="7485806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7485809">var</span>&nbsp;<span class="ident" id="7485813">runErrorTest</span>&nbsp;<span class="op" id="7485826">=</span>&nbsp;<span class="ident" id="7485828">flag</span><span class="op" id="7485832">.</span><span class="ident" id="7485833">Bool</span><span class="op" id="7485837">(</span><span class="string" id="7485838">&#34;run_error_test&#34;</span><span class="op" id="7485854">,</span>&nbsp;<span class="builtintype" id="7485856">false</span><span class="op" id="7485861">,</span>&nbsp;<span class="string" id="7485863">&#34;let&nbsp;TestDialError&nbsp;check&nbsp;for&nbsp;dns&nbsp;errors&#34;</span><span class="op" id="7485903">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="7485906">type</span>&nbsp;<span class="ident" id="7485911">DialErrorTest</span>&nbsp;<span class="keyword" id="7485925">struct</span>&nbsp;<span class="op" id="7485932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7485935">Net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7485943">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7485951">Raddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7485959">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7485967">Pattern</span>&nbsp;<span class="builtintype" id="7485975">string</span><br>
<span class="lineno"></span><span class="op" id="7485982">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="7485985">var</span>&nbsp;<span class="ident" id="7485989">dialErrorTests</span>&nbsp;<span class="op" id="7486004">=</span>&nbsp;<span class="op" id="7486006">[</span><span class="op" id="7486007">]</span><span class="ident" id="7486008">DialErrorTest</span><span class="op" id="7486021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7486024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7486028">&#34;datakit&#34;</span><span class="op" id="7486037">,</span>&nbsp;<span class="string" id="7486039">&#34;mh/astro/r70&#34;</span><span class="op" id="7486053">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7486057">&#34;dial&nbsp;datakit&nbsp;mh/astro/r70:&nbsp;unknown&nbsp;network&nbsp;datakit&#34;</span><span class="op" id="7486109">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7486112">}</span><span class="op" id="7486113">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7486116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7486120">&#34;tcp&#34;</span><span class="op" id="7486125">,</span>&nbsp;<span class="string" id="7486127">&#34;127.0.0.1:☺&#34;</span><span class="op" id="7486142">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7486146">&#34;dial&nbsp;tcp&nbsp;127.0.0.1:☺:&nbsp;unknown&nbsp;port&nbsp;tcp/☺&#34;</span><span class="op" id="7486192">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7486195">}</span><span class="op" id="7486196">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7486199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7486203">&#34;tcp&#34;</span><span class="op" id="7486208">,</span>&nbsp;<span class="string" id="7486210">&#34;no-such-name.google.com.:80&#34;</span><span class="op" id="7486239">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7486243">&#34;dial&nbsp;tcp&nbsp;no-such-name.google.com.:80:&nbsp;lookup&nbsp;no-such-name.google.com.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="7486332">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7486335">}</span><span class="op" id="7486336">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7486339">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7486343">&#34;tcp&#34;</span><span class="op" id="7486348">,</span>&nbsp;<span class="string" id="7486350">&#34;no-such-name.no-such-top-level-domain.:80&#34;</span><span class="op" id="7486393">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7486397">&#34;dial&nbsp;tcp&nbsp;no-such-name.no-such-top-level-domain.:80:&nbsp;lookup&nbsp;no-such-name.no-such-top-level-domain.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="7486514">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7486517">}</span><span class="op" id="7486518">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7486521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7486525">&#34;tcp&#34;</span><span class="op" id="7486530">,</span>&nbsp;<span class="string" id="7486532">&#34;no-such-name:80&#34;</span><span class="op" id="7486549">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7486553">`dial&nbsp;tcp&nbsp;no-such-name:80:&nbsp;lookup&nbsp;no-such-name\.(.*\.)?(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)`</span><span class="op" id="7486627">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7486630">}</span><span class="op" id="7486631">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7486634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7486638">&#34;tcp&#34;</span><span class="op" id="7486643">,</span>&nbsp;<span class="string" id="7486645">&#34;mh/astro/r70:http&#34;</span><span class="op" id="7486664">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7486668">&#34;dial&nbsp;tcp&nbsp;mh/astro/r70:http:&nbsp;lookup&nbsp;mh/astro/r70:&nbsp;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="7486738">,</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7486741">}</span><span class="op" id="7486742">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7486745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7486749">&#34;unix&#34;</span><span class="op" id="7486755">,</span>&nbsp;<span class="string" id="7486757">&#34;/etc/file-not-found&#34;</span><span class="op" id="7486778">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7486782">&#34;dial&nbsp;unix&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="7486840">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7486843">}</span><span class="op" id="7486844">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7486847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7486851">&#34;unix&#34;</span><span class="op" id="7486857">,</span>&nbsp;<span class="string" id="7486859">&#34;/etc/&#34;</span><span class="op" id="7486866">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7486870">&#34;dial&nbsp;unix&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="7486958">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7486961">}</span><span class="op" id="7486962">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7486965">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7486969">&#34;unixpacket&#34;</span><span class="op" id="7486981">,</span>&nbsp;<span class="string" id="7486983">&#34;/etc/file-not-found&#34;</span><span class="op" id="7487004">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7487008">&#34;dial&nbsp;unixpacket&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="7487072">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7487075">}</span><span class="op" id="7487076">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7487079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7487083">&#34;unixpacket&#34;</span><span class="op" id="7487095">,</span>&nbsp;<span class="string" id="7487097">&#34;/etc/&#34;</span><span class="op" id="7487104">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7487108">&#34;dial&nbsp;unixpacket&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="7487202">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7487205">}</span><span class="op" id="7487206">,</span><br>
<span class="lineno"></span><span class="op" id="7487208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7487211">var</span>&nbsp;<span class="ident" id="7487215">duplicateErrorPattern</span>&nbsp;<span class="op" id="7487237">=</span>&nbsp;<span class="string" id="7487239">`dial&nbsp;(.*)&nbsp;dial&nbsp;(.*)`</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="7487262">func</span>&nbsp;<span class="ident" id="7487267">TestDialError</span><span class="op" id="7487280">(</span><span class="ident" id="7487281">t</span>&nbsp;<span class="op" id="7487283">*</span><span class="ident" id="7487284">testing</span><span class="op" id="7487291">.</span><span class="ident" id="7487292">T</span><span class="op" id="7487293">)</span>&nbsp;<span class="op" id="7487295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7487298">if</span>&nbsp;<span class="op" id="7487301">!</span><span class="op" id="7487302">*</span><span class="ident" id="7487303">runErrorTest</span>&nbsp;<span class="op" id="7487316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7487320">t</span><span class="op" id="7487321">.</span><span class="ident" id="7487322">Logf</span><span class="op" id="7487326">(</span><span class="string" id="7487327">&#34;test&nbsp;disabled;&nbsp;use&nbsp;-run_error_test&nbsp;to&nbsp;enable&#34;</span><span class="op" id="7487373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7487377">return</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7487385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7487388">for</span>&nbsp;<span class="ident" id="7487392">i</span><span class="op" id="7487393">,</span>&nbsp;<span class="ident" id="7487395">tt</span>&nbsp;<span class="op" id="7487398">:=</span>&nbsp;<span class="keyword" id="7487401">range</span>&nbsp;<span class="ident" id="7487407">dialErrorTests</span>&nbsp;<span class="op" id="7487422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7487426">c</span><span class="op" id="7487427">,</span>&nbsp;<span class="ident" id="7487429">err</span>&nbsp;<span class="op" id="7487433">:=</span>&nbsp;<span class="ident" id="7487436">Dial</span><span class="op" id="7487440">(</span><span class="ident" id="7487441">tt</span><span class="op" id="7487443">.</span><span class="ident" id="7487444">Net</span><span class="op" id="7487447">,</span>&nbsp;<span class="ident" id="7487449">tt</span><span class="op" id="7487451">.</span><span class="ident" id="7487452">Raddr</span><span class="op" id="7487457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7487461">if</span>&nbsp;<span class="ident" id="7487464">c</span>&nbsp;<span class="op" id="7487466">!=</span>&nbsp;<span class="ident" id="7487469">nil</span>&nbsp;<span class="op" id="7487473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7487478">c</span><span class="op" id="7487479">.</span><span class="ident" id="7487480">Close</span><span class="op" id="7487485">(</span><span class="op" id="7487486">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7487490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7487494">if</span>&nbsp;<span class="ident" id="7487497">err</span>&nbsp;<span class="op" id="7487501">==</span>&nbsp;<span class="ident" id="7487504">nil</span>&nbsp;<span class="op" id="7487508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7487513">t</span><span class="op" id="7487514">.</span><span class="ident" id="7487515">Errorf</span><span class="op" id="7487521">(</span><span class="string" id="7487522">&#34;#%d:&nbsp;nil&nbsp;error,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="7487558">,</span>&nbsp;<span class="ident" id="7487560">i</span><span class="op" id="7487561">,</span>&nbsp;<span class="ident" id="7487563">tt</span><span class="op" id="7487565">.</span><span class="ident" id="7487566">Pattern</span><span class="op" id="7487573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7487578">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7487589">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7487593">s</span>&nbsp;<span class="op" id="7487595">:=</span>&nbsp;<span class="ident" id="7487598">err</span><span class="op" id="7487601">.</span><span class="ident" id="7487602">Error</span><span class="op" id="7487607">(</span><span class="op" id="7487608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7487612">match</span><span class="op" id="7487617">,</span>&nbsp;<span class="ident" id="7487619">_</span>&nbsp;<span class="op" id="7487621">:=</span>&nbsp;<span class="ident" id="7487624">regexp</span><span class="op" id="7487630">.</span><span class="ident" id="7487631">MatchString</span><span class="op" id="7487642">(</span><span class="ident" id="7487643">tt</span><span class="op" id="7487645">.</span><span class="ident" id="7487646">Pattern</span><span class="op" id="7487653">,</span>&nbsp;<span class="ident" id="7487655">s</span><span class="op" id="7487656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7487660">if</span>&nbsp;<span class="op" id="7487663">!</span><span class="ident" id="7487664">match</span>&nbsp;<span class="op" id="7487670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7487675">t</span><span class="op" id="7487676">.</span><span class="ident" id="7487677">Errorf</span><span class="op" id="7487683">(</span><span class="string" id="7487684">&#34;#%d:&nbsp;%q,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="7487713">,</span>&nbsp;<span class="ident" id="7487715">i</span><span class="op" id="7487716">,</span>&nbsp;<span class="ident" id="7487718">s</span><span class="op" id="7487719">,</span>&nbsp;<span class="ident" id="7487721">tt</span><span class="op" id="7487723">.</span><span class="ident" id="7487724">Pattern</span><span class="op" id="7487731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7487735">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7487739">match</span><span class="op" id="7487744">,</span>&nbsp;<span class="ident" id="7487746">_</span>&nbsp;<span class="op" id="7487748">=</span>&nbsp;<span class="ident" id="7487750">regexp</span><span class="op" id="7487756">.</span><span class="ident" id="7487757">MatchString</span><span class="op" id="7487768">(</span><span class="ident" id="7487769">duplicateErrorPattern</span><span class="op" id="7487790">,</span>&nbsp;<span class="ident" id="7487792">s</span><span class="op" id="7487793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7487797">if</span>&nbsp;<span class="ident" id="7487800">match</span>&nbsp;<span class="op" id="7487806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7487811">t</span><span class="op" id="7487812">.</span><span class="ident" id="7487813">Errorf</span><span class="op" id="7487819">(</span><span class="string" id="7487820">&#34;#%d:&nbsp;%q,&nbsp;duplicate&nbsp;error&nbsp;return&nbsp;from&nbsp;Dial&#34;</span><span class="op" id="7487863">,</span>&nbsp;<span class="ident" id="7487865">i</span><span class="op" id="7487866">,</span>&nbsp;<span class="ident" id="7487868">s</span><span class="op" id="7487869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7487873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7487876">}</span><br>
<span class="lineno">240</span><span class="op" id="7487878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7487881">var</span>&nbsp;<span class="ident" id="7487885">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="7487914">=</span>&nbsp;<span class="op" id="7487916">[</span><span class="op" id="7487917">]</span><span class="keyword" id="7487918">struct</span>&nbsp;<span class="op" id="7487925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7487928">net</span>&nbsp;&nbsp;<span class="builtintype" id="7487933">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7487941">addr</span>&nbsp;<span class="builtintype" id="7487946">string</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7487954">err</span>&nbsp;&nbsp;<span class="builtintype" id="7487959">error</span><br>
<span class="lineno"></span><span class="op" id="7487965">}</span><span class="op" id="7487966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7487969">{</span><span class="string" id="7487970">&#34;foo&#34;</span><span class="op" id="7487975">,</span>&nbsp;<span class="string" id="7487977">&#34;bar&#34;</span><span class="op" id="7487982">,</span>&nbsp;<span class="op" id="7487984">&amp;</span><span class="ident" id="7487985">OpError</span><span class="op" id="7487992">{</span><span class="ident" id="7487993">Op</span><span class="op" id="7487995">:</span>&nbsp;<span class="string" id="7487997">&#34;dial&#34;</span><span class="op" id="7488003">,</span>&nbsp;<span class="ident" id="7488005">Net</span><span class="op" id="7488008">:</span>&nbsp;<span class="string" id="7488010">&#34;foo&#34;</span><span class="op" id="7488015">,</span>&nbsp;<span class="ident" id="7488017">Addr</span><span class="op" id="7488021">:</span>&nbsp;<span class="ident" id="7488023">nil</span><span class="op" id="7488026">,</span>&nbsp;<span class="ident" id="7488028">Err</span><span class="op" id="7488031">:</span>&nbsp;<span class="ident" id="7488033">UnknownNetworkError</span><span class="op" id="7488052">(</span><span class="string" id="7488053">&#34;foo&#34;</span><span class="op" id="7488058">)</span><span class="op" id="7488059">}</span><span class="op" id="7488060">}</span><span class="op" id="7488061">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7488064">{</span><span class="string" id="7488065">&#34;baz&#34;</span><span class="op" id="7488070">,</span>&nbsp;<span class="string" id="7488072">&#34;&#34;</span><span class="op" id="7488074">,</span>&nbsp;<span class="op" id="7488076">&amp;</span><span class="ident" id="7488077">OpError</span><span class="op" id="7488084">{</span><span class="ident" id="7488085">Op</span><span class="op" id="7488087">:</span>&nbsp;<span class="string" id="7488089">&#34;listen&#34;</span><span class="op" id="7488097">,</span>&nbsp;<span class="ident" id="7488099">Net</span><span class="op" id="7488102">:</span>&nbsp;<span class="string" id="7488104">&#34;baz&#34;</span><span class="op" id="7488109">,</span>&nbsp;<span class="ident" id="7488111">Addr</span><span class="op" id="7488115">:</span>&nbsp;<span class="ident" id="7488117">nil</span><span class="op" id="7488120">,</span>&nbsp;<span class="ident" id="7488122">Err</span><span class="op" id="7488125">:</span>&nbsp;<span class="ident" id="7488127">UnknownNetworkError</span><span class="op" id="7488146">(</span><span class="string" id="7488147">&#34;baz&#34;</span><span class="op" id="7488152">)</span><span class="op" id="7488153">}</span><span class="op" id="7488154">}</span><span class="op" id="7488155">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7488158">{</span><span class="string" id="7488159">&#34;tcp&#34;</span><span class="op" id="7488164">,</span>&nbsp;<span class="string" id="7488166">&#34;&#34;</span><span class="op" id="7488168">,</span>&nbsp;<span class="op" id="7488170">&amp;</span><span class="ident" id="7488171">OpError</span><span class="op" id="7488178">{</span><span class="ident" id="7488179">Op</span><span class="op" id="7488181">:</span>&nbsp;<span class="string" id="7488183">&#34;dial&#34;</span><span class="op" id="7488189">,</span>&nbsp;<span class="ident" id="7488191">Net</span><span class="op" id="7488194">:</span>&nbsp;<span class="string" id="7488196">&#34;tcp&#34;</span><span class="op" id="7488201">,</span>&nbsp;<span class="ident" id="7488203">Addr</span><span class="op" id="7488207">:</span>&nbsp;<span class="ident" id="7488209">nil</span><span class="op" id="7488212">,</span>&nbsp;<span class="ident" id="7488214">Err</span><span class="op" id="7488217">:</span>&nbsp;<span class="ident" id="7488219">errMissingAddress</span><span class="op" id="7488236">}</span><span class="op" id="7488237">}</span><span class="op" id="7488238">,</span><br>
<span class="lineno">250</span><span class="op" id="7488240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7488243">func</span>&nbsp;<span class="ident" id="7488248">TestInvalidDialAndListenArgs</span><span class="op" id="7488276">(</span><span class="ident" id="7488277">t</span>&nbsp;<span class="op" id="7488279">*</span><span class="ident" id="7488280">testing</span><span class="op" id="7488287">.</span><span class="ident" id="7488288">T</span><span class="op" id="7488289">)</span>&nbsp;<span class="op" id="7488291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7488294">for</span>&nbsp;<span class="ident" id="7488298">_</span><span class="op" id="7488299">,</span>&nbsp;<span class="ident" id="7488301">tt</span>&nbsp;<span class="op" id="7488304">:=</span>&nbsp;<span class="keyword" id="7488307">range</span>&nbsp;<span class="ident" id="7488313">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="7488342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7488346">var</span>&nbsp;<span class="ident" id="7488350">err</span>&nbsp;<span class="builtintype" id="7488354">error</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7488362">switch</span>&nbsp;<span class="ident" id="7488369">tt</span><span class="op" id="7488371">.</span><span class="ident" id="7488372">err</span><span class="op" id="7488375">.</span><span class="op" id="7488376">(</span><span class="op" id="7488377">*</span><span class="ident" id="7488378">OpError</span><span class="op" id="7488385">)</span><span class="op" id="7488386">.</span><span class="ident" id="7488387">Op</span>&nbsp;<span class="op" id="7488390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7488394">case</span>&nbsp;<span class="string" id="7488399">&#34;dial&#34;</span><span class="op" id="7488405">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7488410">_</span><span class="op" id="7488411">,</span>&nbsp;<span class="ident" id="7488413">err</span>&nbsp;<span class="op" id="7488417">=</span>&nbsp;<span class="ident" id="7488419">Dial</span><span class="op" id="7488423">(</span><span class="ident" id="7488424">tt</span><span class="op" id="7488426">.</span><span class="ident" id="7488427">net</span><span class="op" id="7488430">,</span>&nbsp;<span class="ident" id="7488432">tt</span><span class="op" id="7488434">.</span><span class="ident" id="7488435">addr</span><span class="op" id="7488439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7488443">case</span>&nbsp;<span class="string" id="7488448">&#34;listen&#34;</span><span class="op" id="7488456">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7488461">_</span><span class="op" id="7488462">,</span>&nbsp;<span class="ident" id="7488464">err</span>&nbsp;<span class="op" id="7488468">=</span>&nbsp;<span class="ident" id="7488470">Listen</span><span class="op" id="7488476">(</span><span class="ident" id="7488477">tt</span><span class="op" id="7488479">.</span><span class="ident" id="7488480">net</span><span class="op" id="7488483">,</span>&nbsp;<span class="ident" id="7488485">tt</span><span class="op" id="7488487">.</span><span class="ident" id="7488488">addr</span><span class="op" id="7488492">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7488496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7488500">if</span>&nbsp;<span class="op" id="7488503">!</span><span class="ident" id="7488504">reflect</span><span class="op" id="7488511">.</span><span class="ident" id="7488512">DeepEqual</span><span class="op" id="7488521">(</span><span class="ident" id="7488522">tt</span><span class="op" id="7488524">.</span><span class="ident" id="7488525">err</span><span class="op" id="7488528">,</span>&nbsp;<span class="ident" id="7488530">err</span><span class="op" id="7488533">)</span>&nbsp;<span class="op" id="7488535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7488540">t</span><span class="op" id="7488541">.</span><span class="ident" id="7488542">Fatalf</span><span class="op" id="7488548">(</span><span class="string" id="7488549">&#34;got&nbsp;%#v;&nbsp;expected&nbsp;%#v&#34;</span><span class="op" id="7488572">,</span>&nbsp;<span class="ident" id="7488574">err</span><span class="op" id="7488577">,</span>&nbsp;<span class="ident" id="7488579">tt</span><span class="op" id="7488581">.</span><span class="ident" id="7488582">err</span><span class="op" id="7488585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7488589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7488592">}</span><br>
<span class="lineno">265</span><span class="op" id="7488594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7488597">func</span>&nbsp;<span class="ident" id="7488602">TestDialTimeoutFDLeak</span><span class="op" id="7488623">(</span><span class="ident" id="7488624">t</span>&nbsp;<span class="op" id="7488626">*</span><span class="ident" id="7488627">testing</span><span class="op" id="7488634">.</span><span class="ident" id="7488635">T</span><span class="op" id="7488636">)</span>&nbsp;<span class="op" id="7488638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7488641">if</span>&nbsp;<span class="ident" id="7488644">runtime</span><span class="op" id="7488651">.</span><span class="ident" id="7488652">GOOS</span>&nbsp;<span class="op" id="7488657">!=</span>&nbsp;<span class="string" id="7488660">&#34;linux&#34;</span>&nbsp;<span class="op" id="7488668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7488672">//&nbsp;TODO(bradfitz):&nbsp;test&nbsp;on&nbsp;other&nbsp;platforms</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7488717">t</span><span class="op" id="7488718">.</span><span class="ident" id="7488719">Skipf</span><span class="op" id="7488724">(</span><span class="string" id="7488725">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7488746">,</span>&nbsp;<span class="ident" id="7488748">runtime</span><span class="op" id="7488755">.</span><span class="ident" id="7488756">GOOS</span><span class="op" id="7488760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7488763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7488767">ln</span>&nbsp;<span class="op" id="7488770">:=</span>&nbsp;<span class="ident" id="7488773">newLocalListener</span><span class="op" id="7488789">(</span><span class="ident" id="7488790">t</span><span class="op" id="7488791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7488794">defer</span>&nbsp;<span class="ident" id="7488800">ln</span><span class="op" id="7488802">.</span><span class="ident" id="7488803">Close</span><span class="op" id="7488808">(</span><span class="op" id="7488809">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7488813">type</span>&nbsp;<span class="ident" id="7488818">connErr</span>&nbsp;<span class="keyword" id="7488826">struct</span>&nbsp;<span class="op" id="7488833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7488837">conn</span>&nbsp;<span class="ident" id="7488842">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7488849">err</span>&nbsp;&nbsp;<span class="builtintype" id="7488854">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7488861">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7488864">dials</span>&nbsp;<span class="op" id="7488870">:=</span>&nbsp;<span class="ident" id="7488873">listenerBacklog</span>&nbsp;<span class="op" id="7488889">+</span>&nbsp;<span class="num" id="7488891">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7488896">//&nbsp;used&nbsp;to&nbsp;be&nbsp;listenerBacklog&nbsp;+&nbsp;5,&nbsp;but&nbsp;was&nbsp;found&nbsp;to&nbsp;be&nbsp;unreliable,&nbsp;issue&nbsp;4384.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7488976">maxGoodConnect</span>&nbsp;<span class="op" id="7488991">:=</span>&nbsp;<span class="ident" id="7488994">listenerBacklog</span>&nbsp;<span class="op" id="7489010">+</span>&nbsp;<span class="ident" id="7489012">runtime</span><span class="op" id="7489019">.</span><span class="ident" id="7489020">NumCPU</span><span class="op" id="7489026">(</span><span class="op" id="7489027">)</span><span class="op" id="7489028">*</span><span class="num" id="7489029">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7489033">resc</span>&nbsp;<span class="op" id="7489038">:=</span>&nbsp;<span class="builtinfunc" id="7489041">make</span><span class="op" id="7489045">(</span><span class="keyword" id="7489046">chan</span>&nbsp;<span class="ident" id="7489051">connErr</span><span class="op" id="7489058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7489061">for</span>&nbsp;<span class="ident" id="7489065">i</span>&nbsp;<span class="op" id="7489067">:=</span>&nbsp;<span class="num" id="7489070">0</span><span class="op" id="7489071">;</span>&nbsp;<span class="ident" id="7489073">i</span>&nbsp;<span class="op" id="7489075">&lt;</span>&nbsp;<span class="ident" id="7489077">dials</span><span class="op" id="7489082">;</span>&nbsp;<span class="ident" id="7489084">i</span><span class="op" id="7489085">++</span>&nbsp;<span class="op" id="7489088">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7489092">go</span>&nbsp;<span class="keyword" id="7489095">func</span><span class="op" id="7489099">(</span><span class="op" id="7489100">)</span>&nbsp;<span class="op" id="7489102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7489107">conn</span><span class="op" id="7489111">,</span>&nbsp;<span class="ident" id="7489113">err</span>&nbsp;<span class="op" id="7489117">:=</span>&nbsp;<span class="ident" id="7489120">DialTimeout</span><span class="op" id="7489131">(</span><span class="string" id="7489132">&#34;tcp&#34;</span><span class="op" id="7489137">,</span>&nbsp;<span class="ident" id="7489139">ln</span><span class="op" id="7489141">.</span><span class="ident" id="7489142">Addr</span><span class="op" id="7489146">(</span><span class="op" id="7489147">)</span><span class="op" id="7489148">.</span><span class="ident" id="7489149">String</span><span class="op" id="7489155">(</span><span class="op" id="7489156">)</span><span class="op" id="7489157">,</span>&nbsp;<span class="num" id="7489159">500</span><span class="op" id="7489162">*</span><span class="ident" id="7489163">time</span><span class="op" id="7489167">.</span><span class="ident" id="7489168">Millisecond</span><span class="op" id="7489179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7489184">resc</span>&nbsp;<span class="op" id="7489189">&lt;-</span>&nbsp;<span class="ident" id="7489192">connErr</span><span class="op" id="7489199">{</span><span class="ident" id="7489200">conn</span><span class="op" id="7489204">,</span>&nbsp;<span class="ident" id="7489206">err</span><span class="op" id="7489209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7489213">}</span><span class="op" id="7489214">(</span><span class="op" id="7489215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7489218">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7489222">var</span>&nbsp;<span class="ident" id="7489226">firstErr</span>&nbsp;<span class="builtintype" id="7489235">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7489243">var</span>&nbsp;<span class="ident" id="7489247">ngood</span>&nbsp;<span class="builtintype" id="7489253">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7489258">var</span>&nbsp;<span class="ident" id="7489262">toClose</span>&nbsp;<span class="op" id="7489270">[</span><span class="op" id="7489271">]</span><span class="ident" id="7489272">io</span><span class="op" id="7489274">.</span><span class="ident" id="7489275">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7489283">for</span>&nbsp;<span class="ident" id="7489287">i</span>&nbsp;<span class="op" id="7489289">:=</span>&nbsp;<span class="num" id="7489292">0</span><span class="op" id="7489293">;</span>&nbsp;<span class="ident" id="7489295">i</span>&nbsp;<span class="op" id="7489297">&lt;</span>&nbsp;<span class="ident" id="7489299">dials</span><span class="op" id="7489304">;</span>&nbsp;<span class="ident" id="7489306">i</span><span class="op" id="7489307">++</span>&nbsp;<span class="op" id="7489310">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7489314">ce</span>&nbsp;<span class="op" id="7489317">:=</span>&nbsp;<span class="op" id="7489320">&lt;-</span><span class="ident" id="7489322">resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7489329">if</span>&nbsp;<span class="ident" id="7489332">ce</span><span class="op" id="7489334">.</span><span class="ident" id="7489335">err</span>&nbsp;<span class="op" id="7489339">==</span>&nbsp;<span class="ident" id="7489342">nil</span>&nbsp;<span class="op" id="7489346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7489351">ngood</span><span class="op" id="7489356">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7489362">if</span>&nbsp;<span class="ident" id="7489365">ngood</span>&nbsp;<span class="op" id="7489371">&gt;</span>&nbsp;<span class="ident" id="7489373">maxGoodConnect</span>&nbsp;<span class="op" id="7489388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7489394">t</span><span class="op" id="7489395">.</span><span class="ident" id="7489396">Errorf</span><span class="op" id="7489402">(</span><span class="string" id="7489403">&#34;%d&nbsp;good&nbsp;connects;&nbsp;expected&nbsp;at&nbsp;most&nbsp;%d&#34;</span><span class="op" id="7489442">,</span>&nbsp;<span class="ident" id="7489444">ngood</span><span class="op" id="7489449">,</span>&nbsp;<span class="ident" id="7489451">maxGoodConnect</span><span class="op" id="7489465">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7489470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7489475">toClose</span>&nbsp;<span class="op" id="7489483">=</span>&nbsp;<span class="builtinfunc" id="7489485">append</span><span class="op" id="7489491">(</span><span class="ident" id="7489492">toClose</span><span class="op" id="7489499">,</span>&nbsp;<span class="ident" id="7489501">ce</span><span class="op" id="7489503">.</span><span class="ident" id="7489504">conn</span><span class="op" id="7489508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7489513">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7489524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7489528">err</span>&nbsp;<span class="op" id="7489532">:=</span>&nbsp;<span class="ident" id="7489535">ce</span><span class="op" id="7489537">.</span><span class="ident" id="7489538">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7489544">if</span>&nbsp;<span class="ident" id="7489547">firstErr</span>&nbsp;<span class="op" id="7489556">==</span>&nbsp;<span class="string" id="7489559">&#34;&#34;</span>&nbsp;<span class="op" id="7489562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7489567">firstErr</span>&nbsp;<span class="op" id="7489576">=</span>&nbsp;<span class="ident" id="7489578">err</span><span class="op" id="7489581">.</span><span class="ident" id="7489582">Error</span><span class="op" id="7489587">(</span><span class="op" id="7489588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7489592">}</span>&nbsp;<span class="keyword" id="7489594">else</span>&nbsp;<span class="keyword" id="7489599">if</span>&nbsp;<span class="ident" id="7489602">err</span><span class="op" id="7489605">.</span><span class="ident" id="7489606">Error</span><span class="op" id="7489611">(</span><span class="op" id="7489612">)</span>&nbsp;<span class="op" id="7489614">!=</span>&nbsp;<span class="ident" id="7489617">firstErr</span>&nbsp;<span class="op" id="7489626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7489631">t</span><span class="op" id="7489632">.</span><span class="ident" id="7489633">Fatalf</span><span class="op" id="7489639">(</span><span class="string" id="7489640">&#34;inconsistent&nbsp;error&nbsp;messages:&nbsp;first&nbsp;was&nbsp;%q,&nbsp;then&nbsp;later&nbsp;%q&#34;</span><span class="op" id="7489698">,</span>&nbsp;<span class="ident" id="7489700">firstErr</span><span class="op" id="7489708">,</span>&nbsp;<span class="ident" id="7489710">err</span><span class="op" id="7489713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7489717">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7489720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7489723">for</span>&nbsp;<span class="ident" id="7489727">_</span><span class="op" id="7489728">,</span>&nbsp;<span class="ident" id="7489730">c</span>&nbsp;<span class="op" id="7489732">:=</span>&nbsp;<span class="keyword" id="7489735">range</span>&nbsp;<span class="ident" id="7489741">toClose</span>&nbsp;<span class="op" id="7489749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7489753">c</span><span class="op" id="7489754">.</span><span class="ident" id="7489755">Close</span><span class="op" id="7489760">(</span><span class="op" id="7489761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7489764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7489767">for</span>&nbsp;<span class="ident" id="7489771">i</span>&nbsp;<span class="op" id="7489773">:=</span>&nbsp;<span class="num" id="7489776">0</span><span class="op" id="7489777">;</span>&nbsp;<span class="ident" id="7489779">i</span>&nbsp;<span class="op" id="7489781">&lt;</span>&nbsp;<span class="num" id="7489783">100</span><span class="op" id="7489786">;</span>&nbsp;<span class="ident" id="7489788">i</span><span class="op" id="7489789">++</span>&nbsp;<span class="op" id="7489792">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7489796">if</span>&nbsp;<span class="ident" id="7489799">got</span>&nbsp;<span class="op" id="7489803">:=</span>&nbsp;<span class="ident" id="7489806">numFD</span><span class="op" id="7489811">(</span><span class="op" id="7489812">)</span><span class="op" id="7489813">;</span>&nbsp;<span class="ident" id="7489815">got</span>&nbsp;<span class="op" id="7489819">&lt;</span>&nbsp;<span class="ident" id="7489821">dials</span>&nbsp;<span class="op" id="7489827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7489832">//&nbsp;Test&nbsp;passes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7489851">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7489860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7489864">time</span><span class="op" id="7489868">.</span><span class="ident" id="7489869">Sleep</span><span class="op" id="7489874">(</span><span class="num" id="7489875">10</span>&nbsp;<span class="op" id="7489878">*</span>&nbsp;<span class="ident" id="7489880">time</span><span class="op" id="7489884">.</span><span class="ident" id="7489885">Millisecond</span><span class="op" id="7489896">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7489899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7489902">if</span>&nbsp;<span class="ident" id="7489905">got</span>&nbsp;<span class="op" id="7489909">:=</span>&nbsp;<span class="ident" id="7489912">numFD</span><span class="op" id="7489917">(</span><span class="op" id="7489918">)</span><span class="op" id="7489919">;</span>&nbsp;<span class="ident" id="7489921">got</span>&nbsp;<span class="op" id="7489925">&gt;=</span>&nbsp;<span class="ident" id="7489928">dials</span>&nbsp;<span class="op" id="7489934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7489938">t</span><span class="op" id="7489939">.</span><span class="ident" id="7489940">Errorf</span><span class="op" id="7489946">(</span><span class="string" id="7489947">&#34;num&nbsp;fds&nbsp;after&nbsp;%d&nbsp;timeouts&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;%d&#34;</span><span class="op" id="7489989">,</span>&nbsp;<span class="ident" id="7489991">dials</span><span class="op" id="7489996">,</span>&nbsp;<span class="ident" id="7489998">got</span><span class="op" id="7490001">,</span>&nbsp;<span class="ident" id="7490003">dials</span><span class="op" id="7490008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7490011">}</span><br>
<span class="lineno"></span><span class="op" id="7490013">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="7490016">func</span>&nbsp;<span class="ident" id="7490021">numTCP</span><span class="op" id="7490027">(</span><span class="op" id="7490028">)</span>&nbsp;<span class="op" id="7490030">(</span><span class="ident" id="7490031">ntcp</span><span class="op" id="7490035">,</span>&nbsp;<span class="ident" id="7490037">nopen</span><span class="op" id="7490042">,</span>&nbsp;<span class="ident" id="7490044">nclose</span>&nbsp;<span class="builtintype" id="7490051">int</span><span class="op" id="7490054">,</span>&nbsp;<span class="ident" id="7490056">err</span>&nbsp;<span class="builtintype" id="7490060">error</span><span class="op" id="7490065">)</span>&nbsp;<span class="op" id="7490067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7490070">lsof</span><span class="op" id="7490074">,</span>&nbsp;<span class="ident" id="7490076">err</span>&nbsp;<span class="op" id="7490080">:=</span>&nbsp;<span class="ident" id="7490083">exec</span><span class="op" id="7490087">.</span><span class="ident" id="7490088">Command</span><span class="op" id="7490095">(</span><span class="string" id="7490096">&#34;lsof&#34;</span><span class="op" id="7490102">,</span>&nbsp;<span class="string" id="7490104">&#34;-n&#34;</span><span class="op" id="7490108">,</span>&nbsp;<span class="string" id="7490110">&#34;-p&#34;</span><span class="op" id="7490114">,</span>&nbsp;<span class="ident" id="7490116">strconv</span><span class="op" id="7490123">.</span><span class="ident" id="7490124">Itoa</span><span class="op" id="7490128">(</span><span class="ident" id="7490129">os</span><span class="op" id="7490131">.</span><span class="ident" id="7490132">Getpid</span><span class="op" id="7490138">(</span><span class="op" id="7490139">)</span><span class="op" id="7490140">)</span><span class="op" id="7490141">)</span><span class="op" id="7490142">.</span><span class="ident" id="7490143">Output</span><span class="op" id="7490149">(</span><span class="op" id="7490150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7490153">if</span>&nbsp;<span class="ident" id="7490156">err</span>&nbsp;<span class="op" id="7490160">!=</span>&nbsp;<span class="ident" id="7490163">nil</span>&nbsp;<span class="op" id="7490167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7490171">return</span>&nbsp;<span class="num" id="7490178">0</span><span class="op" id="7490179">,</span>&nbsp;<span class="num" id="7490181">0</span><span class="op" id="7490182">,</span>&nbsp;<span class="num" id="7490184">0</span><span class="op" id="7490185">,</span>&nbsp;<span class="ident" id="7490187">err</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7490192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7490195">ntcp</span>&nbsp;<span class="op" id="7490200">+=</span>&nbsp;<span class="ident" id="7490203">bytes</span><span class="op" id="7490208">.</span><span class="ident" id="7490209">Count</span><span class="op" id="7490214">(</span><span class="ident" id="7490215">lsof</span><span class="op" id="7490219">,</span>&nbsp;<span class="op" id="7490221">[</span><span class="op" id="7490222">]</span><span class="builtintype" id="7490223">byte</span><span class="op" id="7490227">(</span><span class="string" id="7490228">&#34;TCP&#34;</span><span class="op" id="7490233">)</span><span class="op" id="7490234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7490237">for</span>&nbsp;<span class="ident" id="7490241">_</span><span class="op" id="7490242">,</span>&nbsp;<span class="ident" id="7490244">state</span>&nbsp;<span class="op" id="7490250">:=</span>&nbsp;<span class="keyword" id="7490253">range</span>&nbsp;<span class="op" id="7490259">[</span><span class="op" id="7490260">]</span><span class="builtintype" id="7490261">string</span><span class="op" id="7490267">{</span><span class="string" id="7490268">&#34;LISTEN&#34;</span><span class="op" id="7490276">,</span>&nbsp;<span class="string" id="7490278">&#34;SYN_SENT&#34;</span><span class="op" id="7490288">,</span>&nbsp;<span class="string" id="7490290">&#34;SYN_RECEIVED&#34;</span><span class="op" id="7490304">,</span>&nbsp;<span class="string" id="7490306">&#34;ESTABLISHED&#34;</span><span class="op" id="7490319">}</span>&nbsp;<span class="op" id="7490321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7490325">nopen</span>&nbsp;<span class="op" id="7490331">+=</span>&nbsp;<span class="ident" id="7490334">bytes</span><span class="op" id="7490339">.</span><span class="ident" id="7490340">Count</span><span class="op" id="7490345">(</span><span class="ident" id="7490346">lsof</span><span class="op" id="7490350">,</span>&nbsp;<span class="op" id="7490352">[</span><span class="op" id="7490353">]</span><span class="builtintype" id="7490354">byte</span><span class="op" id="7490358">(</span><span class="ident" id="7490359">state</span><span class="op" id="7490364">)</span><span class="op" id="7490365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7490368">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7490371">for</span>&nbsp;<span class="ident" id="7490375">_</span><span class="op" id="7490376">,</span>&nbsp;<span class="ident" id="7490378">state</span>&nbsp;<span class="op" id="7490384">:=</span>&nbsp;<span class="keyword" id="7490387">range</span>&nbsp;<span class="op" id="7490393">[</span><span class="op" id="7490394">]</span><span class="builtintype" id="7490395">string</span><span class="op" id="7490401">{</span><span class="string" id="7490402">&#34;CLOSED&#34;</span><span class="op" id="7490410">,</span>&nbsp;<span class="string" id="7490412">&#34;CLOSE_WAIT&#34;</span><span class="op" id="7490424">,</span>&nbsp;<span class="string" id="7490426">&#34;LAST_ACK&#34;</span><span class="op" id="7490436">,</span>&nbsp;<span class="string" id="7490438">&#34;FIN_WAIT_1&#34;</span><span class="op" id="7490450">,</span>&nbsp;<span class="string" id="7490452">&#34;FIN_WAIT_2&#34;</span><span class="op" id="7490464">,</span>&nbsp;<span class="string" id="7490466">&#34;CLOSING&#34;</span><span class="op" id="7490475">,</span>&nbsp;<span class="string" id="7490477">&#34;TIME_WAIT&#34;</span><span class="op" id="7490488">}</span>&nbsp;<span class="op" id="7490490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7490494">nclose</span>&nbsp;<span class="op" id="7490501">+=</span>&nbsp;<span class="ident" id="7490504">bytes</span><span class="op" id="7490509">.</span><span class="ident" id="7490510">Count</span><span class="op" id="7490515">(</span><span class="ident" id="7490516">lsof</span><span class="op" id="7490520">,</span>&nbsp;<span class="op" id="7490522">[</span><span class="op" id="7490523">]</span><span class="builtintype" id="7490524">byte</span><span class="op" id="7490528">(</span><span class="ident" id="7490529">state</span><span class="op" id="7490534">)</span><span class="op" id="7490535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7490538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7490541">return</span>&nbsp;<span class="ident" id="7490548">ntcp</span><span class="op" id="7490552">,</span>&nbsp;<span class="ident" id="7490554">nopen</span><span class="op" id="7490559">,</span>&nbsp;<span class="ident" id="7490561">nclose</span><span class="op" id="7490567">,</span>&nbsp;<span class="ident" id="7490569">nil</span><br>
<span class="lineno"></span><span class="op" id="7490573">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="keyword" id="7490576">func</span>&nbsp;<span class="ident" id="7490581">TestDialMultiFDLeak</span><span class="op" id="7490600">(</span><span class="ident" id="7490601">t</span>&nbsp;<span class="op" id="7490603">*</span><span class="ident" id="7490604">testing</span><span class="op" id="7490611">.</span><span class="ident" id="7490612">T</span><span class="op" id="7490613">)</span>&nbsp;<span class="op" id="7490615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7490618">t</span><span class="op" id="7490619">.</span><span class="ident" id="7490620">Skip</span><span class="op" id="7490624">(</span><span class="string" id="7490625">&#34;flaky&nbsp;test&nbsp;-&nbsp;golang.org/issue/8764&#34;</span><span class="op" id="7490661">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7490665">if</span>&nbsp;<span class="op" id="7490668">!</span><span class="ident" id="7490669">supportsIPv4</span>&nbsp;<span class="op" id="7490682">||</span>&nbsp;<span class="op" id="7490685">!</span><span class="ident" id="7490686">supportsIPv6</span>&nbsp;<span class="op" id="7490699">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7490703">t</span><span class="op" id="7490704">.</span><span class="ident" id="7490705">Skip</span><span class="op" id="7490709">(</span><span class="string" id="7490710">&#34;neither&nbsp;ipv4&nbsp;nor&nbsp;ipv6&nbsp;is&nbsp;supported&#34;</span><span class="op" id="7490746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7490749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7490753">halfDeadServer</span>&nbsp;<span class="op" id="7490768">:=</span>&nbsp;<span class="keyword" id="7490771">func</span><span class="op" id="7490775">(</span><span class="ident" id="7490776">dss</span>&nbsp;<span class="op" id="7490780">*</span><span class="ident" id="7490781">dualStackServer</span><span class="op" id="7490796">,</span>&nbsp;<span class="ident" id="7490798">ln</span>&nbsp;<span class="ident" id="7490801">Listener</span><span class="op" id="7490809">)</span>&nbsp;<span class="op" id="7490811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7490815">for</span>&nbsp;<span class="op" id="7490819">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7490824">if</span>&nbsp;<span class="ident" id="7490827">c</span><span class="op" id="7490828">,</span>&nbsp;<span class="ident" id="7490830">err</span>&nbsp;<span class="op" id="7490834">:=</span>&nbsp;<span class="ident" id="7490837">ln</span><span class="op" id="7490839">.</span><span class="ident" id="7490840">Accept</span><span class="op" id="7490846">(</span><span class="op" id="7490847">)</span><span class="op" id="7490848">;</span>&nbsp;<span class="ident" id="7490850">err</span>&nbsp;<span class="op" id="7490854">!=</span>&nbsp;<span class="ident" id="7490857">nil</span>&nbsp;<span class="op" id="7490861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7490867">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7490877">}</span>&nbsp;<span class="keyword" id="7490879">else</span>&nbsp;<span class="op" id="7490884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7490890">//&nbsp;It&nbsp;just&nbsp;keeps&nbsp;established</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7490923">//&nbsp;connections&nbsp;like&nbsp;a&nbsp;half-dead&nbsp;server</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7490966">//&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7490979">dss</span><span class="op" id="7490982">.</span><span class="ident" id="7490983">putConn</span><span class="op" id="7490990">(</span><span class="ident" id="7490991">c</span><span class="op" id="7490992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7490997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7491001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7491004">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7491007">dss</span><span class="op" id="7491010">,</span>&nbsp;<span class="ident" id="7491012">err</span>&nbsp;<span class="op" id="7491016">:=</span>&nbsp;<span class="ident" id="7491019">newDualStackServer</span><span class="op" id="7491037">(</span><span class="op" id="7491038">[</span><span class="op" id="7491039">]</span><span class="ident" id="7491040">streamListener</span><span class="op" id="7491054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7491058">{</span><span class="ident" id="7491059">net</span><span class="op" id="7491062">:</span>&nbsp;<span class="string" id="7491064">&#34;tcp4&#34;</span><span class="op" id="7491070">,</span>&nbsp;<span class="ident" id="7491072">addr</span><span class="op" id="7491076">:</span>&nbsp;<span class="string" id="7491078">&#34;127.0.0.1&#34;</span><span class="op" id="7491089">}</span><span class="op" id="7491090">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7491094">{</span><span class="ident" id="7491095">net</span><span class="op" id="7491098">:</span>&nbsp;<span class="string" id="7491100">&#34;tcp6&#34;</span><span class="op" id="7491106">,</span>&nbsp;<span class="ident" id="7491108">addr</span><span class="op" id="7491112">:</span>&nbsp;<span class="string" id="7491114">&#34;[::1]&#34;</span><span class="op" id="7491121">}</span><span class="op" id="7491122">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7491125">}</span><span class="op" id="7491126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7491129">if</span>&nbsp;<span class="ident" id="7491132">err</span>&nbsp;<span class="op" id="7491136">!=</span>&nbsp;<span class="ident" id="7491139">nil</span>&nbsp;<span class="op" id="7491143">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7491147">t</span><span class="op" id="7491148">.</span><span class="ident" id="7491149">Fatalf</span><span class="op" id="7491155">(</span><span class="string" id="7491156">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7491187">,</span>&nbsp;<span class="ident" id="7491189">err</span><span class="op" id="7491192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7491195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7491198">defer</span>&nbsp;<span class="ident" id="7491204">dss</span><span class="op" id="7491207">.</span><span class="ident" id="7491208">teardown</span><span class="op" id="7491216">(</span><span class="op" id="7491217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7491220">if</span>&nbsp;<span class="ident" id="7491223">err</span>&nbsp;<span class="op" id="7491227">:=</span>&nbsp;<span class="ident" id="7491230">dss</span><span class="op" id="7491233">.</span><span class="ident" id="7491234">buildup</span><span class="op" id="7491241">(</span><span class="ident" id="7491242">halfDeadServer</span><span class="op" id="7491256">)</span><span class="op" id="7491257">;</span>&nbsp;<span class="ident" id="7491259">err</span>&nbsp;<span class="op" id="7491263">!=</span>&nbsp;<span class="ident" id="7491266">nil</span>&nbsp;<span class="op" id="7491270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7491274">t</span><span class="op" id="7491275">.</span><span class="ident" id="7491276">Fatalf</span><span class="op" id="7491282">(</span><span class="string" id="7491283">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7491319">,</span>&nbsp;<span class="ident" id="7491321">err</span><span class="op" id="7491324">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7491327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7491331">_</span><span class="op" id="7491332">,</span>&nbsp;<span class="ident" id="7491334">before</span><span class="op" id="7491340">,</span>&nbsp;<span class="ident" id="7491342">_</span><span class="op" id="7491343">,</span>&nbsp;<span class="ident" id="7491345">err</span>&nbsp;<span class="op" id="7491349">:=</span>&nbsp;<span class="ident" id="7491352">numTCP</span><span class="op" id="7491358">(</span><span class="op" id="7491359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7491362">if</span>&nbsp;<span class="ident" id="7491365">err</span>&nbsp;<span class="op" id="7491369">!=</span>&nbsp;<span class="ident" id="7491372">nil</span>&nbsp;<span class="op" id="7491376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7491380">t</span><span class="op" id="7491381">.</span><span class="ident" id="7491382">Skipf</span><span class="op" id="7491387">(</span><span class="string" id="7491388">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="7491438">,</span>&nbsp;<span class="ident" id="7491440">err</span><span class="op" id="7491443">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7491446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7491450">var</span>&nbsp;<span class="ident" id="7491454">wg</span>&nbsp;<span class="ident" id="7491457">sync</span><span class="op" id="7491461">.</span><span class="ident" id="7491462">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7491473">portnum</span><span class="op" id="7491480">,</span>&nbsp;<span class="ident" id="7491482">_</span><span class="op" id="7491483">,</span>&nbsp;<span class="ident" id="7491485">_</span>&nbsp;<span class="op" id="7491487">:=</span>&nbsp;<span class="ident" id="7491490">dtoi</span><span class="op" id="7491494">(</span><span class="ident" id="7491495">dss</span><span class="op" id="7491498">.</span><span class="ident" id="7491499">port</span><span class="op" id="7491503">,</span>&nbsp;<span class="num" id="7491505">0</span><span class="op" id="7491506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7491509">ras</span>&nbsp;<span class="op" id="7491513">:=</span>&nbsp;<span class="ident" id="7491516">addrList</span><span class="op" id="7491524">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7491528">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;fail&nbsp;to&nbsp;connect,&nbsp;see&nbsp;RFC&nbsp;6890.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7491581">&amp;</span><span class="ident" id="7491582">TCPAddr</span><span class="op" id="7491589">{</span><span class="ident" id="7491590">IP</span><span class="op" id="7491592">:</span>&nbsp;<span class="ident" id="7491594">IPv4</span><span class="op" id="7491598">(</span><span class="num" id="7491599">198</span><span class="op" id="7491602">,</span>&nbsp;<span class="num" id="7491604">18</span><span class="op" id="7491606">,</span>&nbsp;<span class="num" id="7491608">0</span><span class="op" id="7491609">,</span>&nbsp;<span class="num" id="7491611">254</span><span class="op" id="7491614">)</span><span class="op" id="7491615">,</span>&nbsp;<span class="ident" id="7491617">Port</span><span class="op" id="7491621">:</span>&nbsp;<span class="ident" id="7491623">portnum</span><span class="op" id="7491630">}</span><span class="op" id="7491631">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7491635">&amp;</span><span class="ident" id="7491636">TCPAddr</span><span class="op" id="7491643">{</span><span class="ident" id="7491644">IP</span><span class="op" id="7491646">:</span>&nbsp;<span class="ident" id="7491648">ParseIP</span><span class="op" id="7491655">(</span><span class="string" id="7491656">&#34;2001:2::254&#34;</span><span class="op" id="7491669">)</span><span class="op" id="7491670">,</span>&nbsp;<span class="ident" id="7491672">Port</span><span class="op" id="7491676">:</span>&nbsp;<span class="ident" id="7491678">portnum</span><span class="op" id="7491685">}</span><span class="op" id="7491686">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7491691">//&nbsp;Winner&nbsp;candidates&nbsp;of&nbsp;this&nbsp;race.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7491728">&amp;</span><span class="ident" id="7491729">TCPAddr</span><span class="op" id="7491736">{</span><span class="ident" id="7491737">IP</span><span class="op" id="7491739">:</span>&nbsp;<span class="ident" id="7491741">IPv4</span><span class="op" id="7491745">(</span><span class="num" id="7491746">127</span><span class="op" id="7491749">,</span>&nbsp;<span class="num" id="7491751">0</span><span class="op" id="7491752">,</span>&nbsp;<span class="num" id="7491754">0</span><span class="op" id="7491755">,</span>&nbsp;<span class="num" id="7491757">1</span><span class="op" id="7491758">)</span><span class="op" id="7491759">,</span>&nbsp;<span class="ident" id="7491761">Port</span><span class="op" id="7491765">:</span>&nbsp;<span class="ident" id="7491767">portnum</span><span class="op" id="7491774">}</span><span class="op" id="7491775">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7491779">&amp;</span><span class="ident" id="7491780">TCPAddr</span><span class="op" id="7491787">{</span><span class="ident" id="7491788">IP</span><span class="op" id="7491790">:</span>&nbsp;<span class="ident" id="7491792">IPv6loopback</span><span class="op" id="7491804">,</span>&nbsp;<span class="ident" id="7491806">Port</span><span class="op" id="7491810">:</span>&nbsp;<span class="ident" id="7491812">portnum</span><span class="op" id="7491819">}</span><span class="op" id="7491820">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7491825">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;have&nbsp;established&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7491877">&amp;</span><span class="ident" id="7491878">TCPAddr</span><span class="op" id="7491885">{</span><span class="ident" id="7491886">IP</span><span class="op" id="7491888">:</span>&nbsp;<span class="ident" id="7491890">IPv4</span><span class="op" id="7491894">(</span><span class="num" id="7491895">127</span><span class="op" id="7491898">,</span>&nbsp;<span class="num" id="7491900">0</span><span class="op" id="7491901">,</span>&nbsp;<span class="num" id="7491903">0</span><span class="op" id="7491904">,</span>&nbsp;<span class="num" id="7491906">1</span><span class="op" id="7491907">)</span><span class="op" id="7491908">,</span>&nbsp;<span class="ident" id="7491910">Port</span><span class="op" id="7491914">:</span>&nbsp;<span class="ident" id="7491916">portnum</span><span class="op" id="7491923">}</span><span class="op" id="7491924">,</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7491928">&amp;</span><span class="ident" id="7491929">TCPAddr</span><span class="op" id="7491936">{</span><span class="ident" id="7491937">IP</span><span class="op" id="7491939">:</span>&nbsp;<span class="ident" id="7491941">IPv6loopback</span><span class="op" id="7491953">,</span>&nbsp;<span class="ident" id="7491955">Port</span><span class="op" id="7491959">:</span>&nbsp;<span class="ident" id="7491961">portnum</span><span class="op" id="7491968">}</span><span class="op" id="7491969">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7491972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7491975">const</span>&nbsp;<span class="ident" id="7491981">T1</span>&nbsp;<span class="op" id="7491984">=</span>&nbsp;<span class="num" id="7491986">10</span>&nbsp;<span class="op" id="7491989">*</span>&nbsp;<span class="ident" id="7491991">time</span><span class="op" id="7491995">.</span><span class="ident" id="7491996">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7492009">const</span>&nbsp;<span class="ident" id="7492015">T2</span>&nbsp;<span class="op" id="7492018">=</span>&nbsp;<span class="num" id="7492020">2</span>&nbsp;<span class="op" id="7492022">*</span>&nbsp;<span class="ident" id="7492024">T1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7492028">const</span>&nbsp;<span class="ident" id="7492034">N</span>&nbsp;<span class="op" id="7492036">=</span>&nbsp;<span class="num" id="7492038">10</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7492042">for</span>&nbsp;<span class="ident" id="7492046">i</span>&nbsp;<span class="op" id="7492048">:=</span>&nbsp;<span class="num" id="7492051">0</span><span class="op" id="7492052">;</span>&nbsp;<span class="ident" id="7492054">i</span>&nbsp;<span class="op" id="7492056">&lt;</span>&nbsp;<span class="ident" id="7492058">N</span><span class="op" id="7492059">;</span>&nbsp;<span class="ident" id="7492061">i</span><span class="op" id="7492062">++</span>&nbsp;<span class="op" id="7492065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7492069">wg</span><span class="op" id="7492071">.</span><span class="ident" id="7492072">Add</span><span class="op" id="7492075">(</span><span class="num" id="7492076">1</span><span class="op" id="7492077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7492081">go</span>&nbsp;<span class="keyword" id="7492084">func</span><span class="op" id="7492088">(</span><span class="op" id="7492089">)</span>&nbsp;<span class="op" id="7492091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7492096">defer</span>&nbsp;<span class="ident" id="7492102">wg</span><span class="op" id="7492104">.</span><span class="ident" id="7492105">Done</span><span class="op" id="7492109">(</span><span class="op" id="7492110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7492115">if</span>&nbsp;<span class="ident" id="7492118">c</span><span class="op" id="7492119">,</span>&nbsp;<span class="ident" id="7492121">err</span>&nbsp;<span class="op" id="7492125">:=</span>&nbsp;<span class="ident" id="7492128">dialMulti</span><span class="op" id="7492137">(</span><span class="string" id="7492138">&#34;tcp&#34;</span><span class="op" id="7492143">,</span>&nbsp;<span class="string" id="7492145">&#34;fast&nbsp;failover&nbsp;test&#34;</span><span class="op" id="7492165">,</span>&nbsp;<span class="ident" id="7492167">nil</span><span class="op" id="7492170">,</span>&nbsp;<span class="ident" id="7492172">ras</span><span class="op" id="7492175">,</span>&nbsp;<span class="ident" id="7492177">time</span><span class="op" id="7492181">.</span><span class="ident" id="7492182">Now</span><span class="op" id="7492185">(</span><span class="op" id="7492186">)</span><span class="op" id="7492187">.</span><span class="ident" id="7492188">Add</span><span class="op" id="7492191">(</span><span class="ident" id="7492192">T1</span><span class="op" id="7492194">)</span><span class="op" id="7492195">)</span><span class="op" id="7492196">;</span>&nbsp;<span class="ident" id="7492198">err</span>&nbsp;<span class="op" id="7492202">==</span>&nbsp;<span class="ident" id="7492205">nil</span>&nbsp;<span class="op" id="7492209">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7492215">c</span><span class="op" id="7492216">.</span><span class="ident" id="7492217">Close</span><span class="op" id="7492222">(</span><span class="op" id="7492223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7492228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7492232">}</span><span class="op" id="7492233">(</span><span class="op" id="7492234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7492237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7492240">wg</span><span class="op" id="7492242">.</span><span class="ident" id="7492243">Wait</span><span class="op" id="7492247">(</span><span class="op" id="7492248">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7492251">time</span><span class="op" id="7492255">.</span><span class="ident" id="7492256">Sleep</span><span class="op" id="7492261">(</span><span class="ident" id="7492262">T2</span><span class="op" id="7492264">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7492268">ntcp</span><span class="op" id="7492272">,</span>&nbsp;<span class="ident" id="7492274">after</span><span class="op" id="7492279">,</span>&nbsp;<span class="ident" id="7492281">nclose</span><span class="op" id="7492287">,</span>&nbsp;<span class="ident" id="7492289">err</span>&nbsp;<span class="op" id="7492293">:=</span>&nbsp;<span class="ident" id="7492296">numTCP</span><span class="op" id="7492302">(</span><span class="op" id="7492303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7492306">if</span>&nbsp;<span class="ident" id="7492309">err</span>&nbsp;<span class="op" id="7492313">!=</span>&nbsp;<span class="ident" id="7492316">nil</span>&nbsp;<span class="op" id="7492320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7492324">t</span><span class="op" id="7492325">.</span><span class="ident" id="7492326">Skipf</span><span class="op" id="7492331">(</span><span class="string" id="7492332">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="7492382">,</span>&nbsp;<span class="ident" id="7492384">err</span><span class="op" id="7492387">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7492390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7492393">t</span><span class="op" id="7492394">.</span><span class="ident" id="7492395">Logf</span><span class="op" id="7492399">(</span><span class="string" id="7492400">&#34;tcp&nbsp;sessions:&nbsp;%v,&nbsp;open&nbsp;sessions:&nbsp;%v,&nbsp;closing&nbsp;sessions:&nbsp;%v&#34;</span><span class="op" id="7492459">,</span>&nbsp;<span class="ident" id="7492461">ntcp</span><span class="op" id="7492465">,</span>&nbsp;<span class="ident" id="7492467">after</span><span class="op" id="7492472">,</span>&nbsp;<span class="ident" id="7492474">nclose</span><span class="op" id="7492480">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7492484">if</span>&nbsp;<span class="ident" id="7492487">after</span>&nbsp;<span class="op" id="7492493">!=</span>&nbsp;<span class="ident" id="7492496">before</span>&nbsp;<span class="op" id="7492503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7492507">t</span><span class="op" id="7492508">.</span><span class="ident" id="7492509">Fatalf</span><span class="op" id="7492515">(</span><span class="string" id="7492516">&#34;got&nbsp;%v&nbsp;open&nbsp;sessions;&nbsp;expected&nbsp;%v&#34;</span><span class="op" id="7492551">,</span>&nbsp;<span class="ident" id="7492553">after</span><span class="op" id="7492558">,</span>&nbsp;<span class="ident" id="7492560">before</span><span class="op" id="7492566">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7492569">}</span><br>
<span class="lineno"></span><span class="op" id="7492571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7492574">func</span>&nbsp;<span class="ident" id="7492579">numFD</span><span class="op" id="7492584">(</span><span class="op" id="7492585">)</span>&nbsp;<span class="builtintype" id="7492587">int</span>&nbsp;<span class="op" id="7492591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7492594">if</span>&nbsp;<span class="ident" id="7492597">runtime</span><span class="op" id="7492604">.</span><span class="ident" id="7492605">GOOS</span>&nbsp;<span class="op" id="7492610">==</span>&nbsp;<span class="string" id="7492613">&#34;linux&#34;</span>&nbsp;<span class="op" id="7492621">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7492625">f</span><span class="op" id="7492626">,</span>&nbsp;<span class="ident" id="7492628">err</span>&nbsp;<span class="op" id="7492632">:=</span>&nbsp;<span class="ident" id="7492635">os</span><span class="op" id="7492637">.</span><span class="ident" id="7492638">Open</span><span class="op" id="7492642">(</span><span class="string" id="7492643">&#34;/proc/self/fd&#34;</span><span class="op" id="7492658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7492662">if</span>&nbsp;<span class="ident" id="7492665">err</span>&nbsp;<span class="op" id="7492669">!=</span>&nbsp;<span class="ident" id="7492672">nil</span>&nbsp;<span class="op" id="7492676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7492681">panic</span><span class="op" id="7492686">(</span><span class="ident" id="7492687">err</span><span class="op" id="7492690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7492694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7492698">defer</span>&nbsp;<span class="ident" id="7492704">f</span><span class="op" id="7492705">.</span><span class="ident" id="7492706">Close</span><span class="op" id="7492711">(</span><span class="op" id="7492712">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7492716">names</span><span class="op" id="7492721">,</span>&nbsp;<span class="ident" id="7492723">err</span>&nbsp;<span class="op" id="7492727">:=</span>&nbsp;<span class="ident" id="7492730">f</span><span class="op" id="7492731">.</span><span class="ident" id="7492732">Readdirnames</span><span class="op" id="7492744">(</span><span class="num" id="7492745">0</span><span class="op" id="7492746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7492750">if</span>&nbsp;<span class="ident" id="7492753">err</span>&nbsp;<span class="op" id="7492757">!=</span>&nbsp;<span class="ident" id="7492760">nil</span>&nbsp;<span class="op" id="7492764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7492769">panic</span><span class="op" id="7492774">(</span><span class="ident" id="7492775">err</span><span class="op" id="7492778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7492782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7492786">return</span>&nbsp;<span class="builtinfunc" id="7492793">len</span><span class="op" id="7492796">(</span><span class="ident" id="7492797">names</span><span class="op" id="7492802">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7492805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7492808">//&nbsp;All&nbsp;tests&nbsp;using&nbsp;this&nbsp;should&nbsp;be&nbsp;skipped&nbsp;anyway,&nbsp;but:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7492864">panic</span><span class="op" id="7492869">(</span><span class="string" id="7492870">&#34;numFDs&nbsp;not&nbsp;implemented&nbsp;on&nbsp;&#34;</span>&nbsp;<span class="op" id="7492899">+</span>&nbsp;<span class="ident" id="7492901">runtime</span><span class="op" id="7492908">.</span><span class="ident" id="7492909">GOOS</span><span class="op" id="7492913">)</span><br>
<span class="lineno"></span><span class="op" id="7492915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="7492918">func</span>&nbsp;<span class="ident" id="7492923">TestDialer</span><span class="op" id="7492933">(</span><span class="ident" id="7492934">t</span>&nbsp;<span class="op" id="7492936">*</span><span class="ident" id="7492937">testing</span><span class="op" id="7492944">.</span><span class="ident" id="7492945">T</span><span class="op" id="7492946">)</span>&nbsp;<span class="op" id="7492948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7492951">ln</span><span class="op" id="7492953">,</span>&nbsp;<span class="ident" id="7492955">err</span>&nbsp;<span class="op" id="7492959">:=</span>&nbsp;<span class="ident" id="7492962">Listen</span><span class="op" id="7492968">(</span><span class="string" id="7492969">&#34;tcp4&#34;</span><span class="op" id="7492975">,</span>&nbsp;<span class="string" id="7492977">&#34;127.0.0.1:0&#34;</span><span class="op" id="7492990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7492993">if</span>&nbsp;<span class="ident" id="7492996">err</span>&nbsp;<span class="op" id="7493000">!=</span>&nbsp;<span class="ident" id="7493003">nil</span>&nbsp;<span class="op" id="7493007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7493011">t</span><span class="op" id="7493012">.</span><span class="ident" id="7493013">Fatalf</span><span class="op" id="7493019">(</span><span class="string" id="7493020">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7493039">,</span>&nbsp;<span class="ident" id="7493041">err</span><span class="op" id="7493044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7493047">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7493050">defer</span>&nbsp;<span class="ident" id="7493056">ln</span><span class="op" id="7493058">.</span><span class="ident" id="7493059">Close</span><span class="op" id="7493064">(</span><span class="op" id="7493065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7493068">ch</span>&nbsp;<span class="op" id="7493071">:=</span>&nbsp;<span class="builtinfunc" id="7493074">make</span><span class="op" id="7493078">(</span><span class="keyword" id="7493079">chan</span>&nbsp;<span class="builtintype" id="7493084">error</span><span class="op" id="7493089">,</span>&nbsp;<span class="num" id="7493091">1</span><span class="op" id="7493092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7493095">go</span>&nbsp;<span class="keyword" id="7493098">func</span><span class="op" id="7493102">(</span><span class="op" id="7493103">)</span>&nbsp;<span class="op" id="7493105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7493109">c</span><span class="op" id="7493110">,</span>&nbsp;<span class="ident" id="7493112">err</span>&nbsp;<span class="op" id="7493116">:=</span>&nbsp;<span class="ident" id="7493119">ln</span><span class="op" id="7493121">.</span><span class="ident" id="7493122">Accept</span><span class="op" id="7493128">(</span><span class="op" id="7493129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7493133">if</span>&nbsp;<span class="ident" id="7493136">err</span>&nbsp;<span class="op" id="7493140">!=</span>&nbsp;<span class="ident" id="7493143">nil</span>&nbsp;<span class="op" id="7493147">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7493152">ch</span>&nbsp;<span class="op" id="7493155">&lt;-</span>&nbsp;<span class="ident" id="7493158">fmt</span><span class="op" id="7493161">.</span><span class="ident" id="7493162">Errorf</span><span class="op" id="7493168">(</span><span class="string" id="7493169">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7493188">,</span>&nbsp;<span class="ident" id="7493190">err</span><span class="op" id="7493193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7493198">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7493207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7493211">defer</span>&nbsp;<span class="ident" id="7493217">c</span><span class="op" id="7493218">.</span><span class="ident" id="7493219">Close</span><span class="op" id="7493224">(</span><span class="op" id="7493225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7493229">ch</span>&nbsp;<span class="op" id="7493232">&lt;-</span>&nbsp;<span class="ident" id="7493235">nil</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7493240">}</span><span class="op" id="7493241">(</span><span class="op" id="7493242">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7493246">laddr</span><span class="op" id="7493251">,</span>&nbsp;<span class="ident" id="7493253">err</span>&nbsp;<span class="op" id="7493257">:=</span>&nbsp;<span class="ident" id="7493260">ResolveTCPAddr</span><span class="op" id="7493274">(</span><span class="string" id="7493275">&#34;tcp4&#34;</span><span class="op" id="7493281">,</span>&nbsp;<span class="string" id="7493283">&#34;127.0.0.1:0&#34;</span><span class="op" id="7493296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7493299">if</span>&nbsp;<span class="ident" id="7493302">err</span>&nbsp;<span class="op" id="7493306">!=</span>&nbsp;<span class="ident" id="7493309">nil</span>&nbsp;<span class="op" id="7493313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7493317">t</span><span class="op" id="7493318">.</span><span class="ident" id="7493319">Fatalf</span><span class="op" id="7493325">(</span><span class="string" id="7493326">&#34;ResolveTCPAddr&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7493353">,</span>&nbsp;<span class="ident" id="7493355">err</span><span class="op" id="7493358">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7493361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7493364">d</span>&nbsp;<span class="op" id="7493366">:=</span>&nbsp;<span class="op" id="7493369">&amp;</span><span class="ident" id="7493370">Dialer</span><span class="op" id="7493376">{</span><span class="ident" id="7493377">LocalAddr</span><span class="op" id="7493386">:</span>&nbsp;<span class="ident" id="7493388">laddr</span><span class="op" id="7493393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7493396">c</span><span class="op" id="7493397">,</span>&nbsp;<span class="ident" id="7493399">err</span>&nbsp;<span class="op" id="7493403">:=</span>&nbsp;<span class="ident" id="7493406">d</span><span class="op" id="7493407">.</span><span class="ident" id="7493408">Dial</span><span class="op" id="7493412">(</span><span class="string" id="7493413">&#34;tcp4&#34;</span><span class="op" id="7493419">,</span>&nbsp;<span class="ident" id="7493421">ln</span><span class="op" id="7493423">.</span><span class="ident" id="7493424">Addr</span><span class="op" id="7493428">(</span><span class="op" id="7493429">)</span><span class="op" id="7493430">.</span><span class="ident" id="7493431">String</span><span class="op" id="7493437">(</span><span class="op" id="7493438">)</span><span class="op" id="7493439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7493442">if</span>&nbsp;<span class="ident" id="7493445">err</span>&nbsp;<span class="op" id="7493449">!=</span>&nbsp;<span class="ident" id="7493452">nil</span>&nbsp;<span class="op" id="7493456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7493460">t</span><span class="op" id="7493461">.</span><span class="ident" id="7493462">Fatalf</span><span class="op" id="7493468">(</span><span class="string" id="7493469">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7493486">,</span>&nbsp;<span class="ident" id="7493488">err</span><span class="op" id="7493491">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7493494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7493497">defer</span>&nbsp;<span class="ident" id="7493503">c</span><span class="op" id="7493504">.</span><span class="ident" id="7493505">Close</span><span class="op" id="7493510">(</span><span class="op" id="7493511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7493514">c</span><span class="op" id="7493515">.</span><span class="ident" id="7493516">Read</span><span class="op" id="7493520">(</span><span class="builtinfunc" id="7493521">make</span><span class="op" id="7493525">(</span><span class="op" id="7493526">[</span><span class="op" id="7493527">]</span><span class="builtintype" id="7493528">byte</span><span class="op" id="7493532">,</span>&nbsp;<span class="num" id="7493534">1</span><span class="op" id="7493535">)</span><span class="op" id="7493536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7493539">err</span>&nbsp;<span class="op" id="7493543">=</span>&nbsp;<span class="op" id="7493545">&lt;-</span><span class="ident" id="7493547">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7493551">if</span>&nbsp;<span class="ident" id="7493554">err</span>&nbsp;<span class="op" id="7493558">!=</span>&nbsp;<span class="ident" id="7493561">nil</span>&nbsp;<span class="op" id="7493565">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7493569">t</span><span class="op" id="7493570">.</span><span class="ident" id="7493571">Error</span><span class="op" id="7493576">(</span><span class="ident" id="7493577">err</span><span class="op" id="7493580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7493583">}</span><br>
<span class="lineno"></span><span class="op" id="7493585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7493588">func</span>&nbsp;<span class="ident" id="7493593">TestDialDualStackLocalhost</span><span class="op" id="7493619">(</span><span class="ident" id="7493620">t</span>&nbsp;<span class="op" id="7493622">*</span><span class="ident" id="7493623">testing</span><span class="op" id="7493630">.</span><span class="ident" id="7493631">T</span><span class="op" id="7493632">)</span>&nbsp;<span class="op" id="7493634">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7493637">switch</span>&nbsp;<span class="ident" id="7493644">runtime</span><span class="op" id="7493651">.</span><span class="ident" id="7493652">GOOS</span>&nbsp;<span class="op" id="7493657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7493660">case</span>&nbsp;<span class="string" id="7493665">&#34;nacl&#34;</span><span class="op" id="7493671">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7493675">t</span><span class="op" id="7493676">.</span><span class="ident" id="7493677">Skipf</span><span class="op" id="7493682">(</span><span class="string" id="7493683">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7493704">,</span>&nbsp;<span class="ident" id="7493706">runtime</span><span class="op" id="7493713">.</span><span class="ident" id="7493714">GOOS</span><span class="op" id="7493718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7493721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7493725">if</span>&nbsp;<span class="ident" id="7493728">ips</span><span class="op" id="7493731">,</span>&nbsp;<span class="ident" id="7493733">err</span>&nbsp;<span class="op" id="7493737">:=</span>&nbsp;<span class="ident" id="7493740">LookupIP</span><span class="op" id="7493748">(</span><span class="string" id="7493749">&#34;localhost&#34;</span><span class="op" id="7493760">)</span><span class="op" id="7493761">;</span>&nbsp;<span class="ident" id="7493763">err</span>&nbsp;<span class="op" id="7493767">!=</span>&nbsp;<span class="ident" id="7493770">nil</span>&nbsp;<span class="op" id="7493774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7493778">t</span><span class="op" id="7493779">.</span><span class="ident" id="7493780">Fatalf</span><span class="op" id="7493786">(</span><span class="string" id="7493787">&#34;LookupIP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7493808">,</span>&nbsp;<span class="ident" id="7493810">err</span><span class="op" id="7493813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7493816">}</span>&nbsp;<span class="keyword" id="7493818">else</span>&nbsp;<span class="keyword" id="7493823">if</span>&nbsp;<span class="builtinfunc" id="7493826">len</span><span class="op" id="7493829">(</span><span class="ident" id="7493830">ips</span><span class="op" id="7493833">)</span>&nbsp;<span class="op" id="7493835">&lt;</span>&nbsp;<span class="num" id="7493837">2</span>&nbsp;<span class="op" id="7493839">||</span>&nbsp;<span class="op" id="7493842">!</span><span class="ident" id="7493843">supportsIPv4</span>&nbsp;<span class="op" id="7493856">||</span>&nbsp;<span class="op" id="7493859">!</span><span class="ident" id="7493860">supportsIPv6</span>&nbsp;<span class="op" id="7493873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7493877">t</span><span class="op" id="7493878">.</span><span class="ident" id="7493879">Skip</span><span class="op" id="7493883">(</span><span class="string" id="7493884">&#34;localhost&nbsp;doesn&#39;t&nbsp;have&nbsp;a&nbsp;pair&nbsp;of&nbsp;different&nbsp;address&nbsp;family&nbsp;IP&nbsp;addresses&#34;</span><span class="op" id="7493956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7493959">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7493963">touchAndByeServer</span>&nbsp;<span class="op" id="7493981">:=</span>&nbsp;<span class="keyword" id="7493984">func</span><span class="op" id="7493988">(</span><span class="ident" id="7493989">dss</span>&nbsp;<span class="op" id="7493993">*</span><span class="ident" id="7493994">dualStackServer</span><span class="op" id="7494009">,</span>&nbsp;<span class="ident" id="7494011">ln</span>&nbsp;<span class="ident" id="7494014">Listener</span><span class="op" id="7494022">)</span>&nbsp;<span class="op" id="7494024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7494028">for</span>&nbsp;<span class="op" id="7494032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7494037">if</span>&nbsp;<span class="ident" id="7494040">c</span><span class="op" id="7494041">,</span>&nbsp;<span class="ident" id="7494043">err</span>&nbsp;<span class="op" id="7494047">:=</span>&nbsp;<span class="ident" id="7494050">ln</span><span class="op" id="7494052">.</span><span class="ident" id="7494053">Accept</span><span class="op" id="7494059">(</span><span class="op" id="7494060">)</span><span class="op" id="7494061">;</span>&nbsp;<span class="ident" id="7494063">err</span>&nbsp;<span class="op" id="7494067">!=</span>&nbsp;<span class="ident" id="7494070">nil</span>&nbsp;<span class="op" id="7494074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7494080">return</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7494090">}</span>&nbsp;<span class="keyword" id="7494092">else</span>&nbsp;<span class="op" id="7494097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7494103">c</span><span class="op" id="7494104">.</span><span class="ident" id="7494105">Close</span><span class="op" id="7494110">(</span><span class="op" id="7494111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7494116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7494120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7494123">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7494126">dss</span><span class="op" id="7494129">,</span>&nbsp;<span class="ident" id="7494131">err</span>&nbsp;<span class="op" id="7494135">:=</span>&nbsp;<span class="ident" id="7494138">newDualStackServer</span><span class="op" id="7494156">(</span><span class="op" id="7494157">[</span><span class="op" id="7494158">]</span><span class="ident" id="7494159">streamListener</span><span class="op" id="7494173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7494177">{</span><span class="ident" id="7494178">net</span><span class="op" id="7494181">:</span>&nbsp;<span class="string" id="7494183">&#34;tcp4&#34;</span><span class="op" id="7494189">,</span>&nbsp;<span class="ident" id="7494191">addr</span><span class="op" id="7494195">:</span>&nbsp;<span class="string" id="7494197">&#34;127.0.0.1&#34;</span><span class="op" id="7494208">}</span><span class="op" id="7494209">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7494213">{</span><span class="ident" id="7494214">net</span><span class="op" id="7494217">:</span>&nbsp;<span class="string" id="7494219">&#34;tcp6&#34;</span><span class="op" id="7494225">,</span>&nbsp;<span class="ident" id="7494227">addr</span><span class="op" id="7494231">:</span>&nbsp;<span class="string" id="7494233">&#34;[::1]&#34;</span><span class="op" id="7494240">}</span><span class="op" id="7494241">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7494244">}</span><span class="op" id="7494245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7494248">if</span>&nbsp;<span class="ident" id="7494251">err</span>&nbsp;<span class="op" id="7494255">!=</span>&nbsp;<span class="ident" id="7494258">nil</span>&nbsp;<span class="op" id="7494262">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7494266">t</span><span class="op" id="7494267">.</span><span class="ident" id="7494268">Fatalf</span><span class="op" id="7494274">(</span><span class="string" id="7494275">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7494306">,</span>&nbsp;<span class="ident" id="7494308">err</span><span class="op" id="7494311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7494314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7494317">defer</span>&nbsp;<span class="ident" id="7494323">dss</span><span class="op" id="7494326">.</span><span class="ident" id="7494327">teardown</span><span class="op" id="7494335">(</span><span class="op" id="7494336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7494339">if</span>&nbsp;<span class="ident" id="7494342">err</span>&nbsp;<span class="op" id="7494346">:=</span>&nbsp;<span class="ident" id="7494349">dss</span><span class="op" id="7494352">.</span><span class="ident" id="7494353">buildup</span><span class="op" id="7494360">(</span><span class="ident" id="7494361">touchAndByeServer</span><span class="op" id="7494378">)</span><span class="op" id="7494379">;</span>&nbsp;<span class="ident" id="7494381">err</span>&nbsp;<span class="op" id="7494385">!=</span>&nbsp;<span class="ident" id="7494388">nil</span>&nbsp;<span class="op" id="7494392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7494396">t</span><span class="op" id="7494397">.</span><span class="ident" id="7494398">Fatalf</span><span class="op" id="7494404">(</span><span class="string" id="7494405">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7494441">,</span>&nbsp;<span class="ident" id="7494443">err</span><span class="op" id="7494446">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7494449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7494453">d</span>&nbsp;<span class="op" id="7494455">:=</span>&nbsp;<span class="op" id="7494458">&amp;</span><span class="ident" id="7494459">Dialer</span><span class="op" id="7494465">{</span><span class="ident" id="7494466">DualStack</span><span class="op" id="7494475">:</span>&nbsp;<span class="builtintype" id="7494477">true</span><span class="op" id="7494481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7494484">for</span>&nbsp;<span class="keyword" id="7494488">range</span>&nbsp;<span class="ident" id="7494494">dss</span><span class="op" id="7494497">.</span><span class="ident" id="7494498">lns</span>&nbsp;<span class="op" id="7494502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7494506">if</span>&nbsp;<span class="ident" id="7494509">c</span><span class="op" id="7494510">,</span>&nbsp;<span class="ident" id="7494512">err</span>&nbsp;<span class="op" id="7494516">:=</span>&nbsp;<span class="ident" id="7494519">d</span><span class="op" id="7494520">.</span><span class="ident" id="7494521">Dial</span><span class="op" id="7494525">(</span><span class="string" id="7494526">&#34;tcp&#34;</span><span class="op" id="7494531">,</span>&nbsp;<span class="string" id="7494533">&#34;localhost:&#34;</span><span class="op" id="7494545">+</span><span class="ident" id="7494546">dss</span><span class="op" id="7494549">.</span><span class="ident" id="7494550">port</span><span class="op" id="7494554">)</span><span class="op" id="7494555">;</span>&nbsp;<span class="ident" id="7494557">err</span>&nbsp;<span class="op" id="7494561">!=</span>&nbsp;<span class="ident" id="7494564">nil</span>&nbsp;<span class="op" id="7494568">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7494573">t</span><span class="op" id="7494574">.</span><span class="ident" id="7494575">Errorf</span><span class="op" id="7494581">(</span><span class="string" id="7494582">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7494599">,</span>&nbsp;<span class="ident" id="7494601">err</span><span class="op" id="7494604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7494608">}</span>&nbsp;<span class="keyword" id="7494610">else</span>&nbsp;<span class="op" id="7494615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7494620">if</span>&nbsp;<span class="ident" id="7494623">addr</span>&nbsp;<span class="op" id="7494628">:=</span>&nbsp;<span class="ident" id="7494631">c</span><span class="op" id="7494632">.</span><span class="ident" id="7494633">LocalAddr</span><span class="op" id="7494642">(</span><span class="op" id="7494643">)</span><span class="op" id="7494644">.</span><span class="op" id="7494645">(</span><span class="op" id="7494646">*</span><span class="ident" id="7494647">TCPAddr</span><span class="op" id="7494654">)</span><span class="op" id="7494655">;</span>&nbsp;<span class="ident" id="7494657">addr</span><span class="op" id="7494661">.</span><span class="ident" id="7494662">IP</span><span class="op" id="7494664">.</span><span class="ident" id="7494665">To4</span><span class="op" id="7494668">(</span><span class="op" id="7494669">)</span>&nbsp;<span class="op" id="7494671">!=</span>&nbsp;<span class="ident" id="7494674">nil</span>&nbsp;<span class="op" id="7494678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7494684">dss</span><span class="op" id="7494687">.</span><span class="ident" id="7494688">teardownNetwork</span><span class="op" id="7494703">(</span><span class="string" id="7494704">&#34;tcp4&#34;</span><span class="op" id="7494710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7494715">}</span>&nbsp;<span class="keyword" id="7494717">else</span>&nbsp;<span class="keyword" id="7494722">if</span>&nbsp;<span class="ident" id="7494725">addr</span><span class="op" id="7494729">.</span><span class="ident" id="7494730">IP</span><span class="op" id="7494732">.</span><span class="ident" id="7494733">To16</span><span class="op" id="7494737">(</span><span class="op" id="7494738">)</span>&nbsp;<span class="op" id="7494740">!=</span>&nbsp;<span class="ident" id="7494743">nil</span>&nbsp;<span class="op" id="7494747">&amp;&amp;</span>&nbsp;<span class="ident" id="7494750">addr</span><span class="op" id="7494754">.</span><span class="ident" id="7494755">IP</span><span class="op" id="7494757">.</span><span class="ident" id="7494758">To4</span><span class="op" id="7494761">(</span><span class="op" id="7494762">)</span>&nbsp;<span class="op" id="7494764">==</span>&nbsp;<span class="ident" id="7494767">nil</span>&nbsp;<span class="op" id="7494771">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7494777">dss</span><span class="op" id="7494780">.</span><span class="ident" id="7494781">teardownNetwork</span><span class="op" id="7494796">(</span><span class="string" id="7494797">&#34;tcp6&#34;</span><span class="op" id="7494803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7494808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7494813">c</span><span class="op" id="7494814">.</span><span class="ident" id="7494815">Close</span><span class="op" id="7494820">(</span><span class="op" id="7494821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7494825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7494828">}</span><br>
<span class="lineno">515</span><span class="op" id="7494830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7494833">func</span>&nbsp;<span class="ident" id="7494838">TestDialerKeepAlive</span><span class="op" id="7494857">(</span><span class="ident" id="7494858">t</span>&nbsp;<span class="op" id="7494860">*</span><span class="ident" id="7494861">testing</span><span class="op" id="7494868">.</span><span class="ident" id="7494869">T</span><span class="op" id="7494870">)</span>&nbsp;<span class="op" id="7494872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7494875">ln</span>&nbsp;<span class="op" id="7494878">:=</span>&nbsp;<span class="ident" id="7494881">newLocalListener</span><span class="op" id="7494897">(</span><span class="ident" id="7494898">t</span><span class="op" id="7494899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7494902">defer</span>&nbsp;<span class="ident" id="7494908">ln</span><span class="op" id="7494910">.</span><span class="ident" id="7494911">Close</span><span class="op" id="7494916">(</span><span class="op" id="7494917">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7494920">defer</span>&nbsp;<span class="keyword" id="7494926">func</span><span class="op" id="7494930">(</span><span class="op" id="7494931">)</span>&nbsp;<span class="op" id="7494933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7494937">testHookSetKeepAlive</span>&nbsp;<span class="op" id="7494958">=</span>&nbsp;<span class="keyword" id="7494960">func</span><span class="op" id="7494964">(</span><span class="op" id="7494965">)</span>&nbsp;<span class="op" id="7494967">{</span><span class="op" id="7494968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7494971">}</span><span class="op" id="7494972">(</span><span class="op" id="7494973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7494976">go</span>&nbsp;<span class="keyword" id="7494979">func</span><span class="op" id="7494983">(</span><span class="op" id="7494984">)</span>&nbsp;<span class="op" id="7494986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7494990">for</span>&nbsp;<span class="op" id="7494994">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7494999">c</span><span class="op" id="7495000">,</span>&nbsp;<span class="ident" id="7495002">err</span>&nbsp;<span class="op" id="7495006">:=</span>&nbsp;<span class="ident" id="7495009">ln</span><span class="op" id="7495011">.</span><span class="ident" id="7495012">Accept</span><span class="op" id="7495018">(</span><span class="op" id="7495019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7495024">if</span>&nbsp;<span class="ident" id="7495027">err</span>&nbsp;<span class="op" id="7495031">!=</span>&nbsp;<span class="ident" id="7495034">nil</span>&nbsp;<span class="op" id="7495038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7495044">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7495054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7495059">c</span><span class="op" id="7495060">.</span><span class="ident" id="7495061">Close</span><span class="op" id="7495066">(</span><span class="op" id="7495067">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7495071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7495074">}</span><span class="op" id="7495075">(</span><span class="op" id="7495076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7495079">for</span>&nbsp;<span class="ident" id="7495083">_</span><span class="op" id="7495084">,</span>&nbsp;<span class="ident" id="7495086">keepAlive</span>&nbsp;<span class="op" id="7495096">:=</span>&nbsp;<span class="keyword" id="7495099">range</span>&nbsp;<span class="op" id="7495105">[</span><span class="op" id="7495106">]</span><span class="builtintype" id="7495107">bool</span><span class="op" id="7495111">{</span><span class="builtintype" id="7495112">false</span><span class="op" id="7495117">,</span>&nbsp;<span class="builtintype" id="7495119">true</span><span class="op" id="7495123">}</span>&nbsp;<span class="op" id="7495125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7495129">got</span>&nbsp;<span class="op" id="7495133">:=</span>&nbsp;<span class="builtintype" id="7495136">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7495144">testHookSetKeepAlive</span>&nbsp;<span class="op" id="7495165">=</span>&nbsp;<span class="keyword" id="7495167">func</span><span class="op" id="7495171">(</span><span class="op" id="7495172">)</span>&nbsp;<span class="op" id="7495174">{</span>&nbsp;<span class="ident" id="7495176">got</span>&nbsp;<span class="op" id="7495180">=</span>&nbsp;<span class="builtintype" id="7495182">true</span>&nbsp;<span class="op" id="7495187">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7495191">var</span>&nbsp;<span class="ident" id="7495195">d</span>&nbsp;<span class="ident" id="7495197">Dialer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7495206">if</span>&nbsp;<span class="ident" id="7495209">keepAlive</span>&nbsp;<span class="op" id="7495219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7495224">d</span><span class="op" id="7495225">.</span><span class="ident" id="7495226">KeepAlive</span>&nbsp;<span class="op" id="7495236">=</span>&nbsp;<span class="num" id="7495238">30</span>&nbsp;<span class="op" id="7495241">*</span>&nbsp;<span class="ident" id="7495243">time</span><span class="op" id="7495247">.</span><span class="ident" id="7495248">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7495257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7495261">c</span><span class="op" id="7495262">,</span>&nbsp;<span class="ident" id="7495264">err</span>&nbsp;<span class="op" id="7495268">:=</span>&nbsp;<span class="ident" id="7495271">d</span><span class="op" id="7495272">.</span><span class="ident" id="7495273">Dial</span><span class="op" id="7495277">(</span><span class="string" id="7495278">&#34;tcp&#34;</span><span class="op" id="7495283">,</span>&nbsp;<span class="ident" id="7495285">ln</span><span class="op" id="7495287">.</span><span class="ident" id="7495288">Addr</span><span class="op" id="7495292">(</span><span class="op" id="7495293">)</span><span class="op" id="7495294">.</span><span class="ident" id="7495295">String</span><span class="op" id="7495301">(</span><span class="op" id="7495302">)</span><span class="op" id="7495303">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7495307">if</span>&nbsp;<span class="ident" id="7495310">err</span>&nbsp;<span class="op" id="7495314">!=</span>&nbsp;<span class="ident" id="7495317">nil</span>&nbsp;<span class="op" id="7495321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7495326">t</span><span class="op" id="7495327">.</span><span class="ident" id="7495328">Fatal</span><span class="op" id="7495333">(</span><span class="ident" id="7495334">err</span><span class="op" id="7495337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7495341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7495345">c</span><span class="op" id="7495346">.</span><span class="ident" id="7495347">Close</span><span class="op" id="7495352">(</span><span class="op" id="7495353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7495357">if</span>&nbsp;<span class="ident" id="7495360">got</span>&nbsp;<span class="op" id="7495364">!=</span>&nbsp;<span class="ident" id="7495367">keepAlive</span>&nbsp;<span class="op" id="7495377">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7495382">t</span><span class="op" id="7495383">.</span><span class="ident" id="7495384">Errorf</span><span class="op" id="7495390">(</span><span class="string" id="7495391">&#34;Dialer.KeepAlive&nbsp;=&nbsp;%v:&nbsp;SetKeepAlive&nbsp;called&nbsp;=&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7495449">,</span>&nbsp;<span class="ident" id="7495451">d</span><span class="op" id="7495452">.</span><span class="ident" id="7495453">KeepAlive</span><span class="op" id="7495462">,</span>&nbsp;<span class="ident" id="7495464">got</span><span class="op" id="7495467">,</span>&nbsp;<span class="op" id="7495469">!</span><span class="ident" id="7495470">got</span><span class="op" id="7495473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7495477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7495480">}</span><br>
<span class="lineno"></span><span class="op" id="7495482">}</span>
</div>
</body>
</html>
