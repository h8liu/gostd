<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>regexp</h2>
<ul>
<li><a href="/gostd/regexp/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/regexp/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/regexp/exec.go.html">exec.go</a></li>
<li><a href="/gostd/regexp/exec2_test.go.html">exec2_test.go</a></li>
<li><a href="/gostd/regexp/exec_test.go.html">exec_test.go</a></li>
<li><a href="/gostd/regexp/find_test.go.html">find_test.go</a></li>
<li><a href="/gostd/regexp/onepass.go.html">onepass.go</a></li>
<li><a href="/gostd/regexp/onepass_test.go.html">onepass_test.go</a></li>
<li><a href="/gostd/regexp/regexp.go.html">regexp.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3341834">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3341890">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3341944">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3341995">package</span>&nbsp;<span class="ident" id="3342003">regexp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3342011">import</span>&nbsp;<span class="op" id="3342018">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3342021">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3342030">&#34;regexp/syntax&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3342047">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3342055">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op" id="3342065">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3342068">//&nbsp;&#34;One-pass&#34;&nbsp;regexp&nbsp;execution.</span><br>
<span class="lineno">15</span><span class="comment" id="3342100">//&nbsp;Some&nbsp;regexps&nbsp;can&nbsp;be&nbsp;analyzed&nbsp;to&nbsp;determine&nbsp;that&nbsp;they&nbsp;never&nbsp;need</span><br>
<span class="lineno"></span><span class="comment" id="3342166">//&nbsp;backtracking:&nbsp;they&nbsp;are&nbsp;guaranteed&nbsp;to&nbsp;run&nbsp;in&nbsp;one&nbsp;pass&nbsp;over&nbsp;the&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="3342238">//&nbsp;without&nbsp;bothering&nbsp;to&nbsp;save&nbsp;all&nbsp;the&nbsp;usual&nbsp;NFA&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="3342292">//&nbsp;Detect&nbsp;those&nbsp;and&nbsp;execute&nbsp;them&nbsp;more&nbsp;quickly.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="3342340">//&nbsp;A&nbsp;onePassProg&nbsp;is&nbsp;a&nbsp;compiled&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="3342408">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Prog&nbsp;except&nbsp;for&nbsp;the&nbsp;use&nbsp;of&nbsp;onePassInst.</span><br>
<span class="lineno"></span><span class="keyword" id="3342476">type</span>&nbsp;<span class="ident" id="3342481">onePassProg</span>&nbsp;<span class="keyword" id="3342493">struct</span>&nbsp;<span class="op" id="3342500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3342503">Inst</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3342510">[</span><span class="op" id="3342511">]</span><span class="ident" id="3342512">onePassInst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3342525">Start</span>&nbsp;&nbsp;<span class="builtintype" id="3342532">int</span>&nbsp;<span class="comment" id="3342536">//&nbsp;index&nbsp;of&nbsp;start&nbsp;instruction</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3342567">NumCap</span>&nbsp;<span class="builtintype" id="3342574">int</span>&nbsp;<span class="comment" id="3342578">//&nbsp;number&nbsp;of&nbsp;InstCapture&nbsp;insts&nbsp;in&nbsp;re</span><br>
<span class="lineno"></span><span class="op" id="3342615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3342618">//&nbsp;A&nbsp;onePassInst&nbsp;is&nbsp;a&nbsp;single&nbsp;instruction&nbsp;in&nbsp;a&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="3342701">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Inst&nbsp;except&nbsp;for&nbsp;the&nbsp;new&nbsp;&#39;Next&#39;&nbsp;field.</span><br>
<span class="lineno">30</span><span class="keyword" id="3342767">type</span>&nbsp;<span class="ident" id="3342772">onePassInst</span>&nbsp;<span class="keyword" id="3342784">struct</span>&nbsp;<span class="op" id="3342791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3342794">syntax</span><span class="op" id="3342800">.</span><span class="ident" id="3342801">Inst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3342807">Next</span>&nbsp;<span class="op" id="3342812">[</span><span class="op" id="3342813">]</span><span class="builtintype" id="3342814">uint32</span><br>
<span class="lineno"></span><span class="op" id="3342821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="3342824">//&nbsp;OnePassPrefix&nbsp;returns&nbsp;a&nbsp;literal&nbsp;string&nbsp;that&nbsp;all&nbsp;matches&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3342891">//&nbsp;regexp&nbsp;must&nbsp;start&nbsp;with.&nbsp;&nbsp;Complete&nbsp;is&nbsp;true&nbsp;if&nbsp;the&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="3342950">//&nbsp;is&nbsp;the&nbsp;entire&nbsp;match.&nbsp;Pc&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;last&nbsp;rune&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="3343019">//&nbsp;in&nbsp;the&nbsp;string.&nbsp;The&nbsp;OnePassPrefix&nbsp;skips&nbsp;over&nbsp;the&nbsp;mandatory</span><br>
<span class="lineno"></span><span class="comment" id="3343080">//&nbsp;EmptyBeginText</span><br>
<span class="lineno">40</span><span class="keyword" id="3343098">func</span>&nbsp;<span class="ident" id="3343103">onePassPrefix</span><span class="op" id="3343116">(</span><span class="ident" id="3343117">p</span>&nbsp;<span class="op" id="3343119">*</span><span class="ident" id="3343120">syntax</span><span class="op" id="3343126">.</span><span class="ident" id="3343127">Prog</span><span class="op" id="3343131">)</span>&nbsp;<span class="op" id="3343133">(</span><span class="ident" id="3343134">prefix</span>&nbsp;<span class="builtintype" id="3343141">string</span><span class="op" id="3343147">,</span>&nbsp;<span class="ident" id="3343149">complete</span>&nbsp;<span class="builtintype" id="3343158">bool</span><span class="op" id="3343162">,</span>&nbsp;<span class="ident" id="3343164">pc</span>&nbsp;<span class="builtintype" id="3343167">uint32</span><span class="op" id="3343173">)</span>&nbsp;<span class="op" id="3343175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3343178">i</span>&nbsp;<span class="op" id="3343180">:=</span>&nbsp;<span class="op" id="3343183">&amp;</span><span class="ident" id="3343184">p</span><span class="op" id="3343185">.</span><span class="ident" id="3343186">Inst</span><span class="op" id="3343190">[</span><span class="ident" id="3343191">p</span><span class="op" id="3343192">.</span><span class="ident" id="3343193">Start</span><span class="op" id="3343198">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3343201">if</span>&nbsp;<span class="ident" id="3343204">i</span><span class="op" id="3343205">.</span><span class="ident" id="3343206">Op</span>&nbsp;<span class="op" id="3343209">!=</span>&nbsp;<span class="ident" id="3343212">syntax</span><span class="op" id="3343218">.</span><span class="ident" id="3343219">InstEmptyWidth</span>&nbsp;<span class="op" id="3343234">||</span>&nbsp;<span class="op" id="3343237">(</span><span class="ident" id="3343238">syntax</span><span class="op" id="3343244">.</span><span class="ident" id="3343245">EmptyOp</span><span class="op" id="3343252">(</span><span class="ident" id="3343253">i</span><span class="op" id="3343254">.</span><span class="ident" id="3343255">Arg</span><span class="op" id="3343258">)</span><span class="op" id="3343259">)</span><span class="op" id="3343260">&amp;</span><span class="ident" id="3343261">syntax</span><span class="op" id="3343267">.</span><span class="ident" id="3343268">EmptyBeginText</span>&nbsp;<span class="op" id="3343283">==</span>&nbsp;<span class="num" id="3343286">0</span>&nbsp;<span class="op" id="3343288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3343292">return</span>&nbsp;<span class="string" id="3343299">&#34;&#34;</span><span class="op" id="3343301">,</span>&nbsp;<span class="ident" id="3343303">i</span><span class="op" id="3343304">.</span><span class="ident" id="3343305">Op</span>&nbsp;<span class="op" id="3343308">==</span>&nbsp;<span class="ident" id="3343311">syntax</span><span class="op" id="3343317">.</span><span class="ident" id="3343318">InstMatch</span><span class="op" id="3343327">,</span>&nbsp;<span class="builtintype" id="3343329">uint32</span><span class="op" id="3343335">(</span><span class="ident" id="3343336">p</span><span class="op" id="3343337">.</span><span class="ident" id="3343338">Start</span><span class="op" id="3343343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3343346">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3343349">pc</span>&nbsp;<span class="op" id="3343352">=</span>&nbsp;<span class="ident" id="3343354">i</span><span class="op" id="3343355">.</span><span class="ident" id="3343356">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3343361">i</span>&nbsp;<span class="op" id="3343363">=</span>&nbsp;<span class="op" id="3343365">&amp;</span><span class="ident" id="3343366">p</span><span class="op" id="3343367">.</span><span class="ident" id="3343368">Inst</span><span class="op" id="3343372">[</span><span class="ident" id="3343373">pc</span><span class="op" id="3343375">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3343378">for</span>&nbsp;<span class="ident" id="3343382">i</span><span class="op" id="3343383">.</span><span class="ident" id="3343384">Op</span>&nbsp;<span class="op" id="3343387">==</span>&nbsp;<span class="ident" id="3343390">syntax</span><span class="op" id="3343396">.</span><span class="ident" id="3343397">InstNop</span>&nbsp;<span class="op" id="3343405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3343409">pc</span>&nbsp;<span class="op" id="3343412">=</span>&nbsp;<span class="ident" id="3343414">i</span><span class="op" id="3343415">.</span><span class="ident" id="3343416">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3343422">i</span>&nbsp;<span class="op" id="3343424">=</span>&nbsp;<span class="op" id="3343426">&amp;</span><span class="ident" id="3343427">p</span><span class="op" id="3343428">.</span><span class="ident" id="3343429">Inst</span><span class="op" id="3343433">[</span><span class="ident" id="3343434">pc</span><span class="op" id="3343436">]</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3343439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3343442">//&nbsp;Avoid&nbsp;allocation&nbsp;of&nbsp;buffer&nbsp;if&nbsp;prefix&nbsp;is&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3343493">if</span>&nbsp;<span class="ident" id="3343496">iop</span><span class="op" id="3343499">(</span><span class="ident" id="3343500">i</span><span class="op" id="3343501">)</span>&nbsp;<span class="op" id="3343503">!=</span>&nbsp;<span class="ident" id="3343506">syntax</span><span class="op" id="3343512">.</span><span class="ident" id="3343513">InstRune</span>&nbsp;<span class="op" id="3343522">||</span>&nbsp;<span class="builtinfunc" id="3343525">len</span><span class="op" id="3343528">(</span><span class="ident" id="3343529">i</span><span class="op" id="3343530">.</span><span class="ident" id="3343531">Rune</span><span class="op" id="3343535">)</span>&nbsp;<span class="op" id="3343537">!=</span>&nbsp;<span class="num" id="3343540">1</span>&nbsp;<span class="op" id="3343542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3343546">return</span>&nbsp;<span class="string" id="3343553">&#34;&#34;</span><span class="op" id="3343555">,</span>&nbsp;<span class="ident" id="3343557">i</span><span class="op" id="3343558">.</span><span class="ident" id="3343559">Op</span>&nbsp;<span class="op" id="3343562">==</span>&nbsp;<span class="ident" id="3343565">syntax</span><span class="op" id="3343571">.</span><span class="ident" id="3343572">InstMatch</span><span class="op" id="3343581">,</span>&nbsp;<span class="builtintype" id="3343583">uint32</span><span class="op" id="3343589">(</span><span class="ident" id="3343590">p</span><span class="op" id="3343591">.</span><span class="ident" id="3343592">Start</span><span class="op" id="3343597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3343600">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3343604">//&nbsp;Have&nbsp;prefix;&nbsp;gather&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3343640">var</span>&nbsp;<span class="ident" id="3343644">buf</span>&nbsp;<span class="ident" id="3343648">bytes</span><span class="op" id="3343653">.</span><span class="ident" id="3343654">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3343662">for</span>&nbsp;<span class="ident" id="3343666">iop</span><span class="op" id="3343669">(</span><span class="ident" id="3343670">i</span><span class="op" id="3343671">)</span>&nbsp;<span class="op" id="3343673">==</span>&nbsp;<span class="ident" id="3343676">syntax</span><span class="op" id="3343682">.</span><span class="ident" id="3343683">InstRune</span>&nbsp;<span class="op" id="3343692">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3343695">len</span><span class="op" id="3343698">(</span><span class="ident" id="3343699">i</span><span class="op" id="3343700">.</span><span class="ident" id="3343701">Rune</span><span class="op" id="3343705">)</span>&nbsp;<span class="op" id="3343707">==</span>&nbsp;<span class="num" id="3343710">1</span>&nbsp;<span class="op" id="3343712">&amp;&amp;</span>&nbsp;<span class="ident" id="3343715">syntax</span><span class="op" id="3343721">.</span><span class="ident" id="3343722">Flags</span><span class="op" id="3343727">(</span><span class="ident" id="3343728">i</span><span class="op" id="3343729">.</span><span class="ident" id="3343730">Arg</span><span class="op" id="3343733">)</span><span class="op" id="3343734">&amp;</span><span class="ident" id="3343735">syntax</span><span class="op" id="3343741">.</span><span class="ident" id="3343742">FoldCase</span>&nbsp;<span class="op" id="3343751">==</span>&nbsp;<span class="num" id="3343754">0</span>&nbsp;<span class="op" id="3343756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3343760">buf</span><span class="op" id="3343763">.</span><span class="ident" id="3343764">WriteRune</span><span class="op" id="3343773">(</span><span class="ident" id="3343774">i</span><span class="op" id="3343775">.</span><span class="ident" id="3343776">Rune</span><span class="op" id="3343780">[</span><span class="num" id="3343781">0</span><span class="op" id="3343782">]</span><span class="op" id="3343783">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3343787">pc</span><span class="op" id="3343789">,</span>&nbsp;<span class="ident" id="3343791">i</span>&nbsp;<span class="op" id="3343793">=</span>&nbsp;<span class="ident" id="3343795">i</span><span class="op" id="3343796">.</span><span class="ident" id="3343797">Out</span><span class="op" id="3343800">,</span>&nbsp;<span class="op" id="3343802">&amp;</span><span class="ident" id="3343803">p</span><span class="op" id="3343804">.</span><span class="ident" id="3343805">Inst</span><span class="op" id="3343809">[</span><span class="ident" id="3343810">i</span><span class="op" id="3343811">.</span><span class="ident" id="3343812">Out</span><span class="op" id="3343815">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3343818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3343821">return</span>&nbsp;<span class="ident" id="3343828">buf</span><span class="op" id="3343831">.</span><span class="ident" id="3343832">String</span><span class="op" id="3343838">(</span><span class="op" id="3343839">)</span><span class="op" id="3343840">,</span>&nbsp;<span class="ident" id="3343842">i</span><span class="op" id="3343843">.</span><span class="ident" id="3343844">Op</span>&nbsp;<span class="op" id="3343847">==</span>&nbsp;<span class="ident" id="3343850">syntax</span><span class="op" id="3343856">.</span><span class="ident" id="3343857">InstEmptyWidth</span>&nbsp;<span class="op" id="3343872">&amp;&amp;</span>&nbsp;<span class="op" id="3343875">(</span><span class="ident" id="3343876">syntax</span><span class="op" id="3343882">.</span><span class="ident" id="3343883">EmptyOp</span><span class="op" id="3343890">(</span><span class="ident" id="3343891">i</span><span class="op" id="3343892">.</span><span class="ident" id="3343893">Arg</span><span class="op" id="3343896">)</span><span class="op" id="3343897">)</span><span class="op" id="3343898">&amp;</span><span class="ident" id="3343899">syntax</span><span class="op" id="3343905">.</span><span class="ident" id="3343906">EmptyBeginText</span>&nbsp;<span class="op" id="3343921">!=</span>&nbsp;<span class="num" id="3343924">0</span><span class="op" id="3343925">,</span>&nbsp;<span class="ident" id="3343927">pc</span><br>
<span class="lineno"></span><span class="op" id="3343930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3343933">//&nbsp;OnePassNext&nbsp;selects&nbsp;the&nbsp;next&nbsp;actionable&nbsp;state&nbsp;of&nbsp;the&nbsp;prog,&nbsp;based&nbsp;on&nbsp;the&nbsp;input&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="3344025">//&nbsp;It&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;i.Op&nbsp;==&nbsp;InstAlt&nbsp;or&nbsp;InstAltMatch,&nbsp;and&nbsp;from&nbsp;the&nbsp;one-pass&nbsp;machine.</span><br>
<span class="lineno"></span><span class="comment" id="3344122">//&nbsp;One&nbsp;of&nbsp;the&nbsp;alternates&nbsp;may&nbsp;ultimately&nbsp;lead&nbsp;without&nbsp;input&nbsp;to&nbsp;end&nbsp;of&nbsp;line.&nbsp;If&nbsp;the&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="3344216">//&nbsp;is&nbsp;InstAltMatch&nbsp;the&nbsp;path&nbsp;to&nbsp;the&nbsp;InstMatch&nbsp;is&nbsp;in&nbsp;i.Out,&nbsp;the&nbsp;normal&nbsp;node&nbsp;in&nbsp;i.Next.</span><br>
<span class="lineno"></span><span class="keyword" id="3344301">func</span>&nbsp;<span class="ident" id="3344306">onePassNext</span><span class="op" id="3344317">(</span><span class="ident" id="3344318">i</span>&nbsp;<span class="op" id="3344320">*</span><span class="ident" id="3344321">onePassInst</span><span class="op" id="3344332">,</span>&nbsp;<span class="ident" id="3344334">r</span>&nbsp;<span class="builtintype" id="3344336">rune</span><span class="op" id="3344340">)</span>&nbsp;<span class="builtintype" id="3344342">uint32</span>&nbsp;<span class="op" id="3344349">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3344352">next</span>&nbsp;<span class="op" id="3344357">:=</span>&nbsp;<span class="ident" id="3344360">i</span><span class="op" id="3344361">.</span><span class="ident" id="3344362">MatchRunePos</span><span class="op" id="3344374">(</span><span class="ident" id="3344375">r</span><span class="op" id="3344376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344379">if</span>&nbsp;<span class="ident" id="3344382">next</span>&nbsp;<span class="op" id="3344387">&gt;=</span>&nbsp;<span class="num" id="3344390">0</span>&nbsp;<span class="op" id="3344392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344396">return</span>&nbsp;<span class="ident" id="3344403">i</span><span class="op" id="3344404">.</span><span class="ident" id="3344405">Next</span><span class="op" id="3344409">[</span><span class="ident" id="3344410">next</span><span class="op" id="3344414">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3344417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344420">if</span>&nbsp;<span class="ident" id="3344423">i</span><span class="op" id="3344424">.</span><span class="ident" id="3344425">Op</span>&nbsp;<span class="op" id="3344428">==</span>&nbsp;<span class="ident" id="3344431">syntax</span><span class="op" id="3344437">.</span><span class="ident" id="3344438">InstAltMatch</span>&nbsp;<span class="op" id="3344451">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344455">return</span>&nbsp;<span class="ident" id="3344462">i</span><span class="op" id="3344463">.</span><span class="ident" id="3344464">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3344469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344472">return</span>&nbsp;<span class="num" id="3344479">0</span><br>
<span class="lineno"></span><span class="op" id="3344481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="3344484">func</span>&nbsp;<span class="ident" id="3344489">iop</span><span class="op" id="3344492">(</span><span class="ident" id="3344493">i</span>&nbsp;<span class="op" id="3344495">*</span><span class="ident" id="3344496">syntax</span><span class="op" id="3344502">.</span><span class="ident" id="3344503">Inst</span><span class="op" id="3344507">)</span>&nbsp;<span class="ident" id="3344509">syntax</span><span class="op" id="3344515">.</span><span class="ident" id="3344516">InstOp</span>&nbsp;<span class="op" id="3344523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3344526">op</span>&nbsp;<span class="op" id="3344529">:=</span>&nbsp;<span class="ident" id="3344532">i</span><span class="op" id="3344533">.</span><span class="ident" id="3344534">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344538">switch</span>&nbsp;<span class="ident" id="3344545">op</span>&nbsp;<span class="op" id="3344548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344551">case</span>&nbsp;<span class="ident" id="3344556">syntax</span><span class="op" id="3344562">.</span><span class="ident" id="3344563">InstRune1</span><span class="op" id="3344572">,</span>&nbsp;<span class="ident" id="3344574">syntax</span><span class="op" id="3344580">.</span><span class="ident" id="3344581">InstRuneAny</span><span class="op" id="3344592">,</span>&nbsp;<span class="ident" id="3344594">syntax</span><span class="op" id="3344600">.</span><span class="ident" id="3344601">InstRuneAnyNotNL</span><span class="op" id="3344617">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3344621">op</span>&nbsp;<span class="op" id="3344624">=</span>&nbsp;<span class="ident" id="3344626">syntax</span><span class="op" id="3344632">.</span><span class="ident" id="3344633">InstRune</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3344643">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344646">return</span>&nbsp;<span class="ident" id="3344653">op</span><br>
<span class="lineno"></span><span class="op" id="3344656">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3344659">//&nbsp;Sparse&nbsp;Array&nbsp;implementation&nbsp;is&nbsp;used&nbsp;as&nbsp;a&nbsp;queueOnePass.</span><br>
<span class="lineno">90</span><span class="keyword" id="3344717">type</span>&nbsp;<span class="ident" id="3344722">queueOnePass</span>&nbsp;<span class="keyword" id="3344735">struct</span>&nbsp;<span class="op" id="3344742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3344745">sparse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3344761">[</span><span class="op" id="3344762">]</span><span class="builtintype" id="3344763">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3344771">dense</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3344787">[</span><span class="op" id="3344788">]</span><span class="builtintype" id="3344789">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3344797">size</span><span class="op" id="3344801">,</span>&nbsp;<span class="ident" id="3344803">nextIndex</span>&nbsp;<span class="builtintype" id="3344813">uint32</span><br>
<span class="lineno"></span><span class="op" id="3344820">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="3344823">func</span>&nbsp;<span class="op" id="3344828">(</span><span class="ident" id="3344829">q</span>&nbsp;<span class="op" id="3344831">*</span><span class="ident" id="3344832">queueOnePass</span><span class="op" id="3344844">)</span>&nbsp;<span class="ident" id="3344846">empty</span><span class="op" id="3344851">(</span><span class="op" id="3344852">)</span>&nbsp;<span class="builtintype" id="3344854">bool</span>&nbsp;<span class="op" id="3344859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344862">return</span>&nbsp;<span class="ident" id="3344869">q</span><span class="op" id="3344870">.</span><span class="ident" id="3344871">nextIndex</span>&nbsp;<span class="op" id="3344881">&gt;=</span>&nbsp;<span class="ident" id="3344884">q</span><span class="op" id="3344885">.</span><span class="ident" id="3344886">size</span><br>
<span class="lineno"></span><span class="op" id="3344891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="3344894">func</span>&nbsp;<span class="op" id="3344899">(</span><span class="ident" id="3344900">q</span>&nbsp;<span class="op" id="3344902">*</span><span class="ident" id="3344903">queueOnePass</span><span class="op" id="3344915">)</span>&nbsp;<span class="ident" id="3344917">next</span><span class="op" id="3344921">(</span><span class="op" id="3344922">)</span>&nbsp;<span class="op" id="3344924">(</span><span class="ident" id="3344925">n</span>&nbsp;<span class="builtintype" id="3344927">uint32</span><span class="op" id="3344933">)</span>&nbsp;<span class="op" id="3344935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3344938">n</span>&nbsp;<span class="op" id="3344940">=</span>&nbsp;<span class="ident" id="3344942">q</span><span class="op" id="3344943">.</span><span class="ident" id="3344944">dense</span><span class="op" id="3344949">[</span><span class="ident" id="3344950">q</span><span class="op" id="3344951">.</span><span class="ident" id="3344952">nextIndex</span><span class="op" id="3344961">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3344964">q</span><span class="op" id="3344965">.</span><span class="ident" id="3344966">nextIndex</span><span class="op" id="3344975">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3344979">return</span><br>
<span class="lineno"></span><span class="op" id="3344986">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="3344989">func</span>&nbsp;<span class="op" id="3344994">(</span><span class="ident" id="3344995">q</span>&nbsp;<span class="op" id="3344997">*</span><span class="ident" id="3344998">queueOnePass</span><span class="op" id="3345010">)</span>&nbsp;<span class="ident" id="3345012">clear</span><span class="op" id="3345017">(</span><span class="op" id="3345018">)</span>&nbsp;<span class="op" id="3345020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3345023">q</span><span class="op" id="3345024">.</span><span class="ident" id="3345025">size</span>&nbsp;<span class="op" id="3345030">=</span>&nbsp;<span class="num" id="3345032">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3345035">q</span><span class="op" id="3345036">.</span><span class="ident" id="3345037">nextIndex</span>&nbsp;<span class="op" id="3345047">=</span>&nbsp;<span class="num" id="3345049">0</span><br>
<span class="lineno"></span><span class="op" id="3345051">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="3345054">func</span>&nbsp;<span class="op" id="3345059">(</span><span class="ident" id="3345060">q</span>&nbsp;<span class="op" id="3345062">*</span><span class="ident" id="3345063">queueOnePass</span><span class="op" id="3345075">)</span>&nbsp;<span class="ident" id="3345077">reset</span><span class="op" id="3345082">(</span><span class="op" id="3345083">)</span>&nbsp;<span class="op" id="3345085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3345088">q</span><span class="op" id="3345089">.</span><span class="ident" id="3345090">nextIndex</span>&nbsp;<span class="op" id="3345100">=</span>&nbsp;<span class="num" id="3345102">0</span><br>
<span class="lineno"></span><span class="op" id="3345104">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="3345107">func</span>&nbsp;<span class="op" id="3345112">(</span><span class="ident" id="3345113">q</span>&nbsp;<span class="op" id="3345115">*</span><span class="ident" id="3345116">queueOnePass</span><span class="op" id="3345128">)</span>&nbsp;<span class="ident" id="3345130">contains</span><span class="op" id="3345138">(</span><span class="ident" id="3345139">u</span>&nbsp;<span class="builtintype" id="3345141">uint32</span><span class="op" id="3345147">)</span>&nbsp;<span class="builtintype" id="3345149">bool</span>&nbsp;<span class="op" id="3345154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3345157">if</span>&nbsp;<span class="ident" id="3345160">u</span>&nbsp;<span class="op" id="3345162">&gt;=</span>&nbsp;<span class="builtintype" id="3345165">uint32</span><span class="op" id="3345171">(</span><span class="builtinfunc" id="3345172">len</span><span class="op" id="3345175">(</span><span class="ident" id="3345176">q</span><span class="op" id="3345177">.</span><span class="ident" id="3345178">sparse</span><span class="op" id="3345184">)</span><span class="op" id="3345185">)</span>&nbsp;<span class="op" id="3345187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3345191">return</span>&nbsp;<span class="builtintype" id="3345198">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3345205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3345208">return</span>&nbsp;<span class="ident" id="3345215">q</span><span class="op" id="3345216">.</span><span class="ident" id="3345217">sparse</span><span class="op" id="3345223">[</span><span class="ident" id="3345224">u</span><span class="op" id="3345225">]</span>&nbsp;<span class="op" id="3345227">&lt;</span>&nbsp;<span class="ident" id="3345229">q</span><span class="op" id="3345230">.</span><span class="ident" id="3345231">size</span>&nbsp;<span class="op" id="3345236">&amp;&amp;</span>&nbsp;<span class="ident" id="3345239">q</span><span class="op" id="3345240">.</span><span class="ident" id="3345241">dense</span><span class="op" id="3345246">[</span><span class="ident" id="3345247">q</span><span class="op" id="3345248">.</span><span class="ident" id="3345249">sparse</span><span class="op" id="3345255">[</span><span class="ident" id="3345256">u</span><span class="op" id="3345257">]</span><span class="op" id="3345258">]</span>&nbsp;<span class="op" id="3345260">==</span>&nbsp;<span class="ident" id="3345263">u</span><br>
<span class="lineno">120</span><span class="op" id="3345265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3345268">func</span>&nbsp;<span class="op" id="3345273">(</span><span class="ident" id="3345274">q</span>&nbsp;<span class="op" id="3345276">*</span><span class="ident" id="3345277">queueOnePass</span><span class="op" id="3345289">)</span>&nbsp;<span class="ident" id="3345291">insert</span><span class="op" id="3345297">(</span><span class="ident" id="3345298">u</span>&nbsp;<span class="builtintype" id="3345300">uint32</span><span class="op" id="3345306">)</span>&nbsp;<span class="op" id="3345308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3345311">if</span>&nbsp;<span class="op" id="3345314">!</span><span class="ident" id="3345315">q</span><span class="op" id="3345316">.</span><span class="ident" id="3345317">contains</span><span class="op" id="3345325">(</span><span class="ident" id="3345326">u</span><span class="op" id="3345327">)</span>&nbsp;<span class="op" id="3345329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3345333">q</span><span class="op" id="3345334">.</span><span class="ident" id="3345335">insertNew</span><span class="op" id="3345344">(</span><span class="ident" id="3345345">u</span><span class="op" id="3345346">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3345349">}</span><br>
<span class="lineno"></span><span class="op" id="3345351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3345354">func</span>&nbsp;<span class="op" id="3345359">(</span><span class="ident" id="3345360">q</span>&nbsp;<span class="op" id="3345362">*</span><span class="ident" id="3345363">queueOnePass</span><span class="op" id="3345375">)</span>&nbsp;<span class="ident" id="3345377">insertNew</span><span class="op" id="3345386">(</span><span class="ident" id="3345387">u</span>&nbsp;<span class="builtintype" id="3345389">uint32</span><span class="op" id="3345395">)</span>&nbsp;<span class="op" id="3345397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3345400">if</span>&nbsp;<span class="ident" id="3345403">u</span>&nbsp;<span class="op" id="3345405">&gt;=</span>&nbsp;<span class="builtintype" id="3345408">uint32</span><span class="op" id="3345414">(</span><span class="builtinfunc" id="3345415">len</span><span class="op" id="3345418">(</span><span class="ident" id="3345419">q</span><span class="op" id="3345420">.</span><span class="ident" id="3345421">sparse</span><span class="op" id="3345427">)</span><span class="op" id="3345428">)</span>&nbsp;<span class="op" id="3345430">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3345434">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3345442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3345445">q</span><span class="op" id="3345446">.</span><span class="ident" id="3345447">sparse</span><span class="op" id="3345453">[</span><span class="ident" id="3345454">u</span><span class="op" id="3345455">]</span>&nbsp;<span class="op" id="3345457">=</span>&nbsp;<span class="ident" id="3345459">q</span><span class="op" id="3345460">.</span><span class="ident" id="3345461">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3345467">q</span><span class="op" id="3345468">.</span><span class="ident" id="3345469">dense</span><span class="op" id="3345474">[</span><span class="ident" id="3345475">q</span><span class="op" id="3345476">.</span><span class="ident" id="3345477">size</span><span class="op" id="3345481">]</span>&nbsp;<span class="op" id="3345483">=</span>&nbsp;<span class="ident" id="3345485">u</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3345488">q</span><span class="op" id="3345489">.</span><span class="ident" id="3345490">size</span><span class="op" id="3345494">++</span><br>
<span class="lineno">135</span><span class="op" id="3345497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3345500">func</span>&nbsp;<span class="ident" id="3345505">newQueue</span><span class="op" id="3345513">(</span><span class="ident" id="3345514">size</span>&nbsp;<span class="builtintype" id="3345519">int</span><span class="op" id="3345522">)</span>&nbsp;<span class="op" id="3345524">(</span><span class="ident" id="3345525">q</span>&nbsp;<span class="op" id="3345527">*</span><span class="ident" id="3345528">queueOnePass</span><span class="op" id="3345540">)</span>&nbsp;<span class="op" id="3345542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3345545">return</span>&nbsp;<span class="op" id="3345552">&amp;</span><span class="ident" id="3345553">queueOnePass</span><span class="op" id="3345565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3345569">sparse</span><span class="op" id="3345575">:</span>&nbsp;<span class="builtinfunc" id="3345577">make</span><span class="op" id="3345581">(</span><span class="op" id="3345582">[</span><span class="op" id="3345583">]</span><span class="builtintype" id="3345584">uint32</span><span class="op" id="3345590">,</span>&nbsp;<span class="ident" id="3345592">size</span><span class="op" id="3345596">)</span><span class="op" id="3345597">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3345601">dense</span><span class="op" id="3345606">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="3345609">make</span><span class="op" id="3345613">(</span><span class="op" id="3345614">[</span><span class="op" id="3345615">]</span><span class="builtintype" id="3345616">uint32</span><span class="op" id="3345622">,</span>&nbsp;<span class="ident" id="3345624">size</span><span class="op" id="3345628">)</span><span class="op" id="3345629">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3345632">}</span><br>
<span class="lineno"></span><span class="op" id="3345634">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3345637">//&nbsp;mergeRuneSets&nbsp;merges&nbsp;two&nbsp;non-intersecting&nbsp;runesets,&nbsp;and&nbsp;returns&nbsp;the&nbsp;merged&nbsp;result,</span><br>
<span class="lineno">145</span><span class="comment" id="3345723">//&nbsp;and&nbsp;a&nbsp;NextIp&nbsp;array.&nbsp;The&nbsp;idea&nbsp;is&nbsp;that&nbsp;if&nbsp;a&nbsp;rune&nbsp;matches&nbsp;the&nbsp;OnePassRunes&nbsp;at&nbsp;index</span><br>
<span class="lineno"></span><span class="comment" id="3345807">//&nbsp;i,&nbsp;NextIp[i/2]&nbsp;is&nbsp;the&nbsp;target.&nbsp;If&nbsp;the&nbsp;input&nbsp;sets&nbsp;intersect,&nbsp;an&nbsp;empty&nbsp;runeset&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3345892">//&nbsp;NextIp&nbsp;array&nbsp;with&nbsp;the&nbsp;single&nbsp;element&nbsp;mergeFailed&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="3345957">//&nbsp;The&nbsp;code&nbsp;assumes&nbsp;that&nbsp;both&nbsp;inputs&nbsp;contain&nbsp;ordered&nbsp;and&nbsp;non-intersecting&nbsp;rune&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="keyword" id="3346043">const</span>&nbsp;<span class="ident" id="3346049">mergeFailed</span>&nbsp;<span class="op" id="3346061">=</span>&nbsp;<span class="builtintype" id="3346063">uint32</span><span class="op" id="3346069">(</span><span class="num" id="3346070">0xffffffff</span><span class="op" id="3346080">)</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="3346083">var</span>&nbsp;<span class="op" id="3346087">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3346090">noRune</span>&nbsp;<span class="op" id="3346097">=</span>&nbsp;<span class="op" id="3346099">[</span><span class="op" id="3346100">]</span><span class="builtintype" id="3346101">rune</span><span class="op" id="3346105">{</span><span class="op" id="3346106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3346109">noNext</span>&nbsp;<span class="op" id="3346116">=</span>&nbsp;<span class="op" id="3346118">[</span><span class="op" id="3346119">]</span><span class="builtintype" id="3346120">uint32</span><span class="op" id="3346126">{</span><span class="ident" id="3346127">mergeFailed</span><span class="op" id="3346138">}</span><br>
<span class="lineno"></span><span class="op" id="3346140">)</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="keyword" id="3346143">func</span>&nbsp;<span class="ident" id="3346148">mergeRuneSets</span><span class="op" id="3346161">(</span><span class="ident" id="3346162">leftRunes</span><span class="op" id="3346171">,</span>&nbsp;<span class="ident" id="3346173">rightRunes</span>&nbsp;<span class="op" id="3346184">*</span><span class="op" id="3346185">[</span><span class="op" id="3346186">]</span><span class="builtintype" id="3346187">rune</span><span class="op" id="3346191">,</span>&nbsp;<span class="ident" id="3346193">leftPC</span><span class="op" id="3346199">,</span>&nbsp;<span class="ident" id="3346201">rightPC</span>&nbsp;<span class="builtintype" id="3346209">uint32</span><span class="op" id="3346215">)</span>&nbsp;<span class="op" id="3346217">(</span><span class="op" id="3346218">[</span><span class="op" id="3346219">]</span><span class="builtintype" id="3346220">rune</span><span class="op" id="3346224">,</span>&nbsp;<span class="op" id="3346226">[</span><span class="op" id="3346227">]</span><span class="builtintype" id="3346228">uint32</span><span class="op" id="3346234">)</span>&nbsp;<span class="op" id="3346236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3346239">leftLen</span>&nbsp;<span class="op" id="3346247">:=</span>&nbsp;<span class="builtinfunc" id="3346250">len</span><span class="op" id="3346253">(</span><span class="op" id="3346254">*</span><span class="ident" id="3346255">leftRunes</span><span class="op" id="3346264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3346267">rightLen</span>&nbsp;<span class="op" id="3346276">:=</span>&nbsp;<span class="builtinfunc" id="3346279">len</span><span class="op" id="3346282">(</span><span class="op" id="3346283">*</span><span class="ident" id="3346284">rightRunes</span><span class="op" id="3346294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346297">if</span>&nbsp;<span class="ident" id="3346300">leftLen</span><span class="op" id="3346307">&amp;</span><span class="num" id="3346308">0x1</span>&nbsp;<span class="op" id="3346312">!=</span>&nbsp;<span class="num" id="3346315">0</span>&nbsp;<span class="op" id="3346317">||</span>&nbsp;<span class="ident" id="3346320">rightLen</span><span class="op" id="3346328">&amp;</span><span class="num" id="3346329">0x1</span>&nbsp;<span class="op" id="3346333">!=</span>&nbsp;<span class="num" id="3346336">0</span>&nbsp;<span class="op" id="3346338">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3346342">panic</span><span class="op" id="3346347">(</span><span class="string" id="3346348">&#34;mergeRuneSets&nbsp;odd&nbsp;length&nbsp;[]rune&#34;</span><span class="op" id="3346381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3346384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346387">var</span>&nbsp;<span class="op" id="3346391">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3346395">lx</span><span class="op" id="3346397">,</span>&nbsp;<span class="ident" id="3346399">rx</span>&nbsp;<span class="builtintype" id="3346402">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3346407">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3346410">merged</span>&nbsp;<span class="op" id="3346417">:=</span>&nbsp;<span class="builtinfunc" id="3346420">make</span><span class="op" id="3346424">(</span><span class="op" id="3346425">[</span><span class="op" id="3346426">]</span><span class="builtintype" id="3346427">rune</span><span class="op" id="3346431">,</span>&nbsp;<span class="num" id="3346433">0</span><span class="op" id="3346434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3346437">next</span>&nbsp;<span class="op" id="3346442">:=</span>&nbsp;<span class="builtinfunc" id="3346445">make</span><span class="op" id="3346449">(</span><span class="op" id="3346450">[</span><span class="op" id="3346451">]</span><span class="builtintype" id="3346452">uint32</span><span class="op" id="3346458">,</span>&nbsp;<span class="num" id="3346460">0</span><span class="op" id="3346461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3346464">ok</span>&nbsp;<span class="op" id="3346467">:=</span>&nbsp;<span class="builtintype" id="3346470">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346476">defer</span>&nbsp;<span class="keyword" id="3346482">func</span><span class="op" id="3346486">(</span><span class="op" id="3346487">)</span>&nbsp;<span class="op" id="3346489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346493">if</span>&nbsp;<span class="op" id="3346496">!</span><span class="ident" id="3346497">ok</span>&nbsp;<span class="op" id="3346500">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3346505">merged</span>&nbsp;<span class="op" id="3346512">=</span>&nbsp;<span class="ident" id="3346514">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3346521">next</span>&nbsp;<span class="op" id="3346526">=</span>&nbsp;<span class="ident" id="3346528">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3346534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3346537">}</span><span class="op" id="3346538">(</span><span class="op" id="3346539">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3346543">ix</span>&nbsp;<span class="op" id="3346546">:=</span>&nbsp;<span class="op" id="3346549">-</span><span class="num" id="3346550">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3346553">extend</span>&nbsp;<span class="op" id="3346560">:=</span>&nbsp;<span class="keyword" id="3346563">func</span><span class="op" id="3346567">(</span><span class="ident" id="3346568">newLow</span>&nbsp;<span class="op" id="3346575">*</span><span class="builtintype" id="3346576">int</span><span class="op" id="3346579">,</span>&nbsp;<span class="ident" id="3346581">newArray</span>&nbsp;<span class="op" id="3346590">*</span><span class="op" id="3346591">[</span><span class="op" id="3346592">]</span><span class="builtintype" id="3346593">rune</span><span class="op" id="3346597">,</span>&nbsp;<span class="ident" id="3346599">pc</span>&nbsp;<span class="builtintype" id="3346602">uint32</span><span class="op" id="3346608">)</span>&nbsp;<span class="builtintype" id="3346610">bool</span>&nbsp;<span class="op" id="3346615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346619">if</span>&nbsp;<span class="ident" id="3346622">ix</span>&nbsp;<span class="op" id="3346625">&gt;</span>&nbsp;<span class="num" id="3346627">0</span>&nbsp;<span class="op" id="3346629">&amp;&amp;</span>&nbsp;<span class="op" id="3346632">(</span><span class="op" id="3346633">*</span><span class="ident" id="3346634">newArray</span><span class="op" id="3346642">)</span><span class="op" id="3346643">[</span><span class="op" id="3346644">*</span><span class="ident" id="3346645">newLow</span><span class="op" id="3346651">]</span>&nbsp;<span class="op" id="3346653">&lt;=</span>&nbsp;<span class="ident" id="3346656">merged</span><span class="op" id="3346662">[</span><span class="ident" id="3346663">ix</span><span class="op" id="3346665">]</span>&nbsp;<span class="op" id="3346667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346672">return</span>&nbsp;<span class="builtintype" id="3346679">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3346687">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3346691">merged</span>&nbsp;<span class="op" id="3346698">=</span>&nbsp;<span class="builtinfunc" id="3346700">append</span><span class="op" id="3346706">(</span><span class="ident" id="3346707">merged</span><span class="op" id="3346713">,</span>&nbsp;<span class="op" id="3346715">(</span><span class="op" id="3346716">*</span><span class="ident" id="3346717">newArray</span><span class="op" id="3346725">)</span><span class="op" id="3346726">[</span><span class="op" id="3346727">*</span><span class="ident" id="3346728">newLow</span><span class="op" id="3346734">]</span><span class="op" id="3346735">,</span>&nbsp;<span class="op" id="3346737">(</span><span class="op" id="3346738">*</span><span class="ident" id="3346739">newArray</span><span class="op" id="3346747">)</span><span class="op" id="3346748">[</span><span class="op" id="3346749">*</span><span class="ident" id="3346750">newLow</span><span class="op" id="3346756">+</span><span class="num" id="3346757">1</span><span class="op" id="3346758">]</span><span class="op" id="3346759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3346763">*</span><span class="ident" id="3346764">newLow</span>&nbsp;<span class="op" id="3346771">+=</span>&nbsp;<span class="num" id="3346774">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3346778">ix</span>&nbsp;<span class="op" id="3346781">+=</span>&nbsp;<span class="num" id="3346784">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3346788">next</span>&nbsp;<span class="op" id="3346793">=</span>&nbsp;<span class="builtinfunc" id="3346795">append</span><span class="op" id="3346801">(</span><span class="ident" id="3346802">next</span><span class="op" id="3346806">,</span>&nbsp;<span class="ident" id="3346808">pc</span><span class="op" id="3346810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346814">return</span>&nbsp;<span class="builtintype" id="3346821">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3346827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346831">for</span>&nbsp;<span class="ident" id="3346835">lx</span>&nbsp;<span class="op" id="3346838">&lt;</span>&nbsp;<span class="ident" id="3346840">leftLen</span>&nbsp;<span class="op" id="3346848">||</span>&nbsp;<span class="ident" id="3346851">rx</span>&nbsp;<span class="op" id="3346854">&lt;</span>&nbsp;<span class="ident" id="3346856">rightLen</span>&nbsp;<span class="op" id="3346865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346869">switch</span>&nbsp;<span class="op" id="3346876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346880">case</span>&nbsp;<span class="ident" id="3346885">rx</span>&nbsp;<span class="op" id="3346888">&gt;=</span>&nbsp;<span class="ident" id="3346891">rightLen</span><span class="op" id="3346899">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3346904">ok</span>&nbsp;<span class="op" id="3346907">=</span>&nbsp;<span class="ident" id="3346909">extend</span><span class="op" id="3346915">(</span><span class="op" id="3346916">&amp;</span><span class="ident" id="3346917">lx</span><span class="op" id="3346919">,</span>&nbsp;<span class="ident" id="3346921">leftRunes</span><span class="op" id="3346930">,</span>&nbsp;<span class="ident" id="3346932">leftPC</span><span class="op" id="3346938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3346942">case</span>&nbsp;<span class="ident" id="3346947">lx</span>&nbsp;<span class="op" id="3346950">&gt;=</span>&nbsp;<span class="ident" id="3346953">leftLen</span><span class="op" id="3346960">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3346965">ok</span>&nbsp;<span class="op" id="3346968">=</span>&nbsp;<span class="ident" id="3346970">extend</span><span class="op" id="3346976">(</span><span class="op" id="3346977">&amp;</span><span class="ident" id="3346978">rx</span><span class="op" id="3346980">,</span>&nbsp;<span class="ident" id="3346982">rightRunes</span><span class="op" id="3346992">,</span>&nbsp;<span class="ident" id="3346994">rightPC</span><span class="op" id="3347001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347005">case</span>&nbsp;<span class="op" id="3347010">(</span><span class="op" id="3347011">*</span><span class="ident" id="3347012">rightRunes</span><span class="op" id="3347022">)</span><span class="op" id="3347023">[</span><span class="ident" id="3347024">rx</span><span class="op" id="3347026">]</span>&nbsp;<span class="op" id="3347028">&lt;</span>&nbsp;<span class="op" id="3347030">(</span><span class="op" id="3347031">*</span><span class="ident" id="3347032">leftRunes</span><span class="op" id="3347041">)</span><span class="op" id="3347042">[</span><span class="ident" id="3347043">lx</span><span class="op" id="3347045">]</span><span class="op" id="3347046">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3347051">ok</span>&nbsp;<span class="op" id="3347054">=</span>&nbsp;<span class="ident" id="3347056">extend</span><span class="op" id="3347062">(</span><span class="op" id="3347063">&amp;</span><span class="ident" id="3347064">rx</span><span class="op" id="3347066">,</span>&nbsp;<span class="ident" id="3347068">rightRunes</span><span class="op" id="3347078">,</span>&nbsp;<span class="ident" id="3347080">rightPC</span><span class="op" id="3347087">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347091">default</span><span class="op" id="3347098">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3347103">ok</span>&nbsp;<span class="op" id="3347106">=</span>&nbsp;<span class="ident" id="3347108">extend</span><span class="op" id="3347114">(</span><span class="op" id="3347115">&amp;</span><span class="ident" id="3347116">lx</span><span class="op" id="3347118">,</span>&nbsp;<span class="ident" id="3347120">leftRunes</span><span class="op" id="3347129">,</span>&nbsp;<span class="ident" id="3347131">leftPC</span><span class="op" id="3347137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3347141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347145">if</span>&nbsp;<span class="op" id="3347148">!</span><span class="ident" id="3347149">ok</span>&nbsp;<span class="op" id="3347152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347157">return</span>&nbsp;<span class="ident" id="3347164">noRune</span><span class="op" id="3347170">,</span>&nbsp;<span class="ident" id="3347172">noNext</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3347181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3347184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347187">return</span>&nbsp;<span class="ident" id="3347194">merged</span><span class="op" id="3347200">,</span>&nbsp;<span class="ident" id="3347202">next</span><br>
<span class="lineno"></span><span class="op" id="3347207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span><span class="comment" id="3347210">//&nbsp;cleanupOnePass&nbsp;drops&nbsp;working&nbsp;memory,&nbsp;and&nbsp;restores&nbsp;certain&nbsp;shortcut&nbsp;instructions.</span><br>
<span class="lineno"></span><span class="keyword" id="3347294">func</span>&nbsp;<span class="ident" id="3347299">cleanupOnePass</span><span class="op" id="3347313">(</span><span class="ident" id="3347314">prog</span>&nbsp;<span class="op" id="3347319">*</span><span class="ident" id="3347320">onePassProg</span><span class="op" id="3347331">,</span>&nbsp;<span class="ident" id="3347333">original</span>&nbsp;<span class="op" id="3347342">*</span><span class="ident" id="3347343">syntax</span><span class="op" id="3347349">.</span><span class="ident" id="3347350">Prog</span><span class="op" id="3347354">)</span>&nbsp;<span class="op" id="3347356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347359">for</span>&nbsp;<span class="ident" id="3347363">ix</span><span class="op" id="3347365">,</span>&nbsp;<span class="ident" id="3347367">instOriginal</span>&nbsp;<span class="op" id="3347380">:=</span>&nbsp;<span class="keyword" id="3347383">range</span>&nbsp;<span class="ident" id="3347389">original</span><span class="op" id="3347397">.</span><span class="ident" id="3347398">Inst</span>&nbsp;<span class="op" id="3347403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347407">switch</span>&nbsp;<span class="ident" id="3347414">instOriginal</span><span class="op" id="3347426">.</span><span class="ident" id="3347427">Op</span>&nbsp;<span class="op" id="3347430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347434">case</span>&nbsp;<span class="ident" id="3347439">syntax</span><span class="op" id="3347445">.</span><span class="ident" id="3347446">InstAlt</span><span class="op" id="3347453">,</span>&nbsp;<span class="ident" id="3347455">syntax</span><span class="op" id="3347461">.</span><span class="ident" id="3347462">InstAltMatch</span><span class="op" id="3347474">,</span>&nbsp;<span class="ident" id="3347476">syntax</span><span class="op" id="3347482">.</span><span class="ident" id="3347483">InstRune</span><span class="op" id="3347491">:</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347495">case</span>&nbsp;<span class="ident" id="3347500">syntax</span><span class="op" id="3347506">.</span><span class="ident" id="3347507">InstCapture</span><span class="op" id="3347518">,</span>&nbsp;<span class="ident" id="3347520">syntax</span><span class="op" id="3347526">.</span><span class="ident" id="3347527">InstEmptyWidth</span><span class="op" id="3347541">,</span>&nbsp;<span class="ident" id="3347543">syntax</span><span class="op" id="3347549">.</span><span class="ident" id="3347550">InstNop</span><span class="op" id="3347557">,</span>&nbsp;<span class="ident" id="3347559">syntax</span><span class="op" id="3347565">.</span><span class="ident" id="3347566">InstMatch</span><span class="op" id="3347575">,</span>&nbsp;<span class="ident" id="3347577">syntax</span><span class="op" id="3347583">.</span><span class="ident" id="3347584">InstFail</span><span class="op" id="3347592">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3347597">prog</span><span class="op" id="3347601">.</span><span class="ident" id="3347602">Inst</span><span class="op" id="3347606">[</span><span class="ident" id="3347607">ix</span><span class="op" id="3347609">]</span><span class="op" id="3347610">.</span><span class="ident" id="3347611">Next</span>&nbsp;<span class="op" id="3347616">=</span>&nbsp;<span class="ident" id="3347618">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347624">case</span>&nbsp;<span class="ident" id="3347629">syntax</span><span class="op" id="3347635">.</span><span class="ident" id="3347636">InstRune1</span><span class="op" id="3347645">,</span>&nbsp;<span class="ident" id="3347647">syntax</span><span class="op" id="3347653">.</span><span class="ident" id="3347654">InstRuneAny</span><span class="op" id="3347665">,</span>&nbsp;<span class="ident" id="3347667">syntax</span><span class="op" id="3347673">.</span><span class="ident" id="3347674">InstRuneAnyNotNL</span><span class="op" id="3347690">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3347695">prog</span><span class="op" id="3347699">.</span><span class="ident" id="3347700">Inst</span><span class="op" id="3347704">[</span><span class="ident" id="3347705">ix</span><span class="op" id="3347707">]</span><span class="op" id="3347708">.</span><span class="ident" id="3347709">Next</span>&nbsp;<span class="op" id="3347714">=</span>&nbsp;<span class="ident" id="3347716">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3347723">prog</span><span class="op" id="3347727">.</span><span class="ident" id="3347728">Inst</span><span class="op" id="3347732">[</span><span class="ident" id="3347733">ix</span><span class="op" id="3347735">]</span>&nbsp;<span class="op" id="3347737">=</span>&nbsp;<span class="ident" id="3347739">onePassInst</span><span class="op" id="3347750">{</span><span class="ident" id="3347751">Inst</span><span class="op" id="3347755">:</span>&nbsp;<span class="ident" id="3347757">instOriginal</span><span class="op" id="3347769">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3347773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3347776">}</span><br>
<span class="lineno"></span><span class="op" id="3347778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3347781">//&nbsp;onePassCopy&nbsp;creates&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog,&nbsp;as&nbsp;we&#39;ll&nbsp;be&nbsp;modifying&nbsp;it</span><br>
<span class="lineno">220</span><span class="keyword" id="3347858">func</span>&nbsp;<span class="ident" id="3347863">onePassCopy</span><span class="op" id="3347874">(</span><span class="ident" id="3347875">prog</span>&nbsp;<span class="op" id="3347880">*</span><span class="ident" id="3347881">syntax</span><span class="op" id="3347887">.</span><span class="ident" id="3347888">Prog</span><span class="op" id="3347892">)</span>&nbsp;<span class="op" id="3347894">*</span><span class="ident" id="3347895">onePassProg</span>&nbsp;<span class="op" id="3347907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3347910">p</span>&nbsp;<span class="op" id="3347912">:=</span>&nbsp;<span class="op" id="3347915">&amp;</span><span class="ident" id="3347916">onePassProg</span><span class="op" id="3347927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3347931">Start</span><span class="op" id="3347936">:</span>&nbsp;&nbsp;<span class="ident" id="3347939">prog</span><span class="op" id="3347943">.</span><span class="ident" id="3347944">Start</span><span class="op" id="3347949">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3347953">NumCap</span><span class="op" id="3347959">:</span>&nbsp;<span class="ident" id="3347961">prog</span><span class="op" id="3347965">.</span><span class="ident" id="3347966">NumCap</span><span class="op" id="3347972">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3347975">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3347978">for</span>&nbsp;<span class="ident" id="3347982">_</span><span class="op" id="3347983">,</span>&nbsp;<span class="ident" id="3347985">inst</span>&nbsp;<span class="op" id="3347990">:=</span>&nbsp;<span class="keyword" id="3347993">range</span>&nbsp;<span class="ident" id="3347999">prog</span><span class="op" id="3348003">.</span><span class="ident" id="3348004">Inst</span>&nbsp;<span class="op" id="3348009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3348013">p</span><span class="op" id="3348014">.</span><span class="ident" id="3348015">Inst</span>&nbsp;<span class="op" id="3348020">=</span>&nbsp;<span class="builtinfunc" id="3348022">append</span><span class="op" id="3348028">(</span><span class="ident" id="3348029">p</span><span class="op" id="3348030">.</span><span class="ident" id="3348031">Inst</span><span class="op" id="3348035">,</span>&nbsp;<span class="ident" id="3348037">onePassInst</span><span class="op" id="3348048">{</span><span class="ident" id="3348049">Inst</span><span class="op" id="3348053">:</span>&nbsp;<span class="ident" id="3348055">inst</span><span class="op" id="3348059">}</span><span class="op" id="3348060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3348063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3348067">//&nbsp;rewrites&nbsp;one&nbsp;or&nbsp;more&nbsp;common&nbsp;Prog&nbsp;constructs&nbsp;that&nbsp;enable&nbsp;some&nbsp;otherwise</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3348142">//&nbsp;non-onepass&nbsp;Progs&nbsp;to&nbsp;be&nbsp;onepass.&nbsp;A:BD&nbsp;(for&nbsp;example)&nbsp;means&nbsp;an&nbsp;InstAlt&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3348218">//&nbsp;ip&nbsp;A,&nbsp;that&nbsp;points&nbsp;to&nbsp;ips&nbsp;B&nbsp;&amp;&nbsp;C.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3348254">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:CD</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3348285">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3348316">for</span>&nbsp;<span class="ident" id="3348320">pc</span>&nbsp;<span class="op" id="3348323">:=</span>&nbsp;<span class="keyword" id="3348326">range</span>&nbsp;<span class="ident" id="3348332">p</span><span class="op" id="3348333">.</span><span class="ident" id="3348334">Inst</span>&nbsp;<span class="op" id="3348339">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3348343">switch</span>&nbsp;<span class="ident" id="3348350">p</span><span class="op" id="3348351">.</span><span class="ident" id="3348352">Inst</span><span class="op" id="3348356">[</span><span class="ident" id="3348357">pc</span><span class="op" id="3348359">]</span><span class="op" id="3348360">.</span><span class="ident" id="3348361">Op</span>&nbsp;<span class="op" id="3348364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3348368">default</span><span class="op" id="3348375">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3348380">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3348391">case</span>&nbsp;<span class="ident" id="3348396">syntax</span><span class="op" id="3348402">.</span><span class="ident" id="3348403">InstAlt</span><span class="op" id="3348410">,</span>&nbsp;<span class="ident" id="3348412">syntax</span><span class="op" id="3348418">.</span><span class="ident" id="3348419">InstAltMatch</span><span class="op" id="3348431">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3348436">//&nbsp;A:Bx&nbsp;+&nbsp;B:Ay</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3348454">p_A_Other</span>&nbsp;<span class="op" id="3348464">:=</span>&nbsp;<span class="op" id="3348467">&amp;</span><span class="ident" id="3348468">p</span><span class="op" id="3348469">.</span><span class="ident" id="3348470">Inst</span><span class="op" id="3348474">[</span><span class="ident" id="3348475">pc</span><span class="op" id="3348477">]</span><span class="op" id="3348478">.</span><span class="ident" id="3348479">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3348486">p_A_Alt</span>&nbsp;<span class="op" id="3348494">:=</span>&nbsp;<span class="op" id="3348497">&amp;</span><span class="ident" id="3348498">p</span><span class="op" id="3348499">.</span><span class="ident" id="3348500">Inst</span><span class="op" id="3348504">[</span><span class="ident" id="3348505">pc</span><span class="op" id="3348507">]</span><span class="op" id="3348508">.</span><span class="ident" id="3348509">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3348516">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;target&nbsp;is&nbsp;another&nbsp;Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3348556">instAlt</span>&nbsp;<span class="op" id="3348564">:=</span>&nbsp;<span class="ident" id="3348567">p</span><span class="op" id="3348568">.</span><span class="ident" id="3348569">Inst</span><span class="op" id="3348573">[</span><span class="op" id="3348574">*</span><span class="ident" id="3348575">p_A_Alt</span><span class="op" id="3348582">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3348587">if</span>&nbsp;<span class="op" id="3348590">!</span><span class="op" id="3348591">(</span><span class="ident" id="3348592">instAlt</span><span class="op" id="3348599">.</span><span class="ident" id="3348600">Op</span>&nbsp;<span class="op" id="3348603">==</span>&nbsp;<span class="ident" id="3348606">syntax</span><span class="op" id="3348612">.</span><span class="ident" id="3348613">InstAlt</span>&nbsp;<span class="op" id="3348621">||</span>&nbsp;<span class="ident" id="3348624">instAlt</span><span class="op" id="3348631">.</span><span class="ident" id="3348632">Op</span>&nbsp;<span class="op" id="3348635">==</span>&nbsp;<span class="ident" id="3348638">syntax</span><span class="op" id="3348644">.</span><span class="ident" id="3348645">InstAltMatch</span><span class="op" id="3348657">)</span>&nbsp;<span class="op" id="3348659">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3348665">p_A_Alt</span><span class="op" id="3348672">,</span>&nbsp;<span class="ident" id="3348674">p_A_Other</span>&nbsp;<span class="op" id="3348684">=</span>&nbsp;<span class="ident" id="3348686">p_A_Other</span><span class="op" id="3348695">,</span>&nbsp;<span class="ident" id="3348697">p_A_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3348709">instAlt</span>&nbsp;<span class="op" id="3348717">=</span>&nbsp;<span class="ident" id="3348719">p</span><span class="op" id="3348720">.</span><span class="ident" id="3348721">Inst</span><span class="op" id="3348725">[</span><span class="op" id="3348726">*</span><span class="ident" id="3348727">p_A_Alt</span><span class="op" id="3348734">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3348740">if</span>&nbsp;<span class="op" id="3348743">!</span><span class="op" id="3348744">(</span><span class="ident" id="3348745">instAlt</span><span class="op" id="3348752">.</span><span class="ident" id="3348753">Op</span>&nbsp;<span class="op" id="3348756">==</span>&nbsp;<span class="ident" id="3348759">syntax</span><span class="op" id="3348765">.</span><span class="ident" id="3348766">InstAlt</span>&nbsp;<span class="op" id="3348774">||</span>&nbsp;<span class="ident" id="3348777">instAlt</span><span class="op" id="3348784">.</span><span class="ident" id="3348785">Op</span>&nbsp;<span class="op" id="3348788">==</span>&nbsp;<span class="ident" id="3348791">syntax</span><span class="op" id="3348797">.</span><span class="ident" id="3348798">InstAltMatch</span><span class="op" id="3348810">)</span>&nbsp;<span class="op" id="3348812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3348819">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3348832">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3348837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3348842">instOther</span>&nbsp;<span class="op" id="3348852">:=</span>&nbsp;<span class="ident" id="3348855">p</span><span class="op" id="3348856">.</span><span class="ident" id="3348857">Inst</span><span class="op" id="3348861">[</span><span class="op" id="3348862">*</span><span class="ident" id="3348863">p_A_Other</span><span class="op" id="3348872">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3348877">//&nbsp;Analyzing&nbsp;both&nbsp;legs&nbsp;pointing&nbsp;to&nbsp;Alts&nbsp;is&nbsp;for&nbsp;another&nbsp;day</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3348939">if</span>&nbsp;<span class="ident" id="3348942">instOther</span><span class="op" id="3348951">.</span><span class="ident" id="3348952">Op</span>&nbsp;<span class="op" id="3348955">==</span>&nbsp;<span class="ident" id="3348958">syntax</span><span class="op" id="3348964">.</span><span class="ident" id="3348965">InstAlt</span>&nbsp;<span class="op" id="3348973">||</span>&nbsp;<span class="ident" id="3348976">instOther</span><span class="op" id="3348985">.</span><span class="ident" id="3348986">Op</span>&nbsp;<span class="op" id="3348989">==</span>&nbsp;<span class="ident" id="3348992">syntax</span><span class="op" id="3348998">.</span><span class="ident" id="3348999">InstAltMatch</span>&nbsp;<span class="op" id="3349012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3349018">//&nbsp;too&nbsp;complicated</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3349041">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3349053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3349058">//&nbsp;simple&nbsp;empty&nbsp;transition&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3349093">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3349126">p_B_Alt</span>&nbsp;<span class="op" id="3349134">:=</span>&nbsp;<span class="op" id="3349137">&amp;</span><span class="ident" id="3349138">p</span><span class="op" id="3349139">.</span><span class="ident" id="3349140">Inst</span><span class="op" id="3349144">[</span><span class="op" id="3349145">*</span><span class="ident" id="3349146">p_A_Alt</span><span class="op" id="3349153">]</span><span class="op" id="3349154">.</span><span class="ident" id="3349155">Out</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3349162">p_B_Other</span>&nbsp;<span class="op" id="3349172">:=</span>&nbsp;<span class="op" id="3349175">&amp;</span><span class="ident" id="3349176">p</span><span class="op" id="3349177">.</span><span class="ident" id="3349178">Inst</span><span class="op" id="3349182">[</span><span class="op" id="3349183">*</span><span class="ident" id="3349184">p_A_Alt</span><span class="op" id="3349191">]</span><span class="op" id="3349192">.</span><span class="ident" id="3349193">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3349200">patch</span>&nbsp;<span class="op" id="3349206">:=</span>&nbsp;<span class="builtintype" id="3349209">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3349218">if</span>&nbsp;<span class="ident" id="3349221">instAlt</span><span class="op" id="3349228">.</span><span class="ident" id="3349229">Out</span>&nbsp;<span class="op" id="3349233">==</span>&nbsp;<span class="builtintype" id="3349236">uint32</span><span class="op" id="3349242">(</span><span class="ident" id="3349243">pc</span><span class="op" id="3349245">)</span>&nbsp;<span class="op" id="3349247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3349253">patch</span>&nbsp;<span class="op" id="3349259">=</span>&nbsp;<span class="builtintype" id="3349261">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3349269">}</span>&nbsp;<span class="keyword" id="3349271">else</span>&nbsp;<span class="keyword" id="3349276">if</span>&nbsp;<span class="ident" id="3349279">instAlt</span><span class="op" id="3349286">.</span><span class="ident" id="3349287">Arg</span>&nbsp;<span class="op" id="3349291">==</span>&nbsp;<span class="builtintype" id="3349294">uint32</span><span class="op" id="3349300">(</span><span class="ident" id="3349301">pc</span><span class="op" id="3349303">)</span>&nbsp;<span class="op" id="3349305">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3349311">patch</span>&nbsp;<span class="op" id="3349317">=</span>&nbsp;<span class="builtintype" id="3349319">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3349328">p_B_Alt</span><span class="op" id="3349335">,</span>&nbsp;<span class="ident" id="3349337">p_B_Other</span>&nbsp;<span class="op" id="3349347">=</span>&nbsp;<span class="ident" id="3349349">p_B_Other</span><span class="op" id="3349358">,</span>&nbsp;<span class="ident" id="3349360">p_B_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3349371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3349376">if</span>&nbsp;<span class="ident" id="3349379">patch</span>&nbsp;<span class="op" id="3349385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3349391">*</span><span class="ident" id="3349392">p_B_Alt</span>&nbsp;<span class="op" id="3349400">=</span>&nbsp;<span class="op" id="3349402">*</span><span class="ident" id="3349403">p_A_Other</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3349416">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3349422">//&nbsp;empty&nbsp;transition&nbsp;to&nbsp;common&nbsp;target</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3349462">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3349495">if</span>&nbsp;<span class="op" id="3349498">*</span><span class="ident" id="3349499">p_A_Other</span>&nbsp;<span class="op" id="3349509">==</span>&nbsp;<span class="op" id="3349512">*</span><span class="ident" id="3349513">p_B_Alt</span>&nbsp;<span class="op" id="3349521">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3349527">*</span><span class="ident" id="3349528">p_A_Alt</span>&nbsp;<span class="op" id="3349536">=</span>&nbsp;<span class="op" id="3349538">*</span><span class="ident" id="3349539">p_B_Other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3349552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3349556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3349559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3349562">return</span>&nbsp;<span class="ident" id="3349569">p</span><br>
<span class="lineno">280</span><span class="op" id="3349571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3349574">//&nbsp;runeSlice&nbsp;exists&nbsp;to&nbsp;permit&nbsp;sorting&nbsp;the&nbsp;case-folded&nbsp;rune&nbsp;sets.</span><br>
<span class="lineno"></span><span class="keyword" id="3349639">type</span>&nbsp;<span class="ident" id="3349644">runeSlice</span>&nbsp;<span class="op" id="3349654">[</span><span class="op" id="3349655">]</span><span class="builtintype" id="3349656">rune</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="3349662">func</span>&nbsp;<span class="op" id="3349667">(</span><span class="ident" id="3349668">p</span>&nbsp;<span class="ident" id="3349670">runeSlice</span><span class="op" id="3349679">)</span>&nbsp;<span class="ident" id="3349681">Len</span><span class="op" id="3349684">(</span><span class="op" id="3349685">)</span>&nbsp;<span class="builtintype" id="3349687">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3349701">{</span>&nbsp;<span class="keyword" id="3349703">return</span>&nbsp;<span class="builtinfunc" id="3349710">len</span><span class="op" id="3349713">(</span><span class="ident" id="3349714">p</span><span class="op" id="3349715">)</span>&nbsp;<span class="op" id="3349717">}</span><br>
<span class="lineno"></span><span class="keyword" id="3349719">func</span>&nbsp;<span class="op" id="3349724">(</span><span class="ident" id="3349725">p</span>&nbsp;<span class="ident" id="3349727">runeSlice</span><span class="op" id="3349736">)</span>&nbsp;<span class="ident" id="3349738">Less</span><span class="op" id="3349742">(</span><span class="ident" id="3349743">i</span><span class="op" id="3349744">,</span>&nbsp;<span class="ident" id="3349746">j</span>&nbsp;<span class="builtintype" id="3349748">int</span><span class="op" id="3349751">)</span>&nbsp;<span class="builtintype" id="3349753">bool</span>&nbsp;<span class="op" id="3349758">{</span>&nbsp;<span class="keyword" id="3349760">return</span>&nbsp;<span class="ident" id="3349767">p</span><span class="op" id="3349768">[</span><span class="ident" id="3349769">i</span><span class="op" id="3349770">]</span>&nbsp;<span class="op" id="3349772">&lt;</span>&nbsp;<span class="ident" id="3349774">p</span><span class="op" id="3349775">[</span><span class="ident" id="3349776">j</span><span class="op" id="3349777">]</span>&nbsp;<span class="op" id="3349779">}</span><br>
<span class="lineno"></span><span class="keyword" id="3349781">func</span>&nbsp;<span class="op" id="3349786">(</span><span class="ident" id="3349787">p</span>&nbsp;<span class="ident" id="3349789">runeSlice</span><span class="op" id="3349798">)</span>&nbsp;<span class="ident" id="3349800">Swap</span><span class="op" id="3349804">(</span><span class="ident" id="3349805">i</span><span class="op" id="3349806">,</span>&nbsp;<span class="ident" id="3349808">j</span>&nbsp;<span class="builtintype" id="3349810">int</span><span class="op" id="3349813">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3349820">{</span>&nbsp;<span class="ident" id="3349822">p</span><span class="op" id="3349823">[</span><span class="ident" id="3349824">i</span><span class="op" id="3349825">]</span><span class="op" id="3349826">,</span>&nbsp;<span class="ident" id="3349828">p</span><span class="op" id="3349829">[</span><span class="ident" id="3349830">j</span><span class="op" id="3349831">]</span>&nbsp;<span class="op" id="3349833">=</span>&nbsp;<span class="ident" id="3349835">p</span><span class="op" id="3349836">[</span><span class="ident" id="3349837">j</span><span class="op" id="3349838">]</span><span class="op" id="3349839">,</span>&nbsp;<span class="ident" id="3349841">p</span><span class="op" id="3349842">[</span><span class="ident" id="3349843">i</span><span class="op" id="3349844">]</span>&nbsp;<span class="op" id="3349846">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3349849">//&nbsp;Sort&nbsp;is&nbsp;a&nbsp;convenience&nbsp;method.</span><br>
<span class="lineno">290</span><span class="keyword" id="3349882">func</span>&nbsp;<span class="op" id="3349887">(</span><span class="ident" id="3349888">p</span>&nbsp;<span class="ident" id="3349890">runeSlice</span><span class="op" id="3349899">)</span>&nbsp;<span class="ident" id="3349901">Sort</span><span class="op" id="3349905">(</span><span class="op" id="3349906">)</span>&nbsp;<span class="op" id="3349908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3349911">sort</span><span class="op" id="3349915">.</span><span class="ident" id="3349916">Sort</span><span class="op" id="3349920">(</span><span class="ident" id="3349921">p</span><span class="op" id="3349922">)</span><br>
<span class="lineno"></span><span class="op" id="3349924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3349927">var</span>&nbsp;<span class="ident" id="3349931">anyRuneNotNL</span>&nbsp;<span class="op" id="3349944">=</span>&nbsp;<span class="op" id="3349946">[</span><span class="op" id="3349947">]</span><span class="builtintype" id="3349948">rune</span><span class="op" id="3349952">{</span><span class="num" id="3349953">0</span><span class="op" id="3349954">,</span>&nbsp;<span class="string" id="3349956">&#39;\n&#39;</span>&nbsp;<span class="op" id="3349961">-</span>&nbsp;<span class="num" id="3349963">1</span><span class="op" id="3349964">,</span>&nbsp;<span class="string" id="3349966">&#39;\n&#39;</span>&nbsp;<span class="op" id="3349971">+</span>&nbsp;<span class="num" id="3349973">1</span><span class="op" id="3349974">,</span>&nbsp;<span class="ident" id="3349976">unicode</span><span class="op" id="3349983">.</span><span class="ident" id="3349984">MaxRune</span><span class="op" id="3349991">}</span><br>
<span class="lineno">295</span><span class="keyword" id="3349993">var</span>&nbsp;<span class="ident" id="3349997">anyRune</span>&nbsp;<span class="op" id="3350005">=</span>&nbsp;<span class="op" id="3350007">[</span><span class="op" id="3350008">]</span><span class="builtintype" id="3350009">rune</span><span class="op" id="3350013">{</span><span class="num" id="3350014">0</span><span class="op" id="3350015">,</span>&nbsp;<span class="ident" id="3350017">unicode</span><span class="op" id="3350024">.</span><span class="ident" id="3350025">MaxRune</span><span class="op" id="3350032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3350035">//&nbsp;makeOnePass&nbsp;creates&nbsp;a&nbsp;onepass&nbsp;Prog,&nbsp;if&nbsp;possible.&nbsp;It&nbsp;is&nbsp;possible&nbsp;if&nbsp;at&nbsp;any&nbsp;alt,</span><br>
<span class="lineno"></span><span class="comment" id="3350117">//&nbsp;the&nbsp;match&nbsp;engine&nbsp;can&nbsp;always&nbsp;tell&nbsp;which&nbsp;branch&nbsp;to&nbsp;take.&nbsp;The&nbsp;routine&nbsp;may&nbsp;modify</span><br>
<span class="lineno"></span><span class="comment" id="3350198">//&nbsp;p&nbsp;if&nbsp;it&nbsp;is&nbsp;turned&nbsp;into&nbsp;a&nbsp;onepass&nbsp;Prog.&nbsp;If&nbsp;it&nbsp;isn&#39;t&nbsp;possible&nbsp;for&nbsp;this&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno">300</span><span class="comment" id="3350278">//&nbsp;onepass&nbsp;Prog,&nbsp;the&nbsp;Prog&nbsp;notOnePass&nbsp;is&nbsp;returned.&nbsp;makeOnePass&nbsp;is&nbsp;recursive</span><br>
<span class="lineno"></span><span class="comment" id="3350353">//&nbsp;to&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;Prog.</span><br>
<span class="lineno"></span><span class="keyword" id="3350381">func</span>&nbsp;<span class="ident" id="3350386">makeOnePass</span><span class="op" id="3350397">(</span><span class="ident" id="3350398">p</span>&nbsp;<span class="op" id="3350400">*</span><span class="ident" id="3350401">onePassProg</span><span class="op" id="3350412">)</span>&nbsp;<span class="op" id="3350414">*</span><span class="ident" id="3350415">onePassProg</span>&nbsp;<span class="op" id="3350427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3350430">//&nbsp;If&nbsp;the&nbsp;machine&nbsp;is&nbsp;very&nbsp;long,&nbsp;it&#39;s&nbsp;not&nbsp;worth&nbsp;the&nbsp;time&nbsp;to&nbsp;check&nbsp;if&nbsp;we&nbsp;can&nbsp;use&nbsp;one&nbsp;pass.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3350520">if</span>&nbsp;<span class="builtinfunc" id="3350523">len</span><span class="op" id="3350526">(</span><span class="ident" id="3350527">p</span><span class="op" id="3350528">.</span><span class="ident" id="3350529">Inst</span><span class="op" id="3350533">)</span>&nbsp;<span class="op" id="3350535">&gt;=</span>&nbsp;<span class="num" id="3350538">1000</span>&nbsp;<span class="op" id="3350543">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3350547">return</span>&nbsp;<span class="ident" id="3350554">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3350566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3350570">var</span>&nbsp;<span class="op" id="3350574">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3350578">instQueue</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3350591">=</span>&nbsp;<span class="ident" id="3350593">newQueue</span><span class="op" id="3350601">(</span><span class="builtinfunc" id="3350602">len</span><span class="op" id="3350605">(</span><span class="ident" id="3350606">p</span><span class="op" id="3350607">.</span><span class="ident" id="3350608">Inst</span><span class="op" id="3350612">)</span><span class="op" id="3350613">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3350617">visitQueue</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3350630">=</span>&nbsp;<span class="ident" id="3350632">newQueue</span><span class="op" id="3350640">(</span><span class="builtinfunc" id="3350641">len</span><span class="op" id="3350644">(</span><span class="ident" id="3350645">p</span><span class="op" id="3350646">.</span><span class="ident" id="3350647">Inst</span><span class="op" id="3350651">)</span><span class="op" id="3350652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3350656">build</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3350669">func</span><span class="op" id="3350673">(</span><span class="builtintype" id="3350674">uint32</span><span class="op" id="3350680">,</span>&nbsp;<span class="op" id="3350682">*</span><span class="ident" id="3350683">queueOnePass</span><span class="op" id="3350695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3350699">check</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3350712">func</span><span class="op" id="3350716">(</span><span class="builtintype" id="3350717">uint32</span><span class="op" id="3350723">,</span>&nbsp;<span class="keyword" id="3350725">map</span><span class="op" id="3350728">[</span><span class="builtintype" id="3350729">uint32</span><span class="op" id="3350735">]</span><span class="builtintype" id="3350736">bool</span><span class="op" id="3350740">)</span>&nbsp;<span class="builtintype" id="3350742">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3350749">onePassRunes</span>&nbsp;<span class="op" id="3350762">=</span>&nbsp;<span class="builtinfunc" id="3350764">make</span><span class="op" id="3350768">(</span><span class="op" id="3350769">[</span><span class="op" id="3350770">]</span><span class="op" id="3350771">[</span><span class="op" id="3350772">]</span><span class="builtintype" id="3350773">rune</span><span class="op" id="3350777">,</span>&nbsp;<span class="builtinfunc" id="3350779">len</span><span class="op" id="3350782">(</span><span class="ident" id="3350783">p</span><span class="op" id="3350784">.</span><span class="ident" id="3350785">Inst</span><span class="op" id="3350789">)</span><span class="op" id="3350790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3350793">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3350796">build</span>&nbsp;<span class="op" id="3350802">=</span>&nbsp;<span class="keyword" id="3350804">func</span><span class="op" id="3350808">(</span><span class="ident" id="3350809">pc</span>&nbsp;<span class="builtintype" id="3350812">uint32</span><span class="op" id="3350818">,</span>&nbsp;<span class="ident" id="3350820">q</span>&nbsp;<span class="op" id="3350822">*</span><span class="ident" id="3350823">queueOnePass</span><span class="op" id="3350835">)</span>&nbsp;<span class="op" id="3350837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3350841">if</span>&nbsp;<span class="ident" id="3350844">q</span><span class="op" id="3350845">.</span><span class="ident" id="3350846">contains</span><span class="op" id="3350854">(</span><span class="ident" id="3350855">pc</span><span class="op" id="3350857">)</span>&nbsp;<span class="op" id="3350859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3350864">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3350873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3350877">inst</span>&nbsp;<span class="op" id="3350882">:=</span>&nbsp;<span class="ident" id="3350885">p</span><span class="op" id="3350886">.</span><span class="ident" id="3350887">Inst</span><span class="op" id="3350891">[</span><span class="ident" id="3350892">pc</span><span class="op" id="3350894">]</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3350898">switch</span>&nbsp;<span class="ident" id="3350905">inst</span><span class="op" id="3350909">.</span><span class="ident" id="3350910">Op</span>&nbsp;<span class="op" id="3350913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3350917">case</span>&nbsp;<span class="ident" id="3350922">syntax</span><span class="op" id="3350928">.</span><span class="ident" id="3350929">InstAlt</span><span class="op" id="3350936">,</span>&nbsp;<span class="ident" id="3350938">syntax</span><span class="op" id="3350944">.</span><span class="ident" id="3350945">InstAltMatch</span><span class="op" id="3350957">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3350962">q</span><span class="op" id="3350963">.</span><span class="ident" id="3350964">insert</span><span class="op" id="3350970">(</span><span class="ident" id="3350971">inst</span><span class="op" id="3350975">.</span><span class="ident" id="3350976">Out</span><span class="op" id="3350979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3350984">build</span><span class="op" id="3350989">(</span><span class="ident" id="3350990">inst</span><span class="op" id="3350994">.</span><span class="ident" id="3350995">Out</span><span class="op" id="3350998">,</span>&nbsp;<span class="ident" id="3351000">q</span><span class="op" id="3351001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351006">q</span><span class="op" id="3351007">.</span><span class="ident" id="3351008">insert</span><span class="op" id="3351014">(</span><span class="ident" id="3351015">inst</span><span class="op" id="3351019">.</span><span class="ident" id="3351020">Arg</span><span class="op" id="3351023">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3351027">case</span>&nbsp;<span class="ident" id="3351032">syntax</span><span class="op" id="3351038">.</span><span class="ident" id="3351039">InstMatch</span><span class="op" id="3351048">,</span>&nbsp;<span class="ident" id="3351050">syntax</span><span class="op" id="3351056">.</span><span class="ident" id="3351057">InstFail</span><span class="op" id="3351065">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3351069">default</span><span class="op" id="3351076">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351081">q</span><span class="op" id="3351082">.</span><span class="ident" id="3351083">insert</span><span class="op" id="3351089">(</span><span class="ident" id="3351090">inst</span><span class="op" id="3351094">.</span><span class="ident" id="3351095">Out</span><span class="op" id="3351098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3351102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3351105">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3351109">//&nbsp;check&nbsp;that&nbsp;paths&nbsp;from&nbsp;Alt&nbsp;instructions&nbsp;are&nbsp;unambiguous,&nbsp;and&nbsp;rebuild&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3351189">//&nbsp;program&nbsp;as&nbsp;a&nbsp;onepass&nbsp;program</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351222">check</span>&nbsp;<span class="op" id="3351228">=</span>&nbsp;<span class="keyword" id="3351230">func</span><span class="op" id="3351234">(</span><span class="ident" id="3351235">pc</span>&nbsp;<span class="builtintype" id="3351238">uint32</span><span class="op" id="3351244">,</span>&nbsp;<span class="ident" id="3351246">m</span>&nbsp;<span class="keyword" id="3351248">map</span><span class="op" id="3351251">[</span><span class="builtintype" id="3351252">uint32</span><span class="op" id="3351258">]</span><span class="builtintype" id="3351259">bool</span><span class="op" id="3351263">)</span>&nbsp;<span class="op" id="3351265">(</span><span class="ident" id="3351266">ok</span>&nbsp;<span class="builtintype" id="3351269">bool</span><span class="op" id="3351273">)</span>&nbsp;<span class="op" id="3351275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351279">ok</span>&nbsp;<span class="op" id="3351282">=</span>&nbsp;<span class="builtintype" id="3351284">true</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351291">inst</span>&nbsp;<span class="op" id="3351296">:=</span>&nbsp;<span class="op" id="3351299">&amp;</span><span class="ident" id="3351300">p</span><span class="op" id="3351301">.</span><span class="ident" id="3351302">Inst</span><span class="op" id="3351306">[</span><span class="ident" id="3351307">pc</span><span class="op" id="3351309">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3351313">if</span>&nbsp;<span class="ident" id="3351316">visitQueue</span><span class="op" id="3351326">.</span><span class="ident" id="3351327">contains</span><span class="op" id="3351335">(</span><span class="ident" id="3351336">pc</span><span class="op" id="3351338">)</span>&nbsp;<span class="op" id="3351340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3351345">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3351354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351358">visitQueue</span><span class="op" id="3351368">.</span><span class="ident" id="3351369">insert</span><span class="op" id="3351375">(</span><span class="ident" id="3351376">pc</span><span class="op" id="3351378">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3351382">switch</span>&nbsp;<span class="ident" id="3351389">inst</span><span class="op" id="3351393">.</span><span class="ident" id="3351394">Op</span>&nbsp;<span class="op" id="3351397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3351401">case</span>&nbsp;<span class="ident" id="3351406">syntax</span><span class="op" id="3351412">.</span><span class="ident" id="3351413">InstAlt</span><span class="op" id="3351420">,</span>&nbsp;<span class="ident" id="3351422">syntax</span><span class="op" id="3351428">.</span><span class="ident" id="3351429">InstAltMatch</span><span class="op" id="3351441">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351446">ok</span>&nbsp;<span class="op" id="3351449">=</span>&nbsp;<span class="ident" id="3351451">check</span><span class="op" id="3351456">(</span><span class="ident" id="3351457">inst</span><span class="op" id="3351461">.</span><span class="ident" id="3351462">Out</span><span class="op" id="3351465">,</span>&nbsp;<span class="ident" id="3351467">m</span><span class="op" id="3351468">)</span>&nbsp;<span class="op" id="3351470">&amp;&amp;</span>&nbsp;<span class="ident" id="3351473">check</span><span class="op" id="3351478">(</span><span class="ident" id="3351479">inst</span><span class="op" id="3351483">.</span><span class="ident" id="3351484">Arg</span><span class="op" id="3351487">,</span>&nbsp;<span class="ident" id="3351489">m</span><span class="op" id="3351490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3351495">//&nbsp;check&nbsp;no-input&nbsp;paths&nbsp;to&nbsp;InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351535">matchOut</span>&nbsp;<span class="op" id="3351544">:=</span>&nbsp;<span class="ident" id="3351547">m</span><span class="op" id="3351548">[</span><span class="ident" id="3351549">inst</span><span class="op" id="3351553">.</span><span class="ident" id="3351554">Out</span><span class="op" id="3351557">]</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351562">matchArg</span>&nbsp;<span class="op" id="3351571">:=</span>&nbsp;<span class="ident" id="3351574">m</span><span class="op" id="3351575">[</span><span class="ident" id="3351576">inst</span><span class="op" id="3351580">.</span><span class="ident" id="3351581">Arg</span><span class="op" id="3351584">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3351589">if</span>&nbsp;<span class="ident" id="3351592">matchOut</span>&nbsp;<span class="op" id="3351601">&amp;&amp;</span>&nbsp;<span class="ident" id="3351604">matchArg</span>&nbsp;<span class="op" id="3351613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351619">ok</span>&nbsp;<span class="op" id="3351622">=</span>&nbsp;<span class="builtintype" id="3351624">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3351634">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3351643">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3351648">//&nbsp;Match&nbsp;on&nbsp;empty&nbsp;goes&nbsp;in&nbsp;inst.Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3351686">if</span>&nbsp;<span class="ident" id="3351689">matchArg</span>&nbsp;<span class="op" id="3351698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351704">inst</span><span class="op" id="3351708">.</span><span class="ident" id="3351709">Out</span><span class="op" id="3351712">,</span>&nbsp;<span class="ident" id="3351714">inst</span><span class="op" id="3351718">.</span><span class="ident" id="3351719">Arg</span>&nbsp;<span class="op" id="3351723">=</span>&nbsp;<span class="ident" id="3351725">inst</span><span class="op" id="3351729">.</span><span class="ident" id="3351730">Arg</span><span class="op" id="3351733">,</span>&nbsp;<span class="ident" id="3351735">inst</span><span class="op" id="3351739">.</span><span class="ident" id="3351740">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351748">matchOut</span><span class="op" id="3351756">,</span>&nbsp;<span class="ident" id="3351758">matchArg</span>&nbsp;<span class="op" id="3351767">=</span>&nbsp;<span class="ident" id="3351769">matchArg</span><span class="op" id="3351777">,</span>&nbsp;<span class="ident" id="3351779">matchOut</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3351791">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3351796">if</span>&nbsp;<span class="ident" id="3351799">matchOut</span>&nbsp;<span class="op" id="3351808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351814">m</span><span class="op" id="3351815">[</span><span class="ident" id="3351816">pc</span><span class="op" id="3351818">]</span>&nbsp;<span class="op" id="3351820">=</span>&nbsp;<span class="builtintype" id="3351822">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351831">inst</span><span class="op" id="3351835">.</span><span class="ident" id="3351836">Op</span>&nbsp;<span class="op" id="3351839">=</span>&nbsp;<span class="ident" id="3351841">syntax</span><span class="op" id="3351847">.</span><span class="ident" id="3351848">InstAltMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3351864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3351870">//&nbsp;build&nbsp;a&nbsp;dispatch&nbsp;operator&nbsp;from&nbsp;the&nbsp;two&nbsp;legs&nbsp;of&nbsp;the&nbsp;alt.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3351932">onePassRunes</span><span class="op" id="3351944">[</span><span class="ident" id="3351945">pc</span><span class="op" id="3351947">]</span><span class="op" id="3351948">,</span>&nbsp;<span class="ident" id="3351950">inst</span><span class="op" id="3351954">.</span><span class="ident" id="3351955">Next</span>&nbsp;<span class="op" id="3351960">=</span>&nbsp;<span class="ident" id="3351962">mergeRuneSets</span><span class="op" id="3351975">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3351981">&amp;</span><span class="ident" id="3351982">onePassRunes</span><span class="op" id="3351994">[</span><span class="ident" id="3351995">inst</span><span class="op" id="3351999">.</span><span class="ident" id="3352000">Out</span><span class="op" id="3352003">]</span><span class="op" id="3352004">,</span>&nbsp;<span class="op" id="3352006">&amp;</span><span class="ident" id="3352007">onePassRunes</span><span class="op" id="3352019">[</span><span class="ident" id="3352020">inst</span><span class="op" id="3352024">.</span><span class="ident" id="3352025">Arg</span><span class="op" id="3352028">]</span><span class="op" id="3352029">,</span>&nbsp;<span class="ident" id="3352031">inst</span><span class="op" id="3352035">.</span><span class="ident" id="3352036">Out</span><span class="op" id="3352039">,</span>&nbsp;<span class="ident" id="3352041">inst</span><span class="op" id="3352045">.</span><span class="ident" id="3352046">Arg</span><span class="op" id="3352049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3352054">if</span>&nbsp;<span class="builtinfunc" id="3352057">len</span><span class="op" id="3352060">(</span><span class="ident" id="3352061">inst</span><span class="op" id="3352065">.</span><span class="ident" id="3352066">Next</span><span class="op" id="3352070">)</span>&nbsp;<span class="op" id="3352072">&gt;</span>&nbsp;<span class="num" id="3352074">0</span>&nbsp;<span class="op" id="3352076">&amp;&amp;</span>&nbsp;<span class="ident" id="3352079">inst</span><span class="op" id="3352083">.</span><span class="ident" id="3352084">Next</span><span class="op" id="3352088">[</span><span class="num" id="3352089">0</span><span class="op" id="3352090">]</span>&nbsp;<span class="op" id="3352092">==</span>&nbsp;<span class="ident" id="3352095">mergeFailed</span>&nbsp;<span class="op" id="3352107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3352113">ok</span>&nbsp;<span class="op" id="3352116">=</span>&nbsp;<span class="builtintype" id="3352118">false</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3352128">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3352137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3352141">case</span>&nbsp;<span class="ident" id="3352146">syntax</span><span class="op" id="3352152">.</span><span class="ident" id="3352153">InstCapture</span><span class="op" id="3352164">,</span>&nbsp;<span class="ident" id="3352166">syntax</span><span class="op" id="3352172">.</span><span class="ident" id="3352173">InstNop</span><span class="op" id="3352180">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3352185">ok</span>&nbsp;<span class="op" id="3352188">=</span>&nbsp;<span class="ident" id="3352190">check</span><span class="op" id="3352195">(</span><span class="ident" id="3352196">inst</span><span class="op" id="3352200">.</span><span class="ident" id="3352201">Out</span><span class="op" id="3352204">,</span>&nbsp;<span class="ident" id="3352206">m</span><span class="op" id="3352207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3352212">m</span><span class="op" id="3352213">[</span><span class="ident" id="3352214">pc</span><span class="op" id="3352216">]</span>&nbsp;<span class="op" id="3352218">=</span>&nbsp;<span class="ident" id="3352220">m</span><span class="op" id="3352221">[</span><span class="ident" id="3352222">inst</span><span class="op" id="3352226">.</span><span class="ident" id="3352227">Out</span><span class="op" id="3352230">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3352235">//&nbsp;pass&nbsp;matching&nbsp;runes&nbsp;back&nbsp;through&nbsp;these&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3352288">onePassRunes</span><span class="op" id="3352300">[</span><span class="ident" id="3352301">pc</span><span class="op" id="3352303">]</span>&nbsp;<span class="op" id="3352305">=</span>&nbsp;<span class="builtinfunc" id="3352307">append</span><span class="op" id="3352313">(</span><span class="op" id="3352314">[</span><span class="op" id="3352315">]</span><span class="builtintype" id="3352316">rune</span><span class="op" id="3352320">{</span><span class="op" id="3352321">}</span><span class="op" id="3352322">,</span>&nbsp;<span class="ident" id="3352324">onePassRunes</span><span class="op" id="3352336">[</span><span class="ident" id="3352337">inst</span><span class="op" id="3352341">.</span><span class="ident" id="3352342">Out</span><span class="op" id="3352345">]</span><span class="op" id="3352346">...</span><span class="op" id="3352349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3352354">inst</span><span class="op" id="3352358">.</span><span class="ident" id="3352359">Next</span>&nbsp;<span class="op" id="3352364">=</span>&nbsp;<span class="op" id="3352366">[</span><span class="op" id="3352367">]</span><span class="builtintype" id="3352368">uint32</span><span class="op" id="3352374">{</span><span class="op" id="3352375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3352380">for</span>&nbsp;<span class="ident" id="3352384">i</span>&nbsp;<span class="op" id="3352386">:=</span>&nbsp;<span class="builtinfunc" id="3352389">len</span><span class="op" id="3352392">(</span><span class="ident" id="3352393">onePassRunes</span><span class="op" id="3352405">[</span><span class="ident" id="3352406">pc</span><span class="op" id="3352408">]</span><span class="op" id="3352409">)</span>&nbsp;<span class="op" id="3352411">/</span>&nbsp;<span class="num" id="3352413">2</span><span class="op" id="3352414">;</span>&nbsp;<span class="ident" id="3352416">i</span>&nbsp;<span class="op" id="3352418">&gt;=</span>&nbsp;<span class="num" id="3352421">0</span><span class="op" id="3352422">;</span>&nbsp;<span class="ident" id="3352424">i</span><span class="op" id="3352425">--</span>&nbsp;<span class="op" id="3352428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3352434">inst</span><span class="op" id="3352438">.</span><span class="ident" id="3352439">Next</span>&nbsp;<span class="op" id="3352444">=</span>&nbsp;<span class="builtinfunc" id="3352446">append</span><span class="op" id="3352452">(</span><span class="ident" id="3352453">inst</span><span class="op" id="3352457">.</span><span class="ident" id="3352458">Next</span><span class="op" id="3352462">,</span>&nbsp;<span class="ident" id="3352464">inst</span><span class="op" id="3352468">.</span><span class="ident" id="3352469">Out</span><span class="op" id="3352472">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3352477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3352481">case</span>&nbsp;<span class="ident" id="3352486">syntax</span><span class="op" id="3352492">.</span><span class="ident" id="3352493">InstEmptyWidth</span><span class="op" id="3352507">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3352512">ok</span>&nbsp;<span class="op" id="3352515">=</span>&nbsp;<span class="ident" id="3352517">check</span><span class="op" id="3352522">(</span><span class="ident" id="3352523">inst</span><span class="op" id="3352527">.</span><span class="ident" id="3352528">Out</span><span class="op" id="3352531">,</span>&nbsp;<span class="ident" id="3352533">m</span><span class="op" id="3352534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3352539">m</span><span class="op" id="3352540">[</span><span class="ident" id="3352541">pc</span><span class="op" id="3352543">]</span>&nbsp;<span class="op" id="3352545">=</span>&nbsp;<span class="ident" id="3352547">m</span><span class="op" id="3352548">[</span><span class="ident" id="3352549">inst</span><span class="op" id="3352553">.</span><span class="ident" id="3352554">Out</span><span class="op" id="3352557">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3352562">onePassRunes</span><span class="op" id="3352574">[</span><span class="ident" id="3352575">pc</span><span class="op" id="3352577">]</span>&nbsp;<span class="op" id="3352579">=</span>&nbsp;<span class="builtinfunc" id="3352581">append</span><span class="op" id="3352587">(</span><span class="op" id="3352588">[</span><span class="op" id="3352589">]</span><span class="builtintype" id="3352590">rune</span><span class="op" id="3352594">{</span><span class="op" id="3352595">}</span><span class="op" id="3352596">,</span>&nbsp;<span class="ident" id="3352598">onePassRunes</span><span class="op" id="3352610">[</span><span class="ident" id="3352611">inst</span><span class="op" id="3352615">.</span><span class="ident" id="3352616">Out</span><span class="op" id="3352619">]</span><span class="op" id="3352620">...</span><span class="op" id="3352623">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3352628">inst</span><span class="op" id="3352632">.</span><span class="ident" id="3352633">Next</span>&nbsp;<span class="op" id="3352638">=</span>&nbsp;<span class="op" id="3352640">[</span><span class="op" id="3352641">]</span><span class="builtintype" id="3352642">uint32</span><span class="op" id="3352648">{</span><span class="op" id="3352649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3352654">for</span>&nbsp;<span class="ident" id="3352658">i</span>&nbsp;<span class="op" id="3352660">:=</span>&nbsp;<span class="builtinfunc" id="3352663">len</span><span class="op" id="3352666">(</span><span class="ident" id="3352667">onePassRunes</span><span class="op" id="3352679">[</span><span class="ident" id="3352680">pc</span><span class="op" id="3352682">]</span><span class="op" id="3352683">)</span>&nbsp;<span class="op" id="3352685">/</span>&nbsp;<span class="num" id="3352687">2</span><span class="op" id="3352688">;</span>&nbsp;<span class="ident" id="3352690">i</span>&nbsp;<span class="op" id="3352692">&gt;=</span>&nbsp;<span class="num" id="3352695">0</span><span class="op" id="3352696">;</span>&nbsp;<span class="ident" id="3352698">i</span><span class="op" id="3352699">--</span>&nbsp;<span class="op" id="3352702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3352708">inst</span><span class="op" id="3352712">.</span><span class="ident" id="3352713">Next</span>&nbsp;<span class="op" id="3352718">=</span>&nbsp;<span class="builtinfunc" id="3352720">append</span><span class="op" id="3352726">(</span><span class="ident" id="3352727">inst</span><span class="op" id="3352731">.</span><span class="ident" id="3352732">Next</span><span class="op" id="3352736">,</span>&nbsp;<span class="ident" id="3352738">inst</span><span class="op" id="3352742">.</span><span class="ident" id="3352743">Out</span><span class="op" id="3352746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3352751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3352755">case</span>&nbsp;<span class="ident" id="3352760">syntax</span><span class="op" id="3352766">.</span><span class="ident" id="3352767">InstMatch</span><span class="op" id="3352776">,</span>&nbsp;<span class="ident" id="3352778">syntax</span><span class="op" id="3352784">.</span><span class="ident" id="3352785">InstFail</span><span class="op" id="3352793">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3352798">m</span><span class="op" id="3352799">[</span><span class="ident" id="3352800">pc</span><span class="op" id="3352802">]</span>&nbsp;<span class="op" id="3352804">=</span>&nbsp;<span class="ident" id="3352806">inst</span><span class="op" id="3352810">.</span><span class="ident" id="3352811">Op</span>&nbsp;<span class="op" id="3352814">==</span>&nbsp;<span class="ident" id="3352817">syntax</span><span class="op" id="3352823">.</span><span class="ident" id="3352824">InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3352837">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3352845">case</span>&nbsp;<span class="ident" id="3352850">syntax</span><span class="op" id="3352856">.</span><span class="ident" id="3352857">InstRune</span><span class="op" id="3352865">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3352870">ok</span>&nbsp;<span class="op" id="3352873">=</span>&nbsp;<span class="ident" id="3352875">check</span><span class="op" id="3352880">(</span><span class="ident" id="3352881">inst</span><span class="op" id="3352885">.</span><span class="ident" id="3352886">Out</span><span class="op" id="3352889">,</span>&nbsp;<span class="ident" id="3352891">m</span><span class="op" id="3352892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3352897">m</span><span class="op" id="3352898">[</span><span class="ident" id="3352899">pc</span><span class="op" id="3352901">]</span>&nbsp;<span class="op" id="3352903">=</span>&nbsp;<span class="builtintype" id="3352905">false</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3352914">if</span>&nbsp;<span class="builtinfunc" id="3352917">len</span><span class="op" id="3352920">(</span><span class="ident" id="3352921">inst</span><span class="op" id="3352925">.</span><span class="ident" id="3352926">Next</span><span class="op" id="3352930">)</span>&nbsp;<span class="op" id="3352932">&gt;</span>&nbsp;<span class="num" id="3352934">0</span>&nbsp;<span class="op" id="3352936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3352942">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3352951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3352956">if</span>&nbsp;<span class="builtinfunc" id="3352959">len</span><span class="op" id="3352962">(</span><span class="ident" id="3352963">inst</span><span class="op" id="3352967">.</span><span class="ident" id="3352968">Rune</span><span class="op" id="3352972">)</span>&nbsp;<span class="op" id="3352974">==</span>&nbsp;<span class="num" id="3352977">0</span>&nbsp;<span class="op" id="3352979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3352985">onePassRunes</span><span class="op" id="3352997">[</span><span class="ident" id="3352998">pc</span><span class="op" id="3353000">]</span>&nbsp;<span class="op" id="3353002">=</span>&nbsp;<span class="op" id="3353004">[</span><span class="op" id="3353005">]</span><span class="builtintype" id="3353006">rune</span><span class="op" id="3353010">{</span><span class="op" id="3353011">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353017">inst</span><span class="op" id="3353021">.</span><span class="ident" id="3353022">Next</span>&nbsp;<span class="op" id="3353027">=</span>&nbsp;<span class="op" id="3353029">[</span><span class="op" id="3353030">]</span><span class="builtintype" id="3353031">uint32</span><span class="op" id="3353037">{</span><span class="ident" id="3353038">inst</span><span class="op" id="3353042">.</span><span class="ident" id="3353043">Out</span><span class="op" id="3353046">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3353052">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3353061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353066">runes</span>&nbsp;<span class="op" id="3353072">:=</span>&nbsp;<span class="builtinfunc" id="3353075">make</span><span class="op" id="3353079">(</span><span class="op" id="3353080">[</span><span class="op" id="3353081">]</span><span class="builtintype" id="3353082">rune</span><span class="op" id="3353086">,</span>&nbsp;<span class="num" id="3353088">0</span><span class="op" id="3353089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3353094">if</span>&nbsp;<span class="builtinfunc" id="3353097">len</span><span class="op" id="3353100">(</span><span class="ident" id="3353101">inst</span><span class="op" id="3353105">.</span><span class="ident" id="3353106">Rune</span><span class="op" id="3353110">)</span>&nbsp;<span class="op" id="3353112">==</span>&nbsp;<span class="num" id="3353115">1</span>&nbsp;<span class="op" id="3353117">&amp;&amp;</span>&nbsp;<span class="ident" id="3353120">syntax</span><span class="op" id="3353126">.</span><span class="ident" id="3353127">Flags</span><span class="op" id="3353132">(</span><span class="ident" id="3353133">inst</span><span class="op" id="3353137">.</span><span class="ident" id="3353138">Arg</span><span class="op" id="3353141">)</span><span class="op" id="3353142">&amp;</span><span class="ident" id="3353143">syntax</span><span class="op" id="3353149">.</span><span class="ident" id="3353150">FoldCase</span>&nbsp;<span class="op" id="3353159">!=</span>&nbsp;<span class="num" id="3353162">0</span>&nbsp;<span class="op" id="3353164">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353170">r0</span>&nbsp;<span class="op" id="3353173">:=</span>&nbsp;<span class="ident" id="3353176">inst</span><span class="op" id="3353180">.</span><span class="ident" id="3353181">Rune</span><span class="op" id="3353185">[</span><span class="num" id="3353186">0</span><span class="op" id="3353187">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353193">runes</span>&nbsp;<span class="op" id="3353199">=</span>&nbsp;<span class="builtinfunc" id="3353201">append</span><span class="op" id="3353207">(</span><span class="ident" id="3353208">runes</span><span class="op" id="3353213">,</span>&nbsp;<span class="ident" id="3353215">r0</span><span class="op" id="3353217">,</span>&nbsp;<span class="ident" id="3353219">r0</span><span class="op" id="3353221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3353227">for</span>&nbsp;<span class="ident" id="3353231">r1</span>&nbsp;<span class="op" id="3353234">:=</span>&nbsp;<span class="ident" id="3353237">unicode</span><span class="op" id="3353244">.</span><span class="ident" id="3353245">SimpleFold</span><span class="op" id="3353255">(</span><span class="ident" id="3353256">r0</span><span class="op" id="3353258">)</span><span class="op" id="3353259">;</span>&nbsp;<span class="ident" id="3353261">r1</span>&nbsp;<span class="op" id="3353264">!=</span>&nbsp;<span class="ident" id="3353267">r0</span><span class="op" id="3353269">;</span>&nbsp;<span class="ident" id="3353271">r1</span>&nbsp;<span class="op" id="3353274">=</span>&nbsp;<span class="ident" id="3353276">unicode</span><span class="op" id="3353283">.</span><span class="ident" id="3353284">SimpleFold</span><span class="op" id="3353294">(</span><span class="ident" id="3353295">r1</span><span class="op" id="3353297">)</span>&nbsp;<span class="op" id="3353299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353306">runes</span>&nbsp;<span class="op" id="3353312">=</span>&nbsp;<span class="builtinfunc" id="3353314">append</span><span class="op" id="3353320">(</span><span class="ident" id="3353321">runes</span><span class="op" id="3353326">,</span>&nbsp;<span class="ident" id="3353328">r1</span><span class="op" id="3353330">,</span>&nbsp;<span class="ident" id="3353332">r1</span><span class="op" id="3353334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3353340">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353346">sort</span><span class="op" id="3353350">.</span><span class="ident" id="3353351">Sort</span><span class="op" id="3353355">(</span><span class="ident" id="3353356">runeSlice</span><span class="op" id="3353365">(</span><span class="ident" id="3353366">runes</span><span class="op" id="3353371">)</span><span class="op" id="3353372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3353377">}</span>&nbsp;<span class="keyword" id="3353379">else</span>&nbsp;<span class="op" id="3353384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353390">runes</span>&nbsp;<span class="op" id="3353396">=</span>&nbsp;<span class="builtinfunc" id="3353398">append</span><span class="op" id="3353404">(</span><span class="ident" id="3353405">runes</span><span class="op" id="3353410">,</span>&nbsp;<span class="ident" id="3353412">inst</span><span class="op" id="3353416">.</span><span class="ident" id="3353417">Rune</span><span class="op" id="3353421">...</span><span class="op" id="3353424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3353429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353434">onePassRunes</span><span class="op" id="3353446">[</span><span class="ident" id="3353447">pc</span><span class="op" id="3353449">]</span>&nbsp;<span class="op" id="3353451">=</span>&nbsp;<span class="ident" id="3353453">runes</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353462">inst</span><span class="op" id="3353466">.</span><span class="ident" id="3353467">Next</span>&nbsp;<span class="op" id="3353472">=</span>&nbsp;<span class="op" id="3353474">[</span><span class="op" id="3353475">]</span><span class="builtintype" id="3353476">uint32</span><span class="op" id="3353482">{</span><span class="op" id="3353483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3353488">for</span>&nbsp;<span class="ident" id="3353492">i</span>&nbsp;<span class="op" id="3353494">:=</span>&nbsp;<span class="builtinfunc" id="3353497">len</span><span class="op" id="3353500">(</span><span class="ident" id="3353501">onePassRunes</span><span class="op" id="3353513">[</span><span class="ident" id="3353514">pc</span><span class="op" id="3353516">]</span><span class="op" id="3353517">)</span>&nbsp;<span class="op" id="3353519">/</span>&nbsp;<span class="num" id="3353521">2</span><span class="op" id="3353522">;</span>&nbsp;<span class="ident" id="3353524">i</span>&nbsp;<span class="op" id="3353526">&gt;=</span>&nbsp;<span class="num" id="3353529">0</span><span class="op" id="3353530">;</span>&nbsp;<span class="ident" id="3353532">i</span><span class="op" id="3353533">--</span>&nbsp;<span class="op" id="3353536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353542">inst</span><span class="op" id="3353546">.</span><span class="ident" id="3353547">Next</span>&nbsp;<span class="op" id="3353552">=</span>&nbsp;<span class="builtinfunc" id="3353554">append</span><span class="op" id="3353560">(</span><span class="ident" id="3353561">inst</span><span class="op" id="3353565">.</span><span class="ident" id="3353566">Next</span><span class="op" id="3353570">,</span>&nbsp;<span class="ident" id="3353572">inst</span><span class="op" id="3353576">.</span><span class="ident" id="3353577">Out</span><span class="op" id="3353580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3353585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353590">inst</span><span class="op" id="3353594">.</span><span class="ident" id="3353595">Op</span>&nbsp;<span class="op" id="3353598">=</span>&nbsp;<span class="ident" id="3353600">syntax</span><span class="op" id="3353606">.</span><span class="ident" id="3353607">InstRune</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3353618">case</span>&nbsp;<span class="ident" id="3353623">syntax</span><span class="op" id="3353629">.</span><span class="ident" id="3353630">InstRune1</span><span class="op" id="3353639">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353644">ok</span>&nbsp;<span class="op" id="3353647">=</span>&nbsp;<span class="ident" id="3353649">check</span><span class="op" id="3353654">(</span><span class="ident" id="3353655">inst</span><span class="op" id="3353659">.</span><span class="ident" id="3353660">Out</span><span class="op" id="3353663">,</span>&nbsp;<span class="ident" id="3353665">m</span><span class="op" id="3353666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353671">m</span><span class="op" id="3353672">[</span><span class="ident" id="3353673">pc</span><span class="op" id="3353675">]</span>&nbsp;<span class="op" id="3353677">=</span>&nbsp;<span class="builtintype" id="3353679">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3353688">if</span>&nbsp;<span class="builtinfunc" id="3353691">len</span><span class="op" id="3353694">(</span><span class="ident" id="3353695">inst</span><span class="op" id="3353699">.</span><span class="ident" id="3353700">Next</span><span class="op" id="3353704">)</span>&nbsp;<span class="op" id="3353706">&gt;</span>&nbsp;<span class="num" id="3353708">0</span>&nbsp;<span class="op" id="3353710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3353716">break</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3353725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353730">runes</span>&nbsp;<span class="op" id="3353736">:=</span>&nbsp;<span class="op" id="3353739">[</span><span class="op" id="3353740">]</span><span class="builtintype" id="3353741">rune</span><span class="op" id="3353745">{</span><span class="op" id="3353746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3353751">//&nbsp;expand&nbsp;case-folded&nbsp;runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3353782">if</span>&nbsp;<span class="ident" id="3353785">syntax</span><span class="op" id="3353791">.</span><span class="ident" id="3353792">Flags</span><span class="op" id="3353797">(</span><span class="ident" id="3353798">inst</span><span class="op" id="3353802">.</span><span class="ident" id="3353803">Arg</span><span class="op" id="3353806">)</span><span class="op" id="3353807">&amp;</span><span class="ident" id="3353808">syntax</span><span class="op" id="3353814">.</span><span class="ident" id="3353815">FoldCase</span>&nbsp;<span class="op" id="3353824">!=</span>&nbsp;<span class="num" id="3353827">0</span>&nbsp;<span class="op" id="3353829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353835">r0</span>&nbsp;<span class="op" id="3353838">:=</span>&nbsp;<span class="ident" id="3353841">inst</span><span class="op" id="3353845">.</span><span class="ident" id="3353846">Rune</span><span class="op" id="3353850">[</span><span class="num" id="3353851">0</span><span class="op" id="3353852">]</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353858">runes</span>&nbsp;<span class="op" id="3353864">=</span>&nbsp;<span class="builtinfunc" id="3353866">append</span><span class="op" id="3353872">(</span><span class="ident" id="3353873">runes</span><span class="op" id="3353878">,</span>&nbsp;<span class="ident" id="3353880">r0</span><span class="op" id="3353882">,</span>&nbsp;<span class="ident" id="3353884">r0</span><span class="op" id="3353886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3353892">for</span>&nbsp;<span class="ident" id="3353896">r1</span>&nbsp;<span class="op" id="3353899">:=</span>&nbsp;<span class="ident" id="3353902">unicode</span><span class="op" id="3353909">.</span><span class="ident" id="3353910">SimpleFold</span><span class="op" id="3353920">(</span><span class="ident" id="3353921">r0</span><span class="op" id="3353923">)</span><span class="op" id="3353924">;</span>&nbsp;<span class="ident" id="3353926">r1</span>&nbsp;<span class="op" id="3353929">!=</span>&nbsp;<span class="ident" id="3353932">r0</span><span class="op" id="3353934">;</span>&nbsp;<span class="ident" id="3353936">r1</span>&nbsp;<span class="op" id="3353939">=</span>&nbsp;<span class="ident" id="3353941">unicode</span><span class="op" id="3353948">.</span><span class="ident" id="3353949">SimpleFold</span><span class="op" id="3353959">(</span><span class="ident" id="3353960">r1</span><span class="op" id="3353962">)</span>&nbsp;<span class="op" id="3353964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3353971">runes</span>&nbsp;<span class="op" id="3353977">=</span>&nbsp;<span class="builtinfunc" id="3353979">append</span><span class="op" id="3353985">(</span><span class="ident" id="3353986">runes</span><span class="op" id="3353991">,</span>&nbsp;<span class="ident" id="3353993">r1</span><span class="op" id="3353995">,</span>&nbsp;<span class="ident" id="3353997">r1</span><span class="op" id="3353999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3354005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354011">sort</span><span class="op" id="3354015">.</span><span class="ident" id="3354016">Sort</span><span class="op" id="3354020">(</span><span class="ident" id="3354021">runeSlice</span><span class="op" id="3354030">(</span><span class="ident" id="3354031">runes</span><span class="op" id="3354036">)</span><span class="op" id="3354037">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3354042">}</span>&nbsp;<span class="keyword" id="3354044">else</span>&nbsp;<span class="op" id="3354049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354055">runes</span>&nbsp;<span class="op" id="3354061">=</span>&nbsp;<span class="builtinfunc" id="3354063">append</span><span class="op" id="3354069">(</span><span class="ident" id="3354070">runes</span><span class="op" id="3354075">,</span>&nbsp;<span class="ident" id="3354077">inst</span><span class="op" id="3354081">.</span><span class="ident" id="3354082">Rune</span><span class="op" id="3354086">[</span><span class="num" id="3354087">0</span><span class="op" id="3354088">]</span><span class="op" id="3354089">,</span>&nbsp;<span class="ident" id="3354091">inst</span><span class="op" id="3354095">.</span><span class="ident" id="3354096">Rune</span><span class="op" id="3354100">[</span><span class="num" id="3354101">0</span><span class="op" id="3354102">]</span><span class="op" id="3354103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3354108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354113">onePassRunes</span><span class="op" id="3354125">[</span><span class="ident" id="3354126">pc</span><span class="op" id="3354128">]</span>&nbsp;<span class="op" id="3354130">=</span>&nbsp;<span class="ident" id="3354132">runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354141">inst</span><span class="op" id="3354145">.</span><span class="ident" id="3354146">Next</span>&nbsp;<span class="op" id="3354151">=</span>&nbsp;<span class="op" id="3354153">[</span><span class="op" id="3354154">]</span><span class="builtintype" id="3354155">uint32</span><span class="op" id="3354161">{</span><span class="op" id="3354162">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3354167">for</span>&nbsp;<span class="ident" id="3354171">i</span>&nbsp;<span class="op" id="3354173">:=</span>&nbsp;<span class="builtinfunc" id="3354176">len</span><span class="op" id="3354179">(</span><span class="ident" id="3354180">onePassRunes</span><span class="op" id="3354192">[</span><span class="ident" id="3354193">pc</span><span class="op" id="3354195">]</span><span class="op" id="3354196">)</span>&nbsp;<span class="op" id="3354198">/</span>&nbsp;<span class="num" id="3354200">2</span><span class="op" id="3354201">;</span>&nbsp;<span class="ident" id="3354203">i</span>&nbsp;<span class="op" id="3354205">&gt;=</span>&nbsp;<span class="num" id="3354208">0</span><span class="op" id="3354209">;</span>&nbsp;<span class="ident" id="3354211">i</span><span class="op" id="3354212">--</span>&nbsp;<span class="op" id="3354215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354221">inst</span><span class="op" id="3354225">.</span><span class="ident" id="3354226">Next</span>&nbsp;<span class="op" id="3354231">=</span>&nbsp;<span class="builtinfunc" id="3354233">append</span><span class="op" id="3354239">(</span><span class="ident" id="3354240">inst</span><span class="op" id="3354244">.</span><span class="ident" id="3354245">Next</span><span class="op" id="3354249">,</span>&nbsp;<span class="ident" id="3354251">inst</span><span class="op" id="3354255">.</span><span class="ident" id="3354256">Out</span><span class="op" id="3354259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3354264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354269">inst</span><span class="op" id="3354273">.</span><span class="ident" id="3354274">Op</span>&nbsp;<span class="op" id="3354277">=</span>&nbsp;<span class="ident" id="3354279">syntax</span><span class="op" id="3354285">.</span><span class="ident" id="3354286">InstRune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3354297">case</span>&nbsp;<span class="ident" id="3354302">syntax</span><span class="op" id="3354308">.</span><span class="ident" id="3354309">InstRuneAny</span><span class="op" id="3354320">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354325">ok</span>&nbsp;<span class="op" id="3354328">=</span>&nbsp;<span class="ident" id="3354330">check</span><span class="op" id="3354335">(</span><span class="ident" id="3354336">inst</span><span class="op" id="3354340">.</span><span class="ident" id="3354341">Out</span><span class="op" id="3354344">,</span>&nbsp;<span class="ident" id="3354346">m</span><span class="op" id="3354347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354352">m</span><span class="op" id="3354353">[</span><span class="ident" id="3354354">pc</span><span class="op" id="3354356">]</span>&nbsp;<span class="op" id="3354358">=</span>&nbsp;<span class="builtintype" id="3354360">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3354369">if</span>&nbsp;<span class="builtinfunc" id="3354372">len</span><span class="op" id="3354375">(</span><span class="ident" id="3354376">inst</span><span class="op" id="3354380">.</span><span class="ident" id="3354381">Next</span><span class="op" id="3354385">)</span>&nbsp;<span class="op" id="3354387">&gt;</span>&nbsp;<span class="num" id="3354389">0</span>&nbsp;<span class="op" id="3354391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3354397">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3354406">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354411">onePassRunes</span><span class="op" id="3354423">[</span><span class="ident" id="3354424">pc</span><span class="op" id="3354426">]</span>&nbsp;<span class="op" id="3354428">=</span>&nbsp;<span class="builtinfunc" id="3354430">append</span><span class="op" id="3354436">(</span><span class="op" id="3354437">[</span><span class="op" id="3354438">]</span><span class="builtintype" id="3354439">rune</span><span class="op" id="3354443">{</span><span class="op" id="3354444">}</span><span class="op" id="3354445">,</span>&nbsp;<span class="ident" id="3354447">anyRune</span><span class="op" id="3354454">...</span><span class="op" id="3354457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354462">inst</span><span class="op" id="3354466">.</span><span class="ident" id="3354467">Next</span>&nbsp;<span class="op" id="3354472">=</span>&nbsp;<span class="op" id="3354474">[</span><span class="op" id="3354475">]</span><span class="builtintype" id="3354476">uint32</span><span class="op" id="3354482">{</span><span class="ident" id="3354483">inst</span><span class="op" id="3354487">.</span><span class="ident" id="3354488">Out</span><span class="op" id="3354491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3354495">case</span>&nbsp;<span class="ident" id="3354500">syntax</span><span class="op" id="3354506">.</span><span class="ident" id="3354507">InstRuneAnyNotNL</span><span class="op" id="3354523">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354528">ok</span>&nbsp;<span class="op" id="3354531">=</span>&nbsp;<span class="ident" id="3354533">check</span><span class="op" id="3354538">(</span><span class="ident" id="3354539">inst</span><span class="op" id="3354543">.</span><span class="ident" id="3354544">Out</span><span class="op" id="3354547">,</span>&nbsp;<span class="ident" id="3354549">m</span><span class="op" id="3354550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354555">m</span><span class="op" id="3354556">[</span><span class="ident" id="3354557">pc</span><span class="op" id="3354559">]</span>&nbsp;<span class="op" id="3354561">=</span>&nbsp;<span class="builtintype" id="3354563">false</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3354572">if</span>&nbsp;<span class="builtinfunc" id="3354575">len</span><span class="op" id="3354578">(</span><span class="ident" id="3354579">inst</span><span class="op" id="3354583">.</span><span class="ident" id="3354584">Next</span><span class="op" id="3354588">)</span>&nbsp;<span class="op" id="3354590">&gt;</span>&nbsp;<span class="num" id="3354592">0</span>&nbsp;<span class="op" id="3354594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3354600">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3354609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354614">onePassRunes</span><span class="op" id="3354626">[</span><span class="ident" id="3354627">pc</span><span class="op" id="3354629">]</span>&nbsp;<span class="op" id="3354631">=</span>&nbsp;<span class="builtinfunc" id="3354633">append</span><span class="op" id="3354639">(</span><span class="op" id="3354640">[</span><span class="op" id="3354641">]</span><span class="builtintype" id="3354642">rune</span><span class="op" id="3354646">{</span><span class="op" id="3354647">}</span><span class="op" id="3354648">,</span>&nbsp;<span class="ident" id="3354650">anyRuneNotNL</span><span class="op" id="3354662">...</span><span class="op" id="3354665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354670">inst</span><span class="op" id="3354674">.</span><span class="ident" id="3354675">Next</span>&nbsp;<span class="op" id="3354680">=</span>&nbsp;<span class="op" id="3354682">[</span><span class="op" id="3354683">]</span><span class="builtintype" id="3354684">uint32</span><span class="op" id="3354690">{</span><span class="op" id="3354691">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3354696">for</span>&nbsp;<span class="ident" id="3354700">i</span>&nbsp;<span class="op" id="3354702">:=</span>&nbsp;<span class="builtinfunc" id="3354705">len</span><span class="op" id="3354708">(</span><span class="ident" id="3354709">onePassRunes</span><span class="op" id="3354721">[</span><span class="ident" id="3354722">pc</span><span class="op" id="3354724">]</span><span class="op" id="3354725">)</span>&nbsp;<span class="op" id="3354727">/</span>&nbsp;<span class="num" id="3354729">2</span><span class="op" id="3354730">;</span>&nbsp;<span class="ident" id="3354732">i</span>&nbsp;<span class="op" id="3354734">&gt;=</span>&nbsp;<span class="num" id="3354737">0</span><span class="op" id="3354738">;</span>&nbsp;<span class="ident" id="3354740">i</span><span class="op" id="3354741">--</span>&nbsp;<span class="op" id="3354744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354750">inst</span><span class="op" id="3354754">.</span><span class="ident" id="3354755">Next</span>&nbsp;<span class="op" id="3354760">=</span>&nbsp;<span class="builtinfunc" id="3354762">append</span><span class="op" id="3354768">(</span><span class="ident" id="3354769">inst</span><span class="op" id="3354773">.</span><span class="ident" id="3354774">Next</span><span class="op" id="3354778">,</span>&nbsp;<span class="ident" id="3354780">inst</span><span class="op" id="3354784">.</span><span class="ident" id="3354785">Out</span><span class="op" id="3354788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3354793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3354797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3354801">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3354809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354813">instQueue</span><span class="op" id="3354822">.</span><span class="ident" id="3354823">clear</span><span class="op" id="3354828">(</span><span class="op" id="3354829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354832">instQueue</span><span class="op" id="3354841">.</span><span class="ident" id="3354842">insert</span><span class="op" id="3354848">(</span><span class="builtintype" id="3354849">uint32</span><span class="op" id="3354855">(</span><span class="ident" id="3354856">p</span><span class="op" id="3354857">.</span><span class="ident" id="3354858">Start</span><span class="op" id="3354863">)</span><span class="op" id="3354864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354867">m</span>&nbsp;<span class="op" id="3354869">:=</span>&nbsp;<span class="builtinfunc" id="3354872">make</span><span class="op" id="3354876">(</span><span class="keyword" id="3354877">map</span><span class="op" id="3354880">[</span><span class="builtintype" id="3354881">uint32</span><span class="op" id="3354887">]</span><span class="builtintype" id="3354888">bool</span><span class="op" id="3354892">,</span>&nbsp;<span class="builtinfunc" id="3354894">len</span><span class="op" id="3354897">(</span><span class="ident" id="3354898">p</span><span class="op" id="3354899">.</span><span class="ident" id="3354900">Inst</span><span class="op" id="3354904">)</span><span class="op" id="3354905">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3354908">for</span>&nbsp;<span class="op" id="3354912">!</span><span class="ident" id="3354913">instQueue</span><span class="op" id="3354922">.</span><span class="ident" id="3354923">empty</span><span class="op" id="3354928">(</span><span class="op" id="3354929">)</span>&nbsp;<span class="op" id="3354931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354935">pc</span>&nbsp;<span class="op" id="3354938">:=</span>&nbsp;<span class="ident" id="3354941">instQueue</span><span class="op" id="3354950">.</span><span class="ident" id="3354951">next</span><span class="op" id="3354955">(</span><span class="op" id="3354956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354960">inst</span>&nbsp;<span class="op" id="3354965">:=</span>&nbsp;<span class="ident" id="3354968">p</span><span class="op" id="3354969">.</span><span class="ident" id="3354970">Inst</span><span class="op" id="3354974">[</span><span class="ident" id="3354975">pc</span><span class="op" id="3354977">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3354981">visitQueue</span><span class="op" id="3354991">.</span><span class="ident" id="3354992">clear</span><span class="op" id="3354997">(</span><span class="op" id="3354998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355002">if</span>&nbsp;<span class="op" id="3355005">!</span><span class="ident" id="3355006">check</span><span class="op" id="3355011">(</span><span class="builtintype" id="3355012">uint32</span><span class="op" id="3355018">(</span><span class="ident" id="3355019">pc</span><span class="op" id="3355021">)</span><span class="op" id="3355022">,</span>&nbsp;<span class="ident" id="3355024">m</span><span class="op" id="3355025">)</span>&nbsp;<span class="op" id="3355027">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355032">p</span>&nbsp;<span class="op" id="3355034">=</span>&nbsp;<span class="ident" id="3355036">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355050">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3355058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355062">switch</span>&nbsp;<span class="ident" id="3355069">inst</span><span class="op" id="3355073">.</span><span class="ident" id="3355074">Op</span>&nbsp;<span class="op" id="3355077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355081">case</span>&nbsp;<span class="ident" id="3355086">syntax</span><span class="op" id="3355092">.</span><span class="ident" id="3355093">InstAlt</span><span class="op" id="3355100">,</span>&nbsp;<span class="ident" id="3355102">syntax</span><span class="op" id="3355108">.</span><span class="ident" id="3355109">InstAltMatch</span><span class="op" id="3355121">:</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355126">instQueue</span><span class="op" id="3355135">.</span><span class="ident" id="3355136">insert</span><span class="op" id="3355142">(</span><span class="ident" id="3355143">inst</span><span class="op" id="3355147">.</span><span class="ident" id="3355148">Out</span><span class="op" id="3355151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355156">instQueue</span><span class="op" id="3355165">.</span><span class="ident" id="3355166">insert</span><span class="op" id="3355172">(</span><span class="ident" id="3355173">inst</span><span class="op" id="3355177">.</span><span class="ident" id="3355178">Arg</span><span class="op" id="3355181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355185">case</span>&nbsp;<span class="ident" id="3355190">syntax</span><span class="op" id="3355196">.</span><span class="ident" id="3355197">InstCapture</span><span class="op" id="3355208">,</span>&nbsp;<span class="ident" id="3355210">syntax</span><span class="op" id="3355216">.</span><span class="ident" id="3355217">InstEmptyWidth</span><span class="op" id="3355231">,</span>&nbsp;<span class="ident" id="3355233">syntax</span><span class="op" id="3355239">.</span><span class="ident" id="3355240">InstNop</span><span class="op" id="3355247">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355252">instQueue</span><span class="op" id="3355261">.</span><span class="ident" id="3355262">insert</span><span class="op" id="3355268">(</span><span class="ident" id="3355269">inst</span><span class="op" id="3355273">.</span><span class="ident" id="3355274">Out</span><span class="op" id="3355277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355281">case</span>&nbsp;<span class="ident" id="3355286">syntax</span><span class="op" id="3355292">.</span><span class="ident" id="3355293">InstMatch</span><span class="op" id="3355302">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355306">case</span>&nbsp;<span class="ident" id="3355311">syntax</span><span class="op" id="3355317">.</span><span class="ident" id="3355318">InstFail</span><span class="op" id="3355326">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355330">case</span>&nbsp;<span class="ident" id="3355335">syntax</span><span class="op" id="3355341">.</span><span class="ident" id="3355342">InstRune</span><span class="op" id="3355350">,</span>&nbsp;<span class="ident" id="3355352">syntax</span><span class="op" id="3355358">.</span><span class="ident" id="3355359">InstRune1</span><span class="op" id="3355368">,</span>&nbsp;<span class="ident" id="3355370">syntax</span><span class="op" id="3355376">.</span><span class="ident" id="3355377">InstRuneAny</span><span class="op" id="3355388">,</span>&nbsp;<span class="ident" id="3355390">syntax</span><span class="op" id="3355396">.</span><span class="ident" id="3355397">InstRuneAnyNotNL</span><span class="op" id="3355413">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355417">default</span><span class="op" id="3355424">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3355428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3355431">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355434">if</span>&nbsp;<span class="ident" id="3355437">p</span>&nbsp;<span class="op" id="3355439">!=</span>&nbsp;<span class="ident" id="3355442">notOnePass</span>&nbsp;<span class="op" id="3355453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355457">for</span>&nbsp;<span class="ident" id="3355461">i</span>&nbsp;<span class="op" id="3355463">:=</span>&nbsp;<span class="keyword" id="3355466">range</span>&nbsp;<span class="ident" id="3355472">p</span><span class="op" id="3355473">.</span><span class="ident" id="3355474">Inst</span>&nbsp;<span class="op" id="3355479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355484">p</span><span class="op" id="3355485">.</span><span class="ident" id="3355486">Inst</span><span class="op" id="3355490">[</span><span class="ident" id="3355491">i</span><span class="op" id="3355492">]</span><span class="op" id="3355493">.</span><span class="ident" id="3355494">Rune</span>&nbsp;<span class="op" id="3355499">=</span>&nbsp;<span class="ident" id="3355501">onePassRunes</span><span class="op" id="3355513">[</span><span class="ident" id="3355514">i</span><span class="op" id="3355515">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3355519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3355522">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355525">return</span>&nbsp;<span class="ident" id="3355532">p</span><br>
<span class="lineno"></span><span class="op" id="3355534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3355537">//&nbsp;walk&nbsp;visits&nbsp;each&nbsp;Inst&nbsp;in&nbsp;the&nbsp;prog&nbsp;once,&nbsp;and&nbsp;applies&nbsp;the&nbsp;argument</span><br>
<span class="lineno"></span><span class="comment" id="3355605">//&nbsp;function(ip,&nbsp;next),&nbsp;in&nbsp;pre-order.</span><br>
<span class="lineno">495</span><span class="keyword" id="3355642">func</span>&nbsp;<span class="ident" id="3355647">walk</span><span class="op" id="3355651">(</span><span class="ident" id="3355652">prog</span>&nbsp;<span class="op" id="3355657">*</span><span class="ident" id="3355658">syntax</span><span class="op" id="3355664">.</span><span class="ident" id="3355665">Prog</span><span class="op" id="3355669">,</span>&nbsp;<span class="ident" id="3355671">funcs</span>&nbsp;<span class="op" id="3355677">...</span><span class="keyword" id="3355680">func</span><span class="op" id="3355684">(</span><span class="ident" id="3355685">ip</span><span class="op" id="3355687">,</span>&nbsp;<span class="ident" id="3355689">next</span>&nbsp;<span class="builtintype" id="3355694">uint32</span><span class="op" id="3355700">)</span><span class="op" id="3355701">)</span>&nbsp;<span class="op" id="3355703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355706">var</span>&nbsp;<span class="ident" id="3355710">walk1</span>&nbsp;<span class="keyword" id="3355716">func</span><span class="op" id="3355720">(</span><span class="builtintype" id="3355721">uint32</span><span class="op" id="3355727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355730">progQueue</span>&nbsp;<span class="op" id="3355740">:=</span>&nbsp;<span class="ident" id="3355743">newQueue</span><span class="op" id="3355751">(</span><span class="builtinfunc" id="3355752">len</span><span class="op" id="3355755">(</span><span class="ident" id="3355756">prog</span><span class="op" id="3355760">.</span><span class="ident" id="3355761">Inst</span><span class="op" id="3355765">)</span><span class="op" id="3355766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355769">walk1</span>&nbsp;<span class="op" id="3355775">=</span>&nbsp;<span class="keyword" id="3355777">func</span><span class="op" id="3355781">(</span><span class="ident" id="3355782">ip</span>&nbsp;<span class="builtintype" id="3355785">uint32</span><span class="op" id="3355791">)</span>&nbsp;<span class="op" id="3355793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355797">if</span>&nbsp;<span class="ident" id="3355800">progQueue</span><span class="op" id="3355809">.</span><span class="ident" id="3355810">contains</span><span class="op" id="3355818">(</span><span class="ident" id="3355819">ip</span><span class="op" id="3355821">)</span>&nbsp;<span class="op" id="3355823">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355828">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3355837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355841">progQueue</span><span class="op" id="3355850">.</span><span class="ident" id="3355851">insert</span><span class="op" id="3355857">(</span><span class="ident" id="3355858">ip</span><span class="op" id="3355860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355864">inst</span>&nbsp;<span class="op" id="3355869">:=</span>&nbsp;<span class="ident" id="3355872">prog</span><span class="op" id="3355876">.</span><span class="ident" id="3355877">Inst</span><span class="op" id="3355881">[</span><span class="ident" id="3355882">ip</span><span class="op" id="3355884">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355888">switch</span>&nbsp;<span class="ident" id="3355895">inst</span><span class="op" id="3355899">.</span><span class="ident" id="3355900">Op</span>&nbsp;<span class="op" id="3355903">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355907">case</span>&nbsp;<span class="ident" id="3355912">syntax</span><span class="op" id="3355918">.</span><span class="ident" id="3355919">InstAlt</span><span class="op" id="3355926">,</span>&nbsp;<span class="ident" id="3355928">syntax</span><span class="op" id="3355934">.</span><span class="ident" id="3355935">InstAltMatch</span><span class="op" id="3355947">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3355952">for</span>&nbsp;<span class="ident" id="3355956">_</span><span class="op" id="3355957">,</span>&nbsp;<span class="ident" id="3355959">f</span>&nbsp;<span class="op" id="3355961">:=</span>&nbsp;<span class="keyword" id="3355964">range</span>&nbsp;<span class="ident" id="3355970">funcs</span>&nbsp;<span class="op" id="3355976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3355982">f</span><span class="op" id="3355983">(</span><span class="ident" id="3355984">ip</span><span class="op" id="3355986">,</span>&nbsp;<span class="ident" id="3355988">inst</span><span class="op" id="3355992">.</span><span class="ident" id="3355993">Out</span><span class="op" id="3355996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356002">f</span><span class="op" id="3356003">(</span><span class="ident" id="3356004">ip</span><span class="op" id="3356006">,</span>&nbsp;<span class="ident" id="3356008">inst</span><span class="op" id="3356012">.</span><span class="ident" id="3356013">Arg</span><span class="op" id="3356016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3356021">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356026">walk1</span><span class="op" id="3356031">(</span><span class="ident" id="3356032">inst</span><span class="op" id="3356036">.</span><span class="ident" id="3356037">Out</span><span class="op" id="3356040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356045">walk1</span><span class="op" id="3356050">(</span><span class="ident" id="3356051">inst</span><span class="op" id="3356055">.</span><span class="ident" id="3356056">Arg</span><span class="op" id="3356059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3356063">default</span><span class="op" id="3356070">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3356075">for</span>&nbsp;<span class="ident" id="3356079">_</span><span class="op" id="3356080">,</span>&nbsp;<span class="ident" id="3356082">f</span>&nbsp;<span class="op" id="3356084">:=</span>&nbsp;<span class="keyword" id="3356087">range</span>&nbsp;<span class="ident" id="3356093">funcs</span>&nbsp;<span class="op" id="3356099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356105">f</span><span class="op" id="3356106">(</span><span class="ident" id="3356107">ip</span><span class="op" id="3356109">,</span>&nbsp;<span class="ident" id="3356111">inst</span><span class="op" id="3356115">.</span><span class="ident" id="3356116">Out</span><span class="op" id="3356119">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3356124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356129">walk1</span><span class="op" id="3356134">(</span><span class="ident" id="3356135">inst</span><span class="op" id="3356139">.</span><span class="ident" id="3356140">Out</span><span class="op" id="3356143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3356147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3356150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356153">walk1</span><span class="op" id="3356158">(</span><span class="builtintype" id="3356159">uint32</span><span class="op" id="3356165">(</span><span class="ident" id="3356166">prog</span><span class="op" id="3356170">.</span><span class="ident" id="3356171">Start</span><span class="op" id="3356176">)</span><span class="op" id="3356177">)</span><br>
<span class="lineno">520</span><span class="op" id="3356179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3356182">//&nbsp;find&nbsp;returns&nbsp;the&nbsp;Insts&nbsp;that&nbsp;match&nbsp;the&nbsp;argument&nbsp;predicate&nbsp;function</span><br>
<span class="lineno"></span><span class="keyword" id="3356251">func</span>&nbsp;<span class="ident" id="3356256">find</span><span class="op" id="3356260">(</span><span class="ident" id="3356261">prog</span>&nbsp;<span class="op" id="3356266">*</span><span class="ident" id="3356267">syntax</span><span class="op" id="3356273">.</span><span class="ident" id="3356274">Prog</span><span class="op" id="3356278">,</span>&nbsp;<span class="ident" id="3356280">f</span>&nbsp;<span class="keyword" id="3356282">func</span><span class="op" id="3356286">(</span><span class="op" id="3356287">*</span><span class="ident" id="3356288">syntax</span><span class="op" id="3356294">.</span><span class="ident" id="3356295">Prog</span><span class="op" id="3356299">,</span>&nbsp;<span class="builtintype" id="3356301">int</span><span class="op" id="3356304">)</span>&nbsp;<span class="builtintype" id="3356306">bool</span><span class="op" id="3356310">)</span>&nbsp;<span class="op" id="3356312">(</span><span class="ident" id="3356313">matches</span>&nbsp;<span class="op" id="3356321">[</span><span class="op" id="3356322">]</span><span class="builtintype" id="3356323">uint32</span><span class="op" id="3356329">)</span>&nbsp;<span class="op" id="3356331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356334">matches</span>&nbsp;<span class="op" id="3356342">=</span>&nbsp;<span class="op" id="3356344">[</span><span class="op" id="3356345">]</span><span class="builtintype" id="3356346">uint32</span><span class="op" id="3356352">{</span><span class="op" id="3356353">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3356357">for</span>&nbsp;<span class="ident" id="3356361">ip</span>&nbsp;<span class="op" id="3356364">:=</span>&nbsp;<span class="keyword" id="3356367">range</span>&nbsp;<span class="ident" id="3356373">prog</span><span class="op" id="3356377">.</span><span class="ident" id="3356378">Inst</span>&nbsp;<span class="op" id="3356383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3356387">if</span>&nbsp;<span class="ident" id="3356390">f</span><span class="op" id="3356391">(</span><span class="ident" id="3356392">prog</span><span class="op" id="3356396">,</span>&nbsp;<span class="ident" id="3356398">ip</span><span class="op" id="3356400">)</span>&nbsp;<span class="op" id="3356402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3356407">matches</span>&nbsp;<span class="op" id="3356415">=</span>&nbsp;<span class="builtinfunc" id="3356417">append</span><span class="op" id="3356423">(</span><span class="ident" id="3356424">matches</span><span class="op" id="3356431">,</span>&nbsp;<span class="builtintype" id="3356433">uint32</span><span class="op" id="3356439">(</span><span class="ident" id="3356440">ip</span><span class="op" id="3356442">)</span><span class="op" id="3356443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3356447">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3356450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3356453">return</span><br>
<span class="lineno"></span><span class="op" id="3356460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3356463">var</span>&nbsp;<span class="ident" id="3356467">notOnePass</span>&nbsp;<span class="op" id="3356478">*</span><span class="ident" id="3356479">onePassProg</span>&nbsp;<span class="op" id="3356491">=</span>&nbsp;<span class="ident" id="3356493">nil</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span><span class="comment" id="3356498">//&nbsp;compileOnePass&nbsp;returns&nbsp;a&nbsp;new&nbsp;*syntax.Prog&nbsp;suitable&nbsp;for&nbsp;onePass&nbsp;execution&nbsp;if&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span><span class="comment" id="3356595">//&nbsp;can&nbsp;be&nbsp;recharacterized&nbsp;as&nbsp;a&nbsp;one-pass&nbsp;regexp&nbsp;program,&nbsp;or&nbsp;syntax.notOnePass&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3356679">//&nbsp;Prog&nbsp;cannot&nbsp;be&nbsp;converted.&nbsp;For&nbsp;a&nbsp;one&nbsp;pass&nbsp;prog,&nbsp;the&nbsp;fundamental&nbsp;condition&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="3356765">//&nbsp;be&nbsp;true&nbsp;is:&nbsp;at&nbsp;any&nbsp;InstAlt,&nbsp;there&nbsp;must&nbsp;be&nbsp;no&nbsp;ambiguity&nbsp;about&nbsp;what&nbsp;branch&nbsp;to&nbsp;&nbsp;take.</span><br>
<span class="lineno">540</span><span class="keyword" id="3356851">func</span>&nbsp;<span class="ident" id="3356856">compileOnePass</span><span class="op" id="3356870">(</span><span class="ident" id="3356871">prog</span>&nbsp;<span class="op" id="3356876">*</span><span class="ident" id="3356877">syntax</span><span class="op" id="3356883">.</span><span class="ident" id="3356884">Prog</span><span class="op" id="3356888">)</span>&nbsp;<span class="op" id="3356890">(</span><span class="ident" id="3356891">p</span>&nbsp;<span class="op" id="3356893">*</span><span class="ident" id="3356894">onePassProg</span><span class="op" id="3356905">)</span>&nbsp;<span class="op" id="3356907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3356910">if</span>&nbsp;<span class="ident" id="3356913">prog</span><span class="op" id="3356917">.</span><span class="ident" id="3356918">Start</span>&nbsp;<span class="op" id="3356924">==</span>&nbsp;<span class="num" id="3356927">0</span>&nbsp;<span class="op" id="3356929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3356933">return</span>&nbsp;<span class="ident" id="3356940">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3356952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3356955">//&nbsp;onepass&nbsp;regexp&nbsp;is&nbsp;anchored</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3356986">if</span>&nbsp;<span class="ident" id="3356989">prog</span><span class="op" id="3356993">.</span><span class="ident" id="3356994">Inst</span><span class="op" id="3356998">[</span><span class="ident" id="3356999">prog</span><span class="op" id="3357003">.</span><span class="ident" id="3357004">Start</span><span class="op" id="3357009">]</span><span class="op" id="3357010">.</span><span class="ident" id="3357011">Op</span>&nbsp;<span class="op" id="3357014">!=</span>&nbsp;<span class="ident" id="3357017">syntax</span><span class="op" id="3357023">.</span><span class="ident" id="3357024">InstEmptyWidth</span>&nbsp;<span class="op" id="3357039">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3357044">syntax</span><span class="op" id="3357050">.</span><span class="ident" id="3357051">EmptyOp</span><span class="op" id="3357058">(</span><span class="ident" id="3357059">prog</span><span class="op" id="3357063">.</span><span class="ident" id="3357064">Inst</span><span class="op" id="3357068">[</span><span class="ident" id="3357069">prog</span><span class="op" id="3357073">.</span><span class="ident" id="3357074">Start</span><span class="op" id="3357079">]</span><span class="op" id="3357080">.</span><span class="ident" id="3357081">Arg</span><span class="op" id="3357084">)</span><span class="op" id="3357085">&amp;</span><span class="ident" id="3357086">syntax</span><span class="op" id="3357092">.</span><span class="ident" id="3357093">EmptyBeginText</span>&nbsp;<span class="op" id="3357108">!=</span>&nbsp;<span class="ident" id="3357111">syntax</span><span class="op" id="3357117">.</span><span class="ident" id="3357118">EmptyBeginText</span>&nbsp;<span class="op" id="3357133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357137">return</span>&nbsp;<span class="ident" id="3357144">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3357156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3357159">//&nbsp;every&nbsp;instruction&nbsp;leading&nbsp;to&nbsp;InstMatch&nbsp;must&nbsp;be&nbsp;EmptyEndText</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357223">for</span>&nbsp;<span class="ident" id="3357227">_</span><span class="op" id="3357228">,</span>&nbsp;<span class="ident" id="3357230">inst</span>&nbsp;<span class="op" id="3357235">:=</span>&nbsp;<span class="keyword" id="3357238">range</span>&nbsp;<span class="ident" id="3357244">prog</span><span class="op" id="3357248">.</span><span class="ident" id="3357249">Inst</span>&nbsp;<span class="op" id="3357254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3357258">opOut</span>&nbsp;<span class="op" id="3357264">:=</span>&nbsp;<span class="ident" id="3357267">prog</span><span class="op" id="3357271">.</span><span class="ident" id="3357272">Inst</span><span class="op" id="3357276">[</span><span class="ident" id="3357277">inst</span><span class="op" id="3357281">.</span><span class="ident" id="3357282">Out</span><span class="op" id="3357285">]</span><span class="op" id="3357286">.</span><span class="ident" id="3357287">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357292">switch</span>&nbsp;<span class="ident" id="3357299">inst</span><span class="op" id="3357303">.</span><span class="ident" id="3357304">Op</span>&nbsp;<span class="op" id="3357307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357311">default</span><span class="op" id="3357318">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357323">if</span>&nbsp;<span class="ident" id="3357326">opOut</span>&nbsp;<span class="op" id="3357332">==</span>&nbsp;<span class="ident" id="3357335">syntax</span><span class="op" id="3357341">.</span><span class="ident" id="3357342">InstMatch</span>&nbsp;<span class="op" id="3357352">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357358">return</span>&nbsp;<span class="ident" id="3357365">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3357379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357383">case</span>&nbsp;<span class="ident" id="3357388">syntax</span><span class="op" id="3357394">.</span><span class="ident" id="3357395">InstAlt</span><span class="op" id="3357402">,</span>&nbsp;<span class="ident" id="3357404">syntax</span><span class="op" id="3357410">.</span><span class="ident" id="3357411">InstAltMatch</span><span class="op" id="3357423">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357428">if</span>&nbsp;<span class="ident" id="3357431">opOut</span>&nbsp;<span class="op" id="3357437">==</span>&nbsp;<span class="ident" id="3357440">syntax</span><span class="op" id="3357446">.</span><span class="ident" id="3357447">InstMatch</span>&nbsp;<span class="op" id="3357457">||</span>&nbsp;<span class="ident" id="3357460">prog</span><span class="op" id="3357464">.</span><span class="ident" id="3357465">Inst</span><span class="op" id="3357469">[</span><span class="ident" id="3357470">inst</span><span class="op" id="3357474">.</span><span class="ident" id="3357475">Arg</span><span class="op" id="3357478">]</span><span class="op" id="3357479">.</span><span class="ident" id="3357480">Op</span>&nbsp;<span class="op" id="3357483">==</span>&nbsp;<span class="ident" id="3357486">syntax</span><span class="op" id="3357492">.</span><span class="ident" id="3357493">InstMatch</span>&nbsp;<span class="op" id="3357503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357509">return</span>&nbsp;<span class="ident" id="3357516">notOnePass</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3357530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357534">case</span>&nbsp;<span class="ident" id="3357539">syntax</span><span class="op" id="3357545">.</span><span class="ident" id="3357546">InstEmptyWidth</span><span class="op" id="3357560">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357565">if</span>&nbsp;<span class="ident" id="3357568">opOut</span>&nbsp;<span class="op" id="3357574">==</span>&nbsp;<span class="ident" id="3357577">syntax</span><span class="op" id="3357583">.</span><span class="ident" id="3357584">InstMatch</span>&nbsp;<span class="op" id="3357594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357600">if</span>&nbsp;<span class="ident" id="3357603">syntax</span><span class="op" id="3357609">.</span><span class="ident" id="3357610">EmptyOp</span><span class="op" id="3357617">(</span><span class="ident" id="3357618">inst</span><span class="op" id="3357622">.</span><span class="ident" id="3357623">Arg</span><span class="op" id="3357626">)</span><span class="op" id="3357627">&amp;</span><span class="ident" id="3357628">syntax</span><span class="op" id="3357634">.</span><span class="ident" id="3357635">EmptyEndText</span>&nbsp;<span class="op" id="3357648">==</span>&nbsp;<span class="ident" id="3357651">syntax</span><span class="op" id="3357657">.</span><span class="ident" id="3357658">EmptyEndText</span>&nbsp;<span class="op" id="3357671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357678">continue</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3357691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357697">return</span>&nbsp;<span class="ident" id="3357704">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3357718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3357722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3357725">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3357728">//&nbsp;Creates&nbsp;a&nbsp;slightly&nbsp;optimized&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3357787">//&nbsp;that&nbsp;cleans&nbsp;up&nbsp;some&nbsp;Prog&nbsp;idioms&nbsp;that&nbsp;block&nbsp;valid&nbsp;onepass&nbsp;programs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3357857">p</span>&nbsp;<span class="op" id="3357859">=</span>&nbsp;<span class="ident" id="3357861">onePassCopy</span><span class="op" id="3357872">(</span><span class="ident" id="3357873">prog</span><span class="op" id="3357877">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3357881">//&nbsp;checkAmbiguity&nbsp;on&nbsp;InstAlts,&nbsp;build&nbsp;onepass&nbsp;Prog&nbsp;if&nbsp;possible</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3357944">p</span>&nbsp;<span class="op" id="3357946">=</span>&nbsp;<span class="ident" id="3357948">makeOnePass</span><span class="op" id="3357959">(</span><span class="ident" id="3357960">p</span><span class="op" id="3357961">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3357965">if</span>&nbsp;<span class="ident" id="3357968">p</span>&nbsp;<span class="op" id="3357970">!=</span>&nbsp;<span class="ident" id="3357973">notOnePass</span>&nbsp;<span class="op" id="3357984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3357988">cleanupOnePass</span><span class="op" id="3358002">(</span><span class="ident" id="3358003">p</span><span class="op" id="3358004">,</span>&nbsp;<span class="ident" id="3358006">prog</span><span class="op" id="3358010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3358013">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3358016">return</span>&nbsp;<span class="ident" id="3358023">p</span><br>
<span class="lineno"></span><span class="op" id="3358025">}</span>
</div>
</body>
</html>
