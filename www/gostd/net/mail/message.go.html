<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/mail</h2>
<ul>
<li><a href="/gostd/net/mail/message.go.html" class="current">message.go</a></li>
<li><a href="/gostd/net/mail/message_test.go.html">message_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6046222">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6046277">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6046331">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6046382">/*<br>
<span class="lineno"></span>Package&nbsp;mail&nbsp;implements&nbsp;parsing&nbsp;of&nbsp;mail&nbsp;messages.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>For&nbsp;the&nbsp;most&nbsp;part,&nbsp;this&nbsp;package&nbsp;follows&nbsp;the&nbsp;syntax&nbsp;as&nbsp;specified&nbsp;by&nbsp;RFC&nbsp;5322.<br>
<span class="lineno"></span>Notable&nbsp;divergences:<br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp*&nbsp;Obsolete&nbsp;address&nbsp;formats&nbsp;are&nbsp;not&nbsp;parsed,&nbsp;including&nbsp;addresses&nbsp;with<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;embedded&nbsp;route&nbsp;information.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp*&nbsp;Group&nbsp;addresses&nbsp;are&nbsp;not&nbsp;parsed.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp*&nbsp;The&nbsp;full&nbsp;range&nbsp;of&nbsp;spacing&nbsp;(the&nbsp;CFWS&nbsp;syntax&nbsp;element)&nbsp;is&nbsp;not&nbsp;supported,<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;such&nbsp;as&nbsp;breaking&nbsp;addresses&nbsp;across&nbsp;lines.<br>
<span class="lineno">15</span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="6046789">package</span>&nbsp;<span class="ident" id="6046797">mail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6046803">import</span>&nbsp;<span class="op" id="6046810">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6046813">&#34;bufio&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6046822">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6046831">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6046850">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6046860">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6046867">&#34;io&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6046873">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6046886">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6046893">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6046910">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6046921">&#34;strings&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6046932">&#34;time&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6046940">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op" id="6046950">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6046953">var</span>&nbsp;<span class="ident" id="6046957">debug</span>&nbsp;<span class="op" id="6046963">=</span>&nbsp;<span class="ident" id="6046965">debugT</span><span class="op" id="6046971">(</span><span class="builtintype" id="6046972">false</span><span class="op" id="6046977">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="6046980">type</span>&nbsp;<span class="ident" id="6046985">debugT</span>&nbsp;<span class="builtintype" id="6046992">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6046998">func</span>&nbsp;<span class="op" id="6047003">(</span><span class="ident" id="6047004">d</span>&nbsp;<span class="ident" id="6047006">debugT</span><span class="op" id="6047012">)</span>&nbsp;<span class="ident" id="6047014">Printf</span><span class="op" id="6047020">(</span><span class="ident" id="6047021">format</span>&nbsp;<span class="builtintype" id="6047028">string</span><span class="op" id="6047034">,</span>&nbsp;<span class="ident" id="6047036">args</span>&nbsp;<span class="op" id="6047041">...</span><span class="keyword" id="6047044">interface</span><span class="op" id="6047053">{</span><span class="op" id="6047054">}</span><span class="op" id="6047055">)</span>&nbsp;<span class="op" id="6047057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6047060">if</span>&nbsp;<span class="ident" id="6047063">d</span>&nbsp;<span class="op" id="6047065">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047069">log</span><span class="op" id="6047072">.</span><span class="ident" id="6047073">Printf</span><span class="op" id="6047079">(</span><span class="ident" id="6047080">format</span><span class="op" id="6047086">,</span>&nbsp;<span class="ident" id="6047088">args</span><span class="op" id="6047092">...</span><span class="op" id="6047095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6047098">}</span><br>
<span class="lineno"></span><span class="op" id="6047100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6047103">//&nbsp;A&nbsp;Message&nbsp;represents&nbsp;a&nbsp;parsed&nbsp;mail&nbsp;message.</span><br>
<span class="lineno">45</span><span class="keyword" id="6047150">type</span>&nbsp;<span class="ident" id="6047155">Message</span>&nbsp;<span class="keyword" id="6047163">struct</span>&nbsp;<span class="op" id="6047170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047173">Header</span>&nbsp;<span class="ident" id="6047180">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047188">Body</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6047195">io</span><span class="op" id="6047197">.</span><span class="ident" id="6047198">Reader</span><br>
<span class="lineno"></span><span class="op" id="6047205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="6047208">//&nbsp;ReadMessage&nbsp;reads&nbsp;a&nbsp;message&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="6047247">//&nbsp;The&nbsp;headers&nbsp;are&nbsp;parsed,&nbsp;and&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;message&nbsp;will&nbsp;be&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="6047320">//&nbsp;for&nbsp;reading&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="6047343">func</span>&nbsp;<span class="ident" id="6047348">ReadMessage</span><span class="op" id="6047359">(</span><span class="ident" id="6047360">r</span>&nbsp;<span class="ident" id="6047362">io</span><span class="op" id="6047364">.</span><span class="ident" id="6047365">Reader</span><span class="op" id="6047371">)</span>&nbsp;<span class="op" id="6047373">(</span><span class="ident" id="6047374">msg</span>&nbsp;<span class="op" id="6047378">*</span><span class="ident" id="6047379">Message</span><span class="op" id="6047386">,</span>&nbsp;<span class="ident" id="6047388">err</span>&nbsp;<span class="builtintype" id="6047392">error</span><span class="op" id="6047397">)</span>&nbsp;<span class="op" id="6047399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047402">tp</span>&nbsp;<span class="op" id="6047405">:=</span>&nbsp;<span class="ident" id="6047408">textproto</span><span class="op" id="6047417">.</span><span class="ident" id="6047418">NewReader</span><span class="op" id="6047427">(</span><span class="ident" id="6047428">bufio</span><span class="op" id="6047433">.</span><span class="ident" id="6047434">NewReader</span><span class="op" id="6047443">(</span><span class="ident" id="6047444">r</span><span class="op" id="6047445">)</span><span class="op" id="6047446">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047450">hdr</span><span class="op" id="6047453">,</span>&nbsp;<span class="ident" id="6047455">err</span>&nbsp;<span class="op" id="6047459">:=</span>&nbsp;<span class="ident" id="6047462">tp</span><span class="op" id="6047464">.</span><span class="ident" id="6047465">ReadMIMEHeader</span><span class="op" id="6047479">(</span><span class="op" id="6047480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6047483">if</span>&nbsp;<span class="ident" id="6047486">err</span>&nbsp;<span class="op" id="6047490">!=</span>&nbsp;<span class="ident" id="6047493">nil</span>&nbsp;<span class="op" id="6047497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6047501">return</span>&nbsp;<span class="ident" id="6047508">nil</span><span class="op" id="6047511">,</span>&nbsp;<span class="ident" id="6047513">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6047518">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6047522">return</span>&nbsp;<span class="op" id="6047529">&amp;</span><span class="ident" id="6047530">Message</span><span class="op" id="6047537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047541">Header</span><span class="op" id="6047547">:</span>&nbsp;<span class="ident" id="6047549">Header</span><span class="op" id="6047555">(</span><span class="ident" id="6047556">hdr</span><span class="op" id="6047559">)</span><span class="op" id="6047560">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047564">Body</span><span class="op" id="6047568">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6047572">tp</span><span class="op" id="6047574">.</span><span class="ident" id="6047575">R</span><span class="op" id="6047576">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6047579">}</span><span class="op" id="6047580">,</span>&nbsp;<span class="ident" id="6047582">nil</span><br>
<span class="lineno">65</span><span class="op" id="6047586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6047589">//&nbsp;Layouts&nbsp;suitable&nbsp;for&nbsp;passing&nbsp;to&nbsp;time.Parse.</span><br>
<span class="lineno"></span><span class="comment" id="6047636">//&nbsp;These&nbsp;are&nbsp;tried&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="keyword" id="6047665">var</span>&nbsp;<span class="ident" id="6047669">dateLayouts</span>&nbsp;<span class="op" id="6047681">[</span><span class="op" id="6047682">]</span><span class="builtintype" id="6047683">string</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="6047691">func</span>&nbsp;<span class="ident" id="6047696">init</span><span class="op" id="6047700">(</span><span class="op" id="6047701">)</span>&nbsp;<span class="op" id="6047703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6047706">//&nbsp;Generate&nbsp;layouts&nbsp;based&nbsp;on&nbsp;RFC&nbsp;5322,&nbsp;section&nbsp;3.3.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047760">dows</span>&nbsp;<span class="op" id="6047765">:=</span>&nbsp;<span class="op" id="6047768">[</span><span class="op" id="6047769">...</span><span class="op" id="6047772">]</span><span class="builtintype" id="6047773">string</span><span class="op" id="6047779">{</span><span class="string" id="6047780">&#34;&#34;</span><span class="op" id="6047782">,</span>&nbsp;<span class="string" id="6047784">&#34;Mon,&nbsp;&#34;</span><span class="op" id="6047791">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="6047795">//&nbsp;day-of-week</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047811">days</span>&nbsp;<span class="op" id="6047816">:=</span>&nbsp;<span class="op" id="6047819">[</span><span class="op" id="6047820">...</span><span class="op" id="6047823">]</span><span class="builtintype" id="6047824">string</span><span class="op" id="6047830">{</span><span class="string" id="6047831">&#34;2&#34;</span><span class="op" id="6047834">,</span>&nbsp;<span class="string" id="6047836">&#34;02&#34;</span><span class="op" id="6047840">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6047846">//&nbsp;day&nbsp;=&nbsp;1*2DIGIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047865">years</span>&nbsp;<span class="op" id="6047871">:=</span>&nbsp;<span class="op" id="6047874">[</span><span class="op" id="6047875">...</span><span class="op" id="6047878">]</span><span class="builtintype" id="6047879">string</span><span class="op" id="6047885">{</span><span class="string" id="6047886">&#34;2006&#34;</span><span class="op" id="6047892">,</span>&nbsp;<span class="string" id="6047894">&#34;06&#34;</span><span class="op" id="6047898">}</span>&nbsp;<span class="comment" id="6047900">//&nbsp;year&nbsp;=&nbsp;4*DIGIT&nbsp;/&nbsp;2*DIGIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047929">seconds</span>&nbsp;<span class="op" id="6047937">:=</span>&nbsp;<span class="op" id="6047940">[</span><span class="op" id="6047941">...</span><span class="op" id="6047944">]</span><span class="builtintype" id="6047945">string</span><span class="op" id="6047951">{</span><span class="string" id="6047952">&#34;:05&#34;</span><span class="op" id="6047957">,</span>&nbsp;<span class="string" id="6047959">&#34;&#34;</span><span class="op" id="6047961">}</span>&nbsp;&nbsp;<span class="comment" id="6047964">//&nbsp;second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6047975">//&nbsp;&#34;-0700&nbsp;(MST)&#34;&nbsp;is&nbsp;not&nbsp;in&nbsp;RFC&nbsp;5322,&nbsp;but&nbsp;is&nbsp;common.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048028">zones</span>&nbsp;<span class="op" id="6048034">:=</span>&nbsp;<span class="op" id="6048037">[</span><span class="op" id="6048038">...</span><span class="op" id="6048041">]</span><span class="builtintype" id="6048042">string</span><span class="op" id="6048048">{</span><span class="string" id="6048049">&#34;-0700&#34;</span><span class="op" id="6048056">,</span>&nbsp;<span class="string" id="6048058">&#34;MST&#34;</span><span class="op" id="6048063">,</span>&nbsp;<span class="string" id="6048065">&#34;-0700&nbsp;(MST)&#34;</span><span class="op" id="6048078">}</span>&nbsp;<span class="comment" id="6048080">//&nbsp;zone&nbsp;=&nbsp;((&#34;+&#34;&nbsp;/&nbsp;&#34;-&#34;)&nbsp;4DIGIT)&nbsp;/&nbsp;&#34;GMT&#34;&nbsp;/&nbsp;...</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048127">for</span>&nbsp;<span class="ident" id="6048131">_</span><span class="op" id="6048132">,</span>&nbsp;<span class="ident" id="6048134">dow</span>&nbsp;<span class="op" id="6048138">:=</span>&nbsp;<span class="keyword" id="6048141">range</span>&nbsp;<span class="ident" id="6048147">dows</span>&nbsp;<span class="op" id="6048152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048156">for</span>&nbsp;<span class="ident" id="6048160">_</span><span class="op" id="6048161">,</span>&nbsp;<span class="ident" id="6048163">day</span>&nbsp;<span class="op" id="6048167">:=</span>&nbsp;<span class="keyword" id="6048170">range</span>&nbsp;<span class="ident" id="6048176">days</span>&nbsp;<span class="op" id="6048181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048186">for</span>&nbsp;<span class="ident" id="6048190">_</span><span class="op" id="6048191">,</span>&nbsp;<span class="ident" id="6048193">year</span>&nbsp;<span class="op" id="6048198">:=</span>&nbsp;<span class="keyword" id="6048201">range</span>&nbsp;<span class="ident" id="6048207">years</span>&nbsp;<span class="op" id="6048213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048219">for</span>&nbsp;<span class="ident" id="6048223">_</span><span class="op" id="6048224">,</span>&nbsp;<span class="ident" id="6048226">second</span>&nbsp;<span class="op" id="6048233">:=</span>&nbsp;<span class="keyword" id="6048236">range</span>&nbsp;<span class="ident" id="6048242">seconds</span>&nbsp;<span class="op" id="6048250">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048257">for</span>&nbsp;<span class="ident" id="6048261">_</span><span class="op" id="6048262">,</span>&nbsp;<span class="ident" id="6048264">zone</span>&nbsp;<span class="op" id="6048269">:=</span>&nbsp;<span class="keyword" id="6048272">range</span>&nbsp;<span class="ident" id="6048278">zones</span>&nbsp;<span class="op" id="6048284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048292">s</span>&nbsp;<span class="op" id="6048294">:=</span>&nbsp;<span class="ident" id="6048297">dow</span>&nbsp;<span class="op" id="6048301">+</span>&nbsp;<span class="ident" id="6048303">day</span>&nbsp;<span class="op" id="6048307">+</span>&nbsp;<span class="string" id="6048309">&#34;&nbsp;Jan&nbsp;&#34;</span>&nbsp;<span class="op" id="6048317">+</span>&nbsp;<span class="ident" id="6048319">year</span>&nbsp;<span class="op" id="6048324">+</span>&nbsp;<span class="string" id="6048326">&#34;&nbsp;15:04&#34;</span>&nbsp;<span class="op" id="6048335">+</span>&nbsp;<span class="ident" id="6048337">second</span>&nbsp;<span class="op" id="6048344">+</span>&nbsp;<span class="string" id="6048346">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="6048350">+</span>&nbsp;<span class="ident" id="6048352">zone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048363">dateLayouts</span>&nbsp;<span class="op" id="6048375">=</span>&nbsp;<span class="builtinfunc" id="6048377">append</span><span class="op" id="6048383">(</span><span class="ident" id="6048384">dateLayouts</span><span class="op" id="6048395">,</span>&nbsp;<span class="ident" id="6048397">s</span><span class="op" id="6048398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6048405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6048411">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6048416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6048420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6048423">}</span><br>
<span class="lineno"></span><span class="op" id="6048425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="6048428">func</span>&nbsp;<span class="ident" id="6048433">parseDate</span><span class="op" id="6048442">(</span><span class="ident" id="6048443">date</span>&nbsp;<span class="builtintype" id="6048448">string</span><span class="op" id="6048454">)</span>&nbsp;<span class="op" id="6048456">(</span><span class="ident" id="6048457">time</span><span class="op" id="6048461">.</span><span class="ident" id="6048462">Time</span><span class="op" id="6048466">,</span>&nbsp;<span class="builtintype" id="6048468">error</span><span class="op" id="6048473">)</span>&nbsp;<span class="op" id="6048475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048478">for</span>&nbsp;<span class="ident" id="6048482">_</span><span class="op" id="6048483">,</span>&nbsp;<span class="ident" id="6048485">layout</span>&nbsp;<span class="op" id="6048492">:=</span>&nbsp;<span class="keyword" id="6048495">range</span>&nbsp;<span class="ident" id="6048501">dateLayouts</span>&nbsp;<span class="op" id="6048513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048517">t</span><span class="op" id="6048518">,</span>&nbsp;<span class="ident" id="6048520">err</span>&nbsp;<span class="op" id="6048524">:=</span>&nbsp;<span class="ident" id="6048527">time</span><span class="op" id="6048531">.</span><span class="ident" id="6048532">Parse</span><span class="op" id="6048537">(</span><span class="ident" id="6048538">layout</span><span class="op" id="6048544">,</span>&nbsp;<span class="ident" id="6048546">date</span><span class="op" id="6048550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048554">if</span>&nbsp;<span class="ident" id="6048557">err</span>&nbsp;<span class="op" id="6048561">==</span>&nbsp;<span class="ident" id="6048564">nil</span>&nbsp;<span class="op" id="6048568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048573">return</span>&nbsp;<span class="ident" id="6048580">t</span><span class="op" id="6048581">,</span>&nbsp;<span class="ident" id="6048583">nil</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6048589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6048592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048595">return</span>&nbsp;<span class="ident" id="6048602">time</span><span class="op" id="6048606">.</span><span class="ident" id="6048607">Time</span><span class="op" id="6048611">{</span><span class="op" id="6048612">}</span><span class="op" id="6048613">,</span>&nbsp;<span class="ident" id="6048615">errors</span><span class="op" id="6048621">.</span><span class="ident" id="6048622">New</span><span class="op" id="6048625">(</span><span class="string" id="6048626">&#34;mail:&nbsp;header&nbsp;could&nbsp;not&nbsp;be&nbsp;parsed&#34;</span><span class="op" id="6048660">)</span><br>
<span class="lineno"></span><span class="op" id="6048662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="6048665">//&nbsp;A&nbsp;Header&nbsp;represents&nbsp;the&nbsp;key-value&nbsp;pairs&nbsp;in&nbsp;a&nbsp;mail&nbsp;message&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="6048734">type</span>&nbsp;<span class="ident" id="6048739">Header</span>&nbsp;<span class="keyword" id="6048746">map</span><span class="op" id="6048749">[</span><span class="builtintype" id="6048750">string</span><span class="op" id="6048756">]</span><span class="op" id="6048757">[</span><span class="op" id="6048758">]</span><span class="builtintype" id="6048759">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6048767">//&nbsp;Get&nbsp;gets&nbsp;the&nbsp;first&nbsp;value&nbsp;associated&nbsp;with&nbsp;the&nbsp;given&nbsp;key.</span><br>
<span class="lineno"></span><span class="comment" id="6048826">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;values&nbsp;associated&nbsp;with&nbsp;the&nbsp;key,&nbsp;Get&nbsp;returns&nbsp;&#34;&#34;.</span><br>
<span class="lineno">110</span><span class="keyword" id="6048893">func</span>&nbsp;<span class="op" id="6048898">(</span><span class="ident" id="6048899">h</span>&nbsp;<span class="ident" id="6048901">Header</span><span class="op" id="6048907">)</span>&nbsp;<span class="ident" id="6048909">Get</span><span class="op" id="6048912">(</span><span class="ident" id="6048913">key</span>&nbsp;<span class="builtintype" id="6048917">string</span><span class="op" id="6048923">)</span>&nbsp;<span class="builtintype" id="6048925">string</span>&nbsp;<span class="op" id="6048932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048935">return</span>&nbsp;<span class="ident" id="6048942">textproto</span><span class="op" id="6048951">.</span><span class="ident" id="6048952">MIMEHeader</span><span class="op" id="6048962">(</span><span class="ident" id="6048963">h</span><span class="op" id="6048964">)</span><span class="op" id="6048965">.</span><span class="ident" id="6048966">Get</span><span class="op" id="6048969">(</span><span class="ident" id="6048970">key</span><span class="op" id="6048973">)</span><br>
<span class="lineno"></span><span class="op" id="6048975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6048978">var</span>&nbsp;<span class="ident" id="6048982">ErrHeaderNotPresent</span>&nbsp;<span class="op" id="6049002">=</span>&nbsp;<span class="ident" id="6049004">errors</span><span class="op" id="6049010">.</span><span class="ident" id="6049011">New</span><span class="op" id="6049014">(</span><span class="string" id="6049015">&#34;mail:&nbsp;header&nbsp;not&nbsp;in&nbsp;message&#34;</span><span class="op" id="6049044">)</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="6049047">//&nbsp;Date&nbsp;parses&nbsp;the&nbsp;Date&nbsp;header&nbsp;field.</span><br>
<span class="lineno"></span><span class="keyword" id="6049085">func</span>&nbsp;<span class="op" id="6049090">(</span><span class="ident" id="6049091">h</span>&nbsp;<span class="ident" id="6049093">Header</span><span class="op" id="6049099">)</span>&nbsp;<span class="ident" id="6049101">Date</span><span class="op" id="6049105">(</span><span class="op" id="6049106">)</span>&nbsp;<span class="op" id="6049108">(</span><span class="ident" id="6049109">time</span><span class="op" id="6049113">.</span><span class="ident" id="6049114">Time</span><span class="op" id="6049118">,</span>&nbsp;<span class="builtintype" id="6049120">error</span><span class="op" id="6049125">)</span>&nbsp;<span class="op" id="6049127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049130">hdr</span>&nbsp;<span class="op" id="6049134">:=</span>&nbsp;<span class="ident" id="6049137">h</span><span class="op" id="6049138">.</span><span class="ident" id="6049139">Get</span><span class="op" id="6049142">(</span><span class="string" id="6049143">&#34;Date&#34;</span><span class="op" id="6049149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049152">if</span>&nbsp;<span class="ident" id="6049155">hdr</span>&nbsp;<span class="op" id="6049159">==</span>&nbsp;<span class="string" id="6049162">&#34;&#34;</span>&nbsp;<span class="op" id="6049165">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049169">return</span>&nbsp;<span class="ident" id="6049176">time</span><span class="op" id="6049180">.</span><span class="ident" id="6049181">Time</span><span class="op" id="6049185">{</span><span class="op" id="6049186">}</span><span class="op" id="6049187">,</span>&nbsp;<span class="ident" id="6049189">ErrHeaderNotPresent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6049210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049213">return</span>&nbsp;<span class="ident" id="6049220">parseDate</span><span class="op" id="6049229">(</span><span class="ident" id="6049230">hdr</span><span class="op" id="6049233">)</span><br>
<span class="lineno"></span><span class="op" id="6049235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="6049238">//&nbsp;AddressList&nbsp;parses&nbsp;the&nbsp;named&nbsp;header&nbsp;field&nbsp;as&nbsp;a&nbsp;list&nbsp;of&nbsp;addresses.</span><br>
<span class="lineno"></span><span class="keyword" id="6049307">func</span>&nbsp;<span class="op" id="6049312">(</span><span class="ident" id="6049313">h</span>&nbsp;<span class="ident" id="6049315">Header</span><span class="op" id="6049321">)</span>&nbsp;<span class="ident" id="6049323">AddressList</span><span class="op" id="6049334">(</span><span class="ident" id="6049335">key</span>&nbsp;<span class="builtintype" id="6049339">string</span><span class="op" id="6049345">)</span>&nbsp;<span class="op" id="6049347">(</span><span class="op" id="6049348">[</span><span class="op" id="6049349">]</span><span class="op" id="6049350">*</span><span class="ident" id="6049351">Address</span><span class="op" id="6049358">,</span>&nbsp;<span class="builtintype" id="6049360">error</span><span class="op" id="6049365">)</span>&nbsp;<span class="op" id="6049367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049370">hdr</span>&nbsp;<span class="op" id="6049374">:=</span>&nbsp;<span class="ident" id="6049377">h</span><span class="op" id="6049378">.</span><span class="ident" id="6049379">Get</span><span class="op" id="6049382">(</span><span class="ident" id="6049383">key</span><span class="op" id="6049386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049389">if</span>&nbsp;<span class="ident" id="6049392">hdr</span>&nbsp;<span class="op" id="6049396">==</span>&nbsp;<span class="string" id="6049399">&#34;&#34;</span>&nbsp;<span class="op" id="6049402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049406">return</span>&nbsp;<span class="ident" id="6049413">nil</span><span class="op" id="6049416">,</span>&nbsp;<span class="ident" id="6049418">ErrHeaderNotPresent</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6049439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049442">return</span>&nbsp;<span class="ident" id="6049449">ParseAddressList</span><span class="op" id="6049465">(</span><span class="ident" id="6049466">hdr</span><span class="op" id="6049469">)</span><br>
<span class="lineno"></span><span class="op" id="6049471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6049474">//&nbsp;Address&nbsp;represents&nbsp;a&nbsp;single&nbsp;mail&nbsp;address.</span><br>
<span class="lineno">135</span><span class="comment" id="6049519">//&nbsp;An&nbsp;address&nbsp;such&nbsp;as&nbsp;&#34;Barry&nbsp;Gibbs&nbsp;&lt;bg@example.com&gt;&#34;&nbsp;is&nbsp;represented</span><br>
<span class="lineno"></span><span class="comment" id="6049587">//&nbsp;as&nbsp;Address{Name:&nbsp;&#34;Barry&nbsp;Gibbs&#34;,&nbsp;Address:&nbsp;&#34;bg@example.com&#34;}.</span><br>
<span class="lineno"></span><span class="keyword" id="6049650">type</span>&nbsp;<span class="ident" id="6049655">Address</span>&nbsp;<span class="keyword" id="6049663">struct</span>&nbsp;<span class="op" id="6049670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049673">Name</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6049681">string</span>&nbsp;<span class="comment" id="6049688">//&nbsp;Proper&nbsp;name;&nbsp;may&nbsp;be&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049719">Address</span>&nbsp;<span class="builtintype" id="6049727">string</span>&nbsp;<span class="comment" id="6049734">//&nbsp;user@domain</span><br>
<span class="lineno">140</span><span class="op" id="6049749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6049752">//&nbsp;Parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;address,&nbsp;e.g.&nbsp;&#34;Barry&nbsp;Gibbs&nbsp;&lt;bg@example.com&gt;&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="6049825">func</span>&nbsp;<span class="ident" id="6049830">ParseAddress</span><span class="op" id="6049842">(</span><span class="ident" id="6049843">address</span>&nbsp;<span class="builtintype" id="6049851">string</span><span class="op" id="6049857">)</span>&nbsp;<span class="op" id="6049859">(</span><span class="op" id="6049860">*</span><span class="ident" id="6049861">Address</span><span class="op" id="6049868">,</span>&nbsp;<span class="builtintype" id="6049870">error</span><span class="op" id="6049875">)</span>&nbsp;<span class="op" id="6049877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049880">return</span>&nbsp;<span class="ident" id="6049887">newAddrParser</span><span class="op" id="6049900">(</span><span class="ident" id="6049901">address</span><span class="op" id="6049908">)</span><span class="op" id="6049909">.</span><span class="ident" id="6049910">parseAddress</span><span class="op" id="6049922">(</span><span class="op" id="6049923">)</span><br>
<span class="lineno">145</span><span class="op" id="6049925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6049928">//&nbsp;ParseAddressList&nbsp;parses&nbsp;the&nbsp;given&nbsp;string&nbsp;as&nbsp;a&nbsp;list&nbsp;of&nbsp;addresses.</span><br>
<span class="lineno"></span><span class="keyword" id="6049996">func</span>&nbsp;<span class="ident" id="6050001">ParseAddressList</span><span class="op" id="6050017">(</span><span class="ident" id="6050018">list</span>&nbsp;<span class="builtintype" id="6050023">string</span><span class="op" id="6050029">)</span>&nbsp;<span class="op" id="6050031">(</span><span class="op" id="6050032">[</span><span class="op" id="6050033">]</span><span class="op" id="6050034">*</span><span class="ident" id="6050035">Address</span><span class="op" id="6050042">,</span>&nbsp;<span class="builtintype" id="6050044">error</span><span class="op" id="6050049">)</span>&nbsp;<span class="op" id="6050051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050054">return</span>&nbsp;<span class="ident" id="6050061">newAddrParser</span><span class="op" id="6050074">(</span><span class="ident" id="6050075">list</span><span class="op" id="6050079">)</span><span class="op" id="6050080">.</span><span class="ident" id="6050081">parseAddressList</span><span class="op" id="6050097">(</span><span class="op" id="6050098">)</span><br>
<span class="lineno">150</span><span class="op" id="6050100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6050103">//&nbsp;String&nbsp;formats&nbsp;the&nbsp;address&nbsp;as&nbsp;a&nbsp;valid&nbsp;RFC&nbsp;5322&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment" id="6050162">//&nbsp;If&nbsp;the&nbsp;address&#39;s&nbsp;name&nbsp;contains&nbsp;non-ASCII&nbsp;characters</span><br>
<span class="lineno"></span><span class="comment" id="6050217">//&nbsp;the&nbsp;name&nbsp;will&nbsp;be&nbsp;rendered&nbsp;according&nbsp;to&nbsp;RFC&nbsp;2047.</span><br>
<span class="lineno">155</span><span class="keyword" id="6050269">func</span>&nbsp;<span class="op" id="6050274">(</span><span class="ident" id="6050275">a</span>&nbsp;<span class="op" id="6050277">*</span><span class="ident" id="6050278">Address</span><span class="op" id="6050285">)</span>&nbsp;<span class="ident" id="6050287">String</span><span class="op" id="6050293">(</span><span class="op" id="6050294">)</span>&nbsp;<span class="builtintype" id="6050296">string</span>&nbsp;<span class="op" id="6050303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050306">s</span>&nbsp;<span class="op" id="6050308">:=</span>&nbsp;<span class="string" id="6050311">&#34;&lt;&#34;</span>&nbsp;<span class="op" id="6050315">+</span>&nbsp;<span class="ident" id="6050317">a</span><span class="op" id="6050318">.</span><span class="ident" id="6050319">Address</span>&nbsp;<span class="op" id="6050327">+</span>&nbsp;<span class="string" id="6050329">&#34;&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050334">if</span>&nbsp;<span class="ident" id="6050337">a</span><span class="op" id="6050338">.</span><span class="ident" id="6050339">Name</span>&nbsp;<span class="op" id="6050344">==</span>&nbsp;<span class="string" id="6050347">&#34;&#34;</span>&nbsp;<span class="op" id="6050350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050354">return</span>&nbsp;<span class="ident" id="6050361">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050364">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6050367">//&nbsp;If&nbsp;every&nbsp;character&nbsp;is&nbsp;printable&nbsp;ASCII,&nbsp;quoting&nbsp;is&nbsp;simple.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050429">allPrintable</span>&nbsp;<span class="op" id="6050442">:=</span>&nbsp;<span class="builtintype" id="6050445">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050451">for</span>&nbsp;<span class="ident" id="6050455">i</span>&nbsp;<span class="op" id="6050457">:=</span>&nbsp;<span class="num" id="6050460">0</span><span class="op" id="6050461">;</span>&nbsp;<span class="ident" id="6050463">i</span>&nbsp;<span class="op" id="6050465">&lt;</span>&nbsp;<span class="builtinfunc" id="6050467">len</span><span class="op" id="6050470">(</span><span class="ident" id="6050471">a</span><span class="op" id="6050472">.</span><span class="ident" id="6050473">Name</span><span class="op" id="6050477">)</span><span class="op" id="6050478">;</span>&nbsp;<span class="ident" id="6050480">i</span><span class="op" id="6050481">++</span>&nbsp;<span class="op" id="6050484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6050488">//&nbsp;isWSP&nbsp;here&nbsp;should&nbsp;actually&nbsp;be&nbsp;isFWS,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6050530">//&nbsp;but&nbsp;we&nbsp;don&#39;t&nbsp;support&nbsp;folding&nbsp;yet.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050569">if</span>&nbsp;<span class="op" id="6050572">!</span><span class="ident" id="6050573">isVchar</span><span class="op" id="6050580">(</span><span class="ident" id="6050581">a</span><span class="op" id="6050582">.</span><span class="ident" id="6050583">Name</span><span class="op" id="6050587">[</span><span class="ident" id="6050588">i</span><span class="op" id="6050589">]</span><span class="op" id="6050590">)</span>&nbsp;<span class="op" id="6050592">&amp;&amp;</span>&nbsp;<span class="op" id="6050595">!</span><span class="ident" id="6050596">isWSP</span><span class="op" id="6050601">(</span><span class="ident" id="6050602">a</span><span class="op" id="6050603">.</span><span class="ident" id="6050604">Name</span><span class="op" id="6050608">[</span><span class="ident" id="6050609">i</span><span class="op" id="6050610">]</span><span class="op" id="6050611">)</span>&nbsp;<span class="op" id="6050613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050618">allPrintable</span>&nbsp;<span class="op" id="6050631">=</span>&nbsp;<span class="builtintype" id="6050633">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050642">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050653">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050656">if</span>&nbsp;<span class="ident" id="6050659">allPrintable</span>&nbsp;<span class="op" id="6050672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050676">b</span>&nbsp;<span class="op" id="6050678">:=</span>&nbsp;<span class="ident" id="6050681">bytes</span><span class="op" id="6050686">.</span><span class="ident" id="6050687">NewBufferString</span><span class="op" id="6050702">(</span><span class="string" id="6050703">`&#34;`</span><span class="op" id="6050706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050710">for</span>&nbsp;<span class="ident" id="6050714">i</span>&nbsp;<span class="op" id="6050716">:=</span>&nbsp;<span class="num" id="6050719">0</span><span class="op" id="6050720">;</span>&nbsp;<span class="ident" id="6050722">i</span>&nbsp;<span class="op" id="6050724">&lt;</span>&nbsp;<span class="builtinfunc" id="6050726">len</span><span class="op" id="6050729">(</span><span class="ident" id="6050730">a</span><span class="op" id="6050731">.</span><span class="ident" id="6050732">Name</span><span class="op" id="6050736">)</span><span class="op" id="6050737">;</span>&nbsp;<span class="ident" id="6050739">i</span><span class="op" id="6050740">++</span>&nbsp;<span class="op" id="6050743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050748">if</span>&nbsp;<span class="op" id="6050751">!</span><span class="ident" id="6050752">isQtext</span><span class="op" id="6050759">(</span><span class="ident" id="6050760">a</span><span class="op" id="6050761">.</span><span class="ident" id="6050762">Name</span><span class="op" id="6050766">[</span><span class="ident" id="6050767">i</span><span class="op" id="6050768">]</span><span class="op" id="6050769">)</span>&nbsp;<span class="op" id="6050771">&amp;&amp;</span>&nbsp;<span class="op" id="6050774">!</span><span class="ident" id="6050775">isWSP</span><span class="op" id="6050780">(</span><span class="ident" id="6050781">a</span><span class="op" id="6050782">.</span><span class="ident" id="6050783">Name</span><span class="op" id="6050787">[</span><span class="ident" id="6050788">i</span><span class="op" id="6050789">]</span><span class="op" id="6050790">)</span>&nbsp;<span class="op" id="6050792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050798">b</span><span class="op" id="6050799">.</span><span class="ident" id="6050800">WriteByte</span><span class="op" id="6050809">(</span><span class="string" id="6050810">&#39;\\&#39;</span><span class="op" id="6050814">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050824">b</span><span class="op" id="6050825">.</span><span class="ident" id="6050826">WriteByte</span><span class="op" id="6050835">(</span><span class="ident" id="6050836">a</span><span class="op" id="6050837">.</span><span class="ident" id="6050838">Name</span><span class="op" id="6050842">[</span><span class="ident" id="6050843">i</span><span class="op" id="6050844">]</span><span class="op" id="6050845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050853">b</span><span class="op" id="6050854">.</span><span class="ident" id="6050855">WriteString</span><span class="op" id="6050866">(</span><span class="string" id="6050867">`&#34;&nbsp;`</span><span class="op" id="6050871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050875">b</span><span class="op" id="6050876">.</span><span class="ident" id="6050877">WriteString</span><span class="op" id="6050888">(</span><span class="ident" id="6050889">s</span><span class="op" id="6050890">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050894">return</span>&nbsp;<span class="ident" id="6050901">b</span><span class="op" id="6050902">.</span><span class="ident" id="6050903">String</span><span class="op" id="6050909">(</span><span class="op" id="6050910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6050917">//&nbsp;UTF-8&nbsp;&#34;Q&#34;&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050940">b</span>&nbsp;<span class="op" id="6050942">:=</span>&nbsp;<span class="ident" id="6050945">bytes</span><span class="op" id="6050950">.</span><span class="ident" id="6050951">NewBufferString</span><span class="op" id="6050966">(</span><span class="string" id="6050967">&#34;=?utf-8?q?&#34;</span><span class="op" id="6050979">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050982">for</span>&nbsp;<span class="ident" id="6050986">i</span>&nbsp;<span class="op" id="6050988">:=</span>&nbsp;<span class="num" id="6050991">0</span><span class="op" id="6050992">;</span>&nbsp;<span class="ident" id="6050994">i</span>&nbsp;<span class="op" id="6050996">&lt;</span>&nbsp;<span class="builtinfunc" id="6050998">len</span><span class="op" id="6051001">(</span><span class="ident" id="6051002">a</span><span class="op" id="6051003">.</span><span class="ident" id="6051004">Name</span><span class="op" id="6051008">)</span><span class="op" id="6051009">;</span>&nbsp;<span class="ident" id="6051011">i</span><span class="op" id="6051012">++</span>&nbsp;<span class="op" id="6051015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051019">switch</span>&nbsp;<span class="ident" id="6051026">c</span>&nbsp;<span class="op" id="6051028">:=</span>&nbsp;<span class="ident" id="6051031">a</span><span class="op" id="6051032">.</span><span class="ident" id="6051033">Name</span><span class="op" id="6051037">[</span><span class="ident" id="6051038">i</span><span class="op" id="6051039">]</span><span class="op" id="6051040">;</span>&nbsp;<span class="op" id="6051042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051046">case</span>&nbsp;<span class="ident" id="6051051">c</span>&nbsp;<span class="op" id="6051053">==</span>&nbsp;<span class="string" id="6051056">&#39;&nbsp;&#39;</span><span class="op" id="6051059">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051064">b</span><span class="op" id="6051065">.</span><span class="ident" id="6051066">WriteByte</span><span class="op" id="6051075">(</span><span class="string" id="6051076">&#39;_&#39;</span><span class="op" id="6051079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051083">case</span>&nbsp;<span class="ident" id="6051088">isVchar</span><span class="op" id="6051095">(</span><span class="ident" id="6051096">c</span><span class="op" id="6051097">)</span>&nbsp;<span class="op" id="6051099">&amp;&amp;</span>&nbsp;<span class="ident" id="6051102">c</span>&nbsp;<span class="op" id="6051104">!=</span>&nbsp;<span class="string" id="6051107">&#39;=&#39;</span>&nbsp;<span class="op" id="6051111">&amp;&amp;</span>&nbsp;<span class="ident" id="6051114">c</span>&nbsp;<span class="op" id="6051116">!=</span>&nbsp;<span class="string" id="6051119">&#39;?&#39;</span>&nbsp;<span class="op" id="6051123">&amp;&amp;</span>&nbsp;<span class="ident" id="6051126">c</span>&nbsp;<span class="op" id="6051128">!=</span>&nbsp;<span class="string" id="6051131">&#39;_&#39;</span><span class="op" id="6051134">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051139">b</span><span class="op" id="6051140">.</span><span class="ident" id="6051141">WriteByte</span><span class="op" id="6051150">(</span><span class="ident" id="6051151">c</span><span class="op" id="6051152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051156">default</span><span class="op" id="6051163">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051168">fmt</span><span class="op" id="6051171">.</span><span class="ident" id="6051172">Fprintf</span><span class="op" id="6051179">(</span><span class="ident" id="6051180">b</span><span class="op" id="6051181">,</span>&nbsp;<span class="string" id="6051183">&#34;=%02X&#34;</span><span class="op" id="6051190">,</span>&nbsp;<span class="ident" id="6051192">c</span><span class="op" id="6051193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051200">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051203">b</span><span class="op" id="6051204">.</span><span class="ident" id="6051205">WriteString</span><span class="op" id="6051216">(</span><span class="string" id="6051217">&#34;?=&nbsp;&#34;</span><span class="op" id="6051222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051225">b</span><span class="op" id="6051226">.</span><span class="ident" id="6051227">WriteString</span><span class="op" id="6051238">(</span><span class="ident" id="6051239">s</span><span class="op" id="6051240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051243">return</span>&nbsp;<span class="ident" id="6051250">b</span><span class="op" id="6051251">.</span><span class="ident" id="6051252">String</span><span class="op" id="6051258">(</span><span class="op" id="6051259">)</span><br>
<span class="lineno"></span><span class="op" id="6051261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="6051264">type</span>&nbsp;<span class="ident" id="6051269">addrParser</span>&nbsp;<span class="op" id="6051280">[</span><span class="op" id="6051281">]</span><span class="builtintype" id="6051282">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6051288">func</span>&nbsp;<span class="ident" id="6051293">newAddrParser</span><span class="op" id="6051306">(</span><span class="ident" id="6051307">s</span>&nbsp;<span class="builtintype" id="6051309">string</span><span class="op" id="6051315">)</span>&nbsp;<span class="op" id="6051317">*</span><span class="ident" id="6051318">addrParser</span>&nbsp;<span class="op" id="6051329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051332">p</span>&nbsp;<span class="op" id="6051334">:=</span>&nbsp;<span class="ident" id="6051337">addrParser</span><span class="op" id="6051347">(</span><span class="ident" id="6051348">s</span><span class="op" id="6051349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051352">return</span>&nbsp;<span class="op" id="6051359">&amp;</span><span class="ident" id="6051360">p</span><br>
<span class="lineno">205</span><span class="op" id="6051362">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6051365">func</span>&nbsp;<span class="op" id="6051370">(</span><span class="ident" id="6051371">p</span>&nbsp;<span class="op" id="6051373">*</span><span class="ident" id="6051374">addrParser</span><span class="op" id="6051384">)</span>&nbsp;<span class="ident" id="6051386">parseAddressList</span><span class="op" id="6051402">(</span><span class="op" id="6051403">)</span>&nbsp;<span class="op" id="6051405">(</span><span class="op" id="6051406">[</span><span class="op" id="6051407">]</span><span class="op" id="6051408">*</span><span class="ident" id="6051409">Address</span><span class="op" id="6051416">,</span>&nbsp;<span class="builtintype" id="6051418">error</span><span class="op" id="6051423">)</span>&nbsp;<span class="op" id="6051425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051428">var</span>&nbsp;<span class="ident" id="6051432">list</span>&nbsp;<span class="op" id="6051437">[</span><span class="op" id="6051438">]</span><span class="op" id="6051439">*</span><span class="ident" id="6051440">Address</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051449">for</span>&nbsp;<span class="op" id="6051453">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051457">p</span><span class="op" id="6051458">.</span><span class="ident" id="6051459">skipSpace</span><span class="op" id="6051468">(</span><span class="op" id="6051469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051473">addr</span><span class="op" id="6051477">,</span>&nbsp;<span class="ident" id="6051479">err</span>&nbsp;<span class="op" id="6051483">:=</span>&nbsp;<span class="ident" id="6051486">p</span><span class="op" id="6051487">.</span><span class="ident" id="6051488">parseAddress</span><span class="op" id="6051500">(</span><span class="op" id="6051501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051505">if</span>&nbsp;<span class="ident" id="6051508">err</span>&nbsp;<span class="op" id="6051512">!=</span>&nbsp;<span class="ident" id="6051515">nil</span>&nbsp;<span class="op" id="6051519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051524">return</span>&nbsp;<span class="ident" id="6051531">nil</span><span class="op" id="6051534">,</span>&nbsp;<span class="ident" id="6051536">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051542">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051546">list</span>&nbsp;<span class="op" id="6051551">=</span>&nbsp;<span class="builtinfunc" id="6051553">append</span><span class="op" id="6051559">(</span><span class="ident" id="6051560">list</span><span class="op" id="6051564">,</span>&nbsp;<span class="ident" id="6051566">addr</span><span class="op" id="6051570">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051575">p</span><span class="op" id="6051576">.</span><span class="ident" id="6051577">skipSpace</span><span class="op" id="6051586">(</span><span class="op" id="6051587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051591">if</span>&nbsp;<span class="ident" id="6051594">p</span><span class="op" id="6051595">.</span><span class="ident" id="6051596">empty</span><span class="op" id="6051601">(</span><span class="op" id="6051602">)</span>&nbsp;<span class="op" id="6051604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051609">break</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051621">if</span>&nbsp;<span class="op" id="6051624">!</span><span class="ident" id="6051625">p</span><span class="op" id="6051626">.</span><span class="ident" id="6051627">consume</span><span class="op" id="6051634">(</span><span class="string" id="6051635">&#39;,&#39;</span><span class="op" id="6051638">)</span>&nbsp;<span class="op" id="6051640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051645">return</span>&nbsp;<span class="ident" id="6051652">nil</span><span class="op" id="6051655">,</span>&nbsp;<span class="ident" id="6051657">errors</span><span class="op" id="6051663">.</span><span class="ident" id="6051664">New</span><span class="op" id="6051667">(</span><span class="string" id="6051668">&#34;mail:&nbsp;expected&nbsp;comma&#34;</span><span class="op" id="6051690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051697">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051700">return</span>&nbsp;<span class="ident" id="6051707">list</span><span class="op" id="6051711">,</span>&nbsp;<span class="ident" id="6051713">nil</span><br>
<span class="lineno"></span><span class="op" id="6051717">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6051720">//&nbsp;parseAddress&nbsp;parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;address&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="6051788">func</span>&nbsp;<span class="op" id="6051793">(</span><span class="ident" id="6051794">p</span>&nbsp;<span class="op" id="6051796">*</span><span class="ident" id="6051797">addrParser</span><span class="op" id="6051807">)</span>&nbsp;<span class="ident" id="6051809">parseAddress</span><span class="op" id="6051821">(</span><span class="op" id="6051822">)</span>&nbsp;<span class="op" id="6051824">(</span><span class="ident" id="6051825">addr</span>&nbsp;<span class="op" id="6051830">*</span><span class="ident" id="6051831">Address</span><span class="op" id="6051838">,</span>&nbsp;<span class="ident" id="6051840">err</span>&nbsp;<span class="builtintype" id="6051844">error</span><span class="op" id="6051849">)</span>&nbsp;<span class="op" id="6051851">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051854">debug</span><span class="op" id="6051859">.</span><span class="ident" id="6051860">Printf</span><span class="op" id="6051866">(</span><span class="string" id="6051867">&#34;parseAddress:&nbsp;%q&#34;</span><span class="op" id="6051885">,</span>&nbsp;<span class="op" id="6051887">*</span><span class="ident" id="6051888">p</span><span class="op" id="6051889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051892">p</span><span class="op" id="6051893">.</span><span class="ident" id="6051894">skipSpace</span><span class="op" id="6051903">(</span><span class="op" id="6051904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051907">if</span>&nbsp;<span class="ident" id="6051910">p</span><span class="op" id="6051911">.</span><span class="ident" id="6051912">empty</span><span class="op" id="6051917">(</span><span class="op" id="6051918">)</span>&nbsp;<span class="op" id="6051920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051924">return</span>&nbsp;<span class="ident" id="6051931">nil</span><span class="op" id="6051934">,</span>&nbsp;<span class="ident" id="6051936">errors</span><span class="op" id="6051942">.</span><span class="ident" id="6051943">New</span><span class="op" id="6051946">(</span><span class="string" id="6051947">&#34;mail:&nbsp;no&nbsp;address&#34;</span><span class="op" id="6051965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051968">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6051972">//&nbsp;address&nbsp;=&nbsp;name-addr&nbsp;/&nbsp;addr-spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6052008">//&nbsp;TODO(dsymonds):&nbsp;Support&nbsp;parsing&nbsp;group&nbsp;address.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6052060">//&nbsp;addr-spec&nbsp;has&nbsp;a&nbsp;more&nbsp;restricted&nbsp;grammar&nbsp;than&nbsp;name-addr,</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6052120">//&nbsp;so&nbsp;try&nbsp;parsing&nbsp;it&nbsp;first,&nbsp;and&nbsp;fallback&nbsp;to&nbsp;name-addr.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6052176">//&nbsp;TODO(dsymonds):&nbsp;Is&nbsp;this&nbsp;really&nbsp;correct?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052220">spec</span><span class="op" id="6052224">,</span>&nbsp;<span class="ident" id="6052226">err</span>&nbsp;<span class="op" id="6052230">:=</span>&nbsp;<span class="ident" id="6052233">p</span><span class="op" id="6052234">.</span><span class="ident" id="6052235">consumeAddrSpec</span><span class="op" id="6052250">(</span><span class="op" id="6052251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052254">if</span>&nbsp;<span class="ident" id="6052257">err</span>&nbsp;<span class="op" id="6052261">==</span>&nbsp;<span class="ident" id="6052264">nil</span>&nbsp;<span class="op" id="6052268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052272">return</span>&nbsp;<span class="op" id="6052279">&amp;</span><span class="ident" id="6052280">Address</span><span class="op" id="6052287">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052292">Address</span><span class="op" id="6052299">:</span>&nbsp;<span class="ident" id="6052301">spec</span><span class="op" id="6052305">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052309">}</span><span class="op" id="6052310">,</span>&nbsp;<span class="ident" id="6052312">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052320">debug</span><span class="op" id="6052325">.</span><span class="ident" id="6052326">Printf</span><span class="op" id="6052332">(</span><span class="string" id="6052333">&#34;parseAddress:&nbsp;not&nbsp;an&nbsp;addr-spec:&nbsp;%v&#34;</span><span class="op" id="6052369">,</span>&nbsp;<span class="ident" id="6052371">err</span><span class="op" id="6052374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052377">debug</span><span class="op" id="6052382">.</span><span class="ident" id="6052383">Printf</span><span class="op" id="6052389">(</span><span class="string" id="6052390">&#34;parseAddress:&nbsp;state&nbsp;is&nbsp;now&nbsp;%q&#34;</span><span class="op" id="6052421">,</span>&nbsp;<span class="op" id="6052423">*</span><span class="ident" id="6052424">p</span><span class="op" id="6052425">)</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6052429">//&nbsp;display-name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052446">var</span>&nbsp;<span class="ident" id="6052450">displayName</span>&nbsp;<span class="builtintype" id="6052462">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052470">if</span>&nbsp;<span class="ident" id="6052473">p</span><span class="op" id="6052474">.</span><span class="ident" id="6052475">peek</span><span class="op" id="6052479">(</span><span class="op" id="6052480">)</span>&nbsp;<span class="op" id="6052482">!=</span>&nbsp;<span class="string" id="6052485">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="6052489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052493">displayName</span><span class="op" id="6052504">,</span>&nbsp;<span class="ident" id="6052506">err</span>&nbsp;<span class="op" id="6052510">=</span>&nbsp;<span class="ident" id="6052512">p</span><span class="op" id="6052513">.</span><span class="ident" id="6052514">consumePhrase</span><span class="op" id="6052527">(</span><span class="op" id="6052528">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052532">if</span>&nbsp;<span class="ident" id="6052535">err</span>&nbsp;<span class="op" id="6052539">!=</span>&nbsp;<span class="ident" id="6052542">nil</span>&nbsp;<span class="op" id="6052546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052551">return</span>&nbsp;<span class="ident" id="6052558">nil</span><span class="op" id="6052561">,</span>&nbsp;<span class="ident" id="6052563">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052575">debug</span><span class="op" id="6052580">.</span><span class="ident" id="6052581">Printf</span><span class="op" id="6052587">(</span><span class="string" id="6052588">&#34;parseAddress:&nbsp;displayName=%q&#34;</span><span class="op" id="6052618">,</span>&nbsp;<span class="ident" id="6052620">displayName</span><span class="op" id="6052631">)</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6052635">//&nbsp;angle-addr&nbsp;=&nbsp;&#34;&lt;&#34;&nbsp;addr-spec&nbsp;&#34;&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052670">p</span><span class="op" id="6052671">.</span><span class="ident" id="6052672">skipSpace</span><span class="op" id="6052681">(</span><span class="op" id="6052682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052685">if</span>&nbsp;<span class="op" id="6052688">!</span><span class="ident" id="6052689">p</span><span class="op" id="6052690">.</span><span class="ident" id="6052691">consume</span><span class="op" id="6052698">(</span><span class="string" id="6052699">&#39;&lt;&#39;</span><span class="op" id="6052702">)</span>&nbsp;<span class="op" id="6052704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052708">return</span>&nbsp;<span class="ident" id="6052715">nil</span><span class="op" id="6052718">,</span>&nbsp;<span class="ident" id="6052720">errors</span><span class="op" id="6052726">.</span><span class="ident" id="6052727">New</span><span class="op" id="6052730">(</span><span class="string" id="6052731">&#34;mail:&nbsp;no&nbsp;angle-addr&#34;</span><span class="op" id="6052752">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052758">spec</span><span class="op" id="6052762">,</span>&nbsp;<span class="ident" id="6052764">err</span>&nbsp;<span class="op" id="6052768">=</span>&nbsp;<span class="ident" id="6052770">p</span><span class="op" id="6052771">.</span><span class="ident" id="6052772">consumeAddrSpec</span><span class="op" id="6052787">(</span><span class="op" id="6052788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052791">if</span>&nbsp;<span class="ident" id="6052794">err</span>&nbsp;<span class="op" id="6052798">!=</span>&nbsp;<span class="ident" id="6052801">nil</span>&nbsp;<span class="op" id="6052805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052809">return</span>&nbsp;<span class="ident" id="6052816">nil</span><span class="op" id="6052819">,</span>&nbsp;<span class="ident" id="6052821">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052826">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052829">if</span>&nbsp;<span class="op" id="6052832">!</span><span class="ident" id="6052833">p</span><span class="op" id="6052834">.</span><span class="ident" id="6052835">consume</span><span class="op" id="6052842">(</span><span class="string" id="6052843">&#39;&gt;&#39;</span><span class="op" id="6052846">)</span>&nbsp;<span class="op" id="6052848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052852">return</span>&nbsp;<span class="ident" id="6052859">nil</span><span class="op" id="6052862">,</span>&nbsp;<span class="ident" id="6052864">errors</span><span class="op" id="6052870">.</span><span class="ident" id="6052871">New</span><span class="op" id="6052874">(</span><span class="string" id="6052875">&#34;mail:&nbsp;unclosed&nbsp;angle-addr&#34;</span><span class="op" id="6052902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6052905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052908">debug</span><span class="op" id="6052913">.</span><span class="ident" id="6052914">Printf</span><span class="op" id="6052920">(</span><span class="string" id="6052921">&#34;parseAddress:&nbsp;spec=%q&#34;</span><span class="op" id="6052944">,</span>&nbsp;<span class="ident" id="6052946">spec</span><span class="op" id="6052950">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6052954">return</span>&nbsp;<span class="op" id="6052961">&amp;</span><span class="ident" id="6052962">Address</span><span class="op" id="6052969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052973">Name</span><span class="op" id="6052977">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6052982">displayName</span><span class="op" id="6052993">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6052997">Address</span><span class="op" id="6053004">:</span>&nbsp;<span class="ident" id="6053006">spec</span><span class="op" id="6053010">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6053013">}</span><span class="op" id="6053014">,</span>&nbsp;<span class="ident" id="6053016">nil</span><br>
<span class="lineno"></span><span class="op" id="6053020">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="6053023">//&nbsp;consumeAddrSpec&nbsp;parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;addr-spec&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="6053096">func</span>&nbsp;<span class="op" id="6053101">(</span><span class="ident" id="6053102">p</span>&nbsp;<span class="op" id="6053104">*</span><span class="ident" id="6053105">addrParser</span><span class="op" id="6053115">)</span>&nbsp;<span class="ident" id="6053117">consumeAddrSpec</span><span class="op" id="6053132">(</span><span class="op" id="6053133">)</span>&nbsp;<span class="op" id="6053135">(</span><span class="ident" id="6053136">spec</span>&nbsp;<span class="builtintype" id="6053141">string</span><span class="op" id="6053147">,</span>&nbsp;<span class="ident" id="6053149">err</span>&nbsp;<span class="builtintype" id="6053153">error</span><span class="op" id="6053158">)</span>&nbsp;<span class="op" id="6053160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053163">debug</span><span class="op" id="6053168">.</span><span class="ident" id="6053169">Printf</span><span class="op" id="6053175">(</span><span class="string" id="6053176">&#34;consumeAddrSpec:&nbsp;%q&#34;</span><span class="op" id="6053197">,</span>&nbsp;<span class="op" id="6053199">*</span><span class="ident" id="6053200">p</span><span class="op" id="6053201">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053205">orig</span>&nbsp;<span class="op" id="6053210">:=</span>&nbsp;<span class="op" id="6053213">*</span><span class="ident" id="6053214">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053217">defer</span>&nbsp;<span class="keyword" id="6053223">func</span><span class="op" id="6053227">(</span><span class="op" id="6053228">)</span>&nbsp;<span class="op" id="6053230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053234">if</span>&nbsp;<span class="ident" id="6053237">err</span>&nbsp;<span class="op" id="6053241">!=</span>&nbsp;<span class="ident" id="6053244">nil</span>&nbsp;<span class="op" id="6053248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6053253">*</span><span class="ident" id="6053254">p</span>&nbsp;<span class="op" id="6053256">=</span>&nbsp;<span class="ident" id="6053258">orig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6053265">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6053268">}</span><span class="op" id="6053269">(</span><span class="op" id="6053270">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053274">//&nbsp;local-part&nbsp;=&nbsp;dot-atom&nbsp;/&nbsp;quoted-string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053316">var</span>&nbsp;<span class="ident" id="6053320">localPart</span>&nbsp;<span class="builtintype" id="6053330">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053338">p</span><span class="op" id="6053339">.</span><span class="ident" id="6053340">skipSpace</span><span class="op" id="6053349">(</span><span class="op" id="6053350">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053353">if</span>&nbsp;<span class="ident" id="6053356">p</span><span class="op" id="6053357">.</span><span class="ident" id="6053358">empty</span><span class="op" id="6053363">(</span><span class="op" id="6053364">)</span>&nbsp;<span class="op" id="6053366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053370">return</span>&nbsp;<span class="string" id="6053377">&#34;&#34;</span><span class="op" id="6053379">,</span>&nbsp;<span class="ident" id="6053381">errors</span><span class="op" id="6053387">.</span><span class="ident" id="6053388">New</span><span class="op" id="6053391">(</span><span class="string" id="6053392">&#34;mail:&nbsp;no&nbsp;addr-spec&#34;</span><span class="op" id="6053412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6053415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053418">if</span>&nbsp;<span class="ident" id="6053421">p</span><span class="op" id="6053422">.</span><span class="ident" id="6053423">peek</span><span class="op" id="6053427">(</span><span class="op" id="6053428">)</span>&nbsp;<span class="op" id="6053430">==</span>&nbsp;<span class="string" id="6053433">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="6053437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053441">//&nbsp;quoted-string</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053460">debug</span><span class="op" id="6053465">.</span><span class="ident" id="6053466">Printf</span><span class="op" id="6053472">(</span><span class="string" id="6053473">&#34;consumeAddrSpec:&nbsp;parsing&nbsp;quoted-string&#34;</span><span class="op" id="6053513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053517">localPart</span><span class="op" id="6053526">,</span>&nbsp;<span class="ident" id="6053528">err</span>&nbsp;<span class="op" id="6053532">=</span>&nbsp;<span class="ident" id="6053534">p</span><span class="op" id="6053535">.</span><span class="ident" id="6053536">consumeQuotedString</span><span class="op" id="6053555">(</span><span class="op" id="6053556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6053559">}</span>&nbsp;<span class="keyword" id="6053561">else</span>&nbsp;<span class="op" id="6053566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053570">//&nbsp;dot-atom</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053584">debug</span><span class="op" id="6053589">.</span><span class="ident" id="6053590">Printf</span><span class="op" id="6053596">(</span><span class="string" id="6053597">&#34;consumeAddrSpec:&nbsp;parsing&nbsp;dot-atom&#34;</span><span class="op" id="6053632">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053636">localPart</span><span class="op" id="6053645">,</span>&nbsp;<span class="ident" id="6053647">err</span>&nbsp;<span class="op" id="6053651">=</span>&nbsp;<span class="ident" id="6053653">p</span><span class="op" id="6053654">.</span><span class="ident" id="6053655">consumeAtom</span><span class="op" id="6053666">(</span><span class="builtintype" id="6053667">true</span><span class="op" id="6053671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6053674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053677">if</span>&nbsp;<span class="ident" id="6053680">err</span>&nbsp;<span class="op" id="6053684">!=</span>&nbsp;<span class="ident" id="6053687">nil</span>&nbsp;<span class="op" id="6053691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053695">debug</span><span class="op" id="6053700">.</span><span class="ident" id="6053701">Printf</span><span class="op" id="6053707">(</span><span class="string" id="6053708">&#34;consumeAddrSpec:&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6053737">,</span>&nbsp;<span class="ident" id="6053739">err</span><span class="op" id="6053742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053746">return</span>&nbsp;<span class="string" id="6053753">&#34;&#34;</span><span class="op" id="6053755">,</span>&nbsp;<span class="ident" id="6053757">err</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6053762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053766">if</span>&nbsp;<span class="op" id="6053769">!</span><span class="ident" id="6053770">p</span><span class="op" id="6053771">.</span><span class="ident" id="6053772">consume</span><span class="op" id="6053779">(</span><span class="string" id="6053780">&#39;@&#39;</span><span class="op" id="6053783">)</span>&nbsp;<span class="op" id="6053785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053789">return</span>&nbsp;<span class="string" id="6053796">&#34;&#34;</span><span class="op" id="6053798">,</span>&nbsp;<span class="ident" id="6053800">errors</span><span class="op" id="6053806">.</span><span class="ident" id="6053807">New</span><span class="op" id="6053810">(</span><span class="string" id="6053811">&#34;mail:&nbsp;missing&nbsp;@&nbsp;in&nbsp;addr-spec&#34;</span><span class="op" id="6053841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6053844">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053848">//&nbsp;domain&nbsp;=&nbsp;dot-atom&nbsp;/&nbsp;domain-literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053887">var</span>&nbsp;<span class="ident" id="6053891">domain</span>&nbsp;<span class="builtintype" id="6053898">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6053906">p</span><span class="op" id="6053907">.</span><span class="ident" id="6053908">skipSpace</span><span class="op" id="6053917">(</span><span class="op" id="6053918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053921">if</span>&nbsp;<span class="ident" id="6053924">p</span><span class="op" id="6053925">.</span><span class="ident" id="6053926">empty</span><span class="op" id="6053931">(</span><span class="op" id="6053932">)</span>&nbsp;<span class="op" id="6053934">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6053938">return</span>&nbsp;<span class="string" id="6053945">&#34;&#34;</span><span class="op" id="6053947">,</span>&nbsp;<span class="ident" id="6053949">errors</span><span class="op" id="6053955">.</span><span class="ident" id="6053956">New</span><span class="op" id="6053959">(</span><span class="string" id="6053960">&#34;mail:&nbsp;no&nbsp;domain&nbsp;in&nbsp;addr-spec&#34;</span><span class="op" id="6053990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6053993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6053996">//&nbsp;TODO(dsymonds):&nbsp;Handle&nbsp;domain-literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054038">domain</span><span class="op" id="6054044">,</span>&nbsp;<span class="ident" id="6054046">err</span>&nbsp;<span class="op" id="6054050">=</span>&nbsp;<span class="ident" id="6054052">p</span><span class="op" id="6054053">.</span><span class="ident" id="6054054">consumeAtom</span><span class="op" id="6054065">(</span><span class="builtintype" id="6054066">true</span><span class="op" id="6054070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054073">if</span>&nbsp;<span class="ident" id="6054076">err</span>&nbsp;<span class="op" id="6054080">!=</span>&nbsp;<span class="ident" id="6054083">nil</span>&nbsp;<span class="op" id="6054087">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054091">return</span>&nbsp;<span class="string" id="6054098">&#34;&#34;</span><span class="op" id="6054100">,</span>&nbsp;<span class="ident" id="6054102">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054111">return</span>&nbsp;<span class="ident" id="6054118">localPart</span>&nbsp;<span class="op" id="6054128">+</span>&nbsp;<span class="string" id="6054130">&#34;@&#34;</span>&nbsp;<span class="op" id="6054134">+</span>&nbsp;<span class="ident" id="6054136">domain</span><span class="op" id="6054142">,</span>&nbsp;<span class="ident" id="6054144">nil</span><br>
<span class="lineno"></span><span class="op" id="6054148">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="comment" id="6054151">//&nbsp;consumePhrase&nbsp;parses&nbsp;the&nbsp;RFC&nbsp;5322&nbsp;phrase&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="6054214">func</span>&nbsp;<span class="op" id="6054219">(</span><span class="ident" id="6054220">p</span>&nbsp;<span class="op" id="6054222">*</span><span class="ident" id="6054223">addrParser</span><span class="op" id="6054233">)</span>&nbsp;<span class="ident" id="6054235">consumePhrase</span><span class="op" id="6054248">(</span><span class="op" id="6054249">)</span>&nbsp;<span class="op" id="6054251">(</span><span class="ident" id="6054252">phrase</span>&nbsp;<span class="builtintype" id="6054259">string</span><span class="op" id="6054265">,</span>&nbsp;<span class="ident" id="6054267">err</span>&nbsp;<span class="builtintype" id="6054271">error</span><span class="op" id="6054276">)</span>&nbsp;<span class="op" id="6054278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054281">debug</span><span class="op" id="6054286">.</span><span class="ident" id="6054287">Printf</span><span class="op" id="6054293">(</span><span class="string" id="6054294">&#34;consumePhrase:&nbsp;[%s]&#34;</span><span class="op" id="6054315">,</span>&nbsp;<span class="op" id="6054317">*</span><span class="ident" id="6054318">p</span><span class="op" id="6054319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6054322">//&nbsp;phrase&nbsp;=&nbsp;1*word</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054342">var</span>&nbsp;<span class="ident" id="6054346">words</span>&nbsp;<span class="op" id="6054352">[</span><span class="op" id="6054353">]</span><span class="builtintype" id="6054354">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054362">for</span>&nbsp;<span class="op" id="6054366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6054370">//&nbsp;word&nbsp;=&nbsp;atom&nbsp;/&nbsp;quoted-string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054403">var</span>&nbsp;<span class="ident" id="6054407">word</span>&nbsp;<span class="builtintype" id="6054412">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054421">p</span><span class="op" id="6054422">.</span><span class="ident" id="6054423">skipSpace</span><span class="op" id="6054432">(</span><span class="op" id="6054433">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054437">if</span>&nbsp;<span class="ident" id="6054440">p</span><span class="op" id="6054441">.</span><span class="ident" id="6054442">empty</span><span class="op" id="6054447">(</span><span class="op" id="6054448">)</span>&nbsp;<span class="op" id="6054450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054455">return</span>&nbsp;<span class="string" id="6054462">&#34;&#34;</span><span class="op" id="6054464">,</span>&nbsp;<span class="ident" id="6054466">errors</span><span class="op" id="6054472">.</span><span class="ident" id="6054473">New</span><span class="op" id="6054476">(</span><span class="string" id="6054477">&#34;mail:&nbsp;missing&nbsp;phrase&#34;</span><span class="op" id="6054499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054507">if</span>&nbsp;<span class="ident" id="6054510">p</span><span class="op" id="6054511">.</span><span class="ident" id="6054512">peek</span><span class="op" id="6054516">(</span><span class="op" id="6054517">)</span>&nbsp;<span class="op" id="6054519">==</span>&nbsp;<span class="string" id="6054522">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="6054526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6054531">//&nbsp;quoted-string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054551">word</span><span class="op" id="6054555">,</span>&nbsp;<span class="ident" id="6054557">err</span>&nbsp;<span class="op" id="6054561">=</span>&nbsp;<span class="ident" id="6054563">p</span><span class="op" id="6054564">.</span><span class="ident" id="6054565">consumeQuotedString</span><span class="op" id="6054584">(</span><span class="op" id="6054585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054589">}</span>&nbsp;<span class="keyword" id="6054591">else</span>&nbsp;<span class="op" id="6054596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6054601">//&nbsp;atom</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6054612">//&nbsp;We&nbsp;actually&nbsp;parse&nbsp;dot-atom&nbsp;here&nbsp;to&nbsp;be&nbsp;more&nbsp;permissive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6054672">//&nbsp;than&nbsp;what&nbsp;RFC&nbsp;5322&nbsp;specifies.</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054708">word</span><span class="op" id="6054712">,</span>&nbsp;<span class="ident" id="6054714">err</span>&nbsp;<span class="op" id="6054718">=</span>&nbsp;<span class="ident" id="6054720">p</span><span class="op" id="6054721">.</span><span class="ident" id="6054722">consumeAtom</span><span class="op" id="6054733">(</span><span class="builtintype" id="6054734">true</span><span class="op" id="6054738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6054747">//&nbsp;RFC&nbsp;2047&nbsp;encoded-word&nbsp;starts&nbsp;with&nbsp;=?,&nbsp;ends&nbsp;with&nbsp;?=,&nbsp;and&nbsp;has&nbsp;two&nbsp;other&nbsp;?s.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054826">if</span>&nbsp;<span class="ident" id="6054829">err</span>&nbsp;<span class="op" id="6054833">==</span>&nbsp;<span class="ident" id="6054836">nil</span>&nbsp;<span class="op" id="6054840">&amp;&amp;</span>&nbsp;<span class="ident" id="6054843">strings</span><span class="op" id="6054850">.</span><span class="ident" id="6054851">HasPrefix</span><span class="op" id="6054860">(</span><span class="ident" id="6054861">word</span><span class="op" id="6054865">,</span>&nbsp;<span class="string" id="6054867">&#34;=?&#34;</span><span class="op" id="6054871">)</span>&nbsp;<span class="op" id="6054873">&amp;&amp;</span>&nbsp;<span class="ident" id="6054876">strings</span><span class="op" id="6054883">.</span><span class="ident" id="6054884">HasSuffix</span><span class="op" id="6054893">(</span><span class="ident" id="6054894">word</span><span class="op" id="6054898">,</span>&nbsp;<span class="string" id="6054900">&#34;?=&#34;</span><span class="op" id="6054904">)</span>&nbsp;<span class="op" id="6054906">&amp;&amp;</span>&nbsp;<span class="ident" id="6054909">strings</span><span class="op" id="6054916">.</span><span class="ident" id="6054917">Count</span><span class="op" id="6054922">(</span><span class="ident" id="6054923">word</span><span class="op" id="6054927">,</span>&nbsp;<span class="string" id="6054929">&#34;?&#34;</span><span class="op" id="6054932">)</span>&nbsp;<span class="op" id="6054934">==</span>&nbsp;<span class="num" id="6054937">4</span>&nbsp;<span class="op" id="6054939">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6054944">word</span><span class="op" id="6054948">,</span>&nbsp;<span class="ident" id="6054950">err</span>&nbsp;<span class="op" id="6054954">=</span>&nbsp;<span class="ident" id="6054956">decodeRFC2047Word</span><span class="op" id="6054973">(</span><span class="ident" id="6054974">word</span><span class="op" id="6054978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6054982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6054987">if</span>&nbsp;<span class="ident" id="6054990">err</span>&nbsp;<span class="op" id="6054994">!=</span>&nbsp;<span class="ident" id="6054997">nil</span>&nbsp;<span class="op" id="6055001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055006">break</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6055014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055018">debug</span><span class="op" id="6055023">.</span><span class="ident" id="6055024">Printf</span><span class="op" id="6055030">(</span><span class="string" id="6055031">&#34;consumePhrase:&nbsp;consumed&nbsp;%q&#34;</span><span class="op" id="6055059">,</span>&nbsp;<span class="ident" id="6055061">word</span><span class="op" id="6055065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055069">words</span>&nbsp;<span class="op" id="6055075">=</span>&nbsp;<span class="builtinfunc" id="6055077">append</span><span class="op" id="6055083">(</span><span class="ident" id="6055084">words</span><span class="op" id="6055089">,</span>&nbsp;<span class="ident" id="6055091">word</span><span class="op" id="6055095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6055098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6055101">//&nbsp;Ignore&nbsp;any&nbsp;error&nbsp;if&nbsp;we&nbsp;got&nbsp;at&nbsp;least&nbsp;one&nbsp;word.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055151">if</span>&nbsp;<span class="ident" id="6055154">err</span>&nbsp;<span class="op" id="6055158">!=</span>&nbsp;<span class="ident" id="6055161">nil</span>&nbsp;<span class="op" id="6055165">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6055168">len</span><span class="op" id="6055171">(</span><span class="ident" id="6055172">words</span><span class="op" id="6055177">)</span>&nbsp;<span class="op" id="6055179">==</span>&nbsp;<span class="num" id="6055182">0</span>&nbsp;<span class="op" id="6055184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055188">debug</span><span class="op" id="6055193">.</span><span class="ident" id="6055194">Printf</span><span class="op" id="6055200">(</span><span class="string" id="6055201">&#34;consumePhrase:&nbsp;hit&nbsp;err:&nbsp;%v&#34;</span><span class="op" id="6055229">,</span>&nbsp;<span class="ident" id="6055231">err</span><span class="op" id="6055234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055238">return</span>&nbsp;<span class="string" id="6055245">&#34;&#34;</span><span class="op" id="6055247">,</span>&nbsp;<span class="ident" id="6055249">fmt</span><span class="op" id="6055252">.</span><span class="ident" id="6055253">Errorf</span><span class="op" id="6055259">(</span><span class="string" id="6055260">&#34;mail:&nbsp;missing&nbsp;word&nbsp;in&nbsp;phrase:&nbsp;%v&#34;</span><span class="op" id="6055294">,</span>&nbsp;<span class="ident" id="6055296">err</span><span class="op" id="6055299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6055302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055305">phrase</span>&nbsp;<span class="op" id="6055312">=</span>&nbsp;<span class="ident" id="6055314">strings</span><span class="op" id="6055321">.</span><span class="ident" id="6055322">Join</span><span class="op" id="6055326">(</span><span class="ident" id="6055327">words</span><span class="op" id="6055332">,</span>&nbsp;<span class="string" id="6055334">&#34;&nbsp;&#34;</span><span class="op" id="6055337">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055340">return</span>&nbsp;<span class="ident" id="6055347">phrase</span><span class="op" id="6055353">,</span>&nbsp;<span class="ident" id="6055355">nil</span><br>
<span class="lineno"></span><span class="op" id="6055359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6055362">//&nbsp;consumeQuotedString&nbsp;parses&nbsp;the&nbsp;quoted&nbsp;string&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="6055429">func</span>&nbsp;<span class="op" id="6055434">(</span><span class="ident" id="6055435">p</span>&nbsp;<span class="op" id="6055437">*</span><span class="ident" id="6055438">addrParser</span><span class="op" id="6055448">)</span>&nbsp;<span class="ident" id="6055450">consumeQuotedString</span><span class="op" id="6055469">(</span><span class="op" id="6055470">)</span>&nbsp;<span class="op" id="6055472">(</span><span class="ident" id="6055473">qs</span>&nbsp;<span class="builtintype" id="6055476">string</span><span class="op" id="6055482">,</span>&nbsp;<span class="ident" id="6055484">err</span>&nbsp;<span class="builtintype" id="6055488">error</span><span class="op" id="6055493">)</span>&nbsp;<span class="op" id="6055495">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6055498">//&nbsp;Assume&nbsp;first&nbsp;byte&nbsp;is&nbsp;&#39;&#34;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055528">i</span>&nbsp;<span class="op" id="6055530">:=</span>&nbsp;<span class="num" id="6055533">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055536">qsb</span>&nbsp;<span class="op" id="6055540">:=</span>&nbsp;<span class="builtinfunc" id="6055543">make</span><span class="op" id="6055547">(</span><span class="op" id="6055548">[</span><span class="op" id="6055549">]</span><span class="builtintype" id="6055550">byte</span><span class="op" id="6055554">,</span>&nbsp;<span class="num" id="6055556">0</span><span class="op" id="6055557">,</span>&nbsp;<span class="num" id="6055559">10</span><span class="op" id="6055561">)</span><br>
<span class="lineno"></span><span class="ident" id="6055563">Loop</span><span class="op" id="6055567">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055570">for</span>&nbsp;<span class="op" id="6055574">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055578">if</span>&nbsp;<span class="ident" id="6055581">i</span>&nbsp;<span class="op" id="6055583">&gt;=</span>&nbsp;<span class="ident" id="6055586">p</span><span class="op" id="6055587">.</span><span class="builtinfunc" id="6055588">len</span><span class="op" id="6055591">(</span><span class="op" id="6055592">)</span>&nbsp;<span class="op" id="6055594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055599">return</span>&nbsp;<span class="string" id="6055606">&#34;&#34;</span><span class="op" id="6055608">,</span>&nbsp;<span class="ident" id="6055610">errors</span><span class="op" id="6055616">.</span><span class="ident" id="6055617">New</span><span class="op" id="6055620">(</span><span class="string" id="6055621">&#34;mail:&nbsp;unclosed&nbsp;quoted-string&#34;</span><span class="op" id="6055651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6055655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055659">switch</span>&nbsp;<span class="ident" id="6055666">c</span>&nbsp;<span class="op" id="6055668">:=</span>&nbsp;<span class="op" id="6055671">(</span><span class="op" id="6055672">*</span><span class="ident" id="6055673">p</span><span class="op" id="6055674">)</span><span class="op" id="6055675">[</span><span class="ident" id="6055676">i</span><span class="op" id="6055677">]</span><span class="op" id="6055678">;</span>&nbsp;<span class="op" id="6055680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055684">case</span>&nbsp;<span class="ident" id="6055689">c</span>&nbsp;<span class="op" id="6055691">==</span>&nbsp;<span class="string" id="6055694">&#39;&#34;&#39;</span><span class="op" id="6055697">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055702">break</span>&nbsp;<span class="ident" id="6055708">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055715">case</span>&nbsp;<span class="ident" id="6055720">c</span>&nbsp;<span class="op" id="6055722">==</span>&nbsp;<span class="string" id="6055725">&#39;\\&#39;</span><span class="op" id="6055729">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055734">if</span>&nbsp;<span class="ident" id="6055737">i</span><span class="op" id="6055738">+</span><span class="num" id="6055739">1</span>&nbsp;<span class="op" id="6055741">==</span>&nbsp;<span class="ident" id="6055744">p</span><span class="op" id="6055745">.</span><span class="builtinfunc" id="6055746">len</span><span class="op" id="6055749">(</span><span class="op" id="6055750">)</span>&nbsp;<span class="op" id="6055752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055758">return</span>&nbsp;<span class="string" id="6055765">&#34;&#34;</span><span class="op" id="6055767">,</span>&nbsp;<span class="ident" id="6055769">errors</span><span class="op" id="6055775">.</span><span class="ident" id="6055776">New</span><span class="op" id="6055779">(</span><span class="string" id="6055780">&#34;mail:&nbsp;unclosed&nbsp;quoted-string&#34;</span><span class="op" id="6055810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6055815">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055820">qsb</span>&nbsp;<span class="op" id="6055824">=</span>&nbsp;<span class="builtinfunc" id="6055826">append</span><span class="op" id="6055832">(</span><span class="ident" id="6055833">qsb</span><span class="op" id="6055836">,</span>&nbsp;<span class="op" id="6055838">(</span><span class="op" id="6055839">*</span><span class="ident" id="6055840">p</span><span class="op" id="6055841">)</span><span class="op" id="6055842">[</span><span class="ident" id="6055843">i</span><span class="op" id="6055844">+</span><span class="num" id="6055845">1</span><span class="op" id="6055846">]</span><span class="op" id="6055847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055852">i</span>&nbsp;<span class="op" id="6055854">+=</span>&nbsp;<span class="num" id="6055857">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6055861">case</span>&nbsp;<span class="ident" id="6055866">isQtext</span><span class="op" id="6055873">(</span><span class="ident" id="6055874">c</span><span class="op" id="6055875">)</span><span class="op" id="6055876">,</span>&nbsp;<span class="ident" id="6055878">c</span>&nbsp;<span class="op" id="6055880">==</span>&nbsp;<span class="string" id="6055883">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="6055887">||</span>&nbsp;<span class="ident" id="6055890">c</span>&nbsp;<span class="op" id="6055892">==</span>&nbsp;<span class="string" id="6055895">&#39;\t&#39;</span><span class="op" id="6055899">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6055904">//&nbsp;qtext&nbsp;(printable&nbsp;US-ASCII&nbsp;excluding&nbsp;&#34;&nbsp;and&nbsp;\),&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6055959">//&nbsp;FWS&nbsp;(almost;&nbsp;we&#39;re&nbsp;ignoring&nbsp;CRLF)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6055999">qsb</span>&nbsp;<span class="op" id="6056003">=</span>&nbsp;<span class="builtinfunc" id="6056005">append</span><span class="op" id="6056011">(</span><span class="ident" id="6056012">qsb</span><span class="op" id="6056015">,</span>&nbsp;<span class="ident" id="6056017">c</span><span class="op" id="6056018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056023">i</span><span class="op" id="6056024">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056029">default</span><span class="op" id="6056036">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056041">return</span>&nbsp;<span class="string" id="6056048">&#34;&#34;</span><span class="op" id="6056050">,</span>&nbsp;<span class="ident" id="6056052">fmt</span><span class="op" id="6056055">.</span><span class="ident" id="6056056">Errorf</span><span class="op" id="6056062">(</span><span class="string" id="6056063">&#34;mail:&nbsp;bad&nbsp;character&nbsp;in&nbsp;quoted-string:&nbsp;%q&#34;</span><span class="op" id="6056105">,</span>&nbsp;<span class="ident" id="6056107">c</span><span class="op" id="6056108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6056112">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6056115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6056118">*</span><span class="ident" id="6056119">p</span>&nbsp;<span class="op" id="6056121">=</span>&nbsp;<span class="op" id="6056123">(</span><span class="op" id="6056124">*</span><span class="ident" id="6056125">p</span><span class="op" id="6056126">)</span><span class="op" id="6056127">[</span><span class="ident" id="6056128">i</span><span class="op" id="6056129">+</span><span class="num" id="6056130">1</span><span class="op" id="6056131">:</span><span class="op" id="6056132">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056135">return</span>&nbsp;<span class="builtintype" id="6056142">string</span><span class="op" id="6056148">(</span><span class="ident" id="6056149">qsb</span><span class="op" id="6056152">)</span><span class="op" id="6056153">,</span>&nbsp;<span class="ident" id="6056155">nil</span><br>
<span class="lineno"></span><span class="op" id="6056159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="comment" id="6056162">//&nbsp;consumeAtom&nbsp;parses&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;atom&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="comment" id="6056220">//&nbsp;If&nbsp;dot&nbsp;is&nbsp;true,&nbsp;consumeAtom&nbsp;parses&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;dot-atom&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="6056288">func</span>&nbsp;<span class="op" id="6056293">(</span><span class="ident" id="6056294">p</span>&nbsp;<span class="op" id="6056296">*</span><span class="ident" id="6056297">addrParser</span><span class="op" id="6056307">)</span>&nbsp;<span class="ident" id="6056309">consumeAtom</span><span class="op" id="6056320">(</span><span class="ident" id="6056321">dot</span>&nbsp;<span class="builtintype" id="6056325">bool</span><span class="op" id="6056329">)</span>&nbsp;<span class="op" id="6056331">(</span><span class="ident" id="6056332">atom</span>&nbsp;<span class="builtintype" id="6056337">string</span><span class="op" id="6056343">,</span>&nbsp;<span class="ident" id="6056345">err</span>&nbsp;<span class="builtintype" id="6056349">error</span><span class="op" id="6056354">)</span>&nbsp;<span class="op" id="6056356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056359">if</span>&nbsp;<span class="op" id="6056362">!</span><span class="ident" id="6056363">isAtext</span><span class="op" id="6056370">(</span><span class="ident" id="6056371">p</span><span class="op" id="6056372">.</span><span class="ident" id="6056373">peek</span><span class="op" id="6056377">(</span><span class="op" id="6056378">)</span><span class="op" id="6056379">,</span>&nbsp;<span class="builtintype" id="6056381">false</span><span class="op" id="6056386">)</span>&nbsp;<span class="op" id="6056388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056392">return</span>&nbsp;<span class="string" id="6056399">&#34;&#34;</span><span class="op" id="6056401">,</span>&nbsp;<span class="ident" id="6056403">errors</span><span class="op" id="6056409">.</span><span class="ident" id="6056410">New</span><span class="op" id="6056413">(</span><span class="string" id="6056414">&#34;mail:&nbsp;invalid&nbsp;string&#34;</span><span class="op" id="6056436">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6056439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056442">i</span>&nbsp;<span class="op" id="6056444">:=</span>&nbsp;<span class="num" id="6056447">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056450">for</span>&nbsp;<span class="op" id="6056454">;</span>&nbsp;<span class="ident" id="6056456">i</span>&nbsp;<span class="op" id="6056458">&lt;</span>&nbsp;<span class="ident" id="6056460">p</span><span class="op" id="6056461">.</span><span class="builtinfunc" id="6056462">len</span><span class="op" id="6056465">(</span><span class="op" id="6056466">)</span>&nbsp;<span class="op" id="6056468">&amp;&amp;</span>&nbsp;<span class="ident" id="6056471">isAtext</span><span class="op" id="6056478">(</span><span class="op" id="6056479">(</span><span class="op" id="6056480">*</span><span class="ident" id="6056481">p</span><span class="op" id="6056482">)</span><span class="op" id="6056483">[</span><span class="ident" id="6056484">i</span><span class="op" id="6056485">]</span><span class="op" id="6056486">,</span>&nbsp;<span class="ident" id="6056488">dot</span><span class="op" id="6056491">)</span><span class="op" id="6056492">;</span>&nbsp;<span class="ident" id="6056494">i</span><span class="op" id="6056495">++</span>&nbsp;<span class="op" id="6056498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6056501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6056504">atom</span><span class="op" id="6056508">,</span>&nbsp;<span class="op" id="6056510">*</span><span class="ident" id="6056511">p</span>&nbsp;<span class="op" id="6056513">=</span>&nbsp;<span class="builtintype" id="6056515">string</span><span class="op" id="6056521">(</span><span class="op" id="6056522">(</span><span class="op" id="6056523">*</span><span class="ident" id="6056524">p</span><span class="op" id="6056525">)</span><span class="op" id="6056526">[</span><span class="op" id="6056527">:</span><span class="ident" id="6056528">i</span><span class="op" id="6056529">]</span><span class="op" id="6056530">)</span><span class="op" id="6056531">,</span>&nbsp;<span class="op" id="6056533">(</span><span class="op" id="6056534">*</span><span class="ident" id="6056535">p</span><span class="op" id="6056536">)</span><span class="op" id="6056537">[</span><span class="ident" id="6056538">i</span><span class="op" id="6056539">:</span><span class="op" id="6056540">]</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056543">return</span>&nbsp;<span class="ident" id="6056550">atom</span><span class="op" id="6056554">,</span>&nbsp;<span class="ident" id="6056556">nil</span><br>
<span class="lineno"></span><span class="op" id="6056560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6056563">func</span>&nbsp;<span class="op" id="6056568">(</span><span class="ident" id="6056569">p</span>&nbsp;<span class="op" id="6056571">*</span><span class="ident" id="6056572">addrParser</span><span class="op" id="6056582">)</span>&nbsp;<span class="ident" id="6056584">consume</span><span class="op" id="6056591">(</span><span class="ident" id="6056592">c</span>&nbsp;<span class="builtintype" id="6056594">byte</span><span class="op" id="6056598">)</span>&nbsp;<span class="builtintype" id="6056600">bool</span>&nbsp;<span class="op" id="6056605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056608">if</span>&nbsp;<span class="ident" id="6056611">p</span><span class="op" id="6056612">.</span><span class="ident" id="6056613">empty</span><span class="op" id="6056618">(</span><span class="op" id="6056619">)</span>&nbsp;<span class="op" id="6056621">||</span>&nbsp;<span class="ident" id="6056624">p</span><span class="op" id="6056625">.</span><span class="ident" id="6056626">peek</span><span class="op" id="6056630">(</span><span class="op" id="6056631">)</span>&nbsp;<span class="op" id="6056633">!=</span>&nbsp;<span class="ident" id="6056636">c</span>&nbsp;<span class="op" id="6056638">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056642">return</span>&nbsp;<span class="builtintype" id="6056649">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6056656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6056659">*</span><span class="ident" id="6056660">p</span>&nbsp;<span class="op" id="6056662">=</span>&nbsp;<span class="op" id="6056664">(</span><span class="op" id="6056665">*</span><span class="ident" id="6056666">p</span><span class="op" id="6056667">)</span><span class="op" id="6056668">[</span><span class="num" id="6056669">1</span><span class="op" id="6056670">:</span><span class="op" id="6056671">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056674">return</span>&nbsp;<span class="builtintype" id="6056681">true</span><br>
<span class="lineno"></span><span class="op" id="6056686">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="6056689">//&nbsp;skipSpace&nbsp;skips&nbsp;the&nbsp;leading&nbsp;space&nbsp;and&nbsp;tab&nbsp;characters.</span><br>
<span class="lineno"></span><span class="keyword" id="6056746">func</span>&nbsp;<span class="op" id="6056751">(</span><span class="ident" id="6056752">p</span>&nbsp;<span class="op" id="6056754">*</span><span class="ident" id="6056755">addrParser</span><span class="op" id="6056765">)</span>&nbsp;<span class="ident" id="6056767">skipSpace</span><span class="op" id="6056776">(</span><span class="op" id="6056777">)</span>&nbsp;<span class="op" id="6056779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6056782">*</span><span class="ident" id="6056783">p</span>&nbsp;<span class="op" id="6056785">=</span>&nbsp;<span class="ident" id="6056787">bytes</span><span class="op" id="6056792">.</span><span class="ident" id="6056793">TrimLeft</span><span class="op" id="6056801">(</span><span class="op" id="6056802">*</span><span class="ident" id="6056803">p</span><span class="op" id="6056804">,</span>&nbsp;<span class="string" id="6056806">&#34;&nbsp;\t&#34;</span><span class="op" id="6056811">)</span><br>
<span class="lineno"></span><span class="op" id="6056813">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="6056816">func</span>&nbsp;<span class="op" id="6056821">(</span><span class="ident" id="6056822">p</span>&nbsp;<span class="op" id="6056824">*</span><span class="ident" id="6056825">addrParser</span><span class="op" id="6056835">)</span>&nbsp;<span class="ident" id="6056837">peek</span><span class="op" id="6056841">(</span><span class="op" id="6056842">)</span>&nbsp;<span class="builtintype" id="6056844">byte</span>&nbsp;<span class="op" id="6056849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056852">return</span>&nbsp;<span class="op" id="6056859">(</span><span class="op" id="6056860">*</span><span class="ident" id="6056861">p</span><span class="op" id="6056862">)</span><span class="op" id="6056863">[</span><span class="num" id="6056864">0</span><span class="op" id="6056865">]</span><br>
<span class="lineno"></span><span class="op" id="6056867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="6056870">func</span>&nbsp;<span class="op" id="6056875">(</span><span class="ident" id="6056876">p</span>&nbsp;<span class="op" id="6056878">*</span><span class="ident" id="6056879">addrParser</span><span class="op" id="6056889">)</span>&nbsp;<span class="ident" id="6056891">empty</span><span class="op" id="6056896">(</span><span class="op" id="6056897">)</span>&nbsp;<span class="builtintype" id="6056899">bool</span>&nbsp;<span class="op" id="6056904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056907">return</span>&nbsp;<span class="ident" id="6056914">p</span><span class="op" id="6056915">.</span><span class="builtinfunc" id="6056916">len</span><span class="op" id="6056919">(</span><span class="op" id="6056920">)</span>&nbsp;<span class="op" id="6056922">==</span>&nbsp;<span class="num" id="6056925">0</span><br>
<span class="lineno"></span><span class="op" id="6056927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6056930">func</span>&nbsp;<span class="op" id="6056935">(</span><span class="ident" id="6056936">p</span>&nbsp;<span class="op" id="6056938">*</span><span class="ident" id="6056939">addrParser</span><span class="op" id="6056949">)</span>&nbsp;<span class="builtinfunc" id="6056951">len</span><span class="op" id="6056954">(</span><span class="op" id="6056955">)</span>&nbsp;<span class="builtintype" id="6056957">int</span>&nbsp;<span class="op" id="6056961">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6056964">return</span>&nbsp;<span class="builtinfunc" id="6056971">len</span><span class="op" id="6056974">(</span><span class="op" id="6056975">*</span><span class="ident" id="6056976">p</span><span class="op" id="6056977">)</span><br>
<span class="lineno"></span><span class="op" id="6056979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6056982">func</span>&nbsp;<span class="ident" id="6056987">decodeRFC2047Word</span><span class="op" id="6057004">(</span><span class="ident" id="6057005">s</span>&nbsp;<span class="builtintype" id="6057007">string</span><span class="op" id="6057013">)</span>&nbsp;<span class="op" id="6057015">(</span><span class="builtintype" id="6057016">string</span><span class="op" id="6057022">,</span>&nbsp;<span class="builtintype" id="6057024">error</span><span class="op" id="6057029">)</span>&nbsp;<span class="op" id="6057031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057034">fields</span>&nbsp;<span class="op" id="6057041">:=</span>&nbsp;<span class="ident" id="6057044">strings</span><span class="op" id="6057051">.</span><span class="ident" id="6057052">Split</span><span class="op" id="6057057">(</span><span class="ident" id="6057058">s</span><span class="op" id="6057059">,</span>&nbsp;<span class="string" id="6057061">&#34;?&#34;</span><span class="op" id="6057064">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057067">if</span>&nbsp;<span class="builtinfunc" id="6057070">len</span><span class="op" id="6057073">(</span><span class="ident" id="6057074">fields</span><span class="op" id="6057080">)</span>&nbsp;<span class="op" id="6057082">!=</span>&nbsp;<span class="num" id="6057085">5</span>&nbsp;<span class="op" id="6057087">||</span>&nbsp;<span class="ident" id="6057090">fields</span><span class="op" id="6057096">[</span><span class="num" id="6057097">0</span><span class="op" id="6057098">]</span>&nbsp;<span class="op" id="6057100">!=</span>&nbsp;<span class="string" id="6057103">&#34;=&#34;</span>&nbsp;<span class="op" id="6057107">||</span>&nbsp;<span class="ident" id="6057110">fields</span><span class="op" id="6057116">[</span><span class="num" id="6057117">4</span><span class="op" id="6057118">]</span>&nbsp;<span class="op" id="6057120">!=</span>&nbsp;<span class="string" id="6057123">&#34;=&#34;</span>&nbsp;<span class="op" id="6057127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057131">return</span>&nbsp;<span class="string" id="6057138">&#34;&#34;</span><span class="op" id="6057140">,</span>&nbsp;<span class="ident" id="6057142">errors</span><span class="op" id="6057148">.</span><span class="ident" id="6057149">New</span><span class="op" id="6057152">(</span><span class="string" id="6057153">&#34;address&nbsp;not&nbsp;RFC&nbsp;2047&nbsp;encoded&#34;</span><span class="op" id="6057183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057189">charset</span><span class="op" id="6057196">,</span>&nbsp;<span class="ident" id="6057198">enc</span>&nbsp;<span class="op" id="6057202">:=</span>&nbsp;<span class="ident" id="6057205">strings</span><span class="op" id="6057212">.</span><span class="ident" id="6057213">ToLower</span><span class="op" id="6057220">(</span><span class="ident" id="6057221">fields</span><span class="op" id="6057227">[</span><span class="num" id="6057228">1</span><span class="op" id="6057229">]</span><span class="op" id="6057230">)</span><span class="op" id="6057231">,</span>&nbsp;<span class="ident" id="6057233">strings</span><span class="op" id="6057240">.</span><span class="ident" id="6057241">ToLower</span><span class="op" id="6057248">(</span><span class="ident" id="6057249">fields</span><span class="op" id="6057255">[</span><span class="num" id="6057256">2</span><span class="op" id="6057257">]</span><span class="op" id="6057258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057261">if</span>&nbsp;<span class="ident" id="6057264">charset</span>&nbsp;<span class="op" id="6057272">!=</span>&nbsp;<span class="string" id="6057275">&#34;us-ascii&#34;</span>&nbsp;<span class="op" id="6057286">&amp;&amp;</span>&nbsp;<span class="ident" id="6057289">charset</span>&nbsp;<span class="op" id="6057297">!=</span>&nbsp;<span class="string" id="6057300">&#34;iso-8859-1&#34;</span>&nbsp;<span class="op" id="6057313">&amp;&amp;</span>&nbsp;<span class="ident" id="6057316">charset</span>&nbsp;<span class="op" id="6057324">!=</span>&nbsp;<span class="string" id="6057327">&#34;utf-8&#34;</span>&nbsp;<span class="op" id="6057335">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057339">return</span>&nbsp;<span class="string" id="6057346">&#34;&#34;</span><span class="op" id="6057348">,</span>&nbsp;<span class="ident" id="6057350">fmt</span><span class="op" id="6057353">.</span><span class="ident" id="6057354">Errorf</span><span class="op" id="6057360">(</span><span class="string" id="6057361">&#34;charset&nbsp;not&nbsp;supported:&nbsp;%q&#34;</span><span class="op" id="6057388">,</span>&nbsp;<span class="ident" id="6057390">charset</span><span class="op" id="6057397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057404">in</span>&nbsp;<span class="op" id="6057407">:=</span>&nbsp;<span class="ident" id="6057410">bytes</span><span class="op" id="6057415">.</span><span class="ident" id="6057416">NewBufferString</span><span class="op" id="6057431">(</span><span class="ident" id="6057432">fields</span><span class="op" id="6057438">[</span><span class="num" id="6057439">3</span><span class="op" id="6057440">]</span><span class="op" id="6057441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057444">var</span>&nbsp;<span class="ident" id="6057448">r</span>&nbsp;<span class="ident" id="6057450">io</span><span class="op" id="6057452">.</span><span class="ident" id="6057453">Reader</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057461">switch</span>&nbsp;<span class="ident" id="6057468">enc</span>&nbsp;<span class="op" id="6057472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057475">case</span>&nbsp;<span class="string" id="6057480">&#34;b&#34;</span><span class="op" id="6057483">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057487">r</span>&nbsp;<span class="op" id="6057489">=</span>&nbsp;<span class="ident" id="6057491">base64</span><span class="op" id="6057497">.</span><span class="ident" id="6057498">NewDecoder</span><span class="op" id="6057508">(</span><span class="ident" id="6057509">base64</span><span class="op" id="6057515">.</span><span class="ident" id="6057516">StdEncoding</span><span class="op" id="6057527">,</span>&nbsp;<span class="ident" id="6057529">in</span><span class="op" id="6057531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057534">case</span>&nbsp;<span class="string" id="6057539">&#34;q&#34;</span><span class="op" id="6057542">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057546">r</span>&nbsp;<span class="op" id="6057548">=</span>&nbsp;<span class="ident" id="6057550">qDecoder</span><span class="op" id="6057558">{</span><span class="ident" id="6057559">r</span><span class="op" id="6057560">:</span>&nbsp;<span class="ident" id="6057562">in</span><span class="op" id="6057564">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057567">default</span><span class="op" id="6057574">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057578">return</span>&nbsp;<span class="string" id="6057585">&#34;&#34;</span><span class="op" id="6057587">,</span>&nbsp;<span class="ident" id="6057589">fmt</span><span class="op" id="6057592">.</span><span class="ident" id="6057593">Errorf</span><span class="op" id="6057599">(</span><span class="string" id="6057600">&#34;RFC&nbsp;2047&nbsp;encoding&nbsp;not&nbsp;supported:&nbsp;%q&#34;</span><span class="op" id="6057637">,</span>&nbsp;<span class="ident" id="6057639">enc</span><span class="op" id="6057642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057649">dec</span><span class="op" id="6057652">,</span>&nbsp;<span class="ident" id="6057654">err</span>&nbsp;<span class="op" id="6057658">:=</span>&nbsp;<span class="ident" id="6057661">ioutil</span><span class="op" id="6057667">.</span><span class="ident" id="6057668">ReadAll</span><span class="op" id="6057675">(</span><span class="ident" id="6057676">r</span><span class="op" id="6057677">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057680">if</span>&nbsp;<span class="ident" id="6057683">err</span>&nbsp;<span class="op" id="6057687">!=</span>&nbsp;<span class="ident" id="6057690">nil</span>&nbsp;<span class="op" id="6057694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057698">return</span>&nbsp;<span class="string" id="6057705">&#34;&#34;</span><span class="op" id="6057707">,</span>&nbsp;<span class="ident" id="6057709">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057718">switch</span>&nbsp;<span class="ident" id="6057725">charset</span>&nbsp;<span class="op" id="6057733">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057736">case</span>&nbsp;<span class="string" id="6057741">&#34;us-ascii&#34;</span><span class="op" id="6057751">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057755">b</span>&nbsp;<span class="op" id="6057757">:=</span>&nbsp;<span class="builtinfunc" id="6057760">new</span><span class="op" id="6057763">(</span><span class="ident" id="6057764">bytes</span><span class="op" id="6057769">.</span><span class="ident" id="6057770">Buffer</span><span class="op" id="6057776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057780">for</span>&nbsp;<span class="ident" id="6057784">_</span><span class="op" id="6057785">,</span>&nbsp;<span class="ident" id="6057787">c</span>&nbsp;<span class="op" id="6057789">:=</span>&nbsp;<span class="keyword" id="6057792">range</span>&nbsp;<span class="ident" id="6057798">dec</span>&nbsp;<span class="op" id="6057802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057807">if</span>&nbsp;<span class="ident" id="6057810">c</span>&nbsp;<span class="op" id="6057812">&gt;=</span>&nbsp;<span class="num" id="6057815">0x80</span>&nbsp;<span class="op" id="6057820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057826">b</span><span class="op" id="6057827">.</span><span class="ident" id="6057828">WriteRune</span><span class="op" id="6057837">(</span><span class="ident" id="6057838">unicode</span><span class="op" id="6057845">.</span><span class="ident" id="6057846">ReplacementChar</span><span class="op" id="6057861">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057866">}</span>&nbsp;<span class="keyword" id="6057868">else</span>&nbsp;<span class="op" id="6057873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057879">b</span><span class="op" id="6057880">.</span><span class="ident" id="6057881">WriteRune</span><span class="op" id="6057890">(</span><span class="builtintype" id="6057891">rune</span><span class="op" id="6057895">(</span><span class="ident" id="6057896">c</span><span class="op" id="6057897">)</span><span class="op" id="6057898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6057907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057911">return</span>&nbsp;<span class="ident" id="6057918">b</span><span class="op" id="6057919">.</span><span class="ident" id="6057920">String</span><span class="op" id="6057926">(</span><span class="op" id="6057927">)</span><span class="op" id="6057928">,</span>&nbsp;<span class="ident" id="6057930">nil</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057935">case</span>&nbsp;<span class="string" id="6057940">&#34;iso-8859-1&#34;</span><span class="op" id="6057952">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6057956">b</span>&nbsp;<span class="op" id="6057958">:=</span>&nbsp;<span class="builtinfunc" id="6057961">new</span><span class="op" id="6057964">(</span><span class="ident" id="6057965">bytes</span><span class="op" id="6057970">.</span><span class="ident" id="6057971">Buffer</span><span class="op" id="6057977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6057981">for</span>&nbsp;<span class="ident" id="6057985">_</span><span class="op" id="6057986">,</span>&nbsp;<span class="ident" id="6057988">c</span>&nbsp;<span class="op" id="6057990">:=</span>&nbsp;<span class="keyword" id="6057993">range</span>&nbsp;<span class="ident" id="6057999">dec</span>&nbsp;<span class="op" id="6058003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058008">b</span><span class="op" id="6058009">.</span><span class="ident" id="6058010">WriteRune</span><span class="op" id="6058019">(</span><span class="builtintype" id="6058020">rune</span><span class="op" id="6058024">(</span><span class="ident" id="6058025">c</span><span class="op" id="6058026">)</span><span class="op" id="6058027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6058031">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058035">return</span>&nbsp;<span class="ident" id="6058042">b</span><span class="op" id="6058043">.</span><span class="ident" id="6058044">String</span><span class="op" id="6058050">(</span><span class="op" id="6058051">)</span><span class="op" id="6058052">,</span>&nbsp;<span class="ident" id="6058054">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058059">case</span>&nbsp;<span class="string" id="6058064">&#34;utf-8&#34;</span><span class="op" id="6058071">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058075">return</span>&nbsp;<span class="builtintype" id="6058082">string</span><span class="op" id="6058088">(</span><span class="ident" id="6058089">dec</span><span class="op" id="6058092">)</span><span class="op" id="6058093">,</span>&nbsp;<span class="ident" id="6058095">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6058100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6058103">panic</span><span class="op" id="6058108">(</span><span class="string" id="6058109">&#34;unreachable&#34;</span><span class="op" id="6058122">)</span><br>
<span class="lineno">490</span><span class="op" id="6058124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6058127">type</span>&nbsp;<span class="ident" id="6058132">qDecoder</span>&nbsp;<span class="keyword" id="6058141">struct</span>&nbsp;<span class="op" id="6058148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058151">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6058159">io</span><span class="op" id="6058161">.</span><span class="ident" id="6058162">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058170">scratch</span>&nbsp;<span class="op" id="6058178">[</span><span class="num" id="6058179">2</span><span class="op" id="6058180">]</span><span class="builtintype" id="6058181">byte</span><br>
<span class="lineno">495</span><span class="op" id="6058186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6058189">func</span>&nbsp;<span class="op" id="6058194">(</span><span class="ident" id="6058195">qd</span>&nbsp;<span class="ident" id="6058198">qDecoder</span><span class="op" id="6058206">)</span>&nbsp;<span class="ident" id="6058208">Read</span><span class="op" id="6058212">(</span><span class="ident" id="6058213">p</span>&nbsp;<span class="op" id="6058215">[</span><span class="op" id="6058216">]</span><span class="builtintype" id="6058217">byte</span><span class="op" id="6058221">)</span>&nbsp;<span class="op" id="6058223">(</span><span class="ident" id="6058224">n</span>&nbsp;<span class="builtintype" id="6058226">int</span><span class="op" id="6058229">,</span>&nbsp;<span class="ident" id="6058231">err</span>&nbsp;<span class="builtintype" id="6058235">error</span><span class="op" id="6058240">)</span>&nbsp;<span class="op" id="6058242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6058245">//&nbsp;This&nbsp;method&nbsp;writes&nbsp;at&nbsp;most&nbsp;one&nbsp;byte&nbsp;into&nbsp;p.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058293">if</span>&nbsp;<span class="builtinfunc" id="6058296">len</span><span class="op" id="6058299">(</span><span class="ident" id="6058300">p</span><span class="op" id="6058301">)</span>&nbsp;<span class="op" id="6058303">==</span>&nbsp;<span class="num" id="6058306">0</span>&nbsp;<span class="op" id="6058308">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058312">return</span>&nbsp;<span class="num" id="6058319">0</span><span class="op" id="6058320">,</span>&nbsp;<span class="ident" id="6058322">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6058327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058330">if</span>&nbsp;<span class="ident" id="6058333">_</span><span class="op" id="6058334">,</span>&nbsp;<span class="ident" id="6058336">err</span>&nbsp;<span class="op" id="6058340">:=</span>&nbsp;<span class="ident" id="6058343">qd</span><span class="op" id="6058345">.</span><span class="ident" id="6058346">r</span><span class="op" id="6058347">.</span><span class="ident" id="6058348">Read</span><span class="op" id="6058352">(</span><span class="ident" id="6058353">qd</span><span class="op" id="6058355">.</span><span class="ident" id="6058356">scratch</span><span class="op" id="6058363">[</span><span class="op" id="6058364">:</span><span class="num" id="6058365">1</span><span class="op" id="6058366">]</span><span class="op" id="6058367">)</span><span class="op" id="6058368">;</span>&nbsp;<span class="ident" id="6058370">err</span>&nbsp;<span class="op" id="6058374">!=</span>&nbsp;<span class="ident" id="6058377">nil</span>&nbsp;<span class="op" id="6058381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058385">return</span>&nbsp;<span class="num" id="6058392">0</span><span class="op" id="6058393">,</span>&nbsp;<span class="ident" id="6058395">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6058400">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058403">switch</span>&nbsp;<span class="ident" id="6058410">c</span>&nbsp;<span class="op" id="6058412">:=</span>&nbsp;<span class="ident" id="6058415">qd</span><span class="op" id="6058417">.</span><span class="ident" id="6058418">scratch</span><span class="op" id="6058425">[</span><span class="num" id="6058426">0</span><span class="op" id="6058427">]</span><span class="op" id="6058428">;</span>&nbsp;<span class="op" id="6058430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058433">case</span>&nbsp;<span class="ident" id="6058438">c</span>&nbsp;<span class="op" id="6058440">==</span>&nbsp;<span class="string" id="6058443">&#39;=&#39;</span><span class="op" id="6058446">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058450">if</span>&nbsp;<span class="ident" id="6058453">_</span><span class="op" id="6058454">,</span>&nbsp;<span class="ident" id="6058456">err</span>&nbsp;<span class="op" id="6058460">:=</span>&nbsp;<span class="ident" id="6058463">io</span><span class="op" id="6058465">.</span><span class="ident" id="6058466">ReadFull</span><span class="op" id="6058474">(</span><span class="ident" id="6058475">qd</span><span class="op" id="6058477">.</span><span class="ident" id="6058478">r</span><span class="op" id="6058479">,</span>&nbsp;<span class="ident" id="6058481">qd</span><span class="op" id="6058483">.</span><span class="ident" id="6058484">scratch</span><span class="op" id="6058491">[</span><span class="op" id="6058492">:</span><span class="num" id="6058493">2</span><span class="op" id="6058494">]</span><span class="op" id="6058495">)</span><span class="op" id="6058496">;</span>&nbsp;<span class="ident" id="6058498">err</span>&nbsp;<span class="op" id="6058502">!=</span>&nbsp;<span class="ident" id="6058505">nil</span>&nbsp;<span class="op" id="6058509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058514">return</span>&nbsp;<span class="num" id="6058521">0</span><span class="op" id="6058522">,</span>&nbsp;<span class="ident" id="6058524">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6058530">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058534">x</span><span class="op" id="6058535">,</span>&nbsp;<span class="ident" id="6058537">err</span>&nbsp;<span class="op" id="6058541">:=</span>&nbsp;<span class="ident" id="6058544">strconv</span><span class="op" id="6058551">.</span><span class="ident" id="6058552">ParseInt</span><span class="op" id="6058560">(</span><span class="builtintype" id="6058561">string</span><span class="op" id="6058567">(</span><span class="ident" id="6058568">qd</span><span class="op" id="6058570">.</span><span class="ident" id="6058571">scratch</span><span class="op" id="6058578">[</span><span class="op" id="6058579">:</span><span class="num" id="6058580">2</span><span class="op" id="6058581">]</span><span class="op" id="6058582">)</span><span class="op" id="6058583">,</span>&nbsp;<span class="num" id="6058585">16</span><span class="op" id="6058587">,</span>&nbsp;<span class="num" id="6058589">64</span><span class="op" id="6058591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058595">if</span>&nbsp;<span class="ident" id="6058598">err</span>&nbsp;<span class="op" id="6058602">!=</span>&nbsp;<span class="ident" id="6058605">nil</span>&nbsp;<span class="op" id="6058609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058614">return</span>&nbsp;<span class="num" id="6058621">0</span><span class="op" id="6058622">,</span>&nbsp;<span class="ident" id="6058624">fmt</span><span class="op" id="6058627">.</span><span class="ident" id="6058628">Errorf</span><span class="op" id="6058634">(</span><span class="string" id="6058635">&#34;mail:&nbsp;invalid&nbsp;RFC&nbsp;2047&nbsp;encoding:&nbsp;%q&#34;</span><span class="op" id="6058672">,</span>&nbsp;<span class="ident" id="6058674">qd</span><span class="op" id="6058676">.</span><span class="ident" id="6058677">scratch</span><span class="op" id="6058684">[</span><span class="op" id="6058685">:</span><span class="num" id="6058686">2</span><span class="op" id="6058687">]</span><span class="op" id="6058688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6058692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058696">p</span><span class="op" id="6058697">[</span><span class="num" id="6058698">0</span><span class="op" id="6058699">]</span>&nbsp;<span class="op" id="6058701">=</span>&nbsp;<span class="builtintype" id="6058703">byte</span><span class="op" id="6058707">(</span><span class="ident" id="6058708">x</span><span class="op" id="6058709">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058712">case</span>&nbsp;<span class="ident" id="6058717">c</span>&nbsp;<span class="op" id="6058719">==</span>&nbsp;<span class="string" id="6058722">&#39;_&#39;</span><span class="op" id="6058725">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058729">p</span><span class="op" id="6058730">[</span><span class="num" id="6058731">0</span><span class="op" id="6058732">]</span>&nbsp;<span class="op" id="6058734">=</span>&nbsp;<span class="string" id="6058736">&#39;&nbsp;&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058741">default</span><span class="op" id="6058748">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6058752">p</span><span class="op" id="6058753">[</span><span class="num" id="6058754">0</span><span class="op" id="6058755">]</span>&nbsp;<span class="op" id="6058757">=</span>&nbsp;<span class="ident" id="6058759">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6058762">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6058765">return</span>&nbsp;<span class="num" id="6058772">1</span><span class="op" id="6058773">,</span>&nbsp;<span class="ident" id="6058775">nil</span><br>
<span class="lineno"></span><span class="op" id="6058779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6058782">var</span>&nbsp;<span class="ident" id="6058786">atextChars</span>&nbsp;<span class="op" id="6058797">=</span>&nbsp;<span class="op" id="6058799">[</span><span class="op" id="6058800">]</span><span class="builtintype" id="6058801">byte</span><span class="op" id="6058805">(</span><span class="string" id="6058806">&#34;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#34;</span>&nbsp;<span class="op" id="6058835">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6058838">&#34;abcdefghijklmnopqrstuvwxyz&#34;</span>&nbsp;<span class="op" id="6058867">+</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6058870">&#34;0123456789&#34;</span>&nbsp;<span class="op" id="6058883">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6058886">&#34;!#$%&amp;&#39;*+-/=?^_`{|}~&#34;</span><span class="op" id="6058907">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6058910">//&nbsp;isAtext&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;atext&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="6058971">//&nbsp;If&nbsp;dot&nbsp;is&nbsp;true,&nbsp;period&nbsp;is&nbsp;included.</span><br>
<span class="lineno">530</span><span class="keyword" id="6059010">func</span>&nbsp;<span class="ident" id="6059015">isAtext</span><span class="op" id="6059022">(</span><span class="ident" id="6059023">c</span>&nbsp;<span class="builtintype" id="6059025">byte</span><span class="op" id="6059029">,</span>&nbsp;<span class="ident" id="6059031">dot</span>&nbsp;<span class="builtintype" id="6059035">bool</span><span class="op" id="6059039">)</span>&nbsp;<span class="builtintype" id="6059041">bool</span>&nbsp;<span class="op" id="6059046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059049">if</span>&nbsp;<span class="ident" id="6059052">dot</span>&nbsp;<span class="op" id="6059056">&amp;&amp;</span>&nbsp;<span class="ident" id="6059059">c</span>&nbsp;<span class="op" id="6059061">==</span>&nbsp;<span class="string" id="6059064">&#39;.&#39;</span>&nbsp;<span class="op" id="6059068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059072">return</span>&nbsp;<span class="builtintype" id="6059079">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6059085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059088">return</span>&nbsp;<span class="ident" id="6059095">bytes</span><span class="op" id="6059100">.</span><span class="ident" id="6059101">IndexByte</span><span class="op" id="6059110">(</span><span class="ident" id="6059111">atextChars</span><span class="op" id="6059121">,</span>&nbsp;<span class="ident" id="6059123">c</span><span class="op" id="6059124">)</span>&nbsp;<span class="op" id="6059126">&gt;=</span>&nbsp;<span class="num" id="6059129">0</span><br>
<span class="lineno">535</span><span class="op" id="6059131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6059134">//&nbsp;isQtext&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;qtext&nbsp;character.</span><br>
<span class="lineno"></span><span class="keyword" id="6059195">func</span>&nbsp;<span class="ident" id="6059200">isQtext</span><span class="op" id="6059207">(</span><span class="ident" id="6059208">c</span>&nbsp;<span class="builtintype" id="6059210">byte</span><span class="op" id="6059214">)</span>&nbsp;<span class="builtintype" id="6059216">bool</span>&nbsp;<span class="op" id="6059221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6059224">//&nbsp;Printable&nbsp;US-ASCII,&nbsp;excluding&nbsp;backslash&nbsp;or&nbsp;quote.</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059278">if</span>&nbsp;<span class="ident" id="6059281">c</span>&nbsp;<span class="op" id="6059283">==</span>&nbsp;<span class="string" id="6059286">&#39;\\&#39;</span>&nbsp;<span class="op" id="6059291">||</span>&nbsp;<span class="ident" id="6059294">c</span>&nbsp;<span class="op" id="6059296">==</span>&nbsp;<span class="string" id="6059299">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="6059303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059307">return</span>&nbsp;<span class="builtintype" id="6059314">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6059321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059324">return</span>&nbsp;<span class="string" id="6059331">&#39;!&#39;</span>&nbsp;<span class="op" id="6059335">&lt;=</span>&nbsp;<span class="ident" id="6059338">c</span>&nbsp;<span class="op" id="6059340">&amp;&amp;</span>&nbsp;<span class="ident" id="6059343">c</span>&nbsp;<span class="op" id="6059345">&lt;=</span>&nbsp;<span class="string" id="6059348">&#39;~&#39;</span><br>
<span class="lineno"></span><span class="op" id="6059352">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="comment" id="6059355">//&nbsp;isVchar&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;VCHAR&nbsp;character.</span><br>
<span class="lineno"></span><span class="keyword" id="6059416">func</span>&nbsp;<span class="ident" id="6059421">isVchar</span><span class="op" id="6059428">(</span><span class="ident" id="6059429">c</span>&nbsp;<span class="builtintype" id="6059431">byte</span><span class="op" id="6059435">)</span>&nbsp;<span class="builtintype" id="6059437">bool</span>&nbsp;<span class="op" id="6059442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6059445">//&nbsp;Visible&nbsp;(printing)&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059480">return</span>&nbsp;<span class="string" id="6059487">&#39;!&#39;</span>&nbsp;<span class="op" id="6059491">&lt;=</span>&nbsp;<span class="ident" id="6059494">c</span>&nbsp;<span class="op" id="6059496">&amp;&amp;</span>&nbsp;<span class="ident" id="6059499">c</span>&nbsp;<span class="op" id="6059501">&lt;=</span>&nbsp;<span class="string" id="6059504">&#39;~&#39;</span><br>
<span class="lineno">550</span><span class="op" id="6059508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6059511">//&nbsp;isWSP&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;a&nbsp;WSP&nbsp;(white&nbsp;space).</span><br>
<span class="lineno"></span><span class="comment" id="6059562">//&nbsp;WSP&nbsp;is&nbsp;a&nbsp;space&nbsp;or&nbsp;horizontal&nbsp;tab&nbsp;(RFC5234&nbsp;Appendix&nbsp;B).</span><br>
<span class="lineno"></span><span class="keyword" id="6059620">func</span>&nbsp;<span class="ident" id="6059625">isWSP</span><span class="op" id="6059630">(</span><span class="ident" id="6059631">c</span>&nbsp;<span class="builtintype" id="6059633">byte</span><span class="op" id="6059637">)</span>&nbsp;<span class="builtintype" id="6059639">bool</span>&nbsp;<span class="op" id="6059644">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6059647">return</span>&nbsp;<span class="ident" id="6059654">c</span>&nbsp;<span class="op" id="6059656">==</span>&nbsp;<span class="string" id="6059659">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="6059663">||</span>&nbsp;<span class="ident" id="6059666">c</span>&nbsp;<span class="op" id="6059668">==</span>&nbsp;<span class="string" id="6059671">&#39;\t&#39;</span><br>
<span class="lineno"></span><span class="op" id="6059676">}</span>
</div>
</body>
</html>
