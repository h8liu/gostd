<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6414804">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6414859">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6414913">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6414964">//&nbsp;HTTP&nbsp;reverse&nbsp;proxy&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6414995">package</span>&nbsp;<span class="ident" id="6415003">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6415013">import</span>&nbsp;<span class="op" id="6415020">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6415023">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6415029">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6415036">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6415043">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6415055">&#34;net/url&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6415066">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6415077">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6415085">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6415092">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="6415095">//&nbsp;onExitFlushLoop&nbsp;is&nbsp;a&nbsp;callback&nbsp;set&nbsp;by&nbsp;tests&nbsp;to&nbsp;detect&nbsp;the&nbsp;state&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6415168">//&nbsp;flushLoop()&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="6415194">var</span>&nbsp;<span class="ident" id="6415198">onExitFlushLoop</span>&nbsp;<span class="keyword" id="6415214">func</span><span class="op" id="6415218">(</span><span class="op" id="6415219">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6415222">//&nbsp;ReverseProxy&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;that&nbsp;takes&nbsp;an&nbsp;incoming&nbsp;request&nbsp;and</span><br>
<span class="lineno">25</span><span class="comment" id="6415292">//&nbsp;sends&nbsp;it&nbsp;to&nbsp;another&nbsp;server,&nbsp;proxying&nbsp;the&nbsp;response&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6415357">//&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="6415368">type</span>&nbsp;<span class="ident" id="6415373">ReverseProxy</span>&nbsp;<span class="keyword" id="6415386">struct</span>&nbsp;<span class="op" id="6415393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6415396">//&nbsp;Director&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;which&nbsp;modifies</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6415443">//&nbsp;the&nbsp;request&nbsp;into&nbsp;a&nbsp;new&nbsp;request&nbsp;to&nbsp;be&nbsp;sent</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6415489">//&nbsp;using&nbsp;Transport.&nbsp;Its&nbsp;response&nbsp;is&nbsp;then&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6415538">//&nbsp;back&nbsp;to&nbsp;the&nbsp;original&nbsp;client&nbsp;unmodified.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6415582">Director</span>&nbsp;<span class="keyword" id="6415591">func</span><span class="op" id="6415595">(</span><span class="op" id="6415596">*</span><span class="ident" id="6415597">http</span><span class="op" id="6415601">.</span><span class="ident" id="6415602">Request</span><span class="op" id="6415609">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6415613">//&nbsp;The&nbsp;transport&nbsp;used&nbsp;to&nbsp;perform&nbsp;proxy&nbsp;requests.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6415663">//&nbsp;If&nbsp;nil,&nbsp;http.DefaultTransport&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6415706">Transport</span>&nbsp;<span class="ident" id="6415716">http</span><span class="op" id="6415720">.</span><span class="ident" id="6415721">RoundTripper</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6415736">//&nbsp;FlushInterval&nbsp;specifies&nbsp;the&nbsp;flush&nbsp;interval</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6415783">//&nbsp;to&nbsp;flush&nbsp;to&nbsp;the&nbsp;client&nbsp;while&nbsp;copying&nbsp;the</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6415828">//&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6415847">//&nbsp;If&nbsp;zero,&nbsp;no&nbsp;periodic&nbsp;flushing&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6415890">FlushInterval</span>&nbsp;<span class="ident" id="6415904">time</span><span class="op" id="6415908">.</span><span class="ident" id="6415909">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6415920">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6415973">//&nbsp;that&nbsp;occur&nbsp;when&nbsp;attempting&nbsp;to&nbsp;proxy&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6416026">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6416086">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6416107">ErrorLog</span>&nbsp;<span class="op" id="6416116">*</span><span class="ident" id="6416117">log</span><span class="op" id="6416120">.</span><span class="ident" id="6416121">Logger</span><br>
<span class="lineno"></span><span class="op" id="6416128">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="6416131">func</span>&nbsp;<span class="ident" id="6416136">singleJoiningSlash</span><span class="op" id="6416154">(</span><span class="ident" id="6416155">a</span><span class="op" id="6416156">,</span>&nbsp;<span class="ident" id="6416158">b</span>&nbsp;<span class="builtintype" id="6416160">string</span><span class="op" id="6416166">)</span>&nbsp;<span class="builtintype" id="6416168">string</span>&nbsp;<span class="op" id="6416175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6416178">aslash</span>&nbsp;<span class="op" id="6416185">:=</span>&nbsp;<span class="ident" id="6416188">strings</span><span class="op" id="6416195">.</span><span class="ident" id="6416196">HasSuffix</span><span class="op" id="6416205">(</span><span class="ident" id="6416206">a</span><span class="op" id="6416207">,</span>&nbsp;<span class="string" id="6416209">&#34;/&#34;</span><span class="op" id="6416212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6416215">bslash</span>&nbsp;<span class="op" id="6416222">:=</span>&nbsp;<span class="ident" id="6416225">strings</span><span class="op" id="6416232">.</span><span class="ident" id="6416233">HasPrefix</span><span class="op" id="6416242">(</span><span class="ident" id="6416243">b</span><span class="op" id="6416244">,</span>&nbsp;<span class="string" id="6416246">&#34;/&#34;</span><span class="op" id="6416249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6416252">switch</span>&nbsp;<span class="op" id="6416259">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6416262">case</span>&nbsp;<span class="ident" id="6416267">aslash</span>&nbsp;<span class="op" id="6416274">&amp;&amp;</span>&nbsp;<span class="ident" id="6416277">bslash</span><span class="op" id="6416283">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6416287">return</span>&nbsp;<span class="ident" id="6416294">a</span>&nbsp;<span class="op" id="6416296">+</span>&nbsp;<span class="ident" id="6416298">b</span><span class="op" id="6416299">[</span><span class="num" id="6416300">1</span><span class="op" id="6416301">:</span><span class="op" id="6416302">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6416305">case</span>&nbsp;<span class="op" id="6416310">!</span><span class="ident" id="6416311">aslash</span>&nbsp;<span class="op" id="6416318">&amp;&amp;</span>&nbsp;<span class="op" id="6416321">!</span><span class="ident" id="6416322">bslash</span><span class="op" id="6416328">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6416332">return</span>&nbsp;<span class="ident" id="6416339">a</span>&nbsp;<span class="op" id="6416341">+</span>&nbsp;<span class="string" id="6416343">&#34;/&#34;</span>&nbsp;<span class="op" id="6416347">+</span>&nbsp;<span class="ident" id="6416349">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6416352">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6416355">return</span>&nbsp;<span class="ident" id="6416362">a</span>&nbsp;<span class="op" id="6416364">+</span>&nbsp;<span class="ident" id="6416366">b</span><br>
<span class="lineno"></span><span class="op" id="6416368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6416371">//&nbsp;NewSingleHostReverseProxy&nbsp;returns&nbsp;a&nbsp;new&nbsp;ReverseProxy&nbsp;that&nbsp;rewrites</span><br>
<span class="lineno"></span><span class="comment" id="6416441">//&nbsp;URLs&nbsp;to&nbsp;the&nbsp;scheme,&nbsp;host,&nbsp;and&nbsp;base&nbsp;path&nbsp;provided&nbsp;in&nbsp;target.&nbsp;If&nbsp;the</span><br>
<span class="lineno">65</span><span class="comment" id="6416511">//&nbsp;target&#39;s&nbsp;path&nbsp;is&nbsp;&#34;/base&#34;&nbsp;and&nbsp;the&nbsp;incoming&nbsp;request&nbsp;was&nbsp;for&nbsp;&#34;/dir&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="6416580">//&nbsp;the&nbsp;target&nbsp;request&nbsp;will&nbsp;be&nbsp;for&nbsp;/base/dir.</span><br>
<span class="lineno"></span><span class="keyword" id="6416625">func</span>&nbsp;<span class="ident" id="6416630">NewSingleHostReverseProxy</span><span class="op" id="6416655">(</span><span class="ident" id="6416656">target</span>&nbsp;<span class="op" id="6416663">*</span><span class="ident" id="6416664">url</span><span class="op" id="6416667">.</span><span class="ident" id="6416668">URL</span><span class="op" id="6416671">)</span>&nbsp;<span class="op" id="6416673">*</span><span class="ident" id="6416674">ReverseProxy</span>&nbsp;<span class="op" id="6416687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6416690">targetQuery</span>&nbsp;<span class="op" id="6416702">:=</span>&nbsp;<span class="ident" id="6416705">target</span><span class="op" id="6416711">.</span><span class="ident" id="6416712">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6416722">director</span>&nbsp;<span class="op" id="6416731">:=</span>&nbsp;<span class="keyword" id="6416734">func</span><span class="op" id="6416738">(</span><span class="ident" id="6416739">req</span>&nbsp;<span class="op" id="6416743">*</span><span class="ident" id="6416744">http</span><span class="op" id="6416748">.</span><span class="ident" id="6416749">Request</span><span class="op" id="6416756">)</span>&nbsp;<span class="op" id="6416758">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6416762">req</span><span class="op" id="6416765">.</span><span class="ident" id="6416766">URL</span><span class="op" id="6416769">.</span><span class="ident" id="6416770">Scheme</span>&nbsp;<span class="op" id="6416777">=</span>&nbsp;<span class="ident" id="6416779">target</span><span class="op" id="6416785">.</span><span class="ident" id="6416786">Scheme</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6416795">req</span><span class="op" id="6416798">.</span><span class="ident" id="6416799">URL</span><span class="op" id="6416802">.</span><span class="ident" id="6416803">Host</span>&nbsp;<span class="op" id="6416808">=</span>&nbsp;<span class="ident" id="6416810">target</span><span class="op" id="6416816">.</span><span class="ident" id="6416817">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6416824">req</span><span class="op" id="6416827">.</span><span class="ident" id="6416828">URL</span><span class="op" id="6416831">.</span><span class="ident" id="6416832">Path</span>&nbsp;<span class="op" id="6416837">=</span>&nbsp;<span class="ident" id="6416839">singleJoiningSlash</span><span class="op" id="6416857">(</span><span class="ident" id="6416858">target</span><span class="op" id="6416864">.</span><span class="ident" id="6416865">Path</span><span class="op" id="6416869">,</span>&nbsp;<span class="ident" id="6416871">req</span><span class="op" id="6416874">.</span><span class="ident" id="6416875">URL</span><span class="op" id="6416878">.</span><span class="ident" id="6416879">Path</span><span class="op" id="6416883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6416887">if</span>&nbsp;<span class="ident" id="6416890">targetQuery</span>&nbsp;<span class="op" id="6416902">==</span>&nbsp;<span class="string" id="6416905">&#34;&#34;</span>&nbsp;<span class="op" id="6416908">||</span>&nbsp;<span class="ident" id="6416911">req</span><span class="op" id="6416914">.</span><span class="ident" id="6416915">URL</span><span class="op" id="6416918">.</span><span class="ident" id="6416919">RawQuery</span>&nbsp;<span class="op" id="6416928">==</span>&nbsp;<span class="string" id="6416931">&#34;&#34;</span>&nbsp;<span class="op" id="6416934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6416939">req</span><span class="op" id="6416942">.</span><span class="ident" id="6416943">URL</span><span class="op" id="6416946">.</span><span class="ident" id="6416947">RawQuery</span>&nbsp;<span class="op" id="6416956">=</span>&nbsp;<span class="ident" id="6416958">targetQuery</span>&nbsp;<span class="op" id="6416970">+</span>&nbsp;<span class="ident" id="6416972">req</span><span class="op" id="6416975">.</span><span class="ident" id="6416976">URL</span><span class="op" id="6416979">.</span><span class="ident" id="6416980">RawQuery</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6416991">}</span>&nbsp;<span class="keyword" id="6416993">else</span>&nbsp;<span class="op" id="6416998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417003">req</span><span class="op" id="6417006">.</span><span class="ident" id="6417007">URL</span><span class="op" id="6417010">.</span><span class="ident" id="6417011">RawQuery</span>&nbsp;<span class="op" id="6417020">=</span>&nbsp;<span class="ident" id="6417022">targetQuery</span>&nbsp;<span class="op" id="6417034">+</span>&nbsp;<span class="string" id="6417036">&#34;&amp;&#34;</span>&nbsp;<span class="op" id="6417040">+</span>&nbsp;<span class="ident" id="6417042">req</span><span class="op" id="6417045">.</span><span class="ident" id="6417046">URL</span><span class="op" id="6417049">.</span><span class="ident" id="6417050">RawQuery</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6417061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6417064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6417067">return</span>&nbsp;<span class="op" id="6417074">&amp;</span><span class="ident" id="6417075">ReverseProxy</span><span class="op" id="6417087">{</span><span class="ident" id="6417088">Director</span><span class="op" id="6417096">:</span>&nbsp;<span class="ident" id="6417098">director</span><span class="op" id="6417106">}</span><br>
<span class="lineno">80</span><span class="op" id="6417108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6417111">func</span>&nbsp;<span class="ident" id="6417116">copyHeader</span><span class="op" id="6417126">(</span><span class="ident" id="6417127">dst</span><span class="op" id="6417130">,</span>&nbsp;<span class="ident" id="6417132">src</span>&nbsp;<span class="ident" id="6417136">http</span><span class="op" id="6417140">.</span><span class="ident" id="6417141">Header</span><span class="op" id="6417147">)</span>&nbsp;<span class="op" id="6417149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6417152">for</span>&nbsp;<span class="ident" id="6417156">k</span><span class="op" id="6417157">,</span>&nbsp;<span class="ident" id="6417159">vv</span>&nbsp;<span class="op" id="6417162">:=</span>&nbsp;<span class="keyword" id="6417165">range</span>&nbsp;<span class="ident" id="6417171">src</span>&nbsp;<span class="op" id="6417175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6417179">for</span>&nbsp;<span class="ident" id="6417183">_</span><span class="op" id="6417184">,</span>&nbsp;<span class="ident" id="6417186">v</span>&nbsp;<span class="op" id="6417188">:=</span>&nbsp;<span class="keyword" id="6417191">range</span>&nbsp;<span class="ident" id="6417197">vv</span>&nbsp;<span class="op" id="6417200">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417205">dst</span><span class="op" id="6417208">.</span><span class="ident" id="6417209">Add</span><span class="op" id="6417212">(</span><span class="ident" id="6417213">k</span><span class="op" id="6417214">,</span>&nbsp;<span class="ident" id="6417216">v</span><span class="op" id="6417217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6417221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6417224">}</span><br>
<span class="lineno"></span><span class="op" id="6417226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="6417229">//&nbsp;Hop-by-hop&nbsp;headers.&nbsp;These&nbsp;are&nbsp;removed&nbsp;when&nbsp;sent&nbsp;to&nbsp;the&nbsp;backend.</span><br>
<span class="lineno"></span><span class="comment" id="6417296">//&nbsp;http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html</span><br>
<span class="lineno"></span><span class="keyword" id="6417354">var</span>&nbsp;<span class="ident" id="6417358">hopHeaders</span>&nbsp;<span class="op" id="6417369">=</span>&nbsp;<span class="op" id="6417371">[</span><span class="op" id="6417372">]</span><span class="builtintype" id="6417373">string</span><span class="op" id="6417379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6417382">&#34;Connection&#34;</span><span class="op" id="6417394">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6417397">&#34;Keep-Alive&#34;</span><span class="op" id="6417409">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6417412">&#34;Proxy-Authenticate&#34;</span><span class="op" id="6417432">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6417435">&#34;Proxy-Authorization&#34;</span><span class="op" id="6417456">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6417459">&#34;Te&#34;</span><span class="op" id="6417463">,</span>&nbsp;<span class="comment" id="6417465">//&nbsp;canonicalized&nbsp;version&nbsp;of&nbsp;&#34;TE&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6417499">&#34;Trailers&#34;</span><span class="op" id="6417509">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6417512">&#34;Transfer-Encoding&#34;</span><span class="op" id="6417531">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6417534">&#34;Upgrade&#34;</span><span class="op" id="6417543">,</span><br>
<span class="lineno"></span><span class="op" id="6417545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6417548">func</span>&nbsp;<span class="op" id="6417553">(</span><span class="ident" id="6417554">p</span>&nbsp;<span class="op" id="6417556">*</span><span class="ident" id="6417557">ReverseProxy</span><span class="op" id="6417569">)</span>&nbsp;<span class="ident" id="6417571">ServeHTTP</span><span class="op" id="6417580">(</span><span class="ident" id="6417581">rw</span>&nbsp;<span class="ident" id="6417584">http</span><span class="op" id="6417588">.</span><span class="ident" id="6417589">ResponseWriter</span><span class="op" id="6417603">,</span>&nbsp;<span class="ident" id="6417605">req</span>&nbsp;<span class="op" id="6417609">*</span><span class="ident" id="6417610">http</span><span class="op" id="6417614">.</span><span class="ident" id="6417615">Request</span><span class="op" id="6417622">)</span>&nbsp;<span class="op" id="6417624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417627">transport</span>&nbsp;<span class="op" id="6417637">:=</span>&nbsp;<span class="ident" id="6417640">p</span><span class="op" id="6417641">.</span><span class="ident" id="6417642">Transport</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6417653">if</span>&nbsp;<span class="ident" id="6417656">transport</span>&nbsp;<span class="op" id="6417666">==</span>&nbsp;<span class="ident" id="6417669">nil</span>&nbsp;<span class="op" id="6417673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417677">transport</span>&nbsp;<span class="op" id="6417687">=</span>&nbsp;<span class="ident" id="6417689">http</span><span class="op" id="6417693">.</span><span class="ident" id="6417694">DefaultTransport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6417712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417716">outreq</span>&nbsp;<span class="op" id="6417723">:=</span>&nbsp;<span class="builtinfunc" id="6417726">new</span><span class="op" id="6417729">(</span><span class="ident" id="6417730">http</span><span class="op" id="6417734">.</span><span class="ident" id="6417735">Request</span><span class="op" id="6417742">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6417745">*</span><span class="ident" id="6417746">outreq</span>&nbsp;<span class="op" id="6417753">=</span>&nbsp;<span class="op" id="6417755">*</span><span class="ident" id="6417756">req</span>&nbsp;<span class="comment" id="6417760">//&nbsp;includes&nbsp;shallow&nbsp;copies&nbsp;of&nbsp;maps,&nbsp;but&nbsp;okay</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417807">p</span><span class="op" id="6417808">.</span><span class="ident" id="6417809">Director</span><span class="op" id="6417817">(</span><span class="ident" id="6417818">outreq</span><span class="op" id="6417824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417827">outreq</span><span class="op" id="6417833">.</span><span class="ident" id="6417834">Proto</span>&nbsp;<span class="op" id="6417840">=</span>&nbsp;<span class="string" id="6417842">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417854">outreq</span><span class="op" id="6417860">.</span><span class="ident" id="6417861">ProtoMajor</span>&nbsp;<span class="op" id="6417872">=</span>&nbsp;<span class="num" id="6417874">1</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417877">outreq</span><span class="op" id="6417883">.</span><span class="ident" id="6417884">ProtoMinor</span>&nbsp;<span class="op" id="6417895">=</span>&nbsp;<span class="num" id="6417897">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6417900">outreq</span><span class="op" id="6417906">.</span><span class="ident" id="6417907">Close</span>&nbsp;<span class="op" id="6417913">=</span>&nbsp;<span class="builtintype" id="6417915">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6417923">//&nbsp;Remove&nbsp;hop-by-hop&nbsp;headers&nbsp;to&nbsp;the&nbsp;backend.&nbsp;&nbsp;Especially</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6417981">//&nbsp;important&nbsp;is&nbsp;&#34;Connection&#34;&nbsp;because&nbsp;we&nbsp;want&nbsp;a&nbsp;persistent</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6418040">//&nbsp;connection,&nbsp;regardless&nbsp;of&nbsp;what&nbsp;the&nbsp;client&nbsp;sent&nbsp;to&nbsp;us.&nbsp;&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6418104">//&nbsp;is&nbsp;modifying&nbsp;the&nbsp;same&nbsp;underlying&nbsp;map&nbsp;from&nbsp;req&nbsp;(shallow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6418163">//&nbsp;copied&nbsp;above)&nbsp;so&nbsp;we&nbsp;only&nbsp;copy&nbsp;it&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418214">copiedHeaders</span>&nbsp;<span class="op" id="6418228">:=</span>&nbsp;<span class="builtintype" id="6418231">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6418238">for</span>&nbsp;<span class="ident" id="6418242">_</span><span class="op" id="6418243">,</span>&nbsp;<span class="ident" id="6418245">h</span>&nbsp;<span class="op" id="6418247">:=</span>&nbsp;<span class="keyword" id="6418250">range</span>&nbsp;<span class="ident" id="6418256">hopHeaders</span>&nbsp;<span class="op" id="6418267">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6418271">if</span>&nbsp;<span class="ident" id="6418274">outreq</span><span class="op" id="6418280">.</span><span class="ident" id="6418281">Header</span><span class="op" id="6418287">.</span><span class="ident" id="6418288">Get</span><span class="op" id="6418291">(</span><span class="ident" id="6418292">h</span><span class="op" id="6418293">)</span>&nbsp;<span class="op" id="6418295">!=</span>&nbsp;<span class="string" id="6418298">&#34;&#34;</span>&nbsp;<span class="op" id="6418301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6418306">if</span>&nbsp;<span class="op" id="6418309">!</span><span class="ident" id="6418310">copiedHeaders</span>&nbsp;<span class="op" id="6418324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418330">outreq</span><span class="op" id="6418336">.</span><span class="ident" id="6418337">Header</span>&nbsp;<span class="op" id="6418344">=</span>&nbsp;<span class="builtinfunc" id="6418346">make</span><span class="op" id="6418350">(</span><span class="ident" id="6418351">http</span><span class="op" id="6418355">.</span><span class="ident" id="6418356">Header</span><span class="op" id="6418362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418368">copyHeader</span><span class="op" id="6418378">(</span><span class="ident" id="6418379">outreq</span><span class="op" id="6418385">.</span><span class="ident" id="6418386">Header</span><span class="op" id="6418392">,</span>&nbsp;<span class="ident" id="6418394">req</span><span class="op" id="6418397">.</span><span class="ident" id="6418398">Header</span><span class="op" id="6418404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418410">copiedHeaders</span>&nbsp;<span class="op" id="6418424">=</span>&nbsp;<span class="builtintype" id="6418426">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6418434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418439">outreq</span><span class="op" id="6418445">.</span><span class="ident" id="6418446">Header</span><span class="op" id="6418452">.</span><span class="ident" id="6418453">Del</span><span class="op" id="6418456">(</span><span class="ident" id="6418457">h</span><span class="op" id="6418458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6418462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6418465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6418469">if</span>&nbsp;<span class="ident" id="6418472">clientIP</span><span class="op" id="6418480">,</span>&nbsp;<span class="ident" id="6418482">_</span><span class="op" id="6418483">,</span>&nbsp;<span class="ident" id="6418485">err</span>&nbsp;<span class="op" id="6418489">:=</span>&nbsp;<span class="ident" id="6418492">net</span><span class="op" id="6418495">.</span><span class="ident" id="6418496">SplitHostPort</span><span class="op" id="6418509">(</span><span class="ident" id="6418510">req</span><span class="op" id="6418513">.</span><span class="ident" id="6418514">RemoteAddr</span><span class="op" id="6418524">)</span><span class="op" id="6418525">;</span>&nbsp;<span class="ident" id="6418527">err</span>&nbsp;<span class="op" id="6418531">==</span>&nbsp;<span class="ident" id="6418534">nil</span>&nbsp;<span class="op" id="6418538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6418542">//&nbsp;If&nbsp;we&nbsp;aren&#39;t&nbsp;the&nbsp;first&nbsp;proxy&nbsp;retain&nbsp;prior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6418589">//&nbsp;X-Forwarded-For&nbsp;information&nbsp;as&nbsp;a&nbsp;comma+space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6418639">//&nbsp;separated&nbsp;list&nbsp;and&nbsp;fold&nbsp;multiple&nbsp;headers&nbsp;into&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6418695">if</span>&nbsp;<span class="ident" id="6418698">prior</span><span class="op" id="6418703">,</span>&nbsp;<span class="ident" id="6418705">ok</span>&nbsp;<span class="op" id="6418708">:=</span>&nbsp;<span class="ident" id="6418711">outreq</span><span class="op" id="6418717">.</span><span class="ident" id="6418718">Header</span><span class="op" id="6418724">[</span><span class="string" id="6418725">&#34;X-Forwarded-For&#34;</span><span class="op" id="6418742">]</span><span class="op" id="6418743">;</span>&nbsp;<span class="ident" id="6418745">ok</span>&nbsp;<span class="op" id="6418748">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418753">clientIP</span>&nbsp;<span class="op" id="6418762">=</span>&nbsp;<span class="ident" id="6418764">strings</span><span class="op" id="6418771">.</span><span class="ident" id="6418772">Join</span><span class="op" id="6418776">(</span><span class="ident" id="6418777">prior</span><span class="op" id="6418782">,</span>&nbsp;<span class="string" id="6418784">&#34;,&nbsp;&#34;</span><span class="op" id="6418788">)</span>&nbsp;<span class="op" id="6418790">+</span>&nbsp;<span class="string" id="6418792">&#34;,&nbsp;&#34;</span>&nbsp;<span class="op" id="6418797">+</span>&nbsp;<span class="ident" id="6418799">clientIP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6418810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418814">outreq</span><span class="op" id="6418820">.</span><span class="ident" id="6418821">Header</span><span class="op" id="6418827">.</span><span class="ident" id="6418828">Set</span><span class="op" id="6418831">(</span><span class="string" id="6418832">&#34;X-Forwarded-For&#34;</span><span class="op" id="6418849">,</span>&nbsp;<span class="ident" id="6418851">clientIP</span><span class="op" id="6418859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6418862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418866">res</span><span class="op" id="6418869">,</span>&nbsp;<span class="ident" id="6418871">err</span>&nbsp;<span class="op" id="6418875">:=</span>&nbsp;<span class="ident" id="6418878">transport</span><span class="op" id="6418887">.</span><span class="ident" id="6418888">RoundTrip</span><span class="op" id="6418897">(</span><span class="ident" id="6418898">outreq</span><span class="op" id="6418904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6418907">if</span>&nbsp;<span class="ident" id="6418910">err</span>&nbsp;<span class="op" id="6418914">!=</span>&nbsp;<span class="ident" id="6418917">nil</span>&nbsp;<span class="op" id="6418921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418925">p</span><span class="op" id="6418926">.</span><span class="ident" id="6418927">logf</span><span class="op" id="6418931">(</span><span class="string" id="6418932">&#34;http:&nbsp;proxy&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6418955">,</span>&nbsp;<span class="ident" id="6418957">err</span><span class="op" id="6418960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6418964">rw</span><span class="op" id="6418966">.</span><span class="ident" id="6418967">WriteHeader</span><span class="op" id="6418978">(</span><span class="ident" id="6418979">http</span><span class="op" id="6418983">.</span><span class="ident" id="6418984">StatusInternalServerError</span><span class="op" id="6419009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6419013">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6419021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6419024">defer</span>&nbsp;<span class="ident" id="6419030">res</span><span class="op" id="6419033">.</span><span class="ident" id="6419034">Body</span><span class="op" id="6419038">.</span><span class="ident" id="6419039">Close</span><span class="op" id="6419044">(</span><span class="op" id="6419045">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6419049">for</span>&nbsp;<span class="ident" id="6419053">_</span><span class="op" id="6419054">,</span>&nbsp;<span class="ident" id="6419056">h</span>&nbsp;<span class="op" id="6419058">:=</span>&nbsp;<span class="keyword" id="6419061">range</span>&nbsp;<span class="ident" id="6419067">hopHeaders</span>&nbsp;<span class="op" id="6419078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419082">res</span><span class="op" id="6419085">.</span><span class="ident" id="6419086">Header</span><span class="op" id="6419092">.</span><span class="ident" id="6419093">Del</span><span class="op" id="6419096">(</span><span class="ident" id="6419097">h</span><span class="op" id="6419098">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6419101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419105">copyHeader</span><span class="op" id="6419115">(</span><span class="ident" id="6419116">rw</span><span class="op" id="6419118">.</span><span class="ident" id="6419119">Header</span><span class="op" id="6419125">(</span><span class="op" id="6419126">)</span><span class="op" id="6419127">,</span>&nbsp;<span class="ident" id="6419129">res</span><span class="op" id="6419132">.</span><span class="ident" id="6419133">Header</span><span class="op" id="6419139">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419143">rw</span><span class="op" id="6419145">.</span><span class="ident" id="6419146">WriteHeader</span><span class="op" id="6419157">(</span><span class="ident" id="6419158">res</span><span class="op" id="6419161">.</span><span class="ident" id="6419162">StatusCode</span><span class="op" id="6419172">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419175">p</span><span class="op" id="6419176">.</span><span class="ident" id="6419177">copyResponse</span><span class="op" id="6419189">(</span><span class="ident" id="6419190">rw</span><span class="op" id="6419192">,</span>&nbsp;<span class="ident" id="6419194">res</span><span class="op" id="6419197">.</span><span class="ident" id="6419198">Body</span><span class="op" id="6419202">)</span><br>
<span class="lineno"></span><span class="op" id="6419204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6419207">func</span>&nbsp;<span class="op" id="6419212">(</span><span class="ident" id="6419213">p</span>&nbsp;<span class="op" id="6419215">*</span><span class="ident" id="6419216">ReverseProxy</span><span class="op" id="6419228">)</span>&nbsp;<span class="ident" id="6419230">copyResponse</span><span class="op" id="6419242">(</span><span class="ident" id="6419243">dst</span>&nbsp;<span class="ident" id="6419247">io</span><span class="op" id="6419249">.</span><span class="ident" id="6419250">Writer</span><span class="op" id="6419256">,</span>&nbsp;<span class="ident" id="6419258">src</span>&nbsp;<span class="ident" id="6419262">io</span><span class="op" id="6419264">.</span><span class="ident" id="6419265">Reader</span><span class="op" id="6419271">)</span>&nbsp;<span class="op" id="6419273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6419276">if</span>&nbsp;<span class="ident" id="6419279">p</span><span class="op" id="6419280">.</span><span class="ident" id="6419281">FlushInterval</span>&nbsp;<span class="op" id="6419295">!=</span>&nbsp;<span class="num" id="6419298">0</span>&nbsp;<span class="op" id="6419300">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6419304">if</span>&nbsp;<span class="ident" id="6419307">wf</span><span class="op" id="6419309">,</span>&nbsp;<span class="ident" id="6419311">ok</span>&nbsp;<span class="op" id="6419314">:=</span>&nbsp;<span class="ident" id="6419317">dst</span><span class="op" id="6419320">.</span><span class="op" id="6419321">(</span><span class="ident" id="6419322">writeFlusher</span><span class="op" id="6419334">)</span><span class="op" id="6419335">;</span>&nbsp;<span class="ident" id="6419337">ok</span>&nbsp;<span class="op" id="6419340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419345">mlw</span>&nbsp;<span class="op" id="6419349">:=</span>&nbsp;<span class="op" id="6419352">&amp;</span><span class="ident" id="6419353">maxLatencyWriter</span><span class="op" id="6419369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419375">dst</span><span class="op" id="6419378">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6419384">wf</span><span class="op" id="6419386">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419392">latency</span><span class="op" id="6419399">:</span>&nbsp;<span class="ident" id="6419401">p</span><span class="op" id="6419402">.</span><span class="ident" id="6419403">FlushInterval</span><span class="op" id="6419416">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419422">done</span><span class="op" id="6419426">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6419431">make</span><span class="op" id="6419435">(</span><span class="keyword" id="6419436">chan</span>&nbsp;<span class="builtintype" id="6419441">bool</span><span class="op" id="6419445">)</span><span class="op" id="6419446">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6419451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6419456">go</span>&nbsp;<span class="ident" id="6419459">mlw</span><span class="op" id="6419462">.</span><span class="ident" id="6419463">flushLoop</span><span class="op" id="6419472">(</span><span class="op" id="6419473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6419478">defer</span>&nbsp;<span class="ident" id="6419484">mlw</span><span class="op" id="6419487">.</span><span class="ident" id="6419488">stop</span><span class="op" id="6419492">(</span><span class="op" id="6419493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419498">dst</span>&nbsp;<span class="op" id="6419502">=</span>&nbsp;<span class="ident" id="6419504">mlw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6419510">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6419513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419517">io</span><span class="op" id="6419519">.</span><span class="ident" id="6419520">Copy</span><span class="op" id="6419524">(</span><span class="ident" id="6419525">dst</span><span class="op" id="6419528">,</span>&nbsp;<span class="ident" id="6419530">src</span><span class="op" id="6419533">)</span><br>
<span class="lineno"></span><span class="op" id="6419535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="6419538">func</span>&nbsp;<span class="op" id="6419543">(</span><span class="ident" id="6419544">p</span>&nbsp;<span class="op" id="6419546">*</span><span class="ident" id="6419547">ReverseProxy</span><span class="op" id="6419559">)</span>&nbsp;<span class="ident" id="6419561">logf</span><span class="op" id="6419565">(</span><span class="ident" id="6419566">format</span>&nbsp;<span class="builtintype" id="6419573">string</span><span class="op" id="6419579">,</span>&nbsp;<span class="ident" id="6419581">args</span>&nbsp;<span class="op" id="6419586">...</span><span class="keyword" id="6419589">interface</span><span class="op" id="6419598">{</span><span class="op" id="6419599">}</span><span class="op" id="6419600">)</span>&nbsp;<span class="op" id="6419602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6419605">if</span>&nbsp;<span class="ident" id="6419608">p</span><span class="op" id="6419609">.</span><span class="ident" id="6419610">ErrorLog</span>&nbsp;<span class="op" id="6419619">!=</span>&nbsp;<span class="ident" id="6419622">nil</span>&nbsp;<span class="op" id="6419626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419630">p</span><span class="op" id="6419631">.</span><span class="ident" id="6419632">ErrorLog</span><span class="op" id="6419640">.</span><span class="ident" id="6419641">Printf</span><span class="op" id="6419647">(</span><span class="ident" id="6419648">format</span><span class="op" id="6419654">,</span>&nbsp;<span class="ident" id="6419656">args</span><span class="op" id="6419660">...</span><span class="op" id="6419663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6419666">}</span>&nbsp;<span class="keyword" id="6419668">else</span>&nbsp;<span class="op" id="6419673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419677">log</span><span class="op" id="6419680">.</span><span class="ident" id="6419681">Printf</span><span class="op" id="6419687">(</span><span class="ident" id="6419688">format</span><span class="op" id="6419694">,</span>&nbsp;<span class="ident" id="6419696">args</span><span class="op" id="6419700">...</span><span class="op" id="6419703">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6419706">}</span><br>
<span class="lineno"></span><span class="op" id="6419708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6419711">type</span>&nbsp;<span class="ident" id="6419716">writeFlusher</span>&nbsp;<span class="keyword" id="6419729">interface</span>&nbsp;<span class="op" id="6419739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419742">io</span><span class="op" id="6419744">.</span><span class="ident" id="6419745">Writer</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419753">http</span><span class="op" id="6419757">.</span><span class="ident" id="6419758">Flusher</span><br>
<span class="lineno"></span><span class="op" id="6419766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6419769">type</span>&nbsp;<span class="ident" id="6419774">maxLatencyWriter</span>&nbsp;<span class="keyword" id="6419791">struct</span>&nbsp;<span class="op" id="6419798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419801">dst</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6419809">writeFlusher</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419823">latency</span>&nbsp;<span class="ident" id="6419831">time</span><span class="op" id="6419835">.</span><span class="ident" id="6419836">Duration</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419847">lk</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6419852">sync</span><span class="op" id="6419856">.</span><span class="ident" id="6419857">Mutex</span>&nbsp;<span class="comment" id="6419863">//&nbsp;protects&nbsp;Write&nbsp;+&nbsp;Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419890">done</span>&nbsp;<span class="keyword" id="6419895">chan</span>&nbsp;<span class="builtintype" id="6419900">bool</span><br>
<span class="lineno"></span><span class="op" id="6419905">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="6419908">func</span>&nbsp;<span class="op" id="6419913">(</span><span class="ident" id="6419914">m</span>&nbsp;<span class="op" id="6419916">*</span><span class="ident" id="6419917">maxLatencyWriter</span><span class="op" id="6419933">)</span>&nbsp;<span class="ident" id="6419935">Write</span><span class="op" id="6419940">(</span><span class="ident" id="6419941">p</span>&nbsp;<span class="op" id="6419943">[</span><span class="op" id="6419944">]</span><span class="builtintype" id="6419945">byte</span><span class="op" id="6419949">)</span>&nbsp;<span class="op" id="6419951">(</span><span class="builtintype" id="6419952">int</span><span class="op" id="6419955">,</span>&nbsp;<span class="builtintype" id="6419957">error</span><span class="op" id="6419962">)</span>&nbsp;<span class="op" id="6419964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6419967">m</span><span class="op" id="6419968">.</span><span class="ident" id="6419969">lk</span><span class="op" id="6419971">.</span><span class="ident" id="6419972">Lock</span><span class="op" id="6419976">(</span><span class="op" id="6419977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6419980">defer</span>&nbsp;<span class="ident" id="6419986">m</span><span class="op" id="6419987">.</span><span class="ident" id="6419988">lk</span><span class="op" id="6419990">.</span><span class="ident" id="6419991">Unlock</span><span class="op" id="6419997">(</span><span class="op" id="6419998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6420001">return</span>&nbsp;<span class="ident" id="6420008">m</span><span class="op" id="6420009">.</span><span class="ident" id="6420010">dst</span><span class="op" id="6420013">.</span><span class="ident" id="6420014">Write</span><span class="op" id="6420019">(</span><span class="ident" id="6420020">p</span><span class="op" id="6420021">)</span><br>
<span class="lineno">205</span><span class="op" id="6420023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6420026">func</span>&nbsp;<span class="op" id="6420031">(</span><span class="ident" id="6420032">m</span>&nbsp;<span class="op" id="6420034">*</span><span class="ident" id="6420035">maxLatencyWriter</span><span class="op" id="6420051">)</span>&nbsp;<span class="ident" id="6420053">flushLoop</span><span class="op" id="6420062">(</span><span class="op" id="6420063">)</span>&nbsp;<span class="op" id="6420065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420068">t</span>&nbsp;<span class="op" id="6420070">:=</span>&nbsp;<span class="ident" id="6420073">time</span><span class="op" id="6420077">.</span><span class="ident" id="6420078">NewTicker</span><span class="op" id="6420087">(</span><span class="ident" id="6420088">m</span><span class="op" id="6420089">.</span><span class="ident" id="6420090">latency</span><span class="op" id="6420097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6420100">defer</span>&nbsp;<span class="ident" id="6420106">t</span><span class="op" id="6420107">.</span><span class="ident" id="6420108">Stop</span><span class="op" id="6420112">(</span><span class="op" id="6420113">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6420116">for</span>&nbsp;<span class="op" id="6420120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6420124">select</span>&nbsp;<span class="op" id="6420131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6420135">case</span>&nbsp;<span class="op" id="6420140">&lt;-</span><span class="ident" id="6420142">m</span><span class="op" id="6420143">.</span><span class="ident" id="6420144">done</span><span class="op" id="6420148">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6420153">if</span>&nbsp;<span class="ident" id="6420156">onExitFlushLoop</span>&nbsp;<span class="op" id="6420172">!=</span>&nbsp;<span class="ident" id="6420175">nil</span>&nbsp;<span class="op" id="6420179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420185">onExitFlushLoop</span><span class="op" id="6420200">(</span><span class="op" id="6420201">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6420206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6420211">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6420220">case</span>&nbsp;<span class="op" id="6420225">&lt;-</span><span class="ident" id="6420227">t</span><span class="op" id="6420228">.</span><span class="ident" id="6420229">C</span><span class="op" id="6420230">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420235">m</span><span class="op" id="6420236">.</span><span class="ident" id="6420237">lk</span><span class="op" id="6420239">.</span><span class="ident" id="6420240">Lock</span><span class="op" id="6420244">(</span><span class="op" id="6420245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420250">m</span><span class="op" id="6420251">.</span><span class="ident" id="6420252">dst</span><span class="op" id="6420255">.</span><span class="ident" id="6420256">Flush</span><span class="op" id="6420261">(</span><span class="op" id="6420262">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6420267">m</span><span class="op" id="6420268">.</span><span class="ident" id="6420269">lk</span><span class="op" id="6420271">.</span><span class="ident" id="6420272">Unlock</span><span class="op" id="6420278">(</span><span class="op" id="6420279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6420283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6420286">}</span><br>
<span class="lineno"></span><span class="op" id="6420288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="6420291">func</span>&nbsp;<span class="op" id="6420296">(</span><span class="ident" id="6420297">m</span>&nbsp;<span class="op" id="6420299">*</span><span class="ident" id="6420300">maxLatencyWriter</span><span class="op" id="6420316">)</span>&nbsp;<span class="ident" id="6420318">stop</span><span class="op" id="6420322">(</span><span class="op" id="6420323">)</span>&nbsp;<span class="op" id="6420325">{</span>&nbsp;<span class="ident" id="6420327">m</span><span class="op" id="6420328">.</span><span class="ident" id="6420329">done</span>&nbsp;<span class="op" id="6420334">&lt;-</span>&nbsp;<span class="builtintype" id="6420337">true</span>&nbsp;<span class="op" id="6420342">}</span>
</div>
</body>
</html>
