<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html" class="current">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4017602">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4017657">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4017711">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4017762">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4017827">//&nbsp;DNS&nbsp;client:&nbsp;see&nbsp;RFC&nbsp;1035.</span><br>
<span class="lineno"></span><span class="comment" id="4017856">//&nbsp;Has&nbsp;to&nbsp;be&nbsp;linked&nbsp;into&nbsp;package&nbsp;net&nbsp;for&nbsp;Dial.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="4017904">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span><span class="comment" id="4017918">//&nbsp;&nbsp;&nbsp;&nbspCould&nbsp;potentially&nbsp;handle&nbsp;many&nbsp;outstanding&nbsp;lookups&nbsp;faster.</span><br>
<span class="lineno"></span><span class="comment" id="4017979">//&nbsp;&nbsp;&nbsp;&nbspCould&nbsp;have&nbsp;a&nbsp;small&nbsp;cache.</span><br>
<span class="lineno"></span><span class="comment" id="4018008">//&nbsp;&nbsp;&nbsp;&nbspRandom&nbsp;UDP&nbsp;source&nbsp;port&nbsp;(net.Dial&nbsp;should&nbsp;do&nbsp;that&nbsp;for&nbsp;us).</span><br>
<span class="lineno"></span><span class="comment" id="4018068">//&nbsp;&nbsp;&nbsp;&nbspRandom&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="4018092">package</span>&nbsp;<span class="ident" id="4018100">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4018105">import</span>&nbsp;<span class="op" id="4018112">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4018115">&#34;errors&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4018125">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4018131">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4018144">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4018150">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4018158">&#34;time&#34;</span><br>
<span class="lineno">25</span><span class="op" id="4018165">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4018168">//&nbsp;A&nbsp;dnsConn&nbsp;represents&nbsp;a&nbsp;DNS&nbsp;transport&nbsp;endpoint.</span><br>
<span class="lineno"></span><span class="keyword" id="4018218">type</span>&nbsp;<span class="ident" id="4018223">dnsConn</span>&nbsp;<span class="keyword" id="4018231">interface</span>&nbsp;<span class="op" id="4018241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4018244">Conn</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4018251">//&nbsp;readDNSResponse&nbsp;reads&nbsp;a&nbsp;DNS&nbsp;response&nbsp;message&nbsp;from&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4018313">//&nbsp;transport&nbsp;endpoint&nbsp;and&nbsp;returns&nbsp;the&nbsp;received&nbsp;DNS&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4018374">//&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4018387">readDNSResponse</span><span class="op" id="4018402">(</span><span class="op" id="4018403">)</span>&nbsp;<span class="op" id="4018405">(</span><span class="op" id="4018406">*</span><span class="ident" id="4018407">dnsMsg</span><span class="op" id="4018413">,</span>&nbsp;<span class="builtintype" id="4018415">error</span><span class="op" id="4018420">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4018424">//&nbsp;writeDNSQuery&nbsp;writes&nbsp;a&nbsp;DNS&nbsp;query&nbsp;message&nbsp;to&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4018480">//&nbsp;connection&nbsp;endpoint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4018505">writeDNSQuery</span><span class="op" id="4018518">(</span><span class="op" id="4018519">*</span><span class="ident" id="4018520">dnsMsg</span><span class="op" id="4018526">)</span>&nbsp;<span class="builtintype" id="4018528">error</span><br>
<span class="lineno"></span><span class="op" id="4018534">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="4018537">func</span>&nbsp;<span class="op" id="4018542">(</span><span class="ident" id="4018543">c</span>&nbsp;<span class="op" id="4018545">*</span><span class="ident" id="4018546">UDPConn</span><span class="op" id="4018553">)</span>&nbsp;<span class="ident" id="4018555">readDNSResponse</span><span class="op" id="4018570">(</span><span class="op" id="4018571">)</span>&nbsp;<span class="op" id="4018573">(</span><span class="op" id="4018574">*</span><span class="ident" id="4018575">dnsMsg</span><span class="op" id="4018581">,</span>&nbsp;<span class="builtintype" id="4018583">error</span><span class="op" id="4018588">)</span>&nbsp;<span class="op" id="4018590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4018593">b</span>&nbsp;<span class="op" id="4018595">:=</span>&nbsp;<span class="builtinfunc" id="4018598">make</span><span class="op" id="4018602">(</span><span class="op" id="4018603">[</span><span class="op" id="4018604">]</span><span class="builtintype" id="4018605">byte</span><span class="op" id="4018609">,</span>&nbsp;<span class="num" id="4018611">512</span><span class="op" id="4018614">)</span>&nbsp;<span class="comment" id="4018616">//&nbsp;see&nbsp;RFC&nbsp;1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4018633">n</span><span class="op" id="4018634">,</span>&nbsp;<span class="ident" id="4018636">err</span>&nbsp;<span class="op" id="4018640">:=</span>&nbsp;<span class="ident" id="4018643">c</span><span class="op" id="4018644">.</span><span class="ident" id="4018645">Read</span><span class="op" id="4018649">(</span><span class="ident" id="4018650">b</span><span class="op" id="4018651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4018654">if</span>&nbsp;<span class="ident" id="4018657">err</span>&nbsp;<span class="op" id="4018661">!=</span>&nbsp;<span class="ident" id="4018664">nil</span>&nbsp;<span class="op" id="4018668">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4018672">return</span>&nbsp;<span class="ident" id="4018679">nil</span><span class="op" id="4018682">,</span>&nbsp;<span class="ident" id="4018684">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4018689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4018692">msg</span>&nbsp;<span class="op" id="4018696">:=</span>&nbsp;<span class="op" id="4018699">&amp;</span><span class="ident" id="4018700">dnsMsg</span><span class="op" id="4018706">{</span><span class="op" id="4018707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4018710">if</span>&nbsp;<span class="op" id="4018713">!</span><span class="ident" id="4018714">msg</span><span class="op" id="4018717">.</span><span class="ident" id="4018718">Unpack</span><span class="op" id="4018724">(</span><span class="ident" id="4018725">b</span><span class="op" id="4018726">[</span><span class="op" id="4018727">:</span><span class="ident" id="4018728">n</span><span class="op" id="4018729">]</span><span class="op" id="4018730">)</span>&nbsp;<span class="op" id="4018732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4018736">return</span>&nbsp;<span class="ident" id="4018743">nil</span><span class="op" id="4018746">,</span>&nbsp;<span class="ident" id="4018748">errors</span><span class="op" id="4018754">.</span><span class="ident" id="4018755">New</span><span class="op" id="4018758">(</span><span class="string" id="4018759">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="4018789">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4018792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4018795">return</span>&nbsp;<span class="ident" id="4018802">msg</span><span class="op" id="4018805">,</span>&nbsp;<span class="ident" id="4018807">nil</span><br>
<span class="lineno"></span><span class="op" id="4018811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4018814">func</span>&nbsp;<span class="op" id="4018819">(</span><span class="ident" id="4018820">c</span>&nbsp;<span class="op" id="4018822">*</span><span class="ident" id="4018823">UDPConn</span><span class="op" id="4018830">)</span>&nbsp;<span class="ident" id="4018832">writeDNSQuery</span><span class="op" id="4018845">(</span><span class="ident" id="4018846">msg</span>&nbsp;<span class="op" id="4018850">*</span><span class="ident" id="4018851">dnsMsg</span><span class="op" id="4018857">)</span>&nbsp;<span class="builtintype" id="4018859">error</span>&nbsp;<span class="op" id="4018865">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4018868">b</span><span class="op" id="4018869">,</span>&nbsp;<span class="ident" id="4018871">ok</span>&nbsp;<span class="op" id="4018874">:=</span>&nbsp;<span class="ident" id="4018877">msg</span><span class="op" id="4018880">.</span><span class="ident" id="4018881">Pack</span><span class="op" id="4018885">(</span><span class="op" id="4018886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4018889">if</span>&nbsp;<span class="op" id="4018892">!</span><span class="ident" id="4018893">ok</span>&nbsp;<span class="op" id="4018896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4018900">return</span>&nbsp;<span class="ident" id="4018907">errors</span><span class="op" id="4018913">.</span><span class="ident" id="4018914">New</span><span class="op" id="4018917">(</span><span class="string" id="4018918">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="4018946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4018949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4018952">if</span>&nbsp;<span class="ident" id="4018955">_</span><span class="op" id="4018956">,</span>&nbsp;<span class="ident" id="4018958">err</span>&nbsp;<span class="op" id="4018962">:=</span>&nbsp;<span class="ident" id="4018965">c</span><span class="op" id="4018966">.</span><span class="ident" id="4018967">Write</span><span class="op" id="4018972">(</span><span class="ident" id="4018973">b</span><span class="op" id="4018974">)</span><span class="op" id="4018975">;</span>&nbsp;<span class="ident" id="4018977">err</span>&nbsp;<span class="op" id="4018981">!=</span>&nbsp;<span class="ident" id="4018984">nil</span>&nbsp;<span class="op" id="4018988">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4018992">return</span>&nbsp;<span class="ident" id="4018999">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4019004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4019007">return</span>&nbsp;<span class="ident" id="4019014">nil</span><br>
<span class="lineno"></span><span class="op" id="4019018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="4019021">func</span>&nbsp;<span class="op" id="4019026">(</span><span class="ident" id="4019027">c</span>&nbsp;<span class="op" id="4019029">*</span><span class="ident" id="4019030">TCPConn</span><span class="op" id="4019037">)</span>&nbsp;<span class="ident" id="4019039">readDNSResponse</span><span class="op" id="4019054">(</span><span class="op" id="4019055">)</span>&nbsp;<span class="op" id="4019057">(</span><span class="op" id="4019058">*</span><span class="ident" id="4019059">dnsMsg</span><span class="op" id="4019065">,</span>&nbsp;<span class="builtintype" id="4019067">error</span><span class="op" id="4019072">)</span>&nbsp;<span class="op" id="4019074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4019077">b</span>&nbsp;<span class="op" id="4019079">:=</span>&nbsp;<span class="builtinfunc" id="4019082">make</span><span class="op" id="4019086">(</span><span class="op" id="4019087">[</span><span class="op" id="4019088">]</span><span class="builtintype" id="4019089">byte</span><span class="op" id="4019093">,</span>&nbsp;<span class="num" id="4019095">1280</span><span class="op" id="4019099">)</span>&nbsp;<span class="comment" id="4019101">//&nbsp;1280&nbsp;is&nbsp;a&nbsp;reasonable&nbsp;initial&nbsp;size&nbsp;for&nbsp;IP&nbsp;over&nbsp;Ethernet,&nbsp;see&nbsp;RFC&nbsp;4035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4019174">if</span>&nbsp;<span class="ident" id="4019177">_</span><span class="op" id="4019178">,</span>&nbsp;<span class="ident" id="4019180">err</span>&nbsp;<span class="op" id="4019184">:=</span>&nbsp;<span class="ident" id="4019187">io</span><span class="op" id="4019189">.</span><span class="ident" id="4019190">ReadFull</span><span class="op" id="4019198">(</span><span class="ident" id="4019199">c</span><span class="op" id="4019200">,</span>&nbsp;<span class="ident" id="4019202">b</span><span class="op" id="4019203">[</span><span class="op" id="4019204">:</span><span class="num" id="4019205">2</span><span class="op" id="4019206">]</span><span class="op" id="4019207">)</span><span class="op" id="4019208">;</span>&nbsp;<span class="ident" id="4019210">err</span>&nbsp;<span class="op" id="4019214">!=</span>&nbsp;<span class="ident" id="4019217">nil</span>&nbsp;<span class="op" id="4019221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4019225">return</span>&nbsp;<span class="ident" id="4019232">nil</span><span class="op" id="4019235">,</span>&nbsp;<span class="ident" id="4019237">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4019242">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4019245">l</span>&nbsp;<span class="op" id="4019247">:=</span>&nbsp;<span class="builtintype" id="4019250">int</span><span class="op" id="4019253">(</span><span class="ident" id="4019254">b</span><span class="op" id="4019255">[</span><span class="num" id="4019256">0</span><span class="op" id="4019257">]</span><span class="op" id="4019258">)</span><span class="op" id="4019259">&lt;&lt;</span><span class="num" id="4019261">8</span>&nbsp;<span class="op" id="4019263">|</span>&nbsp;<span class="builtintype" id="4019265">int</span><span class="op" id="4019268">(</span><span class="ident" id="4019269">b</span><span class="op" id="4019270">[</span><span class="num" id="4019271">1</span><span class="op" id="4019272">]</span><span class="op" id="4019273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4019276">if</span>&nbsp;<span class="ident" id="4019279">l</span>&nbsp;<span class="op" id="4019281">&gt;</span>&nbsp;<span class="builtinfunc" id="4019283">len</span><span class="op" id="4019286">(</span><span class="ident" id="4019287">b</span><span class="op" id="4019288">)</span>&nbsp;<span class="op" id="4019290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4019294">b</span>&nbsp;<span class="op" id="4019296">=</span>&nbsp;<span class="builtinfunc" id="4019298">make</span><span class="op" id="4019302">(</span><span class="op" id="4019303">[</span><span class="op" id="4019304">]</span><span class="builtintype" id="4019305">byte</span><span class="op" id="4019309">,</span>&nbsp;<span class="ident" id="4019311">l</span><span class="op" id="4019312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4019315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4019318">n</span><span class="op" id="4019319">,</span>&nbsp;<span class="ident" id="4019321">err</span>&nbsp;<span class="op" id="4019325">:=</span>&nbsp;<span class="ident" id="4019328">io</span><span class="op" id="4019330">.</span><span class="ident" id="4019331">ReadFull</span><span class="op" id="4019339">(</span><span class="ident" id="4019340">c</span><span class="op" id="4019341">,</span>&nbsp;<span class="ident" id="4019343">b</span><span class="op" id="4019344">[</span><span class="op" id="4019345">:</span><span class="ident" id="4019346">l</span><span class="op" id="4019347">]</span><span class="op" id="4019348">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4019351">if</span>&nbsp;<span class="ident" id="4019354">err</span>&nbsp;<span class="op" id="4019358">!=</span>&nbsp;<span class="ident" id="4019361">nil</span>&nbsp;<span class="op" id="4019365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4019369">return</span>&nbsp;<span class="ident" id="4019376">nil</span><span class="op" id="4019379">,</span>&nbsp;<span class="ident" id="4019381">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4019386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4019389">msg</span>&nbsp;<span class="op" id="4019393">:=</span>&nbsp;<span class="op" id="4019396">&amp;</span><span class="ident" id="4019397">dnsMsg</span><span class="op" id="4019403">{</span><span class="op" id="4019404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4019407">if</span>&nbsp;<span class="op" id="4019410">!</span><span class="ident" id="4019411">msg</span><span class="op" id="4019414">.</span><span class="ident" id="4019415">Unpack</span><span class="op" id="4019421">(</span><span class="ident" id="4019422">b</span><span class="op" id="4019423">[</span><span class="op" id="4019424">:</span><span class="ident" id="4019425">n</span><span class="op" id="4019426">]</span><span class="op" id="4019427">)</span>&nbsp;<span class="op" id="4019429">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4019433">return</span>&nbsp;<span class="ident" id="4019440">nil</span><span class="op" id="4019443">,</span>&nbsp;<span class="ident" id="4019445">errors</span><span class="op" id="4019451">.</span><span class="ident" id="4019452">New</span><span class="op" id="4019455">(</span><span class="string" id="4019456">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="4019486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4019489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4019492">return</span>&nbsp;<span class="ident" id="4019499">msg</span><span class="op" id="4019502">,</span>&nbsp;<span class="ident" id="4019504">nil</span><br>
<span class="lineno"></span><span class="op" id="4019508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="keyword" id="4019511">func</span>&nbsp;<span class="op" id="4019516">(</span><span class="ident" id="4019517">c</span>&nbsp;<span class="op" id="4019519">*</span><span class="ident" id="4019520">TCPConn</span><span class="op" id="4019527">)</span>&nbsp;<span class="ident" id="4019529">writeDNSQuery</span><span class="op" id="4019542">(</span><span class="ident" id="4019543">msg</span>&nbsp;<span class="op" id="4019547">*</span><span class="ident" id="4019548">dnsMsg</span><span class="op" id="4019554">)</span>&nbsp;<span class="builtintype" id="4019556">error</span>&nbsp;<span class="op" id="4019562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4019565">b</span><span class="op" id="4019566">,</span>&nbsp;<span class="ident" id="4019568">ok</span>&nbsp;<span class="op" id="4019571">:=</span>&nbsp;<span class="ident" id="4019574">msg</span><span class="op" id="4019577">.</span><span class="ident" id="4019578">Pack</span><span class="op" id="4019582">(</span><span class="op" id="4019583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4019586">if</span>&nbsp;<span class="op" id="4019589">!</span><span class="ident" id="4019590">ok</span>&nbsp;<span class="op" id="4019593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4019597">return</span>&nbsp;<span class="ident" id="4019604">errors</span><span class="op" id="4019610">.</span><span class="ident" id="4019611">New</span><span class="op" id="4019614">(</span><span class="string" id="4019615">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="4019643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4019646">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4019649">l</span>&nbsp;<span class="op" id="4019651">:=</span>&nbsp;<span class="builtintype" id="4019654">uint16</span><span class="op" id="4019660">(</span><span class="builtinfunc" id="4019661">len</span><span class="op" id="4019664">(</span><span class="ident" id="4019665">b</span><span class="op" id="4019666">)</span><span class="op" id="4019667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4019670">b</span>&nbsp;<span class="op" id="4019672">=</span>&nbsp;<span class="builtinfunc" id="4019674">append</span><span class="op" id="4019680">(</span><span class="op" id="4019681">[</span><span class="op" id="4019682">]</span><span class="builtintype" id="4019683">byte</span><span class="op" id="4019687">{</span><span class="builtintype" id="4019688">byte</span><span class="op" id="4019692">(</span><span class="ident" id="4019693">l</span>&nbsp;<span class="op" id="4019695">&gt;&gt;</span>&nbsp;<span class="num" id="4019698">8</span><span class="op" id="4019699">)</span><span class="op" id="4019700">,</span>&nbsp;<span class="builtintype" id="4019702">byte</span><span class="op" id="4019706">(</span><span class="ident" id="4019707">l</span><span class="op" id="4019708">)</span><span class="op" id="4019709">}</span><span class="op" id="4019710">,</span>&nbsp;<span class="ident" id="4019712">b</span><span class="op" id="4019713">...</span><span class="op" id="4019716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4019719">if</span>&nbsp;<span class="ident" id="4019722">_</span><span class="op" id="4019723">,</span>&nbsp;<span class="ident" id="4019725">err</span>&nbsp;<span class="op" id="4019729">:=</span>&nbsp;<span class="ident" id="4019732">c</span><span class="op" id="4019733">.</span><span class="ident" id="4019734">Write</span><span class="op" id="4019739">(</span><span class="ident" id="4019740">b</span><span class="op" id="4019741">)</span><span class="op" id="4019742">;</span>&nbsp;<span class="ident" id="4019744">err</span>&nbsp;<span class="op" id="4019748">!=</span>&nbsp;<span class="ident" id="4019751">nil</span>&nbsp;<span class="op" id="4019755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4019759">return</span>&nbsp;<span class="ident" id="4019766">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4019771">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4019774">return</span>&nbsp;<span class="ident" id="4019781">nil</span><br>
<span class="lineno"></span><span class="op" id="4019785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4019788">func</span>&nbsp;<span class="op" id="4019793">(</span><span class="ident" id="4019794">d</span>&nbsp;<span class="op" id="4019796">*</span><span class="ident" id="4019797">Dialer</span><span class="op" id="4019803">)</span>&nbsp;<span class="ident" id="4019805">dialDNS</span><span class="op" id="4019812">(</span><span class="ident" id="4019813">network</span><span class="op" id="4019820">,</span>&nbsp;<span class="ident" id="4019822">server</span>&nbsp;<span class="builtintype" id="4019829">string</span><span class="op" id="4019835">)</span>&nbsp;<span class="op" id="4019837">(</span><span class="ident" id="4019838">dnsConn</span><span class="op" id="4019845">,</span>&nbsp;<span class="builtintype" id="4019847">error</span><span class="op" id="4019852">)</span>&nbsp;<span class="op" id="4019854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4019857">switch</span>&nbsp;<span class="ident" id="4019864">network</span>&nbsp;<span class="op" id="4019872">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4019875">case</span>&nbsp;<span class="string" id="4019880">&#34;tcp&#34;</span><span class="op" id="4019885">,</span>&nbsp;<span class="string" id="4019887">&#34;tcp4&#34;</span><span class="op" id="4019893">,</span>&nbsp;<span class="string" id="4019895">&#34;tcp6&#34;</span><span class="op" id="4019901">,</span>&nbsp;<span class="string" id="4019903">&#34;udp&#34;</span><span class="op" id="4019908">,</span>&nbsp;<span class="string" id="4019910">&#34;udp4&#34;</span><span class="op" id="4019916">,</span>&nbsp;<span class="string" id="4019918">&#34;udp6&#34;</span><span class="op" id="4019924">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4019927">default</span><span class="op" id="4019934">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4019938">return</span>&nbsp;<span class="ident" id="4019945">nil</span><span class="op" id="4019948">,</span>&nbsp;<span class="ident" id="4019950">UnknownNetworkError</span><span class="op" id="4019969">(</span><span class="ident" id="4019970">network</span><span class="op" id="4019977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4019980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4019983">//&nbsp;Calling&nbsp;Dial&nbsp;here&nbsp;is&nbsp;scary&nbsp;--&nbsp;we&nbsp;have&nbsp;to&nbsp;be&nbsp;sure&nbsp;not&nbsp;to</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4020043">//&nbsp;dial&nbsp;a&nbsp;name&nbsp;that&nbsp;will&nbsp;require&nbsp;a&nbsp;DNS&nbsp;lookup,&nbsp;or&nbsp;Dial&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4020104">//&nbsp;call&nbsp;back&nbsp;here&nbsp;to&nbsp;translate&nbsp;it.&nbsp;The&nbsp;DNS&nbsp;config&nbsp;parser&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4020166">//&nbsp;already&nbsp;checked&nbsp;that&nbsp;all&nbsp;the&nbsp;cfg.servers[i]&nbsp;are&nbsp;IP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4020221">//&nbsp;addresses,&nbsp;which&nbsp;Dial&nbsp;will&nbsp;use&nbsp;without&nbsp;a&nbsp;DNS&nbsp;lookup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020278">c</span><span class="op" id="4020279">,</span>&nbsp;<span class="ident" id="4020281">err</span>&nbsp;<span class="op" id="4020285">:=</span>&nbsp;<span class="ident" id="4020288">d</span><span class="op" id="4020289">.</span><span class="ident" id="4020290">Dial</span><span class="op" id="4020294">(</span><span class="ident" id="4020295">network</span><span class="op" id="4020302">,</span>&nbsp;<span class="ident" id="4020304">server</span><span class="op" id="4020310">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020313">if</span>&nbsp;<span class="ident" id="4020316">err</span>&nbsp;<span class="op" id="4020320">!=</span>&nbsp;<span class="ident" id="4020323">nil</span>&nbsp;<span class="op" id="4020327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020331">return</span>&nbsp;<span class="ident" id="4020338">nil</span><span class="op" id="4020341">,</span>&nbsp;<span class="ident" id="4020343">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4020348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020351">switch</span>&nbsp;<span class="ident" id="4020358">network</span>&nbsp;<span class="op" id="4020366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020369">case</span>&nbsp;<span class="string" id="4020374">&#34;tcp&#34;</span><span class="op" id="4020379">,</span>&nbsp;<span class="string" id="4020381">&#34;tcp4&#34;</span><span class="op" id="4020387">,</span>&nbsp;<span class="string" id="4020389">&#34;tcp6&#34;</span><span class="op" id="4020395">:</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020399">return</span>&nbsp;<span class="ident" id="4020406">c</span><span class="op" id="4020407">.</span><span class="op" id="4020408">(</span><span class="op" id="4020409">*</span><span class="ident" id="4020410">TCPConn</span><span class="op" id="4020417">)</span><span class="op" id="4020418">,</span>&nbsp;<span class="ident" id="4020420">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020425">case</span>&nbsp;<span class="string" id="4020430">&#34;udp&#34;</span><span class="op" id="4020435">,</span>&nbsp;<span class="string" id="4020437">&#34;udp4&#34;</span><span class="op" id="4020443">,</span>&nbsp;<span class="string" id="4020445">&#34;udp6&#34;</span><span class="op" id="4020451">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020455">return</span>&nbsp;<span class="ident" id="4020462">c</span><span class="op" id="4020463">.</span><span class="op" id="4020464">(</span><span class="op" id="4020465">*</span><span class="ident" id="4020466">UDPConn</span><span class="op" id="4020473">)</span><span class="op" id="4020474">,</span>&nbsp;<span class="ident" id="4020476">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4020481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4020484">panic</span><span class="op" id="4020489">(</span><span class="string" id="4020490">&#34;unreachable&#34;</span><span class="op" id="4020503">)</span><br>
<span class="lineno">120</span><span class="op" id="4020505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4020508">//&nbsp;exchange&nbsp;sends&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;connection&nbsp;and&nbsp;hopes&nbsp;for&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="4020578">func</span>&nbsp;<span class="ident" id="4020583">exchange</span><span class="op" id="4020591">(</span><span class="ident" id="4020592">server</span><span class="op" id="4020598">,</span>&nbsp;<span class="ident" id="4020600">name</span>&nbsp;<span class="builtintype" id="4020605">string</span><span class="op" id="4020611">,</span>&nbsp;<span class="ident" id="4020613">qtype</span>&nbsp;<span class="builtintype" id="4020619">uint16</span><span class="op" id="4020625">,</span>&nbsp;<span class="ident" id="4020627">timeout</span>&nbsp;<span class="ident" id="4020635">time</span><span class="op" id="4020639">.</span><span class="ident" id="4020640">Duration</span><span class="op" id="4020648">)</span>&nbsp;<span class="op" id="4020650">(</span><span class="op" id="4020651">*</span><span class="ident" id="4020652">dnsMsg</span><span class="op" id="4020658">,</span>&nbsp;<span class="builtintype" id="4020660">error</span><span class="op" id="4020665">)</span>&nbsp;<span class="op" id="4020667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020670">d</span>&nbsp;<span class="op" id="4020672">:=</span>&nbsp;<span class="ident" id="4020675">Dialer</span><span class="op" id="4020681">{</span><span class="ident" id="4020682">Timeout</span><span class="op" id="4020689">:</span>&nbsp;<span class="ident" id="4020691">timeout</span><span class="op" id="4020698">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020701">out</span>&nbsp;<span class="op" id="4020705">:=</span>&nbsp;<span class="ident" id="4020708">dnsMsg</span><span class="op" id="4020714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020718">dnsMsgHdr</span><span class="op" id="4020727">:</span>&nbsp;<span class="ident" id="4020729">dnsMsgHdr</span><span class="op" id="4020738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020743">recursion_desired</span><span class="op" id="4020760">:</span>&nbsp;<span class="builtintype" id="4020762">true</span><span class="op" id="4020766">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4020770">}</span><span class="op" id="4020771">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020775">question</span><span class="op" id="4020783">:</span>&nbsp;<span class="op" id="4020785">[</span><span class="op" id="4020786">]</span><span class="ident" id="4020787">dnsQuestion</span><span class="op" id="4020798">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4020803">{</span><span class="ident" id="4020804">name</span><span class="op" id="4020808">,</span>&nbsp;<span class="ident" id="4020810">qtype</span><span class="op" id="4020815">,</span>&nbsp;<span class="ident" id="4020817">dnsClassINET</span><span class="op" id="4020829">}</span><span class="op" id="4020830">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4020834">}</span><span class="op" id="4020835">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4020838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020841">for</span>&nbsp;<span class="ident" id="4020845">_</span><span class="op" id="4020846">,</span>&nbsp;<span class="ident" id="4020848">network</span>&nbsp;<span class="op" id="4020856">:=</span>&nbsp;<span class="keyword" id="4020859">range</span>&nbsp;<span class="op" id="4020865">[</span><span class="op" id="4020866">]</span><span class="builtintype" id="4020867">string</span><span class="op" id="4020873">{</span><span class="string" id="4020874">&#34;udp&#34;</span><span class="op" id="4020879">,</span>&nbsp;<span class="string" id="4020881">&#34;tcp&#34;</span><span class="op" id="4020886">}</span>&nbsp;<span class="op" id="4020888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4020892">c</span><span class="op" id="4020893">,</span>&nbsp;<span class="ident" id="4020895">err</span>&nbsp;<span class="op" id="4020899">:=</span>&nbsp;<span class="ident" id="4020902">d</span><span class="op" id="4020903">.</span><span class="ident" id="4020904">dialDNS</span><span class="op" id="4020911">(</span><span class="ident" id="4020912">network</span><span class="op" id="4020919">,</span>&nbsp;<span class="ident" id="4020921">server</span><span class="op" id="4020927">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020931">if</span>&nbsp;<span class="ident" id="4020934">err</span>&nbsp;<span class="op" id="4020938">!=</span>&nbsp;<span class="ident" id="4020941">nil</span>&nbsp;<span class="op" id="4020945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020950">return</span>&nbsp;<span class="ident" id="4020957">nil</span><span class="op" id="4020960">,</span>&nbsp;<span class="ident" id="4020962">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4020968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020972">defer</span>&nbsp;<span class="ident" id="4020978">c</span><span class="op" id="4020979">.</span><span class="ident" id="4020980">Close</span><span class="op" id="4020985">(</span><span class="op" id="4020986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4020990">if</span>&nbsp;<span class="ident" id="4020993">timeout</span>&nbsp;<span class="op" id="4021001">&gt;</span>&nbsp;<span class="num" id="4021003">0</span>&nbsp;<span class="op" id="4021005">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021010">c</span><span class="op" id="4021011">.</span><span class="ident" id="4021012">SetDeadline</span><span class="op" id="4021023">(</span><span class="ident" id="4021024">time</span><span class="op" id="4021028">.</span><span class="ident" id="4021029">Now</span><span class="op" id="4021032">(</span><span class="op" id="4021033">)</span><span class="op" id="4021034">.</span><span class="ident" id="4021035">Add</span><span class="op" id="4021038">(</span><span class="ident" id="4021039">timeout</span><span class="op" id="4021046">)</span><span class="op" id="4021047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4021051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021055">out</span><span class="op" id="4021058">.</span><span class="ident" id="4021059">id</span>&nbsp;<span class="op" id="4021062">=</span>&nbsp;<span class="builtintype" id="4021064">uint16</span><span class="op" id="4021070">(</span><span class="ident" id="4021071">rand</span><span class="op" id="4021075">.</span><span class="ident" id="4021076">Int</span><span class="op" id="4021079">(</span><span class="op" id="4021080">)</span><span class="op" id="4021081">)</span>&nbsp;<span class="op" id="4021083">^</span>&nbsp;<span class="builtintype" id="4021085">uint16</span><span class="op" id="4021091">(</span><span class="ident" id="4021092">time</span><span class="op" id="4021096">.</span><span class="ident" id="4021097">Now</span><span class="op" id="4021100">(</span><span class="op" id="4021101">)</span><span class="op" id="4021102">.</span><span class="ident" id="4021103">UnixNano</span><span class="op" id="4021111">(</span><span class="op" id="4021112">)</span><span class="op" id="4021113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021117">if</span>&nbsp;<span class="ident" id="4021120">err</span>&nbsp;<span class="op" id="4021124">:=</span>&nbsp;<span class="ident" id="4021127">c</span><span class="op" id="4021128">.</span><span class="ident" id="4021129">writeDNSQuery</span><span class="op" id="4021142">(</span><span class="op" id="4021143">&amp;</span><span class="ident" id="4021144">out</span><span class="op" id="4021147">)</span><span class="op" id="4021148">;</span>&nbsp;<span class="ident" id="4021150">err</span>&nbsp;<span class="op" id="4021154">!=</span>&nbsp;<span class="ident" id="4021157">nil</span>&nbsp;<span class="op" id="4021161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021166">return</span>&nbsp;<span class="ident" id="4021173">nil</span><span class="op" id="4021176">,</span>&nbsp;<span class="ident" id="4021178">err</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4021184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021188">in</span><span class="op" id="4021190">,</span>&nbsp;<span class="ident" id="4021192">err</span>&nbsp;<span class="op" id="4021196">:=</span>&nbsp;<span class="ident" id="4021199">c</span><span class="op" id="4021200">.</span><span class="ident" id="4021201">readDNSResponse</span><span class="op" id="4021216">(</span><span class="op" id="4021217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021221">if</span>&nbsp;<span class="ident" id="4021224">err</span>&nbsp;<span class="op" id="4021228">!=</span>&nbsp;<span class="ident" id="4021231">nil</span>&nbsp;<span class="op" id="4021235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021240">return</span>&nbsp;<span class="ident" id="4021247">nil</span><span class="op" id="4021250">,</span>&nbsp;<span class="ident" id="4021252">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4021258">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021262">if</span>&nbsp;<span class="ident" id="4021265">in</span><span class="op" id="4021267">.</span><span class="ident" id="4021268">id</span>&nbsp;<span class="op" id="4021271">!=</span>&nbsp;<span class="ident" id="4021274">out</span><span class="op" id="4021277">.</span><span class="ident" id="4021278">id</span>&nbsp;<span class="op" id="4021281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021286">return</span>&nbsp;<span class="ident" id="4021293">nil</span><span class="op" id="4021296">,</span>&nbsp;<span class="ident" id="4021298">errors</span><span class="op" id="4021304">.</span><span class="ident" id="4021305">New</span><span class="op" id="4021308">(</span><span class="string" id="4021309">&#34;DNS&nbsp;message&nbsp;ID&nbsp;mismatch&#34;</span><span class="op" id="4021334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4021338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021342">if</span>&nbsp;<span class="ident" id="4021345">in</span><span class="op" id="4021347">.</span><span class="ident" id="4021348">truncated</span>&nbsp;<span class="op" id="4021358">{</span>&nbsp;<span class="comment" id="4021360">//&nbsp;see&nbsp;RFC&nbsp;5966</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021379">continue</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4021390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021394">return</span>&nbsp;<span class="ident" id="4021401">in</span><span class="op" id="4021403">,</span>&nbsp;<span class="ident" id="4021405">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4021410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021413">return</span>&nbsp;<span class="ident" id="4021420">nil</span><span class="op" id="4021423">,</span>&nbsp;<span class="ident" id="4021425">errors</span><span class="op" id="4021431">.</span><span class="ident" id="4021432">New</span><span class="op" id="4021435">(</span><span class="string" id="4021436">&#34;no&nbsp;answer&nbsp;from&nbsp;DNS&nbsp;server&#34;</span><span class="op" id="4021463">)</span><br>
<span class="lineno"></span><span class="op" id="4021465">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="4021468">//&nbsp;Do&nbsp;a&nbsp;lookup&nbsp;for&nbsp;a&nbsp;single&nbsp;name,&nbsp;which&nbsp;must&nbsp;be&nbsp;rooted</span><br>
<span class="lineno"></span><span class="comment" id="4021523">//&nbsp;(otherwise&nbsp;answer&nbsp;will&nbsp;not&nbsp;find&nbsp;the&nbsp;answers).</span><br>
<span class="lineno"></span><span class="keyword" id="4021572">func</span>&nbsp;<span class="ident" id="4021577">tryOneName</span><span class="op" id="4021587">(</span><span class="ident" id="4021588">cfg</span>&nbsp;<span class="op" id="4021592">*</span><span class="ident" id="4021593">dnsConfig</span><span class="op" id="4021602">,</span>&nbsp;<span class="ident" id="4021604">name</span>&nbsp;<span class="builtintype" id="4021609">string</span><span class="op" id="4021615">,</span>&nbsp;<span class="ident" id="4021617">qtype</span>&nbsp;<span class="builtintype" id="4021623">uint16</span><span class="op" id="4021629">)</span>&nbsp;<span class="op" id="4021631">(</span><span class="builtintype" id="4021632">string</span><span class="op" id="4021638">,</span>&nbsp;<span class="op" id="4021640">[</span><span class="op" id="4021641">]</span><span class="ident" id="4021642">dnsRR</span><span class="op" id="4021647">,</span>&nbsp;<span class="builtintype" id="4021649">error</span><span class="op" id="4021654">)</span>&nbsp;<span class="op" id="4021656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021659">if</span>&nbsp;<span class="builtinfunc" id="4021662">len</span><span class="op" id="4021665">(</span><span class="ident" id="4021666">cfg</span><span class="op" id="4021669">.</span><span class="ident" id="4021670">servers</span><span class="op" id="4021677">)</span>&nbsp;<span class="op" id="4021679">==</span>&nbsp;<span class="num" id="4021682">0</span>&nbsp;<span class="op" id="4021684">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021688">return</span>&nbsp;<span class="string" id="4021695">&#34;&#34;</span><span class="op" id="4021697">,</span>&nbsp;<span class="ident" id="4021699">nil</span><span class="op" id="4021702">,</span>&nbsp;<span class="op" id="4021704">&amp;</span><span class="ident" id="4021705">DNSError</span><span class="op" id="4021713">{</span><span class="ident" id="4021714">Err</span><span class="op" id="4021717">:</span>&nbsp;<span class="string" id="4021719">&#34;no&nbsp;DNS&nbsp;servers&#34;</span><span class="op" id="4021735">,</span>&nbsp;<span class="ident" id="4021737">Name</span><span class="op" id="4021741">:</span>&nbsp;<span class="ident" id="4021743">name</span><span class="op" id="4021747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4021750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021753">if</span>&nbsp;<span class="builtinfunc" id="4021756">len</span><span class="op" id="4021759">(</span><span class="ident" id="4021760">name</span><span class="op" id="4021764">)</span>&nbsp;<span class="op" id="4021766">&gt;=</span>&nbsp;<span class="num" id="4021769">256</span>&nbsp;<span class="op" id="4021773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021777">return</span>&nbsp;<span class="string" id="4021784">&#34;&#34;</span><span class="op" id="4021786">,</span>&nbsp;<span class="ident" id="4021788">nil</span><span class="op" id="4021791">,</span>&nbsp;<span class="op" id="4021793">&amp;</span><span class="ident" id="4021794">DNSError</span><span class="op" id="4021802">{</span><span class="ident" id="4021803">Err</span><span class="op" id="4021806">:</span>&nbsp;<span class="string" id="4021808">&#34;DNS&nbsp;name&nbsp;too&nbsp;long&#34;</span><span class="op" id="4021827">,</span>&nbsp;<span class="ident" id="4021829">Name</span><span class="op" id="4021833">:</span>&nbsp;<span class="ident" id="4021835">name</span><span class="op" id="4021839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4021842">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021845">timeout</span>&nbsp;<span class="op" id="4021853">:=</span>&nbsp;<span class="ident" id="4021856">time</span><span class="op" id="4021860">.</span><span class="ident" id="4021861">Duration</span><span class="op" id="4021869">(</span><span class="ident" id="4021870">cfg</span><span class="op" id="4021873">.</span><span class="ident" id="4021874">timeout</span><span class="op" id="4021881">)</span>&nbsp;<span class="op" id="4021883">*</span>&nbsp;<span class="ident" id="4021885">time</span><span class="op" id="4021889">.</span><span class="ident" id="4021890">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021898">var</span>&nbsp;<span class="ident" id="4021902">lastErr</span>&nbsp;<span class="builtintype" id="4021910">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021917">for</span>&nbsp;<span class="ident" id="4021921">i</span>&nbsp;<span class="op" id="4021923">:=</span>&nbsp;<span class="num" id="4021926">0</span><span class="op" id="4021927">;</span>&nbsp;<span class="ident" id="4021929">i</span>&nbsp;<span class="op" id="4021931">&lt;</span>&nbsp;<span class="ident" id="4021933">cfg</span><span class="op" id="4021936">.</span><span class="ident" id="4021937">attempts</span><span class="op" id="4021945">;</span>&nbsp;<span class="ident" id="4021947">i</span><span class="op" id="4021948">++</span>&nbsp;<span class="op" id="4021951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4021955">for</span>&nbsp;<span class="ident" id="4021959">_</span><span class="op" id="4021960">,</span>&nbsp;<span class="ident" id="4021962">server</span>&nbsp;<span class="op" id="4021969">:=</span>&nbsp;<span class="keyword" id="4021972">range</span>&nbsp;<span class="ident" id="4021978">cfg</span><span class="op" id="4021981">.</span><span class="ident" id="4021982">servers</span>&nbsp;<span class="op" id="4021990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4021995">server</span>&nbsp;<span class="op" id="4022002">=</span>&nbsp;<span class="ident" id="4022004">JoinHostPort</span><span class="op" id="4022016">(</span><span class="ident" id="4022017">server</span><span class="op" id="4022023">,</span>&nbsp;<span class="string" id="4022025">&#34;53&#34;</span><span class="op" id="4022029">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022034">msg</span><span class="op" id="4022037">,</span>&nbsp;<span class="ident" id="4022039">err</span>&nbsp;<span class="op" id="4022043">:=</span>&nbsp;<span class="ident" id="4022046">exchange</span><span class="op" id="4022054">(</span><span class="ident" id="4022055">server</span><span class="op" id="4022061">,</span>&nbsp;<span class="ident" id="4022063">name</span><span class="op" id="4022067">,</span>&nbsp;<span class="ident" id="4022069">qtype</span><span class="op" id="4022074">,</span>&nbsp;<span class="ident" id="4022076">timeout</span><span class="op" id="4022083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022088">if</span>&nbsp;<span class="ident" id="4022091">err</span>&nbsp;<span class="op" id="4022095">!=</span>&nbsp;<span class="ident" id="4022098">nil</span>&nbsp;<span class="op" id="4022102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022108">lastErr</span>&nbsp;<span class="op" id="4022116">=</span>&nbsp;<span class="op" id="4022118">&amp;</span><span class="ident" id="4022119">DNSError</span><span class="op" id="4022127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022134">Err</span><span class="op" id="4022137">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4022142">err</span><span class="op" id="4022145">.</span><span class="ident" id="4022146">Error</span><span class="op" id="4022151">(</span><span class="op" id="4022152">)</span><span class="op" id="4022153">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022160">Name</span><span class="op" id="4022164">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4022168">name</span><span class="op" id="4022172">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022179">Server</span><span class="op" id="4022185">:</span>&nbsp;<span class="ident" id="4022187">server</span><span class="op" id="4022193">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4022199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022205">if</span>&nbsp;<span class="ident" id="4022208">nerr</span><span class="op" id="4022212">,</span>&nbsp;<span class="ident" id="4022214">ok</span>&nbsp;<span class="op" id="4022217">:=</span>&nbsp;<span class="ident" id="4022220">err</span><span class="op" id="4022223">.</span><span class="op" id="4022224">(</span><span class="ident" id="4022225">Error</span><span class="op" id="4022230">)</span><span class="op" id="4022231">;</span>&nbsp;<span class="ident" id="4022233">ok</span>&nbsp;<span class="op" id="4022236">&amp;&amp;</span>&nbsp;<span class="ident" id="4022239">nerr</span><span class="op" id="4022243">.</span><span class="ident" id="4022244">Timeout</span><span class="op" id="4022251">(</span><span class="op" id="4022252">)</span>&nbsp;<span class="op" id="4022254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022261">lastErr</span><span class="op" id="4022268">.</span><span class="op" id="4022269">(</span><span class="op" id="4022270">*</span><span class="ident" id="4022271">DNSError</span><span class="op" id="4022279">)</span><span class="op" id="4022280">.</span><span class="ident" id="4022281">IsTimeout</span>&nbsp;<span class="op" id="4022291">=</span>&nbsp;<span class="builtintype" id="4022293">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4022302">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022308">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4022320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022325">cname</span><span class="op" id="4022330">,</span>&nbsp;<span class="ident" id="4022332">addrs</span><span class="op" id="4022337">,</span>&nbsp;<span class="ident" id="4022339">err</span>&nbsp;<span class="op" id="4022343">:=</span>&nbsp;<span class="ident" id="4022346">answer</span><span class="op" id="4022352">(</span><span class="ident" id="4022353">name</span><span class="op" id="4022357">,</span>&nbsp;<span class="ident" id="4022359">server</span><span class="op" id="4022365">,</span>&nbsp;<span class="ident" id="4022367">msg</span><span class="op" id="4022370">,</span>&nbsp;<span class="ident" id="4022372">qtype</span><span class="op" id="4022377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022382">if</span>&nbsp;<span class="ident" id="4022385">err</span>&nbsp;<span class="op" id="4022389">==</span>&nbsp;<span class="ident" id="4022392">nil</span>&nbsp;<span class="op" id="4022396">||</span>&nbsp;<span class="ident" id="4022399">err</span><span class="op" id="4022402">.</span><span class="op" id="4022403">(</span><span class="op" id="4022404">*</span><span class="ident" id="4022405">DNSError</span><span class="op" id="4022413">)</span><span class="op" id="4022414">.</span><span class="ident" id="4022415">Err</span>&nbsp;<span class="op" id="4022419">==</span>&nbsp;<span class="ident" id="4022422">noSuchHost</span>&nbsp;<span class="op" id="4022433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022439">return</span>&nbsp;<span class="ident" id="4022446">cname</span><span class="op" id="4022451">,</span>&nbsp;<span class="ident" id="4022453">addrs</span><span class="op" id="4022458">,</span>&nbsp;<span class="ident" id="4022460">err</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4022467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022472">lastErr</span>&nbsp;<span class="op" id="4022480">=</span>&nbsp;<span class="ident" id="4022482">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4022488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4022491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022494">return</span>&nbsp;<span class="string" id="4022501">&#34;&#34;</span><span class="op" id="4022503">,</span>&nbsp;<span class="ident" id="4022505">nil</span><span class="op" id="4022508">,</span>&nbsp;<span class="ident" id="4022510">lastErr</span><br>
<span class="lineno">195</span><span class="op" id="4022518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4022521">func</span>&nbsp;<span class="ident" id="4022526">convertRR_A</span><span class="op" id="4022537">(</span><span class="ident" id="4022538">records</span>&nbsp;<span class="op" id="4022546">[</span><span class="op" id="4022547">]</span><span class="ident" id="4022548">dnsRR</span><span class="op" id="4022553">)</span>&nbsp;<span class="op" id="4022555">[</span><span class="op" id="4022556">]</span><span class="ident" id="4022557">IP</span>&nbsp;<span class="op" id="4022560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022563">addrs</span>&nbsp;<span class="op" id="4022569">:=</span>&nbsp;<span class="builtinfunc" id="4022572">make</span><span class="op" id="4022576">(</span><span class="op" id="4022577">[</span><span class="op" id="4022578">]</span><span class="ident" id="4022579">IP</span><span class="op" id="4022581">,</span>&nbsp;<span class="builtinfunc" id="4022583">len</span><span class="op" id="4022586">(</span><span class="ident" id="4022587">records</span><span class="op" id="4022594">)</span><span class="op" id="4022595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022598">for</span>&nbsp;<span class="ident" id="4022602">i</span><span class="op" id="4022603">,</span>&nbsp;<span class="ident" id="4022605">rr</span>&nbsp;<span class="op" id="4022608">:=</span>&nbsp;<span class="keyword" id="4022611">range</span>&nbsp;<span class="ident" id="4022617">records</span>&nbsp;<span class="op" id="4022625">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022629">a</span>&nbsp;<span class="op" id="4022631">:=</span>&nbsp;<span class="ident" id="4022634">rr</span><span class="op" id="4022636">.</span><span class="op" id="4022637">(</span><span class="op" id="4022638">*</span><span class="ident" id="4022639">dnsRR_A</span><span class="op" id="4022646">)</span><span class="op" id="4022647">.</span><span class="ident" id="4022648">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022652">addrs</span><span class="op" id="4022657">[</span><span class="ident" id="4022658">i</span><span class="op" id="4022659">]</span>&nbsp;<span class="op" id="4022661">=</span>&nbsp;<span class="ident" id="4022663">IPv4</span><span class="op" id="4022667">(</span><span class="builtintype" id="4022668">byte</span><span class="op" id="4022672">(</span><span class="ident" id="4022673">a</span><span class="op" id="4022674">&gt;&gt;</span><span class="num" id="4022676">24</span><span class="op" id="4022678">)</span><span class="op" id="4022679">,</span>&nbsp;<span class="builtintype" id="4022681">byte</span><span class="op" id="4022685">(</span><span class="ident" id="4022686">a</span><span class="op" id="4022687">&gt;&gt;</span><span class="num" id="4022689">16</span><span class="op" id="4022691">)</span><span class="op" id="4022692">,</span>&nbsp;<span class="builtintype" id="4022694">byte</span><span class="op" id="4022698">(</span><span class="ident" id="4022699">a</span><span class="op" id="4022700">&gt;&gt;</span><span class="num" id="4022702">8</span><span class="op" id="4022703">)</span><span class="op" id="4022704">,</span>&nbsp;<span class="builtintype" id="4022706">byte</span><span class="op" id="4022710">(</span><span class="ident" id="4022711">a</span><span class="op" id="4022712">)</span><span class="op" id="4022713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4022716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022719">return</span>&nbsp;<span class="ident" id="4022726">addrs</span><br>
<span class="lineno"></span><span class="op" id="4022732">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="4022735">func</span>&nbsp;<span class="ident" id="4022740">convertRR_AAAA</span><span class="op" id="4022754">(</span><span class="ident" id="4022755">records</span>&nbsp;<span class="op" id="4022763">[</span><span class="op" id="4022764">]</span><span class="ident" id="4022765">dnsRR</span><span class="op" id="4022770">)</span>&nbsp;<span class="op" id="4022772">[</span><span class="op" id="4022773">]</span><span class="ident" id="4022774">IP</span>&nbsp;<span class="op" id="4022777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022780">addrs</span>&nbsp;<span class="op" id="4022786">:=</span>&nbsp;<span class="builtinfunc" id="4022789">make</span><span class="op" id="4022793">(</span><span class="op" id="4022794">[</span><span class="op" id="4022795">]</span><span class="ident" id="4022796">IP</span><span class="op" id="4022798">,</span>&nbsp;<span class="builtinfunc" id="4022800">len</span><span class="op" id="4022803">(</span><span class="ident" id="4022804">records</span><span class="op" id="4022811">)</span><span class="op" id="4022812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022815">for</span>&nbsp;<span class="ident" id="4022819">i</span><span class="op" id="4022820">,</span>&nbsp;<span class="ident" id="4022822">rr</span>&nbsp;<span class="op" id="4022825">:=</span>&nbsp;<span class="keyword" id="4022828">range</span>&nbsp;<span class="ident" id="4022834">records</span>&nbsp;<span class="op" id="4022842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022846">a</span>&nbsp;<span class="op" id="4022848">:=</span>&nbsp;<span class="builtinfunc" id="4022851">make</span><span class="op" id="4022855">(</span><span class="ident" id="4022856">IP</span><span class="op" id="4022858">,</span>&nbsp;<span class="ident" id="4022860">IPv6len</span><span class="op" id="4022867">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4022871">copy</span><span class="op" id="4022875">(</span><span class="ident" id="4022876">a</span><span class="op" id="4022877">,</span>&nbsp;<span class="ident" id="4022879">rr</span><span class="op" id="4022881">.</span><span class="op" id="4022882">(</span><span class="op" id="4022883">*</span><span class="ident" id="4022884">dnsRR_AAAA</span><span class="op" id="4022894">)</span><span class="op" id="4022895">.</span><span class="ident" id="4022896">AAAA</span><span class="op" id="4022900">[</span><span class="op" id="4022901">:</span><span class="op" id="4022902">]</span><span class="op" id="4022903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022907">addrs</span><span class="op" id="4022912">[</span><span class="ident" id="4022913">i</span><span class="op" id="4022914">]</span>&nbsp;<span class="op" id="4022916">=</span>&nbsp;<span class="ident" id="4022918">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4022921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4022924">return</span>&nbsp;<span class="ident" id="4022931">addrs</span><br>
<span class="lineno"></span><span class="op" id="4022937">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="4022940">var</span>&nbsp;<span class="ident" id="4022944">cfg</span>&nbsp;<span class="keyword" id="4022948">struct</span>&nbsp;<span class="op" id="4022955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022958">ch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4022968">chan</span>&nbsp;<span class="keyword" id="4022973">struct</span><span class="op" id="4022979">{</span><span class="op" id="4022980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4022983">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4022993">sync</span><span class="op" id="4022997">.</span><span class="ident" id="4022998">RWMutex</span>&nbsp;<span class="comment" id="4023006">//&nbsp;protects&nbsp;dnsConfig&nbsp;and&nbsp;dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023040">dnsConfig</span>&nbsp;<span class="op" id="4023050">*</span><span class="ident" id="4023051">dnsConfig</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023062">dnserr</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4023072">error</span><br>
<span class="lineno"></span><span class="op" id="4023078">}</span><br>
<span class="lineno"></span><span class="keyword" id="4023080">var</span>&nbsp;<span class="ident" id="4023084">onceLoadConfig</span>&nbsp;<span class="ident" id="4023099">sync</span><span class="op" id="4023103">.</span><span class="ident" id="4023104">Once</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4023110">//&nbsp;Assume&nbsp;dns&nbsp;config&nbsp;file&nbsp;is&nbsp;/etc/resolv.conf&nbsp;here</span><br>
<span class="lineno">225</span><span class="keyword" id="4023161">func</span>&nbsp;<span class="ident" id="4023166">loadDefaultConfig</span><span class="op" id="4023183">(</span><span class="op" id="4023184">)</span>&nbsp;<span class="op" id="4023186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023189">loadConfig</span><span class="op" id="4023199">(</span><span class="string" id="4023200">&#34;/etc/resolv.conf&#34;</span><span class="op" id="4023218">,</span>&nbsp;<span class="num" id="4023220">5</span><span class="op" id="4023221">*</span><span class="ident" id="4023222">time</span><span class="op" id="4023226">.</span><span class="ident" id="4023227">Second</span><span class="op" id="4023233">,</span>&nbsp;<span class="ident" id="4023235">nil</span><span class="op" id="4023238">)</span><br>
<span class="lineno"></span><span class="op" id="4023240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4023243">func</span>&nbsp;<span class="ident" id="4023248">loadConfig</span><span class="op" id="4023258">(</span><span class="ident" id="4023259">resolvConfPath</span>&nbsp;<span class="builtintype" id="4023274">string</span><span class="op" id="4023280">,</span>&nbsp;<span class="ident" id="4023282">reloadTime</span>&nbsp;<span class="ident" id="4023293">time</span><span class="op" id="4023297">.</span><span class="ident" id="4023298">Duration</span><span class="op" id="4023306">,</span>&nbsp;<span class="ident" id="4023308">quit</span>&nbsp;<span class="op" id="4023313">&lt;-</span><span class="keyword" id="4023315">chan</span>&nbsp;<span class="keyword" id="4023320">chan</span>&nbsp;<span class="keyword" id="4023325">struct</span><span class="op" id="4023331">{</span><span class="op" id="4023332">}</span><span class="op" id="4023333">)</span>&nbsp;<span class="op" id="4023335">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4023338">var</span>&nbsp;<span class="ident" id="4023342">mtime</span>&nbsp;<span class="ident" id="4023348">time</span><span class="op" id="4023352">.</span><span class="ident" id="4023353">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023359">cfg</span><span class="op" id="4023362">.</span><span class="ident" id="4023363">ch</span>&nbsp;<span class="op" id="4023366">=</span>&nbsp;<span class="builtinfunc" id="4023368">make</span><span class="op" id="4023372">(</span><span class="keyword" id="4023373">chan</span>&nbsp;<span class="keyword" id="4023378">struct</span><span class="op" id="4023384">{</span><span class="op" id="4023385">}</span><span class="op" id="4023386">,</span>&nbsp;<span class="num" id="4023388">1</span><span class="op" id="4023389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4023392">if</span>&nbsp;<span class="ident" id="4023395">fi</span><span class="op" id="4023397">,</span>&nbsp;<span class="ident" id="4023399">err</span>&nbsp;<span class="op" id="4023403">:=</span>&nbsp;<span class="ident" id="4023406">os</span><span class="op" id="4023408">.</span><span class="ident" id="4023409">Stat</span><span class="op" id="4023413">(</span><span class="ident" id="4023414">resolvConfPath</span><span class="op" id="4023428">)</span><span class="op" id="4023429">;</span>&nbsp;<span class="ident" id="4023431">err</span>&nbsp;<span class="op" id="4023435">!=</span>&nbsp;<span class="ident" id="4023438">nil</span>&nbsp;<span class="op" id="4023442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023446">cfg</span><span class="op" id="4023449">.</span><span class="ident" id="4023450">dnserr</span>&nbsp;<span class="op" id="4023457">=</span>&nbsp;<span class="ident" id="4023459">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4023464">}</span>&nbsp;<span class="keyword" id="4023466">else</span>&nbsp;<span class="op" id="4023471">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023475">mtime</span>&nbsp;<span class="op" id="4023481">=</span>&nbsp;<span class="ident" id="4023483">fi</span><span class="op" id="4023485">.</span><span class="ident" id="4023486">ModTime</span><span class="op" id="4023493">(</span><span class="op" id="4023494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023498">cfg</span><span class="op" id="4023501">.</span><span class="ident" id="4023502">dnsConfig</span><span class="op" id="4023511">,</span>&nbsp;<span class="ident" id="4023513">cfg</span><span class="op" id="4023516">.</span><span class="ident" id="4023517">dnserr</span>&nbsp;<span class="op" id="4023524">=</span>&nbsp;<span class="ident" id="4023526">dnsReadConfig</span><span class="op" id="4023539">(</span><span class="ident" id="4023540">resolvConfPath</span><span class="op" id="4023554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4023557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4023560">go</span>&nbsp;<span class="keyword" id="4023563">func</span><span class="op" id="4023567">(</span><span class="op" id="4023568">)</span>&nbsp;<span class="op" id="4023570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4023574">for</span>&nbsp;<span class="op" id="4023578">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023583">time</span><span class="op" id="4023587">.</span><span class="ident" id="4023588">Sleep</span><span class="op" id="4023593">(</span><span class="ident" id="4023594">reloadTime</span><span class="op" id="4023604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4023609">select</span>&nbsp;<span class="op" id="4023616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4023621">case</span>&nbsp;<span class="ident" id="4023626">qresp</span>&nbsp;<span class="op" id="4023632">:=</span>&nbsp;<span class="op" id="4023635">&lt;-</span><span class="ident" id="4023637">quit</span><span class="op" id="4023641">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023647">qresp</span>&nbsp;<span class="op" id="4023653">&lt;-</span>&nbsp;<span class="keyword" id="4023656">struct</span><span class="op" id="4023662">{</span><span class="op" id="4023663">}</span><span class="op" id="4023664">{</span><span class="op" id="4023665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4023671">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4023681">case</span>&nbsp;<span class="op" id="4023686">&lt;-</span><span class="ident" id="4023688">cfg</span><span class="op" id="4023691">.</span><span class="ident" id="4023692">ch</span><span class="op" id="4023694">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4023699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4023705">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023757">fi</span><span class="op" id="4023759">,</span>&nbsp;<span class="ident" id="4023761">err</span>&nbsp;<span class="op" id="4023765">:=</span>&nbsp;<span class="ident" id="4023768">os</span><span class="op" id="4023770">.</span><span class="ident" id="4023771">Stat</span><span class="op" id="4023775">(</span><span class="ident" id="4023776">resolvConfPath</span><span class="op" id="4023790">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4023795">if</span>&nbsp;<span class="ident" id="4023798">err</span>&nbsp;<span class="op" id="4023802">!=</span>&nbsp;<span class="ident" id="4023805">nil</span>&nbsp;<span class="op" id="4023809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4023815">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4023827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4023832">//&nbsp;If&nbsp;the&nbsp;resolv.conf&nbsp;mtime&nbsp;didn&#39;t&nbsp;change,&nbsp;do&nbsp;not&nbsp;reload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023892">m</span>&nbsp;<span class="op" id="4023894">:=</span>&nbsp;<span class="ident" id="4023897">fi</span><span class="op" id="4023899">.</span><span class="ident" id="4023900">ModTime</span><span class="op" id="4023907">(</span><span class="op" id="4023908">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4023913">if</span>&nbsp;<span class="ident" id="4023916">m</span><span class="op" id="4023917">.</span><span class="ident" id="4023918">Equal</span><span class="op" id="4023923">(</span><span class="ident" id="4023924">mtime</span><span class="op" id="4023929">)</span>&nbsp;<span class="op" id="4023931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4023937">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4023949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4023954">mtime</span>&nbsp;<span class="op" id="4023960">=</span>&nbsp;<span class="ident" id="4023962">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4023967">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4024019">ncfg</span><span class="op" id="4024023">,</span>&nbsp;<span class="ident" id="4024025">err</span>&nbsp;<span class="op" id="4024029">:=</span>&nbsp;<span class="ident" id="4024032">dnsReadConfig</span><span class="op" id="4024045">(</span><span class="ident" id="4024046">resolvConfPath</span><span class="op" id="4024060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4024065">if</span>&nbsp;<span class="ident" id="4024068">err</span>&nbsp;<span class="op" id="4024072">!=</span>&nbsp;<span class="ident" id="4024075">nil</span>&nbsp;<span class="op" id="4024079">||</span>&nbsp;<span class="builtinfunc" id="4024082">len</span><span class="op" id="4024085">(</span><span class="ident" id="4024086">ncfg</span><span class="op" id="4024090">.</span><span class="ident" id="4024091">servers</span><span class="op" id="4024098">)</span>&nbsp;<span class="op" id="4024100">==</span>&nbsp;<span class="num" id="4024103">0</span>&nbsp;<span class="op" id="4024105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4024111">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4024123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4024128">cfg</span><span class="op" id="4024131">.</span><span class="ident" id="4024132">mu</span><span class="op" id="4024134">.</span><span class="ident" id="4024135">Lock</span><span class="op" id="4024139">(</span><span class="op" id="4024140">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4024145">cfg</span><span class="op" id="4024148">.</span><span class="ident" id="4024149">dnsConfig</span>&nbsp;<span class="op" id="4024159">=</span>&nbsp;<span class="ident" id="4024161">ncfg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4024169">cfg</span><span class="op" id="4024172">.</span><span class="ident" id="4024173">dnserr</span>&nbsp;<span class="op" id="4024180">=</span>&nbsp;<span class="ident" id="4024182">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4024189">cfg</span><span class="op" id="4024192">.</span><span class="ident" id="4024193">mu</span><span class="op" id="4024195">.</span><span class="ident" id="4024196">Unlock</span><span class="op" id="4024202">(</span><span class="op" id="4024203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4024207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4024210">}</span><span class="op" id="4024211">(</span><span class="op" id="4024212">)</span><br>
<span class="lineno">270</span><span class="op" id="4024214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4024217">func</span>&nbsp;<span class="ident" id="4024222">lookup</span><span class="op" id="4024228">(</span><span class="ident" id="4024229">name</span>&nbsp;<span class="builtintype" id="4024234">string</span><span class="op" id="4024240">,</span>&nbsp;<span class="ident" id="4024242">qtype</span>&nbsp;<span class="builtintype" id="4024248">uint16</span><span class="op" id="4024254">)</span>&nbsp;<span class="op" id="4024256">(</span><span class="ident" id="4024257">cname</span>&nbsp;<span class="builtintype" id="4024263">string</span><span class="op" id="4024269">,</span>&nbsp;<span class="ident" id="4024271">addrs</span>&nbsp;<span class="op" id="4024277">[</span><span class="op" id="4024278">]</span><span class="ident" id="4024279">dnsRR</span><span class="op" id="4024284">,</span>&nbsp;<span class="ident" id="4024286">err</span>&nbsp;<span class="builtintype" id="4024290">error</span><span class="op" id="4024295">)</span>&nbsp;<span class="op" id="4024297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4024300">if</span>&nbsp;<span class="op" id="4024303">!</span><span class="ident" id="4024304">isDomainName</span><span class="op" id="4024316">(</span><span class="ident" id="4024317">name</span><span class="op" id="4024321">)</span>&nbsp;<span class="op" id="4024323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4024327">return</span>&nbsp;<span class="ident" id="4024334">name</span><span class="op" id="4024338">,</span>&nbsp;<span class="ident" id="4024340">nil</span><span class="op" id="4024343">,</span>&nbsp;<span class="op" id="4024345">&amp;</span><span class="ident" id="4024346">DNSError</span><span class="op" id="4024354">{</span><span class="ident" id="4024355">Err</span><span class="op" id="4024358">:</span>&nbsp;<span class="string" id="4024360">&#34;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="4024381">,</span>&nbsp;<span class="ident" id="4024383">Name</span><span class="op" id="4024387">:</span>&nbsp;<span class="ident" id="4024389">name</span><span class="op" id="4024393">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4024396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4024399">onceLoadConfig</span><span class="op" id="4024413">.</span><span class="ident" id="4024414">Do</span><span class="op" id="4024416">(</span><span class="ident" id="4024417">loadDefaultConfig</span><span class="op" id="4024434">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4024438">select</span>&nbsp;<span class="op" id="4024445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4024448">case</span>&nbsp;<span class="ident" id="4024453">cfg</span><span class="op" id="4024456">.</span><span class="ident" id="4024457">ch</span>&nbsp;<span class="op" id="4024460">&lt;-</span>&nbsp;<span class="keyword" id="4024463">struct</span><span class="op" id="4024469">{</span><span class="op" id="4024470">}</span><span class="op" id="4024471">{</span><span class="op" id="4024472">}</span><span class="op" id="4024473">:</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4024476">default</span><span class="op" id="4024483">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4024486">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4024490">cfg</span><span class="op" id="4024493">.</span><span class="ident" id="4024494">mu</span><span class="op" id="4024496">.</span><span class="ident" id="4024497">RLock</span><span class="op" id="4024502">(</span><span class="op" id="4024503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4024506">defer</span>&nbsp;<span class="ident" id="4024512">cfg</span><span class="op" id="4024515">.</span><span class="ident" id="4024516">mu</span><span class="op" id="4024518">.</span><span class="ident" id="4024519">RUnlock</span><span class="op" id="4024526">(</span><span class="op" id="4024527">)</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4024531">if</span>&nbsp;<span class="ident" id="4024534">cfg</span><span class="op" id="4024537">.</span><span class="ident" id="4024538">dnserr</span>&nbsp;<span class="op" id="4024545">!=</span>&nbsp;<span class="ident" id="4024548">nil</span>&nbsp;<span class="op" id="4024552">||</span>&nbsp;<span class="ident" id="4024555">cfg</span><span class="op" id="4024558">.</span><span class="ident" id="4024559">dnsConfig</span>&nbsp;<span class="op" id="4024569">==</span>&nbsp;<span class="ident" id="4024572">nil</span>&nbsp;<span class="op" id="4024576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4024580">err</span>&nbsp;<span class="op" id="4024584">=</span>&nbsp;<span class="ident" id="4024586">cfg</span><span class="op" id="4024589">.</span><span class="ident" id="4024590">dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4024599">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4024607">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4024610">//&nbsp;If&nbsp;name&nbsp;is&nbsp;rooted&nbsp;(trailing&nbsp;dot)&nbsp;or&nbsp;has&nbsp;enough&nbsp;dots,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4024667">//&nbsp;try&nbsp;it&nbsp;by&nbsp;itself&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4024695">rooted</span>&nbsp;<span class="op" id="4024702">:=</span>&nbsp;<span class="builtinfunc" id="4024705">len</span><span class="op" id="4024708">(</span><span class="ident" id="4024709">name</span><span class="op" id="4024713">)</span>&nbsp;<span class="op" id="4024715">&gt;</span>&nbsp;<span class="num" id="4024717">0</span>&nbsp;<span class="op" id="4024719">&amp;&amp;</span>&nbsp;<span class="ident" id="4024722">name</span><span class="op" id="4024726">[</span><span class="builtinfunc" id="4024727">len</span><span class="op" id="4024730">(</span><span class="ident" id="4024731">name</span><span class="op" id="4024735">)</span><span class="op" id="4024736">-</span><span class="num" id="4024737">1</span><span class="op" id="4024738">]</span>&nbsp;<span class="op" id="4024740">==</span>&nbsp;<span class="string" id="4024743">&#39;.&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4024748">if</span>&nbsp;<span class="ident" id="4024751">rooted</span>&nbsp;<span class="op" id="4024758">||</span>&nbsp;<span class="ident" id="4024761">count</span><span class="op" id="4024766">(</span><span class="ident" id="4024767">name</span><span class="op" id="4024771">,</span>&nbsp;<span class="string" id="4024773">&#39;.&#39;</span><span class="op" id="4024776">)</span>&nbsp;<span class="op" id="4024778">&gt;=</span>&nbsp;<span class="ident" id="4024781">cfg</span><span class="op" id="4024784">.</span><span class="ident" id="4024785">dnsConfig</span><span class="op" id="4024794">.</span><span class="ident" id="4024795">ndots</span>&nbsp;<span class="op" id="4024801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4024805">rname</span>&nbsp;<span class="op" id="4024811">:=</span>&nbsp;<span class="ident" id="4024814">name</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4024821">if</span>&nbsp;<span class="op" id="4024824">!</span><span class="ident" id="4024825">rooted</span>&nbsp;<span class="op" id="4024832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4024837">rname</span>&nbsp;<span class="op" id="4024843">+=</span>&nbsp;<span class="string" id="4024846">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4024852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4024856">//&nbsp;Can&nbsp;try&nbsp;as&nbsp;ordinary&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4024887">cname</span><span class="op" id="4024892">,</span>&nbsp;<span class="ident" id="4024894">addrs</span><span class="op" id="4024899">,</span>&nbsp;<span class="ident" id="4024901">err</span>&nbsp;<span class="op" id="4024905">=</span>&nbsp;<span class="ident" id="4024907">tryOneName</span><span class="op" id="4024917">(</span><span class="ident" id="4024918">cfg</span><span class="op" id="4024921">.</span><span class="ident" id="4024922">dnsConfig</span><span class="op" id="4024931">,</span>&nbsp;<span class="ident" id="4024933">rname</span><span class="op" id="4024938">,</span>&nbsp;<span class="ident" id="4024940">qtype</span><span class="op" id="4024945">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4024949">if</span>&nbsp;<span class="ident" id="4024952">rooted</span>&nbsp;<span class="op" id="4024959">||</span>&nbsp;<span class="ident" id="4024962">err</span>&nbsp;<span class="op" id="4024966">==</span>&nbsp;<span class="ident" id="4024969">nil</span>&nbsp;<span class="op" id="4024973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4024978">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4024987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4024990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4024994">//&nbsp;Otherwise,&nbsp;try&nbsp;suffixes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4025023">for</span>&nbsp;<span class="ident" id="4025027">i</span>&nbsp;<span class="op" id="4025029">:=</span>&nbsp;<span class="num" id="4025032">0</span><span class="op" id="4025033">;</span>&nbsp;<span class="ident" id="4025035">i</span>&nbsp;<span class="op" id="4025037">&lt;</span>&nbsp;<span class="builtinfunc" id="4025039">len</span><span class="op" id="4025042">(</span><span class="ident" id="4025043">cfg</span><span class="op" id="4025046">.</span><span class="ident" id="4025047">dnsConfig</span><span class="op" id="4025056">.</span><span class="ident" id="4025057">search</span><span class="op" id="4025063">)</span><span class="op" id="4025064">;</span>&nbsp;<span class="ident" id="4025066">i</span><span class="op" id="4025067">++</span>&nbsp;<span class="op" id="4025070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4025074">rname</span>&nbsp;<span class="op" id="4025080">:=</span>&nbsp;<span class="ident" id="4025083">name</span>&nbsp;<span class="op" id="4025088">+</span>&nbsp;<span class="string" id="4025090">&#34;.&#34;</span>&nbsp;<span class="op" id="4025094">+</span>&nbsp;<span class="ident" id="4025096">cfg</span><span class="op" id="4025099">.</span><span class="ident" id="4025100">dnsConfig</span><span class="op" id="4025109">.</span><span class="ident" id="4025110">search</span><span class="op" id="4025116">[</span><span class="ident" id="4025117">i</span><span class="op" id="4025118">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4025122">if</span>&nbsp;<span class="ident" id="4025125">rname</span><span class="op" id="4025130">[</span><span class="builtinfunc" id="4025131">len</span><span class="op" id="4025134">(</span><span class="ident" id="4025135">rname</span><span class="op" id="4025140">)</span><span class="op" id="4025141">-</span><span class="num" id="4025142">1</span><span class="op" id="4025143">]</span>&nbsp;<span class="op" id="4025145">!=</span>&nbsp;<span class="string" id="4025148">&#39;.&#39;</span>&nbsp;<span class="op" id="4025152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4025157">rname</span>&nbsp;<span class="op" id="4025163">+=</span>&nbsp;<span class="string" id="4025166">&#34;.&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4025172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4025176">cname</span><span class="op" id="4025181">,</span>&nbsp;<span class="ident" id="4025183">addrs</span><span class="op" id="4025188">,</span>&nbsp;<span class="ident" id="4025190">err</span>&nbsp;<span class="op" id="4025194">=</span>&nbsp;<span class="ident" id="4025196">tryOneName</span><span class="op" id="4025206">(</span><span class="ident" id="4025207">cfg</span><span class="op" id="4025210">.</span><span class="ident" id="4025211">dnsConfig</span><span class="op" id="4025220">,</span>&nbsp;<span class="ident" id="4025222">rname</span><span class="op" id="4025227">,</span>&nbsp;<span class="ident" id="4025229">qtype</span><span class="op" id="4025234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4025238">if</span>&nbsp;<span class="ident" id="4025241">err</span>&nbsp;<span class="op" id="4025245">==</span>&nbsp;<span class="ident" id="4025248">nil</span>&nbsp;<span class="op" id="4025252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4025257">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4025266">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4025269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4025273">//&nbsp;Last&nbsp;ditch&nbsp;effort:&nbsp;try&nbsp;unsuffixed&nbsp;only&nbsp;if&nbsp;we&nbsp;haven&#39;t&nbsp;already,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4025339">//&nbsp;that&nbsp;is,&nbsp;name&nbsp;is&nbsp;not&nbsp;rooted&nbsp;and&nbsp;has&nbsp;less&nbsp;than&nbsp;ndots&nbsp;dots.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4025401">if</span>&nbsp;<span class="ident" id="4025404">count</span><span class="op" id="4025409">(</span><span class="ident" id="4025410">name</span><span class="op" id="4025414">,</span>&nbsp;<span class="string" id="4025416">&#39;.&#39;</span><span class="op" id="4025419">)</span>&nbsp;<span class="op" id="4025421">&lt;</span>&nbsp;<span class="ident" id="4025423">cfg</span><span class="op" id="4025426">.</span><span class="ident" id="4025427">dnsConfig</span><span class="op" id="4025436">.</span><span class="ident" id="4025437">ndots</span>&nbsp;<span class="op" id="4025443">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4025447">cname</span><span class="op" id="4025452">,</span>&nbsp;<span class="ident" id="4025454">addrs</span><span class="op" id="4025459">,</span>&nbsp;<span class="ident" id="4025461">err</span>&nbsp;<span class="op" id="4025465">=</span>&nbsp;<span class="ident" id="4025467">tryOneName</span><span class="op" id="4025477">(</span><span class="ident" id="4025478">cfg</span><span class="op" id="4025481">.</span><span class="ident" id="4025482">dnsConfig</span><span class="op" id="4025491">,</span>&nbsp;<span class="ident" id="4025493">name</span><span class="op" id="4025497">+</span><span class="string" id="4025498">&#34;.&#34;</span><span class="op" id="4025501">,</span>&nbsp;<span class="ident" id="4025503">qtype</span><span class="op" id="4025508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4025512">if</span>&nbsp;<span class="ident" id="4025515">err</span>&nbsp;<span class="op" id="4025519">==</span>&nbsp;<span class="ident" id="4025522">nil</span>&nbsp;<span class="op" id="4025526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4025531">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4025540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4025543">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4025547">if</span>&nbsp;<span class="ident" id="4025550">e</span><span class="op" id="4025551">,</span>&nbsp;<span class="ident" id="4025553">ok</span>&nbsp;<span class="op" id="4025556">:=</span>&nbsp;<span class="ident" id="4025559">err</span><span class="op" id="4025562">.</span><span class="op" id="4025563">(</span><span class="op" id="4025564">*</span><span class="ident" id="4025565">DNSError</span><span class="op" id="4025573">)</span><span class="op" id="4025574">;</span>&nbsp;<span class="ident" id="4025576">ok</span>&nbsp;<span class="op" id="4025579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4025583">//&nbsp;Show&nbsp;original&nbsp;name&nbsp;passed&nbsp;to&nbsp;lookup,&nbsp;not&nbsp;suffixed&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4025643">//&nbsp;In&nbsp;general&nbsp;we&nbsp;might&nbsp;have&nbsp;tried&nbsp;many&nbsp;suffixes;&nbsp;showing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4025702">//&nbsp;just&nbsp;one&nbsp;is&nbsp;misleading.&nbsp;See&nbsp;also&nbsp;golang.org/issue/6324.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4025763">e</span><span class="op" id="4025764">.</span><span class="ident" id="4025765">Name</span>&nbsp;<span class="op" id="4025770">=</span>&nbsp;<span class="ident" id="4025772">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4025778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4025781">return</span><br>
<span class="lineno"></span><span class="op" id="4025788">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="4025791">//&nbsp;goLookupHost&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupHost.</span><br>
<span class="lineno"></span><span class="comment" id="4025854">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="4025914">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="4025978">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4026039">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">340</span><span class="comment" id="4026102">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="4026114">func</span>&nbsp;<span class="ident" id="4026119">goLookupHost</span><span class="op" id="4026131">(</span><span class="ident" id="4026132">name</span>&nbsp;<span class="builtintype" id="4026137">string</span><span class="op" id="4026143">)</span>&nbsp;<span class="op" id="4026145">(</span><span class="ident" id="4026146">addrs</span>&nbsp;<span class="op" id="4026152">[</span><span class="op" id="4026153">]</span><span class="builtintype" id="4026154">string</span><span class="op" id="4026160">,</span>&nbsp;<span class="ident" id="4026162">err</span>&nbsp;<span class="builtintype" id="4026166">error</span><span class="op" id="4026171">)</span>&nbsp;<span class="op" id="4026173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4026176">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;they&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4026223">addrs</span>&nbsp;<span class="op" id="4026229">=</span>&nbsp;<span class="ident" id="4026231">lookupStaticHost</span><span class="op" id="4026247">(</span><span class="ident" id="4026248">name</span><span class="op" id="4026252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4026255">if</span>&nbsp;<span class="builtinfunc" id="4026258">len</span><span class="op" id="4026261">(</span><span class="ident" id="4026262">addrs</span><span class="op" id="4026267">)</span>&nbsp;<span class="op" id="4026269">&gt;</span>&nbsp;<span class="num" id="4026271">0</span>&nbsp;<span class="op" id="4026273">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4026277">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4026285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4026288">ips</span><span class="op" id="4026291">,</span>&nbsp;<span class="ident" id="4026293">err</span>&nbsp;<span class="op" id="4026297">:=</span>&nbsp;<span class="ident" id="4026300">goLookupIP</span><span class="op" id="4026310">(</span><span class="ident" id="4026311">name</span><span class="op" id="4026315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4026318">if</span>&nbsp;<span class="ident" id="4026321">err</span>&nbsp;<span class="op" id="4026325">!=</span>&nbsp;<span class="ident" id="4026328">nil</span>&nbsp;<span class="op" id="4026332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4026336">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4026344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4026347">addrs</span>&nbsp;<span class="op" id="4026353">=</span>&nbsp;<span class="builtinfunc" id="4026355">make</span><span class="op" id="4026359">(</span><span class="op" id="4026360">[</span><span class="op" id="4026361">]</span><span class="builtintype" id="4026362">string</span><span class="op" id="4026368">,</span>&nbsp;<span class="num" id="4026370">0</span><span class="op" id="4026371">,</span>&nbsp;<span class="builtinfunc" id="4026373">len</span><span class="op" id="4026376">(</span><span class="ident" id="4026377">ips</span><span class="op" id="4026380">)</span><span class="op" id="4026381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4026384">for</span>&nbsp;<span class="ident" id="4026388">_</span><span class="op" id="4026389">,</span>&nbsp;<span class="ident" id="4026391">ip</span>&nbsp;<span class="op" id="4026394">:=</span>&nbsp;<span class="keyword" id="4026397">range</span>&nbsp;<span class="ident" id="4026403">ips</span>&nbsp;<span class="op" id="4026407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4026411">addrs</span>&nbsp;<span class="op" id="4026417">=</span>&nbsp;<span class="builtinfunc" id="4026419">append</span><span class="op" id="4026425">(</span><span class="ident" id="4026426">addrs</span><span class="op" id="4026431">,</span>&nbsp;<span class="ident" id="4026433">ip</span><span class="op" id="4026435">.</span><span class="ident" id="4026436">String</span><span class="op" id="4026442">(</span><span class="op" id="4026443">)</span><span class="op" id="4026444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4026447">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4026450">return</span><br>
<span class="lineno"></span><span class="op" id="4026457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4026460">//&nbsp;goLookupIP&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupIP.</span><br>
<span class="lineno"></span><span class="comment" id="4026519">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno">360</span><span class="comment" id="4026577">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="4026639">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4026700">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="4026763">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="4026775">func</span>&nbsp;<span class="ident" id="4026780">goLookupIP</span><span class="op" id="4026790">(</span><span class="ident" id="4026791">name</span>&nbsp;<span class="builtintype" id="4026796">string</span><span class="op" id="4026802">)</span>&nbsp;<span class="op" id="4026804">(</span><span class="ident" id="4026805">addrs</span>&nbsp;<span class="op" id="4026811">[</span><span class="op" id="4026812">]</span><span class="ident" id="4026813">IP</span><span class="op" id="4026815">,</span>&nbsp;<span class="ident" id="4026817">err</span>&nbsp;<span class="builtintype" id="4026821">error</span><span class="op" id="4026826">)</span>&nbsp;<span class="op" id="4026828">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4026831">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4026876">haddrs</span>&nbsp;<span class="op" id="4026883">:=</span>&nbsp;<span class="ident" id="4026886">lookupStaticHost</span><span class="op" id="4026902">(</span><span class="ident" id="4026903">name</span><span class="op" id="4026907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4026910">if</span>&nbsp;<span class="builtinfunc" id="4026913">len</span><span class="op" id="4026916">(</span><span class="ident" id="4026917">haddrs</span><span class="op" id="4026923">)</span>&nbsp;<span class="op" id="4026925">&gt;</span>&nbsp;<span class="num" id="4026927">0</span>&nbsp;<span class="op" id="4026929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4026933">for</span>&nbsp;<span class="ident" id="4026937">_</span><span class="op" id="4026938">,</span>&nbsp;<span class="ident" id="4026940">haddr</span>&nbsp;<span class="op" id="4026946">:=</span>&nbsp;<span class="keyword" id="4026949">range</span>&nbsp;<span class="ident" id="4026955">haddrs</span>&nbsp;<span class="op" id="4026962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4026967">if</span>&nbsp;<span class="ident" id="4026970">ip</span>&nbsp;<span class="op" id="4026973">:=</span>&nbsp;<span class="ident" id="4026976">ParseIP</span><span class="op" id="4026983">(</span><span class="ident" id="4026984">haddr</span><span class="op" id="4026989">)</span><span class="op" id="4026990">;</span>&nbsp;<span class="ident" id="4026992">ip</span>&nbsp;<span class="op" id="4026995">!=</span>&nbsp;<span class="ident" id="4026998">nil</span>&nbsp;<span class="op" id="4027002">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027008">addrs</span>&nbsp;<span class="op" id="4027014">=</span>&nbsp;<span class="builtinfunc" id="4027016">append</span><span class="op" id="4027022">(</span><span class="ident" id="4027023">addrs</span><span class="op" id="4027028">,</span>&nbsp;<span class="ident" id="4027030">ip</span><span class="op" id="4027032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027045">if</span>&nbsp;<span class="builtinfunc" id="4027048">len</span><span class="op" id="4027051">(</span><span class="ident" id="4027052">addrs</span><span class="op" id="4027057">)</span>&nbsp;<span class="op" id="4027059">&gt;</span>&nbsp;<span class="num" id="4027061">0</span>&nbsp;<span class="op" id="4027063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027068">return</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027083">type</span>&nbsp;<span class="ident" id="4027088">racer</span>&nbsp;<span class="keyword" id="4027094">struct</span>&nbsp;<span class="op" id="4027101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027105">qtype</span>&nbsp;<span class="builtintype" id="4027111">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027120">rrs</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4027126">[</span><span class="op" id="4027127">]</span><span class="ident" id="4027128">dnsRR</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4027136">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027146">lane</span>&nbsp;<span class="op" id="4027151">:=</span>&nbsp;<span class="builtinfunc" id="4027154">make</span><span class="op" id="4027158">(</span><span class="keyword" id="4027159">chan</span>&nbsp;<span class="ident" id="4027164">racer</span><span class="op" id="4027169">,</span>&nbsp;<span class="num" id="4027171">1</span><span class="op" id="4027172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027175">qtypes</span>&nbsp;<span class="op" id="4027182">:=</span>&nbsp;<span class="op" id="4027185">[</span><span class="op" id="4027186">...</span><span class="op" id="4027189">]</span><span class="builtintype" id="4027190">uint16</span><span class="op" id="4027196">{</span><span class="ident" id="4027197">dnsTypeA</span><span class="op" id="4027205">,</span>&nbsp;<span class="ident" id="4027207">dnsTypeAAAA</span><span class="op" id="4027218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027221">for</span>&nbsp;<span class="ident" id="4027225">_</span><span class="op" id="4027226">,</span>&nbsp;<span class="ident" id="4027228">qtype</span>&nbsp;<span class="op" id="4027234">:=</span>&nbsp;<span class="keyword" id="4027237">range</span>&nbsp;<span class="ident" id="4027243">qtypes</span>&nbsp;<span class="op" id="4027250">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027254">go</span>&nbsp;<span class="keyword" id="4027257">func</span><span class="op" id="4027261">(</span><span class="ident" id="4027262">qtype</span>&nbsp;<span class="builtintype" id="4027268">uint16</span><span class="op" id="4027274">)</span>&nbsp;<span class="op" id="4027276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027281">_</span><span class="op" id="4027282">,</span>&nbsp;<span class="ident" id="4027284">rrs</span><span class="op" id="4027287">,</span>&nbsp;<span class="ident" id="4027289">err</span>&nbsp;<span class="op" id="4027293">:=</span>&nbsp;<span class="ident" id="4027296">lookup</span><span class="op" id="4027302">(</span><span class="ident" id="4027303">name</span><span class="op" id="4027307">,</span>&nbsp;<span class="ident" id="4027309">qtype</span><span class="op" id="4027314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027319">lane</span>&nbsp;<span class="op" id="4027324">&lt;-</span>&nbsp;<span class="ident" id="4027327">racer</span><span class="op" id="4027332">{</span><span class="ident" id="4027333">qtype</span><span class="op" id="4027338">,</span>&nbsp;<span class="ident" id="4027340">rrs</span><span class="op" id="4027343">,</span>&nbsp;<span class="ident" id="4027345">err</span><span class="op" id="4027348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027352">}</span><span class="op" id="4027353">(</span><span class="ident" id="4027354">qtype</span><span class="op" id="4027359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027362">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027365">var</span>&nbsp;<span class="ident" id="4027369">lastErr</span>&nbsp;<span class="builtintype" id="4027377">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027384">for</span>&nbsp;<span class="keyword" id="4027388">range</span>&nbsp;<span class="ident" id="4027394">qtypes</span>&nbsp;<span class="op" id="4027401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027405">racer</span>&nbsp;<span class="op" id="4027411">:=</span>&nbsp;<span class="op" id="4027414">&lt;-</span><span class="ident" id="4027416">lane</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027423">if</span>&nbsp;<span class="ident" id="4027426">racer</span><span class="op" id="4027431">.</span><span class="builtintype" id="4027432">error</span>&nbsp;<span class="op" id="4027438">!=</span>&nbsp;<span class="ident" id="4027441">nil</span>&nbsp;<span class="op" id="4027445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027450">lastErr</span>&nbsp;<span class="op" id="4027458">=</span>&nbsp;<span class="ident" id="4027460">racer</span><span class="op" id="4027465">.</span><span class="builtintype" id="4027466">error</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027475">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027490">switch</span>&nbsp;<span class="ident" id="4027497">racer</span><span class="op" id="4027502">.</span><span class="ident" id="4027503">qtype</span>&nbsp;<span class="op" id="4027509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027513">case</span>&nbsp;<span class="ident" id="4027518">dnsTypeA</span><span class="op" id="4027526">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027531">addrs</span>&nbsp;<span class="op" id="4027537">=</span>&nbsp;<span class="builtinfunc" id="4027539">append</span><span class="op" id="4027545">(</span><span class="ident" id="4027546">addrs</span><span class="op" id="4027551">,</span>&nbsp;<span class="ident" id="4027553">convertRR_A</span><span class="op" id="4027564">(</span><span class="ident" id="4027565">racer</span><span class="op" id="4027570">.</span><span class="ident" id="4027571">rrs</span><span class="op" id="4027574">)</span><span class="op" id="4027575">...</span><span class="op" id="4027578">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027582">case</span>&nbsp;<span class="ident" id="4027587">dnsTypeAAAA</span><span class="op" id="4027598">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4027603">addrs</span>&nbsp;<span class="op" id="4027609">=</span>&nbsp;<span class="builtinfunc" id="4027611">append</span><span class="op" id="4027617">(</span><span class="ident" id="4027618">addrs</span><span class="op" id="4027623">,</span>&nbsp;<span class="ident" id="4027625">convertRR_AAAA</span><span class="op" id="4027639">(</span><span class="ident" id="4027640">racer</span><span class="op" id="4027645">.</span><span class="ident" id="4027646">rrs</span><span class="op" id="4027649">)</span><span class="op" id="4027650">...</span><span class="op" id="4027653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027663">if</span>&nbsp;<span class="builtinfunc" id="4027666">len</span><span class="op" id="4027669">(</span><span class="ident" id="4027670">addrs</span><span class="op" id="4027675">)</span>&nbsp;<span class="op" id="4027677">==</span>&nbsp;<span class="num" id="4027680">0</span>&nbsp;<span class="op" id="4027682">&amp;&amp;</span>&nbsp;<span class="ident" id="4027685">lastErr</span>&nbsp;<span class="op" id="4027693">!=</span>&nbsp;<span class="ident" id="4027696">nil</span>&nbsp;<span class="op" id="4027700">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027704">return</span>&nbsp;<span class="ident" id="4027711">nil</span><span class="op" id="4027714">,</span>&nbsp;<span class="ident" id="4027716">lastErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4027725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4027728">return</span>&nbsp;<span class="ident" id="4027735">addrs</span><span class="op" id="4027740">,</span>&nbsp;<span class="ident" id="4027742">nil</span><br>
<span class="lineno"></span><span class="op" id="4027746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="4027749">//&nbsp;goLookupCNAME&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupCNAME.</span><br>
<span class="lineno"></span><span class="comment" id="4027814">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="4027875">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="4027940">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4028001">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">415</span><span class="comment" id="4028064">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="4028076">func</span>&nbsp;<span class="ident" id="4028081">goLookupCNAME</span><span class="op" id="4028094">(</span><span class="ident" id="4028095">name</span>&nbsp;<span class="builtintype" id="4028100">string</span><span class="op" id="4028106">)</span>&nbsp;<span class="op" id="4028108">(</span><span class="ident" id="4028109">cname</span>&nbsp;<span class="builtintype" id="4028115">string</span><span class="op" id="4028121">,</span>&nbsp;<span class="ident" id="4028123">err</span>&nbsp;<span class="builtintype" id="4028127">error</span><span class="op" id="4028132">)</span>&nbsp;<span class="op" id="4028134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4028137">_</span><span class="op" id="4028138">,</span>&nbsp;<span class="ident" id="4028140">rr</span><span class="op" id="4028142">,</span>&nbsp;<span class="ident" id="4028144">err</span>&nbsp;<span class="op" id="4028148">:=</span>&nbsp;<span class="ident" id="4028151">lookup</span><span class="op" id="4028157">(</span><span class="ident" id="4028158">name</span><span class="op" id="4028162">,</span>&nbsp;<span class="ident" id="4028164">dnsTypeCNAME</span><span class="op" id="4028176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028179">if</span>&nbsp;<span class="ident" id="4028182">err</span>&nbsp;<span class="op" id="4028186">!=</span>&nbsp;<span class="ident" id="4028189">nil</span>&nbsp;<span class="op" id="4028193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028197">return</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4028205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4028208">cname</span>&nbsp;<span class="op" id="4028214">=</span>&nbsp;<span class="ident" id="4028216">rr</span><span class="op" id="4028218">[</span><span class="num" id="4028219">0</span><span class="op" id="4028220">]</span><span class="op" id="4028221">.</span><span class="op" id="4028222">(</span><span class="op" id="4028223">*</span><span class="ident" id="4028224">dnsRR_CNAME</span><span class="op" id="4028235">)</span><span class="op" id="4028236">.</span><span class="ident" id="4028237">Cname</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4028244">return</span><br>
<span class="lineno"></span><span class="op" id="4028251">}</span>
</div>
</body>
</html>
