<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/textproto</h2>
<ul>
<li><a href="/gostd/net/textproto/header.go.html">header.go</a></li>
<li><a href="/gostd/net/textproto/pipeline.go.html">pipeline.go</a></li>
<li><a href="/gostd/net/textproto/reader.go.html">reader.go</a></li>
<li><a href="/gostd/net/textproto/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/net/textproto/textproto.go.html">textproto.go</a></li>
<li><a href="/gostd/net/textproto/writer.go.html">writer.go</a></li>
<li><a href="/gostd/net/textproto/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3844632">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3844688">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3844742">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3844793">package</span>&nbsp;<span class="ident" id="3844801">textproto</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3844812">import</span>&nbsp;<span class="op" id="3844819">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3844822">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="3844829">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="3844832">//&nbsp;A&nbsp;Pipeline&nbsp;manages&nbsp;a&nbsp;pipelined&nbsp;in-order&nbsp;request/response&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="comment" id="3844902">//</span><br>
<span class="lineno"></span><span class="comment" id="3844905">//&nbsp;To&nbsp;use&nbsp;a&nbsp;Pipeline&nbsp;p&nbsp;to&nbsp;manage&nbsp;multiple&nbsp;clients&nbsp;on&nbsp;a&nbsp;connection,</span><br>
<span class="lineno"></span><span class="comment" id="3844972">//&nbsp;each&nbsp;client&nbsp;should&nbsp;run:</span><br>
<span class="lineno">15</span><span class="comment" id="3844999">//</span><br>
<span class="lineno"></span><span class="comment" id="3845002">//&nbsp;&nbsp;&nbsp;&nbspid&nbsp;:=&nbsp;p.Next()&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;take&nbsp;a&nbsp;number</span><br>
<span class="lineno"></span><span class="comment" id="3845037">//</span><br>
<span class="lineno"></span><span class="comment" id="3845040">//&nbsp;&nbsp;&nbsp;&nbspp.StartRequest(id)&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;wait&nbsp;for&nbsp;turn&nbsp;to&nbsp;send&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="3845095">//&nbsp;&nbsp;&nbsp;&nbsp«send&nbsp;request»</span><br>
<span class="lineno">20</span><span class="comment" id="3845115">//&nbsp;&nbsp;&nbsp;&nbspp.EndRequest(id)&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;notify&nbsp;Pipeline&nbsp;that&nbsp;request&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span><span class="comment" id="3845175">//</span><br>
<span class="lineno"></span><span class="comment" id="3845178">//&nbsp;&nbsp;&nbsp;&nbspp.StartResponse(id)&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;wait&nbsp;for&nbsp;turn&nbsp;to&nbsp;read&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="3845235">//&nbsp;&nbsp;&nbsp;&nbsp«read&nbsp;response»</span><br>
<span class="lineno"></span><span class="comment" id="3845256">//&nbsp;&nbsp;&nbsp;&nbspp.EndResponse(id)&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;notify&nbsp;Pipeline&nbsp;that&nbsp;response&nbsp;is&nbsp;read</span><br>
<span class="lineno">25</span><span class="comment" id="3845318">//</span><br>
<span class="lineno"></span><span class="comment" id="3845321">//&nbsp;A&nbsp;pipelined&nbsp;server&nbsp;can&nbsp;use&nbsp;the&nbsp;same&nbsp;calls&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3845381">//&nbsp;responses&nbsp;computed&nbsp;in&nbsp;parallel&nbsp;are&nbsp;written&nbsp;in&nbsp;the&nbsp;correct&nbsp;order.</span><br>
<span class="lineno"></span><span class="keyword" id="3845449">type</span>&nbsp;<span class="ident" id="3845454">Pipeline</span>&nbsp;<span class="keyword" id="3845463">struct</span>&nbsp;<span class="op" id="3845470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845473">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3845482">sync</span><span class="op" id="3845486">.</span><span class="ident" id="3845487">Mutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845494">id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3845503">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845509">request</span>&nbsp;&nbsp;<span class="ident" id="3845518">sequencer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845529">response</span>&nbsp;<span class="ident" id="3845538">sequencer</span><br>
<span class="lineno"></span><span class="op" id="3845548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="3845551">//&nbsp;Next&nbsp;returns&nbsp;the&nbsp;next&nbsp;id&nbsp;for&nbsp;a&nbsp;request/response&nbsp;pair.</span><br>
<span class="lineno"></span><span class="keyword" id="3845608">func</span>&nbsp;<span class="op" id="3845613">(</span><span class="ident" id="3845614">p</span>&nbsp;<span class="op" id="3845616">*</span><span class="ident" id="3845617">Pipeline</span><span class="op" id="3845625">)</span>&nbsp;<span class="ident" id="3845627">Next</span><span class="op" id="3845631">(</span><span class="op" id="3845632">)</span>&nbsp;<span class="builtintype" id="3845634">uint</span>&nbsp;<span class="op" id="3845639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845642">p</span><span class="op" id="3845643">.</span><span class="ident" id="3845644">mu</span><span class="op" id="3845646">.</span><span class="ident" id="3845647">Lock</span><span class="op" id="3845651">(</span><span class="op" id="3845652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845655">id</span>&nbsp;<span class="op" id="3845658">:=</span>&nbsp;<span class="ident" id="3845661">p</span><span class="op" id="3845662">.</span><span class="ident" id="3845663">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845667">p</span><span class="op" id="3845668">.</span><span class="ident" id="3845669">id</span><span class="op" id="3845671">++</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845675">p</span><span class="op" id="3845676">.</span><span class="ident" id="3845677">mu</span><span class="op" id="3845679">.</span><span class="ident" id="3845680">Unlock</span><span class="op" id="3845686">(</span><span class="op" id="3845687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845690">return</span>&nbsp;<span class="ident" id="3845697">id</span><br>
<span class="lineno"></span><span class="op" id="3845700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3845703">//&nbsp;StartRequest&nbsp;blocks&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;to&nbsp;send&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;receive)</span><br>
<span class="lineno">45</span><span class="comment" id="3845786">//&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id.</span><br>
<span class="lineno"></span><span class="keyword" id="3845820">func</span>&nbsp;<span class="op" id="3845825">(</span><span class="ident" id="3845826">p</span>&nbsp;<span class="op" id="3845828">*</span><span class="ident" id="3845829">Pipeline</span><span class="op" id="3845837">)</span>&nbsp;<span class="ident" id="3845839">StartRequest</span><span class="op" id="3845851">(</span><span class="ident" id="3845852">id</span>&nbsp;<span class="builtintype" id="3845855">uint</span><span class="op" id="3845859">)</span>&nbsp;<span class="op" id="3845861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845864">p</span><span class="op" id="3845865">.</span><span class="ident" id="3845866">request</span><span class="op" id="3845873">.</span><span class="ident" id="3845874">Start</span><span class="op" id="3845879">(</span><span class="ident" id="3845880">id</span><span class="op" id="3845882">)</span><br>
<span class="lineno"></span><span class="op" id="3845884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="3845887">//&nbsp;EndRequest&nbsp;notifies&nbsp;p&nbsp;that&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;has&nbsp;been&nbsp;sent</span><br>
<span class="lineno"></span><span class="comment" id="3845961">//&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;received).</span><br>
<span class="lineno"></span><span class="keyword" id="3846001">func</span>&nbsp;<span class="op" id="3846006">(</span><span class="ident" id="3846007">p</span>&nbsp;<span class="op" id="3846009">*</span><span class="ident" id="3846010">Pipeline</span><span class="op" id="3846018">)</span>&nbsp;<span class="ident" id="3846020">EndRequest</span><span class="op" id="3846030">(</span><span class="ident" id="3846031">id</span>&nbsp;<span class="builtintype" id="3846034">uint</span><span class="op" id="3846038">)</span>&nbsp;<span class="op" id="3846040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846043">p</span><span class="op" id="3846044">.</span><span class="ident" id="3846045">request</span><span class="op" id="3846052">.</span><span class="ident" id="3846053">End</span><span class="op" id="3846056">(</span><span class="ident" id="3846057">id</span><span class="op" id="3846059">)</span><br>
<span class="lineno"></span><span class="op" id="3846061">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="comment" id="3846064">//&nbsp;StartResponse&nbsp;blocks&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;to&nbsp;receive&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;send)</span><br>
<span class="lineno"></span><span class="comment" id="3846148">//&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;given&nbsp;id.</span><br>
<span class="lineno"></span><span class="keyword" id="3846182">func</span>&nbsp;<span class="op" id="3846187">(</span><span class="ident" id="3846188">p</span>&nbsp;<span class="op" id="3846190">*</span><span class="ident" id="3846191">Pipeline</span><span class="op" id="3846199">)</span>&nbsp;<span class="ident" id="3846201">StartResponse</span><span class="op" id="3846214">(</span><span class="ident" id="3846215">id</span>&nbsp;<span class="builtintype" id="3846218">uint</span><span class="op" id="3846222">)</span>&nbsp;<span class="op" id="3846224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846227">p</span><span class="op" id="3846228">.</span><span class="ident" id="3846229">response</span><span class="op" id="3846237">.</span><span class="ident" id="3846238">Start</span><span class="op" id="3846243">(</span><span class="ident" id="3846244">id</span><span class="op" id="3846246">)</span><br>
<span class="lineno">60</span><span class="op" id="3846248">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3846251">//&nbsp;EndResponse&nbsp;notifies&nbsp;p&nbsp;that&nbsp;the&nbsp;response&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;has&nbsp;been&nbsp;received</span><br>
<span class="lineno"></span><span class="comment" id="3846331">//&nbsp;(or,&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;server,&nbsp;sent).</span><br>
<span class="lineno"></span><span class="keyword" id="3846367">func</span>&nbsp;<span class="op" id="3846372">(</span><span class="ident" id="3846373">p</span>&nbsp;<span class="op" id="3846375">*</span><span class="ident" id="3846376">Pipeline</span><span class="op" id="3846384">)</span>&nbsp;<span class="ident" id="3846386">EndResponse</span><span class="op" id="3846397">(</span><span class="ident" id="3846398">id</span>&nbsp;<span class="builtintype" id="3846401">uint</span><span class="op" id="3846405">)</span>&nbsp;<span class="op" id="3846407">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846410">p</span><span class="op" id="3846411">.</span><span class="ident" id="3846412">response</span><span class="op" id="3846420">.</span><span class="ident" id="3846421">End</span><span class="op" id="3846424">(</span><span class="ident" id="3846425">id</span><span class="op" id="3846427">)</span><br>
<span class="lineno"></span><span class="op" id="3846429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3846432">//&nbsp;A&nbsp;sequencer&nbsp;schedules&nbsp;a&nbsp;sequence&nbsp;of&nbsp;numbered&nbsp;events&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="3846497">//&nbsp;happen&nbsp;in&nbsp;order,&nbsp;one&nbsp;after&nbsp;the&nbsp;other.&nbsp;&nbsp;The&nbsp;event&nbsp;numbering&nbsp;must&nbsp;start</span><br>
<span class="lineno">70</span><span class="comment" id="3846570">//&nbsp;at&nbsp;0&nbsp;and&nbsp;increment&nbsp;without&nbsp;skipping.&nbsp;&nbsp;The&nbsp;event&nbsp;number&nbsp;wraps&nbsp;around</span><br>
<span class="lineno"></span><span class="comment" id="3846641">//&nbsp;safely&nbsp;as&nbsp;long&nbsp;as&nbsp;there&nbsp;are&nbsp;not&nbsp;2^32&nbsp;simultaneous&nbsp;events&nbsp;pending.</span><br>
<span class="lineno"></span><span class="keyword" id="3846710">type</span>&nbsp;<span class="ident" id="3846715">sequencer</span>&nbsp;<span class="keyword" id="3846725">struct</span>&nbsp;<span class="op" id="3846732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846735">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3846740">sync</span><span class="op" id="3846744">.</span><span class="ident" id="3846745">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846752">id</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3846757">uint</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846763">wait</span>&nbsp;<span class="keyword" id="3846768">map</span><span class="op" id="3846771">[</span><span class="builtintype" id="3846772">uint</span><span class="op" id="3846776">]</span><span class="keyword" id="3846777">chan</span>&nbsp;<span class="builtintype" id="3846782">uint</span><br>
<span class="lineno"></span><span class="op" id="3846787">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3846790">//&nbsp;Start&nbsp;waits&nbsp;until&nbsp;it&nbsp;is&nbsp;time&nbsp;for&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id&nbsp;to&nbsp;begin.</span><br>
<span class="lineno"></span><span class="comment" id="3846858">//&nbsp;That&nbsp;is,&nbsp;except&nbsp;for&nbsp;the&nbsp;first&nbsp;event,&nbsp;it&nbsp;waits&nbsp;until&nbsp;End(id-1)&nbsp;has</span><br>
<span class="lineno">80</span><span class="comment" id="3846927">//&nbsp;been&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="3846943">func</span>&nbsp;<span class="op" id="3846948">(</span><span class="ident" id="3846949">s</span>&nbsp;<span class="op" id="3846951">*</span><span class="ident" id="3846952">sequencer</span><span class="op" id="3846961">)</span>&nbsp;<span class="ident" id="3846963">Start</span><span class="op" id="3846968">(</span><span class="ident" id="3846969">id</span>&nbsp;<span class="builtintype" id="3846972">uint</span><span class="op" id="3846976">)</span>&nbsp;<span class="op" id="3846978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846981">s</span><span class="op" id="3846982">.</span><span class="ident" id="3846983">mu</span><span class="op" id="3846985">.</span><span class="ident" id="3846986">Lock</span><span class="op" id="3846990">(</span><span class="op" id="3846991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3846994">if</span>&nbsp;<span class="ident" id="3846997">s</span><span class="op" id="3846998">.</span><span class="ident" id="3846999">id</span>&nbsp;<span class="op" id="3847002">==</span>&nbsp;<span class="ident" id="3847005">id</span>&nbsp;<span class="op" id="3847008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847012">s</span><span class="op" id="3847013">.</span><span class="ident" id="3847014">mu</span><span class="op" id="3847016">.</span><span class="ident" id="3847017">Unlock</span><span class="op" id="3847023">(</span><span class="op" id="3847024">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847028">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3847036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847039">c</span>&nbsp;<span class="op" id="3847041">:=</span>&nbsp;<span class="builtinfunc" id="3847044">make</span><span class="op" id="3847048">(</span><span class="keyword" id="3847049">chan</span>&nbsp;<span class="builtintype" id="3847054">uint</span><span class="op" id="3847058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847061">if</span>&nbsp;<span class="ident" id="3847064">s</span><span class="op" id="3847065">.</span><span class="ident" id="3847066">wait</span>&nbsp;<span class="op" id="3847071">==</span>&nbsp;<span class="ident" id="3847074">nil</span>&nbsp;<span class="op" id="3847078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847082">s</span><span class="op" id="3847083">.</span><span class="ident" id="3847084">wait</span>&nbsp;<span class="op" id="3847089">=</span>&nbsp;<span class="builtinfunc" id="3847091">make</span><span class="op" id="3847095">(</span><span class="keyword" id="3847096">map</span><span class="op" id="3847099">[</span><span class="builtintype" id="3847100">uint</span><span class="op" id="3847104">]</span><span class="keyword" id="3847105">chan</span>&nbsp;<span class="builtintype" id="3847110">uint</span><span class="op" id="3847114">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3847117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847120">s</span><span class="op" id="3847121">.</span><span class="ident" id="3847122">wait</span><span class="op" id="3847126">[</span><span class="ident" id="3847127">id</span><span class="op" id="3847129">]</span>&nbsp;<span class="op" id="3847131">=</span>&nbsp;<span class="ident" id="3847133">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847136">s</span><span class="op" id="3847137">.</span><span class="ident" id="3847138">mu</span><span class="op" id="3847140">.</span><span class="ident" id="3847141">Unlock</span><span class="op" id="3847147">(</span><span class="op" id="3847148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3847151">&lt;-</span><span class="ident" id="3847153">c</span><br>
<span class="lineno"></span><span class="op" id="3847155">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="3847158">//&nbsp;End&nbsp;notifies&nbsp;the&nbsp;sequencer&nbsp;that&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id&nbsp;has&nbsp;completed,</span><br>
<span class="lineno"></span><span class="comment" id="3847230">//&nbsp;allowing&nbsp;it&nbsp;to&nbsp;schedule&nbsp;the&nbsp;event&nbsp;numbered&nbsp;id+1.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="3847306">//&nbsp;to&nbsp;call&nbsp;End&nbsp;with&nbsp;an&nbsp;id&nbsp;that&nbsp;is&nbsp;not&nbsp;the&nbsp;number&nbsp;of&nbsp;the&nbsp;active&nbsp;event.</span><br>
<span class="lineno"></span><span class="keyword" id="3847376">func</span>&nbsp;<span class="op" id="3847381">(</span><span class="ident" id="3847382">s</span>&nbsp;<span class="op" id="3847384">*</span><span class="ident" id="3847385">sequencer</span><span class="op" id="3847394">)</span>&nbsp;<span class="ident" id="3847396">End</span><span class="op" id="3847399">(</span><span class="ident" id="3847400">id</span>&nbsp;<span class="builtintype" id="3847403">uint</span><span class="op" id="3847407">)</span>&nbsp;<span class="op" id="3847409">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847412">s</span><span class="op" id="3847413">.</span><span class="ident" id="3847414">mu</span><span class="op" id="3847416">.</span><span class="ident" id="3847417">Lock</span><span class="op" id="3847421">(</span><span class="op" id="3847422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847425">if</span>&nbsp;<span class="ident" id="3847428">s</span><span class="op" id="3847429">.</span><span class="ident" id="3847430">id</span>&nbsp;<span class="op" id="3847433">!=</span>&nbsp;<span class="ident" id="3847436">id</span>&nbsp;<span class="op" id="3847439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3847443">panic</span><span class="op" id="3847448">(</span><span class="string" id="3847449">&#34;out&nbsp;of&nbsp;sync&#34;</span><span class="op" id="3847462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3847465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847468">id</span><span class="op" id="3847470">++</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847474">s</span><span class="op" id="3847475">.</span><span class="ident" id="3847476">id</span>&nbsp;<span class="op" id="3847479">=</span>&nbsp;<span class="ident" id="3847481">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847485">if</span>&nbsp;<span class="ident" id="3847488">s</span><span class="op" id="3847489">.</span><span class="ident" id="3847490">wait</span>&nbsp;<span class="op" id="3847495">==</span>&nbsp;<span class="ident" id="3847498">nil</span>&nbsp;<span class="op" id="3847502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847506">s</span><span class="op" id="3847507">.</span><span class="ident" id="3847508">wait</span>&nbsp;<span class="op" id="3847513">=</span>&nbsp;<span class="builtinfunc" id="3847515">make</span><span class="op" id="3847519">(</span><span class="keyword" id="3847520">map</span><span class="op" id="3847523">[</span><span class="builtintype" id="3847524">uint</span><span class="op" id="3847528">]</span><span class="keyword" id="3847529">chan</span>&nbsp;<span class="builtintype" id="3847534">uint</span><span class="op" id="3847538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3847541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847544">c</span><span class="op" id="3847545">,</span>&nbsp;<span class="ident" id="3847547">ok</span>&nbsp;<span class="op" id="3847550">:=</span>&nbsp;<span class="ident" id="3847553">s</span><span class="op" id="3847554">.</span><span class="ident" id="3847555">wait</span><span class="op" id="3847559">[</span><span class="ident" id="3847560">id</span><span class="op" id="3847562">]</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847565">if</span>&nbsp;<span class="ident" id="3847568">ok</span>&nbsp;<span class="op" id="3847571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3847575">delete</span><span class="op" id="3847581">(</span><span class="ident" id="3847582">s</span><span class="op" id="3847583">.</span><span class="ident" id="3847584">wait</span><span class="op" id="3847588">,</span>&nbsp;<span class="ident" id="3847590">id</span><span class="op" id="3847592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3847595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847598">s</span><span class="op" id="3847599">.</span><span class="ident" id="3847600">mu</span><span class="op" id="3847602">.</span><span class="ident" id="3847603">Unlock</span><span class="op" id="3847609">(</span><span class="op" id="3847610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847613">if</span>&nbsp;<span class="ident" id="3847616">ok</span>&nbsp;<span class="op" id="3847619">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847623">c</span>&nbsp;<span class="op" id="3847625">&lt;-</span>&nbsp;<span class="num" id="3847628">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3847631">}</span><br>
<span class="lineno"></span><span class="op" id="3847633">}</span>
</div>
</body>
</html>
