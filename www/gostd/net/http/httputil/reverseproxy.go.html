<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html" class="current">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6399300">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6399355">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6399409">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6399460">//&nbsp;HTTP&nbsp;reverse&nbsp;proxy&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6399491">package</span>&nbsp;<span class="ident" id="6399499">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6399509">import</span>&nbsp;<span class="op" id="6399516">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6399519">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6399525">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6399532">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6399539">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6399551">&#34;net/url&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6399562">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6399573">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6399581">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6399588">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="6399591">//&nbsp;onExitFlushLoop&nbsp;is&nbsp;a&nbsp;callback&nbsp;set&nbsp;by&nbsp;tests&nbsp;to&nbsp;detect&nbsp;the&nbsp;state&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6399664">//&nbsp;flushLoop()&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="6399690">var</span>&nbsp;<span class="ident" id="6399694">onExitFlushLoop</span>&nbsp;<span class="keyword" id="6399710">func</span><span class="op" id="6399714">(</span><span class="op" id="6399715">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6399718">//&nbsp;ReverseProxy&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;Handler&nbsp;that&nbsp;takes&nbsp;an&nbsp;incoming&nbsp;request&nbsp;and</span><br>
<span class="lineno">25</span><span class="comment" id="6399788">//&nbsp;sends&nbsp;it&nbsp;to&nbsp;another&nbsp;server,&nbsp;proxying&nbsp;the&nbsp;response&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6399853">//&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="6399864">type</span>&nbsp;<span class="ident" id="6399869">ReverseProxy</span>&nbsp;<span class="keyword" id="6399882">struct</span>&nbsp;<span class="op" id="6399889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6399892">//&nbsp;Director&nbsp;must&nbsp;be&nbsp;a&nbsp;function&nbsp;which&nbsp;modifies</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6399939">//&nbsp;the&nbsp;request&nbsp;into&nbsp;a&nbsp;new&nbsp;request&nbsp;to&nbsp;be&nbsp;sent</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6399985">//&nbsp;using&nbsp;Transport.&nbsp;Its&nbsp;response&nbsp;is&nbsp;then&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6400034">//&nbsp;back&nbsp;to&nbsp;the&nbsp;original&nbsp;client&nbsp;unmodified.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400078">Director</span>&nbsp;<span class="keyword" id="6400087">func</span><span class="op" id="6400091">(</span><span class="op" id="6400092">*</span><span class="ident" id="6400093"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399539">http</a></span><span class="op" id="6400097">.</span><span class="ident" id="6400098"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span><span class="op" id="6400105">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6400109">//&nbsp;The&nbsp;transport&nbsp;used&nbsp;to&nbsp;perform&nbsp;proxy&nbsp;requests.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6400159">//&nbsp;If&nbsp;nil,&nbsp;http.DefaultTransport&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400202">Transport</span>&nbsp;<span class="ident" id="6400212"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399539">http</a></span><span class="op" id="6400216">.</span><span class="ident" id="6400217"><a href="/gostd/net/http/client.go.html#4082635">RoundTripper</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6400232">//&nbsp;FlushInterval&nbsp;specifies&nbsp;the&nbsp;flush&nbsp;interval</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6400279">//&nbsp;to&nbsp;flush&nbsp;to&nbsp;the&nbsp;client&nbsp;while&nbsp;copying&nbsp;the</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6400324">//&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6400343">//&nbsp;If&nbsp;zero,&nbsp;no&nbsp;periodic&nbsp;flushing&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400386">FlushInterval</span>&nbsp;<span class="ident" id="6400400"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399581">time</a></span><span class="op" id="6400404">.</span><span class="ident" id="6400405"><a href="/gostd/time/time.go.html#2734212">Duration</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6400416">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6400469">//&nbsp;that&nbsp;occur&nbsp;when&nbsp;attempting&nbsp;to&nbsp;proxy&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6400522">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6400582">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400603">ErrorLog</span>&nbsp;<span class="op" id="6400612">*</span><span class="ident" id="6400613"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399525">log</a></span><span class="op" id="6400616">.</span><span class="ident" id="6400617"><a href="/gostd/log/log.go.html#4072441">Logger</a></span><br>
<span class="lineno"></span><span class="op" id="6400624">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="6400627">func</span>&nbsp;<span class="ident" id="6400632">singleJoiningSlash</span><span class="op" id="6400650">(</span><span class="ident" id="6400651">a</span><span class="op" id="6400652">,</span>&nbsp;<span class="ident" id="6400654">b</span>&nbsp;<span class="builtintype" id="6400656">string</span><span class="op" id="6400662">)</span>&nbsp;<span class="builtintype" id="6400664">string</span>&nbsp;<span class="op" id="6400671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400674">aslash</span>&nbsp;<span class="op" id="6400681">:=</span>&nbsp;<span class="ident" id="6400684"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399562">strings</a></span><span class="op" id="6400691">.</span><span class="ident" id="6400692"><a href="/gostd/strings/strings.go.html#2975527">HasSuffix</a></span><span class="op" id="6400701">(</span><span class="ident" id="6400702"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6400651">a</a></span><span class="op" id="6400703">,</span>&nbsp;<span class="string" id="6400705">&#34;/&#34;</span><span class="op" id="6400708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6400711">bslash</span>&nbsp;<span class="op" id="6400718">:=</span>&nbsp;<span class="ident" id="6400721"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399562">strings</a></span><span class="op" id="6400728">.</span><span class="ident" id="6400729"><a href="/gostd/strings/strings.go.html#2975366">HasPrefix</a></span><span class="op" id="6400738">(</span><span class="ident" id="6400739"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6400654">b</a></span><span class="op" id="6400740">,</span>&nbsp;<span class="string" id="6400742">&#34;/&#34;</span><span class="op" id="6400745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6400748">switch</span>&nbsp;<span class="op" id="6400755">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6400758">case</span>&nbsp;<span class="ident" id="6400763"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6400674">aslash</a></span>&nbsp;<span class="op" id="6400770">&amp;&amp;</span>&nbsp;<span class="ident" id="6400773"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6400711">bslash</a></span><span class="op" id="6400779">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6400783">return</span>&nbsp;<span class="ident" id="6400790"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6400651">a</a></span>&nbsp;<span class="op" id="6400792">+</span>&nbsp;<span class="ident" id="6400794"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6400654">b</a></span><span class="op" id="6400795">[</span><span class="num" id="6400796">1</span><span class="op" id="6400797">:</span><span class="op" id="6400798">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6400801">case</span>&nbsp;<span class="op" id="6400806">!</span><span class="ident" id="6400807"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6400674">aslash</a></span>&nbsp;<span class="op" id="6400814">&amp;&amp;</span>&nbsp;<span class="op" id="6400817">!</span><span class="ident" id="6400818"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6400711">bslash</a></span><span class="op" id="6400824">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6400828">return</span>&nbsp;<span class="ident" id="6400835"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6400651">a</a></span>&nbsp;<span class="op" id="6400837">+</span>&nbsp;<span class="string" id="6400839">&#34;/&#34;</span>&nbsp;<span class="op" id="6400843">+</span>&nbsp;<span class="ident" id="6400845"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6400654">b</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6400848">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6400851">return</span>&nbsp;<span class="ident" id="6400858"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6400651">a</a></span>&nbsp;<span class="op" id="6400860">+</span>&nbsp;<span class="ident" id="6400862"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6400654">b</a></span><br>
<span class="lineno"></span><span class="op" id="6400864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6400867">//&nbsp;NewSingleHostReverseProxy&nbsp;returns&nbsp;a&nbsp;new&nbsp;ReverseProxy&nbsp;that&nbsp;rewrites</span><br>
<span class="lineno"></span><span class="comment" id="6400937">//&nbsp;URLs&nbsp;to&nbsp;the&nbsp;scheme,&nbsp;host,&nbsp;and&nbsp;base&nbsp;path&nbsp;provided&nbsp;in&nbsp;target.&nbsp;If&nbsp;the</span><br>
<span class="lineno">65</span><span class="comment" id="6401007">//&nbsp;target&#39;s&nbsp;path&nbsp;is&nbsp;&#34;/base&#34;&nbsp;and&nbsp;the&nbsp;incoming&nbsp;request&nbsp;was&nbsp;for&nbsp;&#34;/dir&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="6401076">//&nbsp;the&nbsp;target&nbsp;request&nbsp;will&nbsp;be&nbsp;for&nbsp;/base/dir.</span><br>
<span class="lineno"></span><span class="keyword" id="6401121">func</span>&nbsp;<span class="ident" id="6401126">NewSingleHostReverseProxy</span><span class="op" id="6401151">(</span><span class="ident" id="6401152">target</span>&nbsp;<span class="op" id="6401159">*</span><span class="ident" id="6401160"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399551">url</a></span><span class="op" id="6401163">.</span><span class="ident" id="6401164"><a href="/gostd/net/url/url.go.html#3751194">URL</a></span><span class="op" id="6401167">)</span>&nbsp;<span class="op" id="6401169">*</span><span class="ident" id="6401170"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399869">ReverseProxy</a></span>&nbsp;<span class="op" id="6401183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6401186">targetQuery</span>&nbsp;<span class="op" id="6401198">:=</span>&nbsp;<span class="ident" id="6401201"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401152">target</a></span><span class="op" id="6401207">.</span><span class="ident" id="6401208"><a href="/gostd/net/url/url.go.html#3751383">RawQuery</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6401218">director</span>&nbsp;<span class="op" id="6401227">:=</span>&nbsp;<span class="keyword" id="6401230">func</span><span class="op" id="6401234">(</span><span class="ident" id="6401235">req</span>&nbsp;<span class="op" id="6401239">*</span><span class="ident" id="6401240"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399539">http</a></span><span class="op" id="6401244">.</span><span class="ident" id="6401245"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span><span class="op" id="6401252">)</span>&nbsp;<span class="op" id="6401254">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6401258"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401235">req</a></span><span class="op" id="6401261">.</span><span class="ident" id="6401262"><a href="/gostd/net/http/request.go.html#4136640">URL</a></span><span class="op" id="6401265">.</span><span class="ident" id="6401266"><a href="/gostd/net/url/url.go.html#3751208">Scheme</a></span>&nbsp;<span class="op" id="6401273">=</span>&nbsp;<span class="ident" id="6401275"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401152">target</a></span><span class="op" id="6401281">.</span><span class="ident" id="6401282"><a href="/gostd/net/url/url.go.html#3751208">Scheme</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6401291"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401235">req</a></span><span class="op" id="6401294">.</span><span class="ident" id="6401295"><a href="/gostd/net/http/request.go.html#4136640">URL</a></span><span class="op" id="6401298">.</span><span class="ident" id="6401299"><a href="/gostd/net/url/url.go.html#3751325">Host</a></span>&nbsp;<span class="op" id="6401304">=</span>&nbsp;<span class="ident" id="6401306"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401152">target</a></span><span class="op" id="6401312">.</span><span class="ident" id="6401313"><a href="/gostd/net/url/url.go.html#3751325">Host</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6401320"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401235">req</a></span><span class="op" id="6401323">.</span><span class="ident" id="6401324"><a href="/gostd/net/http/request.go.html#4136640">URL</a></span><span class="op" id="6401327">.</span><span class="ident" id="6401328"><a href="/gostd/net/url/url.go.html#3751366">Path</a></span>&nbsp;<span class="op" id="6401333">=</span>&nbsp;<span class="ident" id="6401335"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6400632">singleJoiningSlash</a></span><span class="op" id="6401353">(</span><span class="ident" id="6401354"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401152">target</a></span><span class="op" id="6401360">.</span><span class="ident" id="6401361"><a href="/gostd/net/url/url.go.html#3751366">Path</a></span><span class="op" id="6401365">,</span>&nbsp;<span class="ident" id="6401367"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401235">req</a></span><span class="op" id="6401370">.</span><span class="ident" id="6401371"><a href="/gostd/net/http/request.go.html#4136640">URL</a></span><span class="op" id="6401374">.</span><span class="ident" id="6401375"><a href="/gostd/net/url/url.go.html#3751366">Path</a></span><span class="op" id="6401379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6401383">if</span>&nbsp;<span class="ident" id="6401386"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401186">targetQuery</a></span>&nbsp;<span class="op" id="6401398">==</span>&nbsp;<span class="string" id="6401401">&#34;&#34;</span>&nbsp;<span class="op" id="6401404">||</span>&nbsp;<span class="ident" id="6401407"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401235">req</a></span><span class="op" id="6401410">.</span><span class="ident" id="6401411"><a href="/gostd/net/http/request.go.html#4136640">URL</a></span><span class="op" id="6401414">.</span><span class="ident" id="6401415"><a href="/gostd/net/url/url.go.html#3751383">RawQuery</a></span>&nbsp;<span class="op" id="6401424">==</span>&nbsp;<span class="string" id="6401427">&#34;&#34;</span>&nbsp;<span class="op" id="6401430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6401435"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401235">req</a></span><span class="op" id="6401438">.</span><span class="ident" id="6401439"><a href="/gostd/net/http/request.go.html#4136640">URL</a></span><span class="op" id="6401442">.</span><span class="ident" id="6401443"><a href="/gostd/net/url/url.go.html#3751383">RawQuery</a></span>&nbsp;<span class="op" id="6401452">=</span>&nbsp;<span class="ident" id="6401454"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401186">targetQuery</a></span>&nbsp;<span class="op" id="6401466">+</span>&nbsp;<span class="ident" id="6401468"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401235">req</a></span><span class="op" id="6401471">.</span><span class="ident" id="6401472"><a href="/gostd/net/http/request.go.html#4136640">URL</a></span><span class="op" id="6401475">.</span><span class="ident" id="6401476"><a href="/gostd/net/url/url.go.html#3751383">RawQuery</a></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6401487">}</span>&nbsp;<span class="keyword" id="6401489">else</span>&nbsp;<span class="op" id="6401494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6401499"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401235">req</a></span><span class="op" id="6401502">.</span><span class="ident" id="6401503"><a href="/gostd/net/http/request.go.html#4136640">URL</a></span><span class="op" id="6401506">.</span><span class="ident" id="6401507"><a href="/gostd/net/url/url.go.html#3751383">RawQuery</a></span>&nbsp;<span class="op" id="6401516">=</span>&nbsp;<span class="ident" id="6401518"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401186">targetQuery</a></span>&nbsp;<span class="op" id="6401530">+</span>&nbsp;<span class="string" id="6401532">&#34;&amp;&#34;</span>&nbsp;<span class="op" id="6401536">+</span>&nbsp;<span class="ident" id="6401538"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401235">req</a></span><span class="op" id="6401541">.</span><span class="ident" id="6401542"><a href="/gostd/net/http/request.go.html#4136640">URL</a></span><span class="op" id="6401545">.</span><span class="ident" id="6401546"><a href="/gostd/net/url/url.go.html#3751383">RawQuery</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6401557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6401560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6401563">return</span>&nbsp;<span class="op" id="6401570">&amp;</span><span class="ident" id="6401571"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399869">ReverseProxy</a></span><span class="op" id="6401583">{</span><span class="ident" id="6401584"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6400078">Director</a></span><span class="op" id="6401592">:</span>&nbsp;<span class="ident" id="6401594"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401218">director</a></span><span class="op" id="6401602">}</span><br>
<span class="lineno">80</span><span class="op" id="6401604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6401607">func</span>&nbsp;<span class="ident" id="6401612">copyHeader</span><span class="op" id="6401622">(</span><span class="ident" id="6401623">dst</span><span class="op" id="6401626">,</span>&nbsp;<span class="ident" id="6401628">src</span>&nbsp;<span class="ident" id="6401632"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399539">http</a></span><span class="op" id="6401636">.</span><span class="ident" id="6401637"><a href="/gostd/net/http/header.go.html#4126117">Header</a></span><span class="op" id="6401643">)</span>&nbsp;<span class="op" id="6401645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6401648">for</span>&nbsp;<span class="ident" id="6401652">k</span><span class="op" id="6401653">,</span>&nbsp;<span class="ident" id="6401655">vv</span>&nbsp;<span class="op" id="6401658">:=</span>&nbsp;<span class="keyword" id="6401661">range</span>&nbsp;<span class="ident" id="6401667"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401628">src</a></span>&nbsp;<span class="op" id="6401671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6401675">for</span>&nbsp;<span class="ident" id="6401679">_</span><span class="op" id="6401680">,</span>&nbsp;<span class="ident" id="6401682">v</span>&nbsp;<span class="op" id="6401684">:=</span>&nbsp;<span class="keyword" id="6401687">range</span>&nbsp;<span class="ident" id="6401693"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401655">vv</a></span>&nbsp;<span class="op" id="6401696">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6401701"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401623">dst</a></span><span class="op" id="6401704">.</span><span class="ident" id="6401705"><a href="/gostd/net/http/header.go.html#4126266">Add</a></span><span class="op" id="6401708">(</span><span class="ident" id="6401709"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401652">k</a></span><span class="op" id="6401710">,</span>&nbsp;<span class="ident" id="6401712"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401682">v</a></span><span class="op" id="6401713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6401717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6401720">}</span><br>
<span class="lineno"></span><span class="op" id="6401722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="6401725">//&nbsp;Hop-by-hop&nbsp;headers.&nbsp;These&nbsp;are&nbsp;removed&nbsp;when&nbsp;sent&nbsp;to&nbsp;the&nbsp;backend.</span><br>
<span class="lineno"></span><span class="comment" id="6401792">//&nbsp;http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html</span><br>
<span class="lineno"></span><span class="keyword" id="6401850">var</span>&nbsp;<span class="ident" id="6401854">hopHeaders</span>&nbsp;<span class="op" id="6401865">=</span>&nbsp;<span class="op" id="6401867">[</span><span class="op" id="6401868">]</span><span class="builtintype" id="6401869">string</span><span class="op" id="6401875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6401878">&#34;Connection&#34;</span><span class="op" id="6401890">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6401893">&#34;Keep-Alive&#34;</span><span class="op" id="6401905">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6401908">&#34;Proxy-Authenticate&#34;</span><span class="op" id="6401928">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6401931">&#34;Proxy-Authorization&#34;</span><span class="op" id="6401952">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6401955">&#34;Te&#34;</span><span class="op" id="6401959">,</span>&nbsp;<span class="comment" id="6401961">//&nbsp;canonicalized&nbsp;version&nbsp;of&nbsp;&#34;TE&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6401995">&#34;Trailers&#34;</span><span class="op" id="6402005">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6402008">&#34;Transfer-Encoding&#34;</span><span class="op" id="6402027">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6402030">&#34;Upgrade&#34;</span><span class="op" id="6402039">,</span><br>
<span class="lineno"></span><span class="op" id="6402041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6402044">func</span>&nbsp;<span class="op" id="6402049">(</span><span class="ident" id="6402050">p</span>&nbsp;<span class="op" id="6402052">*</span><span class="ident" id="6402053"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399869">ReverseProxy</a></span><span class="op" id="6402065">)</span>&nbsp;<span class="ident" id="6402067">ServeHTTP</span><span class="op" id="6402076">(</span><span class="ident" id="6402077">rw</span>&nbsp;<span class="ident" id="6402080"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399539">http</a></span><span class="op" id="6402084">.</span><span class="ident" id="6402085"><a href="/gostd/net/http/server.go.html#4170569">ResponseWriter</a></span><span class="op" id="6402099">,</span>&nbsp;<span class="ident" id="6402101">req</span>&nbsp;<span class="op" id="6402105">*</span><span class="ident" id="6402106"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399539">http</a></span><span class="op" id="6402110">.</span><span class="ident" id="6402111"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span><span class="op" id="6402118">)</span>&nbsp;<span class="op" id="6402120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402123">transport</span>&nbsp;<span class="op" id="6402133">:=</span>&nbsp;<span class="ident" id="6402136"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402050">p</a></span><span class="op" id="6402137">.</span><span class="ident" id="6402138"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6400202">Transport</a></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6402149">if</span>&nbsp;<span class="ident" id="6402152"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402123">transport</a></span>&nbsp;<span class="op" id="6402162">==</span>&nbsp;<span class="builtintype" id="6402165">nil</span>&nbsp;<span class="op" id="6402169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402173"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402123">transport</a></span>&nbsp;<span class="op" id="6402183">=</span>&nbsp;<span class="ident" id="6402185"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399539">http</a></span><span class="op" id="6402189">.</span><span class="ident" id="6402190"><a href="/gostd/net/http/transport.go.html#4260261">DefaultTransport</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6402208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402212">outreq</span>&nbsp;<span class="op" id="6402219">:=</span>&nbsp;<span class="builtinfunc" id="6402222">new</span><span class="op" id="6402225">(</span><span class="ident" id="6402226"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399539">http</a></span><span class="op" id="6402230">.</span><span class="ident" id="6402231"><a href="/gostd/net/http/request.go.html#4135954">Request</a></span><span class="op" id="6402238">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6402241">*</span><span class="ident" id="6402242"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402212">outreq</a></span>&nbsp;<span class="op" id="6402249">=</span>&nbsp;<span class="op" id="6402251">*</span><span class="ident" id="6402252"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402101">req</a></span>&nbsp;<span class="comment" id="6402256">//&nbsp;includes&nbsp;shallow&nbsp;copies&nbsp;of&nbsp;maps,&nbsp;but&nbsp;okay</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402303"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402050">p</a></span><span class="op" id="6402304">.</span><span class="ident" id="6402305"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6400078">Director</a></span><span class="op" id="6402313">(</span><span class="ident" id="6402314"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402212">outreq</a></span><span class="op" id="6402320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402323"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402212">outreq</a></span><span class="op" id="6402329">.</span><span class="ident" id="6402330"><a href="/gostd/net/http/request.go.html#4136744">Proto</a></span>&nbsp;<span class="op" id="6402336">=</span>&nbsp;<span class="string" id="6402338">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402350"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402212">outreq</a></span><span class="op" id="6402356">.</span><span class="ident" id="6402357"><a href="/gostd/net/http/request.go.html#4136777">ProtoMajor</a></span>&nbsp;<span class="op" id="6402368">=</span>&nbsp;<span class="num" id="6402370">1</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402373"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402212">outreq</a></span><span class="op" id="6402379">.</span><span class="ident" id="6402380"><a href="/gostd/net/http/request.go.html#4136801">ProtoMinor</a></span>&nbsp;<span class="op" id="6402391">=</span>&nbsp;<span class="num" id="6402393">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402396"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402212">outreq</a></span><span class="op" id="6402402">.</span><span class="ident" id="6402403"><a href="/gostd/net/http/request.go.html#4138776">Close</a></span>&nbsp;<span class="op" id="6402409">=</span>&nbsp;<span class="builtintype" id="6402411">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6402419">//&nbsp;Remove&nbsp;hop-by-hop&nbsp;headers&nbsp;to&nbsp;the&nbsp;backend.&nbsp;&nbsp;Especially</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6402477">//&nbsp;important&nbsp;is&nbsp;&#34;Connection&#34;&nbsp;because&nbsp;we&nbsp;want&nbsp;a&nbsp;persistent</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6402536">//&nbsp;connection,&nbsp;regardless&nbsp;of&nbsp;what&nbsp;the&nbsp;client&nbsp;sent&nbsp;to&nbsp;us.&nbsp;&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6402600">//&nbsp;is&nbsp;modifying&nbsp;the&nbsp;same&nbsp;underlying&nbsp;map&nbsp;from&nbsp;req&nbsp;(shallow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6402659">//&nbsp;copied&nbsp;above)&nbsp;so&nbsp;we&nbsp;only&nbsp;copy&nbsp;it&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402710">copiedHeaders</span>&nbsp;<span class="op" id="6402724">:=</span>&nbsp;<span class="builtintype" id="6402727">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6402734">for</span>&nbsp;<span class="ident" id="6402738">_</span><span class="op" id="6402739">,</span>&nbsp;<span class="ident" id="6402741">h</span>&nbsp;<span class="op" id="6402743">:=</span>&nbsp;<span class="keyword" id="6402746">range</span>&nbsp;<span class="ident" id="6402752"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401854">hopHeaders</a></span>&nbsp;<span class="op" id="6402763">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6402767">if</span>&nbsp;<span class="ident" id="6402770"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402212">outreq</a></span><span class="op" id="6402776">.</span><span class="ident" id="6402777"><a href="/gostd/net/http/request.go.html#4137563">Header</a></span><span class="op" id="6402783">.</span><span class="ident" id="6402784"><a href="/gostd/net/http/header.go.html#4126793">Get</a></span><span class="op" id="6402787">(</span><span class="ident" id="6402788"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402741">h</a></span><span class="op" id="6402789">)</span>&nbsp;<span class="op" id="6402791">!=</span>&nbsp;<span class="string" id="6402794">&#34;&#34;</span>&nbsp;<span class="op" id="6402797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6402802">if</span>&nbsp;<span class="op" id="6402805">!</span><span class="ident" id="6402806"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402710">copiedHeaders</a></span>&nbsp;<span class="op" id="6402820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402826"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402212">outreq</a></span><span class="op" id="6402832">.</span><span class="ident" id="6402833"><a href="/gostd/net/http/request.go.html#4137563">Header</a></span>&nbsp;<span class="op" id="6402840">=</span>&nbsp;<span class="builtinfunc" id="6402842">make</span><span class="op" id="6402846">(</span><span class="ident" id="6402847"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399539">http</a></span><span class="op" id="6402851">.</span><span class="ident" id="6402852"><a href="/gostd/net/http/header.go.html#4126117">Header</a></span><span class="op" id="6402858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402864"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401612">copyHeader</a></span><span class="op" id="6402874">(</span><span class="ident" id="6402875"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402212">outreq</a></span><span class="op" id="6402881">.</span><span class="ident" id="6402882"><a href="/gostd/net/http/request.go.html#4137563">Header</a></span><span class="op" id="6402888">,</span>&nbsp;<span class="ident" id="6402890"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402101">req</a></span><span class="op" id="6402893">.</span><span class="ident" id="6402894"><a href="/gostd/net/http/request.go.html#4137563">Header</a></span><span class="op" id="6402900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402906"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402710">copiedHeaders</a></span>&nbsp;<span class="op" id="6402920">=</span>&nbsp;<span class="builtintype" id="6402922">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6402930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6402935"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402212">outreq</a></span><span class="op" id="6402941">.</span><span class="ident" id="6402942"><a href="/gostd/net/http/request.go.html#4137563">Header</a></span><span class="op" id="6402948">.</span><span class="ident" id="6402949"><a href="/gostd/net/http/header.go.html#4127099">Del</a></span><span class="op" id="6402952">(</span><span class="ident" id="6402953"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402741">h</a></span><span class="op" id="6402954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6402958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6402961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6402965">if</span>&nbsp;<span class="ident" id="6402968">clientIP</span><span class="op" id="6402976">,</span>&nbsp;<span class="ident" id="6402978">_</span><span class="op" id="6402979">,</span>&nbsp;<span class="ident" id="6402981">err</span>&nbsp;<span class="op" id="6402985">:=</span>&nbsp;<span class="ident" id="6402988"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399532">net</a></span><span class="op" id="6402991">.</span><span class="ident" id="6402992"><a href="/gostd/net/ipsock.go.html#3313208">SplitHostPort</a></span><span class="op" id="6403005">(</span><span class="ident" id="6403006"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402101">req</a></span><span class="op" id="6403009">.</span><span class="ident" id="6403010"><a href="/gostd/net/http/request.go.html#4141200">RemoteAddr</a></span><span class="op" id="6403020">)</span><span class="op" id="6403021">;</span>&nbsp;<span class="ident" id="6403023"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402981">err</a></span>&nbsp;<span class="op" id="6403027">==</span>&nbsp;<span class="builtintype" id="6403030">nil</span>&nbsp;<span class="op" id="6403034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6403038">//&nbsp;If&nbsp;we&nbsp;aren&#39;t&nbsp;the&nbsp;first&nbsp;proxy&nbsp;retain&nbsp;prior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6403085">//&nbsp;X-Forwarded-For&nbsp;information&nbsp;as&nbsp;a&nbsp;comma+space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6403135">//&nbsp;separated&nbsp;list&nbsp;and&nbsp;fold&nbsp;multiple&nbsp;headers&nbsp;into&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403191">if</span>&nbsp;<span class="ident" id="6403194">prior</span><span class="op" id="6403199">,</span>&nbsp;<span class="ident" id="6403201">ok</span>&nbsp;<span class="op" id="6403204">:=</span>&nbsp;<span class="ident" id="6403207"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402212">outreq</a></span><span class="op" id="6403213">.</span><span class="ident" id="6403214"><a href="/gostd/net/http/request.go.html#4137563">Header</a></span><span class="op" id="6403220">[</span><span class="string" id="6403221">&#34;X-Forwarded-For&#34;</span><span class="op" id="6403238">]</span><span class="op" id="6403239">;</span>&nbsp;<span class="ident" id="6403241"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403201">ok</a></span>&nbsp;<span class="op" id="6403244">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403249"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402968">clientIP</a></span>&nbsp;<span class="op" id="6403258">=</span>&nbsp;<span class="ident" id="6403260"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399562">strings</a></span><span class="op" id="6403267">.</span><span class="ident" id="6403268"><a href="/gostd/strings/strings.go.html#2974969">Join</a></span><span class="op" id="6403272">(</span><span class="ident" id="6403273"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403194">prior</a></span><span class="op" id="6403278">,</span>&nbsp;<span class="string" id="6403280">&#34;,&nbsp;&#34;</span><span class="op" id="6403284">)</span>&nbsp;<span class="op" id="6403286">+</span>&nbsp;<span class="string" id="6403288">&#34;,&nbsp;&#34;</span>&nbsp;<span class="op" id="6403293">+</span>&nbsp;<span class="ident" id="6403295"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402968">clientIP</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6403306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403310"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402212">outreq</a></span><span class="op" id="6403316">.</span><span class="ident" id="6403317"><a href="/gostd/net/http/request.go.html#4137563">Header</a></span><span class="op" id="6403323">.</span><span class="ident" id="6403324"><a href="/gostd/net/http/header.go.html#4126491">Set</a></span><span class="op" id="6403327">(</span><span class="string" id="6403328">&#34;X-Forwarded-For&#34;</span><span class="op" id="6403345">,</span>&nbsp;<span class="ident" id="6403347"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402968">clientIP</a></span><span class="op" id="6403355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6403358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403362">res</span><span class="op" id="6403365">,</span>&nbsp;<span class="ident" id="6403367">err</span>&nbsp;<span class="op" id="6403371">:=</span>&nbsp;<span class="ident" id="6403374"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402123">transport</a></span><span class="op" id="6403383">.</span><span class="ident" id="6403384"><a href="/gostd/net/http/client.go.html#4083357">RoundTrip</a></span><span class="op" id="6403393">(</span><span class="ident" id="6403394"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402212">outreq</a></span><span class="op" id="6403400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403403">if</span>&nbsp;<span class="ident" id="6403406"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403367">err</a></span>&nbsp;<span class="op" id="6403410">!=</span>&nbsp;<span class="builtintype" id="6403413">nil</span>&nbsp;<span class="op" id="6403417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403421"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402050">p</a></span><span class="op" id="6403422">.</span><span class="ident" id="6403423"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404057">logf</a></span><span class="op" id="6403427">(</span><span class="string" id="6403428">&#34;http:&nbsp;proxy&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="6403451">,</span>&nbsp;<span class="ident" id="6403453"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403367">err</a></span><span class="op" id="6403456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403460"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402077">rw</a></span><span class="op" id="6403462">.</span><span class="ident" id="6403463"><a href="/gostd/net/http/server.go.html#4171422">WriteHeader</a></span><span class="op" id="6403474">(</span><span class="ident" id="6403475"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399539">http</a></span><span class="op" id="6403479">.</span><span class="ident" id="6403480"><a href="/gostd/net/http/status.go.html#4237466">StatusInternalServerError</a></span><span class="op" id="6403505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403509">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6403517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403520">defer</span>&nbsp;<span class="ident" id="6403526"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403362">res</a></span><span class="op" id="6403529">.</span><span class="ident" id="6403530"><a href="/gostd/net/http/response.go.html#4162507">Body</a></span><span class="op" id="6403534">.</span><span class="ident" id="6403535"><a href="/gostd/io/io.go.html#1422583">Close</a></span><span class="op" id="6403540">(</span><span class="op" id="6403541">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403545">for</span>&nbsp;<span class="ident" id="6403549">_</span><span class="op" id="6403550">,</span>&nbsp;<span class="ident" id="6403552">h</span>&nbsp;<span class="op" id="6403554">:=</span>&nbsp;<span class="keyword" id="6403557">range</span>&nbsp;<span class="ident" id="6403563"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401854">hopHeaders</a></span>&nbsp;<span class="op" id="6403574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403578"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403362">res</a></span><span class="op" id="6403581">.</span><span class="ident" id="6403582"><a href="/gostd/net/http/response.go.html#4162137">Header</a></span><span class="op" id="6403588">.</span><span class="ident" id="6403589"><a href="/gostd/net/http/header.go.html#4127099">Del</a></span><span class="op" id="6403592">(</span><span class="ident" id="6403593"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403552">h</a></span><span class="op" id="6403594">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6403597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403601"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6401612">copyHeader</a></span><span class="op" id="6403611">(</span><span class="ident" id="6403612"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402077">rw</a></span><span class="op" id="6403614">.</span><span class="ident" id="6403615"><a href="/gostd/net/http/server.go.html#4170747">Header</a></span><span class="op" id="6403621">(</span><span class="op" id="6403622">)</span><span class="op" id="6403623">,</span>&nbsp;<span class="ident" id="6403625"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403362">res</a></span><span class="op" id="6403628">.</span><span class="ident" id="6403629"><a href="/gostd/net/http/response.go.html#4162137">Header</a></span><span class="op" id="6403635">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403639"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402077">rw</a></span><span class="op" id="6403641">.</span><span class="ident" id="6403642"><a href="/gostd/net/http/server.go.html#4171422">WriteHeader</a></span><span class="op" id="6403653">(</span><span class="ident" id="6403654"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403362">res</a></span><span class="op" id="6403657">.</span><span class="ident" id="6403658"><a href="/gostd/net/http/response.go.html#4161564">StatusCode</a></span><span class="op" id="6403668">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403671"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402050">p</a></span><span class="op" id="6403672">.</span><span class="ident" id="6403673"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403726">copyResponse</a></span><span class="op" id="6403685">(</span><span class="ident" id="6403686"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6402077">rw</a></span><span class="op" id="6403688">,</span>&nbsp;<span class="ident" id="6403690"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403362">res</a></span><span class="op" id="6403693">.</span><span class="ident" id="6403694"><a href="/gostd/net/http/response.go.html#4162507">Body</a></span><span class="op" id="6403698">)</span><br>
<span class="lineno"></span><span class="op" id="6403700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6403703">func</span>&nbsp;<span class="op" id="6403708">(</span><span class="ident" id="6403709">p</span>&nbsp;<span class="op" id="6403711">*</span><span class="ident" id="6403712"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399869">ReverseProxy</a></span><span class="op" id="6403724">)</span>&nbsp;<span class="ident" id="6403726">copyResponse</span><span class="op" id="6403738">(</span><span class="ident" id="6403739">dst</span>&nbsp;<span class="ident" id="6403743"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399519">io</a></span><span class="op" id="6403745">.</span><span class="ident" id="6403746"><a href="/gostd/io/io.go.html#1422314">Writer</a></span><span class="op" id="6403752">,</span>&nbsp;<span class="ident" id="6403754">src</span>&nbsp;<span class="ident" id="6403758"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399519">io</a></span><span class="op" id="6403760">.</span><span class="ident" id="6403761"><a href="/gostd/io/io.go.html#1421823">Reader</a></span><span class="op" id="6403767">)</span>&nbsp;<span class="op" id="6403769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403772">if</span>&nbsp;<span class="ident" id="6403775"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403709">p</a></span><span class="op" id="6403776">.</span><span class="ident" id="6403777"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6400386">FlushInterval</a></span>&nbsp;<span class="op" id="6403791">!=</span>&nbsp;<span class="num" id="6403794">0</span>&nbsp;<span class="op" id="6403796">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403800">if</span>&nbsp;<span class="ident" id="6403803">wf</span><span class="op" id="6403805">,</span>&nbsp;<span class="ident" id="6403807">ok</span>&nbsp;<span class="op" id="6403810">:=</span>&nbsp;<span class="ident" id="6403813"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403739">dst</a></span><span class="op" id="6403816">.</span><span class="op" id="6403817">(</span><span class="ident" id="6403818"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404212">writeFlusher</a></span><span class="op" id="6403830">)</span><span class="op" id="6403831">;</span>&nbsp;<span class="ident" id="6403833"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403807">ok</a></span>&nbsp;<span class="op" id="6403836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403841">mlw</span>&nbsp;<span class="op" id="6403845">:=</span>&nbsp;<span class="op" id="6403848">&amp;</span><span class="ident" id="6403849"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404270">maxLatencyWriter</a></span><span class="op" id="6403865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403871"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404297">dst</a></span><span class="op" id="6403874">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403880"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403803">wf</a></span><span class="op" id="6403882">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403888"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404319">latency</a></span><span class="op" id="6403895">:</span>&nbsp;<span class="ident" id="6403897"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403709">p</a></span><span class="op" id="6403898">.</span><span class="ident" id="6403899"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6400386">FlushInterval</a></span><span class="op" id="6403912">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403918"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404386">done</a></span><span class="op" id="6403922">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6403927">make</span><span class="op" id="6403931">(</span><span class="keyword" id="6403932">chan</span>&nbsp;<span class="builtintype" id="6403937">bool</span><span class="op" id="6403941">)</span><span class="op" id="6403942">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6403947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403952">go</span>&nbsp;<span class="ident" id="6403955"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403841">mlw</a></span><span class="op" id="6403958">.</span><span class="ident" id="6403959"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404549">flushLoop</a></span><span class="op" id="6403968">(</span><span class="op" id="6403969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6403974">defer</span>&nbsp;<span class="ident" id="6403980"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403841">mlw</a></span><span class="op" id="6403983">.</span><span class="ident" id="6403984"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404814">stop</a></span><span class="op" id="6403988">(</span><span class="op" id="6403989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6403994"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403739">dst</a></span>&nbsp;<span class="op" id="6403998">=</span>&nbsp;<span class="ident" id="6404000"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403841">mlw</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6404006">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6404009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404013"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399519">io</a></span><span class="op" id="6404015">.</span><span class="ident" id="6404016"><a href="/gostd/io/io.go.html#1430946">Copy</a></span><span class="op" id="6404020">(</span><span class="ident" id="6404021"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403739">dst</a></span><span class="op" id="6404024">,</span>&nbsp;<span class="ident" id="6404026"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6403754">src</a></span><span class="op" id="6404029">)</span><br>
<span class="lineno"></span><span class="op" id="6404031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="6404034">func</span>&nbsp;<span class="op" id="6404039">(</span><span class="ident" id="6404040">p</span>&nbsp;<span class="op" id="6404042">*</span><span class="ident" id="6404043"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399869">ReverseProxy</a></span><span class="op" id="6404055">)</span>&nbsp;<span class="ident" id="6404057">logf</span><span class="op" id="6404061">(</span><span class="ident" id="6404062">format</span>&nbsp;<span class="builtintype" id="6404069">string</span><span class="op" id="6404075">,</span>&nbsp;<span class="ident" id="6404077">args</span>&nbsp;<span class="op" id="6404082">...</span><span class="keyword" id="6404085">interface</span><span class="op" id="6404094">{</span><span class="op" id="6404095">}</span><span class="op" id="6404096">)</span>&nbsp;<span class="op" id="6404098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6404101">if</span>&nbsp;<span class="ident" id="6404104"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404040">p</a></span><span class="op" id="6404105">.</span><span class="ident" id="6404106"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6400603">ErrorLog</a></span>&nbsp;<span class="op" id="6404115">!=</span>&nbsp;<span class="builtintype" id="6404118">nil</span>&nbsp;<span class="op" id="6404122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404126"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404040">p</a></span><span class="op" id="6404127">.</span><span class="ident" id="6404128"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6400603">ErrorLog</a></span><span class="op" id="6404136">.</span><span class="ident" id="6404137"><a href="/gostd/log/log.go.html#4075692">Printf</a></span><span class="op" id="6404143">(</span><span class="ident" id="6404144"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404062">format</a></span><span class="op" id="6404150">,</span>&nbsp;<span class="ident" id="6404152"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404077">args</a></span><span class="op" id="6404156">...</span><span class="op" id="6404159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6404162">}</span>&nbsp;<span class="keyword" id="6404164">else</span>&nbsp;<span class="op" id="6404169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404173"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399525">log</a></span><span class="op" id="6404176">.</span><span class="ident" id="6404177"><a href="/gostd/log/log.go.html#4078664">Printf</a></span><span class="op" id="6404183">(</span><span class="ident" id="6404184"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404062">format</a></span><span class="op" id="6404190">,</span>&nbsp;<span class="ident" id="6404192"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404077">args</a></span><span class="op" id="6404196">...</span><span class="op" id="6404199">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6404202">}</span><br>
<span class="lineno"></span><span class="op" id="6404204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6404207">type</span>&nbsp;<span class="ident" id="6404212">writeFlusher</span>&nbsp;<span class="keyword" id="6404225">interface</span>&nbsp;<span class="op" id="6404235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404238"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399519">io</a></span><span class="op" id="6404240">.</span><span class="ident" id="6404241"><a href="/gostd/io/io.go.html#1422314">Writer</a></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404249"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399539">http</a></span><span class="op" id="6404253">.</span><span class="ident" id="6404254"><a href="/gostd/net/http/server.go.html#4171767">Flusher</a></span><br>
<span class="lineno"></span><span class="op" id="6404262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6404265">type</span>&nbsp;<span class="ident" id="6404270">maxLatencyWriter</span>&nbsp;<span class="keyword" id="6404287">struct</span>&nbsp;<span class="op" id="6404294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404297">dst</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404305"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404212">writeFlusher</a></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404319">latency</span>&nbsp;<span class="ident" id="6404327"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399581">time</a></span><span class="op" id="6404331">.</span><span class="ident" id="6404332"><a href="/gostd/time/time.go.html#2734212">Duration</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404343">lk</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6404348"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399573">sync</a></span><span class="op" id="6404352">.</span><span class="ident" id="6404353"><a href="/gostd/sync/mutex.go.html#1443974">Mutex</a></span>&nbsp;<span class="comment" id="6404359">//&nbsp;protects&nbsp;Write&nbsp;+&nbsp;Flush</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404386">done</span>&nbsp;<span class="keyword" id="6404391">chan</span>&nbsp;<span class="builtintype" id="6404396">bool</span><br>
<span class="lineno"></span><span class="op" id="6404401">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="keyword" id="6404404">func</span>&nbsp;<span class="op" id="6404409">(</span><span class="ident" id="6404410">m</span>&nbsp;<span class="op" id="6404412">*</span><span class="ident" id="6404413"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404270">maxLatencyWriter</a></span><span class="op" id="6404429">)</span>&nbsp;<span class="ident" id="6404431">Write</span><span class="op" id="6404436">(</span><span class="ident" id="6404437">p</span>&nbsp;<span class="op" id="6404439">[</span><span class="op" id="6404440">]</span><span class="builtintype" id="6404441">byte</span><span class="op" id="6404445">)</span>&nbsp;<span class="op" id="6404447">(</span><span class="builtintype" id="6404448">int</span><span class="op" id="6404451">,</span>&nbsp;<span class="builtintype" id="6404453">error</span><span class="op" id="6404458">)</span>&nbsp;<span class="op" id="6404460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404463"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404410">m</a></span><span class="op" id="6404464">.</span><span class="ident" id="6404465"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404343">lk</a></span><span class="op" id="6404467">.</span><span class="ident" id="6404468"><a href="/gostd/sync/mutex.go.html#1444351">Lock</a></span><span class="op" id="6404472">(</span><span class="op" id="6404473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6404476">defer</span>&nbsp;<span class="ident" id="6404482"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404410">m</a></span><span class="op" id="6404483">.</span><span class="ident" id="6404484"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404343">lk</a></span><span class="op" id="6404486">.</span><span class="ident" id="6404487"><a href="/gostd/sync/mutex.go.html#1445283">Unlock</a></span><span class="op" id="6404493">(</span><span class="op" id="6404494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6404497">return</span>&nbsp;<span class="ident" id="6404504"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404410">m</a></span><span class="op" id="6404505">.</span><span class="ident" id="6404506"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404297">dst</a></span><span class="op" id="6404509">.</span><span class="ident" id="6404510"><a href="/gostd/io/io.go.html#1422334">Write</a></span><span class="op" id="6404515">(</span><span class="ident" id="6404516"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404437">p</a></span><span class="op" id="6404517">)</span><br>
<span class="lineno">205</span><span class="op" id="6404519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6404522">func</span>&nbsp;<span class="op" id="6404527">(</span><span class="ident" id="6404528">m</span>&nbsp;<span class="op" id="6404530">*</span><span class="ident" id="6404531"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404270">maxLatencyWriter</a></span><span class="op" id="6404547">)</span>&nbsp;<span class="ident" id="6404549">flushLoop</span><span class="op" id="6404558">(</span><span class="op" id="6404559">)</span>&nbsp;<span class="op" id="6404561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404564">t</span>&nbsp;<span class="op" id="6404566">:=</span>&nbsp;<span class="ident" id="6404569"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399581">time</a></span><span class="op" id="6404573">.</span><span class="ident" id="6404574"><a href="/gostd/time/tick.go.html#2719323">NewTicker</a></span><span class="op" id="6404583">(</span><span class="ident" id="6404584"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404528">m</a></span><span class="op" id="6404585">.</span><span class="ident" id="6404586"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404319">latency</a></span><span class="op" id="6404593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6404596">defer</span>&nbsp;<span class="ident" id="6404602"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404564">t</a></span><span class="op" id="6404603">.</span><span class="ident" id="6404604"><a href="/gostd/time/tick.go.html#2719948">Stop</a></span><span class="op" id="6404608">(</span><span class="op" id="6404609">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6404612">for</span>&nbsp;<span class="op" id="6404616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6404620">select</span>&nbsp;<span class="op" id="6404627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6404631">case</span>&nbsp;<span class="op" id="6404636">&lt;-</span><span class="ident" id="6404638"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404528">m</a></span><span class="op" id="6404639">.</span><span class="ident" id="6404640"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404386">done</a></span><span class="op" id="6404644">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6404649">if</span>&nbsp;<span class="ident" id="6404652"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399694">onExitFlushLoop</a></span>&nbsp;<span class="op" id="6404668">!=</span>&nbsp;<span class="builtintype" id="6404671">nil</span>&nbsp;<span class="op" id="6404675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404681"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6399694">onExitFlushLoop</a></span><span class="op" id="6404696">(</span><span class="op" id="6404697">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6404702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6404707">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6404716">case</span>&nbsp;<span class="op" id="6404721">&lt;-</span><span class="ident" id="6404723"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404564">t</a></span><span class="op" id="6404724">.</span><span class="ident" id="6404725"><a href="/gostd/time/tick.go.html#2718903">C</a></span><span class="op" id="6404726">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404731"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404528">m</a></span><span class="op" id="6404732">.</span><span class="ident" id="6404733"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404343">lk</a></span><span class="op" id="6404735">.</span><span class="ident" id="6404736"><a href="/gostd/sync/mutex.go.html#1444351">Lock</a></span><span class="op" id="6404740">(</span><span class="op" id="6404741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404746"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404528">m</a></span><span class="op" id="6404747">.</span><span class="ident" id="6404748"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404297">dst</a></span><span class="op" id="6404751">.</span><span class="ident" id="6404752"><a href="/gostd/net/http/server.go.html#4171837">Flush</a></span><span class="op" id="6404757">(</span><span class="op" id="6404758">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6404763"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404528">m</a></span><span class="op" id="6404764">.</span><span class="ident" id="6404765"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404343">lk</a></span><span class="op" id="6404767">.</span><span class="ident" id="6404768"><a href="/gostd/sync/mutex.go.html#1445283">Unlock</a></span><span class="op" id="6404774">(</span><span class="op" id="6404775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6404779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6404782">}</span><br>
<span class="lineno"></span><span class="op" id="6404784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="6404787">func</span>&nbsp;<span class="op" id="6404792">(</span><span class="ident" id="6404793">m</span>&nbsp;<span class="op" id="6404795">*</span><span class="ident" id="6404796"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404270">maxLatencyWriter</a></span><span class="op" id="6404812">)</span>&nbsp;<span class="ident" id="6404814">stop</span><span class="op" id="6404818">(</span><span class="op" id="6404819">)</span>&nbsp;<span class="op" id="6404821">{</span>&nbsp;<span class="ident" id="6404823"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404793">m</a></span><span class="op" id="6404824">.</span><span class="ident" id="6404825"><a href="/gostd/net/http/httputil/reverseproxy.go.html#6404386">done</a></span>&nbsp;<span class="op" id="6404830">&lt;-</span>&nbsp;<span class="builtintype" id="6404833">true</span>&nbsp;<span class="op" id="6404838">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
