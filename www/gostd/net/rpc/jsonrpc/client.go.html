<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc/jsonrpc</h2>
<ul>
<li><a href="/gostd/net/rpc/jsonrpc/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/server.go.html">server.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5126877">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5126933">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5126987">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5127038">//&nbsp;Package&nbsp;jsonrpc&nbsp;implements&nbsp;a&nbsp;JSON-RPC&nbsp;ClientCodec&nbsp;and&nbsp;ServerCodec</span><br>
<span class="lineno"></span><span class="comment" id="5127107">//&nbsp;for&nbsp;the&nbsp;rpc&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="5127131">package</span>&nbsp;<span class="ident" id="5127139">jsonrpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5127148">import</span>&nbsp;<span class="op" id="5127155">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5127158">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5127175">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5127182">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5127188">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5127195">&#34;net/rpc&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5127206">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5127213">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5127216">type</span>&nbsp;<span class="ident" id="5127221">clientCodec</span>&nbsp;<span class="keyword" id="5127233">struct</span>&nbsp;<span class="op" id="5127240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127243">dec</span>&nbsp;<span class="op" id="5127247">*</span><span class="ident" id="5127248">json</span><span class="op" id="5127252">.</span><span class="ident" id="5127253">Decoder</span>&nbsp;<span class="comment" id="5127261">//&nbsp;for&nbsp;reading&nbsp;JSON&nbsp;values</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127289">enc</span>&nbsp;<span class="op" id="5127293">*</span><span class="ident" id="5127294">json</span><span class="op" id="5127298">.</span><span class="ident" id="5127299">Encoder</span>&nbsp;<span class="comment" id="5127307">//&nbsp;for&nbsp;writing&nbsp;JSON&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127335">c</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5127339">io</span><span class="op" id="5127341">.</span><span class="ident" id="5127342">Closer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5127351">//&nbsp;temporary&nbsp;work&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127376">req</span>&nbsp;&nbsp;<span class="ident" id="5127381">clientRequest</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127396">resp</span>&nbsp;<span class="ident" id="5127401">clientResponse</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5127418">//&nbsp;JSON-RPC&nbsp;responses&nbsp;include&nbsp;the&nbsp;request&nbsp;id&nbsp;but&nbsp;not&nbsp;the&nbsp;request&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5127492">//&nbsp;Package&nbsp;rpc&nbsp;expects&nbsp;both.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5127522">//&nbsp;We&nbsp;save&nbsp;the&nbsp;request&nbsp;method&nbsp;in&nbsp;pending&nbsp;when&nbsp;sending&nbsp;a&nbsp;request</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5127587">//&nbsp;and&nbsp;then&nbsp;look&nbsp;it&nbsp;up&nbsp;by&nbsp;request&nbsp;ID&nbsp;when&nbsp;filling&nbsp;out&nbsp;the&nbsp;rpc&nbsp;Response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127660">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5127668">sync</span><span class="op" id="5127672">.</span><span class="ident" id="5127673">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5127686">//&nbsp;protects&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127707">pending</span>&nbsp;<span class="keyword" id="5127715">map</span><span class="op" id="5127718">[</span><span class="ident" id="5127719">uint64</span><span class="op" id="5127725">]</span><span class="builtintype" id="5127726">string</span>&nbsp;<span class="comment" id="5127733">//&nbsp;map&nbsp;request&nbsp;id&nbsp;to&nbsp;method&nbsp;name</span><br>
<span class="lineno"></span><span class="op" id="5127766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="5127769">//&nbsp;NewClientCodec&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.ClientCodec&nbsp;using&nbsp;JSON-RPC&nbsp;on&nbsp;conn.</span><br>
<span class="lineno"></span><span class="keyword" id="5127841">func</span>&nbsp;<span class="ident" id="5127846">NewClientCodec</span><span class="op" id="5127860">(</span><span class="ident" id="5127861">conn</span>&nbsp;<span class="ident" id="5127866">io</span><span class="op" id="5127868">.</span><span class="ident" id="5127869">ReadWriteCloser</span><span class="op" id="5127884">)</span>&nbsp;<span class="ident" id="5127886">rpc</span><span class="op" id="5127889">.</span><span class="ident" id="5127890">ClientCodec</span>&nbsp;<span class="op" id="5127902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5127905">return</span>&nbsp;<span class="op" id="5127912">&amp;</span><span class="ident" id="5127913">clientCodec</span><span class="op" id="5127924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127928">dec</span><span class="op" id="5127931">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5127937">json</span><span class="op" id="5127941">.</span><span class="ident" id="5127942">NewDecoder</span><span class="op" id="5127952">(</span><span class="ident" id="5127953">conn</span><span class="op" id="5127957">)</span><span class="op" id="5127958">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127962">enc</span><span class="op" id="5127965">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5127971">json</span><span class="op" id="5127975">.</span><span class="ident" id="5127976">NewEncoder</span><span class="op" id="5127986">(</span><span class="ident" id="5127987">conn</span><span class="op" id="5127991">)</span><span class="op" id="5127992">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5127996">c</span><span class="op" id="5127997">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5128005">conn</span><span class="op" id="5128009">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128013">pending</span><span class="op" id="5128020">:</span>&nbsp;<span class="builtinfunc" id="5128022">make</span><span class="op" id="5128026">(</span><span class="keyword" id="5128027">map</span><span class="op" id="5128030">[</span><span class="ident" id="5128031">uint64</span><span class="op" id="5128037">]</span><span class="builtintype" id="5128038">string</span><span class="op" id="5128044">)</span><span class="op" id="5128045">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5128048">}</span><br>
<span class="lineno"></span><span class="op" id="5128050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="5128053">type</span>&nbsp;<span class="ident" id="5128058">clientRequest</span>&nbsp;<span class="keyword" id="5128072">struct</span>&nbsp;<span class="op" id="5128079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128082">Method</span>&nbsp;<span class="builtintype" id="5128089">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5128104">`json:&#34;method&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128121">Params</span>&nbsp;<span class="op" id="5128128">[</span><span class="num" id="5128129">1</span><span class="op" id="5128130">]</span><span class="keyword" id="5128131">interface</span><span class="op" id="5128140">{</span><span class="op" id="5128141">}</span>&nbsp;<span class="string" id="5128143">`json:&#34;params&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128160">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5128167">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5128182">`json:&#34;id&#34;`</span><br>
<span class="lineno"></span><span class="op" id="5128194">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="5128197">func</span>&nbsp;<span class="op" id="5128202">(</span><span class="ident" id="5128203">c</span>&nbsp;<span class="op" id="5128205">*</span><span class="ident" id="5128206">clientCodec</span><span class="op" id="5128217">)</span>&nbsp;<span class="ident" id="5128219">WriteRequest</span><span class="op" id="5128231">(</span><span class="ident" id="5128232">r</span>&nbsp;<span class="op" id="5128234">*</span><span class="ident" id="5128235">rpc</span><span class="op" id="5128238">.</span><span class="ident" id="5128239">Request</span><span class="op" id="5128246">,</span>&nbsp;<span class="ident" id="5128248">param</span>&nbsp;<span class="keyword" id="5128254">interface</span><span class="op" id="5128263">{</span><span class="op" id="5128264">}</span><span class="op" id="5128265">)</span>&nbsp;<span class="builtintype" id="5128267">error</span>&nbsp;<span class="op" id="5128273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128276">c</span><span class="op" id="5128277">.</span><span class="ident" id="5128278">mutex</span><span class="op" id="5128283">.</span><span class="ident" id="5128284">Lock</span><span class="op" id="5128288">(</span><span class="op" id="5128289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128292">c</span><span class="op" id="5128293">.</span><span class="ident" id="5128294">pending</span><span class="op" id="5128301">[</span><span class="ident" id="5128302">r</span><span class="op" id="5128303">.</span><span class="ident" id="5128304">Seq</span><span class="op" id="5128307">]</span>&nbsp;<span class="op" id="5128309">=</span>&nbsp;<span class="ident" id="5128311">r</span><span class="op" id="5128312">.</span><span class="ident" id="5128313">ServiceMethod</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128328">c</span><span class="op" id="5128329">.</span><span class="ident" id="5128330">mutex</span><span class="op" id="5128335">.</span><span class="ident" id="5128336">Unlock</span><span class="op" id="5128342">(</span><span class="op" id="5128343">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128346">c</span><span class="op" id="5128347">.</span><span class="ident" id="5128348">req</span><span class="op" id="5128351">.</span><span class="ident" id="5128352">Method</span>&nbsp;<span class="op" id="5128359">=</span>&nbsp;<span class="ident" id="5128361">r</span><span class="op" id="5128362">.</span><span class="ident" id="5128363">ServiceMethod</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128378">c</span><span class="op" id="5128379">.</span><span class="ident" id="5128380">req</span><span class="op" id="5128383">.</span><span class="ident" id="5128384">Params</span><span class="op" id="5128390">[</span><span class="num" id="5128391">0</span><span class="op" id="5128392">]</span>&nbsp;<span class="op" id="5128394">=</span>&nbsp;<span class="ident" id="5128396">param</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128403">c</span><span class="op" id="5128404">.</span><span class="ident" id="5128405">req</span><span class="op" id="5128408">.</span><span class="ident" id="5128409">Id</span>&nbsp;<span class="op" id="5128412">=</span>&nbsp;<span class="ident" id="5128414">r</span><span class="op" id="5128415">.</span><span class="ident" id="5128416">Seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128421">return</span>&nbsp;<span class="ident" id="5128428">c</span><span class="op" id="5128429">.</span><span class="ident" id="5128430">enc</span><span class="op" id="5128433">.</span><span class="ident" id="5128434">Encode</span><span class="op" id="5128440">(</span><span class="op" id="5128441">&amp;</span><span class="ident" id="5128442">c</span><span class="op" id="5128443">.</span><span class="ident" id="5128444">req</span><span class="op" id="5128447">)</span><br>
<span class="lineno"></span><span class="op" id="5128449">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="5128452">type</span>&nbsp;<span class="ident" id="5128457">clientResponse</span>&nbsp;<span class="keyword" id="5128472">struct</span>&nbsp;<span class="op" id="5128479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128482">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5128489">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5128506">`json:&#34;id&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128519">Result</span>&nbsp;<span class="op" id="5128526">*</span><span class="ident" id="5128527">json</span><span class="op" id="5128531">.</span><span class="ident" id="5128532">RawMessage</span>&nbsp;<span class="string" id="5128543">`json:&#34;result&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128560">Error</span>&nbsp;&nbsp;<span class="keyword" id="5128567">interface</span><span class="op" id="5128576">{</span><span class="op" id="5128577">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5128584">`json:&#34;error&#34;`</span><br>
<span class="lineno">65</span><span class="op" id="5128599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5128602">func</span>&nbsp;<span class="op" id="5128607">(</span><span class="ident" id="5128608">r</span>&nbsp;<span class="op" id="5128610">*</span><span class="ident" id="5128611">clientResponse</span><span class="op" id="5128625">)</span>&nbsp;<span class="ident" id="5128627">reset</span><span class="op" id="5128632">(</span><span class="op" id="5128633">)</span>&nbsp;<span class="op" id="5128635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128638">r</span><span class="op" id="5128639">.</span><span class="ident" id="5128640">Id</span>&nbsp;<span class="op" id="5128643">=</span>&nbsp;<span class="num" id="5128645">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128648">r</span><span class="op" id="5128649">.</span><span class="ident" id="5128650">Result</span>&nbsp;<span class="op" id="5128657">=</span>&nbsp;<span class="ident" id="5128659">nil</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128664">r</span><span class="op" id="5128665">.</span><span class="ident" id="5128666">Error</span>&nbsp;<span class="op" id="5128672">=</span>&nbsp;<span class="ident" id="5128674">nil</span><br>
<span class="lineno"></span><span class="op" id="5128678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5128681">func</span>&nbsp;<span class="op" id="5128686">(</span><span class="ident" id="5128687">c</span>&nbsp;<span class="op" id="5128689">*</span><span class="ident" id="5128690">clientCodec</span><span class="op" id="5128701">)</span>&nbsp;<span class="ident" id="5128703">ReadResponseHeader</span><span class="op" id="5128721">(</span><span class="ident" id="5128722">r</span>&nbsp;<span class="op" id="5128724">*</span><span class="ident" id="5128725">rpc</span><span class="op" id="5128728">.</span><span class="ident" id="5128729">Response</span><span class="op" id="5128737">)</span>&nbsp;<span class="builtintype" id="5128739">error</span>&nbsp;<span class="op" id="5128745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128748">c</span><span class="op" id="5128749">.</span><span class="ident" id="5128750">resp</span><span class="op" id="5128754">.</span><span class="ident" id="5128755">reset</span><span class="op" id="5128760">(</span><span class="op" id="5128761">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128764">if</span>&nbsp;<span class="ident" id="5128767">err</span>&nbsp;<span class="op" id="5128771">:=</span>&nbsp;<span class="ident" id="5128774">c</span><span class="op" id="5128775">.</span><span class="ident" id="5128776">dec</span><span class="op" id="5128779">.</span><span class="ident" id="5128780">Decode</span><span class="op" id="5128786">(</span><span class="op" id="5128787">&amp;</span><span class="ident" id="5128788">c</span><span class="op" id="5128789">.</span><span class="ident" id="5128790">resp</span><span class="op" id="5128794">)</span><span class="op" id="5128795">;</span>&nbsp;<span class="ident" id="5128797">err</span>&nbsp;<span class="op" id="5128801">!=</span>&nbsp;<span class="ident" id="5128804">nil</span>&nbsp;<span class="op" id="5128808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128812">return</span>&nbsp;<span class="ident" id="5128819">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5128824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128828">c</span><span class="op" id="5128829">.</span><span class="ident" id="5128830">mutex</span><span class="op" id="5128835">.</span><span class="ident" id="5128836">Lock</span><span class="op" id="5128840">(</span><span class="op" id="5128841">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128844">r</span><span class="op" id="5128845">.</span><span class="ident" id="5128846">ServiceMethod</span>&nbsp;<span class="op" id="5128860">=</span>&nbsp;<span class="ident" id="5128862">c</span><span class="op" id="5128863">.</span><span class="ident" id="5128864">pending</span><span class="op" id="5128871">[</span><span class="ident" id="5128872">c</span><span class="op" id="5128873">.</span><span class="ident" id="5128874">resp</span><span class="op" id="5128878">.</span><span class="ident" id="5128879">Id</span><span class="op" id="5128881">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5128884">delete</span><span class="op" id="5128890">(</span><span class="ident" id="5128891">c</span><span class="op" id="5128892">.</span><span class="ident" id="5128893">pending</span><span class="op" id="5128900">,</span>&nbsp;<span class="ident" id="5128902">c</span><span class="op" id="5128903">.</span><span class="ident" id="5128904">resp</span><span class="op" id="5128908">.</span><span class="ident" id="5128909">Id</span><span class="op" id="5128911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128914">c</span><span class="op" id="5128915">.</span><span class="ident" id="5128916">mutex</span><span class="op" id="5128921">.</span><span class="ident" id="5128922">Unlock</span><span class="op" id="5128928">(</span><span class="op" id="5128929">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128933">r</span><span class="op" id="5128934">.</span><span class="ident" id="5128935">Error</span>&nbsp;<span class="op" id="5128941">=</span>&nbsp;<span class="string" id="5128943">&#34;&#34;</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5128947">r</span><span class="op" id="5128948">.</span><span class="ident" id="5128949">Seq</span>&nbsp;<span class="op" id="5128953">=</span>&nbsp;<span class="ident" id="5128955">c</span><span class="op" id="5128956">.</span><span class="ident" id="5128957">resp</span><span class="op" id="5128961">.</span><span class="ident" id="5128962">Id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5128966">if</span>&nbsp;<span class="ident" id="5128969">c</span><span class="op" id="5128970">.</span><span class="ident" id="5128971">resp</span><span class="op" id="5128975">.</span><span class="ident" id="5128976">Error</span>&nbsp;<span class="op" id="5128982">!=</span>&nbsp;<span class="ident" id="5128985">nil</span>&nbsp;<span class="op" id="5128989">||</span>&nbsp;<span class="ident" id="5128992">c</span><span class="op" id="5128993">.</span><span class="ident" id="5128994">resp</span><span class="op" id="5128998">.</span><span class="ident" id="5128999">Result</span>&nbsp;<span class="op" id="5129006">==</span>&nbsp;<span class="ident" id="5129009">nil</span>&nbsp;<span class="op" id="5129013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129017">x</span><span class="op" id="5129018">,</span>&nbsp;<span class="ident" id="5129020">ok</span>&nbsp;<span class="op" id="5129023">:=</span>&nbsp;<span class="ident" id="5129026">c</span><span class="op" id="5129027">.</span><span class="ident" id="5129028">resp</span><span class="op" id="5129032">.</span><span class="ident" id="5129033">Error</span><span class="op" id="5129038">.</span><span class="op" id="5129039">(</span><span class="builtintype" id="5129040">string</span><span class="op" id="5129046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129050">if</span>&nbsp;<span class="op" id="5129053">!</span><span class="ident" id="5129054">ok</span>&nbsp;<span class="op" id="5129057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129062">return</span>&nbsp;<span class="ident" id="5129069">fmt</span><span class="op" id="5129072">.</span><span class="ident" id="5129073">Errorf</span><span class="op" id="5129079">(</span><span class="string" id="5129080">&#34;invalid&nbsp;error&nbsp;%v&#34;</span><span class="op" id="5129098">,</span>&nbsp;<span class="ident" id="5129100">c</span><span class="op" id="5129101">.</span><span class="ident" id="5129102">resp</span><span class="op" id="5129106">.</span><span class="ident" id="5129107">Error</span><span class="op" id="5129112">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5129116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129120">if</span>&nbsp;<span class="ident" id="5129123">x</span>&nbsp;<span class="op" id="5129125">==</span>&nbsp;<span class="string" id="5129128">&#34;&#34;</span>&nbsp;<span class="op" id="5129131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129136">x</span>&nbsp;<span class="op" id="5129138">=</span>&nbsp;<span class="string" id="5129140">&#34;unspecified&nbsp;error&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5129162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129166">r</span><span class="op" id="5129167">.</span><span class="ident" id="5129168">Error</span>&nbsp;<span class="op" id="5129174">=</span>&nbsp;<span class="ident" id="5129176">x</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5129179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129182">return</span>&nbsp;<span class="ident" id="5129189">nil</span><br>
<span class="lineno"></span><span class="op" id="5129193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5129196">func</span>&nbsp;<span class="op" id="5129201">(</span><span class="ident" id="5129202">c</span>&nbsp;<span class="op" id="5129204">*</span><span class="ident" id="5129205">clientCodec</span><span class="op" id="5129216">)</span>&nbsp;<span class="ident" id="5129218">ReadResponseBody</span><span class="op" id="5129234">(</span><span class="ident" id="5129235">x</span>&nbsp;<span class="keyword" id="5129237">interface</span><span class="op" id="5129246">{</span><span class="op" id="5129247">}</span><span class="op" id="5129248">)</span>&nbsp;<span class="builtintype" id="5129250">error</span>&nbsp;<span class="op" id="5129256">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129259">if</span>&nbsp;<span class="ident" id="5129262">x</span>&nbsp;<span class="op" id="5129264">==</span>&nbsp;<span class="ident" id="5129267">nil</span>&nbsp;<span class="op" id="5129271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129275">return</span>&nbsp;<span class="ident" id="5129282">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5129287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129290">return</span>&nbsp;<span class="ident" id="5129297">json</span><span class="op" id="5129301">.</span><span class="ident" id="5129302">Unmarshal</span><span class="op" id="5129311">(</span><span class="op" id="5129312">*</span><span class="ident" id="5129313">c</span><span class="op" id="5129314">.</span><span class="ident" id="5129315">resp</span><span class="op" id="5129319">.</span><span class="ident" id="5129320">Result</span><span class="op" id="5129326">,</span>&nbsp;<span class="ident" id="5129328">x</span><span class="op" id="5129329">)</span><br>
<span class="lineno"></span><span class="op" id="5129331">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="5129334">func</span>&nbsp;<span class="op" id="5129339">(</span><span class="ident" id="5129340">c</span>&nbsp;<span class="op" id="5129342">*</span><span class="ident" id="5129343">clientCodec</span><span class="op" id="5129354">)</span>&nbsp;<span class="ident" id="5129356">Close</span><span class="op" id="5129361">(</span><span class="op" id="5129362">)</span>&nbsp;<span class="builtintype" id="5129364">error</span>&nbsp;<span class="op" id="5129370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129373">return</span>&nbsp;<span class="ident" id="5129380">c</span><span class="op" id="5129381">.</span><span class="ident" id="5129382">c</span><span class="op" id="5129383">.</span><span class="ident" id="5129384">Close</span><span class="op" id="5129389">(</span><span class="op" id="5129390">)</span><br>
<span class="lineno"></span><span class="op" id="5129392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="5129395">//&nbsp;NewClient&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.Client&nbsp;to&nbsp;handle&nbsp;requests&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5129459">//&nbsp;set&nbsp;of&nbsp;services&nbsp;at&nbsp;the&nbsp;other&nbsp;end&nbsp;of&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5129514">func</span>&nbsp;<span class="ident" id="5129519">NewClient</span><span class="op" id="5129528">(</span><span class="ident" id="5129529">conn</span>&nbsp;<span class="ident" id="5129534">io</span><span class="op" id="5129536">.</span><span class="ident" id="5129537">ReadWriteCloser</span><span class="op" id="5129552">)</span>&nbsp;<span class="op" id="5129554">*</span><span class="ident" id="5129555">rpc</span><span class="op" id="5129558">.</span><span class="ident" id="5129559">Client</span>&nbsp;<span class="op" id="5129566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129569">return</span>&nbsp;<span class="ident" id="5129576">rpc</span><span class="op" id="5129579">.</span><span class="ident" id="5129580">NewClientWithCodec</span><span class="op" id="5129598">(</span><span class="ident" id="5129599">NewClientCodec</span><span class="op" id="5129613">(</span><span class="ident" id="5129614">conn</span><span class="op" id="5129618">)</span><span class="op" id="5129619">)</span><br>
<span class="lineno"></span><span class="op" id="5129621">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="5129624">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;a&nbsp;JSON-RPC&nbsp;server&nbsp;at&nbsp;the&nbsp;specified&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="5129696">func</span>&nbsp;<span class="ident" id="5129701">Dial</span><span class="op" id="5129705">(</span><span class="ident" id="5129706">network</span><span class="op" id="5129713">,</span>&nbsp;<span class="ident" id="5129715">address</span>&nbsp;<span class="builtintype" id="5129723">string</span><span class="op" id="5129729">)</span>&nbsp;<span class="op" id="5129731">(</span><span class="op" id="5129732">*</span><span class="ident" id="5129733">rpc</span><span class="op" id="5129736">.</span><span class="ident" id="5129737">Client</span><span class="op" id="5129743">,</span>&nbsp;<span class="builtintype" id="5129745">error</span><span class="op" id="5129750">)</span>&nbsp;<span class="op" id="5129752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5129755">conn</span><span class="op" id="5129759">,</span>&nbsp;<span class="ident" id="5129761">err</span>&nbsp;<span class="op" id="5129765">:=</span>&nbsp;<span class="ident" id="5129768">net</span><span class="op" id="5129771">.</span><span class="ident" id="5129772">Dial</span><span class="op" id="5129776">(</span><span class="ident" id="5129777">network</span><span class="op" id="5129784">,</span>&nbsp;<span class="ident" id="5129786">address</span><span class="op" id="5129793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129796">if</span>&nbsp;<span class="ident" id="5129799">err</span>&nbsp;<span class="op" id="5129803">!=</span>&nbsp;<span class="ident" id="5129806">nil</span>&nbsp;<span class="op" id="5129810">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129814">return</span>&nbsp;<span class="ident" id="5129821">nil</span><span class="op" id="5129824">,</span>&nbsp;<span class="ident" id="5129826">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5129831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5129834">return</span>&nbsp;<span class="ident" id="5129841">NewClient</span><span class="op" id="5129850">(</span><span class="ident" id="5129851">conn</span><span class="op" id="5129855">)</span><span class="op" id="5129856">,</span>&nbsp;<span class="ident" id="5129858">err</span><br>
<span class="lineno"></span><span class="op" id="5129862">}</span>
</div>
</body>
</html>
