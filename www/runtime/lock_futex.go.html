<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1814061">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1814116">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1814170">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1814221">//&nbsp;+build&nbsp;dragonfly&nbsp;freebsd&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1814256">package</span>&nbsp;<span class="ident" id="1814264">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1814273">import</span>&nbsp;<span class="string" id="1814280">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1814290">//&nbsp;This&nbsp;implementation&nbsp;depends&nbsp;on&nbsp;OS-specific&nbsp;implementations&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1814355">//</span><br>
<span class="lineno"></span><span class="comment" id="1814358">//&nbsp;&nbsp;&nbsp;&nbspruntime路futexsleep(uint32&nbsp;*addr,&nbsp;uint32&nbsp;val,&nbsp;int64&nbsp;ns)</span><br>
<span class="lineno"></span><span class="comment" id="1814417">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspAtomically,</span><br>
<span class="lineno">15</span><span class="comment" id="1814433">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif(*addr&nbsp;==&nbsp;val)&nbsp;sleep</span><br>
<span class="lineno"></span><span class="comment" id="1814461">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspMight&nbsp;be&nbsp;woken&nbsp;up&nbsp;spuriously;&nbsp;that&#39;s&nbsp;allowed.</span><br>
<span class="lineno"></span><span class="comment" id="1814511">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspDon&#39;t&nbsp;sleep&nbsp;longer&nbsp;than&nbsp;ns;&nbsp;ns&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;forever.</span><br>
<span class="lineno"></span><span class="comment" id="1814565">//</span><br>
<span class="lineno"></span><span class="comment" id="1814568">//&nbsp;&nbsp;&nbsp;&nbspruntime路futexwakeup(uint32&nbsp;*addr,&nbsp;uint32&nbsp;cnt)</span><br>
<span class="lineno">20</span><span class="comment" id="1814618">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspIf&nbsp;any&nbsp;procs&nbsp;are&nbsp;sleeping&nbsp;on&nbsp;addr,&nbsp;wake&nbsp;up&nbsp;at&nbsp;most&nbsp;cnt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1814679">const</span>&nbsp;<span class="op" id="1814685">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1814688">mutex_unlocked</span>&nbsp;<span class="op" id="1814703">=</span>&nbsp;<span class="num" id="1814705">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1814708">mutex_locked</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1814723">=</span>&nbsp;<span class="num" id="1814725">1</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1814728">mutex_sleeping</span>&nbsp;<span class="op" id="1814743">=</span>&nbsp;<span class="num" id="1814745">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1814749">active_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1814765">=</span>&nbsp;<span class="num" id="1814767">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1814770">active_spin_cnt</span>&nbsp;<span class="op" id="1814786">=</span>&nbsp;<span class="num" id="1814788">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1814792">passive_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1814808">=</span>&nbsp;<span class="num" id="1814810">1</span><br>
<span class="lineno">30</span><span class="op" id="1814812">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1814815">//&nbsp;Possible&nbsp;lock&nbsp;states&nbsp;are&nbsp;mutex_unlocked,&nbsp;mutex_locked&nbsp;and&nbsp;mutex_sleeping.</span><br>
<span class="lineno"></span><span class="comment" id="1814892">//&nbsp;mutex_sleeping&nbsp;means&nbsp;that&nbsp;there&nbsp;is&nbsp;presumably&nbsp;at&nbsp;least&nbsp;one&nbsp;sleeping&nbsp;thread.</span><br>
<span class="lineno"></span><span class="comment" id="1814971">//&nbsp;Note&nbsp;that&nbsp;there&nbsp;can&nbsp;be&nbsp;spinning&nbsp;threads&nbsp;during&nbsp;all&nbsp;states&nbsp;-&nbsp;they&nbsp;do&nbsp;not</span><br>
<span class="lineno">35</span><span class="comment" id="1815046">//&nbsp;affect&nbsp;mutex&#39;s&nbsp;state.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1815072">func</span>&nbsp;<span class="ident" id="1815077">futexsleep</span><span class="op" id="1815087">(</span><span class="ident" id="1815088">addr</span>&nbsp;<span class="op" id="1815093">*</span><span class="builtintype" id="1815094">uint32</span><span class="op" id="1815100">,</span>&nbsp;<span class="ident" id="1815102">val</span>&nbsp;<span class="builtintype" id="1815106">uint32</span><span class="op" id="1815112">,</span>&nbsp;<span class="ident" id="1815114">ns</span>&nbsp;<span class="ident" id="1815117">int64</span><span class="op" id="1815122">)</span><br>
<span class="lineno"></span><span class="keyword" id="1815124">func</span>&nbsp;<span class="ident" id="1815129">futexwakeup</span><span class="op" id="1815140">(</span><span class="ident" id="1815141">addr</span>&nbsp;<span class="op" id="1815146">*</span><span class="builtintype" id="1815147">uint32</span><span class="op" id="1815153">,</span>&nbsp;<span class="ident" id="1815155">cnt</span>&nbsp;<span class="builtintype" id="1815159">uint32</span><span class="op" id="1815165">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1815168">//&nbsp;We&nbsp;use&nbsp;the&nbsp;uintptr&nbsp;mutex.key&nbsp;and&nbsp;note.key&nbsp;as&nbsp;a&nbsp;uint32.</span><br>
<span class="lineno"></span><span class="keyword" id="1815226">func</span>&nbsp;<span class="ident" id="1815231">key32</span><span class="op" id="1815236">(</span><span class="ident" id="1815237">p</span>&nbsp;<span class="op" id="1815239">*</span><span class="builtintype" id="1815240">uintptr</span><span class="op" id="1815247">)</span>&nbsp;<span class="op" id="1815249">*</span><span class="builtintype" id="1815250">uint32</span>&nbsp;<span class="op" id="1815257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1815260">return</span>&nbsp;<span class="op" id="1815267">(</span><span class="op" id="1815268">*</span><span class="builtintype" id="1815269">uint32</span><span class="op" id="1815275">)</span><span class="op" id="1815276">(</span><span class="ident" id="1815277"><a href="/runtime/lock_futex.go.html#1814280">unsafe</a></span><span class="op" id="1815283">.</span><span class="ident" id="1815284">Pointer</span><span class="op" id="1815291">(</span><span class="ident" id="1815292"><a href="/runtime/lock_futex.go.html#1815237">p</a></span><span class="op" id="1815293">)</span><span class="op" id="1815294">)</span><br>
<span class="lineno"></span><span class="op" id="1815296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="1815299">func</span>&nbsp;<span class="ident" id="1815304">lock</span><span class="op" id="1815308">(</span><span class="ident" id="1815309">l</span>&nbsp;<span class="op" id="1815311">*</span><span class="ident" id="1815312"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2016175">mutex</a></span><span class="op" id="1815317">)</span>&nbsp;<span class="op" id="1815319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1815322">gp</span>&nbsp;<span class="op" id="1815325">:=</span>&nbsp;<span class="ident" id="1815328"><a href="/runtime/stubs.go.html#1968886">getg</a></span><span class="op" id="1815332">(</span><span class="op" id="1815333">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1815337">if</span>&nbsp;<span class="ident" id="1815340"><a href="/runtime/lock_futex.go.html#1815322">gp</a></span><span class="op" id="1815342">.</span><span class="ident" id="1815343">m</span><span class="op" id="1815344">.</span><span class="ident" id="1815345">locks</span>&nbsp;<span class="op" id="1815351">&lt;</span>&nbsp;<span class="num" id="1815353">0</span>&nbsp;<span class="op" id="1815355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1815359"><a href="/runtime/panic.go.html#1894294">gothrow</a></span><span class="op" id="1815366">(</span><span class="string" id="1815367">&#34;runtime路lock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1815394">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1815397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1815400"><a href="/runtime/lock_futex.go.html#1815322">gp</a></span><span class="op" id="1815402">.</span><span class="ident" id="1815403">m</span><span class="op" id="1815404">.</span><span class="ident" id="1815405">locks</span><span class="op" id="1815410">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1815415">//&nbsp;Speculative&nbsp;grab&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1815446">v</span>&nbsp;<span class="op" id="1815448">:=</span>&nbsp;<span class="ident" id="1815451"><a href="/runtime/atomic.go.html#1711033">xchg</a></span><span class="op" id="1815455">(</span><span class="ident" id="1815456"><a href="/runtime/lock_futex.go.html#1815231">key32</a></span><span class="op" id="1815461">(</span><span class="op" id="1815462">&amp;</span><span class="ident" id="1815463"><a href="/runtime/lock_futex.go.html#1815309">l</a></span><span class="op" id="1815464">.</span><span class="ident" id="1815465">key</span><span class="op" id="1815468">)</span><span class="op" id="1815469">,</span>&nbsp;<span class="ident" id="1815471"><a href="/runtime/lock_futex.go.html#1814708">mutex_locked</a></span><span class="op" id="1815483">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1815486">if</span>&nbsp;<span class="ident" id="1815489"><a href="/runtime/lock_futex.go.html#1815446">v</a></span>&nbsp;<span class="op" id="1815491">==</span>&nbsp;<span class="ident" id="1815494"><a href="/runtime/lock_futex.go.html#1814688">mutex_unlocked</a></span>&nbsp;<span class="op" id="1815509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1815513">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1815521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1815525">//&nbsp;wait&nbsp;is&nbsp;either&nbsp;MUTEX_LOCKED&nbsp;or&nbsp;MUTEX_SLEEPING</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1815575">//&nbsp;depending&nbsp;on&nbsp;whether&nbsp;there&nbsp;is&nbsp;a&nbsp;thread&nbsp;sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1815627">//&nbsp;on&nbsp;this&nbsp;mutex.&nbsp;&nbsp;If&nbsp;we&nbsp;ever&nbsp;change&nbsp;l-&gt;key&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1815677">//&nbsp;MUTEX_SLEEPING&nbsp;to&nbsp;some&nbsp;other&nbsp;value,&nbsp;we&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1815728">//&nbsp;careful&nbsp;to&nbsp;change&nbsp;it&nbsp;back&nbsp;to&nbsp;MUTEX_SLEEPING&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1815783">//&nbsp;returning,&nbsp;to&nbsp;ensure&nbsp;that&nbsp;the&nbsp;sleeping&nbsp;thread&nbsp;gets</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1815838">//&nbsp;its&nbsp;wakeup&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1815859">wait</span>&nbsp;<span class="op" id="1815864">:=</span>&nbsp;<span class="ident" id="1815867"><a href="/runtime/lock_futex.go.html#1815446">v</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1815871">//&nbsp;On&nbsp;uniprocessors,&nbsp;no&nbsp;point&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1815912">//&nbsp;On&nbsp;multiprocessors,&nbsp;spin&nbsp;for&nbsp;ACTIVE_SPIN&nbsp;attempts.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1815967">spin</span>&nbsp;<span class="op" id="1815972">:=</span>&nbsp;<span class="num" id="1815975">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1815978">if</span>&nbsp;<span class="ident" id="1815981"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2021317">ncpu</a></span>&nbsp;<span class="op" id="1815986">&gt;</span>&nbsp;<span class="num" id="1815988">1</span>&nbsp;<span class="op" id="1815990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1815994"><a href="/runtime/lock_futex.go.html#1815967">spin</a></span>&nbsp;<span class="op" id="1815999">=</span>&nbsp;<span class="ident" id="1816001"><a href="/runtime/lock_futex.go.html#1814749">active_spin</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1816014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816017">for</span>&nbsp;<span class="op" id="1816021">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1816025">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816054">for</span>&nbsp;<span class="ident" id="1816058">i</span>&nbsp;<span class="op" id="1816060">:=</span>&nbsp;<span class="num" id="1816063">0</span><span class="op" id="1816064">;</span>&nbsp;<span class="ident" id="1816066"><a href="/runtime/lock_futex.go.html#1816058">i</a></span>&nbsp;<span class="op" id="1816068">&lt;</span>&nbsp;<span class="ident" id="1816070"><a href="/runtime/lock_futex.go.html#1815967">spin</a></span><span class="op" id="1816074">;</span>&nbsp;<span class="ident" id="1816076"><a href="/runtime/lock_futex.go.html#1816058">i</a></span><span class="op" id="1816077">++</span>&nbsp;<span class="op" id="1816080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816085">for</span>&nbsp;<span class="ident" id="1816089"><a href="/runtime/lock_futex.go.html#1815309">l</a></span><span class="op" id="1816090">.</span><span class="ident" id="1816091">key</span>&nbsp;<span class="op" id="1816095">==</span>&nbsp;<span class="ident" id="1816098"><a href="/runtime/lock_futex.go.html#1814688">mutex_unlocked</a></span>&nbsp;<span class="op" id="1816113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816119">if</span>&nbsp;<span class="ident" id="1816122"><a href="/runtime/stubs.go.html#1974711">cas</a></span><span class="op" id="1816125">(</span><span class="ident" id="1816126"><a href="/runtime/lock_futex.go.html#1815231">key32</a></span><span class="op" id="1816131">(</span><span class="op" id="1816132">&amp;</span><span class="ident" id="1816133"><a href="/runtime/lock_futex.go.html#1815309">l</a></span><span class="op" id="1816134">.</span><span class="ident" id="1816135">key</span><span class="op" id="1816138">)</span><span class="op" id="1816139">,</span>&nbsp;<span class="ident" id="1816141"><a href="/runtime/lock_futex.go.html#1814688">mutex_unlocked</a></span><span class="op" id="1816155">,</span>&nbsp;<span class="ident" id="1816157"><a href="/runtime/lock_futex.go.html#1815859">wait</a></span><span class="op" id="1816161">)</span>&nbsp;<span class="op" id="1816163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816170">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1816181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1816186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1816191"><a href="/runtime/stubs.go.html#1974412">procyield</a></span><span class="op" id="1816200">(</span><span class="ident" id="1816201"><a href="/runtime/lock_futex.go.html#1814770">active_spin_cnt</a></span><span class="op" id="1816216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1816220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1816225">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;rescheduling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816258">for</span>&nbsp;<span class="ident" id="1816262">i</span>&nbsp;<span class="op" id="1816264">:=</span>&nbsp;<span class="num" id="1816267">0</span><span class="op" id="1816268">;</span>&nbsp;<span class="ident" id="1816270"><a href="/runtime/lock_futex.go.html#1816262">i</a></span>&nbsp;<span class="op" id="1816272">&lt;</span>&nbsp;<span class="ident" id="1816274"><a href="/runtime/lock_futex.go.html#1814792">passive_spin</a></span><span class="op" id="1816286">;</span>&nbsp;<span class="ident" id="1816288"><a href="/runtime/lock_futex.go.html#1816262">i</a></span><span class="op" id="1816289">++</span>&nbsp;<span class="op" id="1816292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816297">for</span>&nbsp;<span class="ident" id="1816301"><a href="/runtime/lock_futex.go.html#1815309">l</a></span><span class="op" id="1816302">.</span><span class="ident" id="1816303">key</span>&nbsp;<span class="op" id="1816307">==</span>&nbsp;<span class="ident" id="1816310"><a href="/runtime/lock_futex.go.html#1814688">mutex_unlocked</a></span>&nbsp;<span class="op" id="1816325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816331">if</span>&nbsp;<span class="ident" id="1816334"><a href="/runtime/stubs.go.html#1974711">cas</a></span><span class="op" id="1816337">(</span><span class="ident" id="1816338"><a href="/runtime/lock_futex.go.html#1815231">key32</a></span><span class="op" id="1816343">(</span><span class="op" id="1816344">&amp;</span><span class="ident" id="1816345"><a href="/runtime/lock_futex.go.html#1815309">l</a></span><span class="op" id="1816346">.</span><span class="ident" id="1816347">key</span><span class="op" id="1816350">)</span><span class="op" id="1816351">,</span>&nbsp;<span class="ident" id="1816353"><a href="/runtime/lock_futex.go.html#1814688">mutex_unlocked</a></span><span class="op" id="1816367">,</span>&nbsp;<span class="ident" id="1816369"><a href="/runtime/lock_futex.go.html#1815859">wait</a></span><span class="op" id="1816373">)</span>&nbsp;<span class="op" id="1816375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816382">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1816393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1816398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1816403"><a href="/runtime/stubs.go.html#1974397">osyield</a></span><span class="op" id="1816410">(</span><span class="op" id="1816411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1816415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1816420">//&nbsp;Sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1816432"><a href="/runtime/lock_futex.go.html#1815446">v</a></span>&nbsp;<span class="op" id="1816434">=</span>&nbsp;<span class="ident" id="1816436"><a href="/runtime/atomic.go.html#1711033">xchg</a></span><span class="op" id="1816440">(</span><span class="ident" id="1816441"><a href="/runtime/lock_futex.go.html#1815231">key32</a></span><span class="op" id="1816446">(</span><span class="op" id="1816447">&amp;</span><span class="ident" id="1816448"><a href="/runtime/lock_futex.go.html#1815309">l</a></span><span class="op" id="1816449">.</span><span class="ident" id="1816450">key</span><span class="op" id="1816453">)</span><span class="op" id="1816454">,</span>&nbsp;<span class="ident" id="1816456"><a href="/runtime/lock_futex.go.html#1814728">mutex_sleeping</a></span><span class="op" id="1816470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816474">if</span>&nbsp;<span class="ident" id="1816477"><a href="/runtime/lock_futex.go.html#1815446">v</a></span>&nbsp;<span class="op" id="1816479">==</span>&nbsp;<span class="ident" id="1816482"><a href="/runtime/lock_futex.go.html#1814688">mutex_unlocked</a></span>&nbsp;<span class="op" id="1816497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816502">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1816511">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1816515"><a href="/runtime/lock_futex.go.html#1815859">wait</a></span>&nbsp;<span class="op" id="1816520">=</span>&nbsp;<span class="ident" id="1816522"><a href="/runtime/lock_futex.go.html#1814728">mutex_sleeping</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1816539"><a href="/runtime/lock_futex.go.html#1815077">futexsleep</a></span><span class="op" id="1816549">(</span><span class="ident" id="1816550"><a href="/runtime/lock_futex.go.html#1815231">key32</a></span><span class="op" id="1816555">(</span><span class="op" id="1816556">&amp;</span><span class="ident" id="1816557"><a href="/runtime/lock_futex.go.html#1815309">l</a></span><span class="op" id="1816558">.</span><span class="ident" id="1816559">key</span><span class="op" id="1816562">)</span><span class="op" id="1816563">,</span>&nbsp;<span class="ident" id="1816565"><a href="/runtime/lock_futex.go.html#1814728">mutex_sleeping</a></span><span class="op" id="1816579">,</span>&nbsp;<span class="op" id="1816581">-</span><span class="num" id="1816582">1</span><span class="op" id="1816583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1816586">}</span><br>
<span class="lineno"></span><span class="op" id="1816588">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="1816591">func</span>&nbsp;<span class="ident" id="1816596">unlock</span><span class="op" id="1816602">(</span><span class="ident" id="1816603">l</span>&nbsp;<span class="op" id="1816605">*</span><span class="ident" id="1816606"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2016175">mutex</a></span><span class="op" id="1816611">)</span>&nbsp;<span class="op" id="1816613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1816616">v</span>&nbsp;<span class="op" id="1816618">:=</span>&nbsp;<span class="ident" id="1816621"><a href="/runtime/atomic.go.html#1711033">xchg</a></span><span class="op" id="1816625">(</span><span class="ident" id="1816626"><a href="/runtime/lock_futex.go.html#1815231">key32</a></span><span class="op" id="1816631">(</span><span class="op" id="1816632">&amp;</span><span class="ident" id="1816633"><a href="/runtime/lock_futex.go.html#1816603">l</a></span><span class="op" id="1816634">.</span><span class="ident" id="1816635">key</span><span class="op" id="1816638">)</span><span class="op" id="1816639">,</span>&nbsp;<span class="ident" id="1816641"><a href="/runtime/lock_futex.go.html#1814688">mutex_unlocked</a></span><span class="op" id="1816655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816658">if</span>&nbsp;<span class="ident" id="1816661"><a href="/runtime/lock_futex.go.html#1816616">v</a></span>&nbsp;<span class="op" id="1816663">==</span>&nbsp;<span class="ident" id="1816666"><a href="/runtime/lock_futex.go.html#1814688">mutex_unlocked</a></span>&nbsp;<span class="op" id="1816681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1816685"><a href="/runtime/panic.go.html#1894294">gothrow</a></span><span class="op" id="1816692">(</span><span class="string" id="1816693">&#34;unlock&nbsp;of&nbsp;unlocked&nbsp;lock&#34;</span><span class="op" id="1816718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1816721">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816724">if</span>&nbsp;<span class="ident" id="1816727"><a href="/runtime/lock_futex.go.html#1816616">v</a></span>&nbsp;<span class="op" id="1816729">==</span>&nbsp;<span class="ident" id="1816732"><a href="/runtime/lock_futex.go.html#1814728">mutex_sleeping</a></span>&nbsp;<span class="op" id="1816747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1816751"><a href="/runtime/lock_futex.go.html#1815129">futexwakeup</a></span><span class="op" id="1816762">(</span><span class="ident" id="1816763"><a href="/runtime/lock_futex.go.html#1815231">key32</a></span><span class="op" id="1816768">(</span><span class="op" id="1816769">&amp;</span><span class="ident" id="1816770"><a href="/runtime/lock_futex.go.html#1816603">l</a></span><span class="op" id="1816771">.</span><span class="ident" id="1816772">key</span><span class="op" id="1816775">)</span><span class="op" id="1816776">,</span>&nbsp;<span class="num" id="1816778">1</span><span class="op" id="1816779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1816782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1816786">gp</span>&nbsp;<span class="op" id="1816789">:=</span>&nbsp;<span class="ident" id="1816792"><a href="/runtime/stubs.go.html#1968886">getg</a></span><span class="op" id="1816796">(</span><span class="op" id="1816797">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1816800"><a href="/runtime/lock_futex.go.html#1816786">gp</a></span><span class="op" id="1816802">.</span><span class="ident" id="1816803">m</span><span class="op" id="1816804">.</span><span class="ident" id="1816805">locks</span><span class="op" id="1816810">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816814">if</span>&nbsp;<span class="ident" id="1816817"><a href="/runtime/lock_futex.go.html#1816786">gp</a></span><span class="op" id="1816819">.</span><span class="ident" id="1816820">m</span><span class="op" id="1816821">.</span><span class="ident" id="1816822">locks</span>&nbsp;<span class="op" id="1816828">&lt;</span>&nbsp;<span class="num" id="1816830">0</span>&nbsp;<span class="op" id="1816832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1816836"><a href="/runtime/panic.go.html#1894294">gothrow</a></span><span class="op" id="1816843">(</span><span class="string" id="1816844">&#34;runtime路unlock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1816873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1816876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1816879">if</span>&nbsp;<span class="ident" id="1816882"><a href="/runtime/lock_futex.go.html#1816786">gp</a></span><span class="op" id="1816884">.</span><span class="ident" id="1816885">m</span><span class="op" id="1816886">.</span><span class="ident" id="1816887">locks</span>&nbsp;<span class="op" id="1816893">==</span>&nbsp;<span class="num" id="1816896">0</span>&nbsp;<span class="op" id="1816898">&amp;&amp;</span>&nbsp;<span class="ident" id="1816901"><a href="/runtime/lock_futex.go.html#1816786">gp</a></span><span class="op" id="1816903">.</span><span class="ident" id="1816904">preempt</span>&nbsp;<span class="op" id="1816912">{</span>&nbsp;<span class="comment" id="1816914">//&nbsp;restore&nbsp;the&nbsp;preemption&nbsp;request&nbsp;in&nbsp;case&nbsp;we&#39;ve&nbsp;cleared&nbsp;it&nbsp;in&nbsp;newstack</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1816987"><a href="/runtime/lock_futex.go.html#1816786">gp</a></span><span class="op" id="1816989">.</span><span class="ident" id="1816990">stackguard0</span>&nbsp;<span class="op" id="1817002">=</span>&nbsp;<span class="ident" id="1817004"><a href="/runtime/stack.go.html#1961891">stackPreempt</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1817018">}</span><br>
<span class="lineno"></span><span class="op" id="1817020">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1817023">//&nbsp;One-time&nbsp;notifications.</span><br>
<span class="lineno">125</span><span class="keyword" id="1817050">func</span>&nbsp;<span class="ident" id="1817055">noteclear</span><span class="op" id="1817064">(</span><span class="ident" id="1817065">n</span>&nbsp;<span class="op" id="1817067">*</span><span class="ident" id="1817068"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2016211">note</a></span><span class="op" id="1817072">)</span>&nbsp;<span class="op" id="1817074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817077"><a href="/runtime/lock_futex.go.html#1817065">n</a></span><span class="op" id="1817078">.</span><span class="ident" id="1817079">key</span>&nbsp;<span class="op" id="1817083">=</span>&nbsp;<span class="num" id="1817085">0</span><br>
<span class="lineno"></span><span class="op" id="1817087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1817090">func</span>&nbsp;<span class="ident" id="1817095">notewakeup</span><span class="op" id="1817105">(</span><span class="ident" id="1817106">n</span>&nbsp;<span class="op" id="1817108">*</span><span class="ident" id="1817109"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2016211">note</a></span><span class="op" id="1817113">)</span>&nbsp;<span class="op" id="1817115">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817118">old</span>&nbsp;<span class="op" id="1817122">:=</span>&nbsp;<span class="ident" id="1817125"><a href="/runtime/atomic.go.html#1711033">xchg</a></span><span class="op" id="1817129">(</span><span class="ident" id="1817130"><a href="/runtime/lock_futex.go.html#1815231">key32</a></span><span class="op" id="1817135">(</span><span class="op" id="1817136">&amp;</span><span class="ident" id="1817137"><a href="/runtime/lock_futex.go.html#1817106">n</a></span><span class="op" id="1817138">.</span><span class="ident" id="1817139">key</span><span class="op" id="1817142">)</span><span class="op" id="1817143">,</span>&nbsp;<span class="num" id="1817145">1</span><span class="op" id="1817146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1817149">if</span>&nbsp;<span class="ident" id="1817152"><a href="/runtime/lock_futex.go.html#1817118">old</a></span>&nbsp;<span class="op" id="1817156">!=</span>&nbsp;<span class="num" id="1817159">0</span>&nbsp;<span class="op" id="1817161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1817165">print</span><span class="op" id="1817170">(</span><span class="string" id="1817171">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&nbsp;(&#34;</span><span class="op" id="1817201">,</span>&nbsp;<span class="ident" id="1817203"><a href="/runtime/lock_futex.go.html#1817118">old</a></span><span class="op" id="1817206">,</span>&nbsp;<span class="string" id="1817208">&#34;)\n&#34;</span><span class="op" id="1817213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817217"><a href="/runtime/panic.go.html#1894294">gothrow</a></span><span class="op" id="1817224">(</span><span class="string" id="1817225">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&#34;</span><span class="op" id="1817253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1817256">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817259"><a href="/runtime/lock_futex.go.html#1815129">futexwakeup</a></span><span class="op" id="1817270">(</span><span class="ident" id="1817271"><a href="/runtime/lock_futex.go.html#1815231">key32</a></span><span class="op" id="1817276">(</span><span class="op" id="1817277">&amp;</span><span class="ident" id="1817278"><a href="/runtime/lock_futex.go.html#1817106">n</a></span><span class="op" id="1817279">.</span><span class="ident" id="1817280">key</span><span class="op" id="1817283">)</span><span class="op" id="1817284">,</span>&nbsp;<span class="num" id="1817286">1</span><span class="op" id="1817287">)</span><br>
<span class="lineno"></span><span class="op" id="1817289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1817292">func</span>&nbsp;<span class="ident" id="1817297">notesleep</span><span class="op" id="1817306">(</span><span class="ident" id="1817307">n</span>&nbsp;<span class="op" id="1817309">*</span><span class="ident" id="1817310"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2016211">note</a></span><span class="op" id="1817314">)</span>&nbsp;<span class="op" id="1817316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817319">gp</span>&nbsp;<span class="op" id="1817322">:=</span>&nbsp;<span class="ident" id="1817325"><a href="/runtime/stubs.go.html#1968886">getg</a></span><span class="op" id="1817329">(</span><span class="op" id="1817330">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1817333">if</span>&nbsp;<span class="ident" id="1817336"><a href="/runtime/lock_futex.go.html#1817319">gp</a></span>&nbsp;<span class="op" id="1817339">!=</span>&nbsp;<span class="ident" id="1817342"><a href="/runtime/lock_futex.go.html#1817319">gp</a></span><span class="op" id="1817344">.</span><span class="ident" id="1817345">m</span><span class="op" id="1817346">.</span><span class="ident" id="1817347">g0</span>&nbsp;<span class="op" id="1817350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817354"><a href="/runtime/panic.go.html#1894294">gothrow</a></span><span class="op" id="1817361">(</span><span class="string" id="1817362">&#34;notesleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1817383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1817386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1817389">for</span>&nbsp;<span class="ident" id="1817393"><a href="/runtime/atomic.go.html#1711297">atomicload</a></span><span class="op" id="1817403">(</span><span class="ident" id="1817404"><a href="/runtime/lock_futex.go.html#1815231">key32</a></span><span class="op" id="1817409">(</span><span class="op" id="1817410">&amp;</span><span class="ident" id="1817411"><a href="/runtime/lock_futex.go.html#1817307">n</a></span><span class="op" id="1817412">.</span><span class="ident" id="1817413">key</span><span class="op" id="1817416">)</span><span class="op" id="1817417">)</span>&nbsp;<span class="op" id="1817419">==</span>&nbsp;<span class="num" id="1817422">0</span>&nbsp;<span class="op" id="1817424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817428"><a href="/runtime/lock_futex.go.html#1817319">gp</a></span><span class="op" id="1817430">.</span><span class="ident" id="1817431">m</span><span class="op" id="1817432">.</span><span class="ident" id="1817433">blocked</span>&nbsp;<span class="op" id="1817441">=</span>&nbsp;<span class="ident" id="1817443">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817450"><a href="/runtime/lock_futex.go.html#1815077">futexsleep</a></span><span class="op" id="1817460">(</span><span class="ident" id="1817461"><a href="/runtime/lock_futex.go.html#1815231">key32</a></span><span class="op" id="1817466">(</span><span class="op" id="1817467">&amp;</span><span class="ident" id="1817468"><a href="/runtime/lock_futex.go.html#1817307">n</a></span><span class="op" id="1817469">.</span><span class="ident" id="1817470">key</span><span class="op" id="1817473">)</span><span class="op" id="1817474">,</span>&nbsp;<span class="num" id="1817476">0</span><span class="op" id="1817477">,</span>&nbsp;<span class="op" id="1817479">-</span><span class="num" id="1817480">1</span><span class="op" id="1817481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817485"><a href="/runtime/lock_futex.go.html#1817319">gp</a></span><span class="op" id="1817487">.</span><span class="ident" id="1817488">m</span><span class="op" id="1817489">.</span><span class="ident" id="1817490">blocked</span>&nbsp;<span class="op" id="1817498">=</span>&nbsp;<span class="ident" id="1817500">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1817507">}</span><br>
<span class="lineno"></span><span class="op" id="1817509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="1817512">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1817525">func</span>&nbsp;<span class="ident" id="1817530">notetsleep_internal</span><span class="op" id="1817549">(</span><span class="ident" id="1817550">n</span>&nbsp;<span class="op" id="1817552">*</span><span class="ident" id="1817553"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2016211">note</a></span><span class="op" id="1817557">,</span>&nbsp;<span class="ident" id="1817559">ns</span>&nbsp;<span class="ident" id="1817562">int64</span><span class="op" id="1817567">)</span>&nbsp;<span class="builtintype" id="1817569">bool</span>&nbsp;<span class="op" id="1817574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817577">gp</span>&nbsp;<span class="op" id="1817580">:=</span>&nbsp;<span class="ident" id="1817583"><a href="/runtime/stubs.go.html#1968886">getg</a></span><span class="op" id="1817587">(</span><span class="op" id="1817588">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1817592">if</span>&nbsp;<span class="ident" id="1817595"><a href="/runtime/lock_futex.go.html#1817559">ns</a></span>&nbsp;<span class="op" id="1817598">&lt;</span>&nbsp;<span class="num" id="1817600">0</span>&nbsp;<span class="op" id="1817602">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1817606">for</span>&nbsp;<span class="ident" id="1817610"><a href="/runtime/atomic.go.html#1711297">atomicload</a></span><span class="op" id="1817620">(</span><span class="ident" id="1817621"><a href="/runtime/lock_futex.go.html#1815231">key32</a></span><span class="op" id="1817626">(</span><span class="op" id="1817627">&amp;</span><span class="ident" id="1817628"><a href="/runtime/lock_futex.go.html#1817550">n</a></span><span class="op" id="1817629">.</span><span class="ident" id="1817630">key</span><span class="op" id="1817633">)</span><span class="op" id="1817634">)</span>&nbsp;<span class="op" id="1817636">==</span>&nbsp;<span class="num" id="1817639">0</span>&nbsp;<span class="op" id="1817641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817646"><a href="/runtime/lock_futex.go.html#1817577">gp</a></span><span class="op" id="1817648">.</span><span class="ident" id="1817649">m</span><span class="op" id="1817650">.</span><span class="ident" id="1817651">blocked</span>&nbsp;<span class="op" id="1817659">=</span>&nbsp;<span class="ident" id="1817661">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817669"><a href="/runtime/lock_futex.go.html#1815077">futexsleep</a></span><span class="op" id="1817679">(</span><span class="ident" id="1817680"><a href="/runtime/lock_futex.go.html#1815231">key32</a></span><span class="op" id="1817685">(</span><span class="op" id="1817686">&amp;</span><span class="ident" id="1817687"><a href="/runtime/lock_futex.go.html#1817550">n</a></span><span class="op" id="1817688">.</span><span class="ident" id="1817689">key</span><span class="op" id="1817692">)</span><span class="op" id="1817693">,</span>&nbsp;<span class="num" id="1817695">0</span><span class="op" id="1817696">,</span>&nbsp;<span class="op" id="1817698">-</span><span class="num" id="1817699">1</span><span class="op" id="1817700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817705"><a href="/runtime/lock_futex.go.html#1817577">gp</a></span><span class="op" id="1817707">.</span><span class="ident" id="1817708">m</span><span class="op" id="1817709">.</span><span class="ident" id="1817710">blocked</span>&nbsp;<span class="op" id="1817718">=</span>&nbsp;<span class="ident" id="1817720">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1817728">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1817732">return</span>&nbsp;<span class="ident" id="1817739">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1817745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1817749">if</span>&nbsp;<span class="ident" id="1817752"><a href="/runtime/atomic.go.html#1711297">atomicload</a></span><span class="op" id="1817762">(</span><span class="ident" id="1817763"><a href="/runtime/lock_futex.go.html#1815231">key32</a></span><span class="op" id="1817768">(</span><span class="op" id="1817769">&amp;</span><span class="ident" id="1817770"><a href="/runtime/lock_futex.go.html#1817550">n</a></span><span class="op" id="1817771">.</span><span class="ident" id="1817772">key</span><span class="op" id="1817775">)</span><span class="op" id="1817776">)</span>&nbsp;<span class="op" id="1817778">!=</span>&nbsp;<span class="num" id="1817781">0</span>&nbsp;<span class="op" id="1817783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1817787">return</span>&nbsp;<span class="ident" id="1817794">true</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1817800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817804">deadline</span>&nbsp;<span class="op" id="1817813">:=</span>&nbsp;<span class="ident" id="1817816"><a href="/runtime/stubs.go.html#1973903">nanotime</a></span><span class="op" id="1817824">(</span><span class="op" id="1817825">)</span>&nbsp;<span class="op" id="1817827">+</span>&nbsp;<span class="ident" id="1817829"><a href="/runtime/lock_futex.go.html#1817559">ns</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1817833">for</span>&nbsp;<span class="op" id="1817837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817841"><a href="/runtime/lock_futex.go.html#1817577">gp</a></span><span class="op" id="1817843">.</span><span class="ident" id="1817844">m</span><span class="op" id="1817845">.</span><span class="ident" id="1817846">blocked</span>&nbsp;<span class="op" id="1817854">=</span>&nbsp;<span class="ident" id="1817856">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817863"><a href="/runtime/lock_futex.go.html#1815077">futexsleep</a></span><span class="op" id="1817873">(</span><span class="ident" id="1817874"><a href="/runtime/lock_futex.go.html#1815231">key32</a></span><span class="op" id="1817879">(</span><span class="op" id="1817880">&amp;</span><span class="ident" id="1817881"><a href="/runtime/lock_futex.go.html#1817550">n</a></span><span class="op" id="1817882">.</span><span class="ident" id="1817883">key</span><span class="op" id="1817886">)</span><span class="op" id="1817887">,</span>&nbsp;<span class="num" id="1817889">0</span><span class="op" id="1817890">,</span>&nbsp;<span class="ident" id="1817892"><a href="/runtime/lock_futex.go.html#1817559">ns</a></span><span class="op" id="1817894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817898"><a href="/runtime/lock_futex.go.html#1817577">gp</a></span><span class="op" id="1817900">.</span><span class="ident" id="1817901">m</span><span class="op" id="1817902">.</span><span class="ident" id="1817903">blocked</span>&nbsp;<span class="op" id="1817911">=</span>&nbsp;<span class="ident" id="1817913">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1817921">if</span>&nbsp;<span class="ident" id="1817924"><a href="/runtime/atomic.go.html#1711297">atomicload</a></span><span class="op" id="1817934">(</span><span class="ident" id="1817935"><a href="/runtime/lock_futex.go.html#1815231">key32</a></span><span class="op" id="1817940">(</span><span class="op" id="1817941">&amp;</span><span class="ident" id="1817942"><a href="/runtime/lock_futex.go.html#1817550">n</a></span><span class="op" id="1817943">.</span><span class="ident" id="1817944">key</span><span class="op" id="1817947">)</span><span class="op" id="1817948">)</span>&nbsp;<span class="op" id="1817950">!=</span>&nbsp;<span class="num" id="1817953">0</span>&nbsp;<span class="op" id="1817955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1817960">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1817968">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1817972">now</span>&nbsp;<span class="op" id="1817976">:=</span>&nbsp;<span class="ident" id="1817979"><a href="/runtime/stubs.go.html#1973903">nanotime</a></span><span class="op" id="1817987">(</span><span class="op" id="1817988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1817992">if</span>&nbsp;<span class="ident" id="1817995"><a href="/runtime/lock_futex.go.html#1817972">now</a></span>&nbsp;<span class="op" id="1817999">&gt;=</span>&nbsp;<span class="ident" id="1818002"><a href="/runtime/lock_futex.go.html#1817804">deadline</a></span>&nbsp;<span class="op" id="1818011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1818016">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1818024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1818028"><a href="/runtime/lock_futex.go.html#1817559">ns</a></span>&nbsp;<span class="op" id="1818031">=</span>&nbsp;<span class="ident" id="1818033"><a href="/runtime/lock_futex.go.html#1817804">deadline</a></span>&nbsp;<span class="op" id="1818042">-</span>&nbsp;<span class="ident" id="1818044"><a href="/runtime/lock_futex.go.html#1817972">now</a></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1818049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1818052">return</span>&nbsp;<span class="ident" id="1818059"><a href="/runtime/atomic.go.html#1711297">atomicload</a></span><span class="op" id="1818069">(</span><span class="ident" id="1818070"><a href="/runtime/lock_futex.go.html#1815231">key32</a></span><span class="op" id="1818075">(</span><span class="op" id="1818076">&amp;</span><span class="ident" id="1818077"><a href="/runtime/lock_futex.go.html#1817550">n</a></span><span class="op" id="1818078">.</span><span class="ident" id="1818079">key</span><span class="op" id="1818082">)</span><span class="op" id="1818083">)</span>&nbsp;<span class="op" id="1818085">!=</span>&nbsp;<span class="num" id="1818088">0</span><br>
<span class="lineno"></span><span class="op" id="1818090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1818093">func</span>&nbsp;<span class="ident" id="1818098">notetsleep</span><span class="op" id="1818108">(</span><span class="ident" id="1818109">n</span>&nbsp;<span class="op" id="1818111">*</span><span class="ident" id="1818112"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2016211">note</a></span><span class="op" id="1818116">,</span>&nbsp;<span class="ident" id="1818118">ns</span>&nbsp;<span class="ident" id="1818121">int64</span><span class="op" id="1818126">)</span>&nbsp;<span class="builtintype" id="1818128">bool</span>&nbsp;<span class="op" id="1818133">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1818136">gp</span>&nbsp;<span class="op" id="1818139">:=</span>&nbsp;<span class="ident" id="1818142"><a href="/runtime/stubs.go.html#1968886">getg</a></span><span class="op" id="1818146">(</span><span class="op" id="1818147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1818150">if</span>&nbsp;<span class="ident" id="1818153"><a href="/runtime/lock_futex.go.html#1818136">gp</a></span>&nbsp;<span class="op" id="1818156">!=</span>&nbsp;<span class="ident" id="1818159"><a href="/runtime/lock_futex.go.html#1818136">gp</a></span><span class="op" id="1818161">.</span><span class="ident" id="1818162">m</span><span class="op" id="1818163">.</span><span class="ident" id="1818164">g0</span>&nbsp;<span class="op" id="1818167">&amp;&amp;</span>&nbsp;<span class="ident" id="1818170"><a href="/runtime/lock_futex.go.html#1818136">gp</a></span><span class="op" id="1818172">.</span><span class="ident" id="1818173">m</span><span class="op" id="1818174">.</span><span class="ident" id="1818175">gcing</span>&nbsp;<span class="op" id="1818181">==</span>&nbsp;<span class="num" id="1818184">0</span>&nbsp;<span class="op" id="1818186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1818190"><a href="/runtime/panic.go.html#1894294">gothrow</a></span><span class="op" id="1818197">(</span><span class="string" id="1818198">&#34;notetsleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1818220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1818223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1818227">return</span>&nbsp;<span class="ident" id="1818234"><a href="/runtime/lock_futex.go.html#1817530">notetsleep_internal</a></span><span class="op" id="1818253">(</span><span class="ident" id="1818254"><a href="/runtime/lock_futex.go.html#1818109">n</a></span><span class="op" id="1818255">,</span>&nbsp;<span class="ident" id="1818257"><a href="/runtime/lock_futex.go.html#1818118">ns</a></span><span class="op" id="1818259">)</span><br>
<span class="lineno"></span><span class="op" id="1818261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1818264">//&nbsp;same&nbsp;as&nbsp;runtime路notetsleep,&nbsp;but&nbsp;called&nbsp;on&nbsp;user&nbsp;g&nbsp;(not&nbsp;g0)</span><br>
<span class="lineno"></span><span class="comment" id="1818326">//&nbsp;calls&nbsp;only&nbsp;nosplit&nbsp;functions&nbsp;between&nbsp;entersyscallblock/exitsyscall</span><br>
<span class="lineno">195</span><span class="keyword" id="1818396">func</span>&nbsp;<span class="ident" id="1818401">notetsleepg</span><span class="op" id="1818412">(</span><span class="ident" id="1818413">n</span>&nbsp;<span class="op" id="1818415">*</span><span class="ident" id="1818416"><a href="/runtime/zruntime_defs_linux_amd64.go.html#2016211">note</a></span><span class="op" id="1818420">,</span>&nbsp;<span class="ident" id="1818422">ns</span>&nbsp;<span class="ident" id="1818425">int64</span><span class="op" id="1818430">)</span>&nbsp;<span class="builtintype" id="1818432">bool</span>&nbsp;<span class="op" id="1818437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1818440">gp</span>&nbsp;<span class="op" id="1818443">:=</span>&nbsp;<span class="ident" id="1818446"><a href="/runtime/stubs.go.html#1968886">getg</a></span><span class="op" id="1818450">(</span><span class="op" id="1818451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1818454">if</span>&nbsp;<span class="ident" id="1818457"><a href="/runtime/lock_futex.go.html#1818440">gp</a></span>&nbsp;<span class="op" id="1818460">==</span>&nbsp;<span class="ident" id="1818463"><a href="/runtime/lock_futex.go.html#1818440">gp</a></span><span class="op" id="1818465">.</span><span class="ident" id="1818466">m</span><span class="op" id="1818467">.</span><span class="ident" id="1818468">g0</span>&nbsp;<span class="op" id="1818471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1818475"><a href="/runtime/panic.go.html#1894294">gothrow</a></span><span class="op" id="1818482">(</span><span class="string" id="1818483">&#34;notetsleepg&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1818502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1818505">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1818509"><a href="/runtime/stubs.go.html#1973457">entersyscallblock</a></span><span class="op" id="1818526">(</span><span class="op" id="1818527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1818530">ok</span>&nbsp;<span class="op" id="1818533">:=</span>&nbsp;<span class="ident" id="1818536"><a href="/runtime/lock_futex.go.html#1817530">notetsleep_internal</a></span><span class="op" id="1818555">(</span><span class="ident" id="1818556"><a href="/runtime/lock_futex.go.html#1818413">n</a></span><span class="op" id="1818557">,</span>&nbsp;<span class="ident" id="1818559"><a href="/runtime/lock_futex.go.html#1818422">ns</a></span><span class="op" id="1818561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1818564"><a href="/runtime/stubs.go.html#1973482">exitsyscall</a></span><span class="op" id="1818575">(</span><span class="op" id="1818576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1818579">return</span>&nbsp;<span class="ident" id="1818586"><a href="/runtime/lock_futex.go.html#1818530">ok</a></span><br>
<span class="lineno">205</span><span class="op" id="1818589">}</span>
</div>
</body>
</html>
