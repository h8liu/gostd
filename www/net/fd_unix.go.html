<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="2575075">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2575130">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2575184">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2575235">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2575305">package</span>&nbsp;<span class="ident" id="2575313">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2575318">import</span>&nbsp;<span class="op" id="2575325">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2575328">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2575334">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2575340">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2575351">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2575366">&#34;syscall&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2575377">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="2575384">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2575387">//&nbsp;Network&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="2575415">type</span>&nbsp;<span class="ident" id="2575420">netFD</span>&nbsp;<span class="keyword" id="2575426">struct</span>&nbsp;<span class="op" id="2575433">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2575436">//&nbsp;locking/lifetime&nbsp;of&nbsp;sysfd&nbsp;+&nbsp;serialize&nbsp;access&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2575511">fdmu</span>&nbsp;<span class="ident" id="2575516"><a href="/net/fd_mutex.go.html#2567642">fdMutex</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2575526">//&nbsp;immutable&nbsp;until&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2575552">sysfd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2575564">int</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2575569">family</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2575581">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2575586">sotype</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2575598">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2575603">isConnected</span>&nbsp;<span class="builtintype" id="2575615">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2575621">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2575633">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2575641">laddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2575653"><a href="/net/net.go.html#2652238">Addr</a></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2575659">raddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2575671"><a href="/net/net.go.html#2652238">Addr</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2575678">//&nbsp;wait&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2575694">pd</span>&nbsp;<span class="ident" id="2575697"><a href="/net/fd_poll_runtime.go.html#2572829">pollDesc</a></span><br>
<span class="lineno"></span><span class="op" id="2575706">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="2575709">func</span>&nbsp;<span class="ident" id="2575714">sysInit</span><span class="op" id="2575721">(</span><span class="op" id="2575722">)</span>&nbsp;<span class="op" id="2575724">{</span><br>
<span class="lineno"></span><span class="op" id="2575726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2575729">func</span>&nbsp;<span class="ident" id="2575734">dial</span><span class="op" id="2575738">(</span><span class="ident" id="2575739">network</span>&nbsp;<span class="builtintype" id="2575747">string</span><span class="op" id="2575753">,</span>&nbsp;<span class="ident" id="2575755">ra</span>&nbsp;<span class="ident" id="2575758"><a href="/net/net.go.html#2652238">Addr</a></span><span class="op" id="2575762">,</span>&nbsp;<span class="ident" id="2575764">dialer</span>&nbsp;<span class="keyword" id="2575771">func</span><span class="op" id="2575775">(</span><span class="ident" id="2575776"><a href="/net/fd_unix.go.html#2575377">time</a></span><span class="op" id="2575780">.</span><span class="ident" id="2575781">Time</span><span class="op" id="2575785">)</span>&nbsp;<span class="op" id="2575787">(</span><span class="ident" id="2575788"><a href="/net/net.go.html#2652476">Conn</a></span><span class="op" id="2575792">,</span>&nbsp;<span class="builtintype" id="2575794">error</span><span class="op" id="2575799">)</span><span class="op" id="2575800">,</span>&nbsp;<span class="ident" id="2575802">deadline</span>&nbsp;<span class="ident" id="2575811"><a href="/net/fd_unix.go.html#2575377">time</a></span><span class="op" id="2575815">.</span><span class="ident" id="2575816">Time</span><span class="op" id="2575820">)</span>&nbsp;<span class="op" id="2575822">(</span><span class="ident" id="2575823"><a href="/net/net.go.html#2652476">Conn</a></span><span class="op" id="2575827">,</span>&nbsp;<span class="builtintype" id="2575829">error</span><span class="op" id="2575834">)</span>&nbsp;<span class="op" id="2575836">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2575839">return</span>&nbsp;<span class="ident" id="2575846"><a href="/net/fd_unix.go.html#2575764">dialer</a></span><span class="op" id="2575852">(</span><span class="ident" id="2575853"><a href="/net/fd_unix.go.html#2575802">deadline</a></span><span class="op" id="2575861">)</span><br>
<span class="lineno"></span><span class="op" id="2575863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2575866">func</span>&nbsp;<span class="ident" id="2575871">newFD</span><span class="op" id="2575876">(</span><span class="ident" id="2575877">sysfd</span><span class="op" id="2575882">,</span>&nbsp;<span class="ident" id="2575884">family</span><span class="op" id="2575890">,</span>&nbsp;<span class="ident" id="2575892">sotype</span>&nbsp;<span class="builtintype" id="2575899">int</span><span class="op" id="2575902">,</span>&nbsp;<span class="ident" id="2575904">net</span>&nbsp;<span class="builtintype" id="2575908">string</span><span class="op" id="2575914">)</span>&nbsp;<span class="op" id="2575916">(</span><span class="op" id="2575917">*</span><span class="ident" id="2575918"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2575923">,</span>&nbsp;<span class="builtintype" id="2575925">error</span><span class="op" id="2575930">)</span>&nbsp;<span class="op" id="2575932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2575935">return</span>&nbsp;<span class="op" id="2575942">&amp;</span><span class="ident" id="2575943"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2575948">{</span><span class="ident" id="2575949">sysfd</span><span class="op" id="2575954">:</span>&nbsp;<span class="ident" id="2575956"><a href="/net/fd_unix.go.html#2575877">sysfd</a></span><span class="op" id="2575961">,</span>&nbsp;<span class="ident" id="2575963">family</span><span class="op" id="2575969">:</span>&nbsp;<span class="ident" id="2575971"><a href="/net/fd_unix.go.html#2575884">family</a></span><span class="op" id="2575977">,</span>&nbsp;<span class="ident" id="2575979">sotype</span><span class="op" id="2575985">:</span>&nbsp;<span class="ident" id="2575987"><a href="/net/fd_unix.go.html#2575892">sotype</a></span><span class="op" id="2575993">,</span>&nbsp;<span class="ident" id="2575995">net</span><span class="op" id="2575998">:</span>&nbsp;<span class="ident" id="2576000"><a href="/net/fd_unix.go.html#2575904">net</a></span><span class="op" id="2576003">}</span><span class="op" id="2576004">,</span>&nbsp;<span class="ident" id="2576006">nil</span><br>
<span class="lineno">45</span><span class="op" id="2576010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2576013">func</span>&nbsp;<span class="op" id="2576018">(</span><span class="ident" id="2576019">fd</span>&nbsp;<span class="op" id="2576022">*</span><span class="ident" id="2576023"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2576028">)</span>&nbsp;<span class="ident" id="2576030">init</span><span class="op" id="2576034">(</span><span class="op" id="2576035">)</span>&nbsp;<span class="builtintype" id="2576037">error</span>&nbsp;<span class="op" id="2576043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2576046">if</span>&nbsp;<span class="ident" id="2576049">err</span>&nbsp;<span class="op" id="2576053">:=</span>&nbsp;<span class="ident" id="2576056"><a href="/net/fd_unix.go.html#2576019">fd</a></span><span class="op" id="2576058">.</span><span class="ident" id="2576059">pd</span><span class="op" id="2576061">.</span><span class="ident" id="2576062">Init</span><span class="op" id="2576066">(</span><span class="ident" id="2576067"><a href="/net/fd_unix.go.html#2576019">fd</a></span><span class="op" id="2576069">)</span><span class="op" id="2576070">;</span>&nbsp;<span class="ident" id="2576072"><a href="/net/fd_unix.go.html#2576049">err</a></span>&nbsp;<span class="op" id="2576076">!=</span>&nbsp;<span class="ident" id="2576079">nil</span>&nbsp;<span class="op" id="2576083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2576087">return</span>&nbsp;<span class="ident" id="2576094"><a href="/net/fd_unix.go.html#2576049">err</a></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2576099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2576102">return</span>&nbsp;<span class="ident" id="2576109">nil</span><br>
<span class="lineno"></span><span class="op" id="2576113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2576116">func</span>&nbsp;<span class="op" id="2576121">(</span><span class="ident" id="2576122">fd</span>&nbsp;<span class="op" id="2576125">*</span><span class="ident" id="2576126"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2576131">)</span>&nbsp;<span class="ident" id="2576133">setAddr</span><span class="op" id="2576140">(</span><span class="ident" id="2576141">laddr</span><span class="op" id="2576146">,</span>&nbsp;<span class="ident" id="2576148">raddr</span>&nbsp;<span class="ident" id="2576154"><a href="/net/net.go.html#2652238">Addr</a></span><span class="op" id="2576158">)</span>&nbsp;<span class="op" id="2576160">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2576163"><a href="/net/fd_unix.go.html#2576122">fd</a></span><span class="op" id="2576165">.</span><span class="ident" id="2576166">laddr</span>&nbsp;<span class="op" id="2576172">=</span>&nbsp;<span class="ident" id="2576174"><a href="/net/fd_unix.go.html#2576141">laddr</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2576181"><a href="/net/fd_unix.go.html#2576122">fd</a></span><span class="op" id="2576183">.</span><span class="ident" id="2576184">raddr</span>&nbsp;<span class="op" id="2576190">=</span>&nbsp;<span class="ident" id="2576192"><a href="/net/fd_unix.go.html#2576148">raddr</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2576199"><a href="/net/fd_unix.go.html#2575340">runtime</a></span><span class="op" id="2576206">.</span><span class="ident" id="2576207">SetFinalizer</span><span class="op" id="2576219">(</span><span class="ident" id="2576220"><a href="/net/fd_unix.go.html#2576122">fd</a></span><span class="op" id="2576222">,</span>&nbsp;<span class="op" id="2576224">(</span><span class="op" id="2576225">*</span><span class="ident" id="2576226"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2576231">)</span><span class="op" id="2576232">.</span><span class="ident" id="2576233">Close</span><span class="op" id="2576238">)</span><br>
<span class="lineno"></span><span class="op" id="2576240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="2576243">func</span>&nbsp;<span class="op" id="2576248">(</span><span class="ident" id="2576249">fd</span>&nbsp;<span class="op" id="2576252">*</span><span class="ident" id="2576253"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2576258">)</span>&nbsp;<span class="ident" id="2576260">name</span><span class="op" id="2576264">(</span><span class="op" id="2576265">)</span>&nbsp;<span class="builtintype" id="2576267">string</span>&nbsp;<span class="op" id="2576274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2576277">var</span>&nbsp;<span class="ident" id="2576281">ls</span><span class="op" id="2576283">,</span>&nbsp;<span class="ident" id="2576285">rs</span>&nbsp;<span class="builtintype" id="2576288">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2576296">if</span>&nbsp;<span class="ident" id="2576299"><a href="/net/fd_unix.go.html#2576249">fd</a></span><span class="op" id="2576301">.</span><span class="ident" id="2576302">laddr</span>&nbsp;<span class="op" id="2576308">!=</span>&nbsp;<span class="ident" id="2576311">nil</span>&nbsp;<span class="op" id="2576315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2576319"><a href="/net/fd_unix.go.html#2576281">ls</a></span>&nbsp;<span class="op" id="2576322">=</span>&nbsp;<span class="ident" id="2576324"><a href="/net/fd_unix.go.html#2576249">fd</a></span><span class="op" id="2576326">.</span><span class="ident" id="2576327">laddr</span><span class="op" id="2576332">.</span><span class="ident" id="2576333">String</span><span class="op" id="2576339">(</span><span class="op" id="2576340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2576343">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2576346">if</span>&nbsp;<span class="ident" id="2576349"><a href="/net/fd_unix.go.html#2576249">fd</a></span><span class="op" id="2576351">.</span><span class="ident" id="2576352">raddr</span>&nbsp;<span class="op" id="2576358">!=</span>&nbsp;<span class="ident" id="2576361">nil</span>&nbsp;<span class="op" id="2576365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2576369"><a href="/net/fd_unix.go.html#2576285">rs</a></span>&nbsp;<span class="op" id="2576372">=</span>&nbsp;<span class="ident" id="2576374"><a href="/net/fd_unix.go.html#2576249">fd</a></span><span class="op" id="2576376">.</span><span class="ident" id="2576377">raddr</span><span class="op" id="2576382">.</span><span class="ident" id="2576383">String</span><span class="op" id="2576389">(</span><span class="op" id="2576390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2576393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2576396">return</span>&nbsp;<span class="ident" id="2576403"><a href="/net/fd_unix.go.html#2576249">fd</a></span><span class="op" id="2576405">.</span><span class="ident" id="2576406">net</span>&nbsp;<span class="op" id="2576410">+</span>&nbsp;<span class="string" id="2576412">&#34;:&#34;</span>&nbsp;<span class="op" id="2576416">+</span>&nbsp;<span class="ident" id="2576418"><a href="/net/fd_unix.go.html#2576281">ls</a></span>&nbsp;<span class="op" id="2576421">+</span>&nbsp;<span class="string" id="2576423">&#34;-&gt;&#34;</span>&nbsp;<span class="op" id="2576428">+</span>&nbsp;<span class="ident" id="2576430"><a href="/net/fd_unix.go.html#2576285">rs</a></span><br>
<span class="lineno"></span><span class="op" id="2576433">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="2576436">func</span>&nbsp;<span class="op" id="2576441">(</span><span class="ident" id="2576442">fd</span>&nbsp;<span class="op" id="2576445">*</span><span class="ident" id="2576446"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2576451">)</span>&nbsp;<span class="ident" id="2576453">connect</span><span class="op" id="2576460">(</span><span class="ident" id="2576461">la</span><span class="op" id="2576463">,</span>&nbsp;<span class="ident" id="2576465">ra</span>&nbsp;<span class="ident" id="2576468"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2576475">.</span><span class="ident" id="2576476">Sockaddr</span><span class="op" id="2576484">,</span>&nbsp;<span class="ident" id="2576486">deadline</span>&nbsp;<span class="ident" id="2576495"><a href="/net/fd_unix.go.html#2575377">time</a></span><span class="op" id="2576499">.</span><span class="ident" id="2576500">Time</span><span class="op" id="2576504">)</span>&nbsp;<span class="builtintype" id="2576506">error</span>&nbsp;<span class="op" id="2576512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2576515">//&nbsp;Do&nbsp;not&nbsp;need&nbsp;to&nbsp;call&nbsp;fd.writeLock&nbsp;here,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2576558">//&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;yet&nbsp;accessible&nbsp;to&nbsp;user,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2576604">//&nbsp;so&nbsp;no&nbsp;concurrent&nbsp;operations&nbsp;are&nbsp;possible.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2576650">switch</span>&nbsp;<span class="ident" id="2576657">err</span>&nbsp;<span class="op" id="2576661">:=</span>&nbsp;<span class="ident" id="2576664"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2576671">.</span><span class="ident" id="2576672">Connect</span><span class="op" id="2576679">(</span><span class="ident" id="2576680"><a href="/net/fd_unix.go.html#2576442">fd</a></span><span class="op" id="2576682">.</span><span class="ident" id="2576683">sysfd</span><span class="op" id="2576688">,</span>&nbsp;<span class="ident" id="2576690"><a href="/net/fd_unix.go.html#2576465">ra</a></span><span class="op" id="2576692">)</span><span class="op" id="2576693">;</span>&nbsp;<span class="ident" id="2576695"><a href="/net/fd_unix.go.html#2576657">err</a></span>&nbsp;<span class="op" id="2576699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2576702">case</span>&nbsp;<span class="ident" id="2576707"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2576714">.</span><span class="ident" id="2576715">EINPROGRESS</span><span class="op" id="2576726">,</span>&nbsp;<span class="ident" id="2576728"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2576735">.</span><span class="ident" id="2576736">EALREADY</span><span class="op" id="2576744">,</span>&nbsp;<span class="ident" id="2576746"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2576753">.</span><span class="ident" id="2576754">EINTR</span><span class="op" id="2576759">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2576762">case</span>&nbsp;<span class="ident" id="2576767">nil</span><span class="op" id="2576770">,</span>&nbsp;<span class="ident" id="2576772"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2576779">.</span><span class="ident" id="2576780">EISCONN</span><span class="op" id="2576787">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2576791">if</span>&nbsp;<span class="op" id="2576794">!</span><span class="ident" id="2576795"><a href="/net/fd_unix.go.html#2576486">deadline</a></span><span class="op" id="2576803">.</span><span class="ident" id="2576804">IsZero</span><span class="op" id="2576810">(</span><span class="op" id="2576811">)</span>&nbsp;<span class="op" id="2576813">&amp;&amp;</span>&nbsp;<span class="ident" id="2576816"><a href="/net/fd_unix.go.html#2576486">deadline</a></span><span class="op" id="2576824">.</span><span class="ident" id="2576825">Before</span><span class="op" id="2576831">(</span><span class="ident" id="2576832"><a href="/net/fd_unix.go.html#2575377">time</a></span><span class="op" id="2576836">.</span><span class="ident" id="2576837">Now</span><span class="op" id="2576840">(</span><span class="op" id="2576841">)</span><span class="op" id="2576842">)</span>&nbsp;<span class="op" id="2576844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2576849">return</span>&nbsp;<span class="ident" id="2576856"><a href="/net/net.go.html#2659253">errTimeout</a></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2576869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2576873">if</span>&nbsp;<span class="ident" id="2576876">err</span>&nbsp;<span class="op" id="2576880">:=</span>&nbsp;<span class="ident" id="2576883"><a href="/net/fd_unix.go.html#2576442">fd</a></span><span class="op" id="2576885">.</span><span class="ident" id="2576886">init</span><span class="op" id="2576890">(</span><span class="op" id="2576891">)</span><span class="op" id="2576892">;</span>&nbsp;<span class="ident" id="2576894"><a href="/net/fd_unix.go.html#2576876">err</a></span>&nbsp;<span class="op" id="2576898">!=</span>&nbsp;<span class="ident" id="2576901">nil</span>&nbsp;<span class="op" id="2576905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2576910">return</span>&nbsp;<span class="ident" id="2576917"><a href="/net/fd_unix.go.html#2576876">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2576923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2576927">return</span>&nbsp;<span class="ident" id="2576934">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2576939">case</span>&nbsp;<span class="ident" id="2576944"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2576951">.</span><span class="ident" id="2576952">EINVAL</span><span class="op" id="2576958">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2576962">//&nbsp;On&nbsp;Solaris&nbsp;we&nbsp;can&nbsp;see&nbsp;EINVAL&nbsp;if&nbsp;the&nbsp;socket&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2577014">//&nbsp;already&nbsp;been&nbsp;accepted&nbsp;and&nbsp;closed&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2577067">//&nbsp;Treat&nbsp;this&nbsp;as&nbsp;a&nbsp;successful&nbsp;connection--writes&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2577121">//&nbsp;the&nbsp;socket&nbsp;will&nbsp;see&nbsp;EOF.&nbsp;&nbsp;For&nbsp;details&nbsp;and&nbsp;a&nbsp;test</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2577175">//&nbsp;case&nbsp;in&nbsp;C&nbsp;see&nbsp;http://golang.org/issue/6828.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2577224">if</span>&nbsp;<span class="ident" id="2577227"><a href="/net/fd_unix.go.html#2575340">runtime</a></span><span class="op" id="2577234">.</span><span class="ident" id="2577235">GOOS</span>&nbsp;<span class="op" id="2577240">==</span>&nbsp;<span class="string" id="2577243">&#34;solaris&#34;</span>&nbsp;<span class="op" id="2577253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2577258">return</span>&nbsp;<span class="ident" id="2577265">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2577271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2577275">fallthrough</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2577288">default</span><span class="op" id="2577295">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2577299">return</span>&nbsp;<span class="ident" id="2577306"><a href="/net/fd_unix.go.html#2576657">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2577311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2577314">if</span>&nbsp;<span class="ident" id="2577317">err</span>&nbsp;<span class="op" id="2577321">:=</span>&nbsp;<span class="ident" id="2577324"><a href="/net/fd_unix.go.html#2576442">fd</a></span><span class="op" id="2577326">.</span><span class="ident" id="2577327">init</span><span class="op" id="2577331">(</span><span class="op" id="2577332">)</span><span class="op" id="2577333">;</span>&nbsp;<span class="ident" id="2577335"><a href="/net/fd_unix.go.html#2577317">err</a></span>&nbsp;<span class="op" id="2577339">!=</span>&nbsp;<span class="ident" id="2577342">nil</span>&nbsp;<span class="op" id="2577346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2577350">return</span>&nbsp;<span class="ident" id="2577357"><a href="/net/fd_unix.go.html#2577317">err</a></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2577362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2577365">if</span>&nbsp;<span class="op" id="2577368">!</span><span class="ident" id="2577369"><a href="/net/fd_unix.go.html#2576486">deadline</a></span><span class="op" id="2577377">.</span><span class="ident" id="2577378">IsZero</span><span class="op" id="2577384">(</span><span class="op" id="2577385">)</span>&nbsp;<span class="op" id="2577387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2577391"><a href="/net/fd_unix.go.html#2576442">fd</a></span><span class="op" id="2577393">.</span><span class="ident" id="2577394">setWriteDeadline</span><span class="op" id="2577410">(</span><span class="ident" id="2577411"><a href="/net/fd_unix.go.html#2576486">deadline</a></span><span class="op" id="2577419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2577423">defer</span>&nbsp;<span class="ident" id="2577429"><a href="/net/fd_unix.go.html#2576442">fd</a></span><span class="op" id="2577431">.</span><span class="ident" id="2577432">setWriteDeadline</span><span class="op" id="2577448">(</span><span class="ident" id="2577449"><a href="/net/net.go.html#2660335">noDeadline</a></span><span class="op" id="2577459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2577462">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2577465">for</span>&nbsp;<span class="op" id="2577469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2577473">//&nbsp;Performing&nbsp;multiple&nbsp;connect&nbsp;system&nbsp;calls&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2577524">//&nbsp;non-blocking&nbsp;socket&nbsp;under&nbsp;Unix&nbsp;variants&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2577578">//&nbsp;necessarily&nbsp;result&nbsp;in&nbsp;earlier&nbsp;errors&nbsp;being</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2577626">//&nbsp;returned.&nbsp;Instead,&nbsp;once&nbsp;runtime-integrated&nbsp;network</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2577682">//&nbsp;poller&nbsp;tells&nbsp;us&nbsp;that&nbsp;the&nbsp;socket&nbsp;is&nbsp;ready,&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2577737">//&nbsp;SO_ERROR&nbsp;socket&nbsp;option&nbsp;to&nbsp;see&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2577790">//&nbsp;succeeded&nbsp;or&nbsp;failed.&nbsp;See&nbsp;issue&nbsp;7474&nbsp;for&nbsp;further</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2577843">//&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2577857">if</span>&nbsp;<span class="ident" id="2577860">err</span>&nbsp;<span class="op" id="2577864">:=</span>&nbsp;<span class="ident" id="2577867"><a href="/net/fd_unix.go.html#2576442">fd</a></span><span class="op" id="2577869">.</span><span class="ident" id="2577870">pd</span><span class="op" id="2577872">.</span><span class="ident" id="2577873">WaitWrite</span><span class="op" id="2577882">(</span><span class="op" id="2577883">)</span><span class="op" id="2577884">;</span>&nbsp;<span class="ident" id="2577886"><a href="/net/fd_unix.go.html#2577860">err</a></span>&nbsp;<span class="op" id="2577890">!=</span>&nbsp;<span class="ident" id="2577893">nil</span>&nbsp;<span class="op" id="2577897">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2577902">return</span>&nbsp;<span class="ident" id="2577909"><a href="/net/fd_unix.go.html#2577860">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2577915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2577919">nerr</span><span class="op" id="2577923">,</span>&nbsp;<span class="ident" id="2577925">err</span>&nbsp;<span class="op" id="2577929">:=</span>&nbsp;<span class="ident" id="2577932"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2577939">.</span><span class="ident" id="2577940">GetsockoptInt</span><span class="op" id="2577953">(</span><span class="ident" id="2577954"><a href="/net/fd_unix.go.html#2576442">fd</a></span><span class="op" id="2577956">.</span><span class="ident" id="2577957">sysfd</span><span class="op" id="2577962">,</span>&nbsp;<span class="ident" id="2577964"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2577971">.</span><span class="ident" id="2577972">SOL_SOCKET</span><span class="op" id="2577982">,</span>&nbsp;<span class="ident" id="2577984"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2577991">.</span><span class="ident" id="2577992">SO_ERROR</span><span class="op" id="2578000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2578004">if</span>&nbsp;<span class="ident" id="2578007"><a href="/net/fd_unix.go.html#2577925">err</a></span>&nbsp;<span class="op" id="2578011">!=</span>&nbsp;<span class="ident" id="2578014">nil</span>&nbsp;<span class="op" id="2578018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2578023">return</span>&nbsp;<span class="ident" id="2578030"><a href="/net/fd_unix.go.html#2577925">err</a></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2578036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2578040">switch</span>&nbsp;<span class="ident" id="2578047">err</span>&nbsp;<span class="op" id="2578051">:=</span>&nbsp;<span class="ident" id="2578054"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2578061">.</span><span class="ident" id="2578062">Errno</span><span class="op" id="2578067">(</span><span class="ident" id="2578068"><a href="/net/fd_unix.go.html#2577919">nerr</a></span><span class="op" id="2578072">)</span><span class="op" id="2578073">;</span>&nbsp;<span class="ident" id="2578075"><a href="/net/fd_unix.go.html#2578047">err</a></span>&nbsp;<span class="op" id="2578079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2578083">case</span>&nbsp;<span class="ident" id="2578088"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2578095">.</span><span class="ident" id="2578096">EINPROGRESS</span><span class="op" id="2578107">,</span>&nbsp;<span class="ident" id="2578109"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2578116">.</span><span class="ident" id="2578117">EALREADY</span><span class="op" id="2578125">,</span>&nbsp;<span class="ident" id="2578127"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2578134">.</span><span class="ident" id="2578135">EINTR</span><span class="op" id="2578140">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2578144">case</span>&nbsp;<span class="ident" id="2578149"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2578156">.</span><span class="ident" id="2578157">Errno</span><span class="op" id="2578162">(</span><span class="num" id="2578163">0</span><span class="op" id="2578164">)</span><span class="op" id="2578165">,</span>&nbsp;<span class="ident" id="2578167"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2578174">.</span><span class="ident" id="2578175">EISCONN</span><span class="op" id="2578182">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2578187">return</span>&nbsp;<span class="ident" id="2578194">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2578200">default</span><span class="op" id="2578207">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2578212">return</span>&nbsp;<span class="ident" id="2578219"><a href="/net/fd_unix.go.html#2578047">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2578225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2578228">}</span><br>
<span class="lineno"></span><span class="op" id="2578230">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="keyword" id="2578233">func</span>&nbsp;<span class="op" id="2578238">(</span><span class="ident" id="2578239">fd</span>&nbsp;<span class="op" id="2578242">*</span><span class="ident" id="2578243"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2578248">)</span>&nbsp;<span class="ident" id="2578250">destroy</span><span class="op" id="2578257">(</span><span class="op" id="2578258">)</span>&nbsp;<span class="op" id="2578260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2578263">//&nbsp;Poller&nbsp;may&nbsp;want&nbsp;to&nbsp;unregister&nbsp;fd&nbsp;in&nbsp;readiness&nbsp;notification&nbsp;mechanism,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2578337">//&nbsp;so&nbsp;this&nbsp;must&nbsp;be&nbsp;executed&nbsp;before&nbsp;closesocket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2578386"><a href="/net/fd_unix.go.html#2578239">fd</a></span><span class="op" id="2578388">.</span><span class="ident" id="2578389">pd</span><span class="op" id="2578391">.</span><span class="ident" id="2578392">Close</span><span class="op" id="2578397">(</span><span class="op" id="2578398">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2578401"><a href="/net/fd_unix.go.html#2587250">closesocket</a></span><span class="op" id="2578412">(</span><span class="ident" id="2578413"><a href="/net/fd_unix.go.html#2578239">fd</a></span><span class="op" id="2578415">.</span><span class="ident" id="2578416">sysfd</span><span class="op" id="2578421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2578424"><a href="/net/fd_unix.go.html#2578239">fd</a></span><span class="op" id="2578426">.</span><span class="ident" id="2578427">sysfd</span>&nbsp;<span class="op" id="2578433">=</span>&nbsp;<span class="op" id="2578435">-</span><span class="num" id="2578436">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2578439"><a href="/net/fd_unix.go.html#2575340">runtime</a></span><span class="op" id="2578446">.</span><span class="ident" id="2578447">SetFinalizer</span><span class="op" id="2578459">(</span><span class="ident" id="2578460"><a href="/net/fd_unix.go.html#2578239">fd</a></span><span class="op" id="2578462">,</span>&nbsp;<span class="ident" id="2578464">nil</span><span class="op" id="2578467">)</span><br>
<span class="lineno"></span><span class="op" id="2578469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="2578472">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd.</span><br>
<span class="lineno"></span><span class="comment" id="2578503">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="2578549">func</span>&nbsp;<span class="op" id="2578554">(</span><span class="ident" id="2578555">fd</span>&nbsp;<span class="op" id="2578558">*</span><span class="ident" id="2578559"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2578564">)</span>&nbsp;<span class="ident" id="2578566">incref</span><span class="op" id="2578572">(</span><span class="op" id="2578573">)</span>&nbsp;<span class="builtintype" id="2578575">error</span>&nbsp;<span class="op" id="2578581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2578584">if</span>&nbsp;<span class="op" id="2578587">!</span><span class="ident" id="2578588"><a href="/net/fd_unix.go.html#2578555">fd</a></span><span class="op" id="2578590">.</span><span class="ident" id="2578591">fdmu</span><span class="op" id="2578595">.</span><span class="ident" id="2578596">Incref</span><span class="op" id="2578602">(</span><span class="op" id="2578603">)</span>&nbsp;<span class="op" id="2578605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2578609">return</span>&nbsp;<span class="ident" id="2578616"><a href="/net/net.go.html#2659298">errClosing</a></span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2578628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2578631">return</span>&nbsp;<span class="ident" id="2578638">nil</span><br>
<span class="lineno"></span><span class="op" id="2578642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2578645">//&nbsp;Remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD&nbsp;and&nbsp;close&nbsp;if&nbsp;we&#39;ve&nbsp;been&nbsp;asked&nbsp;to&nbsp;do&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="2578717">//&nbsp;(and&nbsp;there&nbsp;are&nbsp;no&nbsp;references&nbsp;left).</span><br>
<span class="lineno"></span><span class="keyword" id="2578756">func</span>&nbsp;<span class="op" id="2578761">(</span><span class="ident" id="2578762">fd</span>&nbsp;<span class="op" id="2578765">*</span><span class="ident" id="2578766"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2578771">)</span>&nbsp;<span class="ident" id="2578773">decref</span><span class="op" id="2578779">(</span><span class="op" id="2578780">)</span>&nbsp;<span class="op" id="2578782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2578785">if</span>&nbsp;<span class="ident" id="2578788"><a href="/net/fd_unix.go.html#2578762">fd</a></span><span class="op" id="2578790">.</span><span class="ident" id="2578791">fdmu</span><span class="op" id="2578795">.</span><span class="ident" id="2578796">Decref</span><span class="op" id="2578802">(</span><span class="op" id="2578803">)</span>&nbsp;<span class="op" id="2578805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2578809"><a href="/net/fd_unix.go.html#2578762">fd</a></span><span class="op" id="2578811">.</span><span class="ident" id="2578812">destroy</span><span class="op" id="2578819">(</span><span class="op" id="2578820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2578823">}</span><br>
<span class="lineno">155</span><span class="op" id="2578825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2578828">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="comment" id="2578880">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="2578926">func</span>&nbsp;<span class="op" id="2578931">(</span><span class="ident" id="2578932">fd</span>&nbsp;<span class="op" id="2578935">*</span><span class="ident" id="2578936"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2578941">)</span>&nbsp;<span class="ident" id="2578943">readLock</span><span class="op" id="2578951">(</span><span class="op" id="2578952">)</span>&nbsp;<span class="builtintype" id="2578954">error</span>&nbsp;<span class="op" id="2578960">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2578963">if</span>&nbsp;<span class="op" id="2578966">!</span><span class="ident" id="2578967"><a href="/net/fd_unix.go.html#2578932">fd</a></span><span class="op" id="2578969">.</span><span class="ident" id="2578970">fdmu</span><span class="op" id="2578974">.</span><span class="ident" id="2578975">RWLock</span><span class="op" id="2578981">(</span><span class="ident" id="2578982">true</span><span class="op" id="2578986">)</span>&nbsp;<span class="op" id="2578988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2578992">return</span>&nbsp;<span class="ident" id="2578999"><a href="/net/net.go.html#2659298">errClosing</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2579011">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2579014">return</span>&nbsp;<span class="ident" id="2579021">nil</span><br>
<span class="lineno"></span><span class="op" id="2579025">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="2579028">//&nbsp;Unlock&nbsp;for&nbsp;reading&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="2579085">func</span>&nbsp;<span class="op" id="2579090">(</span><span class="ident" id="2579091">fd</span>&nbsp;<span class="op" id="2579094">*</span><span class="ident" id="2579095"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2579100">)</span>&nbsp;<span class="ident" id="2579102">readUnlock</span><span class="op" id="2579112">(</span><span class="op" id="2579113">)</span>&nbsp;<span class="op" id="2579115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2579118">if</span>&nbsp;<span class="ident" id="2579121"><a href="/net/fd_unix.go.html#2579091">fd</a></span><span class="op" id="2579123">.</span><span class="ident" id="2579124">fdmu</span><span class="op" id="2579128">.</span><span class="ident" id="2579129">RWUnlock</span><span class="op" id="2579137">(</span><span class="ident" id="2579138">true</span><span class="op" id="2579142">)</span>&nbsp;<span class="op" id="2579144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2579148"><a href="/net/fd_unix.go.html#2579091">fd</a></span><span class="op" id="2579150">.</span><span class="ident" id="2579151">destroy</span><span class="op" id="2579158">(</span><span class="op" id="2579159">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2579162">}</span><br>
<span class="lineno"></span><span class="op" id="2579164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2579167">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="2579219">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno">175</span><span class="keyword" id="2579265">func</span>&nbsp;<span class="op" id="2579270">(</span><span class="ident" id="2579271">fd</span>&nbsp;<span class="op" id="2579274">*</span><span class="ident" id="2579275"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2579280">)</span>&nbsp;<span class="ident" id="2579282">writeLock</span><span class="op" id="2579291">(</span><span class="op" id="2579292">)</span>&nbsp;<span class="builtintype" id="2579294">error</span>&nbsp;<span class="op" id="2579300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2579303">if</span>&nbsp;<span class="op" id="2579306">!</span><span class="ident" id="2579307"><a href="/net/fd_unix.go.html#2579271">fd</a></span><span class="op" id="2579309">.</span><span class="ident" id="2579310">fdmu</span><span class="op" id="2579314">.</span><span class="ident" id="2579315">RWLock</span><span class="op" id="2579321">(</span><span class="ident" id="2579322">false</span><span class="op" id="2579327">)</span>&nbsp;<span class="op" id="2579329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2579333">return</span>&nbsp;<span class="ident" id="2579340"><a href="/net/net.go.html#2659298">errClosing</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2579352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2579355">return</span>&nbsp;<span class="ident" id="2579362">nil</span><br>
<span class="lineno">180</span><span class="op" id="2579366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2579369">//&nbsp;Unlock&nbsp;for&nbsp;writing&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="2579426">func</span>&nbsp;<span class="op" id="2579431">(</span><span class="ident" id="2579432">fd</span>&nbsp;<span class="op" id="2579435">*</span><span class="ident" id="2579436"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2579441">)</span>&nbsp;<span class="ident" id="2579443">writeUnlock</span><span class="op" id="2579454">(</span><span class="op" id="2579455">)</span>&nbsp;<span class="op" id="2579457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2579460">if</span>&nbsp;<span class="ident" id="2579463"><a href="/net/fd_unix.go.html#2579432">fd</a></span><span class="op" id="2579465">.</span><span class="ident" id="2579466">fdmu</span><span class="op" id="2579470">.</span><span class="ident" id="2579471">RWUnlock</span><span class="op" id="2579479">(</span><span class="ident" id="2579480">false</span><span class="op" id="2579485">)</span>&nbsp;<span class="op" id="2579487">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2579491"><a href="/net/fd_unix.go.html#2579432">fd</a></span><span class="op" id="2579493">.</span><span class="ident" id="2579494">destroy</span><span class="op" id="2579501">(</span><span class="op" id="2579502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2579505">}</span><br>
<span class="lineno"></span><span class="op" id="2579507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2579510">func</span>&nbsp;<span class="op" id="2579515">(</span><span class="ident" id="2579516">fd</span>&nbsp;<span class="op" id="2579519">*</span><span class="ident" id="2579520"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2579525">)</span>&nbsp;<span class="ident" id="2579527">Close</span><span class="op" id="2579532">(</span><span class="op" id="2579533">)</span>&nbsp;<span class="builtintype" id="2579535">error</span>&nbsp;<span class="op" id="2579541">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2579544"><a href="/net/fd_unix.go.html#2579516">fd</a></span><span class="op" id="2579546">.</span><span class="ident" id="2579547">pd</span><span class="op" id="2579549">.</span><span class="ident" id="2579550">Lock</span><span class="op" id="2579554">(</span><span class="op" id="2579555">)</span>&nbsp;<span class="comment" id="2579557">//&nbsp;needed&nbsp;for&nbsp;both&nbsp;fd.incref(true)&nbsp;and&nbsp;pollDesc.Evict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2579612">if</span>&nbsp;<span class="op" id="2579615">!</span><span class="ident" id="2579616"><a href="/net/fd_unix.go.html#2579516">fd</a></span><span class="op" id="2579618">.</span><span class="ident" id="2579619">fdmu</span><span class="op" id="2579623">.</span><span class="ident" id="2579624">IncrefAndClose</span><span class="op" id="2579638">(</span><span class="op" id="2579639">)</span>&nbsp;<span class="op" id="2579641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2579645"><a href="/net/fd_unix.go.html#2579516">fd</a></span><span class="op" id="2579647">.</span><span class="ident" id="2579648">pd</span><span class="op" id="2579650">.</span><span class="ident" id="2579651">Unlock</span><span class="op" id="2579657">(</span><span class="op" id="2579658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2579662">return</span>&nbsp;<span class="ident" id="2579669"><a href="/net/net.go.html#2659298">errClosing</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2579681">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2579684">//&nbsp;Unblock&nbsp;any&nbsp;I/O.&nbsp;&nbsp;Once&nbsp;it&nbsp;all&nbsp;unblocks&nbsp;and&nbsp;returns,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2579740">//&nbsp;so&nbsp;that&nbsp;it&nbsp;cannot&nbsp;be&nbsp;referring&nbsp;to&nbsp;fd.sysfd&nbsp;anymore,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2579796">//&nbsp;the&nbsp;final&nbsp;decref&nbsp;will&nbsp;close&nbsp;fd.sysfd.&nbsp;&nbsp;This&nbsp;should&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2579858">//&nbsp;fairly&nbsp;quickly,&nbsp;since&nbsp;all&nbsp;the&nbsp;I/O&nbsp;is&nbsp;non-blocking,&nbsp;and&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2579921">//&nbsp;attempts&nbsp;to&nbsp;block&nbsp;in&nbsp;the&nbsp;pollDesc&nbsp;will&nbsp;return&nbsp;errClosing.</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2579983">doWakeup</span>&nbsp;<span class="op" id="2579992">:=</span>&nbsp;<span class="ident" id="2579995"><a href="/net/fd_unix.go.html#2579516">fd</a></span><span class="op" id="2579997">.</span><span class="ident" id="2579998">pd</span><span class="op" id="2580000">.</span><span class="ident" id="2580001">Evict</span><span class="op" id="2580006">(</span><span class="op" id="2580007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2580010"><a href="/net/fd_unix.go.html#2579516">fd</a></span><span class="op" id="2580012">.</span><span class="ident" id="2580013">pd</span><span class="op" id="2580015">.</span><span class="ident" id="2580016">Unlock</span><span class="op" id="2580022">(</span><span class="op" id="2580023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2580026"><a href="/net/fd_unix.go.html#2579516">fd</a></span><span class="op" id="2580028">.</span><span class="ident" id="2580029">decref</span><span class="op" id="2580035">(</span><span class="op" id="2580036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580039">if</span>&nbsp;<span class="ident" id="2580042"><a href="/net/fd_unix.go.html#2579983">doWakeup</a></span>&nbsp;<span class="op" id="2580051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2580055"><a href="/net/fd_unix.go.html#2579516">fd</a></span><span class="op" id="2580057">.</span><span class="ident" id="2580058">pd</span><span class="op" id="2580060">.</span><span class="ident" id="2580061">Wakeup</span><span class="op" id="2580067">(</span><span class="op" id="2580068">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2580071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580074">return</span>&nbsp;<span class="ident" id="2580081">nil</span><br>
<span class="lineno"></span><span class="op" id="2580085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2580088">func</span>&nbsp;<span class="op" id="2580093">(</span><span class="ident" id="2580094">fd</span>&nbsp;<span class="op" id="2580097">*</span><span class="ident" id="2580098"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2580103">)</span>&nbsp;<span class="ident" id="2580105">shutdown</span><span class="op" id="2580113">(</span><span class="ident" id="2580114">how</span>&nbsp;<span class="builtintype" id="2580118">int</span><span class="op" id="2580121">)</span>&nbsp;<span class="builtintype" id="2580123">error</span>&nbsp;<span class="op" id="2580129">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580132">if</span>&nbsp;<span class="ident" id="2580135">err</span>&nbsp;<span class="op" id="2580139">:=</span>&nbsp;<span class="ident" id="2580142"><a href="/net/fd_unix.go.html#2580094">fd</a></span><span class="op" id="2580144">.</span><span class="ident" id="2580145">incref</span><span class="op" id="2580151">(</span><span class="op" id="2580152">)</span><span class="op" id="2580153">;</span>&nbsp;<span class="ident" id="2580155"><a href="/net/fd_unix.go.html#2580135">err</a></span>&nbsp;<span class="op" id="2580159">!=</span>&nbsp;<span class="ident" id="2580162">nil</span>&nbsp;<span class="op" id="2580166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580170">return</span>&nbsp;<span class="ident" id="2580177"><a href="/net/fd_unix.go.html#2580135">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2580182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580185">defer</span>&nbsp;<span class="ident" id="2580191"><a href="/net/fd_unix.go.html#2580094">fd</a></span><span class="op" id="2580193">.</span><span class="ident" id="2580194">decref</span><span class="op" id="2580200">(</span><span class="op" id="2580201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2580204">err</span>&nbsp;<span class="op" id="2580208">:=</span>&nbsp;<span class="ident" id="2580211"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2580218">.</span><span class="ident" id="2580219">Shutdown</span><span class="op" id="2580227">(</span><span class="ident" id="2580228"><a href="/net/fd_unix.go.html#2580094">fd</a></span><span class="op" id="2580230">.</span><span class="ident" id="2580231">sysfd</span><span class="op" id="2580236">,</span>&nbsp;<span class="ident" id="2580238"><a href="/net/fd_unix.go.html#2580114">how</a></span><span class="op" id="2580241">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580244">if</span>&nbsp;<span class="ident" id="2580247"><a href="/net/fd_unix.go.html#2580204">err</a></span>&nbsp;<span class="op" id="2580251">!=</span>&nbsp;<span class="ident" id="2580254">nil</span>&nbsp;<span class="op" id="2580258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580262">return</span>&nbsp;<span class="op" id="2580269">&amp;</span><span class="ident" id="2580270"><a href="/net/net.go.html#2659621">OpError</a></span><span class="op" id="2580277">{</span><span class="string" id="2580278">&#34;shutdown&#34;</span><span class="op" id="2580288">,</span>&nbsp;<span class="ident" id="2580290"><a href="/net/fd_unix.go.html#2580094">fd</a></span><span class="op" id="2580292">.</span><span class="ident" id="2580293">net</span><span class="op" id="2580296">,</span>&nbsp;<span class="ident" id="2580298"><a href="/net/fd_unix.go.html#2580094">fd</a></span><span class="op" id="2580300">.</span><span class="ident" id="2580301">laddr</span><span class="op" id="2580306">,</span>&nbsp;<span class="ident" id="2580308"><a href="/net/fd_unix.go.html#2580204">err</a></span><span class="op" id="2580311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2580314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580317">return</span>&nbsp;<span class="ident" id="2580324">nil</span><br>
<span class="lineno"></span><span class="op" id="2580328">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="2580331">func</span>&nbsp;<span class="op" id="2580336">(</span><span class="ident" id="2580337">fd</span>&nbsp;<span class="op" id="2580340">*</span><span class="ident" id="2580341"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2580346">)</span>&nbsp;<span class="ident" id="2580348">closeRead</span><span class="op" id="2580357">(</span><span class="op" id="2580358">)</span>&nbsp;<span class="builtintype" id="2580360">error</span>&nbsp;<span class="op" id="2580366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580369">return</span>&nbsp;<span class="ident" id="2580376"><a href="/net/fd_unix.go.html#2580337">fd</a></span><span class="op" id="2580378">.</span><span class="ident" id="2580379">shutdown</span><span class="op" id="2580387">(</span><span class="ident" id="2580388"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2580395">.</span><span class="ident" id="2580396">SHUT_RD</span><span class="op" id="2580403">)</span><br>
<span class="lineno"></span><span class="op" id="2580405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="2580408">func</span>&nbsp;<span class="op" id="2580413">(</span><span class="ident" id="2580414">fd</span>&nbsp;<span class="op" id="2580417">*</span><span class="ident" id="2580418"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2580423">)</span>&nbsp;<span class="ident" id="2580425">closeWrite</span><span class="op" id="2580435">(</span><span class="op" id="2580436">)</span>&nbsp;<span class="builtintype" id="2580438">error</span>&nbsp;<span class="op" id="2580444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580447">return</span>&nbsp;<span class="ident" id="2580454"><a href="/net/fd_unix.go.html#2580414">fd</a></span><span class="op" id="2580456">.</span><span class="ident" id="2580457">shutdown</span><span class="op" id="2580465">(</span><span class="ident" id="2580466"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2580473">.</span><span class="ident" id="2580474">SHUT_WR</span><span class="op" id="2580481">)</span><br>
<span class="lineno"></span><span class="op" id="2580483">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2580486">func</span>&nbsp;<span class="op" id="2580491">(</span><span class="ident" id="2580492">fd</span>&nbsp;<span class="op" id="2580495">*</span><span class="ident" id="2580496"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2580501">)</span>&nbsp;<span class="ident" id="2580503">Read</span><span class="op" id="2580507">(</span><span class="ident" id="2580508">p</span>&nbsp;<span class="op" id="2580510">[</span><span class="op" id="2580511">]</span><span class="builtintype" id="2580512">byte</span><span class="op" id="2580516">)</span>&nbsp;<span class="op" id="2580518">(</span><span class="ident" id="2580519">n</span>&nbsp;<span class="builtintype" id="2580521">int</span><span class="op" id="2580524">,</span>&nbsp;<span class="ident" id="2580526">err</span>&nbsp;<span class="builtintype" id="2580530">error</span><span class="op" id="2580535">)</span>&nbsp;<span class="op" id="2580537">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580540">if</span>&nbsp;<span class="ident" id="2580543">err</span>&nbsp;<span class="op" id="2580547">:=</span>&nbsp;<span class="ident" id="2580550"><a href="/net/fd_unix.go.html#2580492">fd</a></span><span class="op" id="2580552">.</span><span class="ident" id="2580553">readLock</span><span class="op" id="2580561">(</span><span class="op" id="2580562">)</span><span class="op" id="2580563">;</span>&nbsp;<span class="ident" id="2580565"><a href="/net/fd_unix.go.html#2580543">err</a></span>&nbsp;<span class="op" id="2580569">!=</span>&nbsp;<span class="ident" id="2580572">nil</span>&nbsp;<span class="op" id="2580576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580580">return</span>&nbsp;<span class="num" id="2580587">0</span><span class="op" id="2580588">,</span>&nbsp;<span class="ident" id="2580590"><a href="/net/fd_unix.go.html#2580543">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2580595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580598">defer</span>&nbsp;<span class="ident" id="2580604"><a href="/net/fd_unix.go.html#2580492">fd</a></span><span class="op" id="2580606">.</span><span class="ident" id="2580607">readUnlock</span><span class="op" id="2580617">(</span><span class="op" id="2580618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580621">if</span>&nbsp;<span class="ident" id="2580624">err</span>&nbsp;<span class="op" id="2580628">:=</span>&nbsp;<span class="ident" id="2580631"><a href="/net/fd_unix.go.html#2580492">fd</a></span><span class="op" id="2580633">.</span><span class="ident" id="2580634">pd</span><span class="op" id="2580636">.</span><span class="ident" id="2580637">PrepareRead</span><span class="op" id="2580648">(</span><span class="op" id="2580649">)</span><span class="op" id="2580650">;</span>&nbsp;<span class="ident" id="2580652"><a href="/net/fd_unix.go.html#2580624">err</a></span>&nbsp;<span class="op" id="2580656">!=</span>&nbsp;<span class="ident" id="2580659">nil</span>&nbsp;<span class="op" id="2580663">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580667">return</span>&nbsp;<span class="num" id="2580674">0</span><span class="op" id="2580675">,</span>&nbsp;<span class="op" id="2580677">&amp;</span><span class="ident" id="2580678"><a href="/net/net.go.html#2659621">OpError</a></span><span class="op" id="2580685">{</span><span class="string" id="2580686">&#34;read&#34;</span><span class="op" id="2580692">,</span>&nbsp;<span class="ident" id="2580694"><a href="/net/fd_unix.go.html#2580492">fd</a></span><span class="op" id="2580696">.</span><span class="ident" id="2580697">net</span><span class="op" id="2580700">,</span>&nbsp;<span class="ident" id="2580702"><a href="/net/fd_unix.go.html#2580492">fd</a></span><span class="op" id="2580704">.</span><span class="ident" id="2580705">raddr</span><span class="op" id="2580710">,</span>&nbsp;<span class="ident" id="2580712"><a href="/net/fd_unix.go.html#2580624">err</a></span><span class="op" id="2580715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2580718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580721">for</span>&nbsp;<span class="op" id="2580725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2580729"><a href="/net/fd_unix.go.html#2580519">n</a></span><span class="op" id="2580730">,</span>&nbsp;<span class="ident" id="2580732"><a href="/net/fd_unix.go.html#2580526">err</a></span>&nbsp;<span class="op" id="2580736">=</span>&nbsp;<span class="ident" id="2580738"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2580745">.</span><span class="ident" id="2580746">Read</span><span class="op" id="2580750">(</span><span class="builtintype" id="2580751">int</span><span class="op" id="2580754">(</span><span class="ident" id="2580755"><a href="/net/fd_unix.go.html#2580492">fd</a></span><span class="op" id="2580757">.</span><span class="ident" id="2580758">sysfd</span><span class="op" id="2580763">)</span><span class="op" id="2580764">,</span>&nbsp;<span class="ident" id="2580766"><a href="/net/fd_unix.go.html#2580508">p</a></span><span class="op" id="2580767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580771">if</span>&nbsp;<span class="ident" id="2580774"><a href="/net/fd_unix.go.html#2580526">err</a></span>&nbsp;<span class="op" id="2580778">!=</span>&nbsp;<span class="ident" id="2580781">nil</span>&nbsp;<span class="op" id="2580785">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2580790"><a href="/net/fd_unix.go.html#2580519">n</a></span>&nbsp;<span class="op" id="2580792">=</span>&nbsp;<span class="num" id="2580794">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580799">if</span>&nbsp;<span class="ident" id="2580802"><a href="/net/fd_unix.go.html#2580526">err</a></span>&nbsp;<span class="op" id="2580806">==</span>&nbsp;<span class="ident" id="2580809"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2580816">.</span><span class="ident" id="2580817">EAGAIN</span>&nbsp;<span class="op" id="2580824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580830">if</span>&nbsp;<span class="ident" id="2580833"><a href="/net/fd_unix.go.html#2580526">err</a></span>&nbsp;<span class="op" id="2580837">=</span>&nbsp;<span class="ident" id="2580839"><a href="/net/fd_unix.go.html#2580492">fd</a></span><span class="op" id="2580841">.</span><span class="ident" id="2580842">pd</span><span class="op" id="2580844">.</span><span class="ident" id="2580845">WaitRead</span><span class="op" id="2580853">(</span><span class="op" id="2580854">)</span><span class="op" id="2580855">;</span>&nbsp;<span class="ident" id="2580857"><a href="/net/fd_unix.go.html#2580526">err</a></span>&nbsp;<span class="op" id="2580861">==</span>&nbsp;<span class="ident" id="2580864">nil</span>&nbsp;<span class="op" id="2580868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580875">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2580888">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2580893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2580897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2580901"><a href="/net/fd_unix.go.html#2580526">err</a></span>&nbsp;<span class="op" id="2580905">=</span>&nbsp;<span class="ident" id="2580907"><a href="/net/fd_unix.go.html#2582316">chkReadErr</a></span><span class="op" id="2580917">(</span><span class="ident" id="2580918"><a href="/net/fd_unix.go.html#2580519">n</a></span><span class="op" id="2580919">,</span>&nbsp;<span class="ident" id="2580921"><a href="/net/fd_unix.go.html#2580526">err</a></span><span class="op" id="2580924">,</span>&nbsp;<span class="ident" id="2580926"><a href="/net/fd_unix.go.html#2580492">fd</a></span><span class="op" id="2580928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580932">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2580939">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2580942">if</span>&nbsp;<span class="ident" id="2580945"><a href="/net/fd_unix.go.html#2580526">err</a></span>&nbsp;<span class="op" id="2580949">!=</span>&nbsp;<span class="ident" id="2580952">nil</span>&nbsp;<span class="op" id="2580956">&amp;&amp;</span>&nbsp;<span class="ident" id="2580959"><a href="/net/fd_unix.go.html#2580526">err</a></span>&nbsp;<span class="op" id="2580963">!=</span>&nbsp;<span class="ident" id="2580966"><a href="/net/fd_unix.go.html#2575328">io</a></span><span class="op" id="2580968">.</span><span class="ident" id="2580969">EOF</span>&nbsp;<span class="op" id="2580973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2580977"><a href="/net/fd_unix.go.html#2580526">err</a></span>&nbsp;<span class="op" id="2580981">=</span>&nbsp;<span class="op" id="2580983">&amp;</span><span class="ident" id="2580984"><a href="/net/net.go.html#2659621">OpError</a></span><span class="op" id="2580991">{</span><span class="string" id="2580992">&#34;read&#34;</span><span class="op" id="2580998">,</span>&nbsp;<span class="ident" id="2581000"><a href="/net/fd_unix.go.html#2580492">fd</a></span><span class="op" id="2581002">.</span><span class="ident" id="2581003">net</span><span class="op" id="2581006">,</span>&nbsp;<span class="ident" id="2581008"><a href="/net/fd_unix.go.html#2580492">fd</a></span><span class="op" id="2581010">.</span><span class="ident" id="2581011">raddr</span><span class="op" id="2581016">,</span>&nbsp;<span class="ident" id="2581018"><a href="/net/fd_unix.go.html#2580526">err</a></span><span class="op" id="2581021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2581024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2581027">return</span><br>
<span class="lineno"></span><span class="op" id="2581034">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="2581037">func</span>&nbsp;<span class="op" id="2581042">(</span><span class="ident" id="2581043">fd</span>&nbsp;<span class="op" id="2581046">*</span><span class="ident" id="2581047"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2581052">)</span>&nbsp;<span class="ident" id="2581054">readFrom</span><span class="op" id="2581062">(</span><span class="ident" id="2581063">p</span>&nbsp;<span class="op" id="2581065">[</span><span class="op" id="2581066">]</span><span class="builtintype" id="2581067">byte</span><span class="op" id="2581071">)</span>&nbsp;<span class="op" id="2581073">(</span><span class="ident" id="2581074">n</span>&nbsp;<span class="builtintype" id="2581076">int</span><span class="op" id="2581079">,</span>&nbsp;<span class="ident" id="2581081">sa</span>&nbsp;<span class="ident" id="2581084"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2581091">.</span><span class="ident" id="2581092">Sockaddr</span><span class="op" id="2581100">,</span>&nbsp;<span class="ident" id="2581102">err</span>&nbsp;<span class="builtintype" id="2581106">error</span><span class="op" id="2581111">)</span>&nbsp;<span class="op" id="2581113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2581116">if</span>&nbsp;<span class="ident" id="2581119">err</span>&nbsp;<span class="op" id="2581123">:=</span>&nbsp;<span class="ident" id="2581126"><a href="/net/fd_unix.go.html#2581043">fd</a></span><span class="op" id="2581128">.</span><span class="ident" id="2581129">readLock</span><span class="op" id="2581137">(</span><span class="op" id="2581138">)</span><span class="op" id="2581139">;</span>&nbsp;<span class="ident" id="2581141"><a href="/net/fd_unix.go.html#2581119">err</a></span>&nbsp;<span class="op" id="2581145">!=</span>&nbsp;<span class="ident" id="2581148">nil</span>&nbsp;<span class="op" id="2581152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2581156">return</span>&nbsp;<span class="num" id="2581163">0</span><span class="op" id="2581164">,</span>&nbsp;<span class="ident" id="2581166">nil</span><span class="op" id="2581169">,</span>&nbsp;<span class="ident" id="2581171"><a href="/net/fd_unix.go.html#2581119">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2581176">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2581179">defer</span>&nbsp;<span class="ident" id="2581185"><a href="/net/fd_unix.go.html#2581043">fd</a></span><span class="op" id="2581187">.</span><span class="ident" id="2581188">readUnlock</span><span class="op" id="2581198">(</span><span class="op" id="2581199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2581202">if</span>&nbsp;<span class="ident" id="2581205">err</span>&nbsp;<span class="op" id="2581209">:=</span>&nbsp;<span class="ident" id="2581212"><a href="/net/fd_unix.go.html#2581043">fd</a></span><span class="op" id="2581214">.</span><span class="ident" id="2581215">pd</span><span class="op" id="2581217">.</span><span class="ident" id="2581218">PrepareRead</span><span class="op" id="2581229">(</span><span class="op" id="2581230">)</span><span class="op" id="2581231">;</span>&nbsp;<span class="ident" id="2581233"><a href="/net/fd_unix.go.html#2581205">err</a></span>&nbsp;<span class="op" id="2581237">!=</span>&nbsp;<span class="ident" id="2581240">nil</span>&nbsp;<span class="op" id="2581244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2581248">return</span>&nbsp;<span class="num" id="2581255">0</span><span class="op" id="2581256">,</span>&nbsp;<span class="ident" id="2581258">nil</span><span class="op" id="2581261">,</span>&nbsp;<span class="op" id="2581263">&amp;</span><span class="ident" id="2581264"><a href="/net/net.go.html#2659621">OpError</a></span><span class="op" id="2581271">{</span><span class="string" id="2581272">&#34;read&#34;</span><span class="op" id="2581278">,</span>&nbsp;<span class="ident" id="2581280"><a href="/net/fd_unix.go.html#2581043">fd</a></span><span class="op" id="2581282">.</span><span class="ident" id="2581283">net</span><span class="op" id="2581286">,</span>&nbsp;<span class="ident" id="2581288"><a href="/net/fd_unix.go.html#2581043">fd</a></span><span class="op" id="2581290">.</span><span class="ident" id="2581291">laddr</span><span class="op" id="2581296">,</span>&nbsp;<span class="ident" id="2581298"><a href="/net/fd_unix.go.html#2581205">err</a></span><span class="op" id="2581301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2581304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2581307">for</span>&nbsp;<span class="op" id="2581311">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2581315"><a href="/net/fd_unix.go.html#2581074">n</a></span><span class="op" id="2581316">,</span>&nbsp;<span class="ident" id="2581318"><a href="/net/fd_unix.go.html#2581081">sa</a></span><span class="op" id="2581320">,</span>&nbsp;<span class="ident" id="2581322"><a href="/net/fd_unix.go.html#2581102">err</a></span>&nbsp;<span class="op" id="2581326">=</span>&nbsp;<span class="ident" id="2581328"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2581335">.</span><span class="ident" id="2581336">Recvfrom</span><span class="op" id="2581344">(</span><span class="ident" id="2581345"><a href="/net/fd_unix.go.html#2581043">fd</a></span><span class="op" id="2581347">.</span><span class="ident" id="2581348">sysfd</span><span class="op" id="2581353">,</span>&nbsp;<span class="ident" id="2581355"><a href="/net/fd_unix.go.html#2581063">p</a></span><span class="op" id="2581356">,</span>&nbsp;<span class="num" id="2581358">0</span><span class="op" id="2581359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2581363">if</span>&nbsp;<span class="ident" id="2581366"><a href="/net/fd_unix.go.html#2581102">err</a></span>&nbsp;<span class="op" id="2581370">!=</span>&nbsp;<span class="ident" id="2581373">nil</span>&nbsp;<span class="op" id="2581377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2581382"><a href="/net/fd_unix.go.html#2581074">n</a></span>&nbsp;<span class="op" id="2581384">=</span>&nbsp;<span class="num" id="2581386">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2581391">if</span>&nbsp;<span class="ident" id="2581394"><a href="/net/fd_unix.go.html#2581102">err</a></span>&nbsp;<span class="op" id="2581398">==</span>&nbsp;<span class="ident" id="2581401"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2581408">.</span><span class="ident" id="2581409">EAGAIN</span>&nbsp;<span class="op" id="2581416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2581422">if</span>&nbsp;<span class="ident" id="2581425"><a href="/net/fd_unix.go.html#2581102">err</a></span>&nbsp;<span class="op" id="2581429">=</span>&nbsp;<span class="ident" id="2581431"><a href="/net/fd_unix.go.html#2581043">fd</a></span><span class="op" id="2581433">.</span><span class="ident" id="2581434">pd</span><span class="op" id="2581436">.</span><span class="ident" id="2581437">WaitRead</span><span class="op" id="2581445">(</span><span class="op" id="2581446">)</span><span class="op" id="2581447">;</span>&nbsp;<span class="ident" id="2581449"><a href="/net/fd_unix.go.html#2581102">err</a></span>&nbsp;<span class="op" id="2581453">==</span>&nbsp;<span class="ident" id="2581456">nil</span>&nbsp;<span class="op" id="2581460">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2581467">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2581480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2581485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2581489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2581493"><a href="/net/fd_unix.go.html#2581102">err</a></span>&nbsp;<span class="op" id="2581497">=</span>&nbsp;<span class="ident" id="2581499"><a href="/net/fd_unix.go.html#2582316">chkReadErr</a></span><span class="op" id="2581509">(</span><span class="ident" id="2581510"><a href="/net/fd_unix.go.html#2581074">n</a></span><span class="op" id="2581511">,</span>&nbsp;<span class="ident" id="2581513"><a href="/net/fd_unix.go.html#2581102">err</a></span><span class="op" id="2581516">,</span>&nbsp;<span class="ident" id="2581518"><a href="/net/fd_unix.go.html#2581043">fd</a></span><span class="op" id="2581520">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2581524">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2581531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2581534">if</span>&nbsp;<span class="ident" id="2581537"><a href="/net/fd_unix.go.html#2581102">err</a></span>&nbsp;<span class="op" id="2581541">!=</span>&nbsp;<span class="ident" id="2581544">nil</span>&nbsp;<span class="op" id="2581548">&amp;&amp;</span>&nbsp;<span class="ident" id="2581551"><a href="/net/fd_unix.go.html#2581102">err</a></span>&nbsp;<span class="op" id="2581555">!=</span>&nbsp;<span class="ident" id="2581558"><a href="/net/fd_unix.go.html#2575328">io</a></span><span class="op" id="2581560">.</span><span class="ident" id="2581561">EOF</span>&nbsp;<span class="op" id="2581565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2581569"><a href="/net/fd_unix.go.html#2581102">err</a></span>&nbsp;<span class="op" id="2581573">=</span>&nbsp;<span class="op" id="2581575">&amp;</span><span class="ident" id="2581576"><a href="/net/net.go.html#2659621">OpError</a></span><span class="op" id="2581583">{</span><span class="string" id="2581584">&#34;read&#34;</span><span class="op" id="2581590">,</span>&nbsp;<span class="ident" id="2581592"><a href="/net/fd_unix.go.html#2581043">fd</a></span><span class="op" id="2581594">.</span><span class="ident" id="2581595">net</span><span class="op" id="2581598">,</span>&nbsp;<span class="ident" id="2581600"><a href="/net/fd_unix.go.html#2581043">fd</a></span><span class="op" id="2581602">.</span><span class="ident" id="2581603">laddr</span><span class="op" id="2581608">,</span>&nbsp;<span class="ident" id="2581610"><a href="/net/fd_unix.go.html#2581102">err</a></span><span class="op" id="2581613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2581616">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2581619">return</span><br>
<span class="lineno"></span><span class="op" id="2581626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2581629">func</span>&nbsp;<span class="op" id="2581634">(</span><span class="ident" id="2581635">fd</span>&nbsp;<span class="op" id="2581638">*</span><span class="ident" id="2581639"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2581644">)</span>&nbsp;<span class="ident" id="2581646">readMsg</span><span class="op" id="2581653">(</span><span class="ident" id="2581654">p</span>&nbsp;<span class="op" id="2581656">[</span><span class="op" id="2581657">]</span><span class="builtintype" id="2581658">byte</span><span class="op" id="2581662">,</span>&nbsp;<span class="ident" id="2581664">oob</span>&nbsp;<span class="op" id="2581668">[</span><span class="op" id="2581669">]</span><span class="builtintype" id="2581670">byte</span><span class="op" id="2581674">)</span>&nbsp;<span class="op" id="2581676">(</span><span class="ident" id="2581677">n</span><span class="op" id="2581678">,</span>&nbsp;<span class="ident" id="2581680">oobn</span><span class="op" id="2581684">,</span>&nbsp;<span class="ident" id="2581686">flags</span>&nbsp;<span class="builtintype" id="2581692">int</span><span class="op" id="2581695">,</span>&nbsp;<span class="ident" id="2581697">sa</span>&nbsp;<span class="ident" id="2581700"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2581707">.</span><span class="ident" id="2581708">Sockaddr</span><span class="op" id="2581716">,</span>&nbsp;<span class="ident" id="2581718">err</span>&nbsp;<span class="builtintype" id="2581722">error</span><span class="op" id="2581727">)</span>&nbsp;<span class="op" id="2581729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2581732">if</span>&nbsp;<span class="ident" id="2581735">err</span>&nbsp;<span class="op" id="2581739">:=</span>&nbsp;<span class="ident" id="2581742"><a href="/net/fd_unix.go.html#2581635">fd</a></span><span class="op" id="2581744">.</span><span class="ident" id="2581745">readLock</span><span class="op" id="2581753">(</span><span class="op" id="2581754">)</span><span class="op" id="2581755">;</span>&nbsp;<span class="ident" id="2581757"><a href="/net/fd_unix.go.html#2581735">err</a></span>&nbsp;<span class="op" id="2581761">!=</span>&nbsp;<span class="ident" id="2581764">nil</span>&nbsp;<span class="op" id="2581768">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2581772">return</span>&nbsp;<span class="num" id="2581779">0</span><span class="op" id="2581780">,</span>&nbsp;<span class="num" id="2581782">0</span><span class="op" id="2581783">,</span>&nbsp;<span class="num" id="2581785">0</span><span class="op" id="2581786">,</span>&nbsp;<span class="ident" id="2581788">nil</span><span class="op" id="2581791">,</span>&nbsp;<span class="ident" id="2581793"><a href="/net/fd_unix.go.html#2581735">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2581798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2581801">defer</span>&nbsp;<span class="ident" id="2581807"><a href="/net/fd_unix.go.html#2581635">fd</a></span><span class="op" id="2581809">.</span><span class="ident" id="2581810">readUnlock</span><span class="op" id="2581820">(</span><span class="op" id="2581821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2581824">if</span>&nbsp;<span class="ident" id="2581827">err</span>&nbsp;<span class="op" id="2581831">:=</span>&nbsp;<span class="ident" id="2581834"><a href="/net/fd_unix.go.html#2581635">fd</a></span><span class="op" id="2581836">.</span><span class="ident" id="2581837">pd</span><span class="op" id="2581839">.</span><span class="ident" id="2581840">PrepareRead</span><span class="op" id="2581851">(</span><span class="op" id="2581852">)</span><span class="op" id="2581853">;</span>&nbsp;<span class="ident" id="2581855"><a href="/net/fd_unix.go.html#2581827">err</a></span>&nbsp;<span class="op" id="2581859">!=</span>&nbsp;<span class="ident" id="2581862">nil</span>&nbsp;<span class="op" id="2581866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2581870">return</span>&nbsp;<span class="num" id="2581877">0</span><span class="op" id="2581878">,</span>&nbsp;<span class="num" id="2581880">0</span><span class="op" id="2581881">,</span>&nbsp;<span class="num" id="2581883">0</span><span class="op" id="2581884">,</span>&nbsp;<span class="ident" id="2581886">nil</span><span class="op" id="2581889">,</span>&nbsp;<span class="op" id="2581891">&amp;</span><span class="ident" id="2581892"><a href="/net/net.go.html#2659621">OpError</a></span><span class="op" id="2581899">{</span><span class="string" id="2581900">&#34;read&#34;</span><span class="op" id="2581906">,</span>&nbsp;<span class="ident" id="2581908"><a href="/net/fd_unix.go.html#2581635">fd</a></span><span class="op" id="2581910">.</span><span class="ident" id="2581911">net</span><span class="op" id="2581914">,</span>&nbsp;<span class="ident" id="2581916"><a href="/net/fd_unix.go.html#2581635">fd</a></span><span class="op" id="2581918">.</span><span class="ident" id="2581919">laddr</span><span class="op" id="2581924">,</span>&nbsp;<span class="ident" id="2581926"><a href="/net/fd_unix.go.html#2581827">err</a></span><span class="op" id="2581929">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2581932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2581935">for</span>&nbsp;<span class="op" id="2581939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2581943"><a href="/net/fd_unix.go.html#2581677">n</a></span><span class="op" id="2581944">,</span>&nbsp;<span class="ident" id="2581946"><a href="/net/fd_unix.go.html#2581680">oobn</a></span><span class="op" id="2581950">,</span>&nbsp;<span class="ident" id="2581952"><a href="/net/fd_unix.go.html#2581686">flags</a></span><span class="op" id="2581957">,</span>&nbsp;<span class="ident" id="2581959"><a href="/net/fd_unix.go.html#2581697">sa</a></span><span class="op" id="2581961">,</span>&nbsp;<span class="ident" id="2581963"><a href="/net/fd_unix.go.html#2581718">err</a></span>&nbsp;<span class="op" id="2581967">=</span>&nbsp;<span class="ident" id="2581969"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2581976">.</span><span class="ident" id="2581977">Recvmsg</span><span class="op" id="2581984">(</span><span class="ident" id="2581985"><a href="/net/fd_unix.go.html#2581635">fd</a></span><span class="op" id="2581987">.</span><span class="ident" id="2581988">sysfd</span><span class="op" id="2581993">,</span>&nbsp;<span class="ident" id="2581995"><a href="/net/fd_unix.go.html#2581654">p</a></span><span class="op" id="2581996">,</span>&nbsp;<span class="ident" id="2581998"><a href="/net/fd_unix.go.html#2581664">oob</a></span><span class="op" id="2582001">,</span>&nbsp;<span class="num" id="2582003">0</span><span class="op" id="2582004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582008">if</span>&nbsp;<span class="ident" id="2582011"><a href="/net/fd_unix.go.html#2581718">err</a></span>&nbsp;<span class="op" id="2582015">!=</span>&nbsp;<span class="ident" id="2582018">nil</span>&nbsp;<span class="op" id="2582022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2582027">//&nbsp;TODO(dfc)&nbsp;should&nbsp;n&nbsp;and&nbsp;oobn&nbsp;be&nbsp;set&nbsp;to&nbsp;0</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582073">if</span>&nbsp;<span class="ident" id="2582076"><a href="/net/fd_unix.go.html#2581718">err</a></span>&nbsp;<span class="op" id="2582080">==</span>&nbsp;<span class="ident" id="2582083"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2582090">.</span><span class="ident" id="2582091">EAGAIN</span>&nbsp;<span class="op" id="2582098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582104">if</span>&nbsp;<span class="ident" id="2582107"><a href="/net/fd_unix.go.html#2581718">err</a></span>&nbsp;<span class="op" id="2582111">=</span>&nbsp;<span class="ident" id="2582113"><a href="/net/fd_unix.go.html#2581635">fd</a></span><span class="op" id="2582115">.</span><span class="ident" id="2582116">pd</span><span class="op" id="2582118">.</span><span class="ident" id="2582119">WaitRead</span><span class="op" id="2582127">(</span><span class="op" id="2582128">)</span><span class="op" id="2582129">;</span>&nbsp;<span class="ident" id="2582131"><a href="/net/fd_unix.go.html#2581718">err</a></span>&nbsp;<span class="op" id="2582135">==</span>&nbsp;<span class="ident" id="2582138">nil</span>&nbsp;<span class="op" id="2582142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582149">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2582162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2582167">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2582171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2582175"><a href="/net/fd_unix.go.html#2581718">err</a></span>&nbsp;<span class="op" id="2582179">=</span>&nbsp;<span class="ident" id="2582181"><a href="/net/fd_unix.go.html#2582316">chkReadErr</a></span><span class="op" id="2582191">(</span><span class="ident" id="2582192"><a href="/net/fd_unix.go.html#2581677">n</a></span><span class="op" id="2582193">,</span>&nbsp;<span class="ident" id="2582195"><a href="/net/fd_unix.go.html#2581718">err</a></span><span class="op" id="2582198">,</span>&nbsp;<span class="ident" id="2582200"><a href="/net/fd_unix.go.html#2581635">fd</a></span><span class="op" id="2582202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582206">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2582213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582216">if</span>&nbsp;<span class="ident" id="2582219"><a href="/net/fd_unix.go.html#2581718">err</a></span>&nbsp;<span class="op" id="2582223">!=</span>&nbsp;<span class="ident" id="2582226">nil</span>&nbsp;<span class="op" id="2582230">&amp;&amp;</span>&nbsp;<span class="ident" id="2582233"><a href="/net/fd_unix.go.html#2581718">err</a></span>&nbsp;<span class="op" id="2582237">!=</span>&nbsp;<span class="ident" id="2582240"><a href="/net/fd_unix.go.html#2575328">io</a></span><span class="op" id="2582242">.</span><span class="ident" id="2582243">EOF</span>&nbsp;<span class="op" id="2582247">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2582251"><a href="/net/fd_unix.go.html#2581718">err</a></span>&nbsp;<span class="op" id="2582255">=</span>&nbsp;<span class="op" id="2582257">&amp;</span><span class="ident" id="2582258"><a href="/net/net.go.html#2659621">OpError</a></span><span class="op" id="2582265">{</span><span class="string" id="2582266">&#34;read&#34;</span><span class="op" id="2582272">,</span>&nbsp;<span class="ident" id="2582274"><a href="/net/fd_unix.go.html#2581635">fd</a></span><span class="op" id="2582276">.</span><span class="ident" id="2582277">net</span><span class="op" id="2582280">,</span>&nbsp;<span class="ident" id="2582282"><a href="/net/fd_unix.go.html#2581635">fd</a></span><span class="op" id="2582284">.</span><span class="ident" id="2582285">laddr</span><span class="op" id="2582290">,</span>&nbsp;<span class="ident" id="2582292"><a href="/net/fd_unix.go.html#2581718">err</a></span><span class="op" id="2582295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2582298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582301">return</span><br>
<span class="lineno"></span><span class="op" id="2582308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span><span class="keyword" id="2582311">func</span>&nbsp;<span class="ident" id="2582316">chkReadErr</span><span class="op" id="2582326">(</span><span class="ident" id="2582327">n</span>&nbsp;<span class="builtintype" id="2582329">int</span><span class="op" id="2582332">,</span>&nbsp;<span class="ident" id="2582334">err</span>&nbsp;<span class="builtintype" id="2582338">error</span><span class="op" id="2582343">,</span>&nbsp;<span class="ident" id="2582345">fd</span>&nbsp;<span class="op" id="2582348">*</span><span class="ident" id="2582349"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2582354">)</span>&nbsp;<span class="builtintype" id="2582356">error</span>&nbsp;<span class="op" id="2582362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582365">if</span>&nbsp;<span class="ident" id="2582368"><a href="/net/fd_unix.go.html#2582327">n</a></span>&nbsp;<span class="op" id="2582370">==</span>&nbsp;<span class="num" id="2582373">0</span>&nbsp;<span class="op" id="2582375">&amp;&amp;</span>&nbsp;<span class="ident" id="2582378"><a href="/net/fd_unix.go.html#2582334">err</a></span>&nbsp;<span class="op" id="2582382">==</span>&nbsp;<span class="ident" id="2582385">nil</span>&nbsp;<span class="op" id="2582389">&amp;&amp;</span>&nbsp;<span class="ident" id="2582392"><a href="/net/fd_unix.go.html#2582345">fd</a></span><span class="op" id="2582394">.</span><span class="ident" id="2582395">sotype</span>&nbsp;<span class="op" id="2582402">!=</span>&nbsp;<span class="ident" id="2582405"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2582412">.</span><span class="ident" id="2582413">SOCK_DGRAM</span>&nbsp;<span class="op" id="2582424">&amp;&amp;</span>&nbsp;<span class="ident" id="2582427"><a href="/net/fd_unix.go.html#2582345">fd</a></span><span class="op" id="2582429">.</span><span class="ident" id="2582430">sotype</span>&nbsp;<span class="op" id="2582437">!=</span>&nbsp;<span class="ident" id="2582440"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2582447">.</span><span class="ident" id="2582448">SOCK_RAW</span>&nbsp;<span class="op" id="2582457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582461">return</span>&nbsp;<span class="ident" id="2582468"><a href="/net/fd_unix.go.html#2575328">io</a></span><span class="op" id="2582470">.</span><span class="ident" id="2582471">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2582476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582479">return</span>&nbsp;<span class="ident" id="2582486"><a href="/net/fd_unix.go.html#2582334">err</a></span><br>
<span class="lineno">315</span><span class="op" id="2582490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2582493">func</span>&nbsp;<span class="op" id="2582498">(</span><span class="ident" id="2582499">fd</span>&nbsp;<span class="op" id="2582502">*</span><span class="ident" id="2582503"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2582508">)</span>&nbsp;<span class="ident" id="2582510">Write</span><span class="op" id="2582515">(</span><span class="ident" id="2582516">p</span>&nbsp;<span class="op" id="2582518">[</span><span class="op" id="2582519">]</span><span class="builtintype" id="2582520">byte</span><span class="op" id="2582524">)</span>&nbsp;<span class="op" id="2582526">(</span><span class="ident" id="2582527">nn</span>&nbsp;<span class="builtintype" id="2582530">int</span><span class="op" id="2582533">,</span>&nbsp;<span class="ident" id="2582535">err</span>&nbsp;<span class="builtintype" id="2582539">error</span><span class="op" id="2582544">)</span>&nbsp;<span class="op" id="2582546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582549">if</span>&nbsp;<span class="ident" id="2582552">err</span>&nbsp;<span class="op" id="2582556">:=</span>&nbsp;<span class="ident" id="2582559"><a href="/net/fd_unix.go.html#2582499">fd</a></span><span class="op" id="2582561">.</span><span class="ident" id="2582562">writeLock</span><span class="op" id="2582571">(</span><span class="op" id="2582572">)</span><span class="op" id="2582573">;</span>&nbsp;<span class="ident" id="2582575"><a href="/net/fd_unix.go.html#2582552">err</a></span>&nbsp;<span class="op" id="2582579">!=</span>&nbsp;<span class="ident" id="2582582">nil</span>&nbsp;<span class="op" id="2582586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582590">return</span>&nbsp;<span class="num" id="2582597">0</span><span class="op" id="2582598">,</span>&nbsp;<span class="ident" id="2582600"><a href="/net/fd_unix.go.html#2582552">err</a></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2582605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582608">defer</span>&nbsp;<span class="ident" id="2582614"><a href="/net/fd_unix.go.html#2582499">fd</a></span><span class="op" id="2582616">.</span><span class="ident" id="2582617">writeUnlock</span><span class="op" id="2582628">(</span><span class="op" id="2582629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582632">if</span>&nbsp;<span class="ident" id="2582635">err</span>&nbsp;<span class="op" id="2582639">:=</span>&nbsp;<span class="ident" id="2582642"><a href="/net/fd_unix.go.html#2582499">fd</a></span><span class="op" id="2582644">.</span><span class="ident" id="2582645">pd</span><span class="op" id="2582647">.</span><span class="ident" id="2582648">PrepareWrite</span><span class="op" id="2582660">(</span><span class="op" id="2582661">)</span><span class="op" id="2582662">;</span>&nbsp;<span class="ident" id="2582664"><a href="/net/fd_unix.go.html#2582635">err</a></span>&nbsp;<span class="op" id="2582668">!=</span>&nbsp;<span class="ident" id="2582671">nil</span>&nbsp;<span class="op" id="2582675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582679">return</span>&nbsp;<span class="num" id="2582686">0</span><span class="op" id="2582687">,</span>&nbsp;<span class="op" id="2582689">&amp;</span><span class="ident" id="2582690"><a href="/net/net.go.html#2659621">OpError</a></span><span class="op" id="2582697">{</span><span class="string" id="2582698">&#34;write&#34;</span><span class="op" id="2582705">,</span>&nbsp;<span class="ident" id="2582707"><a href="/net/fd_unix.go.html#2582499">fd</a></span><span class="op" id="2582709">.</span><span class="ident" id="2582710">net</span><span class="op" id="2582713">,</span>&nbsp;<span class="ident" id="2582715"><a href="/net/fd_unix.go.html#2582499">fd</a></span><span class="op" id="2582717">.</span><span class="ident" id="2582718">raddr</span><span class="op" id="2582723">,</span>&nbsp;<span class="ident" id="2582725"><a href="/net/fd_unix.go.html#2582635">err</a></span><span class="op" id="2582728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2582731">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582734">for</span>&nbsp;<span class="op" id="2582738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582742">var</span>&nbsp;<span class="ident" id="2582746">n</span>&nbsp;<span class="builtintype" id="2582748">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2582754"><a href="/net/fd_unix.go.html#2582746">n</a></span><span class="op" id="2582755">,</span>&nbsp;<span class="ident" id="2582757"><a href="/net/fd_unix.go.html#2582535">err</a></span>&nbsp;<span class="op" id="2582761">=</span>&nbsp;<span class="ident" id="2582763"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2582770">.</span><span class="ident" id="2582771">Write</span><span class="op" id="2582776">(</span><span class="builtintype" id="2582777">int</span><span class="op" id="2582780">(</span><span class="ident" id="2582781"><a href="/net/fd_unix.go.html#2582499">fd</a></span><span class="op" id="2582783">.</span><span class="ident" id="2582784">sysfd</span><span class="op" id="2582789">)</span><span class="op" id="2582790">,</span>&nbsp;<span class="ident" id="2582792"><a href="/net/fd_unix.go.html#2582516">p</a></span><span class="op" id="2582793">[</span><span class="ident" id="2582794"><a href="/net/fd_unix.go.html#2582527">nn</a></span><span class="op" id="2582796">:</span><span class="op" id="2582797">]</span><span class="op" id="2582798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582802">if</span>&nbsp;<span class="ident" id="2582805"><a href="/net/fd_unix.go.html#2582746">n</a></span>&nbsp;<span class="op" id="2582807">&gt;</span>&nbsp;<span class="num" id="2582809">0</span>&nbsp;<span class="op" id="2582811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2582816"><a href="/net/fd_unix.go.html#2582527">nn</a></span>&nbsp;<span class="op" id="2582819">+=</span>&nbsp;<span class="ident" id="2582822"><a href="/net/fd_unix.go.html#2582746">n</a></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2582826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582830">if</span>&nbsp;<span class="ident" id="2582833"><a href="/net/fd_unix.go.html#2582527">nn</a></span>&nbsp;<span class="op" id="2582836">==</span>&nbsp;<span class="builtinfunc" id="2582839">len</span><span class="op" id="2582842">(</span><span class="ident" id="2582843"><a href="/net/fd_unix.go.html#2582516">p</a></span><span class="op" id="2582844">)</span>&nbsp;<span class="op" id="2582846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582851">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2582859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582863">if</span>&nbsp;<span class="ident" id="2582866"><a href="/net/fd_unix.go.html#2582535">err</a></span>&nbsp;<span class="op" id="2582870">==</span>&nbsp;<span class="ident" id="2582873"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2582880">.</span><span class="ident" id="2582881">EAGAIN</span>&nbsp;<span class="op" id="2582888">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582893">if</span>&nbsp;<span class="ident" id="2582896"><a href="/net/fd_unix.go.html#2582535">err</a></span>&nbsp;<span class="op" id="2582900">=</span>&nbsp;<span class="ident" id="2582902"><a href="/net/fd_unix.go.html#2582499">fd</a></span><span class="op" id="2582904">.</span><span class="ident" id="2582905">pd</span><span class="op" id="2582907">.</span><span class="ident" id="2582908">WaitWrite</span><span class="op" id="2582917">(</span><span class="op" id="2582918">)</span><span class="op" id="2582919">;</span>&nbsp;<span class="ident" id="2582921"><a href="/net/fd_unix.go.html#2582535">err</a></span>&nbsp;<span class="op" id="2582925">==</span>&nbsp;<span class="ident" id="2582928">nil</span>&nbsp;<span class="op" id="2582932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582938">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2582950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2582954">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582958">if</span>&nbsp;<span class="ident" id="2582961"><a href="/net/fd_unix.go.html#2582535">err</a></span>&nbsp;<span class="op" id="2582965">!=</span>&nbsp;<span class="ident" id="2582968">nil</span>&nbsp;<span class="op" id="2582972">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2582977"><a href="/net/fd_unix.go.html#2582746">n</a></span>&nbsp;<span class="op" id="2582979">=</span>&nbsp;<span class="num" id="2582981">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582986">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2582994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2582998">if</span>&nbsp;<span class="ident" id="2583001"><a href="/net/fd_unix.go.html#2582746">n</a></span>&nbsp;<span class="op" id="2583003">==</span>&nbsp;<span class="num" id="2583006">0</span>&nbsp;<span class="op" id="2583008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2583013"><a href="/net/fd_unix.go.html#2582535">err</a></span>&nbsp;<span class="op" id="2583017">=</span>&nbsp;<span class="ident" id="2583019"><a href="/net/fd_unix.go.html#2575328">io</a></span><span class="op" id="2583021">.</span><span class="ident" id="2583022">ErrUnexpectedEOF</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2583042">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2583050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2583053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2583056">if</span>&nbsp;<span class="ident" id="2583059"><a href="/net/fd_unix.go.html#2582535">err</a></span>&nbsp;<span class="op" id="2583063">!=</span>&nbsp;<span class="ident" id="2583066">nil</span>&nbsp;<span class="op" id="2583070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2583074"><a href="/net/fd_unix.go.html#2582535">err</a></span>&nbsp;<span class="op" id="2583078">=</span>&nbsp;<span class="op" id="2583080">&amp;</span><span class="ident" id="2583081"><a href="/net/net.go.html#2659621">OpError</a></span><span class="op" id="2583088">{</span><span class="string" id="2583089">&#34;write&#34;</span><span class="op" id="2583096">,</span>&nbsp;<span class="ident" id="2583098"><a href="/net/fd_unix.go.html#2582499">fd</a></span><span class="op" id="2583100">.</span><span class="ident" id="2583101">net</span><span class="op" id="2583104">,</span>&nbsp;<span class="ident" id="2583106"><a href="/net/fd_unix.go.html#2582499">fd</a></span><span class="op" id="2583108">.</span><span class="ident" id="2583109">raddr</span><span class="op" id="2583114">,</span>&nbsp;<span class="ident" id="2583116"><a href="/net/fd_unix.go.html#2582535">err</a></span><span class="op" id="2583119">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2583122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2583125">return</span>&nbsp;<span class="ident" id="2583132"><a href="/net/fd_unix.go.html#2582527">nn</a></span><span class="op" id="2583134">,</span>&nbsp;<span class="ident" id="2583136"><a href="/net/fd_unix.go.html#2582535">err</a></span><br>
<span class="lineno"></span><span class="op" id="2583140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2583143">func</span>&nbsp;<span class="op" id="2583148">(</span><span class="ident" id="2583149">fd</span>&nbsp;<span class="op" id="2583152">*</span><span class="ident" id="2583153"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2583158">)</span>&nbsp;<span class="ident" id="2583160">writeTo</span><span class="op" id="2583167">(</span><span class="ident" id="2583168">p</span>&nbsp;<span class="op" id="2583170">[</span><span class="op" id="2583171">]</span><span class="builtintype" id="2583172">byte</span><span class="op" id="2583176">,</span>&nbsp;<span class="ident" id="2583178">sa</span>&nbsp;<span class="ident" id="2583181"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2583188">.</span><span class="ident" id="2583189">Sockaddr</span><span class="op" id="2583197">)</span>&nbsp;<span class="op" id="2583199">(</span><span class="ident" id="2583200">n</span>&nbsp;<span class="builtintype" id="2583202">int</span><span class="op" id="2583205">,</span>&nbsp;<span class="ident" id="2583207">err</span>&nbsp;<span class="builtintype" id="2583211">error</span><span class="op" id="2583216">)</span>&nbsp;<span class="op" id="2583218">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2583221">if</span>&nbsp;<span class="ident" id="2583224">err</span>&nbsp;<span class="op" id="2583228">:=</span>&nbsp;<span class="ident" id="2583231"><a href="/net/fd_unix.go.html#2583149">fd</a></span><span class="op" id="2583233">.</span><span class="ident" id="2583234">writeLock</span><span class="op" id="2583243">(</span><span class="op" id="2583244">)</span><span class="op" id="2583245">;</span>&nbsp;<span class="ident" id="2583247"><a href="/net/fd_unix.go.html#2583224">err</a></span>&nbsp;<span class="op" id="2583251">!=</span>&nbsp;<span class="ident" id="2583254">nil</span>&nbsp;<span class="op" id="2583258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2583262">return</span>&nbsp;<span class="num" id="2583269">0</span><span class="op" id="2583270">,</span>&nbsp;<span class="ident" id="2583272"><a href="/net/fd_unix.go.html#2583224">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2583277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2583280">defer</span>&nbsp;<span class="ident" id="2583286"><a href="/net/fd_unix.go.html#2583149">fd</a></span><span class="op" id="2583288">.</span><span class="ident" id="2583289">writeUnlock</span><span class="op" id="2583300">(</span><span class="op" id="2583301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2583304">if</span>&nbsp;<span class="ident" id="2583307">err</span>&nbsp;<span class="op" id="2583311">:=</span>&nbsp;<span class="ident" id="2583314"><a href="/net/fd_unix.go.html#2583149">fd</a></span><span class="op" id="2583316">.</span><span class="ident" id="2583317">pd</span><span class="op" id="2583319">.</span><span class="ident" id="2583320">PrepareWrite</span><span class="op" id="2583332">(</span><span class="op" id="2583333">)</span><span class="op" id="2583334">;</span>&nbsp;<span class="ident" id="2583336"><a href="/net/fd_unix.go.html#2583307">err</a></span>&nbsp;<span class="op" id="2583340">!=</span>&nbsp;<span class="ident" id="2583343">nil</span>&nbsp;<span class="op" id="2583347">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2583351">return</span>&nbsp;<span class="num" id="2583358">0</span><span class="op" id="2583359">,</span>&nbsp;<span class="op" id="2583361">&amp;</span><span class="ident" id="2583362"><a href="/net/net.go.html#2659621">OpError</a></span><span class="op" id="2583369">{</span><span class="string" id="2583370">&#34;write&#34;</span><span class="op" id="2583377">,</span>&nbsp;<span class="ident" id="2583379"><a href="/net/fd_unix.go.html#2583149">fd</a></span><span class="op" id="2583381">.</span><span class="ident" id="2583382">net</span><span class="op" id="2583385">,</span>&nbsp;<span class="ident" id="2583387"><a href="/net/fd_unix.go.html#2583149">fd</a></span><span class="op" id="2583389">.</span><span class="ident" id="2583390">raddr</span><span class="op" id="2583395">,</span>&nbsp;<span class="ident" id="2583397"><a href="/net/fd_unix.go.html#2583307">err</a></span><span class="op" id="2583400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2583403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2583406">for</span>&nbsp;<span class="op" id="2583410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2583414"><a href="/net/fd_unix.go.html#2583207">err</a></span>&nbsp;<span class="op" id="2583418">=</span>&nbsp;<span class="ident" id="2583420"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2583427">.</span><span class="ident" id="2583428">Sendto</span><span class="op" id="2583434">(</span><span class="ident" id="2583435"><a href="/net/fd_unix.go.html#2583149">fd</a></span><span class="op" id="2583437">.</span><span class="ident" id="2583438">sysfd</span><span class="op" id="2583443">,</span>&nbsp;<span class="ident" id="2583445"><a href="/net/fd_unix.go.html#2583168">p</a></span><span class="op" id="2583446">,</span>&nbsp;<span class="num" id="2583448">0</span><span class="op" id="2583449">,</span>&nbsp;<span class="ident" id="2583451"><a href="/net/fd_unix.go.html#2583178">sa</a></span><span class="op" id="2583453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2583457">if</span>&nbsp;<span class="ident" id="2583460"><a href="/net/fd_unix.go.html#2583207">err</a></span>&nbsp;<span class="op" id="2583464">==</span>&nbsp;<span class="ident" id="2583467"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2583474">.</span><span class="ident" id="2583475">EAGAIN</span>&nbsp;<span class="op" id="2583482">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2583487">if</span>&nbsp;<span class="ident" id="2583490"><a href="/net/fd_unix.go.html#2583207">err</a></span>&nbsp;<span class="op" id="2583494">=</span>&nbsp;<span class="ident" id="2583496"><a href="/net/fd_unix.go.html#2583149">fd</a></span><span class="op" id="2583498">.</span><span class="ident" id="2583499">pd</span><span class="op" id="2583501">.</span><span class="ident" id="2583502">WaitWrite</span><span class="op" id="2583511">(</span><span class="op" id="2583512">)</span><span class="op" id="2583513">;</span>&nbsp;<span class="ident" id="2583515"><a href="/net/fd_unix.go.html#2583207">err</a></span>&nbsp;<span class="op" id="2583519">==</span>&nbsp;<span class="ident" id="2583522">nil</span>&nbsp;<span class="op" id="2583526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2583532">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2583544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2583548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2583552">break</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2583559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2583562">if</span>&nbsp;<span class="ident" id="2583565"><a href="/net/fd_unix.go.html#2583207">err</a></span>&nbsp;<span class="op" id="2583569">==</span>&nbsp;<span class="ident" id="2583572">nil</span>&nbsp;<span class="op" id="2583576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2583580"><a href="/net/fd_unix.go.html#2583200">n</a></span>&nbsp;<span class="op" id="2583582">=</span>&nbsp;<span class="builtinfunc" id="2583584">len</span><span class="op" id="2583587">(</span><span class="ident" id="2583588"><a href="/net/fd_unix.go.html#2583168">p</a></span><span class="op" id="2583589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2583592">}</span>&nbsp;<span class="keyword" id="2583594">else</span>&nbsp;<span class="op" id="2583599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2583603"><a href="/net/fd_unix.go.html#2583207">err</a></span>&nbsp;<span class="op" id="2583607">=</span>&nbsp;<span class="op" id="2583609">&amp;</span><span class="ident" id="2583610"><a href="/net/net.go.html#2659621">OpError</a></span><span class="op" id="2583617">{</span><span class="string" id="2583618">&#34;write&#34;</span><span class="op" id="2583625">,</span>&nbsp;<span class="ident" id="2583627"><a href="/net/fd_unix.go.html#2583149">fd</a></span><span class="op" id="2583629">.</span><span class="ident" id="2583630">net</span><span class="op" id="2583633">,</span>&nbsp;<span class="ident" id="2583635"><a href="/net/fd_unix.go.html#2583149">fd</a></span><span class="op" id="2583637">.</span><span class="ident" id="2583638">raddr</span><span class="op" id="2583643">,</span>&nbsp;<span class="ident" id="2583645"><a href="/net/fd_unix.go.html#2583207">err</a></span><span class="op" id="2583648">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2583651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2583654">return</span><br>
<span class="lineno"></span><span class="op" id="2583661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2583664">func</span>&nbsp;<span class="op" id="2583669">(</span><span class="ident" id="2583670">fd</span>&nbsp;<span class="op" id="2583673">*</span><span class="ident" id="2583674"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2583679">)</span>&nbsp;<span class="ident" id="2583681">writeMsg</span><span class="op" id="2583689">(</span><span class="ident" id="2583690">p</span>&nbsp;<span class="op" id="2583692">[</span><span class="op" id="2583693">]</span><span class="builtintype" id="2583694">byte</span><span class="op" id="2583698">,</span>&nbsp;<span class="ident" id="2583700">oob</span>&nbsp;<span class="op" id="2583704">[</span><span class="op" id="2583705">]</span><span class="builtintype" id="2583706">byte</span><span class="op" id="2583710">,</span>&nbsp;<span class="ident" id="2583712">sa</span>&nbsp;<span class="ident" id="2583715"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2583722">.</span><span class="ident" id="2583723">Sockaddr</span><span class="op" id="2583731">)</span>&nbsp;<span class="op" id="2583733">(</span><span class="ident" id="2583734">n</span>&nbsp;<span class="builtintype" id="2583736">int</span><span class="op" id="2583739">,</span>&nbsp;<span class="ident" id="2583741">oobn</span>&nbsp;<span class="builtintype" id="2583746">int</span><span class="op" id="2583749">,</span>&nbsp;<span class="ident" id="2583751">err</span>&nbsp;<span class="builtintype" id="2583755">error</span><span class="op" id="2583760">)</span>&nbsp;<span class="op" id="2583762">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2583765">if</span>&nbsp;<span class="ident" id="2583768">err</span>&nbsp;<span class="op" id="2583772">:=</span>&nbsp;<span class="ident" id="2583775"><a href="/net/fd_unix.go.html#2583670">fd</a></span><span class="op" id="2583777">.</span><span class="ident" id="2583778">writeLock</span><span class="op" id="2583787">(</span><span class="op" id="2583788">)</span><span class="op" id="2583789">;</span>&nbsp;<span class="ident" id="2583791"><a href="/net/fd_unix.go.html#2583768">err</a></span>&nbsp;<span class="op" id="2583795">!=</span>&nbsp;<span class="ident" id="2583798">nil</span>&nbsp;<span class="op" id="2583802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2583806">return</span>&nbsp;<span class="num" id="2583813">0</span><span class="op" id="2583814">,</span>&nbsp;<span class="num" id="2583816">0</span><span class="op" id="2583817">,</span>&nbsp;<span class="ident" id="2583819"><a href="/net/fd_unix.go.html#2583768">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2583824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2583827">defer</span>&nbsp;<span class="ident" id="2583833"><a href="/net/fd_unix.go.html#2583670">fd</a></span><span class="op" id="2583835">.</span><span class="ident" id="2583836">writeUnlock</span><span class="op" id="2583847">(</span><span class="op" id="2583848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2583851">if</span>&nbsp;<span class="ident" id="2583854">err</span>&nbsp;<span class="op" id="2583858">:=</span>&nbsp;<span class="ident" id="2583861"><a href="/net/fd_unix.go.html#2583670">fd</a></span><span class="op" id="2583863">.</span><span class="ident" id="2583864">pd</span><span class="op" id="2583866">.</span><span class="ident" id="2583867">PrepareWrite</span><span class="op" id="2583879">(</span><span class="op" id="2583880">)</span><span class="op" id="2583881">;</span>&nbsp;<span class="ident" id="2583883"><a href="/net/fd_unix.go.html#2583854">err</a></span>&nbsp;<span class="op" id="2583887">!=</span>&nbsp;<span class="ident" id="2583890">nil</span>&nbsp;<span class="op" id="2583894">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2583898">return</span>&nbsp;<span class="num" id="2583905">0</span><span class="op" id="2583906">,</span>&nbsp;<span class="num" id="2583908">0</span><span class="op" id="2583909">,</span>&nbsp;<span class="op" id="2583911">&amp;</span><span class="ident" id="2583912"><a href="/net/net.go.html#2659621">OpError</a></span><span class="op" id="2583919">{</span><span class="string" id="2583920">&#34;write&#34;</span><span class="op" id="2583927">,</span>&nbsp;<span class="ident" id="2583929"><a href="/net/fd_unix.go.html#2583670">fd</a></span><span class="op" id="2583931">.</span><span class="ident" id="2583932">net</span><span class="op" id="2583935">,</span>&nbsp;<span class="ident" id="2583937"><a href="/net/fd_unix.go.html#2583670">fd</a></span><span class="op" id="2583939">.</span><span class="ident" id="2583940">raddr</span><span class="op" id="2583945">,</span>&nbsp;<span class="ident" id="2583947"><a href="/net/fd_unix.go.html#2583854">err</a></span><span class="op" id="2583950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2583953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2583956">for</span>&nbsp;<span class="op" id="2583960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2583964"><a href="/net/fd_unix.go.html#2583734">n</a></span><span class="op" id="2583965">,</span>&nbsp;<span class="ident" id="2583967"><a href="/net/fd_unix.go.html#2583751">err</a></span>&nbsp;<span class="op" id="2583971">=</span>&nbsp;<span class="ident" id="2583973"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2583980">.</span><span class="ident" id="2583981">SendmsgN</span><span class="op" id="2583989">(</span><span class="ident" id="2583990"><a href="/net/fd_unix.go.html#2583670">fd</a></span><span class="op" id="2583992">.</span><span class="ident" id="2583993">sysfd</span><span class="op" id="2583998">,</span>&nbsp;<span class="ident" id="2584000"><a href="/net/fd_unix.go.html#2583690">p</a></span><span class="op" id="2584001">,</span>&nbsp;<span class="ident" id="2584003"><a href="/net/fd_unix.go.html#2583700">oob</a></span><span class="op" id="2584006">,</span>&nbsp;<span class="ident" id="2584008"><a href="/net/fd_unix.go.html#2583712">sa</a></span><span class="op" id="2584010">,</span>&nbsp;<span class="num" id="2584012">0</span><span class="op" id="2584013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584017">if</span>&nbsp;<span class="ident" id="2584020"><a href="/net/fd_unix.go.html#2583751">err</a></span>&nbsp;<span class="op" id="2584024">==</span>&nbsp;<span class="ident" id="2584027"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2584034">.</span><span class="ident" id="2584035">EAGAIN</span>&nbsp;<span class="op" id="2584042">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584047">if</span>&nbsp;<span class="ident" id="2584050"><a href="/net/fd_unix.go.html#2583751">err</a></span>&nbsp;<span class="op" id="2584054">=</span>&nbsp;<span class="ident" id="2584056"><a href="/net/fd_unix.go.html#2583670">fd</a></span><span class="op" id="2584058">.</span><span class="ident" id="2584059">pd</span><span class="op" id="2584061">.</span><span class="ident" id="2584062">WaitWrite</span><span class="op" id="2584071">(</span><span class="op" id="2584072">)</span><span class="op" id="2584073">;</span>&nbsp;<span class="ident" id="2584075"><a href="/net/fd_unix.go.html#2583751">err</a></span>&nbsp;<span class="op" id="2584079">==</span>&nbsp;<span class="ident" id="2584082">nil</span>&nbsp;<span class="op" id="2584086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584092">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2584104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2584108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584112">break</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2584119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584122">if</span>&nbsp;<span class="ident" id="2584125"><a href="/net/fd_unix.go.html#2583751">err</a></span>&nbsp;<span class="op" id="2584129">==</span>&nbsp;<span class="ident" id="2584132">nil</span>&nbsp;<span class="op" id="2584136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2584140"><a href="/net/fd_unix.go.html#2583741">oobn</a></span>&nbsp;<span class="op" id="2584145">=</span>&nbsp;<span class="builtinfunc" id="2584147">len</span><span class="op" id="2584150">(</span><span class="ident" id="2584151"><a href="/net/fd_unix.go.html#2583700">oob</a></span><span class="op" id="2584154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2584157">}</span>&nbsp;<span class="keyword" id="2584159">else</span>&nbsp;<span class="op" id="2584164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2584168"><a href="/net/fd_unix.go.html#2583751">err</a></span>&nbsp;<span class="op" id="2584172">=</span>&nbsp;<span class="op" id="2584174">&amp;</span><span class="ident" id="2584175"><a href="/net/net.go.html#2659621">OpError</a></span><span class="op" id="2584182">{</span><span class="string" id="2584183">&#34;write&#34;</span><span class="op" id="2584190">,</span>&nbsp;<span class="ident" id="2584192"><a href="/net/fd_unix.go.html#2583670">fd</a></span><span class="op" id="2584194">.</span><span class="ident" id="2584195">net</span><span class="op" id="2584198">,</span>&nbsp;<span class="ident" id="2584200"><a href="/net/fd_unix.go.html#2583670">fd</a></span><span class="op" id="2584202">.</span><span class="ident" id="2584203">raddr</span><span class="op" id="2584208">,</span>&nbsp;<span class="ident" id="2584210"><a href="/net/fd_unix.go.html#2583751">err</a></span><span class="op" id="2584213">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2584216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584219">return</span><br>
<span class="lineno"></span><span class="op" id="2584226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2584229">func</span>&nbsp;<span class="op" id="2584234">(</span><span class="ident" id="2584235">fd</span>&nbsp;<span class="op" id="2584238">*</span><span class="ident" id="2584239"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2584244">)</span>&nbsp;<span class="ident" id="2584246">accept</span><span class="op" id="2584252">(</span><span class="op" id="2584253">)</span>&nbsp;<span class="op" id="2584255">(</span><span class="ident" id="2584256">netfd</span>&nbsp;<span class="op" id="2584262">*</span><span class="ident" id="2584263"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2584268">,</span>&nbsp;<span class="ident" id="2584270">err</span>&nbsp;<span class="builtintype" id="2584274">error</span><span class="op" id="2584279">)</span>&nbsp;<span class="op" id="2584281">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584284">if</span>&nbsp;<span class="ident" id="2584287">err</span>&nbsp;<span class="op" id="2584291">:=</span>&nbsp;<span class="ident" id="2584294"><a href="/net/fd_unix.go.html#2584235">fd</a></span><span class="op" id="2584296">.</span><span class="ident" id="2584297">readLock</span><span class="op" id="2584305">(</span><span class="op" id="2584306">)</span><span class="op" id="2584307">;</span>&nbsp;<span class="ident" id="2584309"><a href="/net/fd_unix.go.html#2584287">err</a></span>&nbsp;<span class="op" id="2584313">!=</span>&nbsp;<span class="ident" id="2584316">nil</span>&nbsp;<span class="op" id="2584320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584324">return</span>&nbsp;<span class="ident" id="2584331">nil</span><span class="op" id="2584334">,</span>&nbsp;<span class="ident" id="2584336"><a href="/net/fd_unix.go.html#2584287">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2584341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584344">defer</span>&nbsp;<span class="ident" id="2584350"><a href="/net/fd_unix.go.html#2584235">fd</a></span><span class="op" id="2584352">.</span><span class="ident" id="2584353">readUnlock</span><span class="op" id="2584363">(</span><span class="op" id="2584364">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584368">var</span>&nbsp;<span class="ident" id="2584372">s</span>&nbsp;<span class="builtintype" id="2584374">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584379">var</span>&nbsp;<span class="ident" id="2584383">rsa</span>&nbsp;<span class="ident" id="2584387"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2584394">.</span><span class="ident" id="2584395">Sockaddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584405">if</span>&nbsp;<span class="ident" id="2584408"><a href="/net/fd_unix.go.html#2584270">err</a></span>&nbsp;<span class="op" id="2584412">=</span>&nbsp;<span class="ident" id="2584414"><a href="/net/fd_unix.go.html#2584235">fd</a></span><span class="op" id="2584416">.</span><span class="ident" id="2584417">pd</span><span class="op" id="2584419">.</span><span class="ident" id="2584420">PrepareRead</span><span class="op" id="2584431">(</span><span class="op" id="2584432">)</span><span class="op" id="2584433">;</span>&nbsp;<span class="ident" id="2584435"><a href="/net/fd_unix.go.html#2584270">err</a></span>&nbsp;<span class="op" id="2584439">!=</span>&nbsp;<span class="ident" id="2584442">nil</span>&nbsp;<span class="op" id="2584446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584450">return</span>&nbsp;<span class="ident" id="2584457">nil</span><span class="op" id="2584460">,</span>&nbsp;<span class="op" id="2584462">&amp;</span><span class="ident" id="2584463"><a href="/net/net.go.html#2659621">OpError</a></span><span class="op" id="2584470">{</span><span class="string" id="2584471">&#34;accept&#34;</span><span class="op" id="2584479">,</span>&nbsp;<span class="ident" id="2584481"><a href="/net/fd_unix.go.html#2584235">fd</a></span><span class="op" id="2584483">.</span><span class="ident" id="2584484">net</span><span class="op" id="2584487">,</span>&nbsp;<span class="ident" id="2584489"><a href="/net/fd_unix.go.html#2584235">fd</a></span><span class="op" id="2584491">.</span><span class="ident" id="2584492">laddr</span><span class="op" id="2584497">,</span>&nbsp;<span class="ident" id="2584499"><a href="/net/fd_unix.go.html#2584270">err</a></span><span class="op" id="2584502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2584505">}</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584508">for</span>&nbsp;<span class="op" id="2584512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2584516"><a href="/net/fd_unix.go.html#2584372">s</a></span><span class="op" id="2584517">,</span>&nbsp;<span class="ident" id="2584519"><a href="/net/fd_unix.go.html#2584383">rsa</a></span><span class="op" id="2584522">,</span>&nbsp;<span class="ident" id="2584524"><a href="/net/fd_unix.go.html#2584270">err</a></span>&nbsp;<span class="op" id="2584528">=</span>&nbsp;<span class="ident" id="2584530"><a href="/net/sock_cloexec.go.html#2677001">accept</a></span><span class="op" id="2584536">(</span><span class="ident" id="2584537"><a href="/net/fd_unix.go.html#2584235">fd</a></span><span class="op" id="2584539">.</span><span class="ident" id="2584540">sysfd</span><span class="op" id="2584545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584549">if</span>&nbsp;<span class="ident" id="2584552"><a href="/net/fd_unix.go.html#2584270">err</a></span>&nbsp;<span class="op" id="2584556">!=</span>&nbsp;<span class="ident" id="2584559">nil</span>&nbsp;<span class="op" id="2584563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584568">if</span>&nbsp;<span class="ident" id="2584571"><a href="/net/fd_unix.go.html#2584270">err</a></span>&nbsp;<span class="op" id="2584575">==</span>&nbsp;<span class="ident" id="2584578"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2584585">.</span><span class="ident" id="2584586">EAGAIN</span>&nbsp;<span class="op" id="2584593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584599">if</span>&nbsp;<span class="ident" id="2584602"><a href="/net/fd_unix.go.html#2584270">err</a></span>&nbsp;<span class="op" id="2584606">=</span>&nbsp;<span class="ident" id="2584608"><a href="/net/fd_unix.go.html#2584235">fd</a></span><span class="op" id="2584610">.</span><span class="ident" id="2584611">pd</span><span class="op" id="2584613">.</span><span class="ident" id="2584614">WaitRead</span><span class="op" id="2584622">(</span><span class="op" id="2584623">)</span><span class="op" id="2584624">;</span>&nbsp;<span class="ident" id="2584626"><a href="/net/fd_unix.go.html#2584270">err</a></span>&nbsp;<span class="op" id="2584630">==</span>&nbsp;<span class="ident" id="2584633">nil</span>&nbsp;<span class="op" id="2584637">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584644">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2584657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2584662">}</span>&nbsp;<span class="keyword" id="2584664">else</span>&nbsp;<span class="keyword" id="2584669">if</span>&nbsp;<span class="ident" id="2584672"><a href="/net/fd_unix.go.html#2584270">err</a></span>&nbsp;<span class="op" id="2584676">==</span>&nbsp;<span class="ident" id="2584679"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2584686">.</span><span class="ident" id="2584687">ECONNABORTED</span>&nbsp;<span class="op" id="2584700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2584706">//&nbsp;This&nbsp;means&nbsp;that&nbsp;a&nbsp;socket&nbsp;on&nbsp;the&nbsp;listen&nbsp;queue&nbsp;was&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2584769">//&nbsp;before&nbsp;we&nbsp;Accept()ed&nbsp;it;&nbsp;it&#39;s&nbsp;a&nbsp;silly&nbsp;error,&nbsp;so&nbsp;try&nbsp;again.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584835">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2584847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584852">return</span>&nbsp;<span class="ident" id="2584859">nil</span><span class="op" id="2584862">,</span>&nbsp;<span class="op" id="2584864">&amp;</span><span class="ident" id="2584865"><a href="/net/net.go.html#2659621">OpError</a></span><span class="op" id="2584872">{</span><span class="string" id="2584873">&#34;accept&#34;</span><span class="op" id="2584881">,</span>&nbsp;<span class="ident" id="2584883"><a href="/net/fd_unix.go.html#2584235">fd</a></span><span class="op" id="2584885">.</span><span class="ident" id="2584886">net</span><span class="op" id="2584889">,</span>&nbsp;<span class="ident" id="2584891"><a href="/net/fd_unix.go.html#2584235">fd</a></span><span class="op" id="2584893">.</span><span class="ident" id="2584894">laddr</span><span class="op" id="2584899">,</span>&nbsp;<span class="ident" id="2584901"><a href="/net/fd_unix.go.html#2584270">err</a></span><span class="op" id="2584904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2584908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584912">break</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2584919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2584923">if</span>&nbsp;<span class="ident" id="2584926"><a href="/net/fd_unix.go.html#2584256">netfd</a></span><span class="op" id="2584931">,</span>&nbsp;<span class="ident" id="2584933"><a href="/net/fd_unix.go.html#2584270">err</a></span>&nbsp;<span class="op" id="2584937">=</span>&nbsp;<span class="ident" id="2584939"><a href="/net/fd_unix.go.html#2575871">newFD</a></span><span class="op" id="2584944">(</span><span class="ident" id="2584945"><a href="/net/fd_unix.go.html#2584372">s</a></span><span class="op" id="2584946">,</span>&nbsp;<span class="ident" id="2584948"><a href="/net/fd_unix.go.html#2584235">fd</a></span><span class="op" id="2584950">.</span><span class="ident" id="2584951">family</span><span class="op" id="2584957">,</span>&nbsp;<span class="ident" id="2584959"><a href="/net/fd_unix.go.html#2584235">fd</a></span><span class="op" id="2584961">.</span><span class="ident" id="2584962">sotype</span><span class="op" id="2584968">,</span>&nbsp;<span class="ident" id="2584970"><a href="/net/fd_unix.go.html#2584235">fd</a></span><span class="op" id="2584972">.</span><span class="ident" id="2584973">net</span><span class="op" id="2584976">)</span><span class="op" id="2584977">;</span>&nbsp;<span class="ident" id="2584979"><a href="/net/fd_unix.go.html#2584270">err</a></span>&nbsp;<span class="op" id="2584983">!=</span>&nbsp;<span class="ident" id="2584986">nil</span>&nbsp;<span class="op" id="2584990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2584994"><a href="/net/fd_unix.go.html#2587250">closesocket</a></span><span class="op" id="2585005">(</span><span class="ident" id="2585006"><a href="/net/fd_unix.go.html#2584372">s</a></span><span class="op" id="2585007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2585011">return</span>&nbsp;<span class="ident" id="2585018">nil</span><span class="op" id="2585021">,</span>&nbsp;<span class="ident" id="2585023"><a href="/net/fd_unix.go.html#2584270">err</a></span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2585028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2585031">if</span>&nbsp;<span class="ident" id="2585034"><a href="/net/fd_unix.go.html#2584270">err</a></span>&nbsp;<span class="op" id="2585038">=</span>&nbsp;<span class="ident" id="2585040"><a href="/net/fd_unix.go.html#2584256">netfd</a></span><span class="op" id="2585045">.</span><span class="ident" id="2585046">init</span><span class="op" id="2585050">(</span><span class="op" id="2585051">)</span><span class="op" id="2585052">;</span>&nbsp;<span class="ident" id="2585054"><a href="/net/fd_unix.go.html#2584270">err</a></span>&nbsp;<span class="op" id="2585058">!=</span>&nbsp;<span class="ident" id="2585061">nil</span>&nbsp;<span class="op" id="2585065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2585069"><a href="/net/fd_unix.go.html#2584235">fd</a></span><span class="op" id="2585071">.</span><span class="ident" id="2585072">Close</span><span class="op" id="2585077">(</span><span class="op" id="2585078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2585082">return</span>&nbsp;<span class="ident" id="2585089">nil</span><span class="op" id="2585092">,</span>&nbsp;<span class="ident" id="2585094"><a href="/net/fd_unix.go.html#2584270">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2585099">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2585102">lsa</span><span class="op" id="2585105">,</span>&nbsp;<span class="ident" id="2585107">_</span>&nbsp;<span class="op" id="2585109">:=</span>&nbsp;<span class="ident" id="2585112"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2585119">.</span><span class="ident" id="2585120">Getsockname</span><span class="op" id="2585131">(</span><span class="ident" id="2585132"><a href="/net/fd_unix.go.html#2584256">netfd</a></span><span class="op" id="2585137">.</span><span class="ident" id="2585138">sysfd</span><span class="op" id="2585143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2585146"><a href="/net/fd_unix.go.html#2584256">netfd</a></span><span class="op" id="2585151">.</span><span class="ident" id="2585152">setAddr</span><span class="op" id="2585159">(</span><span class="ident" id="2585160"><a href="/net/fd_unix.go.html#2584256">netfd</a></span><span class="op" id="2585165">.</span><span class="ident" id="2585166">addrFunc</span><span class="op" id="2585174">(</span><span class="op" id="2585175">)</span><span class="op" id="2585176">(</span><span class="ident" id="2585177"><a href="/net/fd_unix.go.html#2585102">lsa</a></span><span class="op" id="2585180">)</span><span class="op" id="2585181">,</span>&nbsp;<span class="ident" id="2585183"><a href="/net/fd_unix.go.html#2584256">netfd</a></span><span class="op" id="2585188">.</span><span class="ident" id="2585189">addrFunc</span><span class="op" id="2585197">(</span><span class="op" id="2585198">)</span><span class="op" id="2585199">(</span><span class="ident" id="2585200"><a href="/net/fd_unix.go.html#2584383">rsa</a></span><span class="op" id="2585203">)</span><span class="op" id="2585204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2585207">return</span>&nbsp;<span class="ident" id="2585214"><a href="/net/fd_unix.go.html#2584256">netfd</a></span><span class="op" id="2585219">,</span>&nbsp;<span class="ident" id="2585221">nil</span><br>
<span class="lineno"></span><span class="op" id="2585225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="2585228">//&nbsp;tryDupCloexec&nbsp;indicates&nbsp;whether&nbsp;F_DUPFD_CLOEXEC&nbsp;should&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="2585295">//&nbsp;If&nbsp;the&nbsp;kernel&nbsp;doesn&#39;t&nbsp;support&nbsp;it,&nbsp;this&nbsp;is&nbsp;set&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="2585350">var</span>&nbsp;<span class="ident" id="2585354">tryDupCloexec</span>&nbsp;<span class="op" id="2585368">=</span>&nbsp;<span class="builtintype" id="2585370">int32</span><span class="op" id="2585375">(</span><span class="num" id="2585376">1</span><span class="op" id="2585377">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2585380">func</span>&nbsp;<span class="ident" id="2585385">dupCloseOnExec</span><span class="op" id="2585399">(</span><span class="ident" id="2585400">fd</span>&nbsp;<span class="builtintype" id="2585403">int</span><span class="op" id="2585406">)</span>&nbsp;<span class="op" id="2585408">(</span><span class="ident" id="2585409">newfd</span>&nbsp;<span class="builtintype" id="2585415">int</span><span class="op" id="2585418">,</span>&nbsp;<span class="ident" id="2585420">err</span>&nbsp;<span class="builtintype" id="2585424">error</span><span class="op" id="2585429">)</span>&nbsp;<span class="op" id="2585431">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2585434">if</span>&nbsp;<span class="ident" id="2585437"><a href="/net/fd_unix.go.html#2575351">atomic</a></span><span class="op" id="2585443">.</span><span class="ident" id="2585444">LoadInt32</span><span class="op" id="2585453">(</span><span class="op" id="2585454">&amp;</span><span class="ident" id="2585455"><a href="/net/fd_unix.go.html#2585354">tryDupCloexec</a></span><span class="op" id="2585468">)</span>&nbsp;<span class="op" id="2585470">==</span>&nbsp;<span class="num" id="2585473">1</span>&nbsp;<span class="op" id="2585475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2585479">r0</span><span class="op" id="2585481">,</span>&nbsp;<span class="ident" id="2585483">_</span><span class="op" id="2585484">,</span>&nbsp;<span class="ident" id="2585486">e1</span>&nbsp;<span class="op" id="2585489">:=</span>&nbsp;<span class="ident" id="2585492"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2585499">.</span><span class="ident" id="2585500">Syscall</span><span class="op" id="2585507">(</span><span class="ident" id="2585508"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2585515">.</span><span class="ident" id="2585516">SYS_FCNTL</span><span class="op" id="2585525">,</span>&nbsp;<span class="builtintype" id="2585527">uintptr</span><span class="op" id="2585534">(</span><span class="ident" id="2585535"><a href="/net/fd_unix.go.html#2585400">fd</a></span><span class="op" id="2585537">)</span><span class="op" id="2585538">,</span>&nbsp;<span class="ident" id="2585540"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2585547">.</span><span class="ident" id="2585548">F_DUPFD_CLOEXEC</span><span class="op" id="2585563">,</span>&nbsp;<span class="num" id="2585565">0</span><span class="op" id="2585566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2585570">if</span>&nbsp;<span class="ident" id="2585573"><a href="/net/fd_unix.go.html#2575340">runtime</a></span><span class="op" id="2585580">.</span><span class="ident" id="2585581">GOOS</span>&nbsp;<span class="op" id="2585586">==</span>&nbsp;<span class="string" id="2585589">&#34;darwin&#34;</span>&nbsp;<span class="op" id="2585598">&amp;&amp;</span>&nbsp;<span class="ident" id="2585601"><a href="/net/fd_unix.go.html#2585486">e1</a></span>&nbsp;<span class="op" id="2585604">==</span>&nbsp;<span class="ident" id="2585607"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2585614">.</span><span class="ident" id="2585615">EBADF</span>&nbsp;<span class="op" id="2585621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2585626">//&nbsp;On&nbsp;OS&nbsp;X&nbsp;10.6&nbsp;and&nbsp;below&nbsp;(but&nbsp;we&nbsp;only&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2585676">//&nbsp;&gt;=&nbsp;10.6),&nbsp;F_DUPFD_CLOEXEC&nbsp;is&nbsp;unsupported</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2585723">//&nbsp;and&nbsp;fcntl&nbsp;there&nbsp;falls&nbsp;back&nbsp;(undocumented)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2585771">//&nbsp;to&nbsp;doing&nbsp;an&nbsp;ioctl&nbsp;instead,&nbsp;returning&nbsp;EBADF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2585820">//&nbsp;in&nbsp;this&nbsp;case&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2585864">//&nbsp;expected&nbsp;device&nbsp;fd&nbsp;type.&nbsp;&nbsp;Treat&nbsp;it&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2585908">//&nbsp;EINVAL&nbsp;instead,&nbsp;so&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2585953">//&nbsp;normal&nbsp;dup&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2585976">//&nbsp;TODO:&nbsp;only&nbsp;do&nbsp;this&nbsp;on&nbsp;10.6&nbsp;if&nbsp;we&nbsp;can&nbsp;detect&nbsp;10.6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2586031">//&nbsp;cheaply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2586046"><a href="/net/fd_unix.go.html#2585486">e1</a></span>&nbsp;<span class="op" id="2586049">=</span>&nbsp;<span class="ident" id="2586051"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2586058">.</span><span class="ident" id="2586059">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2586068">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586072">switch</span>&nbsp;<span class="ident" id="2586079"><a href="/net/fd_unix.go.html#2585486">e1</a></span>&nbsp;<span class="op" id="2586082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586086">case</span>&nbsp;<span class="num" id="2586091">0</span><span class="op" id="2586092">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586097">return</span>&nbsp;<span class="builtintype" id="2586104">int</span><span class="op" id="2586107">(</span><span class="ident" id="2586108"><a href="/net/fd_unix.go.html#2585479">r0</a></span><span class="op" id="2586110">)</span><span class="op" id="2586111">,</span>&nbsp;<span class="ident" id="2586113">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586119">case</span>&nbsp;<span class="ident" id="2586124"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2586131">.</span><span class="ident" id="2586132">EINVAL</span><span class="op" id="2586138">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2586143">//&nbsp;Old&nbsp;kernel.&nbsp;Fall&nbsp;back&nbsp;to&nbsp;the&nbsp;portable&nbsp;way</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2586191">//&nbsp;from&nbsp;now&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2586210"><a href="/net/fd_unix.go.html#2575351">atomic</a></span><span class="op" id="2586216">.</span><span class="ident" id="2586217">StoreInt32</span><span class="op" id="2586227">(</span><span class="op" id="2586228">&amp;</span><span class="ident" id="2586229"><a href="/net/fd_unix.go.html#2585354">tryDupCloexec</a></span><span class="op" id="2586242">,</span>&nbsp;<span class="num" id="2586244">0</span><span class="op" id="2586245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586249">default</span><span class="op" id="2586256">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586261">return</span>&nbsp;<span class="op" id="2586268">-</span><span class="num" id="2586269">1</span><span class="op" id="2586270">,</span>&nbsp;<span class="ident" id="2586272"><a href="/net/fd_unix.go.html#2585486">e1</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2586277">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2586280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586283">return</span>&nbsp;<span class="ident" id="2586290"><a href="/net/fd_unix.go.html#2586435">dupCloseOnExecOld</a></span><span class="op" id="2586307">(</span><span class="ident" id="2586308"><a href="/net/fd_unix.go.html#2585400">fd</a></span><span class="op" id="2586310">)</span><br>
<span class="lineno"></span><span class="op" id="2586312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2586315">//&nbsp;dupCloseOnExecUnixOld&nbsp;is&nbsp;the&nbsp;traditional&nbsp;way&nbsp;to&nbsp;dup&nbsp;an&nbsp;fd&nbsp;and</span><br>
<span class="lineno">480</span><span class="comment" id="2586380">//&nbsp;set&nbsp;its&nbsp;O_CLOEXEC&nbsp;bit,&nbsp;using&nbsp;two&nbsp;system&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="2586430">func</span>&nbsp;<span class="ident" id="2586435">dupCloseOnExecOld</span><span class="op" id="2586452">(</span><span class="ident" id="2586453">fd</span>&nbsp;<span class="builtintype" id="2586456">int</span><span class="op" id="2586459">)</span>&nbsp;<span class="op" id="2586461">(</span><span class="ident" id="2586462">newfd</span>&nbsp;<span class="builtintype" id="2586468">int</span><span class="op" id="2586471">,</span>&nbsp;<span class="ident" id="2586473">err</span>&nbsp;<span class="builtintype" id="2586477">error</span><span class="op" id="2586482">)</span>&nbsp;<span class="op" id="2586484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2586487"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2586494">.</span><span class="ident" id="2586495">ForkLock</span><span class="op" id="2586503">.</span><span class="ident" id="2586504">RLock</span><span class="op" id="2586509">(</span><span class="op" id="2586510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586513">defer</span>&nbsp;<span class="ident" id="2586519"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2586526">.</span><span class="ident" id="2586527">ForkLock</span><span class="op" id="2586535">.</span><span class="ident" id="2586536">RUnlock</span><span class="op" id="2586543">(</span><span class="op" id="2586544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2586547"><a href="/net/fd_unix.go.html#2586462">newfd</a></span><span class="op" id="2586552">,</span>&nbsp;<span class="ident" id="2586554"><a href="/net/fd_unix.go.html#2586473">err</a></span>&nbsp;<span class="op" id="2586558">=</span>&nbsp;<span class="ident" id="2586560"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2586567">.</span><span class="ident" id="2586568">Dup</span><span class="op" id="2586571">(</span><span class="ident" id="2586572"><a href="/net/fd_unix.go.html#2586453">fd</a></span><span class="op" id="2586574">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586577">if</span>&nbsp;<span class="ident" id="2586580"><a href="/net/fd_unix.go.html#2586473">err</a></span>&nbsp;<span class="op" id="2586584">!=</span>&nbsp;<span class="ident" id="2586587">nil</span>&nbsp;<span class="op" id="2586591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586595">return</span>&nbsp;<span class="op" id="2586602">-</span><span class="num" id="2586603">1</span><span class="op" id="2586604">,</span>&nbsp;<span class="ident" id="2586606"><a href="/net/fd_unix.go.html#2586473">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2586611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2586614"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2586621">.</span><span class="ident" id="2586622">CloseOnExec</span><span class="op" id="2586633">(</span><span class="ident" id="2586634"><a href="/net/fd_unix.go.html#2586462">newfd</a></span><span class="op" id="2586639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586642">return</span><br>
<span class="lineno">490</span><span class="op" id="2586649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2586652">func</span>&nbsp;<span class="op" id="2586657">(</span><span class="ident" id="2586658">fd</span>&nbsp;<span class="op" id="2586661">*</span><span class="ident" id="2586662"><a href="/net/fd_unix.go.html#2575420">netFD</a></span><span class="op" id="2586667">)</span>&nbsp;<span class="ident" id="2586669">dup</span><span class="op" id="2586672">(</span><span class="op" id="2586673">)</span>&nbsp;<span class="op" id="2586675">(</span><span class="ident" id="2586676">f</span>&nbsp;<span class="op" id="2586678">*</span><span class="ident" id="2586679"><a href="/net/fd_unix.go.html#2575334">os</a></span><span class="op" id="2586681">.</span><span class="ident" id="2586682">File</span><span class="op" id="2586686">,</span>&nbsp;<span class="ident" id="2586688">err</span>&nbsp;<span class="builtintype" id="2586692">error</span><span class="op" id="2586697">)</span>&nbsp;<span class="op" id="2586699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2586702">ns</span><span class="op" id="2586704">,</span>&nbsp;<span class="ident" id="2586706"><a href="/net/fd_unix.go.html#2586688">err</a></span>&nbsp;<span class="op" id="2586710">:=</span>&nbsp;<span class="ident" id="2586713"><a href="/net/fd_unix.go.html#2585385">dupCloseOnExec</a></span><span class="op" id="2586727">(</span><span class="ident" id="2586728"><a href="/net/fd_unix.go.html#2586658">fd</a></span><span class="op" id="2586730">.</span><span class="ident" id="2586731">sysfd</span><span class="op" id="2586736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586739">if</span>&nbsp;<span class="ident" id="2586742"><a href="/net/fd_unix.go.html#2586688">err</a></span>&nbsp;<span class="op" id="2586746">!=</span>&nbsp;<span class="ident" id="2586749">nil</span>&nbsp;<span class="op" id="2586753">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2586757">return</span>&nbsp;<span class="ident" id="2586764">nil</span><span class="op" id="2586767">,</span>&nbsp;<span class="op" id="2586769">&amp;</span><span class="ident" id="2586770"><a href="/net/net.go.html#2659621">OpError</a></span><span class="op" id="2586777">{</span><span class="string" id="2586778">&#34;dup&#34;</span><span class="op" id="2586783">,</span>&nbsp;<span class="ident" id="2586785"><a href="/net/fd_unix.go.html#2586658">fd</a></span><span class="op" id="2586787">.</span><span class="ident" id="2586788">net</span><span class="op" id="2586791">,</span>&nbsp;<span class="ident" id="2586793"><a href="/net/fd_unix.go.html#2586658">fd</a></span><span class="op" id="2586795">.</span><span class="ident" id="2586796">laddr</span><span class="op" id="2586801">,</span>&nbsp;<span class="ident" id="2586803"><a href="/net/fd_unix.go.html#2586688">err</a></span><span class="op" id="2586806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2586809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2586813">//&nbsp;We&nbsp;want&nbsp;blocking&nbsp;mode&nbsp;for&nbsp;the&nbsp;new&nbsp;fd,&nbsp;hence&nbsp;the&nbsp;double&nbsp;negative.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2586882">//&nbsp;This&nbsp;also&nbsp;puts&nbsp;the&nbsp;old&nbsp;fd&nbsp;into&nbsp;blocking&nbsp;mode,&nbsp;meaning&nbsp;that</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2586945">//&nbsp;I/O&nbsp;will&nbsp;block&nbsp;the&nbsp;thread&nbsp;instead&nbsp;of&nbsp;letting&nbsp;us&nbsp;use&nbsp;the&nbsp;epoll&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2587019">//&nbsp;Everything&nbsp;will&nbsp;still&nbsp;work,&nbsp;just&nbsp;with&nbsp;more&nbsp;threads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587075">if</span>&nbsp;<span class="ident" id="2587078"><a href="/net/fd_unix.go.html#2586688">err</a></span>&nbsp;<span class="op" id="2587082">=</span>&nbsp;<span class="ident" id="2587084"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2587091">.</span><span class="ident" id="2587092">SetNonblock</span><span class="op" id="2587103">(</span><span class="ident" id="2587104"><a href="/net/fd_unix.go.html#2586702">ns</a></span><span class="op" id="2587106">,</span>&nbsp;<span class="ident" id="2587108">false</span><span class="op" id="2587113">)</span><span class="op" id="2587114">;</span>&nbsp;<span class="ident" id="2587116"><a href="/net/fd_unix.go.html#2586688">err</a></span>&nbsp;<span class="op" id="2587120">!=</span>&nbsp;<span class="ident" id="2587123">nil</span>&nbsp;<span class="op" id="2587127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587131">return</span>&nbsp;<span class="ident" id="2587138">nil</span><span class="op" id="2587141">,</span>&nbsp;<span class="op" id="2587143">&amp;</span><span class="ident" id="2587144"><a href="/net/net.go.html#2659621">OpError</a></span><span class="op" id="2587151">{</span><span class="string" id="2587152">&#34;setnonblock&#34;</span><span class="op" id="2587165">,</span>&nbsp;<span class="ident" id="2587167"><a href="/net/fd_unix.go.html#2586658">fd</a></span><span class="op" id="2587169">.</span><span class="ident" id="2587170">net</span><span class="op" id="2587173">,</span>&nbsp;<span class="ident" id="2587175"><a href="/net/fd_unix.go.html#2586658">fd</a></span><span class="op" id="2587177">.</span><span class="ident" id="2587178">laddr</span><span class="op" id="2587183">,</span>&nbsp;<span class="ident" id="2587185"><a href="/net/fd_unix.go.html#2586688">err</a></span><span class="op" id="2587188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2587191">}</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587195">return</span>&nbsp;<span class="ident" id="2587202"><a href="/net/fd_unix.go.html#2575334">os</a></span><span class="op" id="2587204">.</span><span class="ident" id="2587205">NewFile</span><span class="op" id="2587212">(</span><span class="builtintype" id="2587213">uintptr</span><span class="op" id="2587220">(</span><span class="ident" id="2587221"><a href="/net/fd_unix.go.html#2586702">ns</a></span><span class="op" id="2587223">)</span><span class="op" id="2587224">,</span>&nbsp;<span class="ident" id="2587226"><a href="/net/fd_unix.go.html#2586658">fd</a></span><span class="op" id="2587228">.</span><span class="ident" id="2587229">name</span><span class="op" id="2587233">(</span><span class="op" id="2587234">)</span><span class="op" id="2587235">)</span><span class="op" id="2587236">,</span>&nbsp;<span class="ident" id="2587238">nil</span><br>
<span class="lineno"></span><span class="op" id="2587242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2587245">func</span>&nbsp;<span class="ident" id="2587250">closesocket</span><span class="op" id="2587261">(</span><span class="ident" id="2587262">s</span>&nbsp;<span class="builtintype" id="2587264">int</span><span class="op" id="2587267">)</span>&nbsp;<span class="builtintype" id="2587269">error</span>&nbsp;<span class="op" id="2587275">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587278">return</span>&nbsp;<span class="ident" id="2587285"><a href="/net/fd_unix.go.html#2575366">syscall</a></span><span class="op" id="2587292">.</span><span class="ident" id="2587293">Close</span><span class="op" id="2587298">(</span><span class="ident" id="2587299"><a href="/net/fd_unix.go.html#2587262">s</a></span><span class="op" id="2587300">)</span><br>
<span class="lineno"></span><span class="op" id="2587302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2587305">func</span>&nbsp;<span class="ident" id="2587310">skipRawSocketTests</span><span class="op" id="2587328">(</span><span class="op" id="2587329">)</span>&nbsp;<span class="op" id="2587331">(</span><span class="ident" id="2587332">skip</span>&nbsp;<span class="builtintype" id="2587337">bool</span><span class="op" id="2587341">,</span>&nbsp;<span class="ident" id="2587343">skipmsg</span>&nbsp;<span class="builtintype" id="2587351">string</span><span class="op" id="2587357">,</span>&nbsp;<span class="ident" id="2587359">err</span>&nbsp;<span class="builtintype" id="2587363">error</span><span class="op" id="2587368">)</span>&nbsp;<span class="op" id="2587370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587373">if</span>&nbsp;<span class="ident" id="2587376"><a href="/net/fd_unix.go.html#2575334">os</a></span><span class="op" id="2587378">.</span><span class="ident" id="2587379">Getuid</span><span class="op" id="2587385">(</span><span class="op" id="2587386">)</span>&nbsp;<span class="op" id="2587388">!=</span>&nbsp;<span class="num" id="2587391">0</span>&nbsp;<span class="op" id="2587393">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587397">return</span>&nbsp;<span class="ident" id="2587404">true</span><span class="op" id="2587408">,</span>&nbsp;<span class="string" id="2587410">&#34;skipping&nbsp;test;&nbsp;must&nbsp;be&nbsp;root&#34;</span><span class="op" id="2587439">,</span>&nbsp;<span class="ident" id="2587441">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2587446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2587449">return</span>&nbsp;<span class="ident" id="2587456">false</span><span class="op" id="2587461">,</span>&nbsp;<span class="string" id="2587463">&#34;&#34;</span><span class="op" id="2587465">,</span>&nbsp;<span class="ident" id="2587467">nil</span><br>
<span class="lineno"></span><span class="op" id="2587471">}</span>
</div>
</body>
</html>
