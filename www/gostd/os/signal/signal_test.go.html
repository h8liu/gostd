<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>os/signal</h2>
<ul>
<li><a href="/gostd/os/signal/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/os/signal/signal.go.html">signal.go</a></li>
<li><a href="/gostd/os/signal/signal_test.go.html" class="current">signal_test.go</a></li>
<li><a href="/gostd/os/signal/signal_unix.go.html">signal_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7655375">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7655430">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7655484">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7655535">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7655600">package</span>&nbsp;<span class="ident" id="7655608">signal</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7655616">import</span>&nbsp;<span class="op" id="7655623">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7655626">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7655634">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7655647">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7655653">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7655664">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7655675">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7655686">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7655697">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="7655708">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7655715">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7655718">func</span>&nbsp;<span class="ident" id="7655723">waitSig</span><span class="op" id="7655730">(</span><span class="ident" id="7655731">t</span>&nbsp;<span class="op" id="7655733">*</span><span class="ident" id="7655734">testing</span><span class="op" id="7655741">.</span><span class="ident" id="7655742">T</span><span class="op" id="7655743">,</span>&nbsp;<span class="ident" id="7655745">c</span>&nbsp;<span class="op" id="7655747">&lt;-</span><span class="keyword" id="7655749">chan</span>&nbsp;<span class="ident" id="7655754">os</span><span class="op" id="7655756">.</span><span class="ident" id="7655757">Signal</span><span class="op" id="7655763">,</span>&nbsp;<span class="ident" id="7655765">sig</span>&nbsp;<span class="ident" id="7655769">os</span><span class="op" id="7655771">.</span><span class="ident" id="7655772">Signal</span><span class="op" id="7655778">)</span>&nbsp;<span class="op" id="7655780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7655783">select</span>&nbsp;<span class="op" id="7655790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7655793">case</span>&nbsp;<span class="ident" id="7655798">s</span>&nbsp;<span class="op" id="7655800">:=</span>&nbsp;<span class="op" id="7655803">&lt;-</span><span class="ident" id="7655805">c</span><span class="op" id="7655806">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7655810">if</span>&nbsp;<span class="ident" id="7655813">s</span>&nbsp;<span class="op" id="7655815">!=</span>&nbsp;<span class="ident" id="7655818">sig</span>&nbsp;<span class="op" id="7655822">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7655827">t</span><span class="op" id="7655828">.</span><span class="ident" id="7655829">Fatalf</span><span class="op" id="7655835">(</span><span class="string" id="7655836">&#34;signal&nbsp;was&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7655860">,</span>&nbsp;<span class="ident" id="7655862">s</span><span class="op" id="7655863">,</span>&nbsp;<span class="ident" id="7655865">sig</span><span class="op" id="7655868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7655872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7655875">case</span>&nbsp;<span class="op" id="7655880">&lt;-</span><span class="ident" id="7655882">time</span><span class="op" id="7655886">.</span><span class="ident" id="7655887">After</span><span class="op" id="7655892">(</span><span class="num" id="7655893">1</span>&nbsp;<span class="op" id="7655895">*</span>&nbsp;<span class="ident" id="7655897">time</span><span class="op" id="7655901">.</span><span class="ident" id="7655902">Second</span><span class="op" id="7655908">)</span><span class="op" id="7655909">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7655913">t</span><span class="op" id="7655914">.</span><span class="ident" id="7655915">Fatalf</span><span class="op" id="7655921">(</span><span class="string" id="7655922">&#34;timeout&nbsp;waiting&nbsp;for&nbsp;%v&#34;</span><span class="op" id="7655946">,</span>&nbsp;<span class="ident" id="7655948">sig</span><span class="op" id="7655951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7655954">}</span><br>
<span class="lineno">30</span><span class="op" id="7655956">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7655959">//&nbsp;Test&nbsp;that&nbsp;basic&nbsp;signal&nbsp;handling&nbsp;works.</span><br>
<span class="lineno"></span><span class="keyword" id="7656001">func</span>&nbsp;<span class="ident" id="7656006">TestSignal</span><span class="op" id="7656016">(</span><span class="ident" id="7656017">t</span>&nbsp;<span class="op" id="7656019">*</span><span class="ident" id="7656020">testing</span><span class="op" id="7656027">.</span><span class="ident" id="7656028">T</span><span class="op" id="7656029">)</span>&nbsp;<span class="op" id="7656031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7656034">//&nbsp;Ask&nbsp;for&nbsp;SIGHUP</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7656053">c</span>&nbsp;<span class="op" id="7656055">:=</span>&nbsp;<span class="builtinfunc" id="7656058">make</span><span class="op" id="7656062">(</span><span class="keyword" id="7656063">chan</span>&nbsp;<span class="ident" id="7656068">os</span><span class="op" id="7656070">.</span><span class="ident" id="7656071">Signal</span><span class="op" id="7656077">,</span>&nbsp;<span class="num" id="7656079">1</span><span class="op" id="7656080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7656083">Notify</span><span class="op" id="7656089">(</span><span class="ident" id="7656090">c</span><span class="op" id="7656091">,</span>&nbsp;<span class="ident" id="7656093">syscall</span><span class="op" id="7656100">.</span><span class="ident" id="7656101">SIGHUP</span><span class="op" id="7656107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7656110">defer</span>&nbsp;<span class="ident" id="7656116">Stop</span><span class="op" id="7656120">(</span><span class="ident" id="7656121">c</span><span class="op" id="7656122">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7656126">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGHUP</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7656157">t</span><span class="op" id="7656158">.</span><span class="ident" id="7656159">Logf</span><span class="op" id="7656163">(</span><span class="string" id="7656164">&#34;sighup...&#34;</span><span class="op" id="7656175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7656178">syscall</span><span class="op" id="7656185">.</span><span class="ident" id="7656186">Kill</span><span class="op" id="7656190">(</span><span class="ident" id="7656191">syscall</span><span class="op" id="7656198">.</span><span class="ident" id="7656199">Getpid</span><span class="op" id="7656205">(</span><span class="op" id="7656206">)</span><span class="op" id="7656207">,</span>&nbsp;<span class="ident" id="7656209">syscall</span><span class="op" id="7656216">.</span><span class="ident" id="7656217">SIGHUP</span><span class="op" id="7656223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7656226">waitSig</span><span class="op" id="7656233">(</span><span class="ident" id="7656234">t</span><span class="op" id="7656235">,</span>&nbsp;<span class="ident" id="7656237">c</span><span class="op" id="7656238">,</span>&nbsp;<span class="ident" id="7656240">syscall</span><span class="op" id="7656247">.</span><span class="ident" id="7656248">SIGHUP</span><span class="op" id="7656254">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7656258">//&nbsp;Ask&nbsp;for&nbsp;everything&nbsp;we&nbsp;can&nbsp;get.</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7656293">c1</span>&nbsp;<span class="op" id="7656296">:=</span>&nbsp;<span class="builtinfunc" id="7656299">make</span><span class="op" id="7656303">(</span><span class="keyword" id="7656304">chan</span>&nbsp;<span class="ident" id="7656309">os</span><span class="op" id="7656311">.</span><span class="ident" id="7656312">Signal</span><span class="op" id="7656318">,</span>&nbsp;<span class="num" id="7656320">1</span><span class="op" id="7656321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7656324">Notify</span><span class="op" id="7656330">(</span><span class="ident" id="7656331">c1</span><span class="op" id="7656333">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7656337">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;a&nbsp;SIGWINCH</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7656370">t</span><span class="op" id="7656371">.</span><span class="ident" id="7656372">Logf</span><span class="op" id="7656376">(</span><span class="string" id="7656377">&#34;sigwinch...&#34;</span><span class="op" id="7656390">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7656393">syscall</span><span class="op" id="7656400">.</span><span class="ident" id="7656401">Kill</span><span class="op" id="7656405">(</span><span class="ident" id="7656406">syscall</span><span class="op" id="7656413">.</span><span class="ident" id="7656414">Getpid</span><span class="op" id="7656420">(</span><span class="op" id="7656421">)</span><span class="op" id="7656422">,</span>&nbsp;<span class="ident" id="7656424">syscall</span><span class="op" id="7656431">.</span><span class="ident" id="7656432">SIGWINCH</span><span class="op" id="7656440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7656443">waitSig</span><span class="op" id="7656450">(</span><span class="ident" id="7656451">t</span><span class="op" id="7656452">,</span>&nbsp;<span class="ident" id="7656454">c1</span><span class="op" id="7656456">,</span>&nbsp;<span class="ident" id="7656458">syscall</span><span class="op" id="7656465">.</span><span class="ident" id="7656466">SIGWINCH</span><span class="op" id="7656474">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7656478">//&nbsp;Send&nbsp;two&nbsp;more&nbsp;SIGHUPs,&nbsp;to&nbsp;make&nbsp;sure&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7656523">//&nbsp;they&nbsp;get&nbsp;delivered&nbsp;on&nbsp;c1&nbsp;and&nbsp;that&nbsp;not&nbsp;reading</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7656573">//&nbsp;from&nbsp;c&nbsp;does&nbsp;not&nbsp;block&nbsp;everything.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7656611">t</span><span class="op" id="7656612">.</span><span class="ident" id="7656613">Logf</span><span class="op" id="7656617">(</span><span class="string" id="7656618">&#34;sighup...&#34;</span><span class="op" id="7656629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7656632">syscall</span><span class="op" id="7656639">.</span><span class="ident" id="7656640">Kill</span><span class="op" id="7656644">(</span><span class="ident" id="7656645">syscall</span><span class="op" id="7656652">.</span><span class="ident" id="7656653">Getpid</span><span class="op" id="7656659">(</span><span class="op" id="7656660">)</span><span class="op" id="7656661">,</span>&nbsp;<span class="ident" id="7656663">syscall</span><span class="op" id="7656670">.</span><span class="ident" id="7656671">SIGHUP</span><span class="op" id="7656677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7656680">waitSig</span><span class="op" id="7656687">(</span><span class="ident" id="7656688">t</span><span class="op" id="7656689">,</span>&nbsp;<span class="ident" id="7656691">c1</span><span class="op" id="7656693">,</span>&nbsp;<span class="ident" id="7656695">syscall</span><span class="op" id="7656702">.</span><span class="ident" id="7656703">SIGHUP</span><span class="op" id="7656709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7656712">t</span><span class="op" id="7656713">.</span><span class="ident" id="7656714">Logf</span><span class="op" id="7656718">(</span><span class="string" id="7656719">&#34;sighup...&#34;</span><span class="op" id="7656730">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7656733">syscall</span><span class="op" id="7656740">.</span><span class="ident" id="7656741">Kill</span><span class="op" id="7656745">(</span><span class="ident" id="7656746">syscall</span><span class="op" id="7656753">.</span><span class="ident" id="7656754">Getpid</span><span class="op" id="7656760">(</span><span class="op" id="7656761">)</span><span class="op" id="7656762">,</span>&nbsp;<span class="ident" id="7656764">syscall</span><span class="op" id="7656771">.</span><span class="ident" id="7656772">SIGHUP</span><span class="op" id="7656778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7656781">waitSig</span><span class="op" id="7656788">(</span><span class="ident" id="7656789">t</span><span class="op" id="7656790">,</span>&nbsp;<span class="ident" id="7656792">c1</span><span class="op" id="7656794">,</span>&nbsp;<span class="ident" id="7656796">syscall</span><span class="op" id="7656803">.</span><span class="ident" id="7656804">SIGHUP</span><span class="op" id="7656810">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7656814">//&nbsp;The&nbsp;first&nbsp;SIGHUP&nbsp;should&nbsp;be&nbsp;waiting&nbsp;for&nbsp;us&nbsp;on&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7656866">waitSig</span><span class="op" id="7656873">(</span><span class="ident" id="7656874">t</span><span class="op" id="7656875">,</span>&nbsp;<span class="ident" id="7656877">c</span><span class="op" id="7656878">,</span>&nbsp;<span class="ident" id="7656880">syscall</span><span class="op" id="7656887">.</span><span class="ident" id="7656888">SIGHUP</span><span class="op" id="7656894">)</span><br>
<span class="lineno">65</span><span class="op" id="7656896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7656899">func</span>&nbsp;<span class="ident" id="7656904">TestStress</span><span class="op" id="7656914">(</span><span class="ident" id="7656915">t</span>&nbsp;<span class="op" id="7656917">*</span><span class="ident" id="7656918">testing</span><span class="op" id="7656925">.</span><span class="ident" id="7656926">T</span><span class="op" id="7656927">)</span>&nbsp;<span class="op" id="7656929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7656932">dur</span>&nbsp;<span class="op" id="7656936">:=</span>&nbsp;<span class="num" id="7656939">3</span>&nbsp;<span class="op" id="7656941">*</span>&nbsp;<span class="ident" id="7656943">time</span><span class="op" id="7656947">.</span><span class="ident" id="7656948">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7656956">if</span>&nbsp;<span class="ident" id="7656959">testing</span><span class="op" id="7656966">.</span><span class="ident" id="7656967">Short</span><span class="op" id="7656972">(</span><span class="op" id="7656973">)</span>&nbsp;<span class="op" id="7656975">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7656979">dur</span>&nbsp;<span class="op" id="7656983">=</span>&nbsp;<span class="num" id="7656985">100</span>&nbsp;<span class="op" id="7656989">*</span>&nbsp;<span class="ident" id="7656991">time</span><span class="op" id="7656995">.</span><span class="ident" id="7656996">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7657009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7657012">defer</span>&nbsp;<span class="ident" id="7657018">runtime</span><span class="op" id="7657025">.</span><span class="ident" id="7657026">GOMAXPROCS</span><span class="op" id="7657036">(</span><span class="ident" id="7657037">runtime</span><span class="op" id="7657044">.</span><span class="ident" id="7657045">GOMAXPROCS</span><span class="op" id="7657055">(</span><span class="num" id="7657056">4</span><span class="op" id="7657057">)</span><span class="op" id="7657058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7657061">done</span>&nbsp;<span class="op" id="7657066">:=</span>&nbsp;<span class="builtinfunc" id="7657069">make</span><span class="op" id="7657073">(</span><span class="keyword" id="7657074">chan</span>&nbsp;<span class="builtintype" id="7657079">bool</span><span class="op" id="7657083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7657086">finished</span>&nbsp;<span class="op" id="7657095">:=</span>&nbsp;<span class="builtinfunc" id="7657098">make</span><span class="op" id="7657102">(</span><span class="keyword" id="7657103">chan</span>&nbsp;<span class="builtintype" id="7657108">bool</span><span class="op" id="7657112">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7657115">go</span>&nbsp;<span class="keyword" id="7657118">func</span><span class="op" id="7657122">(</span><span class="op" id="7657123">)</span>&nbsp;<span class="op" id="7657125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7657129">sig</span>&nbsp;<span class="op" id="7657133">:=</span>&nbsp;<span class="builtinfunc" id="7657136">make</span><span class="op" id="7657140">(</span><span class="keyword" id="7657141">chan</span>&nbsp;<span class="ident" id="7657146">os</span><span class="op" id="7657148">.</span><span class="ident" id="7657149">Signal</span><span class="op" id="7657155">,</span>&nbsp;<span class="num" id="7657157">1</span><span class="op" id="7657158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7657162">Notify</span><span class="op" id="7657168">(</span><span class="ident" id="7657169">sig</span><span class="op" id="7657172">,</span>&nbsp;<span class="ident" id="7657174">syscall</span><span class="op" id="7657181">.</span><span class="ident" id="7657182">SIGUSR1</span><span class="op" id="7657189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7657193">defer</span>&nbsp;<span class="ident" id="7657199">Stop</span><span class="op" id="7657203">(</span><span class="ident" id="7657204">sig</span><span class="op" id="7657207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7657210">Loop</span><span class="op" id="7657214">:</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7657218">for</span>&nbsp;<span class="op" id="7657222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7657227">select</span>&nbsp;<span class="op" id="7657234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7657239">case</span>&nbsp;<span class="op" id="7657244">&lt;-</span><span class="ident" id="7657246">sig</span><span class="op" id="7657249">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7657254">case</span>&nbsp;<span class="op" id="7657259">&lt;-</span><span class="ident" id="7657261">done</span><span class="op" id="7657265">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7657271">break</span>&nbsp;<span class="ident" id="7657277">Loop</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7657285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7657289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7657293">finished</span>&nbsp;<span class="op" id="7657302">&lt;-</span>&nbsp;<span class="builtintype" id="7657305">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7657311">}</span><span class="op" id="7657312">(</span><span class="op" id="7657313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7657316">go</span>&nbsp;<span class="keyword" id="7657319">func</span><span class="op" id="7657323">(</span><span class="op" id="7657324">)</span>&nbsp;<span class="op" id="7657326">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7657329">Loop</span><span class="op" id="7657333">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7657337">for</span>&nbsp;<span class="op" id="7657341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7657346">select</span>&nbsp;<span class="op" id="7657353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7657358">case</span>&nbsp;<span class="op" id="7657363">&lt;-</span><span class="ident" id="7657365">done</span><span class="op" id="7657369">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7657375">break</span>&nbsp;<span class="ident" id="7657381">Loop</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7657389">default</span><span class="op" id="7657396">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7657402">syscall</span><span class="op" id="7657409">.</span><span class="ident" id="7657410">Kill</span><span class="op" id="7657414">(</span><span class="ident" id="7657415">syscall</span><span class="op" id="7657422">.</span><span class="ident" id="7657423">Getpid</span><span class="op" id="7657429">(</span><span class="op" id="7657430">)</span><span class="op" id="7657431">,</span>&nbsp;<span class="ident" id="7657433">syscall</span><span class="op" id="7657440">.</span><span class="ident" id="7657441">SIGUSR1</span><span class="op" id="7657448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7657454">runtime</span><span class="op" id="7657461">.</span><span class="ident" id="7657462">Gosched</span><span class="op" id="7657469">(</span><span class="op" id="7657470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7657475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7657479">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7657483">finished</span>&nbsp;<span class="op" id="7657492">&lt;-</span>&nbsp;<span class="builtintype" id="7657495">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7657501">}</span><span class="op" id="7657502">(</span><span class="op" id="7657503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7657506">time</span><span class="op" id="7657510">.</span><span class="ident" id="7657511">Sleep</span><span class="op" id="7657516">(</span><span class="ident" id="7657517">dur</span><span class="op" id="7657520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="7657523">close</span><span class="op" id="7657528">(</span><span class="ident" id="7657529">done</span><span class="op" id="7657533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7657536">&lt;-</span><span class="ident" id="7657538">finished</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7657548">&lt;-</span><span class="ident" id="7657550">finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7657560">//&nbsp;When&nbsp;run&nbsp;with&nbsp;&#39;go&nbsp;test&nbsp;-cpu=1,2,4&#39;&nbsp;SIGUSR1&nbsp;from&nbsp;this&nbsp;test&nbsp;can&nbsp;slip</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7657631">//&nbsp;into&nbsp;subsequent&nbsp;TestSignal()&nbsp;causing&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7657681">//&nbsp;Sleep&nbsp;for&nbsp;a&nbsp;while&nbsp;to&nbsp;reduce&nbsp;the&nbsp;possibility&nbsp;of&nbsp;the&nbsp;failure.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7657745">time</span><span class="op" id="7657749">.</span><span class="ident" id="7657750">Sleep</span><span class="op" id="7657755">(</span><span class="num" id="7657756">10</span>&nbsp;<span class="op" id="7657759">*</span>&nbsp;<span class="ident" id="7657761">time</span><span class="op" id="7657765">.</span><span class="ident" id="7657766">Millisecond</span><span class="op" id="7657777">)</span><br>
<span class="lineno">110</span><span class="op" id="7657779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7657782">var</span>&nbsp;<span class="ident" id="7657786">sendUncaughtSighup</span>&nbsp;<span class="op" id="7657805">=</span>&nbsp;<span class="ident" id="7657807">flag</span><span class="op" id="7657811">.</span><span class="ident" id="7657812">Int</span><span class="op" id="7657815">(</span><span class="string" id="7657816">&#34;send_uncaught_sighup&#34;</span><span class="op" id="7657838">,</span>&nbsp;<span class="num" id="7657840">0</span><span class="op" id="7657841">,</span>&nbsp;<span class="string" id="7657843">&#34;send&nbsp;uncaught&nbsp;SIGHUP&nbsp;during&nbsp;TestStop&#34;</span><span class="op" id="7657881">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7657884">//&nbsp;Test&nbsp;that&nbsp;Stop&nbsp;cancels&nbsp;the&nbsp;channel&#39;s&nbsp;registrations.</span><br>
<span class="lineno">115</span><span class="keyword" id="7657939">func</span>&nbsp;<span class="ident" id="7657944">TestStop</span><span class="op" id="7657952">(</span><span class="ident" id="7657953">t</span>&nbsp;<span class="op" id="7657955">*</span><span class="ident" id="7657956">testing</span><span class="op" id="7657963">.</span><span class="ident" id="7657964">T</span><span class="op" id="7657965">)</span>&nbsp;<span class="op" id="7657967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7657970">sigs</span>&nbsp;<span class="op" id="7657975">:=</span>&nbsp;<span class="op" id="7657978">[</span><span class="op" id="7657979">]</span><span class="ident" id="7657980">syscall</span><span class="op" id="7657987">.</span><span class="ident" id="7657988">Signal</span><span class="op" id="7657994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7657998">syscall</span><span class="op" id="7658005">.</span><span class="ident" id="7658006">SIGWINCH</span><span class="op" id="7658014">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7658018">syscall</span><span class="op" id="7658025">.</span><span class="ident" id="7658026">SIGHUP</span><span class="op" id="7658032">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7658035">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7658039">for</span>&nbsp;<span class="ident" id="7658043">_</span><span class="op" id="7658044">,</span>&nbsp;<span class="ident" id="7658046">sig</span>&nbsp;<span class="op" id="7658050">:=</span>&nbsp;<span class="keyword" id="7658053">range</span>&nbsp;<span class="ident" id="7658059">sigs</span>&nbsp;<span class="op" id="7658064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7658068">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7658090">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7658135">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7658206">if</span>&nbsp;<span class="ident" id="7658209">sig</span>&nbsp;<span class="op" id="7658213">!=</span>&nbsp;<span class="ident" id="7658216">syscall</span><span class="op" id="7658223">.</span><span class="ident" id="7658224">SIGHUP</span>&nbsp;<span class="op" id="7658231">||</span>&nbsp;<span class="op" id="7658234">*</span><span class="ident" id="7658235">sendUncaughtSighup</span>&nbsp;<span class="op" id="7658254">==</span>&nbsp;<span class="num" id="7658257">1</span>&nbsp;<span class="op" id="7658259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7658264">syscall</span><span class="op" id="7658271">.</span><span class="ident" id="7658272">Kill</span><span class="op" id="7658276">(</span><span class="ident" id="7658277">syscall</span><span class="op" id="7658284">.</span><span class="ident" id="7658285">Getpid</span><span class="op" id="7658291">(</span><span class="op" id="7658292">)</span><span class="op" id="7658293">,</span>&nbsp;<span class="ident" id="7658295">sig</span><span class="op" id="7658298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7658302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7658306">time</span><span class="op" id="7658310">.</span><span class="ident" id="7658311">Sleep</span><span class="op" id="7658316">(</span><span class="num" id="7658317">100</span>&nbsp;<span class="op" id="7658321">*</span>&nbsp;<span class="ident" id="7658323">time</span><span class="op" id="7658327">.</span><span class="ident" id="7658328">Millisecond</span><span class="op" id="7658339">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7658344">//&nbsp;Ask&nbsp;for&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7658364">c</span>&nbsp;<span class="op" id="7658366">:=</span>&nbsp;<span class="builtinfunc" id="7658369">make</span><span class="op" id="7658373">(</span><span class="keyword" id="7658374">chan</span>&nbsp;<span class="ident" id="7658379">os</span><span class="op" id="7658381">.</span><span class="ident" id="7658382">Signal</span><span class="op" id="7658388">,</span>&nbsp;<span class="num" id="7658390">1</span><span class="op" id="7658391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7658395">Notify</span><span class="op" id="7658401">(</span><span class="ident" id="7658402">c</span><span class="op" id="7658403">,</span>&nbsp;<span class="ident" id="7658405">sig</span><span class="op" id="7658408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7658412">defer</span>&nbsp;<span class="ident" id="7658418">Stop</span><span class="op" id="7658422">(</span><span class="ident" id="7658423">c</span><span class="op" id="7658424">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7658429">//&nbsp;Send&nbsp;this&nbsp;process&nbsp;that&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7658464">syscall</span><span class="op" id="7658471">.</span><span class="ident" id="7658472">Kill</span><span class="op" id="7658476">(</span><span class="ident" id="7658477">syscall</span><span class="op" id="7658484">.</span><span class="ident" id="7658485">Getpid</span><span class="op" id="7658491">(</span><span class="op" id="7658492">)</span><span class="op" id="7658493">,</span>&nbsp;<span class="ident" id="7658495">sig</span><span class="op" id="7658498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7658502">waitSig</span><span class="op" id="7658509">(</span><span class="ident" id="7658510">t</span><span class="op" id="7658511">,</span>&nbsp;<span class="ident" id="7658513">c</span><span class="op" id="7658514">,</span>&nbsp;<span class="ident" id="7658516">sig</span><span class="op" id="7658519">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7658524">Stop</span><span class="op" id="7658528">(</span><span class="ident" id="7658529">c</span><span class="op" id="7658530">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7658534">select</span>&nbsp;<span class="op" id="7658541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7658545">case</span>&nbsp;<span class="ident" id="7658550">s</span>&nbsp;<span class="op" id="7658552">:=</span>&nbsp;<span class="op" id="7658555">&lt;-</span><span class="ident" id="7658557">c</span><span class="op" id="7658558">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7658563">t</span><span class="op" id="7658564">.</span><span class="ident" id="7658565">Fatalf</span><span class="op" id="7658571">(</span><span class="string" id="7658572">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="7658594">,</span>&nbsp;<span class="ident" id="7658596">s</span><span class="op" id="7658597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7658601">case</span>&nbsp;<span class="op" id="7658606">&lt;-</span><span class="ident" id="7658608">time</span><span class="op" id="7658612">.</span><span class="ident" id="7658613">After</span><span class="op" id="7658618">(</span><span class="num" id="7658619">100</span>&nbsp;<span class="op" id="7658623">*</span>&nbsp;<span class="ident" id="7658625">time</span><span class="op" id="7658629">.</span><span class="ident" id="7658630">Millisecond</span><span class="op" id="7658641">)</span><span class="op" id="7658642">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7658647">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7658675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7658680">//&nbsp;Send&nbsp;the&nbsp;signal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7658702">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGWINCH,&nbsp;we&nbsp;should&nbsp;not&nbsp;see&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7658747">//&nbsp;If&nbsp;it&#39;s&nbsp;SIGHUP,&nbsp;maybe&nbsp;we&#39;ll&nbsp;die.&nbsp;Let&nbsp;the&nbsp;flag&nbsp;tell&nbsp;us&nbsp;what&nbsp;to&nbsp;do.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7658818">if</span>&nbsp;<span class="ident" id="7658821">sig</span>&nbsp;<span class="op" id="7658825">!=</span>&nbsp;<span class="ident" id="7658828">syscall</span><span class="op" id="7658835">.</span><span class="ident" id="7658836">SIGHUP</span>&nbsp;<span class="op" id="7658843">||</span>&nbsp;<span class="op" id="7658846">*</span><span class="ident" id="7658847">sendUncaughtSighup</span>&nbsp;<span class="op" id="7658866">==</span>&nbsp;<span class="num" id="7658869">2</span>&nbsp;<span class="op" id="7658871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7658876">syscall</span><span class="op" id="7658883">.</span><span class="ident" id="7658884">Kill</span><span class="op" id="7658888">(</span><span class="ident" id="7658889">syscall</span><span class="op" id="7658896">.</span><span class="ident" id="7658897">Getpid</span><span class="op" id="7658903">(</span><span class="op" id="7658904">)</span><span class="op" id="7658905">,</span>&nbsp;<span class="ident" id="7658907">sig</span><span class="op" id="7658910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7658914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7658919">select</span>&nbsp;<span class="op" id="7658926">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7658930">case</span>&nbsp;<span class="ident" id="7658935">s</span>&nbsp;<span class="op" id="7658937">:=</span>&nbsp;<span class="op" id="7658940">&lt;-</span><span class="ident" id="7658942">c</span><span class="op" id="7658943">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7658948">t</span><span class="op" id="7658949">.</span><span class="ident" id="7658950">Fatalf</span><span class="op" id="7658956">(</span><span class="string" id="7658957">&#34;unexpected&nbsp;signal&nbsp;%v&#34;</span><span class="op" id="7658979">,</span>&nbsp;<span class="ident" id="7658981">s</span><span class="op" id="7658982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7658986">case</span>&nbsp;<span class="op" id="7658991">&lt;-</span><span class="ident" id="7658993">time</span><span class="op" id="7658997">.</span><span class="ident" id="7658998">After</span><span class="op" id="7659003">(</span><span class="num" id="7659004">100</span>&nbsp;<span class="op" id="7659008">*</span>&nbsp;<span class="ident" id="7659010">time</span><span class="op" id="7659014">.</span><span class="ident" id="7659015">Millisecond</span><span class="op" id="7659026">)</span><span class="op" id="7659027">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7659032">//&nbsp;nothing&nbsp;to&nbsp;read&nbsp;-&nbsp;good</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7659060">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7659063">}</span><br>
<span class="lineno"></span><span class="op" id="7659065">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7659068">//&nbsp;Test&nbsp;that&nbsp;when&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;an&nbsp;uncaught&nbsp;SIGHUP&nbsp;does&nbsp;not&nbsp;kill&nbsp;the&nbsp;program,</span><br>
<span class="lineno"></span><span class="comment" id="7659149">//&nbsp;but&nbsp;a</span><br>
<span class="lineno">165</span><span class="keyword" id="7659158">func</span>&nbsp;<span class="ident" id="7659163">TestNohup</span><span class="op" id="7659172">(</span><span class="ident" id="7659173">t</span>&nbsp;<span class="op" id="7659175">*</span><span class="ident" id="7659176">testing</span><span class="op" id="7659183">.</span><span class="ident" id="7659184">T</span><span class="op" id="7659185">)</span>&nbsp;<span class="op" id="7659187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7659190">//&nbsp;Ugly:&nbsp;ask&nbsp;for&nbsp;SIGHUP&nbsp;so&nbsp;that&nbsp;child&nbsp;will&nbsp;not&nbsp;have&nbsp;no-hup&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7659254">//&nbsp;even&nbsp;if&nbsp;test&nbsp;is&nbsp;running&nbsp;under&nbsp;nohup&nbsp;environment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7659307">//&nbsp;We&nbsp;have&nbsp;no&nbsp;intention&nbsp;of&nbsp;reading&nbsp;from&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7659351">c</span>&nbsp;<span class="op" id="7659353">:=</span>&nbsp;<span class="builtinfunc" id="7659356">make</span><span class="op" id="7659360">(</span><span class="keyword" id="7659361">chan</span>&nbsp;<span class="ident" id="7659366">os</span><span class="op" id="7659368">.</span><span class="ident" id="7659369">Signal</span><span class="op" id="7659375">,</span>&nbsp;<span class="num" id="7659377">1</span><span class="op" id="7659378">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7659381">Notify</span><span class="op" id="7659387">(</span><span class="ident" id="7659388">c</span><span class="op" id="7659389">,</span>&nbsp;<span class="ident" id="7659391">syscall</span><span class="op" id="7659398">.</span><span class="ident" id="7659399">SIGHUP</span><span class="op" id="7659405">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7659409">//&nbsp;When&nbsp;run&nbsp;without&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;crash&nbsp;on&nbsp;an&nbsp;uncaught&nbsp;SIGHUP.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7659482">//&nbsp;When&nbsp;run&nbsp;under&nbsp;nohup,&nbsp;the&nbsp;test&nbsp;should&nbsp;ignore&nbsp;uncaught&nbsp;SIGHUPs,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7659549">//&nbsp;because&nbsp;the&nbsp;runtime&nbsp;is&nbsp;not&nbsp;supposed&nbsp;to&nbsp;be&nbsp;listening&nbsp;for&nbsp;them.</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7659615">//&nbsp;Either&nbsp;way,&nbsp;TestStop&nbsp;should&nbsp;still&nbsp;be&nbsp;able&nbsp;to&nbsp;catch&nbsp;them&nbsp;when&nbsp;it&nbsp;wants&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7659694">//&nbsp;and&nbsp;then&nbsp;when&nbsp;it&nbsp;stops&nbsp;wanting&nbsp;them,&nbsp;the&nbsp;original&nbsp;behavior&nbsp;should&nbsp;resume.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7659772">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7659776">//&nbsp;send_uncaught_sighup=1&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;before&nbsp;starting&nbsp;to&nbsp;listen&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7659859">//&nbsp;send_uncaught_sighup=2&nbsp;sends&nbsp;the&nbsp;SIGHUP&nbsp;after&nbsp;no&nbsp;longer&nbsp;listening&nbsp;for&nbsp;SIGHUPs.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7659942">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7659946">//&nbsp;Both&nbsp;should&nbsp;fail&nbsp;without&nbsp;nohup&nbsp;and&nbsp;succeed&nbsp;with&nbsp;nohup.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7660006">for</span>&nbsp;<span class="ident" id="7660010">i</span>&nbsp;<span class="op" id="7660012">:=</span>&nbsp;<span class="num" id="7660015">1</span><span class="op" id="7660016">;</span>&nbsp;<span class="ident" id="7660018">i</span>&nbsp;<span class="op" id="7660020">&lt;=</span>&nbsp;<span class="num" id="7660023">2</span><span class="op" id="7660024">;</span>&nbsp;<span class="ident" id="7660026">i</span><span class="op" id="7660027">++</span>&nbsp;<span class="op" id="7660030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7660034">out</span><span class="op" id="7660037">,</span>&nbsp;<span class="ident" id="7660039">err</span>&nbsp;<span class="op" id="7660043">:=</span>&nbsp;<span class="ident" id="7660046">exec</span><span class="op" id="7660050">.</span><span class="ident" id="7660051">Command</span><span class="op" id="7660058">(</span><span class="ident" id="7660059">os</span><span class="op" id="7660061">.</span><span class="ident" id="7660062">Args</span><span class="op" id="7660066">[</span><span class="num" id="7660067">0</span><span class="op" id="7660068">]</span><span class="op" id="7660069">,</span>&nbsp;<span class="string" id="7660071">&#34;-test.run=TestStop&#34;</span><span class="op" id="7660091">,</span>&nbsp;<span class="string" id="7660093">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="7660117">+</span><span class="ident" id="7660118">strconv</span><span class="op" id="7660125">.</span><span class="ident" id="7660126">Itoa</span><span class="op" id="7660130">(</span><span class="ident" id="7660131">i</span><span class="op" id="7660132">)</span><span class="op" id="7660133">)</span><span class="op" id="7660134">.</span><span class="ident" id="7660135">CombinedOutput</span><span class="op" id="7660149">(</span><span class="op" id="7660150">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7660154">if</span>&nbsp;<span class="ident" id="7660157">err</span>&nbsp;<span class="op" id="7660161">==</span>&nbsp;<span class="builtintype" id="7660164">nil</span>&nbsp;<span class="op" id="7660168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7660173">t</span><span class="op" id="7660174">.</span><span class="ident" id="7660175">Fatalf</span><span class="op" id="7660181">(</span><span class="string" id="7660182">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;and&nbsp;it&nbsp;succeeded:&nbsp;expected&nbsp;failure.\nOutput:\n%s&#34;</span><span class="op" id="7660271">,</span>&nbsp;<span class="ident" id="7660273">i</span><span class="op" id="7660274">,</span>&nbsp;<span class="ident" id="7660276">out</span><span class="op" id="7660279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7660283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7660286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7660290">Stop</span><span class="op" id="7660294">(</span><span class="ident" id="7660295">c</span><span class="op" id="7660296">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7660300">//&nbsp;Again,&nbsp;this&nbsp;time&nbsp;with&nbsp;nohup,&nbsp;assuming&nbsp;we&nbsp;can&nbsp;find&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7660358">_</span><span class="op" id="7660359">,</span>&nbsp;<span class="ident" id="7660361">err</span>&nbsp;<span class="op" id="7660365">:=</span>&nbsp;<span class="ident" id="7660368">os</span><span class="op" id="7660370">.</span><span class="ident" id="7660371">Stat</span><span class="op" id="7660375">(</span><span class="string" id="7660376">&#34;/usr/bin/nohup&#34;</span><span class="op" id="7660392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7660395">if</span>&nbsp;<span class="ident" id="7660398">err</span>&nbsp;<span class="op" id="7660402">!=</span>&nbsp;<span class="builtintype" id="7660405">nil</span>&nbsp;<span class="op" id="7660409">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7660413">t</span><span class="op" id="7660414">.</span><span class="ident" id="7660415">Skip</span><span class="op" id="7660419">(</span><span class="string" id="7660420">&#34;cannot&nbsp;find&nbsp;nohup;&nbsp;skipping&nbsp;second&nbsp;half&nbsp;of&nbsp;test&#34;</span><span class="op" id="7660469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7660472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7660476">for</span>&nbsp;<span class="ident" id="7660480">i</span>&nbsp;<span class="op" id="7660482">:=</span>&nbsp;<span class="num" id="7660485">1</span><span class="op" id="7660486">;</span>&nbsp;<span class="ident" id="7660488">i</span>&nbsp;<span class="op" id="7660490">&lt;=</span>&nbsp;<span class="num" id="7660493">2</span><span class="op" id="7660494">;</span>&nbsp;<span class="ident" id="7660496">i</span><span class="op" id="7660497">++</span>&nbsp;<span class="op" id="7660500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7660504">os</span><span class="op" id="7660506">.</span><span class="ident" id="7660507">Remove</span><span class="op" id="7660513">(</span><span class="string" id="7660514">&#34;nohup.out&#34;</span><span class="op" id="7660525">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7660529">out</span><span class="op" id="7660532">,</span>&nbsp;<span class="ident" id="7660534">err</span>&nbsp;<span class="op" id="7660538">:=</span>&nbsp;<span class="ident" id="7660541">exec</span><span class="op" id="7660545">.</span><span class="ident" id="7660546">Command</span><span class="op" id="7660553">(</span><span class="string" id="7660554">&#34;/usr/bin/nohup&#34;</span><span class="op" id="7660570">,</span>&nbsp;<span class="ident" id="7660572">os</span><span class="op" id="7660574">.</span><span class="ident" id="7660575">Args</span><span class="op" id="7660579">[</span><span class="num" id="7660580">0</span><span class="op" id="7660581">]</span><span class="op" id="7660582">,</span>&nbsp;<span class="string" id="7660584">&#34;-test.run=TestStop&#34;</span><span class="op" id="7660604">,</span>&nbsp;<span class="string" id="7660606">&#34;-send_uncaught_sighup=&#34;</span><span class="op" id="7660630">+</span><span class="ident" id="7660631">strconv</span><span class="op" id="7660638">.</span><span class="ident" id="7660639">Itoa</span><span class="op" id="7660643">(</span><span class="ident" id="7660644">i</span><span class="op" id="7660645">)</span><span class="op" id="7660646">)</span><span class="op" id="7660647">.</span><span class="ident" id="7660648">CombinedOutput</span><span class="op" id="7660662">(</span><span class="op" id="7660663">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7660668">data</span><span class="op" id="7660672">,</span>&nbsp;<span class="ident" id="7660674">_</span>&nbsp;<span class="op" id="7660676">:=</span>&nbsp;<span class="ident" id="7660679">ioutil</span><span class="op" id="7660685">.</span><span class="ident" id="7660686">ReadFile</span><span class="op" id="7660694">(</span><span class="string" id="7660695">&#34;nohup.out&#34;</span><span class="op" id="7660706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7660710">os</span><span class="op" id="7660712">.</span><span class="ident" id="7660713">Remove</span><span class="op" id="7660719">(</span><span class="string" id="7660720">&#34;nohup.out&#34;</span><span class="op" id="7660731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7660735">if</span>&nbsp;<span class="ident" id="7660738">err</span>&nbsp;<span class="op" id="7660742">!=</span>&nbsp;<span class="builtintype" id="7660745">nil</span>&nbsp;<span class="op" id="7660749">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7660754">t</span><span class="op" id="7660755">.</span><span class="ident" id="7660756">Fatalf</span><span class="op" id="7660762">(</span><span class="string" id="7660763">&#34;ran&nbsp;test&nbsp;with&nbsp;-send_uncaught_sighup=%d&nbsp;under&nbsp;nohup&nbsp;and&nbsp;it&nbsp;failed:&nbsp;expected&nbsp;success.\nError:&nbsp;%v\nOutput:\n%s%s&#34;</span><span class="op" id="7660874">,</span>&nbsp;<span class="ident" id="7660876">i</span><span class="op" id="7660877">,</span>&nbsp;<span class="ident" id="7660879">err</span><span class="op" id="7660882">,</span>&nbsp;<span class="ident" id="7660884">out</span><span class="op" id="7660887">,</span>&nbsp;<span class="ident" id="7660889">data</span><span class="op" id="7660893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7660897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7660900">}</span><br>
<span class="lineno"></span><span class="op" id="7660902">}</span>
</div>
</body>
</html>
