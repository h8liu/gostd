<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>syscall</h2>
<ul>
<li><a href="/gostd/syscall/creds_test.go.html">creds_test.go</a></li>
<li><a href="/gostd/syscall/env_unix.go.html">env_unix.go</a></li>
<li><a href="/gostd/syscall/exec_linux.go.html" class="current">exec_linux.go</a></li>
<li><a href="/gostd/syscall/exec_unix.go.html">exec_unix.go</a></li>
<li><a href="/gostd/syscall/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/syscall/flock.go.html">flock.go</a></li>
<li><a href="/gostd/syscall/lsf_linux.go.html">lsf_linux.go</a></li>
<li><a href="/gostd/syscall/mmap_unix_test.go.html">mmap_unix_test.go</a></li>
<li><a href="/gostd/syscall/netlink_linux.go.html">netlink_linux.go</a></li>
<li><a href="/gostd/syscall/race0.go.html">race0.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_linux.go.html">sockcmsg_linux.go</a></li>
<li><a href="/gostd/syscall/sockcmsg_unix.go.html">sockcmsg_unix.go</a></li>
<li><a href="/gostd/syscall/str.go.html">str.go</a></li>
<li><a href="/gostd/syscall/syscall.go.html">syscall.go</a></li>
<li><a href="/gostd/syscall/syscall_linux.go.html">syscall_linux.go</a></li>
<li><a href="/gostd/syscall/syscall_linux_amd64.go.html">syscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/syscall_test.go.html">syscall_test.go</a></li>
<li><a href="/gostd/syscall/syscall_unix.go.html">syscall_unix.go</a></li>
<li><a href="/gostd/syscall/syscall_unix_test.go.html">syscall_unix_test.go</a></li>
<li><a href="/gostd/syscall/zerrors_linux_amd64.go.html">zerrors_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsyscall_linux_amd64.go.html">zsyscall_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/zsysnum_linux_amd64.go.html">zsysnum_linux_amd64.go</a></li>
<li><a href="/gostd/syscall/ztypes_linux_amd64.go.html">ztypes_linux_amd64.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2373253">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2373308">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2373362">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2373413">//&nbsp;+build&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2373430">package</span>&nbsp;<span class="ident" id="2373438">syscall</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2373447">import</span>&nbsp;<span class="op" id="2373454">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2373457">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="2373466">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2373469">//&nbsp;SysProcIDMap&nbsp;holds&nbsp;Container&nbsp;ID&nbsp;to&nbsp;Host&nbsp;ID&nbsp;mappings&nbsp;used&nbsp;for&nbsp;User&nbsp;Namespaces&nbsp;in&nbsp;Linux.</span><br>
<span class="lineno"></span><span class="comment" id="2373559">//&nbsp;See&nbsp;user_namespaces(7).</span><br>
<span class="lineno">15</span><span class="keyword" id="2373586">type</span>&nbsp;<span class="ident" id="2373591">SysProcIDMap</span>&nbsp;<span class="keyword" id="2373604">struct</span>&nbsp;<span class="op" id="2373611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2373614">ContainerID</span>&nbsp;<span class="builtintype" id="2373626">int</span>&nbsp;<span class="comment" id="2373630">//&nbsp;Container&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2373648">HostID</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2373660">int</span>&nbsp;<span class="comment" id="2373664">//&nbsp;Host&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2373677">Size</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2373689">int</span>&nbsp;<span class="comment" id="2373693">//&nbsp;Size.</span><br>
<span class="lineno"></span><span class="op" id="2373702">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="2373705">type</span>&nbsp;<span class="ident" id="2373710">SysProcAttr</span>&nbsp;<span class="keyword" id="2373722">struct</span>&nbsp;<span class="op" id="2373729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2373732">Chroot</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2373744">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2373759">//&nbsp;Chroot.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2373771">Credential</span>&nbsp;&nbsp;<span class="op" id="2373783">*</span><span class="ident" id="2373784">Credential</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2373798">//&nbsp;Credential.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2373814">Ptrace</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2373826">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2373841">//&nbsp;Enable&nbsp;tracing.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2373861">Setsid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2373873">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2373888">//&nbsp;Create&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2373908">Setpgid</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2373920">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2373935">//&nbsp;Set&nbsp;process&nbsp;group&nbsp;ID&nbsp;to&nbsp;new&nbsp;pid&nbsp;(SYSV&nbsp;setpgrp)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2373986">Setctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2373998">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2374013">//&nbsp;Set&nbsp;controlling&nbsp;terminal&nbsp;to&nbsp;fd&nbsp;Ctty&nbsp;(only&nbsp;meaningful&nbsp;if&nbsp;Setsid&nbsp;is&nbsp;set)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2374088">Noctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2374100">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2374115">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;controlling&nbsp;terminal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2374157">Ctty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2374169">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2374184">//&nbsp;Controlling&nbsp;TTY&nbsp;fd&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2374220">Pdeathsig</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2374232">Signal</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2374247">//&nbsp;Signal&nbsp;that&nbsp;the&nbsp;process&nbsp;will&nbsp;get&nbsp;when&nbsp;its&nbsp;parent&nbsp;dies&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2374318">Cloneflags</span>&nbsp;&nbsp;<span class="builtintype" id="2374330">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2374345">//&nbsp;Flags&nbsp;for&nbsp;clone&nbsp;calls&nbsp;(Linux&nbsp;only)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2374384">UidMappings</span>&nbsp;<span class="op" id="2374396">[</span><span class="op" id="2374397">]</span><span class="ident" id="2374398">SysProcIDMap</span>&nbsp;<span class="comment" id="2374411">//&nbsp;User&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2374453">GidMappings</span>&nbsp;<span class="op" id="2374465">[</span><span class="op" id="2374466">]</span><span class="ident" id="2374467">SysProcIDMap</span>&nbsp;<span class="comment" id="2374480">//&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces.</span><br>
<span class="lineno"></span><span class="op" id="2374522">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="2374525">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="2374560">func</span>&nbsp;<span class="ident" id="2374565">runtime_BeforeFork</span><span class="op" id="2374583">(</span><span class="op" id="2374584">)</span><br>
<span class="lineno"></span><span class="keyword" id="2374586">func</span>&nbsp;<span class="ident" id="2374591">runtime_AfterFork</span><span class="op" id="2374608">(</span><span class="op" id="2374609">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="2374612">//&nbsp;Fork,&nbsp;dup&nbsp;fd&nbsp;onto&nbsp;0..len(fd),&nbsp;and&nbsp;exec(argv0,&nbsp;argvv,&nbsp;envv)&nbsp;in&nbsp;child.</span><br>
<span class="lineno"></span><span class="comment" id="2374684">//&nbsp;If&nbsp;a&nbsp;dup&nbsp;or&nbsp;exec&nbsp;fails,&nbsp;write&nbsp;the&nbsp;errno&nbsp;error&nbsp;to&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="comment" id="2374742">//&nbsp;(Pipe&nbsp;is&nbsp;close-on-exec&nbsp;so&nbsp;if&nbsp;exec&nbsp;succeeds,&nbsp;it&nbsp;will&nbsp;be&nbsp;closed.)</span><br>
<span class="lineno"></span><span class="comment" id="2374809">//&nbsp;In&nbsp;the&nbsp;child,&nbsp;this&nbsp;function&nbsp;must&nbsp;not&nbsp;acquire&nbsp;any&nbsp;locks,&nbsp;because</span><br>
<span class="lineno"></span><span class="comment" id="2374876">//&nbsp;they&nbsp;might&nbsp;have&nbsp;been&nbsp;locked&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;the&nbsp;fork.&nbsp;&nbsp;This&nbsp;means</span><br>
<span class="lineno">45</span><span class="comment" id="2374944">//&nbsp;no&nbsp;rescheduling,&nbsp;no&nbsp;malloc&nbsp;calls,&nbsp;and&nbsp;no&nbsp;new&nbsp;stack&nbsp;segments.</span><br>
<span class="lineno"></span><span class="comment" id="2375008">//&nbsp;For&nbsp;the&nbsp;same&nbsp;reason&nbsp;compiler&nbsp;does&nbsp;not&nbsp;race&nbsp;instrument&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="2375069">//&nbsp;The&nbsp;calls&nbsp;to&nbsp;RawSyscall&nbsp;are&nbsp;okay&nbsp;because&nbsp;they&nbsp;are&nbsp;assembly</span><br>
<span class="lineno"></span><span class="comment" id="2375131">//&nbsp;functions&nbsp;that&nbsp;do&nbsp;not&nbsp;grow&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="2375172">func</span>&nbsp;<span class="ident" id="2375177">forkAndExecInChild</span><span class="op" id="2375195">(</span><span class="ident" id="2375196">argv0</span>&nbsp;<span class="op" id="2375202">*</span><span class="builtintype" id="2375203">byte</span><span class="op" id="2375207">,</span>&nbsp;<span class="ident" id="2375209">argv</span><span class="op" id="2375213">,</span>&nbsp;<span class="ident" id="2375215">envv</span>&nbsp;<span class="op" id="2375220">[</span><span class="op" id="2375221">]</span><span class="op" id="2375222">*</span><span class="builtintype" id="2375223">byte</span><span class="op" id="2375227">,</span>&nbsp;<span class="ident" id="2375229">chroot</span><span class="op" id="2375235">,</span>&nbsp;<span class="ident" id="2375237">dir</span>&nbsp;<span class="op" id="2375241">*</span><span class="builtintype" id="2375242">byte</span><span class="op" id="2375246">,</span>&nbsp;<span class="ident" id="2375248">attr</span>&nbsp;<span class="op" id="2375253">*</span><span class="ident" id="2375254">ProcAttr</span><span class="op" id="2375262">,</span>&nbsp;<span class="ident" id="2375264">sys</span>&nbsp;<span class="op" id="2375268">*</span><span class="ident" id="2375269">SysProcAttr</span><span class="op" id="2375280">,</span>&nbsp;<span class="ident" id="2375282">pipe</span>&nbsp;<span class="builtintype" id="2375287">int</span><span class="op" id="2375290">)</span>&nbsp;<span class="op" id="2375292">(</span><span class="ident" id="2375293">pid</span>&nbsp;<span class="builtintype" id="2375297">int</span><span class="op" id="2375300">,</span>&nbsp;<span class="ident" id="2375302">err</span>&nbsp;<span class="ident" id="2375306">Errno</span><span class="op" id="2375311">)</span>&nbsp;<span class="op" id="2375313">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2375316">//&nbsp;Declare&nbsp;all&nbsp;variables&nbsp;at&nbsp;top&nbsp;in&nbsp;case&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2375361">//&nbsp;declarations&nbsp;require&nbsp;heap&nbsp;allocation&nbsp;(e.g.,&nbsp;err1).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2375416">var</span>&nbsp;<span class="op" id="2375420">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2375424">r1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2375431">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2375441">err1</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2375448">Errno</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2375456">err2</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="2375463">Errno</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2375471">nextfd</span>&nbsp;<span class="builtintype" id="2375478">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2375484">i</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2375491">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2375497">p</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2375504">[</span><span class="num" id="2375505">2</span><span class="op" id="2375506">]</span><span class="builtintype" id="2375507">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2375512">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2375516">//&nbsp;Guard&nbsp;against&nbsp;side&nbsp;effects&nbsp;of&nbsp;shuffling&nbsp;fds&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2375571">//&nbsp;Make&nbsp;sure&nbsp;that&nbsp;nextfd&nbsp;is&nbsp;beyond&nbsp;any&nbsp;currently&nbsp;open&nbsp;files&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2375635">//&nbsp;that&nbsp;we&nbsp;can&#39;t&nbsp;run&nbsp;the&nbsp;risk&nbsp;of&nbsp;overwriting&nbsp;any&nbsp;of&nbsp;them.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2375694">fd</span>&nbsp;<span class="op" id="2375697">:=</span>&nbsp;<span class="builtinfunc" id="2375700">make</span><span class="op" id="2375704">(</span><span class="op" id="2375705">[</span><span class="op" id="2375706">]</span><span class="builtintype" id="2375707">int</span><span class="op" id="2375710">,</span>&nbsp;<span class="builtinfunc" id="2375712">len</span><span class="op" id="2375715">(</span><span class="ident" id="2375716">attr</span><span class="op" id="2375720">.</span><span class="ident" id="2375721">Files</span><span class="op" id="2375726">)</span><span class="op" id="2375727">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2375730">nextfd</span>&nbsp;<span class="op" id="2375737">=</span>&nbsp;<span class="builtinfunc" id="2375739">len</span><span class="op" id="2375742">(</span><span class="ident" id="2375743">attr</span><span class="op" id="2375747">.</span><span class="ident" id="2375748">Files</span><span class="op" id="2375753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2375756">for</span>&nbsp;<span class="ident" id="2375760">i</span><span class="op" id="2375761">,</span>&nbsp;<span class="ident" id="2375763">ufd</span>&nbsp;<span class="op" id="2375767">:=</span>&nbsp;<span class="keyword" id="2375770">range</span>&nbsp;<span class="ident" id="2375776">attr</span><span class="op" id="2375780">.</span><span class="ident" id="2375781">Files</span>&nbsp;<span class="op" id="2375787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2375791">if</span>&nbsp;<span class="ident" id="2375794">nextfd</span>&nbsp;<span class="op" id="2375801">&lt;</span>&nbsp;<span class="builtintype" id="2375803">int</span><span class="op" id="2375806">(</span><span class="ident" id="2375807">ufd</span><span class="op" id="2375810">)</span>&nbsp;<span class="op" id="2375812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2375817">nextfd</span>&nbsp;<span class="op" id="2375824">=</span>&nbsp;<span class="builtintype" id="2375826">int</span><span class="op" id="2375829">(</span><span class="ident" id="2375830">ufd</span><span class="op" id="2375833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2375837">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2375841">fd</span><span class="op" id="2375843">[</span><span class="ident" id="2375844">i</span><span class="op" id="2375845">]</span>&nbsp;<span class="op" id="2375847">=</span>&nbsp;<span class="builtintype" id="2375849">int</span><span class="op" id="2375852">(</span><span class="ident" id="2375853">ufd</span><span class="op" id="2375856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2375859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2375862">nextfd</span><span class="op" id="2375868">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2375873">//&nbsp;Allocate&nbsp;another&nbsp;pipe&nbsp;for&nbsp;parent&nbsp;to&nbsp;child&nbsp;communication&nbsp;for</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2375937">//&nbsp;synchronizing&nbsp;writing&nbsp;of&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2375993">if</span>&nbsp;<span class="ident" id="2375996">sys</span><span class="op" id="2375999">.</span><span class="ident" id="2376000">UidMappings</span>&nbsp;<span class="op" id="2376012">!=</span>&nbsp;<span class="builtintype" id="2376015">nil</span>&nbsp;<span class="op" id="2376019">||</span>&nbsp;<span class="ident" id="2376022">sys</span><span class="op" id="2376025">.</span><span class="ident" id="2376026">GidMappings</span>&nbsp;<span class="op" id="2376038">!=</span>&nbsp;<span class="builtintype" id="2376041">nil</span>&nbsp;<span class="op" id="2376045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2376049">if</span>&nbsp;<span class="ident" id="2376052">err</span>&nbsp;<span class="op" id="2376056">:=</span>&nbsp;<span class="ident" id="2376059">forkExecPipe</span><span class="op" id="2376071">(</span><span class="ident" id="2376072">p</span><span class="op" id="2376073">[</span><span class="op" id="2376074">:</span><span class="op" id="2376075">]</span><span class="op" id="2376076">)</span><span class="op" id="2376077">;</span>&nbsp;<span class="ident" id="2376079">err</span>&nbsp;<span class="op" id="2376083">!=</span>&nbsp;<span class="builtintype" id="2376086">nil</span>&nbsp;<span class="op" id="2376090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2376095">return</span>&nbsp;<span class="num" id="2376102">0</span><span class="op" id="2376103">,</span>&nbsp;<span class="ident" id="2376105">err</span><span class="op" id="2376108">.</span><span class="op" id="2376109">(</span><span class="ident" id="2376110">Errno</span><span class="op" id="2376115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2376119">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2376122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2376126">//&nbsp;About&nbsp;to&nbsp;call&nbsp;fork.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2376150">//&nbsp;No&nbsp;more&nbsp;allocation&nbsp;or&nbsp;calls&nbsp;of&nbsp;non-assembly&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2376209">runtime_BeforeFork</span><span class="op" id="2376227">(</span><span class="op" id="2376228">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2376231">r1</span><span class="op" id="2376233">,</span>&nbsp;<span class="ident" id="2376235">_</span><span class="op" id="2376236">,</span>&nbsp;<span class="ident" id="2376238">err1</span>&nbsp;<span class="op" id="2376243">=</span>&nbsp;<span class="ident" id="2376245">RawSyscall6</span><span class="op" id="2376256">(</span><span class="ident" id="2376257">SYS_CLONE</span><span class="op" id="2376266">,</span>&nbsp;<span class="builtintype" id="2376268">uintptr</span><span class="op" id="2376275">(</span><span class="ident" id="2376276">SIGCHLD</span><span class="op" id="2376283">)</span><span class="op" id="2376284">|</span><span class="ident" id="2376285">sys</span><span class="op" id="2376288">.</span><span class="ident" id="2376289">Cloneflags</span><span class="op" id="2376299">,</span>&nbsp;<span class="num" id="2376301">0</span><span class="op" id="2376302">,</span>&nbsp;<span class="num" id="2376304">0</span><span class="op" id="2376305">,</span>&nbsp;<span class="num" id="2376307">0</span><span class="op" id="2376308">,</span>&nbsp;<span class="num" id="2376310">0</span><span class="op" id="2376311">,</span>&nbsp;<span class="num" id="2376313">0</span><span class="op" id="2376314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2376317">if</span>&nbsp;<span class="ident" id="2376320">err1</span>&nbsp;<span class="op" id="2376325">!=</span>&nbsp;<span class="num" id="2376328">0</span>&nbsp;<span class="op" id="2376330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2376334">runtime_AfterFork</span><span class="op" id="2376351">(</span><span class="op" id="2376352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2376356">return</span>&nbsp;<span class="num" id="2376363">0</span><span class="op" id="2376364">,</span>&nbsp;<span class="ident" id="2376366">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2376372">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2376376">if</span>&nbsp;<span class="ident" id="2376379">r1</span>&nbsp;<span class="op" id="2376382">!=</span>&nbsp;<span class="num" id="2376385">0</span>&nbsp;<span class="op" id="2376387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2376391">//&nbsp;parent;&nbsp;return&nbsp;PID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2376415">runtime_AfterFork</span><span class="op" id="2376432">(</span><span class="op" id="2376433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2376437">pid</span>&nbsp;<span class="op" id="2376441">=</span>&nbsp;<span class="builtintype" id="2376443">int</span><span class="op" id="2376446">(</span><span class="ident" id="2376447">r1</span><span class="op" id="2376449">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2376454">if</span>&nbsp;<span class="ident" id="2376457">sys</span><span class="op" id="2376460">.</span><span class="ident" id="2376461">UidMappings</span>&nbsp;<span class="op" id="2376473">!=</span>&nbsp;<span class="builtintype" id="2376476">nil</span>&nbsp;<span class="op" id="2376480">||</span>&nbsp;<span class="ident" id="2376483">sys</span><span class="op" id="2376486">.</span><span class="ident" id="2376487">GidMappings</span>&nbsp;<span class="op" id="2376499">!=</span>&nbsp;<span class="builtintype" id="2376502">nil</span>&nbsp;<span class="op" id="2376506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2376511">Close</span><span class="op" id="2376516">(</span><span class="ident" id="2376517">p</span><span class="op" id="2376518">[</span><span class="num" id="2376519">0</span><span class="op" id="2376520">]</span><span class="op" id="2376521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2376526">err</span>&nbsp;<span class="op" id="2376530">:=</span>&nbsp;<span class="ident" id="2376533">writeUidGidMappings</span><span class="op" id="2376552">(</span><span class="ident" id="2376553">pid</span><span class="op" id="2376556">,</span>&nbsp;<span class="ident" id="2376558">sys</span><span class="op" id="2376561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2376566">if</span>&nbsp;<span class="ident" id="2376569">err</span>&nbsp;<span class="op" id="2376573">!=</span>&nbsp;<span class="builtintype" id="2376576">nil</span>&nbsp;<span class="op" id="2376580">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2376586">err2</span>&nbsp;<span class="op" id="2376591">=</span>&nbsp;<span class="ident" id="2376593">err</span><span class="op" id="2376596">.</span><span class="op" id="2376597">(</span><span class="ident" id="2376598">Errno</span><span class="op" id="2376603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2376608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2376613">RawSyscall</span><span class="op" id="2376623">(</span><span class="ident" id="2376624">SYS_WRITE</span><span class="op" id="2376633">,</span>&nbsp;<span class="builtintype" id="2376635">uintptr</span><span class="op" id="2376642">(</span><span class="ident" id="2376643">p</span><span class="op" id="2376644">[</span><span class="num" id="2376645">1</span><span class="op" id="2376646">]</span><span class="op" id="2376647">)</span><span class="op" id="2376648">,</span>&nbsp;<span class="builtintype" id="2376650">uintptr</span><span class="op" id="2376657">(</span><span class="ident" id="2376658">unsafe</span><span class="op" id="2376664">.</span><span class="ident" id="2376665">Pointer</span><span class="op" id="2376672">(</span><span class="op" id="2376673">&amp;</span><span class="ident" id="2376674">err2</span><span class="op" id="2376678">)</span><span class="op" id="2376679">)</span><span class="op" id="2376680">,</span>&nbsp;<span class="ident" id="2376682">unsafe</span><span class="op" id="2376688">.</span><span class="ident" id="2376689">Sizeof</span><span class="op" id="2376695">(</span><span class="ident" id="2376696">err2</span><span class="op" id="2376700">)</span><span class="op" id="2376701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2376706">Close</span><span class="op" id="2376711">(</span><span class="ident" id="2376712">p</span><span class="op" id="2376713">[</span><span class="num" id="2376714">1</span><span class="op" id="2376715">]</span><span class="op" id="2376716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2376720">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2376725">return</span>&nbsp;<span class="ident" id="2376732">pid</span><span class="op" id="2376735">,</span>&nbsp;<span class="num" id="2376737">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2376740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2376744">//&nbsp;Fork&nbsp;succeeded,&nbsp;now&nbsp;in&nbsp;child.</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2376779">//&nbsp;Wait&nbsp;for&nbsp;User&nbsp;ID/Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;be&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2376833">if</span>&nbsp;<span class="ident" id="2376836">sys</span><span class="op" id="2376839">.</span><span class="ident" id="2376840">UidMappings</span>&nbsp;<span class="op" id="2376852">!=</span>&nbsp;<span class="builtintype" id="2376855">nil</span>&nbsp;<span class="op" id="2376859">||</span>&nbsp;<span class="ident" id="2376862">sys</span><span class="op" id="2376865">.</span><span class="ident" id="2376866">GidMappings</span>&nbsp;<span class="op" id="2376878">!=</span>&nbsp;<span class="builtintype" id="2376881">nil</span>&nbsp;<span class="op" id="2376885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2376889">if</span>&nbsp;<span class="ident" id="2376892">_</span><span class="op" id="2376893">,</span>&nbsp;<span class="ident" id="2376895">_</span><span class="op" id="2376896">,</span>&nbsp;<span class="ident" id="2376898">err1</span>&nbsp;<span class="op" id="2376903">=</span>&nbsp;<span class="ident" id="2376905">RawSyscall</span><span class="op" id="2376915">(</span><span class="ident" id="2376916">SYS_CLOSE</span><span class="op" id="2376925">,</span>&nbsp;<span class="builtintype" id="2376927">uintptr</span><span class="op" id="2376934">(</span><span class="ident" id="2376935">p</span><span class="op" id="2376936">[</span><span class="num" id="2376937">1</span><span class="op" id="2376938">]</span><span class="op" id="2376939">)</span><span class="op" id="2376940">,</span>&nbsp;<span class="num" id="2376942">0</span><span class="op" id="2376943">,</span>&nbsp;<span class="num" id="2376945">0</span><span class="op" id="2376946">)</span><span class="op" id="2376947">;</span>&nbsp;<span class="ident" id="2376949">err1</span>&nbsp;<span class="op" id="2376954">!=</span>&nbsp;<span class="num" id="2376957">0</span>&nbsp;<span class="op" id="2376959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2376964">goto</span>&nbsp;<span class="ident" id="2376969">childerror</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2376982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2376986">r1</span><span class="op" id="2376988">,</span>&nbsp;<span class="ident" id="2376990">_</span><span class="op" id="2376991">,</span>&nbsp;<span class="ident" id="2376993">err1</span>&nbsp;<span class="op" id="2376998">=</span>&nbsp;<span class="ident" id="2377000">RawSyscall</span><span class="op" id="2377010">(</span><span class="ident" id="2377011">SYS_READ</span><span class="op" id="2377019">,</span>&nbsp;<span class="builtintype" id="2377021">uintptr</span><span class="op" id="2377028">(</span><span class="ident" id="2377029">p</span><span class="op" id="2377030">[</span><span class="num" id="2377031">0</span><span class="op" id="2377032">]</span><span class="op" id="2377033">)</span><span class="op" id="2377034">,</span>&nbsp;<span class="builtintype" id="2377036">uintptr</span><span class="op" id="2377043">(</span><span class="ident" id="2377044">unsafe</span><span class="op" id="2377050">.</span><span class="ident" id="2377051">Pointer</span><span class="op" id="2377058">(</span><span class="op" id="2377059">&amp;</span><span class="ident" id="2377060">err2</span><span class="op" id="2377064">)</span><span class="op" id="2377065">)</span><span class="op" id="2377066">,</span>&nbsp;<span class="ident" id="2377068">unsafe</span><span class="op" id="2377074">.</span><span class="ident" id="2377075">Sizeof</span><span class="op" id="2377081">(</span><span class="ident" id="2377082">err2</span><span class="op" id="2377086">)</span><span class="op" id="2377087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2377091">if</span>&nbsp;<span class="ident" id="2377094">err1</span>&nbsp;<span class="op" id="2377099">!=</span>&nbsp;<span class="num" id="2377102">0</span>&nbsp;<span class="op" id="2377104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2377109">goto</span>&nbsp;<span class="ident" id="2377114">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2377127">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2377131">if</span>&nbsp;<span class="ident" id="2377134">r1</span>&nbsp;<span class="op" id="2377137">!=</span>&nbsp;<span class="ident" id="2377140">unsafe</span><span class="op" id="2377146">.</span><span class="ident" id="2377147">Sizeof</span><span class="op" id="2377153">(</span><span class="ident" id="2377154">err2</span><span class="op" id="2377158">)</span>&nbsp;<span class="op" id="2377160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2377165">err1</span>&nbsp;<span class="op" id="2377170">=</span>&nbsp;<span class="ident" id="2377172">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2377182">goto</span>&nbsp;<span class="ident" id="2377187">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2377200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2377204">if</span>&nbsp;<span class="ident" id="2377207">err2</span>&nbsp;<span class="op" id="2377212">!=</span>&nbsp;<span class="num" id="2377215">0</span>&nbsp;<span class="op" id="2377217">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2377222">err1</span>&nbsp;<span class="op" id="2377227">=</span>&nbsp;<span class="ident" id="2377229">err2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2377237">goto</span>&nbsp;<span class="ident" id="2377242">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2377255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2377258">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2377262">//&nbsp;Parent&nbsp;death&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2377286">if</span>&nbsp;<span class="ident" id="2377289">sys</span><span class="op" id="2377292">.</span><span class="ident" id="2377293">Pdeathsig</span>&nbsp;<span class="op" id="2377303">!=</span>&nbsp;<span class="num" id="2377306">0</span>&nbsp;<span class="op" id="2377308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2377312">_</span><span class="op" id="2377313">,</span>&nbsp;<span class="ident" id="2377315">_</span><span class="op" id="2377316">,</span>&nbsp;<span class="ident" id="2377318">err1</span>&nbsp;<span class="op" id="2377323">=</span>&nbsp;<span class="ident" id="2377325">RawSyscall6</span><span class="op" id="2377336">(</span><span class="ident" id="2377337">SYS_PRCTL</span><span class="op" id="2377346">,</span>&nbsp;<span class="ident" id="2377348">PR_SET_PDEATHSIG</span><span class="op" id="2377364">,</span>&nbsp;<span class="builtintype" id="2377366">uintptr</span><span class="op" id="2377373">(</span><span class="ident" id="2377374">sys</span><span class="op" id="2377377">.</span><span class="ident" id="2377378">Pdeathsig</span><span class="op" id="2377387">)</span><span class="op" id="2377388">,</span>&nbsp;<span class="num" id="2377390">0</span><span class="op" id="2377391">,</span>&nbsp;<span class="num" id="2377393">0</span><span class="op" id="2377394">,</span>&nbsp;<span class="num" id="2377396">0</span><span class="op" id="2377397">,</span>&nbsp;<span class="num" id="2377399">0</span><span class="op" id="2377400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2377404">if</span>&nbsp;<span class="ident" id="2377407">err1</span>&nbsp;<span class="op" id="2377412">!=</span>&nbsp;<span class="num" id="2377415">0</span>&nbsp;<span class="op" id="2377417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2377422">goto</span>&nbsp;<span class="ident" id="2377427">childerror</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2377440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2377445">//&nbsp;Signal&nbsp;self&nbsp;if&nbsp;parent&nbsp;is&nbsp;already&nbsp;dead.&nbsp;This&nbsp;might&nbsp;cause&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2377508">//&nbsp;duplicate&nbsp;signal&nbsp;in&nbsp;rare&nbsp;cases,&nbsp;but&nbsp;it&nbsp;won&#39;t&nbsp;matter&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2377570">//&nbsp;using&nbsp;SIGKILL.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2377590">r1</span><span class="op" id="2377592">,</span>&nbsp;<span class="ident" id="2377594">_</span><span class="op" id="2377595">,</span>&nbsp;<span class="ident" id="2377597">_</span>&nbsp;<span class="op" id="2377599">=</span>&nbsp;<span class="ident" id="2377601">RawSyscall</span><span class="op" id="2377611">(</span><span class="ident" id="2377612">SYS_GETPPID</span><span class="op" id="2377623">,</span>&nbsp;<span class="num" id="2377625">0</span><span class="op" id="2377626">,</span>&nbsp;<span class="num" id="2377628">0</span><span class="op" id="2377629">,</span>&nbsp;<span class="num" id="2377631">0</span><span class="op" id="2377632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2377636">if</span>&nbsp;<span class="ident" id="2377639">r1</span>&nbsp;<span class="op" id="2377642">==</span>&nbsp;<span class="num" id="2377645">1</span>&nbsp;<span class="op" id="2377647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2377652">pid</span><span class="op" id="2377655">,</span>&nbsp;<span class="ident" id="2377657">_</span><span class="op" id="2377658">,</span>&nbsp;<span class="ident" id="2377660">_</span>&nbsp;<span class="op" id="2377662">:=</span>&nbsp;<span class="ident" id="2377665">RawSyscall</span><span class="op" id="2377675">(</span><span class="ident" id="2377676">SYS_GETPID</span><span class="op" id="2377686">,</span>&nbsp;<span class="num" id="2377688">0</span><span class="op" id="2377689">,</span>&nbsp;<span class="num" id="2377691">0</span><span class="op" id="2377692">,</span>&nbsp;<span class="num" id="2377694">0</span><span class="op" id="2377695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2377700">_</span><span class="op" id="2377701">,</span>&nbsp;<span class="ident" id="2377703">_</span><span class="op" id="2377704">,</span>&nbsp;<span class="ident" id="2377706">err1</span>&nbsp;<span class="op" id="2377711">:=</span>&nbsp;<span class="ident" id="2377714">RawSyscall</span><span class="op" id="2377724">(</span><span class="ident" id="2377725">SYS_KILL</span><span class="op" id="2377733">,</span>&nbsp;<span class="ident" id="2377735">pid</span><span class="op" id="2377738">,</span>&nbsp;<span class="builtintype" id="2377740">uintptr</span><span class="op" id="2377747">(</span><span class="ident" id="2377748">sys</span><span class="op" id="2377751">.</span><span class="ident" id="2377752">Pdeathsig</span><span class="op" id="2377761">)</span><span class="op" id="2377762">,</span>&nbsp;<span class="num" id="2377764">0</span><span class="op" id="2377765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2377770">if</span>&nbsp;<span class="ident" id="2377773">err1</span>&nbsp;<span class="op" id="2377778">!=</span>&nbsp;<span class="num" id="2377781">0</span>&nbsp;<span class="op" id="2377783">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2377789">goto</span>&nbsp;<span class="ident" id="2377794">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2377808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2377812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2377815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2377819">//&nbsp;Enable&nbsp;tracing&nbsp;if&nbsp;requested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2377852">if</span>&nbsp;<span class="ident" id="2377855">sys</span><span class="op" id="2377858">.</span><span class="ident" id="2377859">Ptrace</span>&nbsp;<span class="op" id="2377866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2377870">_</span><span class="op" id="2377871">,</span>&nbsp;<span class="ident" id="2377873">_</span><span class="op" id="2377874">,</span>&nbsp;<span class="ident" id="2377876">err1</span>&nbsp;<span class="op" id="2377881">=</span>&nbsp;<span class="ident" id="2377883">RawSyscall</span><span class="op" id="2377893">(</span><span class="ident" id="2377894">SYS_PTRACE</span><span class="op" id="2377904">,</span>&nbsp;<span class="builtintype" id="2377906">uintptr</span><span class="op" id="2377913">(</span><span class="ident" id="2377914">PTRACE_TRACEME</span><span class="op" id="2377928">)</span><span class="op" id="2377929">,</span>&nbsp;<span class="num" id="2377931">0</span><span class="op" id="2377932">,</span>&nbsp;<span class="num" id="2377934">0</span><span class="op" id="2377935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2377939">if</span>&nbsp;<span class="ident" id="2377942">err1</span>&nbsp;<span class="op" id="2377947">!=</span>&nbsp;<span class="num" id="2377950">0</span>&nbsp;<span class="op" id="2377952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2377957">goto</span>&nbsp;<span class="ident" id="2377962">childerror</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2377975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2377978">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2377982">//&nbsp;Session&nbsp;ID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2377997">if</span>&nbsp;<span class="ident" id="2378000">sys</span><span class="op" id="2378003">.</span><span class="ident" id="2378004">Setsid</span>&nbsp;<span class="op" id="2378011">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2378015">_</span><span class="op" id="2378016">,</span>&nbsp;<span class="ident" id="2378018">_</span><span class="op" id="2378019">,</span>&nbsp;<span class="ident" id="2378021">err1</span>&nbsp;<span class="op" id="2378026">=</span>&nbsp;<span class="ident" id="2378028">RawSyscall</span><span class="op" id="2378038">(</span><span class="ident" id="2378039">SYS_SETSID</span><span class="op" id="2378049">,</span>&nbsp;<span class="num" id="2378051">0</span><span class="op" id="2378052">,</span>&nbsp;<span class="num" id="2378054">0</span><span class="op" id="2378055">,</span>&nbsp;<span class="num" id="2378057">0</span><span class="op" id="2378058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2378062">if</span>&nbsp;<span class="ident" id="2378065">err1</span>&nbsp;<span class="op" id="2378070">!=</span>&nbsp;<span class="num" id="2378073">0</span>&nbsp;<span class="op" id="2378075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2378080">goto</span>&nbsp;<span class="ident" id="2378085">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2378098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2378101">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2378105">//&nbsp;Set&nbsp;process&nbsp;group</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2378127">if</span>&nbsp;<span class="ident" id="2378130">sys</span><span class="op" id="2378133">.</span><span class="ident" id="2378134">Setpgid</span>&nbsp;<span class="op" id="2378142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2378146">_</span><span class="op" id="2378147">,</span>&nbsp;<span class="ident" id="2378149">_</span><span class="op" id="2378150">,</span>&nbsp;<span class="ident" id="2378152">err1</span>&nbsp;<span class="op" id="2378157">=</span>&nbsp;<span class="ident" id="2378159">RawSyscall</span><span class="op" id="2378169">(</span><span class="ident" id="2378170">SYS_SETPGID</span><span class="op" id="2378181">,</span>&nbsp;<span class="num" id="2378183">0</span><span class="op" id="2378184">,</span>&nbsp;<span class="num" id="2378186">0</span><span class="op" id="2378187">,</span>&nbsp;<span class="num" id="2378189">0</span><span class="op" id="2378190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2378194">if</span>&nbsp;<span class="ident" id="2378197">err1</span>&nbsp;<span class="op" id="2378202">!=</span>&nbsp;<span class="num" id="2378205">0</span>&nbsp;<span class="op" id="2378207">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2378212">goto</span>&nbsp;<span class="ident" id="2378217">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2378230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2378233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2378237">//&nbsp;Chroot</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2378248">if</span>&nbsp;<span class="ident" id="2378251">chroot</span>&nbsp;<span class="op" id="2378258">!=</span>&nbsp;<span class="builtintype" id="2378261">nil</span>&nbsp;<span class="op" id="2378265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2378269">_</span><span class="op" id="2378270">,</span>&nbsp;<span class="ident" id="2378272">_</span><span class="op" id="2378273">,</span>&nbsp;<span class="ident" id="2378275">err1</span>&nbsp;<span class="op" id="2378280">=</span>&nbsp;<span class="ident" id="2378282">RawSyscall</span><span class="op" id="2378292">(</span><span class="ident" id="2378293">SYS_CHROOT</span><span class="op" id="2378303">,</span>&nbsp;<span class="builtintype" id="2378305">uintptr</span><span class="op" id="2378312">(</span><span class="ident" id="2378313">unsafe</span><span class="op" id="2378319">.</span><span class="ident" id="2378320">Pointer</span><span class="op" id="2378327">(</span><span class="ident" id="2378328">chroot</span><span class="op" id="2378334">)</span><span class="op" id="2378335">)</span><span class="op" id="2378336">,</span>&nbsp;<span class="num" id="2378338">0</span><span class="op" id="2378339">,</span>&nbsp;<span class="num" id="2378341">0</span><span class="op" id="2378342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2378346">if</span>&nbsp;<span class="ident" id="2378349">err1</span>&nbsp;<span class="op" id="2378354">!=</span>&nbsp;<span class="num" id="2378357">0</span>&nbsp;<span class="op" id="2378359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2378364">goto</span>&nbsp;<span class="ident" id="2378369">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2378382">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2378385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2378389">//&nbsp;User&nbsp;and&nbsp;groups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2378409">if</span>&nbsp;<span class="ident" id="2378412">cred</span>&nbsp;<span class="op" id="2378417">:=</span>&nbsp;<span class="ident" id="2378420">sys</span><span class="op" id="2378423">.</span><span class="ident" id="2378424">Credential</span><span class="op" id="2378434">;</span>&nbsp;<span class="ident" id="2378436">cred</span>&nbsp;<span class="op" id="2378441">!=</span>&nbsp;<span class="builtintype" id="2378444">nil</span>&nbsp;<span class="op" id="2378448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2378452">ngroups</span>&nbsp;<span class="op" id="2378460">:=</span>&nbsp;<span class="builtintype" id="2378463">uintptr</span><span class="op" id="2378470">(</span><span class="builtinfunc" id="2378471">len</span><span class="op" id="2378474">(</span><span class="ident" id="2378475">cred</span><span class="op" id="2378479">.</span><span class="ident" id="2378480">Groups</span><span class="op" id="2378486">)</span><span class="op" id="2378487">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2378491">var</span>&nbsp;<span class="ident" id="2378495">groups</span>&nbsp;<span class="ident" id="2378502">unsafe</span><span class="op" id="2378508">.</span><span class="ident" id="2378509">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2378519">if</span>&nbsp;<span class="ident" id="2378522">ngroups</span>&nbsp;<span class="op" id="2378530">&gt;</span>&nbsp;<span class="num" id="2378532">0</span>&nbsp;<span class="op" id="2378534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2378539">groups</span>&nbsp;<span class="op" id="2378546">=</span>&nbsp;<span class="ident" id="2378548">unsafe</span><span class="op" id="2378554">.</span><span class="ident" id="2378555">Pointer</span><span class="op" id="2378562">(</span><span class="op" id="2378563">&amp;</span><span class="ident" id="2378564">cred</span><span class="op" id="2378568">.</span><span class="ident" id="2378569">Groups</span><span class="op" id="2378575">[</span><span class="num" id="2378576">0</span><span class="op" id="2378577">]</span><span class="op" id="2378578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2378582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2378586">_</span><span class="op" id="2378587">,</span>&nbsp;<span class="ident" id="2378589">_</span><span class="op" id="2378590">,</span>&nbsp;<span class="ident" id="2378592">err1</span>&nbsp;<span class="op" id="2378597">=</span>&nbsp;<span class="ident" id="2378599">RawSyscall</span><span class="op" id="2378609">(</span><span class="ident" id="2378610">SYS_SETGROUPS</span><span class="op" id="2378623">,</span>&nbsp;<span class="ident" id="2378625">ngroups</span><span class="op" id="2378632">,</span>&nbsp;<span class="builtintype" id="2378634">uintptr</span><span class="op" id="2378641">(</span><span class="ident" id="2378642">groups</span><span class="op" id="2378648">)</span><span class="op" id="2378649">,</span>&nbsp;<span class="num" id="2378651">0</span><span class="op" id="2378652">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2378656">if</span>&nbsp;<span class="ident" id="2378659">err1</span>&nbsp;<span class="op" id="2378664">!=</span>&nbsp;<span class="num" id="2378667">0</span>&nbsp;<span class="op" id="2378669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2378674">goto</span>&nbsp;<span class="ident" id="2378679">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2378692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2378696">_</span><span class="op" id="2378697">,</span>&nbsp;<span class="ident" id="2378699">_</span><span class="op" id="2378700">,</span>&nbsp;<span class="ident" id="2378702">err1</span>&nbsp;<span class="op" id="2378707">=</span>&nbsp;<span class="ident" id="2378709">RawSyscall</span><span class="op" id="2378719">(</span><span class="ident" id="2378720">SYS_SETGID</span><span class="op" id="2378730">,</span>&nbsp;<span class="builtintype" id="2378732">uintptr</span><span class="op" id="2378739">(</span><span class="ident" id="2378740">cred</span><span class="op" id="2378744">.</span><span class="ident" id="2378745">Gid</span><span class="op" id="2378748">)</span><span class="op" id="2378749">,</span>&nbsp;<span class="num" id="2378751">0</span><span class="op" id="2378752">,</span>&nbsp;<span class="num" id="2378754">0</span><span class="op" id="2378755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2378759">if</span>&nbsp;<span class="ident" id="2378762">err1</span>&nbsp;<span class="op" id="2378767">!=</span>&nbsp;<span class="num" id="2378770">0</span>&nbsp;<span class="op" id="2378772">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2378777">goto</span>&nbsp;<span class="ident" id="2378782">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2378795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2378799">_</span><span class="op" id="2378800">,</span>&nbsp;<span class="ident" id="2378802">_</span><span class="op" id="2378803">,</span>&nbsp;<span class="ident" id="2378805">err1</span>&nbsp;<span class="op" id="2378810">=</span>&nbsp;<span class="ident" id="2378812">RawSyscall</span><span class="op" id="2378822">(</span><span class="ident" id="2378823">SYS_SETUID</span><span class="op" id="2378833">,</span>&nbsp;<span class="builtintype" id="2378835">uintptr</span><span class="op" id="2378842">(</span><span class="ident" id="2378843">cred</span><span class="op" id="2378847">.</span><span class="ident" id="2378848">Uid</span><span class="op" id="2378851">)</span><span class="op" id="2378852">,</span>&nbsp;<span class="num" id="2378854">0</span><span class="op" id="2378855">,</span>&nbsp;<span class="num" id="2378857">0</span><span class="op" id="2378858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2378862">if</span>&nbsp;<span class="ident" id="2378865">err1</span>&nbsp;<span class="op" id="2378870">!=</span>&nbsp;<span class="num" id="2378873">0</span>&nbsp;<span class="op" id="2378875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2378880">goto</span>&nbsp;<span class="ident" id="2378885">childerror</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2378898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2378901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2378905">//&nbsp;Chdir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2378915">if</span>&nbsp;<span class="ident" id="2378918">dir</span>&nbsp;<span class="op" id="2378922">!=</span>&nbsp;<span class="builtintype" id="2378925">nil</span>&nbsp;<span class="op" id="2378929">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2378933">_</span><span class="op" id="2378934">,</span>&nbsp;<span class="ident" id="2378936">_</span><span class="op" id="2378937">,</span>&nbsp;<span class="ident" id="2378939">err1</span>&nbsp;<span class="op" id="2378944">=</span>&nbsp;<span class="ident" id="2378946">RawSyscall</span><span class="op" id="2378956">(</span><span class="ident" id="2378957">SYS_CHDIR</span><span class="op" id="2378966">,</span>&nbsp;<span class="builtintype" id="2378968">uintptr</span><span class="op" id="2378975">(</span><span class="ident" id="2378976">unsafe</span><span class="op" id="2378982">.</span><span class="ident" id="2378983">Pointer</span><span class="op" id="2378990">(</span><span class="ident" id="2378991">dir</span><span class="op" id="2378994">)</span><span class="op" id="2378995">)</span><span class="op" id="2378996">,</span>&nbsp;<span class="num" id="2378998">0</span><span class="op" id="2378999">,</span>&nbsp;<span class="num" id="2379001">0</span><span class="op" id="2379002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2379006">if</span>&nbsp;<span class="ident" id="2379009">err1</span>&nbsp;<span class="op" id="2379014">!=</span>&nbsp;<span class="num" id="2379017">0</span>&nbsp;<span class="op" id="2379019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2379024">goto</span>&nbsp;<span class="ident" id="2379029">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2379042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2379045">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2379049">//&nbsp;Pass&nbsp;1:&nbsp;look&nbsp;for&nbsp;fd[i]&nbsp;&lt;&nbsp;i&nbsp;and&nbsp;move&nbsp;those&nbsp;up&nbsp;above&nbsp;len(fd)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2379112">//&nbsp;so&nbsp;that&nbsp;pass&nbsp;2&nbsp;won&#39;t&nbsp;stomp&nbsp;on&nbsp;an&nbsp;fd&nbsp;it&nbsp;needs&nbsp;later.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2379168">if</span>&nbsp;<span class="ident" id="2379171">pipe</span>&nbsp;<span class="op" id="2379176">&lt;</span>&nbsp;<span class="ident" id="2379178">nextfd</span>&nbsp;<span class="op" id="2379185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2379189">_</span><span class="op" id="2379190">,</span>&nbsp;<span class="ident" id="2379192">_</span><span class="op" id="2379193">,</span>&nbsp;<span class="ident" id="2379195">err1</span>&nbsp;<span class="op" id="2379200">=</span>&nbsp;<span class="ident" id="2379202">RawSyscall</span><span class="op" id="2379212">(</span><span class="ident" id="2379213">SYS_DUP2</span><span class="op" id="2379221">,</span>&nbsp;<span class="builtintype" id="2379223">uintptr</span><span class="op" id="2379230">(</span><span class="ident" id="2379231">pipe</span><span class="op" id="2379235">)</span><span class="op" id="2379236">,</span>&nbsp;<span class="builtintype" id="2379238">uintptr</span><span class="op" id="2379245">(</span><span class="ident" id="2379246">nextfd</span><span class="op" id="2379252">)</span><span class="op" id="2379253">,</span>&nbsp;<span class="num" id="2379255">0</span><span class="op" id="2379256">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2379260">if</span>&nbsp;<span class="ident" id="2379263">err1</span>&nbsp;<span class="op" id="2379268">!=</span>&nbsp;<span class="num" id="2379271">0</span>&nbsp;<span class="op" id="2379273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2379278">goto</span>&nbsp;<span class="ident" id="2379283">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2379296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2379300">RawSyscall</span><span class="op" id="2379310">(</span><span class="ident" id="2379311">SYS_FCNTL</span><span class="op" id="2379320">,</span>&nbsp;<span class="builtintype" id="2379322">uintptr</span><span class="op" id="2379329">(</span><span class="ident" id="2379330">nextfd</span><span class="op" id="2379336">)</span><span class="op" id="2379337">,</span>&nbsp;<span class="ident" id="2379339">F_SETFD</span><span class="op" id="2379346">,</span>&nbsp;<span class="ident" id="2379348">FD_CLOEXEC</span><span class="op" id="2379358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2379362">pipe</span>&nbsp;<span class="op" id="2379367">=</span>&nbsp;<span class="ident" id="2379369">nextfd</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2379378">nextfd</span><span class="op" id="2379384">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2379388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2379391">for</span>&nbsp;<span class="ident" id="2379395">i</span>&nbsp;<span class="op" id="2379397">=</span>&nbsp;<span class="num" id="2379399">0</span><span class="op" id="2379400">;</span>&nbsp;<span class="ident" id="2379402">i</span>&nbsp;<span class="op" id="2379404">&lt;</span>&nbsp;<span class="builtinfunc" id="2379406">len</span><span class="op" id="2379409">(</span><span class="ident" id="2379410">fd</span><span class="op" id="2379412">)</span><span class="op" id="2379413">;</span>&nbsp;<span class="ident" id="2379415">i</span><span class="op" id="2379416">++</span>&nbsp;<span class="op" id="2379419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2379423">if</span>&nbsp;<span class="ident" id="2379426">fd</span><span class="op" id="2379428">[</span><span class="ident" id="2379429">i</span><span class="op" id="2379430">]</span>&nbsp;<span class="op" id="2379432">&gt;=</span>&nbsp;<span class="num" id="2379435">0</span>&nbsp;<span class="op" id="2379437">&amp;&amp;</span>&nbsp;<span class="ident" id="2379440">fd</span><span class="op" id="2379442">[</span><span class="ident" id="2379443">i</span><span class="op" id="2379444">]</span>&nbsp;<span class="op" id="2379446">&lt;</span>&nbsp;<span class="builtintype" id="2379448">int</span><span class="op" id="2379451">(</span><span class="ident" id="2379452">i</span><span class="op" id="2379453">)</span>&nbsp;<span class="op" id="2379455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2379460">_</span><span class="op" id="2379461">,</span>&nbsp;<span class="ident" id="2379463">_</span><span class="op" id="2379464">,</span>&nbsp;<span class="ident" id="2379466">err1</span>&nbsp;<span class="op" id="2379471">=</span>&nbsp;<span class="ident" id="2379473">RawSyscall</span><span class="op" id="2379483">(</span><span class="ident" id="2379484">SYS_DUP2</span><span class="op" id="2379492">,</span>&nbsp;<span class="builtintype" id="2379494">uintptr</span><span class="op" id="2379501">(</span><span class="ident" id="2379502">fd</span><span class="op" id="2379504">[</span><span class="ident" id="2379505">i</span><span class="op" id="2379506">]</span><span class="op" id="2379507">)</span><span class="op" id="2379508">,</span>&nbsp;<span class="builtintype" id="2379510">uintptr</span><span class="op" id="2379517">(</span><span class="ident" id="2379518">nextfd</span><span class="op" id="2379524">)</span><span class="op" id="2379525">,</span>&nbsp;<span class="num" id="2379527">0</span><span class="op" id="2379528">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2379533">if</span>&nbsp;<span class="ident" id="2379536">err1</span>&nbsp;<span class="op" id="2379541">!=</span>&nbsp;<span class="num" id="2379544">0</span>&nbsp;<span class="op" id="2379546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2379552">goto</span>&nbsp;<span class="ident" id="2379557">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2379571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2379576">RawSyscall</span><span class="op" id="2379586">(</span><span class="ident" id="2379587">SYS_FCNTL</span><span class="op" id="2379596">,</span>&nbsp;<span class="builtintype" id="2379598">uintptr</span><span class="op" id="2379605">(</span><span class="ident" id="2379606">nextfd</span><span class="op" id="2379612">)</span><span class="op" id="2379613">,</span>&nbsp;<span class="ident" id="2379615">F_SETFD</span><span class="op" id="2379622">,</span>&nbsp;<span class="ident" id="2379624">FD_CLOEXEC</span><span class="op" id="2379634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2379639">fd</span><span class="op" id="2379641">[</span><span class="ident" id="2379642">i</span><span class="op" id="2379643">]</span>&nbsp;<span class="op" id="2379645">=</span>&nbsp;<span class="ident" id="2379647">nextfd</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2379657">nextfd</span><span class="op" id="2379663">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2379669">if</span>&nbsp;<span class="ident" id="2379672">nextfd</span>&nbsp;<span class="op" id="2379679">==</span>&nbsp;<span class="ident" id="2379682">pipe</span>&nbsp;<span class="op" id="2379687">{</span>&nbsp;<span class="comment" id="2379689">//&nbsp;don&#39;t&nbsp;stomp&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2379716">nextfd</span><span class="op" id="2379722">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2379728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2379732">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2379735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2379739">//&nbsp;Pass&nbsp;2:&nbsp;dup&nbsp;fd[i]&nbsp;down&nbsp;onto&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2379774">for</span>&nbsp;<span class="ident" id="2379778">i</span>&nbsp;<span class="op" id="2379780">=</span>&nbsp;<span class="num" id="2379782">0</span><span class="op" id="2379783">;</span>&nbsp;<span class="ident" id="2379785">i</span>&nbsp;<span class="op" id="2379787">&lt;</span>&nbsp;<span class="builtinfunc" id="2379789">len</span><span class="op" id="2379792">(</span><span class="ident" id="2379793">fd</span><span class="op" id="2379795">)</span><span class="op" id="2379796">;</span>&nbsp;<span class="ident" id="2379798">i</span><span class="op" id="2379799">++</span>&nbsp;<span class="op" id="2379802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2379806">if</span>&nbsp;<span class="ident" id="2379809">fd</span><span class="op" id="2379811">[</span><span class="ident" id="2379812">i</span><span class="op" id="2379813">]</span>&nbsp;<span class="op" id="2379815">==</span>&nbsp;<span class="op" id="2379818">-</span><span class="num" id="2379819">1</span>&nbsp;<span class="op" id="2379821">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2379826">RawSyscall</span><span class="op" id="2379836">(</span><span class="ident" id="2379837">SYS_CLOSE</span><span class="op" id="2379846">,</span>&nbsp;<span class="builtintype" id="2379848">uintptr</span><span class="op" id="2379855">(</span><span class="ident" id="2379856">i</span><span class="op" id="2379857">)</span><span class="op" id="2379858">,</span>&nbsp;<span class="num" id="2379860">0</span><span class="op" id="2379861">,</span>&nbsp;<span class="num" id="2379863">0</span><span class="op" id="2379864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2379869">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2379880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2379884">if</span>&nbsp;<span class="ident" id="2379887">fd</span><span class="op" id="2379889">[</span><span class="ident" id="2379890">i</span><span class="op" id="2379891">]</span>&nbsp;<span class="op" id="2379893">==</span>&nbsp;<span class="builtintype" id="2379896">int</span><span class="op" id="2379899">(</span><span class="ident" id="2379900">i</span><span class="op" id="2379901">)</span>&nbsp;<span class="op" id="2379903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2379908">//&nbsp;dup2(i,&nbsp;i)&nbsp;won&#39;t&nbsp;clear&nbsp;close-on-exec&nbsp;flag&nbsp;on&nbsp;Linux,</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2379966">//&nbsp;probably&nbsp;not&nbsp;elsewhere&nbsp;either.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2380003">_</span><span class="op" id="2380004">,</span>&nbsp;<span class="ident" id="2380006">_</span><span class="op" id="2380007">,</span>&nbsp;<span class="ident" id="2380009">err1</span>&nbsp;<span class="op" id="2380014">=</span>&nbsp;<span class="ident" id="2380016">RawSyscall</span><span class="op" id="2380026">(</span><span class="ident" id="2380027">SYS_FCNTL</span><span class="op" id="2380036">,</span>&nbsp;<span class="builtintype" id="2380038">uintptr</span><span class="op" id="2380045">(</span><span class="ident" id="2380046">fd</span><span class="op" id="2380048">[</span><span class="ident" id="2380049">i</span><span class="op" id="2380050">]</span><span class="op" id="2380051">)</span><span class="op" id="2380052">,</span>&nbsp;<span class="ident" id="2380054">F_SETFD</span><span class="op" id="2380061">,</span>&nbsp;<span class="num" id="2380063">0</span><span class="op" id="2380064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2380069">if</span>&nbsp;<span class="ident" id="2380072">err1</span>&nbsp;<span class="op" id="2380077">!=</span>&nbsp;<span class="num" id="2380080">0</span>&nbsp;<span class="op" id="2380082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2380088">goto</span>&nbsp;<span class="ident" id="2380093">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2380107">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2380112">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2380123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2380127">//&nbsp;The&nbsp;new&nbsp;fd&nbsp;is&nbsp;created&nbsp;NOT&nbsp;close-on-exec,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2380173">//&nbsp;which&nbsp;is&nbsp;exactly&nbsp;what&nbsp;we&nbsp;want.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2380209">_</span><span class="op" id="2380210">,</span>&nbsp;<span class="ident" id="2380212">_</span><span class="op" id="2380213">,</span>&nbsp;<span class="ident" id="2380215">err1</span>&nbsp;<span class="op" id="2380220">=</span>&nbsp;<span class="ident" id="2380222">RawSyscall</span><span class="op" id="2380232">(</span><span class="ident" id="2380233">SYS_DUP2</span><span class="op" id="2380241">,</span>&nbsp;<span class="builtintype" id="2380243">uintptr</span><span class="op" id="2380250">(</span><span class="ident" id="2380251">fd</span><span class="op" id="2380253">[</span><span class="ident" id="2380254">i</span><span class="op" id="2380255">]</span><span class="op" id="2380256">)</span><span class="op" id="2380257">,</span>&nbsp;<span class="builtintype" id="2380259">uintptr</span><span class="op" id="2380266">(</span><span class="ident" id="2380267">i</span><span class="op" id="2380268">)</span><span class="op" id="2380269">,</span>&nbsp;<span class="num" id="2380271">0</span><span class="op" id="2380272">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2380276">if</span>&nbsp;<span class="ident" id="2380279">err1</span>&nbsp;<span class="op" id="2380284">!=</span>&nbsp;<span class="num" id="2380287">0</span>&nbsp;<span class="op" id="2380289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2380294">goto</span>&nbsp;<span class="ident" id="2380299">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2380312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2380315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2380319">//&nbsp;By&nbsp;convention,&nbsp;we&nbsp;don&#39;t&nbsp;close-on-exec&nbsp;the&nbsp;fds&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2380376">//&nbsp;started&nbsp;with,&nbsp;so&nbsp;if&nbsp;len(fd)&nbsp;&lt;&nbsp;3,&nbsp;close&nbsp;0,&nbsp;1,&nbsp;2&nbsp;as&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2380438">//&nbsp;Programs&nbsp;that&nbsp;know&nbsp;they&nbsp;inherit&nbsp;fds&nbsp;&gt;=&nbsp;3&nbsp;will&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2380493">//&nbsp;to&nbsp;set&nbsp;them&nbsp;close-on-exec.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2380524">for</span>&nbsp;<span class="ident" id="2380528">i</span>&nbsp;<span class="op" id="2380530">=</span>&nbsp;<span class="builtinfunc" id="2380532">len</span><span class="op" id="2380535">(</span><span class="ident" id="2380536">fd</span><span class="op" id="2380538">)</span><span class="op" id="2380539">;</span>&nbsp;<span class="ident" id="2380541">i</span>&nbsp;<span class="op" id="2380543">&lt;</span>&nbsp;<span class="num" id="2380545">3</span><span class="op" id="2380546">;</span>&nbsp;<span class="ident" id="2380548">i</span><span class="op" id="2380549">++</span>&nbsp;<span class="op" id="2380552">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2380556">RawSyscall</span><span class="op" id="2380566">(</span><span class="ident" id="2380567">SYS_CLOSE</span><span class="op" id="2380576">,</span>&nbsp;<span class="builtintype" id="2380578">uintptr</span><span class="op" id="2380585">(</span><span class="ident" id="2380586">i</span><span class="op" id="2380587">)</span><span class="op" id="2380588">,</span>&nbsp;<span class="num" id="2380590">0</span><span class="op" id="2380591">,</span>&nbsp;<span class="num" id="2380593">0</span><span class="op" id="2380594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2380597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2380601">//&nbsp;Detach&nbsp;fd&nbsp;0&nbsp;from&nbsp;tty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2380626">if</span>&nbsp;<span class="ident" id="2380629">sys</span><span class="op" id="2380632">.</span><span class="ident" id="2380633">Noctty</span>&nbsp;<span class="op" id="2380640">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2380644">_</span><span class="op" id="2380645">,</span>&nbsp;<span class="ident" id="2380647">_</span><span class="op" id="2380648">,</span>&nbsp;<span class="ident" id="2380650">err1</span>&nbsp;<span class="op" id="2380655">=</span>&nbsp;<span class="ident" id="2380657">RawSyscall</span><span class="op" id="2380667">(</span><span class="ident" id="2380668">SYS_IOCTL</span><span class="op" id="2380677">,</span>&nbsp;<span class="num" id="2380679">0</span><span class="op" id="2380680">,</span>&nbsp;<span class="builtintype" id="2380682">uintptr</span><span class="op" id="2380689">(</span><span class="ident" id="2380690">TIOCNOTTY</span><span class="op" id="2380699">)</span><span class="op" id="2380700">,</span>&nbsp;<span class="num" id="2380702">0</span><span class="op" id="2380703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2380707">if</span>&nbsp;<span class="ident" id="2380710">err1</span>&nbsp;<span class="op" id="2380715">!=</span>&nbsp;<span class="num" id="2380718">0</span>&nbsp;<span class="op" id="2380720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2380725">goto</span>&nbsp;<span class="ident" id="2380730">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2380743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2380746">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2380750">//&nbsp;Set&nbsp;the&nbsp;controlling&nbsp;TTY&nbsp;to&nbsp;Ctty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2380786">if</span>&nbsp;<span class="ident" id="2380789">sys</span><span class="op" id="2380792">.</span><span class="ident" id="2380793">Setctty</span>&nbsp;<span class="op" id="2380801">&amp;&amp;</span>&nbsp;<span class="ident" id="2380804">sys</span><span class="op" id="2380807">.</span><span class="ident" id="2380808">Ctty</span>&nbsp;<span class="op" id="2380813">&gt;=</span>&nbsp;<span class="num" id="2380816">0</span>&nbsp;<span class="op" id="2380818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2380822">_</span><span class="op" id="2380823">,</span>&nbsp;<span class="ident" id="2380825">_</span><span class="op" id="2380826">,</span>&nbsp;<span class="ident" id="2380828">err1</span>&nbsp;<span class="op" id="2380833">=</span>&nbsp;<span class="ident" id="2380835">RawSyscall</span><span class="op" id="2380845">(</span><span class="ident" id="2380846">SYS_IOCTL</span><span class="op" id="2380855">,</span>&nbsp;<span class="builtintype" id="2380857">uintptr</span><span class="op" id="2380864">(</span><span class="ident" id="2380865">sys</span><span class="op" id="2380868">.</span><span class="ident" id="2380869">Ctty</span><span class="op" id="2380873">)</span><span class="op" id="2380874">,</span>&nbsp;<span class="builtintype" id="2380876">uintptr</span><span class="op" id="2380883">(</span><span class="ident" id="2380884">TIOCSCTTY</span><span class="op" id="2380893">)</span><span class="op" id="2380894">,</span>&nbsp;<span class="num" id="2380896">0</span><span class="op" id="2380897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2380901">if</span>&nbsp;<span class="ident" id="2380904">err1</span>&nbsp;<span class="op" id="2380909">!=</span>&nbsp;<span class="num" id="2380912">0</span>&nbsp;<span class="op" id="2380914">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2380919">goto</span>&nbsp;<span class="ident" id="2380924">childerror</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2380937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2380940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2380944">//&nbsp;Time&nbsp;to&nbsp;exec.</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2380962">_</span><span class="op" id="2380963">,</span>&nbsp;<span class="ident" id="2380965">_</span><span class="op" id="2380966">,</span>&nbsp;<span class="ident" id="2380968">err1</span>&nbsp;<span class="op" id="2380973">=</span>&nbsp;<span class="ident" id="2380975">RawSyscall</span><span class="op" id="2380985">(</span><span class="ident" id="2380986">SYS_EXECVE</span><span class="op" id="2380996">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2381000">uintptr</span><span class="op" id="2381007">(</span><span class="ident" id="2381008">unsafe</span><span class="op" id="2381014">.</span><span class="ident" id="2381015">Pointer</span><span class="op" id="2381022">(</span><span class="ident" id="2381023">argv0</span><span class="op" id="2381028">)</span><span class="op" id="2381029">)</span><span class="op" id="2381030">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2381034">uintptr</span><span class="op" id="2381041">(</span><span class="ident" id="2381042">unsafe</span><span class="op" id="2381048">.</span><span class="ident" id="2381049">Pointer</span><span class="op" id="2381056">(</span><span class="op" id="2381057">&amp;</span><span class="ident" id="2381058">argv</span><span class="op" id="2381062">[</span><span class="num" id="2381063">0</span><span class="op" id="2381064">]</span><span class="op" id="2381065">)</span><span class="op" id="2381066">)</span><span class="op" id="2381067">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2381071">uintptr</span><span class="op" id="2381078">(</span><span class="ident" id="2381079">unsafe</span><span class="op" id="2381085">.</span><span class="ident" id="2381086">Pointer</span><span class="op" id="2381093">(</span><span class="op" id="2381094">&amp;</span><span class="ident" id="2381095">envv</span><span class="op" id="2381099">[</span><span class="num" id="2381100">0</span><span class="op" id="2381101">]</span><span class="op" id="2381102">)</span><span class="op" id="2381103">)</span><span class="op" id="2381104">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="ident" id="2381107">childerror</span><span class="op" id="2381117">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2381120">//&nbsp;send&nbsp;error&nbsp;code&nbsp;on&nbsp;pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2381148">RawSyscall</span><span class="op" id="2381158">(</span><span class="ident" id="2381159">SYS_WRITE</span><span class="op" id="2381168">,</span>&nbsp;<span class="builtintype" id="2381170">uintptr</span><span class="op" id="2381177">(</span><span class="ident" id="2381178">pipe</span><span class="op" id="2381182">)</span><span class="op" id="2381183">,</span>&nbsp;<span class="builtintype" id="2381185">uintptr</span><span class="op" id="2381192">(</span><span class="ident" id="2381193">unsafe</span><span class="op" id="2381199">.</span><span class="ident" id="2381200">Pointer</span><span class="op" id="2381207">(</span><span class="op" id="2381208">&amp;</span><span class="ident" id="2381209">err1</span><span class="op" id="2381213">)</span><span class="op" id="2381214">)</span><span class="op" id="2381215">,</span>&nbsp;<span class="ident" id="2381217">unsafe</span><span class="op" id="2381223">.</span><span class="ident" id="2381224">Sizeof</span><span class="op" id="2381230">(</span><span class="ident" id="2381231">err1</span><span class="op" id="2381235">)</span><span class="op" id="2381236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2381239">for</span>&nbsp;<span class="op" id="2381243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2381247">RawSyscall</span><span class="op" id="2381257">(</span><span class="ident" id="2381258">SYS_EXIT</span><span class="op" id="2381266">,</span>&nbsp;<span class="num" id="2381268">253</span><span class="op" id="2381271">,</span>&nbsp;<span class="num" id="2381273">0</span><span class="op" id="2381274">,</span>&nbsp;<span class="num" id="2381276">0</span><span class="op" id="2381277">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2381280">}</span><br>
<span class="lineno"></span><span class="op" id="2381282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2381285">//&nbsp;Try&nbsp;to&nbsp;open&nbsp;a&nbsp;pipe&nbsp;with&nbsp;O_CLOEXEC&nbsp;set&nbsp;on&nbsp;both&nbsp;file&nbsp;descriptors.</span><br>
<span class="lineno"></span><span class="keyword" id="2381352">func</span>&nbsp;<span class="ident" id="2381357">forkExecPipe</span><span class="op" id="2381369">(</span><span class="ident" id="2381370">p</span>&nbsp;<span class="op" id="2381372">[</span><span class="op" id="2381373">]</span><span class="builtintype" id="2381374">int</span><span class="op" id="2381377">)</span>&nbsp;<span class="op" id="2381379">(</span><span class="ident" id="2381380">err</span>&nbsp;<span class="builtintype" id="2381384">error</span><span class="op" id="2381389">)</span>&nbsp;<span class="op" id="2381391">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2381394">err</span>&nbsp;<span class="op" id="2381398">=</span>&nbsp;<span class="ident" id="2381400">Pipe2</span><span class="op" id="2381405">(</span><span class="ident" id="2381406">p</span><span class="op" id="2381407">,</span>&nbsp;<span class="ident" id="2381409">O_CLOEXEC</span><span class="op" id="2381418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2381421">//&nbsp;pipe2&nbsp;was&nbsp;added&nbsp;in&nbsp;2.6.27&nbsp;and&nbsp;our&nbsp;minimum&nbsp;requirement&nbsp;is&nbsp;2.6.23,&nbsp;so&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2381496">//&nbsp;might&nbsp;not&nbsp;be&nbsp;implemented.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2381526">if</span>&nbsp;<span class="ident" id="2381529">err</span>&nbsp;<span class="op" id="2381533">==</span>&nbsp;<span class="ident" id="2381536">ENOSYS</span>&nbsp;<span class="op" id="2381543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2381547">if</span>&nbsp;<span class="ident" id="2381550">err</span>&nbsp;<span class="op" id="2381554">=</span>&nbsp;<span class="ident" id="2381556">Pipe</span><span class="op" id="2381560">(</span><span class="ident" id="2381561">p</span><span class="op" id="2381562">)</span><span class="op" id="2381563">;</span>&nbsp;<span class="ident" id="2381565">err</span>&nbsp;<span class="op" id="2381569">!=</span>&nbsp;<span class="builtintype" id="2381572">nil</span>&nbsp;<span class="op" id="2381576">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2381581">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2381590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2381594">if</span>&nbsp;<span class="ident" id="2381597">_</span><span class="op" id="2381598">,</span>&nbsp;<span class="ident" id="2381600">err</span>&nbsp;<span class="op" id="2381604">=</span>&nbsp;<span class="ident" id="2381606">fcntl</span><span class="op" id="2381611">(</span><span class="ident" id="2381612">p</span><span class="op" id="2381613">[</span><span class="num" id="2381614">0</span><span class="op" id="2381615">]</span><span class="op" id="2381616">,</span>&nbsp;<span class="ident" id="2381618">F_SETFD</span><span class="op" id="2381625">,</span>&nbsp;<span class="ident" id="2381627">FD_CLOEXEC</span><span class="op" id="2381637">)</span><span class="op" id="2381638">;</span>&nbsp;<span class="ident" id="2381640">err</span>&nbsp;<span class="op" id="2381644">!=</span>&nbsp;<span class="builtintype" id="2381647">nil</span>&nbsp;<span class="op" id="2381651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2381656">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2381665">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2381669">_</span><span class="op" id="2381670">,</span>&nbsp;<span class="ident" id="2381672">err</span>&nbsp;<span class="op" id="2381676">=</span>&nbsp;<span class="ident" id="2381678">fcntl</span><span class="op" id="2381683">(</span><span class="ident" id="2381684">p</span><span class="op" id="2381685">[</span><span class="num" id="2381686">1</span><span class="op" id="2381687">]</span><span class="op" id="2381688">,</span>&nbsp;<span class="ident" id="2381690">F_SETFD</span><span class="op" id="2381697">,</span>&nbsp;<span class="ident" id="2381699">FD_CLOEXEC</span><span class="op" id="2381709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2381712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2381715">return</span><br>
<span class="lineno"></span><span class="op" id="2381722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="comment" id="2381725">//&nbsp;writeIDMappings&nbsp;writes&nbsp;the&nbsp;user&nbsp;namespace&nbsp;User&nbsp;ID&nbsp;or&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;to&nbsp;the&nbsp;specified&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="2381822">func</span>&nbsp;<span class="ident" id="2381827">writeIDMappings</span><span class="op" id="2381842">(</span><span class="ident" id="2381843">path</span>&nbsp;<span class="builtintype" id="2381848">string</span><span class="op" id="2381854">,</span>&nbsp;<span class="ident" id="2381856">idMap</span>&nbsp;<span class="op" id="2381862">[</span><span class="op" id="2381863">]</span><span class="ident" id="2381864">SysProcIDMap</span><span class="op" id="2381876">)</span>&nbsp;<span class="builtintype" id="2381878">error</span>&nbsp;<span class="op" id="2381884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2381887">fd</span><span class="op" id="2381889">,</span>&nbsp;<span class="ident" id="2381891">err</span>&nbsp;<span class="op" id="2381895">:=</span>&nbsp;<span class="ident" id="2381898">Open</span><span class="op" id="2381902">(</span><span class="ident" id="2381903">path</span><span class="op" id="2381907">,</span>&nbsp;<span class="ident" id="2381909">O_RDWR</span><span class="op" id="2381915">,</span>&nbsp;<span class="num" id="2381917">0</span><span class="op" id="2381918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2381921">if</span>&nbsp;<span class="ident" id="2381924">err</span>&nbsp;<span class="op" id="2381928">!=</span>&nbsp;<span class="builtintype" id="2381931">nil</span>&nbsp;<span class="op" id="2381935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2381939">return</span>&nbsp;<span class="ident" id="2381946">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2381951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2381955">data</span>&nbsp;<span class="op" id="2381960">:=</span>&nbsp;<span class="string" id="2381963">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2381967">for</span>&nbsp;<span class="ident" id="2381971">_</span><span class="op" id="2381972">,</span>&nbsp;<span class="ident" id="2381974">im</span>&nbsp;<span class="op" id="2381977">:=</span>&nbsp;<span class="keyword" id="2381980">range</span>&nbsp;<span class="ident" id="2381986">idMap</span>&nbsp;<span class="op" id="2381992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2381996">data</span>&nbsp;<span class="op" id="2382001">=</span>&nbsp;<span class="ident" id="2382003">data</span>&nbsp;<span class="op" id="2382008">+</span>&nbsp;<span class="ident" id="2382010">itoa</span><span class="op" id="2382014">(</span><span class="ident" id="2382015">im</span><span class="op" id="2382017">.</span><span class="ident" id="2382018">ContainerID</span><span class="op" id="2382029">)</span>&nbsp;<span class="op" id="2382031">+</span>&nbsp;<span class="string" id="2382033">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2382037">+</span>&nbsp;<span class="ident" id="2382039">itoa</span><span class="op" id="2382043">(</span><span class="ident" id="2382044">im</span><span class="op" id="2382046">.</span><span class="ident" id="2382047">HostID</span><span class="op" id="2382053">)</span>&nbsp;<span class="op" id="2382055">+</span>&nbsp;<span class="string" id="2382057">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="2382061">+</span>&nbsp;<span class="ident" id="2382063">itoa</span><span class="op" id="2382067">(</span><span class="ident" id="2382068">im</span><span class="op" id="2382070">.</span><span class="ident" id="2382071">Size</span><span class="op" id="2382075">)</span>&nbsp;<span class="op" id="2382077">+</span>&nbsp;<span class="string" id="2382079">&#34;\n&#34;</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2382085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2382089">bytes</span><span class="op" id="2382094">,</span>&nbsp;<span class="ident" id="2382096">err</span>&nbsp;<span class="op" id="2382100">:=</span>&nbsp;<span class="ident" id="2382103">ByteSliceFromString</span><span class="op" id="2382122">(</span><span class="ident" id="2382123">data</span><span class="op" id="2382127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2382130">if</span>&nbsp;<span class="ident" id="2382133">err</span>&nbsp;<span class="op" id="2382137">!=</span>&nbsp;<span class="builtintype" id="2382140">nil</span>&nbsp;<span class="op" id="2382144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2382148">Close</span><span class="op" id="2382153">(</span><span class="ident" id="2382154">fd</span><span class="op" id="2382156">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2382160">return</span>&nbsp;<span class="ident" id="2382167">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2382172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2382176">if</span>&nbsp;<span class="ident" id="2382179">_</span><span class="op" id="2382180">,</span>&nbsp;<span class="ident" id="2382182">err</span>&nbsp;<span class="op" id="2382186">:=</span>&nbsp;<span class="ident" id="2382189">Write</span><span class="op" id="2382194">(</span><span class="ident" id="2382195">fd</span><span class="op" id="2382197">,</span>&nbsp;<span class="ident" id="2382199">bytes</span><span class="op" id="2382204">)</span><span class="op" id="2382205">;</span>&nbsp;<span class="ident" id="2382207">err</span>&nbsp;<span class="op" id="2382211">!=</span>&nbsp;<span class="builtintype" id="2382214">nil</span>&nbsp;<span class="op" id="2382218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2382222">Close</span><span class="op" id="2382227">(</span><span class="ident" id="2382228">fd</span><span class="op" id="2382230">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2382234">return</span>&nbsp;<span class="ident" id="2382241">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2382246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2382250">if</span>&nbsp;<span class="ident" id="2382253">err</span>&nbsp;<span class="op" id="2382257">:=</span>&nbsp;<span class="ident" id="2382260">Close</span><span class="op" id="2382265">(</span><span class="ident" id="2382266">fd</span><span class="op" id="2382268">)</span><span class="op" id="2382269">;</span>&nbsp;<span class="ident" id="2382271">err</span>&nbsp;<span class="op" id="2382275">!=</span>&nbsp;<span class="builtintype" id="2382278">nil</span>&nbsp;<span class="op" id="2382282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2382286">return</span>&nbsp;<span class="ident" id="2382293">err</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2382298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2382302">return</span>&nbsp;<span class="builtintype" id="2382309">nil</span><br>
<span class="lineno"></span><span class="op" id="2382313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">345</span><span class="comment" id="2382316">//&nbsp;writeUidGidMappings&nbsp;writes&nbsp;User&nbsp;ID&nbsp;and&nbsp;Group&nbsp;ID&nbsp;mappings&nbsp;for&nbsp;user&nbsp;namespaces</span><br>
<span class="lineno"></span><span class="comment" id="2382396">//&nbsp;for&nbsp;a&nbsp;process&nbsp;and&nbsp;it&nbsp;is&nbsp;called&nbsp;from&nbsp;the&nbsp;parent&nbsp;process.</span><br>
<span class="lineno"></span><span class="keyword" id="2382455">func</span>&nbsp;<span class="ident" id="2382460">writeUidGidMappings</span><span class="op" id="2382479">(</span><span class="ident" id="2382480">pid</span>&nbsp;<span class="builtintype" id="2382484">int</span><span class="op" id="2382487">,</span>&nbsp;<span class="ident" id="2382489">sys</span>&nbsp;<span class="op" id="2382493">*</span><span class="ident" id="2382494">SysProcAttr</span><span class="op" id="2382505">)</span>&nbsp;<span class="builtintype" id="2382507">error</span>&nbsp;<span class="op" id="2382513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2382516">if</span>&nbsp;<span class="ident" id="2382519">sys</span><span class="op" id="2382522">.</span><span class="ident" id="2382523">UidMappings</span>&nbsp;<span class="op" id="2382535">!=</span>&nbsp;<span class="builtintype" id="2382538">nil</span>&nbsp;<span class="op" id="2382542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2382546">uidf</span>&nbsp;<span class="op" id="2382551">:=</span>&nbsp;<span class="string" id="2382554">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2382563">+</span>&nbsp;<span class="ident" id="2382565">itoa</span><span class="op" id="2382569">(</span><span class="ident" id="2382570">pid</span><span class="op" id="2382573">)</span>&nbsp;<span class="op" id="2382575">+</span>&nbsp;<span class="string" id="2382577">&#34;/uid_map&#34;</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2382590">if</span>&nbsp;<span class="ident" id="2382593">err</span>&nbsp;<span class="op" id="2382597">:=</span>&nbsp;<span class="ident" id="2382600">writeIDMappings</span><span class="op" id="2382615">(</span><span class="ident" id="2382616">uidf</span><span class="op" id="2382620">,</span>&nbsp;<span class="ident" id="2382622">sys</span><span class="op" id="2382625">.</span><span class="ident" id="2382626">UidMappings</span><span class="op" id="2382637">)</span><span class="op" id="2382638">;</span>&nbsp;<span class="ident" id="2382640">err</span>&nbsp;<span class="op" id="2382644">!=</span>&nbsp;<span class="builtintype" id="2382647">nil</span>&nbsp;<span class="op" id="2382651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2382656">return</span>&nbsp;<span class="ident" id="2382663">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2382669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2382672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2382676">if</span>&nbsp;<span class="ident" id="2382679">sys</span><span class="op" id="2382682">.</span><span class="ident" id="2382683">GidMappings</span>&nbsp;<span class="op" id="2382695">!=</span>&nbsp;<span class="builtintype" id="2382698">nil</span>&nbsp;<span class="op" id="2382702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2382706">gidf</span>&nbsp;<span class="op" id="2382711">:=</span>&nbsp;<span class="string" id="2382714">&#34;/proc/&#34;</span>&nbsp;<span class="op" id="2382723">+</span>&nbsp;<span class="ident" id="2382725">itoa</span><span class="op" id="2382729">(</span><span class="ident" id="2382730">pid</span><span class="op" id="2382733">)</span>&nbsp;<span class="op" id="2382735">+</span>&nbsp;<span class="string" id="2382737">&#34;/gid_map&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2382750">if</span>&nbsp;<span class="ident" id="2382753">err</span>&nbsp;<span class="op" id="2382757">:=</span>&nbsp;<span class="ident" id="2382760">writeIDMappings</span><span class="op" id="2382775">(</span><span class="ident" id="2382776">gidf</span><span class="op" id="2382780">,</span>&nbsp;<span class="ident" id="2382782">sys</span><span class="op" id="2382785">.</span><span class="ident" id="2382786">GidMappings</span><span class="op" id="2382797">)</span><span class="op" id="2382798">;</span>&nbsp;<span class="ident" id="2382800">err</span>&nbsp;<span class="op" id="2382804">!=</span>&nbsp;<span class="builtintype" id="2382807">nil</span>&nbsp;<span class="op" id="2382811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2382816">return</span>&nbsp;<span class="ident" id="2382823">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2382829">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2382832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2382836">return</span>&nbsp;<span class="builtintype" id="2382843">nil</span><br>
<span class="lineno"></span><span class="op" id="2382847">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
