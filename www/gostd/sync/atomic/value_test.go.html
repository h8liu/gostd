<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync/atomic</h2>
<ul>
<li><a href="/gostd/sync/atomic/atomic_test.go.html">atomic_test.go</a></li>
<li><a href="/gostd/sync/atomic/doc.go.html">doc.go</a></li>
<li><a href="/gostd/sync/atomic/value.go.html">value.go</a></li>
<li><a href="/gostd/sync/atomic/value_test.go.html" class="current">value_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1179493">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1179548">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1179602">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1179653">package</span>&nbsp;<span class="ident" id="1179661">atomic_test</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1179674">import</span>&nbsp;<span class="op" id="1179681">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1179684">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1179697">&#34;runtime&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1179708">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1179716">.</span>&nbsp;<span class="string" id="1179718">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1179733">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1179744">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="1179751">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="1179754">func</span>&nbsp;<span class="ident" id="1179759">TestValue</span><span class="op" id="1179768">(</span><span class="ident" id="1179769">t</span>&nbsp;<span class="op" id="1179771">*</span><span class="ident" id="1179772">testing</span><span class="op" id="1179779">.</span><span class="ident" id="1179780">T</span><span class="op" id="1179781">)</span>&nbsp;<span class="op" id="1179783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1179786">var</span>&nbsp;<span class="ident" id="1179790">v</span>&nbsp;<span class="ident" id="1179792">Value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1179799">if</span>&nbsp;<span class="ident" id="1179802">v</span><span class="op" id="1179803">.</span><span class="ident" id="1179804">Load</span><span class="op" id="1179808">(</span><span class="op" id="1179809">)</span>&nbsp;<span class="op" id="1179811">!=</span>&nbsp;<span class="builtintype" id="1179814">nil</span>&nbsp;<span class="op" id="1179818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1179822">t</span><span class="op" id="1179823">.</span><span class="ident" id="1179824">Fatal</span><span class="op" id="1179829">(</span><span class="string" id="1179830">&#34;initial&nbsp;Value&nbsp;is&nbsp;not&nbsp;nil&#34;</span><span class="op" id="1179856">)</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1179859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1179862">v</span><span class="op" id="1179863">.</span><span class="ident" id="1179864">Store</span><span class="op" id="1179869">(</span><span class="num" id="1179870">42</span><span class="op" id="1179872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1179875">x</span>&nbsp;<span class="op" id="1179877">:=</span>&nbsp;<span class="ident" id="1179880">v</span><span class="op" id="1179881">.</span><span class="ident" id="1179882">Load</span><span class="op" id="1179886">(</span><span class="op" id="1179887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1179890">if</span>&nbsp;<span class="ident" id="1179893">xx</span><span class="op" id="1179895">,</span>&nbsp;<span class="ident" id="1179897">ok</span>&nbsp;<span class="op" id="1179900">:=</span>&nbsp;<span class="ident" id="1179903">x</span><span class="op" id="1179904">.</span><span class="op" id="1179905">(</span><span class="builtintype" id="1179906">int</span><span class="op" id="1179909">)</span><span class="op" id="1179910">;</span>&nbsp;<span class="op" id="1179912">!</span><span class="ident" id="1179913">ok</span>&nbsp;<span class="op" id="1179916">||</span>&nbsp;<span class="ident" id="1179919">xx</span>&nbsp;<span class="op" id="1179922">!=</span>&nbsp;<span class="num" id="1179925">42</span>&nbsp;<span class="op" id="1179928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1179932">t</span><span class="op" id="1179933">.</span><span class="ident" id="1179934">Fatalf</span><span class="op" id="1179940">(</span><span class="string" id="1179941">&#34;wrong&nbsp;value:&nbsp;got&nbsp;%+v,&nbsp;want&nbsp;42&#34;</span><span class="op" id="1179972">,</span>&nbsp;<span class="ident" id="1179974">x</span><span class="op" id="1179975">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1179978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1179981">v</span><span class="op" id="1179982">.</span><span class="ident" id="1179983">Store</span><span class="op" id="1179988">(</span><span class="num" id="1179989">84</span><span class="op" id="1179991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1179994">x</span>&nbsp;<span class="op" id="1179996">=</span>&nbsp;<span class="ident" id="1179998">v</span><span class="op" id="1179999">.</span><span class="ident" id="1180000">Load</span><span class="op" id="1180004">(</span><span class="op" id="1180005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1180008">if</span>&nbsp;<span class="ident" id="1180011">xx</span><span class="op" id="1180013">,</span>&nbsp;<span class="ident" id="1180015">ok</span>&nbsp;<span class="op" id="1180018">:=</span>&nbsp;<span class="ident" id="1180021">x</span><span class="op" id="1180022">.</span><span class="op" id="1180023">(</span><span class="builtintype" id="1180024">int</span><span class="op" id="1180027">)</span><span class="op" id="1180028">;</span>&nbsp;<span class="op" id="1180030">!</span><span class="ident" id="1180031">ok</span>&nbsp;<span class="op" id="1180034">||</span>&nbsp;<span class="ident" id="1180037">xx</span>&nbsp;<span class="op" id="1180040">!=</span>&nbsp;<span class="num" id="1180043">84</span>&nbsp;<span class="op" id="1180046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1180050">t</span><span class="op" id="1180051">.</span><span class="ident" id="1180052">Fatalf</span><span class="op" id="1180058">(</span><span class="string" id="1180059">&#34;wrong&nbsp;value:&nbsp;got&nbsp;%+v,&nbsp;want&nbsp;84&#34;</span><span class="op" id="1180090">,</span>&nbsp;<span class="ident" id="1180092">x</span><span class="op" id="1180093">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1180096">}</span><br>
<span class="lineno"></span><span class="op" id="1180098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1180101">func</span>&nbsp;<span class="ident" id="1180106">TestValueLarge</span><span class="op" id="1180120">(</span><span class="ident" id="1180121">t</span>&nbsp;<span class="op" id="1180123">*</span><span class="ident" id="1180124">testing</span><span class="op" id="1180131">.</span><span class="ident" id="1180132">T</span><span class="op" id="1180133">)</span>&nbsp;<span class="op" id="1180135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1180138">var</span>&nbsp;<span class="ident" id="1180142">v</span>&nbsp;<span class="ident" id="1180144">Value</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1180151">v</span><span class="op" id="1180152">.</span><span class="ident" id="1180153">Store</span><span class="op" id="1180158">(</span><span class="string" id="1180159">&#34;foo&#34;</span><span class="op" id="1180164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1180167">x</span>&nbsp;<span class="op" id="1180169">:=</span>&nbsp;<span class="ident" id="1180172">v</span><span class="op" id="1180173">.</span><span class="ident" id="1180174">Load</span><span class="op" id="1180178">(</span><span class="op" id="1180179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1180182">if</span>&nbsp;<span class="ident" id="1180185">xx</span><span class="op" id="1180187">,</span>&nbsp;<span class="ident" id="1180189">ok</span>&nbsp;<span class="op" id="1180192">:=</span>&nbsp;<span class="ident" id="1180195">x</span><span class="op" id="1180196">.</span><span class="op" id="1180197">(</span><span class="builtintype" id="1180198">string</span><span class="op" id="1180204">)</span><span class="op" id="1180205">;</span>&nbsp;<span class="op" id="1180207">!</span><span class="ident" id="1180208">ok</span>&nbsp;<span class="op" id="1180211">||</span>&nbsp;<span class="ident" id="1180214">xx</span>&nbsp;<span class="op" id="1180217">!=</span>&nbsp;<span class="string" id="1180220">&#34;foo&#34;</span>&nbsp;<span class="op" id="1180226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1180230">t</span><span class="op" id="1180231">.</span><span class="ident" id="1180232">Fatalf</span><span class="op" id="1180238">(</span><span class="string" id="1180239">&#34;wrong&nbsp;value:&nbsp;got&nbsp;%+v,&nbsp;want&nbsp;foo&#34;</span><span class="op" id="1180271">,</span>&nbsp;<span class="ident" id="1180273">x</span><span class="op" id="1180274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1180277">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1180280">v</span><span class="op" id="1180281">.</span><span class="ident" id="1180282">Store</span><span class="op" id="1180287">(</span><span class="string" id="1180288">&#34;barbaz&#34;</span><span class="op" id="1180296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1180299">x</span>&nbsp;<span class="op" id="1180301">=</span>&nbsp;<span class="ident" id="1180303">v</span><span class="op" id="1180304">.</span><span class="ident" id="1180305">Load</span><span class="op" id="1180309">(</span><span class="op" id="1180310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1180313">if</span>&nbsp;<span class="ident" id="1180316">xx</span><span class="op" id="1180318">,</span>&nbsp;<span class="ident" id="1180320">ok</span>&nbsp;<span class="op" id="1180323">:=</span>&nbsp;<span class="ident" id="1180326">x</span><span class="op" id="1180327">.</span><span class="op" id="1180328">(</span><span class="builtintype" id="1180329">string</span><span class="op" id="1180335">)</span><span class="op" id="1180336">;</span>&nbsp;<span class="op" id="1180338">!</span><span class="ident" id="1180339">ok</span>&nbsp;<span class="op" id="1180342">||</span>&nbsp;<span class="ident" id="1180345">xx</span>&nbsp;<span class="op" id="1180348">!=</span>&nbsp;<span class="string" id="1180351">&#34;barbaz&#34;</span>&nbsp;<span class="op" id="1180360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1180364">t</span><span class="op" id="1180365">.</span><span class="ident" id="1180366">Fatalf</span><span class="op" id="1180372">(</span><span class="string" id="1180373">&#34;wrong&nbsp;value:&nbsp;got&nbsp;%+v,&nbsp;want&nbsp;barbaz&#34;</span><span class="op" id="1180408">,</span>&nbsp;<span class="ident" id="1180410">x</span><span class="op" id="1180411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1180414">}</span><br>
<span class="lineno">45</span><span class="op" id="1180416">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1180419">func</span>&nbsp;<span class="ident" id="1180424">TestValuePanic</span><span class="op" id="1180438">(</span><span class="ident" id="1180439">t</span>&nbsp;<span class="op" id="1180441">*</span><span class="ident" id="1180442">testing</span><span class="op" id="1180449">.</span><span class="ident" id="1180450">T</span><span class="op" id="1180451">)</span>&nbsp;<span class="op" id="1180453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1180456">const</span>&nbsp;<span class="ident" id="1180462">nilErr</span>&nbsp;<span class="op" id="1180469">=</span>&nbsp;<span class="string" id="1180471">&#34;sync/atomic:&nbsp;store&nbsp;of&nbsp;nil&nbsp;value&nbsp;into&nbsp;Value&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1180517">const</span>&nbsp;<span class="ident" id="1180523">badErr</span>&nbsp;<span class="op" id="1180530">=</span>&nbsp;<span class="string" id="1180532">&#34;sync/atomic:&nbsp;store&nbsp;of&nbsp;inconsistently&nbsp;typed&nbsp;value&nbsp;into&nbsp;Value&#34;</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1180595">var</span>&nbsp;<span class="ident" id="1180599">v</span>&nbsp;<span class="ident" id="1180601">Value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1180608">func</span><span class="op" id="1180612">(</span><span class="op" id="1180613">)</span>&nbsp;<span class="op" id="1180615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1180619">defer</span>&nbsp;<span class="keyword" id="1180625">func</span><span class="op" id="1180629">(</span><span class="op" id="1180630">)</span>&nbsp;<span class="op" id="1180632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1180637">err</span>&nbsp;<span class="op" id="1180641">:=</span>&nbsp;<span class="builtinfunc" id="1180644">recover</span><span class="op" id="1180651">(</span><span class="op" id="1180652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1180657">if</span>&nbsp;<span class="ident" id="1180660">err</span>&nbsp;<span class="op" id="1180664">!=</span>&nbsp;<span class="ident" id="1180667">nilErr</span>&nbsp;<span class="op" id="1180674">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1180680">t</span><span class="op" id="1180681">.</span><span class="ident" id="1180682">Fatalf</span><span class="op" id="1180688">(</span><span class="string" id="1180689">&#34;inconsistent&nbsp;store&nbsp;panic:&nbsp;got&nbsp;&#39;%v&#39;,&nbsp;want&nbsp;&#39;%v&#39;&#34;</span><span class="op" id="1180736">,</span>&nbsp;<span class="ident" id="1180738">err</span><span class="op" id="1180741">,</span>&nbsp;<span class="ident" id="1180743">nilErr</span><span class="op" id="1180749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1180754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1180758">}</span><span class="op" id="1180759">(</span><span class="op" id="1180760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1180764">v</span><span class="op" id="1180765">.</span><span class="ident" id="1180766">Store</span><span class="op" id="1180771">(</span><span class="builtintype" id="1180772">nil</span><span class="op" id="1180775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1180778">}</span><span class="op" id="1180779">(</span><span class="op" id="1180780">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1180783">v</span><span class="op" id="1180784">.</span><span class="ident" id="1180785">Store</span><span class="op" id="1180790">(</span><span class="num" id="1180791">42</span><span class="op" id="1180793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1180796">func</span><span class="op" id="1180800">(</span><span class="op" id="1180801">)</span>&nbsp;<span class="op" id="1180803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1180807">defer</span>&nbsp;<span class="keyword" id="1180813">func</span><span class="op" id="1180817">(</span><span class="op" id="1180818">)</span>&nbsp;<span class="op" id="1180820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1180825">err</span>&nbsp;<span class="op" id="1180829">:=</span>&nbsp;<span class="builtinfunc" id="1180832">recover</span><span class="op" id="1180839">(</span><span class="op" id="1180840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1180845">if</span>&nbsp;<span class="ident" id="1180848">err</span>&nbsp;<span class="op" id="1180852">!=</span>&nbsp;<span class="ident" id="1180855">badErr</span>&nbsp;<span class="op" id="1180862">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1180868">t</span><span class="op" id="1180869">.</span><span class="ident" id="1180870">Fatalf</span><span class="op" id="1180876">(</span><span class="string" id="1180877">&#34;inconsistent&nbsp;store&nbsp;panic:&nbsp;got&nbsp;&#39;%v&#39;,&nbsp;want&nbsp;&#39;%v&#39;&#34;</span><span class="op" id="1180924">,</span>&nbsp;<span class="ident" id="1180926">err</span><span class="op" id="1180929">,</span>&nbsp;<span class="ident" id="1180931">badErr</span><span class="op" id="1180937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1180942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1180946">}</span><span class="op" id="1180947">(</span><span class="op" id="1180948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1180952">v</span><span class="op" id="1180953">.</span><span class="ident" id="1180954">Store</span><span class="op" id="1180959">(</span><span class="string" id="1180960">&#34;foo&#34;</span><span class="op" id="1180965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1180968">}</span><span class="op" id="1180969">(</span><span class="op" id="1180970">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1180973">func</span><span class="op" id="1180977">(</span><span class="op" id="1180978">)</span>&nbsp;<span class="op" id="1180980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1180984">defer</span>&nbsp;<span class="keyword" id="1180990">func</span><span class="op" id="1180994">(</span><span class="op" id="1180995">)</span>&nbsp;<span class="op" id="1180997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1181002">err</span>&nbsp;<span class="op" id="1181006">:=</span>&nbsp;<span class="builtinfunc" id="1181009">recover</span><span class="op" id="1181016">(</span><span class="op" id="1181017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1181022">if</span>&nbsp;<span class="ident" id="1181025">err</span>&nbsp;<span class="op" id="1181029">!=</span>&nbsp;<span class="ident" id="1181032">nilErr</span>&nbsp;<span class="op" id="1181039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1181045">t</span><span class="op" id="1181046">.</span><span class="ident" id="1181047">Fatalf</span><span class="op" id="1181053">(</span><span class="string" id="1181054">&#34;inconsistent&nbsp;store&nbsp;panic:&nbsp;got&nbsp;&#39;%v&#39;,&nbsp;want&nbsp;&#39;%v&#39;&#34;</span><span class="op" id="1181101">,</span>&nbsp;<span class="ident" id="1181103">err</span><span class="op" id="1181106">,</span>&nbsp;<span class="ident" id="1181108">nilErr</span><span class="op" id="1181114">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1181119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1181123">}</span><span class="op" id="1181124">(</span><span class="op" id="1181125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1181129">v</span><span class="op" id="1181130">.</span><span class="ident" id="1181131">Store</span><span class="op" id="1181136">(</span><span class="builtintype" id="1181137">nil</span><span class="op" id="1181140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1181143">}</span><span class="op" id="1181144">(</span><span class="op" id="1181145">)</span><br>
<span class="lineno"></span><span class="op" id="1181147">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="1181150">func</span>&nbsp;<span class="ident" id="1181155">TestValueConcurrent</span><span class="op" id="1181174">(</span><span class="ident" id="1181175">t</span>&nbsp;<span class="op" id="1181177">*</span><span class="ident" id="1181178">testing</span><span class="op" id="1181185">.</span><span class="ident" id="1181186">T</span><span class="op" id="1181187">)</span>&nbsp;<span class="op" id="1181189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1181192">tests</span>&nbsp;<span class="op" id="1181198">:=</span>&nbsp;<span class="op" id="1181201">[</span><span class="op" id="1181202">]</span><span class="op" id="1181203">[</span><span class="op" id="1181204">]</span><span class="keyword" id="1181205">interface</span><span class="op" id="1181214">{</span><span class="op" id="1181215">}</span><span class="op" id="1181216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1181220">{</span><span class="builtintype" id="1181221">uint16</span><span class="op" id="1181227">(</span><span class="num" id="1181228">0</span><span class="op" id="1181229">)</span><span class="op" id="1181230">,</span>&nbsp;<span class="op" id="1181232">^</span><span class="builtintype" id="1181233">uint16</span><span class="op" id="1181239">(</span><span class="num" id="1181240">0</span><span class="op" id="1181241">)</span><span class="op" id="1181242">,</span>&nbsp;<span class="builtintype" id="1181244">uint16</span><span class="op" id="1181250">(</span><span class="num" id="1181251">1</span>&nbsp;<span class="op" id="1181253">+</span>&nbsp;<span class="num" id="1181255">2</span><span class="op" id="1181256">&lt;&lt;</span><span class="num" id="1181258">8</span><span class="op" id="1181259">)</span><span class="op" id="1181260">,</span>&nbsp;<span class="builtintype" id="1181262">uint16</span><span class="op" id="1181268">(</span><span class="num" id="1181269">3</span>&nbsp;<span class="op" id="1181271">+</span>&nbsp;<span class="num" id="1181273">4</span><span class="op" id="1181274">&lt;&lt;</span><span class="num" id="1181276">8</span><span class="op" id="1181277">)</span><span class="op" id="1181278">}</span><span class="op" id="1181279">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1181283">{</span><span class="builtintype" id="1181284">uint32</span><span class="op" id="1181290">(</span><span class="num" id="1181291">0</span><span class="op" id="1181292">)</span><span class="op" id="1181293">,</span>&nbsp;<span class="op" id="1181295">^</span><span class="builtintype" id="1181296">uint32</span><span class="op" id="1181302">(</span><span class="num" id="1181303">0</span><span class="op" id="1181304">)</span><span class="op" id="1181305">,</span>&nbsp;<span class="builtintype" id="1181307">uint32</span><span class="op" id="1181313">(</span><span class="num" id="1181314">1</span>&nbsp;<span class="op" id="1181316">+</span>&nbsp;<span class="num" id="1181318">2</span><span class="op" id="1181319">&lt;&lt;</span><span class="num" id="1181321">16</span><span class="op" id="1181323">)</span><span class="op" id="1181324">,</span>&nbsp;<span class="builtintype" id="1181326">uint32</span><span class="op" id="1181332">(</span><span class="num" id="1181333">3</span>&nbsp;<span class="op" id="1181335">+</span>&nbsp;<span class="num" id="1181337">4</span><span class="op" id="1181338">&lt;&lt;</span><span class="num" id="1181340">16</span><span class="op" id="1181342">)</span><span class="op" id="1181343">}</span><span class="op" id="1181344">,</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1181348">{</span><span class="builtintype" id="1181349">uint64</span><span class="op" id="1181355">(</span><span class="num" id="1181356">0</span><span class="op" id="1181357">)</span><span class="op" id="1181358">,</span>&nbsp;<span class="op" id="1181360">^</span><span class="builtintype" id="1181361">uint64</span><span class="op" id="1181367">(</span><span class="num" id="1181368">0</span><span class="op" id="1181369">)</span><span class="op" id="1181370">,</span>&nbsp;<span class="builtintype" id="1181372">uint64</span><span class="op" id="1181378">(</span><span class="num" id="1181379">1</span>&nbsp;<span class="op" id="1181381">+</span>&nbsp;<span class="num" id="1181383">2</span><span class="op" id="1181384">&lt;&lt;</span><span class="num" id="1181386">32</span><span class="op" id="1181388">)</span><span class="op" id="1181389">,</span>&nbsp;<span class="builtintype" id="1181391">uint64</span><span class="op" id="1181397">(</span><span class="num" id="1181398">3</span>&nbsp;<span class="op" id="1181400">+</span>&nbsp;<span class="num" id="1181402">4</span><span class="op" id="1181403">&lt;&lt;</span><span class="num" id="1181405">32</span><span class="op" id="1181407">)</span><span class="op" id="1181408">}</span><span class="op" id="1181409">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1181413">{</span><span class="builtinfunc" id="1181414">complex</span><span class="op" id="1181421">(</span><span class="num" id="1181422">0</span><span class="op" id="1181423">,</span>&nbsp;<span class="num" id="1181425">0</span><span class="op" id="1181426">)</span><span class="op" id="1181427">,</span>&nbsp;<span class="builtinfunc" id="1181429">complex</span><span class="op" id="1181436">(</span><span class="num" id="1181437">1</span><span class="op" id="1181438">,</span>&nbsp;<span class="num" id="1181440">2</span><span class="op" id="1181441">)</span><span class="op" id="1181442">,</span>&nbsp;<span class="builtinfunc" id="1181444">complex</span><span class="op" id="1181451">(</span><span class="num" id="1181452">3</span><span class="op" id="1181453">,</span>&nbsp;<span class="num" id="1181455">4</span><span class="op" id="1181456">)</span><span class="op" id="1181457">,</span>&nbsp;<span class="builtinfunc" id="1181459">complex</span><span class="op" id="1181466">(</span><span class="num" id="1181467">5</span><span class="op" id="1181468">,</span>&nbsp;<span class="num" id="1181470">6</span><span class="op" id="1181471">)</span><span class="op" id="1181472">}</span><span class="op" id="1181473">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1181476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1181479">p</span>&nbsp;<span class="op" id="1181481">:=</span>&nbsp;<span class="num" id="1181484">4</span>&nbsp;<span class="op" id="1181486">*</span>&nbsp;<span class="ident" id="1181488">runtime</span><span class="op" id="1181495">.</span><span class="ident" id="1181496">GOMAXPROCS</span><span class="op" id="1181506">(</span><span class="num" id="1181507">0</span><span class="op" id="1181508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1181511">for</span>&nbsp;<span class="ident" id="1181515">_</span><span class="op" id="1181516">,</span>&nbsp;<span class="ident" id="1181518">test</span>&nbsp;<span class="op" id="1181523">:=</span>&nbsp;<span class="keyword" id="1181526">range</span>&nbsp;<span class="ident" id="1181532">tests</span>&nbsp;<span class="op" id="1181538">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1181542">var</span>&nbsp;<span class="ident" id="1181546">v</span>&nbsp;<span class="ident" id="1181548">Value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1181556">done</span>&nbsp;<span class="op" id="1181561">:=</span>&nbsp;<span class="builtinfunc" id="1181564">make</span><span class="op" id="1181568">(</span><span class="keyword" id="1181569">chan</span>&nbsp;<span class="builtintype" id="1181574">bool</span><span class="op" id="1181578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1181582">for</span>&nbsp;<span class="ident" id="1181586">i</span>&nbsp;<span class="op" id="1181588">:=</span>&nbsp;<span class="num" id="1181591">0</span><span class="op" id="1181592">;</span>&nbsp;<span class="ident" id="1181594">i</span>&nbsp;<span class="op" id="1181596">&lt;</span>&nbsp;<span class="ident" id="1181598">p</span><span class="op" id="1181599">;</span>&nbsp;<span class="ident" id="1181601">i</span><span class="op" id="1181602">++</span>&nbsp;<span class="op" id="1181605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1181610">go</span>&nbsp;<span class="keyword" id="1181613">func</span><span class="op" id="1181617">(</span><span class="op" id="1181618">)</span>&nbsp;<span class="op" id="1181620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1181626">r</span>&nbsp;<span class="op" id="1181628">:=</span>&nbsp;<span class="ident" id="1181631">rand</span><span class="op" id="1181635">.</span><span class="ident" id="1181636">New</span><span class="op" id="1181639">(</span><span class="ident" id="1181640">rand</span><span class="op" id="1181644">.</span><span class="ident" id="1181645">NewSource</span><span class="op" id="1181654">(</span><span class="ident" id="1181655">rand</span><span class="op" id="1181659">.</span><span class="ident" id="1181660">Int63</span><span class="op" id="1181665">(</span><span class="op" id="1181666">)</span><span class="op" id="1181667">)</span><span class="op" id="1181668">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1181673">loop</span><span class="op" id="1181677">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1181683">for</span>&nbsp;<span class="ident" id="1181687">j</span>&nbsp;<span class="op" id="1181689">:=</span>&nbsp;<span class="num" id="1181692">0</span><span class="op" id="1181693">;</span>&nbsp;<span class="ident" id="1181695">j</span>&nbsp;<span class="op" id="1181697">&lt;</span>&nbsp;<span class="num" id="1181699">1e5</span><span class="op" id="1181702">;</span>&nbsp;<span class="ident" id="1181704">j</span><span class="op" id="1181705">++</span>&nbsp;<span class="op" id="1181708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1181715">x</span>&nbsp;<span class="op" id="1181717">:=</span>&nbsp;<span class="ident" id="1181720">test</span><span class="op" id="1181724">[</span><span class="ident" id="1181725">r</span><span class="op" id="1181726">.</span><span class="ident" id="1181727">Intn</span><span class="op" id="1181731">(</span><span class="builtinfunc" id="1181732">len</span><span class="op" id="1181735">(</span><span class="ident" id="1181736">test</span><span class="op" id="1181740">)</span><span class="op" id="1181741">)</span><span class="op" id="1181742">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1181749">v</span><span class="op" id="1181750">.</span><span class="ident" id="1181751">Store</span><span class="op" id="1181756">(</span><span class="ident" id="1181757">x</span><span class="op" id="1181758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1181765">x</span>&nbsp;<span class="op" id="1181767">=</span>&nbsp;<span class="ident" id="1181769">v</span><span class="op" id="1181770">.</span><span class="ident" id="1181771">Load</span><span class="op" id="1181775">(</span><span class="op" id="1181776">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1181783">for</span>&nbsp;<span class="ident" id="1181787">_</span><span class="op" id="1181788">,</span>&nbsp;<span class="ident" id="1181790">x1</span>&nbsp;<span class="op" id="1181793">:=</span>&nbsp;<span class="keyword" id="1181796">range</span>&nbsp;<span class="ident" id="1181802">test</span>&nbsp;<span class="op" id="1181807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1181815">if</span>&nbsp;<span class="ident" id="1181818">x</span>&nbsp;<span class="op" id="1181820">==</span>&nbsp;<span class="ident" id="1181823">x1</span>&nbsp;<span class="op" id="1181826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1181835">continue</span>&nbsp;<span class="ident" id="1181844">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1181855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1181862">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1181869">t</span><span class="op" id="1181870">.</span><span class="ident" id="1181871">Logf</span><span class="op" id="1181875">(</span><span class="string" id="1181876">&#34;loaded&nbsp;unexpected&nbsp;value&nbsp;%+v,&nbsp;want&nbsp;%+v&#34;</span><span class="op" id="1181915">,</span>&nbsp;<span class="ident" id="1181917">x</span><span class="op" id="1181918">,</span>&nbsp;<span class="ident" id="1181920">test</span><span class="op" id="1181924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1181931">done</span>&nbsp;<span class="op" id="1181936">&lt;-</span>&nbsp;<span class="builtintype" id="1181939">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1181949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1181955">done</span>&nbsp;<span class="op" id="1181960">&lt;-</span>&nbsp;<span class="builtintype" id="1181963">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1181971">}</span><span class="op" id="1181972">(</span><span class="op" id="1181973">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1181977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1181981">for</span>&nbsp;<span class="ident" id="1181985">i</span>&nbsp;<span class="op" id="1181987">:=</span>&nbsp;<span class="num" id="1181990">0</span><span class="op" id="1181991">;</span>&nbsp;<span class="ident" id="1181993">i</span>&nbsp;<span class="op" id="1181995">&lt;</span>&nbsp;<span class="ident" id="1181997">p</span><span class="op" id="1181998">;</span>&nbsp;<span class="ident" id="1182000">i</span><span class="op" id="1182001">++</span>&nbsp;<span class="op" id="1182004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1182009">if</span>&nbsp;<span class="op" id="1182012">!</span><span class="op" id="1182013">&lt;-</span><span class="ident" id="1182015">done</span>&nbsp;<span class="op" id="1182020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1182026">t</span><span class="op" id="1182027">.</span><span class="ident" id="1182028">FailNow</span><span class="op" id="1182035">(</span><span class="op" id="1182036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1182041">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1182045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1182048">}</span><br>
<span class="lineno"></span><span class="op" id="1182050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1182053">func</span>&nbsp;<span class="ident" id="1182058">BenchmarkValueRead</span><span class="op" id="1182076">(</span><span class="ident" id="1182077">b</span>&nbsp;<span class="op" id="1182079">*</span><span class="ident" id="1182080">testing</span><span class="op" id="1182087">.</span><span class="ident" id="1182088">B</span><span class="op" id="1182089">)</span>&nbsp;<span class="op" id="1182091">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1182094">var</span>&nbsp;<span class="ident" id="1182098">v</span>&nbsp;<span class="ident" id="1182100">Value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1182107">v</span><span class="op" id="1182108">.</span><span class="ident" id="1182109">Store</span><span class="op" id="1182114">(</span><span class="builtinfunc" id="1182115">new</span><span class="op" id="1182118">(</span><span class="builtintype" id="1182119">int</span><span class="op" id="1182122">)</span><span class="op" id="1182123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1182126">b</span><span class="op" id="1182127">.</span><span class="ident" id="1182128">RunParallel</span><span class="op" id="1182139">(</span><span class="keyword" id="1182140">func</span><span class="op" id="1182144">(</span><span class="ident" id="1182145">pb</span>&nbsp;<span class="op" id="1182148">*</span><span class="ident" id="1182149">testing</span><span class="op" id="1182156">.</span><span class="ident" id="1182157">PB</span><span class="op" id="1182159">)</span>&nbsp;<span class="op" id="1182161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1182165">for</span>&nbsp;<span class="ident" id="1182169">pb</span><span class="op" id="1182171">.</span><span class="ident" id="1182172">Next</span><span class="op" id="1182176">(</span><span class="op" id="1182177">)</span>&nbsp;<span class="op" id="1182179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1182184">x</span>&nbsp;<span class="op" id="1182186">:=</span>&nbsp;<span class="ident" id="1182189">v</span><span class="op" id="1182190">.</span><span class="ident" id="1182191">Load</span><span class="op" id="1182195">(</span><span class="op" id="1182196">)</span><span class="op" id="1182197">.</span><span class="op" id="1182198">(</span><span class="op" id="1182199">*</span><span class="builtintype" id="1182200">int</span><span class="op" id="1182203">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1182208">if</span>&nbsp;<span class="op" id="1182211">*</span><span class="ident" id="1182212">x</span>&nbsp;<span class="op" id="1182214">!=</span>&nbsp;<span class="num" id="1182217">0</span>&nbsp;<span class="op" id="1182219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1182225">b</span><span class="op" id="1182226">.</span><span class="ident" id="1182227">Fatalf</span><span class="op" id="1182233">(</span><span class="string" id="1182234">&#34;wrong&nbsp;value:&nbsp;got&nbsp;%v,&nbsp;want&nbsp;0&#34;</span><span class="op" id="1182263">,</span>&nbsp;<span class="op" id="1182265">*</span><span class="ident" id="1182266">x</span><span class="op" id="1182267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1182272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1182276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1182279">}</span><span class="op" id="1182280">)</span><br>
<span class="lineno">130</span><span class="op" id="1182282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1182285">//&nbsp;The&nbsp;following&nbsp;example&nbsp;shows&nbsp;how&nbsp;to&nbsp;use&nbsp;Value&nbsp;for&nbsp;periodic&nbsp;program&nbsp;config&nbsp;updates</span><br>
<span class="lineno"></span><span class="comment" id="1182369">//&nbsp;and&nbsp;propagation&nbsp;of&nbsp;the&nbsp;changes&nbsp;to&nbsp;worker&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="1182425">func</span>&nbsp;<span class="ident" id="1182430">ExampleValue_config</span><span class="op" id="1182449">(</span><span class="op" id="1182450">)</span>&nbsp;<span class="op" id="1182452">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1182455">var</span>&nbsp;<span class="ident" id="1182459">config</span>&nbsp;<span class="ident" id="1182466">Value</span>&nbsp;<span class="comment" id="1182472">//&nbsp;holds&nbsp;current&nbsp;server&nbsp;configuration</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1182511">//&nbsp;Create&nbsp;initial&nbsp;config&nbsp;value&nbsp;and&nbsp;store&nbsp;into&nbsp;config.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1182566">config</span><span class="op" id="1182572">.</span><span class="ident" id="1182573">Store</span><span class="op" id="1182578">(</span><span class="ident" id="1182579">loadConfig</span><span class="op" id="1182589">(</span><span class="op" id="1182590">)</span><span class="op" id="1182591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1182594">go</span>&nbsp;<span class="keyword" id="1182597">func</span><span class="op" id="1182601">(</span><span class="op" id="1182602">)</span>&nbsp;<span class="op" id="1182604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1182608">//&nbsp;Reload&nbsp;config&nbsp;every&nbsp;10&nbsp;seconds</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1182644">//&nbsp;and&nbsp;update&nbsp;config&nbsp;value&nbsp;with&nbsp;the&nbsp;new&nbsp;version.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1182695">for</span>&nbsp;<span class="op" id="1182699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1182704">time</span><span class="op" id="1182708">.</span><span class="ident" id="1182709">Sleep</span><span class="op" id="1182714">(</span><span class="num" id="1182715">10</span>&nbsp;<span class="op" id="1182718">*</span>&nbsp;<span class="ident" id="1182720">time</span><span class="op" id="1182724">.</span><span class="ident" id="1182725">Second</span><span class="op" id="1182731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1182736">config</span><span class="op" id="1182742">.</span><span class="ident" id="1182743">Store</span><span class="op" id="1182748">(</span><span class="ident" id="1182749">loadConfig</span><span class="op" id="1182759">(</span><span class="op" id="1182760">)</span><span class="op" id="1182761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1182765">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1182768">}</span><span class="op" id="1182769">(</span><span class="op" id="1182770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1182773">//&nbsp;Create&nbsp;worker&nbsp;goroutines&nbsp;that&nbsp;handle&nbsp;incoming&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1182832">//&nbsp;using&nbsp;the&nbsp;latest&nbsp;config&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1182867">for</span>&nbsp;<span class="ident" id="1182871">i</span>&nbsp;<span class="op" id="1182873">:=</span>&nbsp;<span class="num" id="1182876">0</span><span class="op" id="1182877">;</span>&nbsp;<span class="ident" id="1182879">i</span>&nbsp;<span class="op" id="1182881">&lt;</span>&nbsp;<span class="num" id="1182883">10</span><span class="op" id="1182885">;</span>&nbsp;<span class="ident" id="1182887">i</span><span class="op" id="1182888">++</span>&nbsp;<span class="op" id="1182891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1182895">go</span>&nbsp;<span class="keyword" id="1182898">func</span><span class="op" id="1182902">(</span><span class="op" id="1182903">)</span>&nbsp;<span class="op" id="1182905">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1182910">for</span>&nbsp;<span class="ident" id="1182914">r</span>&nbsp;<span class="op" id="1182916">:=</span>&nbsp;<span class="keyword" id="1182919">range</span>&nbsp;<span class="ident" id="1182925">requests</span><span class="op" id="1182933">(</span><span class="op" id="1182934">)</span>&nbsp;<span class="op" id="1182936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1182942">c</span>&nbsp;<span class="op" id="1182944">:=</span>&nbsp;<span class="ident" id="1182947">config</span><span class="op" id="1182953">.</span><span class="ident" id="1182954">Load</span><span class="op" id="1182958">(</span><span class="op" id="1182959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1182965">//&nbsp;Handle&nbsp;request&nbsp;r&nbsp;using&nbsp;config&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1183005">_</span><span class="op" id="1183006">,</span>&nbsp;<span class="ident" id="1183008">_</span>&nbsp;<span class="op" id="1183010">=</span>&nbsp;<span class="ident" id="1183012">r</span><span class="op" id="1183013">,</span>&nbsp;<span class="ident" id="1183015">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1183020">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1183024">}</span><span class="op" id="1183025">(</span><span class="op" id="1183026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1183029">}</span><br>
<span class="lineno"></span><span class="op" id="1183031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1183034">func</span>&nbsp;<span class="ident" id="1183039">loadConfig</span><span class="op" id="1183049">(</span><span class="op" id="1183050">)</span>&nbsp;<span class="keyword" id="1183052">map</span><span class="op" id="1183055">[</span><span class="builtintype" id="1183056">string</span><span class="op" id="1183062">]</span><span class="builtintype" id="1183063">string</span>&nbsp;<span class="op" id="1183070">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1183073">return</span>&nbsp;<span class="builtinfunc" id="1183080">make</span><span class="op" id="1183084">(</span><span class="keyword" id="1183085">map</span><span class="op" id="1183088">[</span><span class="builtintype" id="1183089">string</span><span class="op" id="1183095">]</span><span class="builtintype" id="1183096">string</span><span class="op" id="1183102">)</span><br>
<span class="lineno"></span><span class="op" id="1183104">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1183107">func</span>&nbsp;<span class="ident" id="1183112">requests</span><span class="op" id="1183120">(</span><span class="op" id="1183121">)</span>&nbsp;<span class="keyword" id="1183123">chan</span>&nbsp;<span class="builtintype" id="1183128">int</span>&nbsp;<span class="op" id="1183132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1183135">return</span>&nbsp;<span class="builtinfunc" id="1183142">make</span><span class="op" id="1183146">(</span><span class="keyword" id="1183147">chan</span>&nbsp;<span class="builtintype" id="1183152">int</span><span class="op" id="1183155">)</span><br>
<span class="lineno">165</span><span class="op" id="1183157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1183160">//&nbsp;The&nbsp;following&nbsp;example&nbsp;shows&nbsp;how&nbsp;to&nbsp;maintain&nbsp;a&nbsp;scalable&nbsp;frequently&nbsp;read,</span><br>
<span class="lineno"></span><span class="comment" id="1183235">//&nbsp;but&nbsp;infrequently&nbsp;updated&nbsp;data&nbsp;structure&nbsp;using&nbsp;copy-on-write&nbsp;idiom.</span><br>
<span class="lineno"></span><span class="keyword" id="1183305">func</span>&nbsp;<span class="ident" id="1183310">ExampleValue_readMostly</span><span class="op" id="1183333">(</span><span class="op" id="1183334">)</span>&nbsp;<span class="op" id="1183336">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1183339">type</span>&nbsp;<span class="ident" id="1183344">Map</span>&nbsp;<span class="keyword" id="1183348">map</span><span class="op" id="1183351">[</span><span class="builtintype" id="1183352">string</span><span class="op" id="1183358">]</span><span class="builtintype" id="1183359">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1183367">var</span>&nbsp;<span class="ident" id="1183371">m</span>&nbsp;<span class="ident" id="1183373">Value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1183380">m</span><span class="op" id="1183381">.</span><span class="ident" id="1183382">Store</span><span class="op" id="1183387">(</span><span class="builtinfunc" id="1183388">make</span><span class="op" id="1183392">(</span><span class="ident" id="1183393">Map</span><span class="op" id="1183396">)</span><span class="op" id="1183397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1183400">var</span>&nbsp;<span class="ident" id="1183404">mu</span>&nbsp;<span class="ident" id="1183407">sync</span><span class="op" id="1183411">.</span><span class="ident" id="1183412">Mutex</span>&nbsp;<span class="comment" id="1183418">//&nbsp;used&nbsp;only&nbsp;by&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1183443">//&nbsp;read&nbsp;function&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;read&nbsp;the&nbsp;data&nbsp;without&nbsp;further&nbsp;synchronization</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1183522">read</span>&nbsp;<span class="op" id="1183527">:=</span>&nbsp;<span class="keyword" id="1183530">func</span><span class="op" id="1183534">(</span><span class="ident" id="1183535">key</span>&nbsp;<span class="builtintype" id="1183539">string</span><span class="op" id="1183545">)</span>&nbsp;<span class="op" id="1183547">(</span><span class="ident" id="1183548">val</span>&nbsp;<span class="builtintype" id="1183552">string</span><span class="op" id="1183558">)</span>&nbsp;<span class="op" id="1183560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1183564">m1</span>&nbsp;<span class="op" id="1183567">:=</span>&nbsp;<span class="ident" id="1183570">m</span><span class="op" id="1183571">.</span><span class="ident" id="1183572">Load</span><span class="op" id="1183576">(</span><span class="op" id="1183577">)</span><span class="op" id="1183578">.</span><span class="op" id="1183579">(</span><span class="ident" id="1183580">Map</span><span class="op" id="1183583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1183587">return</span>&nbsp;<span class="ident" id="1183594">m1</span><span class="op" id="1183596">[</span><span class="ident" id="1183597">key</span><span class="op" id="1183600">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1183603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1183606">//&nbsp;insert&nbsp;function&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;update&nbsp;the&nbsp;data&nbsp;without&nbsp;further&nbsp;synchronization</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1183689">insert</span>&nbsp;<span class="op" id="1183696">:=</span>&nbsp;<span class="keyword" id="1183699">func</span><span class="op" id="1183703">(</span><span class="ident" id="1183704">key</span><span class="op" id="1183707">,</span>&nbsp;<span class="ident" id="1183709">val</span>&nbsp;<span class="builtintype" id="1183713">string</span><span class="op" id="1183719">)</span>&nbsp;<span class="op" id="1183721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1183725">mu</span><span class="op" id="1183727">.</span><span class="ident" id="1183728">Lock</span><span class="op" id="1183732">(</span><span class="op" id="1183733">)</span>&nbsp;<span class="comment" id="1183735">//&nbsp;synchronize&nbsp;with&nbsp;other&nbsp;potential&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1183781">defer</span>&nbsp;<span class="ident" id="1183787">mu</span><span class="op" id="1183789">.</span><span class="ident" id="1183790">Unlock</span><span class="op" id="1183796">(</span><span class="op" id="1183797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1183801">m1</span>&nbsp;<span class="op" id="1183804">:=</span>&nbsp;<span class="ident" id="1183807">m</span><span class="op" id="1183808">.</span><span class="ident" id="1183809">Load</span><span class="op" id="1183813">(</span><span class="op" id="1183814">)</span><span class="op" id="1183815">.</span><span class="op" id="1183816">(</span><span class="ident" id="1183817">Map</span><span class="op" id="1183820">)</span>&nbsp;<span class="comment" id="1183822">//&nbsp;load&nbsp;current&nbsp;value&nbsp;of&nbsp;the&nbsp;data&nbsp;structure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1183868">m2</span>&nbsp;<span class="op" id="1183871">:=</span>&nbsp;<span class="builtinfunc" id="1183874">make</span><span class="op" id="1183878">(</span><span class="ident" id="1183879">Map</span><span class="op" id="1183882">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1183889">//&nbsp;create&nbsp;a&nbsp;new&nbsp;value</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1183913">for</span>&nbsp;<span class="ident" id="1183917">k</span><span class="op" id="1183918">,</span>&nbsp;<span class="ident" id="1183920">v</span>&nbsp;<span class="op" id="1183922">:=</span>&nbsp;<span class="keyword" id="1183925">range</span>&nbsp;<span class="ident" id="1183931">m1</span>&nbsp;<span class="op" id="1183934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1183939">m2</span><span class="op" id="1183941">[</span><span class="ident" id="1183942">k</span><span class="op" id="1183943">]</span>&nbsp;<span class="op" id="1183945">=</span>&nbsp;<span class="ident" id="1183947">v</span>&nbsp;<span class="comment" id="1183949">//&nbsp;copy&nbsp;all&nbsp;data&nbsp;from&nbsp;the&nbsp;current&nbsp;object&nbsp;to&nbsp;the&nbsp;new&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1184007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1184011">m2</span><span class="op" id="1184013">[</span><span class="ident" id="1184014">key</span><span class="op" id="1184017">]</span>&nbsp;<span class="op" id="1184019">=</span>&nbsp;<span class="ident" id="1184021">val</span>&nbsp;<span class="comment" id="1184025">//&nbsp;do&nbsp;the&nbsp;update&nbsp;that&nbsp;we&nbsp;need</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1184057">m</span><span class="op" id="1184058">.</span><span class="ident" id="1184059">Store</span><span class="op" id="1184064">(</span><span class="ident" id="1184065">m2</span><span class="op" id="1184067">)</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1184071">//&nbsp;atomically&nbsp;replace&nbsp;the&nbsp;current&nbsp;object&nbsp;with&nbsp;the&nbsp;new&nbsp;one</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1184131">//&nbsp;At&nbsp;this&nbsp;point&nbsp;all&nbsp;new&nbsp;readers&nbsp;start&nbsp;working&nbsp;with&nbsp;the&nbsp;new&nbsp;version.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1184202">//&nbsp;The&nbsp;old&nbsp;version&nbsp;will&nbsp;be&nbsp;garbage&nbsp;collected&nbsp;once&nbsp;the&nbsp;existing&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1184275">//&nbsp;(if&nbsp;any)&nbsp;are&nbsp;done&nbsp;with&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1184306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1184309">_</span><span class="op" id="1184310">,</span>&nbsp;<span class="ident" id="1184312">_</span>&nbsp;<span class="op" id="1184314">=</span>&nbsp;<span class="ident" id="1184316">read</span><span class="op" id="1184320">,</span>&nbsp;<span class="ident" id="1184322">insert</span><br>
<span class="lineno">195</span><span class="op" id="1184329">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
