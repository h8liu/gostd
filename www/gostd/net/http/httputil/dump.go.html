<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html" class="current">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4973636">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4973691">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4973745">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4973796">package</span>&nbsp;<span class="ident" id="4973804">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4973814">import</span>&nbsp;<span class="op" id="4973821">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4973824">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4973833">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4973842">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4973852">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4973859">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4973865">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4973878">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4973885">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4973897">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4973908">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4973919">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4973926">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="4973929">//&nbsp;One&nbsp;of&nbsp;the&nbsp;copies,&nbsp;say&nbsp;from&nbsp;b&nbsp;to&nbsp;r2,&nbsp;could&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using&nbsp;a&nbsp;more</span><br>
<span class="lineno"></span><span class="comment" id="4974002">//&nbsp;elaborate&nbsp;trick&nbsp;where&nbsp;the&nbsp;other&nbsp;copy&nbsp;is&nbsp;made&nbsp;during&nbsp;Request/Response.Write.</span><br>
<span class="lineno"></span><span class="comment" id="4974081">//&nbsp;This&nbsp;would&nbsp;complicate&nbsp;things&nbsp;too&nbsp;much,&nbsp;given&nbsp;that&nbsp;these&nbsp;functions&nbsp;are&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4974158">//&nbsp;debugging&nbsp;only.</span><br>
<span class="lineno">25</span><span class="keyword" id="4974177">func</span>&nbsp;<span class="ident" id="4974182">drainBody</span><span class="op" id="4974191">(</span><span class="ident" id="4974192">b</span>&nbsp;<span class="ident" id="4974194">io</span><span class="op" id="4974196">.</span><span class="ident" id="4974197">ReadCloser</span><span class="op" id="4974207">)</span>&nbsp;<span class="op" id="4974209">(</span><span class="ident" id="4974210">r1</span><span class="op" id="4974212">,</span>&nbsp;<span class="ident" id="4974214">r2</span>&nbsp;<span class="ident" id="4974217">io</span><span class="op" id="4974219">.</span><span class="ident" id="4974220">ReadCloser</span><span class="op" id="4974230">,</span>&nbsp;<span class="ident" id="4974232">err</span>&nbsp;<span class="builtintype" id="4974236">error</span><span class="op" id="4974241">)</span>&nbsp;<span class="op" id="4974243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4974246">var</span>&nbsp;<span class="ident" id="4974250">buf</span>&nbsp;<span class="ident" id="4974254">bytes</span><span class="op" id="4974259">.</span><span class="ident" id="4974260">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4974268">if</span>&nbsp;<span class="ident" id="4974271">_</span><span class="op" id="4974272">,</span>&nbsp;<span class="ident" id="4974274">err</span>&nbsp;<span class="op" id="4974278">=</span>&nbsp;<span class="ident" id="4974280">buf</span><span class="op" id="4974283">.</span><span class="ident" id="4974284">ReadFrom</span><span class="op" id="4974292">(</span><span class="ident" id="4974293">b</span><span class="op" id="4974294">)</span><span class="op" id="4974295">;</span>&nbsp;<span class="ident" id="4974297">err</span>&nbsp;<span class="op" id="4974301">!=</span>&nbsp;<span class="builtintype" id="4974304">nil</span>&nbsp;<span class="op" id="4974308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4974312">return</span>&nbsp;<span class="builtintype" id="4974319">nil</span><span class="op" id="4974322">,</span>&nbsp;<span class="builtintype" id="4974324">nil</span><span class="op" id="4974327">,</span>&nbsp;<span class="ident" id="4974329">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4974334">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4974337">if</span>&nbsp;<span class="ident" id="4974340">err</span>&nbsp;<span class="op" id="4974344">=</span>&nbsp;<span class="ident" id="4974346">b</span><span class="op" id="4974347">.</span><span class="ident" id="4974348">Close</span><span class="op" id="4974353">(</span><span class="op" id="4974354">)</span><span class="op" id="4974355">;</span>&nbsp;<span class="ident" id="4974357">err</span>&nbsp;<span class="op" id="4974361">!=</span>&nbsp;<span class="builtintype" id="4974364">nil</span>&nbsp;<span class="op" id="4974368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4974372">return</span>&nbsp;<span class="builtintype" id="4974379">nil</span><span class="op" id="4974382">,</span>&nbsp;<span class="builtintype" id="4974384">nil</span><span class="op" id="4974387">,</span>&nbsp;<span class="ident" id="4974389">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4974394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4974397">return</span>&nbsp;<span class="ident" id="4974404">ioutil</span><span class="op" id="4974410">.</span><span class="ident" id="4974411">NopCloser</span><span class="op" id="4974420">(</span><span class="op" id="4974421">&amp;</span><span class="ident" id="4974422">buf</span><span class="op" id="4974425">)</span><span class="op" id="4974426">,</span>&nbsp;<span class="ident" id="4974428">ioutil</span><span class="op" id="4974434">.</span><span class="ident" id="4974435">NopCloser</span><span class="op" id="4974444">(</span><span class="ident" id="4974445">bytes</span><span class="op" id="4974450">.</span><span class="ident" id="4974451">NewReader</span><span class="op" id="4974460">(</span><span class="ident" id="4974461">buf</span><span class="op" id="4974464">.</span><span class="ident" id="4974465">Bytes</span><span class="op" id="4974470">(</span><span class="op" id="4974471">)</span><span class="op" id="4974472">)</span><span class="op" id="4974473">)</span><span class="op" id="4974474">,</span>&nbsp;<span class="builtintype" id="4974476">nil</span><br>
<span class="lineno"></span><span class="op" id="4974480">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="4974483">//&nbsp;dumpConn&nbsp;is&nbsp;a&nbsp;net.Conn&nbsp;which&nbsp;writes&nbsp;to&nbsp;Writer&nbsp;and&nbsp;reads&nbsp;from&nbsp;Reader</span><br>
<span class="lineno"></span><span class="keyword" id="4974554">type</span>&nbsp;<span class="ident" id="4974559">dumpConn</span>&nbsp;<span class="keyword" id="4974568">struct</span>&nbsp;<span class="op" id="4974575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4974578">io</span><span class="op" id="4974580">.</span><span class="ident" id="4974581">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4974589">io</span><span class="op" id="4974591">.</span><span class="ident" id="4974592">Reader</span><br>
<span class="lineno">40</span><span class="op" id="4974599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4974602">func</span>&nbsp;<span class="op" id="4974607">(</span><span class="ident" id="4974608">c</span>&nbsp;<span class="op" id="4974610">*</span><span class="ident" id="4974611">dumpConn</span><span class="op" id="4974619">)</span>&nbsp;<span class="ident" id="4974621">Close</span><span class="op" id="4974626">(</span><span class="op" id="4974627">)</span>&nbsp;<span class="builtintype" id="4974629">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4974657">{</span>&nbsp;<span class="keyword" id="4974659">return</span>&nbsp;<span class="builtintype" id="4974666">nil</span>&nbsp;<span class="op" id="4974670">}</span><br>
<span class="lineno"></span><span class="keyword" id="4974672">func</span>&nbsp;<span class="op" id="4974677">(</span><span class="ident" id="4974678">c</span>&nbsp;<span class="op" id="4974680">*</span><span class="ident" id="4974681">dumpConn</span><span class="op" id="4974689">)</span>&nbsp;<span class="ident" id="4974691">LocalAddr</span><span class="op" id="4974700">(</span><span class="op" id="4974701">)</span>&nbsp;<span class="ident" id="4974703">net</span><span class="op" id="4974706">.</span><span class="ident" id="4974707">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4974727">{</span>&nbsp;<span class="keyword" id="4974729">return</span>&nbsp;<span class="builtintype" id="4974736">nil</span>&nbsp;<span class="op" id="4974740">}</span><br>
<span class="lineno"></span><span class="keyword" id="4974742">func</span>&nbsp;<span class="op" id="4974747">(</span><span class="ident" id="4974748">c</span>&nbsp;<span class="op" id="4974750">*</span><span class="ident" id="4974751">dumpConn</span><span class="op" id="4974759">)</span>&nbsp;<span class="ident" id="4974761">RemoteAddr</span><span class="op" id="4974771">(</span><span class="op" id="4974772">)</span>&nbsp;<span class="ident" id="4974774">net</span><span class="op" id="4974777">.</span><span class="ident" id="4974778">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4974797">{</span>&nbsp;<span class="keyword" id="4974799">return</span>&nbsp;<span class="builtintype" id="4974806">nil</span>&nbsp;<span class="op" id="4974810">}</span><br>
<span class="lineno">45</span><span class="keyword" id="4974812">func</span>&nbsp;<span class="op" id="4974817">(</span><span class="ident" id="4974818">c</span>&nbsp;<span class="op" id="4974820">*</span><span class="ident" id="4974821">dumpConn</span><span class="op" id="4974829">)</span>&nbsp;<span class="ident" id="4974831">SetDeadline</span><span class="op" id="4974842">(</span><span class="ident" id="4974843">t</span>&nbsp;<span class="ident" id="4974845">time</span><span class="op" id="4974849">.</span><span class="ident" id="4974850">Time</span><span class="op" id="4974854">)</span>&nbsp;<span class="builtintype" id="4974856">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4974867">{</span>&nbsp;<span class="keyword" id="4974869">return</span>&nbsp;<span class="builtintype" id="4974876">nil</span>&nbsp;<span class="op" id="4974880">}</span><br>
<span class="lineno"></span><span class="keyword" id="4974882">func</span>&nbsp;<span class="op" id="4974887">(</span><span class="ident" id="4974888">c</span>&nbsp;<span class="op" id="4974890">*</span><span class="ident" id="4974891">dumpConn</span><span class="op" id="4974899">)</span>&nbsp;<span class="ident" id="4974901">SetReadDeadline</span><span class="op" id="4974916">(</span><span class="ident" id="4974917">t</span>&nbsp;<span class="ident" id="4974919">time</span><span class="op" id="4974923">.</span><span class="ident" id="4974924">Time</span><span class="op" id="4974928">)</span>&nbsp;<span class="builtintype" id="4974930">error</span>&nbsp;&nbsp;<span class="op" id="4974937">{</span>&nbsp;<span class="keyword" id="4974939">return</span>&nbsp;<span class="builtintype" id="4974946">nil</span>&nbsp;<span class="op" id="4974950">}</span><br>
<span class="lineno"></span><span class="keyword" id="4974952">func</span>&nbsp;<span class="op" id="4974957">(</span><span class="ident" id="4974958">c</span>&nbsp;<span class="op" id="4974960">*</span><span class="ident" id="4974961">dumpConn</span><span class="op" id="4974969">)</span>&nbsp;<span class="ident" id="4974971">SetWriteDeadline</span><span class="op" id="4974987">(</span><span class="ident" id="4974988">t</span>&nbsp;<span class="ident" id="4974990">time</span><span class="op" id="4974994">.</span><span class="ident" id="4974995">Time</span><span class="op" id="4974999">)</span>&nbsp;<span class="builtintype" id="4975001">error</span>&nbsp;<span class="op" id="4975007">{</span>&nbsp;<span class="keyword" id="4975009">return</span>&nbsp;<span class="builtintype" id="4975016">nil</span>&nbsp;<span class="op" id="4975020">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4975023">type</span>&nbsp;<span class="ident" id="4975028">neverEnding</span>&nbsp;<span class="builtintype" id="4975040">byte</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="4975046">func</span>&nbsp;<span class="op" id="4975051">(</span><span class="ident" id="4975052">b</span>&nbsp;<span class="ident" id="4975054">neverEnding</span><span class="op" id="4975065">)</span>&nbsp;<span class="ident" id="4975067">Read</span><span class="op" id="4975071">(</span><span class="ident" id="4975072">p</span>&nbsp;<span class="op" id="4975074">[</span><span class="op" id="4975075">]</span><span class="builtintype" id="4975076">byte</span><span class="op" id="4975080">)</span>&nbsp;<span class="op" id="4975082">(</span><span class="ident" id="4975083">n</span>&nbsp;<span class="builtintype" id="4975085">int</span><span class="op" id="4975088">,</span>&nbsp;<span class="ident" id="4975090">err</span>&nbsp;<span class="builtintype" id="4975094">error</span><span class="op" id="4975099">)</span>&nbsp;<span class="op" id="4975101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4975104">for</span>&nbsp;<span class="ident" id="4975108">i</span>&nbsp;<span class="op" id="4975110">:=</span>&nbsp;<span class="keyword" id="4975113">range</span>&nbsp;<span class="ident" id="4975119">p</span>&nbsp;<span class="op" id="4975121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4975125">p</span><span class="op" id="4975126">[</span><span class="ident" id="4975127">i</span><span class="op" id="4975128">]</span>&nbsp;<span class="op" id="4975130">=</span>&nbsp;<span class="builtintype" id="4975132">byte</span><span class="op" id="4975136">(</span><span class="ident" id="4975137">b</span><span class="op" id="4975138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4975141">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4975144">return</span>&nbsp;<span class="builtinfunc" id="4975151">len</span><span class="op" id="4975154">(</span><span class="ident" id="4975155">p</span><span class="op" id="4975156">)</span><span class="op" id="4975157">,</span>&nbsp;<span class="builtintype" id="4975159">nil</span><br>
<span class="lineno"></span><span class="op" id="4975163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4975166">//&nbsp;DumpRequestOut&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;includes</span><br>
<span class="lineno"></span><span class="comment" id="4975217">//&nbsp;headers&nbsp;that&nbsp;the&nbsp;standard&nbsp;http.Transport&nbsp;adds,</span><br>
<span class="lineno">60</span><span class="comment" id="4975267">//&nbsp;such&nbsp;as&nbsp;User-Agent.</span><br>
<span class="lineno"></span><span class="keyword" id="4975290">func</span>&nbsp;<span class="ident" id="4975295">DumpRequestOut</span><span class="op" id="4975309">(</span><span class="ident" id="4975310">req</span>&nbsp;<span class="op" id="4975314">*</span><span class="ident" id="4975315">http</span><span class="op" id="4975319">.</span><span class="ident" id="4975320">Request</span><span class="op" id="4975327">,</span>&nbsp;<span class="ident" id="4975329">body</span>&nbsp;<span class="builtintype" id="4975334">bool</span><span class="op" id="4975338">)</span>&nbsp;<span class="op" id="4975340">(</span><span class="op" id="4975341">[</span><span class="op" id="4975342">]</span><span class="builtintype" id="4975343">byte</span><span class="op" id="4975347">,</span>&nbsp;<span class="builtintype" id="4975349">error</span><span class="op" id="4975354">)</span>&nbsp;<span class="op" id="4975356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4975359">save</span>&nbsp;<span class="op" id="4975364">:=</span>&nbsp;<span class="ident" id="4975367">req</span><span class="op" id="4975370">.</span><span class="ident" id="4975371">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4975377">dummyBody</span>&nbsp;<span class="op" id="4975387">:=</span>&nbsp;<span class="builtintype" id="4975390">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4975397">if</span>&nbsp;<span class="op" id="4975400">!</span><span class="ident" id="4975401">body</span>&nbsp;<span class="op" id="4975406">||</span>&nbsp;<span class="ident" id="4975409">req</span><span class="op" id="4975412">.</span><span class="ident" id="4975413">Body</span>&nbsp;<span class="op" id="4975418">==</span>&nbsp;<span class="builtintype" id="4975421">nil</span>&nbsp;<span class="op" id="4975425">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4975429">req</span><span class="op" id="4975432">.</span><span class="ident" id="4975433">Body</span>&nbsp;<span class="op" id="4975438">=</span>&nbsp;<span class="builtintype" id="4975440">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4975446">if</span>&nbsp;<span class="ident" id="4975449">req</span><span class="op" id="4975452">.</span><span class="ident" id="4975453">ContentLength</span>&nbsp;<span class="op" id="4975467">!=</span>&nbsp;<span class="num" id="4975470">0</span>&nbsp;<span class="op" id="4975472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4975477">req</span><span class="op" id="4975480">.</span><span class="ident" id="4975481">Body</span>&nbsp;<span class="op" id="4975486">=</span>&nbsp;<span class="ident" id="4975488">ioutil</span><span class="op" id="4975494">.</span><span class="ident" id="4975495">NopCloser</span><span class="op" id="4975504">(</span><span class="ident" id="4975505">io</span><span class="op" id="4975507">.</span><span class="ident" id="4975508">LimitReader</span><span class="op" id="4975519">(</span><span class="ident" id="4975520">neverEnding</span><span class="op" id="4975531">(</span><span class="string" id="4975532">&#39;x&#39;</span><span class="op" id="4975535">)</span><span class="op" id="4975536">,</span>&nbsp;<span class="ident" id="4975538">req</span><span class="op" id="4975541">.</span><span class="ident" id="4975542">ContentLength</span><span class="op" id="4975555">)</span><span class="op" id="4975556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4975561">dummyBody</span>&nbsp;<span class="op" id="4975571">=</span>&nbsp;<span class="builtintype" id="4975573">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4975580">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4975583">}</span>&nbsp;<span class="keyword" id="4975585">else</span>&nbsp;<span class="op" id="4975590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4975594">var</span>&nbsp;<span class="ident" id="4975598">err</span>&nbsp;<span class="builtintype" id="4975602">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4975610">save</span><span class="op" id="4975614">,</span>&nbsp;<span class="ident" id="4975616">req</span><span class="op" id="4975619">.</span><span class="ident" id="4975620">Body</span><span class="op" id="4975624">,</span>&nbsp;<span class="ident" id="4975626">err</span>&nbsp;<span class="op" id="4975630">=</span>&nbsp;<span class="ident" id="4975632">drainBody</span><span class="op" id="4975641">(</span><span class="ident" id="4975642">req</span><span class="op" id="4975645">.</span><span class="ident" id="4975646">Body</span><span class="op" id="4975650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4975654">if</span>&nbsp;<span class="ident" id="4975657">err</span>&nbsp;<span class="op" id="4975661">!=</span>&nbsp;<span class="builtintype" id="4975664">nil</span>&nbsp;<span class="op" id="4975668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4975673">return</span>&nbsp;<span class="builtintype" id="4975680">nil</span><span class="op" id="4975683">,</span>&nbsp;<span class="ident" id="4975685">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4975691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4975694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4975698">//&nbsp;Since&nbsp;we&#39;re&nbsp;using&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;write&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4975768">//&nbsp;switch&nbsp;to&nbsp;http&nbsp;so&nbsp;the&nbsp;Transport&nbsp;doesn&#39;t&nbsp;try&nbsp;to&nbsp;do&nbsp;an&nbsp;SSL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4975829">//&nbsp;negotiation&nbsp;with&nbsp;our&nbsp;dumpConn&nbsp;and&nbsp;its&nbsp;bytes.Buffer&nbsp;&amp;&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4975892">//&nbsp;The&nbsp;wire&nbsp;format&nbsp;for&nbsp;https&nbsp;and&nbsp;http&nbsp;are&nbsp;the&nbsp;same,&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4975953">reqSend</span>&nbsp;<span class="op" id="4975961">:=</span>&nbsp;<span class="ident" id="4975964">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4975969">if</span>&nbsp;<span class="ident" id="4975972">req</span><span class="op" id="4975975">.</span><span class="ident" id="4975976">URL</span><span class="op" id="4975979">.</span><span class="ident" id="4975980">Scheme</span>&nbsp;<span class="op" id="4975987">==</span>&nbsp;<span class="string" id="4975990">&#34;https&#34;</span>&nbsp;<span class="op" id="4975998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976002">reqSend</span>&nbsp;<span class="op" id="4976010">=</span>&nbsp;<span class="builtinfunc" id="4976012">new</span><span class="op" id="4976015">(</span><span class="ident" id="4976016">http</span><span class="op" id="4976020">.</span><span class="ident" id="4976021">Request</span><span class="op" id="4976028">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4976032">*</span><span class="ident" id="4976033">reqSend</span>&nbsp;<span class="op" id="4976041">=</span>&nbsp;<span class="op" id="4976043">*</span><span class="ident" id="4976044">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976050">reqSend</span><span class="op" id="4976057">.</span><span class="ident" id="4976058">URL</span>&nbsp;<span class="op" id="4976062">=</span>&nbsp;<span class="builtinfunc" id="4976064">new</span><span class="op" id="4976067">(</span><span class="ident" id="4976068">url</span><span class="op" id="4976071">.</span><span class="ident" id="4976072">URL</span><span class="op" id="4976075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4976079">*</span><span class="ident" id="4976080">reqSend</span><span class="op" id="4976087">.</span><span class="ident" id="4976088">URL</span>&nbsp;<span class="op" id="4976092">=</span>&nbsp;<span class="op" id="4976094">*</span><span class="ident" id="4976095">req</span><span class="op" id="4976098">.</span><span class="ident" id="4976099">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976105">reqSend</span><span class="op" id="4976112">.</span><span class="ident" id="4976113">URL</span><span class="op" id="4976116">.</span><span class="ident" id="4976117">Scheme</span>&nbsp;<span class="op" id="4976124">=</span>&nbsp;<span class="string" id="4976126">&#34;http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4976134">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4976138">//&nbsp;Use&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;record&nbsp;what&nbsp;we&nbsp;would&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4976201">//&nbsp;on&nbsp;the&nbsp;wire,&nbsp;but&nbsp;not&nbsp;using&nbsp;TCP.&nbsp;&nbsp;Use&nbsp;a&nbsp;Transport&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4976261">//&nbsp;custom&nbsp;dialer&nbsp;that&nbsp;returns&nbsp;a&nbsp;fake&nbsp;net.Conn&nbsp;that&nbsp;waits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4976319">//&nbsp;for&nbsp;the&nbsp;full&nbsp;input&nbsp;(and&nbsp;recording&nbsp;it),&nbsp;and&nbsp;then&nbsp;responds</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4976380">//&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4976407">var</span>&nbsp;<span class="ident" id="4976411">buf</span>&nbsp;<span class="ident" id="4976415">bytes</span><span class="op" id="4976420">.</span><span class="ident" id="4976421">Buffer</span>&nbsp;<span class="comment" id="4976428">//&nbsp;records&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976451">pr</span><span class="op" id="4976453">,</span>&nbsp;<span class="ident" id="4976455">pw</span>&nbsp;<span class="op" id="4976458">:=</span>&nbsp;<span class="ident" id="4976461">io</span><span class="op" id="4976463">.</span><span class="ident" id="4976464">Pipe</span><span class="op" id="4976468">(</span><span class="op" id="4976469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4976472">defer</span>&nbsp;<span class="ident" id="4976478">pr</span><span class="op" id="4976480">.</span><span class="ident" id="4976481">Close</span><span class="op" id="4976486">(</span><span class="op" id="4976487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4976490">defer</span>&nbsp;<span class="ident" id="4976496">pw</span><span class="op" id="4976498">.</span><span class="ident" id="4976499">Close</span><span class="op" id="4976504">(</span><span class="op" id="4976505">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976508">dr</span>&nbsp;<span class="op" id="4976511">:=</span>&nbsp;<span class="op" id="4976514">&amp;</span><span class="ident" id="4976515">delegateReader</span><span class="op" id="4976529">{</span><span class="ident" id="4976530">c</span><span class="op" id="4976531">:</span>&nbsp;<span class="builtinfunc" id="4976533">make</span><span class="op" id="4976537">(</span><span class="keyword" id="4976538">chan</span>&nbsp;<span class="ident" id="4976543">io</span><span class="op" id="4976545">.</span><span class="ident" id="4976546">Reader</span><span class="op" id="4976552">)</span><span class="op" id="4976553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4976556">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;request&nbsp;before&nbsp;replying&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4976620">go</span>&nbsp;<span class="keyword" id="4976623">func</span><span class="op" id="4976627">(</span><span class="op" id="4976628">)</span>&nbsp;<span class="op" id="4976630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976634">req</span><span class="op" id="4976637">,</span>&nbsp;<span class="ident" id="4976639">err</span>&nbsp;<span class="op" id="4976643">:=</span>&nbsp;<span class="ident" id="4976646">http</span><span class="op" id="4976650">.</span><span class="ident" id="4976651">ReadRequest</span><span class="op" id="4976662">(</span><span class="ident" id="4976663">bufio</span><span class="op" id="4976668">.</span><span class="ident" id="4976669">NewReader</span><span class="op" id="4976678">(</span><span class="ident" id="4976679">pr</span><span class="op" id="4976681">)</span><span class="op" id="4976682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4976686">if</span>&nbsp;<span class="ident" id="4976689">err</span>&nbsp;<span class="op" id="4976693">==</span>&nbsp;<span class="builtintype" id="4976696">nil</span>&nbsp;<span class="op" id="4976700">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4976705">//&nbsp;Ensure&nbsp;all&nbsp;the&nbsp;body&nbsp;is&nbsp;read;&nbsp;otherwise</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4976750">//&nbsp;we&#39;ll&nbsp;get&nbsp;a&nbsp;partial&nbsp;dump.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976782">io</span><span class="op" id="4976784">.</span><span class="ident" id="4976785">Copy</span><span class="op" id="4976789">(</span><span class="ident" id="4976790">ioutil</span><span class="op" id="4976796">.</span><span class="ident" id="4976797">Discard</span><span class="op" id="4976804">,</span>&nbsp;<span class="ident" id="4976806">req</span><span class="op" id="4976809">.</span><span class="ident" id="4976810">Body</span><span class="op" id="4976814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976819">req</span><span class="op" id="4976822">.</span><span class="ident" id="4976823">Body</span><span class="op" id="4976827">.</span><span class="ident" id="4976828">Close</span><span class="op" id="4976833">(</span><span class="op" id="4976834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4976838">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976842">dr</span><span class="op" id="4976844">.</span><span class="ident" id="4976845">c</span>&nbsp;<span class="op" id="4976847">&lt;-</span>&nbsp;<span class="ident" id="4976850">strings</span><span class="op" id="4976857">.</span><span class="ident" id="4976858">NewReader</span><span class="op" id="4976867">(</span><span class="string" id="4976868">&#34;HTTP/1.1&nbsp;204&nbsp;No&nbsp;Content\r\n\r\n&#34;</span><span class="op" id="4976901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4976904">}</span><span class="op" id="4976905">(</span><span class="op" id="4976906">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976910">t</span>&nbsp;<span class="op" id="4976912">:=</span>&nbsp;<span class="op" id="4976915">&amp;</span><span class="ident" id="4976916">http</span><span class="op" id="4976920">.</span><span class="ident" id="4976921">Transport</span><span class="op" id="4976930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976934">DisableKeepAlives</span><span class="op" id="4976951">:</span>&nbsp;<span class="builtintype" id="4976953">true</span><span class="op" id="4976957">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4976961">Dial</span><span class="op" id="4976965">:</span>&nbsp;<span class="keyword" id="4976967">func</span><span class="op" id="4976971">(</span><span class="ident" id="4976972">net</span><span class="op" id="4976975">,</span>&nbsp;<span class="ident" id="4976977">addr</span>&nbsp;<span class="builtintype" id="4976982">string</span><span class="op" id="4976988">)</span>&nbsp;<span class="op" id="4976990">(</span><span class="ident" id="4976991">net</span><span class="op" id="4976994">.</span><span class="ident" id="4976995">Conn</span><span class="op" id="4976999">,</span>&nbsp;<span class="builtintype" id="4977001">error</span><span class="op" id="4977006">)</span>&nbsp;<span class="op" id="4977008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4977013">return</span>&nbsp;<span class="op" id="4977020">&amp;</span><span class="ident" id="4977021">dumpConn</span><span class="op" id="4977029">{</span><span class="ident" id="4977030">io</span><span class="op" id="4977032">.</span><span class="ident" id="4977033">MultiWriter</span><span class="op" id="4977044">(</span><span class="op" id="4977045">&amp;</span><span class="ident" id="4977046">buf</span><span class="op" id="4977049">,</span>&nbsp;<span class="ident" id="4977051">pw</span><span class="op" id="4977053">)</span><span class="op" id="4977054">,</span>&nbsp;<span class="ident" id="4977056">dr</span><span class="op" id="4977058">}</span><span class="op" id="4977059">,</span>&nbsp;<span class="builtintype" id="4977061">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4977067">}</span><span class="op" id="4977068">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4977071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4977075">_</span><span class="op" id="4977076">,</span>&nbsp;<span class="ident" id="4977078">err</span>&nbsp;<span class="op" id="4977082">:=</span>&nbsp;<span class="ident" id="4977085">t</span><span class="op" id="4977086">.</span><span class="ident" id="4977087">RoundTrip</span><span class="op" id="4977096">(</span><span class="ident" id="4977097">reqSend</span><span class="op" id="4977104">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4977108">req</span><span class="op" id="4977111">.</span><span class="ident" id="4977112">Body</span>&nbsp;<span class="op" id="4977117">=</span>&nbsp;<span class="ident" id="4977119">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4977125">if</span>&nbsp;<span class="ident" id="4977128">err</span>&nbsp;<span class="op" id="4977132">!=</span>&nbsp;<span class="builtintype" id="4977135">nil</span>&nbsp;<span class="op" id="4977139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4977143">return</span>&nbsp;<span class="builtintype" id="4977150">nil</span><span class="op" id="4977153">,</span>&nbsp;<span class="ident" id="4977155">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4977160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4977163">dump</span>&nbsp;<span class="op" id="4977168">:=</span>&nbsp;<span class="ident" id="4977171">buf</span><span class="op" id="4977174">.</span><span class="ident" id="4977175">Bytes</span><span class="op" id="4977180">(</span><span class="op" id="4977181">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4977185">//&nbsp;If&nbsp;we&nbsp;used&nbsp;a&nbsp;dummy&nbsp;body&nbsp;above,&nbsp;remove&nbsp;it&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4977235">//&nbsp;TODO:&nbsp;if&nbsp;the&nbsp;req.ContentLength&nbsp;is&nbsp;large,&nbsp;we&nbsp;allocate&nbsp;memory</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4977299">//&nbsp;unnecessarily&nbsp;just&nbsp;to&nbsp;slice&nbsp;it&nbsp;off&nbsp;here.&nbsp;&nbsp;But&nbsp;this&nbsp;is&nbsp;just</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4977362">//&nbsp;a&nbsp;debug&nbsp;function,&nbsp;so&nbsp;this&nbsp;is&nbsp;acceptable&nbsp;for&nbsp;now.&nbsp;We&nbsp;could</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4977424">//&nbsp;discard&nbsp;the&nbsp;body&nbsp;earlier&nbsp;if&nbsp;this&nbsp;matters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4977470">if</span>&nbsp;<span class="ident" id="4977473">dummyBody</span>&nbsp;<span class="op" id="4977483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4977487">if</span>&nbsp;<span class="ident" id="4977490">i</span>&nbsp;<span class="op" id="4977492">:=</span>&nbsp;<span class="ident" id="4977495">bytes</span><span class="op" id="4977500">.</span><span class="ident" id="4977501">Index</span><span class="op" id="4977506">(</span><span class="ident" id="4977507">dump</span><span class="op" id="4977511">,</span>&nbsp;<span class="op" id="4977513">[</span><span class="op" id="4977514">]</span><span class="builtintype" id="4977515">byte</span><span class="op" id="4977519">(</span><span class="string" id="4977520">&#34;\r\n\r\n&#34;</span><span class="op" id="4977530">)</span><span class="op" id="4977531">)</span><span class="op" id="4977532">;</span>&nbsp;<span class="ident" id="4977534">i</span>&nbsp;<span class="op" id="4977536">&gt;=</span>&nbsp;<span class="num" id="4977539">0</span>&nbsp;<span class="op" id="4977541">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4977546">dump</span>&nbsp;<span class="op" id="4977551">=</span>&nbsp;<span class="ident" id="4977553">dump</span><span class="op" id="4977557">[</span><span class="op" id="4977558">:</span><span class="ident" id="4977559">i</span><span class="op" id="4977560">+</span><span class="num" id="4977561">4</span><span class="op" id="4977562">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4977566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4977569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4977572">return</span>&nbsp;<span class="ident" id="4977579">dump</span><span class="op" id="4977583">,</span>&nbsp;<span class="builtintype" id="4977585">nil</span><br>
<span class="lineno"></span><span class="op" id="4977589">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="4977592">//&nbsp;delegateReader&nbsp;is&nbsp;a&nbsp;reader&nbsp;that&nbsp;delegates&nbsp;to&nbsp;another&nbsp;reader,</span><br>
<span class="lineno"></span><span class="comment" id="4977656">//&nbsp;once&nbsp;it&nbsp;arrives&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="4977689">type</span>&nbsp;<span class="ident" id="4977694">delegateReader</span>&nbsp;<span class="keyword" id="4977709">struct</span>&nbsp;<span class="op" id="4977716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4977719">c</span>&nbsp;<span class="keyword" id="4977721">chan</span>&nbsp;<span class="ident" id="4977726">io</span><span class="op" id="4977728">.</span><span class="ident" id="4977729">Reader</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4977737">r</span>&nbsp;<span class="ident" id="4977739">io</span><span class="op" id="4977741">.</span><span class="ident" id="4977742">Reader</span>&nbsp;<span class="comment" id="4977749">//&nbsp;nil&nbsp;until&nbsp;received&nbsp;from&nbsp;c</span><br>
<span class="lineno"></span><span class="op" id="4977778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4977781">func</span>&nbsp;<span class="op" id="4977786">(</span><span class="ident" id="4977787">r</span>&nbsp;<span class="op" id="4977789">*</span><span class="ident" id="4977790">delegateReader</span><span class="op" id="4977804">)</span>&nbsp;<span class="ident" id="4977806">Read</span><span class="op" id="4977810">(</span><span class="ident" id="4977811">p</span>&nbsp;<span class="op" id="4977813">[</span><span class="op" id="4977814">]</span><span class="builtintype" id="4977815">byte</span><span class="op" id="4977819">)</span>&nbsp;<span class="op" id="4977821">(</span><span class="builtintype" id="4977822">int</span><span class="op" id="4977825">,</span>&nbsp;<span class="builtintype" id="4977827">error</span><span class="op" id="4977832">)</span>&nbsp;<span class="op" id="4977834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4977837">if</span>&nbsp;<span class="ident" id="4977840">r</span><span class="op" id="4977841">.</span><span class="ident" id="4977842">r</span>&nbsp;<span class="op" id="4977844">==</span>&nbsp;<span class="builtintype" id="4977847">nil</span>&nbsp;<span class="op" id="4977851">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4977855">r</span><span class="op" id="4977856">.</span><span class="ident" id="4977857">r</span>&nbsp;<span class="op" id="4977859">=</span>&nbsp;<span class="op" id="4977861">&lt;-</span><span class="ident" id="4977863">r</span><span class="op" id="4977864">.</span><span class="ident" id="4977865">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4977868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4977871">return</span>&nbsp;<span class="ident" id="4977878">r</span><span class="op" id="4977879">.</span><span class="ident" id="4977880">r</span><span class="op" id="4977881">.</span><span class="ident" id="4977882">Read</span><span class="op" id="4977886">(</span><span class="ident" id="4977887">p</span><span class="op" id="4977888">)</span><br>
<span class="lineno"></span><span class="op" id="4977890">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="comment" id="4977893">//&nbsp;Return&nbsp;value&nbsp;if&nbsp;nonempty,&nbsp;def&nbsp;otherwise.</span><br>
<span class="lineno"></span><span class="keyword" id="4977937">func</span>&nbsp;<span class="ident" id="4977942">valueOrDefault</span><span class="op" id="4977956">(</span><span class="ident" id="4977957">value</span><span class="op" id="4977962">,</span>&nbsp;<span class="ident" id="4977964">def</span>&nbsp;<span class="builtintype" id="4977968">string</span><span class="op" id="4977974">)</span>&nbsp;<span class="builtintype" id="4977976">string</span>&nbsp;<span class="op" id="4977983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4977986">if</span>&nbsp;<span class="ident" id="4977989">value</span>&nbsp;<span class="op" id="4977995">!=</span>&nbsp;<span class="string" id="4977998">&#34;&#34;</span>&nbsp;<span class="op" id="4978001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4978005">return</span>&nbsp;<span class="ident" id="4978012">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4978019">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4978022">return</span>&nbsp;<span class="ident" id="4978029">def</span><br>
<span class="lineno"></span><span class="op" id="4978033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4978036">var</span>&nbsp;<span class="ident" id="4978040">reqWriteExcludeHeaderDump</span>&nbsp;<span class="op" id="4978066">=</span>&nbsp;<span class="keyword" id="4978068">map</span><span class="op" id="4978071">[</span><span class="builtintype" id="4978072">string</span><span class="op" id="4978078">]</span><span class="builtintype" id="4978079">bool</span><span class="op" id="4978083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4978086">&#34;Host&#34;</span><span class="op" id="4978092">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4978107">true</span><span class="op" id="4978111">,</span>&nbsp;<span class="comment" id="4978113">//&nbsp;not&nbsp;in&nbsp;Header&nbsp;map&nbsp;anyway</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4978142">&#34;Content-Length&#34;</span><span class="op" id="4978158">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4978163">true</span><span class="op" id="4978167">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4978170">&#34;Transfer-Encoding&#34;</span><span class="op" id="4978189">:</span>&nbsp;<span class="builtintype" id="4978191">true</span><span class="op" id="4978195">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4978198">&#34;Trailer&#34;</span><span class="op" id="4978207">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4978219">true</span><span class="op" id="4978223">,</span><br>
<span class="lineno"></span><span class="op" id="4978225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="4978228">//&nbsp;dumpAsReceived&nbsp;writes&nbsp;req&nbsp;to&nbsp;w&nbsp;in&nbsp;the&nbsp;form&nbsp;as&nbsp;it&nbsp;was&nbsp;received,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4978297">//&nbsp;at&nbsp;least&nbsp;as&nbsp;accurately&nbsp;as&nbsp;possible&nbsp;from&nbsp;the&nbsp;information&nbsp;retained&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4978368">//&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span><span class="keyword" id="4978384">func</span>&nbsp;<span class="ident" id="4978389">dumpAsReceived</span><span class="op" id="4978403">(</span><span class="ident" id="4978404">req</span>&nbsp;<span class="op" id="4978408">*</span><span class="ident" id="4978409">http</span><span class="op" id="4978413">.</span><span class="ident" id="4978414">Request</span><span class="op" id="4978421">,</span>&nbsp;<span class="ident" id="4978423">w</span>&nbsp;<span class="ident" id="4978425">io</span><span class="op" id="4978427">.</span><span class="ident" id="4978428">Writer</span><span class="op" id="4978434">)</span>&nbsp;<span class="builtintype" id="4978436">error</span>&nbsp;<span class="op" id="4978442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4978445">return</span>&nbsp;<span class="builtintype" id="4978452">nil</span><br>
<span class="lineno">175</span><span class="op" id="4978456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4978459">//&nbsp;DumpRequest&nbsp;returns&nbsp;the&nbsp;as-received&nbsp;wire&nbsp;representation&nbsp;of&nbsp;req,</span><br>
<span class="lineno"></span><span class="comment" id="4978526">//&nbsp;optionally&nbsp;including&nbsp;the&nbsp;request&nbsp;body,&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="comment" id="4978583">//&nbsp;DumpRequest&nbsp;is&nbsp;semantically&nbsp;a&nbsp;no-op,&nbsp;but&nbsp;in&nbsp;order&nbsp;to</span><br>
<span class="lineno">180</span><span class="comment" id="4978639">//&nbsp;dump&nbsp;the&nbsp;body,&nbsp;it&nbsp;reads&nbsp;the&nbsp;body&nbsp;data&nbsp;into&nbsp;memory&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4978696">//&nbsp;changes&nbsp;req.Body&nbsp;to&nbsp;refer&nbsp;to&nbsp;the&nbsp;in-memory&nbsp;copy.</span><br>
<span class="lineno"></span><span class="comment" id="4978748">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;http.Request.Write&nbsp;details&nbsp;which&nbsp;fields</span><br>
<span class="lineno"></span><span class="comment" id="4978813">//&nbsp;of&nbsp;req&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4978833">func</span>&nbsp;<span class="ident" id="4978838">DumpRequest</span><span class="op" id="4978849">(</span><span class="ident" id="4978850">req</span>&nbsp;<span class="op" id="4978854">*</span><span class="ident" id="4978855">http</span><span class="op" id="4978859">.</span><span class="ident" id="4978860">Request</span><span class="op" id="4978867">,</span>&nbsp;<span class="ident" id="4978869">body</span>&nbsp;<span class="builtintype" id="4978874">bool</span><span class="op" id="4978878">)</span>&nbsp;<span class="op" id="4978880">(</span><span class="ident" id="4978881">dump</span>&nbsp;<span class="op" id="4978886">[</span><span class="op" id="4978887">]</span><span class="builtintype" id="4978888">byte</span><span class="op" id="4978892">,</span>&nbsp;<span class="ident" id="4978894">err</span>&nbsp;<span class="builtintype" id="4978898">error</span><span class="op" id="4978903">)</span>&nbsp;<span class="op" id="4978905">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4978908">save</span>&nbsp;<span class="op" id="4978913">:=</span>&nbsp;<span class="ident" id="4978916">req</span><span class="op" id="4978919">.</span><span class="ident" id="4978920">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4978926">if</span>&nbsp;<span class="op" id="4978929">!</span><span class="ident" id="4978930">body</span>&nbsp;<span class="op" id="4978935">||</span>&nbsp;<span class="ident" id="4978938">req</span><span class="op" id="4978941">.</span><span class="ident" id="4978942">Body</span>&nbsp;<span class="op" id="4978947">==</span>&nbsp;<span class="builtintype" id="4978950">nil</span>&nbsp;<span class="op" id="4978954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4978958">req</span><span class="op" id="4978961">.</span><span class="ident" id="4978962">Body</span>&nbsp;<span class="op" id="4978967">=</span>&nbsp;<span class="builtintype" id="4978969">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4978974">}</span>&nbsp;<span class="keyword" id="4978976">else</span>&nbsp;<span class="op" id="4978981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4978985">save</span><span class="op" id="4978989">,</span>&nbsp;<span class="ident" id="4978991">req</span><span class="op" id="4978994">.</span><span class="ident" id="4978995">Body</span><span class="op" id="4978999">,</span>&nbsp;<span class="ident" id="4979001">err</span>&nbsp;<span class="op" id="4979005">=</span>&nbsp;<span class="ident" id="4979007">drainBody</span><span class="op" id="4979016">(</span><span class="ident" id="4979017">req</span><span class="op" id="4979020">.</span><span class="ident" id="4979021">Body</span><span class="op" id="4979025">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4979029">if</span>&nbsp;<span class="ident" id="4979032">err</span>&nbsp;<span class="op" id="4979036">!=</span>&nbsp;<span class="builtintype" id="4979039">nil</span>&nbsp;<span class="op" id="4979043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4979048">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4979057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4979060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4979064">var</span>&nbsp;<span class="ident" id="4979068">b</span>&nbsp;<span class="ident" id="4979070">bytes</span><span class="op" id="4979075">.</span><span class="ident" id="4979076">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979085">fmt</span><span class="op" id="4979088">.</span><span class="ident" id="4979089">Fprintf</span><span class="op" id="4979096">(</span><span class="op" id="4979097">&amp;</span><span class="ident" id="4979098">b</span><span class="op" id="4979099">,</span>&nbsp;<span class="string" id="4979101">&#34;%s&nbsp;%s&nbsp;HTTP/%d.%d\r\n&#34;</span><span class="op" id="4979123">,</span>&nbsp;<span class="ident" id="4979125">valueOrDefault</span><span class="op" id="4979139">(</span><span class="ident" id="4979140">req</span><span class="op" id="4979143">.</span><span class="ident" id="4979144">Method</span><span class="op" id="4979150">,</span>&nbsp;<span class="string" id="4979152">&#34;GET&#34;</span><span class="op" id="4979157">)</span><span class="op" id="4979158">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979162">req</span><span class="op" id="4979165">.</span><span class="ident" id="4979166">URL</span><span class="op" id="4979169">.</span><span class="ident" id="4979170">RequestURI</span><span class="op" id="4979180">(</span><span class="op" id="4979181">)</span><span class="op" id="4979182">,</span>&nbsp;<span class="ident" id="4979184">req</span><span class="op" id="4979187">.</span><span class="ident" id="4979188">ProtoMajor</span><span class="op" id="4979198">,</span>&nbsp;<span class="ident" id="4979200">req</span><span class="op" id="4979203">.</span><span class="ident" id="4979204">ProtoMinor</span><span class="op" id="4979214">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979218">host</span>&nbsp;<span class="op" id="4979223">:=</span>&nbsp;<span class="ident" id="4979226">req</span><span class="op" id="4979229">.</span><span class="ident" id="4979230">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4979236">if</span>&nbsp;<span class="ident" id="4979239">host</span>&nbsp;<span class="op" id="4979244">==</span>&nbsp;<span class="string" id="4979247">&#34;&#34;</span>&nbsp;<span class="op" id="4979250">&amp;&amp;</span>&nbsp;<span class="ident" id="4979253">req</span><span class="op" id="4979256">.</span><span class="ident" id="4979257">URL</span>&nbsp;<span class="op" id="4979261">!=</span>&nbsp;<span class="builtintype" id="4979264">nil</span>&nbsp;<span class="op" id="4979268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979272">host</span>&nbsp;<span class="op" id="4979277">=</span>&nbsp;<span class="ident" id="4979279">req</span><span class="op" id="4979282">.</span><span class="ident" id="4979283">URL</span><span class="op" id="4979286">.</span><span class="ident" id="4979287">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4979293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4979296">if</span>&nbsp;<span class="ident" id="4979299">host</span>&nbsp;<span class="op" id="4979304">!=</span>&nbsp;<span class="string" id="4979307">&#34;&#34;</span>&nbsp;<span class="op" id="4979310">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979314">fmt</span><span class="op" id="4979317">.</span><span class="ident" id="4979318">Fprintf</span><span class="op" id="4979325">(</span><span class="op" id="4979326">&amp;</span><span class="ident" id="4979327">b</span><span class="op" id="4979328">,</span>&nbsp;<span class="string" id="4979330">&#34;Host:&nbsp;%s\r\n&#34;</span><span class="op" id="4979344">,</span>&nbsp;<span class="ident" id="4979346">host</span><span class="op" id="4979350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4979353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979357">chunked</span>&nbsp;<span class="op" id="4979365">:=</span>&nbsp;<span class="builtinfunc" id="4979368">len</span><span class="op" id="4979371">(</span><span class="ident" id="4979372">req</span><span class="op" id="4979375">.</span><span class="ident" id="4979376">TransferEncoding</span><span class="op" id="4979392">)</span>&nbsp;<span class="op" id="4979394">&gt;</span>&nbsp;<span class="num" id="4979396">0</span>&nbsp;<span class="op" id="4979398">&amp;&amp;</span>&nbsp;<span class="ident" id="4979401">req</span><span class="op" id="4979404">.</span><span class="ident" id="4979405">TransferEncoding</span><span class="op" id="4979421">[</span><span class="num" id="4979422">0</span><span class="op" id="4979423">]</span>&nbsp;<span class="op" id="4979425">==</span>&nbsp;<span class="string" id="4979428">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4979439">if</span>&nbsp;<span class="builtinfunc" id="4979442">len</span><span class="op" id="4979445">(</span><span class="ident" id="4979446">req</span><span class="op" id="4979449">.</span><span class="ident" id="4979450">TransferEncoding</span><span class="op" id="4979466">)</span>&nbsp;<span class="op" id="4979468">&gt;</span>&nbsp;<span class="num" id="4979470">0</span>&nbsp;<span class="op" id="4979472">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979476">fmt</span><span class="op" id="4979479">.</span><span class="ident" id="4979480">Fprintf</span><span class="op" id="4979487">(</span><span class="op" id="4979488">&amp;</span><span class="ident" id="4979489">b</span><span class="op" id="4979490">,</span>&nbsp;<span class="string" id="4979492">&#34;Transfer-Encoding:&nbsp;%s\r\n&#34;</span><span class="op" id="4979519">,</span>&nbsp;<span class="ident" id="4979521">strings</span><span class="op" id="4979528">.</span><span class="ident" id="4979529">Join</span><span class="op" id="4979533">(</span><span class="ident" id="4979534">req</span><span class="op" id="4979537">.</span><span class="ident" id="4979538">TransferEncoding</span><span class="op" id="4979554">,</span>&nbsp;<span class="string" id="4979556">&#34;,&#34;</span><span class="op" id="4979559">)</span><span class="op" id="4979560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4979563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4979566">if</span>&nbsp;<span class="ident" id="4979569">req</span><span class="op" id="4979572">.</span><span class="ident" id="4979573">Close</span>&nbsp;<span class="op" id="4979579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979583">fmt</span><span class="op" id="4979586">.</span><span class="ident" id="4979587">Fprintf</span><span class="op" id="4979594">(</span><span class="op" id="4979595">&amp;</span><span class="ident" id="4979596">b</span><span class="op" id="4979597">,</span>&nbsp;<span class="string" id="4979599">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="4979622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4979625">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979629">err</span>&nbsp;<span class="op" id="4979633">=</span>&nbsp;<span class="ident" id="4979635">req</span><span class="op" id="4979638">.</span><span class="ident" id="4979639">Header</span><span class="op" id="4979645">.</span><span class="ident" id="4979646">WriteSubset</span><span class="op" id="4979657">(</span><span class="op" id="4979658">&amp;</span><span class="ident" id="4979659">b</span><span class="op" id="4979660">,</span>&nbsp;<span class="ident" id="4979662">reqWriteExcludeHeaderDump</span><span class="op" id="4979687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4979690">if</span>&nbsp;<span class="ident" id="4979693">err</span>&nbsp;<span class="op" id="4979697">!=</span>&nbsp;<span class="builtintype" id="4979700">nil</span>&nbsp;<span class="op" id="4979704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4979708">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4979716">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979720">io</span><span class="op" id="4979722">.</span><span class="ident" id="4979723">WriteString</span><span class="op" id="4979734">(</span><span class="op" id="4979735">&amp;</span><span class="ident" id="4979736">b</span><span class="op" id="4979737">,</span>&nbsp;<span class="string" id="4979739">&#34;\r\n&#34;</span><span class="op" id="4979745">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4979749">if</span>&nbsp;<span class="ident" id="4979752">req</span><span class="op" id="4979755">.</span><span class="ident" id="4979756">Body</span>&nbsp;<span class="op" id="4979761">!=</span>&nbsp;<span class="builtintype" id="4979764">nil</span>&nbsp;<span class="op" id="4979768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4979772">var</span>&nbsp;<span class="ident" id="4979776">dest</span>&nbsp;<span class="ident" id="4979781">io</span><span class="op" id="4979783">.</span><span class="ident" id="4979784">Writer</span>&nbsp;<span class="op" id="4979791">=</span>&nbsp;<span class="op" id="4979793">&amp;</span><span class="ident" id="4979794">b</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4979798">if</span>&nbsp;<span class="ident" id="4979801">chunked</span>&nbsp;<span class="op" id="4979809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979814">dest</span>&nbsp;<span class="op" id="4979819">=</span>&nbsp;<span class="ident" id="4979821">NewChunkedWriter</span><span class="op" id="4979837">(</span><span class="ident" id="4979838">dest</span><span class="op" id="4979842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4979846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979850">_</span><span class="op" id="4979851">,</span>&nbsp;<span class="ident" id="4979853">err</span>&nbsp;<span class="op" id="4979857">=</span>&nbsp;<span class="ident" id="4979859">io</span><span class="op" id="4979861">.</span><span class="ident" id="4979862">Copy</span><span class="op" id="4979866">(</span><span class="ident" id="4979867">dest</span><span class="op" id="4979871">,</span>&nbsp;<span class="ident" id="4979873">req</span><span class="op" id="4979876">.</span><span class="ident" id="4979877">Body</span><span class="op" id="4979881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4979885">if</span>&nbsp;<span class="ident" id="4979888">chunked</span>&nbsp;<span class="op" id="4979896">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979901">dest</span><span class="op" id="4979905">.</span><span class="op" id="4979906">(</span><span class="ident" id="4979907">io</span><span class="op" id="4979909">.</span><span class="ident" id="4979910">Closer</span><span class="op" id="4979916">)</span><span class="op" id="4979917">.</span><span class="ident" id="4979918">Close</span><span class="op" id="4979923">(</span><span class="op" id="4979924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979929">io</span><span class="op" id="4979931">.</span><span class="ident" id="4979932">WriteString</span><span class="op" id="4979943">(</span><span class="op" id="4979944">&amp;</span><span class="ident" id="4979945">b</span><span class="op" id="4979946">,</span>&nbsp;<span class="string" id="4979948">&#34;\r\n&#34;</span><span class="op" id="4979954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4979958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4979961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4979965">req</span><span class="op" id="4979968">.</span><span class="ident" id="4979969">Body</span>&nbsp;<span class="op" id="4979974">=</span>&nbsp;<span class="ident" id="4979976">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4979982">if</span>&nbsp;<span class="ident" id="4979985">err</span>&nbsp;<span class="op" id="4979989">!=</span>&nbsp;<span class="builtintype" id="4979992">nil</span>&nbsp;<span class="op" id="4979996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4980000">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4980008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4980011">dump</span>&nbsp;<span class="op" id="4980016">=</span>&nbsp;<span class="ident" id="4980018">b</span><span class="op" id="4980019">.</span><span class="ident" id="4980020">Bytes</span><span class="op" id="4980025">(</span><span class="op" id="4980026">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4980029">return</span><br>
<span class="lineno"></span><span class="op" id="4980036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4980039">//&nbsp;errNoBody&nbsp;is&nbsp;a&nbsp;sentinel&nbsp;error&nbsp;value&nbsp;used&nbsp;by&nbsp;failureToReadBody&nbsp;so&nbsp;we&nbsp;can&nbsp;detect</span><br>
<span class="lineno"></span><span class="comment" id="4980121">//&nbsp;that&nbsp;the&nbsp;lack&nbsp;of&nbsp;body&nbsp;was&nbsp;intentional.</span><br>
<span class="lineno">245</span><span class="keyword" id="4980163">var</span>&nbsp;<span class="ident" id="4980167">errNoBody</span>&nbsp;<span class="op" id="4980177">=</span>&nbsp;<span class="ident" id="4980179">errors</span><span class="op" id="4980185">.</span><span class="ident" id="4980186">New</span><span class="op" id="4980189">(</span><span class="string" id="4980190">&#34;sentinel&nbsp;error&nbsp;value&#34;</span><span class="op" id="4980212">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4980215">//&nbsp;failureToReadBody&nbsp;is&nbsp;a&nbsp;io.ReadCloser&nbsp;that&nbsp;just&nbsp;returns&nbsp;errNoBody&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="4980286">//&nbsp;Read.&nbsp;&nbsp;It&#39;s&nbsp;swapped&nbsp;in&nbsp;when&nbsp;we&nbsp;don&#39;t&nbsp;actually&nbsp;want&nbsp;to&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4980355">//&nbsp;body,&nbsp;but&nbsp;need&nbsp;a&nbsp;non-nil&nbsp;one,&nbsp;and&nbsp;want&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;error</span><br>
<span class="lineno">250</span><span class="comment" id="4980422">//&nbsp;from&nbsp;reading&nbsp;the&nbsp;dummy&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="4980454">type</span>&nbsp;<span class="ident" id="4980459">failureToReadBody</span>&nbsp;<span class="keyword" id="4980477">struct</span><span class="op" id="4980483">{</span><span class="op" id="4980484">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4980487">func</span>&nbsp;<span class="op" id="4980492">(</span><span class="ident" id="4980493">failureToReadBody</span><span class="op" id="4980510">)</span>&nbsp;<span class="ident" id="4980512">Read</span><span class="op" id="4980516">(</span><span class="op" id="4980517">[</span><span class="op" id="4980518">]</span><span class="builtintype" id="4980519">byte</span><span class="op" id="4980523">)</span>&nbsp;<span class="op" id="4980525">(</span><span class="builtintype" id="4980526">int</span><span class="op" id="4980529">,</span>&nbsp;<span class="builtintype" id="4980531">error</span><span class="op" id="4980536">)</span>&nbsp;<span class="op" id="4980538">{</span>&nbsp;<span class="keyword" id="4980540">return</span>&nbsp;<span class="num" id="4980547">0</span><span class="op" id="4980548">,</span>&nbsp;<span class="ident" id="4980550">errNoBody</span>&nbsp;<span class="op" id="4980560">}</span><br>
<span class="lineno"></span><span class="keyword" id="4980562">func</span>&nbsp;<span class="op" id="4980567">(</span><span class="ident" id="4980568">failureToReadBody</span><span class="op" id="4980585">)</span>&nbsp;<span class="ident" id="4980587">Close</span><span class="op" id="4980592">(</span><span class="op" id="4980593">)</span>&nbsp;<span class="builtintype" id="4980595">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4980613">{</span>&nbsp;<span class="keyword" id="4980615">return</span>&nbsp;<span class="builtintype" id="4980622">nil</span>&nbsp;<span class="op" id="4980626">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="4980629">var</span>&nbsp;<span class="ident" id="4980633">emptyBody</span>&nbsp;<span class="op" id="4980643">=</span>&nbsp;<span class="ident" id="4980645">ioutil</span><span class="op" id="4980651">.</span><span class="ident" id="4980652">NopCloser</span><span class="op" id="4980661">(</span><span class="ident" id="4980662">strings</span><span class="op" id="4980669">.</span><span class="ident" id="4980670">NewReader</span><span class="op" id="4980679">(</span><span class="string" id="4980680">&#34;&#34;</span><span class="op" id="4980682">)</span><span class="op" id="4980683">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4980686">//&nbsp;DumpResponse&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;dumps&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="4980744">func</span>&nbsp;<span class="ident" id="4980749">DumpResponse</span><span class="op" id="4980761">(</span><span class="ident" id="4980762">resp</span>&nbsp;<span class="op" id="4980767">*</span><span class="ident" id="4980768">http</span><span class="op" id="4980772">.</span><span class="ident" id="4980773">Response</span><span class="op" id="4980781">,</span>&nbsp;<span class="ident" id="4980783">body</span>&nbsp;<span class="builtintype" id="4980788">bool</span><span class="op" id="4980792">)</span>&nbsp;<span class="op" id="4980794">(</span><span class="ident" id="4980795">dump</span>&nbsp;<span class="op" id="4980800">[</span><span class="op" id="4980801">]</span><span class="builtintype" id="4980802">byte</span><span class="op" id="4980806">,</span>&nbsp;<span class="ident" id="4980808">err</span>&nbsp;<span class="builtintype" id="4980812">error</span><span class="op" id="4980817">)</span>&nbsp;<span class="op" id="4980819">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4980822">var</span>&nbsp;<span class="ident" id="4980826">b</span>&nbsp;<span class="ident" id="4980828">bytes</span><span class="op" id="4980833">.</span><span class="ident" id="4980834">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4980842">save</span>&nbsp;<span class="op" id="4980847">:=</span>&nbsp;<span class="ident" id="4980850">resp</span><span class="op" id="4980854">.</span><span class="ident" id="4980855">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4980861">savecl</span>&nbsp;<span class="op" id="4980868">:=</span>&nbsp;<span class="ident" id="4980871">resp</span><span class="op" id="4980875">.</span><span class="ident" id="4980876">ContentLength</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4980892">if</span>&nbsp;<span class="op" id="4980895">!</span><span class="ident" id="4980896">body</span>&nbsp;<span class="op" id="4980901">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4980905">resp</span><span class="op" id="4980909">.</span><span class="ident" id="4980910">Body</span>&nbsp;<span class="op" id="4980915">=</span>&nbsp;<span class="ident" id="4980917">failureToReadBody</span><span class="op" id="4980934">{</span><span class="op" id="4980935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4980938">}</span>&nbsp;<span class="keyword" id="4980940">else</span>&nbsp;<span class="keyword" id="4980945">if</span>&nbsp;<span class="ident" id="4980948">resp</span><span class="op" id="4980952">.</span><span class="ident" id="4980953">Body</span>&nbsp;<span class="op" id="4980958">==</span>&nbsp;<span class="builtintype" id="4980961">nil</span>&nbsp;<span class="op" id="4980965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4980969">resp</span><span class="op" id="4980973">.</span><span class="ident" id="4980974">Body</span>&nbsp;<span class="op" id="4980979">=</span>&nbsp;<span class="ident" id="4980981">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4980992">}</span>&nbsp;<span class="keyword" id="4980994">else</span>&nbsp;<span class="op" id="4980999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4981003">save</span><span class="op" id="4981007">,</span>&nbsp;<span class="ident" id="4981009">resp</span><span class="op" id="4981013">.</span><span class="ident" id="4981014">Body</span><span class="op" id="4981018">,</span>&nbsp;<span class="ident" id="4981020">err</span>&nbsp;<span class="op" id="4981024">=</span>&nbsp;<span class="ident" id="4981026">drainBody</span><span class="op" id="4981035">(</span><span class="ident" id="4981036">resp</span><span class="op" id="4981040">.</span><span class="ident" id="4981041">Body</span><span class="op" id="4981045">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4981049">if</span>&nbsp;<span class="ident" id="4981052">err</span>&nbsp;<span class="op" id="4981056">!=</span>&nbsp;<span class="builtintype" id="4981059">nil</span>&nbsp;<span class="op" id="4981063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4981068">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4981077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4981080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4981083">err</span>&nbsp;<span class="op" id="4981087">=</span>&nbsp;<span class="ident" id="4981089">resp</span><span class="op" id="4981093">.</span><span class="ident" id="4981094">Write</span><span class="op" id="4981099">(</span><span class="op" id="4981100">&amp;</span><span class="ident" id="4981101">b</span><span class="op" id="4981102">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4981105">if</span>&nbsp;<span class="ident" id="4981108">err</span>&nbsp;<span class="op" id="4981112">==</span>&nbsp;<span class="ident" id="4981115">errNoBody</span>&nbsp;<span class="op" id="4981125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4981129">err</span>&nbsp;<span class="op" id="4981133">=</span>&nbsp;<span class="builtintype" id="4981135">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4981140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4981143">resp</span><span class="op" id="4981147">.</span><span class="ident" id="4981148">Body</span>&nbsp;<span class="op" id="4981153">=</span>&nbsp;<span class="ident" id="4981155">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4981161">resp</span><span class="op" id="4981165">.</span><span class="ident" id="4981166">ContentLength</span>&nbsp;<span class="op" id="4981180">=</span>&nbsp;<span class="ident" id="4981182">savecl</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4981190">if</span>&nbsp;<span class="ident" id="4981193">err</span>&nbsp;<span class="op" id="4981197">!=</span>&nbsp;<span class="builtintype" id="4981200">nil</span>&nbsp;<span class="op" id="4981204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4981208">return</span>&nbsp;<span class="builtintype" id="4981215">nil</span><span class="op" id="4981218">,</span>&nbsp;<span class="ident" id="4981220">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4981225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4981228">return</span>&nbsp;<span class="ident" id="4981235">b</span><span class="op" id="4981236">.</span><span class="ident" id="4981237">Bytes</span><span class="op" id="4981242">(</span><span class="op" id="4981243">)</span><span class="op" id="4981244">,</span>&nbsp;<span class="builtintype" id="4981246">nil</span><br>
<span class="lineno"></span><span class="op" id="4981250">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
