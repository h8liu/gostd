<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1437810">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1437866">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1437920">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1437971">//&nbsp;Cgo&nbsp;call&nbsp;and&nbsp;callback&nbsp;support.</span><br>
<span class="lineno"></span><span class="comment" id="1438005">//</span><br>
<span class="lineno"></span><span class="comment" id="1438008">//&nbsp;To&nbsp;call&nbsp;into&nbsp;the&nbsp;C&nbsp;function&nbsp;f&nbsp;from&nbsp;Go,&nbsp;the&nbsp;cgo-generated&nbsp;code&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="1438079">//&nbsp;runtime.cgocall(_cgo_Cfunc_f,&nbsp;frame),&nbsp;where&nbsp;_cgo_Cfunc_f&nbsp;is&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1438144">//&nbsp;gcc-compiled&nbsp;function&nbsp;written&nbsp;by&nbsp;cgo.</span><br>
<span class="lineno">10</span><span class="comment" id="1438185">//</span><br>
<span class="lineno"></span><span class="comment" id="1438188">//&nbsp;runtime.cgocall&nbsp;(below)&nbsp;locks&nbsp;g&nbsp;to&nbsp;m,&nbsp;calls&nbsp;entersyscall</span><br>
<span class="lineno"></span><span class="comment" id="1438248">//&nbsp;so&nbsp;as&nbsp;not&nbsp;to&nbsp;block&nbsp;other&nbsp;goroutines&nbsp;or&nbsp;the&nbsp;garbage&nbsp;collector,</span><br>
<span class="lineno"></span><span class="comment" id="1438313">//&nbsp;and&nbsp;then&nbsp;calls&nbsp;runtime.asmcgocall(_cgo_Cfunc_f,&nbsp;frame).</span><br>
<span class="lineno"></span><span class="comment" id="1438372">//</span><br>
<span class="lineno">15</span><span class="comment" id="1438375">//&nbsp;runtime.asmcgocall&nbsp;(in&nbsp;asm_$GOARCH.s)&nbsp;switches&nbsp;to&nbsp;the&nbsp;m-&gt;g0&nbsp;stack</span><br>
<span class="lineno"></span><span class="comment" id="1438444">//&nbsp;(assumed&nbsp;to&nbsp;be&nbsp;an&nbsp;operating&nbsp;system-allocated&nbsp;stack,&nbsp;so&nbsp;safe&nbsp;to&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="1438514">//&nbsp;gcc-compiled&nbsp;code&nbsp;on)&nbsp;and&nbsp;calls&nbsp;_cgo_Cfunc_f(frame).</span><br>
<span class="lineno"></span><span class="comment" id="1438570">//</span><br>
<span class="lineno"></span><span class="comment" id="1438573">//&nbsp;_cgo_Cfunc_f&nbsp;invokes&nbsp;the&nbsp;actual&nbsp;C&nbsp;function&nbsp;f&nbsp;with&nbsp;arguments</span><br>
<span class="lineno">20</span><span class="comment" id="1438636">//&nbsp;taken&nbsp;from&nbsp;the&nbsp;frame&nbsp;structure,&nbsp;records&nbsp;the&nbsp;results&nbsp;in&nbsp;the&nbsp;frame,</span><br>
<span class="lineno"></span><span class="comment" id="1438705">//&nbsp;and&nbsp;returns&nbsp;to&nbsp;runtime.asmcgocall.</span><br>
<span class="lineno"></span><span class="comment" id="1438743">//</span><br>
<span class="lineno"></span><span class="comment" id="1438746">//&nbsp;After&nbsp;it&nbsp;regains&nbsp;control,&nbsp;runtime.asmcgocall&nbsp;switches&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1438815">//&nbsp;original&nbsp;g&nbsp;(m-&gt;curg)&#39;s&nbsp;stack&nbsp;and&nbsp;returns&nbsp;to&nbsp;runtime.cgocall.</span><br>
<span class="lineno">25</span><span class="comment" id="1438879">//</span><br>
<span class="lineno"></span><span class="comment" id="1438882">//&nbsp;After&nbsp;it&nbsp;regains&nbsp;control,&nbsp;runtime.cgocall&nbsp;calls&nbsp;exitsyscall,&nbsp;which&nbsp;blocks</span><br>
<span class="lineno"></span><span class="comment" id="1438959">//&nbsp;until&nbsp;this&nbsp;m&nbsp;can&nbsp;run&nbsp;Go&nbsp;code&nbsp;without&nbsp;violating&nbsp;the&nbsp;$GOMAXPROCS&nbsp;limit,</span><br>
<span class="lineno"></span><span class="comment" id="1439032">//&nbsp;and&nbsp;then&nbsp;unlocks&nbsp;g&nbsp;from&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1439062">//</span><br>
<span class="lineno">30</span><span class="comment" id="1439065">//&nbsp;The&nbsp;above&nbsp;description&nbsp;skipped&nbsp;over&nbsp;the&nbsp;possibility&nbsp;of&nbsp;the&nbsp;gcc-compiled</span><br>
<span class="lineno"></span><span class="comment" id="1439139">//&nbsp;function&nbsp;f&nbsp;calling&nbsp;back&nbsp;into&nbsp;Go.&nbsp;&nbsp;If&nbsp;that&nbsp;happens,&nbsp;we&nbsp;continue&nbsp;down</span><br>
<span class="lineno"></span><span class="comment" id="1439210">//&nbsp;the&nbsp;rabbit&nbsp;hole&nbsp;during&nbsp;the&nbsp;execution&nbsp;of&nbsp;f.</span><br>
<span class="lineno"></span><span class="comment" id="1439256">//</span><br>
<span class="lineno"></span><span class="comment" id="1439259">//&nbsp;To&nbsp;make&nbsp;it&nbsp;possible&nbsp;for&nbsp;gcc-compiled&nbsp;C&nbsp;code&nbsp;to&nbsp;call&nbsp;a&nbsp;Go&nbsp;function&nbsp;p.GoF,</span><br>
<span class="lineno">35</span><span class="comment" id="1439335">//&nbsp;cgo&nbsp;writes&nbsp;a&nbsp;gcc-compiled&nbsp;function&nbsp;named&nbsp;GoF&nbsp;(not&nbsp;p.GoF,&nbsp;since&nbsp;gcc&nbsp;doesn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="1439413">//&nbsp;know&nbsp;about&nbsp;packages).&nbsp;&nbsp;The&nbsp;gcc-compiled&nbsp;C&nbsp;function&nbsp;f&nbsp;calls&nbsp;GoF.</span><br>
<span class="lineno"></span><span class="comment" id="1439480">//</span><br>
<span class="lineno"></span><span class="comment" id="1439483">//&nbsp;GoF&nbsp;calls&nbsp;crosscall2(_cgoexp_GoF,&nbsp;frame,&nbsp;framesize).&nbsp;&nbsp;Crosscall2</span><br>
<span class="lineno"></span><span class="comment" id="1439551">//&nbsp;(in&nbsp;cgo/gcc_$GOARCH.S,&nbsp;a&nbsp;gcc-compiled&nbsp;assembly&nbsp;file)&nbsp;is&nbsp;a&nbsp;two-argument</span><br>
<span class="lineno">40</span><span class="comment" id="1439625">//&nbsp;adapter&nbsp;from&nbsp;the&nbsp;gcc&nbsp;function&nbsp;call&nbsp;ABI&nbsp;to&nbsp;the&nbsp;6c&nbsp;function&nbsp;call&nbsp;ABI.</span><br>
<span class="lineno"></span><span class="comment" id="1439696">//&nbsp;It&nbsp;is&nbsp;called&nbsp;from&nbsp;gcc&nbsp;to&nbsp;call&nbsp;6c&nbsp;functions.&nbsp;&nbsp;In&nbsp;this&nbsp;case&nbsp;it&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="1439766">//&nbsp;_cgoexp_GoF(frame,&nbsp;framesize),&nbsp;still&nbsp;running&nbsp;on&nbsp;m-&gt;g0&#39;s&nbsp;stack</span><br>
<span class="lineno"></span><span class="comment" id="1439831">//&nbsp;and&nbsp;outside&nbsp;the&nbsp;$GOMAXPROCS&nbsp;limit.&nbsp;&nbsp;Thus,&nbsp;this&nbsp;code&nbsp;cannot&nbsp;yet</span><br>
<span class="lineno"></span><span class="comment" id="1439897">//&nbsp;call&nbsp;arbitrary&nbsp;Go&nbsp;code&nbsp;directly&nbsp;and&nbsp;must&nbsp;be&nbsp;careful&nbsp;not&nbsp;to&nbsp;allocate</span><br>
<span class="lineno">45</span><span class="comment" id="1439968">//&nbsp;memory&nbsp;or&nbsp;use&nbsp;up&nbsp;m-&gt;g0&#39;s&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="1440003">//</span><br>
<span class="lineno"></span><span class="comment" id="1440006">//&nbsp;_cgoexp_GoF&nbsp;calls&nbsp;runtime.cgocallback(p.GoF,&nbsp;frame,&nbsp;framesize).</span><br>
<span class="lineno"></span><span class="comment" id="1440073">//&nbsp;(The&nbsp;reason&nbsp;for&nbsp;having&nbsp;_cgoexp_GoF&nbsp;instead&nbsp;of&nbsp;writing&nbsp;a&nbsp;crosscall3</span><br>
<span class="lineno"></span><span class="comment" id="1440143">//&nbsp;to&nbsp;make&nbsp;this&nbsp;call&nbsp;directly&nbsp;is&nbsp;that&nbsp;_cgoexp_GoF,&nbsp;because&nbsp;it&nbsp;is&nbsp;compiled</span><br>
<span class="lineno">50</span><span class="comment" id="1440217">//&nbsp;with&nbsp;6c&nbsp;instead&nbsp;of&nbsp;gcc,&nbsp;can&nbsp;refer&nbsp;to&nbsp;dotted&nbsp;names&nbsp;like</span><br>
<span class="lineno"></span><span class="comment" id="1440275">//&nbsp;runtime.cgocallback&nbsp;and&nbsp;p.GoF.)</span><br>
<span class="lineno"></span><span class="comment" id="1440310">//</span><br>
<span class="lineno"></span><span class="comment" id="1440313">//&nbsp;runtime.cgocallback&nbsp;(in&nbsp;asm_$GOARCH.s)&nbsp;switches&nbsp;from&nbsp;m-&gt;g0&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="1440377">//&nbsp;stack&nbsp;to&nbsp;the&nbsp;original&nbsp;g&nbsp;(m-&gt;curg)&#39;s&nbsp;stack,&nbsp;on&nbsp;which&nbsp;it&nbsp;calls</span><br>
<span class="lineno">55</span><span class="comment" id="1440441">//&nbsp;runtime.cgocallbackg(p.GoF,&nbsp;frame,&nbsp;framesize).</span><br>
<span class="lineno"></span><span class="comment" id="1440491">//&nbsp;As&nbsp;part&nbsp;of&nbsp;the&nbsp;stack&nbsp;switch,&nbsp;runtime.cgocallback&nbsp;saves&nbsp;the&nbsp;current</span><br>
<span class="lineno"></span><span class="comment" id="1440561">//&nbsp;SP&nbsp;as&nbsp;m-&gt;g0-&gt;sched.sp,&nbsp;so&nbsp;that&nbsp;any&nbsp;use&nbsp;of&nbsp;m-&gt;g0&#39;s&nbsp;stack&nbsp;during&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1440631">//&nbsp;execution&nbsp;of&nbsp;the&nbsp;callback&nbsp;will&nbsp;be&nbsp;done&nbsp;below&nbsp;the&nbsp;existing&nbsp;stack&nbsp;frames.</span><br>
<span class="lineno"></span><span class="comment" id="1440706">//&nbsp;Before&nbsp;overwriting&nbsp;m-&gt;g0-&gt;sched.sp,&nbsp;it&nbsp;pushes&nbsp;the&nbsp;old&nbsp;value&nbsp;on&nbsp;the</span><br>
<span class="lineno">60</span><span class="comment" id="1440776">//&nbsp;m-&gt;g0&nbsp;stack,&nbsp;so&nbsp;that&nbsp;it&nbsp;can&nbsp;be&nbsp;restored&nbsp;later.</span><br>
<span class="lineno"></span><span class="comment" id="1440826">//</span><br>
<span class="lineno"></span><span class="comment" id="1440829">//&nbsp;runtime.cgocallbackg&nbsp;(below)&nbsp;is&nbsp;now&nbsp;running&nbsp;on&nbsp;a&nbsp;real&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1440896">//&nbsp;stack&nbsp;(not&nbsp;an&nbsp;m-&gt;g0&nbsp;stack).&nbsp;&nbsp;First&nbsp;it&nbsp;calls&nbsp;runtime.exitsyscall,&nbsp;which&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="1440975">//&nbsp;block&nbsp;until&nbsp;the&nbsp;$GOMAXPROCS&nbsp;limit&nbsp;allows&nbsp;running&nbsp;this&nbsp;goroutine.</span><br>
<span class="lineno">65</span><span class="comment" id="1441043">//&nbsp;Once&nbsp;exitsyscall&nbsp;has&nbsp;returned,&nbsp;it&nbsp;is&nbsp;safe&nbsp;to&nbsp;do&nbsp;things&nbsp;like&nbsp;call&nbsp;the&nbsp;memory</span><br>
<span class="lineno"></span><span class="comment" id="1441122">//&nbsp;allocator&nbsp;or&nbsp;invoke&nbsp;the&nbsp;Go&nbsp;callback&nbsp;function&nbsp;p.GoF.&nbsp;&nbsp;runtime.cgocallbackg</span><br>
<span class="lineno"></span><span class="comment" id="1441199">//&nbsp;first&nbsp;defers&nbsp;a&nbsp;function&nbsp;to&nbsp;unwind&nbsp;m-&gt;g0.sched.sp,&nbsp;so&nbsp;that&nbsp;if&nbsp;p.GoF</span><br>
<span class="lineno"></span><span class="comment" id="1441269">//&nbsp;panics,&nbsp;m-&gt;g0.sched.sp&nbsp;will&nbsp;be&nbsp;restored&nbsp;to&nbsp;its&nbsp;old&nbsp;value:&nbsp;the&nbsp;m-&gt;g0&nbsp;stack</span><br>
<span class="lineno"></span><span class="comment" id="1441346">//&nbsp;and&nbsp;the&nbsp;m-&gt;curg&nbsp;stack&nbsp;will&nbsp;be&nbsp;unwound&nbsp;in&nbsp;lock&nbsp;step.</span><br>
<span class="lineno">70</span><span class="comment" id="1441401">//&nbsp;Then&nbsp;it&nbsp;calls&nbsp;p.GoF.&nbsp;&nbsp;Finally&nbsp;it&nbsp;pops&nbsp;but&nbsp;does&nbsp;not&nbsp;execute&nbsp;the&nbsp;deferred</span><br>
<span class="lineno"></span><span class="comment" id="1441476">//&nbsp;function,&nbsp;calls&nbsp;runtime.entersyscall,&nbsp;and&nbsp;returns&nbsp;to&nbsp;runtime.cgocallback.</span><br>
<span class="lineno"></span><span class="comment" id="1441553">//</span><br>
<span class="lineno"></span><span class="comment" id="1441556">//&nbsp;After&nbsp;it&nbsp;regains&nbsp;control,&nbsp;runtime.cgocallback&nbsp;switches&nbsp;back&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1441622">//&nbsp;m-&gt;g0&#39;s&nbsp;stack&nbsp;(the&nbsp;pointer&nbsp;is&nbsp;still&nbsp;in&nbsp;m-&gt;g0.sched.sp),&nbsp;restores&nbsp;the&nbsp;old</span><br>
<span class="lineno">75</span><span class="comment" id="1441698">//&nbsp;m-&gt;g0.sched.sp&nbsp;value&nbsp;from&nbsp;the&nbsp;stack,&nbsp;and&nbsp;returns&nbsp;to&nbsp;_cgoexp_GoF.</span><br>
<span class="lineno"></span><span class="comment" id="1441766">//</span><br>
<span class="lineno"></span><span class="comment" id="1441769">//&nbsp;_cgoexp_GoF&nbsp;immediately&nbsp;returns&nbsp;to&nbsp;crosscall2,&nbsp;which&nbsp;restores&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1441838">//&nbsp;callee-save&nbsp;registers&nbsp;for&nbsp;gcc&nbsp;and&nbsp;returns&nbsp;to&nbsp;GoF,&nbsp;which&nbsp;returns&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="1441912">package</span>&nbsp;<span class="ident" id="1441920">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1441929">import</span>&nbsp;<span class="string" id="1441936">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1441946">//&nbsp;Call&nbsp;from&nbsp;Go&nbsp;to&nbsp;C.</span><br>
<span class="lineno">85</span><span class="comment" id="1441968">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1441981">func</span>&nbsp;<span class="ident" id="1441986">cgocall</span><span class="op" id="1441993">(</span><span class="ident" id="1441994">fn</span><span class="op" id="1441996">,</span>&nbsp;<span class="ident" id="1441998">arg</span>&nbsp;<span class="ident" id="1442002">unsafe</span><span class="op" id="1442008">.</span><span class="ident" id="1442009">Pointer</span><span class="op" id="1442016">)</span>&nbsp;<span class="op" id="1442018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442021">cgocall_errno</span><span class="op" id="1442034">(</span><span class="ident" id="1442035">fn</span><span class="op" id="1442037">,</span>&nbsp;<span class="ident" id="1442039">arg</span><span class="op" id="1442042">)</span><br>
<span class="lineno"></span><span class="op" id="1442044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="1442047">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1442060">func</span>&nbsp;<span class="ident" id="1442065">cgocall_errno</span><span class="op" id="1442078">(</span><span class="ident" id="1442079">fn</span><span class="op" id="1442081">,</span>&nbsp;<span class="ident" id="1442083">arg</span>&nbsp;<span class="ident" id="1442087">unsafe</span><span class="op" id="1442093">.</span><span class="ident" id="1442094">Pointer</span><span class="op" id="1442101">)</span>&nbsp;<span class="builtintype" id="1442103">int32</span>&nbsp;<span class="op" id="1442109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1442112">if</span>&nbsp;<span class="op" id="1442115">!</span><span class="ident" id="1442116">iscgo</span>&nbsp;<span class="op" id="1442122">&amp;&amp;</span>&nbsp;<span class="ident" id="1442125">GOOS</span>&nbsp;<span class="op" id="1442130">!=</span>&nbsp;<span class="string" id="1442133">&#34;solaris&#34;</span>&nbsp;<span class="op" id="1442143">&amp;&amp;</span>&nbsp;<span class="ident" id="1442146">GOOS</span>&nbsp;<span class="op" id="1442151">!=</span>&nbsp;<span class="string" id="1442154">&#34;windows&#34;</span>&nbsp;<span class="op" id="1442164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442168">gothrow</span><span class="op" id="1442175">(</span><span class="string" id="1442176">&#34;cgocall&nbsp;unavailable&#34;</span><span class="op" id="1442197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1442200">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1442204">if</span>&nbsp;<span class="ident" id="1442207">fn</span>&nbsp;<span class="op" id="1442210">==</span>&nbsp;<span class="ident" id="1442213">nil</span>&nbsp;<span class="op" id="1442217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442221">gothrow</span><span class="op" id="1442228">(</span><span class="string" id="1442229">&#34;cgocall&nbsp;nil&#34;</span><span class="op" id="1442242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1442245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1442249">if</span>&nbsp;<span class="ident" id="1442252">raceenabled</span>&nbsp;<span class="op" id="1442264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442268">racereleasemerge</span><span class="op" id="1442284">(</span><span class="ident" id="1442285">unsafe</span><span class="op" id="1442291">.</span><span class="ident" id="1442292">Pointer</span><span class="op" id="1442299">(</span><span class="op" id="1442300">&amp;</span><span class="ident" id="1442301">racecgosync</span><span class="op" id="1442312">)</span><span class="op" id="1442313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1442316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1442320">//&nbsp;Create&nbsp;an&nbsp;extra&nbsp;M&nbsp;for&nbsp;callbacks&nbsp;on&nbsp;threads&nbsp;not&nbsp;created&nbsp;by&nbsp;Go&nbsp;on&nbsp;first&nbsp;cgo&nbsp;call.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1442404">if</span>&nbsp;<span class="ident" id="1442407">needextram</span>&nbsp;<span class="op" id="1442418">==</span>&nbsp;<span class="num" id="1442421">1</span>&nbsp;<span class="op" id="1442423">&amp;&amp;</span>&nbsp;<span class="ident" id="1442426">cas</span><span class="op" id="1442429">(</span><span class="op" id="1442430">&amp;</span><span class="ident" id="1442431">needextram</span><span class="op" id="1442441">,</span>&nbsp;<span class="num" id="1442443">1</span><span class="op" id="1442444">,</span>&nbsp;<span class="num" id="1442446">0</span><span class="op" id="1442447">)</span>&nbsp;<span class="op" id="1442449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442453">onM</span><span class="op" id="1442456">(</span><span class="ident" id="1442457">newextram</span><span class="op" id="1442466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1442469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1442473">/*<br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*&nbsp;Lock&nbsp;g&nbsp;to&nbsp;m&nbsp;to&nbsp;ensure&nbsp;we&nbsp;stay&nbsp;on&nbsp;the&nbsp;same&nbsp;stack&nbsp;if&nbsp;we&nbsp;do&nbsp;a<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*&nbsp;cgo&nbsp;callback.&nbsp;Add&nbsp;entry&nbsp;to&nbsp;defer&nbsp;stack&nbsp;in&nbsp;case&nbsp;of&nbsp;panic.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442606">lockOSThread</span><span class="op" id="1442618">(</span><span class="op" id="1442619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442622">mp</span>&nbsp;<span class="op" id="1442625">:=</span>&nbsp;<span class="ident" id="1442628">getg</span><span class="op" id="1442632">(</span><span class="op" id="1442633">)</span><span class="op" id="1442634">.</span><span class="ident" id="1442635">m</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442638">mp</span><span class="op" id="1442640">.</span><span class="ident" id="1442641">ncgocall</span><span class="op" id="1442649">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1442653">mp</span><span class="op" id="1442655">.</span><span class="ident" id="1442656">ncgo</span><span class="op" id="1442660">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1442664">defer</span>&nbsp;<span class="ident" id="1442670">endcgo</span><span class="op" id="1442676">(</span><span class="ident" id="1442677">mp</span><span class="op" id="1442679">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1442683">/*<br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*&nbsp;Announce&nbsp;we&nbsp;are&nbsp;entering&nbsp;a&nbsp;system&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*&nbsp;so&nbsp;that&nbsp;the&nbsp;scheduler&nbsp;knows&nbsp;to&nbsp;create&nbsp;another<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*&nbsp;M&nbsp;to&nbsp;run&nbsp;goroutines&nbsp;while&nbsp;we&nbsp;are&nbsp;in&nbsp;the<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*&nbsp;foreign&nbsp;code.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*<br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*&nbsp;The&nbsp;call&nbsp;to&nbsp;asmcgocall&nbsp;is&nbsp;guaranteed&nbsp;not&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*&nbsp;split&nbsp;the&nbsp;stack&nbsp;and&nbsp;does&nbsp;not&nbsp;allocate&nbsp;memory,<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*&nbsp;so&nbsp;it&nbsp;is&nbsp;safe&nbsp;to&nbsp;call&nbsp;while&nbsp;&#34;in&nbsp;a&nbsp;system&nbsp;call&#34;,&nbsp;outside<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*&nbsp;the&nbsp;$GOMAXPROCS&nbsp;accounting.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;*/</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443041">entersyscall</span><span class="op" id="1443053">(</span><span class="op" id="1443054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443057">errno</span>&nbsp;<span class="op" id="1443063">:=</span>&nbsp;<span class="ident" id="1443066">asmcgocall_errno</span><span class="op" id="1443082">(</span><span class="ident" id="1443083">fn</span><span class="op" id="1443085">,</span>&nbsp;<span class="ident" id="1443087">arg</span><span class="op" id="1443090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443093">exitsyscall</span><span class="op" id="1443104">(</span><span class="op" id="1443105">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1443109">return</span>&nbsp;<span class="ident" id="1443116">errno</span><br>
<span class="lineno">135</span><span class="op" id="1443122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1443125">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1443138">func</span>&nbsp;<span class="ident" id="1443143">endcgo</span><span class="op" id="1443149">(</span><span class="ident" id="1443150">mp</span>&nbsp;<span class="op" id="1443153">*</span><span class="ident" id="1443154">m</span><span class="op" id="1443155">)</span>&nbsp;<span class="op" id="1443157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443160">mp</span><span class="op" id="1443162">.</span><span class="ident" id="1443163">ncgo</span><span class="op" id="1443167">--</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1443171">if</span>&nbsp;<span class="ident" id="1443174">mp</span><span class="op" id="1443176">.</span><span class="ident" id="1443177">ncgo</span>&nbsp;<span class="op" id="1443182">==</span>&nbsp;<span class="num" id="1443185">0</span>&nbsp;<span class="op" id="1443187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1443191">//&nbsp;We&nbsp;are&nbsp;going&nbsp;back&nbsp;to&nbsp;Go&nbsp;and&nbsp;are&nbsp;not&nbsp;in&nbsp;a&nbsp;recursive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1443247">//&nbsp;call.&nbsp;&nbsp;Let&nbsp;the&nbsp;GC&nbsp;collect&nbsp;any&nbsp;memory&nbsp;allocated&nbsp;via</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1443303">//&nbsp;_cgo_allocate&nbsp;that&nbsp;is&nbsp;no&nbsp;longer&nbsp;referenced.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443352">mp</span><span class="op" id="1443354">.</span><span class="ident" id="1443355">cgomal</span>&nbsp;<span class="op" id="1443362">=</span>&nbsp;<span class="ident" id="1443364">nil</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1443369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1443373">if</span>&nbsp;<span class="ident" id="1443376">raceenabled</span>&nbsp;<span class="op" id="1443388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443392">raceacquire</span><span class="op" id="1443403">(</span><span class="ident" id="1443404">unsafe</span><span class="op" id="1443410">.</span><span class="ident" id="1443411">Pointer</span><span class="op" id="1443418">(</span><span class="op" id="1443419">&amp;</span><span class="ident" id="1443420">racecgosync</span><span class="op" id="1443431">)</span><span class="op" id="1443432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1443435">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443439">unlockOSThread</span><span class="op" id="1443453">(</span><span class="op" id="1443454">)</span>&nbsp;<span class="comment" id="1443456">//&nbsp;invalidates&nbsp;mp</span><br>
<span class="lineno"></span><span class="op" id="1443474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1443477">//&nbsp;Helper&nbsp;functions&nbsp;for&nbsp;cgo&nbsp;code.</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="1443512">//&nbsp;Filled&nbsp;by&nbsp;schedinit&nbsp;from&nbsp;corresponding&nbsp;C&nbsp;variables,</span><br>
<span class="lineno"></span><span class="comment" id="1443567">//&nbsp;which&nbsp;are&nbsp;in&nbsp;turn&nbsp;filled&nbsp;in&nbsp;by&nbsp;dynamic&nbsp;linker&nbsp;when&nbsp;Cgo&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1443639">var</span>&nbsp;<span class="ident" id="1443643">cgoMalloc</span><span class="op" id="1443652">,</span>&nbsp;<span class="ident" id="1443654">cgoFree</span>&nbsp;<span class="ident" id="1443662">unsafe</span><span class="op" id="1443668">.</span><span class="ident" id="1443669">Pointer</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="1443678">func</span>&nbsp;<span class="ident" id="1443683">cmalloc</span><span class="op" id="1443690">(</span><span class="ident" id="1443691">n</span>&nbsp;<span class="builtintype" id="1443693">uintptr</span><span class="op" id="1443700">)</span>&nbsp;<span class="ident" id="1443702">unsafe</span><span class="op" id="1443708">.</span><span class="ident" id="1443709">Pointer</span>&nbsp;<span class="op" id="1443717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1443720">var</span>&nbsp;<span class="ident" id="1443724">args</span>&nbsp;<span class="keyword" id="1443729">struct</span>&nbsp;<span class="op" id="1443736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443740">n</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1443744">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443753">ret</span>&nbsp;<span class="ident" id="1443757">unsafe</span><span class="op" id="1443763">.</span><span class="ident" id="1443764">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1443773">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443776">args</span><span class="op" id="1443780">.</span><span class="ident" id="1443781">n</span>&nbsp;<span class="op" id="1443783">=</span>&nbsp;<span class="ident" id="1443785">uint64</span><span class="op" id="1443791">(</span><span class="ident" id="1443792">n</span><span class="op" id="1443793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443796">cgocall</span><span class="op" id="1443803">(</span><span class="ident" id="1443804">cgoMalloc</span><span class="op" id="1443813">,</span>&nbsp;<span class="ident" id="1443815">unsafe</span><span class="op" id="1443821">.</span><span class="ident" id="1443822">Pointer</span><span class="op" id="1443829">(</span><span class="op" id="1443830">&amp;</span><span class="ident" id="1443831">args</span><span class="op" id="1443835">)</span><span class="op" id="1443836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1443839">if</span>&nbsp;<span class="ident" id="1443842">args</span><span class="op" id="1443846">.</span><span class="ident" id="1443847">ret</span>&nbsp;<span class="op" id="1443851">==</span>&nbsp;<span class="ident" id="1443854">nil</span>&nbsp;<span class="op" id="1443858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443862">gothrow</span><span class="op" id="1443869">(</span><span class="string" id="1443870">&#34;C&nbsp;malloc&nbsp;failed&#34;</span><span class="op" id="1443887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1443890">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1443893">return</span>&nbsp;<span class="ident" id="1443900">args</span><span class="op" id="1443904">.</span><span class="ident" id="1443905">ret</span><br>
<span class="lineno"></span><span class="op" id="1443909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1443912">func</span>&nbsp;<span class="ident" id="1443917">cfree</span><span class="op" id="1443922">(</span><span class="ident" id="1443923">p</span>&nbsp;<span class="ident" id="1443925">unsafe</span><span class="op" id="1443931">.</span><span class="ident" id="1443932">Pointer</span><span class="op" id="1443939">)</span>&nbsp;<span class="op" id="1443941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443944">cgocall</span><span class="op" id="1443951">(</span><span class="ident" id="1443952">cgoFree</span><span class="op" id="1443959">,</span>&nbsp;<span class="ident" id="1443961">p</span><span class="op" id="1443962">)</span><br>
<span class="lineno">175</span><span class="op" id="1443964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1443967">//&nbsp;Call&nbsp;from&nbsp;C&nbsp;back&nbsp;to&nbsp;Go.</span><br>
<span class="lineno"></span><span class="comment" id="1443994">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1444007">func</span>&nbsp;<span class="ident" id="1444012">cgocallbackg</span><span class="op" id="1444024">(</span><span class="op" id="1444025">)</span>&nbsp;<span class="op" id="1444027">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444030">gp</span>&nbsp;<span class="op" id="1444033">:=</span>&nbsp;<span class="ident" id="1444036">getg</span><span class="op" id="1444040">(</span><span class="op" id="1444041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1444044">if</span>&nbsp;<span class="ident" id="1444047">gp</span>&nbsp;<span class="op" id="1444050">!=</span>&nbsp;<span class="ident" id="1444053">gp</span><span class="op" id="1444055">.</span><span class="ident" id="1444056">m</span><span class="op" id="1444057">.</span><span class="ident" id="1444058">curg</span>&nbsp;<span class="op" id="1444063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1444067">println</span><span class="op" id="1444074">(</span><span class="string" id="1444075">&#34;runtime:&nbsp;bad&nbsp;g&nbsp;in&nbsp;cgocallback&#34;</span><span class="op" id="1444106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444110">exit</span><span class="op" id="1444114">(</span><span class="num" id="1444115">2</span><span class="op" id="1444116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1444119">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1444123">//&nbsp;entersyscall&nbsp;saves&nbsp;the&nbsp;caller&#39;s&nbsp;SP&nbsp;to&nbsp;allow&nbsp;the&nbsp;GC&nbsp;to&nbsp;trace&nbsp;the&nbsp;Go</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1444194">//&nbsp;stack.&nbsp;However,&nbsp;since&nbsp;we&#39;re&nbsp;returning&nbsp;to&nbsp;an&nbsp;earlier&nbsp;stack&nbsp;frame&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1444266">//&nbsp;need&nbsp;to&nbsp;pair&nbsp;with&nbsp;the&nbsp;entersyscall()&nbsp;call&nbsp;made&nbsp;by&nbsp;cgocall,&nbsp;we&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1444337">//&nbsp;save&nbsp;syscall*&nbsp;and&nbsp;let&nbsp;reentersyscall&nbsp;restore&nbsp;them.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444392">savedsp</span>&nbsp;<span class="op" id="1444400">:=</span>&nbsp;<span class="ident" id="1444403">unsafe</span><span class="op" id="1444409">.</span><span class="ident" id="1444410">Pointer</span><span class="op" id="1444417">(</span><span class="ident" id="1444418">gp</span><span class="op" id="1444420">.</span><span class="ident" id="1444421">syscallsp</span><span class="op" id="1444430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444433">savedpc</span>&nbsp;<span class="op" id="1444441">:=</span>&nbsp;<span class="ident" id="1444444">gp</span><span class="op" id="1444446">.</span><span class="ident" id="1444447">syscallpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444458">exitsyscall</span><span class="op" id="1444469">(</span><span class="op" id="1444470">)</span>&nbsp;<span class="comment" id="1444472">//&nbsp;coming&nbsp;out&nbsp;of&nbsp;cgo&nbsp;call</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444499">cgocallbackg1</span><span class="op" id="1444512">(</span><span class="op" id="1444513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1444516">//&nbsp;going&nbsp;back&nbsp;to&nbsp;cgo&nbsp;call</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444543">reentersyscall</span><span class="op" id="1444557">(</span><span class="ident" id="1444558">savedpc</span><span class="op" id="1444565">,</span>&nbsp;<span class="ident" id="1444567">savedsp</span><span class="op" id="1444574">)</span><br>
<span class="lineno"></span><span class="op" id="1444576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1444579">func</span>&nbsp;<span class="ident" id="1444584">cgocallbackg1</span><span class="op" id="1444597">(</span><span class="op" id="1444598">)</span>&nbsp;<span class="op" id="1444600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444603">gp</span>&nbsp;<span class="op" id="1444606">:=</span>&nbsp;<span class="ident" id="1444609">getg</span><span class="op" id="1444613">(</span><span class="op" id="1444614">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1444617">if</span>&nbsp;<span class="ident" id="1444620">gp</span><span class="op" id="1444622">.</span><span class="ident" id="1444623">m</span><span class="op" id="1444624">.</span><span class="ident" id="1444625">needextram</span>&nbsp;<span class="op" id="1444636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444640">gp</span><span class="op" id="1444642">.</span><span class="ident" id="1444643">m</span><span class="op" id="1444644">.</span><span class="ident" id="1444645">needextram</span>&nbsp;<span class="op" id="1444656">=</span>&nbsp;<span class="builtintype" id="1444658">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444666">onM</span><span class="op" id="1444669">(</span><span class="ident" id="1444670">newextram</span><span class="op" id="1444679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1444682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1444686">//&nbsp;Add&nbsp;entry&nbsp;to&nbsp;defer&nbsp;stack&nbsp;in&nbsp;case&nbsp;of&nbsp;panic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444733">restore</span>&nbsp;<span class="op" id="1444741">:=</span>&nbsp;<span class="builtintype" id="1444744">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1444750">defer</span>&nbsp;<span class="ident" id="1444756">unwindm</span><span class="op" id="1444763">(</span><span class="op" id="1444764">&amp;</span><span class="ident" id="1444765">restore</span><span class="op" id="1444772">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1444776">if</span>&nbsp;<span class="ident" id="1444779">raceenabled</span>&nbsp;<span class="op" id="1444791">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444795">raceacquire</span><span class="op" id="1444806">(</span><span class="ident" id="1444807">unsafe</span><span class="op" id="1444813">.</span><span class="ident" id="1444814">Pointer</span><span class="op" id="1444821">(</span><span class="op" id="1444822">&amp;</span><span class="ident" id="1444823">racecgosync</span><span class="op" id="1444834">)</span><span class="op" id="1444835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1444838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1444842">type</span>&nbsp;<span class="ident" id="1444847">args</span>&nbsp;<span class="keyword" id="1444852">struct</span>&nbsp;<span class="op" id="1444859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444863">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1444871">*</span><span class="ident" id="1444872">funcval</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444882">arg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1444890">unsafe</span><span class="op" id="1444896">.</span><span class="ident" id="1444897">Pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444907">argsize</span>&nbsp;<span class="builtintype" id="1444915">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1444924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1444927">var</span>&nbsp;<span class="ident" id="1444931">cb</span>&nbsp;<span class="op" id="1444934">*</span><span class="ident" id="1444935">args</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1444942">//&nbsp;Location&nbsp;of&nbsp;callback&nbsp;arguments&nbsp;depends&nbsp;on&nbsp;stack&nbsp;frame&nbsp;layout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1445007">//&nbsp;and&nbsp;size&nbsp;of&nbsp;stack&nbsp;frame&nbsp;of&nbsp;cgocallback_gofunc.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445058">sp</span>&nbsp;<span class="op" id="1445061">:=</span>&nbsp;<span class="ident" id="1445064">gp</span><span class="op" id="1445066">.</span><span class="ident" id="1445067">m</span><span class="op" id="1445068">.</span><span class="ident" id="1445069">g0</span><span class="op" id="1445071">.</span><span class="ident" id="1445072">sched</span><span class="op" id="1445077">.</span><span class="ident" id="1445078">sp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1445082">switch</span>&nbsp;<span class="ident" id="1445089">GOARCH</span>&nbsp;<span class="op" id="1445096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1445099">default</span><span class="op" id="1445106">:</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445110">gothrow</span><span class="op" id="1445117">(</span><span class="string" id="1445118">&#34;cgocallbackg&nbsp;is&nbsp;unimplemented&nbsp;on&nbsp;arch&#34;</span><span class="op" id="1445157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1445160">case</span>&nbsp;<span class="string" id="1445165">&#34;arm&#34;</span><span class="op" id="1445170">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1445174">//&nbsp;On&nbsp;arm,&nbsp;stack&nbsp;frame&nbsp;is&nbsp;two&nbsp;words&nbsp;and&nbsp;there&#39;s&nbsp;a&nbsp;saved&nbsp;LR&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1445243">//&nbsp;SP&nbsp;and&nbsp;the&nbsp;stack&nbsp;frame&nbsp;and&nbsp;between&nbsp;the&nbsp;stack&nbsp;frame&nbsp;and&nbsp;the&nbsp;arguments.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445318">cb</span>&nbsp;<span class="op" id="1445321">=</span>&nbsp;<span class="op" id="1445323">(</span><span class="op" id="1445324">*</span><span class="ident" id="1445325">args</span><span class="op" id="1445329">)</span><span class="op" id="1445330">(</span><span class="ident" id="1445331">unsafe</span><span class="op" id="1445337">.</span><span class="ident" id="1445338">Pointer</span><span class="op" id="1445345">(</span><span class="ident" id="1445346">sp</span>&nbsp;<span class="op" id="1445349">+</span>&nbsp;<span class="num" id="1445351">4</span><span class="op" id="1445352">*</span><span class="ident" id="1445353">ptrSize</span><span class="op" id="1445360">)</span><span class="op" id="1445361">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1445364">case</span>&nbsp;<span class="string" id="1445369">&#34;amd64&#34;</span><span class="op" id="1445376">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1445380">//&nbsp;On&nbsp;amd64,&nbsp;stack&nbsp;frame&nbsp;is&nbsp;one&nbsp;word,&nbsp;plus&nbsp;caller&nbsp;PC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445436">cb</span>&nbsp;<span class="op" id="1445439">=</span>&nbsp;<span class="op" id="1445441">(</span><span class="op" id="1445442">*</span><span class="ident" id="1445443">args</span><span class="op" id="1445447">)</span><span class="op" id="1445448">(</span><span class="ident" id="1445449">unsafe</span><span class="op" id="1445455">.</span><span class="ident" id="1445456">Pointer</span><span class="op" id="1445463">(</span><span class="ident" id="1445464">sp</span>&nbsp;<span class="op" id="1445467">+</span>&nbsp;<span class="num" id="1445469">2</span><span class="op" id="1445470">*</span><span class="ident" id="1445471">ptrSize</span><span class="op" id="1445478">)</span><span class="op" id="1445479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1445482">case</span>&nbsp;<span class="string" id="1445487">&#34;386&#34;</span><span class="op" id="1445492">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1445496">//&nbsp;On&nbsp;386,&nbsp;stack&nbsp;frame&nbsp;is&nbsp;three&nbsp;words,&nbsp;plus&nbsp;caller&nbsp;PC.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445553">cb</span>&nbsp;<span class="op" id="1445556">=</span>&nbsp;<span class="op" id="1445558">(</span><span class="op" id="1445559">*</span><span class="ident" id="1445560">args</span><span class="op" id="1445564">)</span><span class="op" id="1445565">(</span><span class="ident" id="1445566">unsafe</span><span class="op" id="1445572">.</span><span class="ident" id="1445573">Pointer</span><span class="op" id="1445580">(</span><span class="ident" id="1445581">sp</span>&nbsp;<span class="op" id="1445584">+</span>&nbsp;<span class="num" id="1445586">4</span><span class="op" id="1445587">*</span><span class="ident" id="1445588">ptrSize</span><span class="op" id="1445595">)</span><span class="op" id="1445596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1445599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1445603">//&nbsp;Invoke&nbsp;callback.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445624">reflectcall</span><span class="op" id="1445635">(</span><span class="ident" id="1445636">unsafe</span><span class="op" id="1445642">.</span><span class="ident" id="1445643">Pointer</span><span class="op" id="1445650">(</span><span class="ident" id="1445651">cb</span><span class="op" id="1445653">.</span><span class="ident" id="1445654">fn</span><span class="op" id="1445656">)</span><span class="op" id="1445657">,</span>&nbsp;<span class="ident" id="1445659">unsafe</span><span class="op" id="1445665">.</span><span class="ident" id="1445666">Pointer</span><span class="op" id="1445673">(</span><span class="ident" id="1445674">cb</span><span class="op" id="1445676">.</span><span class="ident" id="1445677">arg</span><span class="op" id="1445680">)</span><span class="op" id="1445681">,</span>&nbsp;<span class="builtintype" id="1445683">uint32</span><span class="op" id="1445689">(</span><span class="ident" id="1445690">cb</span><span class="op" id="1445692">.</span><span class="ident" id="1445693">argsize</span><span class="op" id="1445700">)</span><span class="op" id="1445701">,</span>&nbsp;<span class="num" id="1445703">0</span><span class="op" id="1445704">)</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1445708">if</span>&nbsp;<span class="ident" id="1445711">raceenabled</span>&nbsp;<span class="op" id="1445723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445727">racereleasemerge</span><span class="op" id="1445743">(</span><span class="ident" id="1445744">unsafe</span><span class="op" id="1445750">.</span><span class="ident" id="1445751">Pointer</span><span class="op" id="1445758">(</span><span class="op" id="1445759">&amp;</span><span class="ident" id="1445760">racecgosync</span><span class="op" id="1445771">)</span><span class="op" id="1445772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1445775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1445779">//&nbsp;Do&nbsp;not&nbsp;unwind&nbsp;m-&gt;g0-&gt;sched.sp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1445814">//&nbsp;Our&nbsp;caller,&nbsp;cgocallback,&nbsp;will&nbsp;do&nbsp;that.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445857">restore</span>&nbsp;<span class="op" id="1445865">=</span>&nbsp;<span class="builtintype" id="1445867">false</span><br>
<span class="lineno"></span><span class="op" id="1445873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span><span class="keyword" id="1445876">func</span>&nbsp;<span class="ident" id="1445881">unwindm</span><span class="op" id="1445888">(</span><span class="ident" id="1445889">restore</span>&nbsp;<span class="op" id="1445897">*</span><span class="builtintype" id="1445898">bool</span><span class="op" id="1445902">)</span>&nbsp;<span class="op" id="1445904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1445907">if</span>&nbsp;<span class="op" id="1445910">!</span><span class="op" id="1445911">*</span><span class="ident" id="1445912">restore</span>&nbsp;<span class="op" id="1445920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1445924">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1445932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1445935">//&nbsp;Restore&nbsp;sp&nbsp;saved&nbsp;by&nbsp;cgocallback&nbsp;during</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1445978">//&nbsp;unwind&nbsp;of&nbsp;g&#39;s&nbsp;stack&nbsp;(see&nbsp;comment&nbsp;at&nbsp;top&nbsp;of&nbsp;file).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446032">mp</span>&nbsp;<span class="op" id="1446035">:=</span>&nbsp;<span class="ident" id="1446038">acquirem</span><span class="op" id="1446046">(</span><span class="op" id="1446047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446050">sched</span>&nbsp;<span class="op" id="1446056">:=</span>&nbsp;<span class="op" id="1446059">&amp;</span><span class="ident" id="1446060">mp</span><span class="op" id="1446062">.</span><span class="ident" id="1446063">g0</span><span class="op" id="1446065">.</span><span class="ident" id="1446066">sched</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1446073">switch</span>&nbsp;<span class="ident" id="1446080">GOARCH</span>&nbsp;<span class="op" id="1446087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1446090">default</span><span class="op" id="1446097">:</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446101">gothrow</span><span class="op" id="1446108">(</span><span class="string" id="1446109">&#34;unwindm&nbsp;not&nbsp;implemented&#34;</span><span class="op" id="1446134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1446137">case</span>&nbsp;<span class="string" id="1446142">&#34;386&#34;</span><span class="op" id="1446147">,</span>&nbsp;<span class="string" id="1446149">&#34;amd64&#34;</span><span class="op" id="1446156">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446160">sched</span><span class="op" id="1446165">.</span><span class="ident" id="1446166">sp</span>&nbsp;<span class="op" id="1446169">=</span>&nbsp;<span class="op" id="1446171">*</span><span class="op" id="1446172">(</span><span class="op" id="1446173">*</span><span class="builtintype" id="1446174">uintptr</span><span class="op" id="1446181">)</span><span class="op" id="1446182">(</span><span class="ident" id="1446183">unsafe</span><span class="op" id="1446189">.</span><span class="ident" id="1446190">Pointer</span><span class="op" id="1446197">(</span><span class="ident" id="1446198">sched</span><span class="op" id="1446203">.</span><span class="ident" id="1446204">sp</span><span class="op" id="1446206">)</span><span class="op" id="1446207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1446210">case</span>&nbsp;<span class="string" id="1446215">&#34;arm&#34;</span><span class="op" id="1446220">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446224">sched</span><span class="op" id="1446229">.</span><span class="ident" id="1446230">sp</span>&nbsp;<span class="op" id="1446233">=</span>&nbsp;<span class="op" id="1446235">*</span><span class="op" id="1446236">(</span><span class="op" id="1446237">*</span><span class="builtintype" id="1446238">uintptr</span><span class="op" id="1446245">)</span><span class="op" id="1446246">(</span><span class="ident" id="1446247">unsafe</span><span class="op" id="1446253">.</span><span class="ident" id="1446254">Pointer</span><span class="op" id="1446261">(</span><span class="ident" id="1446262">sched</span><span class="op" id="1446267">.</span><span class="ident" id="1446268">sp</span>&nbsp;<span class="op" id="1446271">+</span>&nbsp;<span class="num" id="1446273">4</span><span class="op" id="1446274">)</span><span class="op" id="1446275">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1446278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446281">releasem</span><span class="op" id="1446289">(</span><span class="ident" id="1446290">mp</span><span class="op" id="1446292">)</span><br>
<span class="lineno"></span><span class="op" id="1446294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1446297">//&nbsp;called&nbsp;from&nbsp;assembly</span><br>
<span class="lineno">270</span><span class="keyword" id="1446321">func</span>&nbsp;<span class="ident" id="1446326">badcgocallback</span><span class="op" id="1446340">(</span><span class="op" id="1446341">)</span>&nbsp;<span class="op" id="1446343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446346">gothrow</span><span class="op" id="1446353">(</span><span class="string" id="1446354">&#34;misaligned&nbsp;stack&nbsp;in&nbsp;cgocallback&#34;</span><span class="op" id="1446387">)</span><br>
<span class="lineno"></span><span class="op" id="1446389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1446392">//&nbsp;called&nbsp;from&nbsp;(incomplete)&nbsp;assembly</span><br>
<span class="lineno">275</span><span class="keyword" id="1446429">func</span>&nbsp;<span class="ident" id="1446434">cgounimpl</span><span class="op" id="1446443">(</span><span class="op" id="1446444">)</span>&nbsp;<span class="op" id="1446446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446449">gothrow</span><span class="op" id="1446456">(</span><span class="string" id="1446457">&#34;cgo&nbsp;not&nbsp;implemented&#34;</span><span class="op" id="1446478">)</span><br>
<span class="lineno"></span><span class="op" id="1446480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1446483">var</span>&nbsp;<span class="ident" id="1446487">racecgosync</span>&nbsp;<span class="ident" id="1446499">uint64</span>&nbsp;<span class="comment" id="1446506">//&nbsp;represents&nbsp;possible&nbsp;synchronization&nbsp;in&nbsp;C&nbsp;code</span>
</div>
</body>
</html>
