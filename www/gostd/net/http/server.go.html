<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3433971">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3434026">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3434080">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3434131">//&nbsp;HTTP&nbsp;server.&nbsp;&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3434163">package</span>&nbsp;<span class="ident" id="3434171">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3434177">import</span>&nbsp;<span class="op" id="3434184">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3434187">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3434196">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3434210">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3434220">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3434227">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3434233">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3434246">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3434253">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3434260">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3434271">&#34;os&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3434277">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3434285">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3434296">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3434307">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3434318">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3434326">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3434341">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3434348">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3434351">//&nbsp;Errors&nbsp;introduced&nbsp;by&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">30</span><span class="keyword" id="3434392">var</span>&nbsp;<span class="op" id="3434396">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3434399">ErrWriteAfterFlush</span>&nbsp;<span class="op" id="3434418">=</span>&nbsp;<span class="ident" id="3434420">errors</span><span class="op" id="3434426">.</span><span class="ident" id="3434427">New</span><span class="op" id="3434430">(</span><span class="string" id="3434431">&#34;Conn.Write&nbsp;called&nbsp;after&nbsp;Flush&#34;</span><span class="op" id="3434462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3434465">ErrBodyNotAllowed</span>&nbsp;&nbsp;<span class="op" id="3434484">=</span>&nbsp;<span class="ident" id="3434486">errors</span><span class="op" id="3434492">.</span><span class="ident" id="3434493">New</span><span class="op" id="3434496">(</span><span class="string" id="3434497">&#34;http:&nbsp;request&nbsp;method&nbsp;or&nbsp;response&nbsp;status&nbsp;code&nbsp;does&nbsp;not&nbsp;allow&nbsp;body&#34;</span><span class="op" id="3434563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3434566">ErrHijacked</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3434585">=</span>&nbsp;<span class="ident" id="3434587">errors</span><span class="op" id="3434593">.</span><span class="ident" id="3434594">New</span><span class="op" id="3434597">(</span><span class="string" id="3434598">&#34;Conn&nbsp;has&nbsp;been&nbsp;hijacked&#34;</span><span class="op" id="3434622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3434625">ErrContentLength</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3434644">=</span>&nbsp;<span class="ident" id="3434646">errors</span><span class="op" id="3434652">.</span><span class="ident" id="3434653">New</span><span class="op" id="3434656">(</span><span class="string" id="3434657">&#34;Conn.Write&nbsp;wrote&nbsp;more&nbsp;than&nbsp;the&nbsp;declared&nbsp;Content-Length&#34;</span><span class="op" id="3434713">)</span><br>
<span class="lineno">35</span><span class="op" id="3434715">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3434718">//&nbsp;Objects&nbsp;implementing&nbsp;the&nbsp;Handler&nbsp;interface&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3434771">//&nbsp;registered&nbsp;to&nbsp;serve&nbsp;a&nbsp;particular&nbsp;path&nbsp;or&nbsp;subtree</span><br>
<span class="lineno"></span><span class="comment" id="3434823">//&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">40</span><span class="comment" id="3434846">//</span><br>
<span class="lineno"></span><span class="comment" id="3434849">//&nbsp;ServeHTTP&nbsp;should&nbsp;write&nbsp;reply&nbsp;headers&nbsp;and&nbsp;data&nbsp;to&nbsp;the&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="3434920">//&nbsp;and&nbsp;then&nbsp;return.&nbsp;&nbsp;Returning&nbsp;signals&nbsp;that&nbsp;the&nbsp;request&nbsp;is&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="3434988">//&nbsp;and&nbsp;that&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;can&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3435051">//&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">45</span><span class="comment" id="3435070">//</span><br>
<span class="lineno"></span><span class="comment" id="3435073">//&nbsp;If&nbsp;ServeHTTP&nbsp;panics,&nbsp;the&nbsp;server&nbsp;(the&nbsp;caller&nbsp;of&nbsp;ServeHTTP)&nbsp;assumes</span><br>
<span class="lineno"></span><span class="comment" id="3435142">//&nbsp;that&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;panic&nbsp;was&nbsp;isolated&nbsp;to&nbsp;the&nbsp;active&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="3435210">//&nbsp;It&nbsp;recovers&nbsp;the&nbsp;panic,&nbsp;logs&nbsp;a&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;server&nbsp;error&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="3435280">//&nbsp;and&nbsp;hangs&nbsp;up&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">50</span><span class="comment" id="3435312">//</span><br>
<span class="lineno"></span><span class="keyword" id="3435315">type</span>&nbsp;<span class="ident" id="3435320">Handler</span>&nbsp;<span class="keyword" id="3435328">interface</span>&nbsp;<span class="op" id="3435338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3435341">ServeHTTP</span><span class="op" id="3435350">(</span><span class="ident" id="3435351">ResponseWriter</span><span class="op" id="3435365">,</span>&nbsp;<span class="op" id="3435367">*</span><span class="ident" id="3435368">Request</span><span class="op" id="3435375">)</span><br>
<span class="lineno"></span><span class="op" id="3435377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3435380">//&nbsp;A&nbsp;ResponseWriter&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3435440">//&nbsp;construct&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3435471">type</span>&nbsp;<span class="ident" id="3435476">ResponseWriter</span>&nbsp;<span class="keyword" id="3435491">interface</span>&nbsp;<span class="op" id="3435501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3435504">//&nbsp;Header&nbsp;returns&nbsp;the&nbsp;header&nbsp;map&nbsp;that&nbsp;will&nbsp;be&nbsp;sent&nbsp;by&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3435572">//&nbsp;Changing&nbsp;the&nbsp;header&nbsp;after&nbsp;a&nbsp;call&nbsp;to&nbsp;WriteHeader&nbsp;(or&nbsp;Write)&nbsp;has</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3435639">//&nbsp;no&nbsp;effect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3435654">Header</span><span class="op" id="3435660">(</span><span class="op" id="3435661">)</span>&nbsp;<span class="ident" id="3435663">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3435672">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;data&nbsp;to&nbsp;the&nbsp;connection&nbsp;as&nbsp;part&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3435742">//&nbsp;If&nbsp;WriteHeader&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;called,&nbsp;Write&nbsp;calls&nbsp;WriteHeader(http.StatusOK)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3435825">//&nbsp;before&nbsp;writing&nbsp;the&nbsp;data.&nbsp;&nbsp;If&nbsp;the&nbsp;Header&nbsp;does&nbsp;not&nbsp;contain&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3435888">//&nbsp;Content-Type&nbsp;line,&nbsp;Write&nbsp;adds&nbsp;a&nbsp;Content-Type&nbsp;set&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;passing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3435966">//&nbsp;the&nbsp;initial&nbsp;512&nbsp;bytes&nbsp;of&nbsp;written&nbsp;data&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3436030">Write</span><span class="op" id="3436035">(</span><span class="op" id="3436036">[</span><span class="op" id="3436037">]</span><span class="builtintype" id="3436038">byte</span><span class="op" id="3436042">)</span>&nbsp;<span class="op" id="3436044">(</span><span class="builtintype" id="3436045">int</span><span class="op" id="3436048">,</span>&nbsp;<span class="builtintype" id="3436050">error</span><span class="op" id="3436055">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3436059">//&nbsp;WriteHeader&nbsp;sends&nbsp;an&nbsp;HTTP&nbsp;response&nbsp;header&nbsp;with&nbsp;status&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3436123">//&nbsp;If&nbsp;WriteHeader&nbsp;is&nbsp;not&nbsp;called&nbsp;explicitly,&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3436192">//&nbsp;will&nbsp;trigger&nbsp;an&nbsp;implicit&nbsp;WriteHeader(http.StatusOK).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3436249">//&nbsp;Thus&nbsp;explicit&nbsp;calls&nbsp;to&nbsp;WriteHeader&nbsp;are&nbsp;mainly&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3436307">//&nbsp;send&nbsp;error&nbsp;codes.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3436329">WriteHeader</span><span class="op" id="3436340">(</span><span class="builtintype" id="3436341">int</span><span class="op" id="3436344">)</span><br>
<span class="lineno"></span><span class="op" id="3436346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3436349">//&nbsp;The&nbsp;Flusher&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="3436419">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;flush&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno">80</span><span class="comment" id="3436476">//</span><br>
<span class="lineno"></span><span class="comment" id="3436479">//&nbsp;Note&nbsp;that&nbsp;even&nbsp;for&nbsp;ResponseWriters&nbsp;that&nbsp;support&nbsp;Flush,</span><br>
<span class="lineno"></span><span class="comment" id="3436537">//&nbsp;if&nbsp;the&nbsp;client&nbsp;is&nbsp;connected&nbsp;through&nbsp;an&nbsp;HTTP&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="3436590">//&nbsp;the&nbsp;buffered&nbsp;data&nbsp;may&nbsp;not&nbsp;reach&nbsp;the&nbsp;client&nbsp;until&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="3436655">//&nbsp;completes.</span><br>
<span class="lineno">85</span><span class="keyword" id="3436669">type</span>&nbsp;<span class="ident" id="3436674">Flusher</span>&nbsp;<span class="keyword" id="3436682">interface</span>&nbsp;<span class="op" id="3436692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3436695">//&nbsp;Flush&nbsp;sends&nbsp;any&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3436744">Flush</span><span class="op" id="3436749">(</span><span class="op" id="3436750">)</span><br>
<span class="lineno"></span><span class="op" id="3436752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="3436755">//&nbsp;The&nbsp;Hijacker&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="3436826">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3436874">type</span>&nbsp;<span class="ident" id="3436879">Hijacker</span>&nbsp;<span class="keyword" id="3436888">interface</span>&nbsp;<span class="op" id="3436898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3436901">//&nbsp;Hijack&nbsp;lets&nbsp;the&nbsp;caller&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3436954">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Hijack(),&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;library</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3437008">//&nbsp;will&nbsp;not&nbsp;do&nbsp;anything&nbsp;else&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3437059">//&nbsp;It&nbsp;becomes&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;manage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3437112">//&nbsp;and&nbsp;close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3437142">Hijack</span><span class="op" id="3437148">(</span><span class="op" id="3437149">)</span>&nbsp;<span class="op" id="3437151">(</span><span class="ident" id="3437152">net</span><span class="op" id="3437155">.</span><span class="ident" id="3437156">Conn</span><span class="op" id="3437160">,</span>&nbsp;<span class="op" id="3437162">*</span><span class="ident" id="3437163">bufio</span><span class="op" id="3437168">.</span><span class="ident" id="3437169">ReadWriter</span><span class="op" id="3437179">,</span>&nbsp;<span class="builtintype" id="3437181">error</span><span class="op" id="3437186">)</span><br>
<span class="lineno"></span><span class="op" id="3437188">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="3437191">//&nbsp;The&nbsp;CloseNotifier&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="3437262">//&nbsp;allow&nbsp;detecting&nbsp;when&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span><span class="comment" id="3437327">//</span><br>
<span class="lineno"></span><span class="comment" id="3437330">//&nbsp;This&nbsp;mechanism&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;cancel&nbsp;long&nbsp;operations&nbsp;on&nbsp;the&nbsp;server</span><br>
<span class="lineno">105</span><span class="comment" id="3437400">//&nbsp;if&nbsp;the&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;before&nbsp;the&nbsp;response&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="3437464">type</span>&nbsp;<span class="ident" id="3437469">CloseNotifier</span>&nbsp;<span class="keyword" id="3437483">interface</span>&nbsp;<span class="op" id="3437493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3437496">//&nbsp;CloseNotify&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;receives&nbsp;a&nbsp;single&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3437559">//&nbsp;when&nbsp;the&nbsp;client&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3437605">CloseNotify</span><span class="op" id="3437616">(</span><span class="op" id="3437617">)</span>&nbsp;<span class="op" id="3437619">&lt;-</span><span class="keyword" id="3437621">chan</span>&nbsp;<span class="builtintype" id="3437626">bool</span><br>
<span class="lineno">110</span><span class="op" id="3437631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3437634">//&nbsp;A&nbsp;conn&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3437694">type</span>&nbsp;<span class="ident" id="3437699">conn</span>&nbsp;<span class="keyword" id="3437704">struct</span>&nbsp;<span class="op" id="3437711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3437714">remoteAddr</span>&nbsp;<span class="builtintype" id="3437725">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3437746">//&nbsp;network&nbsp;address&nbsp;of&nbsp;remote&nbsp;side</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3437781">server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3437792">*</span><span class="ident" id="3437793">Server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3437813">//&nbsp;the&nbsp;Server&nbsp;on&nbsp;which&nbsp;the&nbsp;connection&nbsp;arrived</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3437860">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3437871">net</span><span class="op" id="3437874">.</span><span class="ident" id="3437875">Conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3437892">//&nbsp;i/o&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3437911">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3437922">io</span><span class="op" id="3437924">.</span><span class="ident" id="3437925">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3437943">//&nbsp;checkConnErrorWriter&#39;s&nbsp;copy&nbsp;of&nbsp;wrc,&nbsp;not&nbsp;zeroed&nbsp;on&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438004">werr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3438015">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3438036">//&nbsp;any&nbsp;errors&nbsp;writing&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438064">sr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3438075">liveSwitchReader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3438096">//&nbsp;where&nbsp;the&nbsp;LimitReader&nbsp;reads&nbsp;from;&nbsp;usually&nbsp;the&nbsp;rwc</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438150">lr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3438161">*</span><span class="ident" id="3438162">io</span><span class="op" id="3438164">.</span><span class="ident" id="3438165">LimitedReader</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3438182">//&nbsp;io.LimitReader(sr)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438205">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3438216">*</span><span class="ident" id="3438217">bufio</span><span class="op" id="3438222">.</span><span class="ident" id="3438223">ReadWriter</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3438237">//&nbsp;buffered(lr,rwc),&nbsp;reading&nbsp;from&nbsp;bufio-&gt;limitReader-&gt;sr-&gt;rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438300">tlsState</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3438311">*</span><span class="ident" id="3438312">tls</span><span class="op" id="3438315">.</span><span class="ident" id="3438316">ConnectionState</span>&nbsp;<span class="comment" id="3438332">//&nbsp;or&nbsp;nil&nbsp;when&nbsp;not&nbsp;using&nbsp;TLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438363">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3438376">sync</span><span class="op" id="3438380">.</span><span class="ident" id="3438381">Mutex</span>&nbsp;<span class="comment" id="3438387">//&nbsp;guards&nbsp;the&nbsp;following</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438412">clientGone</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3438425">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3438436">//&nbsp;if&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;mid-request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438479">closeNotifyc</span>&nbsp;<span class="keyword" id="3438492">chan</span>&nbsp;<span class="builtintype" id="3438497">bool</span>&nbsp;&nbsp;<span class="comment" id="3438503">//&nbsp;made&nbsp;lazily</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438519">hijackedv</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3438532">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3438543">//&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked&nbsp;by&nbsp;handler</span><br>
<span class="lineno"></span><span class="op" id="3438586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="3438589">func</span>&nbsp;<span class="op" id="3438594">(</span><span class="ident" id="3438595">c</span>&nbsp;<span class="op" id="3438597">*</span><span class="ident" id="3438598">conn</span><span class="op" id="3438602">)</span>&nbsp;<span class="ident" id="3438604">hijacked</span><span class="op" id="3438612">(</span><span class="op" id="3438613">)</span>&nbsp;<span class="builtintype" id="3438615">bool</span>&nbsp;<span class="op" id="3438620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438623">c</span><span class="op" id="3438624">.</span><span class="ident" id="3438625">mu</span><span class="op" id="3438627">.</span><span class="ident" id="3438628">Lock</span><span class="op" id="3438632">(</span><span class="op" id="3438633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3438636">defer</span>&nbsp;<span class="ident" id="3438642">c</span><span class="op" id="3438643">.</span><span class="ident" id="3438644">mu</span><span class="op" id="3438646">.</span><span class="ident" id="3438647">Unlock</span><span class="op" id="3438653">(</span><span class="op" id="3438654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3438657">return</span>&nbsp;<span class="ident" id="3438664">c</span><span class="op" id="3438665">.</span><span class="ident" id="3438666">hijackedv</span><br>
<span class="lineno"></span><span class="op" id="3438676">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="3438679">func</span>&nbsp;<span class="op" id="3438684">(</span><span class="ident" id="3438685">c</span>&nbsp;<span class="op" id="3438687">*</span><span class="ident" id="3438688">conn</span><span class="op" id="3438692">)</span>&nbsp;<span class="ident" id="3438694">hijack</span><span class="op" id="3438700">(</span><span class="op" id="3438701">)</span>&nbsp;<span class="op" id="3438703">(</span><span class="ident" id="3438704">rwc</span>&nbsp;<span class="ident" id="3438708">net</span><span class="op" id="3438711">.</span><span class="ident" id="3438712">Conn</span><span class="op" id="3438716">,</span>&nbsp;<span class="ident" id="3438718">buf</span>&nbsp;<span class="op" id="3438722">*</span><span class="ident" id="3438723">bufio</span><span class="op" id="3438728">.</span><span class="ident" id="3438729">ReadWriter</span><span class="op" id="3438739">,</span>&nbsp;<span class="ident" id="3438741">err</span>&nbsp;<span class="builtintype" id="3438745">error</span><span class="op" id="3438750">)</span>&nbsp;<span class="op" id="3438752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438755">c</span><span class="op" id="3438756">.</span><span class="ident" id="3438757">mu</span><span class="op" id="3438759">.</span><span class="ident" id="3438760">Lock</span><span class="op" id="3438764">(</span><span class="op" id="3438765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3438768">defer</span>&nbsp;<span class="ident" id="3438774">c</span><span class="op" id="3438775">.</span><span class="ident" id="3438776">mu</span><span class="op" id="3438778">.</span><span class="ident" id="3438779">Unlock</span><span class="op" id="3438785">(</span><span class="op" id="3438786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3438789">if</span>&nbsp;<span class="ident" id="3438792">c</span><span class="op" id="3438793">.</span><span class="ident" id="3438794">hijackedv</span>&nbsp;<span class="op" id="3438804">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3438808">return</span>&nbsp;<span class="ident" id="3438815">nil</span><span class="op" id="3438818">,</span>&nbsp;<span class="ident" id="3438820">nil</span><span class="op" id="3438823">,</span>&nbsp;<span class="ident" id="3438825">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3438838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3438841">if</span>&nbsp;<span class="ident" id="3438844">c</span><span class="op" id="3438845">.</span><span class="ident" id="3438846">closeNotifyc</span>&nbsp;<span class="op" id="3438859">!=</span>&nbsp;<span class="ident" id="3438862">nil</span>&nbsp;<span class="op" id="3438866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3438870">return</span>&nbsp;<span class="ident" id="3438877">nil</span><span class="op" id="3438880">,</span>&nbsp;<span class="ident" id="3438882">nil</span><span class="op" id="3438885">,</span>&nbsp;<span class="ident" id="3438887">errors</span><span class="op" id="3438893">.</span><span class="ident" id="3438894">New</span><span class="op" id="3438897">(</span><span class="string" id="3438898">&#34;http:&nbsp;Hijack&nbsp;is&nbsp;incompatible&nbsp;with&nbsp;use&nbsp;of&nbsp;CloseNotifier&#34;</span><span class="op" id="3438954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3438957">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438960">c</span><span class="op" id="3438961">.</span><span class="ident" id="3438962">hijackedv</span>&nbsp;<span class="op" id="3438972">=</span>&nbsp;<span class="builtintype" id="3438974">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438980">rwc</span>&nbsp;<span class="op" id="3438984">=</span>&nbsp;<span class="ident" id="3438986">c</span><span class="op" id="3438987">.</span><span class="ident" id="3438988">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3438993">buf</span>&nbsp;<span class="op" id="3438997">=</span>&nbsp;<span class="ident" id="3438999">c</span><span class="op" id="3439000">.</span><span class="ident" id="3439001">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439006">c</span><span class="op" id="3439007">.</span><span class="ident" id="3439008">rwc</span>&nbsp;<span class="op" id="3439012">=</span>&nbsp;<span class="ident" id="3439014">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439019">c</span><span class="op" id="3439020">.</span><span class="ident" id="3439021">buf</span>&nbsp;<span class="op" id="3439025">=</span>&nbsp;<span class="ident" id="3439027">nil</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439032">c</span><span class="op" id="3439033">.</span><span class="ident" id="3439034">setState</span><span class="op" id="3439042">(</span><span class="ident" id="3439043">rwc</span><span class="op" id="3439046">,</span>&nbsp;<span class="ident" id="3439048">StateHijacked</span><span class="op" id="3439061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3439064">return</span><br>
<span class="lineno"></span><span class="op" id="3439071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3439074">func</span>&nbsp;<span class="op" id="3439079">(</span><span class="ident" id="3439080">c</span>&nbsp;<span class="op" id="3439082">*</span><span class="ident" id="3439083">conn</span><span class="op" id="3439087">)</span>&nbsp;<span class="ident" id="3439089">closeNotify</span><span class="op" id="3439100">(</span><span class="op" id="3439101">)</span>&nbsp;<span class="op" id="3439103">&lt;-</span><span class="keyword" id="3439105">chan</span>&nbsp;<span class="builtintype" id="3439110">bool</span>&nbsp;<span class="op" id="3439115">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439118">c</span><span class="op" id="3439119">.</span><span class="ident" id="3439120">mu</span><span class="op" id="3439122">.</span><span class="ident" id="3439123">Lock</span><span class="op" id="3439127">(</span><span class="op" id="3439128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3439131">defer</span>&nbsp;<span class="ident" id="3439137">c</span><span class="op" id="3439138">.</span><span class="ident" id="3439139">mu</span><span class="op" id="3439141">.</span><span class="ident" id="3439142">Unlock</span><span class="op" id="3439148">(</span><span class="op" id="3439149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3439152">if</span>&nbsp;<span class="ident" id="3439155">c</span><span class="op" id="3439156">.</span><span class="ident" id="3439157">closeNotifyc</span>&nbsp;<span class="op" id="3439170">==</span>&nbsp;<span class="ident" id="3439173">nil</span>&nbsp;<span class="op" id="3439177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439181">c</span><span class="op" id="3439182">.</span><span class="ident" id="3439183">closeNotifyc</span>&nbsp;<span class="op" id="3439196">=</span>&nbsp;<span class="builtinfunc" id="3439198">make</span><span class="op" id="3439202">(</span><span class="keyword" id="3439203">chan</span>&nbsp;<span class="builtintype" id="3439208">bool</span><span class="op" id="3439212">,</span>&nbsp;<span class="num" id="3439214">1</span><span class="op" id="3439215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3439219">if</span>&nbsp;<span class="ident" id="3439222">c</span><span class="op" id="3439223">.</span><span class="ident" id="3439224">hijackedv</span>&nbsp;<span class="op" id="3439234">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3439239">//&nbsp;to&nbsp;obey&nbsp;the&nbsp;function&nbsp;signature,&nbsp;even&nbsp;though</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3439289">//&nbsp;it&#39;ll&nbsp;never&nbsp;receive&nbsp;a&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3439324">return</span>&nbsp;<span class="ident" id="3439331">c</span><span class="op" id="3439332">.</span><span class="ident" id="3439333">closeNotifyc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3439348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439352">pr</span><span class="op" id="3439354">,</span>&nbsp;<span class="ident" id="3439356">pw</span>&nbsp;<span class="op" id="3439359">:=</span>&nbsp;<span class="ident" id="3439362">io</span><span class="op" id="3439364">.</span><span class="ident" id="3439365">Pipe</span><span class="op" id="3439369">(</span><span class="op" id="3439370">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439375">readSource</span>&nbsp;<span class="op" id="3439386">:=</span>&nbsp;<span class="ident" id="3439389">c</span><span class="op" id="3439390">.</span><span class="ident" id="3439391">sr</span><span class="op" id="3439393">.</span><span class="ident" id="3439394">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439398">c</span><span class="op" id="3439399">.</span><span class="ident" id="3439400">sr</span><span class="op" id="3439402">.</span><span class="ident" id="3439403">Lock</span><span class="op" id="3439407">(</span><span class="op" id="3439408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439412">c</span><span class="op" id="3439413">.</span><span class="ident" id="3439414">sr</span><span class="op" id="3439416">.</span><span class="ident" id="3439417">r</span>&nbsp;<span class="op" id="3439419">=</span>&nbsp;<span class="ident" id="3439421">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439426">c</span><span class="op" id="3439427">.</span><span class="ident" id="3439428">sr</span><span class="op" id="3439430">.</span><span class="ident" id="3439431">Unlock</span><span class="op" id="3439437">(</span><span class="op" id="3439438">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3439442">go</span>&nbsp;<span class="keyword" id="3439445">func</span><span class="op" id="3439449">(</span><span class="op" id="3439450">)</span>&nbsp;<span class="op" id="3439452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439457">_</span><span class="op" id="3439458">,</span>&nbsp;<span class="ident" id="3439460">err</span>&nbsp;<span class="op" id="3439464">:=</span>&nbsp;<span class="ident" id="3439467">io</span><span class="op" id="3439469">.</span><span class="ident" id="3439470">Copy</span><span class="op" id="3439474">(</span><span class="ident" id="3439475">pw</span><span class="op" id="3439477">,</span>&nbsp;<span class="ident" id="3439479">readSource</span><span class="op" id="3439489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3439494">if</span>&nbsp;<span class="ident" id="3439497">err</span>&nbsp;<span class="op" id="3439501">==</span>&nbsp;<span class="ident" id="3439504">nil</span>&nbsp;<span class="op" id="3439508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439514">err</span>&nbsp;<span class="op" id="3439518">=</span>&nbsp;<span class="ident" id="3439520">io</span><span class="op" id="3439522">.</span><span class="ident" id="3439523">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3439530">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439535">pw</span><span class="op" id="3439537">.</span><span class="ident" id="3439538">CloseWithError</span><span class="op" id="3439552">(</span><span class="ident" id="3439553">err</span><span class="op" id="3439556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439561">c</span><span class="op" id="3439562">.</span><span class="ident" id="3439563">noteClientGone</span><span class="op" id="3439577">(</span><span class="op" id="3439578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3439582">}</span><span class="op" id="3439583">(</span><span class="op" id="3439584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3439587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3439590">return</span>&nbsp;<span class="ident" id="3439597">c</span><span class="op" id="3439598">.</span><span class="ident" id="3439599">closeNotifyc</span><br>
<span class="lineno">180</span><span class="op" id="3439612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3439615">func</span>&nbsp;<span class="op" id="3439620">(</span><span class="ident" id="3439621">c</span>&nbsp;<span class="op" id="3439623">*</span><span class="ident" id="3439624">conn</span><span class="op" id="3439628">)</span>&nbsp;<span class="ident" id="3439630">noteClientGone</span><span class="op" id="3439644">(</span><span class="op" id="3439645">)</span>&nbsp;<span class="op" id="3439647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439650">c</span><span class="op" id="3439651">.</span><span class="ident" id="3439652">mu</span><span class="op" id="3439654">.</span><span class="ident" id="3439655">Lock</span><span class="op" id="3439659">(</span><span class="op" id="3439660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3439663">defer</span>&nbsp;<span class="ident" id="3439669">c</span><span class="op" id="3439670">.</span><span class="ident" id="3439671">mu</span><span class="op" id="3439673">.</span><span class="ident" id="3439674">Unlock</span><span class="op" id="3439680">(</span><span class="op" id="3439681">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3439684">if</span>&nbsp;<span class="ident" id="3439687">c</span><span class="op" id="3439688">.</span><span class="ident" id="3439689">closeNotifyc</span>&nbsp;<span class="op" id="3439702">!=</span>&nbsp;<span class="ident" id="3439705">nil</span>&nbsp;<span class="op" id="3439709">&amp;&amp;</span>&nbsp;<span class="op" id="3439712">!</span><span class="ident" id="3439713">c</span><span class="op" id="3439714">.</span><span class="ident" id="3439715">clientGone</span>&nbsp;<span class="op" id="3439726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439730">c</span><span class="op" id="3439731">.</span><span class="ident" id="3439732">closeNotifyc</span>&nbsp;<span class="op" id="3439745">&lt;-</span>&nbsp;<span class="builtintype" id="3439748">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3439754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439757">c</span><span class="op" id="3439758">.</span><span class="ident" id="3439759">clientGone</span>&nbsp;<span class="op" id="3439770">=</span>&nbsp;<span class="builtintype" id="3439772">true</span><br>
<span class="lineno"></span><span class="op" id="3439777">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="3439780">//&nbsp;A&nbsp;switchReader&nbsp;can&nbsp;have&nbsp;its&nbsp;Reader&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="3439838">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Reads&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="3439890">type</span>&nbsp;<span class="ident" id="3439895">switchReader</span>&nbsp;<span class="keyword" id="3439908">struct</span>&nbsp;<span class="op" id="3439915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3439918">io</span><span class="op" id="3439920">.</span><span class="ident" id="3439921">Reader</span><br>
<span class="lineno">195</span><span class="op" id="3439928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3439931">//&nbsp;A&nbsp;switchWriter&nbsp;can&nbsp;have&nbsp;its&nbsp;Writer&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="3439989">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Writes&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="3440042">type</span>&nbsp;<span class="ident" id="3440047">switchWriter</span>&nbsp;<span class="keyword" id="3440060">struct</span>&nbsp;<span class="op" id="3440067">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440070">io</span><span class="op" id="3440072">.</span><span class="ident" id="3440073">Writer</span><br>
<span class="lineno"></span><span class="op" id="3440080">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3440083">//&nbsp;A&nbsp;liveSwitchReader&nbsp;is&nbsp;a&nbsp;switchReader&nbsp;that&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent</span><br>
<span class="lineno"></span><span class="comment" id="3440150">//&nbsp;reads&nbsp;and&nbsp;switches,&nbsp;if&nbsp;its&nbsp;mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno">205</span><span class="keyword" id="3440195">type</span>&nbsp;<span class="ident" id="3440200">liveSwitchReader</span>&nbsp;<span class="keyword" id="3440217">struct</span>&nbsp;<span class="op" id="3440224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440227">sync</span><span class="op" id="3440231">.</span><span class="ident" id="3440232">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440239">r</span>&nbsp;<span class="ident" id="3440241">io</span><span class="op" id="3440243">.</span><span class="ident" id="3440244">Reader</span><br>
<span class="lineno"></span><span class="op" id="3440251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="keyword" id="3440254">func</span>&nbsp;<span class="op" id="3440259">(</span><span class="ident" id="3440260">sr</span>&nbsp;<span class="op" id="3440263">*</span><span class="ident" id="3440264">liveSwitchReader</span><span class="op" id="3440280">)</span>&nbsp;<span class="ident" id="3440282">Read</span><span class="op" id="3440286">(</span><span class="ident" id="3440287">p</span>&nbsp;<span class="op" id="3440289">[</span><span class="op" id="3440290">]</span><span class="builtintype" id="3440291">byte</span><span class="op" id="3440295">)</span>&nbsp;<span class="op" id="3440297">(</span><span class="ident" id="3440298">n</span>&nbsp;<span class="builtintype" id="3440300">int</span><span class="op" id="3440303">,</span>&nbsp;<span class="ident" id="3440305">err</span>&nbsp;<span class="builtintype" id="3440309">error</span><span class="op" id="3440314">)</span>&nbsp;<span class="op" id="3440316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440319">sr</span><span class="op" id="3440321">.</span><span class="ident" id="3440322">Lock</span><span class="op" id="3440326">(</span><span class="op" id="3440327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440330">r</span>&nbsp;<span class="op" id="3440332">:=</span>&nbsp;<span class="ident" id="3440335">sr</span><span class="op" id="3440337">.</span><span class="ident" id="3440338">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3440341">sr</span><span class="op" id="3440343">.</span><span class="ident" id="3440344">Unlock</span><span class="op" id="3440350">(</span><span class="op" id="3440351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3440354">return</span>&nbsp;<span class="ident" id="3440361">r</span><span class="op" id="3440362">.</span><span class="ident" id="3440363">Read</span><span class="op" id="3440367">(</span><span class="ident" id="3440368">p</span><span class="op" id="3440369">)</span><br>
<span class="lineno">215</span><span class="op" id="3440371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3440374">//&nbsp;This&nbsp;should&nbsp;be&nbsp;&gt;=&nbsp;512&nbsp;bytes&nbsp;for&nbsp;DetectContentType,</span><br>
<span class="lineno"></span><span class="comment" id="3440428">//&nbsp;but&nbsp;otherwise&nbsp;it&#39;s&nbsp;somewhat&nbsp;arbitrary.</span><br>
<span class="lineno"></span><span class="keyword" id="3440470">const</span>&nbsp;<span class="ident" id="3440476">bufferBeforeChunkingSize</span>&nbsp;<span class="op" id="3440501">=</span>&nbsp;<span class="num" id="3440503">2048</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="3440509">//&nbsp;chunkWriter&nbsp;writes&nbsp;to&nbsp;a&nbsp;response&#39;s&nbsp;conn&nbsp;buffer,&nbsp;and&nbsp;is&nbsp;the&nbsp;writer</span><br>
<span class="lineno"></span><span class="comment" id="3440578">//&nbsp;wrapped&nbsp;by&nbsp;the&nbsp;response.bufw&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="3440627">//</span><br>
<span class="lineno"></span><span class="comment" id="3440630">//&nbsp;chunkWriter&nbsp;also&nbsp;is&nbsp;responsible&nbsp;for&nbsp;finalizing&nbsp;the&nbsp;Header,&nbsp;including</span><br>
<span class="lineno">225</span><span class="comment" id="3440702">//&nbsp;conditionally&nbsp;setting&nbsp;the&nbsp;Content-Type&nbsp;and&nbsp;setting&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span><span class="comment" id="3440773">//&nbsp;in&nbsp;cases&nbsp;where&nbsp;the&nbsp;handler&#39;s&nbsp;final&nbsp;output&nbsp;is&nbsp;smaller&nbsp;than&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="3440845">//&nbsp;size.&nbsp;It&nbsp;also&nbsp;conditionally&nbsp;adds&nbsp;chunk&nbsp;headers,&nbsp;when&nbsp;in&nbsp;chunking&nbsp;mode.</span><br>
<span class="lineno"></span><span class="comment" id="3440919">//</span><br>
<span class="lineno"></span><span class="comment" id="3440922">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;above&nbsp;(*response).Write&nbsp;for&nbsp;the&nbsp;entire&nbsp;write&nbsp;flow.</span><br>
<span class="lineno">230</span><span class="keyword" id="3440992">type</span>&nbsp;<span class="ident" id="3440997">chunkWriter</span>&nbsp;<span class="keyword" id="3441009">struct</span>&nbsp;<span class="op" id="3441016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441019">res</span>&nbsp;<span class="op" id="3441023">*</span><span class="ident" id="3441024">response</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3441035">//&nbsp;header&nbsp;is&nbsp;either&nbsp;nil&nbsp;or&nbsp;a&nbsp;deep&nbsp;clone&nbsp;of&nbsp;res.handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3441097">//&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;res.WriteHeader,&nbsp;if&nbsp;res.WriteHeader&nbsp;is</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3441155">//&nbsp;called&nbsp;and&nbsp;extra&nbsp;buffering&nbsp;is&nbsp;being&nbsp;done&nbsp;to&nbsp;calculate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3441213">//&nbsp;Content-Type&nbsp;and/or&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441253">header</span>&nbsp;<span class="ident" id="3441260">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3441269">//&nbsp;wroteHeader&nbsp;tells&nbsp;whether&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;written&nbsp;to&nbsp;&#34;the</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3441333">//&nbsp;wire&#34;&nbsp;(or&nbsp;rather:&nbsp;w.conn.buf).&nbsp;this&nbsp;is&nbsp;unlike</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3441383">//&nbsp;(*response).wroteHeader,&nbsp;which&nbsp;tells&nbsp;only&nbsp;whether&nbsp;it&nbsp;was</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3441444">//&nbsp;logically&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441467">wroteHeader</span>&nbsp;<span class="builtintype" id="3441479">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3441486">//&nbsp;set&nbsp;by&nbsp;the&nbsp;writeHeader&nbsp;method:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441521">chunking</span>&nbsp;<span class="builtintype" id="3441530">bool</span>&nbsp;<span class="comment" id="3441535">//&nbsp;using&nbsp;chunked&nbsp;transfer&nbsp;encoding&nbsp;for&nbsp;reply&nbsp;body</span><br>
<span class="lineno"></span><span class="op" id="3441585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3441588">var</span>&nbsp;<span class="op" id="3441592">(</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441595">crlf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3441606">=</span>&nbsp;<span class="op" id="3441608">[</span><span class="op" id="3441609">]</span><span class="builtintype" id="3441610">byte</span><span class="op" id="3441614">(</span><span class="string" id="3441615">&#34;\r\n&#34;</span><span class="op" id="3441621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441624">colonSpace</span>&nbsp;<span class="op" id="3441635">=</span>&nbsp;<span class="op" id="3441637">[</span><span class="op" id="3441638">]</span><span class="builtintype" id="3441639">byte</span><span class="op" id="3441643">(</span><span class="string" id="3441644">&#34;:&nbsp;&#34;</span><span class="op" id="3441648">)</span><br>
<span class="lineno"></span><span class="op" id="3441650">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3441653">func</span>&nbsp;<span class="op" id="3441658">(</span><span class="ident" id="3441659">cw</span>&nbsp;<span class="op" id="3441662">*</span><span class="ident" id="3441663">chunkWriter</span><span class="op" id="3441674">)</span>&nbsp;<span class="ident" id="3441676">Write</span><span class="op" id="3441681">(</span><span class="ident" id="3441682">p</span>&nbsp;<span class="op" id="3441684">[</span><span class="op" id="3441685">]</span><span class="builtintype" id="3441686">byte</span><span class="op" id="3441690">)</span>&nbsp;<span class="op" id="3441692">(</span><span class="ident" id="3441693">n</span>&nbsp;<span class="builtintype" id="3441695">int</span><span class="op" id="3441698">,</span>&nbsp;<span class="ident" id="3441700">err</span>&nbsp;<span class="builtintype" id="3441704">error</span><span class="op" id="3441709">)</span>&nbsp;<span class="op" id="3441711">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3441714">if</span>&nbsp;<span class="op" id="3441717">!</span><span class="ident" id="3441718">cw</span><span class="op" id="3441720">.</span><span class="ident" id="3441721">wroteHeader</span>&nbsp;<span class="op" id="3441733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441737">cw</span><span class="op" id="3441739">.</span><span class="ident" id="3441740">writeHeader</span><span class="op" id="3441751">(</span><span class="ident" id="3441752">p</span><span class="op" id="3441753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3441756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3441759">if</span>&nbsp;<span class="ident" id="3441762">cw</span><span class="op" id="3441764">.</span><span class="ident" id="3441765">res</span><span class="op" id="3441768">.</span><span class="ident" id="3441769">req</span><span class="op" id="3441772">.</span><span class="ident" id="3441773">Method</span>&nbsp;<span class="op" id="3441780">==</span>&nbsp;<span class="string" id="3441783">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3441790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3441794">//&nbsp;Eat&nbsp;writes.</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3441811">return</span>&nbsp;<span class="builtinfunc" id="3441818">len</span><span class="op" id="3441821">(</span><span class="ident" id="3441822">p</span><span class="op" id="3441823">)</span><span class="op" id="3441824">,</span>&nbsp;<span class="ident" id="3441826">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3441831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3441834">if</span>&nbsp;<span class="ident" id="3441837">cw</span><span class="op" id="3441839">.</span><span class="ident" id="3441840">chunking</span>&nbsp;<span class="op" id="3441849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441853">_</span><span class="op" id="3441854">,</span>&nbsp;<span class="ident" id="3441856">err</span>&nbsp;<span class="op" id="3441860">=</span>&nbsp;<span class="ident" id="3441862">fmt</span><span class="op" id="3441865">.</span><span class="ident" id="3441866">Fprintf</span><span class="op" id="3441873">(</span><span class="ident" id="3441874">cw</span><span class="op" id="3441876">.</span><span class="ident" id="3441877">res</span><span class="op" id="3441880">.</span><span class="ident" id="3441881">conn</span><span class="op" id="3441885">.</span><span class="ident" id="3441886">buf</span><span class="op" id="3441889">,</span>&nbsp;<span class="string" id="3441891">&#34;%x\r\n&#34;</span><span class="op" id="3441899">,</span>&nbsp;<span class="builtinfunc" id="3441901">len</span><span class="op" id="3441904">(</span><span class="ident" id="3441905">p</span><span class="op" id="3441906">)</span><span class="op" id="3441907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3441911">if</span>&nbsp;<span class="ident" id="3441914">err</span>&nbsp;<span class="op" id="3441918">!=</span>&nbsp;<span class="ident" id="3441921">nil</span>&nbsp;<span class="op" id="3441925">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441930">cw</span><span class="op" id="3441932">.</span><span class="ident" id="3441933">res</span><span class="op" id="3441936">.</span><span class="ident" id="3441937">conn</span><span class="op" id="3441941">.</span><span class="ident" id="3441942">rwc</span><span class="op" id="3441945">.</span><span class="ident" id="3441946">Close</span><span class="op" id="3441951">(</span><span class="op" id="3441952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3441957">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3441966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3441969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3441972">n</span><span class="op" id="3441973">,</span>&nbsp;<span class="ident" id="3441975">err</span>&nbsp;<span class="op" id="3441979">=</span>&nbsp;<span class="ident" id="3441981">cw</span><span class="op" id="3441983">.</span><span class="ident" id="3441984">res</span><span class="op" id="3441987">.</span><span class="ident" id="3441988">conn</span><span class="op" id="3441992">.</span><span class="ident" id="3441993">buf</span><span class="op" id="3441996">.</span><span class="ident" id="3441997">Write</span><span class="op" id="3442002">(</span><span class="ident" id="3442003">p</span><span class="op" id="3442004">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442007">if</span>&nbsp;<span class="ident" id="3442010">cw</span><span class="op" id="3442012">.</span><span class="ident" id="3442013">chunking</span>&nbsp;<span class="op" id="3442022">&amp;&amp;</span>&nbsp;<span class="ident" id="3442025">err</span>&nbsp;<span class="op" id="3442029">==</span>&nbsp;<span class="ident" id="3442032">nil</span>&nbsp;<span class="op" id="3442036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442040">_</span><span class="op" id="3442041">,</span>&nbsp;<span class="ident" id="3442043">err</span>&nbsp;<span class="op" id="3442047">=</span>&nbsp;<span class="ident" id="3442049">cw</span><span class="op" id="3442051">.</span><span class="ident" id="3442052">res</span><span class="op" id="3442055">.</span><span class="ident" id="3442056">conn</span><span class="op" id="3442060">.</span><span class="ident" id="3442061">buf</span><span class="op" id="3442064">.</span><span class="ident" id="3442065">Write</span><span class="op" id="3442070">(</span><span class="ident" id="3442071">crlf</span><span class="op" id="3442075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3442078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442081">if</span>&nbsp;<span class="ident" id="3442084">err</span>&nbsp;<span class="op" id="3442088">!=</span>&nbsp;<span class="ident" id="3442091">nil</span>&nbsp;<span class="op" id="3442095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442099">cw</span><span class="op" id="3442101">.</span><span class="ident" id="3442102">res</span><span class="op" id="3442105">.</span><span class="ident" id="3442106">conn</span><span class="op" id="3442110">.</span><span class="ident" id="3442111">rwc</span><span class="op" id="3442114">.</span><span class="ident" id="3442115">Close</span><span class="op" id="3442120">(</span><span class="op" id="3442121">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3442124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442127">return</span><br>
<span class="lineno"></span><span class="op" id="3442134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3442137">func</span>&nbsp;<span class="op" id="3442142">(</span><span class="ident" id="3442143">cw</span>&nbsp;<span class="op" id="3442146">*</span><span class="ident" id="3442147">chunkWriter</span><span class="op" id="3442158">)</span>&nbsp;<span class="ident" id="3442160">flush</span><span class="op" id="3442165">(</span><span class="op" id="3442166">)</span>&nbsp;<span class="op" id="3442168">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442171">if</span>&nbsp;<span class="op" id="3442174">!</span><span class="ident" id="3442175">cw</span><span class="op" id="3442177">.</span><span class="ident" id="3442178">wroteHeader</span>&nbsp;<span class="op" id="3442190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442194">cw</span><span class="op" id="3442196">.</span><span class="ident" id="3442197">writeHeader</span><span class="op" id="3442208">(</span><span class="ident" id="3442209">nil</span><span class="op" id="3442212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3442215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442218">cw</span><span class="op" id="3442220">.</span><span class="ident" id="3442221">res</span><span class="op" id="3442224">.</span><span class="ident" id="3442225">conn</span><span class="op" id="3442229">.</span><span class="ident" id="3442230">buf</span><span class="op" id="3442233">.</span><span class="ident" id="3442234">Flush</span><span class="op" id="3442239">(</span><span class="op" id="3442240">)</span><br>
<span class="lineno"></span><span class="op" id="3442242">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="3442245">func</span>&nbsp;<span class="op" id="3442250">(</span><span class="ident" id="3442251">cw</span>&nbsp;<span class="op" id="3442254">*</span><span class="ident" id="3442255">chunkWriter</span><span class="op" id="3442266">)</span>&nbsp;<span class="builtinfunc" id="3442268">close</span><span class="op" id="3442273">(</span><span class="op" id="3442274">)</span>&nbsp;<span class="op" id="3442276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442279">if</span>&nbsp;<span class="op" id="3442282">!</span><span class="ident" id="3442283">cw</span><span class="op" id="3442285">.</span><span class="ident" id="3442286">wroteHeader</span>&nbsp;<span class="op" id="3442298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442302">cw</span><span class="op" id="3442304">.</span><span class="ident" id="3442305">writeHeader</span><span class="op" id="3442316">(</span><span class="ident" id="3442317">nil</span><span class="op" id="3442320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3442323">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3442326">if</span>&nbsp;<span class="ident" id="3442329">cw</span><span class="op" id="3442331">.</span><span class="ident" id="3442332">chunking</span>&nbsp;<span class="op" id="3442341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3442345">//&nbsp;zero&nbsp;EOF&nbsp;chunk,&nbsp;trailer&nbsp;key/value&nbsp;pairs&nbsp;(currently</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3442401">//&nbsp;unsupported&nbsp;in&nbsp;Go&#39;s&nbsp;server),&nbsp;followed&nbsp;by&nbsp;a&nbsp;blank</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3442455">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442466">cw</span><span class="op" id="3442468">.</span><span class="ident" id="3442469">res</span><span class="op" id="3442472">.</span><span class="ident" id="3442473">conn</span><span class="op" id="3442477">.</span><span class="ident" id="3442478">buf</span><span class="op" id="3442481">.</span><span class="ident" id="3442482">WriteString</span><span class="op" id="3442493">(</span><span class="string" id="3442494">&#34;0\r\n\r\n&#34;</span><span class="op" id="3442505">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3442508">}</span><br>
<span class="lineno"></span><span class="op" id="3442510">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3442513">//&nbsp;A&nbsp;response&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3442575">type</span>&nbsp;<span class="ident" id="3442580">response</span>&nbsp;<span class="keyword" id="3442589">struct</span>&nbsp;<span class="op" id="3442596">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442599">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3442613">*</span><span class="ident" id="3442614">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442620">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3442634">*</span><span class="ident" id="3442635">Request</span>&nbsp;<span class="comment" id="3442643">//&nbsp;request&nbsp;for&nbsp;this&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442673">wroteHeader</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3442687">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3442696">//&nbsp;reply&nbsp;header&nbsp;has&nbsp;been&nbsp;(logically)&nbsp;written</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442742">wroteContinue</span>&nbsp;<span class="builtintype" id="3442756">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3442765">//&nbsp;100&nbsp;Continue&nbsp;response&nbsp;was&nbsp;written</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442804">w</span>&nbsp;&nbsp;<span class="op" id="3442807">*</span><span class="ident" id="3442808">bufio</span><span class="op" id="3442813">.</span><span class="ident" id="3442814">Writer</span>&nbsp;<span class="comment" id="3442821">//&nbsp;buffers&nbsp;output&nbsp;in&nbsp;chunks&nbsp;to&nbsp;chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442865">cw</span>&nbsp;<span class="ident" id="3442868">chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3442881">sw</span>&nbsp;<span class="op" id="3442884">*</span><span class="ident" id="3442885">switchWriter</span>&nbsp;<span class="comment" id="3442898">//&nbsp;of&nbsp;the&nbsp;bufio.Writer,&nbsp;for&nbsp;return&nbsp;to&nbsp;putBufioWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3442953">//&nbsp;handlerHeader&nbsp;is&nbsp;the&nbsp;Header&nbsp;that&nbsp;Handlers&nbsp;get&nbsp;access&nbsp;to,</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3443014">//&nbsp;which&nbsp;may&nbsp;be&nbsp;retained&nbsp;and&nbsp;mutated&nbsp;even&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3443076">//&nbsp;handlerHeader&nbsp;is&nbsp;copied&nbsp;into&nbsp;cw.header&nbsp;at&nbsp;WriteHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3443134">//&nbsp;time,&nbsp;and&nbsp;privately&nbsp;mutated&nbsp;thereafter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443178">handlerHeader</span>&nbsp;<span class="ident" id="3443192">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443200">calledHeader</span>&nbsp;&nbsp;<span class="builtintype" id="3443214">bool</span>&nbsp;<span class="comment" id="3443219">//&nbsp;handler&nbsp;accessed&nbsp;handlerHeader&nbsp;via&nbsp;Header</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443266">written</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3443280">int64</span>&nbsp;<span class="comment" id="3443286">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;in&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443322">contentLength</span>&nbsp;<span class="ident" id="3443336">int64</span>&nbsp;<span class="comment" id="3443342">//&nbsp;explicitly-declared&nbsp;Content-Length;&nbsp;or&nbsp;-1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443388">status</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3443402">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3443408">//&nbsp;status&nbsp;code&nbsp;passed&nbsp;to&nbsp;WriteHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3443447">//&nbsp;close&nbsp;connection&nbsp;after&nbsp;this&nbsp;reply.&nbsp;&nbsp;set&nbsp;on&nbsp;request&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3443506">//&nbsp;updated&nbsp;after&nbsp;response&nbsp;from&nbsp;handler&nbsp;if&nbsp;there&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3443559">//&nbsp;&#34;Connection:&nbsp;keep-alive&#34;&nbsp;response&nbsp;header&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3443610">//&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3443630">closeAfterReply</span>&nbsp;<span class="builtintype" id="3443646">bool</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3443653">//&nbsp;requestBodyLimitHit&nbsp;is&nbsp;set&nbsp;by&nbsp;requestTooLarge&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3443708">//&nbsp;maxBytesReader&nbsp;hits&nbsp;its&nbsp;max&nbsp;size.&nbsp;It&nbsp;is&nbsp;checked&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3443763">//&nbsp;WriteHeader,&nbsp;to&nbsp;make&nbsp;sure&nbsp;we&nbsp;don&#39;t&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3443814">//&nbsp;remaining&nbsp;request&nbsp;body&nbsp;to&nbsp;try&nbsp;to&nbsp;advance&nbsp;to&nbsp;the&nbsp;next&nbsp;HTTP</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3443876">//&nbsp;request.&nbsp;Instead,&nbsp;when&nbsp;this&nbsp;is&nbsp;set,&nbsp;we&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3443932">//&nbsp;subsequent&nbsp;requests&nbsp;on&nbsp;this&nbsp;connection&nbsp;and&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3443992">//&nbsp;input&nbsp;from&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444011">requestBodyLimitHit</span>&nbsp;<span class="builtintype" id="3444031">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444038">handlerDone</span>&nbsp;<span class="builtintype" id="3444050">bool</span>&nbsp;<span class="comment" id="3444055">//&nbsp;set&nbsp;true&nbsp;when&nbsp;the&nbsp;handler&nbsp;exits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3444092">//&nbsp;Buffers&nbsp;for&nbsp;Date&nbsp;and&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444132">dateBuf</span>&nbsp;<span class="op" id="3444140">[</span><span class="builtinfunc" id="3444141">len</span><span class="op" id="3444144">(</span><span class="ident" id="3444145">TimeFormat</span><span class="op" id="3444155">)</span><span class="op" id="3444156">]</span><span class="builtintype" id="3444157">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444163">clenBuf</span>&nbsp;<span class="op" id="3444171">[</span><span class="num" id="3444172">10</span><span class="op" id="3444174">]</span><span class="builtintype" id="3444175">byte</span><br>
<span class="lineno">340</span><span class="op" id="3444180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3444183">//&nbsp;requestTooLarge&nbsp;is&nbsp;called&nbsp;by&nbsp;maxBytesReader&nbsp;when&nbsp;too&nbsp;much&nbsp;input&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="3444254">//&nbsp;been&nbsp;read&nbsp;from&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="3444284">func</span>&nbsp;<span class="op" id="3444289">(</span><span class="ident" id="3444290">w</span>&nbsp;<span class="op" id="3444292">*</span><span class="ident" id="3444293">response</span><span class="op" id="3444301">)</span>&nbsp;<span class="ident" id="3444303">requestTooLarge</span><span class="op" id="3444318">(</span><span class="op" id="3444319">)</span>&nbsp;<span class="op" id="3444321">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444324">w</span><span class="op" id="3444325">.</span><span class="ident" id="3444326">closeAfterReply</span>&nbsp;<span class="op" id="3444342">=</span>&nbsp;<span class="builtintype" id="3444344">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444350">w</span><span class="op" id="3444351">.</span><span class="ident" id="3444352">requestBodyLimitHit</span>&nbsp;<span class="op" id="3444372">=</span>&nbsp;<span class="builtintype" id="3444374">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444380">if</span>&nbsp;<span class="op" id="3444383">!</span><span class="ident" id="3444384">w</span><span class="op" id="3444385">.</span><span class="ident" id="3444386">wroteHeader</span>&nbsp;<span class="op" id="3444398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444402">w</span><span class="op" id="3444403">.</span><span class="ident" id="3444404">Header</span><span class="op" id="3444410">(</span><span class="op" id="3444411">)</span><span class="op" id="3444412">.</span><span class="ident" id="3444413">Set</span><span class="op" id="3444416">(</span><span class="string" id="3444417">&#34;Connection&#34;</span><span class="op" id="3444429">,</span>&nbsp;<span class="string" id="3444431">&#34;close&#34;</span><span class="op" id="3444438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3444441">}</span><br>
<span class="lineno">350</span><span class="op" id="3444443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3444446">//&nbsp;needsSniff&nbsp;reports&nbsp;whether&nbsp;a&nbsp;Content-Type&nbsp;still&nbsp;needs&nbsp;to&nbsp;be&nbsp;sniffed.</span><br>
<span class="lineno"></span><span class="keyword" id="3444518">func</span>&nbsp;<span class="op" id="3444523">(</span><span class="ident" id="3444524">w</span>&nbsp;<span class="op" id="3444526">*</span><span class="ident" id="3444527">response</span><span class="op" id="3444535">)</span>&nbsp;<span class="ident" id="3444537">needsSniff</span><span class="op" id="3444547">(</span><span class="op" id="3444548">)</span>&nbsp;<span class="builtintype" id="3444550">bool</span>&nbsp;<span class="op" id="3444555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444558">_</span><span class="op" id="3444559">,</span>&nbsp;<span class="ident" id="3444561">haveType</span>&nbsp;<span class="op" id="3444570">:=</span>&nbsp;<span class="ident" id="3444573">w</span><span class="op" id="3444574">.</span><span class="ident" id="3444575">handlerHeader</span><span class="op" id="3444588">[</span><span class="string" id="3444589">&#34;Content-Type&#34;</span><span class="op" id="3444603">]</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444606">return</span>&nbsp;<span class="op" id="3444613">!</span><span class="ident" id="3444614">w</span><span class="op" id="3444615">.</span><span class="ident" id="3444616">cw</span><span class="op" id="3444618">.</span><span class="ident" id="3444619">wroteHeader</span>&nbsp;<span class="op" id="3444631">&amp;&amp;</span>&nbsp;<span class="op" id="3444634">!</span><span class="ident" id="3444635">haveType</span>&nbsp;<span class="op" id="3444644">&amp;&amp;</span>&nbsp;<span class="ident" id="3444647">w</span><span class="op" id="3444648">.</span><span class="ident" id="3444649">written</span>&nbsp;<span class="op" id="3444657">&lt;</span>&nbsp;<span class="ident" id="3444659">sniffLen</span><br>
<span class="lineno"></span><span class="op" id="3444668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3444671">//&nbsp;writerOnly&nbsp;hides&nbsp;an&nbsp;io.Writer&nbsp;value&#39;s&nbsp;optional&nbsp;ReadFrom&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="3444737">//&nbsp;from&nbsp;io.Copy.</span><br>
<span class="lineno">360</span><span class="keyword" id="3444754">type</span>&nbsp;<span class="ident" id="3444759">writerOnly</span>&nbsp;<span class="keyword" id="3444770">struct</span>&nbsp;<span class="op" id="3444777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444780">io</span><span class="op" id="3444782">.</span><span class="ident" id="3444783">Writer</span><br>
<span class="lineno"></span><span class="op" id="3444790">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3444793">func</span>&nbsp;<span class="ident" id="3444798">srcIsRegularFile</span><span class="op" id="3444814">(</span><span class="ident" id="3444815">src</span>&nbsp;<span class="ident" id="3444819">io</span><span class="op" id="3444821">.</span><span class="ident" id="3444822">Reader</span><span class="op" id="3444828">)</span>&nbsp;<span class="op" id="3444830">(</span><span class="ident" id="3444831">isRegular</span>&nbsp;<span class="builtintype" id="3444841">bool</span><span class="op" id="3444845">,</span>&nbsp;<span class="ident" id="3444847">err</span>&nbsp;<span class="builtintype" id="3444851">error</span><span class="op" id="3444856">)</span>&nbsp;<span class="op" id="3444858">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444861">switch</span>&nbsp;<span class="ident" id="3444868">v</span>&nbsp;<span class="op" id="3444870">:=</span>&nbsp;<span class="ident" id="3444873">src</span><span class="op" id="3444876">.</span><span class="op" id="3444877">(</span><span class="keyword" id="3444878">type</span><span class="op" id="3444882">)</span>&nbsp;<span class="op" id="3444884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444887">case</span>&nbsp;<span class="op" id="3444892">*</span><span class="ident" id="3444893">os</span><span class="op" id="3444895">.</span><span class="ident" id="3444896">File</span><span class="op" id="3444900">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3444904">fi</span><span class="op" id="3444906">,</span>&nbsp;<span class="ident" id="3444908">err</span>&nbsp;<span class="op" id="3444912">:=</span>&nbsp;<span class="ident" id="3444915">v</span><span class="op" id="3444916">.</span><span class="ident" id="3444917">Stat</span><span class="op" id="3444921">(</span><span class="op" id="3444922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444926">if</span>&nbsp;<span class="ident" id="3444929">err</span>&nbsp;<span class="op" id="3444933">!=</span>&nbsp;<span class="ident" id="3444936">nil</span>&nbsp;<span class="op" id="3444940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444945">return</span>&nbsp;<span class="builtintype" id="3444952">false</span><span class="op" id="3444957">,</span>&nbsp;<span class="ident" id="3444959">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3444965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3444969">return</span>&nbsp;<span class="ident" id="3444976">fi</span><span class="op" id="3444978">.</span><span class="ident" id="3444979">Mode</span><span class="op" id="3444983">(</span><span class="op" id="3444984">)</span><span class="op" id="3444985">.</span><span class="ident" id="3444986">IsRegular</span><span class="op" id="3444995">(</span><span class="op" id="3444996">)</span><span class="op" id="3444997">,</span>&nbsp;<span class="ident" id="3444999">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445004">case</span>&nbsp;<span class="op" id="3445009">*</span><span class="ident" id="3445010">io</span><span class="op" id="3445012">.</span><span class="ident" id="3445013">LimitedReader</span><span class="op" id="3445026">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445030">return</span>&nbsp;<span class="ident" id="3445037">srcIsRegularFile</span><span class="op" id="3445053">(</span><span class="ident" id="3445054">v</span><span class="op" id="3445055">.</span><span class="ident" id="3445056">R</span><span class="op" id="3445057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445060">default</span><span class="op" id="3445067">:</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445071">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3445079">}</span><br>
<span class="lineno"></span><span class="op" id="3445081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3445084">//&nbsp;ReadFrom&nbsp;is&nbsp;here&nbsp;to&nbsp;optimize&nbsp;copying&nbsp;from&nbsp;an&nbsp;*os.File&nbsp;regular&nbsp;file</span><br>
<span class="lineno">380</span><span class="comment" id="3445154">//&nbsp;to&nbsp;a&nbsp;*net.TCPConn&nbsp;with&nbsp;sendfile.</span><br>
<span class="lineno"></span><span class="keyword" id="3445190">func</span>&nbsp;<span class="op" id="3445195">(</span><span class="ident" id="3445196">w</span>&nbsp;<span class="op" id="3445198">*</span><span class="ident" id="3445199">response</span><span class="op" id="3445207">)</span>&nbsp;<span class="ident" id="3445209">ReadFrom</span><span class="op" id="3445217">(</span><span class="ident" id="3445218">src</span>&nbsp;<span class="ident" id="3445222">io</span><span class="op" id="3445224">.</span><span class="ident" id="3445225">Reader</span><span class="op" id="3445231">)</span>&nbsp;<span class="op" id="3445233">(</span><span class="ident" id="3445234">n</span>&nbsp;<span class="ident" id="3445236">int64</span><span class="op" id="3445241">,</span>&nbsp;<span class="ident" id="3445243">err</span>&nbsp;<span class="builtintype" id="3445247">error</span><span class="op" id="3445252">)</span>&nbsp;<span class="op" id="3445254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3445257">//&nbsp;Our&nbsp;underlying&nbsp;w.conn.rwc&nbsp;is&nbsp;usually&nbsp;a&nbsp;*TCPConn&nbsp;(with&nbsp;its</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3445319">//&nbsp;own&nbsp;ReadFrom&nbsp;method).&nbsp;If&nbsp;not,&nbsp;or&nbsp;if&nbsp;our&nbsp;src&nbsp;isn&#39;t&nbsp;a&nbsp;regular</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3445383">//&nbsp;file,&nbsp;just&nbsp;fall&nbsp;back&nbsp;to&nbsp;the&nbsp;normal&nbsp;copy&nbsp;method.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445435">rf</span><span class="op" id="3445437">,</span>&nbsp;<span class="ident" id="3445439">ok</span>&nbsp;<span class="op" id="3445442">:=</span>&nbsp;<span class="ident" id="3445445">w</span><span class="op" id="3445446">.</span><span class="ident" id="3445447">conn</span><span class="op" id="3445451">.</span><span class="ident" id="3445452">rwc</span><span class="op" id="3445455">.</span><span class="op" id="3445456">(</span><span class="ident" id="3445457">io</span><span class="op" id="3445459">.</span><span class="ident" id="3445460">ReaderFrom</span><span class="op" id="3445470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445473">regFile</span><span class="op" id="3445480">,</span>&nbsp;<span class="ident" id="3445482">err</span>&nbsp;<span class="op" id="3445486">:=</span>&nbsp;<span class="ident" id="3445489">srcIsRegularFile</span><span class="op" id="3445505">(</span><span class="ident" id="3445506">src</span><span class="op" id="3445509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445512">if</span>&nbsp;<span class="ident" id="3445515">err</span>&nbsp;<span class="op" id="3445519">!=</span>&nbsp;<span class="ident" id="3445522">nil</span>&nbsp;<span class="op" id="3445526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445530">return</span>&nbsp;<span class="num" id="3445537">0</span><span class="op" id="3445538">,</span>&nbsp;<span class="ident" id="3445540">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3445545">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445548">if</span>&nbsp;<span class="op" id="3445551">!</span><span class="ident" id="3445552">ok</span>&nbsp;<span class="op" id="3445555">||</span>&nbsp;<span class="op" id="3445558">!</span><span class="ident" id="3445559">regFile</span>&nbsp;<span class="op" id="3445567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445571">return</span>&nbsp;<span class="ident" id="3445578">io</span><span class="op" id="3445580">.</span><span class="ident" id="3445581">Copy</span><span class="op" id="3445585">(</span><span class="ident" id="3445586">writerOnly</span><span class="op" id="3445596">{</span><span class="ident" id="3445597">w</span><span class="op" id="3445598">}</span><span class="op" id="3445599">,</span>&nbsp;<span class="ident" id="3445601">src</span><span class="op" id="3445604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3445607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3445611">//&nbsp;sendfile&nbsp;path:</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445631">if</span>&nbsp;<span class="op" id="3445634">!</span><span class="ident" id="3445635">w</span><span class="op" id="3445636">.</span><span class="ident" id="3445637">wroteHeader</span>&nbsp;<span class="op" id="3445649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445653">w</span><span class="op" id="3445654">.</span><span class="ident" id="3445655">WriteHeader</span><span class="op" id="3445666">(</span><span class="ident" id="3445667">StatusOK</span><span class="op" id="3445675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3445678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445682">if</span>&nbsp;<span class="ident" id="3445685">w</span><span class="op" id="3445686">.</span><span class="ident" id="3445687">needsSniff</span><span class="op" id="3445697">(</span><span class="op" id="3445698">)</span>&nbsp;<span class="op" id="3445700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445704">n0</span><span class="op" id="3445706">,</span>&nbsp;<span class="ident" id="3445708">err</span>&nbsp;<span class="op" id="3445712">:=</span>&nbsp;<span class="ident" id="3445715">io</span><span class="op" id="3445717">.</span><span class="ident" id="3445718">Copy</span><span class="op" id="3445722">(</span><span class="ident" id="3445723">writerOnly</span><span class="op" id="3445733">{</span><span class="ident" id="3445734">w</span><span class="op" id="3445735">}</span><span class="op" id="3445736">,</span>&nbsp;<span class="ident" id="3445738">io</span><span class="op" id="3445740">.</span><span class="ident" id="3445741">LimitReader</span><span class="op" id="3445752">(</span><span class="ident" id="3445753">src</span><span class="op" id="3445756">,</span>&nbsp;<span class="ident" id="3445758">sniffLen</span><span class="op" id="3445766">)</span><span class="op" id="3445767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445771">n</span>&nbsp;<span class="op" id="3445773">+=</span>&nbsp;<span class="ident" id="3445776">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445781">if</span>&nbsp;<span class="ident" id="3445784">err</span>&nbsp;<span class="op" id="3445788">!=</span>&nbsp;<span class="ident" id="3445791">nil</span>&nbsp;<span class="op" id="3445795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3445800">return</span>&nbsp;<span class="ident" id="3445807">n</span><span class="op" id="3445808">,</span>&nbsp;<span class="ident" id="3445810">err</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3445816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3445819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445823">w</span><span class="op" id="3445824">.</span><span class="ident" id="3445825">w</span><span class="op" id="3445826">.</span><span class="ident" id="3445827">Flush</span><span class="op" id="3445832">(</span><span class="op" id="3445833">)</span>&nbsp;&nbsp;<span class="comment" id="3445836">//&nbsp;get&nbsp;rid&nbsp;of&nbsp;any&nbsp;previous&nbsp;writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3445871">w</span><span class="op" id="3445872">.</span><span class="ident" id="3445873">cw</span><span class="op" id="3445875">.</span><span class="ident" id="3445876">flush</span><span class="op" id="3445881">(</span><span class="op" id="3445882">)</span>&nbsp;<span class="comment" id="3445884">//&nbsp;make&nbsp;sure&nbsp;Header&nbsp;is&nbsp;written;&nbsp;flush&nbsp;data&nbsp;to&nbsp;rwc</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3445936">//&nbsp;Now&nbsp;that&nbsp;cw&nbsp;has&nbsp;been&nbsp;flushed,&nbsp;its&nbsp;chunking&nbsp;field&nbsp;is&nbsp;guaranteed&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446016">if</span>&nbsp;<span class="op" id="3446019">!</span><span class="ident" id="3446020">w</span><span class="op" id="3446021">.</span><span class="ident" id="3446022">cw</span><span class="op" id="3446024">.</span><span class="ident" id="3446025">chunking</span>&nbsp;<span class="op" id="3446034">&amp;&amp;</span>&nbsp;<span class="ident" id="3446037">w</span><span class="op" id="3446038">.</span><span class="ident" id="3446039">bodyAllowed</span><span class="op" id="3446050">(</span><span class="op" id="3446051">)</span>&nbsp;<span class="op" id="3446053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446057">n0</span><span class="op" id="3446059">,</span>&nbsp;<span class="ident" id="3446061">err</span>&nbsp;<span class="op" id="3446065">:=</span>&nbsp;<span class="ident" id="3446068">rf</span><span class="op" id="3446070">.</span><span class="ident" id="3446071">ReadFrom</span><span class="op" id="3446079">(</span><span class="ident" id="3446080">src</span><span class="op" id="3446083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446087">n</span>&nbsp;<span class="op" id="3446089">+=</span>&nbsp;<span class="ident" id="3446092">n0</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446097">w</span><span class="op" id="3446098">.</span><span class="ident" id="3446099">written</span>&nbsp;<span class="op" id="3446107">+=</span>&nbsp;<span class="ident" id="3446110">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446115">return</span>&nbsp;<span class="ident" id="3446122">n</span><span class="op" id="3446123">,</span>&nbsp;<span class="ident" id="3446125">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3446130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446134">n0</span><span class="op" id="3446136">,</span>&nbsp;<span class="ident" id="3446138">err</span>&nbsp;<span class="op" id="3446142">:=</span>&nbsp;<span class="ident" id="3446145">io</span><span class="op" id="3446147">.</span><span class="ident" id="3446148">Copy</span><span class="op" id="3446152">(</span><span class="ident" id="3446153">writerOnly</span><span class="op" id="3446163">{</span><span class="ident" id="3446164">w</span><span class="op" id="3446165">}</span><span class="op" id="3446166">,</span>&nbsp;<span class="ident" id="3446168">src</span><span class="op" id="3446171">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446174">n</span>&nbsp;<span class="op" id="3446176">+=</span>&nbsp;<span class="ident" id="3446179">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446183">return</span>&nbsp;<span class="ident" id="3446190">n</span><span class="op" id="3446191">,</span>&nbsp;<span class="ident" id="3446193">err</span><br>
<span class="lineno"></span><span class="op" id="3446197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3446200">//&nbsp;noLimit&nbsp;is&nbsp;an&nbsp;effective&nbsp;infinite&nbsp;upper&nbsp;bound&nbsp;for&nbsp;io.LimitedReader</span><br>
<span class="lineno">425</span><span class="keyword" id="3446269">const</span>&nbsp;<span class="ident" id="3446275">noLimit</span>&nbsp;<span class="ident" id="3446283">int64</span>&nbsp;<span class="op" id="3446289">=</span>&nbsp;<span class="op" id="3446291">(</span><span class="num" id="3446292">1</span>&nbsp;<span class="op" id="3446294">&lt;&lt;</span>&nbsp;<span class="num" id="3446297">63</span><span class="op" id="3446299">)</span>&nbsp;<span class="op" id="3446301">-</span>&nbsp;<span class="num" id="3446303">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3446306">//&nbsp;debugServerConnections&nbsp;controls&nbsp;whether&nbsp;all&nbsp;server&nbsp;connections&nbsp;are&nbsp;wrapped</span><br>
<span class="lineno"></span><span class="comment" id="3446384">//&nbsp;with&nbsp;a&nbsp;verbose&nbsp;logging&nbsp;wrapper.</span><br>
<span class="lineno"></span><span class="keyword" id="3446419">const</span>&nbsp;<span class="ident" id="3446425">debugServerConnections</span>&nbsp;<span class="op" id="3446448">=</span>&nbsp;<span class="builtintype" id="3446450">false</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="comment" id="3446457">//&nbsp;Create&nbsp;new&nbsp;connection&nbsp;from&nbsp;rwc.</span><br>
<span class="lineno"></span><span class="keyword" id="3446492">func</span>&nbsp;<span class="op" id="3446497">(</span><span class="ident" id="3446498">srv</span>&nbsp;<span class="op" id="3446502">*</span><span class="ident" id="3446503">Server</span><span class="op" id="3446509">)</span>&nbsp;<span class="ident" id="3446511">newConn</span><span class="op" id="3446518">(</span><span class="ident" id="3446519">rwc</span>&nbsp;<span class="ident" id="3446523">net</span><span class="op" id="3446526">.</span><span class="ident" id="3446527">Conn</span><span class="op" id="3446531">)</span>&nbsp;<span class="op" id="3446533">(</span><span class="ident" id="3446534">c</span>&nbsp;<span class="op" id="3446536">*</span><span class="ident" id="3446537">conn</span><span class="op" id="3446541">,</span>&nbsp;<span class="ident" id="3446543">err</span>&nbsp;<span class="builtintype" id="3446547">error</span><span class="op" id="3446552">)</span>&nbsp;<span class="op" id="3446554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446557">c</span>&nbsp;<span class="op" id="3446559">=</span>&nbsp;<span class="builtinfunc" id="3446561">new</span><span class="op" id="3446564">(</span><span class="ident" id="3446565">conn</span><span class="op" id="3446569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446572">c</span><span class="op" id="3446573">.</span><span class="ident" id="3446574">remoteAddr</span>&nbsp;<span class="op" id="3446585">=</span>&nbsp;<span class="ident" id="3446587">rwc</span><span class="op" id="3446590">.</span><span class="ident" id="3446591">RemoteAddr</span><span class="op" id="3446601">(</span><span class="op" id="3446602">)</span><span class="op" id="3446603">.</span><span class="ident" id="3446604">String</span><span class="op" id="3446610">(</span><span class="op" id="3446611">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446614">c</span><span class="op" id="3446615">.</span><span class="ident" id="3446616">server</span>&nbsp;<span class="op" id="3446623">=</span>&nbsp;<span class="ident" id="3446625">srv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446630">c</span><span class="op" id="3446631">.</span><span class="ident" id="3446632">rwc</span>&nbsp;<span class="op" id="3446636">=</span>&nbsp;<span class="ident" id="3446638">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446643">c</span><span class="op" id="3446644">.</span><span class="ident" id="3446645">w</span>&nbsp;<span class="op" id="3446647">=</span>&nbsp;<span class="ident" id="3446649">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446654">if</span>&nbsp;<span class="ident" id="3446657">debugServerConnections</span>&nbsp;<span class="op" id="3446680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446684">c</span><span class="op" id="3446685">.</span><span class="ident" id="3446686">rwc</span>&nbsp;<span class="op" id="3446690">=</span>&nbsp;<span class="ident" id="3446692">newLoggingConn</span><span class="op" id="3446706">(</span><span class="string" id="3446707">&#34;server&#34;</span><span class="op" id="3446715">,</span>&nbsp;<span class="ident" id="3446717">c</span><span class="op" id="3446718">.</span><span class="ident" id="3446719">rwc</span><span class="op" id="3446722">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3446725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446728">c</span><span class="op" id="3446729">.</span><span class="ident" id="3446730">sr</span>&nbsp;<span class="op" id="3446733">=</span>&nbsp;<span class="ident" id="3446735">liveSwitchReader</span><span class="op" id="3446751">{</span><span class="ident" id="3446752">r</span><span class="op" id="3446753">:</span>&nbsp;<span class="ident" id="3446755">c</span><span class="op" id="3446756">.</span><span class="ident" id="3446757">rwc</span><span class="op" id="3446760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446763">c</span><span class="op" id="3446764">.</span><span class="ident" id="3446765">lr</span>&nbsp;<span class="op" id="3446768">=</span>&nbsp;<span class="ident" id="3446770">io</span><span class="op" id="3446772">.</span><span class="ident" id="3446773">LimitReader</span><span class="op" id="3446784">(</span><span class="op" id="3446785">&amp;</span><span class="ident" id="3446786">c</span><span class="op" id="3446787">.</span><span class="ident" id="3446788">sr</span><span class="op" id="3446790">,</span>&nbsp;<span class="ident" id="3446792">noLimit</span><span class="op" id="3446799">)</span><span class="op" id="3446800">.</span><span class="op" id="3446801">(</span><span class="op" id="3446802">*</span><span class="ident" id="3446803">io</span><span class="op" id="3446805">.</span><span class="ident" id="3446806">LimitedReader</span><span class="op" id="3446819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446822">br</span>&nbsp;<span class="op" id="3446825">:=</span>&nbsp;<span class="ident" id="3446828">newBufioReader</span><span class="op" id="3446842">(</span><span class="ident" id="3446843">c</span><span class="op" id="3446844">.</span><span class="ident" id="3446845">lr</span><span class="op" id="3446847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446850">bw</span>&nbsp;<span class="op" id="3446853">:=</span>&nbsp;<span class="ident" id="3446856">newBufioWriterSize</span><span class="op" id="3446874">(</span><span class="ident" id="3446875">checkConnErrorWriter</span><span class="op" id="3446895">{</span><span class="ident" id="3446896">c</span><span class="op" id="3446897">}</span><span class="op" id="3446898">,</span>&nbsp;<span class="num" id="3446900">4</span><span class="op" id="3446901">&lt;&lt;</span><span class="num" id="3446903">10</span><span class="op" id="3446905">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446908">c</span><span class="op" id="3446909">.</span><span class="ident" id="3446910">buf</span>&nbsp;<span class="op" id="3446914">=</span>&nbsp;<span class="ident" id="3446916">bufio</span><span class="op" id="3446921">.</span><span class="ident" id="3446922">NewReadWriter</span><span class="op" id="3446935">(</span><span class="ident" id="3446936">br</span><span class="op" id="3446938">,</span>&nbsp;<span class="ident" id="3446940">bw</span><span class="op" id="3446942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3446945">return</span>&nbsp;<span class="ident" id="3446952">c</span><span class="op" id="3446953">,</span>&nbsp;<span class="ident" id="3446955">nil</span><br>
<span class="lineno"></span><span class="op" id="3446959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3446962">var</span>&nbsp;<span class="op" id="3446966">(</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446969">bufioReaderPool</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3446987">sync</span><span class="op" id="3446991">.</span><span class="ident" id="3446992">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3446998">bufioWriter2kPool</span>&nbsp;<span class="ident" id="3447016">sync</span><span class="op" id="3447020">.</span><span class="ident" id="3447021">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447027">bufioWriter4kPool</span>&nbsp;<span class="ident" id="3447045">sync</span><span class="op" id="3447049">.</span><span class="ident" id="3447050">Pool</span><br>
<span class="lineno"></span><span class="op" id="3447055">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="keyword" id="3447058">func</span>&nbsp;<span class="ident" id="3447063">bufioWriterPool</span><span class="op" id="3447078">(</span><span class="ident" id="3447079">size</span>&nbsp;<span class="builtintype" id="3447084">int</span><span class="op" id="3447087">)</span>&nbsp;<span class="op" id="3447089">*</span><span class="ident" id="3447090">sync</span><span class="op" id="3447094">.</span><span class="ident" id="3447095">Pool</span>&nbsp;<span class="op" id="3447100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447103">switch</span>&nbsp;<span class="ident" id="3447110">size</span>&nbsp;<span class="op" id="3447115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447118">case</span>&nbsp;<span class="num" id="3447123">2</span>&nbsp;<span class="op" id="3447125">&lt;&lt;</span>&nbsp;<span class="num" id="3447128">10</span><span class="op" id="3447130">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447134">return</span>&nbsp;<span class="op" id="3447141">&amp;</span><span class="ident" id="3447142">bufioWriter2kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447161">case</span>&nbsp;<span class="num" id="3447166">4</span>&nbsp;<span class="op" id="3447168">&lt;&lt;</span>&nbsp;<span class="num" id="3447171">10</span><span class="op" id="3447173">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447177">return</span>&nbsp;<span class="op" id="3447184">&amp;</span><span class="ident" id="3447185">bufioWriter4kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3447204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447207">return</span>&nbsp;<span class="ident" id="3447214">nil</span><br>
<span class="lineno"></span><span class="op" id="3447218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="keyword" id="3447221">func</span>&nbsp;<span class="ident" id="3447226">newBufioReader</span><span class="op" id="3447240">(</span><span class="ident" id="3447241">r</span>&nbsp;<span class="ident" id="3447243">io</span><span class="op" id="3447245">.</span><span class="ident" id="3447246">Reader</span><span class="op" id="3447252">)</span>&nbsp;<span class="op" id="3447254">*</span><span class="ident" id="3447255">bufio</span><span class="op" id="3447260">.</span><span class="ident" id="3447261">Reader</span>&nbsp;<span class="op" id="3447268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447271">if</span>&nbsp;<span class="ident" id="3447274">v</span>&nbsp;<span class="op" id="3447276">:=</span>&nbsp;<span class="ident" id="3447279">bufioReaderPool</span><span class="op" id="3447294">.</span><span class="ident" id="3447295">Get</span><span class="op" id="3447298">(</span><span class="op" id="3447299">)</span><span class="op" id="3447300">;</span>&nbsp;<span class="ident" id="3447302">v</span>&nbsp;<span class="op" id="3447304">!=</span>&nbsp;<span class="ident" id="3447307">nil</span>&nbsp;<span class="op" id="3447311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447315">br</span>&nbsp;<span class="op" id="3447318">:=</span>&nbsp;<span class="ident" id="3447321">v</span><span class="op" id="3447322">.</span><span class="op" id="3447323">(</span><span class="op" id="3447324">*</span><span class="ident" id="3447325">bufio</span><span class="op" id="3447330">.</span><span class="ident" id="3447331">Reader</span><span class="op" id="3447337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447341">br</span><span class="op" id="3447343">.</span><span class="ident" id="3447344">Reset</span><span class="op" id="3447349">(</span><span class="ident" id="3447350">r</span><span class="op" id="3447351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447355">return</span>&nbsp;<span class="ident" id="3447362">br</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3447366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447369">return</span>&nbsp;<span class="ident" id="3447376">bufio</span><span class="op" id="3447381">.</span><span class="ident" id="3447382">NewReader</span><span class="op" id="3447391">(</span><span class="ident" id="3447392">r</span><span class="op" id="3447393">)</span><br>
<span class="lineno"></span><span class="op" id="3447395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3447398">func</span>&nbsp;<span class="ident" id="3447403">putBufioReader</span><span class="op" id="3447417">(</span><span class="ident" id="3447418">br</span>&nbsp;<span class="op" id="3447421">*</span><span class="ident" id="3447422">bufio</span><span class="op" id="3447427">.</span><span class="ident" id="3447428">Reader</span><span class="op" id="3447434">)</span>&nbsp;<span class="op" id="3447436">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447439">br</span><span class="op" id="3447441">.</span><span class="ident" id="3447442">Reset</span><span class="op" id="3447447">(</span><span class="ident" id="3447448">nil</span><span class="op" id="3447451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447454">bufioReaderPool</span><span class="op" id="3447469">.</span><span class="ident" id="3447470">Put</span><span class="op" id="3447473">(</span><span class="ident" id="3447474">br</span><span class="op" id="3447476">)</span><br>
<span class="lineno"></span><span class="op" id="3447478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3447481">func</span>&nbsp;<span class="ident" id="3447486">newBufioWriterSize</span><span class="op" id="3447504">(</span><span class="ident" id="3447505">w</span>&nbsp;<span class="ident" id="3447507">io</span><span class="op" id="3447509">.</span><span class="ident" id="3447510">Writer</span><span class="op" id="3447516">,</span>&nbsp;<span class="ident" id="3447518">size</span>&nbsp;<span class="builtintype" id="3447523">int</span><span class="op" id="3447526">)</span>&nbsp;<span class="op" id="3447528">*</span><span class="ident" id="3447529">bufio</span><span class="op" id="3447534">.</span><span class="ident" id="3447535">Writer</span>&nbsp;<span class="op" id="3447542">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447545">pool</span>&nbsp;<span class="op" id="3447550">:=</span>&nbsp;<span class="ident" id="3447553">bufioWriterPool</span><span class="op" id="3447568">(</span><span class="ident" id="3447569">size</span><span class="op" id="3447573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447576">if</span>&nbsp;<span class="ident" id="3447579">pool</span>&nbsp;<span class="op" id="3447584">!=</span>&nbsp;<span class="ident" id="3447587">nil</span>&nbsp;<span class="op" id="3447591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447595">if</span>&nbsp;<span class="ident" id="3447598">v</span>&nbsp;<span class="op" id="3447600">:=</span>&nbsp;<span class="ident" id="3447603">pool</span><span class="op" id="3447607">.</span><span class="ident" id="3447608">Get</span><span class="op" id="3447611">(</span><span class="op" id="3447612">)</span><span class="op" id="3447613">;</span>&nbsp;<span class="ident" id="3447615">v</span>&nbsp;<span class="op" id="3447617">!=</span>&nbsp;<span class="ident" id="3447620">nil</span>&nbsp;<span class="op" id="3447624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447629">bw</span>&nbsp;<span class="op" id="3447632">:=</span>&nbsp;<span class="ident" id="3447635">v</span><span class="op" id="3447636">.</span><span class="op" id="3447637">(</span><span class="op" id="3447638">*</span><span class="ident" id="3447639">bufio</span><span class="op" id="3447644">.</span><span class="ident" id="3447645">Writer</span><span class="op" id="3447651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447656">bw</span><span class="op" id="3447658">.</span><span class="ident" id="3447659">Reset</span><span class="op" id="3447664">(</span><span class="ident" id="3447665">w</span><span class="op" id="3447666">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447671">return</span>&nbsp;<span class="ident" id="3447678">bw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3447683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3447686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447689">return</span>&nbsp;<span class="ident" id="3447696">bufio</span><span class="op" id="3447701">.</span><span class="ident" id="3447702">NewWriterSize</span><span class="op" id="3447715">(</span><span class="ident" id="3447716">w</span><span class="op" id="3447717">,</span>&nbsp;<span class="ident" id="3447719">size</span><span class="op" id="3447723">)</span><br>
<span class="lineno"></span><span class="op" id="3447725">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="keyword" id="3447728">func</span>&nbsp;<span class="ident" id="3447733">putBufioWriter</span><span class="op" id="3447747">(</span><span class="ident" id="3447748">bw</span>&nbsp;<span class="op" id="3447751">*</span><span class="ident" id="3447752">bufio</span><span class="op" id="3447757">.</span><span class="ident" id="3447758">Writer</span><span class="op" id="3447764">)</span>&nbsp;<span class="op" id="3447766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447769">bw</span><span class="op" id="3447771">.</span><span class="ident" id="3447772">Reset</span><span class="op" id="3447777">(</span><span class="ident" id="3447778">nil</span><span class="op" id="3447781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3447784">if</span>&nbsp;<span class="ident" id="3447787">pool</span>&nbsp;<span class="op" id="3447792">:=</span>&nbsp;<span class="ident" id="3447795">bufioWriterPool</span><span class="op" id="3447810">(</span><span class="ident" id="3447811">bw</span><span class="op" id="3447813">.</span><span class="ident" id="3447814">Available</span><span class="op" id="3447823">(</span><span class="op" id="3447824">)</span><span class="op" id="3447825">)</span><span class="op" id="3447826">;</span>&nbsp;<span class="ident" id="3447828">pool</span>&nbsp;<span class="op" id="3447833">!=</span>&nbsp;<span class="ident" id="3447836">nil</span>&nbsp;<span class="op" id="3447840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3447844">pool</span><span class="op" id="3447848">.</span><span class="ident" id="3447849">Put</span><span class="op" id="3447852">(</span><span class="ident" id="3447853">bw</span><span class="op" id="3447855">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3447858">}</span><br>
<span class="lineno"></span><span class="op" id="3447860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3447863">//&nbsp;DefaultMaxHeaderBytes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;permitted&nbsp;size&nbsp;of&nbsp;the&nbsp;headers</span><br>
<span class="lineno"></span><span class="comment" id="3447933">//&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;request.</span><br>
<span class="lineno">500</span><span class="comment" id="3447956">//&nbsp;This&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;setting&nbsp;Server.MaxHeaderBytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3448016">const</span>&nbsp;<span class="ident" id="3448022">DefaultMaxHeaderBytes</span>&nbsp;<span class="op" id="3448044">=</span>&nbsp;<span class="num" id="3448046">1</span>&nbsp;<span class="op" id="3448048">&lt;&lt;</span>&nbsp;<span class="num" id="3448051">20</span>&nbsp;<span class="comment" id="3448054">//&nbsp;1&nbsp;MB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3448063">func</span>&nbsp;<span class="op" id="3448068">(</span><span class="ident" id="3448069">srv</span>&nbsp;<span class="op" id="3448073">*</span><span class="ident" id="3448074">Server</span><span class="op" id="3448080">)</span>&nbsp;<span class="ident" id="3448082">maxHeaderBytes</span><span class="op" id="3448096">(</span><span class="op" id="3448097">)</span>&nbsp;<span class="builtintype" id="3448099">int</span>&nbsp;<span class="op" id="3448103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448106">if</span>&nbsp;<span class="ident" id="3448109">srv</span><span class="op" id="3448112">.</span><span class="ident" id="3448113">MaxHeaderBytes</span>&nbsp;<span class="op" id="3448128">&gt;</span>&nbsp;<span class="num" id="3448130">0</span>&nbsp;<span class="op" id="3448132">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448136">return</span>&nbsp;<span class="ident" id="3448143">srv</span><span class="op" id="3448146">.</span><span class="ident" id="3448147">MaxHeaderBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3448163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448166">return</span>&nbsp;<span class="ident" id="3448173">DefaultMaxHeaderBytes</span><br>
<span class="lineno"></span><span class="op" id="3448195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="3448198">func</span>&nbsp;<span class="op" id="3448203">(</span><span class="ident" id="3448204">srv</span>&nbsp;<span class="op" id="3448208">*</span><span class="ident" id="3448209">Server</span><span class="op" id="3448215">)</span>&nbsp;<span class="ident" id="3448217">initialLimitedReaderSize</span><span class="op" id="3448241">(</span><span class="op" id="3448242">)</span>&nbsp;<span class="ident" id="3448244">int64</span>&nbsp;<span class="op" id="3448250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448253">return</span>&nbsp;<span class="ident" id="3448260">int64</span><span class="op" id="3448265">(</span><span class="ident" id="3448266">srv</span><span class="op" id="3448269">.</span><span class="ident" id="3448270">maxHeaderBytes</span><span class="op" id="3448284">(</span><span class="op" id="3448285">)</span><span class="op" id="3448286">)</span>&nbsp;<span class="op" id="3448288">+</span>&nbsp;<span class="num" id="3448290">4096</span>&nbsp;<span class="comment" id="3448295">//&nbsp;bufio&nbsp;slop</span><br>
<span class="lineno"></span><span class="op" id="3448309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3448312">//&nbsp;wrapper&nbsp;around&nbsp;io.ReaderCloser&nbsp;which&nbsp;on&nbsp;first&nbsp;read,&nbsp;sends&nbsp;an</span><br>
<span class="lineno">515</span><span class="comment" id="3448376">//&nbsp;HTTP/1.1&nbsp;100&nbsp;Continue&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="3448408">type</span>&nbsp;<span class="ident" id="3448413">expectContinueReader</span>&nbsp;<span class="keyword" id="3448434">struct</span>&nbsp;<span class="op" id="3448441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448444">resp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3448455">*</span><span class="ident" id="3448456">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448466">readCloser</span>&nbsp;<span class="ident" id="3448477">io</span><span class="op" id="3448479">.</span><span class="ident" id="3448480">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448492">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3448503">bool</span><br>
<span class="lineno">520</span><span class="op" id="3448508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3448511">func</span>&nbsp;<span class="op" id="3448516">(</span><span class="ident" id="3448517">ecr</span>&nbsp;<span class="op" id="3448521">*</span><span class="ident" id="3448522">expectContinueReader</span><span class="op" id="3448542">)</span>&nbsp;<span class="ident" id="3448544">Read</span><span class="op" id="3448548">(</span><span class="ident" id="3448549">p</span>&nbsp;<span class="op" id="3448551">[</span><span class="op" id="3448552">]</span><span class="builtintype" id="3448553">byte</span><span class="op" id="3448557">)</span>&nbsp;<span class="op" id="3448559">(</span><span class="ident" id="3448560">n</span>&nbsp;<span class="builtintype" id="3448562">int</span><span class="op" id="3448565">,</span>&nbsp;<span class="ident" id="3448567">err</span>&nbsp;<span class="builtintype" id="3448571">error</span><span class="op" id="3448576">)</span>&nbsp;<span class="op" id="3448578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448581">if</span>&nbsp;<span class="ident" id="3448584">ecr</span><span class="op" id="3448587">.</span><span class="ident" id="3448588">closed</span>&nbsp;<span class="op" id="3448595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448599">return</span>&nbsp;<span class="num" id="3448606">0</span><span class="op" id="3448607">,</span>&nbsp;<span class="ident" id="3448609">ErrBodyReadAfterClose</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3448632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448635">if</span>&nbsp;<span class="op" id="3448638">!</span><span class="ident" id="3448639">ecr</span><span class="op" id="3448642">.</span><span class="ident" id="3448643">resp</span><span class="op" id="3448647">.</span><span class="ident" id="3448648">wroteContinue</span>&nbsp;<span class="op" id="3448662">&amp;&amp;</span>&nbsp;<span class="op" id="3448665">!</span><span class="ident" id="3448666">ecr</span><span class="op" id="3448669">.</span><span class="ident" id="3448670">resp</span><span class="op" id="3448674">.</span><span class="ident" id="3448675">conn</span><span class="op" id="3448679">.</span><span class="ident" id="3448680">hijacked</span><span class="op" id="3448688">(</span><span class="op" id="3448689">)</span>&nbsp;<span class="op" id="3448691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448695">ecr</span><span class="op" id="3448698">.</span><span class="ident" id="3448699">resp</span><span class="op" id="3448703">.</span><span class="ident" id="3448704">wroteContinue</span>&nbsp;<span class="op" id="3448718">=</span>&nbsp;<span class="builtintype" id="3448720">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448727">ecr</span><span class="op" id="3448730">.</span><span class="ident" id="3448731">resp</span><span class="op" id="3448735">.</span><span class="ident" id="3448736">conn</span><span class="op" id="3448740">.</span><span class="ident" id="3448741">buf</span><span class="op" id="3448744">.</span><span class="ident" id="3448745">WriteString</span><span class="op" id="3448756">(</span><span class="string" id="3448757">&#34;HTTP/1.1&nbsp;100&nbsp;Continue\r\n\r\n&#34;</span><span class="op" id="3448788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448792">ecr</span><span class="op" id="3448795">.</span><span class="ident" id="3448796">resp</span><span class="op" id="3448800">.</span><span class="ident" id="3448801">conn</span><span class="op" id="3448805">.</span><span class="ident" id="3448806">buf</span><span class="op" id="3448809">.</span><span class="ident" id="3448810">Flush</span><span class="op" id="3448815">(</span><span class="op" id="3448816">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3448819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448822">return</span>&nbsp;<span class="ident" id="3448829">ecr</span><span class="op" id="3448832">.</span><span class="ident" id="3448833">readCloser</span><span class="op" id="3448843">.</span><span class="ident" id="3448844">Read</span><span class="op" id="3448848">(</span><span class="ident" id="3448849">p</span><span class="op" id="3448850">)</span><br>
<span class="lineno"></span><span class="op" id="3448852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3448855">func</span>&nbsp;<span class="op" id="3448860">(</span><span class="ident" id="3448861">ecr</span>&nbsp;<span class="op" id="3448865">*</span><span class="ident" id="3448866">expectContinueReader</span><span class="op" id="3448886">)</span>&nbsp;<span class="ident" id="3448888">Close</span><span class="op" id="3448893">(</span><span class="op" id="3448894">)</span>&nbsp;<span class="builtintype" id="3448896">error</span>&nbsp;<span class="op" id="3448902">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3448905">ecr</span><span class="op" id="3448908">.</span><span class="ident" id="3448909">closed</span>&nbsp;<span class="op" id="3448916">=</span>&nbsp;<span class="builtintype" id="3448918">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3448924">return</span>&nbsp;<span class="ident" id="3448931">ecr</span><span class="op" id="3448934">.</span><span class="ident" id="3448935">readCloser</span><span class="op" id="3448945">.</span><span class="ident" id="3448946">Close</span><span class="op" id="3448951">(</span><span class="op" id="3448952">)</span><br>
<span class="lineno"></span><span class="op" id="3448954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3448957">//&nbsp;TimeFormat&nbsp;is&nbsp;the&nbsp;time&nbsp;format&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno">540</span><span class="comment" id="3449002">//&nbsp;time.Parse&nbsp;and&nbsp;time.Time.Format&nbsp;when&nbsp;parsing</span><br>
<span class="lineno"></span><span class="comment" id="3449050">//&nbsp;or&nbsp;generating&nbsp;times&nbsp;in&nbsp;HTTP&nbsp;headers.</span><br>
<span class="lineno"></span><span class="comment" id="3449090">//&nbsp;It&nbsp;is&nbsp;like&nbsp;time.RFC1123&nbsp;but&nbsp;hard&nbsp;codes&nbsp;GMT&nbsp;as&nbsp;the&nbsp;time&nbsp;zone.</span><br>
<span class="lineno"></span><span class="keyword" id="3449154">const</span>&nbsp;<span class="ident" id="3449160">TimeFormat</span>&nbsp;<span class="op" id="3449171">=</span>&nbsp;<span class="string" id="3449173">&#34;Mon,&nbsp;02&nbsp;Jan&nbsp;2006&nbsp;15:04:05&nbsp;GMT&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span><span class="comment" id="3449206">//&nbsp;appendTime&nbsp;is&nbsp;a&nbsp;non-allocating&nbsp;version&nbsp;of&nbsp;[]byte(t.UTC().Format(TimeFormat))</span><br>
<span class="lineno"></span><span class="keyword" id="3449286">func</span>&nbsp;<span class="ident" id="3449291">appendTime</span><span class="op" id="3449301">(</span><span class="ident" id="3449302">b</span>&nbsp;<span class="op" id="3449304">[</span><span class="op" id="3449305">]</span><span class="builtintype" id="3449306">byte</span><span class="op" id="3449310">,</span>&nbsp;<span class="ident" id="3449312">t</span>&nbsp;<span class="ident" id="3449314">time</span><span class="op" id="3449318">.</span><span class="ident" id="3449319">Time</span><span class="op" id="3449323">)</span>&nbsp;<span class="op" id="3449325">[</span><span class="op" id="3449326">]</span><span class="builtintype" id="3449327">byte</span>&nbsp;<span class="op" id="3449332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3449335">const</span>&nbsp;<span class="ident" id="3449341">days</span>&nbsp;<span class="op" id="3449346">=</span>&nbsp;<span class="string" id="3449348">&#34;SunMonTueWedThuFriSat&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3449373">const</span>&nbsp;<span class="ident" id="3449379">months</span>&nbsp;<span class="op" id="3449386">=</span>&nbsp;<span class="string" id="3449388">&#34;JanFebMarAprMayJunJulAugSepOctNovDec&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3449429">t</span>&nbsp;<span class="op" id="3449431">=</span>&nbsp;<span class="ident" id="3449433">t</span><span class="op" id="3449434">.</span><span class="ident" id="3449435">UTC</span><span class="op" id="3449438">(</span><span class="op" id="3449439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3449442">yy</span><span class="op" id="3449444">,</span>&nbsp;<span class="ident" id="3449446">mm</span><span class="op" id="3449448">,</span>&nbsp;<span class="ident" id="3449450">dd</span>&nbsp;<span class="op" id="3449453">:=</span>&nbsp;<span class="ident" id="3449456">t</span><span class="op" id="3449457">.</span><span class="ident" id="3449458">Date</span><span class="op" id="3449462">(</span><span class="op" id="3449463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3449466">hh</span><span class="op" id="3449468">,</span>&nbsp;<span class="ident" id="3449470">mn</span><span class="op" id="3449472">,</span>&nbsp;<span class="ident" id="3449474">ss</span>&nbsp;<span class="op" id="3449477">:=</span>&nbsp;<span class="ident" id="3449480">t</span><span class="op" id="3449481">.</span><span class="ident" id="3449482">Clock</span><span class="op" id="3449487">(</span><span class="op" id="3449488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3449491">day</span>&nbsp;<span class="op" id="3449495">:=</span>&nbsp;<span class="ident" id="3449498">days</span><span class="op" id="3449502">[</span><span class="num" id="3449503">3</span><span class="op" id="3449504">*</span><span class="ident" id="3449505">t</span><span class="op" id="3449506">.</span><span class="ident" id="3449507">Weekday</span><span class="op" id="3449514">(</span><span class="op" id="3449515">)</span><span class="op" id="3449516">:</span><span class="op" id="3449517">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3449520">mon</span>&nbsp;<span class="op" id="3449524">:=</span>&nbsp;<span class="ident" id="3449527">months</span><span class="op" id="3449533">[</span><span class="num" id="3449534">3</span><span class="op" id="3449535">*</span><span class="op" id="3449536">(</span><span class="ident" id="3449537">mm</span><span class="op" id="3449539">-</span><span class="num" id="3449540">1</span><span class="op" id="3449541">)</span><span class="op" id="3449542">:</span><span class="op" id="3449543">]</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3449547">return</span>&nbsp;<span class="builtinfunc" id="3449554">append</span><span class="op" id="3449560">(</span><span class="ident" id="3449561">b</span><span class="op" id="3449562">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3449566">day</span><span class="op" id="3449569">[</span><span class="num" id="3449570">0</span><span class="op" id="3449571">]</span><span class="op" id="3449572">,</span>&nbsp;<span class="ident" id="3449574">day</span><span class="op" id="3449577">[</span><span class="num" id="3449578">1</span><span class="op" id="3449579">]</span><span class="op" id="3449580">,</span>&nbsp;<span class="ident" id="3449582">day</span><span class="op" id="3449585">[</span><span class="num" id="3449586">2</span><span class="op" id="3449587">]</span><span class="op" id="3449588">,</span>&nbsp;<span class="string" id="3449590">&#39;,&#39;</span><span class="op" id="3449593">,</span>&nbsp;<span class="string" id="3449595">&#39;&nbsp;&#39;</span><span class="op" id="3449598">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3449602">byte</span><span class="op" id="3449606">(</span><span class="string" id="3449607">&#39;0&#39;</span><span class="op" id="3449610">+</span><span class="ident" id="3449611">dd</span><span class="op" id="3449613">/</span><span class="num" id="3449614">10</span><span class="op" id="3449616">)</span><span class="op" id="3449617">,</span>&nbsp;<span class="builtintype" id="3449619">byte</span><span class="op" id="3449623">(</span><span class="string" id="3449624">&#39;0&#39;</span><span class="op" id="3449627">+</span><span class="ident" id="3449628">dd</span><span class="op" id="3449630">%</span><span class="num" id="3449631">10</span><span class="op" id="3449633">)</span><span class="op" id="3449634">,</span>&nbsp;<span class="string" id="3449636">&#39;&nbsp;&#39;</span><span class="op" id="3449639">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3449643">mon</span><span class="op" id="3449646">[</span><span class="num" id="3449647">0</span><span class="op" id="3449648">]</span><span class="op" id="3449649">,</span>&nbsp;<span class="ident" id="3449651">mon</span><span class="op" id="3449654">[</span><span class="num" id="3449655">1</span><span class="op" id="3449656">]</span><span class="op" id="3449657">,</span>&nbsp;<span class="ident" id="3449659">mon</span><span class="op" id="3449662">[</span><span class="num" id="3449663">2</span><span class="op" id="3449664">]</span><span class="op" id="3449665">,</span>&nbsp;<span class="string" id="3449667">&#39;&nbsp;&#39;</span><span class="op" id="3449670">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3449674">byte</span><span class="op" id="3449678">(</span><span class="string" id="3449679">&#39;0&#39;</span><span class="op" id="3449682">+</span><span class="ident" id="3449683">yy</span><span class="op" id="3449685">/</span><span class="num" id="3449686">1000</span><span class="op" id="3449690">)</span><span class="op" id="3449691">,</span>&nbsp;<span class="builtintype" id="3449693">byte</span><span class="op" id="3449697">(</span><span class="string" id="3449698">&#39;0&#39;</span><span class="op" id="3449701">+</span><span class="op" id="3449702">(</span><span class="ident" id="3449703">yy</span><span class="op" id="3449705">/</span><span class="num" id="3449706">100</span><span class="op" id="3449709">)</span><span class="op" id="3449710">%</span><span class="num" id="3449711">10</span><span class="op" id="3449713">)</span><span class="op" id="3449714">,</span>&nbsp;<span class="builtintype" id="3449716">byte</span><span class="op" id="3449720">(</span><span class="string" id="3449721">&#39;0&#39;</span><span class="op" id="3449724">+</span><span class="op" id="3449725">(</span><span class="ident" id="3449726">yy</span><span class="op" id="3449728">/</span><span class="num" id="3449729">10</span><span class="op" id="3449731">)</span><span class="op" id="3449732">%</span><span class="num" id="3449733">10</span><span class="op" id="3449735">)</span><span class="op" id="3449736">,</span>&nbsp;<span class="builtintype" id="3449738">byte</span><span class="op" id="3449742">(</span><span class="string" id="3449743">&#39;0&#39;</span><span class="op" id="3449746">+</span><span class="ident" id="3449747">yy</span><span class="op" id="3449749">%</span><span class="num" id="3449750">10</span><span class="op" id="3449752">)</span><span class="op" id="3449753">,</span>&nbsp;<span class="string" id="3449755">&#39;&nbsp;&#39;</span><span class="op" id="3449758">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3449762">byte</span><span class="op" id="3449766">(</span><span class="string" id="3449767">&#39;0&#39;</span><span class="op" id="3449770">+</span><span class="ident" id="3449771">hh</span><span class="op" id="3449773">/</span><span class="num" id="3449774">10</span><span class="op" id="3449776">)</span><span class="op" id="3449777">,</span>&nbsp;<span class="builtintype" id="3449779">byte</span><span class="op" id="3449783">(</span><span class="string" id="3449784">&#39;0&#39;</span><span class="op" id="3449787">+</span><span class="ident" id="3449788">hh</span><span class="op" id="3449790">%</span><span class="num" id="3449791">10</span><span class="op" id="3449793">)</span><span class="op" id="3449794">,</span>&nbsp;<span class="string" id="3449796">&#39;:&#39;</span><span class="op" id="3449799">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3449803">byte</span><span class="op" id="3449807">(</span><span class="string" id="3449808">&#39;0&#39;</span><span class="op" id="3449811">+</span><span class="ident" id="3449812">mn</span><span class="op" id="3449814">/</span><span class="num" id="3449815">10</span><span class="op" id="3449817">)</span><span class="op" id="3449818">,</span>&nbsp;<span class="builtintype" id="3449820">byte</span><span class="op" id="3449824">(</span><span class="string" id="3449825">&#39;0&#39;</span><span class="op" id="3449828">+</span><span class="ident" id="3449829">mn</span><span class="op" id="3449831">%</span><span class="num" id="3449832">10</span><span class="op" id="3449834">)</span><span class="op" id="3449835">,</span>&nbsp;<span class="string" id="3449837">&#39;:&#39;</span><span class="op" id="3449840">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3449844">byte</span><span class="op" id="3449848">(</span><span class="string" id="3449849">&#39;0&#39;</span><span class="op" id="3449852">+</span><span class="ident" id="3449853">ss</span><span class="op" id="3449855">/</span><span class="num" id="3449856">10</span><span class="op" id="3449858">)</span><span class="op" id="3449859">,</span>&nbsp;<span class="builtintype" id="3449861">byte</span><span class="op" id="3449865">(</span><span class="string" id="3449866">&#39;0&#39;</span><span class="op" id="3449869">+</span><span class="ident" id="3449870">ss</span><span class="op" id="3449872">%</span><span class="num" id="3449873">10</span><span class="op" id="3449875">)</span><span class="op" id="3449876">,</span>&nbsp;<span class="string" id="3449878">&#39;&nbsp;&#39;</span><span class="op" id="3449881">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3449885">&#39;G&#39;</span><span class="op" id="3449888">,</span>&nbsp;<span class="string" id="3449890">&#39;M&#39;</span><span class="op" id="3449893">,</span>&nbsp;<span class="string" id="3449895">&#39;T&#39;</span><span class="op" id="3449898">)</span><br>
<span class="lineno">565</span><span class="op" id="3449900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3449903">var</span>&nbsp;<span class="ident" id="3449907">errTooLarge</span>&nbsp;<span class="op" id="3449919">=</span>&nbsp;<span class="ident" id="3449921">errors</span><span class="op" id="3449927">.</span><span class="ident" id="3449928">New</span><span class="op" id="3449931">(</span><span class="string" id="3449932">&#34;http:&nbsp;request&nbsp;too&nbsp;large&#34;</span><span class="op" id="3449957">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3449960">//&nbsp;Read&nbsp;next&nbsp;request&nbsp;from&nbsp;connection.</span><br>
<span class="lineno">570</span><span class="keyword" id="3449998">func</span>&nbsp;<span class="op" id="3450003">(</span><span class="ident" id="3450004">c</span>&nbsp;<span class="op" id="3450006">*</span><span class="ident" id="3450007">conn</span><span class="op" id="3450011">)</span>&nbsp;<span class="ident" id="3450013">readRequest</span><span class="op" id="3450024">(</span><span class="op" id="3450025">)</span>&nbsp;<span class="op" id="3450027">(</span><span class="ident" id="3450028">w</span>&nbsp;<span class="op" id="3450030">*</span><span class="ident" id="3450031">response</span><span class="op" id="3450039">,</span>&nbsp;<span class="ident" id="3450041">err</span>&nbsp;<span class="builtintype" id="3450045">error</span><span class="op" id="3450050">)</span>&nbsp;<span class="op" id="3450052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450055">if</span>&nbsp;<span class="ident" id="3450058">c</span><span class="op" id="3450059">.</span><span class="ident" id="3450060">hijacked</span><span class="op" id="3450068">(</span><span class="op" id="3450069">)</span>&nbsp;<span class="op" id="3450071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450075">return</span>&nbsp;<span class="ident" id="3450082">nil</span><span class="op" id="3450085">,</span>&nbsp;<span class="ident" id="3450087">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450104">if</span>&nbsp;<span class="ident" id="3450107">d</span>&nbsp;<span class="op" id="3450109">:=</span>&nbsp;<span class="ident" id="3450112">c</span><span class="op" id="3450113">.</span><span class="ident" id="3450114">server</span><span class="op" id="3450120">.</span><span class="ident" id="3450121">ReadTimeout</span><span class="op" id="3450132">;</span>&nbsp;<span class="ident" id="3450134">d</span>&nbsp;<span class="op" id="3450136">!=</span>&nbsp;<span class="num" id="3450139">0</span>&nbsp;<span class="op" id="3450141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450145">c</span><span class="op" id="3450146">.</span><span class="ident" id="3450147">rwc</span><span class="op" id="3450150">.</span><span class="ident" id="3450151">SetReadDeadline</span><span class="op" id="3450166">(</span><span class="ident" id="3450167">time</span><span class="op" id="3450171">.</span><span class="ident" id="3450172">Now</span><span class="op" id="3450175">(</span><span class="op" id="3450176">)</span><span class="op" id="3450177">.</span><span class="ident" id="3450178">Add</span><span class="op" id="3450181">(</span><span class="ident" id="3450182">d</span><span class="op" id="3450183">)</span><span class="op" id="3450184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450190">if</span>&nbsp;<span class="ident" id="3450193">d</span>&nbsp;<span class="op" id="3450195">:=</span>&nbsp;<span class="ident" id="3450198">c</span><span class="op" id="3450199">.</span><span class="ident" id="3450200">server</span><span class="op" id="3450206">.</span><span class="ident" id="3450207">WriteTimeout</span><span class="op" id="3450219">;</span>&nbsp;<span class="ident" id="3450221">d</span>&nbsp;<span class="op" id="3450223">!=</span>&nbsp;<span class="num" id="3450226">0</span>&nbsp;<span class="op" id="3450228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450232">defer</span>&nbsp;<span class="keyword" id="3450238">func</span><span class="op" id="3450242">(</span><span class="op" id="3450243">)</span>&nbsp;<span class="op" id="3450245">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450250">c</span><span class="op" id="3450251">.</span><span class="ident" id="3450252">rwc</span><span class="op" id="3450255">.</span><span class="ident" id="3450256">SetWriteDeadline</span><span class="op" id="3450272">(</span><span class="ident" id="3450273">time</span><span class="op" id="3450277">.</span><span class="ident" id="3450278">Now</span><span class="op" id="3450281">(</span><span class="op" id="3450282">)</span><span class="op" id="3450283">.</span><span class="ident" id="3450284">Add</span><span class="op" id="3450287">(</span><span class="ident" id="3450288">d</span><span class="op" id="3450289">)</span><span class="op" id="3450290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450294">}</span><span class="op" id="3450295">(</span><span class="op" id="3450296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450303">c</span><span class="op" id="3450304">.</span><span class="ident" id="3450305">lr</span><span class="op" id="3450307">.</span><span class="ident" id="3450308">N</span>&nbsp;<span class="op" id="3450310">=</span>&nbsp;<span class="ident" id="3450312">c</span><span class="op" id="3450313">.</span><span class="ident" id="3450314">server</span><span class="op" id="3450320">.</span><span class="ident" id="3450321">initialLimitedReaderSize</span><span class="op" id="3450345">(</span><span class="op" id="3450346">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450349">var</span>&nbsp;<span class="ident" id="3450353">req</span>&nbsp;<span class="op" id="3450357">*</span><span class="ident" id="3450358">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450367">if</span>&nbsp;<span class="ident" id="3450370">req</span><span class="op" id="3450373">,</span>&nbsp;<span class="ident" id="3450375">err</span>&nbsp;<span class="op" id="3450379">=</span>&nbsp;<span class="ident" id="3450381">ReadRequest</span><span class="op" id="3450392">(</span><span class="ident" id="3450393">c</span><span class="op" id="3450394">.</span><span class="ident" id="3450395">buf</span><span class="op" id="3450398">.</span><span class="ident" id="3450399">Reader</span><span class="op" id="3450405">)</span><span class="op" id="3450406">;</span>&nbsp;<span class="ident" id="3450408">err</span>&nbsp;<span class="op" id="3450412">!=</span>&nbsp;<span class="ident" id="3450415">nil</span>&nbsp;<span class="op" id="3450419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450423">if</span>&nbsp;<span class="ident" id="3450426">c</span><span class="op" id="3450427">.</span><span class="ident" id="3450428">lr</span><span class="op" id="3450430">.</span><span class="ident" id="3450431">N</span>&nbsp;<span class="op" id="3450433">==</span>&nbsp;<span class="num" id="3450436">0</span>&nbsp;<span class="op" id="3450438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450443">return</span>&nbsp;<span class="ident" id="3450450">nil</span><span class="op" id="3450453">,</span>&nbsp;<span class="ident" id="3450455">errTooLarge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450469">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450473">return</span>&nbsp;<span class="ident" id="3450480">nil</span><span class="op" id="3450483">,</span>&nbsp;<span class="ident" id="3450485">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450493">c</span><span class="op" id="3450494">.</span><span class="ident" id="3450495">lr</span><span class="op" id="3450497">.</span><span class="ident" id="3450498">N</span>&nbsp;<span class="op" id="3450500">=</span>&nbsp;<span class="ident" id="3450502">noLimit</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450512">req</span><span class="op" id="3450515">.</span><span class="ident" id="3450516">RemoteAddr</span>&nbsp;<span class="op" id="3450527">=</span>&nbsp;<span class="ident" id="3450529">c</span><span class="op" id="3450530">.</span><span class="ident" id="3450531">remoteAddr</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450543">req</span><span class="op" id="3450546">.</span><span class="ident" id="3450547">TLS</span>&nbsp;<span class="op" id="3450551">=</span>&nbsp;<span class="ident" id="3450553">c</span><span class="op" id="3450554">.</span><span class="ident" id="3450555">tlsState</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450566">w</span>&nbsp;<span class="op" id="3450568">=</span>&nbsp;<span class="op" id="3450570">&amp;</span><span class="ident" id="3450571">response</span><span class="op" id="3450579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450583">conn</span><span class="op" id="3450587">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3450598">c</span><span class="op" id="3450599">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450603">req</span><span class="op" id="3450606">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3450618">req</span><span class="op" id="3450621">,</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450625">handlerHeader</span><span class="op" id="3450638">:</span>&nbsp;<span class="builtinfunc" id="3450640">make</span><span class="op" id="3450644">(</span><span class="ident" id="3450645">Header</span><span class="op" id="3450651">)</span><span class="op" id="3450652">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450656">contentLength</span><span class="op" id="3450669">:</span>&nbsp;<span class="op" id="3450671">-</span><span class="num" id="3450672">1</span><span class="op" id="3450673">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3450676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450679">w</span><span class="op" id="3450680">.</span><span class="ident" id="3450681">cw</span><span class="op" id="3450683">.</span><span class="ident" id="3450684">res</span>&nbsp;<span class="op" id="3450688">=</span>&nbsp;<span class="ident" id="3450690">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3450693">w</span><span class="op" id="3450694">.</span><span class="ident" id="3450695">w</span>&nbsp;<span class="op" id="3450697">=</span>&nbsp;<span class="ident" id="3450699">newBufioWriterSize</span><span class="op" id="3450717">(</span><span class="op" id="3450718">&amp;</span><span class="ident" id="3450719">w</span><span class="op" id="3450720">.</span><span class="ident" id="3450721">cw</span><span class="op" id="3450723">,</span>&nbsp;<span class="ident" id="3450725">bufferBeforeChunkingSize</span><span class="op" id="3450749">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450752">return</span>&nbsp;<span class="ident" id="3450759">w</span><span class="op" id="3450760">,</span>&nbsp;<span class="ident" id="3450762">nil</span><br>
<span class="lineno"></span><span class="op" id="3450766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3450769">func</span>&nbsp;<span class="op" id="3450774">(</span><span class="ident" id="3450775">w</span>&nbsp;<span class="op" id="3450777">*</span><span class="ident" id="3450778">response</span><span class="op" id="3450786">)</span>&nbsp;<span class="ident" id="3450788">Header</span><span class="op" id="3450794">(</span><span class="op" id="3450795">)</span>&nbsp;<span class="ident" id="3450797">Header</span>&nbsp;<span class="op" id="3450804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3450807">if</span>&nbsp;<span class="ident" id="3450810">w</span><span class="op" id="3450811">.</span><span class="ident" id="3450812">cw</span><span class="op" id="3450814">.</span><span class="ident" id="3450815">header</span>&nbsp;<span class="op" id="3450822">==</span>&nbsp;<span class="ident" id="3450825">nil</span>&nbsp;<span class="op" id="3450829">&amp;&amp;</span>&nbsp;<span class="ident" id="3450832">w</span><span class="op" id="3450833">.</span><span class="ident" id="3450834">wroteHeader</span>&nbsp;<span class="op" id="3450846">&amp;&amp;</span>&nbsp;<span class="op" id="3450849">!</span><span class="ident" id="3450850">w</span><span class="op" id="3450851">.</span><span class="ident" id="3450852">cw</span><span class="op" id="3450854">.</span><span class="ident" id="3450855">wroteHeader</span>&nbsp;<span class="op" id="3450867">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3450871">//&nbsp;Accessing&nbsp;the&nbsp;header&nbsp;between&nbsp;logically&nbsp;writing&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3450926">//&nbsp;and&nbsp;physically&nbsp;writing&nbsp;it&nbsp;means&nbsp;we&nbsp;need&nbsp;to&nbsp;allocate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3450983">//&nbsp;a&nbsp;clone&nbsp;to&nbsp;snapshot&nbsp;the&nbsp;logically&nbsp;written&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451037">w</span><span class="op" id="3451038">.</span><span class="ident" id="3451039">cw</span><span class="op" id="3451041">.</span><span class="ident" id="3451042">header</span>&nbsp;<span class="op" id="3451049">=</span>&nbsp;<span class="ident" id="3451051">w</span><span class="op" id="3451052">.</span><span class="ident" id="3451053">handlerHeader</span><span class="op" id="3451066">.</span><span class="ident" id="3451067">clone</span><span class="op" id="3451072">(</span><span class="op" id="3451073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3451076">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451079">w</span><span class="op" id="3451080">.</span><span class="ident" id="3451081">calledHeader</span>&nbsp;<span class="op" id="3451094">=</span>&nbsp;<span class="builtintype" id="3451096">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451102">return</span>&nbsp;<span class="ident" id="3451109">w</span><span class="op" id="3451110">.</span><span class="ident" id="3451111">handlerHeader</span><br>
<span class="lineno"></span><span class="op" id="3451125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3451128">//&nbsp;maxPostHandlerReadBytes&nbsp;is&nbsp;the&nbsp;max&nbsp;number&nbsp;of&nbsp;Request.Body&nbsp;bytes&nbsp;not</span><br>
<span class="lineno">620</span><span class="comment" id="3451199">//&nbsp;consumed&nbsp;by&nbsp;a&nbsp;handler&nbsp;that&nbsp;the&nbsp;server&nbsp;will&nbsp;read&nbsp;from&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="3451266">//&nbsp;in&nbsp;order&nbsp;to&nbsp;keep&nbsp;a&nbsp;connection&nbsp;alive.&nbsp;&nbsp;If&nbsp;there&nbsp;are&nbsp;more&nbsp;bytes&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="3451336">//&nbsp;this&nbsp;then&nbsp;the&nbsp;server&nbsp;to&nbsp;be&nbsp;paranoid&nbsp;instead&nbsp;sends&nbsp;a&nbsp;&#34;Connection:</span><br>
<span class="lineno"></span><span class="comment" id="3451404">//&nbsp;close&#34;&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="3451424">//</span><br>
<span class="lineno">625</span><span class="comment" id="3451427">//&nbsp;This&nbsp;number&nbsp;is&nbsp;approximately&nbsp;what&nbsp;a&nbsp;typical&nbsp;machine&#39;s&nbsp;TCP&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="3451495">//&nbsp;size&nbsp;is&nbsp;anyway.&nbsp;&nbsp;(if&nbsp;we&nbsp;have&nbsp;the&nbsp;bytes&nbsp;on&nbsp;the&nbsp;machine,&nbsp;we&nbsp;might&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="3451565">//&nbsp;well&nbsp;read&nbsp;them)</span><br>
<span class="lineno"></span><span class="keyword" id="3451584">const</span>&nbsp;<span class="ident" id="3451590">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="3451614">=</span>&nbsp;<span class="num" id="3451616">256</span>&nbsp;<span class="op" id="3451620">&lt;&lt;</span>&nbsp;<span class="num" id="3451623">10</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="3451627">func</span>&nbsp;<span class="op" id="3451632">(</span><span class="ident" id="3451633">w</span>&nbsp;<span class="op" id="3451635">*</span><span class="ident" id="3451636">response</span><span class="op" id="3451644">)</span>&nbsp;<span class="ident" id="3451646">WriteHeader</span><span class="op" id="3451657">(</span><span class="ident" id="3451658">code</span>&nbsp;<span class="builtintype" id="3451663">int</span><span class="op" id="3451666">)</span>&nbsp;<span class="op" id="3451668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451671">if</span>&nbsp;<span class="ident" id="3451674">w</span><span class="op" id="3451675">.</span><span class="ident" id="3451676">conn</span><span class="op" id="3451680">.</span><span class="ident" id="3451681">hijacked</span><span class="op" id="3451689">(</span><span class="op" id="3451690">)</span>&nbsp;<span class="op" id="3451692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451696">w</span><span class="op" id="3451697">.</span><span class="ident" id="3451698">conn</span><span class="op" id="3451702">.</span><span class="ident" id="3451703">server</span><span class="op" id="3451709">.</span><span class="ident" id="3451710">logf</span><span class="op" id="3451714">(</span><span class="string" id="3451715">&#34;http:&nbsp;response.WriteHeader&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="3451766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451770">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3451778">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451781">if</span>&nbsp;<span class="ident" id="3451784">w</span><span class="op" id="3451785">.</span><span class="ident" id="3451786">wroteHeader</span>&nbsp;<span class="op" id="3451798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451802">w</span><span class="op" id="3451803">.</span><span class="ident" id="3451804">conn</span><span class="op" id="3451808">.</span><span class="ident" id="3451809">server</span><span class="op" id="3451815">.</span><span class="ident" id="3451816">logf</span><span class="op" id="3451820">(</span><span class="string" id="3451821">&#34;http:&nbsp;multiple&nbsp;response.WriteHeader&nbsp;calls&#34;</span><span class="op" id="3451864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451868">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3451876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451879">w</span><span class="op" id="3451880">.</span><span class="ident" id="3451881">wroteHeader</span>&nbsp;<span class="op" id="3451893">=</span>&nbsp;<span class="builtintype" id="3451895">true</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451901">w</span><span class="op" id="3451902">.</span><span class="ident" id="3451903">status</span>&nbsp;<span class="op" id="3451910">=</span>&nbsp;<span class="ident" id="3451912">code</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451919">if</span>&nbsp;<span class="ident" id="3451922">w</span><span class="op" id="3451923">.</span><span class="ident" id="3451924">calledHeader</span>&nbsp;<span class="op" id="3451937">&amp;&amp;</span>&nbsp;<span class="ident" id="3451940">w</span><span class="op" id="3451941">.</span><span class="ident" id="3451942">cw</span><span class="op" id="3451944">.</span><span class="ident" id="3451945">header</span>&nbsp;<span class="op" id="3451952">==</span>&nbsp;<span class="ident" id="3451955">nil</span>&nbsp;<span class="op" id="3451959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3451963">w</span><span class="op" id="3451964">.</span><span class="ident" id="3451965">cw</span><span class="op" id="3451967">.</span><span class="ident" id="3451968">header</span>&nbsp;<span class="op" id="3451975">=</span>&nbsp;<span class="ident" id="3451977">w</span><span class="op" id="3451978">.</span><span class="ident" id="3451979">handlerHeader</span><span class="op" id="3451992">.</span><span class="ident" id="3451993">clone</span><span class="op" id="3451998">(</span><span class="op" id="3451999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452002">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452006">if</span>&nbsp;<span class="ident" id="3452009">cl</span>&nbsp;<span class="op" id="3452012">:=</span>&nbsp;<span class="ident" id="3452015">w</span><span class="op" id="3452016">.</span><span class="ident" id="3452017">handlerHeader</span><span class="op" id="3452030">.</span><span class="ident" id="3452031">get</span><span class="op" id="3452034">(</span><span class="string" id="3452035">&#34;Content-Length&#34;</span><span class="op" id="3452051">)</span><span class="op" id="3452052">;</span>&nbsp;<span class="ident" id="3452054">cl</span>&nbsp;<span class="op" id="3452057">!=</span>&nbsp;<span class="string" id="3452060">&#34;&#34;</span>&nbsp;<span class="op" id="3452063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452067">v</span><span class="op" id="3452068">,</span>&nbsp;<span class="ident" id="3452070">err</span>&nbsp;<span class="op" id="3452074">:=</span>&nbsp;<span class="ident" id="3452077">strconv</span><span class="op" id="3452084">.</span><span class="ident" id="3452085">ParseInt</span><span class="op" id="3452093">(</span><span class="ident" id="3452094">cl</span><span class="op" id="3452096">,</span>&nbsp;<span class="num" id="3452098">10</span><span class="op" id="3452100">,</span>&nbsp;<span class="num" id="3452102">64</span><span class="op" id="3452104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452108">if</span>&nbsp;<span class="ident" id="3452111">err</span>&nbsp;<span class="op" id="3452115">==</span>&nbsp;<span class="ident" id="3452118">nil</span>&nbsp;<span class="op" id="3452122">&amp;&amp;</span>&nbsp;<span class="ident" id="3452125">v</span>&nbsp;<span class="op" id="3452127">&gt;=</span>&nbsp;<span class="num" id="3452130">0</span>&nbsp;<span class="op" id="3452132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452137">w</span><span class="op" id="3452138">.</span><span class="ident" id="3452139">contentLength</span>&nbsp;<span class="op" id="3452153">=</span>&nbsp;<span class="ident" id="3452155">v</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452159">}</span>&nbsp;<span class="keyword" id="3452161">else</span>&nbsp;<span class="op" id="3452166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452171">w</span><span class="op" id="3452172">.</span><span class="ident" id="3452173">conn</span><span class="op" id="3452177">.</span><span class="ident" id="3452178">server</span><span class="op" id="3452184">.</span><span class="ident" id="3452185">logf</span><span class="op" id="3452189">(</span><span class="string" id="3452190">&#34;http:&nbsp;invalid&nbsp;Content-Length&nbsp;of&nbsp;%q&#34;</span><span class="op" id="3452226">,</span>&nbsp;<span class="ident" id="3452228">cl</span><span class="op" id="3452230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452235">w</span><span class="op" id="3452236">.</span><span class="ident" id="3452237">handlerHeader</span><span class="op" id="3452250">.</span><span class="ident" id="3452251">Del</span><span class="op" id="3452254">(</span><span class="string" id="3452255">&#34;Content-Length&#34;</span><span class="op" id="3452271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452278">}</span><br>
<span class="lineno">655</span><span class="op" id="3452280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3452283">//&nbsp;extraHeader&nbsp;is&nbsp;the&nbsp;set&nbsp;of&nbsp;headers&nbsp;sometimes&nbsp;added&nbsp;by&nbsp;chunkWriter.writeHeader.</span><br>
<span class="lineno"></span><span class="comment" id="3452364">//&nbsp;This&nbsp;type&nbsp;is&nbsp;used&nbsp;to&nbsp;avoid&nbsp;extra&nbsp;allocations&nbsp;from&nbsp;cloning&nbsp;and/or&nbsp;populating</span><br>
<span class="lineno"></span><span class="comment" id="3452443">//&nbsp;the&nbsp;response&nbsp;Header&nbsp;map&nbsp;and&nbsp;all&nbsp;its&nbsp;1-element&nbsp;slices.</span><br>
<span class="lineno">660</span><span class="keyword" id="3452500">type</span>&nbsp;<span class="ident" id="3452505">extraHeader</span>&nbsp;<span class="keyword" id="3452517">struct</span>&nbsp;<span class="op" id="3452524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452527">contentType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3452544">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452552">connection</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3452569">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452577">transferEncoding</span>&nbsp;<span class="builtintype" id="3452594">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452602">date</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3452619">[</span><span class="op" id="3452620">]</span><span class="builtintype" id="3452621">byte</span>&nbsp;<span class="comment" id="3452626">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452649">contentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3452666">[</span><span class="op" id="3452667">]</span><span class="builtintype" id="3452668">byte</span>&nbsp;<span class="comment" id="3452673">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="3452695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3452698">//&nbsp;Sorted&nbsp;the&nbsp;same&nbsp;as&nbsp;extraHeader.Write&#39;s&nbsp;loop.</span><br>
<span class="lineno"></span><span class="keyword" id="3452746">var</span>&nbsp;<span class="ident" id="3452750">extraHeaderKeys</span>&nbsp;<span class="op" id="3452766">=</span>&nbsp;<span class="op" id="3452768">[</span><span class="op" id="3452769">]</span><span class="op" id="3452770">[</span><span class="op" id="3452771">]</span><span class="builtintype" id="3452772">byte</span><span class="op" id="3452776">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452779">[</span><span class="op" id="3452780">]</span><span class="builtintype" id="3452781">byte</span><span class="op" id="3452785">(</span><span class="string" id="3452786">&#34;Content-Type&#34;</span><span class="op" id="3452800">)</span><span class="op" id="3452801">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452804">[</span><span class="op" id="3452805">]</span><span class="builtintype" id="3452806">byte</span><span class="op" id="3452810">(</span><span class="string" id="3452811">&#34;Connection&#34;</span><span class="op" id="3452823">)</span><span class="op" id="3452824">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452827">[</span><span class="op" id="3452828">]</span><span class="builtintype" id="3452829">byte</span><span class="op" id="3452833">(</span><span class="string" id="3452834">&#34;Transfer-Encoding&#34;</span><span class="op" id="3452853">)</span><span class="op" id="3452854">,</span><br>
<span class="lineno"></span><span class="op" id="3452856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span><span class="keyword" id="3452859">var</span>&nbsp;<span class="op" id="3452863">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452866">headerContentLength</span>&nbsp;<span class="op" id="3452886">=</span>&nbsp;<span class="op" id="3452888">[</span><span class="op" id="3452889">]</span><span class="builtintype" id="3452890">byte</span><span class="op" id="3452894">(</span><span class="string" id="3452895">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="3452913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452916">headerDate</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3452936">=</span>&nbsp;<span class="op" id="3452938">[</span><span class="op" id="3452939">]</span><span class="builtintype" id="3452940">byte</span><span class="op" id="3452944">(</span><span class="string" id="3452945">&#34;Date:&nbsp;&#34;</span><span class="op" id="3452953">)</span><br>
<span class="lineno"></span><span class="op" id="3452955">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="comment" id="3452958">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;headers&nbsp;described&nbsp;in&nbsp;h&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="3453007">//</span><br>
<span class="lineno"></span><span class="comment" id="3453010">//&nbsp;This&nbsp;method&nbsp;has&nbsp;a&nbsp;value&nbsp;receiver,&nbsp;despite&nbsp;the&nbsp;somewhat&nbsp;large&nbsp;size</span><br>
<span class="lineno"></span><span class="comment" id="3453079">//&nbsp;of&nbsp;h,&nbsp;because&nbsp;it&nbsp;prevents&nbsp;an&nbsp;allocation.&nbsp;The&nbsp;escape&nbsp;analysis&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="3453149">//&nbsp;smart&nbsp;enough&nbsp;to&nbsp;realize&nbsp;this&nbsp;function&nbsp;doesn&#39;t&nbsp;mutate&nbsp;h.</span><br>
<span class="lineno">685</span><span class="keyword" id="3453208">func</span>&nbsp;<span class="op" id="3453213">(</span><span class="ident" id="3453214">h</span>&nbsp;<span class="ident" id="3453216">extraHeader</span><span class="op" id="3453227">)</span>&nbsp;<span class="ident" id="3453229">Write</span><span class="op" id="3453234">(</span><span class="ident" id="3453235">w</span>&nbsp;<span class="op" id="3453237">*</span><span class="ident" id="3453238">bufio</span><span class="op" id="3453243">.</span><span class="ident" id="3453244">Writer</span><span class="op" id="3453250">)</span>&nbsp;<span class="op" id="3453252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453255">if</span>&nbsp;<span class="ident" id="3453258">h</span><span class="op" id="3453259">.</span><span class="ident" id="3453260">date</span>&nbsp;<span class="op" id="3453265">!=</span>&nbsp;<span class="ident" id="3453268">nil</span>&nbsp;<span class="op" id="3453272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453276">w</span><span class="op" id="3453277">.</span><span class="ident" id="3453278">Write</span><span class="op" id="3453283">(</span><span class="ident" id="3453284">headerDate</span><span class="op" id="3453294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453298">w</span><span class="op" id="3453299">.</span><span class="ident" id="3453300">Write</span><span class="op" id="3453305">(</span><span class="ident" id="3453306">h</span><span class="op" id="3453307">.</span><span class="ident" id="3453308">date</span><span class="op" id="3453312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453316">w</span><span class="op" id="3453317">.</span><span class="ident" id="3453318">Write</span><span class="op" id="3453323">(</span><span class="ident" id="3453324">crlf</span><span class="op" id="3453328">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3453331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453334">if</span>&nbsp;<span class="ident" id="3453337">h</span><span class="op" id="3453338">.</span><span class="ident" id="3453339">contentLength</span>&nbsp;<span class="op" id="3453353">!=</span>&nbsp;<span class="ident" id="3453356">nil</span>&nbsp;<span class="op" id="3453360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453364">w</span><span class="op" id="3453365">.</span><span class="ident" id="3453366">Write</span><span class="op" id="3453371">(</span><span class="ident" id="3453372">headerContentLength</span><span class="op" id="3453391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453395">w</span><span class="op" id="3453396">.</span><span class="ident" id="3453397">Write</span><span class="op" id="3453402">(</span><span class="ident" id="3453403">h</span><span class="op" id="3453404">.</span><span class="ident" id="3453405">contentLength</span><span class="op" id="3453418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453422">w</span><span class="op" id="3453423">.</span><span class="ident" id="3453424">Write</span><span class="op" id="3453429">(</span><span class="ident" id="3453430">crlf</span><span class="op" id="3453434">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3453437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453440">for</span>&nbsp;<span class="ident" id="3453444">i</span><span class="op" id="3453445">,</span>&nbsp;<span class="ident" id="3453447">v</span>&nbsp;<span class="op" id="3453449">:=</span>&nbsp;<span class="keyword" id="3453452">range</span>&nbsp;<span class="op" id="3453458">[</span><span class="op" id="3453459">]</span><span class="builtintype" id="3453460">string</span><span class="op" id="3453466">{</span><span class="ident" id="3453467">h</span><span class="op" id="3453468">.</span><span class="ident" id="3453469">contentType</span><span class="op" id="3453480">,</span>&nbsp;<span class="ident" id="3453482">h</span><span class="op" id="3453483">.</span><span class="ident" id="3453484">connection</span><span class="op" id="3453494">,</span>&nbsp;<span class="ident" id="3453496">h</span><span class="op" id="3453497">.</span><span class="ident" id="3453498">transferEncoding</span><span class="op" id="3453514">}</span>&nbsp;<span class="op" id="3453516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453520">if</span>&nbsp;<span class="ident" id="3453523">v</span>&nbsp;<span class="op" id="3453525">!=</span>&nbsp;<span class="string" id="3453528">&#34;&#34;</span>&nbsp;<span class="op" id="3453531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453536">w</span><span class="op" id="3453537">.</span><span class="ident" id="3453538">Write</span><span class="op" id="3453543">(</span><span class="ident" id="3453544">extraHeaderKeys</span><span class="op" id="3453559">[</span><span class="ident" id="3453560">i</span><span class="op" id="3453561">]</span><span class="op" id="3453562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453567">w</span><span class="op" id="3453568">.</span><span class="ident" id="3453569">Write</span><span class="op" id="3453574">(</span><span class="ident" id="3453575">colonSpace</span><span class="op" id="3453585">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453590">w</span><span class="op" id="3453591">.</span><span class="ident" id="3453592">WriteString</span><span class="op" id="3453603">(</span><span class="ident" id="3453604">v</span><span class="op" id="3453605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3453610">w</span><span class="op" id="3453611">.</span><span class="ident" id="3453612">Write</span><span class="op" id="3453617">(</span><span class="ident" id="3453618">crlf</span><span class="op" id="3453622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3453626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3453629">}</span><br>
<span class="lineno"></span><span class="op" id="3453631">}</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span><span class="comment" id="3453634">//&nbsp;writeHeader&nbsp;finalizes&nbsp;the&nbsp;header&nbsp;sent&nbsp;to&nbsp;the&nbsp;client&nbsp;and&nbsp;writes&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3453703">//&nbsp;to&nbsp;cw.res.conn.buf.</span><br>
<span class="lineno"></span><span class="comment" id="3453726">//</span><br>
<span class="lineno"></span><span class="comment" id="3453729">//&nbsp;p&nbsp;is&nbsp;not&nbsp;written&nbsp;by&nbsp;writeHeader,&nbsp;but&nbsp;is&nbsp;the&nbsp;first&nbsp;chunk&nbsp;of&nbsp;the&nbsp;body</span><br>
<span class="lineno">710</span><span class="comment" id="3453800">//&nbsp;that&nbsp;will&nbsp;be&nbsp;written.&nbsp;&nbsp;It&nbsp;is&nbsp;sniffed&nbsp;for&nbsp;a&nbsp;Content-Type&nbsp;if&nbsp;none&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3453870">//&nbsp;set&nbsp;explicitly.&nbsp;&nbsp;It&#39;s&nbsp;also&nbsp;used&nbsp;to&nbsp;set&nbsp;the&nbsp;Content-Length,&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3453939">//&nbsp;total&nbsp;body&nbsp;size&nbsp;was&nbsp;small&nbsp;and&nbsp;the&nbsp;handler&nbsp;has&nbsp;already&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="3454005">//&nbsp;running.</span><br>
<span class="lineno"></span><span class="keyword" id="3454017">func</span>&nbsp;<span class="op" id="3454022">(</span><span class="ident" id="3454023">cw</span>&nbsp;<span class="op" id="3454026">*</span><span class="ident" id="3454027">chunkWriter</span><span class="op" id="3454038">)</span>&nbsp;<span class="ident" id="3454040">writeHeader</span><span class="op" id="3454051">(</span><span class="ident" id="3454052">p</span>&nbsp;<span class="op" id="3454054">[</span><span class="op" id="3454055">]</span><span class="builtintype" id="3454056">byte</span><span class="op" id="3454060">)</span>&nbsp;<span class="op" id="3454062">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454065">if</span>&nbsp;<span class="ident" id="3454068">cw</span><span class="op" id="3454070">.</span><span class="ident" id="3454071">wroteHeader</span>&nbsp;<span class="op" id="3454083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454087">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3454095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454098">cw</span><span class="op" id="3454100">.</span><span class="ident" id="3454101">wroteHeader</span>&nbsp;<span class="op" id="3454113">=</span>&nbsp;<span class="builtintype" id="3454115">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454122">w</span>&nbsp;<span class="op" id="3454124">:=</span>&nbsp;<span class="ident" id="3454127">cw</span><span class="op" id="3454129">.</span><span class="ident" id="3454130">res</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454135">keepAlivesEnabled</span>&nbsp;<span class="op" id="3454153">:=</span>&nbsp;<span class="ident" id="3454156">w</span><span class="op" id="3454157">.</span><span class="ident" id="3454158">conn</span><span class="op" id="3454162">.</span><span class="ident" id="3454163">server</span><span class="op" id="3454169">.</span><span class="ident" id="3454170">doKeepAlives</span><span class="op" id="3454182">(</span><span class="op" id="3454183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454186">isHEAD</span>&nbsp;<span class="op" id="3454193">:=</span>&nbsp;<span class="ident" id="3454196">w</span><span class="op" id="3454197">.</span><span class="ident" id="3454198">req</span><span class="op" id="3454201">.</span><span class="ident" id="3454202">Method</span>&nbsp;<span class="op" id="3454209">==</span>&nbsp;<span class="string" id="3454212">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3454221">//&nbsp;header&nbsp;is&nbsp;written&nbsp;out&nbsp;to&nbsp;w.conn.buf&nbsp;below.&nbsp;Depending&nbsp;on&nbsp;the</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3454285">//&nbsp;state&nbsp;of&nbsp;the&nbsp;handler,&nbsp;we&nbsp;either&nbsp;own&nbsp;the&nbsp;map&nbsp;or&nbsp;not.&nbsp;If&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3454347">//&nbsp;don&#39;t&nbsp;own&nbsp;it,&nbsp;the&nbsp;exclude&nbsp;map&nbsp;is&nbsp;created&nbsp;lazily&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3454403">//&nbsp;WriteSubset&nbsp;to&nbsp;remove&nbsp;headers.&nbsp;The&nbsp;setHeader&nbsp;struct&nbsp;holds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3454465">//&nbsp;headers&nbsp;we&nbsp;need&nbsp;to&nbsp;add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454493">header</span>&nbsp;<span class="op" id="3454500">:=</span>&nbsp;<span class="ident" id="3454503">cw</span><span class="op" id="3454505">.</span><span class="ident" id="3454506">header</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454514">owned</span>&nbsp;<span class="op" id="3454520">:=</span>&nbsp;<span class="ident" id="3454523">header</span>&nbsp;<span class="op" id="3454530">!=</span>&nbsp;<span class="ident" id="3454533">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454538">if</span>&nbsp;<span class="op" id="3454541">!</span><span class="ident" id="3454542">owned</span>&nbsp;<span class="op" id="3454548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454552">header</span>&nbsp;<span class="op" id="3454559">=</span>&nbsp;<span class="ident" id="3454561">w</span><span class="op" id="3454562">.</span><span class="ident" id="3454563">handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3454578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454581">var</span>&nbsp;<span class="ident" id="3454585">excludeHeader</span>&nbsp;<span class="keyword" id="3454599">map</span><span class="op" id="3454602">[</span><span class="builtintype" id="3454603">string</span><span class="op" id="3454609">]</span><span class="builtintype" id="3454610">bool</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454616">delHeader</span>&nbsp;<span class="op" id="3454626">:=</span>&nbsp;<span class="keyword" id="3454629">func</span><span class="op" id="3454633">(</span><span class="ident" id="3454634">key</span>&nbsp;<span class="builtintype" id="3454638">string</span><span class="op" id="3454644">)</span>&nbsp;<span class="op" id="3454646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454650">if</span>&nbsp;<span class="ident" id="3454653">owned</span>&nbsp;<span class="op" id="3454659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454664">header</span><span class="op" id="3454670">.</span><span class="ident" id="3454671">Del</span><span class="op" id="3454674">(</span><span class="ident" id="3454675">key</span><span class="op" id="3454678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454683">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3454692">}</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454696">if</span>&nbsp;<span class="ident" id="3454699">_</span><span class="op" id="3454700">,</span>&nbsp;<span class="ident" id="3454702">ok</span>&nbsp;<span class="op" id="3454705">:=</span>&nbsp;<span class="ident" id="3454708">header</span><span class="op" id="3454714">[</span><span class="ident" id="3454715">key</span><span class="op" id="3454718">]</span><span class="op" id="3454719">;</span>&nbsp;<span class="op" id="3454721">!</span><span class="ident" id="3454722">ok</span>&nbsp;<span class="op" id="3454725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454730">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3454739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454743">if</span>&nbsp;<span class="ident" id="3454746">excludeHeader</span>&nbsp;<span class="op" id="3454760">==</span>&nbsp;<span class="ident" id="3454763">nil</span>&nbsp;<span class="op" id="3454767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454772">excludeHeader</span>&nbsp;<span class="op" id="3454786">=</span>&nbsp;<span class="builtinfunc" id="3454788">make</span><span class="op" id="3454792">(</span><span class="keyword" id="3454793">map</span><span class="op" id="3454796">[</span><span class="builtintype" id="3454797">string</span><span class="op" id="3454803">]</span><span class="builtintype" id="3454804">bool</span><span class="op" id="3454808">)</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3454812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454816">excludeHeader</span><span class="op" id="3454829">[</span><span class="ident" id="3454830">key</span><span class="op" id="3454833">]</span>&nbsp;<span class="op" id="3454835">=</span>&nbsp;<span class="builtintype" id="3454837">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3454843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454846">var</span>&nbsp;<span class="ident" id="3454850">setHeader</span>&nbsp;<span class="ident" id="3454860">extraHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3454874">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;is&nbsp;done&nbsp;but&nbsp;never&nbsp;sent&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3454933">//&nbsp;response&nbsp;header&nbsp;and&nbsp;this&nbsp;is&nbsp;our&nbsp;first&nbsp;(and&nbsp;last)&nbsp;write,&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3454997">//&nbsp;it,&nbsp;even&nbsp;to&nbsp;zero.&nbsp;This&nbsp;helps&nbsp;HTTP/1.0&nbsp;clients&nbsp;keep&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455058">//&nbsp;&#34;keep-alive&#34;&nbsp;connections&nbsp;alive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455094">//&nbsp;Exceptions:&nbsp;304/204/1xx&nbsp;responses&nbsp;never&nbsp;get&nbsp;Content-Length,&nbsp;and&nbsp;if</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455165">//&nbsp;it&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;difference&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455229">//&nbsp;0&nbsp;actual&nbsp;bytes&nbsp;and&nbsp;0&nbsp;bytes&nbsp;because&nbsp;the&nbsp;handler&nbsp;noticed&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455291">//&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request&nbsp;and&nbsp;chose&nbsp;not&nbsp;to&nbsp;write&nbsp;anything.&nbsp;&nbsp;So&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455355">//&nbsp;HEAD,&nbsp;the&nbsp;handler&nbsp;should&nbsp;either&nbsp;write&nbsp;the&nbsp;Content-Length&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455419">//&nbsp;write&nbsp;non-zero&nbsp;bytes.&nbsp;&nbsp;If&nbsp;it&#39;s&nbsp;actually&nbsp;0&nbsp;bytes&nbsp;and&nbsp;the</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455479">//&nbsp;handler&nbsp;never&nbsp;looked&nbsp;at&nbsp;the&nbsp;Request.Method,&nbsp;we&nbsp;just&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455541">//&nbsp;send&nbsp;a&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455575">if</span>&nbsp;<span class="ident" id="3455578">w</span><span class="op" id="3455579">.</span><span class="ident" id="3455580">handlerDone</span>&nbsp;<span class="op" id="3455592">&amp;&amp;</span>&nbsp;<span class="ident" id="3455595">bodyAllowedForStatus</span><span class="op" id="3455615">(</span><span class="ident" id="3455616">w</span><span class="op" id="3455617">.</span><span class="ident" id="3455618">status</span><span class="op" id="3455624">)</span>&nbsp;<span class="op" id="3455626">&amp;&amp;</span>&nbsp;<span class="ident" id="3455629">header</span><span class="op" id="3455635">.</span><span class="ident" id="3455636">get</span><span class="op" id="3455639">(</span><span class="string" id="3455640">&#34;Content-Length&#34;</span><span class="op" id="3455656">)</span>&nbsp;<span class="op" id="3455658">==</span>&nbsp;<span class="string" id="3455661">&#34;&#34;</span>&nbsp;<span class="op" id="3455664">&amp;&amp;</span>&nbsp;<span class="op" id="3455667">(</span><span class="op" id="3455668">!</span><span class="ident" id="3455669">isHEAD</span>&nbsp;<span class="op" id="3455676">||</span>&nbsp;<span class="builtinfunc" id="3455679">len</span><span class="op" id="3455682">(</span><span class="ident" id="3455683">p</span><span class="op" id="3455684">)</span>&nbsp;<span class="op" id="3455686">&gt;</span>&nbsp;<span class="num" id="3455688">0</span><span class="op" id="3455689">)</span>&nbsp;<span class="op" id="3455691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455695">w</span><span class="op" id="3455696">.</span><span class="ident" id="3455697">contentLength</span>&nbsp;<span class="op" id="3455711">=</span>&nbsp;<span class="ident" id="3455713">int64</span><span class="op" id="3455718">(</span><span class="builtinfunc" id="3455719">len</span><span class="op" id="3455722">(</span><span class="ident" id="3455723">p</span><span class="op" id="3455724">)</span><span class="op" id="3455725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3455729">setHeader</span><span class="op" id="3455738">.</span><span class="ident" id="3455739">contentLength</span>&nbsp;<span class="op" id="3455753">=</span>&nbsp;<span class="ident" id="3455755">strconv</span><span class="op" id="3455762">.</span><span class="ident" id="3455763">AppendInt</span><span class="op" id="3455772">(</span><span class="ident" id="3455773">cw</span><span class="op" id="3455775">.</span><span class="ident" id="3455776">res</span><span class="op" id="3455779">.</span><span class="ident" id="3455780">clenBuf</span><span class="op" id="3455787">[</span><span class="op" id="3455788">:</span><span class="num" id="3455789">0</span><span class="op" id="3455790">]</span><span class="op" id="3455791">,</span>&nbsp;<span class="ident" id="3455793">int64</span><span class="op" id="3455798">(</span><span class="builtinfunc" id="3455799">len</span><span class="op" id="3455802">(</span><span class="ident" id="3455803">p</span><span class="op" id="3455804">)</span><span class="op" id="3455805">)</span><span class="op" id="3455806">,</span>&nbsp;<span class="num" id="3455808">10</span><span class="op" id="3455810">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3455813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455817">//&nbsp;If&nbsp;this&nbsp;was&nbsp;an&nbsp;HTTP/1.0&nbsp;request&nbsp;with&nbsp;keep-alive&nbsp;and&nbsp;we&nbsp;sent&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455883">//&nbsp;Content-Length&nbsp;back,&nbsp;we&nbsp;can&nbsp;make&nbsp;this&nbsp;a&nbsp;keep-alive&nbsp;response&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3455951">if</span>&nbsp;<span class="ident" id="3455954">w</span><span class="op" id="3455955">.</span><span class="ident" id="3455956">req</span><span class="op" id="3455959">.</span><span class="ident" id="3455960">wantsHttp10KeepAlive</span><span class="op" id="3455980">(</span><span class="op" id="3455981">)</span>&nbsp;<span class="op" id="3455983">&amp;&amp;</span>&nbsp;<span class="ident" id="3455986">keepAlivesEnabled</span>&nbsp;<span class="op" id="3456004">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456008">sentLength</span>&nbsp;<span class="op" id="3456019">:=</span>&nbsp;<span class="ident" id="3456022">header</span><span class="op" id="3456028">.</span><span class="ident" id="3456029">get</span><span class="op" id="3456032">(</span><span class="string" id="3456033">&#34;Content-Length&#34;</span><span class="op" id="3456049">)</span>&nbsp;<span class="op" id="3456051">!=</span>&nbsp;<span class="string" id="3456054">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456059">if</span>&nbsp;<span class="ident" id="3456062">sentLength</span>&nbsp;<span class="op" id="3456073">&amp;&amp;</span>&nbsp;<span class="ident" id="3456076">header</span><span class="op" id="3456082">.</span><span class="ident" id="3456083">get</span><span class="op" id="3456086">(</span><span class="string" id="3456087">&#34;Connection&#34;</span><span class="op" id="3456099">)</span>&nbsp;<span class="op" id="3456101">==</span>&nbsp;<span class="string" id="3456104">&#34;keep-alive&#34;</span>&nbsp;<span class="op" id="3456117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456122">w</span><span class="op" id="3456123">.</span><span class="ident" id="3456124">closeAfterReply</span>&nbsp;<span class="op" id="3456140">=</span>&nbsp;<span class="builtintype" id="3456142">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456153">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3456157">//&nbsp;Check&nbsp;for&nbsp;a&nbsp;explicit&nbsp;(and&nbsp;valid)&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456217">hasCL</span>&nbsp;<span class="op" id="3456223">:=</span>&nbsp;<span class="ident" id="3456226">w</span><span class="op" id="3456227">.</span><span class="ident" id="3456228">contentLength</span>&nbsp;<span class="op" id="3456242">!=</span>&nbsp;<span class="op" id="3456245">-</span><span class="num" id="3456246">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456250">if</span>&nbsp;<span class="ident" id="3456253">w</span><span class="op" id="3456254">.</span><span class="ident" id="3456255">req</span><span class="op" id="3456258">.</span><span class="ident" id="3456259">wantsHttp10KeepAlive</span><span class="op" id="3456279">(</span><span class="op" id="3456280">)</span>&nbsp;<span class="op" id="3456282">&amp;&amp;</span>&nbsp;<span class="op" id="3456285">(</span><span class="ident" id="3456286">isHEAD</span>&nbsp;<span class="op" id="3456293">||</span>&nbsp;<span class="ident" id="3456296">hasCL</span><span class="op" id="3456301">)</span>&nbsp;<span class="op" id="3456303">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456307">_</span><span class="op" id="3456308">,</span>&nbsp;<span class="ident" id="3456310">connectionHeaderSet</span>&nbsp;<span class="op" id="3456330">:=</span>&nbsp;<span class="ident" id="3456333">header</span><span class="op" id="3456339">[</span><span class="string" id="3456340">&#34;Connection&#34;</span><span class="op" id="3456352">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456356">if</span>&nbsp;<span class="op" id="3456359">!</span><span class="ident" id="3456360">connectionHeaderSet</span>&nbsp;<span class="op" id="3456380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456385">setHeader</span><span class="op" id="3456394">.</span><span class="ident" id="3456395">connection</span>&nbsp;<span class="op" id="3456406">=</span>&nbsp;<span class="string" id="3456408">&#34;keep-alive&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456426">}</span>&nbsp;<span class="keyword" id="3456428">else</span>&nbsp;<span class="keyword" id="3456433">if</span>&nbsp;<span class="op" id="3456436">!</span><span class="ident" id="3456437">w</span><span class="op" id="3456438">.</span><span class="ident" id="3456439">req</span><span class="op" id="3456442">.</span><span class="ident" id="3456443">ProtoAtLeast</span><span class="op" id="3456455">(</span><span class="num" id="3456456">1</span><span class="op" id="3456457">,</span>&nbsp;<span class="num" id="3456459">1</span><span class="op" id="3456460">)</span>&nbsp;<span class="op" id="3456462">||</span>&nbsp;<span class="ident" id="3456465">w</span><span class="op" id="3456466">.</span><span class="ident" id="3456467">req</span><span class="op" id="3456470">.</span><span class="ident" id="3456471">wantsClose</span><span class="op" id="3456481">(</span><span class="op" id="3456482">)</span>&nbsp;<span class="op" id="3456484">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456488">w</span><span class="op" id="3456489">.</span><span class="ident" id="3456490">closeAfterReply</span>&nbsp;<span class="op" id="3456506">=</span>&nbsp;<span class="builtintype" id="3456508">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456518">if</span>&nbsp;<span class="ident" id="3456521">header</span><span class="op" id="3456527">.</span><span class="ident" id="3456528">get</span><span class="op" id="3456531">(</span><span class="string" id="3456532">&#34;Connection&#34;</span><span class="op" id="3456544">)</span>&nbsp;<span class="op" id="3456546">==</span>&nbsp;<span class="string" id="3456549">&#34;close&#34;</span>&nbsp;<span class="op" id="3456557">||</span>&nbsp;<span class="op" id="3456560">!</span><span class="ident" id="3456561">keepAlivesEnabled</span>&nbsp;<span class="op" id="3456579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456583">w</span><span class="op" id="3456584">.</span><span class="ident" id="3456585">closeAfterReply</span>&nbsp;<span class="op" id="3456601">=</span>&nbsp;<span class="builtintype" id="3456603">true</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3456613">//&nbsp;Per&nbsp;RFC&nbsp;2616,&nbsp;we&nbsp;should&nbsp;consume&nbsp;the&nbsp;request&nbsp;body&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3456673">//&nbsp;replying,&nbsp;if&nbsp;the&nbsp;handler&nbsp;hasn&#39;t&nbsp;already&nbsp;done&nbsp;so.&nbsp;&nbsp;But&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3456734">//&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;do&nbsp;an&nbsp;unbounded&nbsp;amount&nbsp;of&nbsp;reading&nbsp;here&nbsp;for</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3456795">//&nbsp;DoS&nbsp;reasons,&nbsp;so&nbsp;we&nbsp;only&nbsp;try&nbsp;up&nbsp;to&nbsp;a&nbsp;threshold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456846">if</span>&nbsp;<span class="ident" id="3456849">w</span><span class="op" id="3456850">.</span><span class="ident" id="3456851">req</span><span class="op" id="3456854">.</span><span class="ident" id="3456855">ContentLength</span>&nbsp;<span class="op" id="3456869">!=</span>&nbsp;<span class="num" id="3456872">0</span>&nbsp;<span class="op" id="3456874">&amp;&amp;</span>&nbsp;<span class="op" id="3456877">!</span><span class="ident" id="3456878">w</span><span class="op" id="3456879">.</span><span class="ident" id="3456880">closeAfterReply</span>&nbsp;<span class="op" id="3456896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456900">ecr</span><span class="op" id="3456903">,</span>&nbsp;<span class="ident" id="3456905">isExpecter</span>&nbsp;<span class="op" id="3456916">:=</span>&nbsp;<span class="ident" id="3456919">w</span><span class="op" id="3456920">.</span><span class="ident" id="3456921">req</span><span class="op" id="3456924">.</span><span class="ident" id="3456925">Body</span><span class="op" id="3456929">.</span><span class="op" id="3456930">(</span><span class="op" id="3456931">*</span><span class="ident" id="3456932">expectContinueReader</span><span class="op" id="3456952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456956">if</span>&nbsp;<span class="op" id="3456959">!</span><span class="ident" id="3456960">isExpecter</span>&nbsp;<span class="op" id="3456971">||</span>&nbsp;<span class="ident" id="3456974">ecr</span><span class="op" id="3456977">.</span><span class="ident" id="3456978">resp</span><span class="op" id="3456982">.</span><span class="ident" id="3456983">wroteContinue</span>&nbsp;<span class="op" id="3456997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457002">n</span><span class="op" id="3457003">,</span>&nbsp;<span class="ident" id="3457005">_</span>&nbsp;<span class="op" id="3457007">:=</span>&nbsp;<span class="ident" id="3457010">io</span><span class="op" id="3457012">.</span><span class="ident" id="3457013">CopyN</span><span class="op" id="3457018">(</span><span class="ident" id="3457019">ioutil</span><span class="op" id="3457025">.</span><span class="ident" id="3457026">Discard</span><span class="op" id="3457033">,</span>&nbsp;<span class="ident" id="3457035">w</span><span class="op" id="3457036">.</span><span class="ident" id="3457037">req</span><span class="op" id="3457040">.</span><span class="ident" id="3457041">Body</span><span class="op" id="3457045">,</span>&nbsp;<span class="ident" id="3457047">maxPostHandlerReadBytes</span><span class="op" id="3457070">+</span><span class="num" id="3457071">1</span><span class="op" id="3457072">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457077">if</span>&nbsp;<span class="ident" id="3457080">n</span>&nbsp;<span class="op" id="3457082">&gt;=</span>&nbsp;<span class="ident" id="3457085">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="3457109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457115">w</span><span class="op" id="3457116">.</span><span class="ident" id="3457117">requestTooLarge</span><span class="op" id="3457132">(</span><span class="op" id="3457133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457139">delHeader</span><span class="op" id="3457148">(</span><span class="string" id="3457149">&#34;Connection&#34;</span><span class="op" id="3457161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457167">setHeader</span><span class="op" id="3457176">.</span><span class="ident" id="3457177">connection</span>&nbsp;<span class="op" id="3457188">=</span>&nbsp;<span class="string" id="3457190">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457201">}</span>&nbsp;<span class="keyword" id="3457203">else</span>&nbsp;<span class="op" id="3457208">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457214">w</span><span class="op" id="3457215">.</span><span class="ident" id="3457216">req</span><span class="op" id="3457219">.</span><span class="ident" id="3457220">Body</span><span class="op" id="3457224">.</span><span class="ident" id="3457225">Close</span><span class="op" id="3457230">(</span><span class="op" id="3457231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457236">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457247">code</span>&nbsp;<span class="op" id="3457252">:=</span>&nbsp;<span class="ident" id="3457255">w</span><span class="op" id="3457256">.</span><span class="ident" id="3457257">status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457265">if</span>&nbsp;<span class="ident" id="3457268">bodyAllowedForStatus</span><span class="op" id="3457288">(</span><span class="ident" id="3457289">code</span><span class="op" id="3457293">)</span>&nbsp;<span class="op" id="3457295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3457299">//&nbsp;If&nbsp;no&nbsp;content&nbsp;type,&nbsp;apply&nbsp;sniffing&nbsp;algorithm&nbsp;to&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457358">_</span><span class="op" id="3457359">,</span>&nbsp;<span class="ident" id="3457361">haveType</span>&nbsp;<span class="op" id="3457370">:=</span>&nbsp;<span class="ident" id="3457373">header</span><span class="op" id="3457379">[</span><span class="string" id="3457380">&#34;Content-Type&#34;</span><span class="op" id="3457394">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457398">if</span>&nbsp;<span class="op" id="3457401">!</span><span class="ident" id="3457402">haveType</span>&nbsp;<span class="op" id="3457411">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457416">setHeader</span><span class="op" id="3457425">.</span><span class="ident" id="3457426">contentType</span>&nbsp;<span class="op" id="3457438">=</span>&nbsp;<span class="ident" id="3457440">DetectContentType</span><span class="op" id="3457457">(</span><span class="ident" id="3457458">p</span><span class="op" id="3457459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457466">}</span>&nbsp;<span class="keyword" id="3457468">else</span>&nbsp;<span class="op" id="3457473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457477">for</span>&nbsp;<span class="ident" id="3457481">_</span><span class="op" id="3457482">,</span>&nbsp;<span class="ident" id="3457484">k</span>&nbsp;<span class="op" id="3457486">:=</span>&nbsp;<span class="keyword" id="3457489">range</span>&nbsp;<span class="ident" id="3457495">suppressedHeaders</span><span class="op" id="3457512">(</span><span class="ident" id="3457513">code</span><span class="op" id="3457517">)</span>&nbsp;<span class="op" id="3457519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457524">delHeader</span><span class="op" id="3457533">(</span><span class="ident" id="3457534">k</span><span class="op" id="3457535">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457542">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457546">if</span>&nbsp;<span class="ident" id="3457549">_</span><span class="op" id="3457550">,</span>&nbsp;<span class="ident" id="3457552">ok</span>&nbsp;<span class="op" id="3457555">:=</span>&nbsp;<span class="ident" id="3457558">header</span><span class="op" id="3457564">[</span><span class="string" id="3457565">&#34;Date&#34;</span><span class="op" id="3457571">]</span><span class="op" id="3457572">;</span>&nbsp;<span class="op" id="3457574">!</span><span class="ident" id="3457575">ok</span>&nbsp;<span class="op" id="3457578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457582">setHeader</span><span class="op" id="3457591">.</span><span class="ident" id="3457592">date</span>&nbsp;<span class="op" id="3457597">=</span>&nbsp;<span class="ident" id="3457599">appendTime</span><span class="op" id="3457609">(</span><span class="ident" id="3457610">cw</span><span class="op" id="3457612">.</span><span class="ident" id="3457613">res</span><span class="op" id="3457616">.</span><span class="ident" id="3457617">dateBuf</span><span class="op" id="3457624">[</span><span class="op" id="3457625">:</span><span class="num" id="3457626">0</span><span class="op" id="3457627">]</span><span class="op" id="3457628">,</span>&nbsp;<span class="ident" id="3457630">time</span><span class="op" id="3457634">.</span><span class="ident" id="3457635">Now</span><span class="op" id="3457638">(</span><span class="op" id="3457639">)</span><span class="op" id="3457640">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457647">te</span>&nbsp;<span class="op" id="3457650">:=</span>&nbsp;<span class="ident" id="3457653">header</span><span class="op" id="3457659">.</span><span class="ident" id="3457660">get</span><span class="op" id="3457663">(</span><span class="string" id="3457664">&#34;Transfer-Encoding&#34;</span><span class="op" id="3457683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457686">hasTE</span>&nbsp;<span class="op" id="3457692">:=</span>&nbsp;<span class="ident" id="3457695">te</span>&nbsp;<span class="op" id="3457698">!=</span>&nbsp;<span class="string" id="3457701">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457705">if</span>&nbsp;<span class="ident" id="3457708">hasCL</span>&nbsp;<span class="op" id="3457714">&amp;&amp;</span>&nbsp;<span class="ident" id="3457717">hasTE</span>&nbsp;<span class="op" id="3457723">&amp;&amp;</span>&nbsp;<span class="ident" id="3457726">te</span>&nbsp;<span class="op" id="3457729">!=</span>&nbsp;<span class="string" id="3457732">&#34;identity&#34;</span>&nbsp;<span class="op" id="3457743">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3457747">//&nbsp;TODO:&nbsp;return&nbsp;an&nbsp;error&nbsp;if&nbsp;WriteHeader&nbsp;gets&nbsp;a&nbsp;return&nbsp;parameter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3457813">//&nbsp;For&nbsp;now&nbsp;just&nbsp;ignore&nbsp;the&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457858">w</span><span class="op" id="3457859">.</span><span class="ident" id="3457860">conn</span><span class="op" id="3457864">.</span><span class="ident" id="3457865">server</span><span class="op" id="3457871">.</span><span class="ident" id="3457872">logf</span><span class="op" id="3457876">(</span><span class="string" id="3457877">&#34;http:&nbsp;WriteHeader&nbsp;called&nbsp;with&nbsp;both&nbsp;Transfer-Encoding&nbsp;of&nbsp;%q&nbsp;and&nbsp;a&nbsp;Content-Length&nbsp;of&nbsp;%d&#34;</span><span class="op" id="3457964">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457969">te</span><span class="op" id="3457971">,</span>&nbsp;<span class="ident" id="3457973">w</span><span class="op" id="3457974">.</span><span class="ident" id="3457975">contentLength</span><span class="op" id="3457988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457992">delHeader</span><span class="op" id="3458001">(</span><span class="string" id="3458002">&#34;Content-Length&#34;</span><span class="op" id="3458018">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458022">hasCL</span>&nbsp;<span class="op" id="3458028">=</span>&nbsp;<span class="builtintype" id="3458030">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458041">if</span>&nbsp;<span class="ident" id="3458044">w</span><span class="op" id="3458045">.</span><span class="ident" id="3458046">req</span><span class="op" id="3458049">.</span><span class="ident" id="3458050">Method</span>&nbsp;<span class="op" id="3458057">==</span>&nbsp;<span class="string" id="3458060">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3458067">||</span>&nbsp;<span class="op" id="3458070">!</span><span class="ident" id="3458071">bodyAllowedForStatus</span><span class="op" id="3458091">(</span><span class="ident" id="3458092">code</span><span class="op" id="3458096">)</span>&nbsp;<span class="op" id="3458098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3458102">//&nbsp;do&nbsp;nothing</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458117">}</span>&nbsp;<span class="keyword" id="3458119">else</span>&nbsp;<span class="keyword" id="3458124">if</span>&nbsp;<span class="ident" id="3458127">code</span>&nbsp;<span class="op" id="3458132">==</span>&nbsp;<span class="ident" id="3458135">StatusNoContent</span>&nbsp;<span class="op" id="3458151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458155">delHeader</span><span class="op" id="3458164">(</span><span class="string" id="3458165">&#34;Transfer-Encoding&#34;</span><span class="op" id="3458184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458187">}</span>&nbsp;<span class="keyword" id="3458189">else</span>&nbsp;<span class="keyword" id="3458194">if</span>&nbsp;<span class="ident" id="3458197">hasCL</span>&nbsp;<span class="op" id="3458203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458207">delHeader</span><span class="op" id="3458216">(</span><span class="string" id="3458217">&#34;Transfer-Encoding&#34;</span><span class="op" id="3458236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458239">}</span>&nbsp;<span class="keyword" id="3458241">else</span>&nbsp;<span class="keyword" id="3458246">if</span>&nbsp;<span class="ident" id="3458249">w</span><span class="op" id="3458250">.</span><span class="ident" id="3458251">req</span><span class="op" id="3458254">.</span><span class="ident" id="3458255">ProtoAtLeast</span><span class="op" id="3458267">(</span><span class="num" id="3458268">1</span><span class="op" id="3458269">,</span>&nbsp;<span class="num" id="3458271">1</span><span class="op" id="3458272">)</span>&nbsp;<span class="op" id="3458274">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3458278">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;Transfer-Encoding&nbsp;has&nbsp;been&nbsp;set&nbsp;to&nbsp;identity,&nbsp;&nbsp;and&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3458356">//&nbsp;content-length&nbsp;has&nbsp;been&nbsp;provided.&nbsp;The&nbsp;connection&nbsp;must&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3458435">//&nbsp;reply&nbsp;is&nbsp;written,&nbsp;and&nbsp;no&nbsp;chunking&nbsp;is&nbsp;to&nbsp;be&nbsp;done.&nbsp;This&nbsp;is&nbsp;the&nbsp;setup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3458507">//&nbsp;recommended&nbsp;in&nbsp;the&nbsp;Server-Sent&nbsp;Events&nbsp;candidate&nbsp;recommendation&nbsp;11,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3458579">//&nbsp;section&nbsp;8.</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458595">if</span>&nbsp;<span class="ident" id="3458598">hasTE</span>&nbsp;<span class="op" id="3458604">&amp;&amp;</span>&nbsp;<span class="ident" id="3458607">te</span>&nbsp;<span class="op" id="3458610">==</span>&nbsp;<span class="string" id="3458613">&#34;identity&#34;</span>&nbsp;<span class="op" id="3458624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458629">cw</span><span class="op" id="3458631">.</span><span class="ident" id="3458632">chunking</span>&nbsp;<span class="op" id="3458641">=</span>&nbsp;<span class="builtintype" id="3458643">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458652">w</span><span class="op" id="3458653">.</span><span class="ident" id="3458654">closeAfterReply</span>&nbsp;<span class="op" id="3458670">=</span>&nbsp;<span class="builtintype" id="3458672">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458679">}</span>&nbsp;<span class="keyword" id="3458681">else</span>&nbsp;<span class="op" id="3458686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3458691">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;use&nbsp;chunked&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3458748">//&nbsp;to&nbsp;avoid&nbsp;closing&nbsp;the&nbsp;connection&nbsp;at&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458794">cw</span><span class="op" id="3458796">.</span><span class="ident" id="3458797">chunking</span>&nbsp;<span class="op" id="3458806">=</span>&nbsp;<span class="builtintype" id="3458808">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458816">setHeader</span><span class="op" id="3458825">.</span><span class="ident" id="3458826">transferEncoding</span>&nbsp;<span class="op" id="3458843">=</span>&nbsp;<span class="string" id="3458845">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458860">}</span>&nbsp;<span class="keyword" id="3458862">else</span>&nbsp;<span class="op" id="3458867">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3458871">//&nbsp;HTTP&nbsp;version&nbsp;&lt;&nbsp;1.1:&nbsp;cannot&nbsp;do&nbsp;chunked&nbsp;transfer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3458923">//&nbsp;encoding&nbsp;and&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;Content-Length&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3458977">//&nbsp;signal&nbsp;EOF&nbsp;by&nbsp;closing&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459016">w</span><span class="op" id="3459017">.</span><span class="ident" id="3459018">closeAfterReply</span>&nbsp;<span class="op" id="3459034">=</span>&nbsp;<span class="builtintype" id="3459036">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459043">delHeader</span><span class="op" id="3459052">(</span><span class="string" id="3459053">&#34;Transfer-Encoding&#34;</span><span class="op" id="3459072">)</span>&nbsp;<span class="comment" id="3459074">//&nbsp;in&nbsp;case&nbsp;already&nbsp;set</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3459102">//&nbsp;Cannot&nbsp;use&nbsp;Content-Length&nbsp;with&nbsp;non-identity&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459169">if</span>&nbsp;<span class="ident" id="3459172">cw</span><span class="op" id="3459174">.</span><span class="ident" id="3459175">chunking</span>&nbsp;<span class="op" id="3459184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459188">delHeader</span><span class="op" id="3459197">(</span><span class="string" id="3459198">&#34;Content-Length&#34;</span><span class="op" id="3459214">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459220">if</span>&nbsp;<span class="op" id="3459223">!</span><span class="ident" id="3459224">w</span><span class="op" id="3459225">.</span><span class="ident" id="3459226">req</span><span class="op" id="3459229">.</span><span class="ident" id="3459230">ProtoAtLeast</span><span class="op" id="3459242">(</span><span class="num" id="3459243">1</span><span class="op" id="3459244">,</span>&nbsp;<span class="num" id="3459246">0</span><span class="op" id="3459247">)</span>&nbsp;<span class="op" id="3459249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459253">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459265">if</span>&nbsp;<span class="ident" id="3459268">w</span><span class="op" id="3459269">.</span><span class="ident" id="3459270">closeAfterReply</span>&nbsp;<span class="op" id="3459286">&amp;&amp;</span>&nbsp;<span class="op" id="3459289">(</span><span class="op" id="3459290">!</span><span class="ident" id="3459291">keepAlivesEnabled</span>&nbsp;<span class="op" id="3459309">||</span>&nbsp;<span class="op" id="3459312">!</span><span class="ident" id="3459313">hasToken</span><span class="op" id="3459321">(</span><span class="ident" id="3459322">cw</span><span class="op" id="3459324">.</span><span class="ident" id="3459325">header</span><span class="op" id="3459331">.</span><span class="ident" id="3459332">get</span><span class="op" id="3459335">(</span><span class="string" id="3459336">&#34;Connection&#34;</span><span class="op" id="3459348">)</span><span class="op" id="3459349">,</span>&nbsp;<span class="string" id="3459351">&#34;close&#34;</span><span class="op" id="3459358">)</span><span class="op" id="3459359">)</span>&nbsp;<span class="op" id="3459361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459365">delHeader</span><span class="op" id="3459374">(</span><span class="string" id="3459375">&#34;Connection&#34;</span><span class="op" id="3459387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459391">if</span>&nbsp;<span class="ident" id="3459394">w</span><span class="op" id="3459395">.</span><span class="ident" id="3459396">req</span><span class="op" id="3459399">.</span><span class="ident" id="3459400">ProtoAtLeast</span><span class="op" id="3459412">(</span><span class="num" id="3459413">1</span><span class="op" id="3459414">,</span>&nbsp;<span class="num" id="3459416">1</span><span class="op" id="3459417">)</span>&nbsp;<span class="op" id="3459419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459424">setHeader</span><span class="op" id="3459433">.</span><span class="ident" id="3459434">connection</span>&nbsp;<span class="op" id="3459445">=</span>&nbsp;<span class="string" id="3459447">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459457">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459464">w</span><span class="op" id="3459465">.</span><span class="ident" id="3459466">conn</span><span class="op" id="3459470">.</span><span class="ident" id="3459471">buf</span><span class="op" id="3459474">.</span><span class="ident" id="3459475">WriteString</span><span class="op" id="3459486">(</span><span class="ident" id="3459487">statusLine</span><span class="op" id="3459497">(</span><span class="ident" id="3459498">w</span><span class="op" id="3459499">.</span><span class="ident" id="3459500">req</span><span class="op" id="3459503">,</span>&nbsp;<span class="ident" id="3459505">code</span><span class="op" id="3459509">)</span><span class="op" id="3459510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459513">cw</span><span class="op" id="3459515">.</span><span class="ident" id="3459516">header</span><span class="op" id="3459522">.</span><span class="ident" id="3459523">WriteSubset</span><span class="op" id="3459534">(</span><span class="ident" id="3459535">w</span><span class="op" id="3459536">.</span><span class="ident" id="3459537">conn</span><span class="op" id="3459541">.</span><span class="ident" id="3459542">buf</span><span class="op" id="3459545">,</span>&nbsp;<span class="ident" id="3459547">excludeHeader</span><span class="op" id="3459560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459563">setHeader</span><span class="op" id="3459572">.</span><span class="ident" id="3459573">Write</span><span class="op" id="3459578">(</span><span class="ident" id="3459579">w</span><span class="op" id="3459580">.</span><span class="ident" id="3459581">conn</span><span class="op" id="3459585">.</span><span class="ident" id="3459586">buf</span><span class="op" id="3459589">.</span><span class="ident" id="3459590">Writer</span><span class="op" id="3459596">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459599">w</span><span class="op" id="3459600">.</span><span class="ident" id="3459601">conn</span><span class="op" id="3459605">.</span><span class="ident" id="3459606">buf</span><span class="op" id="3459609">.</span><span class="ident" id="3459610">Write</span><span class="op" id="3459615">(</span><span class="ident" id="3459616">crlf</span><span class="op" id="3459620">)</span><br>
<span class="lineno"></span><span class="op" id="3459622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3459625">//&nbsp;statusLines&nbsp;is&nbsp;a&nbsp;cache&nbsp;of&nbsp;Status-Line&nbsp;strings,&nbsp;keyed&nbsp;by&nbsp;code&nbsp;(for</span><br>
<span class="lineno"></span><span class="comment" id="3459694">//&nbsp;HTTP/1.1)&nbsp;or&nbsp;negative&nbsp;code&nbsp;(for&nbsp;HTTP/1.0).&nbsp;This&nbsp;is&nbsp;faster&nbsp;than&nbsp;a</span><br>
<span class="lineno">890</span><span class="comment" id="3459762">//&nbsp;map&nbsp;keyed&nbsp;by&nbsp;struct&nbsp;of&nbsp;two&nbsp;fields.&nbsp;This&nbsp;map&#39;s&nbsp;max&nbsp;size&nbsp;is&nbsp;bounded</span><br>
<span class="lineno"></span><span class="comment" id="3459831">//&nbsp;by&nbsp;2*len(statusText),&nbsp;two&nbsp;protocol&nbsp;types&nbsp;for&nbsp;each&nbsp;known&nbsp;official</span><br>
<span class="lineno"></span><span class="comment" id="3459899">//&nbsp;status&nbsp;code&nbsp;in&nbsp;the&nbsp;statusText&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="3459937">var</span>&nbsp;<span class="op" id="3459941">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459944">statusMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3459956">sync</span><span class="op" id="3459960">.</span><span class="ident" id="3459961">RWMutex</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459970">statusLines</span>&nbsp;<span class="op" id="3459982">=</span>&nbsp;<span class="builtinfunc" id="3459984">make</span><span class="op" id="3459988">(</span><span class="keyword" id="3459989">map</span><span class="op" id="3459992">[</span><span class="builtintype" id="3459993">int</span><span class="op" id="3459996">]</span><span class="builtintype" id="3459997">string</span><span class="op" id="3460003">)</span><br>
<span class="lineno"></span><span class="op" id="3460005">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3460008">//&nbsp;statusLine&nbsp;returns&nbsp;a&nbsp;response&nbsp;Status-Line&nbsp;(RFC&nbsp;2616&nbsp;Section&nbsp;6.1)</span><br>
<span class="lineno"></span><span class="comment" id="3460076">//&nbsp;for&nbsp;the&nbsp;given&nbsp;request&nbsp;and&nbsp;response&nbsp;status&nbsp;code.</span><br>
<span class="lineno">900</span><span class="keyword" id="3460127">func</span>&nbsp;<span class="ident" id="3460132">statusLine</span><span class="op" id="3460142">(</span><span class="ident" id="3460143">req</span>&nbsp;<span class="op" id="3460147">*</span><span class="ident" id="3460148">Request</span><span class="op" id="3460155">,</span>&nbsp;<span class="ident" id="3460157">code</span>&nbsp;<span class="builtintype" id="3460162">int</span><span class="op" id="3460165">)</span>&nbsp;<span class="builtintype" id="3460167">string</span>&nbsp;<span class="op" id="3460174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3460177">//&nbsp;Fast&nbsp;path:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460192">key</span>&nbsp;<span class="op" id="3460196">:=</span>&nbsp;<span class="ident" id="3460199">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460205">proto11</span>&nbsp;<span class="op" id="3460213">:=</span>&nbsp;<span class="ident" id="3460216">req</span><span class="op" id="3460219">.</span><span class="ident" id="3460220">ProtoAtLeast</span><span class="op" id="3460232">(</span><span class="num" id="3460233">1</span><span class="op" id="3460234">,</span>&nbsp;<span class="num" id="3460236">1</span><span class="op" id="3460237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460240">if</span>&nbsp;<span class="op" id="3460243">!</span><span class="ident" id="3460244">proto11</span>&nbsp;<span class="op" id="3460252">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460256">key</span>&nbsp;<span class="op" id="3460260">=</span>&nbsp;<span class="op" id="3460262">-</span><span class="ident" id="3460263">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460271">statusMu</span><span class="op" id="3460279">.</span><span class="ident" id="3460280">RLock</span><span class="op" id="3460285">(</span><span class="op" id="3460286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460289">line</span><span class="op" id="3460293">,</span>&nbsp;<span class="ident" id="3460295">ok</span>&nbsp;<span class="op" id="3460298">:=</span>&nbsp;<span class="ident" id="3460301">statusLines</span><span class="op" id="3460312">[</span><span class="ident" id="3460313">key</span><span class="op" id="3460316">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460319">statusMu</span><span class="op" id="3460327">.</span><span class="ident" id="3460328">RUnlock</span><span class="op" id="3460335">(</span><span class="op" id="3460336">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460339">if</span>&nbsp;<span class="ident" id="3460342">ok</span>&nbsp;<span class="op" id="3460345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460349">return</span>&nbsp;<span class="ident" id="3460356">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460362">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3460366">//&nbsp;Slow&nbsp;path:</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460381">proto</span>&nbsp;<span class="op" id="3460387">:=</span>&nbsp;<span class="string" id="3460390">&#34;HTTP/1.0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460402">if</span>&nbsp;<span class="ident" id="3460405">proto11</span>&nbsp;<span class="op" id="3460413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460417">proto</span>&nbsp;<span class="op" id="3460423">=</span>&nbsp;<span class="string" id="3460425">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460440">codestring</span>&nbsp;<span class="op" id="3460451">:=</span>&nbsp;<span class="ident" id="3460454">strconv</span><span class="op" id="3460461">.</span><span class="ident" id="3460462">Itoa</span><span class="op" id="3460466">(</span><span class="ident" id="3460467">code</span><span class="op" id="3460471">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460474">text</span><span class="op" id="3460478">,</span>&nbsp;<span class="ident" id="3460480">ok</span>&nbsp;<span class="op" id="3460483">:=</span>&nbsp;<span class="ident" id="3460486">statusText</span><span class="op" id="3460496">[</span><span class="ident" id="3460497">code</span><span class="op" id="3460501">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460504">if</span>&nbsp;<span class="op" id="3460507">!</span><span class="ident" id="3460508">ok</span>&nbsp;<span class="op" id="3460511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460515">text</span>&nbsp;<span class="op" id="3460520">=</span>&nbsp;<span class="string" id="3460522">&#34;status&nbsp;code&nbsp;&#34;</span>&nbsp;<span class="op" id="3460537">+</span>&nbsp;<span class="ident" id="3460539">codestring</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460554">line</span>&nbsp;<span class="op" id="3460559">=</span>&nbsp;<span class="ident" id="3460561">proto</span>&nbsp;<span class="op" id="3460567">+</span>&nbsp;<span class="string" id="3460569">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="3460573">+</span>&nbsp;<span class="ident" id="3460575">codestring</span>&nbsp;<span class="op" id="3460586">+</span>&nbsp;<span class="string" id="3460588">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="3460592">+</span>&nbsp;<span class="ident" id="3460594">text</span>&nbsp;<span class="op" id="3460599">+</span>&nbsp;<span class="string" id="3460601">&#34;\r\n&#34;</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460609">if</span>&nbsp;<span class="ident" id="3460612">ok</span>&nbsp;<span class="op" id="3460615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460619">statusMu</span><span class="op" id="3460627">.</span><span class="ident" id="3460628">Lock</span><span class="op" id="3460632">(</span><span class="op" id="3460633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460637">defer</span>&nbsp;<span class="ident" id="3460643">statusMu</span><span class="op" id="3460651">.</span><span class="ident" id="3460652">Unlock</span><span class="op" id="3460658">(</span><span class="op" id="3460659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3460663">statusLines</span><span class="op" id="3460674">[</span><span class="ident" id="3460675">key</span><span class="op" id="3460678">]</span>&nbsp;<span class="op" id="3460680">=</span>&nbsp;<span class="ident" id="3460682">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460688">}</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460691">return</span>&nbsp;<span class="ident" id="3460698">line</span><br>
<span class="lineno"></span><span class="op" id="3460703">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3460706">//&nbsp;bodyAllowed&nbsp;returns&nbsp;true&nbsp;if&nbsp;a&nbsp;Write&nbsp;is&nbsp;allowed&nbsp;for&nbsp;this&nbsp;response&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="3460780">//&nbsp;It&#39;s&nbsp;illegal&nbsp;to&nbsp;call&nbsp;this&nbsp;before&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;flushed.</span><br>
<span class="lineno">935</span><span class="keyword" id="3460845">func</span>&nbsp;<span class="op" id="3460850">(</span><span class="ident" id="3460851">w</span>&nbsp;<span class="op" id="3460853">*</span><span class="ident" id="3460854">response</span><span class="op" id="3460862">)</span>&nbsp;<span class="ident" id="3460864">bodyAllowed</span><span class="op" id="3460875">(</span><span class="op" id="3460876">)</span>&nbsp;<span class="builtintype" id="3460878">bool</span>&nbsp;<span class="op" id="3460883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460886">if</span>&nbsp;<span class="op" id="3460889">!</span><span class="ident" id="3460890">w</span><span class="op" id="3460891">.</span><span class="ident" id="3460892">wroteHeader</span>&nbsp;<span class="op" id="3460904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3460908">panic</span><span class="op" id="3460913">(</span><span class="string" id="3460914">&#34;&#34;</span><span class="op" id="3460916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460922">return</span>&nbsp;<span class="ident" id="3460929">bodyAllowedForStatus</span><span class="op" id="3460949">(</span><span class="ident" id="3460950">w</span><span class="op" id="3460951">.</span><span class="ident" id="3460952">status</span><span class="op" id="3460958">)</span><br>
<span class="lineno">940</span><span class="op" id="3460960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3460963">//&nbsp;The&nbsp;Life&nbsp;Of&nbsp;A&nbsp;Write&nbsp;is&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span><span class="comment" id="3461000">//</span><br>
<span class="lineno"></span><span class="comment" id="3461003">//&nbsp;Handler&nbsp;starts.&nbsp;No&nbsp;header&nbsp;has&nbsp;been&nbsp;sent.&nbsp;The&nbsp;handler&nbsp;can&nbsp;either</span><br>
<span class="lineno">945</span><span class="comment" id="3461070">//&nbsp;write&nbsp;a&nbsp;header,&nbsp;or&nbsp;just&nbsp;start&nbsp;writing.&nbsp;&nbsp;Writing&nbsp;before&nbsp;sending&nbsp;a&nbsp;header</span><br>
<span class="lineno"></span><span class="comment" id="3461145">//&nbsp;sends&nbsp;an&nbsp;implicitly&nbsp;empty&nbsp;200&nbsp;OK&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="3461189">//</span><br>
<span class="lineno"></span><span class="comment" id="3461192">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;declare&nbsp;a&nbsp;Content-Length&nbsp;up&nbsp;front,&nbsp;we&nbsp;either</span><br>
<span class="lineno"></span><span class="comment" id="3461262">//&nbsp;go&nbsp;into&nbsp;chunking&nbsp;mode&nbsp;or,&nbsp;if&nbsp;the&nbsp;handler&nbsp;finishes&nbsp;running&nbsp;before</span><br>
<span class="lineno">950</span><span class="comment" id="3461330">//&nbsp;the&nbsp;chunking&nbsp;buffer&nbsp;size,&nbsp;we&nbsp;compute&nbsp;a&nbsp;Content-Length&nbsp;and&nbsp;send&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3461401">//&nbsp;in&nbsp;the&nbsp;header&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="3461427">//</span><br>
<span class="lineno"></span><span class="comment" id="3461430">//&nbsp;Likewise,&nbsp;if&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;set&nbsp;a&nbsp;Content-Type,&nbsp;we&nbsp;sniff&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3461499">//&nbsp;from&nbsp;the&nbsp;initial&nbsp;chunk&nbsp;of&nbsp;output.</span><br>
<span class="lineno">955</span><span class="comment" id="3461536">//</span><br>
<span class="lineno"></span><span class="comment" id="3461539">//&nbsp;The&nbsp;Writers&nbsp;are&nbsp;wired&nbsp;together&nbsp;like:</span><br>
<span class="lineno"></span><span class="comment" id="3461579">//</span><br>
<span class="lineno"></span><span class="comment" id="3461582">//&nbsp;1.&nbsp;*response&nbsp;(the&nbsp;ResponseWriter)&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="3461622">//&nbsp;2.&nbsp;(*response).w,&nbsp;a&nbsp;*bufio.Writer&nbsp;of&nbsp;bufferBeforeChunkingSize&nbsp;bytes</span><br>
<span class="lineno">960</span><span class="comment" id="3461693">//&nbsp;3.&nbsp;chunkWriter.Writer&nbsp;(whose&nbsp;writeHeader&nbsp;finalizes&nbsp;Content-Length/Type)</span><br>
<span class="lineno"></span><span class="comment" id="3461768">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;which&nbsp;writes&nbsp;the&nbsp;chunk&nbsp;headers,&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="comment" id="3461821">//&nbsp;4.&nbsp;conn.buf,&nbsp;a&nbsp;bufio.Writer&nbsp;of&nbsp;default&nbsp;(4kB)&nbsp;bytes,&nbsp;writing&nbsp;to&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="3461890">//&nbsp;5.&nbsp;checkConnErrorWriter{c},&nbsp;which&nbsp;notes&nbsp;any&nbsp;non-nil&nbsp;error&nbsp;on&nbsp;Write</span><br>
<span class="lineno"></span><span class="comment" id="3461960">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;populates&nbsp;c.werr&nbsp;with&nbsp;it&nbsp;if&nbsp;so.&nbsp;but&nbsp;otherwise&nbsp;writes&nbsp;to:</span><br>
<span class="lineno">965</span><span class="comment" id="3462027">//&nbsp;6.&nbsp;the&nbsp;rwc,&nbsp;the&nbsp;net.Conn.</span><br>
<span class="lineno"></span><span class="comment" id="3462056">//</span><br>
<span class="lineno"></span><span class="comment" id="3462059">//&nbsp;TODO(bradfitz):&nbsp;short-circuit&nbsp;some&nbsp;of&nbsp;the&nbsp;buffering&nbsp;when&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3462123">//&nbsp;initial&nbsp;header&nbsp;contains&nbsp;both&nbsp;a&nbsp;Content-Type&nbsp;and&nbsp;Content-Length.</span><br>
<span class="lineno"></span><span class="comment" id="3462190">//&nbsp;Also&nbsp;short-circuit&nbsp;in&nbsp;(1)&nbsp;when&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;sent&nbsp;and&nbsp;not&nbsp;in</span><br>
<span class="lineno">970</span><span class="comment" id="3462258">//&nbsp;chunking&nbsp;mode,&nbsp;writing&nbsp;directly&nbsp;to&nbsp;(4)&nbsp;instead,&nbsp;if&nbsp;(2)&nbsp;has&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="3462323">//&nbsp;buffered&nbsp;data.&nbsp;&nbsp;More&nbsp;generally,&nbsp;we&nbsp;could&nbsp;short-circuit&nbsp;from&nbsp;(1)&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3462393">//&nbsp;(3)&nbsp;even&nbsp;in&nbsp;chunking&nbsp;mode&nbsp;if&nbsp;the&nbsp;write&nbsp;size&nbsp;from&nbsp;(1)&nbsp;is&nbsp;over&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="3462462">//&nbsp;threshold&nbsp;and&nbsp;nothing&nbsp;is&nbsp;in&nbsp;(2).&nbsp;&nbsp;The&nbsp;answer&nbsp;might&nbsp;be&nbsp;mostly&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="3462533">//&nbsp;bufferBeforeChunkingSize&nbsp;smaller&nbsp;and&nbsp;having&nbsp;bufio&#39;s&nbsp;fast-paths&nbsp;deal</span><br>
<span class="lineno">975</span><span class="comment" id="3462604">//&nbsp;with&nbsp;this&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="3462626">func</span>&nbsp;<span class="op" id="3462631">(</span><span class="ident" id="3462632">w</span>&nbsp;<span class="op" id="3462634">*</span><span class="ident" id="3462635">response</span><span class="op" id="3462643">)</span>&nbsp;<span class="ident" id="3462645">Write</span><span class="op" id="3462650">(</span><span class="ident" id="3462651">data</span>&nbsp;<span class="op" id="3462656">[</span><span class="op" id="3462657">]</span><span class="builtintype" id="3462658">byte</span><span class="op" id="3462662">)</span>&nbsp;<span class="op" id="3462664">(</span><span class="ident" id="3462665">n</span>&nbsp;<span class="builtintype" id="3462667">int</span><span class="op" id="3462670">,</span>&nbsp;<span class="ident" id="3462672">err</span>&nbsp;<span class="builtintype" id="3462676">error</span><span class="op" id="3462681">)</span>&nbsp;<span class="op" id="3462683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3462686">return</span>&nbsp;<span class="ident" id="3462693">w</span><span class="op" id="3462694">.</span><span class="ident" id="3462695">write</span><span class="op" id="3462700">(</span><span class="builtinfunc" id="3462701">len</span><span class="op" id="3462704">(</span><span class="ident" id="3462705">data</span><span class="op" id="3462709">)</span><span class="op" id="3462710">,</span>&nbsp;<span class="ident" id="3462712">data</span><span class="op" id="3462716">,</span>&nbsp;<span class="string" id="3462718">&#34;&#34;</span><span class="op" id="3462720">)</span><br>
<span class="lineno"></span><span class="op" id="3462722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="3462725">func</span>&nbsp;<span class="op" id="3462730">(</span><span class="ident" id="3462731">w</span>&nbsp;<span class="op" id="3462733">*</span><span class="ident" id="3462734">response</span><span class="op" id="3462742">)</span>&nbsp;<span class="ident" id="3462744">WriteString</span><span class="op" id="3462755">(</span><span class="ident" id="3462756">data</span>&nbsp;<span class="builtintype" id="3462761">string</span><span class="op" id="3462767">)</span>&nbsp;<span class="op" id="3462769">(</span><span class="ident" id="3462770">n</span>&nbsp;<span class="builtintype" id="3462772">int</span><span class="op" id="3462775">,</span>&nbsp;<span class="ident" id="3462777">err</span>&nbsp;<span class="builtintype" id="3462781">error</span><span class="op" id="3462786">)</span>&nbsp;<span class="op" id="3462788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3462791">return</span>&nbsp;<span class="ident" id="3462798">w</span><span class="op" id="3462799">.</span><span class="ident" id="3462800">write</span><span class="op" id="3462805">(</span><span class="builtinfunc" id="3462806">len</span><span class="op" id="3462809">(</span><span class="ident" id="3462810">data</span><span class="op" id="3462814">)</span><span class="op" id="3462815">,</span>&nbsp;<span class="ident" id="3462817">nil</span><span class="op" id="3462820">,</span>&nbsp;<span class="ident" id="3462822">data</span><span class="op" id="3462826">)</span><br>
<span class="lineno"></span><span class="op" id="3462828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3462831">//&nbsp;either&nbsp;dataB&nbsp;or&nbsp;dataS&nbsp;is&nbsp;non-zero.</span><br>
<span class="lineno">985</span><span class="keyword" id="3462869">func</span>&nbsp;<span class="op" id="3462874">(</span><span class="ident" id="3462875">w</span>&nbsp;<span class="op" id="3462877">*</span><span class="ident" id="3462878">response</span><span class="op" id="3462886">)</span>&nbsp;<span class="ident" id="3462888">write</span><span class="op" id="3462893">(</span><span class="ident" id="3462894">lenData</span>&nbsp;<span class="builtintype" id="3462902">int</span><span class="op" id="3462905">,</span>&nbsp;<span class="ident" id="3462907">dataB</span>&nbsp;<span class="op" id="3462913">[</span><span class="op" id="3462914">]</span><span class="builtintype" id="3462915">byte</span><span class="op" id="3462919">,</span>&nbsp;<span class="ident" id="3462921">dataS</span>&nbsp;<span class="builtintype" id="3462927">string</span><span class="op" id="3462933">)</span>&nbsp;<span class="op" id="3462935">(</span><span class="ident" id="3462936">n</span>&nbsp;<span class="builtintype" id="3462938">int</span><span class="op" id="3462941">,</span>&nbsp;<span class="ident" id="3462943">err</span>&nbsp;<span class="builtintype" id="3462947">error</span><span class="op" id="3462952">)</span>&nbsp;<span class="op" id="3462954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3462957">if</span>&nbsp;<span class="ident" id="3462960">w</span><span class="op" id="3462961">.</span><span class="ident" id="3462962">conn</span><span class="op" id="3462966">.</span><span class="ident" id="3462967">hijacked</span><span class="op" id="3462975">(</span><span class="op" id="3462976">)</span>&nbsp;<span class="op" id="3462978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3462982">w</span><span class="op" id="3462983">.</span><span class="ident" id="3462984">conn</span><span class="op" id="3462988">.</span><span class="ident" id="3462989">server</span><span class="op" id="3462995">.</span><span class="ident" id="3462996">logf</span><span class="op" id="3463000">(</span><span class="string" id="3463001">&#34;http:&nbsp;response.Write&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="3463046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463050">return</span>&nbsp;<span class="num" id="3463057">0</span><span class="op" id="3463058">,</span>&nbsp;<span class="ident" id="3463060">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3463073">}</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463076">if</span>&nbsp;<span class="op" id="3463079">!</span><span class="ident" id="3463080">w</span><span class="op" id="3463081">.</span><span class="ident" id="3463082">wroteHeader</span>&nbsp;<span class="op" id="3463094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463098">w</span><span class="op" id="3463099">.</span><span class="ident" id="3463100">WriteHeader</span><span class="op" id="3463111">(</span><span class="ident" id="3463112">StatusOK</span><span class="op" id="3463120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3463123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463126">if</span>&nbsp;<span class="ident" id="3463129">lenData</span>&nbsp;<span class="op" id="3463137">==</span>&nbsp;<span class="num" id="3463140">0</span>&nbsp;<span class="op" id="3463142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463146">return</span>&nbsp;<span class="num" id="3463153">0</span><span class="op" id="3463154">,</span>&nbsp;<span class="ident" id="3463156">nil</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3463161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463164">if</span>&nbsp;<span class="op" id="3463167">!</span><span class="ident" id="3463168">w</span><span class="op" id="3463169">.</span><span class="ident" id="3463170">bodyAllowed</span><span class="op" id="3463181">(</span><span class="op" id="3463182">)</span>&nbsp;<span class="op" id="3463184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463188">return</span>&nbsp;<span class="num" id="3463195">0</span><span class="op" id="3463196">,</span>&nbsp;<span class="ident" id="3463198">ErrBodyNotAllowed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3463217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463221">w</span><span class="op" id="3463222">.</span><span class="ident" id="3463223">written</span>&nbsp;<span class="op" id="3463231">+=</span>&nbsp;<span class="ident" id="3463234">int64</span><span class="op" id="3463239">(</span><span class="ident" id="3463240">lenData</span><span class="op" id="3463247">)</span>&nbsp;<span class="comment" id="3463249">//&nbsp;ignoring&nbsp;errors,&nbsp;for&nbsp;errorKludge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463286">if</span>&nbsp;<span class="ident" id="3463289">w</span><span class="op" id="3463290">.</span><span class="ident" id="3463291">contentLength</span>&nbsp;<span class="op" id="3463305">!=</span>&nbsp;<span class="op" id="3463308">-</span><span class="num" id="3463309">1</span>&nbsp;<span class="op" id="3463311">&amp;&amp;</span>&nbsp;<span class="ident" id="3463314">w</span><span class="op" id="3463315">.</span><span class="ident" id="3463316">written</span>&nbsp;<span class="op" id="3463324">&gt;</span>&nbsp;<span class="ident" id="3463326">w</span><span class="op" id="3463327">.</span><span class="ident" id="3463328">contentLength</span>&nbsp;<span class="op" id="3463342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463346">return</span>&nbsp;<span class="num" id="3463353">0</span><span class="op" id="3463354">,</span>&nbsp;<span class="ident" id="3463356">ErrContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3463374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463377">if</span>&nbsp;<span class="ident" id="3463380">dataB</span>&nbsp;<span class="op" id="3463386">!=</span>&nbsp;<span class="ident" id="3463389">nil</span>&nbsp;<span class="op" id="3463393">{</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463397">return</span>&nbsp;<span class="ident" id="3463404">w</span><span class="op" id="3463405">.</span><span class="ident" id="3463406">w</span><span class="op" id="3463407">.</span><span class="ident" id="3463408">Write</span><span class="op" id="3463413">(</span><span class="ident" id="3463414">dataB</span><span class="op" id="3463419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3463422">}</span>&nbsp;<span class="keyword" id="3463424">else</span>&nbsp;<span class="op" id="3463429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463433">return</span>&nbsp;<span class="ident" id="3463440">w</span><span class="op" id="3463441">.</span><span class="ident" id="3463442">w</span><span class="op" id="3463443">.</span><span class="ident" id="3463444">WriteString</span><span class="op" id="3463455">(</span><span class="ident" id="3463456">dataS</span><span class="op" id="3463461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3463464">}</span><br>
<span class="lineno"></span><span class="op" id="3463466">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span><span class="keyword" id="3463469">func</span>&nbsp;<span class="op" id="3463474">(</span><span class="ident" id="3463475">w</span>&nbsp;<span class="op" id="3463477">*</span><span class="ident" id="3463478">response</span><span class="op" id="3463486">)</span>&nbsp;<span class="ident" id="3463488">finishRequest</span><span class="op" id="3463501">(</span><span class="op" id="3463502">)</span>&nbsp;<span class="op" id="3463504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463507">w</span><span class="op" id="3463508">.</span><span class="ident" id="3463509">handlerDone</span>&nbsp;<span class="op" id="3463521">=</span>&nbsp;<span class="builtintype" id="3463523">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463530">if</span>&nbsp;<span class="op" id="3463533">!</span><span class="ident" id="3463534">w</span><span class="op" id="3463535">.</span><span class="ident" id="3463536">wroteHeader</span>&nbsp;<span class="op" id="3463548">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463552">w</span><span class="op" id="3463553">.</span><span class="ident" id="3463554">WriteHeader</span><span class="op" id="3463565">(</span><span class="ident" id="3463566">StatusOK</span><span class="op" id="3463574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3463577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463581">w</span><span class="op" id="3463582">.</span><span class="ident" id="3463583">w</span><span class="op" id="3463584">.</span><span class="ident" id="3463585">Flush</span><span class="op" id="3463590">(</span><span class="op" id="3463591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463594">putBufioWriter</span><span class="op" id="3463608">(</span><span class="ident" id="3463609">w</span><span class="op" id="3463610">.</span><span class="ident" id="3463611">w</span><span class="op" id="3463612">)</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463615">w</span><span class="op" id="3463616">.</span><span class="ident" id="3463617">cw</span><span class="op" id="3463619">.</span><span class="builtinfunc" id="3463620">close</span><span class="op" id="3463625">(</span><span class="op" id="3463626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463629">w</span><span class="op" id="3463630">.</span><span class="ident" id="3463631">conn</span><span class="op" id="3463635">.</span><span class="ident" id="3463636">buf</span><span class="op" id="3463639">.</span><span class="ident" id="3463640">Flush</span><span class="op" id="3463645">(</span><span class="op" id="3463646">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3463650">//&nbsp;Close&nbsp;the&nbsp;body&nbsp;(regardless&nbsp;of&nbsp;w.closeAfterReply)&nbsp;so&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3463713">//&nbsp;re-use&nbsp;its&nbsp;bufio.Reader&nbsp;later&nbsp;safely.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463755">w</span><span class="op" id="3463756">.</span><span class="ident" id="3463757">req</span><span class="op" id="3463760">.</span><span class="ident" id="3463761">Body</span><span class="op" id="3463765">.</span><span class="ident" id="3463766">Close</span><span class="op" id="3463771">(</span><span class="op" id="3463772">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463776">if</span>&nbsp;<span class="ident" id="3463779">w</span><span class="op" id="3463780">.</span><span class="ident" id="3463781">req</span><span class="op" id="3463784">.</span><span class="ident" id="3463785">MultipartForm</span>&nbsp;<span class="op" id="3463799">!=</span>&nbsp;<span class="ident" id="3463802">nil</span>&nbsp;<span class="op" id="3463806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3463810">w</span><span class="op" id="3463811">.</span><span class="ident" id="3463812">req</span><span class="op" id="3463815">.</span><span class="ident" id="3463816">MultipartForm</span><span class="op" id="3463829">.</span><span class="ident" id="3463830">RemoveAll</span><span class="op" id="3463839">(</span><span class="op" id="3463840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3463843">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3463847">if</span>&nbsp;<span class="ident" id="3463850">w</span><span class="op" id="3463851">.</span><span class="ident" id="3463852">req</span><span class="op" id="3463855">.</span><span class="ident" id="3463856">Method</span>&nbsp;<span class="op" id="3463863">!=</span>&nbsp;<span class="string" id="3463866">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3463873">&amp;&amp;</span>&nbsp;<span class="ident" id="3463876">w</span><span class="op" id="3463877">.</span><span class="ident" id="3463878">contentLength</span>&nbsp;<span class="op" id="3463892">!=</span>&nbsp;<span class="op" id="3463895">-</span><span class="num" id="3463896">1</span>&nbsp;<span class="op" id="3463898">&amp;&amp;</span>&nbsp;<span class="ident" id="3463901">w</span><span class="op" id="3463902">.</span><span class="ident" id="3463903">bodyAllowed</span><span class="op" id="3463914">(</span><span class="op" id="3463915">)</span>&nbsp;<span class="op" id="3463917">&amp;&amp;</span>&nbsp;<span class="ident" id="3463920">w</span><span class="op" id="3463921">.</span><span class="ident" id="3463922">contentLength</span>&nbsp;<span class="op" id="3463936">!=</span>&nbsp;<span class="ident" id="3463939">w</span><span class="op" id="3463940">.</span><span class="ident" id="3463941">written</span>&nbsp;<span class="op" id="3463949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3463953">//&nbsp;Did&nbsp;not&nbsp;write&nbsp;enough.&nbsp;Avoid&nbsp;getting&nbsp;out&nbsp;of&nbsp;sync.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3464007">w</span><span class="op" id="3464008">.</span><span class="ident" id="3464009">closeAfterReply</span>&nbsp;<span class="op" id="3464025">=</span>&nbsp;<span class="builtintype" id="3464027">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3464033">}</span><br>
<span class="lineno">1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3464037">//&nbsp;There&nbsp;was&nbsp;some&nbsp;error&nbsp;writing&nbsp;to&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3464099">//&nbsp;during&nbsp;the&nbsp;request,&nbsp;so&nbsp;don&#39;t&nbsp;re-use&nbsp;this&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3464150">if</span>&nbsp;<span class="ident" id="3464153">w</span><span class="op" id="3464154">.</span><span class="ident" id="3464155">conn</span><span class="op" id="3464159">.</span><span class="ident" id="3464160">werr</span>&nbsp;<span class="op" id="3464165">!=</span>&nbsp;<span class="ident" id="3464168">nil</span>&nbsp;<span class="op" id="3464172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3464176">w</span><span class="op" id="3464177">.</span><span class="ident" id="3464178">closeAfterReply</span>&nbsp;<span class="op" id="3464194">=</span>&nbsp;<span class="builtintype" id="3464196">true</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3464202">}</span><br>
<span class="lineno"></span><span class="op" id="3464204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3464207">func</span>&nbsp;<span class="op" id="3464212">(</span><span class="ident" id="3464213">w</span>&nbsp;<span class="op" id="3464215">*</span><span class="ident" id="3464216">response</span><span class="op" id="3464224">)</span>&nbsp;<span class="ident" id="3464226">Flush</span><span class="op" id="3464231">(</span><span class="op" id="3464232">)</span>&nbsp;<span class="op" id="3464234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3464237">if</span>&nbsp;<span class="op" id="3464240">!</span><span class="ident" id="3464241">w</span><span class="op" id="3464242">.</span><span class="ident" id="3464243">wroteHeader</span>&nbsp;<span class="op" id="3464255">{</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3464259">w</span><span class="op" id="3464260">.</span><span class="ident" id="3464261">WriteHeader</span><span class="op" id="3464272">(</span><span class="ident" id="3464273">StatusOK</span><span class="op" id="3464281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3464284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3464287">w</span><span class="op" id="3464288">.</span><span class="ident" id="3464289">w</span><span class="op" id="3464290">.</span><span class="ident" id="3464291">Flush</span><span class="op" id="3464296">(</span><span class="op" id="3464297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3464300">w</span><span class="op" id="3464301">.</span><span class="ident" id="3464302">cw</span><span class="op" id="3464304">.</span><span class="ident" id="3464305">flush</span><span class="op" id="3464310">(</span><span class="op" id="3464311">)</span><br>
<span class="lineno"></span><span class="op" id="3464313">}</span><br>
<span class="lineno">1050</span><br>
<span class="lineno"></span><span class="keyword" id="3464316">func</span>&nbsp;<span class="op" id="3464321">(</span><span class="ident" id="3464322">c</span>&nbsp;<span class="op" id="3464324">*</span><span class="ident" id="3464325">conn</span><span class="op" id="3464329">)</span>&nbsp;<span class="ident" id="3464331">finalFlush</span><span class="op" id="3464341">(</span><span class="op" id="3464342">)</span>&nbsp;<span class="op" id="3464344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3464347">if</span>&nbsp;<span class="ident" id="3464350">c</span><span class="op" id="3464351">.</span><span class="ident" id="3464352">buf</span>&nbsp;<span class="op" id="3464356">!=</span>&nbsp;<span class="ident" id="3464359">nil</span>&nbsp;<span class="op" id="3464363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3464367">c</span><span class="op" id="3464368">.</span><span class="ident" id="3464369">buf</span><span class="op" id="3464372">.</span><span class="ident" id="3464373">Flush</span><span class="op" id="3464378">(</span><span class="op" id="3464379">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3464384">//&nbsp;Steal&nbsp;the&nbsp;bufio.Reader&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3464454">//&nbsp;reader&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3464491">putBufioReader</span><span class="op" id="3464505">(</span><span class="ident" id="3464506">c</span><span class="op" id="3464507">.</span><span class="ident" id="3464508">buf</span><span class="op" id="3464511">.</span><span class="ident" id="3464512">Reader</span><span class="op" id="3464518">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3464523">//&nbsp;Steal&nbsp;the&nbsp;bufio.Writer&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3464593">//&nbsp;writer&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3464630">putBufioWriter</span><span class="op" id="3464644">(</span><span class="ident" id="3464645">c</span><span class="op" id="3464646">.</span><span class="ident" id="3464647">buf</span><span class="op" id="3464650">.</span><span class="ident" id="3464651">Writer</span><span class="op" id="3464657">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3464662">c</span><span class="op" id="3464663">.</span><span class="ident" id="3464664">buf</span>&nbsp;<span class="op" id="3464668">=</span>&nbsp;<span class="ident" id="3464670">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3464675">}</span><br>
<span class="lineno">1065</span><span class="op" id="3464677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3464680">//&nbsp;Close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3464705">func</span>&nbsp;<span class="op" id="3464710">(</span><span class="ident" id="3464711">c</span>&nbsp;<span class="op" id="3464713">*</span><span class="ident" id="3464714">conn</span><span class="op" id="3464718">)</span>&nbsp;<span class="builtinfunc" id="3464720">close</span><span class="op" id="3464725">(</span><span class="op" id="3464726">)</span>&nbsp;<span class="op" id="3464728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3464731">c</span><span class="op" id="3464732">.</span><span class="ident" id="3464733">finalFlush</span><span class="op" id="3464743">(</span><span class="op" id="3464744">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3464747">if</span>&nbsp;<span class="ident" id="3464750">c</span><span class="op" id="3464751">.</span><span class="ident" id="3464752">rwc</span>&nbsp;<span class="op" id="3464756">!=</span>&nbsp;<span class="ident" id="3464759">nil</span>&nbsp;<span class="op" id="3464763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3464767">c</span><span class="op" id="3464768">.</span><span class="ident" id="3464769">rwc</span><span class="op" id="3464772">.</span><span class="ident" id="3464773">Close</span><span class="op" id="3464778">(</span><span class="op" id="3464779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3464783">c</span><span class="op" id="3464784">.</span><span class="ident" id="3464785">rwc</span>&nbsp;<span class="op" id="3464789">=</span>&nbsp;<span class="ident" id="3464791">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3464796">}</span><br>
<span class="lineno"></span><span class="op" id="3464798">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span><span class="comment" id="3464801">//&nbsp;rstAvoidanceDelay&nbsp;is&nbsp;the&nbsp;amount&nbsp;of&nbsp;time&nbsp;we&nbsp;sleep&nbsp;after&nbsp;closing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3464871">//&nbsp;write&nbsp;side&nbsp;of&nbsp;a&nbsp;TCP&nbsp;connection&nbsp;before&nbsp;closing&nbsp;the&nbsp;entire&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="3464939">//&nbsp;By&nbsp;sleeping,&nbsp;we&nbsp;increase&nbsp;the&nbsp;chances&nbsp;that&nbsp;the&nbsp;client&nbsp;sees&nbsp;our&nbsp;FIN</span><br>
<span class="lineno"></span><span class="comment" id="3465008">//&nbsp;and&nbsp;processes&nbsp;its&nbsp;final&nbsp;data&nbsp;before&nbsp;they&nbsp;process&nbsp;the&nbsp;subsequent&nbsp;RST</span><br>
<span class="lineno">1080</span><span class="comment" id="3465079">//&nbsp;from&nbsp;closing&nbsp;a&nbsp;connection&nbsp;with&nbsp;known&nbsp;unread&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="3465132">//&nbsp;This&nbsp;RST&nbsp;seems&nbsp;to&nbsp;occur&nbsp;mostly&nbsp;on&nbsp;BSD&nbsp;systems.&nbsp;(And&nbsp;Windows?)</span><br>
<span class="lineno"></span><span class="comment" id="3465197">//&nbsp;This&nbsp;timeout&nbsp;is&nbsp;somewhat&nbsp;arbitrary&nbsp;(~latency&nbsp;around&nbsp;the&nbsp;planet).</span><br>
<span class="lineno"></span><span class="keyword" id="3465265">const</span>&nbsp;<span class="ident" id="3465271">rstAvoidanceDelay</span>&nbsp;<span class="op" id="3465289">=</span>&nbsp;<span class="num" id="3465291">500</span>&nbsp;<span class="op" id="3465295">*</span>&nbsp;<span class="ident" id="3465297">time</span><span class="op" id="3465301">.</span><span class="ident" id="3465302">Millisecond</span><br>
<span class="lineno"></span><br>
<span class="lineno">1085</span><span class="keyword" id="3465315">type</span>&nbsp;<span class="ident" id="3465320">closeWriter</span>&nbsp;<span class="keyword" id="3465332">interface</span>&nbsp;<span class="op" id="3465342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3465345">CloseWrite</span><span class="op" id="3465355">(</span><span class="op" id="3465356">)</span>&nbsp;<span class="builtintype" id="3465358">error</span><br>
<span class="lineno"></span><span class="op" id="3465364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3465367">var</span>&nbsp;<span class="ident" id="3465371">_</span>&nbsp;<span class="ident" id="3465373">closeWriter</span>&nbsp;<span class="op" id="3465385">=</span>&nbsp;<span class="op" id="3465387">(</span><span class="op" id="3465388">*</span><span class="ident" id="3465389">net</span><span class="op" id="3465392">.</span><span class="ident" id="3465393">TCPConn</span><span class="op" id="3465400">)</span><span class="op" id="3465401">(</span><span class="ident" id="3465402">nil</span><span class="op" id="3465405">)</span><br>
<span class="lineno">1090</span><br>
<span class="lineno"></span><span class="comment" id="3465408">//&nbsp;closeWrite&nbsp;flushes&nbsp;any&nbsp;outstanding&nbsp;data&nbsp;and&nbsp;sends&nbsp;a&nbsp;FIN&nbsp;packet&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="3465478">//&nbsp;client&nbsp;is&nbsp;connected&nbsp;via&nbsp;TCP),&nbsp;signalling&nbsp;that&nbsp;we&#39;re&nbsp;done.&nbsp;&nbsp;We&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3465548">//&nbsp;pause&nbsp;for&nbsp;a&nbsp;bit,&nbsp;hoping&nbsp;the&nbsp;client&nbsp;processes&nbsp;it&nbsp;before&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="3465610">//&nbsp;subsequent&nbsp;RST.</span><br>
<span class="lineno">1095</span><span class="comment" id="3465629">//</span><br>
<span class="lineno"></span><span class="comment" id="3465632">//&nbsp;See&nbsp;http://golang.org/issue/3595</span><br>
<span class="lineno"></span><span class="keyword" id="3465668">func</span>&nbsp;<span class="op" id="3465673">(</span><span class="ident" id="3465674">c</span>&nbsp;<span class="op" id="3465676">*</span><span class="ident" id="3465677">conn</span><span class="op" id="3465681">)</span>&nbsp;<span class="ident" id="3465683">closeWriteAndWait</span><span class="op" id="3465700">(</span><span class="op" id="3465701">)</span>&nbsp;<span class="op" id="3465703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3465706">c</span><span class="op" id="3465707">.</span><span class="ident" id="3465708">finalFlush</span><span class="op" id="3465718">(</span><span class="op" id="3465719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3465722">if</span>&nbsp;<span class="ident" id="3465725">tcp</span><span class="op" id="3465728">,</span>&nbsp;<span class="ident" id="3465730">ok</span>&nbsp;<span class="op" id="3465733">:=</span>&nbsp;<span class="ident" id="3465736">c</span><span class="op" id="3465737">.</span><span class="ident" id="3465738">rwc</span><span class="op" id="3465741">.</span><span class="op" id="3465742">(</span><span class="ident" id="3465743">closeWriter</span><span class="op" id="3465754">)</span><span class="op" id="3465755">;</span>&nbsp;<span class="ident" id="3465757">ok</span>&nbsp;<span class="op" id="3465760">{</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3465764">tcp</span><span class="op" id="3465767">.</span><span class="ident" id="3465768">CloseWrite</span><span class="op" id="3465778">(</span><span class="op" id="3465779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3465782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3465785">time</span><span class="op" id="3465789">.</span><span class="ident" id="3465790">Sleep</span><span class="op" id="3465795">(</span><span class="ident" id="3465796">rstAvoidanceDelay</span><span class="op" id="3465813">)</span><br>
<span class="lineno"></span><span class="op" id="3465815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1105</span><span class="comment" id="3465818">//&nbsp;validNPN&nbsp;reports&nbsp;whether&nbsp;the&nbsp;proto&nbsp;is&nbsp;not&nbsp;a&nbsp;blacklisted&nbsp;Next</span><br>
<span class="lineno"></span><span class="comment" id="3465882">//&nbsp;Protocol&nbsp;Negotiation&nbsp;protocol.&nbsp;&nbsp;Empty&nbsp;and&nbsp;built-in&nbsp;protocol&nbsp;types</span><br>
<span class="lineno"></span><span class="comment" id="3465951">//&nbsp;are&nbsp;blacklisted&nbsp;and&nbsp;can&#39;t&nbsp;be&nbsp;overridden&nbsp;with&nbsp;alternate</span><br>
<span class="lineno"></span><span class="comment" id="3466009">//&nbsp;implementations.</span><br>
<span class="lineno"></span><span class="keyword" id="3466029">func</span>&nbsp;<span class="ident" id="3466034">validNPN</span><span class="op" id="3466042">(</span><span class="ident" id="3466043">proto</span>&nbsp;<span class="builtintype" id="3466049">string</span><span class="op" id="3466055">)</span>&nbsp;<span class="builtintype" id="3466057">bool</span>&nbsp;<span class="op" id="3466062">{</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466065">switch</span>&nbsp;<span class="ident" id="3466072">proto</span>&nbsp;<span class="op" id="3466078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466081">case</span>&nbsp;<span class="string" id="3466086">&#34;&#34;</span><span class="op" id="3466088">,</span>&nbsp;<span class="string" id="3466090">&#34;http/1.1&#34;</span><span class="op" id="3466100">,</span>&nbsp;<span class="string" id="3466102">&#34;http/1.0&#34;</span><span class="op" id="3466112">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466116">return</span>&nbsp;<span class="builtintype" id="3466123">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3466130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466133">return</span>&nbsp;<span class="builtintype" id="3466140">true</span><br>
<span class="lineno">1115</span><span class="op" id="3466145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3466148">func</span>&nbsp;<span class="op" id="3466153">(</span><span class="ident" id="3466154">c</span>&nbsp;<span class="op" id="3466156">*</span><span class="ident" id="3466157">conn</span><span class="op" id="3466161">)</span>&nbsp;<span class="ident" id="3466163">setState</span><span class="op" id="3466171">(</span><span class="ident" id="3466172">nc</span>&nbsp;<span class="ident" id="3466175">net</span><span class="op" id="3466178">.</span><span class="ident" id="3466179">Conn</span><span class="op" id="3466183">,</span>&nbsp;<span class="ident" id="3466185">state</span>&nbsp;<span class="ident" id="3466191">ConnState</span><span class="op" id="3466200">)</span>&nbsp;<span class="op" id="3466202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466205">if</span>&nbsp;<span class="ident" id="3466208">hook</span>&nbsp;<span class="op" id="3466213">:=</span>&nbsp;<span class="ident" id="3466216">c</span><span class="op" id="3466217">.</span><span class="ident" id="3466218">server</span><span class="op" id="3466224">.</span><span class="ident" id="3466225">ConnState</span><span class="op" id="3466234">;</span>&nbsp;<span class="ident" id="3466236">hook</span>&nbsp;<span class="op" id="3466241">!=</span>&nbsp;<span class="ident" id="3466244">nil</span>&nbsp;<span class="op" id="3466248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3466252">hook</span><span class="op" id="3466256">(</span><span class="ident" id="3466257">nc</span><span class="op" id="3466259">,</span>&nbsp;<span class="ident" id="3466261">state</span><span class="op" id="3466266">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3466269">}</span><br>
<span class="lineno"></span><span class="op" id="3466271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3466274">//&nbsp;Serve&nbsp;a&nbsp;new&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3466301">func</span>&nbsp;<span class="op" id="3466306">(</span><span class="ident" id="3466307">c</span>&nbsp;<span class="op" id="3466309">*</span><span class="ident" id="3466310">conn</span><span class="op" id="3466314">)</span>&nbsp;<span class="ident" id="3466316">serve</span><span class="op" id="3466321">(</span><span class="op" id="3466322">)</span>&nbsp;<span class="op" id="3466324">{</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3466327">origConn</span>&nbsp;<span class="op" id="3466336">:=</span>&nbsp;<span class="ident" id="3466339">c</span><span class="op" id="3466340">.</span><span class="ident" id="3466341">rwc</span>&nbsp;<span class="comment" id="3466345">//&nbsp;copy&nbsp;it&nbsp;before&nbsp;it&#39;s&nbsp;set&nbsp;nil&nbsp;on&nbsp;Close&nbsp;or&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466396">defer</span>&nbsp;<span class="keyword" id="3466402">func</span><span class="op" id="3466406">(</span><span class="op" id="3466407">)</span>&nbsp;<span class="op" id="3466409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466413">if</span>&nbsp;<span class="ident" id="3466416">err</span>&nbsp;<span class="op" id="3466420">:=</span>&nbsp;<span class="builtinfunc" id="3466423">recover</span><span class="op" id="3466430">(</span><span class="op" id="3466431">)</span><span class="op" id="3466432">;</span>&nbsp;<span class="ident" id="3466434">err</span>&nbsp;<span class="op" id="3466438">!=</span>&nbsp;<span class="ident" id="3466441">nil</span>&nbsp;<span class="op" id="3466445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466450">const</span>&nbsp;<span class="ident" id="3466456">size</span>&nbsp;<span class="op" id="3466461">=</span>&nbsp;<span class="num" id="3466463">64</span>&nbsp;<span class="op" id="3466466">&lt;&lt;</span>&nbsp;<span class="num" id="3466469">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3466475">buf</span>&nbsp;<span class="op" id="3466479">:=</span>&nbsp;<span class="builtinfunc" id="3466482">make</span><span class="op" id="3466486">(</span><span class="op" id="3466487">[</span><span class="op" id="3466488">]</span><span class="builtintype" id="3466489">byte</span><span class="op" id="3466493">,</span>&nbsp;<span class="ident" id="3466495">size</span><span class="op" id="3466499">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3466504">buf</span>&nbsp;<span class="op" id="3466508">=</span>&nbsp;<span class="ident" id="3466510">buf</span><span class="op" id="3466513">[</span><span class="op" id="3466514">:</span><span class="ident" id="3466515">runtime</span><span class="op" id="3466522">.</span><span class="ident" id="3466523">Stack</span><span class="op" id="3466528">(</span><span class="ident" id="3466529">buf</span><span class="op" id="3466532">,</span>&nbsp;<span class="builtintype" id="3466534">false</span><span class="op" id="3466539">)</span><span class="op" id="3466540">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3466545">c</span><span class="op" id="3466546">.</span><span class="ident" id="3466547">server</span><span class="op" id="3466553">.</span><span class="ident" id="3466554">logf</span><span class="op" id="3466558">(</span><span class="string" id="3466559">&#34;http:&nbsp;panic&nbsp;serving&nbsp;%v:&nbsp;%v\n%s&#34;</span><span class="op" id="3466591">,</span>&nbsp;<span class="ident" id="3466593">c</span><span class="op" id="3466594">.</span><span class="ident" id="3466595">remoteAddr</span><span class="op" id="3466605">,</span>&nbsp;<span class="ident" id="3466607">err</span><span class="op" id="3466610">,</span>&nbsp;<span class="ident" id="3466612">buf</span><span class="op" id="3466615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3466619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466623">if</span>&nbsp;<span class="op" id="3466626">!</span><span class="ident" id="3466627">c</span><span class="op" id="3466628">.</span><span class="ident" id="3466629">hijacked</span><span class="op" id="3466637">(</span><span class="op" id="3466638">)</span>&nbsp;<span class="op" id="3466640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3466645">c</span><span class="op" id="3466646">.</span><span class="builtinfunc" id="3466647">close</span><span class="op" id="3466652">(</span><span class="op" id="3466653">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3466658">c</span><span class="op" id="3466659">.</span><span class="ident" id="3466660">setState</span><span class="op" id="3466668">(</span><span class="ident" id="3466669">origConn</span><span class="op" id="3466677">,</span>&nbsp;<span class="ident" id="3466679">StateClosed</span><span class="op" id="3466690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3466694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3466697">}</span><span class="op" id="3466698">(</span><span class="op" id="3466699">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466703">if</span>&nbsp;<span class="ident" id="3466706">tlsConn</span><span class="op" id="3466713">,</span>&nbsp;<span class="ident" id="3466715">ok</span>&nbsp;<span class="op" id="3466718">:=</span>&nbsp;<span class="ident" id="3466721">c</span><span class="op" id="3466722">.</span><span class="ident" id="3466723">rwc</span><span class="op" id="3466726">.</span><span class="op" id="3466727">(</span><span class="op" id="3466728">*</span><span class="ident" id="3466729">tls</span><span class="op" id="3466732">.</span><span class="ident" id="3466733">Conn</span><span class="op" id="3466737">)</span><span class="op" id="3466738">;</span>&nbsp;<span class="ident" id="3466740">ok</span>&nbsp;<span class="op" id="3466743">{</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466747">if</span>&nbsp;<span class="ident" id="3466750">d</span>&nbsp;<span class="op" id="3466752">:=</span>&nbsp;<span class="ident" id="3466755">c</span><span class="op" id="3466756">.</span><span class="ident" id="3466757">server</span><span class="op" id="3466763">.</span><span class="ident" id="3466764">ReadTimeout</span><span class="op" id="3466775">;</span>&nbsp;<span class="ident" id="3466777">d</span>&nbsp;<span class="op" id="3466779">!=</span>&nbsp;<span class="num" id="3466782">0</span>&nbsp;<span class="op" id="3466784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3466789">c</span><span class="op" id="3466790">.</span><span class="ident" id="3466791">rwc</span><span class="op" id="3466794">.</span><span class="ident" id="3466795">SetReadDeadline</span><span class="op" id="3466810">(</span><span class="ident" id="3466811">time</span><span class="op" id="3466815">.</span><span class="ident" id="3466816">Now</span><span class="op" id="3466819">(</span><span class="op" id="3466820">)</span><span class="op" id="3466821">.</span><span class="ident" id="3466822">Add</span><span class="op" id="3466825">(</span><span class="ident" id="3466826">d</span><span class="op" id="3466827">)</span><span class="op" id="3466828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3466832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466836">if</span>&nbsp;<span class="ident" id="3466839">d</span>&nbsp;<span class="op" id="3466841">:=</span>&nbsp;<span class="ident" id="3466844">c</span><span class="op" id="3466845">.</span><span class="ident" id="3466846">server</span><span class="op" id="3466852">.</span><span class="ident" id="3466853">WriteTimeout</span><span class="op" id="3466865">;</span>&nbsp;<span class="ident" id="3466867">d</span>&nbsp;<span class="op" id="3466869">!=</span>&nbsp;<span class="num" id="3466872">0</span>&nbsp;<span class="op" id="3466874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3466879">c</span><span class="op" id="3466880">.</span><span class="ident" id="3466881">rwc</span><span class="op" id="3466884">.</span><span class="ident" id="3466885">SetWriteDeadline</span><span class="op" id="3466901">(</span><span class="ident" id="3466902">time</span><span class="op" id="3466906">.</span><span class="ident" id="3466907">Now</span><span class="op" id="3466910">(</span><span class="op" id="3466911">)</span><span class="op" id="3466912">.</span><span class="ident" id="3466913">Add</span><span class="op" id="3466916">(</span><span class="ident" id="3466917">d</span><span class="op" id="3466918">)</span><span class="op" id="3466919">)</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3466923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3466927">if</span>&nbsp;<span class="ident" id="3466930">err</span>&nbsp;<span class="op" id="3466934">:=</span>&nbsp;<span class="ident" id="3466937">tlsConn</span><span class="op" id="3466944">.</span><span class="ident" id="3466945">Handshake</span><span class="op" id="3466954">(</span><span class="op" id="3466955">)</span><span class="op" id="3466956">;</span>&nbsp;<span class="ident" id="3466958">err</span>&nbsp;<span class="op" id="3466962">!=</span>&nbsp;<span class="ident" id="3466965">nil</span>&nbsp;<span class="op" id="3466969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3466974">c</span><span class="op" id="3466975">.</span><span class="ident" id="3466976">server</span><span class="op" id="3466982">.</span><span class="ident" id="3466983">logf</span><span class="op" id="3466987">(</span><span class="string" id="3466988">&#34;http:&nbsp;TLS&nbsp;handshake&nbsp;error&nbsp;from&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="3467027">,</span>&nbsp;<span class="ident" id="3467029">c</span><span class="op" id="3467030">.</span><span class="ident" id="3467031">rwc</span><span class="op" id="3467034">.</span><span class="ident" id="3467035">RemoteAddr</span><span class="op" id="3467045">(</span><span class="op" id="3467046">)</span><span class="op" id="3467047">,</span>&nbsp;<span class="ident" id="3467049">err</span><span class="op" id="3467052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3467057">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3467066">}</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3467070">c</span><span class="op" id="3467071">.</span><span class="ident" id="3467072">tlsState</span>&nbsp;<span class="op" id="3467081">=</span>&nbsp;<span class="builtinfunc" id="3467083">new</span><span class="op" id="3467086">(</span><span class="ident" id="3467087">tls</span><span class="op" id="3467090">.</span><span class="ident" id="3467091">ConnectionState</span><span class="op" id="3467106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3467110">*</span><span class="ident" id="3467111">c</span><span class="op" id="3467112">.</span><span class="ident" id="3467113">tlsState</span>&nbsp;<span class="op" id="3467122">=</span>&nbsp;<span class="ident" id="3467124">tlsConn</span><span class="op" id="3467131">.</span><span class="ident" id="3467132">ConnectionState</span><span class="op" id="3467147">(</span><span class="op" id="3467148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3467152">if</span>&nbsp;<span class="ident" id="3467155">proto</span>&nbsp;<span class="op" id="3467161">:=</span>&nbsp;<span class="ident" id="3467164">c</span><span class="op" id="3467165">.</span><span class="ident" id="3467166">tlsState</span><span class="op" id="3467174">.</span><span class="ident" id="3467175">NegotiatedProtocol</span><span class="op" id="3467193">;</span>&nbsp;<span class="ident" id="3467195">validNPN</span><span class="op" id="3467203">(</span><span class="ident" id="3467204">proto</span><span class="op" id="3467209">)</span>&nbsp;<span class="op" id="3467211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3467216">if</span>&nbsp;<span class="ident" id="3467219">fn</span>&nbsp;<span class="op" id="3467222">:=</span>&nbsp;<span class="ident" id="3467225">c</span><span class="op" id="3467226">.</span><span class="ident" id="3467227">server</span><span class="op" id="3467233">.</span><span class="ident" id="3467234">TLSNextProto</span><span class="op" id="3467246">[</span><span class="ident" id="3467247">proto</span><span class="op" id="3467252">]</span><span class="op" id="3467253">;</span>&nbsp;<span class="ident" id="3467255">fn</span>&nbsp;<span class="op" id="3467258">!=</span>&nbsp;<span class="ident" id="3467261">nil</span>&nbsp;<span class="op" id="3467265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3467271">h</span>&nbsp;<span class="op" id="3467273">:=</span>&nbsp;<span class="ident" id="3467276">initNPNRequest</span><span class="op" id="3467290">{</span><span class="ident" id="3467291">tlsConn</span><span class="op" id="3467298">,</span>&nbsp;<span class="ident" id="3467300">serverHandler</span><span class="op" id="3467313">{</span><span class="ident" id="3467314">c</span><span class="op" id="3467315">.</span><span class="ident" id="3467316">server</span><span class="op" id="3467322">}</span><span class="op" id="3467323">}</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3467329">fn</span><span class="op" id="3467331">(</span><span class="ident" id="3467332">c</span><span class="op" id="3467333">.</span><span class="ident" id="3467334">server</span><span class="op" id="3467340">,</span>&nbsp;<span class="ident" id="3467342">tlsConn</span><span class="op" id="3467349">,</span>&nbsp;<span class="ident" id="3467351">h</span><span class="op" id="3467352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3467357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3467362">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3467371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3467374">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3467378">for</span>&nbsp;<span class="op" id="3467382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3467386">w</span><span class="op" id="3467387">,</span>&nbsp;<span class="ident" id="3467389">err</span>&nbsp;<span class="op" id="3467393">:=</span>&nbsp;<span class="ident" id="3467396">c</span><span class="op" id="3467397">.</span><span class="ident" id="3467398">readRequest</span><span class="op" id="3467409">(</span><span class="op" id="3467410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3467414">if</span>&nbsp;<span class="ident" id="3467417">c</span><span class="op" id="3467418">.</span><span class="ident" id="3467419">lr</span><span class="op" id="3467421">.</span><span class="ident" id="3467422">N</span>&nbsp;<span class="op" id="3467424">!=</span>&nbsp;<span class="ident" id="3467427">c</span><span class="op" id="3467428">.</span><span class="ident" id="3467429">server</span><span class="op" id="3467435">.</span><span class="ident" id="3467436">initialLimitedReaderSize</span><span class="op" id="3467460">(</span><span class="op" id="3467461">)</span>&nbsp;<span class="op" id="3467463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3467468">//&nbsp;If&nbsp;we&nbsp;read&nbsp;any&nbsp;bytes&nbsp;off&nbsp;the&nbsp;wire,&nbsp;we&#39;re&nbsp;active.</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3467523">c</span><span class="op" id="3467524">.</span><span class="ident" id="3467525">setState</span><span class="op" id="3467533">(</span><span class="ident" id="3467534">c</span><span class="op" id="3467535">.</span><span class="ident" id="3467536">rwc</span><span class="op" id="3467539">,</span>&nbsp;<span class="ident" id="3467541">StateActive</span><span class="op" id="3467552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3467556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3467560">if</span>&nbsp;<span class="ident" id="3467563">err</span>&nbsp;<span class="op" id="3467567">!=</span>&nbsp;<span class="ident" id="3467570">nil</span>&nbsp;<span class="op" id="3467574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3467579">if</span>&nbsp;<span class="ident" id="3467582">err</span>&nbsp;<span class="op" id="3467586">==</span>&nbsp;<span class="ident" id="3467589">errTooLarge</span>&nbsp;<span class="op" id="3467601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3467607">//&nbsp;Their&nbsp;HTTP&nbsp;client&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;be</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3467650">//&nbsp;able&nbsp;to&nbsp;read&nbsp;this&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3467684">//&nbsp;responding&nbsp;to&nbsp;them&nbsp;and&nbsp;hanging&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3467725">//&nbsp;while&nbsp;they&#39;re&nbsp;still&nbsp;writing&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3467766">//&nbsp;request.&nbsp;&nbsp;Undefined&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3467803">io</span><span class="op" id="3467805">.</span><span class="ident" id="3467806">WriteString</span><span class="op" id="3467817">(</span><span class="ident" id="3467818">c</span><span class="op" id="3467819">.</span><span class="ident" id="3467820">rwc</span><span class="op" id="3467823">,</span>&nbsp;<span class="string" id="3467825">&#34;HTTP/1.1&nbsp;413&nbsp;Request&nbsp;Entity&nbsp;Too&nbsp;Large\r\n\r\n&#34;</span><span class="op" id="3467872">)</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3467878">c</span><span class="op" id="3467879">.</span><span class="ident" id="3467880">closeWriteAndWait</span><span class="op" id="3467897">(</span><span class="op" id="3467898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3467904">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3467913">}</span>&nbsp;<span class="keyword" id="3467915">else</span>&nbsp;<span class="keyword" id="3467920">if</span>&nbsp;<span class="ident" id="3467923">err</span>&nbsp;<span class="op" id="3467927">==</span>&nbsp;<span class="ident" id="3467930">io</span><span class="op" id="3467932">.</span><span class="ident" id="3467933">EOF</span>&nbsp;<span class="op" id="3467937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3467943">break</span>&nbsp;<span class="comment" id="3467949">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3467967">}</span>&nbsp;<span class="keyword" id="3467969">else</span>&nbsp;<span class="keyword" id="3467974">if</span>&nbsp;<span class="ident" id="3467977">neterr</span><span class="op" id="3467983">,</span>&nbsp;<span class="ident" id="3467985">ok</span>&nbsp;<span class="op" id="3467988">:=</span>&nbsp;<span class="ident" id="3467991">err</span><span class="op" id="3467994">.</span><span class="op" id="3467995">(</span><span class="ident" id="3467996">net</span><span class="op" id="3467999">.</span><span class="ident" id="3468000">Error</span><span class="op" id="3468005">)</span><span class="op" id="3468006">;</span>&nbsp;<span class="ident" id="3468008">ok</span>&nbsp;<span class="op" id="3468011">&amp;&amp;</span>&nbsp;<span class="ident" id="3468014">neterr</span><span class="op" id="3468020">.</span><span class="ident" id="3468021">Timeout</span><span class="op" id="3468028">(</span><span class="op" id="3468029">)</span>&nbsp;<span class="op" id="3468031">{</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3468037">break</span>&nbsp;<span class="comment" id="3468043">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3468061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468066">io</span><span class="op" id="3468068">.</span><span class="ident" id="3468069">WriteString</span><span class="op" id="3468080">(</span><span class="ident" id="3468081">c</span><span class="op" id="3468082">.</span><span class="ident" id="3468083">rwc</span><span class="op" id="3468086">,</span>&nbsp;<span class="string" id="3468088">&#34;HTTP/1.1&nbsp;400&nbsp;Bad&nbsp;Request\r\n\r\n&#34;</span><span class="op" id="3468122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3468127">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3468135">}</span><br>
<span class="lineno">1185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3468140">//&nbsp;Expect&nbsp;100&nbsp;Continue&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468173">req</span>&nbsp;<span class="op" id="3468177">:=</span>&nbsp;<span class="ident" id="3468180">w</span><span class="op" id="3468181">.</span><span class="ident" id="3468182">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3468188">if</span>&nbsp;<span class="ident" id="3468191">req</span><span class="op" id="3468194">.</span><span class="ident" id="3468195">expectsContinue</span><span class="op" id="3468210">(</span><span class="op" id="3468211">)</span>&nbsp;<span class="op" id="3468213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3468218">if</span>&nbsp;<span class="ident" id="3468221">req</span><span class="op" id="3468224">.</span><span class="ident" id="3468225">ProtoAtLeast</span><span class="op" id="3468237">(</span><span class="num" id="3468238">1</span><span class="op" id="3468239">,</span>&nbsp;<span class="num" id="3468241">1</span><span class="op" id="3468242">)</span>&nbsp;<span class="op" id="3468244">&amp;&amp;</span>&nbsp;<span class="ident" id="3468247">req</span><span class="op" id="3468250">.</span><span class="ident" id="3468251">ContentLength</span>&nbsp;<span class="op" id="3468265">!=</span>&nbsp;<span class="num" id="3468268">0</span>&nbsp;<span class="op" id="3468270">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3468276">//&nbsp;Wrap&nbsp;the&nbsp;Body&nbsp;reader&nbsp;with&nbsp;one&nbsp;that&nbsp;replies&nbsp;on&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468344">req</span><span class="op" id="3468347">.</span><span class="ident" id="3468348">Body</span>&nbsp;<span class="op" id="3468353">=</span>&nbsp;<span class="op" id="3468355">&amp;</span><span class="ident" id="3468356">expectContinueReader</span><span class="op" id="3468376">{</span><span class="ident" id="3468377">readCloser</span><span class="op" id="3468387">:</span>&nbsp;<span class="ident" id="3468389">req</span><span class="op" id="3468392">.</span><span class="ident" id="3468393">Body</span><span class="op" id="3468397">,</span>&nbsp;<span class="ident" id="3468399">resp</span><span class="op" id="3468403">:</span>&nbsp;<span class="ident" id="3468405">w</span><span class="op" id="3468406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3468411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468416">req</span><span class="op" id="3468419">.</span><span class="ident" id="3468420">Header</span><span class="op" id="3468426">.</span><span class="ident" id="3468427">Del</span><span class="op" id="3468430">(</span><span class="string" id="3468431">&#34;Expect&#34;</span><span class="op" id="3468439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3468443">}</span>&nbsp;<span class="keyword" id="3468445">else</span>&nbsp;<span class="keyword" id="3468450">if</span>&nbsp;<span class="ident" id="3468453">req</span><span class="op" id="3468456">.</span><span class="ident" id="3468457">Header</span><span class="op" id="3468463">.</span><span class="ident" id="3468464">get</span><span class="op" id="3468467">(</span><span class="string" id="3468468">&#34;Expect&#34;</span><span class="op" id="3468476">)</span>&nbsp;<span class="op" id="3468478">!=</span>&nbsp;<span class="string" id="3468481">&#34;&#34;</span>&nbsp;<span class="op" id="3468484">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468489">w</span><span class="op" id="3468490">.</span><span class="ident" id="3468491">sendExpectationFailed</span><span class="op" id="3468512">(</span><span class="op" id="3468513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3468518">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3468526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3468531">//&nbsp;HTTP&nbsp;cannot&nbsp;have&nbsp;multiple&nbsp;simultaneous&nbsp;active&nbsp;requests.[*]</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3468595">//&nbsp;Until&nbsp;the&nbsp;server&nbsp;replies&nbsp;to&nbsp;this&nbsp;request,&nbsp;it&nbsp;can&#39;t&nbsp;read&nbsp;another,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3468665">//&nbsp;so&nbsp;we&nbsp;might&nbsp;as&nbsp;well&nbsp;run&nbsp;the&nbsp;handler&nbsp;in&nbsp;this&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3468725">//&nbsp;[*]&nbsp;Not&nbsp;strictly&nbsp;true:&nbsp;HTTP&nbsp;pipelining.&nbsp;&nbsp;We&nbsp;could&nbsp;let&nbsp;them&nbsp;all&nbsp;process</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3468801">//&nbsp;in&nbsp;parallel&nbsp;even&nbsp;if&nbsp;their&nbsp;responses&nbsp;need&nbsp;to&nbsp;be&nbsp;serialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468865">serverHandler</span><span class="op" id="3468878">{</span><span class="ident" id="3468879">c</span><span class="op" id="3468880">.</span><span class="ident" id="3468881">server</span><span class="op" id="3468887">}</span><span class="op" id="3468888">.</span><span class="ident" id="3468889">ServeHTTP</span><span class="op" id="3468898">(</span><span class="ident" id="3468899">w</span><span class="op" id="3468900">,</span>&nbsp;<span class="ident" id="3468902">w</span><span class="op" id="3468903">.</span><span class="ident" id="3468904">req</span><span class="op" id="3468907">)</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3468911">if</span>&nbsp;<span class="ident" id="3468914">c</span><span class="op" id="3468915">.</span><span class="ident" id="3468916">hijacked</span><span class="op" id="3468924">(</span><span class="op" id="3468925">)</span>&nbsp;<span class="op" id="3468927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3468932">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3468941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3468945">w</span><span class="op" id="3468946">.</span><span class="ident" id="3468947">finishRequest</span><span class="op" id="3468960">(</span><span class="op" id="3468961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3468965">if</span>&nbsp;<span class="ident" id="3468968">w</span><span class="op" id="3468969">.</span><span class="ident" id="3468970">closeAfterReply</span>&nbsp;<span class="op" id="3468986">{</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3468991">if</span>&nbsp;<span class="ident" id="3468994">w</span><span class="op" id="3468995">.</span><span class="ident" id="3468996">requestBodyLimitHit</span>&nbsp;<span class="op" id="3469016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3469022">c</span><span class="op" id="3469023">.</span><span class="ident" id="3469024">closeWriteAndWait</span><span class="op" id="3469041">(</span><span class="op" id="3469042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3469047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469052">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3469060">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3469064">c</span><span class="op" id="3469065">.</span><span class="ident" id="3469066">setState</span><span class="op" id="3469074">(</span><span class="ident" id="3469075">c</span><span class="op" id="3469076">.</span><span class="ident" id="3469077">rwc</span><span class="op" id="3469080">,</span>&nbsp;<span class="ident" id="3469082">StateIdle</span><span class="op" id="3469091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3469094">}</span><br>
<span class="lineno"></span><span class="op" id="3469096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3469099">func</span>&nbsp;<span class="op" id="3469104">(</span><span class="ident" id="3469105">w</span>&nbsp;<span class="op" id="3469107">*</span><span class="ident" id="3469108">response</span><span class="op" id="3469116">)</span>&nbsp;<span class="ident" id="3469118">sendExpectationFailed</span><span class="op" id="3469139">(</span><span class="op" id="3469140">)</span>&nbsp;<span class="op" id="3469142">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3469145">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;ServeHTTP&nbsp;handlers&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3469195">//&nbsp;requests&nbsp;with&nbsp;non-standard&nbsp;expectation[s]?&nbsp;Seems</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3469248">//&nbsp;theoretical&nbsp;at&nbsp;best,&nbsp;and&nbsp;doesn&#39;t&nbsp;fit&nbsp;into&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3469298">//&nbsp;current&nbsp;ServeHTTP&nbsp;model&nbsp;anyway.&nbsp;&nbsp;We&#39;d&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3469348">//&nbsp;make&nbsp;the&nbsp;ResponseWriter&nbsp;an&nbsp;optional</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3469388">//&nbsp;&#34;ExpectReplier&#34;&nbsp;interface&nbsp;or&nbsp;something.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3469432">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3469436">//&nbsp;For&nbsp;now&nbsp;we&#39;ll&nbsp;just&nbsp;obey&nbsp;RFC&nbsp;2616&nbsp;14.20&nbsp;which&nbsp;says</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3469490">//&nbsp;&#34;If&nbsp;a&nbsp;server&nbsp;receives&nbsp;a&nbsp;request&nbsp;containing&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3469540">//&nbsp;Expect&nbsp;field&nbsp;that&nbsp;includes&nbsp;an&nbsp;expectation-</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3469587">//&nbsp;extension&nbsp;that&nbsp;it&nbsp;does&nbsp;not&nbsp;support,&nbsp;it&nbsp;MUST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3469635">//&nbsp;respond&nbsp;with&nbsp;a&nbsp;417&nbsp;(Expectation&nbsp;Failed)&nbsp;status.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3469688">w</span><span class="op" id="3469689">.</span><span class="ident" id="3469690">Header</span><span class="op" id="3469696">(</span><span class="op" id="3469697">)</span><span class="op" id="3469698">.</span><span class="ident" id="3469699">Set</span><span class="op" id="3469702">(</span><span class="string" id="3469703">&#34;Connection&#34;</span><span class="op" id="3469715">,</span>&nbsp;<span class="string" id="3469717">&#34;close&#34;</span><span class="op" id="3469724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3469727">w</span><span class="op" id="3469728">.</span><span class="ident" id="3469729">WriteHeader</span><span class="op" id="3469740">(</span><span class="ident" id="3469741">StatusExpectationFailed</span><span class="op" id="3469764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3469767">w</span><span class="op" id="3469768">.</span><span class="ident" id="3469769">finishRequest</span><span class="op" id="3469782">(</span><span class="op" id="3469783">)</span><br>
<span class="lineno">1235</span><span class="op" id="3469785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3469788">//&nbsp;Hijack&nbsp;implements&nbsp;the&nbsp;Hijacker.Hijack&nbsp;method.&nbsp;Our&nbsp;response&nbsp;is&nbsp;both&nbsp;a&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="3469875">//&nbsp;and&nbsp;a&nbsp;Hijacker.</span><br>
<span class="lineno"></span><span class="keyword" id="3469894">func</span>&nbsp;<span class="op" id="3469899">(</span><span class="ident" id="3469900">w</span>&nbsp;<span class="op" id="3469902">*</span><span class="ident" id="3469903">response</span><span class="op" id="3469911">)</span>&nbsp;<span class="ident" id="3469913">Hijack</span><span class="op" id="3469919">(</span><span class="op" id="3469920">)</span>&nbsp;<span class="op" id="3469922">(</span><span class="ident" id="3469923">rwc</span>&nbsp;<span class="ident" id="3469927">net</span><span class="op" id="3469930">.</span><span class="ident" id="3469931">Conn</span><span class="op" id="3469935">,</span>&nbsp;<span class="ident" id="3469937">buf</span>&nbsp;<span class="op" id="3469941">*</span><span class="ident" id="3469942">bufio</span><span class="op" id="3469947">.</span><span class="ident" id="3469948">ReadWriter</span><span class="op" id="3469958">,</span>&nbsp;<span class="ident" id="3469960">err</span>&nbsp;<span class="builtintype" id="3469964">error</span><span class="op" id="3469969">)</span>&nbsp;<span class="op" id="3469971">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3469974">if</span>&nbsp;<span class="ident" id="3469977">w</span><span class="op" id="3469978">.</span><span class="ident" id="3469979">wroteHeader</span>&nbsp;<span class="op" id="3469991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3469995">w</span><span class="op" id="3469996">.</span><span class="ident" id="3469997">cw</span><span class="op" id="3469999">.</span><span class="ident" id="3470000">flush</span><span class="op" id="3470005">(</span><span class="op" id="3470006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3470009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3470012">//&nbsp;Release&nbsp;the&nbsp;bufioWriter&nbsp;that&nbsp;writes&nbsp;to&nbsp;the&nbsp;chunk&nbsp;writer,&nbsp;it&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3470083">//&nbsp;used&nbsp;after&nbsp;a&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked.</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3470130">rwc</span><span class="op" id="3470133">,</span>&nbsp;<span class="ident" id="3470135">buf</span><span class="op" id="3470138">,</span>&nbsp;<span class="ident" id="3470140">err</span>&nbsp;<span class="op" id="3470144">=</span>&nbsp;<span class="ident" id="3470146">w</span><span class="op" id="3470147">.</span><span class="ident" id="3470148">conn</span><span class="op" id="3470152">.</span><span class="ident" id="3470153">hijack</span><span class="op" id="3470159">(</span><span class="op" id="3470160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470163">if</span>&nbsp;<span class="ident" id="3470166">err</span>&nbsp;<span class="op" id="3470170">==</span>&nbsp;<span class="ident" id="3470173">nil</span>&nbsp;<span class="op" id="3470177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3470181">putBufioWriter</span><span class="op" id="3470195">(</span><span class="ident" id="3470196">w</span><span class="op" id="3470197">.</span><span class="ident" id="3470198">w</span><span class="op" id="3470199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3470203">w</span><span class="op" id="3470204">.</span><span class="ident" id="3470205">w</span>&nbsp;<span class="op" id="3470207">=</span>&nbsp;<span class="ident" id="3470209">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3470214">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470217">return</span>&nbsp;<span class="ident" id="3470224">rwc</span><span class="op" id="3470227">,</span>&nbsp;<span class="ident" id="3470229">buf</span><span class="op" id="3470232">,</span>&nbsp;<span class="ident" id="3470234">err</span><br>
<span class="lineno"></span><span class="op" id="3470238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3470241">func</span>&nbsp;<span class="op" id="3470246">(</span><span class="ident" id="3470247">w</span>&nbsp;<span class="op" id="3470249">*</span><span class="ident" id="3470250">response</span><span class="op" id="3470258">)</span>&nbsp;<span class="ident" id="3470260">CloseNotify</span><span class="op" id="3470271">(</span><span class="op" id="3470272">)</span>&nbsp;<span class="op" id="3470274">&lt;-</span><span class="keyword" id="3470276">chan</span>&nbsp;<span class="builtintype" id="3470281">bool</span>&nbsp;<span class="op" id="3470286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3470289">return</span>&nbsp;<span class="ident" id="3470296">w</span><span class="op" id="3470297">.</span><span class="ident" id="3470298">conn</span><span class="op" id="3470302">.</span><span class="ident" id="3470303">closeNotify</span><span class="op" id="3470314">(</span><span class="op" id="3470315">)</span><br>
<span class="lineno">1255</span><span class="op" id="3470317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3470320">//&nbsp;The&nbsp;HandlerFunc&nbsp;type&nbsp;is&nbsp;an&nbsp;adapter&nbsp;to&nbsp;allow&nbsp;the&nbsp;use&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3470378">//&nbsp;ordinary&nbsp;functions&nbsp;as&nbsp;HTTP&nbsp;handlers.&nbsp;&nbsp;If&nbsp;f&nbsp;is&nbsp;a&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="3470438">//&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;signature,&nbsp;HandlerFunc(f)&nbsp;is&nbsp;a</span><br>
<span class="lineno">1260</span><span class="comment" id="3470493">//&nbsp;Handler&nbsp;object&nbsp;that&nbsp;calls&nbsp;f.</span><br>
<span class="lineno"></span><span class="keyword" id="3470525">type</span>&nbsp;<span class="ident" id="3470530">HandlerFunc</span>&nbsp;<span class="keyword" id="3470542">func</span><span class="op" id="3470546">(</span><span class="ident" id="3470547">ResponseWriter</span><span class="op" id="3470561">,</span>&nbsp;<span class="op" id="3470563">*</span><span class="ident" id="3470564">Request</span><span class="op" id="3470571">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3470574">//&nbsp;ServeHTTP&nbsp;calls&nbsp;f(w,&nbsp;r).</span><br>
<span class="lineno"></span><span class="keyword" id="3470602">func</span>&nbsp;<span class="op" id="3470607">(</span><span class="ident" id="3470608">f</span>&nbsp;<span class="ident" id="3470610">HandlerFunc</span><span class="op" id="3470621">)</span>&nbsp;<span class="ident" id="3470623">ServeHTTP</span><span class="op" id="3470632">(</span><span class="ident" id="3470633">w</span>&nbsp;<span class="ident" id="3470635">ResponseWriter</span><span class="op" id="3470649">,</span>&nbsp;<span class="ident" id="3470651">r</span>&nbsp;<span class="op" id="3470653">*</span><span class="ident" id="3470654">Request</span><span class="op" id="3470661">)</span>&nbsp;<span class="op" id="3470663">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3470666">f</span><span class="op" id="3470667">(</span><span class="ident" id="3470668">w</span><span class="op" id="3470669">,</span>&nbsp;<span class="ident" id="3470671">r</span><span class="op" id="3470672">)</span><br>
<span class="lineno"></span><span class="op" id="3470674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3470677">//&nbsp;Helper&nbsp;handlers</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="3470697">//&nbsp;Error&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;specified&nbsp;error&nbsp;message&nbsp;and&nbsp;HTTP&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment" id="3470777">//&nbsp;The&nbsp;error&nbsp;message&nbsp;should&nbsp;be&nbsp;plain&nbsp;text.</span><br>
<span class="lineno"></span><span class="keyword" id="3470820">func</span>&nbsp;<span class="ident" id="3470825">Error</span><span class="op" id="3470830">(</span><span class="ident" id="3470831">w</span>&nbsp;<span class="ident" id="3470833">ResponseWriter</span><span class="op" id="3470847">,</span>&nbsp;<span class="builtintype" id="3470849">error</span>&nbsp;<span class="builtintype" id="3470855">string</span><span class="op" id="3470861">,</span>&nbsp;<span class="ident" id="3470863">code</span>&nbsp;<span class="builtintype" id="3470868">int</span><span class="op" id="3470871">)</span>&nbsp;<span class="op" id="3470873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3470876">w</span><span class="op" id="3470877">.</span><span class="ident" id="3470878">Header</span><span class="op" id="3470884">(</span><span class="op" id="3470885">)</span><span class="op" id="3470886">.</span><span class="ident" id="3470887">Set</span><span class="op" id="3470890">(</span><span class="string" id="3470891">&#34;Content-Type&#34;</span><span class="op" id="3470905">,</span>&nbsp;<span class="string" id="3470907">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="3470934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3470937">w</span><span class="op" id="3470938">.</span><span class="ident" id="3470939">WriteHeader</span><span class="op" id="3470950">(</span><span class="ident" id="3470951">code</span><span class="op" id="3470955">)</span><br>
<span class="lineno">1275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3470958">fmt</span><span class="op" id="3470961">.</span><span class="ident" id="3470962">Fprintln</span><span class="op" id="3470970">(</span><span class="ident" id="3470971">w</span><span class="op" id="3470972">,</span>&nbsp;<span class="builtintype" id="3470974">error</span><span class="op" id="3470979">)</span><br>
<span class="lineno"></span><span class="op" id="3470981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3470984">//&nbsp;NotFound&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3471053">func</span>&nbsp;<span class="ident" id="3471058">NotFound</span><span class="op" id="3471066">(</span><span class="ident" id="3471067">w</span>&nbsp;<span class="ident" id="3471069">ResponseWriter</span><span class="op" id="3471083">,</span>&nbsp;<span class="ident" id="3471085">r</span>&nbsp;<span class="op" id="3471087">*</span><span class="ident" id="3471088">Request</span><span class="op" id="3471095">)</span>&nbsp;<span class="op" id="3471097">{</span>&nbsp;<span class="ident" id="3471099">Error</span><span class="op" id="3471104">(</span><span class="ident" id="3471105">w</span><span class="op" id="3471106">,</span>&nbsp;<span class="string" id="3471108">&#34;404&nbsp;page&nbsp;not&nbsp;found&#34;</span><span class="op" id="3471128">,</span>&nbsp;<span class="ident" id="3471130">StatusNotFound</span><span class="op" id="3471144">)</span>&nbsp;<span class="op" id="3471146">}</span><br>
<span class="lineno">1280</span><br>
<span class="lineno"></span><span class="comment" id="3471149">//&nbsp;NotFoundHandler&nbsp;returns&nbsp;a&nbsp;simple&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="3471201">//&nbsp;that&nbsp;replies&nbsp;to&nbsp;each&nbsp;request&nbsp;with&nbsp;a&nbsp;``404&nbsp;page&nbsp;not&nbsp;found&#39;&#39;&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="3471270">func</span>&nbsp;<span class="ident" id="3471275">NotFoundHandler</span><span class="op" id="3471290">(</span><span class="op" id="3471291">)</span>&nbsp;<span class="ident" id="3471293">Handler</span>&nbsp;<span class="op" id="3471301">{</span>&nbsp;<span class="keyword" id="3471303">return</span>&nbsp;<span class="ident" id="3471310">HandlerFunc</span><span class="op" id="3471321">(</span><span class="ident" id="3471322">NotFound</span><span class="op" id="3471330">)</span>&nbsp;<span class="op" id="3471332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span><span class="comment" id="3471335">//&nbsp;StripPrefix&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3471394">//&nbsp;by&nbsp;removing&nbsp;the&nbsp;given&nbsp;prefix&nbsp;from&nbsp;the&nbsp;request&nbsp;URL&#39;s&nbsp;Path</span><br>
<span class="lineno"></span><span class="comment" id="3471454">//&nbsp;and&nbsp;invoking&nbsp;the&nbsp;handler&nbsp;h.&nbsp;StripPrefix&nbsp;handles&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3471507">//&nbsp;request&nbsp;for&nbsp;a&nbsp;path&nbsp;that&nbsp;doesn&#39;t&nbsp;begin&nbsp;with&nbsp;prefix&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3471563">//&nbsp;replying&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno">1290</span><span class="keyword" id="3471609">func</span>&nbsp;<span class="ident" id="3471614">StripPrefix</span><span class="op" id="3471625">(</span><span class="ident" id="3471626">prefix</span>&nbsp;<span class="builtintype" id="3471633">string</span><span class="op" id="3471639">,</span>&nbsp;<span class="ident" id="3471641">h</span>&nbsp;<span class="ident" id="3471643">Handler</span><span class="op" id="3471650">)</span>&nbsp;<span class="ident" id="3471652">Handler</span>&nbsp;<span class="op" id="3471660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471663">if</span>&nbsp;<span class="ident" id="3471666">prefix</span>&nbsp;<span class="op" id="3471673">==</span>&nbsp;<span class="string" id="3471676">&#34;&#34;</span>&nbsp;<span class="op" id="3471679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471683">return</span>&nbsp;<span class="ident" id="3471690">h</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3471693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471696">return</span>&nbsp;<span class="ident" id="3471703">HandlerFunc</span><span class="op" id="3471714">(</span><span class="keyword" id="3471715">func</span><span class="op" id="3471719">(</span><span class="ident" id="3471720">w</span>&nbsp;<span class="ident" id="3471722">ResponseWriter</span><span class="op" id="3471736">,</span>&nbsp;<span class="ident" id="3471738">r</span>&nbsp;<span class="op" id="3471740">*</span><span class="ident" id="3471741">Request</span><span class="op" id="3471748">)</span>&nbsp;<span class="op" id="3471750">{</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3471754">if</span>&nbsp;<span class="ident" id="3471757">p</span>&nbsp;<span class="op" id="3471759">:=</span>&nbsp;<span class="ident" id="3471762">strings</span><span class="op" id="3471769">.</span><span class="ident" id="3471770">TrimPrefix</span><span class="op" id="3471780">(</span><span class="ident" id="3471781">r</span><span class="op" id="3471782">.</span><span class="ident" id="3471783">URL</span><span class="op" id="3471786">.</span><span class="ident" id="3471787">Path</span><span class="op" id="3471791">,</span>&nbsp;<span class="ident" id="3471793">prefix</span><span class="op" id="3471799">)</span><span class="op" id="3471800">;</span>&nbsp;<span class="builtinfunc" id="3471802">len</span><span class="op" id="3471805">(</span><span class="ident" id="3471806">p</span><span class="op" id="3471807">)</span>&nbsp;<span class="op" id="3471809">&lt;</span>&nbsp;<span class="builtinfunc" id="3471811">len</span><span class="op" id="3471814">(</span><span class="ident" id="3471815">r</span><span class="op" id="3471816">.</span><span class="ident" id="3471817">URL</span><span class="op" id="3471820">.</span><span class="ident" id="3471821">Path</span><span class="op" id="3471825">)</span>&nbsp;<span class="op" id="3471827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3471832">r</span><span class="op" id="3471833">.</span><span class="ident" id="3471834">URL</span><span class="op" id="3471837">.</span><span class="ident" id="3471838">Path</span>&nbsp;<span class="op" id="3471843">=</span>&nbsp;<span class="ident" id="3471845">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3471850">h</span><span class="op" id="3471851">.</span><span class="ident" id="3471852">ServeHTTP</span><span class="op" id="3471861">(</span><span class="ident" id="3471862">w</span><span class="op" id="3471863">,</span>&nbsp;<span class="ident" id="3471865">r</span><span class="op" id="3471866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3471870">}</span>&nbsp;<span class="keyword" id="3471872">else</span>&nbsp;<span class="op" id="3471877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3471882">NotFound</span><span class="op" id="3471890">(</span><span class="ident" id="3471891">w</span><span class="op" id="3471892">,</span>&nbsp;<span class="ident" id="3471894">r</span><span class="op" id="3471895">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3471899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3471902">}</span><span class="op" id="3471903">)</span><br>
<span class="lineno"></span><span class="op" id="3471905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3471908">//&nbsp;Redirect&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;a&nbsp;redirect&nbsp;to&nbsp;url,</span><br>
<span class="lineno">1305</span><span class="comment" id="3471967">//&nbsp;which&nbsp;may&nbsp;be&nbsp;a&nbsp;path&nbsp;relative&nbsp;to&nbsp;the&nbsp;request&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="3472020">func</span>&nbsp;<span class="ident" id="3472025">Redirect</span><span class="op" id="3472033">(</span><span class="ident" id="3472034">w</span>&nbsp;<span class="ident" id="3472036">ResponseWriter</span><span class="op" id="3472050">,</span>&nbsp;<span class="ident" id="3472052">r</span>&nbsp;<span class="op" id="3472054">*</span><span class="ident" id="3472055">Request</span><span class="op" id="3472062">,</span>&nbsp;<span class="ident" id="3472064">urlStr</span>&nbsp;<span class="builtintype" id="3472071">string</span><span class="op" id="3472077">,</span>&nbsp;<span class="ident" id="3472079">code</span>&nbsp;<span class="builtintype" id="3472084">int</span><span class="op" id="3472087">)</span>&nbsp;<span class="op" id="3472089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472092">if</span>&nbsp;<span class="ident" id="3472095">u</span><span class="op" id="3472096">,</span>&nbsp;<span class="ident" id="3472098">err</span>&nbsp;<span class="op" id="3472102">:=</span>&nbsp;<span class="ident" id="3472105">url</span><span class="op" id="3472108">.</span><span class="ident" id="3472109">Parse</span><span class="op" id="3472114">(</span><span class="ident" id="3472115">urlStr</span><span class="op" id="3472121">)</span><span class="op" id="3472122">;</span>&nbsp;<span class="ident" id="3472124">err</span>&nbsp;<span class="op" id="3472128">==</span>&nbsp;<span class="ident" id="3472131">nil</span>&nbsp;<span class="op" id="3472135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3472139">//&nbsp;If&nbsp;url&nbsp;was&nbsp;relative,&nbsp;make&nbsp;absolute&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3472182">//&nbsp;combining&nbsp;with&nbsp;request&nbsp;path.</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3472216">//&nbsp;The&nbsp;browser&nbsp;would&nbsp;probably&nbsp;do&nbsp;this&nbsp;for&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3472264">//&nbsp;but&nbsp;doing&nbsp;it&nbsp;ourselves&nbsp;is&nbsp;more&nbsp;reliable.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3472311">//&nbsp;NOTE(rsc):&nbsp;RFC&nbsp;2616&nbsp;says&nbsp;that&nbsp;the&nbsp;Location</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3472359">//&nbsp;line&nbsp;must&nbsp;be&nbsp;an&nbsp;absolute&nbsp;URI,&nbsp;like</span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3472399">//&nbsp;&#34;http://www.google.com/redirect/&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3472439">//&nbsp;not&nbsp;a&nbsp;path&nbsp;like&nbsp;&#34;/redirect/&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3472474">//&nbsp;Unfortunately,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;what&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3472516">//&nbsp;put&nbsp;in&nbsp;the&nbsp;host&nbsp;name&nbsp;section&nbsp;to&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3472561">//&nbsp;client&nbsp;to&nbsp;connect&nbsp;to&nbsp;us&nbsp;again,&nbsp;so&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3472609">//&nbsp;know&nbsp;the&nbsp;right&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;send&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3472656">//&nbsp;Because&nbsp;of&nbsp;this&nbsp;problem,&nbsp;no&nbsp;one&nbsp;pays&nbsp;attention</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3472708">//&nbsp;to&nbsp;the&nbsp;RFC;&nbsp;they&nbsp;all&nbsp;send&nbsp;back&nbsp;just&nbsp;a&nbsp;new&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3472761">//&nbsp;So&nbsp;do&nbsp;we.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472776">oldpath</span>&nbsp;<span class="op" id="3472784">:=</span>&nbsp;<span class="ident" id="3472787">r</span><span class="op" id="3472788">.</span><span class="ident" id="3472789">URL</span><span class="op" id="3472792">.</span><span class="ident" id="3472793">Path</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472800">if</span>&nbsp;<span class="ident" id="3472803">oldpath</span>&nbsp;<span class="op" id="3472811">==</span>&nbsp;<span class="string" id="3472814">&#34;&#34;</span>&nbsp;<span class="op" id="3472817">{</span>&nbsp;<span class="comment" id="3472819">//&nbsp;should&nbsp;not&nbsp;happen,&nbsp;but&nbsp;avoid&nbsp;a&nbsp;crash&nbsp;if&nbsp;it&nbsp;does</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3472873">oldpath</span>&nbsp;<span class="op" id="3472881">=</span>&nbsp;<span class="string" id="3472883">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3472889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472893">if</span>&nbsp;<span class="ident" id="3472896">u</span><span class="op" id="3472897">.</span><span class="ident" id="3472898">Scheme</span>&nbsp;<span class="op" id="3472905">==</span>&nbsp;<span class="string" id="3472908">&#34;&#34;</span>&nbsp;<span class="op" id="3472911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3472916">//&nbsp;no&nbsp;leading&nbsp;http://server</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3472947">if</span>&nbsp;<span class="ident" id="3472950">urlStr</span>&nbsp;<span class="op" id="3472957">==</span>&nbsp;<span class="string" id="3472960">&#34;&#34;</span>&nbsp;<span class="op" id="3472963">||</span>&nbsp;<span class="ident" id="3472966">urlStr</span><span class="op" id="3472972">[</span><span class="num" id="3472973">0</span><span class="op" id="3472974">]</span>&nbsp;<span class="op" id="3472976">!=</span>&nbsp;<span class="string" id="3472979">&#39;/&#39;</span>&nbsp;<span class="op" id="3472983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3472989">//&nbsp;make&nbsp;relative&nbsp;path&nbsp;absolute</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473024">olddir</span><span class="op" id="3473030">,</span>&nbsp;<span class="ident" id="3473032">_</span>&nbsp;<span class="op" id="3473034">:=</span>&nbsp;<span class="ident" id="3473037">path</span><span class="op" id="3473041">.</span><span class="ident" id="3473042">Split</span><span class="op" id="3473047">(</span><span class="ident" id="3473048">oldpath</span><span class="op" id="3473055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473061">urlStr</span>&nbsp;<span class="op" id="3473068">=</span>&nbsp;<span class="ident" id="3473070">olddir</span>&nbsp;<span class="op" id="3473077">+</span>&nbsp;<span class="ident" id="3473079">urlStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473089">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3473095">var</span>&nbsp;<span class="ident" id="3473099">query</span>&nbsp;<span class="builtintype" id="3473105">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3473115">if</span>&nbsp;<span class="ident" id="3473118">i</span>&nbsp;<span class="op" id="3473120">:=</span>&nbsp;<span class="ident" id="3473123">strings</span><span class="op" id="3473130">.</span><span class="ident" id="3473131">Index</span><span class="op" id="3473136">(</span><span class="ident" id="3473137">urlStr</span><span class="op" id="3473143">,</span>&nbsp;<span class="string" id="3473145">&#34;?&#34;</span><span class="op" id="3473148">)</span><span class="op" id="3473149">;</span>&nbsp;<span class="ident" id="3473151">i</span>&nbsp;<span class="op" id="3473153">!=</span>&nbsp;<span class="op" id="3473156">-</span><span class="num" id="3473157">1</span>&nbsp;<span class="op" id="3473159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473165">urlStr</span><span class="op" id="3473171">,</span>&nbsp;<span class="ident" id="3473173">query</span>&nbsp;<span class="op" id="3473179">=</span>&nbsp;<span class="ident" id="3473181">urlStr</span><span class="op" id="3473187">[</span><span class="op" id="3473188">:</span><span class="ident" id="3473189">i</span><span class="op" id="3473190">]</span><span class="op" id="3473191">,</span>&nbsp;<span class="ident" id="3473193">urlStr</span><span class="op" id="3473199">[</span><span class="ident" id="3473200">i</span><span class="op" id="3473201">:</span><span class="op" id="3473202">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473207">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3473213">//&nbsp;clean&nbsp;up&nbsp;but&nbsp;preserve&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473256">trailing</span>&nbsp;<span class="op" id="3473265">:=</span>&nbsp;<span class="ident" id="3473268">strings</span><span class="op" id="3473275">.</span><span class="ident" id="3473276">HasSuffix</span><span class="op" id="3473285">(</span><span class="ident" id="3473286">urlStr</span><span class="op" id="3473292">,</span>&nbsp;<span class="string" id="3473294">&#34;/&#34;</span><span class="op" id="3473297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473302">urlStr</span>&nbsp;<span class="op" id="3473309">=</span>&nbsp;<span class="ident" id="3473311">path</span><span class="op" id="3473315">.</span><span class="ident" id="3473316">Clean</span><span class="op" id="3473321">(</span><span class="ident" id="3473322">urlStr</span><span class="op" id="3473328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3473333">if</span>&nbsp;<span class="ident" id="3473336">trailing</span>&nbsp;<span class="op" id="3473345">&amp;&amp;</span>&nbsp;<span class="op" id="3473348">!</span><span class="ident" id="3473349">strings</span><span class="op" id="3473356">.</span><span class="ident" id="3473357">HasSuffix</span><span class="op" id="3473366">(</span><span class="ident" id="3473367">urlStr</span><span class="op" id="3473373">,</span>&nbsp;<span class="string" id="3473375">&#34;/&#34;</span><span class="op" id="3473378">)</span>&nbsp;<span class="op" id="3473380">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473386">urlStr</span>&nbsp;<span class="op" id="3473393">+=</span>&nbsp;<span class="string" id="3473396">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473408">urlStr</span>&nbsp;<span class="op" id="3473415">+=</span>&nbsp;<span class="ident" id="3473418">query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473429">}</span><br>
<span class="lineno">1350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473433">w</span><span class="op" id="3473434">.</span><span class="ident" id="3473435">Header</span><span class="op" id="3473441">(</span><span class="op" id="3473442">)</span><span class="op" id="3473443">.</span><span class="ident" id="3473444">Set</span><span class="op" id="3473447">(</span><span class="string" id="3473448">&#34;Location&#34;</span><span class="op" id="3473458">,</span>&nbsp;<span class="ident" id="3473460">urlStr</span><span class="op" id="3473466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473469">w</span><span class="op" id="3473470">.</span><span class="ident" id="3473471">WriteHeader</span><span class="op" id="3473482">(</span><span class="ident" id="3473483">code</span><span class="op" id="3473487">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3473491">//&nbsp;RFC2616&nbsp;recommends&nbsp;that&nbsp;a&nbsp;short&nbsp;note&nbsp;&#34;SHOULD&#34;&nbsp;be&nbsp;included&nbsp;in&nbsp;the</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3473560">//&nbsp;response&nbsp;because&nbsp;older&nbsp;user&nbsp;agents&nbsp;may&nbsp;not&nbsp;understand&nbsp;301/307.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3473627">//&nbsp;Shouldn&#39;t&nbsp;send&nbsp;the&nbsp;response&nbsp;for&nbsp;POST&nbsp;or&nbsp;HEAD;&nbsp;that&nbsp;leaves&nbsp;GET.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3473694">if</span>&nbsp;<span class="ident" id="3473697">r</span><span class="op" id="3473698">.</span><span class="ident" id="3473699">Method</span>&nbsp;<span class="op" id="3473706">==</span>&nbsp;<span class="string" id="3473709">&#34;GET&#34;</span>&nbsp;<span class="op" id="3473715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473719">note</span>&nbsp;<span class="op" id="3473724">:=</span>&nbsp;<span class="string" id="3473727">&#34;&lt;a&nbsp;href=\&#34;&#34;</span>&nbsp;<span class="op" id="3473740">+</span>&nbsp;<span class="ident" id="3473742">htmlEscape</span><span class="op" id="3473752">(</span><span class="ident" id="3473753">urlStr</span><span class="op" id="3473759">)</span>&nbsp;<span class="op" id="3473761">+</span>&nbsp;<span class="string" id="3473763">&#34;\&#34;&gt;&#34;</span>&nbsp;<span class="op" id="3473769">+</span>&nbsp;<span class="ident" id="3473771">statusText</span><span class="op" id="3473781">[</span><span class="ident" id="3473782">code</span><span class="op" id="3473786">]</span>&nbsp;<span class="op" id="3473788">+</span>&nbsp;<span class="string" id="3473790">&#34;&lt;/a&gt;.\n&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3473802">fmt</span><span class="op" id="3473805">.</span><span class="ident" id="3473806">Fprintln</span><span class="op" id="3473814">(</span><span class="ident" id="3473815">w</span><span class="op" id="3473816">,</span>&nbsp;<span class="ident" id="3473818">note</span><span class="op" id="3473822">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3473825">}</span><br>
<span class="lineno"></span><span class="op" id="3473827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3473830">var</span>&nbsp;<span class="ident" id="3473834">htmlReplacer</span>&nbsp;<span class="op" id="3473847">=</span>&nbsp;<span class="ident" id="3473849">strings</span><span class="op" id="3473856">.</span><span class="ident" id="3473857">NewReplacer</span><span class="op" id="3473868">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3473871">&#34;&amp;&#34;</span><span class="op" id="3473874">,</span>&nbsp;<span class="string" id="3473876">&#34;&amp;amp;&#34;</span><span class="op" id="3473883">,</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3473886">&#34;&lt;&#34;</span><span class="op" id="3473889">,</span>&nbsp;<span class="string" id="3473891">&#34;&amp;lt;&#34;</span><span class="op" id="3473897">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3473900">&#34;&gt;&#34;</span><span class="op" id="3473903">,</span>&nbsp;<span class="string" id="3473905">&#34;&amp;gt;&#34;</span><span class="op" id="3473911">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3473914">//&nbsp;&#34;&amp;#34;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;quot;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3473952">`&#34;`</span><span class="op" id="3473955">,</span>&nbsp;<span class="string" id="3473957">&#34;&amp;#34;&#34;</span><span class="op" id="3473964">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3473967">//&nbsp;&#34;&amp;#39;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;apos;&#34;&nbsp;and&nbsp;apos&nbsp;was&nbsp;not&nbsp;in&nbsp;HTML&nbsp;until&nbsp;HTML5.</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3474042">&#34;&#39;&#34;</span><span class="op" id="3474045">,</span>&nbsp;<span class="string" id="3474047">&#34;&amp;#39;&#34;</span><span class="op" id="3474054">,</span><br>
<span class="lineno"></span><span class="op" id="3474056">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3474059">func</span>&nbsp;<span class="ident" id="3474064">htmlEscape</span><span class="op" id="3474074">(</span><span class="ident" id="3474075">s</span>&nbsp;<span class="builtintype" id="3474077">string</span><span class="op" id="3474083">)</span>&nbsp;<span class="builtintype" id="3474085">string</span>&nbsp;<span class="op" id="3474092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474095">return</span>&nbsp;<span class="ident" id="3474102">htmlReplacer</span><span class="op" id="3474114">.</span><span class="ident" id="3474115">Replace</span><span class="op" id="3474122">(</span><span class="ident" id="3474123">s</span><span class="op" id="3474124">)</span><br>
<span class="lineno">1375</span><span class="op" id="3474126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3474129">//&nbsp;Redirect&nbsp;to&nbsp;a&nbsp;fixed&nbsp;URL</span><br>
<span class="lineno"></span><span class="keyword" id="3474156">type</span>&nbsp;<span class="ident" id="3474161">redirectHandler</span>&nbsp;<span class="keyword" id="3474177">struct</span>&nbsp;<span class="op" id="3474184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474187">url</span>&nbsp;&nbsp;<span class="builtintype" id="3474192">string</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474200">code</span>&nbsp;<span class="builtintype" id="3474205">int</span><br>
<span class="lineno"></span><span class="op" id="3474209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3474212">func</span>&nbsp;<span class="op" id="3474217">(</span><span class="ident" id="3474218">rh</span>&nbsp;<span class="op" id="3474221">*</span><span class="ident" id="3474222">redirectHandler</span><span class="op" id="3474237">)</span>&nbsp;<span class="ident" id="3474239">ServeHTTP</span><span class="op" id="3474248">(</span><span class="ident" id="3474249">w</span>&nbsp;<span class="ident" id="3474251">ResponseWriter</span><span class="op" id="3474265">,</span>&nbsp;<span class="ident" id="3474267">r</span>&nbsp;<span class="op" id="3474269">*</span><span class="ident" id="3474270">Request</span><span class="op" id="3474277">)</span>&nbsp;<span class="op" id="3474279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3474282">Redirect</span><span class="op" id="3474290">(</span><span class="ident" id="3474291">w</span><span class="op" id="3474292">,</span>&nbsp;<span class="ident" id="3474294">r</span><span class="op" id="3474295">,</span>&nbsp;<span class="ident" id="3474297">rh</span><span class="op" id="3474299">.</span><span class="ident" id="3474300">url</span><span class="op" id="3474303">,</span>&nbsp;<span class="ident" id="3474305">rh</span><span class="op" id="3474307">.</span><span class="ident" id="3474308">code</span><span class="op" id="3474312">)</span><br>
<span class="lineno">1385</span><span class="op" id="3474314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3474317">//&nbsp;RedirectHandler&nbsp;returns&nbsp;a&nbsp;request&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno"></span><span class="comment" id="3474377">//&nbsp;each&nbsp;request&nbsp;it&nbsp;receives&nbsp;to&nbsp;the&nbsp;given&nbsp;url&nbsp;using&nbsp;the&nbsp;given</span><br>
<span class="lineno"></span><span class="comment" id="3474438">//&nbsp;status&nbsp;code.</span><br>
<span class="lineno">1390</span><span class="keyword" id="3474454">func</span>&nbsp;<span class="ident" id="3474459">RedirectHandler</span><span class="op" id="3474474">(</span><span class="ident" id="3474475">url</span>&nbsp;<span class="builtintype" id="3474479">string</span><span class="op" id="3474485">,</span>&nbsp;<span class="ident" id="3474487">code</span>&nbsp;<span class="builtintype" id="3474492">int</span><span class="op" id="3474495">)</span>&nbsp;<span class="ident" id="3474497">Handler</span>&nbsp;<span class="op" id="3474505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3474508">return</span>&nbsp;<span class="op" id="3474515">&amp;</span><span class="ident" id="3474516">redirectHandler</span><span class="op" id="3474531">{</span><span class="ident" id="3474532">url</span><span class="op" id="3474535">,</span>&nbsp;<span class="ident" id="3474537">code</span><span class="op" id="3474541">}</span><br>
<span class="lineno"></span><span class="op" id="3474543">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3474546">//&nbsp;ServeMux&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;request&nbsp;multiplexer.</span><br>
<span class="lineno">1395</span><span class="comment" id="3474590">//&nbsp;It&nbsp;matches&nbsp;the&nbsp;URL&nbsp;of&nbsp;each&nbsp;incoming&nbsp;request&nbsp;against&nbsp;a&nbsp;list&nbsp;of&nbsp;registered</span><br>
<span class="lineno"></span><span class="comment" id="3474666">//&nbsp;patterns&nbsp;and&nbsp;calls&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;pattern&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3474721">//&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;URL.</span><br>
<span class="lineno"></span><span class="comment" id="3474754">//</span><br>
<span class="lineno"></span><span class="comment" id="3474757">//&nbsp;Patterns&nbsp;name&nbsp;fixed,&nbsp;rooted&nbsp;paths,&nbsp;like&nbsp;&#34;/favicon.ico&#34;,</span><br>
<span class="lineno">1400</span><span class="comment" id="3474816">//&nbsp;or&nbsp;rooted&nbsp;subtrees,&nbsp;like&nbsp;&#34;/images/&#34;&nbsp;(note&nbsp;the&nbsp;trailing&nbsp;slash).</span><br>
<span class="lineno"></span><span class="comment" id="3474882">//&nbsp;Longer&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over&nbsp;shorter&nbsp;ones,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3474944">//&nbsp;if&nbsp;there&nbsp;are&nbsp;handlers&nbsp;registered&nbsp;for&nbsp;both&nbsp;&#34;/images/&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3475000">//&nbsp;and&nbsp;&#34;/images/thumbnails/&#34;,&nbsp;the&nbsp;latter&nbsp;handler&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3475057">//&nbsp;called&nbsp;for&nbsp;paths&nbsp;beginning&nbsp;&#34;/images/thumbnails/&#34;&nbsp;and&nbsp;the</span><br>
<span class="lineno">1405</span><span class="comment" id="3475117">//&nbsp;former&nbsp;will&nbsp;receive&nbsp;requests&nbsp;for&nbsp;any&nbsp;other&nbsp;paths&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3475176">//&nbsp;&#34;/images/&#34;&nbsp;subtree.</span><br>
<span class="lineno"></span><span class="comment" id="3475199">//</span><br>
<span class="lineno"></span><span class="comment" id="3475202">//&nbsp;Note&nbsp;that&nbsp;since&nbsp;a&nbsp;pattern&nbsp;ending&nbsp;in&nbsp;a&nbsp;slash&nbsp;names&nbsp;a&nbsp;rooted&nbsp;subtree,</span><br>
<span class="lineno"></span><span class="comment" id="3475273">//&nbsp;the&nbsp;pattern&nbsp;&#34;/&#34;&nbsp;matches&nbsp;all&nbsp;paths&nbsp;not&nbsp;matched&nbsp;by&nbsp;other&nbsp;registered</span><br>
<span class="lineno">1410</span><span class="comment" id="3475342">//&nbsp;patterns,&nbsp;not&nbsp;just&nbsp;the&nbsp;URL&nbsp;with&nbsp;Path&nbsp;==&nbsp;&#34;/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3475390">//</span><br>
<span class="lineno"></span><span class="comment" id="3475393">//&nbsp;Patterns&nbsp;may&nbsp;optionally&nbsp;begin&nbsp;with&nbsp;a&nbsp;host&nbsp;name,&nbsp;restricting&nbsp;matches&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3475467">//&nbsp;URLs&nbsp;on&nbsp;that&nbsp;host&nbsp;only.&nbsp;&nbsp;Host-specific&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="3475539">//&nbsp;general&nbsp;patterns,&nbsp;so&nbsp;that&nbsp;a&nbsp;handler&nbsp;might&nbsp;register&nbsp;for&nbsp;the&nbsp;two&nbsp;patterns</span><br>
<span class="lineno">1415</span><span class="comment" id="3475614">//&nbsp;&#34;/codesearch&#34;&nbsp;and&nbsp;&#34;codesearch.google.com/&#34;&nbsp;without&nbsp;also&nbsp;taking&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="3475685">//&nbsp;requests&nbsp;for&nbsp;&#34;http://www.google.com/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3475727">//</span><br>
<span class="lineno"></span><span class="comment" id="3475730">//&nbsp;ServeMux&nbsp;also&nbsp;takes&nbsp;care&nbsp;of&nbsp;sanitizing&nbsp;the&nbsp;URL&nbsp;request&nbsp;path,</span><br>
<span class="lineno"></span><span class="comment" id="3475794">//&nbsp;redirecting&nbsp;any&nbsp;request&nbsp;containing&nbsp;.&nbsp;or&nbsp;..&nbsp;elements&nbsp;to&nbsp;an</span><br>
<span class="lineno">1420</span><span class="comment" id="3475855">//&nbsp;equivalent&nbsp;.-&nbsp;and&nbsp;..-free&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3475889">type</span>&nbsp;<span class="ident" id="3475894">ServeMux</span>&nbsp;<span class="keyword" id="3475903">struct</span>&nbsp;<span class="op" id="3475910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475913">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3475919">sync</span><span class="op" id="3475923">.</span><span class="ident" id="3475924">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475933">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3475939">map</span><span class="op" id="3475942">[</span><span class="builtintype" id="3475943">string</span><span class="op" id="3475949">]</span><span class="ident" id="3475950">muxEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3475960">hosts</span>&nbsp;<span class="builtintype" id="3475966">bool</span>&nbsp;<span class="comment" id="3475971">//&nbsp;whether&nbsp;any&nbsp;patterns&nbsp;contain&nbsp;hostnames</span><br>
<span class="lineno">1425</span><span class="op" id="3476013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3476016">type</span>&nbsp;<span class="ident" id="3476021">muxEntry</span>&nbsp;<span class="keyword" id="3476030">struct</span>&nbsp;<span class="op" id="3476037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476040">explicit</span>&nbsp;<span class="builtintype" id="3476049">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476055">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3476064">Handler</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476073">pattern</span>&nbsp;&nbsp;<span class="builtintype" id="3476082">string</span><br>
<span class="lineno"></span><span class="op" id="3476089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3476092">//&nbsp;NewServeMux&nbsp;allocates&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="3476145">func</span>&nbsp;<span class="ident" id="3476150">NewServeMux</span><span class="op" id="3476161">(</span><span class="op" id="3476162">)</span>&nbsp;<span class="op" id="3476164">*</span><span class="ident" id="3476165">ServeMux</span>&nbsp;<span class="op" id="3476174">{</span>&nbsp;<span class="keyword" id="3476176">return</span>&nbsp;<span class="op" id="3476183">&amp;</span><span class="ident" id="3476184">ServeMux</span><span class="op" id="3476192">{</span><span class="ident" id="3476193">m</span><span class="op" id="3476194">:</span>&nbsp;<span class="builtinfunc" id="3476196">make</span><span class="op" id="3476200">(</span><span class="keyword" id="3476201">map</span><span class="op" id="3476204">[</span><span class="builtintype" id="3476205">string</span><span class="op" id="3476211">]</span><span class="ident" id="3476212">muxEntry</span><span class="op" id="3476220">)</span><span class="op" id="3476221">}</span>&nbsp;<span class="op" id="3476223">}</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span><span class="comment" id="3476226">//&nbsp;DefaultServeMux&nbsp;is&nbsp;the&nbsp;default&nbsp;ServeMux&nbsp;used&nbsp;by&nbsp;Serve.</span><br>
<span class="lineno"></span><span class="keyword" id="3476284">var</span>&nbsp;<span class="ident" id="3476288">DefaultServeMux</span>&nbsp;<span class="op" id="3476304">=</span>&nbsp;<span class="ident" id="3476306">NewServeMux</span><span class="op" id="3476317">(</span><span class="op" id="3476318">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3476321">//&nbsp;Does&nbsp;path&nbsp;match&nbsp;pattern?</span><br>
<span class="lineno">1440</span><span class="keyword" id="3476349">func</span>&nbsp;<span class="ident" id="3476354">pathMatch</span><span class="op" id="3476363">(</span><span class="ident" id="3476364">pattern</span><span class="op" id="3476371">,</span>&nbsp;<span class="ident" id="3476373">path</span>&nbsp;<span class="builtintype" id="3476378">string</span><span class="op" id="3476384">)</span>&nbsp;<span class="builtintype" id="3476386">bool</span>&nbsp;<span class="op" id="3476391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476394">if</span>&nbsp;<span class="builtinfunc" id="3476397">len</span><span class="op" id="3476400">(</span><span class="ident" id="3476401">pattern</span><span class="op" id="3476408">)</span>&nbsp;<span class="op" id="3476410">==</span>&nbsp;<span class="num" id="3476413">0</span>&nbsp;<span class="op" id="3476415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3476419">//&nbsp;should&nbsp;not&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476442">return</span>&nbsp;<span class="builtintype" id="3476449">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476456">}</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476459">n</span>&nbsp;<span class="op" id="3476461">:=</span>&nbsp;<span class="builtinfunc" id="3476464">len</span><span class="op" id="3476467">(</span><span class="ident" id="3476468">pattern</span><span class="op" id="3476475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476478">if</span>&nbsp;<span class="ident" id="3476481">pattern</span><span class="op" id="3476488">[</span><span class="ident" id="3476489">n</span><span class="op" id="3476490">-</span><span class="num" id="3476491">1</span><span class="op" id="3476492">]</span>&nbsp;<span class="op" id="3476494">!=</span>&nbsp;<span class="string" id="3476497">&#39;/&#39;</span>&nbsp;<span class="op" id="3476501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476505">return</span>&nbsp;<span class="ident" id="3476512">pattern</span>&nbsp;<span class="op" id="3476520">==</span>&nbsp;<span class="ident" id="3476523">path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476532">return</span>&nbsp;<span class="builtinfunc" id="3476539">len</span><span class="op" id="3476542">(</span><span class="ident" id="3476543">path</span><span class="op" id="3476547">)</span>&nbsp;<span class="op" id="3476549">&gt;=</span>&nbsp;<span class="ident" id="3476552">n</span>&nbsp;<span class="op" id="3476554">&amp;&amp;</span>&nbsp;<span class="ident" id="3476557">path</span><span class="op" id="3476561">[</span><span class="num" id="3476562">0</span><span class="op" id="3476563">:</span><span class="ident" id="3476564">n</span><span class="op" id="3476565">]</span>&nbsp;<span class="op" id="3476567">==</span>&nbsp;<span class="ident" id="3476570">pattern</span><br>
<span class="lineno">1450</span><span class="op" id="3476578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3476581">//&nbsp;Return&nbsp;the&nbsp;canonical&nbsp;path&nbsp;for&nbsp;p,&nbsp;eliminating&nbsp;.&nbsp;and&nbsp;..&nbsp;elements.</span><br>
<span class="lineno"></span><span class="keyword" id="3476648">func</span>&nbsp;<span class="ident" id="3476653">cleanPath</span><span class="op" id="3476662">(</span><span class="ident" id="3476663">p</span>&nbsp;<span class="builtintype" id="3476665">string</span><span class="op" id="3476671">)</span>&nbsp;<span class="builtintype" id="3476673">string</span>&nbsp;<span class="op" id="3476680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476683">if</span>&nbsp;<span class="ident" id="3476686">p</span>&nbsp;<span class="op" id="3476688">==</span>&nbsp;<span class="string" id="3476691">&#34;&#34;</span>&nbsp;<span class="op" id="3476694">{</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476698">return</span>&nbsp;<span class="string" id="3476705">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476713">if</span>&nbsp;<span class="ident" id="3476716">p</span><span class="op" id="3476717">[</span><span class="num" id="3476718">0</span><span class="op" id="3476719">]</span>&nbsp;<span class="op" id="3476721">!=</span>&nbsp;<span class="string" id="3476724">&#39;/&#39;</span>&nbsp;<span class="op" id="3476728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476732">p</span>&nbsp;<span class="op" id="3476734">=</span>&nbsp;<span class="string" id="3476736">&#34;/&#34;</span>&nbsp;<span class="op" id="3476740">+</span>&nbsp;<span class="ident" id="3476742">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476745">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476748">np</span>&nbsp;<span class="op" id="3476751">:=</span>&nbsp;<span class="ident" id="3476754">path</span><span class="op" id="3476758">.</span><span class="ident" id="3476759">Clean</span><span class="op" id="3476764">(</span><span class="ident" id="3476765">p</span><span class="op" id="3476766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3476769">//&nbsp;path.Clean&nbsp;removes&nbsp;trailing&nbsp;slash&nbsp;except&nbsp;for&nbsp;root;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3476824">//&nbsp;put&nbsp;the&nbsp;trailing&nbsp;slash&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476870">if</span>&nbsp;<span class="ident" id="3476873">p</span><span class="op" id="3476874">[</span><span class="builtinfunc" id="3476875">len</span><span class="op" id="3476878">(</span><span class="ident" id="3476879">p</span><span class="op" id="3476880">)</span><span class="op" id="3476881">-</span><span class="num" id="3476882">1</span><span class="op" id="3476883">]</span>&nbsp;<span class="op" id="3476885">==</span>&nbsp;<span class="string" id="3476888">&#39;/&#39;</span>&nbsp;<span class="op" id="3476892">&amp;&amp;</span>&nbsp;<span class="ident" id="3476895">np</span>&nbsp;<span class="op" id="3476898">!=</span>&nbsp;<span class="string" id="3476901">&#34;/&#34;</span>&nbsp;<span class="op" id="3476905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3476909">np</span>&nbsp;<span class="op" id="3476912">+=</span>&nbsp;<span class="string" id="3476915">&#34;/&#34;</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3476920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3476923">return</span>&nbsp;<span class="ident" id="3476930">np</span><br>
<span class="lineno"></span><span class="op" id="3476933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3476936">//&nbsp;Find&nbsp;a&nbsp;handler&nbsp;on&nbsp;a&nbsp;handler&nbsp;map&nbsp;given&nbsp;a&nbsp;path&nbsp;string</span><br>
<span class="lineno">1470</span><span class="comment" id="3476991">//&nbsp;Most-specific&nbsp;(longest)&nbsp;pattern&nbsp;wins</span><br>
<span class="lineno"></span><span class="keyword" id="3477031">func</span>&nbsp;<span class="op" id="3477036">(</span><span class="ident" id="3477037">mux</span>&nbsp;<span class="op" id="3477041">*</span><span class="ident" id="3477042">ServeMux</span><span class="op" id="3477050">)</span>&nbsp;<span class="ident" id="3477052">match</span><span class="op" id="3477057">(</span><span class="ident" id="3477058">path</span>&nbsp;<span class="builtintype" id="3477063">string</span><span class="op" id="3477069">)</span>&nbsp;<span class="op" id="3477071">(</span><span class="ident" id="3477072">h</span>&nbsp;<span class="ident" id="3477074">Handler</span><span class="op" id="3477081">,</span>&nbsp;<span class="ident" id="3477083">pattern</span>&nbsp;<span class="builtintype" id="3477091">string</span><span class="op" id="3477097">)</span>&nbsp;<span class="op" id="3477099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477102">var</span>&nbsp;<span class="ident" id="3477106">n</span>&nbsp;<span class="op" id="3477108">=</span>&nbsp;<span class="num" id="3477110">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477113">for</span>&nbsp;<span class="ident" id="3477117">k</span><span class="op" id="3477118">,</span>&nbsp;<span class="ident" id="3477120">v</span>&nbsp;<span class="op" id="3477122">:=</span>&nbsp;<span class="keyword" id="3477125">range</span>&nbsp;<span class="ident" id="3477131">mux</span><span class="op" id="3477134">.</span><span class="ident" id="3477135">m</span>&nbsp;<span class="op" id="3477137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477141">if</span>&nbsp;<span class="op" id="3477144">!</span><span class="ident" id="3477145">pathMatch</span><span class="op" id="3477154">(</span><span class="ident" id="3477155">k</span><span class="op" id="3477156">,</span>&nbsp;<span class="ident" id="3477158">path</span><span class="op" id="3477162">)</span>&nbsp;<span class="op" id="3477164">{</span><br>
<span class="lineno">1475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477169">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3477180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477184">if</span>&nbsp;<span class="ident" id="3477187">h</span>&nbsp;<span class="op" id="3477189">==</span>&nbsp;<span class="ident" id="3477192">nil</span>&nbsp;<span class="op" id="3477196">||</span>&nbsp;<span class="builtinfunc" id="3477199">len</span><span class="op" id="3477202">(</span><span class="ident" id="3477203">k</span><span class="op" id="3477204">)</span>&nbsp;<span class="op" id="3477206">&gt;</span>&nbsp;<span class="ident" id="3477208">n</span>&nbsp;<span class="op" id="3477210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477215">n</span>&nbsp;<span class="op" id="3477217">=</span>&nbsp;<span class="builtinfunc" id="3477219">len</span><span class="op" id="3477222">(</span><span class="ident" id="3477223">k</span><span class="op" id="3477224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477229">h</span>&nbsp;<span class="op" id="3477231">=</span>&nbsp;<span class="ident" id="3477233">v</span><span class="op" id="3477234">.</span><span class="ident" id="3477235">h</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3477240">pattern</span>&nbsp;<span class="op" id="3477248">=</span>&nbsp;<span class="ident" id="3477250">v</span><span class="op" id="3477251">.</span><span class="ident" id="3477252">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3477262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3477265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477268">return</span><br>
<span class="lineno"></span><span class="op" id="3477275">}</span><br>
<span class="lineno">1485</span><br>
<span class="lineno"></span><span class="comment" id="3477278">//&nbsp;Handler&nbsp;returns&nbsp;the&nbsp;handler&nbsp;to&nbsp;use&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3477339">//&nbsp;consulting&nbsp;r.Method,&nbsp;r.Host,&nbsp;and&nbsp;r.URL.Path.&nbsp;It&nbsp;always&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="3477405">//&nbsp;a&nbsp;non-nil&nbsp;handler.&nbsp;If&nbsp;the&nbsp;path&nbsp;is&nbsp;not&nbsp;in&nbsp;its&nbsp;canonical&nbsp;form,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3477473">//&nbsp;handler&nbsp;will&nbsp;be&nbsp;an&nbsp;internally-generated&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno">1490</span><span class="comment" id="3477539">//&nbsp;to&nbsp;the&nbsp;canonical&nbsp;path.</span><br>
<span class="lineno"></span><span class="comment" id="3477565">//</span><br>
<span class="lineno"></span><span class="comment" id="3477568">//&nbsp;Handler&nbsp;also&nbsp;returns&nbsp;the&nbsp;registered&nbsp;pattern&nbsp;that&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3477632">//&nbsp;request&nbsp;or,&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;internally-generated&nbsp;redirects,</span><br>
<span class="lineno"></span><span class="comment" id="3477694">//&nbsp;the&nbsp;pattern&nbsp;that&nbsp;will&nbsp;match&nbsp;after&nbsp;following&nbsp;the&nbsp;redirect.</span><br>
<span class="lineno">1495</span><span class="comment" id="3477755">//</span><br>
<span class="lineno"></span><span class="comment" id="3477758">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;registered&nbsp;handler&nbsp;that&nbsp;applies&nbsp;to&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3477824">//&nbsp;Handler&nbsp;returns&nbsp;a&nbsp;``page&nbsp;not&nbsp;found&#39;&#39;&nbsp;handler&nbsp;and&nbsp;an&nbsp;empty&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="3477894">func</span>&nbsp;<span class="op" id="3477899">(</span><span class="ident" id="3477900">mux</span>&nbsp;<span class="op" id="3477904">*</span><span class="ident" id="3477905">ServeMux</span><span class="op" id="3477913">)</span>&nbsp;<span class="ident" id="3477915">Handler</span><span class="op" id="3477922">(</span><span class="ident" id="3477923">r</span>&nbsp;<span class="op" id="3477925">*</span><span class="ident" id="3477926">Request</span><span class="op" id="3477933">)</span>&nbsp;<span class="op" id="3477935">(</span><span class="ident" id="3477936">h</span>&nbsp;<span class="ident" id="3477938">Handler</span><span class="op" id="3477945">,</span>&nbsp;<span class="ident" id="3477947">pattern</span>&nbsp;<span class="builtintype" id="3477955">string</span><span class="op" id="3477961">)</span>&nbsp;<span class="op" id="3477963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477966">if</span>&nbsp;<span class="ident" id="3477969">r</span><span class="op" id="3477970">.</span><span class="ident" id="3477971">Method</span>&nbsp;<span class="op" id="3477978">!=</span>&nbsp;<span class="string" id="3477981">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="3477991">{</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3477995">if</span>&nbsp;<span class="ident" id="3477998">p</span>&nbsp;<span class="op" id="3478000">:=</span>&nbsp;<span class="ident" id="3478003">cleanPath</span><span class="op" id="3478012">(</span><span class="ident" id="3478013">r</span><span class="op" id="3478014">.</span><span class="ident" id="3478015">URL</span><span class="op" id="3478018">.</span><span class="ident" id="3478019">Path</span><span class="op" id="3478023">)</span><span class="op" id="3478024">;</span>&nbsp;<span class="ident" id="3478026">p</span>&nbsp;<span class="op" id="3478028">!=</span>&nbsp;<span class="ident" id="3478031">r</span><span class="op" id="3478032">.</span><span class="ident" id="3478033">URL</span><span class="op" id="3478036">.</span><span class="ident" id="3478037">Path</span>&nbsp;<span class="op" id="3478042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478047">_</span><span class="op" id="3478048">,</span>&nbsp;<span class="ident" id="3478050">pattern</span>&nbsp;<span class="op" id="3478058">=</span>&nbsp;<span class="ident" id="3478060">mux</span><span class="op" id="3478063">.</span><span class="ident" id="3478064">handler</span><span class="op" id="3478071">(</span><span class="ident" id="3478072">r</span><span class="op" id="3478073">.</span><span class="ident" id="3478074">Host</span><span class="op" id="3478078">,</span>&nbsp;<span class="ident" id="3478080">p</span><span class="op" id="3478081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478086">url</span>&nbsp;<span class="op" id="3478090">:=</span>&nbsp;<span class="op" id="3478093">*</span><span class="ident" id="3478094">r</span><span class="op" id="3478095">.</span><span class="ident" id="3478096">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478103">url</span><span class="op" id="3478106">.</span><span class="ident" id="3478107">Path</span>&nbsp;<span class="op" id="3478112">=</span>&nbsp;<span class="ident" id="3478114">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478119">return</span>&nbsp;<span class="ident" id="3478126">RedirectHandler</span><span class="op" id="3478141">(</span><span class="ident" id="3478142">url</span><span class="op" id="3478145">.</span><span class="ident" id="3478146">String</span><span class="op" id="3478152">(</span><span class="op" id="3478153">)</span><span class="op" id="3478154">,</span>&nbsp;<span class="ident" id="3478156">StatusMovedPermanently</span><span class="op" id="3478178">)</span><span class="op" id="3478179">,</span>&nbsp;<span class="ident" id="3478181">pattern</span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478198">return</span>&nbsp;<span class="ident" id="3478205">mux</span><span class="op" id="3478208">.</span><span class="ident" id="3478209">handler</span><span class="op" id="3478216">(</span><span class="ident" id="3478217">r</span><span class="op" id="3478218">.</span><span class="ident" id="3478219">Host</span><span class="op" id="3478223">,</span>&nbsp;<span class="ident" id="3478225">r</span><span class="op" id="3478226">.</span><span class="ident" id="3478227">URL</span><span class="op" id="3478230">.</span><span class="ident" id="3478231">Path</span><span class="op" id="3478235">)</span><br>
<span class="lineno"></span><span class="op" id="3478237">}</span><br>
<span class="lineno">1510</span><br>
<span class="lineno"></span><span class="comment" id="3478240">//&nbsp;handler&nbsp;is&nbsp;the&nbsp;main&nbsp;implementation&nbsp;of&nbsp;Handler.</span><br>
<span class="lineno"></span><span class="comment" id="3478290">//&nbsp;The&nbsp;path&nbsp;is&nbsp;known&nbsp;to&nbsp;be&nbsp;in&nbsp;canonical&nbsp;form,&nbsp;except&nbsp;for&nbsp;CONNECT&nbsp;methods.</span><br>
<span class="lineno"></span><span class="keyword" id="3478364">func</span>&nbsp;<span class="op" id="3478369">(</span><span class="ident" id="3478370">mux</span>&nbsp;<span class="op" id="3478374">*</span><span class="ident" id="3478375">ServeMux</span><span class="op" id="3478383">)</span>&nbsp;<span class="ident" id="3478385">handler</span><span class="op" id="3478392">(</span><span class="ident" id="3478393">host</span><span class="op" id="3478397">,</span>&nbsp;<span class="ident" id="3478399">path</span>&nbsp;<span class="builtintype" id="3478404">string</span><span class="op" id="3478410">)</span>&nbsp;<span class="op" id="3478412">(</span><span class="ident" id="3478413">h</span>&nbsp;<span class="ident" id="3478415">Handler</span><span class="op" id="3478422">,</span>&nbsp;<span class="ident" id="3478424">pattern</span>&nbsp;<span class="builtintype" id="3478432">string</span><span class="op" id="3478438">)</span>&nbsp;<span class="op" id="3478440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478443">mux</span><span class="op" id="3478446">.</span><span class="ident" id="3478447">mu</span><span class="op" id="3478449">.</span><span class="ident" id="3478450">RLock</span><span class="op" id="3478455">(</span><span class="op" id="3478456">)</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478459">defer</span>&nbsp;<span class="ident" id="3478465">mux</span><span class="op" id="3478468">.</span><span class="ident" id="3478469">mu</span><span class="op" id="3478471">.</span><span class="ident" id="3478472">RUnlock</span><span class="op" id="3478479">(</span><span class="op" id="3478480">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3478484">//&nbsp;Host-specific&nbsp;pattern&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;generic&nbsp;ones</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478545">if</span>&nbsp;<span class="ident" id="3478548">mux</span><span class="op" id="3478551">.</span><span class="ident" id="3478552">hosts</span>&nbsp;<span class="op" id="3478558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478562">h</span><span class="op" id="3478563">,</span>&nbsp;<span class="ident" id="3478565">pattern</span>&nbsp;<span class="op" id="3478573">=</span>&nbsp;<span class="ident" id="3478575">mux</span><span class="op" id="3478578">.</span><span class="ident" id="3478579">match</span><span class="op" id="3478584">(</span><span class="ident" id="3478585">host</span>&nbsp;<span class="op" id="3478590">+</span>&nbsp;<span class="ident" id="3478592">path</span><span class="op" id="3478596">)</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478602">if</span>&nbsp;<span class="ident" id="3478605">h</span>&nbsp;<span class="op" id="3478607">==</span>&nbsp;<span class="ident" id="3478610">nil</span>&nbsp;<span class="op" id="3478614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478618">h</span><span class="op" id="3478619">,</span>&nbsp;<span class="ident" id="3478621">pattern</span>&nbsp;<span class="op" id="3478629">=</span>&nbsp;<span class="ident" id="3478631">mux</span><span class="op" id="3478634">.</span><span class="ident" id="3478635">match</span><span class="op" id="3478640">(</span><span class="ident" id="3478641">path</span><span class="op" id="3478645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478651">if</span>&nbsp;<span class="ident" id="3478654">h</span>&nbsp;<span class="op" id="3478656">==</span>&nbsp;<span class="ident" id="3478659">nil</span>&nbsp;<span class="op" id="3478663">{</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478667">h</span><span class="op" id="3478668">,</span>&nbsp;<span class="ident" id="3478670">pattern</span>&nbsp;<span class="op" id="3478678">=</span>&nbsp;<span class="ident" id="3478680">NotFoundHandler</span><span class="op" id="3478695">(</span><span class="op" id="3478696">)</span><span class="op" id="3478697">,</span>&nbsp;<span class="string" id="3478699">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478706">return</span><br>
<span class="lineno"></span><span class="op" id="3478713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1530</span><span class="comment" id="3478716">//&nbsp;ServeHTTP&nbsp;dispatches&nbsp;the&nbsp;request&nbsp;to&nbsp;the&nbsp;handler&nbsp;whose</span><br>
<span class="lineno"></span><span class="comment" id="3478773">//&nbsp;pattern&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;request&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3478822">func</span>&nbsp;<span class="op" id="3478827">(</span><span class="ident" id="3478828">mux</span>&nbsp;<span class="op" id="3478832">*</span><span class="ident" id="3478833">ServeMux</span><span class="op" id="3478841">)</span>&nbsp;<span class="ident" id="3478843">ServeHTTP</span><span class="op" id="3478852">(</span><span class="ident" id="3478853">w</span>&nbsp;<span class="ident" id="3478855">ResponseWriter</span><span class="op" id="3478869">,</span>&nbsp;<span class="ident" id="3478871">r</span>&nbsp;<span class="op" id="3478873">*</span><span class="ident" id="3478874">Request</span><span class="op" id="3478881">)</span>&nbsp;<span class="op" id="3478883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478886">if</span>&nbsp;<span class="ident" id="3478889">r</span><span class="op" id="3478890">.</span><span class="ident" id="3478891">RequestURI</span>&nbsp;<span class="op" id="3478902">==</span>&nbsp;<span class="string" id="3478905">&#34;*&#34;</span>&nbsp;<span class="op" id="3478909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3478913">if</span>&nbsp;<span class="ident" id="3478916">r</span><span class="op" id="3478917">.</span><span class="ident" id="3478918">ProtoAtLeast</span><span class="op" id="3478930">(</span><span class="num" id="3478931">1</span><span class="op" id="3478932">,</span>&nbsp;<span class="num" id="3478934">1</span><span class="op" id="3478935">)</span>&nbsp;<span class="op" id="3478937">{</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478942">w</span><span class="op" id="3478943">.</span><span class="ident" id="3478944">Header</span><span class="op" id="3478950">(</span><span class="op" id="3478951">)</span><span class="op" id="3478952">.</span><span class="ident" id="3478953">Set</span><span class="op" id="3478956">(</span><span class="string" id="3478957">&#34;Connection&#34;</span><span class="op" id="3478969">,</span>&nbsp;<span class="string" id="3478971">&#34;close&#34;</span><span class="op" id="3478978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3478982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3478986">w</span><span class="op" id="3478987">.</span><span class="ident" id="3478988">WriteHeader</span><span class="op" id="3478999">(</span><span class="ident" id="3479000">StatusBadRequest</span><span class="op" id="3479016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479020">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479028">}</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479031">h</span><span class="op" id="3479032">,</span>&nbsp;<span class="ident" id="3479034">_</span>&nbsp;<span class="op" id="3479036">:=</span>&nbsp;<span class="ident" id="3479039">mux</span><span class="op" id="3479042">.</span><span class="ident" id="3479043">Handler</span><span class="op" id="3479050">(</span><span class="ident" id="3479051">r</span><span class="op" id="3479052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479055">h</span><span class="op" id="3479056">.</span><span class="ident" id="3479057">ServeHTTP</span><span class="op" id="3479066">(</span><span class="ident" id="3479067">w</span><span class="op" id="3479068">,</span>&nbsp;<span class="ident" id="3479070">r</span><span class="op" id="3479071">)</span><br>
<span class="lineno"></span><span class="op" id="3479073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3479076">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno">1545</span><span class="comment" id="3479131">//&nbsp;If&nbsp;a&nbsp;handler&nbsp;already&nbsp;exists&nbsp;for&nbsp;pattern,&nbsp;Handle&nbsp;panics.</span><br>
<span class="lineno"></span><span class="keyword" id="3479190">func</span>&nbsp;<span class="op" id="3479195">(</span><span class="ident" id="3479196">mux</span>&nbsp;<span class="op" id="3479200">*</span><span class="ident" id="3479201">ServeMux</span><span class="op" id="3479209">)</span>&nbsp;<span class="ident" id="3479211">Handle</span><span class="op" id="3479217">(</span><span class="ident" id="3479218">pattern</span>&nbsp;<span class="builtintype" id="3479226">string</span><span class="op" id="3479232">,</span>&nbsp;<span class="ident" id="3479234">handler</span>&nbsp;<span class="ident" id="3479242">Handler</span><span class="op" id="3479249">)</span>&nbsp;<span class="op" id="3479251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479254">mux</span><span class="op" id="3479257">.</span><span class="ident" id="3479258">mu</span><span class="op" id="3479260">.</span><span class="ident" id="3479261">Lock</span><span class="op" id="3479265">(</span><span class="op" id="3479266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479269">defer</span>&nbsp;<span class="ident" id="3479275">mux</span><span class="op" id="3479278">.</span><span class="ident" id="3479279">mu</span><span class="op" id="3479281">.</span><span class="ident" id="3479282">Unlock</span><span class="op" id="3479288">(</span><span class="op" id="3479289">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479293">if</span>&nbsp;<span class="ident" id="3479296">pattern</span>&nbsp;<span class="op" id="3479304">==</span>&nbsp;<span class="string" id="3479307">&#34;&#34;</span>&nbsp;<span class="op" id="3479310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3479314">panic</span><span class="op" id="3479319">(</span><span class="string" id="3479320">&#34;http:&nbsp;invalid&nbsp;pattern&nbsp;&#34;</span>&nbsp;<span class="op" id="3479345">+</span>&nbsp;<span class="ident" id="3479347">pattern</span><span class="op" id="3479354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479360">if</span>&nbsp;<span class="ident" id="3479363">handler</span>&nbsp;<span class="op" id="3479371">==</span>&nbsp;<span class="ident" id="3479374">nil</span>&nbsp;<span class="op" id="3479378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3479382">panic</span><span class="op" id="3479387">(</span><span class="string" id="3479388">&#34;http:&nbsp;nil&nbsp;handler&#34;</span><span class="op" id="3479407">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479413">if</span>&nbsp;<span class="ident" id="3479416">mux</span><span class="op" id="3479419">.</span><span class="ident" id="3479420">m</span><span class="op" id="3479421">[</span><span class="ident" id="3479422">pattern</span><span class="op" id="3479429">]</span><span class="op" id="3479430">.</span><span class="ident" id="3479431">explicit</span>&nbsp;<span class="op" id="3479440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3479444">panic</span><span class="op" id="3479449">(</span><span class="string" id="3479450">&#34;http:&nbsp;multiple&nbsp;registrations&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="3479486">+</span>&nbsp;<span class="ident" id="3479488">pattern</span><span class="op" id="3479495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479502">mux</span><span class="op" id="3479505">.</span><span class="ident" id="3479506">m</span><span class="op" id="3479507">[</span><span class="ident" id="3479508">pattern</span><span class="op" id="3479515">]</span>&nbsp;<span class="op" id="3479517">=</span>&nbsp;<span class="ident" id="3479519">muxEntry</span><span class="op" id="3479527">{</span><span class="ident" id="3479528">explicit</span><span class="op" id="3479536">:</span>&nbsp;<span class="builtintype" id="3479538">true</span><span class="op" id="3479542">,</span>&nbsp;<span class="ident" id="3479544">h</span><span class="op" id="3479545">:</span>&nbsp;<span class="ident" id="3479547">handler</span><span class="op" id="3479554">,</span>&nbsp;<span class="ident" id="3479556">pattern</span><span class="op" id="3479563">:</span>&nbsp;<span class="ident" id="3479565">pattern</span><span class="op" id="3479572">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479576">if</span>&nbsp;<span class="ident" id="3479579">pattern</span><span class="op" id="3479586">[</span><span class="num" id="3479587">0</span><span class="op" id="3479588">]</span>&nbsp;<span class="op" id="3479590">!=</span>&nbsp;<span class="string" id="3479593">&#39;/&#39;</span>&nbsp;<span class="op" id="3479597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479601">mux</span><span class="op" id="3479604">.</span><span class="ident" id="3479605">hosts</span>&nbsp;<span class="op" id="3479611">=</span>&nbsp;<span class="builtintype" id="3479613">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3479619">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3479623">//&nbsp;Helpful&nbsp;behavior:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3479645">//&nbsp;If&nbsp;pattern&nbsp;is&nbsp;/tree/,&nbsp;insert&nbsp;an&nbsp;implicit&nbsp;permanent&nbsp;redirect&nbsp;for&nbsp;/tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3479720">//&nbsp;It&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;an&nbsp;explicit&nbsp;registration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479774">n</span>&nbsp;<span class="op" id="3479776">:=</span>&nbsp;<span class="builtinfunc" id="3479779">len</span><span class="op" id="3479782">(</span><span class="ident" id="3479783">pattern</span><span class="op" id="3479790">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479793">if</span>&nbsp;<span class="ident" id="3479796">n</span>&nbsp;<span class="op" id="3479798">&gt;</span>&nbsp;<span class="num" id="3479800">0</span>&nbsp;<span class="op" id="3479802">&amp;&amp;</span>&nbsp;<span class="ident" id="3479805">pattern</span><span class="op" id="3479812">[</span><span class="ident" id="3479813">n</span><span class="op" id="3479814">-</span><span class="num" id="3479815">1</span><span class="op" id="3479816">]</span>&nbsp;<span class="op" id="3479818">==</span>&nbsp;<span class="string" id="3479821">&#39;/&#39;</span>&nbsp;<span class="op" id="3479825">&amp;&amp;</span>&nbsp;<span class="op" id="3479828">!</span><span class="ident" id="3479829">mux</span><span class="op" id="3479832">.</span><span class="ident" id="3479833">m</span><span class="op" id="3479834">[</span><span class="ident" id="3479835">pattern</span><span class="op" id="3479842">[</span><span class="num" id="3479843">0</span><span class="op" id="3479844">:</span><span class="ident" id="3479845">n</span><span class="op" id="3479846">-</span><span class="num" id="3479847">1</span><span class="op" id="3479848">]</span><span class="op" id="3479849">]</span><span class="op" id="3479850">.</span><span class="ident" id="3479851">explicit</span>&nbsp;<span class="op" id="3479860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3479864">//&nbsp;If&nbsp;pattern&nbsp;contains&nbsp;a&nbsp;host&nbsp;name,&nbsp;strip&nbsp;it&nbsp;and&nbsp;use&nbsp;remaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3479929">//&nbsp;path&nbsp;for&nbsp;redirect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3479953">path</span>&nbsp;<span class="op" id="3479958">:=</span>&nbsp;<span class="ident" id="3479961">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3479971">if</span>&nbsp;<span class="ident" id="3479974">pattern</span><span class="op" id="3479981">[</span><span class="num" id="3479982">0</span><span class="op" id="3479983">]</span>&nbsp;<span class="op" id="3479985">!=</span>&nbsp;<span class="string" id="3479988">&#39;/&#39;</span>&nbsp;<span class="op" id="3479992">{</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3479997">//&nbsp;In&nbsp;pattern,&nbsp;at&nbsp;least&nbsp;the&nbsp;last&nbsp;character&nbsp;is&nbsp;a&nbsp;&#39;/&#39;,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3480056">//&nbsp;strings.Index&nbsp;can&#39;t&nbsp;be&nbsp;-1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480089">path</span>&nbsp;<span class="op" id="3480094">=</span>&nbsp;<span class="ident" id="3480096">pattern</span><span class="op" id="3480103">[</span><span class="ident" id="3480104">strings</span><span class="op" id="3480111">.</span><span class="ident" id="3480112">Index</span><span class="op" id="3480117">(</span><span class="ident" id="3480118">pattern</span><span class="op" id="3480125">,</span>&nbsp;<span class="string" id="3480127">&#34;/&#34;</span><span class="op" id="3480130">)</span><span class="op" id="3480131">:</span><span class="op" id="3480132">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480140">mux</span><span class="op" id="3480143">.</span><span class="ident" id="3480144">m</span><span class="op" id="3480145">[</span><span class="ident" id="3480146">pattern</span><span class="op" id="3480153">[</span><span class="num" id="3480154">0</span><span class="op" id="3480155">:</span><span class="ident" id="3480156">n</span><span class="op" id="3480157">-</span><span class="num" id="3480158">1</span><span class="op" id="3480159">]</span><span class="op" id="3480160">]</span>&nbsp;<span class="op" id="3480162">=</span>&nbsp;<span class="ident" id="3480164">muxEntry</span><span class="op" id="3480172">{</span><span class="ident" id="3480173">h</span><span class="op" id="3480174">:</span>&nbsp;<span class="ident" id="3480176">RedirectHandler</span><span class="op" id="3480191">(</span><span class="ident" id="3480192">path</span><span class="op" id="3480196">,</span>&nbsp;<span class="ident" id="3480198">StatusMovedPermanently</span><span class="op" id="3480220">)</span><span class="op" id="3480221">,</span>&nbsp;<span class="ident" id="3480223">pattern</span><span class="op" id="3480230">:</span>&nbsp;<span class="ident" id="3480232">pattern</span><span class="op" id="3480239">}</span><br>
<span class="lineno">1580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3480242">}</span><br>
<span class="lineno"></span><span class="op" id="3480244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3480247">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="3480315">func</span>&nbsp;<span class="op" id="3480320">(</span><span class="ident" id="3480321">mux</span>&nbsp;<span class="op" id="3480325">*</span><span class="ident" id="3480326">ServeMux</span><span class="op" id="3480334">)</span>&nbsp;<span class="ident" id="3480336">HandleFunc</span><span class="op" id="3480346">(</span><span class="ident" id="3480347">pattern</span>&nbsp;<span class="builtintype" id="3480355">string</span><span class="op" id="3480361">,</span>&nbsp;<span class="ident" id="3480363">handler</span>&nbsp;<span class="keyword" id="3480371">func</span><span class="op" id="3480375">(</span><span class="ident" id="3480376">ResponseWriter</span><span class="op" id="3480390">,</span>&nbsp;<span class="op" id="3480392">*</span><span class="ident" id="3480393">Request</span><span class="op" id="3480400">)</span><span class="op" id="3480401">)</span>&nbsp;<span class="op" id="3480403">{</span><br>
<span class="lineno">1585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480406">mux</span><span class="op" id="3480409">.</span><span class="ident" id="3480410">Handle</span><span class="op" id="3480416">(</span><span class="ident" id="3480417">pattern</span><span class="op" id="3480424">,</span>&nbsp;<span class="ident" id="3480426">HandlerFunc</span><span class="op" id="3480437">(</span><span class="ident" id="3480438">handler</span><span class="op" id="3480445">)</span><span class="op" id="3480446">)</span><br>
<span class="lineno"></span><span class="op" id="3480448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3480451">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="3480505">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1590</span><span class="comment" id="3480532">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="3480601">func</span>&nbsp;<span class="ident" id="3480606">Handle</span><span class="op" id="3480612">(</span><span class="ident" id="3480613">pattern</span>&nbsp;<span class="builtintype" id="3480621">string</span><span class="op" id="3480627">,</span>&nbsp;<span class="ident" id="3480629">handler</span>&nbsp;<span class="ident" id="3480637">Handler</span><span class="op" id="3480644">)</span>&nbsp;<span class="op" id="3480646">{</span>&nbsp;<span class="ident" id="3480648">DefaultServeMux</span><span class="op" id="3480663">.</span><span class="ident" id="3480664">Handle</span><span class="op" id="3480670">(</span><span class="ident" id="3480671">pattern</span><span class="op" id="3480678">,</span>&nbsp;<span class="ident" id="3480680">handler</span><span class="op" id="3480687">)</span>&nbsp;<span class="op" id="3480689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3480692">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="3480759">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1595</span><span class="comment" id="3480786">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="3480855">func</span>&nbsp;<span class="ident" id="3480860">HandleFunc</span><span class="op" id="3480870">(</span><span class="ident" id="3480871">pattern</span>&nbsp;<span class="builtintype" id="3480879">string</span><span class="op" id="3480885">,</span>&nbsp;<span class="ident" id="3480887">handler</span>&nbsp;<span class="keyword" id="3480895">func</span><span class="op" id="3480899">(</span><span class="ident" id="3480900">ResponseWriter</span><span class="op" id="3480914">,</span>&nbsp;<span class="op" id="3480916">*</span><span class="ident" id="3480917">Request</span><span class="op" id="3480924">)</span><span class="op" id="3480925">)</span>&nbsp;<span class="op" id="3480927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3480930">DefaultServeMux</span><span class="op" id="3480945">.</span><span class="ident" id="3480946">HandleFunc</span><span class="op" id="3480956">(</span><span class="ident" id="3480957">pattern</span><span class="op" id="3480964">,</span>&nbsp;<span class="ident" id="3480966">handler</span><span class="op" id="3480973">)</span><br>
<span class="lineno"></span><span class="op" id="3480975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="3480978">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;HTTP&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,</span><br>
<span class="lineno"></span><span class="comment" id="3481040">//&nbsp;creating&nbsp;a&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="3481110">//&nbsp;read&nbsp;requests&nbsp;and&nbsp;then&nbsp;call&nbsp;handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="3481167">//&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3481239">func</span>&nbsp;<span class="ident" id="3481244">Serve</span><span class="op" id="3481249">(</span><span class="ident" id="3481250">l</span>&nbsp;<span class="ident" id="3481252">net</span><span class="op" id="3481255">.</span><span class="ident" id="3481256">Listener</span><span class="op" id="3481264">,</span>&nbsp;<span class="ident" id="3481266">handler</span>&nbsp;<span class="ident" id="3481274">Handler</span><span class="op" id="3481281">)</span>&nbsp;<span class="builtintype" id="3481283">error</span>&nbsp;<span class="op" id="3481289">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481292">srv</span>&nbsp;<span class="op" id="3481296">:=</span>&nbsp;<span class="op" id="3481299">&amp;</span><span class="ident" id="3481300">Server</span><span class="op" id="3481306">{</span><span class="ident" id="3481307">Handler</span><span class="op" id="3481314">:</span>&nbsp;<span class="ident" id="3481316">handler</span><span class="op" id="3481323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3481326">return</span>&nbsp;<span class="ident" id="3481333">srv</span><span class="op" id="3481336">.</span><span class="ident" id="3481337">Serve</span><span class="op" id="3481342">(</span><span class="ident" id="3481343">l</span><span class="op" id="3481344">)</span><br>
<span class="lineno"></span><span class="op" id="3481346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3481349">//&nbsp;A&nbsp;Server&nbsp;defines&nbsp;parameters&nbsp;for&nbsp;running&nbsp;an&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">1610</span><span class="comment" id="3481408">//&nbsp;The&nbsp;zero&nbsp;value&nbsp;for&nbsp;Server&nbsp;is&nbsp;a&nbsp;valid&nbsp;configuration.</span><br>
<span class="lineno"></span><span class="keyword" id="3481463">type</span>&nbsp;<span class="ident" id="3481468">Server</span>&nbsp;<span class="keyword" id="3481475">struct</span>&nbsp;<span class="op" id="3481482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481485">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3481500">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3481514">//&nbsp;TCP&nbsp;address&nbsp;to&nbsp;listen&nbsp;on,&nbsp;&#34;:http&#34;&nbsp;if&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481561">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3481576">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3481590">//&nbsp;handler&nbsp;to&nbsp;invoke,&nbsp;http.DefaultServeMux&nbsp;if&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481641">ReadTimeout</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3481656">time</span><span class="op" id="3481660">.</span><span class="ident" id="3481661">Duration</span>&nbsp;<span class="comment" id="3481670">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;read&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481729">WriteTimeout</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3481744">time</span><span class="op" id="3481748">.</span><span class="ident" id="3481749">Duration</span>&nbsp;<span class="comment" id="3481758">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;write&nbsp;of&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481819">MaxHeaderBytes</span>&nbsp;<span class="builtintype" id="3481834">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3481848">//&nbsp;maximum&nbsp;size&nbsp;of&nbsp;request&nbsp;headers,&nbsp;DefaultMaxHeaderBytes&nbsp;if&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3481912">TLSConfig</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3481927">*</span><span class="ident" id="3481928">tls</span><span class="op" id="3481931">.</span><span class="ident" id="3481932">Config</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3481941">//&nbsp;optional&nbsp;TLS&nbsp;config,&nbsp;used&nbsp;by&nbsp;ListenAndServeTLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3481993">//&nbsp;TLSNextProto&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;take&nbsp;over</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482055">//&nbsp;ownership&nbsp;of&nbsp;the&nbsp;provided&nbsp;TLS&nbsp;connection&nbsp;when&nbsp;an&nbsp;NPN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482112">//&nbsp;protocol&nbsp;upgrade&nbsp;has&nbsp;occurred.&nbsp;&nbsp;The&nbsp;map&nbsp;key&nbsp;is&nbsp;the&nbsp;protocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482176">//&nbsp;name&nbsp;negotiated.&nbsp;The&nbsp;Handler&nbsp;argument&nbsp;should&nbsp;be&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482236">//&nbsp;handle&nbsp;HTTP&nbsp;requests&nbsp;and&nbsp;will&nbsp;initialize&nbsp;the&nbsp;Request&#39;s&nbsp;TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482299">//&nbsp;and&nbsp;RemoteAddr&nbsp;if&nbsp;not&nbsp;already&nbsp;set.&nbsp;&nbsp;The&nbsp;connection&nbsp;is</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482357">//&nbsp;automatically&nbsp;closed&nbsp;when&nbsp;the&nbsp;function&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482409">TLSNextProto</span>&nbsp;<span class="keyword" id="3482422">map</span><span class="op" id="3482425">[</span><span class="builtintype" id="3482426">string</span><span class="op" id="3482432">]</span><span class="keyword" id="3482433">func</span><span class="op" id="3482437">(</span><span class="op" id="3482438">*</span><span class="ident" id="3482439">Server</span><span class="op" id="3482445">,</span>&nbsp;<span class="op" id="3482447">*</span><span class="ident" id="3482448">tls</span><span class="op" id="3482451">.</span><span class="ident" id="3482452">Conn</span><span class="op" id="3482456">,</span>&nbsp;<span class="ident" id="3482458">Handler</span><span class="op" id="3482465">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482469">//&nbsp;ConnState&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;callback&nbsp;function&nbsp;that&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482531">//&nbsp;called&nbsp;when&nbsp;a&nbsp;client&nbsp;connection&nbsp;changes&nbsp;state.&nbsp;See&nbsp;the</span><br>
<span class="lineno">1630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482590">//&nbsp;ConnState&nbsp;type&nbsp;and&nbsp;associated&nbsp;constants&nbsp;for&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482647">ConnState</span>&nbsp;<span class="keyword" id="3482657">func</span><span class="op" id="3482661">(</span><span class="ident" id="3482662">net</span><span class="op" id="3482665">.</span><span class="ident" id="3482666">Conn</span><span class="op" id="3482670">,</span>&nbsp;<span class="ident" id="3482672">ConnState</span><span class="op" id="3482681">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482685">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors&nbsp;accepting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482748">//&nbsp;connections&nbsp;and&nbsp;unexpected&nbsp;behavior&nbsp;from&nbsp;handlers.</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482803">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3482863">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482884">ErrorLog</span>&nbsp;<span class="op" id="3482893">*</span><span class="ident" id="3482894">log</span><span class="op" id="3482897">.</span><span class="ident" id="3482898">Logger</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3482907">disableKeepAlives</span>&nbsp;<span class="builtintype" id="3482925">int32</span>&nbsp;<span class="comment" id="3482931">//&nbsp;accessed&nbsp;atomically.</span><br>
<span class="lineno">1640</span><span class="op" id="3482955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3482958">//&nbsp;A&nbsp;ConnState&nbsp;represents&nbsp;the&nbsp;state&nbsp;of&nbsp;a&nbsp;client&nbsp;connection&nbsp;to&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="comment" id="3483030">//&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;the&nbsp;optional&nbsp;Server.ConnState&nbsp;hook.</span><br>
<span class="lineno"></span><span class="keyword" id="3483082">type</span>&nbsp;<span class="ident" id="3483087">ConnState</span>&nbsp;<span class="builtintype" id="3483097">int</span><br>
<span class="lineno">1645</span><br>
<span class="lineno"></span><span class="keyword" id="3483102">const</span>&nbsp;<span class="op" id="3483108">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483111">//&nbsp;StateNew&nbsp;represents&nbsp;a&nbsp;new&nbsp;connection&nbsp;that&nbsp;is&nbsp;expected&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483172">//&nbsp;send&nbsp;a&nbsp;request&nbsp;immediately.&nbsp;Connections&nbsp;begin&nbsp;at&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483230">//&nbsp;state&nbsp;and&nbsp;then&nbsp;transition&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483285">//&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483302">StateNew</span>&nbsp;<span class="ident" id="3483311">ConnState</span>&nbsp;<span class="op" id="3483321">=</span>&nbsp;<span class="ident" id="3483323">iota</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483330">//&nbsp;StateActive&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;read&nbsp;1&nbsp;or&nbsp;more</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483394">//&nbsp;bytes&nbsp;of&nbsp;a&nbsp;request.&nbsp;The&nbsp;Server.ConnState&nbsp;hook&nbsp;for</span><br>
<span class="lineno">1655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483448">//&nbsp;StateActive&nbsp;fires&nbsp;before&nbsp;the&nbsp;request&nbsp;has&nbsp;entered&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483511">//&nbsp;and&nbsp;doesn&#39;t&nbsp;fire&nbsp;again&nbsp;until&nbsp;the&nbsp;request&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483565">//&nbsp;handled.&nbsp;After&nbsp;the&nbsp;request&nbsp;is&nbsp;handled,&nbsp;the&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483618">//&nbsp;transitions&nbsp;to&nbsp;StateClosed,&nbsp;StateHijacked,&nbsp;or&nbsp;StateIdle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483679">StateActive</span><br>
<span class="lineno">1660</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483693">//&nbsp;StateIdle&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483749">//&nbsp;handling&nbsp;a&nbsp;request&nbsp;and&nbsp;is&nbsp;in&nbsp;the&nbsp;keep-alive&nbsp;state,&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483812">//&nbsp;for&nbsp;a&nbsp;new&nbsp;request.&nbsp;Connections&nbsp;transition&nbsp;from&nbsp;StateIdle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483873">//&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or&nbsp;StateClosed.</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3483915">StateIdle</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483927">//&nbsp;StateHijacked&nbsp;represents&nbsp;a&nbsp;hijacked&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3483979">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484048">StateHijacked</span><br>
<span class="lineno">1670</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3484064">//&nbsp;StateClosed&nbsp;represents&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3484112">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;Hijacked&nbsp;connections&nbsp;do&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3484170">//&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484201">StateClosed</span><br>
<span class="lineno">1675</span><span class="op" id="3484213">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3484216">var</span>&nbsp;<span class="ident" id="3484220">stateName</span>&nbsp;<span class="op" id="3484230">=</span>&nbsp;<span class="keyword" id="3484232">map</span><span class="op" id="3484235">[</span><span class="ident" id="3484236">ConnState</span><span class="op" id="3484245">]</span><span class="builtintype" id="3484246">string</span><span class="op" id="3484252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484255">StateNew</span><span class="op" id="3484263">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3484270">&#34;new&#34;</span><span class="op" id="3484275">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484278">StateActive</span><span class="op" id="3484289">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="3484293">&#34;active&#34;</span><span class="op" id="3484301">,</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484304">StateIdle</span><span class="op" id="3484313">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3484319">&#34;idle&#34;</span><span class="op" id="3484325">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484328">StateHijacked</span><span class="op" id="3484341">:</span>&nbsp;<span class="string" id="3484343">&#34;hijacked&#34;</span><span class="op" id="3484353">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484356">StateClosed</span><span class="op" id="3484367">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="3484371">&#34;closed&#34;</span><span class="op" id="3484379">,</span><br>
<span class="lineno"></span><span class="op" id="3484381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1685</span><span class="keyword" id="3484384">func</span>&nbsp;<span class="op" id="3484389">(</span><span class="ident" id="3484390">c</span>&nbsp;<span class="ident" id="3484392">ConnState</span><span class="op" id="3484401">)</span>&nbsp;<span class="ident" id="3484403">String</span><span class="op" id="3484409">(</span><span class="op" id="3484410">)</span>&nbsp;<span class="builtintype" id="3484412">string</span>&nbsp;<span class="op" id="3484419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484422">return</span>&nbsp;<span class="ident" id="3484429">stateName</span><span class="op" id="3484438">[</span><span class="ident" id="3484439">c</span><span class="op" id="3484440">]</span><br>
<span class="lineno"></span><span class="op" id="3484442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3484445">//&nbsp;serverHandler&nbsp;delegates&nbsp;to&nbsp;either&nbsp;the&nbsp;server&#39;s&nbsp;Handler&nbsp;or</span><br>
<span class="lineno">1690</span><span class="comment" id="3484506">//&nbsp;DefaultServeMux&nbsp;and&nbsp;also&nbsp;handles&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="3484564">type</span>&nbsp;<span class="ident" id="3484569">serverHandler</span>&nbsp;<span class="keyword" id="3484583">struct</span>&nbsp;<span class="op" id="3484590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484593">srv</span>&nbsp;<span class="op" id="3484597">*</span><span class="ident" id="3484598">Server</span><br>
<span class="lineno"></span><span class="op" id="3484605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1695</span><span class="keyword" id="3484608">func</span>&nbsp;<span class="op" id="3484613">(</span><span class="ident" id="3484614">sh</span>&nbsp;<span class="ident" id="3484617">serverHandler</span><span class="op" id="3484630">)</span>&nbsp;<span class="ident" id="3484632">ServeHTTP</span><span class="op" id="3484641">(</span><span class="ident" id="3484642">rw</span>&nbsp;<span class="ident" id="3484645">ResponseWriter</span><span class="op" id="3484659">,</span>&nbsp;<span class="ident" id="3484661">req</span>&nbsp;<span class="op" id="3484665">*</span><span class="ident" id="3484666">Request</span><span class="op" id="3484673">)</span>&nbsp;<span class="op" id="3484675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484678">handler</span>&nbsp;<span class="op" id="3484686">:=</span>&nbsp;<span class="ident" id="3484689">sh</span><span class="op" id="3484691">.</span><span class="ident" id="3484692">srv</span><span class="op" id="3484695">.</span><span class="ident" id="3484696">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484705">if</span>&nbsp;<span class="ident" id="3484708">handler</span>&nbsp;<span class="op" id="3484716">==</span>&nbsp;<span class="ident" id="3484719">nil</span>&nbsp;<span class="op" id="3484723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484727">handler</span>&nbsp;<span class="op" id="3484735">=</span>&nbsp;<span class="ident" id="3484737">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3484754">}</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3484757">if</span>&nbsp;<span class="ident" id="3484760">req</span><span class="op" id="3484763">.</span><span class="ident" id="3484764">RequestURI</span>&nbsp;<span class="op" id="3484775">==</span>&nbsp;<span class="string" id="3484778">&#34;*&#34;</span>&nbsp;<span class="op" id="3484782">&amp;&amp;</span>&nbsp;<span class="ident" id="3484785">req</span><span class="op" id="3484788">.</span><span class="ident" id="3484789">Method</span>&nbsp;<span class="op" id="3484796">==</span>&nbsp;<span class="string" id="3484799">&#34;OPTIONS&#34;</span>&nbsp;<span class="op" id="3484809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484813">handler</span>&nbsp;<span class="op" id="3484821">=</span>&nbsp;<span class="ident" id="3484823">globalOptionsHandler</span><span class="op" id="3484843">{</span><span class="op" id="3484844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3484847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3484850">handler</span><span class="op" id="3484857">.</span><span class="ident" id="3484858">ServeHTTP</span><span class="op" id="3484867">(</span><span class="ident" id="3484868">rw</span><span class="op" id="3484870">,</span>&nbsp;<span class="ident" id="3484872">req</span><span class="op" id="3484875">)</span><br>
<span class="lineno"></span><span class="op" id="3484877">}</span><br>
<span class="lineno">1705</span><br>
<span class="lineno"></span><span class="comment" id="3484880">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3484951">//&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;If</span><br>
<span class="lineno"></span><span class="comment" id="3485014">//&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:http&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3485053">func</span>&nbsp;<span class="op" id="3485058">(</span><span class="ident" id="3485059">srv</span>&nbsp;<span class="op" id="3485063">*</span><span class="ident" id="3485064">Server</span><span class="op" id="3485070">)</span>&nbsp;<span class="ident" id="3485072">ListenAndServe</span><span class="op" id="3485086">(</span><span class="op" id="3485087">)</span>&nbsp;<span class="builtintype" id="3485089">error</span>&nbsp;<span class="op" id="3485095">{</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485098">addr</span>&nbsp;<span class="op" id="3485103">:=</span>&nbsp;<span class="ident" id="3485106">srv</span><span class="op" id="3485109">.</span><span class="ident" id="3485110">Addr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3485116">if</span>&nbsp;<span class="ident" id="3485119">addr</span>&nbsp;<span class="op" id="3485124">==</span>&nbsp;<span class="string" id="3485127">&#34;&#34;</span>&nbsp;<span class="op" id="3485130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485134">addr</span>&nbsp;<span class="op" id="3485139">=</span>&nbsp;<span class="string" id="3485141">&#34;:http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3485150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485153">ln</span><span class="op" id="3485155">,</span>&nbsp;<span class="ident" id="3485157">err</span>&nbsp;<span class="op" id="3485161">:=</span>&nbsp;<span class="ident" id="3485164">net</span><span class="op" id="3485167">.</span><span class="ident" id="3485168">Listen</span><span class="op" id="3485174">(</span><span class="string" id="3485175">&#34;tcp&#34;</span><span class="op" id="3485180">,</span>&nbsp;<span class="ident" id="3485182">addr</span><span class="op" id="3485186">)</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3485189">if</span>&nbsp;<span class="ident" id="3485192">err</span>&nbsp;<span class="op" id="3485196">!=</span>&nbsp;<span class="ident" id="3485199">nil</span>&nbsp;<span class="op" id="3485203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3485207">return</span>&nbsp;<span class="ident" id="3485214">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3485219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3485222">return</span>&nbsp;<span class="ident" id="3485229">srv</span><span class="op" id="3485232">.</span><span class="ident" id="3485233">Serve</span><span class="op" id="3485238">(</span><span class="ident" id="3485239">tcpKeepAliveListener</span><span class="op" id="3485259">{</span><span class="ident" id="3485260">ln</span><span class="op" id="3485262">.</span><span class="op" id="3485263">(</span><span class="op" id="3485264">*</span><span class="ident" id="3485265">net</span><span class="op" id="3485268">.</span><span class="ident" id="3485269">TCPListener</span><span class="op" id="3485280">)</span><span class="op" id="3485281">}</span><span class="op" id="3485282">)</span><br>
<span class="lineno"></span><span class="op" id="3485284">}</span><br>
<span class="lineno">1720</span><br>
<span class="lineno"></span><span class="comment" id="3485287">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;connections&nbsp;on&nbsp;the&nbsp;Listener&nbsp;l,&nbsp;creating&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3485355">//&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines&nbsp;read&nbsp;requests&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3485432">//&nbsp;then&nbsp;call&nbsp;srv.Handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="3485475">func</span>&nbsp;<span class="op" id="3485480">(</span><span class="ident" id="3485481">srv</span>&nbsp;<span class="op" id="3485485">*</span><span class="ident" id="3485486">Server</span><span class="op" id="3485492">)</span>&nbsp;<span class="ident" id="3485494">Serve</span><span class="op" id="3485499">(</span><span class="ident" id="3485500">l</span>&nbsp;<span class="ident" id="3485502">net</span><span class="op" id="3485505">.</span><span class="ident" id="3485506">Listener</span><span class="op" id="3485514">)</span>&nbsp;<span class="builtintype" id="3485516">error</span>&nbsp;<span class="op" id="3485522">{</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3485525">defer</span>&nbsp;<span class="ident" id="3485531">l</span><span class="op" id="3485532">.</span><span class="ident" id="3485533">Close</span><span class="op" id="3485538">(</span><span class="op" id="3485539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3485542">var</span>&nbsp;<span class="ident" id="3485546">tempDelay</span>&nbsp;<span class="ident" id="3485556">time</span><span class="op" id="3485560">.</span><span class="ident" id="3485561">Duration</span>&nbsp;<span class="comment" id="3485570">//&nbsp;how&nbsp;long&nbsp;to&nbsp;sleep&nbsp;on&nbsp;accept&nbsp;failure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3485610">for</span>&nbsp;<span class="op" id="3485614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485618">rw</span><span class="op" id="3485620">,</span>&nbsp;<span class="ident" id="3485622">e</span>&nbsp;<span class="op" id="3485624">:=</span>&nbsp;<span class="ident" id="3485627">l</span><span class="op" id="3485628">.</span><span class="ident" id="3485629">Accept</span><span class="op" id="3485635">(</span><span class="op" id="3485636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3485640">if</span>&nbsp;<span class="ident" id="3485643">e</span>&nbsp;<span class="op" id="3485645">!=</span>&nbsp;<span class="ident" id="3485648">nil</span>&nbsp;<span class="op" id="3485652">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3485657">if</span>&nbsp;<span class="ident" id="3485660">ne</span><span class="op" id="3485662">,</span>&nbsp;<span class="ident" id="3485664">ok</span>&nbsp;<span class="op" id="3485667">:=</span>&nbsp;<span class="ident" id="3485670">e</span><span class="op" id="3485671">.</span><span class="op" id="3485672">(</span><span class="ident" id="3485673">net</span><span class="op" id="3485676">.</span><span class="ident" id="3485677">Error</span><span class="op" id="3485682">)</span><span class="op" id="3485683">;</span>&nbsp;<span class="ident" id="3485685">ok</span>&nbsp;<span class="op" id="3485688">&amp;&amp;</span>&nbsp;<span class="ident" id="3485691">ne</span><span class="op" id="3485693">.</span><span class="ident" id="3485694">Temporary</span><span class="op" id="3485703">(</span><span class="op" id="3485704">)</span>&nbsp;<span class="op" id="3485706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3485712">if</span>&nbsp;<span class="ident" id="3485715">tempDelay</span>&nbsp;<span class="op" id="3485725">==</span>&nbsp;<span class="num" id="3485728">0</span>&nbsp;<span class="op" id="3485730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485737">tempDelay</span>&nbsp;<span class="op" id="3485747">=</span>&nbsp;<span class="num" id="3485749">5</span>&nbsp;<span class="op" id="3485751">*</span>&nbsp;<span class="ident" id="3485753">time</span><span class="op" id="3485757">.</span><span class="ident" id="3485758">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3485774">}</span>&nbsp;<span class="keyword" id="3485776">else</span>&nbsp;<span class="op" id="3485781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485788">tempDelay</span>&nbsp;<span class="op" id="3485798">*=</span>&nbsp;<span class="num" id="3485801">2</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3485807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3485813">if</span>&nbsp;<span class="ident" id="3485816">max</span>&nbsp;<span class="op" id="3485820">:=</span>&nbsp;<span class="num" id="3485823">1</span>&nbsp;<span class="op" id="3485825">*</span>&nbsp;<span class="ident" id="3485827">time</span><span class="op" id="3485831">.</span><span class="ident" id="3485832">Second</span><span class="op" id="3485838">;</span>&nbsp;<span class="ident" id="3485840">tempDelay</span>&nbsp;<span class="op" id="3485850">&gt;</span>&nbsp;<span class="ident" id="3485852">max</span>&nbsp;<span class="op" id="3485856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485863">tempDelay</span>&nbsp;<span class="op" id="3485873">=</span>&nbsp;<span class="ident" id="3485875">max</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3485883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485889">srv</span><span class="op" id="3485892">.</span><span class="ident" id="3485893">logf</span><span class="op" id="3485897">(</span><span class="string" id="3485898">&#34;http:&nbsp;Accept&nbsp;error:&nbsp;%v;&nbsp;retrying&nbsp;in&nbsp;%v&#34;</span><span class="op" id="3485938">,</span>&nbsp;<span class="ident" id="3485940">e</span><span class="op" id="3485941">,</span>&nbsp;<span class="ident" id="3485943">tempDelay</span><span class="op" id="3485952">)</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3485958">time</span><span class="op" id="3485962">.</span><span class="ident" id="3485963">Sleep</span><span class="op" id="3485968">(</span><span class="ident" id="3485969">tempDelay</span><span class="op" id="3485978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3485984">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3485996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486001">return</span>&nbsp;<span class="ident" id="3486008">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3486012">}</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3486016">tempDelay</span>&nbsp;<span class="op" id="3486026">=</span>&nbsp;<span class="num" id="3486028">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3486032">c</span><span class="op" id="3486033">,</span>&nbsp;<span class="ident" id="3486035">err</span>&nbsp;<span class="op" id="3486039">:=</span>&nbsp;<span class="ident" id="3486042">srv</span><span class="op" id="3486045">.</span><span class="ident" id="3486046">newConn</span><span class="op" id="3486053">(</span><span class="ident" id="3486054">rw</span><span class="op" id="3486056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486060">if</span>&nbsp;<span class="ident" id="3486063">err</span>&nbsp;<span class="op" id="3486067">!=</span>&nbsp;<span class="ident" id="3486070">nil</span>&nbsp;<span class="op" id="3486074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486079">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3486090">}</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3486094">c</span><span class="op" id="3486095">.</span><span class="ident" id="3486096">setState</span><span class="op" id="3486104">(</span><span class="ident" id="3486105">c</span><span class="op" id="3486106">.</span><span class="ident" id="3486107">rwc</span><span class="op" id="3486110">,</span>&nbsp;<span class="ident" id="3486112">StateNew</span><span class="op" id="3486120">)</span>&nbsp;<span class="comment" id="3486122">//&nbsp;before&nbsp;Serve&nbsp;can&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486151">go</span>&nbsp;<span class="ident" id="3486154">c</span><span class="op" id="3486155">.</span><span class="ident" id="3486156">serve</span><span class="op" id="3486161">(</span><span class="op" id="3486162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3486165">}</span><br>
<span class="lineno"></span><span class="op" id="3486167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1755</span><span class="keyword" id="3486170">func</span>&nbsp;<span class="op" id="3486175">(</span><span class="ident" id="3486176">s</span>&nbsp;<span class="op" id="3486178">*</span><span class="ident" id="3486179">Server</span><span class="op" id="3486185">)</span>&nbsp;<span class="ident" id="3486187">doKeepAlives</span><span class="op" id="3486199">(</span><span class="op" id="3486200">)</span>&nbsp;<span class="builtintype" id="3486202">bool</span>&nbsp;<span class="op" id="3486207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486210">return</span>&nbsp;<span class="ident" id="3486217">atomic</span><span class="op" id="3486223">.</span><span class="ident" id="3486224">LoadInt32</span><span class="op" id="3486233">(</span><span class="op" id="3486234">&amp;</span><span class="ident" id="3486235">s</span><span class="op" id="3486236">.</span><span class="ident" id="3486237">disableKeepAlives</span><span class="op" id="3486254">)</span>&nbsp;<span class="op" id="3486256">==</span>&nbsp;<span class="num" id="3486259">0</span><br>
<span class="lineno"></span><span class="op" id="3486261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3486264">//&nbsp;SetKeepAlivesEnabled&nbsp;controls&nbsp;whether&nbsp;HTTP&nbsp;keep-alives&nbsp;are&nbsp;enabled.</span><br>
<span class="lineno">1760</span><span class="comment" id="3486335">//&nbsp;By&nbsp;default,&nbsp;keep-alives&nbsp;are&nbsp;always&nbsp;enabled.&nbsp;Only&nbsp;very</span><br>
<span class="lineno"></span><span class="comment" id="3486392">//&nbsp;resource-constrained&nbsp;environments&nbsp;or&nbsp;servers&nbsp;in&nbsp;the&nbsp;process&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3486458">//&nbsp;shutting&nbsp;down&nbsp;should&nbsp;disable&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="3486496">func</span>&nbsp;<span class="op" id="3486501">(</span><span class="ident" id="3486502">s</span>&nbsp;<span class="op" id="3486504">*</span><span class="ident" id="3486505">Server</span><span class="op" id="3486511">)</span>&nbsp;<span class="ident" id="3486513">SetKeepAlivesEnabled</span><span class="op" id="3486533">(</span><span class="ident" id="3486534">v</span>&nbsp;<span class="builtintype" id="3486536">bool</span><span class="op" id="3486540">)</span>&nbsp;<span class="op" id="3486542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486545">if</span>&nbsp;<span class="ident" id="3486548">v</span>&nbsp;<span class="op" id="3486550">{</span><br>
<span class="lineno">1765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3486554">atomic</span><span class="op" id="3486560">.</span><span class="ident" id="3486561">StoreInt32</span><span class="op" id="3486571">(</span><span class="op" id="3486572">&amp;</span><span class="ident" id="3486573">s</span><span class="op" id="3486574">.</span><span class="ident" id="3486575">disableKeepAlives</span><span class="op" id="3486592">,</span>&nbsp;<span class="num" id="3486594">0</span><span class="op" id="3486595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3486598">}</span>&nbsp;<span class="keyword" id="3486600">else</span>&nbsp;<span class="op" id="3486605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3486609">atomic</span><span class="op" id="3486615">.</span><span class="ident" id="3486616">StoreInt32</span><span class="op" id="3486626">(</span><span class="op" id="3486627">&amp;</span><span class="ident" id="3486628">s</span><span class="op" id="3486629">.</span><span class="ident" id="3486630">disableKeepAlives</span><span class="op" id="3486647">,</span>&nbsp;<span class="num" id="3486649">1</span><span class="op" id="3486650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3486653">}</span><br>
<span class="lineno"></span><span class="op" id="3486655">}</span><br>
<span class="lineno">1770</span><br>
<span class="lineno"></span><span class="keyword" id="3486658">func</span>&nbsp;<span class="op" id="3486663">(</span><span class="ident" id="3486664">s</span>&nbsp;<span class="op" id="3486666">*</span><span class="ident" id="3486667">Server</span><span class="op" id="3486673">)</span>&nbsp;<span class="ident" id="3486675">logf</span><span class="op" id="3486679">(</span><span class="ident" id="3486680">format</span>&nbsp;<span class="builtintype" id="3486687">string</span><span class="op" id="3486693">,</span>&nbsp;<span class="ident" id="3486695">args</span>&nbsp;<span class="op" id="3486700">...</span><span class="keyword" id="3486703">interface</span><span class="op" id="3486712">{</span><span class="op" id="3486713">}</span><span class="op" id="3486714">)</span>&nbsp;<span class="op" id="3486716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3486719">if</span>&nbsp;<span class="ident" id="3486722">s</span><span class="op" id="3486723">.</span><span class="ident" id="3486724">ErrorLog</span>&nbsp;<span class="op" id="3486733">!=</span>&nbsp;<span class="ident" id="3486736">nil</span>&nbsp;<span class="op" id="3486740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3486744">s</span><span class="op" id="3486745">.</span><span class="ident" id="3486746">ErrorLog</span><span class="op" id="3486754">.</span><span class="ident" id="3486755">Printf</span><span class="op" id="3486761">(</span><span class="ident" id="3486762">format</span><span class="op" id="3486768">,</span>&nbsp;<span class="ident" id="3486770">args</span><span class="op" id="3486774">...</span><span class="op" id="3486777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3486780">}</span>&nbsp;<span class="keyword" id="3486782">else</span>&nbsp;<span class="op" id="3486787">{</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3486791">log</span><span class="op" id="3486794">.</span><span class="ident" id="3486795">Printf</span><span class="op" id="3486801">(</span><span class="ident" id="3486802">format</span><span class="op" id="3486808">,</span>&nbsp;<span class="ident" id="3486810">args</span><span class="op" id="3486814">...</span><span class="op" id="3486817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3486820">}</span><br>
<span class="lineno"></span><span class="op" id="3486822">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3486825">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;addr</span><br>
<span class="lineno">1780</span><span class="comment" id="3486883">//&nbsp;and&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;with&nbsp;handler&nbsp;to&nbsp;handle&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3486939">//&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="3486994">//&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="3487040">//</span><br>
<span class="lineno"></span><span class="comment" id="3487043">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno">1785</span><span class="comment" id="3487075">//</span><br>
<span class="lineno"></span><span class="comment" id="3487078">//&nbsp;&nbsp;&nbsp;&nbsppackage&nbsp;main</span><br>
<span class="lineno"></span><span class="comment" id="3487094">//</span><br>
<span class="lineno"></span><span class="comment" id="3487097">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;(</span><br>
<span class="lineno"></span><span class="comment" id="3487109">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;io&#34;</span><br>
<span class="lineno">1790</span><span class="comment" id="3487118">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3487133">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3487143">//&nbsp;&nbsp;&nbsp;&nbsp)</span><br>
<span class="lineno"></span><span class="comment" id="3487148">//</span><br>
<span class="lineno"></span><span class="comment" id="3487151">//&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;hello&nbsp;world,&nbsp;the&nbsp;web&nbsp;server</span><br>
<span class="lineno">1795</span><span class="comment" id="3487185">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;HelloServer(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3487249">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspio.WriteString(w,&nbsp;&#34;hello,&nbsp;world!\n&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3487290">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3487295">//</span><br>
<span class="lineno"></span><span class="comment" id="3487298">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1800</span><span class="comment" id="3487315">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsphttp.HandleFunc(&#34;/hello&#34;,&nbsp;HelloServer)</span><br>
<span class="lineno"></span><span class="comment" id="3487358">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;:=&nbsp;http.ListenAndServe(&#34;:12345&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="3487404">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3487424">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;ListenAndServe:&nbsp;&#34;,&nbsp;err)</span><br>
<span class="lineno"></span><span class="comment" id="3487464">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno">1805</span><span class="comment" id="3487470">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="keyword" id="3487475">func</span>&nbsp;<span class="ident" id="3487480">ListenAndServe</span><span class="op" id="3487494">(</span><span class="ident" id="3487495">addr</span>&nbsp;<span class="builtintype" id="3487500">string</span><span class="op" id="3487506">,</span>&nbsp;<span class="ident" id="3487508">handler</span>&nbsp;<span class="ident" id="3487516">Handler</span><span class="op" id="3487523">)</span>&nbsp;<span class="builtintype" id="3487525">error</span>&nbsp;<span class="op" id="3487531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3487534">server</span>&nbsp;<span class="op" id="3487541">:=</span>&nbsp;<span class="op" id="3487544">&amp;</span><span class="ident" id="3487545">Server</span><span class="op" id="3487551">{</span><span class="ident" id="3487552">Addr</span><span class="op" id="3487556">:</span>&nbsp;<span class="ident" id="3487558">addr</span><span class="op" id="3487562">,</span>&nbsp;<span class="ident" id="3487564">Handler</span><span class="op" id="3487571">:</span>&nbsp;<span class="ident" id="3487573">handler</span><span class="op" id="3487580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3487583">return</span>&nbsp;<span class="ident" id="3487590">server</span><span class="op" id="3487596">.</span><span class="ident" id="3487597">ListenAndServe</span><span class="op" id="3487611">(</span><span class="op" id="3487612">)</span><br>
<span class="lineno"></span><span class="op" id="3487614">}</span><br>
<span class="lineno">1810</span><br>
<span class="lineno"></span><span class="comment" id="3487617">//&nbsp;ListenAndServeTLS&nbsp;acts&nbsp;identically&nbsp;to&nbsp;ListenAndServe,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3487689">//&nbsp;expects&nbsp;HTTPS&nbsp;connections.&nbsp;Additionally,&nbsp;files&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3487768">//&nbsp;matching&nbsp;private&nbsp;key&nbsp;for&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate</span><br>
<span class="lineno"></span><span class="comment" id="3487844">//&nbsp;is&nbsp;signed&nbsp;by&nbsp;a&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1815</span><span class="comment" id="3487926">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="3487991">//</span><br>
<span class="lineno"></span><span class="comment" id="3487994">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno"></span><span class="comment" id="3488026">//</span><br>
<span class="lineno"></span><span class="comment" id="3488029">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;(</span><br>
<span class="lineno">1820</span><span class="comment" id="3488041">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3488051">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3488066">//&nbsp;&nbsp;&nbsp;&nbsp)</span><br>
<span class="lineno"></span><span class="comment" id="3488071">//</span><br>
<span class="lineno"></span><span class="comment" id="3488074">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;handler(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno">1825</span><span class="comment" id="3488134">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspw.Header().Set(&#34;Content-Type&#34;,&nbsp;&#34;text/plain&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3488183">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspw.Write([]byte(&#34;This&nbsp;is&nbsp;an&nbsp;example&nbsp;server.\n&#34;))</span><br>
<span class="lineno"></span><span class="comment" id="3488235">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3488240">//</span><br>
<span class="lineno"></span><span class="comment" id="3488243">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1830</span><span class="comment" id="3488260">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsphttp.HandleFunc(&#34;/&#34;,&nbsp;handler)</span><br>
<span class="lineno"></span><span class="comment" id="3488294">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Printf(&#34;About&nbsp;to&nbsp;listen&nbsp;on&nbsp;10443.&nbsp;Go&nbsp;to&nbsp;https://127.0.0.1:10443/&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3488369">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;:=&nbsp;http.ListenAndServeTLS(&#34;:10443&#34;,&nbsp;&#34;cert.pem&#34;,&nbsp;&#34;key.pem&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="3488441">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3488461">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(err)</span><br>
<span class="lineno">1835</span><span class="comment" id="3488481">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3488487">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3488492">//</span><br>
<span class="lineno"></span><span class="comment" id="3488495">//&nbsp;One&nbsp;can&nbsp;use&nbsp;generate_cert.go&nbsp;in&nbsp;crypto/tls&nbsp;to&nbsp;generate&nbsp;cert.pem&nbsp;and&nbsp;key.pem.</span><br>
<span class="lineno"></span><span class="keyword" id="3488575">func</span>&nbsp;<span class="ident" id="3488580">ListenAndServeTLS</span><span class="op" id="3488597">(</span><span class="ident" id="3488598">addr</span>&nbsp;<span class="builtintype" id="3488603">string</span><span class="op" id="3488609">,</span>&nbsp;<span class="ident" id="3488611">certFile</span>&nbsp;<span class="builtintype" id="3488620">string</span><span class="op" id="3488626">,</span>&nbsp;<span class="ident" id="3488628">keyFile</span>&nbsp;<span class="builtintype" id="3488636">string</span><span class="op" id="3488642">,</span>&nbsp;<span class="ident" id="3488644">handler</span>&nbsp;<span class="ident" id="3488652">Handler</span><span class="op" id="3488659">)</span>&nbsp;<span class="builtintype" id="3488661">error</span>&nbsp;<span class="op" id="3488667">{</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3488670">server</span>&nbsp;<span class="op" id="3488677">:=</span>&nbsp;<span class="op" id="3488680">&amp;</span><span class="ident" id="3488681">Server</span><span class="op" id="3488687">{</span><span class="ident" id="3488688">Addr</span><span class="op" id="3488692">:</span>&nbsp;<span class="ident" id="3488694">addr</span><span class="op" id="3488698">,</span>&nbsp;<span class="ident" id="3488700">Handler</span><span class="op" id="3488707">:</span>&nbsp;<span class="ident" id="3488709">handler</span><span class="op" id="3488716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3488719">return</span>&nbsp;<span class="ident" id="3488726">server</span><span class="op" id="3488732">.</span><span class="ident" id="3488733">ListenAndServeTLS</span><span class="op" id="3488750">(</span><span class="ident" id="3488751">certFile</span><span class="op" id="3488759">,</span>&nbsp;<span class="ident" id="3488761">keyFile</span><span class="op" id="3488768">)</span><br>
<span class="lineno"></span><span class="op" id="3488770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3488773">//&nbsp;ListenAndServeTLS&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and</span><br>
<span class="lineno">1845</span><span class="comment" id="3488842">//&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="3488910">//</span><br>
<span class="lineno"></span><span class="comment" id="3488913">//&nbsp;Filenames&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and&nbsp;matching&nbsp;private&nbsp;key&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3488980">//&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3489046">//&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1850</span><span class="comment" id="3489113">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="3489178">//</span><br>
<span class="lineno"></span><span class="comment" id="3489181">//&nbsp;If&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:https&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3489224">func</span>&nbsp;<span class="op" id="3489229">(</span><span class="ident" id="3489230">srv</span>&nbsp;<span class="op" id="3489234">*</span><span class="ident" id="3489235">Server</span><span class="op" id="3489241">)</span>&nbsp;<span class="ident" id="3489243">ListenAndServeTLS</span><span class="op" id="3489260">(</span><span class="ident" id="3489261">certFile</span><span class="op" id="3489269">,</span>&nbsp;<span class="ident" id="3489271">keyFile</span>&nbsp;<span class="builtintype" id="3489279">string</span><span class="op" id="3489285">)</span>&nbsp;<span class="builtintype" id="3489287">error</span>&nbsp;<span class="op" id="3489293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489296">addr</span>&nbsp;<span class="op" id="3489301">:=</span>&nbsp;<span class="ident" id="3489304">srv</span><span class="op" id="3489307">.</span><span class="ident" id="3489308">Addr</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489314">if</span>&nbsp;<span class="ident" id="3489317">addr</span>&nbsp;<span class="op" id="3489322">==</span>&nbsp;<span class="string" id="3489325">&#34;&#34;</span>&nbsp;<span class="op" id="3489328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489332">addr</span>&nbsp;<span class="op" id="3489337">=</span>&nbsp;<span class="string" id="3489339">&#34;:https&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3489349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489352">config</span>&nbsp;<span class="op" id="3489359">:=</span>&nbsp;<span class="op" id="3489362">&amp;</span><span class="ident" id="3489363">tls</span><span class="op" id="3489366">.</span><span class="ident" id="3489367">Config</span><span class="op" id="3489373">{</span><span class="op" id="3489374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489377">if</span>&nbsp;<span class="ident" id="3489380">srv</span><span class="op" id="3489383">.</span><span class="ident" id="3489384">TLSConfig</span>&nbsp;<span class="op" id="3489394">!=</span>&nbsp;<span class="ident" id="3489397">nil</span>&nbsp;<span class="op" id="3489401">{</span><br>
<span class="lineno">1860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3489405">*</span><span class="ident" id="3489406">config</span>&nbsp;<span class="op" id="3489413">=</span>&nbsp;<span class="op" id="3489415">*</span><span class="ident" id="3489416">srv</span><span class="op" id="3489419">.</span><span class="ident" id="3489420">TLSConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3489431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489434">if</span>&nbsp;<span class="ident" id="3489437">config</span><span class="op" id="3489443">.</span><span class="ident" id="3489444">NextProtos</span>&nbsp;<span class="op" id="3489455">==</span>&nbsp;<span class="ident" id="3489458">nil</span>&nbsp;<span class="op" id="3489462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489466">config</span><span class="op" id="3489472">.</span><span class="ident" id="3489473">NextProtos</span>&nbsp;<span class="op" id="3489484">=</span>&nbsp;<span class="op" id="3489486">[</span><span class="op" id="3489487">]</span><span class="builtintype" id="3489488">string</span><span class="op" id="3489494">{</span><span class="string" id="3489495">&#34;http/1.1&#34;</span><span class="op" id="3489505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3489508">}</span><br>
<span class="lineno">1865</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489512">var</span>&nbsp;<span class="ident" id="3489516">err</span>&nbsp;<span class="builtintype" id="3489520">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489527">config</span><span class="op" id="3489533">.</span><span class="ident" id="3489534">Certificates</span>&nbsp;<span class="op" id="3489547">=</span>&nbsp;<span class="builtinfunc" id="3489549">make</span><span class="op" id="3489553">(</span><span class="op" id="3489554">[</span><span class="op" id="3489555">]</span><span class="ident" id="3489556">tls</span><span class="op" id="3489559">.</span><span class="ident" id="3489560">Certificate</span><span class="op" id="3489571">,</span>&nbsp;<span class="num" id="3489573">1</span><span class="op" id="3489574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489577">config</span><span class="op" id="3489583">.</span><span class="ident" id="3489584">Certificates</span><span class="op" id="3489596">[</span><span class="num" id="3489597">0</span><span class="op" id="3489598">]</span><span class="op" id="3489599">,</span>&nbsp;<span class="ident" id="3489601">err</span>&nbsp;<span class="op" id="3489605">=</span>&nbsp;<span class="ident" id="3489607">tls</span><span class="op" id="3489610">.</span><span class="ident" id="3489611">LoadX509KeyPair</span><span class="op" id="3489626">(</span><span class="ident" id="3489627">certFile</span><span class="op" id="3489635">,</span>&nbsp;<span class="ident" id="3489637">keyFile</span><span class="op" id="3489644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489647">if</span>&nbsp;<span class="ident" id="3489650">err</span>&nbsp;<span class="op" id="3489654">!=</span>&nbsp;<span class="ident" id="3489657">nil</span>&nbsp;<span class="op" id="3489661">{</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489665">return</span>&nbsp;<span class="ident" id="3489672">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3489677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489681">ln</span><span class="op" id="3489683">,</span>&nbsp;<span class="ident" id="3489685">err</span>&nbsp;<span class="op" id="3489689">:=</span>&nbsp;<span class="ident" id="3489692">net</span><span class="op" id="3489695">.</span><span class="ident" id="3489696">Listen</span><span class="op" id="3489702">(</span><span class="string" id="3489703">&#34;tcp&#34;</span><span class="op" id="3489708">,</span>&nbsp;<span class="ident" id="3489710">addr</span><span class="op" id="3489714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489717">if</span>&nbsp;<span class="ident" id="3489720">err</span>&nbsp;<span class="op" id="3489724">!=</span>&nbsp;<span class="ident" id="3489727">nil</span>&nbsp;<span class="op" id="3489731">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489735">return</span>&nbsp;<span class="ident" id="3489742">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3489747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3489751">tlsListener</span>&nbsp;<span class="op" id="3489763">:=</span>&nbsp;<span class="ident" id="3489766">tls</span><span class="op" id="3489769">.</span><span class="ident" id="3489770">NewListener</span><span class="op" id="3489781">(</span><span class="ident" id="3489782">tcpKeepAliveListener</span><span class="op" id="3489802">{</span><span class="ident" id="3489803">ln</span><span class="op" id="3489805">.</span><span class="op" id="3489806">(</span><span class="op" id="3489807">*</span><span class="ident" id="3489808">net</span><span class="op" id="3489811">.</span><span class="ident" id="3489812">TCPListener</span><span class="op" id="3489823">)</span><span class="op" id="3489824">}</span><span class="op" id="3489825">,</span>&nbsp;<span class="ident" id="3489827">config</span><span class="op" id="3489833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3489836">return</span>&nbsp;<span class="ident" id="3489843">srv</span><span class="op" id="3489846">.</span><span class="ident" id="3489847">Serve</span><span class="op" id="3489852">(</span><span class="ident" id="3489853">tlsListener</span><span class="op" id="3489864">)</span><br>
<span class="lineno">1880</span><span class="op" id="3489866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3489869">//&nbsp;TimeoutHandler&nbsp;returns&nbsp;a&nbsp;Handler&nbsp;that&nbsp;runs&nbsp;h&nbsp;with&nbsp;the&nbsp;given&nbsp;time&nbsp;limit.</span><br>
<span class="lineno"></span><span class="comment" id="3489944">//</span><br>
<span class="lineno"></span><span class="comment" id="3489947">//&nbsp;The&nbsp;new&nbsp;Handler&nbsp;calls&nbsp;h.ServeHTTP&nbsp;to&nbsp;handle&nbsp;each&nbsp;request,&nbsp;but&nbsp;if&nbsp;a</span><br>
<span class="lineno">1885</span><span class="comment" id="3490017">//&nbsp;call&nbsp;runs&nbsp;for&nbsp;longer&nbsp;than&nbsp;its&nbsp;time&nbsp;limit,&nbsp;the&nbsp;handler&nbsp;responds&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="3490088">//&nbsp;a&nbsp;503&nbsp;Service&nbsp;Unavailable&nbsp;error&nbsp;and&nbsp;the&nbsp;given&nbsp;message&nbsp;in&nbsp;its&nbsp;body.</span><br>
<span class="lineno"></span><span class="comment" id="3490158">//&nbsp;(If&nbsp;msg&nbsp;is&nbsp;empty,&nbsp;a&nbsp;suitable&nbsp;default&nbsp;message&nbsp;will&nbsp;be&nbsp;sent.)</span><br>
<span class="lineno"></span><span class="comment" id="3490221">//&nbsp;After&nbsp;such&nbsp;a&nbsp;timeout,&nbsp;writes&nbsp;by&nbsp;h&nbsp;to&nbsp;its&nbsp;ResponseWriter&nbsp;will&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="3490292">//&nbsp;ErrHandlerTimeout.</span><br>
<span class="lineno">1890</span><span class="keyword" id="3490314">func</span>&nbsp;<span class="ident" id="3490319">TimeoutHandler</span><span class="op" id="3490333">(</span><span class="ident" id="3490334">h</span>&nbsp;<span class="ident" id="3490336">Handler</span><span class="op" id="3490343">,</span>&nbsp;<span class="ident" id="3490345">dt</span>&nbsp;<span class="ident" id="3490348">time</span><span class="op" id="3490352">.</span><span class="ident" id="3490353">Duration</span><span class="op" id="3490361">,</span>&nbsp;<span class="ident" id="3490363">msg</span>&nbsp;<span class="builtintype" id="3490367">string</span><span class="op" id="3490373">)</span>&nbsp;<span class="ident" id="3490375">Handler</span>&nbsp;<span class="op" id="3490383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3490386">f</span>&nbsp;<span class="op" id="3490388">:=</span>&nbsp;<span class="keyword" id="3490391">func</span><span class="op" id="3490395">(</span><span class="op" id="3490396">)</span>&nbsp;<span class="op" id="3490398">&lt;-</span><span class="keyword" id="3490400">chan</span>&nbsp;<span class="ident" id="3490405">time</span><span class="op" id="3490409">.</span><span class="ident" id="3490410">Time</span>&nbsp;<span class="op" id="3490415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3490419">return</span>&nbsp;<span class="ident" id="3490426">time</span><span class="op" id="3490430">.</span><span class="ident" id="3490431">After</span><span class="op" id="3490436">(</span><span class="ident" id="3490437">dt</span><span class="op" id="3490439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3490442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3490445">return</span>&nbsp;<span class="op" id="3490452">&amp;</span><span class="ident" id="3490453">timeoutHandler</span><span class="op" id="3490467">{</span><span class="ident" id="3490468">h</span><span class="op" id="3490469">,</span>&nbsp;<span class="ident" id="3490471">f</span><span class="op" id="3490472">,</span>&nbsp;<span class="ident" id="3490474">msg</span><span class="op" id="3490477">}</span><br>
<span class="lineno">1895</span><span class="op" id="3490479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3490482">//&nbsp;ErrHandlerTimeout&nbsp;is&nbsp;returned&nbsp;on&nbsp;ResponseWriter&nbsp;Write&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="3490545">//&nbsp;in&nbsp;handlers&nbsp;which&nbsp;have&nbsp;timed&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3490582">var</span>&nbsp;<span class="ident" id="3490586">ErrHandlerTimeout</span>&nbsp;<span class="op" id="3490604">=</span>&nbsp;<span class="ident" id="3490606">errors</span><span class="op" id="3490612">.</span><span class="ident" id="3490613">New</span><span class="op" id="3490616">(</span><span class="string" id="3490617">&#34;http:&nbsp;Handler&nbsp;timeout&#34;</span><span class="op" id="3490640">)</span><br>
<span class="lineno">1900</span><br>
<span class="lineno"></span><span class="keyword" id="3490643">type</span>&nbsp;<span class="ident" id="3490648">timeoutHandler</span>&nbsp;<span class="keyword" id="3490663">struct</span>&nbsp;<span class="op" id="3490670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3490673">handler</span>&nbsp;<span class="ident" id="3490681">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3490690">timeout</span>&nbsp;<span class="keyword" id="3490698">func</span><span class="op" id="3490702">(</span><span class="op" id="3490703">)</span>&nbsp;<span class="op" id="3490705">&lt;-</span><span class="keyword" id="3490707">chan</span>&nbsp;<span class="ident" id="3490712">time</span><span class="op" id="3490716">.</span><span class="ident" id="3490717">Time</span>&nbsp;<span class="comment" id="3490722">//&nbsp;returns&nbsp;channel&nbsp;producing&nbsp;a&nbsp;timeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3490762">body</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3490770">string</span><br>
<span class="lineno">1905</span><span class="op" id="3490777">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3490780">func</span>&nbsp;<span class="op" id="3490785">(</span><span class="ident" id="3490786">h</span>&nbsp;<span class="op" id="3490788">*</span><span class="ident" id="3490789">timeoutHandler</span><span class="op" id="3490803">)</span>&nbsp;<span class="ident" id="3490805">errorBody</span><span class="op" id="3490814">(</span><span class="op" id="3490815">)</span>&nbsp;<span class="builtintype" id="3490817">string</span>&nbsp;<span class="op" id="3490824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3490827">if</span>&nbsp;<span class="ident" id="3490830">h</span><span class="op" id="3490831">.</span><span class="ident" id="3490832">body</span>&nbsp;<span class="op" id="3490837">!=</span>&nbsp;<span class="string" id="3490840">&#34;&#34;</span>&nbsp;<span class="op" id="3490843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3490847">return</span>&nbsp;<span class="ident" id="3490854">h</span><span class="op" id="3490855">.</span><span class="ident" id="3490856">body</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3490862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3490865">return</span>&nbsp;<span class="string" id="3490872">&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Timeout&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Timeout&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3490952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3490955">func</span>&nbsp;<span class="op" id="3490960">(</span><span class="ident" id="3490961">h</span>&nbsp;<span class="op" id="3490963">*</span><span class="ident" id="3490964">timeoutHandler</span><span class="op" id="3490978">)</span>&nbsp;<span class="ident" id="3490980">ServeHTTP</span><span class="op" id="3490989">(</span><span class="ident" id="3490990">w</span>&nbsp;<span class="ident" id="3490992">ResponseWriter</span><span class="op" id="3491006">,</span>&nbsp;<span class="ident" id="3491008">r</span>&nbsp;<span class="op" id="3491010">*</span><span class="ident" id="3491011">Request</span><span class="op" id="3491018">)</span>&nbsp;<span class="op" id="3491020">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3491023">done</span>&nbsp;<span class="op" id="3491028">:=</span>&nbsp;<span class="builtinfunc" id="3491031">make</span><span class="op" id="3491035">(</span><span class="keyword" id="3491036">chan</span>&nbsp;<span class="builtintype" id="3491041">bool</span><span class="op" id="3491045">,</span>&nbsp;<span class="num" id="3491047">1</span><span class="op" id="3491048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3491051">tw</span>&nbsp;<span class="op" id="3491054">:=</span>&nbsp;<span class="op" id="3491057">&amp;</span><span class="ident" id="3491058">timeoutWriter</span><span class="op" id="3491071">{</span><span class="ident" id="3491072">w</span><span class="op" id="3491073">:</span>&nbsp;<span class="ident" id="3491075">w</span><span class="op" id="3491076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3491079">go</span>&nbsp;<span class="keyword" id="3491082">func</span><span class="op" id="3491086">(</span><span class="op" id="3491087">)</span>&nbsp;<span class="op" id="3491089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3491093">h</span><span class="op" id="3491094">.</span><span class="ident" id="3491095">handler</span><span class="op" id="3491102">.</span><span class="ident" id="3491103">ServeHTTP</span><span class="op" id="3491112">(</span><span class="ident" id="3491113">tw</span><span class="op" id="3491115">,</span>&nbsp;<span class="ident" id="3491117">r</span><span class="op" id="3491118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3491122">done</span>&nbsp;<span class="op" id="3491127">&lt;-</span>&nbsp;<span class="builtintype" id="3491130">true</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3491136">}</span><span class="op" id="3491137">(</span><span class="op" id="3491138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3491141">select</span>&nbsp;<span class="op" id="3491148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3491151">case</span>&nbsp;<span class="op" id="3491156">&lt;-</span><span class="ident" id="3491158">done</span><span class="op" id="3491162">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3491166">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3491174">case</span>&nbsp;<span class="op" id="3491179">&lt;-</span><span class="ident" id="3491181">h</span><span class="op" id="3491182">.</span><span class="ident" id="3491183">timeout</span><span class="op" id="3491190">(</span><span class="op" id="3491191">)</span><span class="op" id="3491192">:</span><br>
<span class="lineno">1925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3491196">tw</span><span class="op" id="3491198">.</span><span class="ident" id="3491199">mu</span><span class="op" id="3491201">.</span><span class="ident" id="3491202">Lock</span><span class="op" id="3491206">(</span><span class="op" id="3491207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3491211">defer</span>&nbsp;<span class="ident" id="3491217">tw</span><span class="op" id="3491219">.</span><span class="ident" id="3491220">mu</span><span class="op" id="3491222">.</span><span class="ident" id="3491223">Unlock</span><span class="op" id="3491229">(</span><span class="op" id="3491230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3491234">if</span>&nbsp;<span class="op" id="3491237">!</span><span class="ident" id="3491238">tw</span><span class="op" id="3491240">.</span><span class="ident" id="3491241">wroteHeader</span>&nbsp;<span class="op" id="3491253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3491258">tw</span><span class="op" id="3491260">.</span><span class="ident" id="3491261">w</span><span class="op" id="3491262">.</span><span class="ident" id="3491263">WriteHeader</span><span class="op" id="3491274">(</span><span class="ident" id="3491275">StatusServiceUnavailable</span><span class="op" id="3491299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3491304">tw</span><span class="op" id="3491306">.</span><span class="ident" id="3491307">w</span><span class="op" id="3491308">.</span><span class="ident" id="3491309">Write</span><span class="op" id="3491314">(</span><span class="op" id="3491315">[</span><span class="op" id="3491316">]</span><span class="builtintype" id="3491317">byte</span><span class="op" id="3491321">(</span><span class="ident" id="3491322">h</span><span class="op" id="3491323">.</span><span class="ident" id="3491324">errorBody</span><span class="op" id="3491333">(</span><span class="op" id="3491334">)</span><span class="op" id="3491335">)</span><span class="op" id="3491336">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3491340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3491344">tw</span><span class="op" id="3491346">.</span><span class="ident" id="3491347">timedOut</span>&nbsp;<span class="op" id="3491356">=</span>&nbsp;<span class="builtintype" id="3491358">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3491364">}</span><br>
<span class="lineno"></span><span class="op" id="3491366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1935</span><span class="keyword" id="3491369">type</span>&nbsp;<span class="ident" id="3491374">timeoutWriter</span>&nbsp;<span class="keyword" id="3491388">struct</span>&nbsp;<span class="op" id="3491395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3491398">w</span>&nbsp;<span class="ident" id="3491400">ResponseWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3491417">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3491429">sync</span><span class="op" id="3491433">.</span><span class="ident" id="3491434">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3491441">timedOut</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3491453">bool</span><br>
<span class="lineno">1940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3491459">wroteHeader</span>&nbsp;<span class="builtintype" id="3491471">bool</span><br>
<span class="lineno"></span><span class="op" id="3491476">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3491479">func</span>&nbsp;<span class="op" id="3491484">(</span><span class="ident" id="3491485">tw</span>&nbsp;<span class="op" id="3491488">*</span><span class="ident" id="3491489">timeoutWriter</span><span class="op" id="3491502">)</span>&nbsp;<span class="ident" id="3491504">Header</span><span class="op" id="3491510">(</span><span class="op" id="3491511">)</span>&nbsp;<span class="ident" id="3491513">Header</span>&nbsp;<span class="op" id="3491520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3491523">return</span>&nbsp;<span class="ident" id="3491530">tw</span><span class="op" id="3491532">.</span><span class="ident" id="3491533">w</span><span class="op" id="3491534">.</span><span class="ident" id="3491535">Header</span><span class="op" id="3491541">(</span><span class="op" id="3491542">)</span><br>
<span class="lineno">1945</span><span class="op" id="3491544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3491547">func</span>&nbsp;<span class="op" id="3491552">(</span><span class="ident" id="3491553">tw</span>&nbsp;<span class="op" id="3491556">*</span><span class="ident" id="3491557">timeoutWriter</span><span class="op" id="3491570">)</span>&nbsp;<span class="ident" id="3491572">Write</span><span class="op" id="3491577">(</span><span class="ident" id="3491578">p</span>&nbsp;<span class="op" id="3491580">[</span><span class="op" id="3491581">]</span><span class="builtintype" id="3491582">byte</span><span class="op" id="3491586">)</span>&nbsp;<span class="op" id="3491588">(</span><span class="builtintype" id="3491589">int</span><span class="op" id="3491592">,</span>&nbsp;<span class="builtintype" id="3491594">error</span><span class="op" id="3491599">)</span>&nbsp;<span class="op" id="3491601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3491604">tw</span><span class="op" id="3491606">.</span><span class="ident" id="3491607">mu</span><span class="op" id="3491609">.</span><span class="ident" id="3491610">Lock</span><span class="op" id="3491614">(</span><span class="op" id="3491615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3491618">defer</span>&nbsp;<span class="ident" id="3491624">tw</span><span class="op" id="3491626">.</span><span class="ident" id="3491627">mu</span><span class="op" id="3491629">.</span><span class="ident" id="3491630">Unlock</span><span class="op" id="3491636">(</span><span class="op" id="3491637">)</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3491640">tw</span><span class="op" id="3491642">.</span><span class="ident" id="3491643">wroteHeader</span>&nbsp;<span class="op" id="3491655">=</span>&nbsp;<span class="builtintype" id="3491657">true</span>&nbsp;<span class="comment" id="3491662">//&nbsp;implicitly&nbsp;at&nbsp;least</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3491686">if</span>&nbsp;<span class="ident" id="3491689">tw</span><span class="op" id="3491691">.</span><span class="ident" id="3491692">timedOut</span>&nbsp;<span class="op" id="3491701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3491705">return</span>&nbsp;<span class="num" id="3491712">0</span><span class="op" id="3491713">,</span>&nbsp;<span class="ident" id="3491715">ErrHandlerTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3491734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3491737">return</span>&nbsp;<span class="ident" id="3491744">tw</span><span class="op" id="3491746">.</span><span class="ident" id="3491747">w</span><span class="op" id="3491748">.</span><span class="ident" id="3491749">Write</span><span class="op" id="3491754">(</span><span class="ident" id="3491755">p</span><span class="op" id="3491756">)</span><br>
<span class="lineno">1955</span><span class="op" id="3491758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3491761">func</span>&nbsp;<span class="op" id="3491766">(</span><span class="ident" id="3491767">tw</span>&nbsp;<span class="op" id="3491770">*</span><span class="ident" id="3491771">timeoutWriter</span><span class="op" id="3491784">)</span>&nbsp;<span class="ident" id="3491786">WriteHeader</span><span class="op" id="3491797">(</span><span class="ident" id="3491798">code</span>&nbsp;<span class="builtintype" id="3491803">int</span><span class="op" id="3491806">)</span>&nbsp;<span class="op" id="3491808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3491811">tw</span><span class="op" id="3491813">.</span><span class="ident" id="3491814">mu</span><span class="op" id="3491816">.</span><span class="ident" id="3491817">Lock</span><span class="op" id="3491821">(</span><span class="op" id="3491822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3491825">defer</span>&nbsp;<span class="ident" id="3491831">tw</span><span class="op" id="3491833">.</span><span class="ident" id="3491834">mu</span><span class="op" id="3491836">.</span><span class="ident" id="3491837">Unlock</span><span class="op" id="3491843">(</span><span class="op" id="3491844">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3491847">if</span>&nbsp;<span class="ident" id="3491850">tw</span><span class="op" id="3491852">.</span><span class="ident" id="3491853">timedOut</span>&nbsp;<span class="op" id="3491862">||</span>&nbsp;<span class="ident" id="3491865">tw</span><span class="op" id="3491867">.</span><span class="ident" id="3491868">wroteHeader</span>&nbsp;<span class="op" id="3491880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3491884">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3491892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3491895">tw</span><span class="op" id="3491897">.</span><span class="ident" id="3491898">wroteHeader</span>&nbsp;<span class="op" id="3491910">=</span>&nbsp;<span class="builtintype" id="3491912">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3491918">tw</span><span class="op" id="3491920">.</span><span class="ident" id="3491921">w</span><span class="op" id="3491922">.</span><span class="ident" id="3491923">WriteHeader</span><span class="op" id="3491934">(</span><span class="ident" id="3491935">code</span><span class="op" id="3491939">)</span><br>
<span class="lineno">1965</span><span class="op" id="3491941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3491944">//&nbsp;tcpKeepAliveListener&nbsp;sets&nbsp;TCP&nbsp;keep-alive&nbsp;timeouts&nbsp;on&nbsp;accepted</span><br>
<span class="lineno"></span><span class="comment" id="3492009">//&nbsp;connections.&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;ListenAndServe&nbsp;and&nbsp;ListenAndServeTLS&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="3492078">//&nbsp;dead&nbsp;TCP&nbsp;connections&nbsp;(e.g.&nbsp;closing&nbsp;laptop&nbsp;mid-download)&nbsp;eventually</span><br>
<span class="lineno">1970</span><span class="comment" id="3492148">//&nbsp;go&nbsp;away.</span><br>
<span class="lineno"></span><span class="keyword" id="3492160">type</span>&nbsp;<span class="ident" id="3492165">tcpKeepAliveListener</span>&nbsp;<span class="keyword" id="3492186">struct</span>&nbsp;<span class="op" id="3492193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3492196">*</span><span class="ident" id="3492197">net</span><span class="op" id="3492200">.</span><span class="ident" id="3492201">TCPListener</span><br>
<span class="lineno"></span><span class="op" id="3492213">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1975</span><span class="keyword" id="3492216">func</span>&nbsp;<span class="op" id="3492221">(</span><span class="ident" id="3492222">ln</span>&nbsp;<span class="ident" id="3492225">tcpKeepAliveListener</span><span class="op" id="3492245">)</span>&nbsp;<span class="ident" id="3492247">Accept</span><span class="op" id="3492253">(</span><span class="op" id="3492254">)</span>&nbsp;<span class="op" id="3492256">(</span><span class="ident" id="3492257">c</span>&nbsp;<span class="ident" id="3492259">net</span><span class="op" id="3492262">.</span><span class="ident" id="3492263">Conn</span><span class="op" id="3492267">,</span>&nbsp;<span class="ident" id="3492269">err</span>&nbsp;<span class="builtintype" id="3492273">error</span><span class="op" id="3492278">)</span>&nbsp;<span class="op" id="3492280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3492283">tc</span><span class="op" id="3492285">,</span>&nbsp;<span class="ident" id="3492287">err</span>&nbsp;<span class="op" id="3492291">:=</span>&nbsp;<span class="ident" id="3492294">ln</span><span class="op" id="3492296">.</span><span class="ident" id="3492297">AcceptTCP</span><span class="op" id="3492306">(</span><span class="op" id="3492307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3492310">if</span>&nbsp;<span class="ident" id="3492313">err</span>&nbsp;<span class="op" id="3492317">!=</span>&nbsp;<span class="ident" id="3492320">nil</span>&nbsp;<span class="op" id="3492324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3492328">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3492336">}</span><br>
<span class="lineno">1980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3492339">tc</span><span class="op" id="3492341">.</span><span class="ident" id="3492342">SetKeepAlive</span><span class="op" id="3492354">(</span><span class="builtintype" id="3492355">true</span><span class="op" id="3492359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3492362">tc</span><span class="op" id="3492364">.</span><span class="ident" id="3492365">SetKeepAlivePeriod</span><span class="op" id="3492383">(</span><span class="num" id="3492384">3</span>&nbsp;<span class="op" id="3492386">*</span>&nbsp;<span class="ident" id="3492388">time</span><span class="op" id="3492392">.</span><span class="ident" id="3492393">Minute</span><span class="op" id="3492399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3492402">return</span>&nbsp;<span class="ident" id="3492409">tc</span><span class="op" id="3492411">,</span>&nbsp;<span class="ident" id="3492413">nil</span><br>
<span class="lineno"></span><span class="op" id="3492417">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1985</span><span class="comment" id="3492420">//&nbsp;globalOptionsHandler&nbsp;responds&nbsp;to&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="3492478">type</span>&nbsp;<span class="ident" id="3492483">globalOptionsHandler</span>&nbsp;<span class="keyword" id="3492504">struct</span><span class="op" id="3492510">{</span><span class="op" id="3492511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3492514">func</span>&nbsp;<span class="op" id="3492519">(</span><span class="ident" id="3492520">globalOptionsHandler</span><span class="op" id="3492540">)</span>&nbsp;<span class="ident" id="3492542">ServeHTTP</span><span class="op" id="3492551">(</span><span class="ident" id="3492552">w</span>&nbsp;<span class="ident" id="3492554">ResponseWriter</span><span class="op" id="3492568">,</span>&nbsp;<span class="ident" id="3492570">r</span>&nbsp;<span class="op" id="3492572">*</span><span class="ident" id="3492573">Request</span><span class="op" id="3492580">)</span>&nbsp;<span class="op" id="3492582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3492585">w</span><span class="op" id="3492586">.</span><span class="ident" id="3492587">Header</span><span class="op" id="3492593">(</span><span class="op" id="3492594">)</span><span class="op" id="3492595">.</span><span class="ident" id="3492596">Set</span><span class="op" id="3492599">(</span><span class="string" id="3492600">&#34;Content-Length&#34;</span><span class="op" id="3492616">,</span>&nbsp;<span class="string" id="3492618">&#34;0&#34;</span><span class="op" id="3492621">)</span><br>
<span class="lineno">1990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3492624">if</span>&nbsp;<span class="ident" id="3492627">r</span><span class="op" id="3492628">.</span><span class="ident" id="3492629">ContentLength</span>&nbsp;<span class="op" id="3492643">!=</span>&nbsp;<span class="num" id="3492646">0</span>&nbsp;<span class="op" id="3492648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3492652">//&nbsp;Read&nbsp;up&nbsp;to&nbsp;4KB&nbsp;of&nbsp;OPTIONS&nbsp;body&nbsp;(as&nbsp;mentioned&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3492709">//&nbsp;spec&nbsp;as&nbsp;being&nbsp;reserved&nbsp;for&nbsp;future&nbsp;use),&nbsp;but&nbsp;anything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3492767">//&nbsp;over&nbsp;that&nbsp;is&nbsp;considered&nbsp;a&nbsp;waste&nbsp;of&nbsp;server&nbsp;resources</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3492824">//&nbsp;(or&nbsp;an&nbsp;attack)&nbsp;and&nbsp;we&nbsp;abort&nbsp;and&nbsp;close&nbsp;the&nbsp;connection,</span><br>
<span class="lineno">1995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3492883">//&nbsp;courtesy&nbsp;of&nbsp;MaxBytesReader&#39;s&nbsp;EOF&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3492931">mb</span>&nbsp;<span class="op" id="3492934">:=</span>&nbsp;<span class="ident" id="3492937">MaxBytesReader</span><span class="op" id="3492951">(</span><span class="ident" id="3492952">w</span><span class="op" id="3492953">,</span>&nbsp;<span class="ident" id="3492955">r</span><span class="op" id="3492956">.</span><span class="ident" id="3492957">Body</span><span class="op" id="3492961">,</span>&nbsp;<span class="num" id="3492963">4</span><span class="op" id="3492964">&lt;&lt;</span><span class="num" id="3492966">10</span><span class="op" id="3492968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3492972">io</span><span class="op" id="3492974">.</span><span class="ident" id="3492975">Copy</span><span class="op" id="3492979">(</span><span class="ident" id="3492980">ioutil</span><span class="op" id="3492986">.</span><span class="ident" id="3492987">Discard</span><span class="op" id="3492994">,</span>&nbsp;<span class="ident" id="3492996">mb</span><span class="op" id="3492998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3493001">}</span><br>
<span class="lineno"></span><span class="op" id="3493003">}</span><br>
<span class="lineno">2000</span><br>
<span class="lineno"></span><span class="keyword" id="3493006">type</span>&nbsp;<span class="ident" id="3493011">eofReaderWithWriteTo</span>&nbsp;<span class="keyword" id="3493032">struct</span><span class="op" id="3493038">{</span><span class="op" id="3493039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3493042">func</span>&nbsp;<span class="op" id="3493047">(</span><span class="ident" id="3493048">eofReaderWithWriteTo</span><span class="op" id="3493068">)</span>&nbsp;<span class="ident" id="3493070">WriteTo</span><span class="op" id="3493077">(</span><span class="ident" id="3493078">io</span><span class="op" id="3493080">.</span><span class="ident" id="3493081">Writer</span><span class="op" id="3493087">)</span>&nbsp;<span class="op" id="3493089">(</span><span class="ident" id="3493090">int64</span><span class="op" id="3493095">,</span>&nbsp;<span class="builtintype" id="3493097">error</span><span class="op" id="3493102">)</span>&nbsp;<span class="op" id="3493104">{</span>&nbsp;<span class="keyword" id="3493106">return</span>&nbsp;<span class="num" id="3493113">0</span><span class="op" id="3493114">,</span>&nbsp;<span class="ident" id="3493116">nil</span>&nbsp;<span class="op" id="3493120">}</span><br>
<span class="lineno"></span><span class="keyword" id="3493122">func</span>&nbsp;<span class="op" id="3493127">(</span><span class="ident" id="3493128">eofReaderWithWriteTo</span><span class="op" id="3493148">)</span>&nbsp;<span class="ident" id="3493150">Read</span><span class="op" id="3493154">(</span><span class="op" id="3493155">[</span><span class="op" id="3493156">]</span><span class="builtintype" id="3493157">byte</span><span class="op" id="3493161">)</span>&nbsp;<span class="op" id="3493163">(</span><span class="builtintype" id="3493164">int</span><span class="op" id="3493167">,</span>&nbsp;<span class="builtintype" id="3493169">error</span><span class="op" id="3493174">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3493184">{</span>&nbsp;<span class="keyword" id="3493186">return</span>&nbsp;<span class="num" id="3493193">0</span><span class="op" id="3493194">,</span>&nbsp;<span class="ident" id="3493196">io</span><span class="op" id="3493198">.</span><span class="ident" id="3493199">EOF</span>&nbsp;<span class="op" id="3493203">}</span><br>
<span class="lineno">2005</span><br>
<span class="lineno"></span><span class="comment" id="3493206">//&nbsp;eofReader&nbsp;is&nbsp;a&nbsp;non-nil&nbsp;io.ReadCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="comment" id="3493271">//&nbsp;It&nbsp;has&nbsp;a&nbsp;WriteTo&nbsp;method&nbsp;so&nbsp;io.Copy&nbsp;won&#39;t&nbsp;need&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3493330">var</span>&nbsp;<span class="ident" id="3493334">eofReader</span>&nbsp;<span class="op" id="3493344">=</span>&nbsp;<span class="op" id="3493346">&amp;</span><span class="keyword" id="3493347">struct</span>&nbsp;<span class="op" id="3493354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3493357">eofReaderWithWriteTo</span><br>
<span class="lineno">2010</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3493379">io</span><span class="op" id="3493381">.</span><span class="ident" id="3493382">Closer</span><br>
<span class="lineno"></span><span class="op" id="3493389">}</span><span class="op" id="3493390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3493393">eofReaderWithWriteTo</span><span class="op" id="3493413">{</span><span class="op" id="3493414">}</span><span class="op" id="3493415">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3493418">ioutil</span><span class="op" id="3493424">.</span><span class="ident" id="3493425">NopCloser</span><span class="op" id="3493434">(</span><span class="ident" id="3493435">nil</span><span class="op" id="3493438">)</span><span class="op" id="3493439">,</span><br>
<span class="lineno"></span><span class="op" id="3493441">}</span><br>
<span class="lineno">2015</span><br>
<span class="lineno"></span><span class="comment" id="3493444">//&nbsp;Verify&nbsp;that&nbsp;an&nbsp;io.Copy&nbsp;from&nbsp;an&nbsp;eofReader&nbsp;won&#39;t&nbsp;require&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3493512">var</span>&nbsp;<span class="ident" id="3493516">_</span>&nbsp;<span class="ident" id="3493518">io</span><span class="op" id="3493520">.</span><span class="ident" id="3493521">WriterTo</span>&nbsp;<span class="op" id="3493530">=</span>&nbsp;<span class="ident" id="3493532">eofReader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3493543">//&nbsp;initNPNRequest&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;that&nbsp;initializes&nbsp;certain</span><br>
<span class="lineno">2020</span><span class="comment" id="3493605">//&nbsp;uninitialized&nbsp;fields&nbsp;in&nbsp;its&nbsp;*Request.&nbsp;Such&nbsp;partially-initialized</span><br>
<span class="lineno"></span><span class="comment" id="3493673">//&nbsp;Requests&nbsp;come&nbsp;from&nbsp;NPN&nbsp;protocol&nbsp;handlers.</span><br>
<span class="lineno"></span><span class="keyword" id="3493718">type</span>&nbsp;<span class="ident" id="3493723">initNPNRequest</span>&nbsp;<span class="keyword" id="3493738">struct</span>&nbsp;<span class="op" id="3493745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3493748">c</span>&nbsp;<span class="op" id="3493750">*</span><span class="ident" id="3493751">tls</span><span class="op" id="3493754">.</span><span class="ident" id="3493755">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3493761">h</span>&nbsp;<span class="ident" id="3493763">serverHandler</span><br>
<span class="lineno">2025</span><span class="op" id="3493777">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3493780">func</span>&nbsp;<span class="op" id="3493785">(</span><span class="ident" id="3493786">h</span>&nbsp;<span class="ident" id="3493788">initNPNRequest</span><span class="op" id="3493802">)</span>&nbsp;<span class="ident" id="3493804">ServeHTTP</span><span class="op" id="3493813">(</span><span class="ident" id="3493814">rw</span>&nbsp;<span class="ident" id="3493817">ResponseWriter</span><span class="op" id="3493831">,</span>&nbsp;<span class="ident" id="3493833">req</span>&nbsp;<span class="op" id="3493837">*</span><span class="ident" id="3493838">Request</span><span class="op" id="3493845">)</span>&nbsp;<span class="op" id="3493847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3493850">if</span>&nbsp;<span class="ident" id="3493853">req</span><span class="op" id="3493856">.</span><span class="ident" id="3493857">TLS</span>&nbsp;<span class="op" id="3493861">==</span>&nbsp;<span class="ident" id="3493864">nil</span>&nbsp;<span class="op" id="3493868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3493872">req</span><span class="op" id="3493875">.</span><span class="ident" id="3493876">TLS</span>&nbsp;<span class="op" id="3493880">=</span>&nbsp;<span class="op" id="3493882">&amp;</span><span class="ident" id="3493883">tls</span><span class="op" id="3493886">.</span><span class="ident" id="3493887">ConnectionState</span><span class="op" id="3493902">{</span><span class="op" id="3493903">}</span><br>
<span class="lineno">2030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3493907">*</span><span class="ident" id="3493908">req</span><span class="op" id="3493911">.</span><span class="ident" id="3493912">TLS</span>&nbsp;<span class="op" id="3493916">=</span>&nbsp;<span class="ident" id="3493918">h</span><span class="op" id="3493919">.</span><span class="ident" id="3493920">c</span><span class="op" id="3493921">.</span><span class="ident" id="3493922">ConnectionState</span><span class="op" id="3493937">(</span><span class="op" id="3493938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3493941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3493944">if</span>&nbsp;<span class="ident" id="3493947">req</span><span class="op" id="3493950">.</span><span class="ident" id="3493951">Body</span>&nbsp;<span class="op" id="3493956">==</span>&nbsp;<span class="ident" id="3493959">nil</span>&nbsp;<span class="op" id="3493963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3493967">req</span><span class="op" id="3493970">.</span><span class="ident" id="3493971">Body</span>&nbsp;<span class="op" id="3493976">=</span>&nbsp;<span class="ident" id="3493978">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3493989">}</span><br>
<span class="lineno">2035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3493992">if</span>&nbsp;<span class="ident" id="3493995">req</span><span class="op" id="3493998">.</span><span class="ident" id="3493999">RemoteAddr</span>&nbsp;<span class="op" id="3494010">==</span>&nbsp;<span class="string" id="3494013">&#34;&#34;</span>&nbsp;<span class="op" id="3494016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494020">req</span><span class="op" id="3494023">.</span><span class="ident" id="3494024">RemoteAddr</span>&nbsp;<span class="op" id="3494035">=</span>&nbsp;<span class="ident" id="3494037">h</span><span class="op" id="3494038">.</span><span class="ident" id="3494039">c</span><span class="op" id="3494040">.</span><span class="ident" id="3494041">RemoteAddr</span><span class="op" id="3494051">(</span><span class="op" id="3494052">)</span><span class="op" id="3494053">.</span><span class="ident" id="3494054">String</span><span class="op" id="3494060">(</span><span class="op" id="3494061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3494064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494067">h</span><span class="op" id="3494068">.</span><span class="ident" id="3494069">h</span><span class="op" id="3494070">.</span><span class="ident" id="3494071">ServeHTTP</span><span class="op" id="3494080">(</span><span class="ident" id="3494081">rw</span><span class="op" id="3494083">,</span>&nbsp;<span class="ident" id="3494085">req</span><span class="op" id="3494088">)</span><br>
<span class="lineno"></span><span class="op" id="3494090">}</span><br>
<span class="lineno">2040</span><br>
<span class="lineno"></span><span class="comment" id="3494093">//&nbsp;loggingConn&nbsp;is&nbsp;used&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="keyword" id="3494131">type</span>&nbsp;<span class="ident" id="3494136">loggingConn</span>&nbsp;<span class="keyword" id="3494148">struct</span>&nbsp;<span class="op" id="3494155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494158">name</span>&nbsp;<span class="builtintype" id="3494163">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494171">net</span><span class="op" id="3494174">.</span><span class="ident" id="3494175">Conn</span><br>
<span class="lineno">2045</span><span class="op" id="3494180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3494183">var</span>&nbsp;<span class="op" id="3494187">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494190">uniqNameMu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3494203">sync</span><span class="op" id="3494207">.</span><span class="ident" id="3494208">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494215">uniqNameNext</span>&nbsp;<span class="op" id="3494228">=</span>&nbsp;<span class="builtinfunc" id="3494230">make</span><span class="op" id="3494234">(</span><span class="keyword" id="3494235">map</span><span class="op" id="3494238">[</span><span class="builtintype" id="3494239">string</span><span class="op" id="3494245">]</span><span class="builtintype" id="3494246">int</span><span class="op" id="3494249">)</span><br>
<span class="lineno">2050</span><span class="op" id="3494251">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3494254">func</span>&nbsp;<span class="ident" id="3494259">newLoggingConn</span><span class="op" id="3494273">(</span><span class="ident" id="3494274">baseName</span>&nbsp;<span class="builtintype" id="3494283">string</span><span class="op" id="3494289">,</span>&nbsp;<span class="ident" id="3494291">c</span>&nbsp;<span class="ident" id="3494293">net</span><span class="op" id="3494296">.</span><span class="ident" id="3494297">Conn</span><span class="op" id="3494301">)</span>&nbsp;<span class="ident" id="3494303">net</span><span class="op" id="3494306">.</span><span class="ident" id="3494307">Conn</span>&nbsp;<span class="op" id="3494312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494315">uniqNameMu</span><span class="op" id="3494325">.</span><span class="ident" id="3494326">Lock</span><span class="op" id="3494330">(</span><span class="op" id="3494331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3494334">defer</span>&nbsp;<span class="ident" id="3494340">uniqNameMu</span><span class="op" id="3494350">.</span><span class="ident" id="3494351">Unlock</span><span class="op" id="3494357">(</span><span class="op" id="3494358">)</span><br>
<span class="lineno">2055</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494361">uniqNameNext</span><span class="op" id="3494373">[</span><span class="ident" id="3494374">baseName</span><span class="op" id="3494382">]</span><span class="op" id="3494383">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3494387">return</span>&nbsp;<span class="op" id="3494394">&amp;</span><span class="ident" id="3494395">loggingConn</span><span class="op" id="3494406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494410">name</span><span class="op" id="3494414">:</span>&nbsp;<span class="ident" id="3494416">fmt</span><span class="op" id="3494419">.</span><span class="ident" id="3494420">Sprintf</span><span class="op" id="3494427">(</span><span class="string" id="3494428">&#34;%s-%d&#34;</span><span class="op" id="3494435">,</span>&nbsp;<span class="ident" id="3494437">baseName</span><span class="op" id="3494445">,</span>&nbsp;<span class="ident" id="3494447">uniqNameNext</span><span class="op" id="3494459">[</span><span class="ident" id="3494460">baseName</span><span class="op" id="3494468">]</span><span class="op" id="3494469">)</span><span class="op" id="3494470">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494474">Conn</span><span class="op" id="3494478">:</span>&nbsp;<span class="ident" id="3494480">c</span><span class="op" id="3494481">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3494484">}</span><br>
<span class="lineno">2060</span><span class="op" id="3494486">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3494489">func</span>&nbsp;<span class="op" id="3494494">(</span><span class="ident" id="3494495">c</span>&nbsp;<span class="op" id="3494497">*</span><span class="ident" id="3494498">loggingConn</span><span class="op" id="3494509">)</span>&nbsp;<span class="ident" id="3494511">Write</span><span class="op" id="3494516">(</span><span class="ident" id="3494517">p</span>&nbsp;<span class="op" id="3494519">[</span><span class="op" id="3494520">]</span><span class="builtintype" id="3494521">byte</span><span class="op" id="3494525">)</span>&nbsp;<span class="op" id="3494527">(</span><span class="ident" id="3494528">n</span>&nbsp;<span class="builtintype" id="3494530">int</span><span class="op" id="3494533">,</span>&nbsp;<span class="ident" id="3494535">err</span>&nbsp;<span class="builtintype" id="3494539">error</span><span class="op" id="3494544">)</span>&nbsp;<span class="op" id="3494546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494549">log</span><span class="op" id="3494552">.</span><span class="ident" id="3494553">Printf</span><span class="op" id="3494559">(</span><span class="string" id="3494560">&#34;%s.Write(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="3494581">,</span>&nbsp;<span class="ident" id="3494583">c</span><span class="op" id="3494584">.</span><span class="ident" id="3494585">name</span><span class="op" id="3494589">,</span>&nbsp;<span class="builtinfunc" id="3494591">len</span><span class="op" id="3494594">(</span><span class="ident" id="3494595">p</span><span class="op" id="3494596">)</span><span class="op" id="3494597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494600">n</span><span class="op" id="3494601">,</span>&nbsp;<span class="ident" id="3494603">err</span>&nbsp;<span class="op" id="3494607">=</span>&nbsp;<span class="ident" id="3494609">c</span><span class="op" id="3494610">.</span><span class="ident" id="3494611">Conn</span><span class="op" id="3494615">.</span><span class="ident" id="3494616">Write</span><span class="op" id="3494621">(</span><span class="ident" id="3494622">p</span><span class="op" id="3494623">)</span><br>
<span class="lineno">2065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494626">log</span><span class="op" id="3494629">.</span><span class="ident" id="3494630">Printf</span><span class="op" id="3494636">(</span><span class="string" id="3494637">&#34;%s.Write(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="3494660">,</span>&nbsp;<span class="ident" id="3494662">c</span><span class="op" id="3494663">.</span><span class="ident" id="3494664">name</span><span class="op" id="3494668">,</span>&nbsp;<span class="builtinfunc" id="3494670">len</span><span class="op" id="3494673">(</span><span class="ident" id="3494674">p</span><span class="op" id="3494675">)</span><span class="op" id="3494676">,</span>&nbsp;<span class="ident" id="3494678">n</span><span class="op" id="3494679">,</span>&nbsp;<span class="ident" id="3494681">err</span><span class="op" id="3494684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3494687">return</span><br>
<span class="lineno"></span><span class="op" id="3494694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3494697">func</span>&nbsp;<span class="op" id="3494702">(</span><span class="ident" id="3494703">c</span>&nbsp;<span class="op" id="3494705">*</span><span class="ident" id="3494706">loggingConn</span><span class="op" id="3494717">)</span>&nbsp;<span class="ident" id="3494719">Read</span><span class="op" id="3494723">(</span><span class="ident" id="3494724">p</span>&nbsp;<span class="op" id="3494726">[</span><span class="op" id="3494727">]</span><span class="builtintype" id="3494728">byte</span><span class="op" id="3494732">)</span>&nbsp;<span class="op" id="3494734">(</span><span class="ident" id="3494735">n</span>&nbsp;<span class="builtintype" id="3494737">int</span><span class="op" id="3494740">,</span>&nbsp;<span class="ident" id="3494742">err</span>&nbsp;<span class="builtintype" id="3494746">error</span><span class="op" id="3494751">)</span>&nbsp;<span class="op" id="3494753">{</span><br>
<span class="lineno">2070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494756">log</span><span class="op" id="3494759">.</span><span class="ident" id="3494760">Printf</span><span class="op" id="3494766">(</span><span class="string" id="3494767">&#34;%s.Read(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="3494787">,</span>&nbsp;<span class="ident" id="3494789">c</span><span class="op" id="3494790">.</span><span class="ident" id="3494791">name</span><span class="op" id="3494795">,</span>&nbsp;<span class="builtinfunc" id="3494797">len</span><span class="op" id="3494800">(</span><span class="ident" id="3494801">p</span><span class="op" id="3494802">)</span><span class="op" id="3494803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494806">n</span><span class="op" id="3494807">,</span>&nbsp;<span class="ident" id="3494809">err</span>&nbsp;<span class="op" id="3494813">=</span>&nbsp;<span class="ident" id="3494815">c</span><span class="op" id="3494816">.</span><span class="ident" id="3494817">Conn</span><span class="op" id="3494821">.</span><span class="ident" id="3494822">Read</span><span class="op" id="3494826">(</span><span class="ident" id="3494827">p</span><span class="op" id="3494828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494831">log</span><span class="op" id="3494834">.</span><span class="ident" id="3494835">Printf</span><span class="op" id="3494841">(</span><span class="string" id="3494842">&#34;%s.Read(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="3494864">,</span>&nbsp;<span class="ident" id="3494866">c</span><span class="op" id="3494867">.</span><span class="ident" id="3494868">name</span><span class="op" id="3494872">,</span>&nbsp;<span class="builtinfunc" id="3494874">len</span><span class="op" id="3494877">(</span><span class="ident" id="3494878">p</span><span class="op" id="3494879">)</span><span class="op" id="3494880">,</span>&nbsp;<span class="ident" id="3494882">n</span><span class="op" id="3494883">,</span>&nbsp;<span class="ident" id="3494885">err</span><span class="op" id="3494888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3494891">return</span><br>
<span class="lineno"></span><span class="op" id="3494898">}</span><br>
<span class="lineno">2075</span><br>
<span class="lineno"></span><span class="keyword" id="3494901">func</span>&nbsp;<span class="op" id="3494906">(</span><span class="ident" id="3494907">c</span>&nbsp;<span class="op" id="3494909">*</span><span class="ident" id="3494910">loggingConn</span><span class="op" id="3494921">)</span>&nbsp;<span class="ident" id="3494923">Close</span><span class="op" id="3494928">(</span><span class="op" id="3494929">)</span>&nbsp;<span class="op" id="3494931">(</span><span class="ident" id="3494932">err</span>&nbsp;<span class="builtintype" id="3494936">error</span><span class="op" id="3494941">)</span>&nbsp;<span class="op" id="3494943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494946">log</span><span class="op" id="3494949">.</span><span class="ident" id="3494950">Printf</span><span class="op" id="3494956">(</span><span class="string" id="3494957">&#34;%s.Close()&nbsp;=&nbsp;...&#34;</span><span class="op" id="3494975">,</span>&nbsp;<span class="ident" id="3494977">c</span><span class="op" id="3494978">.</span><span class="ident" id="3494979">name</span><span class="op" id="3494983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494986">err</span>&nbsp;<span class="op" id="3494990">=</span>&nbsp;<span class="ident" id="3494992">c</span><span class="op" id="3494993">.</span><span class="ident" id="3494994">Conn</span><span class="op" id="3494998">.</span><span class="ident" id="3494999">Close</span><span class="op" id="3495004">(</span><span class="op" id="3495005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3495008">log</span><span class="op" id="3495011">.</span><span class="ident" id="3495012">Printf</span><span class="op" id="3495018">(</span><span class="string" id="3495019">&#34;%s.Close()&nbsp;=&nbsp;%v&#34;</span><span class="op" id="3495036">,</span>&nbsp;<span class="ident" id="3495038">c</span><span class="op" id="3495039">.</span><span class="ident" id="3495040">name</span><span class="op" id="3495044">,</span>&nbsp;<span class="ident" id="3495046">err</span><span class="op" id="3495049">)</span><br>
<span class="lineno">2080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3495052">return</span><br>
<span class="lineno"></span><span class="op" id="3495059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3495062">//&nbsp;checkConnErrorWriter&nbsp;writes&nbsp;to&nbsp;c.rwc&nbsp;and&nbsp;records&nbsp;any&nbsp;write&nbsp;errors&nbsp;to&nbsp;c.werr.</span><br>
<span class="lineno"></span><span class="comment" id="3495142">//&nbsp;It&nbsp;only&nbsp;contains&nbsp;one&nbsp;field&nbsp;(and&nbsp;a&nbsp;pointer&nbsp;field&nbsp;at&nbsp;that),&nbsp;so&nbsp;it</span><br>
<span class="lineno">2085</span><span class="comment" id="3495209">//&nbsp;fits&nbsp;in&nbsp;an&nbsp;interface&nbsp;value&nbsp;without&nbsp;an&nbsp;extra&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="3495268">type</span>&nbsp;<span class="ident" id="3495273">checkConnErrorWriter</span>&nbsp;<span class="keyword" id="3495294">struct</span>&nbsp;<span class="op" id="3495301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3495304">c</span>&nbsp;<span class="op" id="3495306">*</span><span class="ident" id="3495307">conn</span><br>
<span class="lineno"></span><span class="op" id="3495312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2090</span><span class="keyword" id="3495315">func</span>&nbsp;<span class="op" id="3495320">(</span><span class="ident" id="3495321">w</span>&nbsp;<span class="ident" id="3495323">checkConnErrorWriter</span><span class="op" id="3495343">)</span>&nbsp;<span class="ident" id="3495345">Write</span><span class="op" id="3495350">(</span><span class="ident" id="3495351">p</span>&nbsp;<span class="op" id="3495353">[</span><span class="op" id="3495354">]</span><span class="builtintype" id="3495355">byte</span><span class="op" id="3495359">)</span>&nbsp;<span class="op" id="3495361">(</span><span class="ident" id="3495362">n</span>&nbsp;<span class="builtintype" id="3495364">int</span><span class="op" id="3495367">,</span>&nbsp;<span class="ident" id="3495369">err</span>&nbsp;<span class="builtintype" id="3495373">error</span><span class="op" id="3495378">)</span>&nbsp;<span class="op" id="3495380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3495383">n</span><span class="op" id="3495384">,</span>&nbsp;<span class="ident" id="3495386">err</span>&nbsp;<span class="op" id="3495390">=</span>&nbsp;<span class="ident" id="3495392">w</span><span class="op" id="3495393">.</span><span class="ident" id="3495394">c</span><span class="op" id="3495395">.</span><span class="ident" id="3495396">w</span><span class="op" id="3495397">.</span><span class="ident" id="3495398">Write</span><span class="op" id="3495403">(</span><span class="ident" id="3495404">p</span><span class="op" id="3495405">)</span>&nbsp;<span class="comment" id="3495407">//&nbsp;c.w&nbsp;==&nbsp;c.rwc,&nbsp;except&nbsp;after&nbsp;a&nbsp;hijack,&nbsp;when&nbsp;rwc&nbsp;is&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3495465">if</span>&nbsp;<span class="ident" id="3495468">err</span>&nbsp;<span class="op" id="3495472">!=</span>&nbsp;<span class="ident" id="3495475">nil</span>&nbsp;<span class="op" id="3495479">&amp;&amp;</span>&nbsp;<span class="ident" id="3495482">w</span><span class="op" id="3495483">.</span><span class="ident" id="3495484">c</span><span class="op" id="3495485">.</span><span class="ident" id="3495486">werr</span>&nbsp;<span class="op" id="3495491">==</span>&nbsp;<span class="ident" id="3495494">nil</span>&nbsp;<span class="op" id="3495498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3495502">w</span><span class="op" id="3495503">.</span><span class="ident" id="3495504">c</span><span class="op" id="3495505">.</span><span class="ident" id="3495506">werr</span>&nbsp;<span class="op" id="3495511">=</span>&nbsp;<span class="ident" id="3495513">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3495518">}</span><br>
<span class="lineno">2095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3495521">return</span><br>
<span class="lineno"></span><span class="op" id="3495528">}</span>
</div>
</body>
</html>
