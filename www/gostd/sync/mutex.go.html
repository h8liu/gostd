<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html" class="current">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1408430">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1408485">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1408539">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1408590">//&nbsp;Package&nbsp;sync&nbsp;provides&nbsp;basic&nbsp;synchronization&nbsp;primitives&nbsp;such&nbsp;as&nbsp;mutual</span><br>
<span class="lineno"></span><span class="comment" id="1408663">//&nbsp;exclusion&nbsp;locks.&nbsp;&nbsp;Other&nbsp;than&nbsp;the&nbsp;Once&nbsp;and&nbsp;WaitGroup&nbsp;types,&nbsp;most&nbsp;are&nbsp;intended</span><br>
<span class="lineno"></span><span class="comment" id="1408743">//&nbsp;for&nbsp;use&nbsp;by&nbsp;low-level&nbsp;library&nbsp;routines.&nbsp;&nbsp;Higher-level&nbsp;synchronization&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1408818">//&nbsp;better&nbsp;done&nbsp;via&nbsp;channels&nbsp;and&nbsp;communication.</span><br>
<span class="lineno"></span><span class="comment" id="1408865">//</span><br>
<span class="lineno">10</span><span class="comment" id="1408868">//&nbsp;Values&nbsp;containing&nbsp;the&nbsp;types&nbsp;defined&nbsp;in&nbsp;this&nbsp;package&nbsp;should&nbsp;not&nbsp;be&nbsp;copied.</span><br>
<span class="lineno"></span><span class="keyword" id="1408945">package</span>&nbsp;<span class="ident" id="1408953">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1408959">import</span>&nbsp;<span class="op" id="1408966">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1408969">&#34;sync/atomic&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1408984">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1408993">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1408996">//&nbsp;A&nbsp;Mutex&nbsp;is&nbsp;a&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1409035">//&nbsp;Mutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other&nbsp;structures;</span><br>
<span class="lineno">20</span><span class="comment" id="1409090">//&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;Mutex&nbsp;is&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1409142">type</span>&nbsp;<span class="ident" id="1409147">Mutex</span>&nbsp;<span class="keyword" id="1409153">struct</span>&nbsp;<span class="op" id="1409160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409163">state</span>&nbsp;<span class="builtintype" id="1409169">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409176">sema</span>&nbsp;&nbsp;<span class="builtintype" id="1409182">uint32</span><br>
<span class="lineno"></span><span class="op" id="1409189">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="1409192">//&nbsp;A&nbsp;Locker&nbsp;represents&nbsp;an&nbsp;object&nbsp;that&nbsp;can&nbsp;be&nbsp;locked&nbsp;and&nbsp;unlocked.</span><br>
<span class="lineno"></span><span class="keyword" id="1409258">type</span>&nbsp;<span class="ident" id="1409263">Locker</span>&nbsp;<span class="keyword" id="1409270">interface</span>&nbsp;<span class="op" id="1409280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409283">Lock</span><span class="op" id="1409287">(</span><span class="op" id="1409288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409291">Unlock</span><span class="op" id="1409297">(</span><span class="op" id="1409298">)</span><br>
<span class="lineno">30</span><span class="op" id="1409300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1409303">const</span>&nbsp;<span class="op" id="1409309">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409312">mutexLocked</span>&nbsp;<span class="op" id="1409324">=</span>&nbsp;<span class="num" id="1409326">1</span>&nbsp;<span class="op" id="1409328">&lt;&lt;</span>&nbsp;<span class="ident" id="1409331">iota</span>&nbsp;<span class="comment" id="1409336">//&nbsp;mutex&nbsp;is&nbsp;locked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409356">mutexWoken</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409368">mutexWaiterShift</span>&nbsp;<span class="op" id="1409385">=</span>&nbsp;<span class="ident" id="1409387">iota</span><br>
<span class="lineno"></span><span class="op" id="1409392">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1409395">//&nbsp;Lock&nbsp;locks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1409412">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;in&nbsp;use,&nbsp;the&nbsp;calling&nbsp;goroutine</span><br>
<span class="lineno">40</span><span class="comment" id="1409468">//&nbsp;blocks&nbsp;until&nbsp;the&nbsp;mutex&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1409508">func</span>&nbsp;<span class="op" id="1409513">(</span><span class="ident" id="1409514">m</span>&nbsp;<span class="op" id="1409516">*</span><span class="ident" id="1409517">Mutex</span><span class="op" id="1409522">)</span>&nbsp;<span class="ident" id="1409524">Lock</span><span class="op" id="1409528">(</span><span class="op" id="1409529">)</span>&nbsp;<span class="op" id="1409531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1409534">//&nbsp;Fast&nbsp;path:&nbsp;grab&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409570">if</span>&nbsp;<span class="ident" id="1409573">atomic</span><span class="op" id="1409579">.</span><span class="ident" id="1409580">CompareAndSwapInt32</span><span class="op" id="1409599">(</span><span class="op" id="1409600">&amp;</span><span class="ident" id="1409601">m</span><span class="op" id="1409602">.</span><span class="ident" id="1409603">state</span><span class="op" id="1409608">,</span>&nbsp;<span class="num" id="1409610">0</span><span class="op" id="1409611">,</span>&nbsp;<span class="ident" id="1409613">mutexLocked</span><span class="op" id="1409624">)</span>&nbsp;<span class="op" id="1409626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409630">if</span>&nbsp;<span class="ident" id="1409633">raceenabled</span>&nbsp;<span class="op" id="1409645">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409650">raceAcquire</span><span class="op" id="1409661">(</span><span class="ident" id="1409662">unsafe</span><span class="op" id="1409668">.</span><span class="ident" id="1409669">Pointer</span><span class="op" id="1409676">(</span><span class="ident" id="1409677">m</span><span class="op" id="1409678">)</span><span class="op" id="1409679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409687">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409699">awoke</span>&nbsp;<span class="op" id="1409705">:=</span>&nbsp;<span class="builtintype" id="1409708">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409715">for</span>&nbsp;<span class="op" id="1409719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409723">old</span>&nbsp;<span class="op" id="1409727">:=</span>&nbsp;<span class="ident" id="1409730">m</span><span class="op" id="1409731">.</span><span class="ident" id="1409732">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1409740">new</span>&nbsp;<span class="op" id="1409744">:=</span>&nbsp;<span class="ident" id="1409747">old</span>&nbsp;<span class="op" id="1409751">|</span>&nbsp;<span class="ident" id="1409753">mutexLocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409767">if</span>&nbsp;<span class="ident" id="1409770">old</span><span class="op" id="1409773">&amp;</span><span class="ident" id="1409774">mutexLocked</span>&nbsp;<span class="op" id="1409786">!=</span>&nbsp;<span class="num" id="1409789">0</span>&nbsp;<span class="op" id="1409791">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1409796">new</span>&nbsp;<span class="op" id="1409800">=</span>&nbsp;<span class="ident" id="1409802">old</span>&nbsp;<span class="op" id="1409806">+</span>&nbsp;<span class="num" id="1409808">1</span><span class="op" id="1409809">&lt;&lt;</span><span class="ident" id="1409811">mutexWaiterShift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409834">if</span>&nbsp;<span class="ident" id="1409837">awoke</span>&nbsp;<span class="op" id="1409843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1409848">//&nbsp;The&nbsp;goroutine&nbsp;has&nbsp;been&nbsp;woken&nbsp;from&nbsp;sleep,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1409895">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;reset&nbsp;the&nbsp;flag&nbsp;in&nbsp;either&nbsp;case.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1409946">new</span>&nbsp;<span class="op" id="1409950">&amp;^=</span>&nbsp;<span class="ident" id="1409954">mutexWoken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409971">if</span>&nbsp;<span class="ident" id="1409974">atomic</span><span class="op" id="1409980">.</span><span class="ident" id="1409981">CompareAndSwapInt32</span><span class="op" id="1410000">(</span><span class="op" id="1410001">&amp;</span><span class="ident" id="1410002">m</span><span class="op" id="1410003">.</span><span class="ident" id="1410004">state</span><span class="op" id="1410009">,</span>&nbsp;<span class="ident" id="1410011">old</span><span class="op" id="1410014">,</span>&nbsp;<span class="builtinfunc" id="1410016">new</span><span class="op" id="1410019">)</span>&nbsp;<span class="op" id="1410021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410026">if</span>&nbsp;<span class="ident" id="1410029">old</span><span class="op" id="1410032">&amp;</span><span class="ident" id="1410033">mutexLocked</span>&nbsp;<span class="op" id="1410045">==</span>&nbsp;<span class="num" id="1410048">0</span>&nbsp;<span class="op" id="1410050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410056">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410070">runtime_Semacquire</span><span class="op" id="1410088">(</span><span class="op" id="1410089">&amp;</span><span class="ident" id="1410090">m</span><span class="op" id="1410091">.</span><span class="ident" id="1410092">sema</span><span class="op" id="1410096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410101">awoke</span>&nbsp;<span class="op" id="1410107">=</span>&nbsp;<span class="builtintype" id="1410109">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410119">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410123">if</span>&nbsp;<span class="ident" id="1410126">raceenabled</span>&nbsp;<span class="op" id="1410138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410142">raceAcquire</span><span class="op" id="1410153">(</span><span class="ident" id="1410154">unsafe</span><span class="op" id="1410160">.</span><span class="ident" id="1410161">Pointer</span><span class="op" id="1410168">(</span><span class="ident" id="1410169">m</span><span class="op" id="1410170">)</span><span class="op" id="1410171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410174">}</span><br>
<span class="lineno"></span><span class="op" id="1410176">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="1410179">//&nbsp;Unlock&nbsp;unlocks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1410200">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;m&nbsp;is&nbsp;not&nbsp;locked&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1410265">//</span><br>
<span class="lineno"></span><span class="comment" id="1410268">//&nbsp;A&nbsp;locked&nbsp;Mutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular&nbsp;goroutine.</span><br>
<span class="lineno">80</span><span class="comment" id="1410333">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;for&nbsp;one&nbsp;goroutine&nbsp;to&nbsp;lock&nbsp;a&nbsp;Mutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1410393">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;unlock&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1410440">func</span>&nbsp;<span class="op" id="1410445">(</span><span class="ident" id="1410446">m</span>&nbsp;<span class="op" id="1410448">*</span><span class="ident" id="1410449">Mutex</span><span class="op" id="1410454">)</span>&nbsp;<span class="ident" id="1410456">Unlock</span><span class="op" id="1410462">(</span><span class="op" id="1410463">)</span>&nbsp;<span class="op" id="1410465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410468">if</span>&nbsp;<span class="ident" id="1410471">raceenabled</span>&nbsp;<span class="op" id="1410483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410487">_</span>&nbsp;<span class="op" id="1410489">=</span>&nbsp;<span class="ident" id="1410491">m</span><span class="op" id="1410492">.</span><span class="ident" id="1410493">state</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410501">raceRelease</span><span class="op" id="1410512">(</span><span class="ident" id="1410513">unsafe</span><span class="op" id="1410519">.</span><span class="ident" id="1410520">Pointer</span><span class="op" id="1410527">(</span><span class="ident" id="1410528">m</span><span class="op" id="1410529">)</span><span class="op" id="1410530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1410537">//&nbsp;Fast&nbsp;path:&nbsp;drop&nbsp;lock&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1410567">new</span>&nbsp;<span class="op" id="1410571">:=</span>&nbsp;<span class="ident" id="1410574">atomic</span><span class="op" id="1410580">.</span><span class="ident" id="1410581">AddInt32</span><span class="op" id="1410589">(</span><span class="op" id="1410590">&amp;</span><span class="ident" id="1410591">m</span><span class="op" id="1410592">.</span><span class="ident" id="1410593">state</span><span class="op" id="1410598">,</span>&nbsp;<span class="op" id="1410600">-</span><span class="ident" id="1410601">mutexLocked</span><span class="op" id="1410612">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410615">if</span>&nbsp;<span class="op" id="1410618">(</span><span class="builtinfunc" id="1410619">new</span><span class="op" id="1410622">+</span><span class="ident" id="1410623">mutexLocked</span><span class="op" id="1410634">)</span><span class="op" id="1410635">&amp;</span><span class="ident" id="1410636">mutexLocked</span>&nbsp;<span class="op" id="1410648">==</span>&nbsp;<span class="num" id="1410651">0</span>&nbsp;<span class="op" id="1410653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1410657">panic</span><span class="op" id="1410662">(</span><span class="string" id="1410663">&#34;sync:&nbsp;unlock&nbsp;of&nbsp;unlocked&nbsp;mutex&#34;</span><span class="op" id="1410695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410702">old</span>&nbsp;<span class="op" id="1410706">:=</span>&nbsp;<span class="builtinfunc" id="1410709">new</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410714">for</span>&nbsp;<span class="op" id="1410718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1410722">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;waiters&nbsp;or&nbsp;a&nbsp;goroutine&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1410778">//&nbsp;been&nbsp;woken&nbsp;or&nbsp;grabbed&nbsp;the&nbsp;lock,&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;anyone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410839">if</span>&nbsp;<span class="ident" id="1410842">old</span><span class="op" id="1410845">&gt;&gt;</span><span class="ident" id="1410847">mutexWaiterShift</span>&nbsp;<span class="op" id="1410864">==</span>&nbsp;<span class="num" id="1410867">0</span>&nbsp;<span class="op" id="1410869">||</span>&nbsp;<span class="ident" id="1410872">old</span><span class="op" id="1410875">&amp;</span><span class="op" id="1410876">(</span><span class="ident" id="1410877">mutexLocked</span><span class="op" id="1410888">|</span><span class="ident" id="1410889">mutexWoken</span><span class="op" id="1410899">)</span>&nbsp;<span class="op" id="1410901">!=</span>&nbsp;<span class="num" id="1410904">0</span>&nbsp;<span class="op" id="1410906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410911">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1410924">//&nbsp;Grab&nbsp;the&nbsp;right&nbsp;to&nbsp;wake&nbsp;someone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1410961">new</span>&nbsp;<span class="op" id="1410965">=</span>&nbsp;<span class="op" id="1410967">(</span><span class="ident" id="1410968">old</span>&nbsp;<span class="op" id="1410972">-</span>&nbsp;<span class="num" id="1410974">1</span><span class="op" id="1410975">&lt;&lt;</span><span class="ident" id="1410977">mutexWaiterShift</span><span class="op" id="1410993">)</span>&nbsp;<span class="op" id="1410995">|</span>&nbsp;<span class="ident" id="1410997">mutexWoken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1411010">if</span>&nbsp;<span class="ident" id="1411013">atomic</span><span class="op" id="1411019">.</span><span class="ident" id="1411020">CompareAndSwapInt32</span><span class="op" id="1411039">(</span><span class="op" id="1411040">&amp;</span><span class="ident" id="1411041">m</span><span class="op" id="1411042">.</span><span class="ident" id="1411043">state</span><span class="op" id="1411048">,</span>&nbsp;<span class="ident" id="1411050">old</span><span class="op" id="1411053">,</span>&nbsp;<span class="builtinfunc" id="1411055">new</span><span class="op" id="1411058">)</span>&nbsp;<span class="op" id="1411060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411065">runtime_Semrelease</span><span class="op" id="1411083">(</span><span class="op" id="1411084">&amp;</span><span class="ident" id="1411085">m</span><span class="op" id="1411086">.</span><span class="ident" id="1411087">sema</span><span class="op" id="1411091">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1411096">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1411105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411109">old</span>&nbsp;<span class="op" id="1411113">=</span>&nbsp;<span class="ident" id="1411115">m</span><span class="op" id="1411116">.</span><span class="ident" id="1411117">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1411124">}</span><br>
<span class="lineno"></span><span class="op" id="1411126">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
