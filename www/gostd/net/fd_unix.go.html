<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3001298">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3001353">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3001407">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3001458">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3001528">package</span>&nbsp;<span class="ident" id="3001536">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3001541">import</span>&nbsp;<span class="op" id="3001548">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3001551">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3001557">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3001563">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3001574">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3001589">&#34;syscall&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3001600">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3001607">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3001610">//&nbsp;Network&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="3001638">type</span>&nbsp;<span class="ident" id="3001643">netFD</span>&nbsp;<span class="keyword" id="3001649">struct</span>&nbsp;<span class="op" id="3001656">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3001659">//&nbsp;locking/lifetime&nbsp;of&nbsp;sysfd&nbsp;+&nbsp;serialize&nbsp;access&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3001734">fdmu</span>&nbsp;<span class="ident" id="3001739">fdMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3001749">//&nbsp;immutable&nbsp;until&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3001775">sysfd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3001787">int</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3001792">family</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3001804">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3001809">sotype</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3001821">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3001826">isConnected</span>&nbsp;<span class="builtintype" id="3001838">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3001844">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3001856">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3001864">laddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3001876">Addr</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3001882">raddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3001894">Addr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3001901">//&nbsp;wait&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3001917">pd</span>&nbsp;<span class="ident" id="3001920">pollDesc</span><br>
<span class="lineno"></span><span class="op" id="3001929">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="3001932">func</span>&nbsp;<span class="ident" id="3001937">sysInit</span><span class="op" id="3001944">(</span><span class="op" id="3001945">)</span>&nbsp;<span class="op" id="3001947">{</span><br>
<span class="lineno"></span><span class="op" id="3001949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3001952">func</span>&nbsp;<span class="ident" id="3001957">dial</span><span class="op" id="3001961">(</span><span class="ident" id="3001962">network</span>&nbsp;<span class="builtintype" id="3001970">string</span><span class="op" id="3001976">,</span>&nbsp;<span class="ident" id="3001978">ra</span>&nbsp;<span class="ident" id="3001981">Addr</span><span class="op" id="3001985">,</span>&nbsp;<span class="ident" id="3001987">dialer</span>&nbsp;<span class="keyword" id="3001994">func</span><span class="op" id="3001998">(</span><span class="ident" id="3001999">time</span><span class="op" id="3002003">.</span><span class="ident" id="3002004">Time</span><span class="op" id="3002008">)</span>&nbsp;<span class="op" id="3002010">(</span><span class="ident" id="3002011">Conn</span><span class="op" id="3002015">,</span>&nbsp;<span class="builtintype" id="3002017">error</span><span class="op" id="3002022">)</span><span class="op" id="3002023">,</span>&nbsp;<span class="ident" id="3002025">deadline</span>&nbsp;<span class="ident" id="3002034">time</span><span class="op" id="3002038">.</span><span class="ident" id="3002039">Time</span><span class="op" id="3002043">)</span>&nbsp;<span class="op" id="3002045">(</span><span class="ident" id="3002046">Conn</span><span class="op" id="3002050">,</span>&nbsp;<span class="builtintype" id="3002052">error</span><span class="op" id="3002057">)</span>&nbsp;<span class="op" id="3002059">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002062">return</span>&nbsp;<span class="ident" id="3002069">dialer</span><span class="op" id="3002075">(</span><span class="ident" id="3002076">deadline</span><span class="op" id="3002084">)</span><br>
<span class="lineno"></span><span class="op" id="3002086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3002089">func</span>&nbsp;<span class="ident" id="3002094">newFD</span><span class="op" id="3002099">(</span><span class="ident" id="3002100">sysfd</span><span class="op" id="3002105">,</span>&nbsp;<span class="ident" id="3002107">family</span><span class="op" id="3002113">,</span>&nbsp;<span class="ident" id="3002115">sotype</span>&nbsp;<span class="builtintype" id="3002122">int</span><span class="op" id="3002125">,</span>&nbsp;<span class="ident" id="3002127">net</span>&nbsp;<span class="builtintype" id="3002131">string</span><span class="op" id="3002137">)</span>&nbsp;<span class="op" id="3002139">(</span><span class="op" id="3002140">*</span><span class="ident" id="3002141">netFD</span><span class="op" id="3002146">,</span>&nbsp;<span class="builtintype" id="3002148">error</span><span class="op" id="3002153">)</span>&nbsp;<span class="op" id="3002155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002158">return</span>&nbsp;<span class="op" id="3002165">&amp;</span><span class="ident" id="3002166">netFD</span><span class="op" id="3002171">{</span><span class="ident" id="3002172">sysfd</span><span class="op" id="3002177">:</span>&nbsp;<span class="ident" id="3002179">sysfd</span><span class="op" id="3002184">,</span>&nbsp;<span class="ident" id="3002186">family</span><span class="op" id="3002192">:</span>&nbsp;<span class="ident" id="3002194">family</span><span class="op" id="3002200">,</span>&nbsp;<span class="ident" id="3002202">sotype</span><span class="op" id="3002208">:</span>&nbsp;<span class="ident" id="3002210">sotype</span><span class="op" id="3002216">,</span>&nbsp;<span class="ident" id="3002218">net</span><span class="op" id="3002221">:</span>&nbsp;<span class="ident" id="3002223">net</span><span class="op" id="3002226">}</span><span class="op" id="3002227">,</span>&nbsp;<span class="ident" id="3002229">nil</span><br>
<span class="lineno">45</span><span class="op" id="3002233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3002236">func</span>&nbsp;<span class="op" id="3002241">(</span><span class="ident" id="3002242">fd</span>&nbsp;<span class="op" id="3002245">*</span><span class="ident" id="3002246">netFD</span><span class="op" id="3002251">)</span>&nbsp;<span class="ident" id="3002253">init</span><span class="op" id="3002257">(</span><span class="op" id="3002258">)</span>&nbsp;<span class="builtintype" id="3002260">error</span>&nbsp;<span class="op" id="3002266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002269">if</span>&nbsp;<span class="ident" id="3002272">err</span>&nbsp;<span class="op" id="3002276">:=</span>&nbsp;<span class="ident" id="3002279">fd</span><span class="op" id="3002281">.</span><span class="ident" id="3002282">pd</span><span class="op" id="3002284">.</span><span class="ident" id="3002285">Init</span><span class="op" id="3002289">(</span><span class="ident" id="3002290">fd</span><span class="op" id="3002292">)</span><span class="op" id="3002293">;</span>&nbsp;<span class="ident" id="3002295">err</span>&nbsp;<span class="op" id="3002299">!=</span>&nbsp;<span class="ident" id="3002302">nil</span>&nbsp;<span class="op" id="3002306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002310">return</span>&nbsp;<span class="ident" id="3002317">err</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3002322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002325">return</span>&nbsp;<span class="ident" id="3002332">nil</span><br>
<span class="lineno"></span><span class="op" id="3002336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3002339">func</span>&nbsp;<span class="op" id="3002344">(</span><span class="ident" id="3002345">fd</span>&nbsp;<span class="op" id="3002348">*</span><span class="ident" id="3002349">netFD</span><span class="op" id="3002354">)</span>&nbsp;<span class="ident" id="3002356">setAddr</span><span class="op" id="3002363">(</span><span class="ident" id="3002364">laddr</span><span class="op" id="3002369">,</span>&nbsp;<span class="ident" id="3002371">raddr</span>&nbsp;<span class="ident" id="3002377">Addr</span><span class="op" id="3002381">)</span>&nbsp;<span class="op" id="3002383">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3002386">fd</span><span class="op" id="3002388">.</span><span class="ident" id="3002389">laddr</span>&nbsp;<span class="op" id="3002395">=</span>&nbsp;<span class="ident" id="3002397">laddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3002404">fd</span><span class="op" id="3002406">.</span><span class="ident" id="3002407">raddr</span>&nbsp;<span class="op" id="3002413">=</span>&nbsp;<span class="ident" id="3002415">raddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3002422">runtime</span><span class="op" id="3002429">.</span><span class="ident" id="3002430">SetFinalizer</span><span class="op" id="3002442">(</span><span class="ident" id="3002443">fd</span><span class="op" id="3002445">,</span>&nbsp;<span class="op" id="3002447">(</span><span class="op" id="3002448">*</span><span class="ident" id="3002449">netFD</span><span class="op" id="3002454">)</span><span class="op" id="3002455">.</span><span class="ident" id="3002456">Close</span><span class="op" id="3002461">)</span><br>
<span class="lineno"></span><span class="op" id="3002463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="3002466">func</span>&nbsp;<span class="op" id="3002471">(</span><span class="ident" id="3002472">fd</span>&nbsp;<span class="op" id="3002475">*</span><span class="ident" id="3002476">netFD</span><span class="op" id="3002481">)</span>&nbsp;<span class="ident" id="3002483">name</span><span class="op" id="3002487">(</span><span class="op" id="3002488">)</span>&nbsp;<span class="builtintype" id="3002490">string</span>&nbsp;<span class="op" id="3002497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002500">var</span>&nbsp;<span class="ident" id="3002504">ls</span><span class="op" id="3002506">,</span>&nbsp;<span class="ident" id="3002508">rs</span>&nbsp;<span class="builtintype" id="3002511">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002519">if</span>&nbsp;<span class="ident" id="3002522">fd</span><span class="op" id="3002524">.</span><span class="ident" id="3002525">laddr</span>&nbsp;<span class="op" id="3002531">!=</span>&nbsp;<span class="ident" id="3002534">nil</span>&nbsp;<span class="op" id="3002538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3002542">ls</span>&nbsp;<span class="op" id="3002545">=</span>&nbsp;<span class="ident" id="3002547">fd</span><span class="op" id="3002549">.</span><span class="ident" id="3002550">laddr</span><span class="op" id="3002555">.</span><span class="ident" id="3002556">String</span><span class="op" id="3002562">(</span><span class="op" id="3002563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3002566">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002569">if</span>&nbsp;<span class="ident" id="3002572">fd</span><span class="op" id="3002574">.</span><span class="ident" id="3002575">raddr</span>&nbsp;<span class="op" id="3002581">!=</span>&nbsp;<span class="ident" id="3002584">nil</span>&nbsp;<span class="op" id="3002588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3002592">rs</span>&nbsp;<span class="op" id="3002595">=</span>&nbsp;<span class="ident" id="3002597">fd</span><span class="op" id="3002599">.</span><span class="ident" id="3002600">raddr</span><span class="op" id="3002605">.</span><span class="ident" id="3002606">String</span><span class="op" id="3002612">(</span><span class="op" id="3002613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3002616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002619">return</span>&nbsp;<span class="ident" id="3002626">fd</span><span class="op" id="3002628">.</span><span class="ident" id="3002629">net</span>&nbsp;<span class="op" id="3002633">+</span>&nbsp;<span class="string" id="3002635">&#34;:&#34;</span>&nbsp;<span class="op" id="3002639">+</span>&nbsp;<span class="ident" id="3002641">ls</span>&nbsp;<span class="op" id="3002644">+</span>&nbsp;<span class="string" id="3002646">&#34;-&gt;&#34;</span>&nbsp;<span class="op" id="3002651">+</span>&nbsp;<span class="ident" id="3002653">rs</span><br>
<span class="lineno"></span><span class="op" id="3002656">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="3002659">func</span>&nbsp;<span class="op" id="3002664">(</span><span class="ident" id="3002665">fd</span>&nbsp;<span class="op" id="3002668">*</span><span class="ident" id="3002669">netFD</span><span class="op" id="3002674">)</span>&nbsp;<span class="ident" id="3002676">connect</span><span class="op" id="3002683">(</span><span class="ident" id="3002684">la</span><span class="op" id="3002686">,</span>&nbsp;<span class="ident" id="3002688">ra</span>&nbsp;<span class="ident" id="3002691">syscall</span><span class="op" id="3002698">.</span><span class="ident" id="3002699">Sockaddr</span><span class="op" id="3002707">,</span>&nbsp;<span class="ident" id="3002709">deadline</span>&nbsp;<span class="ident" id="3002718">time</span><span class="op" id="3002722">.</span><span class="ident" id="3002723">Time</span><span class="op" id="3002727">)</span>&nbsp;<span class="builtintype" id="3002729">error</span>&nbsp;<span class="op" id="3002735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3002738">//&nbsp;Do&nbsp;not&nbsp;need&nbsp;to&nbsp;call&nbsp;fd.writeLock&nbsp;here,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3002781">//&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;yet&nbsp;accessible&nbsp;to&nbsp;user,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3002827">//&nbsp;so&nbsp;no&nbsp;concurrent&nbsp;operations&nbsp;are&nbsp;possible.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002873">switch</span>&nbsp;<span class="ident" id="3002880">err</span>&nbsp;<span class="op" id="3002884">:=</span>&nbsp;<span class="ident" id="3002887">syscall</span><span class="op" id="3002894">.</span><span class="ident" id="3002895">Connect</span><span class="op" id="3002902">(</span><span class="ident" id="3002903">fd</span><span class="op" id="3002905">.</span><span class="ident" id="3002906">sysfd</span><span class="op" id="3002911">,</span>&nbsp;<span class="ident" id="3002913">ra</span><span class="op" id="3002915">)</span><span class="op" id="3002916">;</span>&nbsp;<span class="ident" id="3002918">err</span>&nbsp;<span class="op" id="3002922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002925">case</span>&nbsp;<span class="ident" id="3002930">syscall</span><span class="op" id="3002937">.</span><span class="ident" id="3002938">EINPROGRESS</span><span class="op" id="3002949">,</span>&nbsp;<span class="ident" id="3002951">syscall</span><span class="op" id="3002958">.</span><span class="ident" id="3002959">EALREADY</span><span class="op" id="3002967">,</span>&nbsp;<span class="ident" id="3002969">syscall</span><span class="op" id="3002976">.</span><span class="ident" id="3002977">EINTR</span><span class="op" id="3002982">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3002985">case</span>&nbsp;<span class="ident" id="3002990">nil</span><span class="op" id="3002993">,</span>&nbsp;<span class="ident" id="3002995">syscall</span><span class="op" id="3003002">.</span><span class="ident" id="3003003">EISCONN</span><span class="op" id="3003010">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003014">if</span>&nbsp;<span class="op" id="3003017">!</span><span class="ident" id="3003018">deadline</span><span class="op" id="3003026">.</span><span class="ident" id="3003027">IsZero</span><span class="op" id="3003033">(</span><span class="op" id="3003034">)</span>&nbsp;<span class="op" id="3003036">&amp;&amp;</span>&nbsp;<span class="ident" id="3003039">deadline</span><span class="op" id="3003047">.</span><span class="ident" id="3003048">Before</span><span class="op" id="3003054">(</span><span class="ident" id="3003055">time</span><span class="op" id="3003059">.</span><span class="ident" id="3003060">Now</span><span class="op" id="3003063">(</span><span class="op" id="3003064">)</span><span class="op" id="3003065">)</span>&nbsp;<span class="op" id="3003067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003072">return</span>&nbsp;<span class="ident" id="3003079">errTimeout</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3003092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003096">if</span>&nbsp;<span class="ident" id="3003099">err</span>&nbsp;<span class="op" id="3003103">:=</span>&nbsp;<span class="ident" id="3003106">fd</span><span class="op" id="3003108">.</span><span class="ident" id="3003109">init</span><span class="op" id="3003113">(</span><span class="op" id="3003114">)</span><span class="op" id="3003115">;</span>&nbsp;<span class="ident" id="3003117">err</span>&nbsp;<span class="op" id="3003121">!=</span>&nbsp;<span class="ident" id="3003124">nil</span>&nbsp;<span class="op" id="3003128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003133">return</span>&nbsp;<span class="ident" id="3003140">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3003146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003150">return</span>&nbsp;<span class="ident" id="3003157">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003162">case</span>&nbsp;<span class="ident" id="3003167">syscall</span><span class="op" id="3003174">.</span><span class="ident" id="3003175">EINVAL</span><span class="op" id="3003181">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3003185">//&nbsp;On&nbsp;Solaris&nbsp;we&nbsp;can&nbsp;see&nbsp;EINVAL&nbsp;if&nbsp;the&nbsp;socket&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3003237">//&nbsp;already&nbsp;been&nbsp;accepted&nbsp;and&nbsp;closed&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3003290">//&nbsp;Treat&nbsp;this&nbsp;as&nbsp;a&nbsp;successful&nbsp;connection--writes&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3003344">//&nbsp;the&nbsp;socket&nbsp;will&nbsp;see&nbsp;EOF.&nbsp;&nbsp;For&nbsp;details&nbsp;and&nbsp;a&nbsp;test</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3003398">//&nbsp;case&nbsp;in&nbsp;C&nbsp;see&nbsp;http://golang.org/issue/6828.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003447">if</span>&nbsp;<span class="ident" id="3003450">runtime</span><span class="op" id="3003457">.</span><span class="ident" id="3003458">GOOS</span>&nbsp;<span class="op" id="3003463">==</span>&nbsp;<span class="string" id="3003466">&#34;solaris&#34;</span>&nbsp;<span class="op" id="3003476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003481">return</span>&nbsp;<span class="ident" id="3003488">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3003494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003498">fallthrough</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003511">default</span><span class="op" id="3003518">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003522">return</span>&nbsp;<span class="ident" id="3003529">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3003534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003537">if</span>&nbsp;<span class="ident" id="3003540">err</span>&nbsp;<span class="op" id="3003544">:=</span>&nbsp;<span class="ident" id="3003547">fd</span><span class="op" id="3003549">.</span><span class="ident" id="3003550">init</span><span class="op" id="3003554">(</span><span class="op" id="3003555">)</span><span class="op" id="3003556">;</span>&nbsp;<span class="ident" id="3003558">err</span>&nbsp;<span class="op" id="3003562">!=</span>&nbsp;<span class="ident" id="3003565">nil</span>&nbsp;<span class="op" id="3003569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003573">return</span>&nbsp;<span class="ident" id="3003580">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3003585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003588">if</span>&nbsp;<span class="op" id="3003591">!</span><span class="ident" id="3003592">deadline</span><span class="op" id="3003600">.</span><span class="ident" id="3003601">IsZero</span><span class="op" id="3003607">(</span><span class="op" id="3003608">)</span>&nbsp;<span class="op" id="3003610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3003614">fd</span><span class="op" id="3003616">.</span><span class="ident" id="3003617">setWriteDeadline</span><span class="op" id="3003633">(</span><span class="ident" id="3003634">deadline</span><span class="op" id="3003642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003646">defer</span>&nbsp;<span class="ident" id="3003652">fd</span><span class="op" id="3003654">.</span><span class="ident" id="3003655">setWriteDeadline</span><span class="op" id="3003671">(</span><span class="ident" id="3003672">noDeadline</span><span class="op" id="3003682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3003685">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3003688">for</span>&nbsp;<span class="op" id="3003692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3003696">//&nbsp;Performing&nbsp;multiple&nbsp;connect&nbsp;system&nbsp;calls&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3003747">//&nbsp;non-blocking&nbsp;socket&nbsp;under&nbsp;Unix&nbsp;variants&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3003801">//&nbsp;necessarily&nbsp;result&nbsp;in&nbsp;earlier&nbsp;errors&nbsp;being</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3003849">//&nbsp;returned.&nbsp;Instead,&nbsp;once&nbsp;runtime-integrated&nbsp;network</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3003905">//&nbsp;poller&nbsp;tells&nbsp;us&nbsp;that&nbsp;the&nbsp;socket&nbsp;is&nbsp;ready,&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3003960">//&nbsp;SO_ERROR&nbsp;socket&nbsp;option&nbsp;to&nbsp;see&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3004013">//&nbsp;succeeded&nbsp;or&nbsp;failed.&nbsp;See&nbsp;issue&nbsp;7474&nbsp;for&nbsp;further</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3004066">//&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3004080">if</span>&nbsp;<span class="ident" id="3004083">err</span>&nbsp;<span class="op" id="3004087">:=</span>&nbsp;<span class="ident" id="3004090">fd</span><span class="op" id="3004092">.</span><span class="ident" id="3004093">pd</span><span class="op" id="3004095">.</span><span class="ident" id="3004096">WaitWrite</span><span class="op" id="3004105">(</span><span class="op" id="3004106">)</span><span class="op" id="3004107">;</span>&nbsp;<span class="ident" id="3004109">err</span>&nbsp;<span class="op" id="3004113">!=</span>&nbsp;<span class="ident" id="3004116">nil</span>&nbsp;<span class="op" id="3004120">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3004125">return</span>&nbsp;<span class="ident" id="3004132">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3004138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3004142">nerr</span><span class="op" id="3004146">,</span>&nbsp;<span class="ident" id="3004148">err</span>&nbsp;<span class="op" id="3004152">:=</span>&nbsp;<span class="ident" id="3004155">syscall</span><span class="op" id="3004162">.</span><span class="ident" id="3004163">GetsockoptInt</span><span class="op" id="3004176">(</span><span class="ident" id="3004177">fd</span><span class="op" id="3004179">.</span><span class="ident" id="3004180">sysfd</span><span class="op" id="3004185">,</span>&nbsp;<span class="ident" id="3004187">syscall</span><span class="op" id="3004194">.</span><span class="ident" id="3004195">SOL_SOCKET</span><span class="op" id="3004205">,</span>&nbsp;<span class="ident" id="3004207">syscall</span><span class="op" id="3004214">.</span><span class="ident" id="3004215">SO_ERROR</span><span class="op" id="3004223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3004227">if</span>&nbsp;<span class="ident" id="3004230">err</span>&nbsp;<span class="op" id="3004234">!=</span>&nbsp;<span class="ident" id="3004237">nil</span>&nbsp;<span class="op" id="3004241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3004246">return</span>&nbsp;<span class="ident" id="3004253">err</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3004259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3004263">switch</span>&nbsp;<span class="ident" id="3004270">err</span>&nbsp;<span class="op" id="3004274">:=</span>&nbsp;<span class="ident" id="3004277">syscall</span><span class="op" id="3004284">.</span><span class="ident" id="3004285">Errno</span><span class="op" id="3004290">(</span><span class="ident" id="3004291">nerr</span><span class="op" id="3004295">)</span><span class="op" id="3004296">;</span>&nbsp;<span class="ident" id="3004298">err</span>&nbsp;<span class="op" id="3004302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3004306">case</span>&nbsp;<span class="ident" id="3004311">syscall</span><span class="op" id="3004318">.</span><span class="ident" id="3004319">EINPROGRESS</span><span class="op" id="3004330">,</span>&nbsp;<span class="ident" id="3004332">syscall</span><span class="op" id="3004339">.</span><span class="ident" id="3004340">EALREADY</span><span class="op" id="3004348">,</span>&nbsp;<span class="ident" id="3004350">syscall</span><span class="op" id="3004357">.</span><span class="ident" id="3004358">EINTR</span><span class="op" id="3004363">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3004367">case</span>&nbsp;<span class="ident" id="3004372">syscall</span><span class="op" id="3004379">.</span><span class="ident" id="3004380">Errno</span><span class="op" id="3004385">(</span><span class="num" id="3004386">0</span><span class="op" id="3004387">)</span><span class="op" id="3004388">,</span>&nbsp;<span class="ident" id="3004390">syscall</span><span class="op" id="3004397">.</span><span class="ident" id="3004398">EISCONN</span><span class="op" id="3004405">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3004410">return</span>&nbsp;<span class="ident" id="3004417">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3004423">default</span><span class="op" id="3004430">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3004435">return</span>&nbsp;<span class="ident" id="3004442">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3004448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3004451">}</span><br>
<span class="lineno"></span><span class="op" id="3004453">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="keyword" id="3004456">func</span>&nbsp;<span class="op" id="3004461">(</span><span class="ident" id="3004462">fd</span>&nbsp;<span class="op" id="3004465">*</span><span class="ident" id="3004466">netFD</span><span class="op" id="3004471">)</span>&nbsp;<span class="ident" id="3004473">destroy</span><span class="op" id="3004480">(</span><span class="op" id="3004481">)</span>&nbsp;<span class="op" id="3004483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3004486">//&nbsp;Poller&nbsp;may&nbsp;want&nbsp;to&nbsp;unregister&nbsp;fd&nbsp;in&nbsp;readiness&nbsp;notification&nbsp;mechanism,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3004560">//&nbsp;so&nbsp;this&nbsp;must&nbsp;be&nbsp;executed&nbsp;before&nbsp;closesocket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3004609">fd</span><span class="op" id="3004611">.</span><span class="ident" id="3004612">pd</span><span class="op" id="3004614">.</span><span class="ident" id="3004615">Close</span><span class="op" id="3004620">(</span><span class="op" id="3004621">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3004624">closesocket</span><span class="op" id="3004635">(</span><span class="ident" id="3004636">fd</span><span class="op" id="3004638">.</span><span class="ident" id="3004639">sysfd</span><span class="op" id="3004644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3004647">fd</span><span class="op" id="3004649">.</span><span class="ident" id="3004650">sysfd</span>&nbsp;<span class="op" id="3004656">=</span>&nbsp;<span class="op" id="3004658">-</span><span class="num" id="3004659">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3004662">runtime</span><span class="op" id="3004669">.</span><span class="ident" id="3004670">SetFinalizer</span><span class="op" id="3004682">(</span><span class="ident" id="3004683">fd</span><span class="op" id="3004685">,</span>&nbsp;<span class="ident" id="3004687">nil</span><span class="op" id="3004690">)</span><br>
<span class="lineno"></span><span class="op" id="3004692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3004695">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd.</span><br>
<span class="lineno"></span><span class="comment" id="3004726">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3004772">func</span>&nbsp;<span class="op" id="3004777">(</span><span class="ident" id="3004778">fd</span>&nbsp;<span class="op" id="3004781">*</span><span class="ident" id="3004782">netFD</span><span class="op" id="3004787">)</span>&nbsp;<span class="ident" id="3004789">incref</span><span class="op" id="3004795">(</span><span class="op" id="3004796">)</span>&nbsp;<span class="builtintype" id="3004798">error</span>&nbsp;<span class="op" id="3004804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3004807">if</span>&nbsp;<span class="op" id="3004810">!</span><span class="ident" id="3004811">fd</span><span class="op" id="3004813">.</span><span class="ident" id="3004814">fdmu</span><span class="op" id="3004818">.</span><span class="ident" id="3004819">Incref</span><span class="op" id="3004825">(</span><span class="op" id="3004826">)</span>&nbsp;<span class="op" id="3004828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3004832">return</span>&nbsp;<span class="ident" id="3004839">errClosing</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3004851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3004854">return</span>&nbsp;<span class="ident" id="3004861">nil</span><br>
<span class="lineno"></span><span class="op" id="3004865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3004868">//&nbsp;Remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD&nbsp;and&nbsp;close&nbsp;if&nbsp;we&#39;ve&nbsp;been&nbsp;asked&nbsp;to&nbsp;do&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="3004940">//&nbsp;(and&nbsp;there&nbsp;are&nbsp;no&nbsp;references&nbsp;left).</span><br>
<span class="lineno"></span><span class="keyword" id="3004979">func</span>&nbsp;<span class="op" id="3004984">(</span><span class="ident" id="3004985">fd</span>&nbsp;<span class="op" id="3004988">*</span><span class="ident" id="3004989">netFD</span><span class="op" id="3004994">)</span>&nbsp;<span class="ident" id="3004996">decref</span><span class="op" id="3005002">(</span><span class="op" id="3005003">)</span>&nbsp;<span class="op" id="3005005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3005008">if</span>&nbsp;<span class="ident" id="3005011">fd</span><span class="op" id="3005013">.</span><span class="ident" id="3005014">fdmu</span><span class="op" id="3005018">.</span><span class="ident" id="3005019">Decref</span><span class="op" id="3005025">(</span><span class="op" id="3005026">)</span>&nbsp;<span class="op" id="3005028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3005032">fd</span><span class="op" id="3005034">.</span><span class="ident" id="3005035">destroy</span><span class="op" id="3005042">(</span><span class="op" id="3005043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3005046">}</span><br>
<span class="lineno">155</span><span class="op" id="3005048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3005051">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="comment" id="3005103">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3005149">func</span>&nbsp;<span class="op" id="3005154">(</span><span class="ident" id="3005155">fd</span>&nbsp;<span class="op" id="3005158">*</span><span class="ident" id="3005159">netFD</span><span class="op" id="3005164">)</span>&nbsp;<span class="ident" id="3005166">readLock</span><span class="op" id="3005174">(</span><span class="op" id="3005175">)</span>&nbsp;<span class="builtintype" id="3005177">error</span>&nbsp;<span class="op" id="3005183">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3005186">if</span>&nbsp;<span class="op" id="3005189">!</span><span class="ident" id="3005190">fd</span><span class="op" id="3005192">.</span><span class="ident" id="3005193">fdmu</span><span class="op" id="3005197">.</span><span class="ident" id="3005198">RWLock</span><span class="op" id="3005204">(</span><span class="builtintype" id="3005205">true</span><span class="op" id="3005209">)</span>&nbsp;<span class="op" id="3005211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3005215">return</span>&nbsp;<span class="ident" id="3005222">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3005234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3005237">return</span>&nbsp;<span class="ident" id="3005244">nil</span><br>
<span class="lineno"></span><span class="op" id="3005248">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="3005251">//&nbsp;Unlock&nbsp;for&nbsp;reading&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="3005308">func</span>&nbsp;<span class="op" id="3005313">(</span><span class="ident" id="3005314">fd</span>&nbsp;<span class="op" id="3005317">*</span><span class="ident" id="3005318">netFD</span><span class="op" id="3005323">)</span>&nbsp;<span class="ident" id="3005325">readUnlock</span><span class="op" id="3005335">(</span><span class="op" id="3005336">)</span>&nbsp;<span class="op" id="3005338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3005341">if</span>&nbsp;<span class="ident" id="3005344">fd</span><span class="op" id="3005346">.</span><span class="ident" id="3005347">fdmu</span><span class="op" id="3005351">.</span><span class="ident" id="3005352">RWUnlock</span><span class="op" id="3005360">(</span><span class="builtintype" id="3005361">true</span><span class="op" id="3005365">)</span>&nbsp;<span class="op" id="3005367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3005371">fd</span><span class="op" id="3005373">.</span><span class="ident" id="3005374">destroy</span><span class="op" id="3005381">(</span><span class="op" id="3005382">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3005385">}</span><br>
<span class="lineno"></span><span class="op" id="3005387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3005390">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="3005442">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno">175</span><span class="keyword" id="3005488">func</span>&nbsp;<span class="op" id="3005493">(</span><span class="ident" id="3005494">fd</span>&nbsp;<span class="op" id="3005497">*</span><span class="ident" id="3005498">netFD</span><span class="op" id="3005503">)</span>&nbsp;<span class="ident" id="3005505">writeLock</span><span class="op" id="3005514">(</span><span class="op" id="3005515">)</span>&nbsp;<span class="builtintype" id="3005517">error</span>&nbsp;<span class="op" id="3005523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3005526">if</span>&nbsp;<span class="op" id="3005529">!</span><span class="ident" id="3005530">fd</span><span class="op" id="3005532">.</span><span class="ident" id="3005533">fdmu</span><span class="op" id="3005537">.</span><span class="ident" id="3005538">RWLock</span><span class="op" id="3005544">(</span><span class="builtintype" id="3005545">false</span><span class="op" id="3005550">)</span>&nbsp;<span class="op" id="3005552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3005556">return</span>&nbsp;<span class="ident" id="3005563">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3005575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3005578">return</span>&nbsp;<span class="ident" id="3005585">nil</span><br>
<span class="lineno">180</span><span class="op" id="3005589">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3005592">//&nbsp;Unlock&nbsp;for&nbsp;writing&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="3005649">func</span>&nbsp;<span class="op" id="3005654">(</span><span class="ident" id="3005655">fd</span>&nbsp;<span class="op" id="3005658">*</span><span class="ident" id="3005659">netFD</span><span class="op" id="3005664">)</span>&nbsp;<span class="ident" id="3005666">writeUnlock</span><span class="op" id="3005677">(</span><span class="op" id="3005678">)</span>&nbsp;<span class="op" id="3005680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3005683">if</span>&nbsp;<span class="ident" id="3005686">fd</span><span class="op" id="3005688">.</span><span class="ident" id="3005689">fdmu</span><span class="op" id="3005693">.</span><span class="ident" id="3005694">RWUnlock</span><span class="op" id="3005702">(</span><span class="builtintype" id="3005703">false</span><span class="op" id="3005708">)</span>&nbsp;<span class="op" id="3005710">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3005714">fd</span><span class="op" id="3005716">.</span><span class="ident" id="3005717">destroy</span><span class="op" id="3005724">(</span><span class="op" id="3005725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3005728">}</span><br>
<span class="lineno"></span><span class="op" id="3005730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3005733">func</span>&nbsp;<span class="op" id="3005738">(</span><span class="ident" id="3005739">fd</span>&nbsp;<span class="op" id="3005742">*</span><span class="ident" id="3005743">netFD</span><span class="op" id="3005748">)</span>&nbsp;<span class="ident" id="3005750">Close</span><span class="op" id="3005755">(</span><span class="op" id="3005756">)</span>&nbsp;<span class="builtintype" id="3005758">error</span>&nbsp;<span class="op" id="3005764">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3005767">fd</span><span class="op" id="3005769">.</span><span class="ident" id="3005770">pd</span><span class="op" id="3005772">.</span><span class="ident" id="3005773">Lock</span><span class="op" id="3005777">(</span><span class="op" id="3005778">)</span>&nbsp;<span class="comment" id="3005780">//&nbsp;needed&nbsp;for&nbsp;both&nbsp;fd.incref(true)&nbsp;and&nbsp;pollDesc.Evict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3005835">if</span>&nbsp;<span class="op" id="3005838">!</span><span class="ident" id="3005839">fd</span><span class="op" id="3005841">.</span><span class="ident" id="3005842">fdmu</span><span class="op" id="3005846">.</span><span class="ident" id="3005847">IncrefAndClose</span><span class="op" id="3005861">(</span><span class="op" id="3005862">)</span>&nbsp;<span class="op" id="3005864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3005868">fd</span><span class="op" id="3005870">.</span><span class="ident" id="3005871">pd</span><span class="op" id="3005873">.</span><span class="ident" id="3005874">Unlock</span><span class="op" id="3005880">(</span><span class="op" id="3005881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3005885">return</span>&nbsp;<span class="ident" id="3005892">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3005904">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3005907">//&nbsp;Unblock&nbsp;any&nbsp;I/O.&nbsp;&nbsp;Once&nbsp;it&nbsp;all&nbsp;unblocks&nbsp;and&nbsp;returns,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3005963">//&nbsp;so&nbsp;that&nbsp;it&nbsp;cannot&nbsp;be&nbsp;referring&nbsp;to&nbsp;fd.sysfd&nbsp;anymore,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3006019">//&nbsp;the&nbsp;final&nbsp;decref&nbsp;will&nbsp;close&nbsp;fd.sysfd.&nbsp;&nbsp;This&nbsp;should&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3006081">//&nbsp;fairly&nbsp;quickly,&nbsp;since&nbsp;all&nbsp;the&nbsp;I/O&nbsp;is&nbsp;non-blocking,&nbsp;and&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3006144">//&nbsp;attempts&nbsp;to&nbsp;block&nbsp;in&nbsp;the&nbsp;pollDesc&nbsp;will&nbsp;return&nbsp;errClosing.</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3006206">doWakeup</span>&nbsp;<span class="op" id="3006215">:=</span>&nbsp;<span class="ident" id="3006218">fd</span><span class="op" id="3006220">.</span><span class="ident" id="3006221">pd</span><span class="op" id="3006223">.</span><span class="ident" id="3006224">Evict</span><span class="op" id="3006229">(</span><span class="op" id="3006230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3006233">fd</span><span class="op" id="3006235">.</span><span class="ident" id="3006236">pd</span><span class="op" id="3006238">.</span><span class="ident" id="3006239">Unlock</span><span class="op" id="3006245">(</span><span class="op" id="3006246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3006249">fd</span><span class="op" id="3006251">.</span><span class="ident" id="3006252">decref</span><span class="op" id="3006258">(</span><span class="op" id="3006259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006262">if</span>&nbsp;<span class="ident" id="3006265">doWakeup</span>&nbsp;<span class="op" id="3006274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3006278">fd</span><span class="op" id="3006280">.</span><span class="ident" id="3006281">pd</span><span class="op" id="3006283">.</span><span class="ident" id="3006284">Wakeup</span><span class="op" id="3006290">(</span><span class="op" id="3006291">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3006294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006297">return</span>&nbsp;<span class="ident" id="3006304">nil</span><br>
<span class="lineno"></span><span class="op" id="3006308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3006311">func</span>&nbsp;<span class="op" id="3006316">(</span><span class="ident" id="3006317">fd</span>&nbsp;<span class="op" id="3006320">*</span><span class="ident" id="3006321">netFD</span><span class="op" id="3006326">)</span>&nbsp;<span class="ident" id="3006328">shutdown</span><span class="op" id="3006336">(</span><span class="ident" id="3006337">how</span>&nbsp;<span class="builtintype" id="3006341">int</span><span class="op" id="3006344">)</span>&nbsp;<span class="builtintype" id="3006346">error</span>&nbsp;<span class="op" id="3006352">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006355">if</span>&nbsp;<span class="ident" id="3006358">err</span>&nbsp;<span class="op" id="3006362">:=</span>&nbsp;<span class="ident" id="3006365">fd</span><span class="op" id="3006367">.</span><span class="ident" id="3006368">incref</span><span class="op" id="3006374">(</span><span class="op" id="3006375">)</span><span class="op" id="3006376">;</span>&nbsp;<span class="ident" id="3006378">err</span>&nbsp;<span class="op" id="3006382">!=</span>&nbsp;<span class="ident" id="3006385">nil</span>&nbsp;<span class="op" id="3006389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006393">return</span>&nbsp;<span class="ident" id="3006400">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3006405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006408">defer</span>&nbsp;<span class="ident" id="3006414">fd</span><span class="op" id="3006416">.</span><span class="ident" id="3006417">decref</span><span class="op" id="3006423">(</span><span class="op" id="3006424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3006427">err</span>&nbsp;<span class="op" id="3006431">:=</span>&nbsp;<span class="ident" id="3006434">syscall</span><span class="op" id="3006441">.</span><span class="ident" id="3006442">Shutdown</span><span class="op" id="3006450">(</span><span class="ident" id="3006451">fd</span><span class="op" id="3006453">.</span><span class="ident" id="3006454">sysfd</span><span class="op" id="3006459">,</span>&nbsp;<span class="ident" id="3006461">how</span><span class="op" id="3006464">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006467">if</span>&nbsp;<span class="ident" id="3006470">err</span>&nbsp;<span class="op" id="3006474">!=</span>&nbsp;<span class="ident" id="3006477">nil</span>&nbsp;<span class="op" id="3006481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006485">return</span>&nbsp;<span class="op" id="3006492">&amp;</span><span class="ident" id="3006493">OpError</span><span class="op" id="3006500">{</span><span class="string" id="3006501">&#34;shutdown&#34;</span><span class="op" id="3006511">,</span>&nbsp;<span class="ident" id="3006513">fd</span><span class="op" id="3006515">.</span><span class="ident" id="3006516">net</span><span class="op" id="3006519">,</span>&nbsp;<span class="ident" id="3006521">fd</span><span class="op" id="3006523">.</span><span class="ident" id="3006524">laddr</span><span class="op" id="3006529">,</span>&nbsp;<span class="ident" id="3006531">err</span><span class="op" id="3006534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3006537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006540">return</span>&nbsp;<span class="ident" id="3006547">nil</span><br>
<span class="lineno"></span><span class="op" id="3006551">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="3006554">func</span>&nbsp;<span class="op" id="3006559">(</span><span class="ident" id="3006560">fd</span>&nbsp;<span class="op" id="3006563">*</span><span class="ident" id="3006564">netFD</span><span class="op" id="3006569">)</span>&nbsp;<span class="ident" id="3006571">closeRead</span><span class="op" id="3006580">(</span><span class="op" id="3006581">)</span>&nbsp;<span class="builtintype" id="3006583">error</span>&nbsp;<span class="op" id="3006589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006592">return</span>&nbsp;<span class="ident" id="3006599">fd</span><span class="op" id="3006601">.</span><span class="ident" id="3006602">shutdown</span><span class="op" id="3006610">(</span><span class="ident" id="3006611">syscall</span><span class="op" id="3006618">.</span><span class="ident" id="3006619">SHUT_RD</span><span class="op" id="3006626">)</span><br>
<span class="lineno"></span><span class="op" id="3006628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="3006631">func</span>&nbsp;<span class="op" id="3006636">(</span><span class="ident" id="3006637">fd</span>&nbsp;<span class="op" id="3006640">*</span><span class="ident" id="3006641">netFD</span><span class="op" id="3006646">)</span>&nbsp;<span class="ident" id="3006648">closeWrite</span><span class="op" id="3006658">(</span><span class="op" id="3006659">)</span>&nbsp;<span class="builtintype" id="3006661">error</span>&nbsp;<span class="op" id="3006667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006670">return</span>&nbsp;<span class="ident" id="3006677">fd</span><span class="op" id="3006679">.</span><span class="ident" id="3006680">shutdown</span><span class="op" id="3006688">(</span><span class="ident" id="3006689">syscall</span><span class="op" id="3006696">.</span><span class="ident" id="3006697">SHUT_WR</span><span class="op" id="3006704">)</span><br>
<span class="lineno"></span><span class="op" id="3006706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3006709">func</span>&nbsp;<span class="op" id="3006714">(</span><span class="ident" id="3006715">fd</span>&nbsp;<span class="op" id="3006718">*</span><span class="ident" id="3006719">netFD</span><span class="op" id="3006724">)</span>&nbsp;<span class="ident" id="3006726">Read</span><span class="op" id="3006730">(</span><span class="ident" id="3006731">p</span>&nbsp;<span class="op" id="3006733">[</span><span class="op" id="3006734">]</span><span class="builtintype" id="3006735">byte</span><span class="op" id="3006739">)</span>&nbsp;<span class="op" id="3006741">(</span><span class="ident" id="3006742">n</span>&nbsp;<span class="builtintype" id="3006744">int</span><span class="op" id="3006747">,</span>&nbsp;<span class="ident" id="3006749">err</span>&nbsp;<span class="builtintype" id="3006753">error</span><span class="op" id="3006758">)</span>&nbsp;<span class="op" id="3006760">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006763">if</span>&nbsp;<span class="ident" id="3006766">err</span>&nbsp;<span class="op" id="3006770">:=</span>&nbsp;<span class="ident" id="3006773">fd</span><span class="op" id="3006775">.</span><span class="ident" id="3006776">readLock</span><span class="op" id="3006784">(</span><span class="op" id="3006785">)</span><span class="op" id="3006786">;</span>&nbsp;<span class="ident" id="3006788">err</span>&nbsp;<span class="op" id="3006792">!=</span>&nbsp;<span class="ident" id="3006795">nil</span>&nbsp;<span class="op" id="3006799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006803">return</span>&nbsp;<span class="num" id="3006810">0</span><span class="op" id="3006811">,</span>&nbsp;<span class="ident" id="3006813">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3006818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006821">defer</span>&nbsp;<span class="ident" id="3006827">fd</span><span class="op" id="3006829">.</span><span class="ident" id="3006830">readUnlock</span><span class="op" id="3006840">(</span><span class="op" id="3006841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006844">if</span>&nbsp;<span class="ident" id="3006847">err</span>&nbsp;<span class="op" id="3006851">:=</span>&nbsp;<span class="ident" id="3006854">fd</span><span class="op" id="3006856">.</span><span class="ident" id="3006857">pd</span><span class="op" id="3006859">.</span><span class="ident" id="3006860">PrepareRead</span><span class="op" id="3006871">(</span><span class="op" id="3006872">)</span><span class="op" id="3006873">;</span>&nbsp;<span class="ident" id="3006875">err</span>&nbsp;<span class="op" id="3006879">!=</span>&nbsp;<span class="ident" id="3006882">nil</span>&nbsp;<span class="op" id="3006886">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006890">return</span>&nbsp;<span class="num" id="3006897">0</span><span class="op" id="3006898">,</span>&nbsp;<span class="op" id="3006900">&amp;</span><span class="ident" id="3006901">OpError</span><span class="op" id="3006908">{</span><span class="string" id="3006909">&#34;read&#34;</span><span class="op" id="3006915">,</span>&nbsp;<span class="ident" id="3006917">fd</span><span class="op" id="3006919">.</span><span class="ident" id="3006920">net</span><span class="op" id="3006923">,</span>&nbsp;<span class="ident" id="3006925">fd</span><span class="op" id="3006927">.</span><span class="ident" id="3006928">raddr</span><span class="op" id="3006933">,</span>&nbsp;<span class="ident" id="3006935">err</span><span class="op" id="3006938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3006941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006944">for</span>&nbsp;<span class="op" id="3006948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3006952">n</span><span class="op" id="3006953">,</span>&nbsp;<span class="ident" id="3006955">err</span>&nbsp;<span class="op" id="3006959">=</span>&nbsp;<span class="ident" id="3006961">syscall</span><span class="op" id="3006968">.</span><span class="ident" id="3006969">Read</span><span class="op" id="3006973">(</span><span class="builtintype" id="3006974">int</span><span class="op" id="3006977">(</span><span class="ident" id="3006978">fd</span><span class="op" id="3006980">.</span><span class="ident" id="3006981">sysfd</span><span class="op" id="3006986">)</span><span class="op" id="3006987">,</span>&nbsp;<span class="ident" id="3006989">p</span><span class="op" id="3006990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3006994">if</span>&nbsp;<span class="ident" id="3006997">err</span>&nbsp;<span class="op" id="3007001">!=</span>&nbsp;<span class="ident" id="3007004">nil</span>&nbsp;<span class="op" id="3007008">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3007013">n</span>&nbsp;<span class="op" id="3007015">=</span>&nbsp;<span class="num" id="3007017">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007022">if</span>&nbsp;<span class="ident" id="3007025">err</span>&nbsp;<span class="op" id="3007029">==</span>&nbsp;<span class="ident" id="3007032">syscall</span><span class="op" id="3007039">.</span><span class="ident" id="3007040">EAGAIN</span>&nbsp;<span class="op" id="3007047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007053">if</span>&nbsp;<span class="ident" id="3007056">err</span>&nbsp;<span class="op" id="3007060">=</span>&nbsp;<span class="ident" id="3007062">fd</span><span class="op" id="3007064">.</span><span class="ident" id="3007065">pd</span><span class="op" id="3007067">.</span><span class="ident" id="3007068">WaitRead</span><span class="op" id="3007076">(</span><span class="op" id="3007077">)</span><span class="op" id="3007078">;</span>&nbsp;<span class="ident" id="3007080">err</span>&nbsp;<span class="op" id="3007084">==</span>&nbsp;<span class="ident" id="3007087">nil</span>&nbsp;<span class="op" id="3007091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007098">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3007111">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3007116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3007120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3007124">err</span>&nbsp;<span class="op" id="3007128">=</span>&nbsp;<span class="ident" id="3007130">chkReadErr</span><span class="op" id="3007140">(</span><span class="ident" id="3007141">n</span><span class="op" id="3007142">,</span>&nbsp;<span class="ident" id="3007144">err</span><span class="op" id="3007147">,</span>&nbsp;<span class="ident" id="3007149">fd</span><span class="op" id="3007151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007155">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3007162">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007165">if</span>&nbsp;<span class="ident" id="3007168">err</span>&nbsp;<span class="op" id="3007172">!=</span>&nbsp;<span class="ident" id="3007175">nil</span>&nbsp;<span class="op" id="3007179">&amp;&amp;</span>&nbsp;<span class="ident" id="3007182">err</span>&nbsp;<span class="op" id="3007186">!=</span>&nbsp;<span class="ident" id="3007189">io</span><span class="op" id="3007191">.</span><span class="ident" id="3007192">EOF</span>&nbsp;<span class="op" id="3007196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3007200">err</span>&nbsp;<span class="op" id="3007204">=</span>&nbsp;<span class="op" id="3007206">&amp;</span><span class="ident" id="3007207">OpError</span><span class="op" id="3007214">{</span><span class="string" id="3007215">&#34;read&#34;</span><span class="op" id="3007221">,</span>&nbsp;<span class="ident" id="3007223">fd</span><span class="op" id="3007225">.</span><span class="ident" id="3007226">net</span><span class="op" id="3007229">,</span>&nbsp;<span class="ident" id="3007231">fd</span><span class="op" id="3007233">.</span><span class="ident" id="3007234">raddr</span><span class="op" id="3007239">,</span>&nbsp;<span class="ident" id="3007241">err</span><span class="op" id="3007244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3007247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007250">return</span><br>
<span class="lineno"></span><span class="op" id="3007257">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="3007260">func</span>&nbsp;<span class="op" id="3007265">(</span><span class="ident" id="3007266">fd</span>&nbsp;<span class="op" id="3007269">*</span><span class="ident" id="3007270">netFD</span><span class="op" id="3007275">)</span>&nbsp;<span class="ident" id="3007277">readFrom</span><span class="op" id="3007285">(</span><span class="ident" id="3007286">p</span>&nbsp;<span class="op" id="3007288">[</span><span class="op" id="3007289">]</span><span class="builtintype" id="3007290">byte</span><span class="op" id="3007294">)</span>&nbsp;<span class="op" id="3007296">(</span><span class="ident" id="3007297">n</span>&nbsp;<span class="builtintype" id="3007299">int</span><span class="op" id="3007302">,</span>&nbsp;<span class="ident" id="3007304">sa</span>&nbsp;<span class="ident" id="3007307">syscall</span><span class="op" id="3007314">.</span><span class="ident" id="3007315">Sockaddr</span><span class="op" id="3007323">,</span>&nbsp;<span class="ident" id="3007325">err</span>&nbsp;<span class="builtintype" id="3007329">error</span><span class="op" id="3007334">)</span>&nbsp;<span class="op" id="3007336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007339">if</span>&nbsp;<span class="ident" id="3007342">err</span>&nbsp;<span class="op" id="3007346">:=</span>&nbsp;<span class="ident" id="3007349">fd</span><span class="op" id="3007351">.</span><span class="ident" id="3007352">readLock</span><span class="op" id="3007360">(</span><span class="op" id="3007361">)</span><span class="op" id="3007362">;</span>&nbsp;<span class="ident" id="3007364">err</span>&nbsp;<span class="op" id="3007368">!=</span>&nbsp;<span class="ident" id="3007371">nil</span>&nbsp;<span class="op" id="3007375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007379">return</span>&nbsp;<span class="num" id="3007386">0</span><span class="op" id="3007387">,</span>&nbsp;<span class="ident" id="3007389">nil</span><span class="op" id="3007392">,</span>&nbsp;<span class="ident" id="3007394">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3007399">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007402">defer</span>&nbsp;<span class="ident" id="3007408">fd</span><span class="op" id="3007410">.</span><span class="ident" id="3007411">readUnlock</span><span class="op" id="3007421">(</span><span class="op" id="3007422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007425">if</span>&nbsp;<span class="ident" id="3007428">err</span>&nbsp;<span class="op" id="3007432">:=</span>&nbsp;<span class="ident" id="3007435">fd</span><span class="op" id="3007437">.</span><span class="ident" id="3007438">pd</span><span class="op" id="3007440">.</span><span class="ident" id="3007441">PrepareRead</span><span class="op" id="3007452">(</span><span class="op" id="3007453">)</span><span class="op" id="3007454">;</span>&nbsp;<span class="ident" id="3007456">err</span>&nbsp;<span class="op" id="3007460">!=</span>&nbsp;<span class="ident" id="3007463">nil</span>&nbsp;<span class="op" id="3007467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007471">return</span>&nbsp;<span class="num" id="3007478">0</span><span class="op" id="3007479">,</span>&nbsp;<span class="ident" id="3007481">nil</span><span class="op" id="3007484">,</span>&nbsp;<span class="op" id="3007486">&amp;</span><span class="ident" id="3007487">OpError</span><span class="op" id="3007494">{</span><span class="string" id="3007495">&#34;read&#34;</span><span class="op" id="3007501">,</span>&nbsp;<span class="ident" id="3007503">fd</span><span class="op" id="3007505">.</span><span class="ident" id="3007506">net</span><span class="op" id="3007509">,</span>&nbsp;<span class="ident" id="3007511">fd</span><span class="op" id="3007513">.</span><span class="ident" id="3007514">laddr</span><span class="op" id="3007519">,</span>&nbsp;<span class="ident" id="3007521">err</span><span class="op" id="3007524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3007527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007530">for</span>&nbsp;<span class="op" id="3007534">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3007538">n</span><span class="op" id="3007539">,</span>&nbsp;<span class="ident" id="3007541">sa</span><span class="op" id="3007543">,</span>&nbsp;<span class="ident" id="3007545">err</span>&nbsp;<span class="op" id="3007549">=</span>&nbsp;<span class="ident" id="3007551">syscall</span><span class="op" id="3007558">.</span><span class="ident" id="3007559">Recvfrom</span><span class="op" id="3007567">(</span><span class="ident" id="3007568">fd</span><span class="op" id="3007570">.</span><span class="ident" id="3007571">sysfd</span><span class="op" id="3007576">,</span>&nbsp;<span class="ident" id="3007578">p</span><span class="op" id="3007579">,</span>&nbsp;<span class="num" id="3007581">0</span><span class="op" id="3007582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007586">if</span>&nbsp;<span class="ident" id="3007589">err</span>&nbsp;<span class="op" id="3007593">!=</span>&nbsp;<span class="ident" id="3007596">nil</span>&nbsp;<span class="op" id="3007600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3007605">n</span>&nbsp;<span class="op" id="3007607">=</span>&nbsp;<span class="num" id="3007609">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007614">if</span>&nbsp;<span class="ident" id="3007617">err</span>&nbsp;<span class="op" id="3007621">==</span>&nbsp;<span class="ident" id="3007624">syscall</span><span class="op" id="3007631">.</span><span class="ident" id="3007632">EAGAIN</span>&nbsp;<span class="op" id="3007639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007645">if</span>&nbsp;<span class="ident" id="3007648">err</span>&nbsp;<span class="op" id="3007652">=</span>&nbsp;<span class="ident" id="3007654">fd</span><span class="op" id="3007656">.</span><span class="ident" id="3007657">pd</span><span class="op" id="3007659">.</span><span class="ident" id="3007660">WaitRead</span><span class="op" id="3007668">(</span><span class="op" id="3007669">)</span><span class="op" id="3007670">;</span>&nbsp;<span class="ident" id="3007672">err</span>&nbsp;<span class="op" id="3007676">==</span>&nbsp;<span class="ident" id="3007679">nil</span>&nbsp;<span class="op" id="3007683">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007690">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3007703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3007708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3007712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3007716">err</span>&nbsp;<span class="op" id="3007720">=</span>&nbsp;<span class="ident" id="3007722">chkReadErr</span><span class="op" id="3007732">(</span><span class="ident" id="3007733">n</span><span class="op" id="3007734">,</span>&nbsp;<span class="ident" id="3007736">err</span><span class="op" id="3007739">,</span>&nbsp;<span class="ident" id="3007741">fd</span><span class="op" id="3007743">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007747">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3007754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007757">if</span>&nbsp;<span class="ident" id="3007760">err</span>&nbsp;<span class="op" id="3007764">!=</span>&nbsp;<span class="ident" id="3007767">nil</span>&nbsp;<span class="op" id="3007771">&amp;&amp;</span>&nbsp;<span class="ident" id="3007774">err</span>&nbsp;<span class="op" id="3007778">!=</span>&nbsp;<span class="ident" id="3007781">io</span><span class="op" id="3007783">.</span><span class="ident" id="3007784">EOF</span>&nbsp;<span class="op" id="3007788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3007792">err</span>&nbsp;<span class="op" id="3007796">=</span>&nbsp;<span class="op" id="3007798">&amp;</span><span class="ident" id="3007799">OpError</span><span class="op" id="3007806">{</span><span class="string" id="3007807">&#34;read&#34;</span><span class="op" id="3007813">,</span>&nbsp;<span class="ident" id="3007815">fd</span><span class="op" id="3007817">.</span><span class="ident" id="3007818">net</span><span class="op" id="3007821">,</span>&nbsp;<span class="ident" id="3007823">fd</span><span class="op" id="3007825">.</span><span class="ident" id="3007826">laddr</span><span class="op" id="3007831">,</span>&nbsp;<span class="ident" id="3007833">err</span><span class="op" id="3007836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3007839">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007842">return</span><br>
<span class="lineno"></span><span class="op" id="3007849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3007852">func</span>&nbsp;<span class="op" id="3007857">(</span><span class="ident" id="3007858">fd</span>&nbsp;<span class="op" id="3007861">*</span><span class="ident" id="3007862">netFD</span><span class="op" id="3007867">)</span>&nbsp;<span class="ident" id="3007869">readMsg</span><span class="op" id="3007876">(</span><span class="ident" id="3007877">p</span>&nbsp;<span class="op" id="3007879">[</span><span class="op" id="3007880">]</span><span class="builtintype" id="3007881">byte</span><span class="op" id="3007885">,</span>&nbsp;<span class="ident" id="3007887">oob</span>&nbsp;<span class="op" id="3007891">[</span><span class="op" id="3007892">]</span><span class="builtintype" id="3007893">byte</span><span class="op" id="3007897">)</span>&nbsp;<span class="op" id="3007899">(</span><span class="ident" id="3007900">n</span><span class="op" id="3007901">,</span>&nbsp;<span class="ident" id="3007903">oobn</span><span class="op" id="3007907">,</span>&nbsp;<span class="ident" id="3007909">flags</span>&nbsp;<span class="builtintype" id="3007915">int</span><span class="op" id="3007918">,</span>&nbsp;<span class="ident" id="3007920">sa</span>&nbsp;<span class="ident" id="3007923">syscall</span><span class="op" id="3007930">.</span><span class="ident" id="3007931">Sockaddr</span><span class="op" id="3007939">,</span>&nbsp;<span class="ident" id="3007941">err</span>&nbsp;<span class="builtintype" id="3007945">error</span><span class="op" id="3007950">)</span>&nbsp;<span class="op" id="3007952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007955">if</span>&nbsp;<span class="ident" id="3007958">err</span>&nbsp;<span class="op" id="3007962">:=</span>&nbsp;<span class="ident" id="3007965">fd</span><span class="op" id="3007967">.</span><span class="ident" id="3007968">readLock</span><span class="op" id="3007976">(</span><span class="op" id="3007977">)</span><span class="op" id="3007978">;</span>&nbsp;<span class="ident" id="3007980">err</span>&nbsp;<span class="op" id="3007984">!=</span>&nbsp;<span class="ident" id="3007987">nil</span>&nbsp;<span class="op" id="3007991">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3007995">return</span>&nbsp;<span class="num" id="3008002">0</span><span class="op" id="3008003">,</span>&nbsp;<span class="num" id="3008005">0</span><span class="op" id="3008006">,</span>&nbsp;<span class="num" id="3008008">0</span><span class="op" id="3008009">,</span>&nbsp;<span class="ident" id="3008011">nil</span><span class="op" id="3008014">,</span>&nbsp;<span class="ident" id="3008016">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3008021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008024">defer</span>&nbsp;<span class="ident" id="3008030">fd</span><span class="op" id="3008032">.</span><span class="ident" id="3008033">readUnlock</span><span class="op" id="3008043">(</span><span class="op" id="3008044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008047">if</span>&nbsp;<span class="ident" id="3008050">err</span>&nbsp;<span class="op" id="3008054">:=</span>&nbsp;<span class="ident" id="3008057">fd</span><span class="op" id="3008059">.</span><span class="ident" id="3008060">pd</span><span class="op" id="3008062">.</span><span class="ident" id="3008063">PrepareRead</span><span class="op" id="3008074">(</span><span class="op" id="3008075">)</span><span class="op" id="3008076">;</span>&nbsp;<span class="ident" id="3008078">err</span>&nbsp;<span class="op" id="3008082">!=</span>&nbsp;<span class="ident" id="3008085">nil</span>&nbsp;<span class="op" id="3008089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008093">return</span>&nbsp;<span class="num" id="3008100">0</span><span class="op" id="3008101">,</span>&nbsp;<span class="num" id="3008103">0</span><span class="op" id="3008104">,</span>&nbsp;<span class="num" id="3008106">0</span><span class="op" id="3008107">,</span>&nbsp;<span class="ident" id="3008109">nil</span><span class="op" id="3008112">,</span>&nbsp;<span class="op" id="3008114">&amp;</span><span class="ident" id="3008115">OpError</span><span class="op" id="3008122">{</span><span class="string" id="3008123">&#34;read&#34;</span><span class="op" id="3008129">,</span>&nbsp;<span class="ident" id="3008131">fd</span><span class="op" id="3008133">.</span><span class="ident" id="3008134">net</span><span class="op" id="3008137">,</span>&nbsp;<span class="ident" id="3008139">fd</span><span class="op" id="3008141">.</span><span class="ident" id="3008142">laddr</span><span class="op" id="3008147">,</span>&nbsp;<span class="ident" id="3008149">err</span><span class="op" id="3008152">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3008155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008158">for</span>&nbsp;<span class="op" id="3008162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3008166">n</span><span class="op" id="3008167">,</span>&nbsp;<span class="ident" id="3008169">oobn</span><span class="op" id="3008173">,</span>&nbsp;<span class="ident" id="3008175">flags</span><span class="op" id="3008180">,</span>&nbsp;<span class="ident" id="3008182">sa</span><span class="op" id="3008184">,</span>&nbsp;<span class="ident" id="3008186">err</span>&nbsp;<span class="op" id="3008190">=</span>&nbsp;<span class="ident" id="3008192">syscall</span><span class="op" id="3008199">.</span><span class="ident" id="3008200">Recvmsg</span><span class="op" id="3008207">(</span><span class="ident" id="3008208">fd</span><span class="op" id="3008210">.</span><span class="ident" id="3008211">sysfd</span><span class="op" id="3008216">,</span>&nbsp;<span class="ident" id="3008218">p</span><span class="op" id="3008219">,</span>&nbsp;<span class="ident" id="3008221">oob</span><span class="op" id="3008224">,</span>&nbsp;<span class="num" id="3008226">0</span><span class="op" id="3008227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008231">if</span>&nbsp;<span class="ident" id="3008234">err</span>&nbsp;<span class="op" id="3008238">!=</span>&nbsp;<span class="ident" id="3008241">nil</span>&nbsp;<span class="op" id="3008245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3008250">//&nbsp;TODO(dfc)&nbsp;should&nbsp;n&nbsp;and&nbsp;oobn&nbsp;be&nbsp;set&nbsp;to&nbsp;0</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008296">if</span>&nbsp;<span class="ident" id="3008299">err</span>&nbsp;<span class="op" id="3008303">==</span>&nbsp;<span class="ident" id="3008306">syscall</span><span class="op" id="3008313">.</span><span class="ident" id="3008314">EAGAIN</span>&nbsp;<span class="op" id="3008321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008327">if</span>&nbsp;<span class="ident" id="3008330">err</span>&nbsp;<span class="op" id="3008334">=</span>&nbsp;<span class="ident" id="3008336">fd</span><span class="op" id="3008338">.</span><span class="ident" id="3008339">pd</span><span class="op" id="3008341">.</span><span class="ident" id="3008342">WaitRead</span><span class="op" id="3008350">(</span><span class="op" id="3008351">)</span><span class="op" id="3008352">;</span>&nbsp;<span class="ident" id="3008354">err</span>&nbsp;<span class="op" id="3008358">==</span>&nbsp;<span class="ident" id="3008361">nil</span>&nbsp;<span class="op" id="3008365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008372">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3008385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3008390">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3008394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3008398">err</span>&nbsp;<span class="op" id="3008402">=</span>&nbsp;<span class="ident" id="3008404">chkReadErr</span><span class="op" id="3008414">(</span><span class="ident" id="3008415">n</span><span class="op" id="3008416">,</span>&nbsp;<span class="ident" id="3008418">err</span><span class="op" id="3008421">,</span>&nbsp;<span class="ident" id="3008423">fd</span><span class="op" id="3008425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008429">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3008436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008439">if</span>&nbsp;<span class="ident" id="3008442">err</span>&nbsp;<span class="op" id="3008446">!=</span>&nbsp;<span class="ident" id="3008449">nil</span>&nbsp;<span class="op" id="3008453">&amp;&amp;</span>&nbsp;<span class="ident" id="3008456">err</span>&nbsp;<span class="op" id="3008460">!=</span>&nbsp;<span class="ident" id="3008463">io</span><span class="op" id="3008465">.</span><span class="ident" id="3008466">EOF</span>&nbsp;<span class="op" id="3008470">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3008474">err</span>&nbsp;<span class="op" id="3008478">=</span>&nbsp;<span class="op" id="3008480">&amp;</span><span class="ident" id="3008481">OpError</span><span class="op" id="3008488">{</span><span class="string" id="3008489">&#34;read&#34;</span><span class="op" id="3008495">,</span>&nbsp;<span class="ident" id="3008497">fd</span><span class="op" id="3008499">.</span><span class="ident" id="3008500">net</span><span class="op" id="3008503">,</span>&nbsp;<span class="ident" id="3008505">fd</span><span class="op" id="3008507">.</span><span class="ident" id="3008508">laddr</span><span class="op" id="3008513">,</span>&nbsp;<span class="ident" id="3008515">err</span><span class="op" id="3008518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3008521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008524">return</span><br>
<span class="lineno"></span><span class="op" id="3008531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span><span class="keyword" id="3008534">func</span>&nbsp;<span class="ident" id="3008539">chkReadErr</span><span class="op" id="3008549">(</span><span class="ident" id="3008550">n</span>&nbsp;<span class="builtintype" id="3008552">int</span><span class="op" id="3008555">,</span>&nbsp;<span class="ident" id="3008557">err</span>&nbsp;<span class="builtintype" id="3008561">error</span><span class="op" id="3008566">,</span>&nbsp;<span class="ident" id="3008568">fd</span>&nbsp;<span class="op" id="3008571">*</span><span class="ident" id="3008572">netFD</span><span class="op" id="3008577">)</span>&nbsp;<span class="builtintype" id="3008579">error</span>&nbsp;<span class="op" id="3008585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008588">if</span>&nbsp;<span class="ident" id="3008591">n</span>&nbsp;<span class="op" id="3008593">==</span>&nbsp;<span class="num" id="3008596">0</span>&nbsp;<span class="op" id="3008598">&amp;&amp;</span>&nbsp;<span class="ident" id="3008601">err</span>&nbsp;<span class="op" id="3008605">==</span>&nbsp;<span class="ident" id="3008608">nil</span>&nbsp;<span class="op" id="3008612">&amp;&amp;</span>&nbsp;<span class="ident" id="3008615">fd</span><span class="op" id="3008617">.</span><span class="ident" id="3008618">sotype</span>&nbsp;<span class="op" id="3008625">!=</span>&nbsp;<span class="ident" id="3008628">syscall</span><span class="op" id="3008635">.</span><span class="ident" id="3008636">SOCK_DGRAM</span>&nbsp;<span class="op" id="3008647">&amp;&amp;</span>&nbsp;<span class="ident" id="3008650">fd</span><span class="op" id="3008652">.</span><span class="ident" id="3008653">sotype</span>&nbsp;<span class="op" id="3008660">!=</span>&nbsp;<span class="ident" id="3008663">syscall</span><span class="op" id="3008670">.</span><span class="ident" id="3008671">SOCK_RAW</span>&nbsp;<span class="op" id="3008680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008684">return</span>&nbsp;<span class="ident" id="3008691">io</span><span class="op" id="3008693">.</span><span class="ident" id="3008694">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3008699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008702">return</span>&nbsp;<span class="ident" id="3008709">err</span><br>
<span class="lineno">315</span><span class="op" id="3008713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3008716">func</span>&nbsp;<span class="op" id="3008721">(</span><span class="ident" id="3008722">fd</span>&nbsp;<span class="op" id="3008725">*</span><span class="ident" id="3008726">netFD</span><span class="op" id="3008731">)</span>&nbsp;<span class="ident" id="3008733">Write</span><span class="op" id="3008738">(</span><span class="ident" id="3008739">p</span>&nbsp;<span class="op" id="3008741">[</span><span class="op" id="3008742">]</span><span class="builtintype" id="3008743">byte</span><span class="op" id="3008747">)</span>&nbsp;<span class="op" id="3008749">(</span><span class="ident" id="3008750">nn</span>&nbsp;<span class="builtintype" id="3008753">int</span><span class="op" id="3008756">,</span>&nbsp;<span class="ident" id="3008758">err</span>&nbsp;<span class="builtintype" id="3008762">error</span><span class="op" id="3008767">)</span>&nbsp;<span class="op" id="3008769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008772">if</span>&nbsp;<span class="ident" id="3008775">err</span>&nbsp;<span class="op" id="3008779">:=</span>&nbsp;<span class="ident" id="3008782">fd</span><span class="op" id="3008784">.</span><span class="ident" id="3008785">writeLock</span><span class="op" id="3008794">(</span><span class="op" id="3008795">)</span><span class="op" id="3008796">;</span>&nbsp;<span class="ident" id="3008798">err</span>&nbsp;<span class="op" id="3008802">!=</span>&nbsp;<span class="ident" id="3008805">nil</span>&nbsp;<span class="op" id="3008809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008813">return</span>&nbsp;<span class="num" id="3008820">0</span><span class="op" id="3008821">,</span>&nbsp;<span class="ident" id="3008823">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3008828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008831">defer</span>&nbsp;<span class="ident" id="3008837">fd</span><span class="op" id="3008839">.</span><span class="ident" id="3008840">writeUnlock</span><span class="op" id="3008851">(</span><span class="op" id="3008852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008855">if</span>&nbsp;<span class="ident" id="3008858">err</span>&nbsp;<span class="op" id="3008862">:=</span>&nbsp;<span class="ident" id="3008865">fd</span><span class="op" id="3008867">.</span><span class="ident" id="3008868">pd</span><span class="op" id="3008870">.</span><span class="ident" id="3008871">PrepareWrite</span><span class="op" id="3008883">(</span><span class="op" id="3008884">)</span><span class="op" id="3008885">;</span>&nbsp;<span class="ident" id="3008887">err</span>&nbsp;<span class="op" id="3008891">!=</span>&nbsp;<span class="ident" id="3008894">nil</span>&nbsp;<span class="op" id="3008898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008902">return</span>&nbsp;<span class="num" id="3008909">0</span><span class="op" id="3008910">,</span>&nbsp;<span class="op" id="3008912">&amp;</span><span class="ident" id="3008913">OpError</span><span class="op" id="3008920">{</span><span class="string" id="3008921">&#34;write&#34;</span><span class="op" id="3008928">,</span>&nbsp;<span class="ident" id="3008930">fd</span><span class="op" id="3008932">.</span><span class="ident" id="3008933">net</span><span class="op" id="3008936">,</span>&nbsp;<span class="ident" id="3008938">fd</span><span class="op" id="3008940">.</span><span class="ident" id="3008941">raddr</span><span class="op" id="3008946">,</span>&nbsp;<span class="ident" id="3008948">err</span><span class="op" id="3008951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3008954">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008957">for</span>&nbsp;<span class="op" id="3008961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3008965">var</span>&nbsp;<span class="ident" id="3008969">n</span>&nbsp;<span class="builtintype" id="3008971">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3008977">n</span><span class="op" id="3008978">,</span>&nbsp;<span class="ident" id="3008980">err</span>&nbsp;<span class="op" id="3008984">=</span>&nbsp;<span class="ident" id="3008986">syscall</span><span class="op" id="3008993">.</span><span class="ident" id="3008994">Write</span><span class="op" id="3008999">(</span><span class="builtintype" id="3009000">int</span><span class="op" id="3009003">(</span><span class="ident" id="3009004">fd</span><span class="op" id="3009006">.</span><span class="ident" id="3009007">sysfd</span><span class="op" id="3009012">)</span><span class="op" id="3009013">,</span>&nbsp;<span class="ident" id="3009015">p</span><span class="op" id="3009016">[</span><span class="ident" id="3009017">nn</span><span class="op" id="3009019">:</span><span class="op" id="3009020">]</span><span class="op" id="3009021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009025">if</span>&nbsp;<span class="ident" id="3009028">n</span>&nbsp;<span class="op" id="3009030">&gt;</span>&nbsp;<span class="num" id="3009032">0</span>&nbsp;<span class="op" id="3009034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3009039">nn</span>&nbsp;<span class="op" id="3009042">+=</span>&nbsp;<span class="ident" id="3009045">n</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009053">if</span>&nbsp;<span class="ident" id="3009056">nn</span>&nbsp;<span class="op" id="3009059">==</span>&nbsp;<span class="builtinfunc" id="3009062">len</span><span class="op" id="3009065">(</span><span class="ident" id="3009066">p</span><span class="op" id="3009067">)</span>&nbsp;<span class="op" id="3009069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009074">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009086">if</span>&nbsp;<span class="ident" id="3009089">err</span>&nbsp;<span class="op" id="3009093">==</span>&nbsp;<span class="ident" id="3009096">syscall</span><span class="op" id="3009103">.</span><span class="ident" id="3009104">EAGAIN</span>&nbsp;<span class="op" id="3009111">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009116">if</span>&nbsp;<span class="ident" id="3009119">err</span>&nbsp;<span class="op" id="3009123">=</span>&nbsp;<span class="ident" id="3009125">fd</span><span class="op" id="3009127">.</span><span class="ident" id="3009128">pd</span><span class="op" id="3009130">.</span><span class="ident" id="3009131">WaitWrite</span><span class="op" id="3009140">(</span><span class="op" id="3009141">)</span><span class="op" id="3009142">;</span>&nbsp;<span class="ident" id="3009144">err</span>&nbsp;<span class="op" id="3009148">==</span>&nbsp;<span class="ident" id="3009151">nil</span>&nbsp;<span class="op" id="3009155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009161">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009181">if</span>&nbsp;<span class="ident" id="3009184">err</span>&nbsp;<span class="op" id="3009188">!=</span>&nbsp;<span class="ident" id="3009191">nil</span>&nbsp;<span class="op" id="3009195">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3009200">n</span>&nbsp;<span class="op" id="3009202">=</span>&nbsp;<span class="num" id="3009204">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009209">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009221">if</span>&nbsp;<span class="ident" id="3009224">n</span>&nbsp;<span class="op" id="3009226">==</span>&nbsp;<span class="num" id="3009229">0</span>&nbsp;<span class="op" id="3009231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3009236">err</span>&nbsp;<span class="op" id="3009240">=</span>&nbsp;<span class="ident" id="3009242">io</span><span class="op" id="3009244">.</span><span class="ident" id="3009245">ErrUnexpectedEOF</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009265">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009279">if</span>&nbsp;<span class="ident" id="3009282">err</span>&nbsp;<span class="op" id="3009286">!=</span>&nbsp;<span class="ident" id="3009289">nil</span>&nbsp;<span class="op" id="3009293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3009297">err</span>&nbsp;<span class="op" id="3009301">=</span>&nbsp;<span class="op" id="3009303">&amp;</span><span class="ident" id="3009304">OpError</span><span class="op" id="3009311">{</span><span class="string" id="3009312">&#34;write&#34;</span><span class="op" id="3009319">,</span>&nbsp;<span class="ident" id="3009321">fd</span><span class="op" id="3009323">.</span><span class="ident" id="3009324">net</span><span class="op" id="3009327">,</span>&nbsp;<span class="ident" id="3009329">fd</span><span class="op" id="3009331">.</span><span class="ident" id="3009332">raddr</span><span class="op" id="3009337">,</span>&nbsp;<span class="ident" id="3009339">err</span><span class="op" id="3009342">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009348">return</span>&nbsp;<span class="ident" id="3009355">nn</span><span class="op" id="3009357">,</span>&nbsp;<span class="ident" id="3009359">err</span><br>
<span class="lineno"></span><span class="op" id="3009363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3009366">func</span>&nbsp;<span class="op" id="3009371">(</span><span class="ident" id="3009372">fd</span>&nbsp;<span class="op" id="3009375">*</span><span class="ident" id="3009376">netFD</span><span class="op" id="3009381">)</span>&nbsp;<span class="ident" id="3009383">writeTo</span><span class="op" id="3009390">(</span><span class="ident" id="3009391">p</span>&nbsp;<span class="op" id="3009393">[</span><span class="op" id="3009394">]</span><span class="builtintype" id="3009395">byte</span><span class="op" id="3009399">,</span>&nbsp;<span class="ident" id="3009401">sa</span>&nbsp;<span class="ident" id="3009404">syscall</span><span class="op" id="3009411">.</span><span class="ident" id="3009412">Sockaddr</span><span class="op" id="3009420">)</span>&nbsp;<span class="op" id="3009422">(</span><span class="ident" id="3009423">n</span>&nbsp;<span class="builtintype" id="3009425">int</span><span class="op" id="3009428">,</span>&nbsp;<span class="ident" id="3009430">err</span>&nbsp;<span class="builtintype" id="3009434">error</span><span class="op" id="3009439">)</span>&nbsp;<span class="op" id="3009441">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009444">if</span>&nbsp;<span class="ident" id="3009447">err</span>&nbsp;<span class="op" id="3009451">:=</span>&nbsp;<span class="ident" id="3009454">fd</span><span class="op" id="3009456">.</span><span class="ident" id="3009457">writeLock</span><span class="op" id="3009466">(</span><span class="op" id="3009467">)</span><span class="op" id="3009468">;</span>&nbsp;<span class="ident" id="3009470">err</span>&nbsp;<span class="op" id="3009474">!=</span>&nbsp;<span class="ident" id="3009477">nil</span>&nbsp;<span class="op" id="3009481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009485">return</span>&nbsp;<span class="num" id="3009492">0</span><span class="op" id="3009493">,</span>&nbsp;<span class="ident" id="3009495">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009503">defer</span>&nbsp;<span class="ident" id="3009509">fd</span><span class="op" id="3009511">.</span><span class="ident" id="3009512">writeUnlock</span><span class="op" id="3009523">(</span><span class="op" id="3009524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009527">if</span>&nbsp;<span class="ident" id="3009530">err</span>&nbsp;<span class="op" id="3009534">:=</span>&nbsp;<span class="ident" id="3009537">fd</span><span class="op" id="3009539">.</span><span class="ident" id="3009540">pd</span><span class="op" id="3009542">.</span><span class="ident" id="3009543">PrepareWrite</span><span class="op" id="3009555">(</span><span class="op" id="3009556">)</span><span class="op" id="3009557">;</span>&nbsp;<span class="ident" id="3009559">err</span>&nbsp;<span class="op" id="3009563">!=</span>&nbsp;<span class="ident" id="3009566">nil</span>&nbsp;<span class="op" id="3009570">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009574">return</span>&nbsp;<span class="num" id="3009581">0</span><span class="op" id="3009582">,</span>&nbsp;<span class="op" id="3009584">&amp;</span><span class="ident" id="3009585">OpError</span><span class="op" id="3009592">{</span><span class="string" id="3009593">&#34;write&#34;</span><span class="op" id="3009600">,</span>&nbsp;<span class="ident" id="3009602">fd</span><span class="op" id="3009604">.</span><span class="ident" id="3009605">net</span><span class="op" id="3009608">,</span>&nbsp;<span class="ident" id="3009610">fd</span><span class="op" id="3009612">.</span><span class="ident" id="3009613">raddr</span><span class="op" id="3009618">,</span>&nbsp;<span class="ident" id="3009620">err</span><span class="op" id="3009623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009629">for</span>&nbsp;<span class="op" id="3009633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3009637">err</span>&nbsp;<span class="op" id="3009641">=</span>&nbsp;<span class="ident" id="3009643">syscall</span><span class="op" id="3009650">.</span><span class="ident" id="3009651">Sendto</span><span class="op" id="3009657">(</span><span class="ident" id="3009658">fd</span><span class="op" id="3009660">.</span><span class="ident" id="3009661">sysfd</span><span class="op" id="3009666">,</span>&nbsp;<span class="ident" id="3009668">p</span><span class="op" id="3009669">,</span>&nbsp;<span class="num" id="3009671">0</span><span class="op" id="3009672">,</span>&nbsp;<span class="ident" id="3009674">sa</span><span class="op" id="3009676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009680">if</span>&nbsp;<span class="ident" id="3009683">err</span>&nbsp;<span class="op" id="3009687">==</span>&nbsp;<span class="ident" id="3009690">syscall</span><span class="op" id="3009697">.</span><span class="ident" id="3009698">EAGAIN</span>&nbsp;<span class="op" id="3009705">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009710">if</span>&nbsp;<span class="ident" id="3009713">err</span>&nbsp;<span class="op" id="3009717">=</span>&nbsp;<span class="ident" id="3009719">fd</span><span class="op" id="3009721">.</span><span class="ident" id="3009722">pd</span><span class="op" id="3009724">.</span><span class="ident" id="3009725">WaitWrite</span><span class="op" id="3009734">(</span><span class="op" id="3009735">)</span><span class="op" id="3009736">;</span>&nbsp;<span class="ident" id="3009738">err</span>&nbsp;<span class="op" id="3009742">==</span>&nbsp;<span class="ident" id="3009745">nil</span>&nbsp;<span class="op" id="3009749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009755">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009775">break</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009785">if</span>&nbsp;<span class="ident" id="3009788">err</span>&nbsp;<span class="op" id="3009792">==</span>&nbsp;<span class="ident" id="3009795">nil</span>&nbsp;<span class="op" id="3009799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3009803">n</span>&nbsp;<span class="op" id="3009805">=</span>&nbsp;<span class="builtinfunc" id="3009807">len</span><span class="op" id="3009810">(</span><span class="ident" id="3009811">p</span><span class="op" id="3009812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009815">}</span>&nbsp;<span class="keyword" id="3009817">else</span>&nbsp;<span class="op" id="3009822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3009826">err</span>&nbsp;<span class="op" id="3009830">=</span>&nbsp;<span class="op" id="3009832">&amp;</span><span class="ident" id="3009833">OpError</span><span class="op" id="3009840">{</span><span class="string" id="3009841">&#34;write&#34;</span><span class="op" id="3009848">,</span>&nbsp;<span class="ident" id="3009850">fd</span><span class="op" id="3009852">.</span><span class="ident" id="3009853">net</span><span class="op" id="3009856">,</span>&nbsp;<span class="ident" id="3009858">fd</span><span class="op" id="3009860">.</span><span class="ident" id="3009861">raddr</span><span class="op" id="3009866">,</span>&nbsp;<span class="ident" id="3009868">err</span><span class="op" id="3009871">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3009874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009877">return</span><br>
<span class="lineno"></span><span class="op" id="3009884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3009887">func</span>&nbsp;<span class="op" id="3009892">(</span><span class="ident" id="3009893">fd</span>&nbsp;<span class="op" id="3009896">*</span><span class="ident" id="3009897">netFD</span><span class="op" id="3009902">)</span>&nbsp;<span class="ident" id="3009904">writeMsg</span><span class="op" id="3009912">(</span><span class="ident" id="3009913">p</span>&nbsp;<span class="op" id="3009915">[</span><span class="op" id="3009916">]</span><span class="builtintype" id="3009917">byte</span><span class="op" id="3009921">,</span>&nbsp;<span class="ident" id="3009923">oob</span>&nbsp;<span class="op" id="3009927">[</span><span class="op" id="3009928">]</span><span class="builtintype" id="3009929">byte</span><span class="op" id="3009933">,</span>&nbsp;<span class="ident" id="3009935">sa</span>&nbsp;<span class="ident" id="3009938">syscall</span><span class="op" id="3009945">.</span><span class="ident" id="3009946">Sockaddr</span><span class="op" id="3009954">)</span>&nbsp;<span class="op" id="3009956">(</span><span class="ident" id="3009957">n</span>&nbsp;<span class="builtintype" id="3009959">int</span><span class="op" id="3009962">,</span>&nbsp;<span class="ident" id="3009964">oobn</span>&nbsp;<span class="builtintype" id="3009969">int</span><span class="op" id="3009972">,</span>&nbsp;<span class="ident" id="3009974">err</span>&nbsp;<span class="builtintype" id="3009978">error</span><span class="op" id="3009983">)</span>&nbsp;<span class="op" id="3009985">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3009988">if</span>&nbsp;<span class="ident" id="3009991">err</span>&nbsp;<span class="op" id="3009995">:=</span>&nbsp;<span class="ident" id="3009998">fd</span><span class="op" id="3010000">.</span><span class="ident" id="3010001">writeLock</span><span class="op" id="3010010">(</span><span class="op" id="3010011">)</span><span class="op" id="3010012">;</span>&nbsp;<span class="ident" id="3010014">err</span>&nbsp;<span class="op" id="3010018">!=</span>&nbsp;<span class="ident" id="3010021">nil</span>&nbsp;<span class="op" id="3010025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010029">return</span>&nbsp;<span class="num" id="3010036">0</span><span class="op" id="3010037">,</span>&nbsp;<span class="num" id="3010039">0</span><span class="op" id="3010040">,</span>&nbsp;<span class="ident" id="3010042">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3010047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010050">defer</span>&nbsp;<span class="ident" id="3010056">fd</span><span class="op" id="3010058">.</span><span class="ident" id="3010059">writeUnlock</span><span class="op" id="3010070">(</span><span class="op" id="3010071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010074">if</span>&nbsp;<span class="ident" id="3010077">err</span>&nbsp;<span class="op" id="3010081">:=</span>&nbsp;<span class="ident" id="3010084">fd</span><span class="op" id="3010086">.</span><span class="ident" id="3010087">pd</span><span class="op" id="3010089">.</span><span class="ident" id="3010090">PrepareWrite</span><span class="op" id="3010102">(</span><span class="op" id="3010103">)</span><span class="op" id="3010104">;</span>&nbsp;<span class="ident" id="3010106">err</span>&nbsp;<span class="op" id="3010110">!=</span>&nbsp;<span class="ident" id="3010113">nil</span>&nbsp;<span class="op" id="3010117">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010121">return</span>&nbsp;<span class="num" id="3010128">0</span><span class="op" id="3010129">,</span>&nbsp;<span class="num" id="3010131">0</span><span class="op" id="3010132">,</span>&nbsp;<span class="op" id="3010134">&amp;</span><span class="ident" id="3010135">OpError</span><span class="op" id="3010142">{</span><span class="string" id="3010143">&#34;write&#34;</span><span class="op" id="3010150">,</span>&nbsp;<span class="ident" id="3010152">fd</span><span class="op" id="3010154">.</span><span class="ident" id="3010155">net</span><span class="op" id="3010158">,</span>&nbsp;<span class="ident" id="3010160">fd</span><span class="op" id="3010162">.</span><span class="ident" id="3010163">raddr</span><span class="op" id="3010168">,</span>&nbsp;<span class="ident" id="3010170">err</span><span class="op" id="3010173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3010176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010179">for</span>&nbsp;<span class="op" id="3010183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3010187">n</span><span class="op" id="3010188">,</span>&nbsp;<span class="ident" id="3010190">err</span>&nbsp;<span class="op" id="3010194">=</span>&nbsp;<span class="ident" id="3010196">syscall</span><span class="op" id="3010203">.</span><span class="ident" id="3010204">SendmsgN</span><span class="op" id="3010212">(</span><span class="ident" id="3010213">fd</span><span class="op" id="3010215">.</span><span class="ident" id="3010216">sysfd</span><span class="op" id="3010221">,</span>&nbsp;<span class="ident" id="3010223">p</span><span class="op" id="3010224">,</span>&nbsp;<span class="ident" id="3010226">oob</span><span class="op" id="3010229">,</span>&nbsp;<span class="ident" id="3010231">sa</span><span class="op" id="3010233">,</span>&nbsp;<span class="num" id="3010235">0</span><span class="op" id="3010236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010240">if</span>&nbsp;<span class="ident" id="3010243">err</span>&nbsp;<span class="op" id="3010247">==</span>&nbsp;<span class="ident" id="3010250">syscall</span><span class="op" id="3010257">.</span><span class="ident" id="3010258">EAGAIN</span>&nbsp;<span class="op" id="3010265">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010270">if</span>&nbsp;<span class="ident" id="3010273">err</span>&nbsp;<span class="op" id="3010277">=</span>&nbsp;<span class="ident" id="3010279">fd</span><span class="op" id="3010281">.</span><span class="ident" id="3010282">pd</span><span class="op" id="3010284">.</span><span class="ident" id="3010285">WaitWrite</span><span class="op" id="3010294">(</span><span class="op" id="3010295">)</span><span class="op" id="3010296">;</span>&nbsp;<span class="ident" id="3010298">err</span>&nbsp;<span class="op" id="3010302">==</span>&nbsp;<span class="ident" id="3010305">nil</span>&nbsp;<span class="op" id="3010309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010315">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3010327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3010331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010335">break</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3010342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010345">if</span>&nbsp;<span class="ident" id="3010348">err</span>&nbsp;<span class="op" id="3010352">==</span>&nbsp;<span class="ident" id="3010355">nil</span>&nbsp;<span class="op" id="3010359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3010363">oobn</span>&nbsp;<span class="op" id="3010368">=</span>&nbsp;<span class="builtinfunc" id="3010370">len</span><span class="op" id="3010373">(</span><span class="ident" id="3010374">oob</span><span class="op" id="3010377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3010380">}</span>&nbsp;<span class="keyword" id="3010382">else</span>&nbsp;<span class="op" id="3010387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3010391">err</span>&nbsp;<span class="op" id="3010395">=</span>&nbsp;<span class="op" id="3010397">&amp;</span><span class="ident" id="3010398">OpError</span><span class="op" id="3010405">{</span><span class="string" id="3010406">&#34;write&#34;</span><span class="op" id="3010413">,</span>&nbsp;<span class="ident" id="3010415">fd</span><span class="op" id="3010417">.</span><span class="ident" id="3010418">net</span><span class="op" id="3010421">,</span>&nbsp;<span class="ident" id="3010423">fd</span><span class="op" id="3010425">.</span><span class="ident" id="3010426">raddr</span><span class="op" id="3010431">,</span>&nbsp;<span class="ident" id="3010433">err</span><span class="op" id="3010436">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3010439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010442">return</span><br>
<span class="lineno"></span><span class="op" id="3010449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3010452">func</span>&nbsp;<span class="op" id="3010457">(</span><span class="ident" id="3010458">fd</span>&nbsp;<span class="op" id="3010461">*</span><span class="ident" id="3010462">netFD</span><span class="op" id="3010467">)</span>&nbsp;<span class="ident" id="3010469">accept</span><span class="op" id="3010475">(</span><span class="op" id="3010476">)</span>&nbsp;<span class="op" id="3010478">(</span><span class="ident" id="3010479">netfd</span>&nbsp;<span class="op" id="3010485">*</span><span class="ident" id="3010486">netFD</span><span class="op" id="3010491">,</span>&nbsp;<span class="ident" id="3010493">err</span>&nbsp;<span class="builtintype" id="3010497">error</span><span class="op" id="3010502">)</span>&nbsp;<span class="op" id="3010504">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010507">if</span>&nbsp;<span class="ident" id="3010510">err</span>&nbsp;<span class="op" id="3010514">:=</span>&nbsp;<span class="ident" id="3010517">fd</span><span class="op" id="3010519">.</span><span class="ident" id="3010520">readLock</span><span class="op" id="3010528">(</span><span class="op" id="3010529">)</span><span class="op" id="3010530">;</span>&nbsp;<span class="ident" id="3010532">err</span>&nbsp;<span class="op" id="3010536">!=</span>&nbsp;<span class="ident" id="3010539">nil</span>&nbsp;<span class="op" id="3010543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010547">return</span>&nbsp;<span class="ident" id="3010554">nil</span><span class="op" id="3010557">,</span>&nbsp;<span class="ident" id="3010559">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3010564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010567">defer</span>&nbsp;<span class="ident" id="3010573">fd</span><span class="op" id="3010575">.</span><span class="ident" id="3010576">readUnlock</span><span class="op" id="3010586">(</span><span class="op" id="3010587">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010591">var</span>&nbsp;<span class="ident" id="3010595">s</span>&nbsp;<span class="builtintype" id="3010597">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010602">var</span>&nbsp;<span class="ident" id="3010606">rsa</span>&nbsp;<span class="ident" id="3010610">syscall</span><span class="op" id="3010617">.</span><span class="ident" id="3010618">Sockaddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010628">if</span>&nbsp;<span class="ident" id="3010631">err</span>&nbsp;<span class="op" id="3010635">=</span>&nbsp;<span class="ident" id="3010637">fd</span><span class="op" id="3010639">.</span><span class="ident" id="3010640">pd</span><span class="op" id="3010642">.</span><span class="ident" id="3010643">PrepareRead</span><span class="op" id="3010654">(</span><span class="op" id="3010655">)</span><span class="op" id="3010656">;</span>&nbsp;<span class="ident" id="3010658">err</span>&nbsp;<span class="op" id="3010662">!=</span>&nbsp;<span class="ident" id="3010665">nil</span>&nbsp;<span class="op" id="3010669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010673">return</span>&nbsp;<span class="ident" id="3010680">nil</span><span class="op" id="3010683">,</span>&nbsp;<span class="op" id="3010685">&amp;</span><span class="ident" id="3010686">OpError</span><span class="op" id="3010693">{</span><span class="string" id="3010694">&#34;accept&#34;</span><span class="op" id="3010702">,</span>&nbsp;<span class="ident" id="3010704">fd</span><span class="op" id="3010706">.</span><span class="ident" id="3010707">net</span><span class="op" id="3010710">,</span>&nbsp;<span class="ident" id="3010712">fd</span><span class="op" id="3010714">.</span><span class="ident" id="3010715">laddr</span><span class="op" id="3010720">,</span>&nbsp;<span class="ident" id="3010722">err</span><span class="op" id="3010725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3010728">}</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010731">for</span>&nbsp;<span class="op" id="3010735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3010739">s</span><span class="op" id="3010740">,</span>&nbsp;<span class="ident" id="3010742">rsa</span><span class="op" id="3010745">,</span>&nbsp;<span class="ident" id="3010747">err</span>&nbsp;<span class="op" id="3010751">=</span>&nbsp;<span class="ident" id="3010753">accept</span><span class="op" id="3010759">(</span><span class="ident" id="3010760">fd</span><span class="op" id="3010762">.</span><span class="ident" id="3010763">sysfd</span><span class="op" id="3010768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010772">if</span>&nbsp;<span class="ident" id="3010775">err</span>&nbsp;<span class="op" id="3010779">!=</span>&nbsp;<span class="ident" id="3010782">nil</span>&nbsp;<span class="op" id="3010786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010791">if</span>&nbsp;<span class="ident" id="3010794">err</span>&nbsp;<span class="op" id="3010798">==</span>&nbsp;<span class="ident" id="3010801">syscall</span><span class="op" id="3010808">.</span><span class="ident" id="3010809">EAGAIN</span>&nbsp;<span class="op" id="3010816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010822">if</span>&nbsp;<span class="ident" id="3010825">err</span>&nbsp;<span class="op" id="3010829">=</span>&nbsp;<span class="ident" id="3010831">fd</span><span class="op" id="3010833">.</span><span class="ident" id="3010834">pd</span><span class="op" id="3010836">.</span><span class="ident" id="3010837">WaitRead</span><span class="op" id="3010845">(</span><span class="op" id="3010846">)</span><span class="op" id="3010847">;</span>&nbsp;<span class="ident" id="3010849">err</span>&nbsp;<span class="op" id="3010853">==</span>&nbsp;<span class="ident" id="3010856">nil</span>&nbsp;<span class="op" id="3010860">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3010867">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3010880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3010885">}</span>&nbsp;<span class="keyword" id="3010887">else</span>&nbsp;<span class="keyword" id="3010892">if</span>&nbsp;<span class="ident" id="3010895">err</span>&nbsp;<span class="op" id="3010899">==</span>&nbsp;<span class="ident" id="3010902">syscall</span><span class="op" id="3010909">.</span><span class="ident" id="3010910">ECONNABORTED</span>&nbsp;<span class="op" id="3010923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3010929">//&nbsp;This&nbsp;means&nbsp;that&nbsp;a&nbsp;socket&nbsp;on&nbsp;the&nbsp;listen&nbsp;queue&nbsp;was&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3010992">//&nbsp;before&nbsp;we&nbsp;Accept()ed&nbsp;it;&nbsp;it&#39;s&nbsp;a&nbsp;silly&nbsp;error,&nbsp;so&nbsp;try&nbsp;again.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3011058">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3011070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3011075">return</span>&nbsp;<span class="ident" id="3011082">nil</span><span class="op" id="3011085">,</span>&nbsp;<span class="op" id="3011087">&amp;</span><span class="ident" id="3011088">OpError</span><span class="op" id="3011095">{</span><span class="string" id="3011096">&#34;accept&#34;</span><span class="op" id="3011104">,</span>&nbsp;<span class="ident" id="3011106">fd</span><span class="op" id="3011108">.</span><span class="ident" id="3011109">net</span><span class="op" id="3011112">,</span>&nbsp;<span class="ident" id="3011114">fd</span><span class="op" id="3011116">.</span><span class="ident" id="3011117">laddr</span><span class="op" id="3011122">,</span>&nbsp;<span class="ident" id="3011124">err</span><span class="op" id="3011127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3011131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3011135">break</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3011142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3011146">if</span>&nbsp;<span class="ident" id="3011149">netfd</span><span class="op" id="3011154">,</span>&nbsp;<span class="ident" id="3011156">err</span>&nbsp;<span class="op" id="3011160">=</span>&nbsp;<span class="ident" id="3011162">newFD</span><span class="op" id="3011167">(</span><span class="ident" id="3011168">s</span><span class="op" id="3011169">,</span>&nbsp;<span class="ident" id="3011171">fd</span><span class="op" id="3011173">.</span><span class="ident" id="3011174">family</span><span class="op" id="3011180">,</span>&nbsp;<span class="ident" id="3011182">fd</span><span class="op" id="3011184">.</span><span class="ident" id="3011185">sotype</span><span class="op" id="3011191">,</span>&nbsp;<span class="ident" id="3011193">fd</span><span class="op" id="3011195">.</span><span class="ident" id="3011196">net</span><span class="op" id="3011199">)</span><span class="op" id="3011200">;</span>&nbsp;<span class="ident" id="3011202">err</span>&nbsp;<span class="op" id="3011206">!=</span>&nbsp;<span class="ident" id="3011209">nil</span>&nbsp;<span class="op" id="3011213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3011217">closesocket</span><span class="op" id="3011228">(</span><span class="ident" id="3011229">s</span><span class="op" id="3011230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3011234">return</span>&nbsp;<span class="ident" id="3011241">nil</span><span class="op" id="3011244">,</span>&nbsp;<span class="ident" id="3011246">err</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3011251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3011254">if</span>&nbsp;<span class="ident" id="3011257">err</span>&nbsp;<span class="op" id="3011261">=</span>&nbsp;<span class="ident" id="3011263">netfd</span><span class="op" id="3011268">.</span><span class="ident" id="3011269">init</span><span class="op" id="3011273">(</span><span class="op" id="3011274">)</span><span class="op" id="3011275">;</span>&nbsp;<span class="ident" id="3011277">err</span>&nbsp;<span class="op" id="3011281">!=</span>&nbsp;<span class="ident" id="3011284">nil</span>&nbsp;<span class="op" id="3011288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3011292">fd</span><span class="op" id="3011294">.</span><span class="ident" id="3011295">Close</span><span class="op" id="3011300">(</span><span class="op" id="3011301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3011305">return</span>&nbsp;<span class="ident" id="3011312">nil</span><span class="op" id="3011315">,</span>&nbsp;<span class="ident" id="3011317">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3011322">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3011325">lsa</span><span class="op" id="3011328">,</span>&nbsp;<span class="ident" id="3011330">_</span>&nbsp;<span class="op" id="3011332">:=</span>&nbsp;<span class="ident" id="3011335">syscall</span><span class="op" id="3011342">.</span><span class="ident" id="3011343">Getsockname</span><span class="op" id="3011354">(</span><span class="ident" id="3011355">netfd</span><span class="op" id="3011360">.</span><span class="ident" id="3011361">sysfd</span><span class="op" id="3011366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3011369">netfd</span><span class="op" id="3011374">.</span><span class="ident" id="3011375">setAddr</span><span class="op" id="3011382">(</span><span class="ident" id="3011383">netfd</span><span class="op" id="3011388">.</span><span class="ident" id="3011389">addrFunc</span><span class="op" id="3011397">(</span><span class="op" id="3011398">)</span><span class="op" id="3011399">(</span><span class="ident" id="3011400">lsa</span><span class="op" id="3011403">)</span><span class="op" id="3011404">,</span>&nbsp;<span class="ident" id="3011406">netfd</span><span class="op" id="3011411">.</span><span class="ident" id="3011412">addrFunc</span><span class="op" id="3011420">(</span><span class="op" id="3011421">)</span><span class="op" id="3011422">(</span><span class="ident" id="3011423">rsa</span><span class="op" id="3011426">)</span><span class="op" id="3011427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3011430">return</span>&nbsp;<span class="ident" id="3011437">netfd</span><span class="op" id="3011442">,</span>&nbsp;<span class="ident" id="3011444">nil</span><br>
<span class="lineno"></span><span class="op" id="3011448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="3011451">//&nbsp;tryDupCloexec&nbsp;indicates&nbsp;whether&nbsp;F_DUPFD_CLOEXEC&nbsp;should&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="3011518">//&nbsp;If&nbsp;the&nbsp;kernel&nbsp;doesn&#39;t&nbsp;support&nbsp;it,&nbsp;this&nbsp;is&nbsp;set&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3011573">var</span>&nbsp;<span class="ident" id="3011577">tryDupCloexec</span>&nbsp;<span class="op" id="3011591">=</span>&nbsp;<span class="builtintype" id="3011593">int32</span><span class="op" id="3011598">(</span><span class="num" id="3011599">1</span><span class="op" id="3011600">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3011603">func</span>&nbsp;<span class="ident" id="3011608">dupCloseOnExec</span><span class="op" id="3011622">(</span><span class="ident" id="3011623">fd</span>&nbsp;<span class="builtintype" id="3011626">int</span><span class="op" id="3011629">)</span>&nbsp;<span class="op" id="3011631">(</span><span class="ident" id="3011632">newfd</span>&nbsp;<span class="builtintype" id="3011638">int</span><span class="op" id="3011641">,</span>&nbsp;<span class="ident" id="3011643">err</span>&nbsp;<span class="builtintype" id="3011647">error</span><span class="op" id="3011652">)</span>&nbsp;<span class="op" id="3011654">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3011657">if</span>&nbsp;<span class="ident" id="3011660">atomic</span><span class="op" id="3011666">.</span><span class="ident" id="3011667">LoadInt32</span><span class="op" id="3011676">(</span><span class="op" id="3011677">&amp;</span><span class="ident" id="3011678">tryDupCloexec</span><span class="op" id="3011691">)</span>&nbsp;<span class="op" id="3011693">==</span>&nbsp;<span class="num" id="3011696">1</span>&nbsp;<span class="op" id="3011698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3011702">r0</span><span class="op" id="3011704">,</span>&nbsp;<span class="ident" id="3011706">_</span><span class="op" id="3011707">,</span>&nbsp;<span class="ident" id="3011709">e1</span>&nbsp;<span class="op" id="3011712">:=</span>&nbsp;<span class="ident" id="3011715">syscall</span><span class="op" id="3011722">.</span><span class="ident" id="3011723">Syscall</span><span class="op" id="3011730">(</span><span class="ident" id="3011731">syscall</span><span class="op" id="3011738">.</span><span class="ident" id="3011739">SYS_FCNTL</span><span class="op" id="3011748">,</span>&nbsp;<span class="builtintype" id="3011750">uintptr</span><span class="op" id="3011757">(</span><span class="ident" id="3011758">fd</span><span class="op" id="3011760">)</span><span class="op" id="3011761">,</span>&nbsp;<span class="ident" id="3011763">syscall</span><span class="op" id="3011770">.</span><span class="ident" id="3011771">F_DUPFD_CLOEXEC</span><span class="op" id="3011786">,</span>&nbsp;<span class="num" id="3011788">0</span><span class="op" id="3011789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3011793">if</span>&nbsp;<span class="ident" id="3011796">runtime</span><span class="op" id="3011803">.</span><span class="ident" id="3011804">GOOS</span>&nbsp;<span class="op" id="3011809">==</span>&nbsp;<span class="string" id="3011812">&#34;darwin&#34;</span>&nbsp;<span class="op" id="3011821">&amp;&amp;</span>&nbsp;<span class="ident" id="3011824">e1</span>&nbsp;<span class="op" id="3011827">==</span>&nbsp;<span class="ident" id="3011830">syscall</span><span class="op" id="3011837">.</span><span class="ident" id="3011838">EBADF</span>&nbsp;<span class="op" id="3011844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3011849">//&nbsp;On&nbsp;OS&nbsp;X&nbsp;10.6&nbsp;and&nbsp;below&nbsp;(but&nbsp;we&nbsp;only&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3011899">//&nbsp;&gt;=&nbsp;10.6),&nbsp;F_DUPFD_CLOEXEC&nbsp;is&nbsp;unsupported</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3011946">//&nbsp;and&nbsp;fcntl&nbsp;there&nbsp;falls&nbsp;back&nbsp;(undocumented)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3011994">//&nbsp;to&nbsp;doing&nbsp;an&nbsp;ioctl&nbsp;instead,&nbsp;returning&nbsp;EBADF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3012043">//&nbsp;in&nbsp;this&nbsp;case&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3012087">//&nbsp;expected&nbsp;device&nbsp;fd&nbsp;type.&nbsp;&nbsp;Treat&nbsp;it&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3012131">//&nbsp;EINVAL&nbsp;instead,&nbsp;so&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3012176">//&nbsp;normal&nbsp;dup&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3012199">//&nbsp;TODO:&nbsp;only&nbsp;do&nbsp;this&nbsp;on&nbsp;10.6&nbsp;if&nbsp;we&nbsp;can&nbsp;detect&nbsp;10.6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3012254">//&nbsp;cheaply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3012269">e1</span>&nbsp;<span class="op" id="3012272">=</span>&nbsp;<span class="ident" id="3012274">syscall</span><span class="op" id="3012281">.</span><span class="ident" id="3012282">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3012291">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3012295">switch</span>&nbsp;<span class="ident" id="3012302">e1</span>&nbsp;<span class="op" id="3012305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3012309">case</span>&nbsp;<span class="num" id="3012314">0</span><span class="op" id="3012315">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3012320">return</span>&nbsp;<span class="builtintype" id="3012327">int</span><span class="op" id="3012330">(</span><span class="ident" id="3012331">r0</span><span class="op" id="3012333">)</span><span class="op" id="3012334">,</span>&nbsp;<span class="ident" id="3012336">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3012342">case</span>&nbsp;<span class="ident" id="3012347">syscall</span><span class="op" id="3012354">.</span><span class="ident" id="3012355">EINVAL</span><span class="op" id="3012361">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3012366">//&nbsp;Old&nbsp;kernel.&nbsp;Fall&nbsp;back&nbsp;to&nbsp;the&nbsp;portable&nbsp;way</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3012414">//&nbsp;from&nbsp;now&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3012433">atomic</span><span class="op" id="3012439">.</span><span class="ident" id="3012440">StoreInt32</span><span class="op" id="3012450">(</span><span class="op" id="3012451">&amp;</span><span class="ident" id="3012452">tryDupCloexec</span><span class="op" id="3012465">,</span>&nbsp;<span class="num" id="3012467">0</span><span class="op" id="3012468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3012472">default</span><span class="op" id="3012479">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3012484">return</span>&nbsp;<span class="op" id="3012491">-</span><span class="num" id="3012492">1</span><span class="op" id="3012493">,</span>&nbsp;<span class="ident" id="3012495">e1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3012500">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3012503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3012506">return</span>&nbsp;<span class="ident" id="3012513">dupCloseOnExecOld</span><span class="op" id="3012530">(</span><span class="ident" id="3012531">fd</span><span class="op" id="3012533">)</span><br>
<span class="lineno"></span><span class="op" id="3012535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3012538">//&nbsp;dupCloseOnExecUnixOld&nbsp;is&nbsp;the&nbsp;traditional&nbsp;way&nbsp;to&nbsp;dup&nbsp;an&nbsp;fd&nbsp;and</span><br>
<span class="lineno">480</span><span class="comment" id="3012603">//&nbsp;set&nbsp;its&nbsp;O_CLOEXEC&nbsp;bit,&nbsp;using&nbsp;two&nbsp;system&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="3012653">func</span>&nbsp;<span class="ident" id="3012658">dupCloseOnExecOld</span><span class="op" id="3012675">(</span><span class="ident" id="3012676">fd</span>&nbsp;<span class="builtintype" id="3012679">int</span><span class="op" id="3012682">)</span>&nbsp;<span class="op" id="3012684">(</span><span class="ident" id="3012685">newfd</span>&nbsp;<span class="builtintype" id="3012691">int</span><span class="op" id="3012694">,</span>&nbsp;<span class="ident" id="3012696">err</span>&nbsp;<span class="builtintype" id="3012700">error</span><span class="op" id="3012705">)</span>&nbsp;<span class="op" id="3012707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3012710">syscall</span><span class="op" id="3012717">.</span><span class="ident" id="3012718">ForkLock</span><span class="op" id="3012726">.</span><span class="ident" id="3012727">RLock</span><span class="op" id="3012732">(</span><span class="op" id="3012733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3012736">defer</span>&nbsp;<span class="ident" id="3012742">syscall</span><span class="op" id="3012749">.</span><span class="ident" id="3012750">ForkLock</span><span class="op" id="3012758">.</span><span class="ident" id="3012759">RUnlock</span><span class="op" id="3012766">(</span><span class="op" id="3012767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3012770">newfd</span><span class="op" id="3012775">,</span>&nbsp;<span class="ident" id="3012777">err</span>&nbsp;<span class="op" id="3012781">=</span>&nbsp;<span class="ident" id="3012783">syscall</span><span class="op" id="3012790">.</span><span class="ident" id="3012791">Dup</span><span class="op" id="3012794">(</span><span class="ident" id="3012795">fd</span><span class="op" id="3012797">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3012800">if</span>&nbsp;<span class="ident" id="3012803">err</span>&nbsp;<span class="op" id="3012807">!=</span>&nbsp;<span class="ident" id="3012810">nil</span>&nbsp;<span class="op" id="3012814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3012818">return</span>&nbsp;<span class="op" id="3012825">-</span><span class="num" id="3012826">1</span><span class="op" id="3012827">,</span>&nbsp;<span class="ident" id="3012829">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3012834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3012837">syscall</span><span class="op" id="3012844">.</span><span class="ident" id="3012845">CloseOnExec</span><span class="op" id="3012856">(</span><span class="ident" id="3012857">newfd</span><span class="op" id="3012862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3012865">return</span><br>
<span class="lineno">490</span><span class="op" id="3012872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3012875">func</span>&nbsp;<span class="op" id="3012880">(</span><span class="ident" id="3012881">fd</span>&nbsp;<span class="op" id="3012884">*</span><span class="ident" id="3012885">netFD</span><span class="op" id="3012890">)</span>&nbsp;<span class="ident" id="3012892">dup</span><span class="op" id="3012895">(</span><span class="op" id="3012896">)</span>&nbsp;<span class="op" id="3012898">(</span><span class="ident" id="3012899">f</span>&nbsp;<span class="op" id="3012901">*</span><span class="ident" id="3012902">os</span><span class="op" id="3012904">.</span><span class="ident" id="3012905">File</span><span class="op" id="3012909">,</span>&nbsp;<span class="ident" id="3012911">err</span>&nbsp;<span class="builtintype" id="3012915">error</span><span class="op" id="3012920">)</span>&nbsp;<span class="op" id="3012922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3012925">ns</span><span class="op" id="3012927">,</span>&nbsp;<span class="ident" id="3012929">err</span>&nbsp;<span class="op" id="3012933">:=</span>&nbsp;<span class="ident" id="3012936">dupCloseOnExec</span><span class="op" id="3012950">(</span><span class="ident" id="3012951">fd</span><span class="op" id="3012953">.</span><span class="ident" id="3012954">sysfd</span><span class="op" id="3012959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3012962">if</span>&nbsp;<span class="ident" id="3012965">err</span>&nbsp;<span class="op" id="3012969">!=</span>&nbsp;<span class="ident" id="3012972">nil</span>&nbsp;<span class="op" id="3012976">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3012980">return</span>&nbsp;<span class="ident" id="3012987">nil</span><span class="op" id="3012990">,</span>&nbsp;<span class="op" id="3012992">&amp;</span><span class="ident" id="3012993">OpError</span><span class="op" id="3013000">{</span><span class="string" id="3013001">&#34;dup&#34;</span><span class="op" id="3013006">,</span>&nbsp;<span class="ident" id="3013008">fd</span><span class="op" id="3013010">.</span><span class="ident" id="3013011">net</span><span class="op" id="3013014">,</span>&nbsp;<span class="ident" id="3013016">fd</span><span class="op" id="3013018">.</span><span class="ident" id="3013019">laddr</span><span class="op" id="3013024">,</span>&nbsp;<span class="ident" id="3013026">err</span><span class="op" id="3013029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3013032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3013036">//&nbsp;We&nbsp;want&nbsp;blocking&nbsp;mode&nbsp;for&nbsp;the&nbsp;new&nbsp;fd,&nbsp;hence&nbsp;the&nbsp;double&nbsp;negative.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3013105">//&nbsp;This&nbsp;also&nbsp;puts&nbsp;the&nbsp;old&nbsp;fd&nbsp;into&nbsp;blocking&nbsp;mode,&nbsp;meaning&nbsp;that</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3013168">//&nbsp;I/O&nbsp;will&nbsp;block&nbsp;the&nbsp;thread&nbsp;instead&nbsp;of&nbsp;letting&nbsp;us&nbsp;use&nbsp;the&nbsp;epoll&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3013242">//&nbsp;Everything&nbsp;will&nbsp;still&nbsp;work,&nbsp;just&nbsp;with&nbsp;more&nbsp;threads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3013298">if</span>&nbsp;<span class="ident" id="3013301">err</span>&nbsp;<span class="op" id="3013305">=</span>&nbsp;<span class="ident" id="3013307">syscall</span><span class="op" id="3013314">.</span><span class="ident" id="3013315">SetNonblock</span><span class="op" id="3013326">(</span><span class="ident" id="3013327">ns</span><span class="op" id="3013329">,</span>&nbsp;<span class="builtintype" id="3013331">false</span><span class="op" id="3013336">)</span><span class="op" id="3013337">;</span>&nbsp;<span class="ident" id="3013339">err</span>&nbsp;<span class="op" id="3013343">!=</span>&nbsp;<span class="ident" id="3013346">nil</span>&nbsp;<span class="op" id="3013350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3013354">return</span>&nbsp;<span class="ident" id="3013361">nil</span><span class="op" id="3013364">,</span>&nbsp;<span class="op" id="3013366">&amp;</span><span class="ident" id="3013367">OpError</span><span class="op" id="3013374">{</span><span class="string" id="3013375">&#34;setnonblock&#34;</span><span class="op" id="3013388">,</span>&nbsp;<span class="ident" id="3013390">fd</span><span class="op" id="3013392">.</span><span class="ident" id="3013393">net</span><span class="op" id="3013396">,</span>&nbsp;<span class="ident" id="3013398">fd</span><span class="op" id="3013400">.</span><span class="ident" id="3013401">laddr</span><span class="op" id="3013406">,</span>&nbsp;<span class="ident" id="3013408">err</span><span class="op" id="3013411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3013414">}</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3013418">return</span>&nbsp;<span class="ident" id="3013425">os</span><span class="op" id="3013427">.</span><span class="ident" id="3013428">NewFile</span><span class="op" id="3013435">(</span><span class="builtintype" id="3013436">uintptr</span><span class="op" id="3013443">(</span><span class="ident" id="3013444">ns</span><span class="op" id="3013446">)</span><span class="op" id="3013447">,</span>&nbsp;<span class="ident" id="3013449">fd</span><span class="op" id="3013451">.</span><span class="ident" id="3013452">name</span><span class="op" id="3013456">(</span><span class="op" id="3013457">)</span><span class="op" id="3013458">)</span><span class="op" id="3013459">,</span>&nbsp;<span class="ident" id="3013461">nil</span><br>
<span class="lineno"></span><span class="op" id="3013465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3013468">func</span>&nbsp;<span class="ident" id="3013473">closesocket</span><span class="op" id="3013484">(</span><span class="ident" id="3013485">s</span>&nbsp;<span class="builtintype" id="3013487">int</span><span class="op" id="3013490">)</span>&nbsp;<span class="builtintype" id="3013492">error</span>&nbsp;<span class="op" id="3013498">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3013501">return</span>&nbsp;<span class="ident" id="3013508">syscall</span><span class="op" id="3013515">.</span><span class="ident" id="3013516">Close</span><span class="op" id="3013521">(</span><span class="ident" id="3013522">s</span><span class="op" id="3013523">)</span><br>
<span class="lineno"></span><span class="op" id="3013525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3013528">func</span>&nbsp;<span class="ident" id="3013533">skipRawSocketTests</span><span class="op" id="3013551">(</span><span class="op" id="3013552">)</span>&nbsp;<span class="op" id="3013554">(</span><span class="ident" id="3013555">skip</span>&nbsp;<span class="builtintype" id="3013560">bool</span><span class="op" id="3013564">,</span>&nbsp;<span class="ident" id="3013566">skipmsg</span>&nbsp;<span class="builtintype" id="3013574">string</span><span class="op" id="3013580">,</span>&nbsp;<span class="ident" id="3013582">err</span>&nbsp;<span class="builtintype" id="3013586">error</span><span class="op" id="3013591">)</span>&nbsp;<span class="op" id="3013593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3013596">if</span>&nbsp;<span class="ident" id="3013599">os</span><span class="op" id="3013601">.</span><span class="ident" id="3013602">Getuid</span><span class="op" id="3013608">(</span><span class="op" id="3013609">)</span>&nbsp;<span class="op" id="3013611">!=</span>&nbsp;<span class="num" id="3013614">0</span>&nbsp;<span class="op" id="3013616">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3013620">return</span>&nbsp;<span class="builtintype" id="3013627">true</span><span class="op" id="3013631">,</span>&nbsp;<span class="string" id="3013633">&#34;skipping&nbsp;test;&nbsp;must&nbsp;be&nbsp;root&#34;</span><span class="op" id="3013662">,</span>&nbsp;<span class="ident" id="3013664">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3013669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3013672">return</span>&nbsp;<span class="builtintype" id="3013679">false</span><span class="op" id="3013684">,</span>&nbsp;<span class="string" id="3013686">&#34;&#34;</span><span class="op" id="3013688">,</span>&nbsp;<span class="ident" id="3013690">nil</span><br>
<span class="lineno"></span><span class="op" id="3013694">}</span>
</div>
</body>
</html>
