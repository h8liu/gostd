<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/json</h2>
<ul>
<li><a href="/gostd/encoding/json/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/encoding/json/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/json/decode_test.go.html">decode_test.go</a></li>
<li><a href="/gostd/encoding/json/encode.go.html" class="current">encode.go</a></li>
<li><a href="/gostd/encoding/json/encode_test.go.html">encode_test.go</a></li>
<li><a href="/gostd/encoding/json/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/json/fold.go.html">fold.go</a></li>
<li><a href="/gostd/encoding/json/fold_test.go.html">fold_test.go</a></li>
<li><a href="/gostd/encoding/json/indent.go.html">indent.go</a></li>
<li><a href="/gostd/encoding/json/scanner.go.html">scanner.go</a></li>
<li><a href="/gostd/encoding/json/scanner_test.go.html">scanner_test.go</a></li>
<li><a href="/gostd/encoding/json/stream.go.html">stream.go</a></li>
<li><a href="/gostd/encoding/json/stream_test.go.html">stream_test.go</a></li>
<li><a href="/gostd/encoding/json/tagkey_test.go.html">tagkey_test.go</a></li>
<li><a href="/gostd/encoding/json/tags.go.html">tags.go</a></li>
<li><a href="/gostd/encoding/json/tags_test.go.html">tags_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3715401">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3715457">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3715511">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3715562">//&nbsp;Package&nbsp;json&nbsp;implements&nbsp;encoding&nbsp;and&nbsp;decoding&nbsp;of&nbsp;JSON&nbsp;objects&nbsp;as&nbsp;defined&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3715641">//&nbsp;RFC&nbsp;4627.&nbsp;The&nbsp;mapping&nbsp;between&nbsp;JSON&nbsp;objects&nbsp;and&nbsp;Go&nbsp;values&nbsp;is&nbsp;described</span><br>
<span class="lineno"></span><span class="comment" id="3715714">//&nbsp;in&nbsp;the&nbsp;documentation&nbsp;for&nbsp;the&nbsp;Marshal&nbsp;and&nbsp;Unmarshal&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="3715779">//</span><br>
<span class="lineno"></span><span class="comment" id="3715782">//&nbsp;See&nbsp;&#34;JSON&nbsp;and&nbsp;Go&#34;&nbsp;for&nbsp;an&nbsp;introduction&nbsp;to&nbsp;this&nbsp;package:</span><br>
<span class="lineno">10</span><span class="comment" id="3715840">//&nbsp;http://golang.org/doc/articles/json_and_go.html</span><br>
<span class="lineno"></span><span class="keyword" id="3715891">package</span>&nbsp;<span class="ident" id="3715899">json</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3715905">import</span>&nbsp;<span class="op" id="3715912">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3715915">&#34;bytes&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3715924">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3715936">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3715955">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3715963">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3715974">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3715985">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3715993">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3716004">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3716015">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3716023">&#34;unicode&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3716034">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="3716049">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3716052">//&nbsp;Marshal&nbsp;returns&nbsp;the&nbsp;JSON&nbsp;encoding&nbsp;of&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="3716095">//</span><br>
<span class="lineno">30</span><span class="comment" id="3716098">//&nbsp;Marshal&nbsp;traverses&nbsp;the&nbsp;value&nbsp;v&nbsp;recursively.</span><br>
<span class="lineno"></span><span class="comment" id="3716144">//&nbsp;If&nbsp;an&nbsp;encountered&nbsp;value&nbsp;implements&nbsp;the&nbsp;Marshaler&nbsp;interface</span><br>
<span class="lineno"></span><span class="comment" id="3716206">//&nbsp;and&nbsp;is&nbsp;not&nbsp;a&nbsp;nil&nbsp;pointer,&nbsp;Marshal&nbsp;calls&nbsp;its&nbsp;MarshalJSON&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="3716272">//&nbsp;to&nbsp;produce&nbsp;JSON.&nbsp;&nbsp;The&nbsp;nil&nbsp;pointer&nbsp;exception&nbsp;is&nbsp;not&nbsp;strictly&nbsp;necessary</span><br>
<span class="lineno"></span><span class="comment" id="3716345">//&nbsp;but&nbsp;mimics&nbsp;a&nbsp;similar,&nbsp;necessary&nbsp;exception&nbsp;in&nbsp;the&nbsp;behavior&nbsp;of</span><br>
<span class="lineno">35</span><span class="comment" id="3716409">//&nbsp;UnmarshalJSON.</span><br>
<span class="lineno"></span><span class="comment" id="3716427">//</span><br>
<span class="lineno"></span><span class="comment" id="3716430">//&nbsp;Otherwise,&nbsp;Marshal&nbsp;uses&nbsp;the&nbsp;following&nbsp;type-dependent&nbsp;default&nbsp;encodings:</span><br>
<span class="lineno"></span><span class="comment" id="3716505">//</span><br>
<span class="lineno"></span><span class="comment" id="3716508">//&nbsp;Boolean&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;booleans.</span><br>
<span class="lineno">40</span><span class="comment" id="3716551">//</span><br>
<span class="lineno"></span><span class="comment" id="3716554">//&nbsp;Floating&nbsp;point,&nbsp;integer,&nbsp;and&nbsp;Number&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;numbers.</span><br>
<span class="lineno"></span><span class="comment" id="3716624">//</span><br>
<span class="lineno"></span><span class="comment" id="3716627">//&nbsp;String&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;strings&nbsp;coerced&nbsp;to&nbsp;valid&nbsp;UTF-8,</span><br>
<span class="lineno"></span><span class="comment" id="3716691">//&nbsp;replacing&nbsp;invalid&nbsp;bytes&nbsp;with&nbsp;the&nbsp;Unicode&nbsp;replacement&nbsp;rune.</span><br>
<span class="lineno">45</span><span class="comment" id="3716753">//&nbsp;The&nbsp;angle&nbsp;brackets&nbsp;&#34;&lt;&#34;&nbsp;and&nbsp;&#34;&gt;&#34;&nbsp;are&nbsp;escaped&nbsp;to&nbsp;&#34;\u003c&#34;&nbsp;and&nbsp;&#34;\u003e&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3716824">//&nbsp;to&nbsp;keep&nbsp;some&nbsp;browsers&nbsp;from&nbsp;misinterpreting&nbsp;JSON&nbsp;output&nbsp;as&nbsp;HTML.</span><br>
<span class="lineno"></span><span class="comment" id="3716891">//&nbsp;Ampersand&nbsp;&#34;&amp;&#34;&nbsp;is&nbsp;also&nbsp;escaped&nbsp;to&nbsp;&#34;\u0026&#34;&nbsp;for&nbsp;the&nbsp;same&nbsp;reason.</span><br>
<span class="lineno"></span><span class="comment" id="3716957">//</span><br>
<span class="lineno"></span><span class="comment" id="3716960">//&nbsp;Array&nbsp;and&nbsp;slice&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;arrays,&nbsp;except&nbsp;that</span><br>
<span class="lineno">50</span><span class="comment" id="3717021">//&nbsp;[]byte&nbsp;encodes&nbsp;as&nbsp;a&nbsp;base64-encoded&nbsp;string,&nbsp;and&nbsp;a&nbsp;nil&nbsp;slice</span><br>
<span class="lineno"></span><span class="comment" id="3717083">//&nbsp;encodes&nbsp;as&nbsp;the&nbsp;null&nbsp;JSON&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="3717119">//</span><br>
<span class="lineno"></span><span class="comment" id="3717122">//&nbsp;Struct&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;objects.&nbsp;Each&nbsp;exported&nbsp;struct&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="3717190">//&nbsp;becomes&nbsp;a&nbsp;member&nbsp;of&nbsp;the&nbsp;object&nbsp;unless</span><br>
<span class="lineno">55</span><span class="comment" id="3717231">//&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;field&#39;s&nbsp;tag&nbsp;is&nbsp;&#34;-&#34;,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3717265">//&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;field&nbsp;is&nbsp;empty&nbsp;and&nbsp;its&nbsp;tag&nbsp;specifies&nbsp;the&nbsp;&#34;omitempty&#34;&nbsp;option.</span><br>
<span class="lineno"></span><span class="comment" id="3717337">//&nbsp;The&nbsp;empty&nbsp;values&nbsp;are&nbsp;false,&nbsp;0,&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="3717375">//&nbsp;nil&nbsp;pointer&nbsp;or&nbsp;interface&nbsp;value,&nbsp;and&nbsp;any&nbsp;array,&nbsp;slice,&nbsp;map,&nbsp;or&nbsp;string&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3717450">//&nbsp;length&nbsp;zero.&nbsp;The&nbsp;object&#39;s&nbsp;default&nbsp;key&nbsp;string&nbsp;is&nbsp;the&nbsp;struct&nbsp;field&nbsp;name</span><br>
<span class="lineno">60</span><span class="comment" id="3717523">//&nbsp;but&nbsp;can&nbsp;be&nbsp;specified&nbsp;in&nbsp;the&nbsp;struct&nbsp;field&#39;s&nbsp;tag&nbsp;value.&nbsp;The&nbsp;&#34;json&#34;&nbsp;key&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3717598">//&nbsp;the&nbsp;struct&nbsp;field&#39;s&nbsp;tag&nbsp;value&nbsp;is&nbsp;the&nbsp;key&nbsp;name,&nbsp;followed&nbsp;by&nbsp;an&nbsp;optional&nbsp;comma</span><br>
<span class="lineno"></span><span class="comment" id="3717677">//&nbsp;and&nbsp;options.&nbsp;Examples:</span><br>
<span class="lineno"></span><span class="comment" id="3717703">//</span><br>
<span class="lineno"></span><span class="comment" id="3717706">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;is&nbsp;ignored&nbsp;by&nbsp;this&nbsp;package.</span><br>
<span class="lineno">65</span><span class="comment" id="3717748">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;-&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="3717774">//</span><br>
<span class="lineno"></span><span class="comment" id="3717777">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;appears&nbsp;in&nbsp;JSON&nbsp;as&nbsp;key&nbsp;&#34;myName&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3717824">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;myName&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="3717855">//</span><br>
<span class="lineno">70</span><span class="comment" id="3717858">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;appears&nbsp;in&nbsp;JSON&nbsp;as&nbsp;key&nbsp;&#34;myName&#34;&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3717908">//&nbsp;&nbsp;&nbsp;//&nbsp;the&nbsp;field&nbsp;is&nbsp;omitted&nbsp;from&nbsp;the&nbsp;object&nbsp;if&nbsp;its&nbsp;value&nbsp;is&nbsp;empty,</span><br>
<span class="lineno"></span><span class="comment" id="3717976">//&nbsp;&nbsp;&nbsp;//&nbsp;as&nbsp;defined&nbsp;above.</span><br>
<span class="lineno"></span><span class="comment" id="3718002">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;myName,omitempty&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="3718043">//</span><br>
<span class="lineno">75</span><span class="comment" id="3718046">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;appears&nbsp;in&nbsp;JSON&nbsp;as&nbsp;key&nbsp;&#34;Field&#34;&nbsp;(the&nbsp;default),&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="3718110">//&nbsp;&nbsp;&nbsp;//&nbsp;the&nbsp;field&nbsp;is&nbsp;skipped&nbsp;if&nbsp;empty.</span><br>
<span class="lineno"></span><span class="comment" id="3718149">//&nbsp;&nbsp;&nbsp;//&nbsp;Note&nbsp;the&nbsp;leading&nbsp;comma.</span><br>
<span class="lineno"></span><span class="comment" id="3718181">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;,omitempty&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="3718216">//</span><br>
<span class="lineno">80</span><span class="comment" id="3718219">//&nbsp;The&nbsp;&#34;string&#34;&nbsp;option&nbsp;signals&nbsp;that&nbsp;a&nbsp;field&nbsp;is&nbsp;stored&nbsp;as&nbsp;JSON&nbsp;inside&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3718290">//&nbsp;JSON-encoded&nbsp;string.&nbsp;It&nbsp;applies&nbsp;only&nbsp;to&nbsp;fields&nbsp;of&nbsp;string,&nbsp;floating&nbsp;point,</span><br>
<span class="lineno"></span><span class="comment" id="3718367">//&nbsp;or&nbsp;integer&nbsp;types.&nbsp;This&nbsp;extra&nbsp;level&nbsp;of&nbsp;encoding&nbsp;is&nbsp;sometimes&nbsp;used&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="3718440">//&nbsp;communicating&nbsp;with&nbsp;JavaScript&nbsp;programs:</span><br>
<span class="lineno"></span><span class="comment" id="3718483">//</span><br>
<span class="lineno">85</span><span class="comment" id="3718486">//&nbsp;&nbsp;&nbsp;&nbsp;Int64String&nbsp;int64&nbsp;`json:&#34;,string&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="3718527">//</span><br>
<span class="lineno"></span><span class="comment" id="3718530">//&nbsp;The&nbsp;key&nbsp;name&nbsp;will&nbsp;be&nbsp;used&nbsp;if&nbsp;it&#39;s&nbsp;a&nbsp;non-empty&nbsp;string&nbsp;consisting&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3718600">//&nbsp;only&nbsp;Unicode&nbsp;letters,&nbsp;digits,&nbsp;dollar&nbsp;signs,&nbsp;percent&nbsp;signs,&nbsp;hyphens,</span><br>
<span class="lineno"></span><span class="comment" id="3718671">//&nbsp;underscores&nbsp;and&nbsp;slashes.</span><br>
<span class="lineno">90</span><span class="comment" id="3718699">//</span><br>
<span class="lineno"></span><span class="comment" id="3718702">//&nbsp;Anonymous&nbsp;struct&nbsp;fields&nbsp;are&nbsp;usually&nbsp;marshaled&nbsp;as&nbsp;if&nbsp;their&nbsp;inner&nbsp;exported&nbsp;fields</span><br>
<span class="lineno"></span><span class="comment" id="3718785">//&nbsp;were&nbsp;fields&nbsp;in&nbsp;the&nbsp;outer&nbsp;struct,&nbsp;subject&nbsp;to&nbsp;the&nbsp;usual&nbsp;Go&nbsp;visibility&nbsp;rules&nbsp;amended</span><br>
<span class="lineno"></span><span class="comment" id="3718870">//&nbsp;as&nbsp;described&nbsp;in&nbsp;the&nbsp;next&nbsp;paragraph.</span><br>
<span class="lineno"></span><span class="comment" id="3718909">//&nbsp;An&nbsp;anonymous&nbsp;struct&nbsp;field&nbsp;with&nbsp;a&nbsp;name&nbsp;given&nbsp;in&nbsp;its&nbsp;JSON&nbsp;tag&nbsp;is&nbsp;treated&nbsp;as</span><br>
<span class="lineno">95</span><span class="comment" id="3718986">//&nbsp;having&nbsp;that&nbsp;name,&nbsp;rather&nbsp;than&nbsp;being&nbsp;anonymous.</span><br>
<span class="lineno"></span><span class="comment" id="3719036">//&nbsp;An&nbsp;anonymous&nbsp;struct&nbsp;field&nbsp;of&nbsp;interface&nbsp;type&nbsp;is&nbsp;treated&nbsp;the&nbsp;same&nbsp;as&nbsp;having</span><br>
<span class="lineno"></span><span class="comment" id="3719113">//&nbsp;that&nbsp;type&nbsp;as&nbsp;its&nbsp;name,&nbsp;rather&nbsp;than&nbsp;being&nbsp;anonymous.</span><br>
<span class="lineno"></span><span class="comment" id="3719168">//</span><br>
<span class="lineno"></span><span class="comment" id="3719171">//&nbsp;The&nbsp;Go&nbsp;visibility&nbsp;rules&nbsp;for&nbsp;struct&nbsp;fields&nbsp;are&nbsp;amended&nbsp;for&nbsp;JSON&nbsp;when</span><br>
<span class="lineno">100</span><span class="comment" id="3719242">//&nbsp;deciding&nbsp;which&nbsp;field&nbsp;to&nbsp;marshal&nbsp;or&nbsp;unmarshal.&nbsp;If&nbsp;there&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="3719304">//&nbsp;multiple&nbsp;fields&nbsp;at&nbsp;the&nbsp;same&nbsp;level,&nbsp;and&nbsp;that&nbsp;level&nbsp;is&nbsp;the&nbsp;least</span><br>
<span class="lineno"></span><span class="comment" id="3719370">//&nbsp;nested&nbsp;(and&nbsp;would&nbsp;therefore&nbsp;be&nbsp;the&nbsp;nesting&nbsp;level&nbsp;selected&nbsp;by&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3719438">//&nbsp;usual&nbsp;Go&nbsp;rules),&nbsp;the&nbsp;following&nbsp;extra&nbsp;rules&nbsp;apply:</span><br>
<span class="lineno"></span><span class="comment" id="3719491">//</span><br>
<span class="lineno">105</span><span class="comment" id="3719494">//&nbsp;1)&nbsp;Of&nbsp;those&nbsp;fields,&nbsp;if&nbsp;any&nbsp;are&nbsp;JSON-tagged,&nbsp;only&nbsp;tagged&nbsp;fields&nbsp;are&nbsp;considered,</span><br>
<span class="lineno"></span><span class="comment" id="3719576">//&nbsp;even&nbsp;if&nbsp;there&nbsp;are&nbsp;multiple&nbsp;untagged&nbsp;fields&nbsp;that&nbsp;would&nbsp;otherwise&nbsp;conflict.</span><br>
<span class="lineno"></span><span class="comment" id="3719653">//&nbsp;2)&nbsp;If&nbsp;there&nbsp;is&nbsp;exactly&nbsp;one&nbsp;field&nbsp;(tagged&nbsp;or&nbsp;not&nbsp;according&nbsp;to&nbsp;the&nbsp;first&nbsp;rule),&nbsp;that&nbsp;is&nbsp;selected.</span><br>
<span class="lineno"></span><span class="comment" id="3719752">//&nbsp;3)&nbsp;Otherwise&nbsp;there&nbsp;are&nbsp;multiple&nbsp;fields,&nbsp;and&nbsp;all&nbsp;are&nbsp;ignored;&nbsp;no&nbsp;error&nbsp;occurs.</span><br>
<span class="lineno"></span><span class="comment" id="3719833">//</span><br>
<span class="lineno">110</span><span class="comment" id="3719836">//&nbsp;Handling&nbsp;of&nbsp;anonymous&nbsp;struct&nbsp;fields&nbsp;is&nbsp;new&nbsp;in&nbsp;Go&nbsp;1.1.</span><br>
<span class="lineno"></span><span class="comment" id="3719893">//&nbsp;Prior&nbsp;to&nbsp;Go&nbsp;1.1,&nbsp;anonymous&nbsp;struct&nbsp;fields&nbsp;were&nbsp;ignored.&nbsp;To&nbsp;force&nbsp;ignoring&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3719972">//&nbsp;an&nbsp;anonymous&nbsp;struct&nbsp;field&nbsp;in&nbsp;both&nbsp;current&nbsp;and&nbsp;earlier&nbsp;versions,&nbsp;give&nbsp;the&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="3720054">//&nbsp;a&nbsp;JSON&nbsp;tag&nbsp;of&nbsp;&#34;-&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3720076">//</span><br>
<span class="lineno">115</span><span class="comment" id="3720079">//&nbsp;Map&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;objects.</span><br>
<span class="lineno"></span><span class="comment" id="3720117">//&nbsp;The&nbsp;map&#39;s&nbsp;key&nbsp;type&nbsp;must&nbsp;be&nbsp;string;&nbsp;the&nbsp;object&nbsp;keys&nbsp;are&nbsp;used&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="3720189">//&nbsp;as&nbsp;map&nbsp;keys.</span><br>
<span class="lineno"></span><span class="comment" id="3720205">//</span><br>
<span class="lineno"></span><span class="comment" id="3720208">//&nbsp;Pointer&nbsp;values&nbsp;encode&nbsp;as&nbsp;the&nbsp;value&nbsp;pointed&nbsp;to.</span><br>
<span class="lineno">120</span><span class="comment" id="3720258">//&nbsp;A&nbsp;nil&nbsp;pointer&nbsp;encodes&nbsp;as&nbsp;the&nbsp;null&nbsp;JSON&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="3720308">//</span><br>
<span class="lineno"></span><span class="comment" id="3720311">//&nbsp;Interface&nbsp;values&nbsp;encode&nbsp;as&nbsp;the&nbsp;value&nbsp;contained&nbsp;in&nbsp;the&nbsp;interface.</span><br>
<span class="lineno"></span><span class="comment" id="3720379">//&nbsp;A&nbsp;nil&nbsp;interface&nbsp;value&nbsp;encodes&nbsp;as&nbsp;the&nbsp;null&nbsp;JSON&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="3720437">//</span><br>
<span class="lineno">125</span><span class="comment" id="3720440">//&nbsp;Channel,&nbsp;complex,&nbsp;and&nbsp;function&nbsp;values&nbsp;cannot&nbsp;be&nbsp;encoded&nbsp;in&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="comment" id="3720508">//&nbsp;Attempting&nbsp;to&nbsp;encode&nbsp;such&nbsp;a&nbsp;value&nbsp;causes&nbsp;Marshal&nbsp;to&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="3720570">//&nbsp;an&nbsp;UnsupportedTypeError.</span><br>
<span class="lineno"></span><span class="comment" id="3720598">//</span><br>
<span class="lineno"></span><span class="comment" id="3720601">//&nbsp;JSON&nbsp;cannot&nbsp;represent&nbsp;cyclic&nbsp;data&nbsp;structures&nbsp;and&nbsp;Marshal&nbsp;does&nbsp;not</span><br>
<span class="lineno">130</span><span class="comment" id="3720670">//&nbsp;handle&nbsp;them.&nbsp;&nbsp;Passing&nbsp;cyclic&nbsp;structures&nbsp;to&nbsp;Marshal&nbsp;will&nbsp;result&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3720739">//&nbsp;an&nbsp;infinite&nbsp;recursion.</span><br>
<span class="lineno"></span><span class="comment" id="3720765">//</span><br>
<span class="lineno"></span><span class="keyword" id="3720768">func</span>&nbsp;<span class="ident" id="3720773">Marshal</span><span class="op" id="3720780">(</span><span class="ident" id="3720781">v</span>&nbsp;<span class="keyword" id="3720783">interface</span><span class="op" id="3720792">{</span><span class="op" id="3720793">}</span><span class="op" id="3720794">)</span>&nbsp;<span class="op" id="3720796">(</span><span class="op" id="3720797">[</span><span class="op" id="3720798">]</span><span class="builtintype" id="3720799">byte</span><span class="op" id="3720803">,</span>&nbsp;<span class="builtintype" id="3720805">error</span><span class="op" id="3720810">)</span>&nbsp;<span class="op" id="3720812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3720815">e</span>&nbsp;<span class="op" id="3720817">:=</span>&nbsp;<span class="op" id="3720820">&amp;</span><span class="ident" id="3720821">encodeState</span><span class="op" id="3720832">{</span><span class="op" id="3720833">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3720836">err</span>&nbsp;<span class="op" id="3720840">:=</span>&nbsp;<span class="ident" id="3720843">e</span><span class="op" id="3720844">.</span><span class="ident" id="3720845">marshal</span><span class="op" id="3720852">(</span><span class="ident" id="3720853">v</span><span class="op" id="3720854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3720857">if</span>&nbsp;<span class="ident" id="3720860">err</span>&nbsp;<span class="op" id="3720864">!=</span>&nbsp;<span class="ident" id="3720867">nil</span>&nbsp;<span class="op" id="3720871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3720875">return</span>&nbsp;<span class="ident" id="3720882">nil</span><span class="op" id="3720885">,</span>&nbsp;<span class="ident" id="3720887">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3720892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3720895">return</span>&nbsp;<span class="ident" id="3720902">e</span><span class="op" id="3720903">.</span><span class="ident" id="3720904">Bytes</span><span class="op" id="3720909">(</span><span class="op" id="3720910">)</span><span class="op" id="3720911">,</span>&nbsp;<span class="ident" id="3720913">nil</span><br>
<span class="lineno">140</span><span class="op" id="3720917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3720920">//&nbsp;MarshalIndent&nbsp;is&nbsp;like&nbsp;Marshal&nbsp;but&nbsp;applies&nbsp;Indent&nbsp;to&nbsp;format&nbsp;the&nbsp;output.</span><br>
<span class="lineno"></span><span class="keyword" id="3720994">func</span>&nbsp;<span class="ident" id="3720999">MarshalIndent</span><span class="op" id="3721012">(</span><span class="ident" id="3721013">v</span>&nbsp;<span class="keyword" id="3721015">interface</span><span class="op" id="3721024">{</span><span class="op" id="3721025">}</span><span class="op" id="3721026">,</span>&nbsp;<span class="ident" id="3721028">prefix</span><span class="op" id="3721034">,</span>&nbsp;<span class="ident" id="3721036">indent</span>&nbsp;<span class="builtintype" id="3721043">string</span><span class="op" id="3721049">)</span>&nbsp;<span class="op" id="3721051">(</span><span class="op" id="3721052">[</span><span class="op" id="3721053">]</span><span class="builtintype" id="3721054">byte</span><span class="op" id="3721058">,</span>&nbsp;<span class="builtintype" id="3721060">error</span><span class="op" id="3721065">)</span>&nbsp;<span class="op" id="3721067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3721070">b</span><span class="op" id="3721071">,</span>&nbsp;<span class="ident" id="3721073">err</span>&nbsp;<span class="op" id="3721077">:=</span>&nbsp;<span class="ident" id="3721080">Marshal</span><span class="op" id="3721087">(</span><span class="ident" id="3721088">v</span><span class="op" id="3721089">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3721092">if</span>&nbsp;<span class="ident" id="3721095">err</span>&nbsp;<span class="op" id="3721099">!=</span>&nbsp;<span class="ident" id="3721102">nil</span>&nbsp;<span class="op" id="3721106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3721110">return</span>&nbsp;<span class="ident" id="3721117">nil</span><span class="op" id="3721120">,</span>&nbsp;<span class="ident" id="3721122">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3721127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3721130">var</span>&nbsp;<span class="ident" id="3721134">buf</span>&nbsp;<span class="ident" id="3721138">bytes</span><span class="op" id="3721143">.</span><span class="ident" id="3721144">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3721152">err</span>&nbsp;<span class="op" id="3721156">=</span>&nbsp;<span class="ident" id="3721158">Indent</span><span class="op" id="3721164">(</span><span class="op" id="3721165">&amp;</span><span class="ident" id="3721166">buf</span><span class="op" id="3721169">,</span>&nbsp;<span class="ident" id="3721171">b</span><span class="op" id="3721172">,</span>&nbsp;<span class="ident" id="3721174">prefix</span><span class="op" id="3721180">,</span>&nbsp;<span class="ident" id="3721182">indent</span><span class="op" id="3721188">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3721191">if</span>&nbsp;<span class="ident" id="3721194">err</span>&nbsp;<span class="op" id="3721198">!=</span>&nbsp;<span class="ident" id="3721201">nil</span>&nbsp;<span class="op" id="3721205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3721209">return</span>&nbsp;<span class="ident" id="3721216">nil</span><span class="op" id="3721219">,</span>&nbsp;<span class="ident" id="3721221">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3721226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3721229">return</span>&nbsp;<span class="ident" id="3721236">buf</span><span class="op" id="3721239">.</span><span class="ident" id="3721240">Bytes</span><span class="op" id="3721245">(</span><span class="op" id="3721246">)</span><span class="op" id="3721247">,</span>&nbsp;<span class="ident" id="3721249">nil</span><br>
<span class="lineno"></span><span class="op" id="3721253">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="3721256">//&nbsp;HTMLEscape&nbsp;appends&nbsp;to&nbsp;dst&nbsp;the&nbsp;JSON-encoded&nbsp;src&nbsp;with&nbsp;&lt;,&nbsp;&gt;,&nbsp;&amp;,&nbsp;U+2028&nbsp;and&nbsp;U+2029</span><br>
<span class="lineno"></span><span class="comment" id="3721338">//&nbsp;characters&nbsp;inside&nbsp;string&nbsp;literals&nbsp;changed&nbsp;to&nbsp;\u003c,&nbsp;\u003e,&nbsp;\u0026,&nbsp;\u2028,&nbsp;\u2029</span><br>
<span class="lineno"></span><span class="comment" id="3721425">//&nbsp;so&nbsp;that&nbsp;the&nbsp;JSON&nbsp;will&nbsp;be&nbsp;safe&nbsp;to&nbsp;embed&nbsp;inside&nbsp;HTML&nbsp;&lt;script&gt;&nbsp;tags.</span><br>
<span class="lineno"></span><span class="comment" id="3721494">//&nbsp;For&nbsp;historical&nbsp;reasons,&nbsp;web&nbsp;browsers&nbsp;don&#39;t&nbsp;honor&nbsp;standard&nbsp;HTML</span><br>
<span class="lineno">160</span><span class="comment" id="3721560">//&nbsp;escaping&nbsp;within&nbsp;&lt;script&gt;&nbsp;tags,&nbsp;so&nbsp;an&nbsp;alternative&nbsp;JSON&nbsp;encoding&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="3721631">//&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3721643">func</span>&nbsp;<span class="ident" id="3721648">HTMLEscape</span><span class="op" id="3721658">(</span><span class="ident" id="3721659">dst</span>&nbsp;<span class="op" id="3721663">*</span><span class="ident" id="3721664">bytes</span><span class="op" id="3721669">.</span><span class="ident" id="3721670">Buffer</span><span class="op" id="3721676">,</span>&nbsp;<span class="ident" id="3721678">src</span>&nbsp;<span class="op" id="3721682">[</span><span class="op" id="3721683">]</span><span class="builtintype" id="3721684">byte</span><span class="op" id="3721688">)</span>&nbsp;<span class="op" id="3721690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3721693">//&nbsp;The&nbsp;characters&nbsp;can&nbsp;only&nbsp;appear&nbsp;in&nbsp;string&nbsp;literals,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3721748">//&nbsp;so&nbsp;just&nbsp;scan&nbsp;the&nbsp;string&nbsp;one&nbsp;byte&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3721796">start</span>&nbsp;<span class="op" id="3721802">:=</span>&nbsp;<span class="num" id="3721805">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3721808">for</span>&nbsp;<span class="ident" id="3721812">i</span><span class="op" id="3721813">,</span>&nbsp;<span class="ident" id="3721815">c</span>&nbsp;<span class="op" id="3721817">:=</span>&nbsp;<span class="keyword" id="3721820">range</span>&nbsp;<span class="ident" id="3721826">src</span>&nbsp;<span class="op" id="3721830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3721834">if</span>&nbsp;<span class="ident" id="3721837">c</span>&nbsp;<span class="op" id="3721839">==</span>&nbsp;<span class="string" id="3721842">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="3721846">||</span>&nbsp;<span class="ident" id="3721849">c</span>&nbsp;<span class="op" id="3721851">==</span>&nbsp;<span class="string" id="3721854">&#39;&gt;&#39;</span>&nbsp;<span class="op" id="3721858">||</span>&nbsp;<span class="ident" id="3721861">c</span>&nbsp;<span class="op" id="3721863">==</span>&nbsp;<span class="string" id="3721866">&#39;&amp;&#39;</span>&nbsp;<span class="op" id="3721870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3721875">if</span>&nbsp;<span class="ident" id="3721878">start</span>&nbsp;<span class="op" id="3721884">&lt;</span>&nbsp;<span class="ident" id="3721886">i</span>&nbsp;<span class="op" id="3721888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3721894">dst</span><span class="op" id="3721897">.</span><span class="ident" id="3721898">Write</span><span class="op" id="3721903">(</span><span class="ident" id="3721904">src</span><span class="op" id="3721907">[</span><span class="ident" id="3721908">start</span><span class="op" id="3721913">:</span><span class="ident" id="3721914">i</span><span class="op" id="3721915">]</span><span class="op" id="3721916">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3721921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3721926">dst</span><span class="op" id="3721929">.</span><span class="ident" id="3721930">WriteString</span><span class="op" id="3721941">(</span><span class="string" id="3721942">`\u00`</span><span class="op" id="3721948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3721953">dst</span><span class="op" id="3721956">.</span><span class="ident" id="3721957">WriteByte</span><span class="op" id="3721966">(</span><span class="ident" id="3721967">hex</span><span class="op" id="3721970">[</span><span class="ident" id="3721971">c</span><span class="op" id="3721972">&gt;&gt;</span><span class="num" id="3721974">4</span><span class="op" id="3721975">]</span><span class="op" id="3721976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3721981">dst</span><span class="op" id="3721984">.</span><span class="ident" id="3721985">WriteByte</span><span class="op" id="3721994">(</span><span class="ident" id="3721995">hex</span><span class="op" id="3721998">[</span><span class="ident" id="3721999">c</span><span class="op" id="3722000">&amp;</span><span class="num" id="3722001">0xF</span><span class="op" id="3722004">]</span><span class="op" id="3722005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3722010">start</span>&nbsp;<span class="op" id="3722016">=</span>&nbsp;<span class="ident" id="3722018">i</span>&nbsp;<span class="op" id="3722020">+</span>&nbsp;<span class="num" id="3722022">1</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3722026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3722030">//&nbsp;Convert&nbsp;U+2028&nbsp;and&nbsp;U+2029&nbsp;(E2&nbsp;80&nbsp;A8&nbsp;and&nbsp;E2&nbsp;80&nbsp;A9).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3722086">if</span>&nbsp;<span class="ident" id="3722089">c</span>&nbsp;<span class="op" id="3722091">==</span>&nbsp;<span class="num" id="3722094">0xE2</span>&nbsp;<span class="op" id="3722099">&amp;&amp;</span>&nbsp;<span class="ident" id="3722102">i</span><span class="op" id="3722103">+</span><span class="num" id="3722104">2</span>&nbsp;<span class="op" id="3722106">&lt;</span>&nbsp;<span class="builtinfunc" id="3722108">len</span><span class="op" id="3722111">(</span><span class="ident" id="3722112">src</span><span class="op" id="3722115">)</span>&nbsp;<span class="op" id="3722117">&amp;&amp;</span>&nbsp;<span class="ident" id="3722120">src</span><span class="op" id="3722123">[</span><span class="ident" id="3722124">i</span><span class="op" id="3722125">+</span><span class="num" id="3722126">1</span><span class="op" id="3722127">]</span>&nbsp;<span class="op" id="3722129">==</span>&nbsp;<span class="num" id="3722132">0x80</span>&nbsp;<span class="op" id="3722137">&amp;&amp;</span>&nbsp;<span class="ident" id="3722140">src</span><span class="op" id="3722143">[</span><span class="ident" id="3722144">i</span><span class="op" id="3722145">+</span><span class="num" id="3722146">2</span><span class="op" id="3722147">]</span><span class="op" id="3722148">&amp;^</span><span class="num" id="3722150">1</span>&nbsp;<span class="op" id="3722152">==</span>&nbsp;<span class="num" id="3722155">0xA8</span>&nbsp;<span class="op" id="3722160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3722165">if</span>&nbsp;<span class="ident" id="3722168">start</span>&nbsp;<span class="op" id="3722174">&lt;</span>&nbsp;<span class="ident" id="3722176">i</span>&nbsp;<span class="op" id="3722178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3722184">dst</span><span class="op" id="3722187">.</span><span class="ident" id="3722188">Write</span><span class="op" id="3722193">(</span><span class="ident" id="3722194">src</span><span class="op" id="3722197">[</span><span class="ident" id="3722198">start</span><span class="op" id="3722203">:</span><span class="ident" id="3722204">i</span><span class="op" id="3722205">]</span><span class="op" id="3722206">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3722211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3722216">dst</span><span class="op" id="3722219">.</span><span class="ident" id="3722220">WriteString</span><span class="op" id="3722231">(</span><span class="string" id="3722232">`\u202`</span><span class="op" id="3722239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3722244">dst</span><span class="op" id="3722247">.</span><span class="ident" id="3722248">WriteByte</span><span class="op" id="3722257">(</span><span class="ident" id="3722258">hex</span><span class="op" id="3722261">[</span><span class="ident" id="3722262">src</span><span class="op" id="3722265">[</span><span class="ident" id="3722266">i</span><span class="op" id="3722267">+</span><span class="num" id="3722268">2</span><span class="op" id="3722269">]</span><span class="op" id="3722270">&amp;</span><span class="num" id="3722271">0xF</span><span class="op" id="3722274">]</span><span class="op" id="3722275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3722280">start</span>&nbsp;<span class="op" id="3722286">=</span>&nbsp;<span class="ident" id="3722288">i</span>&nbsp;<span class="op" id="3722290">+</span>&nbsp;<span class="num" id="3722292">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3722296">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3722299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3722302">if</span>&nbsp;<span class="ident" id="3722305">start</span>&nbsp;<span class="op" id="3722311">&lt;</span>&nbsp;<span class="builtinfunc" id="3722313">len</span><span class="op" id="3722316">(</span><span class="ident" id="3722317">src</span><span class="op" id="3722320">)</span>&nbsp;<span class="op" id="3722322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3722326">dst</span><span class="op" id="3722329">.</span><span class="ident" id="3722330">Write</span><span class="op" id="3722335">(</span><span class="ident" id="3722336">src</span><span class="op" id="3722339">[</span><span class="ident" id="3722340">start</span><span class="op" id="3722345">:</span><span class="op" id="3722346">]</span><span class="op" id="3722347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3722350">}</span><br>
<span class="lineno"></span><span class="op" id="3722352">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="3722355">//&nbsp;Marshaler&nbsp;is&nbsp;the&nbsp;interface&nbsp;implemented&nbsp;by&nbsp;objects&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3722413">//&nbsp;can&nbsp;marshal&nbsp;themselves&nbsp;into&nbsp;valid&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="keyword" id="3722456">type</span>&nbsp;<span class="ident" id="3722461">Marshaler</span>&nbsp;<span class="keyword" id="3722471">interface</span>&nbsp;<span class="op" id="3722481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3722484">MarshalJSON</span><span class="op" id="3722495">(</span><span class="op" id="3722496">)</span>&nbsp;<span class="op" id="3722498">(</span><span class="op" id="3722499">[</span><span class="op" id="3722500">]</span><span class="builtintype" id="3722501">byte</span><span class="op" id="3722505">,</span>&nbsp;<span class="builtintype" id="3722507">error</span><span class="op" id="3722512">)</span><br>
<span class="lineno">195</span><span class="op" id="3722514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3722517">//&nbsp;An&nbsp;UnsupportedTypeError&nbsp;is&nbsp;returned&nbsp;by&nbsp;Marshal&nbsp;when&nbsp;attempting</span><br>
<span class="lineno"></span><span class="comment" id="3722583">//&nbsp;to&nbsp;encode&nbsp;an&nbsp;unsupported&nbsp;value&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3722623">type</span>&nbsp;<span class="ident" id="3722628">UnsupportedTypeError</span>&nbsp;<span class="keyword" id="3722649">struct</span>&nbsp;<span class="op" id="3722656">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3722659">Type</span>&nbsp;<span class="ident" id="3722664">reflect</span><span class="op" id="3722671">.</span><span class="ident" id="3722672">Type</span><br>
<span class="lineno"></span><span class="op" id="3722677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3722680">func</span>&nbsp;<span class="op" id="3722685">(</span><span class="ident" id="3722686">e</span>&nbsp;<span class="op" id="3722688">*</span><span class="ident" id="3722689">UnsupportedTypeError</span><span class="op" id="3722709">)</span>&nbsp;<span class="ident" id="3722711">Error</span><span class="op" id="3722716">(</span><span class="op" id="3722717">)</span>&nbsp;<span class="builtintype" id="3722719">string</span>&nbsp;<span class="op" id="3722726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3722729">return</span>&nbsp;<span class="string" id="3722736">&#34;json:&nbsp;unsupported&nbsp;type:&nbsp;&#34;</span>&nbsp;<span class="op" id="3722763">+</span>&nbsp;<span class="ident" id="3722765">e</span><span class="op" id="3722766">.</span><span class="ident" id="3722767">Type</span><span class="op" id="3722771">.</span><span class="ident" id="3722772">String</span><span class="op" id="3722778">(</span><span class="op" id="3722779">)</span><br>
<span class="lineno">205</span><span class="op" id="3722781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3722784">type</span>&nbsp;<span class="ident" id="3722789">UnsupportedValueError</span>&nbsp;<span class="keyword" id="3722811">struct</span>&nbsp;<span class="op" id="3722818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3722821">Value</span>&nbsp;<span class="ident" id="3722827">reflect</span><span class="op" id="3722834">.</span><span class="ident" id="3722835">Value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3722842">Str</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3722848">string</span><br>
<span class="lineno">210</span><span class="op" id="3722855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3722858">func</span>&nbsp;<span class="op" id="3722863">(</span><span class="ident" id="3722864">e</span>&nbsp;<span class="op" id="3722866">*</span><span class="ident" id="3722867">UnsupportedValueError</span><span class="op" id="3722888">)</span>&nbsp;<span class="ident" id="3722890">Error</span><span class="op" id="3722895">(</span><span class="op" id="3722896">)</span>&nbsp;<span class="builtintype" id="3722898">string</span>&nbsp;<span class="op" id="3722905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3722908">return</span>&nbsp;<span class="string" id="3722915">&#34;json:&nbsp;unsupported&nbsp;value:&nbsp;&#34;</span>&nbsp;<span class="op" id="3722943">+</span>&nbsp;<span class="ident" id="3722945">e</span><span class="op" id="3722946">.</span><span class="ident" id="3722947">Str</span><br>
<span class="lineno"></span><span class="op" id="3722951">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="comment" id="3722954">//&nbsp;Before&nbsp;Go&nbsp;1.2,&nbsp;an&nbsp;InvalidUTF8Error&nbsp;was&nbsp;returned&nbsp;by&nbsp;Marshal&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="3723021">//&nbsp;attempting&nbsp;to&nbsp;encode&nbsp;a&nbsp;string&nbsp;value&nbsp;with&nbsp;invalid&nbsp;UTF-8&nbsp;sequences.</span><br>
<span class="lineno"></span><span class="comment" id="3723090">//&nbsp;As&nbsp;of&nbsp;Go&nbsp;1.2,&nbsp;Marshal&nbsp;instead&nbsp;coerces&nbsp;the&nbsp;string&nbsp;to&nbsp;valid&nbsp;UTF-8&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3723160">//&nbsp;replacing&nbsp;invalid&nbsp;bytes&nbsp;with&nbsp;the&nbsp;Unicode&nbsp;replacement&nbsp;rune&nbsp;U+FFFD.</span><br>
<span class="lineno">220</span><span class="comment" id="3723229">//&nbsp;This&nbsp;error&nbsp;is&nbsp;no&nbsp;longer&nbsp;generated&nbsp;but&nbsp;is&nbsp;kept&nbsp;for&nbsp;backwards&nbsp;compatibility</span><br>
<span class="lineno"></span><span class="comment" id="3723306">//&nbsp;with&nbsp;programs&nbsp;that&nbsp;might&nbsp;mention&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="3723346">type</span>&nbsp;<span class="ident" id="3723351">InvalidUTF8Error</span>&nbsp;<span class="keyword" id="3723368">struct</span>&nbsp;<span class="op" id="3723375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3723378">S</span>&nbsp;<span class="builtintype" id="3723380">string</span>&nbsp;<span class="comment" id="3723387">//&nbsp;the&nbsp;whole&nbsp;string&nbsp;value&nbsp;that&nbsp;caused&nbsp;the&nbsp;error</span><br>
<span class="lineno"></span><span class="op" id="3723435">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="3723438">func</span>&nbsp;<span class="op" id="3723443">(</span><span class="ident" id="3723444">e</span>&nbsp;<span class="op" id="3723446">*</span><span class="ident" id="3723447">InvalidUTF8Error</span><span class="op" id="3723463">)</span>&nbsp;<span class="ident" id="3723465">Error</span><span class="op" id="3723470">(</span><span class="op" id="3723471">)</span>&nbsp;<span class="builtintype" id="3723473">string</span>&nbsp;<span class="op" id="3723480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3723483">return</span>&nbsp;<span class="string" id="3723490">&#34;json:&nbsp;invalid&nbsp;UTF-8&nbsp;in&nbsp;string:&nbsp;&#34;</span>&nbsp;<span class="op" id="3723524">+</span>&nbsp;<span class="ident" id="3723526">strconv</span><span class="op" id="3723533">.</span><span class="ident" id="3723534">Quote</span><span class="op" id="3723539">(</span><span class="ident" id="3723540">e</span><span class="op" id="3723541">.</span><span class="ident" id="3723542">S</span><span class="op" id="3723543">)</span><br>
<span class="lineno"></span><span class="op" id="3723545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="3723548">type</span>&nbsp;<span class="ident" id="3723553">MarshalerError</span>&nbsp;<span class="keyword" id="3723568">struct</span>&nbsp;<span class="op" id="3723575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3723578">Type</span>&nbsp;<span class="ident" id="3723583">reflect</span><span class="op" id="3723590">.</span><span class="ident" id="3723591">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3723597">Err</span>&nbsp;&nbsp;<span class="builtintype" id="3723602">error</span><br>
<span class="lineno"></span><span class="op" id="3723608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span><span class="keyword" id="3723611">func</span>&nbsp;<span class="op" id="3723616">(</span><span class="ident" id="3723617">e</span>&nbsp;<span class="op" id="3723619">*</span><span class="ident" id="3723620">MarshalerError</span><span class="op" id="3723634">)</span>&nbsp;<span class="ident" id="3723636">Error</span><span class="op" id="3723641">(</span><span class="op" id="3723642">)</span>&nbsp;<span class="builtintype" id="3723644">string</span>&nbsp;<span class="op" id="3723651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3723654">return</span>&nbsp;<span class="string" id="3723661">&#34;json:&nbsp;error&nbsp;calling&nbsp;MarshalJSON&nbsp;for&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="3723705">+</span>&nbsp;<span class="ident" id="3723707">e</span><span class="op" id="3723708">.</span><span class="ident" id="3723709">Type</span><span class="op" id="3723713">.</span><span class="ident" id="3723714">String</span><span class="op" id="3723720">(</span><span class="op" id="3723721">)</span>&nbsp;<span class="op" id="3723723">+</span>&nbsp;<span class="string" id="3723725">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="3723730">+</span>&nbsp;<span class="ident" id="3723732">e</span><span class="op" id="3723733">.</span><span class="ident" id="3723734">Err</span><span class="op" id="3723737">.</span><span class="ident" id="3723738">Error</span><span class="op" id="3723743">(</span><span class="op" id="3723744">)</span><br>
<span class="lineno"></span><span class="op" id="3723746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3723749">var</span>&nbsp;<span class="ident" id="3723753">hex</span>&nbsp;<span class="op" id="3723757">=</span>&nbsp;<span class="string" id="3723759">&#34;0123456789abcdef&#34;</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="comment" id="3723779">//&nbsp;An&nbsp;encodeState&nbsp;encodes&nbsp;JSON&nbsp;into&nbsp;a&nbsp;bytes.Buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3723831">type</span>&nbsp;<span class="ident" id="3723836">encodeState</span>&nbsp;<span class="keyword" id="3723848">struct</span>&nbsp;<span class="op" id="3723855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3723858">bytes</span><span class="op" id="3723863">.</span><span class="ident" id="3723864">Buffer</span>&nbsp;<span class="comment" id="3723871">//&nbsp;accumulated&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3723894">scratch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3723907">[</span><span class="num" id="3723908">64</span><span class="op" id="3723910">]</span><span class="builtintype" id="3723911">byte</span><br>
<span class="lineno">245</span><span class="op" id="3723916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3723919">var</span>&nbsp;<span class="ident" id="3723923">encodeStatePool</span>&nbsp;<span class="ident" id="3723939">sync</span><span class="op" id="3723943">.</span><span class="ident" id="3723944">Pool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3723950">func</span>&nbsp;<span class="ident" id="3723955">newEncodeState</span><span class="op" id="3723969">(</span><span class="op" id="3723970">)</span>&nbsp;<span class="op" id="3723972">*</span><span class="ident" id="3723973">encodeState</span>&nbsp;<span class="op" id="3723985">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3723988">if</span>&nbsp;<span class="ident" id="3723991">v</span>&nbsp;<span class="op" id="3723993">:=</span>&nbsp;<span class="ident" id="3723996">encodeStatePool</span><span class="op" id="3724011">.</span><span class="ident" id="3724012">Get</span><span class="op" id="3724015">(</span><span class="op" id="3724016">)</span><span class="op" id="3724017">;</span>&nbsp;<span class="ident" id="3724019">v</span>&nbsp;<span class="op" id="3724021">!=</span>&nbsp;<span class="ident" id="3724024">nil</span>&nbsp;<span class="op" id="3724028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3724032">e</span>&nbsp;<span class="op" id="3724034">:=</span>&nbsp;<span class="ident" id="3724037">v</span><span class="op" id="3724038">.</span><span class="op" id="3724039">(</span><span class="op" id="3724040">*</span><span class="ident" id="3724041">encodeState</span><span class="op" id="3724052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3724056">e</span><span class="op" id="3724057">.</span><span class="ident" id="3724058">Reset</span><span class="op" id="3724063">(</span><span class="op" id="3724064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724068">return</span>&nbsp;<span class="ident" id="3724075">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3724078">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724081">return</span>&nbsp;<span class="builtinfunc" id="3724088">new</span><span class="op" id="3724091">(</span><span class="ident" id="3724092">encodeState</span><span class="op" id="3724103">)</span><br>
<span class="lineno"></span><span class="op" id="3724105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3724108">func</span>&nbsp;<span class="op" id="3724113">(</span><span class="ident" id="3724114">e</span>&nbsp;<span class="op" id="3724116">*</span><span class="ident" id="3724117">encodeState</span><span class="op" id="3724128">)</span>&nbsp;<span class="ident" id="3724130">marshal</span><span class="op" id="3724137">(</span><span class="ident" id="3724138">v</span>&nbsp;<span class="keyword" id="3724140">interface</span><span class="op" id="3724149">{</span><span class="op" id="3724150">}</span><span class="op" id="3724151">)</span>&nbsp;<span class="op" id="3724153">(</span><span class="ident" id="3724154">err</span>&nbsp;<span class="builtintype" id="3724158">error</span><span class="op" id="3724163">)</span>&nbsp;<span class="op" id="3724165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724168">defer</span>&nbsp;<span class="keyword" id="3724174">func</span><span class="op" id="3724178">(</span><span class="op" id="3724179">)</span>&nbsp;<span class="op" id="3724181">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724185">if</span>&nbsp;<span class="ident" id="3724188">r</span>&nbsp;<span class="op" id="3724190">:=</span>&nbsp;<span class="builtinfunc" id="3724193">recover</span><span class="op" id="3724200">(</span><span class="op" id="3724201">)</span><span class="op" id="3724202">;</span>&nbsp;<span class="ident" id="3724204">r</span>&nbsp;<span class="op" id="3724206">!=</span>&nbsp;<span class="ident" id="3724209">nil</span>&nbsp;<span class="op" id="3724213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724218">if</span>&nbsp;<span class="ident" id="3724221">_</span><span class="op" id="3724222">,</span>&nbsp;<span class="ident" id="3724224">ok</span>&nbsp;<span class="op" id="3724227">:=</span>&nbsp;<span class="ident" id="3724230">r</span><span class="op" id="3724231">.</span><span class="op" id="3724232">(</span><span class="ident" id="3724233">runtime</span><span class="op" id="3724240">.</span><span class="ident" id="3724241">Error</span><span class="op" id="3724246">)</span><span class="op" id="3724247">;</span>&nbsp;<span class="ident" id="3724249">ok</span>&nbsp;<span class="op" id="3724252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3724258">panic</span><span class="op" id="3724263">(</span><span class="ident" id="3724264">r</span><span class="op" id="3724265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3724270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724275">if</span>&nbsp;<span class="ident" id="3724278">s</span><span class="op" id="3724279">,</span>&nbsp;<span class="ident" id="3724281">ok</span>&nbsp;<span class="op" id="3724284">:=</span>&nbsp;<span class="ident" id="3724287">r</span><span class="op" id="3724288">.</span><span class="op" id="3724289">(</span><span class="builtintype" id="3724290">string</span><span class="op" id="3724296">)</span><span class="op" id="3724297">;</span>&nbsp;<span class="ident" id="3724299">ok</span>&nbsp;<span class="op" id="3724302">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3724308">panic</span><span class="op" id="3724313">(</span><span class="ident" id="3724314">s</span><span class="op" id="3724315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3724320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3724325">err</span>&nbsp;<span class="op" id="3724329">=</span>&nbsp;<span class="ident" id="3724331">r</span><span class="op" id="3724332">.</span><span class="op" id="3724333">(</span><span class="builtintype" id="3724334">error</span><span class="op" id="3724339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3724343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3724346">}</span><span class="op" id="3724347">(</span><span class="op" id="3724348">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3724351">e</span><span class="op" id="3724352">.</span><span class="ident" id="3724353">reflectValue</span><span class="op" id="3724365">(</span><span class="ident" id="3724366">reflect</span><span class="op" id="3724373">.</span><span class="ident" id="3724374">ValueOf</span><span class="op" id="3724381">(</span><span class="ident" id="3724382">v</span><span class="op" id="3724383">)</span><span class="op" id="3724384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724387">return</span>&nbsp;<span class="ident" id="3724394">nil</span><br>
<span class="lineno"></span><span class="op" id="3724398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3724401">func</span>&nbsp;<span class="op" id="3724406">(</span><span class="ident" id="3724407">e</span>&nbsp;<span class="op" id="3724409">*</span><span class="ident" id="3724410">encodeState</span><span class="op" id="3724421">)</span>&nbsp;<span class="builtintype" id="3724423">error</span><span class="op" id="3724428">(</span><span class="ident" id="3724429">err</span>&nbsp;<span class="builtintype" id="3724433">error</span><span class="op" id="3724438">)</span>&nbsp;<span class="op" id="3724440">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3724443">panic</span><span class="op" id="3724448">(</span><span class="ident" id="3724449">err</span><span class="op" id="3724452">)</span><br>
<span class="lineno"></span><span class="op" id="3724454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3724457">var</span>&nbsp;<span class="ident" id="3724461">byteSliceType</span>&nbsp;<span class="op" id="3724475">=</span>&nbsp;<span class="ident" id="3724477">reflect</span><span class="op" id="3724484">.</span><span class="ident" id="3724485">TypeOf</span><span class="op" id="3724491">(</span><span class="op" id="3724492">[</span><span class="op" id="3724493">]</span><span class="builtintype" id="3724494">byte</span><span class="op" id="3724498">(</span><span class="ident" id="3724499">nil</span><span class="op" id="3724502">)</span><span class="op" id="3724503">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="keyword" id="3724506">func</span>&nbsp;<span class="ident" id="3724511">isEmptyValue</span><span class="op" id="3724523">(</span><span class="ident" id="3724524">v</span>&nbsp;<span class="ident" id="3724526">reflect</span><span class="op" id="3724533">.</span><span class="ident" id="3724534">Value</span><span class="op" id="3724539">)</span>&nbsp;<span class="builtintype" id="3724541">bool</span>&nbsp;<span class="op" id="3724546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724549">switch</span>&nbsp;<span class="ident" id="3724556">v</span><span class="op" id="3724557">.</span><span class="ident" id="3724558">Kind</span><span class="op" id="3724562">(</span><span class="op" id="3724563">)</span>&nbsp;<span class="op" id="3724565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724568">case</span>&nbsp;<span class="ident" id="3724573">reflect</span><span class="op" id="3724580">.</span><span class="ident" id="3724581">Array</span><span class="op" id="3724586">,</span>&nbsp;<span class="ident" id="3724588">reflect</span><span class="op" id="3724595">.</span><span class="ident" id="3724596">Map</span><span class="op" id="3724599">,</span>&nbsp;<span class="ident" id="3724601">reflect</span><span class="op" id="3724608">.</span><span class="ident" id="3724609">Slice</span><span class="op" id="3724614">,</span>&nbsp;<span class="ident" id="3724616">reflect</span><span class="op" id="3724623">.</span><span class="ident" id="3724624">String</span><span class="op" id="3724630">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724634">return</span>&nbsp;<span class="ident" id="3724641">v</span><span class="op" id="3724642">.</span><span class="ident" id="3724643">Len</span><span class="op" id="3724646">(</span><span class="op" id="3724647">)</span>&nbsp;<span class="op" id="3724649">==</span>&nbsp;<span class="num" id="3724652">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724655">case</span>&nbsp;<span class="ident" id="3724660">reflect</span><span class="op" id="3724667">.</span><span class="ident" id="3724668">Bool</span><span class="op" id="3724672">:</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724676">return</span>&nbsp;<span class="op" id="3724683">!</span><span class="ident" id="3724684">v</span><span class="op" id="3724685">.</span><span class="ident" id="3724686">Bool</span><span class="op" id="3724690">(</span><span class="op" id="3724691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724694">case</span>&nbsp;<span class="ident" id="3724699">reflect</span><span class="op" id="3724706">.</span><span class="ident" id="3724707">Int</span><span class="op" id="3724710">,</span>&nbsp;<span class="ident" id="3724712">reflect</span><span class="op" id="3724719">.</span><span class="ident" id="3724720">Int8</span><span class="op" id="3724724">,</span>&nbsp;<span class="ident" id="3724726">reflect</span><span class="op" id="3724733">.</span><span class="ident" id="3724734">Int16</span><span class="op" id="3724739">,</span>&nbsp;<span class="ident" id="3724741">reflect</span><span class="op" id="3724748">.</span><span class="ident" id="3724749">Int32</span><span class="op" id="3724754">,</span>&nbsp;<span class="ident" id="3724756">reflect</span><span class="op" id="3724763">.</span><span class="ident" id="3724764">Int64</span><span class="op" id="3724769">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724773">return</span>&nbsp;<span class="ident" id="3724780">v</span><span class="op" id="3724781">.</span><span class="ident" id="3724782">Int</span><span class="op" id="3724785">(</span><span class="op" id="3724786">)</span>&nbsp;<span class="op" id="3724788">==</span>&nbsp;<span class="num" id="3724791">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724794">case</span>&nbsp;<span class="ident" id="3724799">reflect</span><span class="op" id="3724806">.</span><span class="ident" id="3724807">Uint</span><span class="op" id="3724811">,</span>&nbsp;<span class="ident" id="3724813">reflect</span><span class="op" id="3724820">.</span><span class="ident" id="3724821">Uint8</span><span class="op" id="3724826">,</span>&nbsp;<span class="ident" id="3724828">reflect</span><span class="op" id="3724835">.</span><span class="ident" id="3724836">Uint16</span><span class="op" id="3724842">,</span>&nbsp;<span class="ident" id="3724844">reflect</span><span class="op" id="3724851">.</span><span class="ident" id="3724852">Uint32</span><span class="op" id="3724858">,</span>&nbsp;<span class="ident" id="3724860">reflect</span><span class="op" id="3724867">.</span><span class="ident" id="3724868">Uint64</span><span class="op" id="3724874">,</span>&nbsp;<span class="ident" id="3724876">reflect</span><span class="op" id="3724883">.</span><span class="ident" id="3724884">Uintptr</span><span class="op" id="3724891">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724895">return</span>&nbsp;<span class="ident" id="3724902">v</span><span class="op" id="3724903">.</span><span class="ident" id="3724904">Uint</span><span class="op" id="3724908">(</span><span class="op" id="3724909">)</span>&nbsp;<span class="op" id="3724911">==</span>&nbsp;<span class="num" id="3724914">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724917">case</span>&nbsp;<span class="ident" id="3724922">reflect</span><span class="op" id="3724929">.</span><span class="ident" id="3724930">Float32</span><span class="op" id="3724937">,</span>&nbsp;<span class="ident" id="3724939">reflect</span><span class="op" id="3724946">.</span><span class="ident" id="3724947">Float64</span><span class="op" id="3724954">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724958">return</span>&nbsp;<span class="ident" id="3724965">v</span><span class="op" id="3724966">.</span><span class="ident" id="3724967">Float</span><span class="op" id="3724972">(</span><span class="op" id="3724973">)</span>&nbsp;<span class="op" id="3724975">==</span>&nbsp;<span class="num" id="3724978">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724981">case</span>&nbsp;<span class="ident" id="3724986">reflect</span><span class="op" id="3724993">.</span><span class="ident" id="3724994">Interface</span><span class="op" id="3725003">,</span>&nbsp;<span class="ident" id="3725005">reflect</span><span class="op" id="3725012">.</span><span class="ident" id="3725013">Ptr</span><span class="op" id="3725016">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3725020">return</span>&nbsp;<span class="ident" id="3725027">v</span><span class="op" id="3725028">.</span><span class="ident" id="3725029">IsNil</span><span class="op" id="3725034">(</span><span class="op" id="3725035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3725038">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3725041">return</span>&nbsp;<span class="builtintype" id="3725048">false</span><br>
<span class="lineno"></span><span class="op" id="3725054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3725057">func</span>&nbsp;<span class="op" id="3725062">(</span><span class="ident" id="3725063">e</span>&nbsp;<span class="op" id="3725065">*</span><span class="ident" id="3725066">encodeState</span><span class="op" id="3725077">)</span>&nbsp;<span class="ident" id="3725079">reflectValue</span><span class="op" id="3725091">(</span><span class="ident" id="3725092">v</span>&nbsp;<span class="ident" id="3725094">reflect</span><span class="op" id="3725101">.</span><span class="ident" id="3725102">Value</span><span class="op" id="3725107">)</span>&nbsp;<span class="op" id="3725109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3725112">valueEncoder</span><span class="op" id="3725124">(</span><span class="ident" id="3725125">v</span><span class="op" id="3725126">)</span><span class="op" id="3725127">(</span><span class="ident" id="3725128">e</span><span class="op" id="3725129">,</span>&nbsp;<span class="ident" id="3725131">v</span><span class="op" id="3725132">,</span>&nbsp;<span class="builtintype" id="3725134">false</span><span class="op" id="3725139">)</span><br>
<span class="lineno">300</span><span class="op" id="3725141">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3725144">type</span>&nbsp;<span class="ident" id="3725149">encoderFunc</span>&nbsp;<span class="keyword" id="3725161">func</span><span class="op" id="3725165">(</span><span class="ident" id="3725166">e</span>&nbsp;<span class="op" id="3725168">*</span><span class="ident" id="3725169">encodeState</span><span class="op" id="3725180">,</span>&nbsp;<span class="ident" id="3725182">v</span>&nbsp;<span class="ident" id="3725184">reflect</span><span class="op" id="3725191">.</span><span class="ident" id="3725192">Value</span><span class="op" id="3725197">,</span>&nbsp;<span class="ident" id="3725199">quoted</span>&nbsp;<span class="builtintype" id="3725206">bool</span><span class="op" id="3725210">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3725213">var</span>&nbsp;<span class="ident" id="3725217">encoderCache</span>&nbsp;<span class="keyword" id="3725230">struct</span>&nbsp;<span class="op" id="3725237">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3725240">sync</span><span class="op" id="3725244">.</span><span class="ident" id="3725245">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3725254">m</span>&nbsp;<span class="keyword" id="3725256">map</span><span class="op" id="3725259">[</span><span class="ident" id="3725260">reflect</span><span class="op" id="3725267">.</span><span class="ident" id="3725268">Type</span><span class="op" id="3725272">]</span><span class="ident" id="3725273">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="3725285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3725288">func</span>&nbsp;<span class="ident" id="3725293">valueEncoder</span><span class="op" id="3725305">(</span><span class="ident" id="3725306">v</span>&nbsp;<span class="ident" id="3725308">reflect</span><span class="op" id="3725315">.</span><span class="ident" id="3725316">Value</span><span class="op" id="3725321">)</span>&nbsp;<span class="ident" id="3725323">encoderFunc</span>&nbsp;<span class="op" id="3725335">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3725338">if</span>&nbsp;<span class="op" id="3725341">!</span><span class="ident" id="3725342">v</span><span class="op" id="3725343">.</span><span class="ident" id="3725344">IsValid</span><span class="op" id="3725351">(</span><span class="op" id="3725352">)</span>&nbsp;<span class="op" id="3725354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3725358">return</span>&nbsp;<span class="ident" id="3725365">invalidValueEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3725386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3725389">return</span>&nbsp;<span class="ident" id="3725396">typeEncoder</span><span class="op" id="3725407">(</span><span class="ident" id="3725408">v</span><span class="op" id="3725409">.</span><span class="ident" id="3725410">Type</span><span class="op" id="3725414">(</span><span class="op" id="3725415">)</span><span class="op" id="3725416">)</span><br>
<span class="lineno"></span><span class="op" id="3725418">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="3725421">func</span>&nbsp;<span class="ident" id="3725426">typeEncoder</span><span class="op" id="3725437">(</span><span class="ident" id="3725438">t</span>&nbsp;<span class="ident" id="3725440">reflect</span><span class="op" id="3725447">.</span><span class="ident" id="3725448">Type</span><span class="op" id="3725452">)</span>&nbsp;<span class="ident" id="3725454">encoderFunc</span>&nbsp;<span class="op" id="3725466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3725469">encoderCache</span><span class="op" id="3725481">.</span><span class="ident" id="3725482">RLock</span><span class="op" id="3725487">(</span><span class="op" id="3725488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3725491">f</span>&nbsp;<span class="op" id="3725493">:=</span>&nbsp;<span class="ident" id="3725496">encoderCache</span><span class="op" id="3725508">.</span><span class="ident" id="3725509">m</span><span class="op" id="3725510">[</span><span class="ident" id="3725511">t</span><span class="op" id="3725512">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3725515">encoderCache</span><span class="op" id="3725527">.</span><span class="ident" id="3725528">RUnlock</span><span class="op" id="3725535">(</span><span class="op" id="3725536">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3725539">if</span>&nbsp;<span class="ident" id="3725542">f</span>&nbsp;<span class="op" id="3725544">!=</span>&nbsp;<span class="ident" id="3725547">nil</span>&nbsp;<span class="op" id="3725551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3725555">return</span>&nbsp;<span class="ident" id="3725562">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3725565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3725569">//&nbsp;To&nbsp;deal&nbsp;with&nbsp;recursive&nbsp;types,&nbsp;populate&nbsp;the&nbsp;map&nbsp;with&nbsp;an</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3725628">//&nbsp;indirect&nbsp;func&nbsp;before&nbsp;we&nbsp;build&nbsp;it.&nbsp;This&nbsp;type&nbsp;waits&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3725689">//&nbsp;real&nbsp;func&nbsp;(f)&nbsp;to&nbsp;be&nbsp;ready&nbsp;and&nbsp;then&nbsp;calls&nbsp;it.&nbsp;&nbsp;This&nbsp;indirect</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3725753">//&nbsp;func&nbsp;is&nbsp;only&nbsp;used&nbsp;for&nbsp;recursive&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3725796">encoderCache</span><span class="op" id="3725808">.</span><span class="ident" id="3725809">Lock</span><span class="op" id="3725813">(</span><span class="op" id="3725814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3725817">if</span>&nbsp;<span class="ident" id="3725820">encoderCache</span><span class="op" id="3725832">.</span><span class="ident" id="3725833">m</span>&nbsp;<span class="op" id="3725835">==</span>&nbsp;<span class="ident" id="3725838">nil</span>&nbsp;<span class="op" id="3725842">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3725846">encoderCache</span><span class="op" id="3725858">.</span><span class="ident" id="3725859">m</span>&nbsp;<span class="op" id="3725861">=</span>&nbsp;<span class="builtinfunc" id="3725863">make</span><span class="op" id="3725867">(</span><span class="keyword" id="3725868">map</span><span class="op" id="3725871">[</span><span class="ident" id="3725872">reflect</span><span class="op" id="3725879">.</span><span class="ident" id="3725880">Type</span><span class="op" id="3725884">]</span><span class="ident" id="3725885">encoderFunc</span><span class="op" id="3725896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3725899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3725902">var</span>&nbsp;<span class="ident" id="3725906">wg</span>&nbsp;<span class="ident" id="3725909">sync</span><span class="op" id="3725913">.</span><span class="ident" id="3725914">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3725925">wg</span><span class="op" id="3725927">.</span><span class="ident" id="3725928">Add</span><span class="op" id="3725931">(</span><span class="num" id="3725932">1</span><span class="op" id="3725933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3725936">encoderCache</span><span class="op" id="3725948">.</span><span class="ident" id="3725949">m</span><span class="op" id="3725950">[</span><span class="ident" id="3725951">t</span><span class="op" id="3725952">]</span>&nbsp;<span class="op" id="3725954">=</span>&nbsp;<span class="keyword" id="3725956">func</span><span class="op" id="3725960">(</span><span class="ident" id="3725961">e</span>&nbsp;<span class="op" id="3725963">*</span><span class="ident" id="3725964">encodeState</span><span class="op" id="3725975">,</span>&nbsp;<span class="ident" id="3725977">v</span>&nbsp;<span class="ident" id="3725979">reflect</span><span class="op" id="3725986">.</span><span class="ident" id="3725987">Value</span><span class="op" id="3725992">,</span>&nbsp;<span class="ident" id="3725994">quoted</span>&nbsp;<span class="builtintype" id="3726001">bool</span><span class="op" id="3726005">)</span>&nbsp;<span class="op" id="3726007">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726011">wg</span><span class="op" id="3726013">.</span><span class="ident" id="3726014">Wait</span><span class="op" id="3726018">(</span><span class="op" id="3726019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726023">f</span><span class="op" id="3726024">(</span><span class="ident" id="3726025">e</span><span class="op" id="3726026">,</span>&nbsp;<span class="ident" id="3726028">v</span><span class="op" id="3726029">,</span>&nbsp;<span class="ident" id="3726031">quoted</span><span class="op" id="3726037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3726040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726043">encoderCache</span><span class="op" id="3726055">.</span><span class="ident" id="3726056">Unlock</span><span class="op" id="3726062">(</span><span class="op" id="3726063">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3726067">//&nbsp;Compute&nbsp;fields&nbsp;without&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3726100">//&nbsp;Might&nbsp;duplicate&nbsp;effort&nbsp;but&nbsp;won&#39;t&nbsp;hold&nbsp;other&nbsp;computations&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726167">f</span>&nbsp;<span class="op" id="3726169">=</span>&nbsp;<span class="ident" id="3726171">newTypeEncoder</span><span class="op" id="3726185">(</span><span class="ident" id="3726186">t</span><span class="op" id="3726187">,</span>&nbsp;<span class="builtintype" id="3726189">true</span><span class="op" id="3726193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726196">wg</span><span class="op" id="3726198">.</span><span class="ident" id="3726199">Done</span><span class="op" id="3726203">(</span><span class="op" id="3726204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726207">encoderCache</span><span class="op" id="3726219">.</span><span class="ident" id="3726220">Lock</span><span class="op" id="3726224">(</span><span class="op" id="3726225">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726228">encoderCache</span><span class="op" id="3726240">.</span><span class="ident" id="3726241">m</span><span class="op" id="3726242">[</span><span class="ident" id="3726243">t</span><span class="op" id="3726244">]</span>&nbsp;<span class="op" id="3726246">=</span>&nbsp;<span class="ident" id="3726248">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726251">encoderCache</span><span class="op" id="3726263">.</span><span class="ident" id="3726264">Unlock</span><span class="op" id="3726270">(</span><span class="op" id="3726271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3726274">return</span>&nbsp;<span class="ident" id="3726281">f</span><br>
<span class="lineno"></span><span class="op" id="3726283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span><span class="keyword" id="3726286">var</span>&nbsp;<span class="op" id="3726290">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726293">marshalerType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3726311">=</span>&nbsp;<span class="ident" id="3726313">reflect</span><span class="op" id="3726320">.</span><span class="ident" id="3726321">TypeOf</span><span class="op" id="3726327">(</span><span class="builtinfunc" id="3726328">new</span><span class="op" id="3726331">(</span><span class="ident" id="3726332">Marshaler</span><span class="op" id="3726341">)</span><span class="op" id="3726342">)</span><span class="op" id="3726343">.</span><span class="ident" id="3726344">Elem</span><span class="op" id="3726348">(</span><span class="op" id="3726349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726352">textMarshalerType</span>&nbsp;<span class="op" id="3726370">=</span>&nbsp;<span class="ident" id="3726372">reflect</span><span class="op" id="3726379">.</span><span class="ident" id="3726380">TypeOf</span><span class="op" id="3726386">(</span><span class="builtinfunc" id="3726387">new</span><span class="op" id="3726390">(</span><span class="ident" id="3726391">encoding</span><span class="op" id="3726399">.</span><span class="ident" id="3726400">TextMarshaler</span><span class="op" id="3726413">)</span><span class="op" id="3726414">)</span><span class="op" id="3726415">.</span><span class="ident" id="3726416">Elem</span><span class="op" id="3726420">(</span><span class="op" id="3726421">)</span><br>
<span class="lineno"></span><span class="op" id="3726423">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment" id="3726426">//&nbsp;newTypeEncoder&nbsp;constructs&nbsp;an&nbsp;encoderFunc&nbsp;for&nbsp;a&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="3726482">//&nbsp;The&nbsp;returned&nbsp;encoder&nbsp;only&nbsp;checks&nbsp;CanAddr&nbsp;when&nbsp;allowAddr&nbsp;is&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="3726550">func</span>&nbsp;<span class="ident" id="3726555">newTypeEncoder</span><span class="op" id="3726569">(</span><span class="ident" id="3726570">t</span>&nbsp;<span class="ident" id="3726572">reflect</span><span class="op" id="3726579">.</span><span class="ident" id="3726580">Type</span><span class="op" id="3726584">,</span>&nbsp;<span class="ident" id="3726586">allowAddr</span>&nbsp;<span class="builtintype" id="3726596">bool</span><span class="op" id="3726600">)</span>&nbsp;<span class="ident" id="3726602">encoderFunc</span>&nbsp;<span class="op" id="3726614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3726617">if</span>&nbsp;<span class="ident" id="3726620">t</span><span class="op" id="3726621">.</span><span class="ident" id="3726622">Implements</span><span class="op" id="3726632">(</span><span class="ident" id="3726633">marshalerType</span><span class="op" id="3726646">)</span>&nbsp;<span class="op" id="3726648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3726652">return</span>&nbsp;<span class="ident" id="3726659">marshalerEncoder</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3726677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3726680">if</span>&nbsp;<span class="ident" id="3726683">t</span><span class="op" id="3726684">.</span><span class="ident" id="3726685">Kind</span><span class="op" id="3726689">(</span><span class="op" id="3726690">)</span>&nbsp;<span class="op" id="3726692">!=</span>&nbsp;<span class="ident" id="3726695">reflect</span><span class="op" id="3726702">.</span><span class="ident" id="3726703">Ptr</span>&nbsp;<span class="op" id="3726707">&amp;&amp;</span>&nbsp;<span class="ident" id="3726710">allowAddr</span>&nbsp;<span class="op" id="3726720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3726724">if</span>&nbsp;<span class="ident" id="3726727">reflect</span><span class="op" id="3726734">.</span><span class="ident" id="3726735">PtrTo</span><span class="op" id="3726740">(</span><span class="ident" id="3726741">t</span><span class="op" id="3726742">)</span><span class="op" id="3726743">.</span><span class="ident" id="3726744">Implements</span><span class="op" id="3726754">(</span><span class="ident" id="3726755">marshalerType</span><span class="op" id="3726768">)</span>&nbsp;<span class="op" id="3726770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3726775">return</span>&nbsp;<span class="ident" id="3726782">newCondAddrEncoder</span><span class="op" id="3726800">(</span><span class="ident" id="3726801">addrMarshalerEncoder</span><span class="op" id="3726821">,</span>&nbsp;<span class="ident" id="3726823">newTypeEncoder</span><span class="op" id="3726837">(</span><span class="ident" id="3726838">t</span><span class="op" id="3726839">,</span>&nbsp;<span class="builtintype" id="3726841">false</span><span class="op" id="3726846">)</span><span class="op" id="3726847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3726851">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3726854">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3726858">if</span>&nbsp;<span class="ident" id="3726861">t</span><span class="op" id="3726862">.</span><span class="ident" id="3726863">Implements</span><span class="op" id="3726873">(</span><span class="ident" id="3726874">textMarshalerType</span><span class="op" id="3726891">)</span>&nbsp;<span class="op" id="3726893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3726897">return</span>&nbsp;<span class="ident" id="3726904">textMarshalerEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3726926">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3726929">if</span>&nbsp;<span class="ident" id="3726932">t</span><span class="op" id="3726933">.</span><span class="ident" id="3726934">Kind</span><span class="op" id="3726938">(</span><span class="op" id="3726939">)</span>&nbsp;<span class="op" id="3726941">!=</span>&nbsp;<span class="ident" id="3726944">reflect</span><span class="op" id="3726951">.</span><span class="ident" id="3726952">Ptr</span>&nbsp;<span class="op" id="3726956">&amp;&amp;</span>&nbsp;<span class="ident" id="3726959">allowAddr</span>&nbsp;<span class="op" id="3726969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3726973">if</span>&nbsp;<span class="ident" id="3726976">reflect</span><span class="op" id="3726983">.</span><span class="ident" id="3726984">PtrTo</span><span class="op" id="3726989">(</span><span class="ident" id="3726990">t</span><span class="op" id="3726991">)</span><span class="op" id="3726992">.</span><span class="ident" id="3726993">Implements</span><span class="op" id="3727003">(</span><span class="ident" id="3727004">textMarshalerType</span><span class="op" id="3727021">)</span>&nbsp;<span class="op" id="3727023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727028">return</span>&nbsp;<span class="ident" id="3727035">newCondAddrEncoder</span><span class="op" id="3727053">(</span><span class="ident" id="3727054">addrTextMarshalerEncoder</span><span class="op" id="3727078">,</span>&nbsp;<span class="ident" id="3727080">newTypeEncoder</span><span class="op" id="3727094">(</span><span class="ident" id="3727095">t</span><span class="op" id="3727096">,</span>&nbsp;<span class="builtintype" id="3727098">false</span><span class="op" id="3727103">)</span><span class="op" id="3727104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3727108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3727111">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727115">switch</span>&nbsp;<span class="ident" id="3727122">t</span><span class="op" id="3727123">.</span><span class="ident" id="3727124">Kind</span><span class="op" id="3727128">(</span><span class="op" id="3727129">)</span>&nbsp;<span class="op" id="3727131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727134">case</span>&nbsp;<span class="ident" id="3727139">reflect</span><span class="op" id="3727146">.</span><span class="ident" id="3727147">Bool</span><span class="op" id="3727151">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727155">return</span>&nbsp;<span class="ident" id="3727162">boolEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727175">case</span>&nbsp;<span class="ident" id="3727180">reflect</span><span class="op" id="3727187">.</span><span class="ident" id="3727188">Int</span><span class="op" id="3727191">,</span>&nbsp;<span class="ident" id="3727193">reflect</span><span class="op" id="3727200">.</span><span class="ident" id="3727201">Int8</span><span class="op" id="3727205">,</span>&nbsp;<span class="ident" id="3727207">reflect</span><span class="op" id="3727214">.</span><span class="ident" id="3727215">Int16</span><span class="op" id="3727220">,</span>&nbsp;<span class="ident" id="3727222">reflect</span><span class="op" id="3727229">.</span><span class="ident" id="3727230">Int32</span><span class="op" id="3727235">,</span>&nbsp;<span class="ident" id="3727237">reflect</span><span class="op" id="3727244">.</span><span class="ident" id="3727245">Int64</span><span class="op" id="3727250">:</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727254">return</span>&nbsp;<span class="ident" id="3727261">intEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727273">case</span>&nbsp;<span class="ident" id="3727278">reflect</span><span class="op" id="3727285">.</span><span class="ident" id="3727286">Uint</span><span class="op" id="3727290">,</span>&nbsp;<span class="ident" id="3727292">reflect</span><span class="op" id="3727299">.</span><span class="ident" id="3727300">Uint8</span><span class="op" id="3727305">,</span>&nbsp;<span class="ident" id="3727307">reflect</span><span class="op" id="3727314">.</span><span class="ident" id="3727315">Uint16</span><span class="op" id="3727321">,</span>&nbsp;<span class="ident" id="3727323">reflect</span><span class="op" id="3727330">.</span><span class="ident" id="3727331">Uint32</span><span class="op" id="3727337">,</span>&nbsp;<span class="ident" id="3727339">reflect</span><span class="op" id="3727346">.</span><span class="ident" id="3727347">Uint64</span><span class="op" id="3727353">,</span>&nbsp;<span class="ident" id="3727355">reflect</span><span class="op" id="3727362">.</span><span class="ident" id="3727363">Uintptr</span><span class="op" id="3727370">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727374">return</span>&nbsp;<span class="ident" id="3727381">uintEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727394">case</span>&nbsp;<span class="ident" id="3727399">reflect</span><span class="op" id="3727406">.</span><span class="ident" id="3727407">Float32</span><span class="op" id="3727414">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727418">return</span>&nbsp;<span class="ident" id="3727425">float32Encoder</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727441">case</span>&nbsp;<span class="ident" id="3727446">reflect</span><span class="op" id="3727453">.</span><span class="ident" id="3727454">Float64</span><span class="op" id="3727461">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727465">return</span>&nbsp;<span class="ident" id="3727472">float64Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727488">case</span>&nbsp;<span class="ident" id="3727493">reflect</span><span class="op" id="3727500">.</span><span class="ident" id="3727501">String</span><span class="op" id="3727507">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727511">return</span>&nbsp;<span class="ident" id="3727518">stringEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727533">case</span>&nbsp;<span class="ident" id="3727538">reflect</span><span class="op" id="3727545">.</span><span class="ident" id="3727546">Interface</span><span class="op" id="3727555">:</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727559">return</span>&nbsp;<span class="ident" id="3727566">interfaceEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727584">case</span>&nbsp;<span class="ident" id="3727589">reflect</span><span class="op" id="3727596">.</span><span class="ident" id="3727597">Struct</span><span class="op" id="3727603">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727607">return</span>&nbsp;<span class="ident" id="3727614">newStructEncoder</span><span class="op" id="3727630">(</span><span class="ident" id="3727631">t</span><span class="op" id="3727632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727635">case</span>&nbsp;<span class="ident" id="3727640">reflect</span><span class="op" id="3727647">.</span><span class="ident" id="3727648">Map</span><span class="op" id="3727651">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727655">return</span>&nbsp;<span class="ident" id="3727662">newMapEncoder</span><span class="op" id="3727675">(</span><span class="ident" id="3727676">t</span><span class="op" id="3727677">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727680">case</span>&nbsp;<span class="ident" id="3727685">reflect</span><span class="op" id="3727692">.</span><span class="ident" id="3727693">Slice</span><span class="op" id="3727698">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727702">return</span>&nbsp;<span class="ident" id="3727709">newSliceEncoder</span><span class="op" id="3727724">(</span><span class="ident" id="3727725">t</span><span class="op" id="3727726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727729">case</span>&nbsp;<span class="ident" id="3727734">reflect</span><span class="op" id="3727741">.</span><span class="ident" id="3727742">Array</span><span class="op" id="3727747">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727751">return</span>&nbsp;<span class="ident" id="3727758">newArrayEncoder</span><span class="op" id="3727773">(</span><span class="ident" id="3727774">t</span><span class="op" id="3727775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727778">case</span>&nbsp;<span class="ident" id="3727783">reflect</span><span class="op" id="3727790">.</span><span class="ident" id="3727791">Ptr</span><span class="op" id="3727794">:</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727798">return</span>&nbsp;<span class="ident" id="3727805">newPtrEncoder</span><span class="op" id="3727818">(</span><span class="ident" id="3727819">t</span><span class="op" id="3727820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727823">default</span><span class="op" id="3727830">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727834">return</span>&nbsp;<span class="ident" id="3727841">unsupportedTypeEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3727865">}</span><br>
<span class="lineno"></span><span class="op" id="3727867">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span><span class="keyword" id="3727870">func</span>&nbsp;<span class="ident" id="3727875">invalidValueEncoder</span><span class="op" id="3727894">(</span><span class="ident" id="3727895">e</span>&nbsp;<span class="op" id="3727897">*</span><span class="ident" id="3727898">encodeState</span><span class="op" id="3727909">,</span>&nbsp;<span class="ident" id="3727911">v</span>&nbsp;<span class="ident" id="3727913">reflect</span><span class="op" id="3727920">.</span><span class="ident" id="3727921">Value</span><span class="op" id="3727926">,</span>&nbsp;<span class="ident" id="3727928">quoted</span>&nbsp;<span class="builtintype" id="3727935">bool</span><span class="op" id="3727939">)</span>&nbsp;<span class="op" id="3727941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3727944">e</span><span class="op" id="3727945">.</span><span class="ident" id="3727946">WriteString</span><span class="op" id="3727957">(</span><span class="string" id="3727958">&#34;null&#34;</span><span class="op" id="3727964">)</span><br>
<span class="lineno"></span><span class="op" id="3727966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="keyword" id="3727969">func</span>&nbsp;<span class="ident" id="3727974">marshalerEncoder</span><span class="op" id="3727990">(</span><span class="ident" id="3727991">e</span>&nbsp;<span class="op" id="3727993">*</span><span class="ident" id="3727994">encodeState</span><span class="op" id="3728005">,</span>&nbsp;<span class="ident" id="3728007">v</span>&nbsp;<span class="ident" id="3728009">reflect</span><span class="op" id="3728016">.</span><span class="ident" id="3728017">Value</span><span class="op" id="3728022">,</span>&nbsp;<span class="ident" id="3728024">quoted</span>&nbsp;<span class="builtintype" id="3728031">bool</span><span class="op" id="3728035">)</span>&nbsp;<span class="op" id="3728037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728040">if</span>&nbsp;<span class="ident" id="3728043">v</span><span class="op" id="3728044">.</span><span class="ident" id="3728045">Kind</span><span class="op" id="3728049">(</span><span class="op" id="3728050">)</span>&nbsp;<span class="op" id="3728052">==</span>&nbsp;<span class="ident" id="3728055">reflect</span><span class="op" id="3728062">.</span><span class="ident" id="3728063">Ptr</span>&nbsp;<span class="op" id="3728067">&amp;&amp;</span>&nbsp;<span class="ident" id="3728070">v</span><span class="op" id="3728071">.</span><span class="ident" id="3728072">IsNil</span><span class="op" id="3728077">(</span><span class="op" id="3728078">)</span>&nbsp;<span class="op" id="3728080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728084">e</span><span class="op" id="3728085">.</span><span class="ident" id="3728086">WriteString</span><span class="op" id="3728097">(</span><span class="string" id="3728098">&#34;null&#34;</span><span class="op" id="3728104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728108">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3728116">}</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728119">m</span>&nbsp;<span class="op" id="3728121">:=</span>&nbsp;<span class="ident" id="3728124">v</span><span class="op" id="3728125">.</span><span class="ident" id="3728126">Interface</span><span class="op" id="3728135">(</span><span class="op" id="3728136">)</span><span class="op" id="3728137">.</span><span class="op" id="3728138">(</span><span class="ident" id="3728139">Marshaler</span><span class="op" id="3728148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728151">b</span><span class="op" id="3728152">,</span>&nbsp;<span class="ident" id="3728154">err</span>&nbsp;<span class="op" id="3728158">:=</span>&nbsp;<span class="ident" id="3728161">m</span><span class="op" id="3728162">.</span><span class="ident" id="3728163">MarshalJSON</span><span class="op" id="3728174">(</span><span class="op" id="3728175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728178">if</span>&nbsp;<span class="ident" id="3728181">err</span>&nbsp;<span class="op" id="3728185">==</span>&nbsp;<span class="ident" id="3728188">nil</span>&nbsp;<span class="op" id="3728192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3728196">//&nbsp;copy&nbsp;JSON&nbsp;into&nbsp;buffer,&nbsp;checking&nbsp;validity.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728243">err</span>&nbsp;<span class="op" id="3728247">=</span>&nbsp;<span class="ident" id="3728249">compact</span><span class="op" id="3728256">(</span><span class="op" id="3728257">&amp;</span><span class="ident" id="3728258">e</span><span class="op" id="3728259">.</span><span class="ident" id="3728260">Buffer</span><span class="op" id="3728266">,</span>&nbsp;<span class="ident" id="3728268">b</span><span class="op" id="3728269">,</span>&nbsp;<span class="builtintype" id="3728271">true</span><span class="op" id="3728275">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3728278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728281">if</span>&nbsp;<span class="ident" id="3728284">err</span>&nbsp;<span class="op" id="3728288">!=</span>&nbsp;<span class="ident" id="3728291">nil</span>&nbsp;<span class="op" id="3728295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728299">e</span><span class="op" id="3728300">.</span><span class="builtintype" id="3728301">error</span><span class="op" id="3728306">(</span><span class="op" id="3728307">&amp;</span><span class="ident" id="3728308">MarshalerError</span><span class="op" id="3728322">{</span><span class="ident" id="3728323">v</span><span class="op" id="3728324">.</span><span class="ident" id="3728325">Type</span><span class="op" id="3728329">(</span><span class="op" id="3728330">)</span><span class="op" id="3728331">,</span>&nbsp;<span class="ident" id="3728333">err</span><span class="op" id="3728336">}</span><span class="op" id="3728337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3728340">}</span><br>
<span class="lineno"></span><span class="op" id="3728342">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="keyword" id="3728345">func</span>&nbsp;<span class="ident" id="3728350">addrMarshalerEncoder</span><span class="op" id="3728370">(</span><span class="ident" id="3728371">e</span>&nbsp;<span class="op" id="3728373">*</span><span class="ident" id="3728374">encodeState</span><span class="op" id="3728385">,</span>&nbsp;<span class="ident" id="3728387">v</span>&nbsp;<span class="ident" id="3728389">reflect</span><span class="op" id="3728396">.</span><span class="ident" id="3728397">Value</span><span class="op" id="3728402">,</span>&nbsp;<span class="ident" id="3728404">quoted</span>&nbsp;<span class="builtintype" id="3728411">bool</span><span class="op" id="3728415">)</span>&nbsp;<span class="op" id="3728417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728420">va</span>&nbsp;<span class="op" id="3728423">:=</span>&nbsp;<span class="ident" id="3728426">v</span><span class="op" id="3728427">.</span><span class="ident" id="3728428">Addr</span><span class="op" id="3728432">(</span><span class="op" id="3728433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728436">if</span>&nbsp;<span class="ident" id="3728439">va</span><span class="op" id="3728441">.</span><span class="ident" id="3728442">IsNil</span><span class="op" id="3728447">(</span><span class="op" id="3728448">)</span>&nbsp;<span class="op" id="3728450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728454">e</span><span class="op" id="3728455">.</span><span class="ident" id="3728456">WriteString</span><span class="op" id="3728467">(</span><span class="string" id="3728468">&#34;null&#34;</span><span class="op" id="3728474">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728478">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3728486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728489">m</span>&nbsp;<span class="op" id="3728491">:=</span>&nbsp;<span class="ident" id="3728494">va</span><span class="op" id="3728496">.</span><span class="ident" id="3728497">Interface</span><span class="op" id="3728506">(</span><span class="op" id="3728507">)</span><span class="op" id="3728508">.</span><span class="op" id="3728509">(</span><span class="ident" id="3728510">Marshaler</span><span class="op" id="3728519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728522">b</span><span class="op" id="3728523">,</span>&nbsp;<span class="ident" id="3728525">err</span>&nbsp;<span class="op" id="3728529">:=</span>&nbsp;<span class="ident" id="3728532">m</span><span class="op" id="3728533">.</span><span class="ident" id="3728534">MarshalJSON</span><span class="op" id="3728545">(</span><span class="op" id="3728546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728549">if</span>&nbsp;<span class="ident" id="3728552">err</span>&nbsp;<span class="op" id="3728556">==</span>&nbsp;<span class="ident" id="3728559">nil</span>&nbsp;<span class="op" id="3728563">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3728567">//&nbsp;copy&nbsp;JSON&nbsp;into&nbsp;buffer,&nbsp;checking&nbsp;validity.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728614">err</span>&nbsp;<span class="op" id="3728618">=</span>&nbsp;<span class="ident" id="3728620">compact</span><span class="op" id="3728627">(</span><span class="op" id="3728628">&amp;</span><span class="ident" id="3728629">e</span><span class="op" id="3728630">.</span><span class="ident" id="3728631">Buffer</span><span class="op" id="3728637">,</span>&nbsp;<span class="ident" id="3728639">b</span><span class="op" id="3728640">,</span>&nbsp;<span class="builtintype" id="3728642">true</span><span class="op" id="3728646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3728649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728652">if</span>&nbsp;<span class="ident" id="3728655">err</span>&nbsp;<span class="op" id="3728659">!=</span>&nbsp;<span class="ident" id="3728662">nil</span>&nbsp;<span class="op" id="3728666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728670">e</span><span class="op" id="3728671">.</span><span class="builtintype" id="3728672">error</span><span class="op" id="3728677">(</span><span class="op" id="3728678">&amp;</span><span class="ident" id="3728679">MarshalerError</span><span class="op" id="3728693">{</span><span class="ident" id="3728694">v</span><span class="op" id="3728695">.</span><span class="ident" id="3728696">Type</span><span class="op" id="3728700">(</span><span class="op" id="3728701">)</span><span class="op" id="3728702">,</span>&nbsp;<span class="ident" id="3728704">err</span><span class="op" id="3728707">}</span><span class="op" id="3728708">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3728711">}</span><br>
<span class="lineno"></span><span class="op" id="3728713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3728716">func</span>&nbsp;<span class="ident" id="3728721">textMarshalerEncoder</span><span class="op" id="3728741">(</span><span class="ident" id="3728742">e</span>&nbsp;<span class="op" id="3728744">*</span><span class="ident" id="3728745">encodeState</span><span class="op" id="3728756">,</span>&nbsp;<span class="ident" id="3728758">v</span>&nbsp;<span class="ident" id="3728760">reflect</span><span class="op" id="3728767">.</span><span class="ident" id="3728768">Value</span><span class="op" id="3728773">,</span>&nbsp;<span class="ident" id="3728775">quoted</span>&nbsp;<span class="builtintype" id="3728782">bool</span><span class="op" id="3728786">)</span>&nbsp;<span class="op" id="3728788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728791">if</span>&nbsp;<span class="ident" id="3728794">v</span><span class="op" id="3728795">.</span><span class="ident" id="3728796">Kind</span><span class="op" id="3728800">(</span><span class="op" id="3728801">)</span>&nbsp;<span class="op" id="3728803">==</span>&nbsp;<span class="ident" id="3728806">reflect</span><span class="op" id="3728813">.</span><span class="ident" id="3728814">Ptr</span>&nbsp;<span class="op" id="3728818">&amp;&amp;</span>&nbsp;<span class="ident" id="3728821">v</span><span class="op" id="3728822">.</span><span class="ident" id="3728823">IsNil</span><span class="op" id="3728828">(</span><span class="op" id="3728829">)</span>&nbsp;<span class="op" id="3728831">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728835">e</span><span class="op" id="3728836">.</span><span class="ident" id="3728837">WriteString</span><span class="op" id="3728848">(</span><span class="string" id="3728849">&#34;null&#34;</span><span class="op" id="3728855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728859">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3728867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728870">m</span>&nbsp;<span class="op" id="3728872">:=</span>&nbsp;<span class="ident" id="3728875">v</span><span class="op" id="3728876">.</span><span class="ident" id="3728877">Interface</span><span class="op" id="3728886">(</span><span class="op" id="3728887">)</span><span class="op" id="3728888">.</span><span class="op" id="3728889">(</span><span class="ident" id="3728890">encoding</span><span class="op" id="3728898">.</span><span class="ident" id="3728899">TextMarshaler</span><span class="op" id="3728912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728915">b</span><span class="op" id="3728916">,</span>&nbsp;<span class="ident" id="3728918">err</span>&nbsp;<span class="op" id="3728922">:=</span>&nbsp;<span class="ident" id="3728925">m</span><span class="op" id="3728926">.</span><span class="ident" id="3728927">MarshalText</span><span class="op" id="3728938">(</span><span class="op" id="3728939">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728942">if</span>&nbsp;<span class="ident" id="3728945">err</span>&nbsp;<span class="op" id="3728949">==</span>&nbsp;<span class="ident" id="3728952">nil</span>&nbsp;<span class="op" id="3728956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728960">_</span><span class="op" id="3728961">,</span>&nbsp;<span class="ident" id="3728963">err</span>&nbsp;<span class="op" id="3728967">=</span>&nbsp;<span class="ident" id="3728969">e</span><span class="op" id="3728970">.</span><span class="ident" id="3728971">stringBytes</span><span class="op" id="3728982">(</span><span class="ident" id="3728983">b</span><span class="op" id="3728984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3728987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728990">if</span>&nbsp;<span class="ident" id="3728993">err</span>&nbsp;<span class="op" id="3728997">!=</span>&nbsp;<span class="ident" id="3729000">nil</span>&nbsp;<span class="op" id="3729004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729008">e</span><span class="op" id="3729009">.</span><span class="builtintype" id="3729010">error</span><span class="op" id="3729015">(</span><span class="op" id="3729016">&amp;</span><span class="ident" id="3729017">MarshalerError</span><span class="op" id="3729031">{</span><span class="ident" id="3729032">v</span><span class="op" id="3729033">.</span><span class="ident" id="3729034">Type</span><span class="op" id="3729038">(</span><span class="op" id="3729039">)</span><span class="op" id="3729040">,</span>&nbsp;<span class="ident" id="3729042">err</span><span class="op" id="3729045">}</span><span class="op" id="3729046">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3729049">}</span><br>
<span class="lineno"></span><span class="op" id="3729051">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3729054">func</span>&nbsp;<span class="ident" id="3729059">addrTextMarshalerEncoder</span><span class="op" id="3729083">(</span><span class="ident" id="3729084">e</span>&nbsp;<span class="op" id="3729086">*</span><span class="ident" id="3729087">encodeState</span><span class="op" id="3729098">,</span>&nbsp;<span class="ident" id="3729100">v</span>&nbsp;<span class="ident" id="3729102">reflect</span><span class="op" id="3729109">.</span><span class="ident" id="3729110">Value</span><span class="op" id="3729115">,</span>&nbsp;<span class="ident" id="3729117">quoted</span>&nbsp;<span class="builtintype" id="3729124">bool</span><span class="op" id="3729128">)</span>&nbsp;<span class="op" id="3729130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729133">va</span>&nbsp;<span class="op" id="3729136">:=</span>&nbsp;<span class="ident" id="3729139">v</span><span class="op" id="3729140">.</span><span class="ident" id="3729141">Addr</span><span class="op" id="3729145">(</span><span class="op" id="3729146">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3729149">if</span>&nbsp;<span class="ident" id="3729152">va</span><span class="op" id="3729154">.</span><span class="ident" id="3729155">IsNil</span><span class="op" id="3729160">(</span><span class="op" id="3729161">)</span>&nbsp;<span class="op" id="3729163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729167">e</span><span class="op" id="3729168">.</span><span class="ident" id="3729169">WriteString</span><span class="op" id="3729180">(</span><span class="string" id="3729181">&#34;null&#34;</span><span class="op" id="3729187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3729191">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3729199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729202">m</span>&nbsp;<span class="op" id="3729204">:=</span>&nbsp;<span class="ident" id="3729207">va</span><span class="op" id="3729209">.</span><span class="ident" id="3729210">Interface</span><span class="op" id="3729219">(</span><span class="op" id="3729220">)</span><span class="op" id="3729221">.</span><span class="op" id="3729222">(</span><span class="ident" id="3729223">encoding</span><span class="op" id="3729231">.</span><span class="ident" id="3729232">TextMarshaler</span><span class="op" id="3729245">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729248">b</span><span class="op" id="3729249">,</span>&nbsp;<span class="ident" id="3729251">err</span>&nbsp;<span class="op" id="3729255">:=</span>&nbsp;<span class="ident" id="3729258">m</span><span class="op" id="3729259">.</span><span class="ident" id="3729260">MarshalText</span><span class="op" id="3729271">(</span><span class="op" id="3729272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3729275">if</span>&nbsp;<span class="ident" id="3729278">err</span>&nbsp;<span class="op" id="3729282">==</span>&nbsp;<span class="ident" id="3729285">nil</span>&nbsp;<span class="op" id="3729289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729293">_</span><span class="op" id="3729294">,</span>&nbsp;<span class="ident" id="3729296">err</span>&nbsp;<span class="op" id="3729300">=</span>&nbsp;<span class="ident" id="3729302">e</span><span class="op" id="3729303">.</span><span class="ident" id="3729304">stringBytes</span><span class="op" id="3729315">(</span><span class="ident" id="3729316">b</span><span class="op" id="3729317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3729320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3729323">if</span>&nbsp;<span class="ident" id="3729326">err</span>&nbsp;<span class="op" id="3729330">!=</span>&nbsp;<span class="ident" id="3729333">nil</span>&nbsp;<span class="op" id="3729337">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729341">e</span><span class="op" id="3729342">.</span><span class="builtintype" id="3729343">error</span><span class="op" id="3729348">(</span><span class="op" id="3729349">&amp;</span><span class="ident" id="3729350">MarshalerError</span><span class="op" id="3729364">{</span><span class="ident" id="3729365">v</span><span class="op" id="3729366">.</span><span class="ident" id="3729367">Type</span><span class="op" id="3729371">(</span><span class="op" id="3729372">)</span><span class="op" id="3729373">,</span>&nbsp;<span class="ident" id="3729375">err</span><span class="op" id="3729378">}</span><span class="op" id="3729379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3729382">}</span><br>
<span class="lineno"></span><span class="op" id="3729384">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3729387">func</span>&nbsp;<span class="ident" id="3729392">boolEncoder</span><span class="op" id="3729403">(</span><span class="ident" id="3729404">e</span>&nbsp;<span class="op" id="3729406">*</span><span class="ident" id="3729407">encodeState</span><span class="op" id="3729418">,</span>&nbsp;<span class="ident" id="3729420">v</span>&nbsp;<span class="ident" id="3729422">reflect</span><span class="op" id="3729429">.</span><span class="ident" id="3729430">Value</span><span class="op" id="3729435">,</span>&nbsp;<span class="ident" id="3729437">quoted</span>&nbsp;<span class="builtintype" id="3729444">bool</span><span class="op" id="3729448">)</span>&nbsp;<span class="op" id="3729450">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3729453">if</span>&nbsp;<span class="ident" id="3729456">quoted</span>&nbsp;<span class="op" id="3729463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729467">e</span><span class="op" id="3729468">.</span><span class="ident" id="3729469">WriteByte</span><span class="op" id="3729478">(</span><span class="string" id="3729479">&#39;&#34;&#39;</span><span class="op" id="3729482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3729485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3729488">if</span>&nbsp;<span class="ident" id="3729491">v</span><span class="op" id="3729492">.</span><span class="ident" id="3729493">Bool</span><span class="op" id="3729497">(</span><span class="op" id="3729498">)</span>&nbsp;<span class="op" id="3729500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729504">e</span><span class="op" id="3729505">.</span><span class="ident" id="3729506">WriteString</span><span class="op" id="3729517">(</span><span class="string" id="3729518">&#34;true&#34;</span><span class="op" id="3729524">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3729527">}</span>&nbsp;<span class="keyword" id="3729529">else</span>&nbsp;<span class="op" id="3729534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729538">e</span><span class="op" id="3729539">.</span><span class="ident" id="3729540">WriteString</span><span class="op" id="3729551">(</span><span class="string" id="3729552">&#34;false&#34;</span><span class="op" id="3729559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3729562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3729565">if</span>&nbsp;<span class="ident" id="3729568">quoted</span>&nbsp;<span class="op" id="3729575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729579">e</span><span class="op" id="3729580">.</span><span class="ident" id="3729581">WriteByte</span><span class="op" id="3729590">(</span><span class="string" id="3729591">&#39;&#34;&#39;</span><span class="op" id="3729594">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3729597">}</span><br>
<span class="lineno"></span><span class="op" id="3729599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3729602">func</span>&nbsp;<span class="ident" id="3729607">intEncoder</span><span class="op" id="3729617">(</span><span class="ident" id="3729618">e</span>&nbsp;<span class="op" id="3729620">*</span><span class="ident" id="3729621">encodeState</span><span class="op" id="3729632">,</span>&nbsp;<span class="ident" id="3729634">v</span>&nbsp;<span class="ident" id="3729636">reflect</span><span class="op" id="3729643">.</span><span class="ident" id="3729644">Value</span><span class="op" id="3729649">,</span>&nbsp;<span class="ident" id="3729651">quoted</span>&nbsp;<span class="builtintype" id="3729658">bool</span><span class="op" id="3729662">)</span>&nbsp;<span class="op" id="3729664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729667">b</span>&nbsp;<span class="op" id="3729669">:=</span>&nbsp;<span class="ident" id="3729672">strconv</span><span class="op" id="3729679">.</span><span class="ident" id="3729680">AppendInt</span><span class="op" id="3729689">(</span><span class="ident" id="3729690">e</span><span class="op" id="3729691">.</span><span class="ident" id="3729692">scratch</span><span class="op" id="3729699">[</span><span class="op" id="3729700">:</span><span class="num" id="3729701">0</span><span class="op" id="3729702">]</span><span class="op" id="3729703">,</span>&nbsp;<span class="ident" id="3729705">v</span><span class="op" id="3729706">.</span><span class="ident" id="3729707">Int</span><span class="op" id="3729710">(</span><span class="op" id="3729711">)</span><span class="op" id="3729712">,</span>&nbsp;<span class="num" id="3729714">10</span><span class="op" id="3729716">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3729719">if</span>&nbsp;<span class="ident" id="3729722">quoted</span>&nbsp;<span class="op" id="3729729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729733">e</span><span class="op" id="3729734">.</span><span class="ident" id="3729735">WriteByte</span><span class="op" id="3729744">(</span><span class="string" id="3729745">&#39;&#34;&#39;</span><span class="op" id="3729748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3729751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729754">e</span><span class="op" id="3729755">.</span><span class="ident" id="3729756">Write</span><span class="op" id="3729761">(</span><span class="ident" id="3729762">b</span><span class="op" id="3729763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3729766">if</span>&nbsp;<span class="ident" id="3729769">quoted</span>&nbsp;<span class="op" id="3729776">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729780">e</span><span class="op" id="3729781">.</span><span class="ident" id="3729782">WriteByte</span><span class="op" id="3729791">(</span><span class="string" id="3729792">&#39;&#34;&#39;</span><span class="op" id="3729795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3729798">}</span><br>
<span class="lineno"></span><span class="op" id="3729800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3729803">func</span>&nbsp;<span class="ident" id="3729808">uintEncoder</span><span class="op" id="3729819">(</span><span class="ident" id="3729820">e</span>&nbsp;<span class="op" id="3729822">*</span><span class="ident" id="3729823">encodeState</span><span class="op" id="3729834">,</span>&nbsp;<span class="ident" id="3729836">v</span>&nbsp;<span class="ident" id="3729838">reflect</span><span class="op" id="3729845">.</span><span class="ident" id="3729846">Value</span><span class="op" id="3729851">,</span>&nbsp;<span class="ident" id="3729853">quoted</span>&nbsp;<span class="builtintype" id="3729860">bool</span><span class="op" id="3729864">)</span>&nbsp;<span class="op" id="3729866">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729869">b</span>&nbsp;<span class="op" id="3729871">:=</span>&nbsp;<span class="ident" id="3729874">strconv</span><span class="op" id="3729881">.</span><span class="ident" id="3729882">AppendUint</span><span class="op" id="3729892">(</span><span class="ident" id="3729893">e</span><span class="op" id="3729894">.</span><span class="ident" id="3729895">scratch</span><span class="op" id="3729902">[</span><span class="op" id="3729903">:</span><span class="num" id="3729904">0</span><span class="op" id="3729905">]</span><span class="op" id="3729906">,</span>&nbsp;<span class="ident" id="3729908">v</span><span class="op" id="3729909">.</span><span class="ident" id="3729910">Uint</span><span class="op" id="3729914">(</span><span class="op" id="3729915">)</span><span class="op" id="3729916">,</span>&nbsp;<span class="num" id="3729918">10</span><span class="op" id="3729920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3729923">if</span>&nbsp;<span class="ident" id="3729926">quoted</span>&nbsp;<span class="op" id="3729933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729937">e</span><span class="op" id="3729938">.</span><span class="ident" id="3729939">WriteByte</span><span class="op" id="3729948">(</span><span class="string" id="3729949">&#39;&#34;&#39;</span><span class="op" id="3729952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3729955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729958">e</span><span class="op" id="3729959">.</span><span class="ident" id="3729960">Write</span><span class="op" id="3729965">(</span><span class="ident" id="3729966">b</span><span class="op" id="3729967">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3729970">if</span>&nbsp;<span class="ident" id="3729973">quoted</span>&nbsp;<span class="op" id="3729980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729984">e</span><span class="op" id="3729985">.</span><span class="ident" id="3729986">WriteByte</span><span class="op" id="3729995">(</span><span class="string" id="3729996">&#39;&#34;&#39;</span><span class="op" id="3729999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3730002">}</span><br>
<span class="lineno"></span><span class="op" id="3730004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="3730007">type</span>&nbsp;<span class="ident" id="3730012">floatEncoder</span>&nbsp;<span class="builtintype" id="3730025">int</span>&nbsp;<span class="comment" id="3730029">//&nbsp;number&nbsp;of&nbsp;bits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3730048">func</span>&nbsp;<span class="op" id="3730053">(</span><span class="ident" id="3730054">bits</span>&nbsp;<span class="ident" id="3730059">floatEncoder</span><span class="op" id="3730071">)</span>&nbsp;<span class="ident" id="3730073">encode</span><span class="op" id="3730079">(</span><span class="ident" id="3730080">e</span>&nbsp;<span class="op" id="3730082">*</span><span class="ident" id="3730083">encodeState</span><span class="op" id="3730094">,</span>&nbsp;<span class="ident" id="3730096">v</span>&nbsp;<span class="ident" id="3730098">reflect</span><span class="op" id="3730105">.</span><span class="ident" id="3730106">Value</span><span class="op" id="3730111">,</span>&nbsp;<span class="ident" id="3730113">quoted</span>&nbsp;<span class="builtintype" id="3730120">bool</span><span class="op" id="3730124">)</span>&nbsp;<span class="op" id="3730126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730129">f</span>&nbsp;<span class="op" id="3730131">:=</span>&nbsp;<span class="ident" id="3730134">v</span><span class="op" id="3730135">.</span><span class="ident" id="3730136">Float</span><span class="op" id="3730141">(</span><span class="op" id="3730142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730145">if</span>&nbsp;<span class="ident" id="3730148">math</span><span class="op" id="3730152">.</span><span class="ident" id="3730153">IsInf</span><span class="op" id="3730158">(</span><span class="ident" id="3730159">f</span><span class="op" id="3730160">,</span>&nbsp;<span class="num" id="3730162">0</span><span class="op" id="3730163">)</span>&nbsp;<span class="op" id="3730165">||</span>&nbsp;<span class="ident" id="3730168">math</span><span class="op" id="3730172">.</span><span class="ident" id="3730173">IsNaN</span><span class="op" id="3730178">(</span><span class="ident" id="3730179">f</span><span class="op" id="3730180">)</span>&nbsp;<span class="op" id="3730182">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730186">e</span><span class="op" id="3730187">.</span><span class="builtintype" id="3730188">error</span><span class="op" id="3730193">(</span><span class="op" id="3730194">&amp;</span><span class="ident" id="3730195">UnsupportedValueError</span><span class="op" id="3730216">{</span><span class="ident" id="3730217">v</span><span class="op" id="3730218">,</span>&nbsp;<span class="ident" id="3730220">strconv</span><span class="op" id="3730227">.</span><span class="ident" id="3730228">FormatFloat</span><span class="op" id="3730239">(</span><span class="ident" id="3730240">f</span><span class="op" id="3730241">,</span>&nbsp;<span class="string" id="3730243">&#39;g&#39;</span><span class="op" id="3730246">,</span>&nbsp;<span class="op" id="3730248">-</span><span class="num" id="3730249">1</span><span class="op" id="3730250">,</span>&nbsp;<span class="builtintype" id="3730252">int</span><span class="op" id="3730255">(</span><span class="ident" id="3730256">bits</span><span class="op" id="3730260">)</span><span class="op" id="3730261">)</span><span class="op" id="3730262">}</span><span class="op" id="3730263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3730266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730269">b</span>&nbsp;<span class="op" id="3730271">:=</span>&nbsp;<span class="ident" id="3730274">strconv</span><span class="op" id="3730281">.</span><span class="ident" id="3730282">AppendFloat</span><span class="op" id="3730293">(</span><span class="ident" id="3730294">e</span><span class="op" id="3730295">.</span><span class="ident" id="3730296">scratch</span><span class="op" id="3730303">[</span><span class="op" id="3730304">:</span><span class="num" id="3730305">0</span><span class="op" id="3730306">]</span><span class="op" id="3730307">,</span>&nbsp;<span class="ident" id="3730309">f</span><span class="op" id="3730310">,</span>&nbsp;<span class="string" id="3730312">&#39;g&#39;</span><span class="op" id="3730315">,</span>&nbsp;<span class="op" id="3730317">-</span><span class="num" id="3730318">1</span><span class="op" id="3730319">,</span>&nbsp;<span class="builtintype" id="3730321">int</span><span class="op" id="3730324">(</span><span class="ident" id="3730325">bits</span><span class="op" id="3730329">)</span><span class="op" id="3730330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730333">if</span>&nbsp;<span class="ident" id="3730336">quoted</span>&nbsp;<span class="op" id="3730343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730347">e</span><span class="op" id="3730348">.</span><span class="ident" id="3730349">WriteByte</span><span class="op" id="3730358">(</span><span class="string" id="3730359">&#39;&#34;&#39;</span><span class="op" id="3730362">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3730365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730368">e</span><span class="op" id="3730369">.</span><span class="ident" id="3730370">Write</span><span class="op" id="3730375">(</span><span class="ident" id="3730376">b</span><span class="op" id="3730377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730380">if</span>&nbsp;<span class="ident" id="3730383">quoted</span>&nbsp;<span class="op" id="3730390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730394">e</span><span class="op" id="3730395">.</span><span class="ident" id="3730396">WriteByte</span><span class="op" id="3730405">(</span><span class="string" id="3730406">&#39;&#34;&#39;</span><span class="op" id="3730409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3730412">}</span><br>
<span class="lineno">525</span><span class="op" id="3730414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3730417">var</span>&nbsp;<span class="op" id="3730421">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730424">float32Encoder</span>&nbsp;<span class="op" id="3730439">=</span>&nbsp;<span class="op" id="3730441">(</span><span class="ident" id="3730442">floatEncoder</span><span class="op" id="3730454">(</span><span class="num" id="3730455">32</span><span class="op" id="3730457">)</span><span class="op" id="3730458">)</span><span class="op" id="3730459">.</span><span class="ident" id="3730460">encode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730468">float64Encoder</span>&nbsp;<span class="op" id="3730483">=</span>&nbsp;<span class="op" id="3730485">(</span><span class="ident" id="3730486">floatEncoder</span><span class="op" id="3730498">(</span><span class="num" id="3730499">64</span><span class="op" id="3730501">)</span><span class="op" id="3730502">)</span><span class="op" id="3730503">.</span><span class="ident" id="3730504">encode</span><br>
<span class="lineno">530</span><span class="op" id="3730511">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3730514">func</span>&nbsp;<span class="ident" id="3730519">stringEncoder</span><span class="op" id="3730532">(</span><span class="ident" id="3730533">e</span>&nbsp;<span class="op" id="3730535">*</span><span class="ident" id="3730536">encodeState</span><span class="op" id="3730547">,</span>&nbsp;<span class="ident" id="3730549">v</span>&nbsp;<span class="ident" id="3730551">reflect</span><span class="op" id="3730558">.</span><span class="ident" id="3730559">Value</span><span class="op" id="3730564">,</span>&nbsp;<span class="ident" id="3730566">quoted</span>&nbsp;<span class="builtintype" id="3730573">bool</span><span class="op" id="3730577">)</span>&nbsp;<span class="op" id="3730579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730582">if</span>&nbsp;<span class="ident" id="3730585">v</span><span class="op" id="3730586">.</span><span class="ident" id="3730587">Type</span><span class="op" id="3730591">(</span><span class="op" id="3730592">)</span>&nbsp;<span class="op" id="3730594">==</span>&nbsp;<span class="ident" id="3730597">numberType</span>&nbsp;<span class="op" id="3730608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730612">numStr</span>&nbsp;<span class="op" id="3730619">:=</span>&nbsp;<span class="ident" id="3730622">v</span><span class="op" id="3730623">.</span><span class="ident" id="3730624">String</span><span class="op" id="3730630">(</span><span class="op" id="3730631">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730635">if</span>&nbsp;<span class="ident" id="3730638">numStr</span>&nbsp;<span class="op" id="3730645">==</span>&nbsp;<span class="string" id="3730648">&#34;&#34;</span>&nbsp;<span class="op" id="3730651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730656">numStr</span>&nbsp;<span class="op" id="3730663">=</span>&nbsp;<span class="string" id="3730665">&#34;0&#34;</span>&nbsp;<span class="comment" id="3730669">//&nbsp;Number&#39;s&nbsp;zero-val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3730692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730696">e</span><span class="op" id="3730697">.</span><span class="ident" id="3730698">WriteString</span><span class="op" id="3730709">(</span><span class="ident" id="3730710">numStr</span><span class="op" id="3730716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730720">return</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3730728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730731">if</span>&nbsp;<span class="ident" id="3730734">quoted</span>&nbsp;<span class="op" id="3730741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730745">sb</span><span class="op" id="3730747">,</span>&nbsp;<span class="ident" id="3730749">err</span>&nbsp;<span class="op" id="3730753">:=</span>&nbsp;<span class="ident" id="3730756">Marshal</span><span class="op" id="3730763">(</span><span class="ident" id="3730764">v</span><span class="op" id="3730765">.</span><span class="ident" id="3730766">String</span><span class="op" id="3730772">(</span><span class="op" id="3730773">)</span><span class="op" id="3730774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730778">if</span>&nbsp;<span class="ident" id="3730781">err</span>&nbsp;<span class="op" id="3730785">!=</span>&nbsp;<span class="ident" id="3730788">nil</span>&nbsp;<span class="op" id="3730792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730797">e</span><span class="op" id="3730798">.</span><span class="builtintype" id="3730799">error</span><span class="op" id="3730804">(</span><span class="ident" id="3730805">err</span><span class="op" id="3730808">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3730812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730816">e</span><span class="op" id="3730817">.</span><span class="builtintype" id="3730818">string</span><span class="op" id="3730824">(</span><span class="builtintype" id="3730825">string</span><span class="op" id="3730831">(</span><span class="ident" id="3730832">sb</span><span class="op" id="3730834">)</span><span class="op" id="3730835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3730838">}</span>&nbsp;<span class="keyword" id="3730840">else</span>&nbsp;<span class="op" id="3730845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730849">e</span><span class="op" id="3730850">.</span><span class="builtintype" id="3730851">string</span><span class="op" id="3730857">(</span><span class="ident" id="3730858">v</span><span class="op" id="3730859">.</span><span class="ident" id="3730860">String</span><span class="op" id="3730866">(</span><span class="op" id="3730867">)</span><span class="op" id="3730868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3730871">}</span><br>
<span class="lineno">550</span><span class="op" id="3730873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3730876">func</span>&nbsp;<span class="ident" id="3730881">interfaceEncoder</span><span class="op" id="3730897">(</span><span class="ident" id="3730898">e</span>&nbsp;<span class="op" id="3730900">*</span><span class="ident" id="3730901">encodeState</span><span class="op" id="3730912">,</span>&nbsp;<span class="ident" id="3730914">v</span>&nbsp;<span class="ident" id="3730916">reflect</span><span class="op" id="3730923">.</span><span class="ident" id="3730924">Value</span><span class="op" id="3730929">,</span>&nbsp;<span class="ident" id="3730931">quoted</span>&nbsp;<span class="builtintype" id="3730938">bool</span><span class="op" id="3730942">)</span>&nbsp;<span class="op" id="3730944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730947">if</span>&nbsp;<span class="ident" id="3730950">v</span><span class="op" id="3730951">.</span><span class="ident" id="3730952">IsNil</span><span class="op" id="3730957">(</span><span class="op" id="3730958">)</span>&nbsp;<span class="op" id="3730960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730964">e</span><span class="op" id="3730965">.</span><span class="ident" id="3730966">WriteString</span><span class="op" id="3730977">(</span><span class="string" id="3730978">&#34;null&#34;</span><span class="op" id="3730984">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730988">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3730996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730999">e</span><span class="op" id="3731000">.</span><span class="ident" id="3731001">reflectValue</span><span class="op" id="3731013">(</span><span class="ident" id="3731014">v</span><span class="op" id="3731015">.</span><span class="ident" id="3731016">Elem</span><span class="op" id="3731020">(</span><span class="op" id="3731021">)</span><span class="op" id="3731022">)</span><br>
<span class="lineno"></span><span class="op" id="3731024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">560</span><span class="keyword" id="3731027">func</span>&nbsp;<span class="ident" id="3731032">unsupportedTypeEncoder</span><span class="op" id="3731054">(</span><span class="ident" id="3731055">e</span>&nbsp;<span class="op" id="3731057">*</span><span class="ident" id="3731058">encodeState</span><span class="op" id="3731069">,</span>&nbsp;<span class="ident" id="3731071">v</span>&nbsp;<span class="ident" id="3731073">reflect</span><span class="op" id="3731080">.</span><span class="ident" id="3731081">Value</span><span class="op" id="3731086">,</span>&nbsp;<span class="ident" id="3731088">quoted</span>&nbsp;<span class="builtintype" id="3731095">bool</span><span class="op" id="3731099">)</span>&nbsp;<span class="op" id="3731101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731104">e</span><span class="op" id="3731105">.</span><span class="builtintype" id="3731106">error</span><span class="op" id="3731111">(</span><span class="op" id="3731112">&amp;</span><span class="ident" id="3731113">UnsupportedTypeError</span><span class="op" id="3731133">{</span><span class="ident" id="3731134">v</span><span class="op" id="3731135">.</span><span class="ident" id="3731136">Type</span><span class="op" id="3731140">(</span><span class="op" id="3731141">)</span><span class="op" id="3731142">}</span><span class="op" id="3731143">)</span><br>
<span class="lineno"></span><span class="op" id="3731145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3731148">type</span>&nbsp;<span class="ident" id="3731153">structEncoder</span>&nbsp;<span class="keyword" id="3731167">struct</span>&nbsp;<span class="op" id="3731174">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731177">fields</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3731187">[</span><span class="op" id="3731188">]</span><span class="ident" id="3731189">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731196">fieldEncs</span>&nbsp;<span class="op" id="3731206">[</span><span class="op" id="3731207">]</span><span class="ident" id="3731208">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="3731220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3731223">func</span>&nbsp;<span class="op" id="3731228">(</span><span class="ident" id="3731229">se</span>&nbsp;<span class="op" id="3731232">*</span><span class="ident" id="3731233">structEncoder</span><span class="op" id="3731246">)</span>&nbsp;<span class="ident" id="3731248">encode</span><span class="op" id="3731254">(</span><span class="ident" id="3731255">e</span>&nbsp;<span class="op" id="3731257">*</span><span class="ident" id="3731258">encodeState</span><span class="op" id="3731269">,</span>&nbsp;<span class="ident" id="3731271">v</span>&nbsp;<span class="ident" id="3731273">reflect</span><span class="op" id="3731280">.</span><span class="ident" id="3731281">Value</span><span class="op" id="3731286">,</span>&nbsp;<span class="ident" id="3731288">quoted</span>&nbsp;<span class="builtintype" id="3731295">bool</span><span class="op" id="3731299">)</span>&nbsp;<span class="op" id="3731301">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731304">e</span><span class="op" id="3731305">.</span><span class="ident" id="3731306">WriteByte</span><span class="op" id="3731315">(</span><span class="string" id="3731316">&#39;{&#39;</span><span class="op" id="3731319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731322">first</span>&nbsp;<span class="op" id="3731328">:=</span>&nbsp;<span class="builtintype" id="3731331">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3731337">for</span>&nbsp;<span class="ident" id="3731341">i</span><span class="op" id="3731342">,</span>&nbsp;<span class="ident" id="3731344">f</span>&nbsp;<span class="op" id="3731346">:=</span>&nbsp;<span class="keyword" id="3731349">range</span>&nbsp;<span class="ident" id="3731355">se</span><span class="op" id="3731357">.</span><span class="ident" id="3731358">fields</span>&nbsp;<span class="op" id="3731365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731369">fv</span>&nbsp;<span class="op" id="3731372">:=</span>&nbsp;<span class="ident" id="3731375">fieldByIndex</span><span class="op" id="3731387">(</span><span class="ident" id="3731388">v</span><span class="op" id="3731389">,</span>&nbsp;<span class="ident" id="3731391">f</span><span class="op" id="3731392">.</span><span class="ident" id="3731393">index</span><span class="op" id="3731398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3731402">if</span>&nbsp;<span class="op" id="3731405">!</span><span class="ident" id="3731406">fv</span><span class="op" id="3731408">.</span><span class="ident" id="3731409">IsValid</span><span class="op" id="3731416">(</span><span class="op" id="3731417">)</span>&nbsp;<span class="op" id="3731419">||</span>&nbsp;<span class="ident" id="3731422">f</span><span class="op" id="3731423">.</span><span class="ident" id="3731424">omitEmpty</span>&nbsp;<span class="op" id="3731434">&amp;&amp;</span>&nbsp;<span class="ident" id="3731437">isEmptyValue</span><span class="op" id="3731449">(</span><span class="ident" id="3731450">fv</span><span class="op" id="3731452">)</span>&nbsp;<span class="op" id="3731454">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3731459">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3731470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3731474">if</span>&nbsp;<span class="ident" id="3731477">first</span>&nbsp;<span class="op" id="3731483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731488">first</span>&nbsp;<span class="op" id="3731494">=</span>&nbsp;<span class="builtintype" id="3731496">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3731504">}</span>&nbsp;<span class="keyword" id="3731506">else</span>&nbsp;<span class="op" id="3731511">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731516">e</span><span class="op" id="3731517">.</span><span class="ident" id="3731518">WriteByte</span><span class="op" id="3731527">(</span><span class="string" id="3731528">&#39;,&#39;</span><span class="op" id="3731531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3731535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731539">e</span><span class="op" id="3731540">.</span><span class="builtintype" id="3731541">string</span><span class="op" id="3731547">(</span><span class="ident" id="3731548">f</span><span class="op" id="3731549">.</span><span class="ident" id="3731550">name</span><span class="op" id="3731554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731558">e</span><span class="op" id="3731559">.</span><span class="ident" id="3731560">WriteByte</span><span class="op" id="3731569">(</span><span class="string" id="3731570">&#39;:&#39;</span><span class="op" id="3731573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731577">se</span><span class="op" id="3731579">.</span><span class="ident" id="3731580">fieldEncs</span><span class="op" id="3731589">[</span><span class="ident" id="3731590">i</span><span class="op" id="3731591">]</span><span class="op" id="3731592">(</span><span class="ident" id="3731593">e</span><span class="op" id="3731594">,</span>&nbsp;<span class="ident" id="3731596">fv</span><span class="op" id="3731598">,</span>&nbsp;<span class="ident" id="3731600">f</span><span class="op" id="3731601">.</span><span class="ident" id="3731602">quoted</span><span class="op" id="3731608">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3731611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731614">e</span><span class="op" id="3731615">.</span><span class="ident" id="3731616">WriteByte</span><span class="op" id="3731625">(</span><span class="string" id="3731626">&#39;}&#39;</span><span class="op" id="3731629">)</span><br>
<span class="lineno"></span><span class="op" id="3731631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3731634">func</span>&nbsp;<span class="ident" id="3731639">newStructEncoder</span><span class="op" id="3731655">(</span><span class="ident" id="3731656">t</span>&nbsp;<span class="ident" id="3731658">reflect</span><span class="op" id="3731665">.</span><span class="ident" id="3731666">Type</span><span class="op" id="3731670">)</span>&nbsp;<span class="ident" id="3731672">encoderFunc</span>&nbsp;<span class="op" id="3731684">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731687">fields</span>&nbsp;<span class="op" id="3731694">:=</span>&nbsp;<span class="ident" id="3731697">cachedTypeFields</span><span class="op" id="3731713">(</span><span class="ident" id="3731714">t</span><span class="op" id="3731715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731718">se</span>&nbsp;<span class="op" id="3731721">:=</span>&nbsp;<span class="op" id="3731724">&amp;</span><span class="ident" id="3731725">structEncoder</span><span class="op" id="3731738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731742">fields</span><span class="op" id="3731748">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3731753">fields</span><span class="op" id="3731759">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731763">fieldEncs</span><span class="op" id="3731772">:</span>&nbsp;<span class="builtinfunc" id="3731774">make</span><span class="op" id="3731778">(</span><span class="op" id="3731779">[</span><span class="op" id="3731780">]</span><span class="ident" id="3731781">encoderFunc</span><span class="op" id="3731792">,</span>&nbsp;<span class="builtinfunc" id="3731794">len</span><span class="op" id="3731797">(</span><span class="ident" id="3731798">fields</span><span class="op" id="3731804">)</span><span class="op" id="3731805">)</span><span class="op" id="3731806">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3731809">}</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3731812">for</span>&nbsp;<span class="ident" id="3731816">i</span><span class="op" id="3731817">,</span>&nbsp;<span class="ident" id="3731819">f</span>&nbsp;<span class="op" id="3731821">:=</span>&nbsp;<span class="keyword" id="3731824">range</span>&nbsp;<span class="ident" id="3731830">fields</span>&nbsp;<span class="op" id="3731837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731841">se</span><span class="op" id="3731843">.</span><span class="ident" id="3731844">fieldEncs</span><span class="op" id="3731853">[</span><span class="ident" id="3731854">i</span><span class="op" id="3731855">]</span>&nbsp;<span class="op" id="3731857">=</span>&nbsp;<span class="ident" id="3731859">typeEncoder</span><span class="op" id="3731870">(</span><span class="ident" id="3731871">typeByIndex</span><span class="op" id="3731882">(</span><span class="ident" id="3731883">t</span><span class="op" id="3731884">,</span>&nbsp;<span class="ident" id="3731886">f</span><span class="op" id="3731887">.</span><span class="ident" id="3731888">index</span><span class="op" id="3731893">)</span><span class="op" id="3731894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3731897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3731900">return</span>&nbsp;<span class="ident" id="3731907">se</span><span class="op" id="3731909">.</span><span class="ident" id="3731910">encode</span><br>
<span class="lineno"></span><span class="op" id="3731917">}</span><br>
<span class="lineno">600</span><br>
<span class="lineno"></span><span class="keyword" id="3731920">type</span>&nbsp;<span class="ident" id="3731925">mapEncoder</span>&nbsp;<span class="keyword" id="3731936">struct</span>&nbsp;<span class="op" id="3731943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731946">elemEnc</span>&nbsp;<span class="ident" id="3731954">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="3731966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">605</span><span class="keyword" id="3731969">func</span>&nbsp;<span class="op" id="3731974">(</span><span class="ident" id="3731975">me</span>&nbsp;<span class="op" id="3731978">*</span><span class="ident" id="3731979">mapEncoder</span><span class="op" id="3731989">)</span>&nbsp;<span class="ident" id="3731991">encode</span><span class="op" id="3731997">(</span><span class="ident" id="3731998">e</span>&nbsp;<span class="op" id="3732000">*</span><span class="ident" id="3732001">encodeState</span><span class="op" id="3732012">,</span>&nbsp;<span class="ident" id="3732014">v</span>&nbsp;<span class="ident" id="3732016">reflect</span><span class="op" id="3732023">.</span><span class="ident" id="3732024">Value</span><span class="op" id="3732029">,</span>&nbsp;<span class="ident" id="3732031">_</span>&nbsp;<span class="builtintype" id="3732033">bool</span><span class="op" id="3732037">)</span>&nbsp;<span class="op" id="3732039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732042">if</span>&nbsp;<span class="ident" id="3732045">v</span><span class="op" id="3732046">.</span><span class="ident" id="3732047">IsNil</span><span class="op" id="3732052">(</span><span class="op" id="3732053">)</span>&nbsp;<span class="op" id="3732055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732059">e</span><span class="op" id="3732060">.</span><span class="ident" id="3732061">WriteString</span><span class="op" id="3732072">(</span><span class="string" id="3732073">&#34;null&#34;</span><span class="op" id="3732079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732083">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3732091">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732094">e</span><span class="op" id="3732095">.</span><span class="ident" id="3732096">WriteByte</span><span class="op" id="3732105">(</span><span class="string" id="3732106">&#39;{&#39;</span><span class="op" id="3732109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732112">var</span>&nbsp;<span class="ident" id="3732116">sv</span>&nbsp;<span class="ident" id="3732119">stringValues</span>&nbsp;<span class="op" id="3732132">=</span>&nbsp;<span class="ident" id="3732134">v</span><span class="op" id="3732135">.</span><span class="ident" id="3732136">MapKeys</span><span class="op" id="3732143">(</span><span class="op" id="3732144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732147">sort</span><span class="op" id="3732151">.</span><span class="ident" id="3732152">Sort</span><span class="op" id="3732156">(</span><span class="ident" id="3732157">sv</span><span class="op" id="3732159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732162">for</span>&nbsp;<span class="ident" id="3732166">i</span><span class="op" id="3732167">,</span>&nbsp;<span class="ident" id="3732169">k</span>&nbsp;<span class="op" id="3732171">:=</span>&nbsp;<span class="keyword" id="3732174">range</span>&nbsp;<span class="ident" id="3732180">sv</span>&nbsp;<span class="op" id="3732183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732187">if</span>&nbsp;<span class="ident" id="3732190">i</span>&nbsp;<span class="op" id="3732192">&gt;</span>&nbsp;<span class="num" id="3732194">0</span>&nbsp;<span class="op" id="3732196">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732201">e</span><span class="op" id="3732202">.</span><span class="ident" id="3732203">WriteByte</span><span class="op" id="3732212">(</span><span class="string" id="3732213">&#39;,&#39;</span><span class="op" id="3732216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3732220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732224">e</span><span class="op" id="3732225">.</span><span class="builtintype" id="3732226">string</span><span class="op" id="3732232">(</span><span class="ident" id="3732233">k</span><span class="op" id="3732234">.</span><span class="ident" id="3732235">String</span><span class="op" id="3732241">(</span><span class="op" id="3732242">)</span><span class="op" id="3732243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732247">e</span><span class="op" id="3732248">.</span><span class="ident" id="3732249">WriteByte</span><span class="op" id="3732258">(</span><span class="string" id="3732259">&#39;:&#39;</span><span class="op" id="3732262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732266">me</span><span class="op" id="3732268">.</span><span class="ident" id="3732269">elemEnc</span><span class="op" id="3732276">(</span><span class="ident" id="3732277">e</span><span class="op" id="3732278">,</span>&nbsp;<span class="ident" id="3732280">v</span><span class="op" id="3732281">.</span><span class="ident" id="3732282">MapIndex</span><span class="op" id="3732290">(</span><span class="ident" id="3732291">k</span><span class="op" id="3732292">)</span><span class="op" id="3732293">,</span>&nbsp;<span class="builtintype" id="3732295">false</span><span class="op" id="3732300">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3732303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732306">e</span><span class="op" id="3732307">.</span><span class="ident" id="3732308">WriteByte</span><span class="op" id="3732317">(</span><span class="string" id="3732318">&#39;}&#39;</span><span class="op" id="3732321">)</span><br>
<span class="lineno"></span><span class="op" id="3732323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3732326">func</span>&nbsp;<span class="ident" id="3732331">newMapEncoder</span><span class="op" id="3732344">(</span><span class="ident" id="3732345">t</span>&nbsp;<span class="ident" id="3732347">reflect</span><span class="op" id="3732354">.</span><span class="ident" id="3732355">Type</span><span class="op" id="3732359">)</span>&nbsp;<span class="ident" id="3732361">encoderFunc</span>&nbsp;<span class="op" id="3732373">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732376">if</span>&nbsp;<span class="ident" id="3732379">t</span><span class="op" id="3732380">.</span><span class="ident" id="3732381">Key</span><span class="op" id="3732384">(</span><span class="op" id="3732385">)</span><span class="op" id="3732386">.</span><span class="ident" id="3732387">Kind</span><span class="op" id="3732391">(</span><span class="op" id="3732392">)</span>&nbsp;<span class="op" id="3732394">!=</span>&nbsp;<span class="ident" id="3732397">reflect</span><span class="op" id="3732404">.</span><span class="ident" id="3732405">String</span>&nbsp;<span class="op" id="3732412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732416">return</span>&nbsp;<span class="ident" id="3732423">unsupportedTypeEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3732447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732450">me</span>&nbsp;<span class="op" id="3732453">:=</span>&nbsp;<span class="op" id="3732456">&amp;</span><span class="ident" id="3732457">mapEncoder</span><span class="op" id="3732467">{</span><span class="ident" id="3732468">typeEncoder</span><span class="op" id="3732479">(</span><span class="ident" id="3732480">t</span><span class="op" id="3732481">.</span><span class="ident" id="3732482">Elem</span><span class="op" id="3732486">(</span><span class="op" id="3732487">)</span><span class="op" id="3732488">)</span><span class="op" id="3732489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732492">return</span>&nbsp;<span class="ident" id="3732499">me</span><span class="op" id="3732501">.</span><span class="ident" id="3732502">encode</span><br>
<span class="lineno">630</span><span class="op" id="3732509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3732512">func</span>&nbsp;<span class="ident" id="3732517">encodeByteSlice</span><span class="op" id="3732532">(</span><span class="ident" id="3732533">e</span>&nbsp;<span class="op" id="3732535">*</span><span class="ident" id="3732536">encodeState</span><span class="op" id="3732547">,</span>&nbsp;<span class="ident" id="3732549">v</span>&nbsp;<span class="ident" id="3732551">reflect</span><span class="op" id="3732558">.</span><span class="ident" id="3732559">Value</span><span class="op" id="3732564">,</span>&nbsp;<span class="ident" id="3732566">_</span>&nbsp;<span class="builtintype" id="3732568">bool</span><span class="op" id="3732572">)</span>&nbsp;<span class="op" id="3732574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732577">if</span>&nbsp;<span class="ident" id="3732580">v</span><span class="op" id="3732581">.</span><span class="ident" id="3732582">IsNil</span><span class="op" id="3732587">(</span><span class="op" id="3732588">)</span>&nbsp;<span class="op" id="3732590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732594">e</span><span class="op" id="3732595">.</span><span class="ident" id="3732596">WriteString</span><span class="op" id="3732607">(</span><span class="string" id="3732608">&#34;null&#34;</span><span class="op" id="3732614">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732618">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3732626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732629">s</span>&nbsp;<span class="op" id="3732631">:=</span>&nbsp;<span class="ident" id="3732634">v</span><span class="op" id="3732635">.</span><span class="ident" id="3732636">Bytes</span><span class="op" id="3732641">(</span><span class="op" id="3732642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732645">e</span><span class="op" id="3732646">.</span><span class="ident" id="3732647">WriteByte</span><span class="op" id="3732656">(</span><span class="string" id="3732657">&#39;&#34;&#39;</span><span class="op" id="3732660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732663">if</span>&nbsp;<span class="builtinfunc" id="3732666">len</span><span class="op" id="3732669">(</span><span class="ident" id="3732670">s</span><span class="op" id="3732671">)</span>&nbsp;<span class="op" id="3732673">&lt;</span>&nbsp;<span class="num" id="3732675">1024</span>&nbsp;<span class="op" id="3732680">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3732684">//&nbsp;for&nbsp;small&nbsp;buffers,&nbsp;using&nbsp;Encode&nbsp;directly&nbsp;is&nbsp;much&nbsp;faster.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732746">dst</span>&nbsp;<span class="op" id="3732750">:=</span>&nbsp;<span class="builtinfunc" id="3732753">make</span><span class="op" id="3732757">(</span><span class="op" id="3732758">[</span><span class="op" id="3732759">]</span><span class="builtintype" id="3732760">byte</span><span class="op" id="3732764">,</span>&nbsp;<span class="ident" id="3732766">base64</span><span class="op" id="3732772">.</span><span class="ident" id="3732773">StdEncoding</span><span class="op" id="3732784">.</span><span class="ident" id="3732785">EncodedLen</span><span class="op" id="3732795">(</span><span class="builtinfunc" id="3732796">len</span><span class="op" id="3732799">(</span><span class="ident" id="3732800">s</span><span class="op" id="3732801">)</span><span class="op" id="3732802">)</span><span class="op" id="3732803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732807">base64</span><span class="op" id="3732813">.</span><span class="ident" id="3732814">StdEncoding</span><span class="op" id="3732825">.</span><span class="ident" id="3732826">Encode</span><span class="op" id="3732832">(</span><span class="ident" id="3732833">dst</span><span class="op" id="3732836">,</span>&nbsp;<span class="ident" id="3732838">s</span><span class="op" id="3732839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732843">e</span><span class="op" id="3732844">.</span><span class="ident" id="3732845">Write</span><span class="op" id="3732850">(</span><span class="ident" id="3732851">dst</span><span class="op" id="3732854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3732857">}</span>&nbsp;<span class="keyword" id="3732859">else</span>&nbsp;<span class="op" id="3732864">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3732868">//&nbsp;for&nbsp;large&nbsp;buffers,&nbsp;avoid&nbsp;unnecessary&nbsp;extra&nbsp;temporary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3732926">//&nbsp;buffer&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732945">enc</span>&nbsp;<span class="op" id="3732949">:=</span>&nbsp;<span class="ident" id="3732952">base64</span><span class="op" id="3732958">.</span><span class="ident" id="3732959">NewEncoder</span><span class="op" id="3732969">(</span><span class="ident" id="3732970">base64</span><span class="op" id="3732976">.</span><span class="ident" id="3732977">StdEncoding</span><span class="op" id="3732988">,</span>&nbsp;<span class="ident" id="3732990">e</span><span class="op" id="3732991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732995">enc</span><span class="op" id="3732998">.</span><span class="ident" id="3732999">Write</span><span class="op" id="3733004">(</span><span class="ident" id="3733005">s</span><span class="op" id="3733006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733010">enc</span><span class="op" id="3733013">.</span><span class="ident" id="3733014">Close</span><span class="op" id="3733019">(</span><span class="op" id="3733020">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3733023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733026">e</span><span class="op" id="3733027">.</span><span class="ident" id="3733028">WriteByte</span><span class="op" id="3733037">(</span><span class="string" id="3733038">&#39;&#34;&#39;</span><span class="op" id="3733041">)</span><br>
<span class="lineno"></span><span class="op" id="3733043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3733046">//&nbsp;sliceEncoder&nbsp;just&nbsp;wraps&nbsp;an&nbsp;arrayEncoder,&nbsp;checking&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;value&nbsp;isn&#39;t&nbsp;nil.</span><br>
<span class="lineno">655</span><span class="keyword" id="3733133">type</span>&nbsp;<span class="ident" id="3733138">sliceEncoder</span>&nbsp;<span class="keyword" id="3733151">struct</span>&nbsp;<span class="op" id="3733158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733161">arrayEnc</span>&nbsp;<span class="ident" id="3733170">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="3733182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3733185">func</span>&nbsp;<span class="op" id="3733190">(</span><span class="ident" id="3733191">se</span>&nbsp;<span class="op" id="3733194">*</span><span class="ident" id="3733195">sliceEncoder</span><span class="op" id="3733207">)</span>&nbsp;<span class="ident" id="3733209">encode</span><span class="op" id="3733215">(</span><span class="ident" id="3733216">e</span>&nbsp;<span class="op" id="3733218">*</span><span class="ident" id="3733219">encodeState</span><span class="op" id="3733230">,</span>&nbsp;<span class="ident" id="3733232">v</span>&nbsp;<span class="ident" id="3733234">reflect</span><span class="op" id="3733241">.</span><span class="ident" id="3733242">Value</span><span class="op" id="3733247">,</span>&nbsp;<span class="ident" id="3733249">_</span>&nbsp;<span class="builtintype" id="3733251">bool</span><span class="op" id="3733255">)</span>&nbsp;<span class="op" id="3733257">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3733260">if</span>&nbsp;<span class="ident" id="3733263">v</span><span class="op" id="3733264">.</span><span class="ident" id="3733265">IsNil</span><span class="op" id="3733270">(</span><span class="op" id="3733271">)</span>&nbsp;<span class="op" id="3733273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733277">e</span><span class="op" id="3733278">.</span><span class="ident" id="3733279">WriteString</span><span class="op" id="3733290">(</span><span class="string" id="3733291">&#34;null&#34;</span><span class="op" id="3733297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3733301">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3733309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733312">se</span><span class="op" id="3733314">.</span><span class="ident" id="3733315">arrayEnc</span><span class="op" id="3733323">(</span><span class="ident" id="3733324">e</span><span class="op" id="3733325">,</span>&nbsp;<span class="ident" id="3733327">v</span><span class="op" id="3733328">,</span>&nbsp;<span class="builtintype" id="3733330">false</span><span class="op" id="3733335">)</span><br>
<span class="lineno">665</span><span class="op" id="3733337">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3733340">func</span>&nbsp;<span class="ident" id="3733345">newSliceEncoder</span><span class="op" id="3733360">(</span><span class="ident" id="3733361">t</span>&nbsp;<span class="ident" id="3733363">reflect</span><span class="op" id="3733370">.</span><span class="ident" id="3733371">Type</span><span class="op" id="3733375">)</span>&nbsp;<span class="ident" id="3733377">encoderFunc</span>&nbsp;<span class="op" id="3733389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3733392">//&nbsp;Byte&nbsp;slices&nbsp;get&nbsp;special&nbsp;treatment;&nbsp;arrays&nbsp;don&#39;t.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3733445">if</span>&nbsp;<span class="ident" id="3733448">t</span><span class="op" id="3733449">.</span><span class="ident" id="3733450">Elem</span><span class="op" id="3733454">(</span><span class="op" id="3733455">)</span><span class="op" id="3733456">.</span><span class="ident" id="3733457">Kind</span><span class="op" id="3733461">(</span><span class="op" id="3733462">)</span>&nbsp;<span class="op" id="3733464">==</span>&nbsp;<span class="ident" id="3733467">reflect</span><span class="op" id="3733474">.</span><span class="ident" id="3733475">Uint8</span>&nbsp;<span class="op" id="3733481">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3733485">return</span>&nbsp;<span class="ident" id="3733492">encodeByteSlice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3733509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733512">enc</span>&nbsp;<span class="op" id="3733516">:=</span>&nbsp;<span class="op" id="3733519">&amp;</span><span class="ident" id="3733520">sliceEncoder</span><span class="op" id="3733532">{</span><span class="ident" id="3733533">newArrayEncoder</span><span class="op" id="3733548">(</span><span class="ident" id="3733549">t</span><span class="op" id="3733550">)</span><span class="op" id="3733551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3733554">return</span>&nbsp;<span class="ident" id="3733561">enc</span><span class="op" id="3733564">.</span><span class="ident" id="3733565">encode</span><br>
<span class="lineno"></span><span class="op" id="3733572">}</span><br>
<span class="lineno">675</span><br>
<span class="lineno"></span><span class="keyword" id="3733575">type</span>&nbsp;<span class="ident" id="3733580">arrayEncoder</span>&nbsp;<span class="keyword" id="3733593">struct</span>&nbsp;<span class="op" id="3733600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733603">elemEnc</span>&nbsp;<span class="ident" id="3733611">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="3733623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="keyword" id="3733626">func</span>&nbsp;<span class="op" id="3733631">(</span><span class="ident" id="3733632">ae</span>&nbsp;<span class="op" id="3733635">*</span><span class="ident" id="3733636">arrayEncoder</span><span class="op" id="3733648">)</span>&nbsp;<span class="ident" id="3733650">encode</span><span class="op" id="3733656">(</span><span class="ident" id="3733657">e</span>&nbsp;<span class="op" id="3733659">*</span><span class="ident" id="3733660">encodeState</span><span class="op" id="3733671">,</span>&nbsp;<span class="ident" id="3733673">v</span>&nbsp;<span class="ident" id="3733675">reflect</span><span class="op" id="3733682">.</span><span class="ident" id="3733683">Value</span><span class="op" id="3733688">,</span>&nbsp;<span class="ident" id="3733690">_</span>&nbsp;<span class="builtintype" id="3733692">bool</span><span class="op" id="3733696">)</span>&nbsp;<span class="op" id="3733698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733701">e</span><span class="op" id="3733702">.</span><span class="ident" id="3733703">WriteByte</span><span class="op" id="3733712">(</span><span class="string" id="3733713">&#39;[&#39;</span><span class="op" id="3733716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733719">n</span>&nbsp;<span class="op" id="3733721">:=</span>&nbsp;<span class="ident" id="3733724">v</span><span class="op" id="3733725">.</span><span class="ident" id="3733726">Len</span><span class="op" id="3733729">(</span><span class="op" id="3733730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3733733">for</span>&nbsp;<span class="ident" id="3733737">i</span>&nbsp;<span class="op" id="3733739">:=</span>&nbsp;<span class="num" id="3733742">0</span><span class="op" id="3733743">;</span>&nbsp;<span class="ident" id="3733745">i</span>&nbsp;<span class="op" id="3733747">&lt;</span>&nbsp;<span class="ident" id="3733749">n</span><span class="op" id="3733750">;</span>&nbsp;<span class="ident" id="3733752">i</span><span class="op" id="3733753">++</span>&nbsp;<span class="op" id="3733756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3733760">if</span>&nbsp;<span class="ident" id="3733763">i</span>&nbsp;<span class="op" id="3733765">&gt;</span>&nbsp;<span class="num" id="3733767">0</span>&nbsp;<span class="op" id="3733769">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733774">e</span><span class="op" id="3733775">.</span><span class="ident" id="3733776">WriteByte</span><span class="op" id="3733785">(</span><span class="string" id="3733786">&#39;,&#39;</span><span class="op" id="3733789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3733793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733797">ae</span><span class="op" id="3733799">.</span><span class="ident" id="3733800">elemEnc</span><span class="op" id="3733807">(</span><span class="ident" id="3733808">e</span><span class="op" id="3733809">,</span>&nbsp;<span class="ident" id="3733811">v</span><span class="op" id="3733812">.</span><span class="ident" id="3733813">Index</span><span class="op" id="3733818">(</span><span class="ident" id="3733819">i</span><span class="op" id="3733820">)</span><span class="op" id="3733821">,</span>&nbsp;<span class="builtintype" id="3733823">false</span><span class="op" id="3733828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3733831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733834">e</span><span class="op" id="3733835">.</span><span class="ident" id="3733836">WriteByte</span><span class="op" id="3733845">(</span><span class="string" id="3733846">&#39;]&#39;</span><span class="op" id="3733849">)</span><br>
<span class="lineno">690</span><span class="op" id="3733851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3733854">func</span>&nbsp;<span class="ident" id="3733859">newArrayEncoder</span><span class="op" id="3733874">(</span><span class="ident" id="3733875">t</span>&nbsp;<span class="ident" id="3733877">reflect</span><span class="op" id="3733884">.</span><span class="ident" id="3733885">Type</span><span class="op" id="3733889">)</span>&nbsp;<span class="ident" id="3733891">encoderFunc</span>&nbsp;<span class="op" id="3733903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733906">enc</span>&nbsp;<span class="op" id="3733910">:=</span>&nbsp;<span class="op" id="3733913">&amp;</span><span class="ident" id="3733914">arrayEncoder</span><span class="op" id="3733926">{</span><span class="ident" id="3733927">typeEncoder</span><span class="op" id="3733938">(</span><span class="ident" id="3733939">t</span><span class="op" id="3733940">.</span><span class="ident" id="3733941">Elem</span><span class="op" id="3733945">(</span><span class="op" id="3733946">)</span><span class="op" id="3733947">)</span><span class="op" id="3733948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3733951">return</span>&nbsp;<span class="ident" id="3733958">enc</span><span class="op" id="3733961">.</span><span class="ident" id="3733962">encode</span><br>
<span class="lineno">695</span><span class="op" id="3733969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3733972">type</span>&nbsp;<span class="ident" id="3733977">ptrEncoder</span>&nbsp;<span class="keyword" id="3733988">struct</span>&nbsp;<span class="op" id="3733995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733998">elemEnc</span>&nbsp;<span class="ident" id="3734006">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="3734018">}</span><br>
<span class="lineno">700</span><br>
<span class="lineno"></span><span class="keyword" id="3734021">func</span>&nbsp;<span class="op" id="3734026">(</span><span class="ident" id="3734027">pe</span>&nbsp;<span class="op" id="3734030">*</span><span class="ident" id="3734031">ptrEncoder</span><span class="op" id="3734041">)</span>&nbsp;<span class="ident" id="3734043">encode</span><span class="op" id="3734049">(</span><span class="ident" id="3734050">e</span>&nbsp;<span class="op" id="3734052">*</span><span class="ident" id="3734053">encodeState</span><span class="op" id="3734064">,</span>&nbsp;<span class="ident" id="3734066">v</span>&nbsp;<span class="ident" id="3734068">reflect</span><span class="op" id="3734075">.</span><span class="ident" id="3734076">Value</span><span class="op" id="3734081">,</span>&nbsp;<span class="ident" id="3734083">quoted</span>&nbsp;<span class="builtintype" id="3734090">bool</span><span class="op" id="3734094">)</span>&nbsp;<span class="op" id="3734096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3734099">if</span>&nbsp;<span class="ident" id="3734102">v</span><span class="op" id="3734103">.</span><span class="ident" id="3734104">IsNil</span><span class="op" id="3734109">(</span><span class="op" id="3734110">)</span>&nbsp;<span class="op" id="3734112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3734116">e</span><span class="op" id="3734117">.</span><span class="ident" id="3734118">WriteString</span><span class="op" id="3734129">(</span><span class="string" id="3734130">&#34;null&#34;</span><span class="op" id="3734136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3734140">return</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3734148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3734151">pe</span><span class="op" id="3734153">.</span><span class="ident" id="3734154">elemEnc</span><span class="op" id="3734161">(</span><span class="ident" id="3734162">e</span><span class="op" id="3734163">,</span>&nbsp;<span class="ident" id="3734165">v</span><span class="op" id="3734166">.</span><span class="ident" id="3734167">Elem</span><span class="op" id="3734171">(</span><span class="op" id="3734172">)</span><span class="op" id="3734173">,</span>&nbsp;<span class="ident" id="3734175">quoted</span><span class="op" id="3734181">)</span><br>
<span class="lineno"></span><span class="op" id="3734183">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3734186">func</span>&nbsp;<span class="ident" id="3734191">newPtrEncoder</span><span class="op" id="3734204">(</span><span class="ident" id="3734205">t</span>&nbsp;<span class="ident" id="3734207">reflect</span><span class="op" id="3734214">.</span><span class="ident" id="3734215">Type</span><span class="op" id="3734219">)</span>&nbsp;<span class="ident" id="3734221">encoderFunc</span>&nbsp;<span class="op" id="3734233">{</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3734236">enc</span>&nbsp;<span class="op" id="3734240">:=</span>&nbsp;<span class="op" id="3734243">&amp;</span><span class="ident" id="3734244">ptrEncoder</span><span class="op" id="3734254">{</span><span class="ident" id="3734255">typeEncoder</span><span class="op" id="3734266">(</span><span class="ident" id="3734267">t</span><span class="op" id="3734268">.</span><span class="ident" id="3734269">Elem</span><span class="op" id="3734273">(</span><span class="op" id="3734274">)</span><span class="op" id="3734275">)</span><span class="op" id="3734276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3734279">return</span>&nbsp;<span class="ident" id="3734286">enc</span><span class="op" id="3734289">.</span><span class="ident" id="3734290">encode</span><br>
<span class="lineno"></span><span class="op" id="3734297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3734300">type</span>&nbsp;<span class="ident" id="3734305">condAddrEncoder</span>&nbsp;<span class="keyword" id="3734321">struct</span>&nbsp;<span class="op" id="3734328">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3734331">canAddrEnc</span><span class="op" id="3734341">,</span>&nbsp;<span class="ident" id="3734343">elseEnc</span>&nbsp;<span class="ident" id="3734351">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="3734363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3734366">func</span>&nbsp;<span class="op" id="3734371">(</span><span class="ident" id="3734372">ce</span>&nbsp;<span class="op" id="3734375">*</span><span class="ident" id="3734376">condAddrEncoder</span><span class="op" id="3734391">)</span>&nbsp;<span class="ident" id="3734393">encode</span><span class="op" id="3734399">(</span><span class="ident" id="3734400">e</span>&nbsp;<span class="op" id="3734402">*</span><span class="ident" id="3734403">encodeState</span><span class="op" id="3734414">,</span>&nbsp;<span class="ident" id="3734416">v</span>&nbsp;<span class="ident" id="3734418">reflect</span><span class="op" id="3734425">.</span><span class="ident" id="3734426">Value</span><span class="op" id="3734431">,</span>&nbsp;<span class="ident" id="3734433">quoted</span>&nbsp;<span class="builtintype" id="3734440">bool</span><span class="op" id="3734444">)</span>&nbsp;<span class="op" id="3734446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3734449">if</span>&nbsp;<span class="ident" id="3734452">v</span><span class="op" id="3734453">.</span><span class="ident" id="3734454">CanAddr</span><span class="op" id="3734461">(</span><span class="op" id="3734462">)</span>&nbsp;<span class="op" id="3734464">{</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3734468">ce</span><span class="op" id="3734470">.</span><span class="ident" id="3734471">canAddrEnc</span><span class="op" id="3734481">(</span><span class="ident" id="3734482">e</span><span class="op" id="3734483">,</span>&nbsp;<span class="ident" id="3734485">v</span><span class="op" id="3734486">,</span>&nbsp;<span class="ident" id="3734488">quoted</span><span class="op" id="3734494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3734497">}</span>&nbsp;<span class="keyword" id="3734499">else</span>&nbsp;<span class="op" id="3734504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3734508">ce</span><span class="op" id="3734510">.</span><span class="ident" id="3734511">elseEnc</span><span class="op" id="3734518">(</span><span class="ident" id="3734519">e</span><span class="op" id="3734520">,</span>&nbsp;<span class="ident" id="3734522">v</span><span class="op" id="3734523">,</span>&nbsp;<span class="ident" id="3734525">quoted</span><span class="op" id="3734531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3734534">}</span><br>
<span class="lineno"></span><span class="op" id="3734536">}</span><br>
<span class="lineno">725</span><br>
<span class="lineno"></span><span class="comment" id="3734539">//&nbsp;newCondAddrEncoder&nbsp;returns&nbsp;an&nbsp;encoder&nbsp;that&nbsp;checks&nbsp;whether&nbsp;its&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="3734610">//&nbsp;CanAddr&nbsp;and&nbsp;delegates&nbsp;to&nbsp;canAddrEnc&nbsp;if&nbsp;so,&nbsp;else&nbsp;to&nbsp;elseEnc.</span><br>
<span class="lineno"></span><span class="keyword" id="3734673">func</span>&nbsp;<span class="ident" id="3734678">newCondAddrEncoder</span><span class="op" id="3734696">(</span><span class="ident" id="3734697">canAddrEnc</span><span class="op" id="3734707">,</span>&nbsp;<span class="ident" id="3734709">elseEnc</span>&nbsp;<span class="ident" id="3734717">encoderFunc</span><span class="op" id="3734728">)</span>&nbsp;<span class="ident" id="3734730">encoderFunc</span>&nbsp;<span class="op" id="3734742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3734745">enc</span>&nbsp;<span class="op" id="3734749">:=</span>&nbsp;<span class="op" id="3734752">&amp;</span><span class="ident" id="3734753">condAddrEncoder</span><span class="op" id="3734768">{</span><span class="ident" id="3734769">canAddrEnc</span><span class="op" id="3734779">:</span>&nbsp;<span class="ident" id="3734781">canAddrEnc</span><span class="op" id="3734791">,</span>&nbsp;<span class="ident" id="3734793">elseEnc</span><span class="op" id="3734800">:</span>&nbsp;<span class="ident" id="3734802">elseEnc</span><span class="op" id="3734809">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3734812">return</span>&nbsp;<span class="ident" id="3734819">enc</span><span class="op" id="3734822">.</span><span class="ident" id="3734823">encode</span><br>
<span class="lineno"></span><span class="op" id="3734830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3734833">func</span>&nbsp;<span class="ident" id="3734838">isValidTag</span><span class="op" id="3734848">(</span><span class="ident" id="3734849">s</span>&nbsp;<span class="builtintype" id="3734851">string</span><span class="op" id="3734857">)</span>&nbsp;<span class="builtintype" id="3734859">bool</span>&nbsp;<span class="op" id="3734864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3734867">if</span>&nbsp;<span class="ident" id="3734870">s</span>&nbsp;<span class="op" id="3734872">==</span>&nbsp;<span class="string" id="3734875">&#34;&#34;</span>&nbsp;<span class="op" id="3734878">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3734882">return</span>&nbsp;<span class="builtintype" id="3734889">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3734896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3734899">for</span>&nbsp;<span class="ident" id="3734903">_</span><span class="op" id="3734904">,</span>&nbsp;<span class="ident" id="3734906">c</span>&nbsp;<span class="op" id="3734908">:=</span>&nbsp;<span class="keyword" id="3734911">range</span>&nbsp;<span class="ident" id="3734917">s</span>&nbsp;<span class="op" id="3734919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3734923">switch</span>&nbsp;<span class="op" id="3734930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3734934">case</span>&nbsp;<span class="ident" id="3734939">strings</span><span class="op" id="3734946">.</span><span class="ident" id="3734947">ContainsRune</span><span class="op" id="3734959">(</span><span class="string" id="3734960">&#34;!#$%&amp;()*+-./:&lt;=&gt;?@[]^_{|}~&nbsp;&#34;</span><span class="op" id="3734989">,</span>&nbsp;<span class="ident" id="3734991">c</span><span class="op" id="3734992">)</span><span class="op" id="3734993">:</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3734998">//&nbsp;Backslash&nbsp;and&nbsp;quote&nbsp;chars&nbsp;are&nbsp;reserved,&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3735048">//&nbsp;otherwise&nbsp;any&nbsp;punctuation&nbsp;chars&nbsp;are&nbsp;allowed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3735098">//&nbsp;in&nbsp;a&nbsp;tag&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735118">default</span><span class="op" id="3735125">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735130">if</span>&nbsp;<span class="op" id="3735133">!</span><span class="ident" id="3735134">unicode</span><span class="op" id="3735141">.</span><span class="ident" id="3735142">IsLetter</span><span class="op" id="3735150">(</span><span class="ident" id="3735151">c</span><span class="op" id="3735152">)</span>&nbsp;<span class="op" id="3735154">&amp;&amp;</span>&nbsp;<span class="op" id="3735157">!</span><span class="ident" id="3735158">unicode</span><span class="op" id="3735165">.</span><span class="ident" id="3735166">IsDigit</span><span class="op" id="3735173">(</span><span class="ident" id="3735174">c</span><span class="op" id="3735175">)</span>&nbsp;<span class="op" id="3735177">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735183">return</span>&nbsp;<span class="builtintype" id="3735190">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3735199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3735203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3735206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735209">return</span>&nbsp;<span class="builtintype" id="3735216">true</span><br>
<span class="lineno">750</span><span class="op" id="3735221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3735224">func</span>&nbsp;<span class="ident" id="3735229">fieldByIndex</span><span class="op" id="3735241">(</span><span class="ident" id="3735242">v</span>&nbsp;<span class="ident" id="3735244">reflect</span><span class="op" id="3735251">.</span><span class="ident" id="3735252">Value</span><span class="op" id="3735257">,</span>&nbsp;<span class="ident" id="3735259">index</span>&nbsp;<span class="op" id="3735265">[</span><span class="op" id="3735266">]</span><span class="builtintype" id="3735267">int</span><span class="op" id="3735270">)</span>&nbsp;<span class="ident" id="3735272">reflect</span><span class="op" id="3735279">.</span><span class="ident" id="3735280">Value</span>&nbsp;<span class="op" id="3735286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735289">for</span>&nbsp;<span class="ident" id="3735293">_</span><span class="op" id="3735294">,</span>&nbsp;<span class="ident" id="3735296">i</span>&nbsp;<span class="op" id="3735298">:=</span>&nbsp;<span class="keyword" id="3735301">range</span>&nbsp;<span class="ident" id="3735307">index</span>&nbsp;<span class="op" id="3735313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735317">if</span>&nbsp;<span class="ident" id="3735320">v</span><span class="op" id="3735321">.</span><span class="ident" id="3735322">Kind</span><span class="op" id="3735326">(</span><span class="op" id="3735327">)</span>&nbsp;<span class="op" id="3735329">==</span>&nbsp;<span class="ident" id="3735332">reflect</span><span class="op" id="3735339">.</span><span class="ident" id="3735340">Ptr</span>&nbsp;<span class="op" id="3735344">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735349">if</span>&nbsp;<span class="ident" id="3735352">v</span><span class="op" id="3735353">.</span><span class="ident" id="3735354">IsNil</span><span class="op" id="3735359">(</span><span class="op" id="3735360">)</span>&nbsp;<span class="op" id="3735362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735368">return</span>&nbsp;<span class="ident" id="3735375">reflect</span><span class="op" id="3735382">.</span><span class="ident" id="3735383">Value</span><span class="op" id="3735388">{</span><span class="op" id="3735389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3735394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3735399">v</span>&nbsp;<span class="op" id="3735401">=</span>&nbsp;<span class="ident" id="3735403">v</span><span class="op" id="3735404">.</span><span class="ident" id="3735405">Elem</span><span class="op" id="3735409">(</span><span class="op" id="3735410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3735414">}</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3735418">v</span>&nbsp;<span class="op" id="3735420">=</span>&nbsp;<span class="ident" id="3735422">v</span><span class="op" id="3735423">.</span><span class="ident" id="3735424">Field</span><span class="op" id="3735429">(</span><span class="ident" id="3735430">i</span><span class="op" id="3735431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3735434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735437">return</span>&nbsp;<span class="ident" id="3735444">v</span><br>
<span class="lineno"></span><span class="op" id="3735446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">765</span><span class="keyword" id="3735449">func</span>&nbsp;<span class="ident" id="3735454">typeByIndex</span><span class="op" id="3735465">(</span><span class="ident" id="3735466">t</span>&nbsp;<span class="ident" id="3735468">reflect</span><span class="op" id="3735475">.</span><span class="ident" id="3735476">Type</span><span class="op" id="3735480">,</span>&nbsp;<span class="ident" id="3735482">index</span>&nbsp;<span class="op" id="3735488">[</span><span class="op" id="3735489">]</span><span class="builtintype" id="3735490">int</span><span class="op" id="3735493">)</span>&nbsp;<span class="ident" id="3735495">reflect</span><span class="op" id="3735502">.</span><span class="ident" id="3735503">Type</span>&nbsp;<span class="op" id="3735508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735511">for</span>&nbsp;<span class="ident" id="3735515">_</span><span class="op" id="3735516">,</span>&nbsp;<span class="ident" id="3735518">i</span>&nbsp;<span class="op" id="3735520">:=</span>&nbsp;<span class="keyword" id="3735523">range</span>&nbsp;<span class="ident" id="3735529">index</span>&nbsp;<span class="op" id="3735535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735539">if</span>&nbsp;<span class="ident" id="3735542">t</span><span class="op" id="3735543">.</span><span class="ident" id="3735544">Kind</span><span class="op" id="3735548">(</span><span class="op" id="3735549">)</span>&nbsp;<span class="op" id="3735551">==</span>&nbsp;<span class="ident" id="3735554">reflect</span><span class="op" id="3735561">.</span><span class="ident" id="3735562">Ptr</span>&nbsp;<span class="op" id="3735566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3735571">t</span>&nbsp;<span class="op" id="3735573">=</span>&nbsp;<span class="ident" id="3735575">t</span><span class="op" id="3735576">.</span><span class="ident" id="3735577">Elem</span><span class="op" id="3735581">(</span><span class="op" id="3735582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3735586">}</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3735590">t</span>&nbsp;<span class="op" id="3735592">=</span>&nbsp;<span class="ident" id="3735594">t</span><span class="op" id="3735595">.</span><span class="ident" id="3735596">Field</span><span class="op" id="3735601">(</span><span class="ident" id="3735602">i</span><span class="op" id="3735603">)</span><span class="op" id="3735604">.</span><span class="ident" id="3735605">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3735611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735614">return</span>&nbsp;<span class="ident" id="3735621">t</span><br>
<span class="lineno"></span><span class="op" id="3735623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">775</span><span class="comment" id="3735626">//&nbsp;stringValues&nbsp;is&nbsp;a&nbsp;slice&nbsp;of&nbsp;reflect.Value&nbsp;holding&nbsp;*reflect.StringValue.</span><br>
<span class="lineno"></span><span class="comment" id="3735700">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;methods&nbsp;to&nbsp;sort&nbsp;by&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="3735748">type</span>&nbsp;<span class="ident" id="3735753">stringValues</span>&nbsp;<span class="op" id="3735766">[</span><span class="op" id="3735767">]</span><span class="ident" id="3735768">reflect</span><span class="op" id="3735775">.</span><span class="ident" id="3735776">Value</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3735783">func</span>&nbsp;<span class="op" id="3735788">(</span><span class="ident" id="3735789">sv</span>&nbsp;<span class="ident" id="3735792">stringValues</span><span class="op" id="3735804">)</span>&nbsp;<span class="ident" id="3735806">Len</span><span class="op" id="3735809">(</span><span class="op" id="3735810">)</span>&nbsp;<span class="builtintype" id="3735812">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3735826">{</span>&nbsp;<span class="keyword" id="3735828">return</span>&nbsp;<span class="builtinfunc" id="3735835">len</span><span class="op" id="3735838">(</span><span class="ident" id="3735839">sv</span><span class="op" id="3735841">)</span>&nbsp;<span class="op" id="3735843">}</span><br>
<span class="lineno">780</span><span class="keyword" id="3735845">func</span>&nbsp;<span class="op" id="3735850">(</span><span class="ident" id="3735851">sv</span>&nbsp;<span class="ident" id="3735854">stringValues</span><span class="op" id="3735866">)</span>&nbsp;<span class="ident" id="3735868">Swap</span><span class="op" id="3735872">(</span><span class="ident" id="3735873">i</span><span class="op" id="3735874">,</span>&nbsp;<span class="ident" id="3735876">j</span>&nbsp;<span class="builtintype" id="3735878">int</span><span class="op" id="3735881">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3735888">{</span>&nbsp;<span class="ident" id="3735890">sv</span><span class="op" id="3735892">[</span><span class="ident" id="3735893">i</span><span class="op" id="3735894">]</span><span class="op" id="3735895">,</span>&nbsp;<span class="ident" id="3735897">sv</span><span class="op" id="3735899">[</span><span class="ident" id="3735900">j</span><span class="op" id="3735901">]</span>&nbsp;<span class="op" id="3735903">=</span>&nbsp;<span class="ident" id="3735905">sv</span><span class="op" id="3735907">[</span><span class="ident" id="3735908">j</span><span class="op" id="3735909">]</span><span class="op" id="3735910">,</span>&nbsp;<span class="ident" id="3735912">sv</span><span class="op" id="3735914">[</span><span class="ident" id="3735915">i</span><span class="op" id="3735916">]</span>&nbsp;<span class="op" id="3735918">}</span><br>
<span class="lineno"></span><span class="keyword" id="3735920">func</span>&nbsp;<span class="op" id="3735925">(</span><span class="ident" id="3735926">sv</span>&nbsp;<span class="ident" id="3735929">stringValues</span><span class="op" id="3735941">)</span>&nbsp;<span class="ident" id="3735943">Less</span><span class="op" id="3735947">(</span><span class="ident" id="3735948">i</span><span class="op" id="3735949">,</span>&nbsp;<span class="ident" id="3735951">j</span>&nbsp;<span class="builtintype" id="3735953">int</span><span class="op" id="3735956">)</span>&nbsp;<span class="builtintype" id="3735958">bool</span>&nbsp;<span class="op" id="3735963">{</span>&nbsp;<span class="keyword" id="3735965">return</span>&nbsp;<span class="ident" id="3735972">sv</span><span class="op" id="3735974">.</span><span class="ident" id="3735975">get</span><span class="op" id="3735978">(</span><span class="ident" id="3735979">i</span><span class="op" id="3735980">)</span>&nbsp;<span class="op" id="3735982">&lt;</span>&nbsp;<span class="ident" id="3735984">sv</span><span class="op" id="3735986">.</span><span class="ident" id="3735987">get</span><span class="op" id="3735990">(</span><span class="ident" id="3735991">j</span><span class="op" id="3735992">)</span>&nbsp;<span class="op" id="3735994">}</span><br>
<span class="lineno"></span><span class="keyword" id="3735996">func</span>&nbsp;<span class="op" id="3736001">(</span><span class="ident" id="3736002">sv</span>&nbsp;<span class="ident" id="3736005">stringValues</span><span class="op" id="3736017">)</span>&nbsp;<span class="ident" id="3736019">get</span><span class="op" id="3736022">(</span><span class="ident" id="3736023">i</span>&nbsp;<span class="builtintype" id="3736025">int</span><span class="op" id="3736028">)</span>&nbsp;<span class="builtintype" id="3736030">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3736039">{</span>&nbsp;<span class="keyword" id="3736041">return</span>&nbsp;<span class="ident" id="3736048">sv</span><span class="op" id="3736050">[</span><span class="ident" id="3736051">i</span><span class="op" id="3736052">]</span><span class="op" id="3736053">.</span><span class="ident" id="3736054">String</span><span class="op" id="3736060">(</span><span class="op" id="3736061">)</span>&nbsp;<span class="op" id="3736063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3736066">//&nbsp;NOTE:&nbsp;keep&nbsp;in&nbsp;sync&nbsp;with&nbsp;stringBytes&nbsp;below.</span><br>
<span class="lineno">785</span><span class="keyword" id="3736112">func</span>&nbsp;<span class="op" id="3736117">(</span><span class="ident" id="3736118">e</span>&nbsp;<span class="op" id="3736120">*</span><span class="ident" id="3736121">encodeState</span><span class="op" id="3736132">)</span>&nbsp;<span class="builtintype" id="3736134">string</span><span class="op" id="3736140">(</span><span class="ident" id="3736141">s</span>&nbsp;<span class="builtintype" id="3736143">string</span><span class="op" id="3736149">)</span>&nbsp;<span class="op" id="3736151">(</span><span class="builtintype" id="3736152">int</span><span class="op" id="3736155">,</span>&nbsp;<span class="builtintype" id="3736157">error</span><span class="op" id="3736162">)</span>&nbsp;<span class="op" id="3736164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3736167">len0</span>&nbsp;<span class="op" id="3736172">:=</span>&nbsp;<span class="ident" id="3736175">e</span><span class="op" id="3736176">.</span><span class="ident" id="3736177">Len</span><span class="op" id="3736180">(</span><span class="op" id="3736181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3736184">e</span><span class="op" id="3736185">.</span><span class="ident" id="3736186">WriteByte</span><span class="op" id="3736195">(</span><span class="string" id="3736196">&#39;&#34;&#39;</span><span class="op" id="3736199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3736202">start</span>&nbsp;<span class="op" id="3736208">:=</span>&nbsp;<span class="num" id="3736211">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736214">for</span>&nbsp;<span class="ident" id="3736218">i</span>&nbsp;<span class="op" id="3736220">:=</span>&nbsp;<span class="num" id="3736223">0</span><span class="op" id="3736224">;</span>&nbsp;<span class="ident" id="3736226">i</span>&nbsp;<span class="op" id="3736228">&lt;</span>&nbsp;<span class="builtinfunc" id="3736230">len</span><span class="op" id="3736233">(</span><span class="ident" id="3736234">s</span><span class="op" id="3736235">)</span><span class="op" id="3736236">;</span>&nbsp;<span class="op" id="3736238">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736242">if</span>&nbsp;<span class="ident" id="3736245">b</span>&nbsp;<span class="op" id="3736247">:=</span>&nbsp;<span class="ident" id="3736250">s</span><span class="op" id="3736251">[</span><span class="ident" id="3736252">i</span><span class="op" id="3736253">]</span><span class="op" id="3736254">;</span>&nbsp;<span class="ident" id="3736256">b</span>&nbsp;<span class="op" id="3736258">&lt;</span>&nbsp;<span class="ident" id="3736260">utf8</span><span class="op" id="3736264">.</span><span class="ident" id="3736265">RuneSelf</span>&nbsp;<span class="op" id="3736274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736279">if</span>&nbsp;<span class="num" id="3736282">0x20</span>&nbsp;<span class="op" id="3736287">&lt;=</span>&nbsp;<span class="ident" id="3736290">b</span>&nbsp;<span class="op" id="3736292">&amp;&amp;</span>&nbsp;<span class="ident" id="3736295">b</span>&nbsp;<span class="op" id="3736297">!=</span>&nbsp;<span class="string" id="3736300">&#39;\\&#39;</span>&nbsp;<span class="op" id="3736305">&amp;&amp;</span>&nbsp;<span class="ident" id="3736308">b</span>&nbsp;<span class="op" id="3736310">!=</span>&nbsp;<span class="string" id="3736313">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="3736317">&amp;&amp;</span>&nbsp;<span class="ident" id="3736320">b</span>&nbsp;<span class="op" id="3736322">!=</span>&nbsp;<span class="string" id="3736325">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="3736329">&amp;&amp;</span>&nbsp;<span class="ident" id="3736332">b</span>&nbsp;<span class="op" id="3736334">!=</span>&nbsp;<span class="string" id="3736337">&#39;&gt;&#39;</span>&nbsp;<span class="op" id="3736341">&amp;&amp;</span>&nbsp;<span class="ident" id="3736344">b</span>&nbsp;<span class="op" id="3736346">!=</span>&nbsp;<span class="string" id="3736349">&#39;&amp;&#39;</span>&nbsp;<span class="op" id="3736353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3736359">i</span><span class="op" id="3736360">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736367">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3736379">}</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736384">if</span>&nbsp;<span class="ident" id="3736387">start</span>&nbsp;<span class="op" id="3736393">&lt;</span>&nbsp;<span class="ident" id="3736395">i</span>&nbsp;<span class="op" id="3736397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3736403">e</span><span class="op" id="3736404">.</span><span class="ident" id="3736405">WriteString</span><span class="op" id="3736416">(</span><span class="ident" id="3736417">s</span><span class="op" id="3736418">[</span><span class="ident" id="3736419">start</span><span class="op" id="3736424">:</span><span class="ident" id="3736425">i</span><span class="op" id="3736426">]</span><span class="op" id="3736427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3736432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736437">switch</span>&nbsp;<span class="ident" id="3736444">b</span>&nbsp;<span class="op" id="3736446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736451">case</span>&nbsp;<span class="string" id="3736456">&#39;\\&#39;</span><span class="op" id="3736460">,</span>&nbsp;<span class="string" id="3736462">&#39;&#34;&#39;</span><span class="op" id="3736465">:</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3736471">e</span><span class="op" id="3736472">.</span><span class="ident" id="3736473">WriteByte</span><span class="op" id="3736482">(</span><span class="string" id="3736483">&#39;\\&#39;</span><span class="op" id="3736487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3736493">e</span><span class="op" id="3736494">.</span><span class="ident" id="3736495">WriteByte</span><span class="op" id="3736504">(</span><span class="ident" id="3736505">b</span><span class="op" id="3736506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736511">case</span>&nbsp;<span class="string" id="3736516">&#39;\n&#39;</span><span class="op" id="3736520">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3736526">e</span><span class="op" id="3736527">.</span><span class="ident" id="3736528">WriteByte</span><span class="op" id="3736537">(</span><span class="string" id="3736538">&#39;\\&#39;</span><span class="op" id="3736542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3736548">e</span><span class="op" id="3736549">.</span><span class="ident" id="3736550">WriteByte</span><span class="op" id="3736559">(</span><span class="string" id="3736560">&#39;n&#39;</span><span class="op" id="3736563">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736568">case</span>&nbsp;<span class="string" id="3736573">&#39;\r&#39;</span><span class="op" id="3736577">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3736583">e</span><span class="op" id="3736584">.</span><span class="ident" id="3736585">WriteByte</span><span class="op" id="3736594">(</span><span class="string" id="3736595">&#39;\\&#39;</span><span class="op" id="3736599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3736605">e</span><span class="op" id="3736606">.</span><span class="ident" id="3736607">WriteByte</span><span class="op" id="3736616">(</span><span class="string" id="3736617">&#39;r&#39;</span><span class="op" id="3736620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736625">case</span>&nbsp;<span class="string" id="3736630">&#39;\t&#39;</span><span class="op" id="3736634">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3736640">e</span><span class="op" id="3736641">.</span><span class="ident" id="3736642">WriteByte</span><span class="op" id="3736651">(</span><span class="string" id="3736652">&#39;\\&#39;</span><span class="op" id="3736656">)</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3736662">e</span><span class="op" id="3736663">.</span><span class="ident" id="3736664">WriteByte</span><span class="op" id="3736673">(</span><span class="string" id="3736674">&#39;t&#39;</span><span class="op" id="3736677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736682">default</span><span class="op" id="3736689">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3736695">//&nbsp;This&nbsp;encodes&nbsp;bytes&nbsp;&lt;&nbsp;0x20&nbsp;except&nbsp;for&nbsp;\n&nbsp;and&nbsp;\r,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3736750">//&nbsp;as&nbsp;well&nbsp;as&nbsp;&lt;,&nbsp;&gt;&nbsp;and&nbsp;&amp;.&nbsp;The&nbsp;latter&nbsp;are&nbsp;escaped&nbsp;because&nbsp;they</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3736816">//&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;when&nbsp;user-controlled&nbsp;strings</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3736879">//&nbsp;are&nbsp;rendered&nbsp;into&nbsp;JSON&nbsp;and&nbsp;served&nbsp;to&nbsp;some&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3736938">e</span><span class="op" id="3736939">.</span><span class="ident" id="3736940">WriteString</span><span class="op" id="3736951">(</span><span class="string" id="3736952">`\u00`</span><span class="op" id="3736958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3736964">e</span><span class="op" id="3736965">.</span><span class="ident" id="3736966">WriteByte</span><span class="op" id="3736975">(</span><span class="ident" id="3736976">hex</span><span class="op" id="3736979">[</span><span class="ident" id="3736980">b</span><span class="op" id="3736981">&gt;&gt;</span><span class="num" id="3736983">4</span><span class="op" id="3736984">]</span><span class="op" id="3736985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3736991">e</span><span class="op" id="3736992">.</span><span class="ident" id="3736993">WriteByte</span><span class="op" id="3737002">(</span><span class="ident" id="3737003">hex</span><span class="op" id="3737006">[</span><span class="ident" id="3737007">b</span><span class="op" id="3737008">&amp;</span><span class="num" id="3737009">0xF</span><span class="op" id="3737012">]</span><span class="op" id="3737013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3737018">}</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3737023">i</span><span class="op" id="3737024">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3737030">start</span>&nbsp;<span class="op" id="3737036">=</span>&nbsp;<span class="ident" id="3737038">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3737043">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3737054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3737058">c</span><span class="op" id="3737059">,</span>&nbsp;<span class="ident" id="3737061">size</span>&nbsp;<span class="op" id="3737066">:=</span>&nbsp;<span class="ident" id="3737069">utf8</span><span class="op" id="3737073">.</span><span class="ident" id="3737074">DecodeRuneInString</span><span class="op" id="3737092">(</span><span class="ident" id="3737093">s</span><span class="op" id="3737094">[</span><span class="ident" id="3737095">i</span><span class="op" id="3737096">:</span><span class="op" id="3737097">]</span><span class="op" id="3737098">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3737102">if</span>&nbsp;<span class="ident" id="3737105">c</span>&nbsp;<span class="op" id="3737107">==</span>&nbsp;<span class="ident" id="3737110">utf8</span><span class="op" id="3737114">.</span><span class="ident" id="3737115">RuneError</span>&nbsp;<span class="op" id="3737125">&amp;&amp;</span>&nbsp;<span class="ident" id="3737128">size</span>&nbsp;<span class="op" id="3737133">==</span>&nbsp;<span class="num" id="3737136">1</span>&nbsp;<span class="op" id="3737138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3737143">if</span>&nbsp;<span class="ident" id="3737146">start</span>&nbsp;<span class="op" id="3737152">&lt;</span>&nbsp;<span class="ident" id="3737154">i</span>&nbsp;<span class="op" id="3737156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3737162">e</span><span class="op" id="3737163">.</span><span class="ident" id="3737164">WriteString</span><span class="op" id="3737175">(</span><span class="ident" id="3737176">s</span><span class="op" id="3737177">[</span><span class="ident" id="3737178">start</span><span class="op" id="3737183">:</span><span class="ident" id="3737184">i</span><span class="op" id="3737185">]</span><span class="op" id="3737186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3737191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3737196">e</span><span class="op" id="3737197">.</span><span class="ident" id="3737198">WriteString</span><span class="op" id="3737209">(</span><span class="string" id="3737210">`\ufffd`</span><span class="op" id="3737218">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3737223">i</span>&nbsp;<span class="op" id="3737225">+=</span>&nbsp;<span class="ident" id="3737228">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3737236">start</span>&nbsp;<span class="op" id="3737242">=</span>&nbsp;<span class="ident" id="3737244">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3737249">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3737260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3737264">//&nbsp;U+2028&nbsp;is&nbsp;LINE&nbsp;SEPARATOR.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3737295">//&nbsp;U+2029&nbsp;is&nbsp;PARAGRAPH&nbsp;SEPARATOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3737331">//&nbsp;They&nbsp;are&nbsp;both&nbsp;technically&nbsp;valid&nbsp;characters&nbsp;in&nbsp;JSON&nbsp;strings,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3737396">//&nbsp;but&nbsp;don&#39;t&nbsp;work&nbsp;in&nbsp;JSONP,&nbsp;which&nbsp;has&nbsp;to&nbsp;be&nbsp;evaluated&nbsp;as&nbsp;JavaScript,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3737467">//&nbsp;and&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;there.&nbsp;It&nbsp;is&nbsp;valid&nbsp;JSON&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3737530">//&nbsp;escape&nbsp;them,&nbsp;so&nbsp;we&nbsp;do&nbsp;so&nbsp;unconditionally.</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3737577">//&nbsp;See&nbsp;http://timelessrepo.com/json-isnt-a-javascript-subset&nbsp;for&nbsp;discussion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3737656">if</span>&nbsp;<span class="ident" id="3737659">c</span>&nbsp;<span class="op" id="3737661">==</span>&nbsp;<span class="string" id="3737664">&#39;\u2028&#39;</span>&nbsp;<span class="op" id="3737673">||</span>&nbsp;<span class="ident" id="3737676">c</span>&nbsp;<span class="op" id="3737678">==</span>&nbsp;<span class="string" id="3737681">&#39;\u2029&#39;</span>&nbsp;<span class="op" id="3737690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3737695">if</span>&nbsp;<span class="ident" id="3737698">start</span>&nbsp;<span class="op" id="3737704">&lt;</span>&nbsp;<span class="ident" id="3737706">i</span>&nbsp;<span class="op" id="3737708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3737714">e</span><span class="op" id="3737715">.</span><span class="ident" id="3737716">WriteString</span><span class="op" id="3737727">(</span><span class="ident" id="3737728">s</span><span class="op" id="3737729">[</span><span class="ident" id="3737730">start</span><span class="op" id="3737735">:</span><span class="ident" id="3737736">i</span><span class="op" id="3737737">]</span><span class="op" id="3737738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3737743">}</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3737748">e</span><span class="op" id="3737749">.</span><span class="ident" id="3737750">WriteString</span><span class="op" id="3737761">(</span><span class="string" id="3737762">`\u202`</span><span class="op" id="3737769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3737774">e</span><span class="op" id="3737775">.</span><span class="ident" id="3737776">WriteByte</span><span class="op" id="3737785">(</span><span class="ident" id="3737786">hex</span><span class="op" id="3737789">[</span><span class="ident" id="3737790">c</span><span class="op" id="3737791">&amp;</span><span class="num" id="3737792">0xF</span><span class="op" id="3737795">]</span><span class="op" id="3737796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3737801">i</span>&nbsp;<span class="op" id="3737803">+=</span>&nbsp;<span class="ident" id="3737806">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3737814">start</span>&nbsp;<span class="op" id="3737820">=</span>&nbsp;<span class="ident" id="3737822">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3737827">continue</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3737838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3737842">i</span>&nbsp;<span class="op" id="3737844">+=</span>&nbsp;<span class="ident" id="3737847">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3737853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3737856">if</span>&nbsp;<span class="ident" id="3737859">start</span>&nbsp;<span class="op" id="3737865">&lt;</span>&nbsp;<span class="builtinfunc" id="3737867">len</span><span class="op" id="3737870">(</span><span class="ident" id="3737871">s</span><span class="op" id="3737872">)</span>&nbsp;<span class="op" id="3737874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3737878">e</span><span class="op" id="3737879">.</span><span class="ident" id="3737880">WriteString</span><span class="op" id="3737891">(</span><span class="ident" id="3737892">s</span><span class="op" id="3737893">[</span><span class="ident" id="3737894">start</span><span class="op" id="3737899">:</span><span class="op" id="3737900">]</span><span class="op" id="3737901">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3737904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3737907">e</span><span class="op" id="3737908">.</span><span class="ident" id="3737909">WriteByte</span><span class="op" id="3737918">(</span><span class="string" id="3737919">&#39;&#34;&#39;</span><span class="op" id="3737922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3737925">return</span>&nbsp;<span class="ident" id="3737932">e</span><span class="op" id="3737933">.</span><span class="ident" id="3737934">Len</span><span class="op" id="3737937">(</span><span class="op" id="3737938">)</span>&nbsp;<span class="op" id="3737940">-</span>&nbsp;<span class="ident" id="3737942">len0</span><span class="op" id="3737946">,</span>&nbsp;<span class="ident" id="3737948">nil</span><br>
<span class="lineno"></span><span class="op" id="3737952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span><span class="comment" id="3737955">//&nbsp;NOTE:&nbsp;keep&nbsp;in&nbsp;sync&nbsp;with&nbsp;string&nbsp;above.</span><br>
<span class="lineno"></span><span class="keyword" id="3737996">func</span>&nbsp;<span class="op" id="3738001">(</span><span class="ident" id="3738002">e</span>&nbsp;<span class="op" id="3738004">*</span><span class="ident" id="3738005">encodeState</span><span class="op" id="3738016">)</span>&nbsp;<span class="ident" id="3738018">stringBytes</span><span class="op" id="3738029">(</span><span class="ident" id="3738030">s</span>&nbsp;<span class="op" id="3738032">[</span><span class="op" id="3738033">]</span><span class="builtintype" id="3738034">byte</span><span class="op" id="3738038">)</span>&nbsp;<span class="op" id="3738040">(</span><span class="builtintype" id="3738041">int</span><span class="op" id="3738044">,</span>&nbsp;<span class="builtintype" id="3738046">error</span><span class="op" id="3738051">)</span>&nbsp;<span class="op" id="3738053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738056">len0</span>&nbsp;<span class="op" id="3738061">:=</span>&nbsp;<span class="ident" id="3738064">e</span><span class="op" id="3738065">.</span><span class="ident" id="3738066">Len</span><span class="op" id="3738069">(</span><span class="op" id="3738070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738073">e</span><span class="op" id="3738074">.</span><span class="ident" id="3738075">WriteByte</span><span class="op" id="3738084">(</span><span class="string" id="3738085">&#39;&#34;&#39;</span><span class="op" id="3738088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738091">start</span>&nbsp;<span class="op" id="3738097">:=</span>&nbsp;<span class="num" id="3738100">0</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738103">for</span>&nbsp;<span class="ident" id="3738107">i</span>&nbsp;<span class="op" id="3738109">:=</span>&nbsp;<span class="num" id="3738112">0</span><span class="op" id="3738113">;</span>&nbsp;<span class="ident" id="3738115">i</span>&nbsp;<span class="op" id="3738117">&lt;</span>&nbsp;<span class="builtinfunc" id="3738119">len</span><span class="op" id="3738122">(</span><span class="ident" id="3738123">s</span><span class="op" id="3738124">)</span><span class="op" id="3738125">;</span>&nbsp;<span class="op" id="3738127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738131">if</span>&nbsp;<span class="ident" id="3738134">b</span>&nbsp;<span class="op" id="3738136">:=</span>&nbsp;<span class="ident" id="3738139">s</span><span class="op" id="3738140">[</span><span class="ident" id="3738141">i</span><span class="op" id="3738142">]</span><span class="op" id="3738143">;</span>&nbsp;<span class="ident" id="3738145">b</span>&nbsp;<span class="op" id="3738147">&lt;</span>&nbsp;<span class="ident" id="3738149">utf8</span><span class="op" id="3738153">.</span><span class="ident" id="3738154">RuneSelf</span>&nbsp;<span class="op" id="3738163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738168">if</span>&nbsp;<span class="num" id="3738171">0x20</span>&nbsp;<span class="op" id="3738176">&lt;=</span>&nbsp;<span class="ident" id="3738179">b</span>&nbsp;<span class="op" id="3738181">&amp;&amp;</span>&nbsp;<span class="ident" id="3738184">b</span>&nbsp;<span class="op" id="3738186">!=</span>&nbsp;<span class="string" id="3738189">&#39;\\&#39;</span>&nbsp;<span class="op" id="3738194">&amp;&amp;</span>&nbsp;<span class="ident" id="3738197">b</span>&nbsp;<span class="op" id="3738199">!=</span>&nbsp;<span class="string" id="3738202">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="3738206">&amp;&amp;</span>&nbsp;<span class="ident" id="3738209">b</span>&nbsp;<span class="op" id="3738211">!=</span>&nbsp;<span class="string" id="3738214">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="3738218">&amp;&amp;</span>&nbsp;<span class="ident" id="3738221">b</span>&nbsp;<span class="op" id="3738223">!=</span>&nbsp;<span class="string" id="3738226">&#39;&gt;&#39;</span>&nbsp;<span class="op" id="3738230">&amp;&amp;</span>&nbsp;<span class="ident" id="3738233">b</span>&nbsp;<span class="op" id="3738235">!=</span>&nbsp;<span class="string" id="3738238">&#39;&amp;&#39;</span>&nbsp;<span class="op" id="3738242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738248">i</span><span class="op" id="3738249">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738256">continue</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3738268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738273">if</span>&nbsp;<span class="ident" id="3738276">start</span>&nbsp;<span class="op" id="3738282">&lt;</span>&nbsp;<span class="ident" id="3738284">i</span>&nbsp;<span class="op" id="3738286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738292">e</span><span class="op" id="3738293">.</span><span class="ident" id="3738294">Write</span><span class="op" id="3738299">(</span><span class="ident" id="3738300">s</span><span class="op" id="3738301">[</span><span class="ident" id="3738302">start</span><span class="op" id="3738307">:</span><span class="ident" id="3738308">i</span><span class="op" id="3738309">]</span><span class="op" id="3738310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3738315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738320">switch</span>&nbsp;<span class="ident" id="3738327">b</span>&nbsp;<span class="op" id="3738329">{</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738334">case</span>&nbsp;<span class="string" id="3738339">&#39;\\&#39;</span><span class="op" id="3738343">,</span>&nbsp;<span class="string" id="3738345">&#39;&#34;&#39;</span><span class="op" id="3738348">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738354">e</span><span class="op" id="3738355">.</span><span class="ident" id="3738356">WriteByte</span><span class="op" id="3738365">(</span><span class="string" id="3738366">&#39;\\&#39;</span><span class="op" id="3738370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738376">e</span><span class="op" id="3738377">.</span><span class="ident" id="3738378">WriteByte</span><span class="op" id="3738387">(</span><span class="ident" id="3738388">b</span><span class="op" id="3738389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738394">case</span>&nbsp;<span class="string" id="3738399">&#39;\n&#39;</span><span class="op" id="3738403">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738409">e</span><span class="op" id="3738410">.</span><span class="ident" id="3738411">WriteByte</span><span class="op" id="3738420">(</span><span class="string" id="3738421">&#39;\\&#39;</span><span class="op" id="3738425">)</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738431">e</span><span class="op" id="3738432">.</span><span class="ident" id="3738433">WriteByte</span><span class="op" id="3738442">(</span><span class="string" id="3738443">&#39;n&#39;</span><span class="op" id="3738446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738451">case</span>&nbsp;<span class="string" id="3738456">&#39;\r&#39;</span><span class="op" id="3738460">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738466">e</span><span class="op" id="3738467">.</span><span class="ident" id="3738468">WriteByte</span><span class="op" id="3738477">(</span><span class="string" id="3738478">&#39;\\&#39;</span><span class="op" id="3738482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738488">e</span><span class="op" id="3738489">.</span><span class="ident" id="3738490">WriteByte</span><span class="op" id="3738499">(</span><span class="string" id="3738500">&#39;r&#39;</span><span class="op" id="3738503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738508">case</span>&nbsp;<span class="string" id="3738513">&#39;\t&#39;</span><span class="op" id="3738517">:</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738523">e</span><span class="op" id="3738524">.</span><span class="ident" id="3738525">WriteByte</span><span class="op" id="3738534">(</span><span class="string" id="3738535">&#39;\\&#39;</span><span class="op" id="3738539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738545">e</span><span class="op" id="3738546">.</span><span class="ident" id="3738547">WriteByte</span><span class="op" id="3738556">(</span><span class="string" id="3738557">&#39;t&#39;</span><span class="op" id="3738560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738565">default</span><span class="op" id="3738572">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3738578">//&nbsp;This&nbsp;encodes&nbsp;bytes&nbsp;&lt;&nbsp;0x20&nbsp;except&nbsp;for&nbsp;\n&nbsp;and&nbsp;\r,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3738633">//&nbsp;as&nbsp;well&nbsp;as&nbsp;&lt;,&nbsp;&gt;,&nbsp;and&nbsp;&amp;.&nbsp;The&nbsp;latter&nbsp;are&nbsp;escaped&nbsp;because&nbsp;they</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3738700">//&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;when&nbsp;user-controlled&nbsp;strings</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3738763">//&nbsp;are&nbsp;rendered&nbsp;into&nbsp;JSON&nbsp;and&nbsp;served&nbsp;to&nbsp;some&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738822">e</span><span class="op" id="3738823">.</span><span class="ident" id="3738824">WriteString</span><span class="op" id="3738835">(</span><span class="string" id="3738836">`\u00`</span><span class="op" id="3738842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738848">e</span><span class="op" id="3738849">.</span><span class="ident" id="3738850">WriteByte</span><span class="op" id="3738859">(</span><span class="ident" id="3738860">hex</span><span class="op" id="3738863">[</span><span class="ident" id="3738864">b</span><span class="op" id="3738865">&gt;&gt;</span><span class="num" id="3738867">4</span><span class="op" id="3738868">]</span><span class="op" id="3738869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738875">e</span><span class="op" id="3738876">.</span><span class="ident" id="3738877">WriteByte</span><span class="op" id="3738886">(</span><span class="ident" id="3738887">hex</span><span class="op" id="3738890">[</span><span class="ident" id="3738891">b</span><span class="op" id="3738892">&amp;</span><span class="num" id="3738893">0xF</span><span class="op" id="3738896">]</span><span class="op" id="3738897">)</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3738902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738907">i</span><span class="op" id="3738908">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738914">start</span>&nbsp;<span class="op" id="3738920">=</span>&nbsp;<span class="ident" id="3738922">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738927">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3738938">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3738942">c</span><span class="op" id="3738943">,</span>&nbsp;<span class="ident" id="3738945">size</span>&nbsp;<span class="op" id="3738950">:=</span>&nbsp;<span class="ident" id="3738953">utf8</span><span class="op" id="3738957">.</span><span class="ident" id="3738958">DecodeRune</span><span class="op" id="3738968">(</span><span class="ident" id="3738969">s</span><span class="op" id="3738970">[</span><span class="ident" id="3738971">i</span><span class="op" id="3738972">:</span><span class="op" id="3738973">]</span><span class="op" id="3738974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3738978">if</span>&nbsp;<span class="ident" id="3738981">c</span>&nbsp;<span class="op" id="3738983">==</span>&nbsp;<span class="ident" id="3738986">utf8</span><span class="op" id="3738990">.</span><span class="ident" id="3738991">RuneError</span>&nbsp;<span class="op" id="3739001">&amp;&amp;</span>&nbsp;<span class="ident" id="3739004">size</span>&nbsp;<span class="op" id="3739009">==</span>&nbsp;<span class="num" id="3739012">1</span>&nbsp;<span class="op" id="3739014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3739019">if</span>&nbsp;<span class="ident" id="3739022">start</span>&nbsp;<span class="op" id="3739028">&lt;</span>&nbsp;<span class="ident" id="3739030">i</span>&nbsp;<span class="op" id="3739032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739038">e</span><span class="op" id="3739039">.</span><span class="ident" id="3739040">Write</span><span class="op" id="3739045">(</span><span class="ident" id="3739046">s</span><span class="op" id="3739047">[</span><span class="ident" id="3739048">start</span><span class="op" id="3739053">:</span><span class="ident" id="3739054">i</span><span class="op" id="3739055">]</span><span class="op" id="3739056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3739061">}</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739066">e</span><span class="op" id="3739067">.</span><span class="ident" id="3739068">WriteString</span><span class="op" id="3739079">(</span><span class="string" id="3739080">`\ufffd`</span><span class="op" id="3739088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739093">i</span>&nbsp;<span class="op" id="3739095">+=</span>&nbsp;<span class="ident" id="3739098">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739106">start</span>&nbsp;<span class="op" id="3739112">=</span>&nbsp;<span class="ident" id="3739114">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3739119">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3739130">}</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3739134">//&nbsp;U+2028&nbsp;is&nbsp;LINE&nbsp;SEPARATOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3739165">//&nbsp;U+2029&nbsp;is&nbsp;PARAGRAPH&nbsp;SEPARATOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3739201">//&nbsp;They&nbsp;are&nbsp;both&nbsp;technically&nbsp;valid&nbsp;characters&nbsp;in&nbsp;JSON&nbsp;strings,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3739266">//&nbsp;but&nbsp;don&#39;t&nbsp;work&nbsp;in&nbsp;JSONP,&nbsp;which&nbsp;has&nbsp;to&nbsp;be&nbsp;evaluated&nbsp;as&nbsp;JavaScript,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3739337">//&nbsp;and&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;there.&nbsp;It&nbsp;is&nbsp;valid&nbsp;JSON&nbsp;to</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3739400">//&nbsp;escape&nbsp;them,&nbsp;so&nbsp;we&nbsp;do&nbsp;so&nbsp;unconditionally.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3739447">//&nbsp;See&nbsp;http://timelessrepo.com/json-isnt-a-javascript-subset&nbsp;for&nbsp;discussion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3739526">if</span>&nbsp;<span class="ident" id="3739529">c</span>&nbsp;<span class="op" id="3739531">==</span>&nbsp;<span class="string" id="3739534">&#39;\u2028&#39;</span>&nbsp;<span class="op" id="3739543">||</span>&nbsp;<span class="ident" id="3739546">c</span>&nbsp;<span class="op" id="3739548">==</span>&nbsp;<span class="string" id="3739551">&#39;\u2029&#39;</span>&nbsp;<span class="op" id="3739560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3739565">if</span>&nbsp;<span class="ident" id="3739568">start</span>&nbsp;<span class="op" id="3739574">&lt;</span>&nbsp;<span class="ident" id="3739576">i</span>&nbsp;<span class="op" id="3739578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739584">e</span><span class="op" id="3739585">.</span><span class="ident" id="3739586">Write</span><span class="op" id="3739591">(</span><span class="ident" id="3739592">s</span><span class="op" id="3739593">[</span><span class="ident" id="3739594">start</span><span class="op" id="3739599">:</span><span class="ident" id="3739600">i</span><span class="op" id="3739601">]</span><span class="op" id="3739602">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3739607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739612">e</span><span class="op" id="3739613">.</span><span class="ident" id="3739614">WriteString</span><span class="op" id="3739625">(</span><span class="string" id="3739626">`\u202`</span><span class="op" id="3739633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739638">e</span><span class="op" id="3739639">.</span><span class="ident" id="3739640">WriteByte</span><span class="op" id="3739649">(</span><span class="ident" id="3739650">hex</span><span class="op" id="3739653">[</span><span class="ident" id="3739654">c</span><span class="op" id="3739655">&amp;</span><span class="num" id="3739656">0xF</span><span class="op" id="3739659">]</span><span class="op" id="3739660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739665">i</span>&nbsp;<span class="op" id="3739667">+=</span>&nbsp;<span class="ident" id="3739670">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739678">start</span>&nbsp;<span class="op" id="3739684">=</span>&nbsp;<span class="ident" id="3739686">i</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3739691">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3739702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739706">i</span>&nbsp;<span class="op" id="3739708">+=</span>&nbsp;<span class="ident" id="3739711">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3739717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3739720">if</span>&nbsp;<span class="ident" id="3739723">start</span>&nbsp;<span class="op" id="3739729">&lt;</span>&nbsp;<span class="builtinfunc" id="3739731">len</span><span class="op" id="3739734">(</span><span class="ident" id="3739735">s</span><span class="op" id="3739736">)</span>&nbsp;<span class="op" id="3739738">{</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739742">e</span><span class="op" id="3739743">.</span><span class="ident" id="3739744">Write</span><span class="op" id="3739749">(</span><span class="ident" id="3739750">s</span><span class="op" id="3739751">[</span><span class="ident" id="3739752">start</span><span class="op" id="3739757">:</span><span class="op" id="3739758">]</span><span class="op" id="3739759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3739762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739765">e</span><span class="op" id="3739766">.</span><span class="ident" id="3739767">WriteByte</span><span class="op" id="3739776">(</span><span class="string" id="3739777">&#39;&#34;&#39;</span><span class="op" id="3739780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3739783">return</span>&nbsp;<span class="ident" id="3739790">e</span><span class="op" id="3739791">.</span><span class="ident" id="3739792">Len</span><span class="op" id="3739795">(</span><span class="op" id="3739796">)</span>&nbsp;<span class="op" id="3739798">-</span>&nbsp;<span class="ident" id="3739800">len0</span><span class="op" id="3739804">,</span>&nbsp;<span class="ident" id="3739806">nil</span><br>
<span class="lineno"></span><span class="op" id="3739810">}</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span><span class="comment" id="3739813">//&nbsp;A&nbsp;field&nbsp;represents&nbsp;a&nbsp;single&nbsp;field&nbsp;found&nbsp;in&nbsp;a&nbsp;struct.</span><br>
<span class="lineno"></span><span class="keyword" id="3739869">type</span>&nbsp;<span class="ident" id="3739874">field</span>&nbsp;<span class="keyword" id="3739880">struct</span>&nbsp;<span class="op" id="3739887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739890">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3739900">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739908">nameBytes</span>&nbsp;<span class="op" id="3739918">[</span><span class="op" id="3739919">]</span><span class="builtintype" id="3739920">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3739941">//&nbsp;[]byte(name)</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3739958">equalFold</span>&nbsp;<span class="keyword" id="3739968">func</span><span class="op" id="3739972">(</span><span class="ident" id="3739973">s</span><span class="op" id="3739974">,</span>&nbsp;<span class="ident" id="3739976">t</span>&nbsp;<span class="op" id="3739978">[</span><span class="op" id="3739979">]</span><span class="builtintype" id="3739980">byte</span><span class="op" id="3739984">)</span>&nbsp;<span class="builtintype" id="3739986">bool</span>&nbsp;<span class="comment" id="3739991">//&nbsp;bytes.EqualFold&nbsp;or&nbsp;equivalent</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3740026">tag</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3740036">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3740042">index</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3740052">[</span><span class="op" id="3740053">]</span><span class="builtintype" id="3740054">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3740059">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3740069">reflect</span><span class="op" id="3740076">.</span><span class="ident" id="3740077">Type</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3740083">omitEmpty</span>&nbsp;<span class="builtintype" id="3740093">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3740099">quoted</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3740109">bool</span><br>
<span class="lineno"></span><span class="op" id="3740114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3740117">func</span>&nbsp;<span class="ident" id="3740122">fillField</span><span class="op" id="3740131">(</span><span class="ident" id="3740132">f</span>&nbsp;<span class="ident" id="3740134">field</span><span class="op" id="3740139">)</span>&nbsp;<span class="ident" id="3740141">field</span>&nbsp;<span class="op" id="3740147">{</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3740150">f</span><span class="op" id="3740151">.</span><span class="ident" id="3740152">nameBytes</span>&nbsp;<span class="op" id="3740162">=</span>&nbsp;<span class="op" id="3740164">[</span><span class="op" id="3740165">]</span><span class="builtintype" id="3740166">byte</span><span class="op" id="3740170">(</span><span class="ident" id="3740171">f</span><span class="op" id="3740172">.</span><span class="ident" id="3740173">name</span><span class="op" id="3740177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3740180">f</span><span class="op" id="3740181">.</span><span class="ident" id="3740182">equalFold</span>&nbsp;<span class="op" id="3740192">=</span>&nbsp;<span class="ident" id="3740194">foldFunc</span><span class="op" id="3740202">(</span><span class="ident" id="3740203">f</span><span class="op" id="3740204">.</span><span class="ident" id="3740205">nameBytes</span><span class="op" id="3740214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740217">return</span>&nbsp;<span class="ident" id="3740224">f</span><br>
<span class="lineno"></span><span class="op" id="3740226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">955</span><span class="comment" id="3740229">//&nbsp;byName&nbsp;sorts&nbsp;field&nbsp;by&nbsp;name,&nbsp;breaking&nbsp;ties&nbsp;with&nbsp;depth,</span><br>
<span class="lineno"></span><span class="comment" id="3740286">//&nbsp;then&nbsp;breaking&nbsp;ties&nbsp;with&nbsp;&#34;name&nbsp;came&nbsp;from&nbsp;json&nbsp;tag&#34;,&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3740345">//&nbsp;breaking&nbsp;ties&nbsp;with&nbsp;index&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="keyword" id="3740383">type</span>&nbsp;<span class="ident" id="3740388">byName</span>&nbsp;<span class="op" id="3740395">[</span><span class="op" id="3740396">]</span><span class="ident" id="3740397">field</span><br>
<span class="lineno"></span><br>
<span class="lineno">960</span><span class="keyword" id="3740404">func</span>&nbsp;<span class="op" id="3740409">(</span><span class="ident" id="3740410">x</span>&nbsp;<span class="ident" id="3740412">byName</span><span class="op" id="3740418">)</span>&nbsp;<span class="ident" id="3740420">Len</span><span class="op" id="3740423">(</span><span class="op" id="3740424">)</span>&nbsp;<span class="builtintype" id="3740426">int</span>&nbsp;<span class="op" id="3740430">{</span>&nbsp;<span class="keyword" id="3740432">return</span>&nbsp;<span class="builtinfunc" id="3740439">len</span><span class="op" id="3740442">(</span><span class="ident" id="3740443">x</span><span class="op" id="3740444">)</span>&nbsp;<span class="op" id="3740446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3740449">func</span>&nbsp;<span class="op" id="3740454">(</span><span class="ident" id="3740455">x</span>&nbsp;<span class="ident" id="3740457">byName</span><span class="op" id="3740463">)</span>&nbsp;<span class="ident" id="3740465">Swap</span><span class="op" id="3740469">(</span><span class="ident" id="3740470">i</span><span class="op" id="3740471">,</span>&nbsp;<span class="ident" id="3740473">j</span>&nbsp;<span class="builtintype" id="3740475">int</span><span class="op" id="3740478">)</span>&nbsp;<span class="op" id="3740480">{</span>&nbsp;<span class="ident" id="3740482">x</span><span class="op" id="3740483">[</span><span class="ident" id="3740484">i</span><span class="op" id="3740485">]</span><span class="op" id="3740486">,</span>&nbsp;<span class="ident" id="3740488">x</span><span class="op" id="3740489">[</span><span class="ident" id="3740490">j</span><span class="op" id="3740491">]</span>&nbsp;<span class="op" id="3740493">=</span>&nbsp;<span class="ident" id="3740495">x</span><span class="op" id="3740496">[</span><span class="ident" id="3740497">j</span><span class="op" id="3740498">]</span><span class="op" id="3740499">,</span>&nbsp;<span class="ident" id="3740501">x</span><span class="op" id="3740502">[</span><span class="ident" id="3740503">i</span><span class="op" id="3740504">]</span>&nbsp;<span class="op" id="3740506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3740509">func</span>&nbsp;<span class="op" id="3740514">(</span><span class="ident" id="3740515">x</span>&nbsp;<span class="ident" id="3740517">byName</span><span class="op" id="3740523">)</span>&nbsp;<span class="ident" id="3740525">Less</span><span class="op" id="3740529">(</span><span class="ident" id="3740530">i</span><span class="op" id="3740531">,</span>&nbsp;<span class="ident" id="3740533">j</span>&nbsp;<span class="builtintype" id="3740535">int</span><span class="op" id="3740538">)</span>&nbsp;<span class="builtintype" id="3740540">bool</span>&nbsp;<span class="op" id="3740545">{</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740548">if</span>&nbsp;<span class="ident" id="3740551">x</span><span class="op" id="3740552">[</span><span class="ident" id="3740553">i</span><span class="op" id="3740554">]</span><span class="op" id="3740555">.</span><span class="ident" id="3740556">name</span>&nbsp;<span class="op" id="3740561">!=</span>&nbsp;<span class="ident" id="3740564">x</span><span class="op" id="3740565">[</span><span class="ident" id="3740566">j</span><span class="op" id="3740567">]</span><span class="op" id="3740568">.</span><span class="ident" id="3740569">name</span>&nbsp;<span class="op" id="3740574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740578">return</span>&nbsp;<span class="ident" id="3740585">x</span><span class="op" id="3740586">[</span><span class="ident" id="3740587">i</span><span class="op" id="3740588">]</span><span class="op" id="3740589">.</span><span class="ident" id="3740590">name</span>&nbsp;<span class="op" id="3740595">&lt;</span>&nbsp;<span class="ident" id="3740597">x</span><span class="op" id="3740598">[</span><span class="ident" id="3740599">j</span><span class="op" id="3740600">]</span><span class="op" id="3740601">.</span><span class="ident" id="3740602">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3740608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740611">if</span>&nbsp;<span class="builtinfunc" id="3740614">len</span><span class="op" id="3740617">(</span><span class="ident" id="3740618">x</span><span class="op" id="3740619">[</span><span class="ident" id="3740620">i</span><span class="op" id="3740621">]</span><span class="op" id="3740622">.</span><span class="ident" id="3740623">index</span><span class="op" id="3740628">)</span>&nbsp;<span class="op" id="3740630">!=</span>&nbsp;<span class="builtinfunc" id="3740633">len</span><span class="op" id="3740636">(</span><span class="ident" id="3740637">x</span><span class="op" id="3740638">[</span><span class="ident" id="3740639">j</span><span class="op" id="3740640">]</span><span class="op" id="3740641">.</span><span class="ident" id="3740642">index</span><span class="op" id="3740647">)</span>&nbsp;<span class="op" id="3740649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740653">return</span>&nbsp;<span class="builtinfunc" id="3740660">len</span><span class="op" id="3740663">(</span><span class="ident" id="3740664">x</span><span class="op" id="3740665">[</span><span class="ident" id="3740666">i</span><span class="op" id="3740667">]</span><span class="op" id="3740668">.</span><span class="ident" id="3740669">index</span><span class="op" id="3740674">)</span>&nbsp;<span class="op" id="3740676">&lt;</span>&nbsp;<span class="builtinfunc" id="3740678">len</span><span class="op" id="3740681">(</span><span class="ident" id="3740682">x</span><span class="op" id="3740683">[</span><span class="ident" id="3740684">j</span><span class="op" id="3740685">]</span><span class="op" id="3740686">.</span><span class="ident" id="3740687">index</span><span class="op" id="3740692">)</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3740695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740698">if</span>&nbsp;<span class="ident" id="3740701">x</span><span class="op" id="3740702">[</span><span class="ident" id="3740703">i</span><span class="op" id="3740704">]</span><span class="op" id="3740705">.</span><span class="ident" id="3740706">tag</span>&nbsp;<span class="op" id="3740710">!=</span>&nbsp;<span class="ident" id="3740713">x</span><span class="op" id="3740714">[</span><span class="ident" id="3740715">j</span><span class="op" id="3740716">]</span><span class="op" id="3740717">.</span><span class="ident" id="3740718">tag</span>&nbsp;<span class="op" id="3740722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740726">return</span>&nbsp;<span class="ident" id="3740733">x</span><span class="op" id="3740734">[</span><span class="ident" id="3740735">i</span><span class="op" id="3740736">]</span><span class="op" id="3740737">.</span><span class="ident" id="3740738">tag</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3740743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740746">return</span>&nbsp;<span class="ident" id="3740753">byIndex</span><span class="op" id="3740760">(</span><span class="ident" id="3740761">x</span><span class="op" id="3740762">)</span><span class="op" id="3740763">.</span><span class="ident" id="3740764">Less</span><span class="op" id="3740768">(</span><span class="ident" id="3740769">i</span><span class="op" id="3740770">,</span>&nbsp;<span class="ident" id="3740772">j</span><span class="op" id="3740773">)</span><br>
<span class="lineno">975</span><span class="op" id="3740775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3740778">//&nbsp;byIndex&nbsp;sorts&nbsp;field&nbsp;by&nbsp;index&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="keyword" id="3740820">type</span>&nbsp;<span class="ident" id="3740825">byIndex</span>&nbsp;<span class="op" id="3740833">[</span><span class="op" id="3740834">]</span><span class="ident" id="3740835">field</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="3740842">func</span>&nbsp;<span class="op" id="3740847">(</span><span class="ident" id="3740848">x</span>&nbsp;<span class="ident" id="3740850">byIndex</span><span class="op" id="3740857">)</span>&nbsp;<span class="ident" id="3740859">Len</span><span class="op" id="3740862">(</span><span class="op" id="3740863">)</span>&nbsp;<span class="builtintype" id="3740865">int</span>&nbsp;<span class="op" id="3740869">{</span>&nbsp;<span class="keyword" id="3740871">return</span>&nbsp;<span class="builtinfunc" id="3740878">len</span><span class="op" id="3740881">(</span><span class="ident" id="3740882">x</span><span class="op" id="3740883">)</span>&nbsp;<span class="op" id="3740885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3740888">func</span>&nbsp;<span class="op" id="3740893">(</span><span class="ident" id="3740894">x</span>&nbsp;<span class="ident" id="3740896">byIndex</span><span class="op" id="3740903">)</span>&nbsp;<span class="ident" id="3740905">Swap</span><span class="op" id="3740909">(</span><span class="ident" id="3740910">i</span><span class="op" id="3740911">,</span>&nbsp;<span class="ident" id="3740913">j</span>&nbsp;<span class="builtintype" id="3740915">int</span><span class="op" id="3740918">)</span>&nbsp;<span class="op" id="3740920">{</span>&nbsp;<span class="ident" id="3740922">x</span><span class="op" id="3740923">[</span><span class="ident" id="3740924">i</span><span class="op" id="3740925">]</span><span class="op" id="3740926">,</span>&nbsp;<span class="ident" id="3740928">x</span><span class="op" id="3740929">[</span><span class="ident" id="3740930">j</span><span class="op" id="3740931">]</span>&nbsp;<span class="op" id="3740933">=</span>&nbsp;<span class="ident" id="3740935">x</span><span class="op" id="3740936">[</span><span class="ident" id="3740937">j</span><span class="op" id="3740938">]</span><span class="op" id="3740939">,</span>&nbsp;<span class="ident" id="3740941">x</span><span class="op" id="3740942">[</span><span class="ident" id="3740943">i</span><span class="op" id="3740944">]</span>&nbsp;<span class="op" id="3740946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3740949">func</span>&nbsp;<span class="op" id="3740954">(</span><span class="ident" id="3740955">x</span>&nbsp;<span class="ident" id="3740957">byIndex</span><span class="op" id="3740964">)</span>&nbsp;<span class="ident" id="3740966">Less</span><span class="op" id="3740970">(</span><span class="ident" id="3740971">i</span><span class="op" id="3740972">,</span>&nbsp;<span class="ident" id="3740974">j</span>&nbsp;<span class="builtintype" id="3740976">int</span><span class="op" id="3740979">)</span>&nbsp;<span class="builtintype" id="3740981">bool</span>&nbsp;<span class="op" id="3740986">{</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3740989">for</span>&nbsp;<span class="ident" id="3740993">k</span><span class="op" id="3740994">,</span>&nbsp;<span class="ident" id="3740996">xik</span>&nbsp;<span class="op" id="3741000">:=</span>&nbsp;<span class="keyword" id="3741003">range</span>&nbsp;<span class="ident" id="3741009">x</span><span class="op" id="3741010">[</span><span class="ident" id="3741011">i</span><span class="op" id="3741012">]</span><span class="op" id="3741013">.</span><span class="ident" id="3741014">index</span>&nbsp;<span class="op" id="3741020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741024">if</span>&nbsp;<span class="ident" id="3741027">k</span>&nbsp;<span class="op" id="3741029">&gt;=</span>&nbsp;<span class="builtinfunc" id="3741032">len</span><span class="op" id="3741035">(</span><span class="ident" id="3741036">x</span><span class="op" id="3741037">[</span><span class="ident" id="3741038">j</span><span class="op" id="3741039">]</span><span class="op" id="3741040">.</span><span class="ident" id="3741041">index</span><span class="op" id="3741046">)</span>&nbsp;<span class="op" id="3741048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741053">return</span>&nbsp;<span class="builtintype" id="3741060">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3741068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741072">if</span>&nbsp;<span class="ident" id="3741075">xik</span>&nbsp;<span class="op" id="3741079">!=</span>&nbsp;<span class="ident" id="3741082">x</span><span class="op" id="3741083">[</span><span class="ident" id="3741084">j</span><span class="op" id="3741085">]</span><span class="op" id="3741086">.</span><span class="ident" id="3741087">index</span><span class="op" id="3741092">[</span><span class="ident" id="3741093">k</span><span class="op" id="3741094">]</span>&nbsp;<span class="op" id="3741096">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741101">return</span>&nbsp;<span class="ident" id="3741108">xik</span>&nbsp;<span class="op" id="3741112">&lt;</span>&nbsp;<span class="ident" id="3741114">x</span><span class="op" id="3741115">[</span><span class="ident" id="3741116">j</span><span class="op" id="3741117">]</span><span class="op" id="3741118">.</span><span class="ident" id="3741119">index</span><span class="op" id="3741124">[</span><span class="ident" id="3741125">k</span><span class="op" id="3741126">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3741130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3741133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741136">return</span>&nbsp;<span class="builtinfunc" id="3741143">len</span><span class="op" id="3741146">(</span><span class="ident" id="3741147">x</span><span class="op" id="3741148">[</span><span class="ident" id="3741149">i</span><span class="op" id="3741150">]</span><span class="op" id="3741151">.</span><span class="ident" id="3741152">index</span><span class="op" id="3741157">)</span>&nbsp;<span class="op" id="3741159">&lt;</span>&nbsp;<span class="builtinfunc" id="3741161">len</span><span class="op" id="3741164">(</span><span class="ident" id="3741165">x</span><span class="op" id="3741166">[</span><span class="ident" id="3741167">j</span><span class="op" id="3741168">]</span><span class="op" id="3741169">.</span><span class="ident" id="3741170">index</span><span class="op" id="3741175">)</span><br>
<span class="lineno"></span><span class="op" id="3741177">}</span><br>
<span class="lineno">995</span><br>
<span class="lineno"></span><span class="comment" id="3741180">//&nbsp;typeFields&nbsp;returns&nbsp;a&nbsp;list&nbsp;of&nbsp;fields&nbsp;that&nbsp;JSON&nbsp;should&nbsp;recognize&nbsp;for&nbsp;the&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="3741266">//&nbsp;The&nbsp;algorithm&nbsp;is&nbsp;breadth-first&nbsp;search&nbsp;over&nbsp;the&nbsp;set&nbsp;of&nbsp;structs&nbsp;to&nbsp;include&nbsp;-&nbsp;the&nbsp;top&nbsp;struct</span><br>
<span class="lineno"></span><span class="comment" id="3741359">//&nbsp;and&nbsp;then&nbsp;any&nbsp;reachable&nbsp;anonymous&nbsp;structs.</span><br>
<span class="lineno"></span><span class="keyword" id="3741404">func</span>&nbsp;<span class="ident" id="3741409">typeFields</span><span class="op" id="3741419">(</span><span class="ident" id="3741420">t</span>&nbsp;<span class="ident" id="3741422">reflect</span><span class="op" id="3741429">.</span><span class="ident" id="3741430">Type</span><span class="op" id="3741434">)</span>&nbsp;<span class="op" id="3741436">[</span><span class="op" id="3741437">]</span><span class="ident" id="3741438">field</span>&nbsp;<span class="op" id="3741444">{</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3741447">//&nbsp;Anonymous&nbsp;fields&nbsp;to&nbsp;explore&nbsp;at&nbsp;the&nbsp;current&nbsp;level&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3741514">current</span>&nbsp;<span class="op" id="3741522">:=</span>&nbsp;<span class="op" id="3741525">[</span><span class="op" id="3741526">]</span><span class="ident" id="3741527">field</span><span class="op" id="3741532">{</span><span class="op" id="3741533">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3741536">next</span>&nbsp;<span class="op" id="3741541">:=</span>&nbsp;<span class="op" id="3741544">[</span><span class="op" id="3741545">]</span><span class="ident" id="3741546">field</span><span class="op" id="3741551">{</span><span class="op" id="3741552">{</span><span class="ident" id="3741553">typ</span><span class="op" id="3741556">:</span>&nbsp;<span class="ident" id="3741558">t</span><span class="op" id="3741559">}</span><span class="op" id="3741560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3741564">//&nbsp;Count&nbsp;of&nbsp;queued&nbsp;names&nbsp;for&nbsp;current&nbsp;level&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3741622">count</span>&nbsp;<span class="op" id="3741628">:=</span>&nbsp;<span class="keyword" id="3741631">map</span><span class="op" id="3741634">[</span><span class="ident" id="3741635">reflect</span><span class="op" id="3741642">.</span><span class="ident" id="3741643">Type</span><span class="op" id="3741647">]</span><span class="builtintype" id="3741648">int</span><span class="op" id="3741651">{</span><span class="op" id="3741652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3741655">nextCount</span>&nbsp;<span class="op" id="3741665">:=</span>&nbsp;<span class="keyword" id="3741668">map</span><span class="op" id="3741671">[</span><span class="ident" id="3741672">reflect</span><span class="op" id="3741679">.</span><span class="ident" id="3741680">Type</span><span class="op" id="3741684">]</span><span class="builtintype" id="3741685">int</span><span class="op" id="3741688">{</span><span class="op" id="3741689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3741693">//&nbsp;Types&nbsp;already&nbsp;visited&nbsp;at&nbsp;an&nbsp;earlier&nbsp;level.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3741740">visited</span>&nbsp;<span class="op" id="3741748">:=</span>&nbsp;<span class="keyword" id="3741751">map</span><span class="op" id="3741754">[</span><span class="ident" id="3741755">reflect</span><span class="op" id="3741762">.</span><span class="ident" id="3741763">Type</span><span class="op" id="3741767">]</span><span class="builtintype" id="3741768">bool</span><span class="op" id="3741772">{</span><span class="op" id="3741773">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3741777">//&nbsp;Fields&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741795">var</span>&nbsp;<span class="ident" id="3741799">fields</span>&nbsp;<span class="op" id="3741806">[</span><span class="op" id="3741807">]</span><span class="ident" id="3741808">field</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741816">for</span>&nbsp;<span class="builtinfunc" id="3741820">len</span><span class="op" id="3741823">(</span><span class="ident" id="3741824">next</span><span class="op" id="3741828">)</span>&nbsp;<span class="op" id="3741830">&gt;</span>&nbsp;<span class="num" id="3741832">0</span>&nbsp;<span class="op" id="3741834">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3741838">current</span><span class="op" id="3741845">,</span>&nbsp;<span class="ident" id="3741847">next</span>&nbsp;<span class="op" id="3741852">=</span>&nbsp;<span class="ident" id="3741854">next</span><span class="op" id="3741858">,</span>&nbsp;<span class="ident" id="3741860">current</span><span class="op" id="3741867">[</span><span class="op" id="3741868">:</span><span class="num" id="3741869">0</span><span class="op" id="3741870">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3741874">count</span><span class="op" id="3741879">,</span>&nbsp;<span class="ident" id="3741881">nextCount</span>&nbsp;<span class="op" id="3741891">=</span>&nbsp;<span class="ident" id="3741893">nextCount</span><span class="op" id="3741902">,</span>&nbsp;<span class="keyword" id="3741904">map</span><span class="op" id="3741907">[</span><span class="ident" id="3741908">reflect</span><span class="op" id="3741915">.</span><span class="ident" id="3741916">Type</span><span class="op" id="3741920">]</span><span class="builtintype" id="3741921">int</span><span class="op" id="3741924">{</span><span class="op" id="3741925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741930">for</span>&nbsp;<span class="ident" id="3741934">_</span><span class="op" id="3741935">,</span>&nbsp;<span class="ident" id="3741937">f</span>&nbsp;<span class="op" id="3741939">:=</span>&nbsp;<span class="keyword" id="3741942">range</span>&nbsp;<span class="ident" id="3741948">current</span>&nbsp;<span class="op" id="3741956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741961">if</span>&nbsp;<span class="ident" id="3741964">visited</span><span class="op" id="3741971">[</span><span class="ident" id="3741972">f</span><span class="op" id="3741973">.</span><span class="ident" id="3741974">typ</span><span class="op" id="3741977">]</span>&nbsp;<span class="op" id="3741979">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3741985">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3741997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742002">visited</span><span class="op" id="3742009">[</span><span class="ident" id="3742010">f</span><span class="op" id="3742011">.</span><span class="ident" id="3742012">typ</span><span class="op" id="3742015">]</span>&nbsp;<span class="op" id="3742017">=</span>&nbsp;<span class="builtintype" id="3742019">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3742028">//&nbsp;Scan&nbsp;f.typ&nbsp;for&nbsp;fields&nbsp;to&nbsp;include.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742068">for</span>&nbsp;<span class="ident" id="3742072">i</span>&nbsp;<span class="op" id="3742074">:=</span>&nbsp;<span class="num" id="3742077">0</span><span class="op" id="3742078">;</span>&nbsp;<span class="ident" id="3742080">i</span>&nbsp;<span class="op" id="3742082">&lt;</span>&nbsp;<span class="ident" id="3742084">f</span><span class="op" id="3742085">.</span><span class="ident" id="3742086">typ</span><span class="op" id="3742089">.</span><span class="ident" id="3742090">NumField</span><span class="op" id="3742098">(</span><span class="op" id="3742099">)</span><span class="op" id="3742100">;</span>&nbsp;<span class="ident" id="3742102">i</span><span class="op" id="3742103">++</span>&nbsp;<span class="op" id="3742106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742112">sf</span>&nbsp;<span class="op" id="3742115">:=</span>&nbsp;<span class="ident" id="3742118">f</span><span class="op" id="3742119">.</span><span class="ident" id="3742120">typ</span><span class="op" id="3742123">.</span><span class="ident" id="3742124">Field</span><span class="op" id="3742129">(</span><span class="ident" id="3742130">i</span><span class="op" id="3742131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742137">if</span>&nbsp;<span class="ident" id="3742140">sf</span><span class="op" id="3742142">.</span><span class="ident" id="3742143">PkgPath</span>&nbsp;<span class="op" id="3742151">!=</span>&nbsp;<span class="string" id="3742154">&#34;&#34;</span>&nbsp;<span class="op" id="3742157">{</span>&nbsp;<span class="comment" id="3742159">//&nbsp;unexported</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742178">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3742191">}</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742197">tag</span>&nbsp;<span class="op" id="3742201">:=</span>&nbsp;<span class="ident" id="3742204">sf</span><span class="op" id="3742206">.</span><span class="ident" id="3742207">Tag</span><span class="op" id="3742210">.</span><span class="ident" id="3742211">Get</span><span class="op" id="3742214">(</span><span class="string" id="3742215">&#34;json&#34;</span><span class="op" id="3742221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742227">if</span>&nbsp;<span class="ident" id="3742230">tag</span>&nbsp;<span class="op" id="3742234">==</span>&nbsp;<span class="string" id="3742237">&#34;-&#34;</span>&nbsp;<span class="op" id="3742241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742248">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3742261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742267">name</span><span class="op" id="3742271">,</span>&nbsp;<span class="ident" id="3742273">opts</span>&nbsp;<span class="op" id="3742278">:=</span>&nbsp;<span class="ident" id="3742281">parseTag</span><span class="op" id="3742289">(</span><span class="ident" id="3742290">tag</span><span class="op" id="3742293">)</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742299">if</span>&nbsp;<span class="op" id="3742302">!</span><span class="ident" id="3742303">isValidTag</span><span class="op" id="3742313">(</span><span class="ident" id="3742314">name</span><span class="op" id="3742318">)</span>&nbsp;<span class="op" id="3742320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742327">name</span>&nbsp;<span class="op" id="3742332">=</span>&nbsp;<span class="string" id="3742334">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3742341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742347">index</span>&nbsp;<span class="op" id="3742353">:=</span>&nbsp;<span class="builtinfunc" id="3742356">make</span><span class="op" id="3742360">(</span><span class="op" id="3742361">[</span><span class="op" id="3742362">]</span><span class="builtintype" id="3742363">int</span><span class="op" id="3742366">,</span>&nbsp;<span class="builtinfunc" id="3742368">len</span><span class="op" id="3742371">(</span><span class="ident" id="3742372">f</span><span class="op" id="3742373">.</span><span class="ident" id="3742374">index</span><span class="op" id="3742379">)</span><span class="op" id="3742380">+</span><span class="num" id="3742381">1</span><span class="op" id="3742382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3742388">copy</span><span class="op" id="3742392">(</span><span class="ident" id="3742393">index</span><span class="op" id="3742398">,</span>&nbsp;<span class="ident" id="3742400">f</span><span class="op" id="3742401">.</span><span class="ident" id="3742402">index</span><span class="op" id="3742407">)</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742413">index</span><span class="op" id="3742418">[</span><span class="builtinfunc" id="3742419">len</span><span class="op" id="3742422">(</span><span class="ident" id="3742423">f</span><span class="op" id="3742424">.</span><span class="ident" id="3742425">index</span><span class="op" id="3742430">)</span><span class="op" id="3742431">]</span>&nbsp;<span class="op" id="3742433">=</span>&nbsp;<span class="ident" id="3742435">i</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742442">ft</span>&nbsp;<span class="op" id="3742445">:=</span>&nbsp;<span class="ident" id="3742448">sf</span><span class="op" id="3742450">.</span><span class="ident" id="3742451">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742460">if</span>&nbsp;<span class="ident" id="3742463">ft</span><span class="op" id="3742465">.</span><span class="ident" id="3742466">Name</span><span class="op" id="3742470">(</span><span class="op" id="3742471">)</span>&nbsp;<span class="op" id="3742473">==</span>&nbsp;<span class="string" id="3742476">&#34;&#34;</span>&nbsp;<span class="op" id="3742479">&amp;&amp;</span>&nbsp;<span class="ident" id="3742482">ft</span><span class="op" id="3742484">.</span><span class="ident" id="3742485">Kind</span><span class="op" id="3742489">(</span><span class="op" id="3742490">)</span>&nbsp;<span class="op" id="3742492">==</span>&nbsp;<span class="ident" id="3742495">reflect</span><span class="op" id="3742502">.</span><span class="ident" id="3742503">Ptr</span>&nbsp;<span class="op" id="3742507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3742514">//&nbsp;Follow&nbsp;pointer.</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742538">ft</span>&nbsp;<span class="op" id="3742541">=</span>&nbsp;<span class="ident" id="3742543">ft</span><span class="op" id="3742545">.</span><span class="ident" id="3742546">Elem</span><span class="op" id="3742550">(</span><span class="op" id="3742551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3742557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3742564">//&nbsp;Record&nbsp;found&nbsp;field&nbsp;and&nbsp;index&nbsp;sequence.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742610">if</span>&nbsp;<span class="ident" id="3742613">name</span>&nbsp;<span class="op" id="3742618">!=</span>&nbsp;<span class="string" id="3742621">&#34;&#34;</span>&nbsp;<span class="op" id="3742624">||</span>&nbsp;<span class="op" id="3742627">!</span><span class="ident" id="3742628">sf</span><span class="op" id="3742630">.</span><span class="ident" id="3742631">Anonymous</span>&nbsp;<span class="op" id="3742641">||</span>&nbsp;<span class="ident" id="3742644">ft</span><span class="op" id="3742646">.</span><span class="ident" id="3742647">Kind</span><span class="op" id="3742651">(</span><span class="op" id="3742652">)</span>&nbsp;<span class="op" id="3742654">!=</span>&nbsp;<span class="ident" id="3742657">reflect</span><span class="op" id="3742664">.</span><span class="ident" id="3742665">Struct</span>&nbsp;<span class="op" id="3742672">{</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742679">tagged</span>&nbsp;<span class="op" id="3742686">:=</span>&nbsp;<span class="ident" id="3742689">name</span>&nbsp;<span class="op" id="3742694">!=</span>&nbsp;<span class="string" id="3742697">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742705">if</span>&nbsp;<span class="ident" id="3742708">name</span>&nbsp;<span class="op" id="3742713">==</span>&nbsp;<span class="string" id="3742716">&#34;&#34;</span>&nbsp;<span class="op" id="3742719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742727">name</span>&nbsp;<span class="op" id="3742732">=</span>&nbsp;<span class="ident" id="3742734">sf</span><span class="op" id="3742736">.</span><span class="ident" id="3742737">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3742747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742754">fields</span>&nbsp;<span class="op" id="3742761">=</span>&nbsp;<span class="builtinfunc" id="3742763">append</span><span class="op" id="3742769">(</span><span class="ident" id="3742770">fields</span><span class="op" id="3742776">,</span>&nbsp;<span class="ident" id="3742778">fillField</span><span class="op" id="3742787">(</span><span class="ident" id="3742788">field</span><span class="op" id="3742793">{</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742801">name</span><span class="op" id="3742805">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3742812">name</span><span class="op" id="3742816">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742824">tag</span><span class="op" id="3742827">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3742835">tagged</span><span class="op" id="3742841">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742849">index</span><span class="op" id="3742854">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3742860">index</span><span class="op" id="3742865">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742873">typ</span><span class="op" id="3742876">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3742884">ft</span><span class="op" id="3742886">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742894">omitEmpty</span><span class="op" id="3742903">:</span>&nbsp;<span class="ident" id="3742905">opts</span><span class="op" id="3742909">.</span><span class="ident" id="3742910">Contains</span><span class="op" id="3742918">(</span><span class="string" id="3742919">&#34;omitempty&#34;</span><span class="op" id="3742930">)</span><span class="op" id="3742931">,</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3742939">quoted</span><span class="op" id="3742945">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3742950">opts</span><span class="op" id="3742954">.</span><span class="ident" id="3742955">Contains</span><span class="op" id="3742963">(</span><span class="string" id="3742964">&#34;string&#34;</span><span class="op" id="3742972">)</span><span class="op" id="3742973">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3742980">}</span><span class="op" id="3742981">)</span><span class="op" id="3742982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3742989">if</span>&nbsp;<span class="ident" id="3742992">count</span><span class="op" id="3742997">[</span><span class="ident" id="3742998">f</span><span class="op" id="3742999">.</span><span class="ident" id="3743000">typ</span><span class="op" id="3743003">]</span>&nbsp;<span class="op" id="3743005">&gt;</span>&nbsp;<span class="num" id="3743007">1</span>&nbsp;<span class="op" id="3743009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3743017">//&nbsp;If&nbsp;there&nbsp;were&nbsp;multiple&nbsp;instances,&nbsp;add&nbsp;a&nbsp;second,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3743074">//&nbsp;so&nbsp;that&nbsp;the&nbsp;annihilation&nbsp;code&nbsp;will&nbsp;see&nbsp;a&nbsp;duplicate.</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3743135">//&nbsp;It&nbsp;only&nbsp;cares&nbsp;about&nbsp;the&nbsp;distinction&nbsp;between&nbsp;1&nbsp;or&nbsp;2,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3743196">//&nbsp;so&nbsp;don&#39;t&nbsp;bother&nbsp;generating&nbsp;any&nbsp;more&nbsp;copies.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743249">fields</span>&nbsp;<span class="op" id="3743256">=</span>&nbsp;<span class="builtinfunc" id="3743258">append</span><span class="op" id="3743264">(</span><span class="ident" id="3743265">fields</span><span class="op" id="3743271">,</span>&nbsp;<span class="ident" id="3743273">fields</span><span class="op" id="3743279">[</span><span class="builtinfunc" id="3743280">len</span><span class="op" id="3743283">(</span><span class="ident" id="3743284">fields</span><span class="op" id="3743290">)</span><span class="op" id="3743291">-</span><span class="num" id="3743292">1</span><span class="op" id="3743293">]</span><span class="op" id="3743294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3743301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743308">continue</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3743321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3743328">//&nbsp;Record&nbsp;new&nbsp;anonymous&nbsp;struct&nbsp;to&nbsp;explore&nbsp;in&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743389">nextCount</span><span class="op" id="3743398">[</span><span class="ident" id="3743399">ft</span><span class="op" id="3743401">]</span><span class="op" id="3743402">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743409">if</span>&nbsp;<span class="ident" id="3743412">nextCount</span><span class="op" id="3743421">[</span><span class="ident" id="3743422">ft</span><span class="op" id="3743424">]</span>&nbsp;<span class="op" id="3743426">==</span>&nbsp;<span class="num" id="3743429">1</span>&nbsp;<span class="op" id="3743431">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743438">next</span>&nbsp;<span class="op" id="3743443">=</span>&nbsp;<span class="builtinfunc" id="3743445">append</span><span class="op" id="3743451">(</span><span class="ident" id="3743452">next</span><span class="op" id="3743456">,</span>&nbsp;<span class="ident" id="3743458">fillField</span><span class="op" id="3743467">(</span><span class="ident" id="3743468">field</span><span class="op" id="3743473">{</span><span class="ident" id="3743474">name</span><span class="op" id="3743478">:</span>&nbsp;<span class="ident" id="3743480">ft</span><span class="op" id="3743482">.</span><span class="ident" id="3743483">Name</span><span class="op" id="3743487">(</span><span class="op" id="3743488">)</span><span class="op" id="3743489">,</span>&nbsp;<span class="ident" id="3743491">index</span><span class="op" id="3743496">:</span>&nbsp;<span class="ident" id="3743498">index</span><span class="op" id="3743503">,</span>&nbsp;<span class="ident" id="3743505">typ</span><span class="op" id="3743508">:</span>&nbsp;<span class="ident" id="3743510">ft</span><span class="op" id="3743512">}</span><span class="op" id="3743513">)</span><span class="op" id="3743514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3743520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3743525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3743529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3743532">}</span><br>
<span class="lineno">1080</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743536">sort</span><span class="op" id="3743540">.</span><span class="ident" id="3743541">Sort</span><span class="op" id="3743545">(</span><span class="ident" id="3743546">byName</span><span class="op" id="3743552">(</span><span class="ident" id="3743553">fields</span><span class="op" id="3743559">)</span><span class="op" id="3743560">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3743564">//&nbsp;Delete&nbsp;all&nbsp;fields&nbsp;that&nbsp;are&nbsp;hidden&nbsp;by&nbsp;the&nbsp;Go&nbsp;rules&nbsp;for&nbsp;embedded&nbsp;fields,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3743639">//&nbsp;except&nbsp;that&nbsp;fields&nbsp;with&nbsp;JSON&nbsp;tags&nbsp;are&nbsp;promoted.</span><br>
<span class="lineno">1085</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3743692">//&nbsp;The&nbsp;fields&nbsp;are&nbsp;sorted&nbsp;in&nbsp;primary&nbsp;order&nbsp;of&nbsp;name,&nbsp;secondary&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3743760">//&nbsp;of&nbsp;field&nbsp;index&nbsp;length.&nbsp;Loop&nbsp;over&nbsp;names;&nbsp;for&nbsp;each&nbsp;name,&nbsp;delete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3743826">//&nbsp;hidden&nbsp;fields&nbsp;by&nbsp;choosing&nbsp;the&nbsp;one&nbsp;dominant&nbsp;field&nbsp;that&nbsp;survives.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3743894">out</span>&nbsp;<span class="op" id="3743898">:=</span>&nbsp;<span class="ident" id="3743901">fields</span><span class="op" id="3743907">[</span><span class="op" id="3743908">:</span><span class="num" id="3743909">0</span><span class="op" id="3743910">]</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3743913">for</span>&nbsp;<span class="ident" id="3743917">advance</span><span class="op" id="3743924">,</span>&nbsp;<span class="ident" id="3743926">i</span>&nbsp;<span class="op" id="3743928">:=</span>&nbsp;<span class="num" id="3743931">0</span><span class="op" id="3743932">,</span>&nbsp;<span class="num" id="3743934">0</span><span class="op" id="3743935">;</span>&nbsp;<span class="ident" id="3743937">i</span>&nbsp;<span class="op" id="3743939">&lt;</span>&nbsp;<span class="builtinfunc" id="3743941">len</span><span class="op" id="3743944">(</span><span class="ident" id="3743945">fields</span><span class="op" id="3743951">)</span><span class="op" id="3743952">;</span>&nbsp;<span class="ident" id="3743954">i</span>&nbsp;<span class="op" id="3743956">+=</span>&nbsp;<span class="ident" id="3743959">advance</span>&nbsp;<span class="op" id="3743967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3743971">//&nbsp;One&nbsp;iteration&nbsp;per&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3744000">//&nbsp;Find&nbsp;the&nbsp;sequence&nbsp;of&nbsp;fields&nbsp;with&nbsp;the&nbsp;name&nbsp;of&nbsp;this&nbsp;first&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744068">fi</span>&nbsp;<span class="op" id="3744071">:=</span>&nbsp;<span class="ident" id="3744074">fields</span><span class="op" id="3744080">[</span><span class="ident" id="3744081">i</span><span class="op" id="3744082">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744086">name</span>&nbsp;<span class="op" id="3744091">:=</span>&nbsp;<span class="ident" id="3744094">fi</span><span class="op" id="3744096">.</span><span class="ident" id="3744097">name</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744104">for</span>&nbsp;<span class="ident" id="3744108">advance</span>&nbsp;<span class="op" id="3744116">=</span>&nbsp;<span class="num" id="3744118">1</span><span class="op" id="3744119">;</span>&nbsp;<span class="ident" id="3744121">i</span><span class="op" id="3744122">+</span><span class="ident" id="3744123">advance</span>&nbsp;<span class="op" id="3744131">&lt;</span>&nbsp;<span class="builtinfunc" id="3744133">len</span><span class="op" id="3744136">(</span><span class="ident" id="3744137">fields</span><span class="op" id="3744143">)</span><span class="op" id="3744144">;</span>&nbsp;<span class="ident" id="3744146">advance</span><span class="op" id="3744153">++</span>&nbsp;<span class="op" id="3744156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744161">fj</span>&nbsp;<span class="op" id="3744164">:=</span>&nbsp;<span class="ident" id="3744167">fields</span><span class="op" id="3744173">[</span><span class="ident" id="3744174">i</span><span class="op" id="3744175">+</span><span class="ident" id="3744176">advance</span><span class="op" id="3744183">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744188">if</span>&nbsp;<span class="ident" id="3744191">fj</span><span class="op" id="3744193">.</span><span class="ident" id="3744194">name</span>&nbsp;<span class="op" id="3744199">!=</span>&nbsp;<span class="ident" id="3744202">name</span>&nbsp;<span class="op" id="3744207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744213">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3744222">}</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3744226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744230">if</span>&nbsp;<span class="ident" id="3744233">advance</span>&nbsp;<span class="op" id="3744241">==</span>&nbsp;<span class="num" id="3744244">1</span>&nbsp;<span class="op" id="3744246">{</span>&nbsp;<span class="comment" id="3744248">//&nbsp;Only&nbsp;one&nbsp;field&nbsp;with&nbsp;this&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744284">out</span>&nbsp;<span class="op" id="3744288">=</span>&nbsp;<span class="builtinfunc" id="3744290">append</span><span class="op" id="3744296">(</span><span class="ident" id="3744297">out</span><span class="op" id="3744300">,</span>&nbsp;<span class="ident" id="3744302">fi</span><span class="op" id="3744304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744309">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3744320">}</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744324">dominant</span><span class="op" id="3744332">,</span>&nbsp;<span class="ident" id="3744334">ok</span>&nbsp;<span class="op" id="3744337">:=</span>&nbsp;<span class="ident" id="3744340">dominantField</span><span class="op" id="3744353">(</span><span class="ident" id="3744354">fields</span><span class="op" id="3744360">[</span><span class="ident" id="3744361">i</span>&nbsp;<span class="op" id="3744363">:</span>&nbsp;<span class="ident" id="3744365">i</span><span class="op" id="3744366">+</span><span class="ident" id="3744367">advance</span><span class="op" id="3744374">]</span><span class="op" id="3744375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744379">if</span>&nbsp;<span class="ident" id="3744382">ok</span>&nbsp;<span class="op" id="3744385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744390">out</span>&nbsp;<span class="op" id="3744394">=</span>&nbsp;<span class="builtinfunc" id="3744396">append</span><span class="op" id="3744402">(</span><span class="ident" id="3744403">out</span><span class="op" id="3744406">,</span>&nbsp;<span class="ident" id="3744408">dominant</span><span class="op" id="3744416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3744420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3744423">}</span><br>
<span class="lineno">1110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744427">fields</span>&nbsp;<span class="op" id="3744434">=</span>&nbsp;<span class="ident" id="3744436">out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3744441">sort</span><span class="op" id="3744445">.</span><span class="ident" id="3744446">Sort</span><span class="op" id="3744450">(</span><span class="ident" id="3744451">byIndex</span><span class="op" id="3744458">(</span><span class="ident" id="3744459">fields</span><span class="op" id="3744465">)</span><span class="op" id="3744466">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3744470">return</span>&nbsp;<span class="ident" id="3744477">fields</span><br>
<span class="lineno">1115</span><span class="op" id="3744484">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3744487">//&nbsp;dominantField&nbsp;looks&nbsp;through&nbsp;the&nbsp;fields,&nbsp;all&nbsp;of&nbsp;which&nbsp;are&nbsp;known&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3744556">//&nbsp;have&nbsp;the&nbsp;same&nbsp;name,&nbsp;to&nbsp;find&nbsp;the&nbsp;single&nbsp;field&nbsp;that&nbsp;dominates&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3744623">//&nbsp;others&nbsp;using&nbsp;Go&#39;s&nbsp;embedding&nbsp;rules,&nbsp;modified&nbsp;by&nbsp;the&nbsp;presence&nbsp;of</span><br>
<span class="lineno">1120</span><span class="comment" id="3744689">//&nbsp;JSON&nbsp;tags.&nbsp;If&nbsp;there&nbsp;are&nbsp;multiple&nbsp;top-level&nbsp;fields,&nbsp;the&nbsp;boolean</span><br>
<span class="lineno"></span><span class="comment" id="3744755">//&nbsp;will&nbsp;be&nbsp;false:&nbsp;This&nbsp;condition&nbsp;is&nbsp;an&nbsp;error&nbsp;in&nbsp;Go&nbsp;and&nbsp;we&nbsp;skip&nbsp;all</span><br>
<span class="lineno"></span><span class="comment" id="3744822">//&nbsp;the&nbsp;fields.</span><br>
<span class="lineno"></span><span class="keyword" id="3744837">func</span>&nbsp;<span class="ident" id="3744842">dominantField</span><span class="op" id="3744855">(</span><span class="ident" id="3744856">fields</span>&nbsp;<span class="op" id="3744863">[</span><span class="op" id="3744864">]</span><span class="ident" id="3744865">field</span><span class="op" id="3744870">)</span>&nbsp;<span class="op" id="3744872">(</span><span class="ident" id="3744873">field</span><span class="op" id="3744878">,</span>&nbsp;<span class="builtintype" id="3744880">bool</span><span class="op" id="3744884">)</span>&nbsp;<span class="op" id="3744886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3744889">//&nbsp;The&nbsp;fields&nbsp;are&nbsp;sorted&nbsp;in&nbsp;increasing&nbsp;index-length&nbsp;order.&nbsp;The&nbsp;winner</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3744960">//&nbsp;must&nbsp;therefore&nbsp;be&nbsp;one&nbsp;with&nbsp;the&nbsp;shortest&nbsp;index&nbsp;length.&nbsp;Drop&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3745027">//&nbsp;longer&nbsp;entries,&nbsp;which&nbsp;is&nbsp;easy:&nbsp;just&nbsp;truncate&nbsp;the&nbsp;slice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745087">length</span>&nbsp;<span class="op" id="3745094">:=</span>&nbsp;<span class="builtinfunc" id="3745097">len</span><span class="op" id="3745100">(</span><span class="ident" id="3745101">fields</span><span class="op" id="3745107">[</span><span class="num" id="3745108">0</span><span class="op" id="3745109">]</span><span class="op" id="3745110">.</span><span class="ident" id="3745111">index</span><span class="op" id="3745116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745119">tagged</span>&nbsp;<span class="op" id="3745126">:=</span>&nbsp;<span class="op" id="3745129">-</span><span class="num" id="3745130">1</span>&nbsp;<span class="comment" id="3745132">//&nbsp;Index&nbsp;of&nbsp;first&nbsp;tagged&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745165">for</span>&nbsp;<span class="ident" id="3745169">i</span><span class="op" id="3745170">,</span>&nbsp;<span class="ident" id="3745172">f</span>&nbsp;<span class="op" id="3745174">:=</span>&nbsp;<span class="keyword" id="3745177">range</span>&nbsp;<span class="ident" id="3745183">fields</span>&nbsp;<span class="op" id="3745190">{</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745194">if</span>&nbsp;<span class="builtinfunc" id="3745197">len</span><span class="op" id="3745200">(</span><span class="ident" id="3745201">f</span><span class="op" id="3745202">.</span><span class="ident" id="3745203">index</span><span class="op" id="3745208">)</span>&nbsp;<span class="op" id="3745210">&gt;</span>&nbsp;<span class="ident" id="3745212">length</span>&nbsp;<span class="op" id="3745219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745224">fields</span>&nbsp;<span class="op" id="3745231">=</span>&nbsp;<span class="ident" id="3745233">fields</span><span class="op" id="3745239">[</span><span class="op" id="3745240">:</span><span class="ident" id="3745241">i</span><span class="op" id="3745242">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745247">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3745255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745259">if</span>&nbsp;<span class="ident" id="3745262">f</span><span class="op" id="3745263">.</span><span class="ident" id="3745264">tag</span>&nbsp;<span class="op" id="3745268">{</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745273">if</span>&nbsp;<span class="ident" id="3745276">tagged</span>&nbsp;<span class="op" id="3745283">&gt;=</span>&nbsp;<span class="num" id="3745286">0</span>&nbsp;<span class="op" id="3745288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3745294">//&nbsp;Multiple&nbsp;tagged&nbsp;fields&nbsp;at&nbsp;the&nbsp;same&nbsp;level:&nbsp;conflict.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3745353">//&nbsp;Return&nbsp;no&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745377">return</span>&nbsp;<span class="ident" id="3745384">field</span><span class="op" id="3745389">{</span><span class="op" id="3745390">}</span><span class="op" id="3745391">,</span>&nbsp;<span class="builtintype" id="3745393">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3745402">}</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745407">tagged</span>&nbsp;<span class="op" id="3745414">=</span>&nbsp;<span class="ident" id="3745416">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3745420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3745423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745426">if</span>&nbsp;<span class="ident" id="3745429">tagged</span>&nbsp;<span class="op" id="3745436">&gt;=</span>&nbsp;<span class="num" id="3745439">0</span>&nbsp;<span class="op" id="3745441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745445">return</span>&nbsp;<span class="ident" id="3745452">fields</span><span class="op" id="3745458">[</span><span class="ident" id="3745459">tagged</span><span class="op" id="3745465">]</span><span class="op" id="3745466">,</span>&nbsp;<span class="builtintype" id="3745468">true</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3745474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3745477">//&nbsp;All&nbsp;remaining&nbsp;fields&nbsp;have&nbsp;the&nbsp;same&nbsp;length.&nbsp;If&nbsp;there&#39;s&nbsp;more&nbsp;than&nbsp;one,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3745550">//&nbsp;we&nbsp;have&nbsp;a&nbsp;conflict&nbsp;(two&nbsp;fields&nbsp;named&nbsp;&#34;X&#34;&nbsp;at&nbsp;the&nbsp;same&nbsp;level)&nbsp;and&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3745621">//&nbsp;return&nbsp;no&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745642">if</span>&nbsp;<span class="builtinfunc" id="3745645">len</span><span class="op" id="3745648">(</span><span class="ident" id="3745649">fields</span><span class="op" id="3745655">)</span>&nbsp;<span class="op" id="3745657">&gt;</span>&nbsp;<span class="num" id="3745659">1</span>&nbsp;<span class="op" id="3745661">{</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745665">return</span>&nbsp;<span class="ident" id="3745672">field</span><span class="op" id="3745677">{</span><span class="op" id="3745678">}</span><span class="op" id="3745679">,</span>&nbsp;<span class="builtintype" id="3745681">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3745688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745691">return</span>&nbsp;<span class="ident" id="3745698">fields</span><span class="op" id="3745704">[</span><span class="num" id="3745705">0</span><span class="op" id="3745706">]</span><span class="op" id="3745707">,</span>&nbsp;<span class="builtintype" id="3745709">true</span><br>
<span class="lineno"></span><span class="op" id="3745714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1155</span><span class="keyword" id="3745717">var</span>&nbsp;<span class="ident" id="3745721">fieldCache</span>&nbsp;<span class="keyword" id="3745732">struct</span>&nbsp;<span class="op" id="3745739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745742">sync</span><span class="op" id="3745746">.</span><span class="ident" id="3745747">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745756">m</span>&nbsp;<span class="keyword" id="3745758">map</span><span class="op" id="3745761">[</span><span class="ident" id="3745762">reflect</span><span class="op" id="3745769">.</span><span class="ident" id="3745770">Type</span><span class="op" id="3745774">]</span><span class="op" id="3745775">[</span><span class="op" id="3745776">]</span><span class="ident" id="3745777">field</span><br>
<span class="lineno"></span><span class="op" id="3745783">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1160</span><span class="comment" id="3745786">//&nbsp;cachedTypeFields&nbsp;is&nbsp;like&nbsp;typeFields&nbsp;but&nbsp;uses&nbsp;a&nbsp;cache&nbsp;to&nbsp;avoid&nbsp;repeated&nbsp;work.</span><br>
<span class="lineno"></span><span class="keyword" id="3745866">func</span>&nbsp;<span class="ident" id="3745871">cachedTypeFields</span><span class="op" id="3745887">(</span><span class="ident" id="3745888">t</span>&nbsp;<span class="ident" id="3745890">reflect</span><span class="op" id="3745897">.</span><span class="ident" id="3745898">Type</span><span class="op" id="3745902">)</span>&nbsp;<span class="op" id="3745904">[</span><span class="op" id="3745905">]</span><span class="ident" id="3745906">field</span>&nbsp;<span class="op" id="3745912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745915">fieldCache</span><span class="op" id="3745925">.</span><span class="ident" id="3745926">RLock</span><span class="op" id="3745931">(</span><span class="op" id="3745932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745935">f</span>&nbsp;<span class="op" id="3745937">:=</span>&nbsp;<span class="ident" id="3745940">fieldCache</span><span class="op" id="3745950">.</span><span class="ident" id="3745951">m</span><span class="op" id="3745952">[</span><span class="ident" id="3745953">t</span><span class="op" id="3745954">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3745957">fieldCache</span><span class="op" id="3745967">.</span><span class="ident" id="3745968">RUnlock</span><span class="op" id="3745975">(</span><span class="op" id="3745976">)</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745979">if</span>&nbsp;<span class="ident" id="3745982">f</span>&nbsp;<span class="op" id="3745984">!=</span>&nbsp;<span class="ident" id="3745987">nil</span>&nbsp;<span class="op" id="3745991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3745995">return</span>&nbsp;<span class="ident" id="3746002">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3746005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3746009">//&nbsp;Compute&nbsp;fields&nbsp;without&nbsp;lock.</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3746042">//&nbsp;Might&nbsp;duplicate&nbsp;effort&nbsp;but&nbsp;won&#39;t&nbsp;hold&nbsp;other&nbsp;computations&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3746109">f</span>&nbsp;<span class="op" id="3746111">=</span>&nbsp;<span class="ident" id="3746113">typeFields</span><span class="op" id="3746123">(</span><span class="ident" id="3746124">t</span><span class="op" id="3746125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746128">if</span>&nbsp;<span class="ident" id="3746131">f</span>&nbsp;<span class="op" id="3746133">==</span>&nbsp;<span class="ident" id="3746136">nil</span>&nbsp;<span class="op" id="3746140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3746144">f</span>&nbsp;<span class="op" id="3746146">=</span>&nbsp;<span class="op" id="3746148">[</span><span class="op" id="3746149">]</span><span class="ident" id="3746150">field</span><span class="op" id="3746155">{</span><span class="op" id="3746156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3746159">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3746163">fieldCache</span><span class="op" id="3746173">.</span><span class="ident" id="3746174">Lock</span><span class="op" id="3746178">(</span><span class="op" id="3746179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746182">if</span>&nbsp;<span class="ident" id="3746185">fieldCache</span><span class="op" id="3746195">.</span><span class="ident" id="3746196">m</span>&nbsp;<span class="op" id="3746198">==</span>&nbsp;<span class="ident" id="3746201">nil</span>&nbsp;<span class="op" id="3746205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3746209">fieldCache</span><span class="op" id="3746219">.</span><span class="ident" id="3746220">m</span>&nbsp;<span class="op" id="3746222">=</span>&nbsp;<span class="keyword" id="3746224">map</span><span class="op" id="3746227">[</span><span class="ident" id="3746228">reflect</span><span class="op" id="3746235">.</span><span class="ident" id="3746236">Type</span><span class="op" id="3746240">]</span><span class="op" id="3746241">[</span><span class="op" id="3746242">]</span><span class="ident" id="3746243">field</span><span class="op" id="3746248">{</span><span class="op" id="3746249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3746252">}</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3746255">fieldCache</span><span class="op" id="3746265">.</span><span class="ident" id="3746266">m</span><span class="op" id="3746267">[</span><span class="ident" id="3746268">t</span><span class="op" id="3746269">]</span>&nbsp;<span class="op" id="3746271">=</span>&nbsp;<span class="ident" id="3746273">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3746276">fieldCache</span><span class="op" id="3746286">.</span><span class="ident" id="3746287">Unlock</span><span class="op" id="3746293">(</span><span class="op" id="3746294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3746297">return</span>&nbsp;<span class="ident" id="3746304">f</span><br>
<span class="lineno"></span><span class="op" id="3746306">}</span>
</div>
</body>
</html>
