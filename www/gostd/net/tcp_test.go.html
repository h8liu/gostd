<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html" class="current">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6775655">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6775710">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6775764">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6775815">package</span>&nbsp;<span class="ident" id="6775823">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6775828">import</span>&nbsp;<span class="op" id="6775835">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6775838">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6775845">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6775851">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6775862">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6775873">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6775881">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6775892">&#34;time&#34;</span><br>
<span class="lineno">15</span><span class="op" id="6775899">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6775902">func</span>&nbsp;<span class="ident" id="6775907">BenchmarkTCP4OneShot</span><span class="op" id="6775927">(</span><span class="ident" id="6775928">b</span>&nbsp;<span class="op" id="6775930">*</span><span class="ident" id="6775931">testing</span><span class="op" id="6775938">.</span><span class="ident" id="6775939">B</span><span class="op" id="6775940">)</span>&nbsp;<span class="op" id="6775942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6775945">benchmarkTCP</span><span class="op" id="6775957">(</span><span class="ident" id="6775958">b</span><span class="op" id="6775959">,</span>&nbsp;<span class="builtintype" id="6775961">false</span><span class="op" id="6775966">,</span>&nbsp;<span class="builtintype" id="6775968">false</span><span class="op" id="6775973">,</span>&nbsp;<span class="string" id="6775975">&#34;127.0.0.1:0&#34;</span><span class="op" id="6775988">)</span><br>
<span class="lineno"></span><span class="op" id="6775990">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="6775993">func</span>&nbsp;<span class="ident" id="6775998">BenchmarkTCP4OneShotTimeout</span><span class="op" id="6776025">(</span><span class="ident" id="6776026">b</span>&nbsp;<span class="op" id="6776028">*</span><span class="ident" id="6776029">testing</span><span class="op" id="6776036">.</span><span class="ident" id="6776037">B</span><span class="op" id="6776038">)</span>&nbsp;<span class="op" id="6776040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776043">benchmarkTCP</span><span class="op" id="6776055">(</span><span class="ident" id="6776056">b</span><span class="op" id="6776057">,</span>&nbsp;<span class="builtintype" id="6776059">false</span><span class="op" id="6776064">,</span>&nbsp;<span class="builtintype" id="6776066">true</span><span class="op" id="6776070">,</span>&nbsp;<span class="string" id="6776072">&#34;127.0.0.1:0&#34;</span><span class="op" id="6776085">)</span><br>
<span class="lineno"></span><span class="op" id="6776087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="6776090">func</span>&nbsp;<span class="ident" id="6776095">BenchmarkTCP4Persistent</span><span class="op" id="6776118">(</span><span class="ident" id="6776119">b</span>&nbsp;<span class="op" id="6776121">*</span><span class="ident" id="6776122">testing</span><span class="op" id="6776129">.</span><span class="ident" id="6776130">B</span><span class="op" id="6776131">)</span>&nbsp;<span class="op" id="6776133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776136">benchmarkTCP</span><span class="op" id="6776148">(</span><span class="ident" id="6776149">b</span><span class="op" id="6776150">,</span>&nbsp;<span class="builtintype" id="6776152">true</span><span class="op" id="6776156">,</span>&nbsp;<span class="builtintype" id="6776158">false</span><span class="op" id="6776163">,</span>&nbsp;<span class="string" id="6776165">&#34;127.0.0.1:0&#34;</span><span class="op" id="6776178">)</span><br>
<span class="lineno"></span><span class="op" id="6776180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6776183">func</span>&nbsp;<span class="ident" id="6776188">BenchmarkTCP4PersistentTimeout</span><span class="op" id="6776218">(</span><span class="ident" id="6776219">b</span>&nbsp;<span class="op" id="6776221">*</span><span class="ident" id="6776222">testing</span><span class="op" id="6776229">.</span><span class="ident" id="6776230">B</span><span class="op" id="6776231">)</span>&nbsp;<span class="op" id="6776233">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776236">benchmarkTCP</span><span class="op" id="6776248">(</span><span class="ident" id="6776249">b</span><span class="op" id="6776250">,</span>&nbsp;<span class="builtintype" id="6776252">true</span><span class="op" id="6776256">,</span>&nbsp;<span class="builtintype" id="6776258">true</span><span class="op" id="6776262">,</span>&nbsp;<span class="string" id="6776264">&#34;127.0.0.1:0&#34;</span><span class="op" id="6776277">)</span><br>
<span class="lineno"></span><span class="op" id="6776279">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6776282">func</span>&nbsp;<span class="ident" id="6776287">BenchmarkTCP6OneShot</span><span class="op" id="6776307">(</span><span class="ident" id="6776308">b</span>&nbsp;<span class="op" id="6776310">*</span><span class="ident" id="6776311">testing</span><span class="op" id="6776318">.</span><span class="ident" id="6776319">B</span><span class="op" id="6776320">)</span>&nbsp;<span class="op" id="6776322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6776325">if</span>&nbsp;<span class="op" id="6776328">!</span><span class="ident" id="6776329">supportsIPv6</span>&nbsp;<span class="op" id="6776342">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776346">b</span><span class="op" id="6776347">.</span><span class="ident" id="6776348">Skip</span><span class="op" id="6776352">(</span><span class="string" id="6776353">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6776376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6776379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776382">benchmarkTCP</span><span class="op" id="6776394">(</span><span class="ident" id="6776395">b</span><span class="op" id="6776396">,</span>&nbsp;<span class="builtintype" id="6776398">false</span><span class="op" id="6776403">,</span>&nbsp;<span class="builtintype" id="6776405">false</span><span class="op" id="6776410">,</span>&nbsp;<span class="string" id="6776412">&#34;[::1]:0&#34;</span><span class="op" id="6776421">)</span><br>
<span class="lineno"></span><span class="op" id="6776423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="6776426">func</span>&nbsp;<span class="ident" id="6776431">BenchmarkTCP6OneShotTimeout</span><span class="op" id="6776458">(</span><span class="ident" id="6776459">b</span>&nbsp;<span class="op" id="6776461">*</span><span class="ident" id="6776462">testing</span><span class="op" id="6776469">.</span><span class="ident" id="6776470">B</span><span class="op" id="6776471">)</span>&nbsp;<span class="op" id="6776473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6776476">if</span>&nbsp;<span class="op" id="6776479">!</span><span class="ident" id="6776480">supportsIPv6</span>&nbsp;<span class="op" id="6776493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776497">b</span><span class="op" id="6776498">.</span><span class="ident" id="6776499">Skip</span><span class="op" id="6776503">(</span><span class="string" id="6776504">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6776527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6776530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776533">benchmarkTCP</span><span class="op" id="6776545">(</span><span class="ident" id="6776546">b</span><span class="op" id="6776547">,</span>&nbsp;<span class="builtintype" id="6776549">false</span><span class="op" id="6776554">,</span>&nbsp;<span class="builtintype" id="6776556">true</span><span class="op" id="6776560">,</span>&nbsp;<span class="string" id="6776562">&#34;[::1]:0&#34;</span><span class="op" id="6776571">)</span><br>
<span class="lineno">45</span><span class="op" id="6776573">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6776576">func</span>&nbsp;<span class="ident" id="6776581">BenchmarkTCP6Persistent</span><span class="op" id="6776604">(</span><span class="ident" id="6776605">b</span>&nbsp;<span class="op" id="6776607">*</span><span class="ident" id="6776608">testing</span><span class="op" id="6776615">.</span><span class="ident" id="6776616">B</span><span class="op" id="6776617">)</span>&nbsp;<span class="op" id="6776619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6776622">if</span>&nbsp;<span class="op" id="6776625">!</span><span class="ident" id="6776626">supportsIPv6</span>&nbsp;<span class="op" id="6776639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776643">b</span><span class="op" id="6776644">.</span><span class="ident" id="6776645">Skip</span><span class="op" id="6776649">(</span><span class="string" id="6776650">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6776673">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6776676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776679">benchmarkTCP</span><span class="op" id="6776691">(</span><span class="ident" id="6776692">b</span><span class="op" id="6776693">,</span>&nbsp;<span class="builtintype" id="6776695">true</span><span class="op" id="6776699">,</span>&nbsp;<span class="builtintype" id="6776701">false</span><span class="op" id="6776706">,</span>&nbsp;<span class="string" id="6776708">&#34;[::1]:0&#34;</span><span class="op" id="6776717">)</span><br>
<span class="lineno"></span><span class="op" id="6776719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6776722">func</span>&nbsp;<span class="ident" id="6776727">BenchmarkTCP6PersistentTimeout</span><span class="op" id="6776757">(</span><span class="ident" id="6776758">b</span>&nbsp;<span class="op" id="6776760">*</span><span class="ident" id="6776761">testing</span><span class="op" id="6776768">.</span><span class="ident" id="6776769">B</span><span class="op" id="6776770">)</span>&nbsp;<span class="op" id="6776772">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6776775">if</span>&nbsp;<span class="op" id="6776778">!</span><span class="ident" id="6776779">supportsIPv6</span>&nbsp;<span class="op" id="6776792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776796">b</span><span class="op" id="6776797">.</span><span class="ident" id="6776798">Skip</span><span class="op" id="6776802">(</span><span class="string" id="6776803">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6776826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6776829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776832">benchmarkTCP</span><span class="op" id="6776844">(</span><span class="ident" id="6776845">b</span><span class="op" id="6776846">,</span>&nbsp;<span class="builtintype" id="6776848">true</span><span class="op" id="6776852">,</span>&nbsp;<span class="builtintype" id="6776854">true</span><span class="op" id="6776858">,</span>&nbsp;<span class="string" id="6776860">&#34;[::1]:0&#34;</span><span class="op" id="6776869">)</span><br>
<span class="lineno"></span><span class="op" id="6776871">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="6776874">func</span>&nbsp;<span class="ident" id="6776879">benchmarkTCP</span><span class="op" id="6776891">(</span><span class="ident" id="6776892">b</span>&nbsp;<span class="op" id="6776894">*</span><span class="ident" id="6776895">testing</span><span class="op" id="6776902">.</span><span class="ident" id="6776903">B</span><span class="op" id="6776904">,</span>&nbsp;<span class="ident" id="6776906">persistent</span><span class="op" id="6776916">,</span>&nbsp;<span class="ident" id="6776918">timeout</span>&nbsp;<span class="builtintype" id="6776926">bool</span><span class="op" id="6776930">,</span>&nbsp;<span class="ident" id="6776932">laddr</span>&nbsp;<span class="builtintype" id="6776938">string</span><span class="op" id="6776944">)</span>&nbsp;<span class="op" id="6776946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6776949">const</span>&nbsp;<span class="ident" id="6776955">msgLen</span>&nbsp;<span class="op" id="6776962">=</span>&nbsp;<span class="num" id="6776964">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776969">conns</span>&nbsp;<span class="op" id="6776975">:=</span>&nbsp;<span class="ident" id="6776978">b</span><span class="op" id="6776979">.</span><span class="ident" id="6776980">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6776983">numConcurrent</span>&nbsp;<span class="op" id="6776997">:=</span>&nbsp;<span class="ident" id="6777000">runtime</span><span class="op" id="6777007">.</span><span class="ident" id="6777008">GOMAXPROCS</span><span class="op" id="6777018">(</span><span class="op" id="6777019">-</span><span class="num" id="6777020">1</span><span class="op" id="6777021">)</span>&nbsp;<span class="op" id="6777023">*</span>&nbsp;<span class="num" id="6777025">2</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777028">msgs</span>&nbsp;<span class="op" id="6777033">:=</span>&nbsp;<span class="num" id="6777036">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777039">if</span>&nbsp;<span class="ident" id="6777042">persistent</span>&nbsp;<span class="op" id="6777053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777057">conns</span>&nbsp;<span class="op" id="6777063">=</span>&nbsp;<span class="ident" id="6777065">numConcurrent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777081">msgs</span>&nbsp;<span class="op" id="6777086">=</span>&nbsp;<span class="ident" id="6777088">b</span><span class="op" id="6777089">.</span><span class="ident" id="6777090">N</span>&nbsp;<span class="op" id="6777092">/</span>&nbsp;<span class="ident" id="6777094">conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777102">if</span>&nbsp;<span class="ident" id="6777105">msgs</span>&nbsp;<span class="op" id="6777110">==</span>&nbsp;<span class="num" id="6777113">0</span>&nbsp;<span class="op" id="6777115">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777120">msgs</span>&nbsp;<span class="op" id="6777125">=</span>&nbsp;<span class="num" id="6777127">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6777131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777135">if</span>&nbsp;<span class="ident" id="6777138">conns</span>&nbsp;<span class="op" id="6777144">&gt;</span>&nbsp;<span class="ident" id="6777146">b</span><span class="op" id="6777147">.</span><span class="ident" id="6777148">N</span>&nbsp;<span class="op" id="6777150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777155">conns</span>&nbsp;<span class="op" id="6777161">=</span>&nbsp;<span class="ident" id="6777163">b</span><span class="op" id="6777164">.</span><span class="ident" id="6777165">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6777169">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6777172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777175">sendMsg</span>&nbsp;<span class="op" id="6777183">:=</span>&nbsp;<span class="keyword" id="6777186">func</span><span class="op" id="6777190">(</span><span class="ident" id="6777191">c</span>&nbsp;<span class="ident" id="6777193">Conn</span><span class="op" id="6777197">,</span>&nbsp;<span class="ident" id="6777199">buf</span>&nbsp;<span class="op" id="6777203">[</span><span class="op" id="6777204">]</span><span class="builtintype" id="6777205">byte</span><span class="op" id="6777209">)</span>&nbsp;<span class="builtintype" id="6777211">bool</span>&nbsp;<span class="op" id="6777216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777220">n</span><span class="op" id="6777221">,</span>&nbsp;<span class="ident" id="6777223">err</span>&nbsp;<span class="op" id="6777227">:=</span>&nbsp;<span class="ident" id="6777230">c</span><span class="op" id="6777231">.</span><span class="ident" id="6777232">Write</span><span class="op" id="6777237">(</span><span class="ident" id="6777238">buf</span><span class="op" id="6777241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777245">if</span>&nbsp;<span class="ident" id="6777248">n</span>&nbsp;<span class="op" id="6777250">!=</span>&nbsp;<span class="builtinfunc" id="6777253">len</span><span class="op" id="6777256">(</span><span class="ident" id="6777257">buf</span><span class="op" id="6777260">)</span>&nbsp;<span class="op" id="6777262">||</span>&nbsp;<span class="ident" id="6777265">err</span>&nbsp;<span class="op" id="6777269">!=</span>&nbsp;<span class="builtintype" id="6777272">nil</span>&nbsp;<span class="op" id="6777276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777281">b</span><span class="op" id="6777282">.</span><span class="ident" id="6777283">Logf</span><span class="op" id="6777287">(</span><span class="string" id="6777288">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6777306">,</span>&nbsp;<span class="ident" id="6777308">err</span><span class="op" id="6777311">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777316">return</span>&nbsp;<span class="builtintype" id="6777323">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6777331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777335">return</span>&nbsp;<span class="builtintype" id="6777342">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6777348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777351">recvMsg</span>&nbsp;<span class="op" id="6777359">:=</span>&nbsp;<span class="keyword" id="6777362">func</span><span class="op" id="6777366">(</span><span class="ident" id="6777367">c</span>&nbsp;<span class="ident" id="6777369">Conn</span><span class="op" id="6777373">,</span>&nbsp;<span class="ident" id="6777375">buf</span>&nbsp;<span class="op" id="6777379">[</span><span class="op" id="6777380">]</span><span class="builtintype" id="6777381">byte</span><span class="op" id="6777385">)</span>&nbsp;<span class="builtintype" id="6777387">bool</span>&nbsp;<span class="op" id="6777392">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777396">for</span>&nbsp;<span class="ident" id="6777400">read</span>&nbsp;<span class="op" id="6777405">:=</span>&nbsp;<span class="num" id="6777408">0</span><span class="op" id="6777409">;</span>&nbsp;<span class="ident" id="6777411">read</span>&nbsp;<span class="op" id="6777416">!=</span>&nbsp;<span class="builtinfunc" id="6777419">len</span><span class="op" id="6777422">(</span><span class="ident" id="6777423">buf</span><span class="op" id="6777426">)</span><span class="op" id="6777427">;</span>&nbsp;<span class="op" id="6777429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777434">n</span><span class="op" id="6777435">,</span>&nbsp;<span class="ident" id="6777437">err</span>&nbsp;<span class="op" id="6777441">:=</span>&nbsp;<span class="ident" id="6777444">c</span><span class="op" id="6777445">.</span><span class="ident" id="6777446">Read</span><span class="op" id="6777450">(</span><span class="ident" id="6777451">buf</span><span class="op" id="6777454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777459">read</span>&nbsp;<span class="op" id="6777464">+=</span>&nbsp;<span class="ident" id="6777467">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777472">if</span>&nbsp;<span class="ident" id="6777475">err</span>&nbsp;<span class="op" id="6777479">!=</span>&nbsp;<span class="builtintype" id="6777482">nil</span>&nbsp;<span class="op" id="6777486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777492">b</span><span class="op" id="6777493">.</span><span class="ident" id="6777494">Logf</span><span class="op" id="6777498">(</span><span class="string" id="6777499">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6777516">,</span>&nbsp;<span class="ident" id="6777518">err</span><span class="op" id="6777521">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777527">return</span>&nbsp;<span class="builtintype" id="6777534">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6777543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6777547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777551">return</span>&nbsp;<span class="builtintype" id="6777558">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6777564">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777567">ln</span><span class="op" id="6777569">,</span>&nbsp;<span class="ident" id="6777571">err</span>&nbsp;<span class="op" id="6777575">:=</span>&nbsp;<span class="ident" id="6777578">Listen</span><span class="op" id="6777584">(</span><span class="string" id="6777585">&#34;tcp&#34;</span><span class="op" id="6777590">,</span>&nbsp;<span class="ident" id="6777592">laddr</span><span class="op" id="6777597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777600">if</span>&nbsp;<span class="ident" id="6777603">err</span>&nbsp;<span class="op" id="6777607">!=</span>&nbsp;<span class="builtintype" id="6777610">nil</span>&nbsp;<span class="op" id="6777614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777618">b</span><span class="op" id="6777619">.</span><span class="ident" id="6777620">Fatalf</span><span class="op" id="6777626">(</span><span class="string" id="6777627">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6777646">,</span>&nbsp;<span class="ident" id="6777648">err</span><span class="op" id="6777651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6777654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777657">defer</span>&nbsp;<span class="ident" id="6777663">ln</span><span class="op" id="6777665">.</span><span class="ident" id="6777666">Close</span><span class="op" id="6777671">(</span><span class="op" id="6777672">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777675">serverSem</span>&nbsp;<span class="op" id="6777685">:=</span>&nbsp;<span class="builtinfunc" id="6777688">make</span><span class="op" id="6777692">(</span><span class="keyword" id="6777693">chan</span>&nbsp;<span class="builtintype" id="6777698">bool</span><span class="op" id="6777702">,</span>&nbsp;<span class="ident" id="6777704">numConcurrent</span><span class="op" id="6777717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6777720">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777734">go</span>&nbsp;<span class="keyword" id="6777737">func</span><span class="op" id="6777741">(</span><span class="op" id="6777742">)</span>&nbsp;<span class="op" id="6777744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777748">for</span>&nbsp;<span class="op" id="6777752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777757">c</span><span class="op" id="6777758">,</span>&nbsp;<span class="ident" id="6777760">err</span>&nbsp;<span class="op" id="6777764">:=</span>&nbsp;<span class="ident" id="6777767">ln</span><span class="op" id="6777769">.</span><span class="ident" id="6777770">Accept</span><span class="op" id="6777776">(</span><span class="op" id="6777777">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777782">if</span>&nbsp;<span class="ident" id="6777785">err</span>&nbsp;<span class="op" id="6777789">!=</span>&nbsp;<span class="builtintype" id="6777792">nil</span>&nbsp;<span class="op" id="6777796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777802">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6777811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777816">serverSem</span>&nbsp;<span class="op" id="6777826">&lt;-</span>&nbsp;<span class="builtintype" id="6777829">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6777837">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777862">go</span>&nbsp;<span class="keyword" id="6777865">func</span><span class="op" id="6777869">(</span><span class="ident" id="6777870">c</span>&nbsp;<span class="ident" id="6777872">Conn</span><span class="op" id="6777876">)</span>&nbsp;<span class="op" id="6777878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777884">defer</span>&nbsp;<span class="keyword" id="6777890">func</span><span class="op" id="6777894">(</span><span class="op" id="6777895">)</span>&nbsp;<span class="op" id="6777897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777904">c</span><span class="op" id="6777905">.</span><span class="ident" id="6777906">Close</span><span class="op" id="6777911">(</span><span class="op" id="6777912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6777919">&lt;-</span><span class="ident" id="6777921">serverSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6777935">}</span><span class="op" id="6777936">(</span><span class="op" id="6777937">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6777943">if</span>&nbsp;<span class="ident" id="6777946">timeout</span>&nbsp;<span class="op" id="6777954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6777961">c</span><span class="op" id="6777962">.</span><span class="ident" id="6777963">SetDeadline</span><span class="op" id="6777974">(</span><span class="ident" id="6777975">time</span><span class="op" id="6777979">.</span><span class="ident" id="6777980">Now</span><span class="op" id="6777983">(</span><span class="op" id="6777984">)</span><span class="op" id="6777985">.</span><span class="ident" id="6777986">Add</span><span class="op" id="6777989">(</span><span class="ident" id="6777990">time</span><span class="op" id="6777994">.</span><span class="ident" id="6777995">Hour</span><span class="op" id="6777999">)</span><span class="op" id="6778000">)</span>&nbsp;<span class="comment" id="6778002">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6778031">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778037">var</span>&nbsp;<span class="ident" id="6778041">buf</span>&nbsp;<span class="op" id="6778045">[</span><span class="ident" id="6778046">msgLen</span><span class="op" id="6778052">]</span><span class="builtintype" id="6778053">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778062">for</span>&nbsp;<span class="ident" id="6778066">m</span>&nbsp;<span class="op" id="6778068">:=</span>&nbsp;<span class="num" id="6778071">0</span><span class="op" id="6778072">;</span>&nbsp;<span class="ident" id="6778074">m</span>&nbsp;<span class="op" id="6778076">&lt;</span>&nbsp;<span class="ident" id="6778078">msgs</span><span class="op" id="6778082">;</span>&nbsp;<span class="ident" id="6778084">m</span><span class="op" id="6778085">++</span>&nbsp;<span class="op" id="6778088">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778095">if</span>&nbsp;<span class="op" id="6778098">!</span><span class="ident" id="6778099">recvMsg</span><span class="op" id="6778106">(</span><span class="ident" id="6778107">c</span><span class="op" id="6778108">,</span>&nbsp;<span class="ident" id="6778110">buf</span><span class="op" id="6778113">[</span><span class="op" id="6778114">:</span><span class="op" id="6778115">]</span><span class="op" id="6778116">)</span>&nbsp;<span class="op" id="6778118">||</span>&nbsp;<span class="op" id="6778121">!</span><span class="ident" id="6778122">sendMsg</span><span class="op" id="6778129">(</span><span class="ident" id="6778130">c</span><span class="op" id="6778131">,</span>&nbsp;<span class="ident" id="6778133">buf</span><span class="op" id="6778136">[</span><span class="op" id="6778137">:</span><span class="op" id="6778138">]</span><span class="op" id="6778139">)</span>&nbsp;<span class="op" id="6778141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778149">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6778160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6778166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6778171">}</span><span class="op" id="6778172">(</span><span class="ident" id="6778173">c</span><span class="op" id="6778174">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6778178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6778181">}</span><span class="op" id="6778182">(</span><span class="op" id="6778183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778186">clientSem</span>&nbsp;<span class="op" id="6778196">:=</span>&nbsp;<span class="builtinfunc" id="6778199">make</span><span class="op" id="6778203">(</span><span class="keyword" id="6778204">chan</span>&nbsp;<span class="builtintype" id="6778209">bool</span><span class="op" id="6778213">,</span>&nbsp;<span class="ident" id="6778215">numConcurrent</span><span class="op" id="6778228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778231">for</span>&nbsp;<span class="ident" id="6778235">i</span>&nbsp;<span class="op" id="6778237">:=</span>&nbsp;<span class="num" id="6778240">0</span><span class="op" id="6778241">;</span>&nbsp;<span class="ident" id="6778243">i</span>&nbsp;<span class="op" id="6778245">&lt;</span>&nbsp;<span class="ident" id="6778247">conns</span><span class="op" id="6778252">;</span>&nbsp;<span class="ident" id="6778254">i</span><span class="op" id="6778255">++</span>&nbsp;<span class="op" id="6778258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778262">clientSem</span>&nbsp;<span class="op" id="6778272">&lt;-</span>&nbsp;<span class="builtintype" id="6778275">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6778282">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778306">go</span>&nbsp;<span class="keyword" id="6778309">func</span><span class="op" id="6778313">(</span><span class="op" id="6778314">)</span>&nbsp;<span class="op" id="6778316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778321">defer</span>&nbsp;<span class="keyword" id="6778327">func</span><span class="op" id="6778331">(</span><span class="op" id="6778332">)</span>&nbsp;<span class="op" id="6778334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6778340">&lt;-</span><span class="ident" id="6778342">clientSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6778355">}</span><span class="op" id="6778356">(</span><span class="op" id="6778357">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778362">c</span><span class="op" id="6778363">,</span>&nbsp;<span class="ident" id="6778365">err</span>&nbsp;<span class="op" id="6778369">:=</span>&nbsp;<span class="ident" id="6778372">Dial</span><span class="op" id="6778376">(</span><span class="string" id="6778377">&#34;tcp&#34;</span><span class="op" id="6778382">,</span>&nbsp;<span class="ident" id="6778384">ln</span><span class="op" id="6778386">.</span><span class="ident" id="6778387">Addr</span><span class="op" id="6778391">(</span><span class="op" id="6778392">)</span><span class="op" id="6778393">.</span><span class="ident" id="6778394">String</span><span class="op" id="6778400">(</span><span class="op" id="6778401">)</span><span class="op" id="6778402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778407">if</span>&nbsp;<span class="ident" id="6778410">err</span>&nbsp;<span class="op" id="6778414">!=</span>&nbsp;<span class="builtintype" id="6778417">nil</span>&nbsp;<span class="op" id="6778421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778427">b</span><span class="op" id="6778428">.</span><span class="ident" id="6778429">Logf</span><span class="op" id="6778433">(</span><span class="string" id="6778434">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6778451">,</span>&nbsp;<span class="ident" id="6778453">err</span><span class="op" id="6778456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778462">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6778472">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778477">defer</span>&nbsp;<span class="ident" id="6778483">c</span><span class="op" id="6778484">.</span><span class="ident" id="6778485">Close</span><span class="op" id="6778490">(</span><span class="op" id="6778491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778496">if</span>&nbsp;<span class="ident" id="6778499">timeout</span>&nbsp;<span class="op" id="6778507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778513">c</span><span class="op" id="6778514">.</span><span class="ident" id="6778515">SetDeadline</span><span class="op" id="6778526">(</span><span class="ident" id="6778527">time</span><span class="op" id="6778531">.</span><span class="ident" id="6778532">Now</span><span class="op" id="6778535">(</span><span class="op" id="6778536">)</span><span class="op" id="6778537">.</span><span class="ident" id="6778538">Add</span><span class="op" id="6778541">(</span><span class="ident" id="6778542">time</span><span class="op" id="6778546">.</span><span class="ident" id="6778547">Hour</span><span class="op" id="6778551">)</span><span class="op" id="6778552">)</span>&nbsp;<span class="comment" id="6778554">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6778582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778587">var</span>&nbsp;<span class="ident" id="6778591">buf</span>&nbsp;<span class="op" id="6778595">[</span><span class="ident" id="6778596">msgLen</span><span class="op" id="6778602">]</span><span class="builtintype" id="6778603">byte</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778611">for</span>&nbsp;<span class="ident" id="6778615">m</span>&nbsp;<span class="op" id="6778617">:=</span>&nbsp;<span class="num" id="6778620">0</span><span class="op" id="6778621">;</span>&nbsp;<span class="ident" id="6778623">m</span>&nbsp;<span class="op" id="6778625">&lt;</span>&nbsp;<span class="ident" id="6778627">msgs</span><span class="op" id="6778631">;</span>&nbsp;<span class="ident" id="6778633">m</span><span class="op" id="6778634">++</span>&nbsp;<span class="op" id="6778637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778643">if</span>&nbsp;<span class="op" id="6778646">!</span><span class="ident" id="6778647">sendMsg</span><span class="op" id="6778654">(</span><span class="ident" id="6778655">c</span><span class="op" id="6778656">,</span>&nbsp;<span class="ident" id="6778658">buf</span><span class="op" id="6778661">[</span><span class="op" id="6778662">:</span><span class="op" id="6778663">]</span><span class="op" id="6778664">)</span>&nbsp;<span class="op" id="6778666">||</span>&nbsp;<span class="op" id="6778669">!</span><span class="ident" id="6778670">recvMsg</span><span class="op" id="6778677">(</span><span class="ident" id="6778678">c</span><span class="op" id="6778679">,</span>&nbsp;<span class="ident" id="6778681">buf</span><span class="op" id="6778684">[</span><span class="op" id="6778685">:</span><span class="op" id="6778686">]</span><span class="op" id="6778687">)</span>&nbsp;<span class="op" id="6778689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778696">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6778706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6778711">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6778715">}</span><span class="op" id="6778716">(</span><span class="op" id="6778717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6778720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778723">for</span>&nbsp;<span class="ident" id="6778727">i</span>&nbsp;<span class="op" id="6778729">:=</span>&nbsp;<span class="num" id="6778732">0</span><span class="op" id="6778733">;</span>&nbsp;<span class="ident" id="6778735">i</span>&nbsp;<span class="op" id="6778737">&lt;</span>&nbsp;<span class="ident" id="6778739">numConcurrent</span><span class="op" id="6778752">;</span>&nbsp;<span class="ident" id="6778754">i</span><span class="op" id="6778755">++</span>&nbsp;<span class="op" id="6778758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778762">clientSem</span>&nbsp;<span class="op" id="6778772">&lt;-</span>&nbsp;<span class="builtintype" id="6778775">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778782">serverSem</span>&nbsp;<span class="op" id="6778792">&lt;-</span>&nbsp;<span class="builtintype" id="6778795">true</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6778801">}</span><br>
<span class="lineno"></span><span class="op" id="6778803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6778806">func</span>&nbsp;<span class="ident" id="6778811">BenchmarkTCP4ConcurrentReadWrite</span><span class="op" id="6778843">(</span><span class="ident" id="6778844">b</span>&nbsp;<span class="op" id="6778846">*</span><span class="ident" id="6778847">testing</span><span class="op" id="6778854">.</span><span class="ident" id="6778855">B</span><span class="op" id="6778856">)</span>&nbsp;<span class="op" id="6778858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778861">benchmarkTCPConcurrentReadWrite</span><span class="op" id="6778892">(</span><span class="ident" id="6778893">b</span><span class="op" id="6778894">,</span>&nbsp;<span class="string" id="6778896">&#34;127.0.0.1:0&#34;</span><span class="op" id="6778909">)</span><br>
<span class="lineno">160</span><span class="op" id="6778911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6778914">func</span>&nbsp;<span class="ident" id="6778919">BenchmarkTCP6ConcurrentReadWrite</span><span class="op" id="6778951">(</span><span class="ident" id="6778952">b</span>&nbsp;<span class="op" id="6778954">*</span><span class="ident" id="6778955">testing</span><span class="op" id="6778962">.</span><span class="ident" id="6778963">B</span><span class="op" id="6778964">)</span>&nbsp;<span class="op" id="6778966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6778969">if</span>&nbsp;<span class="op" id="6778972">!</span><span class="ident" id="6778973">supportsIPv6</span>&nbsp;<span class="op" id="6778986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6778990">b</span><span class="op" id="6778991">.</span><span class="ident" id="6778992">Skip</span><span class="op" id="6778996">(</span><span class="string" id="6778997">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6779020">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6779023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6779026">benchmarkTCPConcurrentReadWrite</span><span class="op" id="6779057">(</span><span class="ident" id="6779058">b</span><span class="op" id="6779059">,</span>&nbsp;<span class="string" id="6779061">&#34;[::1]:0&#34;</span><span class="op" id="6779070">)</span><br>
<span class="lineno"></span><span class="op" id="6779072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6779075">func</span>&nbsp;<span class="ident" id="6779080">benchmarkTCPConcurrentReadWrite</span><span class="op" id="6779111">(</span><span class="ident" id="6779112">b</span>&nbsp;<span class="op" id="6779114">*</span><span class="ident" id="6779115">testing</span><span class="op" id="6779122">.</span><span class="ident" id="6779123">B</span><span class="op" id="6779124">,</span>&nbsp;<span class="ident" id="6779126">laddr</span>&nbsp;<span class="builtintype" id="6779132">string</span><span class="op" id="6779138">)</span>&nbsp;<span class="op" id="6779140">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6779143">//&nbsp;The&nbsp;benchmark&nbsp;creates&nbsp;GOMAXPROCS&nbsp;client/server&nbsp;pairs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6779201">//&nbsp;Each&nbsp;pair&nbsp;creates&nbsp;4&nbsp;goroutines:&nbsp;client&nbsp;reader/writer&nbsp;and&nbsp;server&nbsp;reader/writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6779284">//&nbsp;The&nbsp;benchmark&nbsp;stresses&nbsp;concurrent&nbsp;reading&nbsp;and&nbsp;writing&nbsp;to&nbsp;the&nbsp;same&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6779366">//&nbsp;Such&nbsp;pattern&nbsp;is&nbsp;used&nbsp;in&nbsp;net/http&nbsp;and&nbsp;net/rpc.</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6779417">b</span><span class="op" id="6779418">.</span><span class="ident" id="6779419">StopTimer</span><span class="op" id="6779428">(</span><span class="op" id="6779429">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6779433">P</span>&nbsp;<span class="op" id="6779435">:=</span>&nbsp;<span class="ident" id="6779438">runtime</span><span class="op" id="6779445">.</span><span class="ident" id="6779446">GOMAXPROCS</span><span class="op" id="6779456">(</span><span class="num" id="6779457">0</span><span class="op" id="6779458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6779461">N</span>&nbsp;<span class="op" id="6779463">:=</span>&nbsp;<span class="ident" id="6779466">b</span><span class="op" id="6779467">.</span><span class="ident" id="6779468">N</span>&nbsp;<span class="op" id="6779470">/</span>&nbsp;<span class="ident" id="6779472">P</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6779475">W</span>&nbsp;<span class="op" id="6779477">:=</span>&nbsp;<span class="num" id="6779480">1000</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6779487">//&nbsp;Setup&nbsp;P&nbsp;client/server&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6779526">clients</span>&nbsp;<span class="op" id="6779534">:=</span>&nbsp;<span class="builtinfunc" id="6779537">make</span><span class="op" id="6779541">(</span><span class="op" id="6779542">[</span><span class="op" id="6779543">]</span><span class="ident" id="6779544">Conn</span><span class="op" id="6779548">,</span>&nbsp;<span class="ident" id="6779550">P</span><span class="op" id="6779551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6779554">servers</span>&nbsp;<span class="op" id="6779562">:=</span>&nbsp;<span class="builtinfunc" id="6779565">make</span><span class="op" id="6779569">(</span><span class="op" id="6779570">[</span><span class="op" id="6779571">]</span><span class="ident" id="6779572">Conn</span><span class="op" id="6779576">,</span>&nbsp;<span class="ident" id="6779578">P</span><span class="op" id="6779579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6779582">ln</span><span class="op" id="6779584">,</span>&nbsp;<span class="ident" id="6779586">err</span>&nbsp;<span class="op" id="6779590">:=</span>&nbsp;<span class="ident" id="6779593">Listen</span><span class="op" id="6779599">(</span><span class="string" id="6779600">&#34;tcp&#34;</span><span class="op" id="6779605">,</span>&nbsp;<span class="ident" id="6779607">laddr</span><span class="op" id="6779612">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6779615">if</span>&nbsp;<span class="ident" id="6779618">err</span>&nbsp;<span class="op" id="6779622">!=</span>&nbsp;<span class="builtintype" id="6779625">nil</span>&nbsp;<span class="op" id="6779629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6779633">b</span><span class="op" id="6779634">.</span><span class="ident" id="6779635">Fatalf</span><span class="op" id="6779641">(</span><span class="string" id="6779642">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6779661">,</span>&nbsp;<span class="ident" id="6779663">err</span><span class="op" id="6779666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6779669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6779672">defer</span>&nbsp;<span class="ident" id="6779678">ln</span><span class="op" id="6779680">.</span><span class="ident" id="6779681">Close</span><span class="op" id="6779686">(</span><span class="op" id="6779687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6779690">done</span>&nbsp;<span class="op" id="6779695">:=</span>&nbsp;<span class="builtinfunc" id="6779698">make</span><span class="op" id="6779702">(</span><span class="keyword" id="6779703">chan</span>&nbsp;<span class="builtintype" id="6779708">bool</span><span class="op" id="6779712">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6779715">go</span>&nbsp;<span class="keyword" id="6779718">func</span><span class="op" id="6779722">(</span><span class="op" id="6779723">)</span>&nbsp;<span class="op" id="6779725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6779729">for</span>&nbsp;<span class="ident" id="6779733">p</span>&nbsp;<span class="op" id="6779735">:=</span>&nbsp;<span class="num" id="6779738">0</span><span class="op" id="6779739">;</span>&nbsp;<span class="ident" id="6779741">p</span>&nbsp;<span class="op" id="6779743">&lt;</span>&nbsp;<span class="ident" id="6779745">P</span><span class="op" id="6779746">;</span>&nbsp;<span class="ident" id="6779748">p</span><span class="op" id="6779749">++</span>&nbsp;<span class="op" id="6779752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6779757">s</span><span class="op" id="6779758">,</span>&nbsp;<span class="ident" id="6779760">err</span>&nbsp;<span class="op" id="6779764">:=</span>&nbsp;<span class="ident" id="6779767">ln</span><span class="op" id="6779769">.</span><span class="ident" id="6779770">Accept</span><span class="op" id="6779776">(</span><span class="op" id="6779777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6779782">if</span>&nbsp;<span class="ident" id="6779785">err</span>&nbsp;<span class="op" id="6779789">!=</span>&nbsp;<span class="builtintype" id="6779792">nil</span>&nbsp;<span class="op" id="6779796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6779802">b</span><span class="op" id="6779803">.</span><span class="ident" id="6779804">Errorf</span><span class="op" id="6779810">(</span><span class="string" id="6779811">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6779830">,</span>&nbsp;<span class="ident" id="6779832">err</span><span class="op" id="6779835">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6779841">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6779851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6779856">servers</span><span class="op" id="6779863">[</span><span class="ident" id="6779864">p</span><span class="op" id="6779865">]</span>&nbsp;<span class="op" id="6779867">=</span>&nbsp;<span class="ident" id="6779869">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6779873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6779877">done</span>&nbsp;<span class="op" id="6779882">&lt;-</span>&nbsp;<span class="builtintype" id="6779885">true</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6779891">}</span><span class="op" id="6779892">(</span><span class="op" id="6779893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6779896">for</span>&nbsp;<span class="ident" id="6779900">p</span>&nbsp;<span class="op" id="6779902">:=</span>&nbsp;<span class="num" id="6779905">0</span><span class="op" id="6779906">;</span>&nbsp;<span class="ident" id="6779908">p</span>&nbsp;<span class="op" id="6779910">&lt;</span>&nbsp;<span class="ident" id="6779912">P</span><span class="op" id="6779913">;</span>&nbsp;<span class="ident" id="6779915">p</span><span class="op" id="6779916">++</span>&nbsp;<span class="op" id="6779919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6779923">c</span><span class="op" id="6779924">,</span>&nbsp;<span class="ident" id="6779926">err</span>&nbsp;<span class="op" id="6779930">:=</span>&nbsp;<span class="ident" id="6779933">Dial</span><span class="op" id="6779937">(</span><span class="string" id="6779938">&#34;tcp&#34;</span><span class="op" id="6779943">,</span>&nbsp;<span class="ident" id="6779945">ln</span><span class="op" id="6779947">.</span><span class="ident" id="6779948">Addr</span><span class="op" id="6779952">(</span><span class="op" id="6779953">)</span><span class="op" id="6779954">.</span><span class="ident" id="6779955">String</span><span class="op" id="6779961">(</span><span class="op" id="6779962">)</span><span class="op" id="6779963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6779967">if</span>&nbsp;<span class="ident" id="6779970">err</span>&nbsp;<span class="op" id="6779974">!=</span>&nbsp;<span class="builtintype" id="6779977">nil</span>&nbsp;<span class="op" id="6779981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6779986">b</span><span class="op" id="6779987">.</span><span class="ident" id="6779988">Fatalf</span><span class="op" id="6779994">(</span><span class="string" id="6779995">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6780012">,</span>&nbsp;<span class="ident" id="6780014">err</span><span class="op" id="6780017">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6780021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6780025">clients</span><span class="op" id="6780032">[</span><span class="ident" id="6780033">p</span><span class="op" id="6780034">]</span>&nbsp;<span class="op" id="6780036">=</span>&nbsp;<span class="ident" id="6780038">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6780041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6780044">&lt;-</span><span class="ident" id="6780046">done</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6780053">b</span><span class="op" id="6780054">.</span><span class="ident" id="6780055">StartTimer</span><span class="op" id="6780065">(</span><span class="op" id="6780066">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6780070">var</span>&nbsp;<span class="ident" id="6780074">wg</span>&nbsp;<span class="ident" id="6780077">sync</span><span class="op" id="6780081">.</span><span class="ident" id="6780082">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6780093">wg</span><span class="op" id="6780095">.</span><span class="ident" id="6780096">Add</span><span class="op" id="6780099">(</span><span class="num" id="6780100">4</span>&nbsp;<span class="op" id="6780102">*</span>&nbsp;<span class="ident" id="6780104">P</span><span class="op" id="6780105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6780108">for</span>&nbsp;<span class="ident" id="6780112">p</span>&nbsp;<span class="op" id="6780114">:=</span>&nbsp;<span class="num" id="6780117">0</span><span class="op" id="6780118">;</span>&nbsp;<span class="ident" id="6780120">p</span>&nbsp;<span class="op" id="6780122">&lt;</span>&nbsp;<span class="ident" id="6780124">P</span><span class="op" id="6780125">;</span>&nbsp;<span class="ident" id="6780127">p</span><span class="op" id="6780128">++</span>&nbsp;<span class="op" id="6780131">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6780135">//&nbsp;Client&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6780155">go</span>&nbsp;<span class="keyword" id="6780158">func</span><span class="op" id="6780162">(</span><span class="ident" id="6780163">c</span>&nbsp;<span class="ident" id="6780165">Conn</span><span class="op" id="6780169">)</span>&nbsp;<span class="op" id="6780171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6780176">defer</span>&nbsp;<span class="ident" id="6780182">wg</span><span class="op" id="6780184">.</span><span class="ident" id="6780185">Done</span><span class="op" id="6780189">(</span><span class="op" id="6780190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6780195">var</span>&nbsp;<span class="ident" id="6780199">buf</span>&nbsp;<span class="op" id="6780203">[</span><span class="num" id="6780204">1</span><span class="op" id="6780205">]</span><span class="builtintype" id="6780206">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6780214">for</span>&nbsp;<span class="ident" id="6780218">i</span>&nbsp;<span class="op" id="6780220">:=</span>&nbsp;<span class="num" id="6780223">0</span><span class="op" id="6780224">;</span>&nbsp;<span class="ident" id="6780226">i</span>&nbsp;<span class="op" id="6780228">&lt;</span>&nbsp;<span class="ident" id="6780230">N</span><span class="op" id="6780231">;</span>&nbsp;<span class="ident" id="6780233">i</span><span class="op" id="6780234">++</span>&nbsp;<span class="op" id="6780237">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6780243">v</span>&nbsp;<span class="op" id="6780245">:=</span>&nbsp;<span class="builtintype" id="6780248">byte</span><span class="op" id="6780252">(</span><span class="ident" id="6780253">i</span><span class="op" id="6780254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6780260">for</span>&nbsp;<span class="ident" id="6780264">w</span>&nbsp;<span class="op" id="6780266">:=</span>&nbsp;<span class="num" id="6780269">0</span><span class="op" id="6780270">;</span>&nbsp;<span class="ident" id="6780272">w</span>&nbsp;<span class="op" id="6780274">&lt;</span>&nbsp;<span class="ident" id="6780276">W</span><span class="op" id="6780277">;</span>&nbsp;<span class="ident" id="6780279">w</span><span class="op" id="6780280">++</span>&nbsp;<span class="op" id="6780283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6780290">v</span>&nbsp;<span class="op" id="6780292">*=</span>&nbsp;<span class="ident" id="6780295">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6780301">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6780307">buf</span><span class="op" id="6780310">[</span><span class="num" id="6780311">0</span><span class="op" id="6780312">]</span>&nbsp;<span class="op" id="6780314">=</span>&nbsp;<span class="ident" id="6780316">v</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6780322">_</span><span class="op" id="6780323">,</span>&nbsp;<span class="ident" id="6780325">err</span>&nbsp;<span class="op" id="6780329">:=</span>&nbsp;<span class="ident" id="6780332">c</span><span class="op" id="6780333">.</span><span class="ident" id="6780334">Write</span><span class="op" id="6780339">(</span><span class="ident" id="6780340">buf</span><span class="op" id="6780343">[</span><span class="op" id="6780344">:</span><span class="op" id="6780345">]</span><span class="op" id="6780346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6780352">if</span>&nbsp;<span class="ident" id="6780355">err</span>&nbsp;<span class="op" id="6780359">!=</span>&nbsp;<span class="builtintype" id="6780362">nil</span>&nbsp;<span class="op" id="6780366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6780373">b</span><span class="op" id="6780374">.</span><span class="ident" id="6780375">Errorf</span><span class="op" id="6780381">(</span><span class="string" id="6780382">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6780400">,</span>&nbsp;<span class="ident" id="6780402">err</span><span class="op" id="6780405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6780412">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6780423">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6780428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6780432">}</span><span class="op" id="6780433">(</span><span class="ident" id="6780434">clients</span><span class="op" id="6780441">[</span><span class="ident" id="6780442">p</span><span class="op" id="6780443">]</span><span class="op" id="6780444">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6780449">//&nbsp;Pipe&nbsp;between&nbsp;server&nbsp;reader&nbsp;and&nbsp;server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6780500">pipe</span>&nbsp;<span class="op" id="6780505">:=</span>&nbsp;<span class="builtinfunc" id="6780508">make</span><span class="op" id="6780512">(</span><span class="keyword" id="6780513">chan</span>&nbsp;<span class="builtintype" id="6780518">byte</span><span class="op" id="6780522">,</span>&nbsp;<span class="num" id="6780524">128</span><span class="op" id="6780527">)</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6780532">//&nbsp;Server&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6780552">go</span>&nbsp;<span class="keyword" id="6780555">func</span><span class="op" id="6780559">(</span><span class="ident" id="6780560">s</span>&nbsp;<span class="ident" id="6780562">Conn</span><span class="op" id="6780566">)</span>&nbsp;<span class="op" id="6780568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6780573">defer</span>&nbsp;<span class="ident" id="6780579">wg</span><span class="op" id="6780581">.</span><span class="ident" id="6780582">Done</span><span class="op" id="6780586">(</span><span class="op" id="6780587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6780592">var</span>&nbsp;<span class="ident" id="6780596">buf</span>&nbsp;<span class="op" id="6780600">[</span><span class="num" id="6780601">1</span><span class="op" id="6780602">]</span><span class="builtintype" id="6780603">byte</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6780611">for</span>&nbsp;<span class="ident" id="6780615">i</span>&nbsp;<span class="op" id="6780617">:=</span>&nbsp;<span class="num" id="6780620">0</span><span class="op" id="6780621">;</span>&nbsp;<span class="ident" id="6780623">i</span>&nbsp;<span class="op" id="6780625">&lt;</span>&nbsp;<span class="ident" id="6780627">N</span><span class="op" id="6780628">;</span>&nbsp;<span class="ident" id="6780630">i</span><span class="op" id="6780631">++</span>&nbsp;<span class="op" id="6780634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6780640">_</span><span class="op" id="6780641">,</span>&nbsp;<span class="ident" id="6780643">err</span>&nbsp;<span class="op" id="6780647">:=</span>&nbsp;<span class="ident" id="6780650">s</span><span class="op" id="6780651">.</span><span class="ident" id="6780652">Read</span><span class="op" id="6780656">(</span><span class="ident" id="6780657">buf</span><span class="op" id="6780660">[</span><span class="op" id="6780661">:</span><span class="op" id="6780662">]</span><span class="op" id="6780663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6780669">if</span>&nbsp;<span class="ident" id="6780672">err</span>&nbsp;<span class="op" id="6780676">!=</span>&nbsp;<span class="builtintype" id="6780679">nil</span>&nbsp;<span class="op" id="6780683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6780690">b</span><span class="op" id="6780691">.</span><span class="ident" id="6780692">Errorf</span><span class="op" id="6780698">(</span><span class="string" id="6780699">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6780716">,</span>&nbsp;<span class="ident" id="6780718">err</span><span class="op" id="6780721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6780728">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6780739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6780745">pipe</span>&nbsp;<span class="op" id="6780750">&lt;-</span>&nbsp;<span class="ident" id="6780753">buf</span><span class="op" id="6780756">[</span><span class="num" id="6780757">0</span><span class="op" id="6780758">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6780763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6780767">}</span><span class="op" id="6780768">(</span><span class="ident" id="6780769">servers</span><span class="op" id="6780776">[</span><span class="ident" id="6780777">p</span><span class="op" id="6780778">]</span><span class="op" id="6780779">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6780784">//&nbsp;Server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6780804">go</span>&nbsp;<span class="keyword" id="6780807">func</span><span class="op" id="6780811">(</span><span class="ident" id="6780812">s</span>&nbsp;<span class="ident" id="6780814">Conn</span><span class="op" id="6780818">)</span>&nbsp;<span class="op" id="6780820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6780825">defer</span>&nbsp;<span class="ident" id="6780831">wg</span><span class="op" id="6780833">.</span><span class="ident" id="6780834">Done</span><span class="op" id="6780838">(</span><span class="op" id="6780839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6780844">var</span>&nbsp;<span class="ident" id="6780848">buf</span>&nbsp;<span class="op" id="6780852">[</span><span class="num" id="6780853">1</span><span class="op" id="6780854">]</span><span class="builtintype" id="6780855">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6780863">for</span>&nbsp;<span class="ident" id="6780867">i</span>&nbsp;<span class="op" id="6780869">:=</span>&nbsp;<span class="num" id="6780872">0</span><span class="op" id="6780873">;</span>&nbsp;<span class="ident" id="6780875">i</span>&nbsp;<span class="op" id="6780877">&lt;</span>&nbsp;<span class="ident" id="6780879">N</span><span class="op" id="6780880">;</span>&nbsp;<span class="ident" id="6780882">i</span><span class="op" id="6780883">++</span>&nbsp;<span class="op" id="6780886">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6780892">v</span>&nbsp;<span class="op" id="6780894">:=</span>&nbsp;<span class="op" id="6780897">&lt;-</span><span class="ident" id="6780899">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6780908">for</span>&nbsp;<span class="ident" id="6780912">w</span>&nbsp;<span class="op" id="6780914">:=</span>&nbsp;<span class="num" id="6780917">0</span><span class="op" id="6780918">;</span>&nbsp;<span class="ident" id="6780920">w</span>&nbsp;<span class="op" id="6780922">&lt;</span>&nbsp;<span class="ident" id="6780924">W</span><span class="op" id="6780925">;</span>&nbsp;<span class="ident" id="6780927">w</span><span class="op" id="6780928">++</span>&nbsp;<span class="op" id="6780931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6780938">v</span>&nbsp;<span class="op" id="6780940">*=</span>&nbsp;<span class="ident" id="6780943">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6780949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6780955">buf</span><span class="op" id="6780958">[</span><span class="num" id="6780959">0</span><span class="op" id="6780960">]</span>&nbsp;<span class="op" id="6780962">=</span>&nbsp;<span class="ident" id="6780964">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6780970">_</span><span class="op" id="6780971">,</span>&nbsp;<span class="ident" id="6780973">err</span>&nbsp;<span class="op" id="6780977">:=</span>&nbsp;<span class="ident" id="6780980">s</span><span class="op" id="6780981">.</span><span class="ident" id="6780982">Write</span><span class="op" id="6780987">(</span><span class="ident" id="6780988">buf</span><span class="op" id="6780991">[</span><span class="op" id="6780992">:</span><span class="op" id="6780993">]</span><span class="op" id="6780994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6781000">if</span>&nbsp;<span class="ident" id="6781003">err</span>&nbsp;<span class="op" id="6781007">!=</span>&nbsp;<span class="builtintype" id="6781010">nil</span>&nbsp;<span class="op" id="6781014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6781021">b</span><span class="op" id="6781022">.</span><span class="ident" id="6781023">Errorf</span><span class="op" id="6781029">(</span><span class="string" id="6781030">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6781048">,</span>&nbsp;<span class="ident" id="6781050">err</span><span class="op" id="6781053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6781060">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6781071">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6781076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6781081">s</span><span class="op" id="6781082">.</span><span class="ident" id="6781083">Close</span><span class="op" id="6781088">(</span><span class="op" id="6781089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6781093">}</span><span class="op" id="6781094">(</span><span class="ident" id="6781095">servers</span><span class="op" id="6781102">[</span><span class="ident" id="6781103">p</span><span class="op" id="6781104">]</span><span class="op" id="6781105">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6781110">//&nbsp;Client&nbsp;reader.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6781130">go</span>&nbsp;<span class="keyword" id="6781133">func</span><span class="op" id="6781137">(</span><span class="ident" id="6781138">c</span>&nbsp;<span class="ident" id="6781140">Conn</span><span class="op" id="6781144">)</span>&nbsp;<span class="op" id="6781146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6781151">defer</span>&nbsp;<span class="ident" id="6781157">wg</span><span class="op" id="6781159">.</span><span class="ident" id="6781160">Done</span><span class="op" id="6781164">(</span><span class="op" id="6781165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6781170">var</span>&nbsp;<span class="ident" id="6781174">buf</span>&nbsp;<span class="op" id="6781178">[</span><span class="num" id="6781179">1</span><span class="op" id="6781180">]</span><span class="builtintype" id="6781181">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6781189">for</span>&nbsp;<span class="ident" id="6781193">i</span>&nbsp;<span class="op" id="6781195">:=</span>&nbsp;<span class="num" id="6781198">0</span><span class="op" id="6781199">;</span>&nbsp;<span class="ident" id="6781201">i</span>&nbsp;<span class="op" id="6781203">&lt;</span>&nbsp;<span class="ident" id="6781205">N</span><span class="op" id="6781206">;</span>&nbsp;<span class="ident" id="6781208">i</span><span class="op" id="6781209">++</span>&nbsp;<span class="op" id="6781212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6781218">_</span><span class="op" id="6781219">,</span>&nbsp;<span class="ident" id="6781221">err</span>&nbsp;<span class="op" id="6781225">:=</span>&nbsp;<span class="ident" id="6781228">c</span><span class="op" id="6781229">.</span><span class="ident" id="6781230">Read</span><span class="op" id="6781234">(</span><span class="ident" id="6781235">buf</span><span class="op" id="6781238">[</span><span class="op" id="6781239">:</span><span class="op" id="6781240">]</span><span class="op" id="6781241">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6781247">if</span>&nbsp;<span class="ident" id="6781250">err</span>&nbsp;<span class="op" id="6781254">!=</span>&nbsp;<span class="builtintype" id="6781257">nil</span>&nbsp;<span class="op" id="6781261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6781268">b</span><span class="op" id="6781269">.</span><span class="ident" id="6781270">Errorf</span><span class="op" id="6781276">(</span><span class="string" id="6781277">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6781294">,</span>&nbsp;<span class="ident" id="6781296">err</span><span class="op" id="6781299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6781306">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6781317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6781322">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6781327">c</span><span class="op" id="6781328">.</span><span class="ident" id="6781329">Close</span><span class="op" id="6781334">(</span><span class="op" id="6781335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6781339">}</span><span class="op" id="6781340">(</span><span class="ident" id="6781341">clients</span><span class="op" id="6781348">[</span><span class="ident" id="6781349">p</span><span class="op" id="6781350">]</span><span class="op" id="6781351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6781354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6781357">wg</span><span class="op" id="6781359">.</span><span class="ident" id="6781360">Wait</span><span class="op" id="6781364">(</span><span class="op" id="6781365">)</span><br>
<span class="lineno"></span><span class="op" id="6781367">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="6781370">type</span>&nbsp;<span class="ident" id="6781375">resolveTCPAddrTest</span>&nbsp;<span class="keyword" id="6781394">struct</span>&nbsp;<span class="op" id="6781401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6781404">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6781418">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6781426">litAddrOrName</span>&nbsp;<span class="builtintype" id="6781440">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6781448">addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6781462">*</span><span class="ident" id="6781463">TCPAddr</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6781472">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6781486">error</span><br>
<span class="lineno"></span><span class="op" id="6781492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6781495">var</span>&nbsp;<span class="ident" id="6781499">resolveTCPAddrTests</span>&nbsp;<span class="op" id="6781519">=</span>&nbsp;<span class="op" id="6781521">[</span><span class="op" id="6781522">]</span><span class="ident" id="6781523">resolveTCPAddrTest</span><span class="op" id="6781541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6781544">{</span><span class="string" id="6781545">&#34;tcp&#34;</span><span class="op" id="6781550">,</span>&nbsp;<span class="string" id="6781552">&#34;127.0.0.1:0&#34;</span><span class="op" id="6781565">,</span>&nbsp;<span class="op" id="6781567">&amp;</span><span class="ident" id="6781568">TCPAddr</span><span class="op" id="6781575">{</span><span class="ident" id="6781576">IP</span><span class="op" id="6781578">:</span>&nbsp;<span class="ident" id="6781580">IPv4</span><span class="op" id="6781584">(</span><span class="num" id="6781585">127</span><span class="op" id="6781588">,</span>&nbsp;<span class="num" id="6781590">0</span><span class="op" id="6781591">,</span>&nbsp;<span class="num" id="6781593">0</span><span class="op" id="6781594">,</span>&nbsp;<span class="num" id="6781596">1</span><span class="op" id="6781597">)</span><span class="op" id="6781598">,</span>&nbsp;<span class="ident" id="6781600">Port</span><span class="op" id="6781604">:</span>&nbsp;<span class="num" id="6781606">0</span><span class="op" id="6781607">}</span><span class="op" id="6781608">,</span>&nbsp;<span class="builtintype" id="6781610">nil</span><span class="op" id="6781613">}</span><span class="op" id="6781614">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6781617">{</span><span class="string" id="6781618">&#34;tcp4&#34;</span><span class="op" id="6781624">,</span>&nbsp;<span class="string" id="6781626">&#34;127.0.0.1:65535&#34;</span><span class="op" id="6781643">,</span>&nbsp;<span class="op" id="6781645">&amp;</span><span class="ident" id="6781646">TCPAddr</span><span class="op" id="6781653">{</span><span class="ident" id="6781654">IP</span><span class="op" id="6781656">:</span>&nbsp;<span class="ident" id="6781658">IPv4</span><span class="op" id="6781662">(</span><span class="num" id="6781663">127</span><span class="op" id="6781666">,</span>&nbsp;<span class="num" id="6781668">0</span><span class="op" id="6781669">,</span>&nbsp;<span class="num" id="6781671">0</span><span class="op" id="6781672">,</span>&nbsp;<span class="num" id="6781674">1</span><span class="op" id="6781675">)</span><span class="op" id="6781676">,</span>&nbsp;<span class="ident" id="6781678">Port</span><span class="op" id="6781682">:</span>&nbsp;<span class="num" id="6781684">65535</span><span class="op" id="6781689">}</span><span class="op" id="6781690">,</span>&nbsp;<span class="builtintype" id="6781692">nil</span><span class="op" id="6781695">}</span><span class="op" id="6781696">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6781700">{</span><span class="string" id="6781701">&#34;tcp&#34;</span><span class="op" id="6781706">,</span>&nbsp;<span class="string" id="6781708">&#34;[::1]:1&#34;</span><span class="op" id="6781717">,</span>&nbsp;<span class="op" id="6781719">&amp;</span><span class="ident" id="6781720">TCPAddr</span><span class="op" id="6781727">{</span><span class="ident" id="6781728">IP</span><span class="op" id="6781730">:</span>&nbsp;<span class="ident" id="6781732">ParseIP</span><span class="op" id="6781739">(</span><span class="string" id="6781740">&#34;::1&#34;</span><span class="op" id="6781745">)</span><span class="op" id="6781746">,</span>&nbsp;<span class="ident" id="6781748">Port</span><span class="op" id="6781752">:</span>&nbsp;<span class="num" id="6781754">1</span><span class="op" id="6781755">}</span><span class="op" id="6781756">,</span>&nbsp;<span class="builtintype" id="6781758">nil</span><span class="op" id="6781761">}</span><span class="op" id="6781762">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6781765">{</span><span class="string" id="6781766">&#34;tcp6&#34;</span><span class="op" id="6781772">,</span>&nbsp;<span class="string" id="6781774">&#34;[::1]:65534&#34;</span><span class="op" id="6781787">,</span>&nbsp;<span class="op" id="6781789">&amp;</span><span class="ident" id="6781790">TCPAddr</span><span class="op" id="6781797">{</span><span class="ident" id="6781798">IP</span><span class="op" id="6781800">:</span>&nbsp;<span class="ident" id="6781802">ParseIP</span><span class="op" id="6781809">(</span><span class="string" id="6781810">&#34;::1&#34;</span><span class="op" id="6781815">)</span><span class="op" id="6781816">,</span>&nbsp;<span class="ident" id="6781818">Port</span><span class="op" id="6781822">:</span>&nbsp;<span class="num" id="6781824">65534</span><span class="op" id="6781829">}</span><span class="op" id="6781830">,</span>&nbsp;<span class="builtintype" id="6781832">nil</span><span class="op" id="6781835">}</span><span class="op" id="6781836">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6781840">{</span><span class="string" id="6781841">&#34;tcp&#34;</span><span class="op" id="6781846">,</span>&nbsp;<span class="string" id="6781848">&#34;[::1%en0]:1&#34;</span><span class="op" id="6781861">,</span>&nbsp;<span class="op" id="6781863">&amp;</span><span class="ident" id="6781864">TCPAddr</span><span class="op" id="6781871">{</span><span class="ident" id="6781872">IP</span><span class="op" id="6781874">:</span>&nbsp;<span class="ident" id="6781876">ParseIP</span><span class="op" id="6781883">(</span><span class="string" id="6781884">&#34;::1&#34;</span><span class="op" id="6781889">)</span><span class="op" id="6781890">,</span>&nbsp;<span class="ident" id="6781892">Port</span><span class="op" id="6781896">:</span>&nbsp;<span class="num" id="6781898">1</span><span class="op" id="6781899">,</span>&nbsp;<span class="ident" id="6781901">Zone</span><span class="op" id="6781905">:</span>&nbsp;<span class="string" id="6781907">&#34;en0&#34;</span><span class="op" id="6781912">}</span><span class="op" id="6781913">,</span>&nbsp;<span class="builtintype" id="6781915">nil</span><span class="op" id="6781918">}</span><span class="op" id="6781919">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6781922">{</span><span class="string" id="6781923">&#34;tcp6&#34;</span><span class="op" id="6781929">,</span>&nbsp;<span class="string" id="6781931">&#34;[::1%911]:2&#34;</span><span class="op" id="6781944">,</span>&nbsp;<span class="op" id="6781946">&amp;</span><span class="ident" id="6781947">TCPAddr</span><span class="op" id="6781954">{</span><span class="ident" id="6781955">IP</span><span class="op" id="6781957">:</span>&nbsp;<span class="ident" id="6781959">ParseIP</span><span class="op" id="6781966">(</span><span class="string" id="6781967">&#34;::1&#34;</span><span class="op" id="6781972">)</span><span class="op" id="6781973">,</span>&nbsp;<span class="ident" id="6781975">Port</span><span class="op" id="6781979">:</span>&nbsp;<span class="num" id="6781981">2</span><span class="op" id="6781982">,</span>&nbsp;<span class="ident" id="6781984">Zone</span><span class="op" id="6781988">:</span>&nbsp;<span class="string" id="6781990">&#34;911&#34;</span><span class="op" id="6781995">}</span><span class="op" id="6781996">,</span>&nbsp;<span class="builtintype" id="6781998">nil</span><span class="op" id="6782001">}</span><span class="op" id="6782002">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6782006">{</span><span class="string" id="6782007">&#34;&#34;</span><span class="op" id="6782009">,</span>&nbsp;<span class="string" id="6782011">&#34;127.0.0.1:0&#34;</span><span class="op" id="6782024">,</span>&nbsp;<span class="op" id="6782026">&amp;</span><span class="ident" id="6782027">TCPAddr</span><span class="op" id="6782034">{</span><span class="ident" id="6782035">IP</span><span class="op" id="6782037">:</span>&nbsp;<span class="ident" id="6782039">IPv4</span><span class="op" id="6782043">(</span><span class="num" id="6782044">127</span><span class="op" id="6782047">,</span>&nbsp;<span class="num" id="6782049">0</span><span class="op" id="6782050">,</span>&nbsp;<span class="num" id="6782052">0</span><span class="op" id="6782053">,</span>&nbsp;<span class="num" id="6782055">1</span><span class="op" id="6782056">)</span><span class="op" id="6782057">,</span>&nbsp;<span class="ident" id="6782059">Port</span><span class="op" id="6782063">:</span>&nbsp;<span class="num" id="6782065">0</span><span class="op" id="6782066">}</span><span class="op" id="6782067">,</span>&nbsp;<span class="builtintype" id="6782069">nil</span><span class="op" id="6782072">}</span><span class="op" id="6782073">,</span>&nbsp;<span class="comment" id="6782075">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6782095">{</span><span class="string" id="6782096">&#34;&#34;</span><span class="op" id="6782098">,</span>&nbsp;<span class="string" id="6782100">&#34;[::1]:0&#34;</span><span class="op" id="6782109">,</span>&nbsp;<span class="op" id="6782111">&amp;</span><span class="ident" id="6782112">TCPAddr</span><span class="op" id="6782119">{</span><span class="ident" id="6782120">IP</span><span class="op" id="6782122">:</span>&nbsp;<span class="ident" id="6782124">ParseIP</span><span class="op" id="6782131">(</span><span class="string" id="6782132">&#34;::1&#34;</span><span class="op" id="6782137">)</span><span class="op" id="6782138">,</span>&nbsp;<span class="ident" id="6782140">Port</span><span class="op" id="6782144">:</span>&nbsp;<span class="num" id="6782146">0</span><span class="op" id="6782147">}</span><span class="op" id="6782148">,</span>&nbsp;<span class="builtintype" id="6782150">nil</span><span class="op" id="6782153">}</span><span class="op" id="6782154">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6782164">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6782185">{</span><span class="string" id="6782186">&#34;tcp&#34;</span><span class="op" id="6782191">,</span>&nbsp;<span class="string" id="6782193">&#34;:12345&#34;</span><span class="op" id="6782201">,</span>&nbsp;<span class="op" id="6782203">&amp;</span><span class="ident" id="6782204">TCPAddr</span><span class="op" id="6782211">{</span><span class="ident" id="6782212">Port</span><span class="op" id="6782216">:</span>&nbsp;<span class="num" id="6782218">12345</span><span class="op" id="6782223">}</span><span class="op" id="6782224">,</span>&nbsp;<span class="builtintype" id="6782226">nil</span><span class="op" id="6782229">}</span><span class="op" id="6782230">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6782234">{</span><span class="string" id="6782235">&#34;http&#34;</span><span class="op" id="6782241">,</span>&nbsp;<span class="string" id="6782243">&#34;127.0.0.1:0&#34;</span><span class="op" id="6782256">,</span>&nbsp;<span class="builtintype" id="6782258">nil</span><span class="op" id="6782261">,</span>&nbsp;<span class="ident" id="6782263">UnknownNetworkError</span><span class="op" id="6782282">(</span><span class="string" id="6782283">&#34;http&#34;</span><span class="op" id="6782289">)</span><span class="op" id="6782290">}</span><span class="op" id="6782291">,</span><br>
<span class="lineno"></span><span class="op" id="6782293">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span><span class="keyword" id="6782296">func</span>&nbsp;<span class="ident" id="6782301">init</span><span class="op" id="6782305">(</span><span class="op" id="6782306">)</span>&nbsp;<span class="op" id="6782308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6782311">if</span>&nbsp;<span class="ident" id="6782314">ifi</span>&nbsp;<span class="op" id="6782318">:=</span>&nbsp;<span class="ident" id="6782321">loopbackInterface</span><span class="op" id="6782338">(</span><span class="op" id="6782339">)</span><span class="op" id="6782340">;</span>&nbsp;<span class="ident" id="6782342">ifi</span>&nbsp;<span class="op" id="6782346">!=</span>&nbsp;<span class="builtintype" id="6782349">nil</span>&nbsp;<span class="op" id="6782353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6782357">index</span>&nbsp;<span class="op" id="6782363">:=</span>&nbsp;<span class="ident" id="6782366">fmt</span><span class="op" id="6782369">.</span><span class="ident" id="6782370">Sprintf</span><span class="op" id="6782377">(</span><span class="string" id="6782378">&#34;%v&#34;</span><span class="op" id="6782382">,</span>&nbsp;<span class="ident" id="6782384">ifi</span><span class="op" id="6782387">.</span><span class="ident" id="6782388">Index</span><span class="op" id="6782393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6782397">resolveTCPAddrTests</span>&nbsp;<span class="op" id="6782417">=</span>&nbsp;<span class="builtinfunc" id="6782419">append</span><span class="op" id="6782425">(</span><span class="ident" id="6782426">resolveTCPAddrTests</span><span class="op" id="6782445">,</span>&nbsp;<span class="op" id="6782447">[</span><span class="op" id="6782448">]</span><span class="ident" id="6782449">resolveTCPAddrTest</span><span class="op" id="6782467">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6782472">{</span><span class="string" id="6782473">&#34;tcp6&#34;</span><span class="op" id="6782479">,</span>&nbsp;<span class="string" id="6782481">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="6782493">+</span>&nbsp;<span class="ident" id="6782495">ifi</span><span class="op" id="6782498">.</span><span class="ident" id="6782499">Name</span>&nbsp;<span class="op" id="6782504">+</span>&nbsp;<span class="string" id="6782506">&#34;]:3&#34;</span><span class="op" id="6782511">,</span>&nbsp;<span class="op" id="6782513">&amp;</span><span class="ident" id="6782514">TCPAddr</span><span class="op" id="6782521">{</span><span class="ident" id="6782522">IP</span><span class="op" id="6782524">:</span>&nbsp;<span class="ident" id="6782526">ParseIP</span><span class="op" id="6782533">(</span><span class="string" id="6782534">&#34;fe80::1&#34;</span><span class="op" id="6782543">)</span><span class="op" id="6782544">,</span>&nbsp;<span class="ident" id="6782546">Port</span><span class="op" id="6782550">:</span>&nbsp;<span class="num" id="6782552">3</span><span class="op" id="6782553">,</span>&nbsp;<span class="ident" id="6782555">Zone</span><span class="op" id="6782559">:</span>&nbsp;<span class="ident" id="6782561">zoneToString</span><span class="op" id="6782573">(</span><span class="ident" id="6782574">ifi</span><span class="op" id="6782577">.</span><span class="ident" id="6782578">Index</span><span class="op" id="6782583">)</span><span class="op" id="6782584">}</span><span class="op" id="6782585">,</span>&nbsp;<span class="builtintype" id="6782587">nil</span><span class="op" id="6782590">}</span><span class="op" id="6782591">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6782596">{</span><span class="string" id="6782597">&#34;tcp6&#34;</span><span class="op" id="6782603">,</span>&nbsp;<span class="string" id="6782605">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="6782617">+</span>&nbsp;<span class="ident" id="6782619">index</span>&nbsp;<span class="op" id="6782625">+</span>&nbsp;<span class="string" id="6782627">&#34;]:4&#34;</span><span class="op" id="6782632">,</span>&nbsp;<span class="op" id="6782634">&amp;</span><span class="ident" id="6782635">TCPAddr</span><span class="op" id="6782642">{</span><span class="ident" id="6782643">IP</span><span class="op" id="6782645">:</span>&nbsp;<span class="ident" id="6782647">ParseIP</span><span class="op" id="6782654">(</span><span class="string" id="6782655">&#34;fe80::1&#34;</span><span class="op" id="6782664">)</span><span class="op" id="6782665">,</span>&nbsp;<span class="ident" id="6782667">Port</span><span class="op" id="6782671">:</span>&nbsp;<span class="num" id="6782673">4</span><span class="op" id="6782674">,</span>&nbsp;<span class="ident" id="6782676">Zone</span><span class="op" id="6782680">:</span>&nbsp;<span class="ident" id="6782682">index</span><span class="op" id="6782687">}</span><span class="op" id="6782688">,</span>&nbsp;<span class="builtintype" id="6782690">nil</span><span class="op" id="6782693">}</span><span class="op" id="6782694">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6782698">}</span><span class="op" id="6782699">...</span><span class="op" id="6782702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6782705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6782708">if</span>&nbsp;<span class="ident" id="6782711">ips</span><span class="op" id="6782714">,</span>&nbsp;<span class="ident" id="6782716">err</span>&nbsp;<span class="op" id="6782720">:=</span>&nbsp;<span class="ident" id="6782723">LookupIP</span><span class="op" id="6782731">(</span><span class="string" id="6782732">&#34;localhost&#34;</span><span class="op" id="6782743">)</span><span class="op" id="6782744">;</span>&nbsp;<span class="ident" id="6782746">err</span>&nbsp;<span class="op" id="6782750">==</span>&nbsp;<span class="builtintype" id="6782753">nil</span>&nbsp;<span class="op" id="6782757">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6782760">len</span><span class="op" id="6782763">(</span><span class="ident" id="6782764">ips</span><span class="op" id="6782767">)</span>&nbsp;<span class="op" id="6782769">&gt;</span>&nbsp;<span class="num" id="6782771">1</span>&nbsp;<span class="op" id="6782773">&amp;&amp;</span>&nbsp;<span class="ident" id="6782776">supportsIPv4</span>&nbsp;<span class="op" id="6782789">&amp;&amp;</span>&nbsp;<span class="ident" id="6782792">supportsIPv6</span>&nbsp;<span class="op" id="6782805">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6782809">resolveTCPAddrTests</span>&nbsp;<span class="op" id="6782829">=</span>&nbsp;<span class="builtinfunc" id="6782831">append</span><span class="op" id="6782837">(</span><span class="ident" id="6782838">resolveTCPAddrTests</span><span class="op" id="6782857">,</span>&nbsp;<span class="op" id="6782859">[</span><span class="op" id="6782860">]</span><span class="ident" id="6782861">resolveTCPAddrTest</span><span class="op" id="6782879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6782884">{</span><span class="string" id="6782885">&#34;tcp&#34;</span><span class="op" id="6782890">,</span>&nbsp;<span class="string" id="6782892">&#34;localhost:5&#34;</span><span class="op" id="6782905">,</span>&nbsp;<span class="op" id="6782907">&amp;</span><span class="ident" id="6782908">TCPAddr</span><span class="op" id="6782915">{</span><span class="ident" id="6782916">IP</span><span class="op" id="6782918">:</span>&nbsp;<span class="ident" id="6782920">IPv4</span><span class="op" id="6782924">(</span><span class="num" id="6782925">127</span><span class="op" id="6782928">,</span>&nbsp;<span class="num" id="6782930">0</span><span class="op" id="6782931">,</span>&nbsp;<span class="num" id="6782933">0</span><span class="op" id="6782934">,</span>&nbsp;<span class="num" id="6782936">1</span><span class="op" id="6782937">)</span><span class="op" id="6782938">,</span>&nbsp;<span class="ident" id="6782940">Port</span><span class="op" id="6782944">:</span>&nbsp;<span class="num" id="6782946">5</span><span class="op" id="6782947">}</span><span class="op" id="6782948">,</span>&nbsp;<span class="builtintype" id="6782950">nil</span><span class="op" id="6782953">}</span><span class="op" id="6782954">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6782959">{</span><span class="string" id="6782960">&#34;tcp4&#34;</span><span class="op" id="6782966">,</span>&nbsp;<span class="string" id="6782968">&#34;localhost:6&#34;</span><span class="op" id="6782981">,</span>&nbsp;<span class="op" id="6782983">&amp;</span><span class="ident" id="6782984">TCPAddr</span><span class="op" id="6782991">{</span><span class="ident" id="6782992">IP</span><span class="op" id="6782994">:</span>&nbsp;<span class="ident" id="6782996">IPv4</span><span class="op" id="6783000">(</span><span class="num" id="6783001">127</span><span class="op" id="6783004">,</span>&nbsp;<span class="num" id="6783006">0</span><span class="op" id="6783007">,</span>&nbsp;<span class="num" id="6783009">0</span><span class="op" id="6783010">,</span>&nbsp;<span class="num" id="6783012">1</span><span class="op" id="6783013">)</span><span class="op" id="6783014">,</span>&nbsp;<span class="ident" id="6783016">Port</span><span class="op" id="6783020">:</span>&nbsp;<span class="num" id="6783022">6</span><span class="op" id="6783023">}</span><span class="op" id="6783024">,</span>&nbsp;<span class="builtintype" id="6783026">nil</span><span class="op" id="6783029">}</span><span class="op" id="6783030">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6783035">{</span><span class="string" id="6783036">&#34;tcp6&#34;</span><span class="op" id="6783042">,</span>&nbsp;<span class="string" id="6783044">&#34;localhost:7&#34;</span><span class="op" id="6783057">,</span>&nbsp;<span class="op" id="6783059">&amp;</span><span class="ident" id="6783060">TCPAddr</span><span class="op" id="6783067">{</span><span class="ident" id="6783068">IP</span><span class="op" id="6783070">:</span>&nbsp;<span class="ident" id="6783072">IPv6loopback</span><span class="op" id="6783084">,</span>&nbsp;<span class="ident" id="6783086">Port</span><span class="op" id="6783090">:</span>&nbsp;<span class="num" id="6783092">7</span><span class="op" id="6783093">}</span><span class="op" id="6783094">,</span>&nbsp;<span class="builtintype" id="6783096">nil</span><span class="op" id="6783099">}</span><span class="op" id="6783100">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6783104">}</span><span class="op" id="6783105">...</span><span class="op" id="6783108">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6783111">}</span><br>
<span class="lineno"></span><span class="op" id="6783113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6783116">func</span>&nbsp;<span class="ident" id="6783121">TestResolveTCPAddr</span><span class="op" id="6783139">(</span><span class="ident" id="6783140">t</span>&nbsp;<span class="op" id="6783142">*</span><span class="ident" id="6783143">testing</span><span class="op" id="6783150">.</span><span class="ident" id="6783151">T</span><span class="op" id="6783152">)</span>&nbsp;<span class="op" id="6783154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6783157">for</span>&nbsp;<span class="ident" id="6783161">_</span><span class="op" id="6783162">,</span>&nbsp;<span class="ident" id="6783164">tt</span>&nbsp;<span class="op" id="6783167">:=</span>&nbsp;<span class="keyword" id="6783170">range</span>&nbsp;<span class="ident" id="6783176">resolveTCPAddrTests</span>&nbsp;<span class="op" id="6783196">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6783200">addr</span><span class="op" id="6783204">,</span>&nbsp;<span class="ident" id="6783206">err</span>&nbsp;<span class="op" id="6783210">:=</span>&nbsp;<span class="ident" id="6783213">ResolveTCPAddr</span><span class="op" id="6783227">(</span><span class="ident" id="6783228">tt</span><span class="op" id="6783230">.</span><span class="ident" id="6783231">net</span><span class="op" id="6783234">,</span>&nbsp;<span class="ident" id="6783236">tt</span><span class="op" id="6783238">.</span><span class="ident" id="6783239">litAddrOrName</span><span class="op" id="6783252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6783256">if</span>&nbsp;<span class="ident" id="6783259">err</span>&nbsp;<span class="op" id="6783263">!=</span>&nbsp;<span class="ident" id="6783266">tt</span><span class="op" id="6783268">.</span><span class="ident" id="6783269">err</span>&nbsp;<span class="op" id="6783273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6783278">t</span><span class="op" id="6783279">.</span><span class="ident" id="6783280">Fatalf</span><span class="op" id="6783286">(</span><span class="string" id="6783287">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6783322">,</span>&nbsp;<span class="ident" id="6783324">tt</span><span class="op" id="6783326">.</span><span class="ident" id="6783327">net</span><span class="op" id="6783330">,</span>&nbsp;<span class="ident" id="6783332">tt</span><span class="op" id="6783334">.</span><span class="ident" id="6783335">litAddrOrName</span><span class="op" id="6783348">,</span>&nbsp;<span class="ident" id="6783350">err</span><span class="op" id="6783353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6783357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6783361">if</span>&nbsp;<span class="op" id="6783364">!</span><span class="ident" id="6783365">reflect</span><span class="op" id="6783372">.</span><span class="ident" id="6783373">DeepEqual</span><span class="op" id="6783382">(</span><span class="ident" id="6783383">addr</span><span class="op" id="6783387">,</span>&nbsp;<span class="ident" id="6783389">tt</span><span class="op" id="6783391">.</span><span class="ident" id="6783392">addr</span><span class="op" id="6783396">)</span>&nbsp;<span class="op" id="6783398">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6783403">t</span><span class="op" id="6783404">.</span><span class="ident" id="6783405">Fatalf</span><span class="op" id="6783411">(</span><span class="string" id="6783412">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="6783452">,</span>&nbsp;<span class="ident" id="6783454">tt</span><span class="op" id="6783456">.</span><span class="ident" id="6783457">net</span><span class="op" id="6783460">,</span>&nbsp;<span class="ident" id="6783462">tt</span><span class="op" id="6783464">.</span><span class="ident" id="6783465">litAddrOrName</span><span class="op" id="6783478">,</span>&nbsp;<span class="ident" id="6783480">addr</span><span class="op" id="6783484">,</span>&nbsp;<span class="ident" id="6783486">tt</span><span class="op" id="6783488">.</span><span class="ident" id="6783489">addr</span><span class="op" id="6783493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6783497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6783501">if</span>&nbsp;<span class="ident" id="6783504">err</span>&nbsp;<span class="op" id="6783508">==</span>&nbsp;<span class="builtintype" id="6783511">nil</span>&nbsp;<span class="op" id="6783515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6783520">str</span>&nbsp;<span class="op" id="6783524">:=</span>&nbsp;<span class="ident" id="6783527">addr</span><span class="op" id="6783531">.</span><span class="ident" id="6783532">String</span><span class="op" id="6783538">(</span><span class="op" id="6783539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6783544">addr1</span><span class="op" id="6783549">,</span>&nbsp;<span class="ident" id="6783551">err</span>&nbsp;<span class="op" id="6783555">:=</span>&nbsp;<span class="ident" id="6783558">ResolveTCPAddr</span><span class="op" id="6783572">(</span><span class="ident" id="6783573">tt</span><span class="op" id="6783575">.</span><span class="ident" id="6783576">net</span><span class="op" id="6783579">,</span>&nbsp;<span class="ident" id="6783581">str</span><span class="op" id="6783584">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6783589">if</span>&nbsp;<span class="ident" id="6783592">err</span>&nbsp;<span class="op" id="6783596">!=</span>&nbsp;<span class="builtintype" id="6783599">nil</span>&nbsp;<span class="op" id="6783603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6783609">t</span><span class="op" id="6783610">.</span><span class="ident" id="6783611">Fatalf</span><span class="op" id="6783617">(</span><span class="string" id="6783618">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]:&nbsp;%v&#34;</span><span class="op" id="6783656">,</span>&nbsp;<span class="ident" id="6783658">tt</span><span class="op" id="6783660">.</span><span class="ident" id="6783661">net</span><span class="op" id="6783664">,</span>&nbsp;<span class="ident" id="6783666">str</span><span class="op" id="6783669">,</span>&nbsp;<span class="ident" id="6783671">tt</span><span class="op" id="6783673">.</span><span class="ident" id="6783674">litAddrOrName</span><span class="op" id="6783687">,</span>&nbsp;<span class="ident" id="6783689">err</span><span class="op" id="6783692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6783697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6783702">if</span>&nbsp;<span class="op" id="6783705">!</span><span class="ident" id="6783706">reflect</span><span class="op" id="6783713">.</span><span class="ident" id="6783714">DeepEqual</span><span class="op" id="6783723">(</span><span class="ident" id="6783724">addr1</span><span class="op" id="6783729">,</span>&nbsp;<span class="ident" id="6783731">addr</span><span class="op" id="6783735">)</span>&nbsp;<span class="op" id="6783737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6783743">t</span><span class="op" id="6783744">.</span><span class="ident" id="6783745">Fatalf</span><span class="op" id="6783751">(</span><span class="string" id="6783752">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="6783802">,</span>&nbsp;<span class="ident" id="6783804">tt</span><span class="op" id="6783806">.</span><span class="ident" id="6783807">net</span><span class="op" id="6783810">,</span>&nbsp;<span class="ident" id="6783812">str</span><span class="op" id="6783815">,</span>&nbsp;<span class="ident" id="6783817">tt</span><span class="op" id="6783819">.</span><span class="ident" id="6783820">litAddrOrName</span><span class="op" id="6783833">,</span>&nbsp;<span class="ident" id="6783835">addr1</span><span class="op" id="6783840">,</span>&nbsp;<span class="ident" id="6783842">addr</span><span class="op" id="6783846">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6783851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6783855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6783858">}</span><br>
<span class="lineno"></span><span class="op" id="6783860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span><span class="keyword" id="6783863">var</span>&nbsp;<span class="ident" id="6783867">tcpListenerNameTests</span>&nbsp;<span class="op" id="6783888">=</span>&nbsp;<span class="op" id="6783890">[</span><span class="op" id="6783891">]</span><span class="keyword" id="6783892">struct</span>&nbsp;<span class="op" id="6783899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6783902">net</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6783908">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6783916">laddr</span>&nbsp;<span class="op" id="6783922">*</span><span class="ident" id="6783923">TCPAddr</span><br>
<span class="lineno"></span><span class="op" id="6783931">}</span><span class="op" id="6783932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6783935">{</span><span class="string" id="6783936">&#34;tcp4&#34;</span><span class="op" id="6783942">,</span>&nbsp;<span class="op" id="6783944">&amp;</span><span class="ident" id="6783945">TCPAddr</span><span class="op" id="6783952">{</span><span class="ident" id="6783953">IP</span><span class="op" id="6783955">:</span>&nbsp;<span class="ident" id="6783957">IPv4</span><span class="op" id="6783961">(</span><span class="num" id="6783962">127</span><span class="op" id="6783965">,</span>&nbsp;<span class="num" id="6783967">0</span><span class="op" id="6783968">,</span>&nbsp;<span class="num" id="6783970">0</span><span class="op" id="6783971">,</span>&nbsp;<span class="num" id="6783973">1</span><span class="op" id="6783974">)</span><span class="op" id="6783975">}</span><span class="op" id="6783976">}</span><span class="op" id="6783977">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6783980">{</span><span class="string" id="6783981">&#34;tcp4&#34;</span><span class="op" id="6783987">,</span>&nbsp;<span class="op" id="6783989">&amp;</span><span class="ident" id="6783990">TCPAddr</span><span class="op" id="6783997">{</span><span class="op" id="6783998">}</span><span class="op" id="6783999">}</span><span class="op" id="6784000">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6784003">{</span><span class="string" id="6784004">&#34;tcp4&#34;</span><span class="op" id="6784010">,</span>&nbsp;<span class="builtintype" id="6784012">nil</span><span class="op" id="6784015">}</span><span class="op" id="6784016">,</span><br>
<span class="lineno"></span><span class="op" id="6784018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6784021">func</span>&nbsp;<span class="ident" id="6784026">TestTCPListenerName</span><span class="op" id="6784045">(</span><span class="ident" id="6784046">t</span>&nbsp;<span class="op" id="6784048">*</span><span class="ident" id="6784049">testing</span><span class="op" id="6784056">.</span><span class="ident" id="6784057">T</span><span class="op" id="6784058">)</span>&nbsp;<span class="op" id="6784060">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6784063">if</span>&nbsp;<span class="ident" id="6784066">testing</span><span class="op" id="6784073">.</span><span class="ident" id="6784074">Short</span><span class="op" id="6784079">(</span><span class="op" id="6784080">)</span>&nbsp;<span class="op" id="6784082">||</span>&nbsp;<span class="op" id="6784085">!</span><span class="op" id="6784086">*</span><span class="ident" id="6784087">testExternal</span>&nbsp;<span class="op" id="6784100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6784104">t</span><span class="op" id="6784105">.</span><span class="ident" id="6784106">Skip</span><span class="op" id="6784110">(</span><span class="string" id="6784111">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="6784152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6784155">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6784159">for</span>&nbsp;<span class="ident" id="6784163">_</span><span class="op" id="6784164">,</span>&nbsp;<span class="ident" id="6784166">tt</span>&nbsp;<span class="op" id="6784169">:=</span>&nbsp;<span class="keyword" id="6784172">range</span>&nbsp;<span class="ident" id="6784178">tcpListenerNameTests</span>&nbsp;<span class="op" id="6784199">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6784203">ln</span><span class="op" id="6784205">,</span>&nbsp;<span class="ident" id="6784207">err</span>&nbsp;<span class="op" id="6784211">:=</span>&nbsp;<span class="ident" id="6784214">ListenTCP</span><span class="op" id="6784223">(</span><span class="ident" id="6784224">tt</span><span class="op" id="6784226">.</span><span class="ident" id="6784227">net</span><span class="op" id="6784230">,</span>&nbsp;<span class="ident" id="6784232">tt</span><span class="op" id="6784234">.</span><span class="ident" id="6784235">laddr</span><span class="op" id="6784240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6784244">if</span>&nbsp;<span class="ident" id="6784247">err</span>&nbsp;<span class="op" id="6784251">!=</span>&nbsp;<span class="builtintype" id="6784254">nil</span>&nbsp;<span class="op" id="6784258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6784263">t</span><span class="op" id="6784264">.</span><span class="ident" id="6784265">Fatalf</span><span class="op" id="6784271">(</span><span class="string" id="6784272">&#34;ListenTCP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6784294">,</span>&nbsp;<span class="ident" id="6784296">err</span><span class="op" id="6784299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6784303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6784307">defer</span>&nbsp;<span class="ident" id="6784313">ln</span><span class="op" id="6784315">.</span><span class="ident" id="6784316">Close</span><span class="op" id="6784321">(</span><span class="op" id="6784322">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6784326">la</span>&nbsp;<span class="op" id="6784329">:=</span>&nbsp;<span class="ident" id="6784332">ln</span><span class="op" id="6784334">.</span><span class="ident" id="6784335">Addr</span><span class="op" id="6784339">(</span><span class="op" id="6784340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6784344">if</span>&nbsp;<span class="ident" id="6784347">a</span><span class="op" id="6784348">,</span>&nbsp;<span class="ident" id="6784350">ok</span>&nbsp;<span class="op" id="6784353">:=</span>&nbsp;<span class="ident" id="6784356">la</span><span class="op" id="6784358">.</span><span class="op" id="6784359">(</span><span class="op" id="6784360">*</span><span class="ident" id="6784361">TCPAddr</span><span class="op" id="6784368">)</span><span class="op" id="6784369">;</span>&nbsp;<span class="op" id="6784371">!</span><span class="ident" id="6784372">ok</span>&nbsp;<span class="op" id="6784375">||</span>&nbsp;<span class="ident" id="6784378">a</span><span class="op" id="6784379">.</span><span class="ident" id="6784380">Port</span>&nbsp;<span class="op" id="6784385">==</span>&nbsp;<span class="num" id="6784388">0</span>&nbsp;<span class="op" id="6784390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6784395">t</span><span class="op" id="6784396">.</span><span class="ident" id="6784397">Fatalf</span><span class="op" id="6784403">(</span><span class="string" id="6784404">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;non-zero&nbsp;port&nbsp;number&#34;</span><span class="op" id="6784465">,</span>&nbsp;<span class="ident" id="6784467">la</span><span class="op" id="6784469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6784473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6784476">}</span><br>
<span class="lineno">375</span><span class="op" id="6784478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6784481">func</span>&nbsp;<span class="ident" id="6784486">TestIPv6LinkLocalUnicastTCP</span><span class="op" id="6784513">(</span><span class="ident" id="6784514">t</span>&nbsp;<span class="op" id="6784516">*</span><span class="ident" id="6784517">testing</span><span class="op" id="6784524">.</span><span class="ident" id="6784525">T</span><span class="op" id="6784526">)</span>&nbsp;<span class="op" id="6784528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6784531">if</span>&nbsp;<span class="ident" id="6784534">testing</span><span class="op" id="6784541">.</span><span class="ident" id="6784542">Short</span><span class="op" id="6784547">(</span><span class="op" id="6784548">)</span>&nbsp;<span class="op" id="6784550">||</span>&nbsp;<span class="op" id="6784553">!</span><span class="op" id="6784554">*</span><span class="ident" id="6784555">testExternal</span>&nbsp;<span class="op" id="6784568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6784572">t</span><span class="op" id="6784573">.</span><span class="ident" id="6784574">Skip</span><span class="op" id="6784578">(</span><span class="string" id="6784579">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="6784620">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6784623">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6784626">if</span>&nbsp;<span class="op" id="6784629">!</span><span class="ident" id="6784630">supportsIPv6</span>&nbsp;<span class="op" id="6784643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6784647">t</span><span class="op" id="6784648">.</span><span class="ident" id="6784649">Skip</span><span class="op" id="6784653">(</span><span class="string" id="6784654">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="6784677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6784680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6784683">ifi</span>&nbsp;<span class="op" id="6784687">:=</span>&nbsp;<span class="ident" id="6784690">loopbackInterface</span><span class="op" id="6784707">(</span><span class="op" id="6784708">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6784711">if</span>&nbsp;<span class="ident" id="6784714">ifi</span>&nbsp;<span class="op" id="6784718">==</span>&nbsp;<span class="builtintype" id="6784721">nil</span>&nbsp;<span class="op" id="6784725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6784729">t</span><span class="op" id="6784730">.</span><span class="ident" id="6784731">Skip</span><span class="op" id="6784735">(</span><span class="string" id="6784736">&#34;loopback&nbsp;interface&nbsp;not&nbsp;found&#34;</span><span class="op" id="6784766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6784769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6784772">laddr</span>&nbsp;<span class="op" id="6784778">:=</span>&nbsp;<span class="ident" id="6784781">ipv6LinkLocalUnicastAddr</span><span class="op" id="6784805">(</span><span class="ident" id="6784806">ifi</span><span class="op" id="6784809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6784812">if</span>&nbsp;<span class="ident" id="6784815">laddr</span>&nbsp;<span class="op" id="6784821">==</span>&nbsp;<span class="string" id="6784824">&#34;&#34;</span>&nbsp;<span class="op" id="6784827">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6784831">t</span><span class="op" id="6784832">.</span><span class="ident" id="6784833">Skip</span><span class="op" id="6784837">(</span><span class="string" id="6784838">&#34;ipv6&nbsp;unicast&nbsp;address&nbsp;on&nbsp;loopback&nbsp;not&nbsp;found&#34;</span><span class="op" id="6784882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6784885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6784889">type</span>&nbsp;<span class="ident" id="6784894">test</span>&nbsp;<span class="keyword" id="6784899">struct</span>&nbsp;<span class="op" id="6784906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6784910">net</span><span class="op" id="6784913">,</span>&nbsp;<span class="ident" id="6784915">addr</span>&nbsp;&nbsp;<span class="builtintype" id="6784921">string</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6784930">nameLookup</span>&nbsp;<span class="builtintype" id="6784941">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6784947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6784950">var</span>&nbsp;<span class="ident" id="6784954">tests</span>&nbsp;<span class="op" id="6784960">=</span>&nbsp;<span class="op" id="6784962">[</span><span class="op" id="6784963">]</span><span class="ident" id="6784964">test</span><span class="op" id="6784968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6784972">{</span><span class="string" id="6784973">&#34;tcp&#34;</span><span class="op" id="6784978">,</span>&nbsp;<span class="string" id="6784980">&#34;[&#34;</span>&nbsp;<span class="op" id="6784984">+</span>&nbsp;<span class="ident" id="6784986">laddr</span>&nbsp;<span class="op" id="6784992">+</span>&nbsp;<span class="string" id="6784994">&#34;%&#34;</span>&nbsp;<span class="op" id="6784998">+</span>&nbsp;<span class="ident" id="6785000">ifi</span><span class="op" id="6785003">.</span><span class="ident" id="6785004">Name</span>&nbsp;<span class="op" id="6785009">+</span>&nbsp;<span class="string" id="6785011">&#34;]:0&#34;</span><span class="op" id="6785016">,</span>&nbsp;<span class="builtintype" id="6785018">false</span><span class="op" id="6785023">}</span><span class="op" id="6785024">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6785028">{</span><span class="string" id="6785029">&#34;tcp6&#34;</span><span class="op" id="6785035">,</span>&nbsp;<span class="string" id="6785037">&#34;[&#34;</span>&nbsp;<span class="op" id="6785041">+</span>&nbsp;<span class="ident" id="6785043">laddr</span>&nbsp;<span class="op" id="6785049">+</span>&nbsp;<span class="string" id="6785051">&#34;%&#34;</span>&nbsp;<span class="op" id="6785055">+</span>&nbsp;<span class="ident" id="6785057">ifi</span><span class="op" id="6785060">.</span><span class="ident" id="6785061">Name</span>&nbsp;<span class="op" id="6785066">+</span>&nbsp;<span class="string" id="6785068">&#34;]:0&#34;</span><span class="op" id="6785073">,</span>&nbsp;<span class="builtintype" id="6785075">false</span><span class="op" id="6785080">}</span><span class="op" id="6785081">,</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6785084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6785087">switch</span>&nbsp;<span class="ident" id="6785094">runtime</span><span class="op" id="6785101">.</span><span class="ident" id="6785102">GOOS</span>&nbsp;<span class="op" id="6785107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6785110">case</span>&nbsp;<span class="string" id="6785115">&#34;darwin&#34;</span><span class="op" id="6785123">,</span>&nbsp;<span class="string" id="6785125">&#34;freebsd&#34;</span><span class="op" id="6785134">,</span>&nbsp;<span class="string" id="6785136">&#34;openbsd&#34;</span><span class="op" id="6785145">,</span>&nbsp;<span class="string" id="6785147">&#34;netbsd&#34;</span><span class="op" id="6785155">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6785159">tests</span>&nbsp;<span class="op" id="6785165">=</span>&nbsp;<span class="builtinfunc" id="6785167">append</span><span class="op" id="6785173">(</span><span class="ident" id="6785174">tests</span><span class="op" id="6785179">,</span>&nbsp;<span class="op" id="6785181">[</span><span class="op" id="6785182">]</span><span class="ident" id="6785183">test</span><span class="op" id="6785187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6785192">{</span><span class="string" id="6785193">&#34;tcp&#34;</span><span class="op" id="6785198">,</span>&nbsp;<span class="string" id="6785200">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="6785214">+</span>&nbsp;<span class="ident" id="6785216">ifi</span><span class="op" id="6785219">.</span><span class="ident" id="6785220">Name</span>&nbsp;<span class="op" id="6785225">+</span>&nbsp;<span class="string" id="6785227">&#34;]:0&#34;</span><span class="op" id="6785232">,</span>&nbsp;<span class="builtintype" id="6785234">true</span><span class="op" id="6785238">}</span><span class="op" id="6785239">,</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6785244">{</span><span class="string" id="6785245">&#34;tcp6&#34;</span><span class="op" id="6785251">,</span>&nbsp;<span class="string" id="6785253">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="6785267">+</span>&nbsp;<span class="ident" id="6785269">ifi</span><span class="op" id="6785272">.</span><span class="ident" id="6785273">Name</span>&nbsp;<span class="op" id="6785278">+</span>&nbsp;<span class="string" id="6785280">&#34;]:0&#34;</span><span class="op" id="6785285">,</span>&nbsp;<span class="builtintype" id="6785287">true</span><span class="op" id="6785291">}</span><span class="op" id="6785292">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6785296">}</span><span class="op" id="6785297">...</span><span class="op" id="6785300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6785303">case</span>&nbsp;<span class="string" id="6785308">&#34;linux&#34;</span><span class="op" id="6785315">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6785319">tests</span>&nbsp;<span class="op" id="6785325">=</span>&nbsp;<span class="builtinfunc" id="6785327">append</span><span class="op" id="6785333">(</span><span class="ident" id="6785334">tests</span><span class="op" id="6785339">,</span>&nbsp;<span class="op" id="6785341">[</span><span class="op" id="6785342">]</span><span class="ident" id="6785343">test</span><span class="op" id="6785347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6785352">{</span><span class="string" id="6785353">&#34;tcp&#34;</span><span class="op" id="6785358">,</span>&nbsp;<span class="string" id="6785360">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="6785378">+</span>&nbsp;<span class="ident" id="6785380">ifi</span><span class="op" id="6785383">.</span><span class="ident" id="6785384">Name</span>&nbsp;<span class="op" id="6785389">+</span>&nbsp;<span class="string" id="6785391">&#34;]:0&#34;</span><span class="op" id="6785396">,</span>&nbsp;<span class="builtintype" id="6785398">true</span><span class="op" id="6785402">}</span><span class="op" id="6785403">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6785408">{</span><span class="string" id="6785409">&#34;tcp6&#34;</span><span class="op" id="6785415">,</span>&nbsp;<span class="string" id="6785417">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="6785435">+</span>&nbsp;<span class="ident" id="6785437">ifi</span><span class="op" id="6785440">.</span><span class="ident" id="6785441">Name</span>&nbsp;<span class="op" id="6785446">+</span>&nbsp;<span class="string" id="6785448">&#34;]:0&#34;</span><span class="op" id="6785453">,</span>&nbsp;<span class="builtintype" id="6785455">true</span><span class="op" id="6785459">}</span><span class="op" id="6785460">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6785464">}</span><span class="op" id="6785465">...</span><span class="op" id="6785468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6785471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6785474">for</span>&nbsp;<span class="ident" id="6785478">_</span><span class="op" id="6785479">,</span>&nbsp;<span class="ident" id="6785481">tt</span>&nbsp;<span class="op" id="6785484">:=</span>&nbsp;<span class="keyword" id="6785487">range</span>&nbsp;<span class="ident" id="6785493">tests</span>&nbsp;<span class="op" id="6785499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6785503">ln</span><span class="op" id="6785505">,</span>&nbsp;<span class="ident" id="6785507">err</span>&nbsp;<span class="op" id="6785511">:=</span>&nbsp;<span class="ident" id="6785514">Listen</span><span class="op" id="6785520">(</span><span class="ident" id="6785521">tt</span><span class="op" id="6785523">.</span><span class="ident" id="6785524">net</span><span class="op" id="6785527">,</span>&nbsp;<span class="ident" id="6785529">tt</span><span class="op" id="6785531">.</span><span class="ident" id="6785532">addr</span><span class="op" id="6785536">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6785540">if</span>&nbsp;<span class="ident" id="6785543">err</span>&nbsp;<span class="op" id="6785547">!=</span>&nbsp;<span class="builtintype" id="6785550">nil</span>&nbsp;<span class="op" id="6785554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6785559">//&nbsp;It&nbsp;might&nbsp;return&nbsp;&#34;LookupHost&nbsp;returned&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6785605">//&nbsp;suitable&nbsp;address&#34;&nbsp;error&nbsp;on&nbsp;some&nbsp;platforms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6785654">t</span><span class="op" id="6785655">.</span><span class="ident" id="6785656">Logf</span><span class="op" id="6785660">(</span><span class="string" id="6785661">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6785680">,</span>&nbsp;<span class="ident" id="6785682">err</span><span class="op" id="6785685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6785690">continue</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6785701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6785705">defer</span>&nbsp;<span class="ident" id="6785711">ln</span><span class="op" id="6785713">.</span><span class="ident" id="6785714">Close</span><span class="op" id="6785719">(</span><span class="op" id="6785720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6785724">if</span>&nbsp;<span class="ident" id="6785727">la</span><span class="op" id="6785729">,</span>&nbsp;<span class="ident" id="6785731">ok</span>&nbsp;<span class="op" id="6785734">:=</span>&nbsp;<span class="ident" id="6785737">ln</span><span class="op" id="6785739">.</span><span class="ident" id="6785740">Addr</span><span class="op" id="6785744">(</span><span class="op" id="6785745">)</span><span class="op" id="6785746">.</span><span class="op" id="6785747">(</span><span class="op" id="6785748">*</span><span class="ident" id="6785749">TCPAddr</span><span class="op" id="6785756">)</span><span class="op" id="6785757">;</span>&nbsp;<span class="op" id="6785759">!</span><span class="ident" id="6785760">ok</span>&nbsp;<span class="op" id="6785763">||</span>&nbsp;<span class="op" id="6785766">!</span><span class="ident" id="6785767">tt</span><span class="op" id="6785769">.</span><span class="ident" id="6785770">nameLookup</span>&nbsp;<span class="op" id="6785781">&amp;&amp;</span>&nbsp;<span class="ident" id="6785784">la</span><span class="op" id="6785786">.</span><span class="ident" id="6785787">Zone</span>&nbsp;<span class="op" id="6785792">==</span>&nbsp;<span class="string" id="6785795">&#34;&#34;</span>&nbsp;<span class="op" id="6785798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6785803">t</span><span class="op" id="6785804">.</span><span class="ident" id="6785805">Fatalf</span><span class="op" id="6785811">(</span><span class="string" id="6785812">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="6785868">,</span>&nbsp;<span class="ident" id="6785870">la</span><span class="op" id="6785872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6785876">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6785881">done</span>&nbsp;<span class="op" id="6785886">:=</span>&nbsp;<span class="builtinfunc" id="6785889">make</span><span class="op" id="6785893">(</span><span class="keyword" id="6785894">chan</span>&nbsp;<span class="builtintype" id="6785899">int</span><span class="op" id="6785902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6785906">go</span>&nbsp;<span class="ident" id="6785909">transponder</span><span class="op" id="6785920">(</span><span class="ident" id="6785921">t</span><span class="op" id="6785922">,</span>&nbsp;<span class="ident" id="6785924">ln</span><span class="op" id="6785926">,</span>&nbsp;<span class="ident" id="6785928">done</span><span class="op" id="6785932">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6785937">c</span><span class="op" id="6785938">,</span>&nbsp;<span class="ident" id="6785940">err</span>&nbsp;<span class="op" id="6785944">:=</span>&nbsp;<span class="ident" id="6785947">Dial</span><span class="op" id="6785951">(</span><span class="ident" id="6785952">tt</span><span class="op" id="6785954">.</span><span class="ident" id="6785955">net</span><span class="op" id="6785958">,</span>&nbsp;<span class="ident" id="6785960">ln</span><span class="op" id="6785962">.</span><span class="ident" id="6785963">Addr</span><span class="op" id="6785967">(</span><span class="op" id="6785968">)</span><span class="op" id="6785969">.</span><span class="ident" id="6785970">String</span><span class="op" id="6785976">(</span><span class="op" id="6785977">)</span><span class="op" id="6785978">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6785982">if</span>&nbsp;<span class="ident" id="6785985">err</span>&nbsp;<span class="op" id="6785989">!=</span>&nbsp;<span class="builtintype" id="6785992">nil</span>&nbsp;<span class="op" id="6785996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6786001">t</span><span class="op" id="6786002">.</span><span class="ident" id="6786003">Fatalf</span><span class="op" id="6786009">(</span><span class="string" id="6786010">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6786027">,</span>&nbsp;<span class="ident" id="6786029">err</span><span class="op" id="6786032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6786036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6786040">defer</span>&nbsp;<span class="ident" id="6786046">c</span><span class="op" id="6786047">.</span><span class="ident" id="6786048">Close</span><span class="op" id="6786053">(</span><span class="op" id="6786054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6786058">if</span>&nbsp;<span class="ident" id="6786061">la</span><span class="op" id="6786063">,</span>&nbsp;<span class="ident" id="6786065">ok</span>&nbsp;<span class="op" id="6786068">:=</span>&nbsp;<span class="ident" id="6786071">c</span><span class="op" id="6786072">.</span><span class="ident" id="6786073">LocalAddr</span><span class="op" id="6786082">(</span><span class="op" id="6786083">)</span><span class="op" id="6786084">.</span><span class="op" id="6786085">(</span><span class="op" id="6786086">*</span><span class="ident" id="6786087">TCPAddr</span><span class="op" id="6786094">)</span><span class="op" id="6786095">;</span>&nbsp;<span class="op" id="6786097">!</span><span class="ident" id="6786098">ok</span>&nbsp;<span class="op" id="6786101">||</span>&nbsp;<span class="op" id="6786104">!</span><span class="ident" id="6786105">tt</span><span class="op" id="6786107">.</span><span class="ident" id="6786108">nameLookup</span>&nbsp;<span class="op" id="6786119">&amp;&amp;</span>&nbsp;<span class="ident" id="6786122">la</span><span class="op" id="6786124">.</span><span class="ident" id="6786125">Zone</span>&nbsp;<span class="op" id="6786130">==</span>&nbsp;<span class="string" id="6786133">&#34;&#34;</span>&nbsp;<span class="op" id="6786136">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6786141">t</span><span class="op" id="6786142">.</span><span class="ident" id="6786143">Fatalf</span><span class="op" id="6786149">(</span><span class="string" id="6786150">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="6786206">,</span>&nbsp;<span class="ident" id="6786208">la</span><span class="op" id="6786210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6786214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6786218">if</span>&nbsp;<span class="ident" id="6786221">ra</span><span class="op" id="6786223">,</span>&nbsp;<span class="ident" id="6786225">ok</span>&nbsp;<span class="op" id="6786228">:=</span>&nbsp;<span class="ident" id="6786231">c</span><span class="op" id="6786232">.</span><span class="ident" id="6786233">RemoteAddr</span><span class="op" id="6786243">(</span><span class="op" id="6786244">)</span><span class="op" id="6786245">.</span><span class="op" id="6786246">(</span><span class="op" id="6786247">*</span><span class="ident" id="6786248">TCPAddr</span><span class="op" id="6786255">)</span><span class="op" id="6786256">;</span>&nbsp;<span class="op" id="6786258">!</span><span class="ident" id="6786259">ok</span>&nbsp;<span class="op" id="6786262">||</span>&nbsp;<span class="op" id="6786265">!</span><span class="ident" id="6786266">tt</span><span class="op" id="6786268">.</span><span class="ident" id="6786269">nameLookup</span>&nbsp;<span class="op" id="6786280">&amp;&amp;</span>&nbsp;<span class="ident" id="6786283">ra</span><span class="op" id="6786285">.</span><span class="ident" id="6786286">Zone</span>&nbsp;<span class="op" id="6786291">==</span>&nbsp;<span class="string" id="6786294">&#34;&#34;</span>&nbsp;<span class="op" id="6786297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6786302">t</span><span class="op" id="6786303">.</span><span class="ident" id="6786304">Fatalf</span><span class="op" id="6786310">(</span><span class="string" id="6786311">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="6786367">,</span>&nbsp;<span class="ident" id="6786369">ra</span><span class="op" id="6786371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6786375">}</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6786380">if</span>&nbsp;<span class="ident" id="6786383">_</span><span class="op" id="6786384">,</span>&nbsp;<span class="ident" id="6786386">err</span>&nbsp;<span class="op" id="6786390">:=</span>&nbsp;<span class="ident" id="6786393">c</span><span class="op" id="6786394">.</span><span class="ident" id="6786395">Write</span><span class="op" id="6786400">(</span><span class="op" id="6786401">[</span><span class="op" id="6786402">]</span><span class="builtintype" id="6786403">byte</span><span class="op" id="6786407">(</span><span class="string" id="6786408">&#34;TCP&nbsp;OVER&nbsp;IPV6&nbsp;LINKLOCAL&nbsp;TEST&#34;</span><span class="op" id="6786438">)</span><span class="op" id="6786439">)</span><span class="op" id="6786440">;</span>&nbsp;<span class="ident" id="6786442">err</span>&nbsp;<span class="op" id="6786446">!=</span>&nbsp;<span class="builtintype" id="6786449">nil</span>&nbsp;<span class="op" id="6786453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6786458">t</span><span class="op" id="6786459">.</span><span class="ident" id="6786460">Fatalf</span><span class="op" id="6786466">(</span><span class="string" id="6786467">&#34;Conn.Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6786490">,</span>&nbsp;<span class="ident" id="6786492">err</span><span class="op" id="6786495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6786499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6786503">b</span>&nbsp;<span class="op" id="6786505">:=</span>&nbsp;<span class="builtinfunc" id="6786508">make</span><span class="op" id="6786512">(</span><span class="op" id="6786513">[</span><span class="op" id="6786514">]</span><span class="builtintype" id="6786515">byte</span><span class="op" id="6786519">,</span>&nbsp;<span class="num" id="6786521">32</span><span class="op" id="6786523">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6786527">if</span>&nbsp;<span class="ident" id="6786530">_</span><span class="op" id="6786531">,</span>&nbsp;<span class="ident" id="6786533">err</span>&nbsp;<span class="op" id="6786537">:=</span>&nbsp;<span class="ident" id="6786540">c</span><span class="op" id="6786541">.</span><span class="ident" id="6786542">Read</span><span class="op" id="6786546">(</span><span class="ident" id="6786547">b</span><span class="op" id="6786548">)</span><span class="op" id="6786549">;</span>&nbsp;<span class="ident" id="6786551">err</span>&nbsp;<span class="op" id="6786555">!=</span>&nbsp;<span class="builtintype" id="6786558">nil</span>&nbsp;<span class="op" id="6786562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6786567">t</span><span class="op" id="6786568">.</span><span class="ident" id="6786569">Fatalf</span><span class="op" id="6786575">(</span><span class="string" id="6786576">&#34;Conn.Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6786598">,</span>&nbsp;<span class="ident" id="6786600">err</span><span class="op" id="6786603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6786607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6786612">&lt;-</span><span class="ident" id="6786614">done</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6786620">}</span><br>
<span class="lineno"></span><span class="op" id="6786622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6786625">func</span>&nbsp;<span class="ident" id="6786630">TestTCPConcurrentAccept</span><span class="op" id="6786653">(</span><span class="ident" id="6786654">t</span>&nbsp;<span class="op" id="6786656">*</span><span class="ident" id="6786657">testing</span><span class="op" id="6786664">.</span><span class="ident" id="6786665">T</span><span class="op" id="6786666">)</span>&nbsp;<span class="op" id="6786668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6786671">defer</span>&nbsp;<span class="ident" id="6786677">runtime</span><span class="op" id="6786684">.</span><span class="ident" id="6786685">GOMAXPROCS</span><span class="op" id="6786695">(</span><span class="ident" id="6786696">runtime</span><span class="op" id="6786703">.</span><span class="ident" id="6786704">GOMAXPROCS</span><span class="op" id="6786714">(</span><span class="num" id="6786715">4</span><span class="op" id="6786716">)</span><span class="op" id="6786717">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6786720">ln</span><span class="op" id="6786722">,</span>&nbsp;<span class="ident" id="6786724">err</span>&nbsp;<span class="op" id="6786728">:=</span>&nbsp;<span class="ident" id="6786731">Listen</span><span class="op" id="6786737">(</span><span class="string" id="6786738">&#34;tcp&#34;</span><span class="op" id="6786743">,</span>&nbsp;<span class="string" id="6786745">&#34;127.0.0.1:0&#34;</span><span class="op" id="6786758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6786761">if</span>&nbsp;<span class="ident" id="6786764">err</span>&nbsp;<span class="op" id="6786768">!=</span>&nbsp;<span class="builtintype" id="6786771">nil</span>&nbsp;<span class="op" id="6786775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6786779">t</span><span class="op" id="6786780">.</span><span class="ident" id="6786781">Fatalf</span><span class="op" id="6786787">(</span><span class="string" id="6786788">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6786807">,</span>&nbsp;<span class="ident" id="6786809">err</span><span class="op" id="6786812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6786815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6786818">const</span>&nbsp;<span class="ident" id="6786824">N</span>&nbsp;<span class="op" id="6786826">=</span>&nbsp;<span class="num" id="6786828">10</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6786832">var</span>&nbsp;<span class="ident" id="6786836">wg</span>&nbsp;<span class="ident" id="6786839">sync</span><span class="op" id="6786843">.</span><span class="ident" id="6786844">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6786855">wg</span><span class="op" id="6786857">.</span><span class="ident" id="6786858">Add</span><span class="op" id="6786861">(</span><span class="ident" id="6786862">N</span><span class="op" id="6786863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6786866">for</span>&nbsp;<span class="ident" id="6786870">i</span>&nbsp;<span class="op" id="6786872">:=</span>&nbsp;<span class="num" id="6786875">0</span><span class="op" id="6786876">;</span>&nbsp;<span class="ident" id="6786878">i</span>&nbsp;<span class="op" id="6786880">&lt;</span>&nbsp;<span class="ident" id="6786882">N</span><span class="op" id="6786883">;</span>&nbsp;<span class="ident" id="6786885">i</span><span class="op" id="6786886">++</span>&nbsp;<span class="op" id="6786889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6786893">go</span>&nbsp;<span class="keyword" id="6786896">func</span><span class="op" id="6786900">(</span><span class="op" id="6786901">)</span>&nbsp;<span class="op" id="6786903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6786908">for</span>&nbsp;<span class="op" id="6786912">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6786918">c</span><span class="op" id="6786919">,</span>&nbsp;<span class="ident" id="6786921">err</span>&nbsp;<span class="op" id="6786925">:=</span>&nbsp;<span class="ident" id="6786928">ln</span><span class="op" id="6786930">.</span><span class="ident" id="6786931">Accept</span><span class="op" id="6786937">(</span><span class="op" id="6786938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6786944">if</span>&nbsp;<span class="ident" id="6786947">err</span>&nbsp;<span class="op" id="6786951">!=</span>&nbsp;<span class="builtintype" id="6786954">nil</span>&nbsp;<span class="op" id="6786958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6786965">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6786975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6786981">c</span><span class="op" id="6786982">.</span><span class="ident" id="6786983">Close</span><span class="op" id="6786988">(</span><span class="op" id="6786989">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6786994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6786999">wg</span><span class="op" id="6787001">.</span><span class="ident" id="6787002">Done</span><span class="op" id="6787006">(</span><span class="op" id="6787007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6787011">}</span><span class="op" id="6787012">(</span><span class="op" id="6787013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6787016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6787019">attempts</span>&nbsp;<span class="op" id="6787028">:=</span>&nbsp;<span class="num" id="6787031">10</span>&nbsp;<span class="op" id="6787034">*</span>&nbsp;<span class="ident" id="6787036">N</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6787039">fails</span>&nbsp;<span class="op" id="6787045">:=</span>&nbsp;<span class="num" id="6787048">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6787051">d</span>&nbsp;<span class="op" id="6787053">:=</span>&nbsp;<span class="op" id="6787056">&amp;</span><span class="ident" id="6787057">Dialer</span><span class="op" id="6787063">{</span><span class="ident" id="6787064">Timeout</span><span class="op" id="6787071">:</span>&nbsp;<span class="num" id="6787073">200</span>&nbsp;<span class="op" id="6787077">*</span>&nbsp;<span class="ident" id="6787079">time</span><span class="op" id="6787083">.</span><span class="ident" id="6787084">Millisecond</span><span class="op" id="6787095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6787098">for</span>&nbsp;<span class="ident" id="6787102">i</span>&nbsp;<span class="op" id="6787104">:=</span>&nbsp;<span class="num" id="6787107">0</span><span class="op" id="6787108">;</span>&nbsp;<span class="ident" id="6787110">i</span>&nbsp;<span class="op" id="6787112">&lt;</span>&nbsp;<span class="ident" id="6787114">attempts</span><span class="op" id="6787122">;</span>&nbsp;<span class="ident" id="6787124">i</span><span class="op" id="6787125">++</span>&nbsp;<span class="op" id="6787128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6787132">c</span><span class="op" id="6787133">,</span>&nbsp;<span class="ident" id="6787135">err</span>&nbsp;<span class="op" id="6787139">:=</span>&nbsp;<span class="ident" id="6787142">d</span><span class="op" id="6787143">.</span><span class="ident" id="6787144">Dial</span><span class="op" id="6787148">(</span><span class="string" id="6787149">&#34;tcp&#34;</span><span class="op" id="6787154">,</span>&nbsp;<span class="ident" id="6787156">ln</span><span class="op" id="6787158">.</span><span class="ident" id="6787159">Addr</span><span class="op" id="6787163">(</span><span class="op" id="6787164">)</span><span class="op" id="6787165">.</span><span class="ident" id="6787166">String</span><span class="op" id="6787172">(</span><span class="op" id="6787173">)</span><span class="op" id="6787174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6787178">if</span>&nbsp;<span class="ident" id="6787181">err</span>&nbsp;<span class="op" id="6787185">!=</span>&nbsp;<span class="builtintype" id="6787188">nil</span>&nbsp;<span class="op" id="6787192">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6787197">fails</span><span class="op" id="6787202">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6787207">}</span>&nbsp;<span class="keyword" id="6787209">else</span>&nbsp;<span class="op" id="6787214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6787219">c</span><span class="op" id="6787220">.</span><span class="ident" id="6787221">Close</span><span class="op" id="6787226">(</span><span class="op" id="6787227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6787231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6787234">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6787237">ln</span><span class="op" id="6787239">.</span><span class="ident" id="6787240">Close</span><span class="op" id="6787245">(</span><span class="op" id="6787246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6787249">wg</span><span class="op" id="6787251">.</span><span class="ident" id="6787252">Wait</span><span class="op" id="6787256">(</span><span class="op" id="6787257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6787260">if</span>&nbsp;<span class="ident" id="6787263">fails</span>&nbsp;<span class="op" id="6787269">&gt;</span>&nbsp;<span class="ident" id="6787271">attempts</span><span class="op" id="6787279">/</span><span class="num" id="6787280">9</span>&nbsp;<span class="op" id="6787282">{</span>&nbsp;<span class="comment" id="6787284">//&nbsp;see&nbsp;issues&nbsp;7400&nbsp;and&nbsp;7541</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6787314">t</span><span class="op" id="6787315">.</span><span class="ident" id="6787316">Fatalf</span><span class="op" id="6787322">(</span><span class="string" id="6787323">&#34;too&nbsp;many&nbsp;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6787349">,</span>&nbsp;<span class="ident" id="6787351">fails</span><span class="op" id="6787356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6787359">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6787362">if</span>&nbsp;<span class="ident" id="6787365">fails</span>&nbsp;<span class="op" id="6787371">&gt;</span>&nbsp;<span class="num" id="6787373">0</span>&nbsp;<span class="op" id="6787375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6787379">t</span><span class="op" id="6787380">.</span><span class="ident" id="6787381">Logf</span><span class="op" id="6787385">(</span><span class="string" id="6787386">&#34;#&nbsp;of&nbsp;failed&nbsp;Dials:&nbsp;%v&#34;</span><span class="op" id="6787409">,</span>&nbsp;<span class="ident" id="6787411">fails</span><span class="op" id="6787416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6787419">}</span><br>
<span class="lineno"></span><span class="op" id="6787421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="keyword" id="6787424">func</span>&nbsp;<span class="ident" id="6787429">TestTCPReadWriteMallocs</span><span class="op" id="6787452">(</span><span class="ident" id="6787453">t</span>&nbsp;<span class="op" id="6787455">*</span><span class="ident" id="6787456">testing</span><span class="op" id="6787463">.</span><span class="ident" id="6787464">T</span><span class="op" id="6787465">)</span>&nbsp;<span class="op" id="6787467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6787470">if</span>&nbsp;<span class="ident" id="6787473">testing</span><span class="op" id="6787480">.</span><span class="ident" id="6787481">Short</span><span class="op" id="6787486">(</span><span class="op" id="6787487">)</span>&nbsp;<span class="op" id="6787489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6787493">t</span><span class="op" id="6787494">.</span><span class="ident" id="6787495">Skip</span><span class="op" id="6787499">(</span><span class="string" id="6787500">&#34;skipping&nbsp;malloc&nbsp;count&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="6787537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6787540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6787543">ln</span><span class="op" id="6787545">,</span>&nbsp;<span class="ident" id="6787547">err</span>&nbsp;<span class="op" id="6787551">:=</span>&nbsp;<span class="ident" id="6787554">Listen</span><span class="op" id="6787560">(</span><span class="string" id="6787561">&#34;tcp&#34;</span><span class="op" id="6787566">,</span>&nbsp;<span class="string" id="6787568">&#34;127.0.0.1:0&#34;</span><span class="op" id="6787581">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6787584">if</span>&nbsp;<span class="ident" id="6787587">err</span>&nbsp;<span class="op" id="6787591">!=</span>&nbsp;<span class="builtintype" id="6787594">nil</span>&nbsp;<span class="op" id="6787598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6787602">t</span><span class="op" id="6787603">.</span><span class="ident" id="6787604">Fatalf</span><span class="op" id="6787610">(</span><span class="string" id="6787611">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6787630">,</span>&nbsp;<span class="ident" id="6787632">err</span><span class="op" id="6787635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6787638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6787641">defer</span>&nbsp;<span class="ident" id="6787647">ln</span><span class="op" id="6787649">.</span><span class="ident" id="6787650">Close</span><span class="op" id="6787655">(</span><span class="op" id="6787656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6787659">var</span>&nbsp;<span class="ident" id="6787663">server</span>&nbsp;<span class="ident" id="6787670">Conn</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6787676">errc</span>&nbsp;<span class="op" id="6787681">:=</span>&nbsp;<span class="builtinfunc" id="6787684">make</span><span class="op" id="6787688">(</span><span class="keyword" id="6787689">chan</span>&nbsp;<span class="builtintype" id="6787694">error</span><span class="op" id="6787699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6787702">go</span>&nbsp;<span class="keyword" id="6787705">func</span><span class="op" id="6787709">(</span><span class="op" id="6787710">)</span>&nbsp;<span class="op" id="6787712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6787716">var</span>&nbsp;<span class="ident" id="6787720">err</span>&nbsp;<span class="builtintype" id="6787724">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6787732">server</span><span class="op" id="6787738">,</span>&nbsp;<span class="ident" id="6787740">err</span>&nbsp;<span class="op" id="6787744">=</span>&nbsp;<span class="ident" id="6787746">ln</span><span class="op" id="6787748">.</span><span class="ident" id="6787749">Accept</span><span class="op" id="6787755">(</span><span class="op" id="6787756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6787760">errc</span>&nbsp;<span class="op" id="6787765">&lt;-</span>&nbsp;<span class="ident" id="6787768">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6787773">}</span><span class="op" id="6787774">(</span><span class="op" id="6787775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6787778">client</span><span class="op" id="6787784">,</span>&nbsp;<span class="ident" id="6787786">err</span>&nbsp;<span class="op" id="6787790">:=</span>&nbsp;<span class="ident" id="6787793">Dial</span><span class="op" id="6787797">(</span><span class="string" id="6787798">&#34;tcp&#34;</span><span class="op" id="6787803">,</span>&nbsp;<span class="ident" id="6787805">ln</span><span class="op" id="6787807">.</span><span class="ident" id="6787808">Addr</span><span class="op" id="6787812">(</span><span class="op" id="6787813">)</span><span class="op" id="6787814">.</span><span class="ident" id="6787815">String</span><span class="op" id="6787821">(</span><span class="op" id="6787822">)</span><span class="op" id="6787823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6787826">if</span>&nbsp;<span class="ident" id="6787829">err</span>&nbsp;<span class="op" id="6787833">!=</span>&nbsp;<span class="builtintype" id="6787836">nil</span>&nbsp;<span class="op" id="6787840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6787844">t</span><span class="op" id="6787845">.</span><span class="ident" id="6787846">Fatalf</span><span class="op" id="6787852">(</span><span class="string" id="6787853">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6787870">,</span>&nbsp;<span class="ident" id="6787872">err</span><span class="op" id="6787875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6787878">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6787881">if</span>&nbsp;<span class="ident" id="6787884">err</span>&nbsp;<span class="op" id="6787888">:=</span>&nbsp;<span class="op" id="6787891">&lt;-</span><span class="ident" id="6787893">errc</span><span class="op" id="6787897">;</span>&nbsp;<span class="ident" id="6787899">err</span>&nbsp;<span class="op" id="6787903">!=</span>&nbsp;<span class="builtintype" id="6787906">nil</span>&nbsp;<span class="op" id="6787910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6787914">t</span><span class="op" id="6787915">.</span><span class="ident" id="6787916">Fatalf</span><span class="op" id="6787922">(</span><span class="string" id="6787923">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6787942">,</span>&nbsp;<span class="ident" id="6787944">err</span><span class="op" id="6787947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6787950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6787953">defer</span>&nbsp;<span class="ident" id="6787959">server</span><span class="op" id="6787965">.</span><span class="ident" id="6787966">Close</span><span class="op" id="6787971">(</span><span class="op" id="6787972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6787975">var</span>&nbsp;<span class="ident" id="6787979">buf</span>&nbsp;<span class="op" id="6787983">[</span><span class="num" id="6787984">128</span><span class="op" id="6787987">]</span><span class="builtintype" id="6787988">byte</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6787994">mallocs</span>&nbsp;<span class="op" id="6788002">:=</span>&nbsp;<span class="ident" id="6788005">testing</span><span class="op" id="6788012">.</span><span class="ident" id="6788013">AllocsPerRun</span><span class="op" id="6788025">(</span><span class="num" id="6788026">1000</span><span class="op" id="6788030">,</span>&nbsp;<span class="keyword" id="6788032">func</span><span class="op" id="6788036">(</span><span class="op" id="6788037">)</span>&nbsp;<span class="op" id="6788039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6788043">_</span><span class="op" id="6788044">,</span>&nbsp;<span class="ident" id="6788046">err</span>&nbsp;<span class="op" id="6788050">:=</span>&nbsp;<span class="ident" id="6788053">server</span><span class="op" id="6788059">.</span><span class="ident" id="6788060">Write</span><span class="op" id="6788065">(</span><span class="ident" id="6788066">buf</span><span class="op" id="6788069">[</span><span class="op" id="6788070">:</span><span class="op" id="6788071">]</span><span class="op" id="6788072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6788076">if</span>&nbsp;<span class="ident" id="6788079">err</span>&nbsp;<span class="op" id="6788083">!=</span>&nbsp;<span class="builtintype" id="6788086">nil</span>&nbsp;<span class="op" id="6788090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6788095">t</span><span class="op" id="6788096">.</span><span class="ident" id="6788097">Fatalf</span><span class="op" id="6788103">(</span><span class="string" id="6788104">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6788122">,</span>&nbsp;<span class="ident" id="6788124">err</span><span class="op" id="6788127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6788131">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6788135">_</span><span class="op" id="6788136">,</span>&nbsp;<span class="ident" id="6788138">err</span>&nbsp;<span class="op" id="6788142">=</span>&nbsp;<span class="ident" id="6788144">io</span><span class="op" id="6788146">.</span><span class="ident" id="6788147">ReadFull</span><span class="op" id="6788155">(</span><span class="ident" id="6788156">client</span><span class="op" id="6788162">,</span>&nbsp;<span class="ident" id="6788164">buf</span><span class="op" id="6788167">[</span><span class="op" id="6788168">:</span><span class="op" id="6788169">]</span><span class="op" id="6788170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6788174">if</span>&nbsp;<span class="ident" id="6788177">err</span>&nbsp;<span class="op" id="6788181">!=</span>&nbsp;<span class="builtintype" id="6788184">nil</span>&nbsp;<span class="op" id="6788188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6788193">t</span><span class="op" id="6788194">.</span><span class="ident" id="6788195">Fatalf</span><span class="op" id="6788201">(</span><span class="string" id="6788202">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6788219">,</span>&nbsp;<span class="ident" id="6788221">err</span><span class="op" id="6788224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6788228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6788231">}</span><span class="op" id="6788232">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6788235">if</span>&nbsp;<span class="ident" id="6788238">mallocs</span>&nbsp;<span class="op" id="6788246">&gt;</span>&nbsp;<span class="num" id="6788248">0</span>&nbsp;<span class="op" id="6788250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6788254">t</span><span class="op" id="6788255">.</span><span class="ident" id="6788256">Fatalf</span><span class="op" id="6788262">(</span><span class="string" id="6788263">&#34;Got&nbsp;%v&nbsp;allocs,&nbsp;want&nbsp;0&#34;</span><span class="op" id="6788286">,</span>&nbsp;<span class="ident" id="6788288">mallocs</span><span class="op" id="6788295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6788298">}</span><br>
<span class="lineno"></span><span class="op" id="6788300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="6788303">func</span>&nbsp;<span class="ident" id="6788308">TestTCPStress</span><span class="op" id="6788321">(</span><span class="ident" id="6788322">t</span>&nbsp;<span class="op" id="6788324">*</span><span class="ident" id="6788325">testing</span><span class="op" id="6788332">.</span><span class="ident" id="6788333">T</span><span class="op" id="6788334">)</span>&nbsp;<span class="op" id="6788336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6788339">const</span>&nbsp;<span class="ident" id="6788345">conns</span>&nbsp;<span class="op" id="6788351">=</span>&nbsp;<span class="num" id="6788353">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6788356">const</span>&nbsp;<span class="ident" id="6788362">msgLen</span>&nbsp;<span class="op" id="6788369">=</span>&nbsp;<span class="num" id="6788371">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6788376">msgs</span>&nbsp;<span class="op" id="6788381">:=</span>&nbsp;<span class="builtintype" id="6788384">int</span><span class="op" id="6788387">(</span><span class="num" id="6788388">1e4</span><span class="op" id="6788391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6788394">if</span>&nbsp;<span class="ident" id="6788397">testing</span><span class="op" id="6788404">.</span><span class="ident" id="6788405">Short</span><span class="op" id="6788410">(</span><span class="op" id="6788411">)</span>&nbsp;<span class="op" id="6788413">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6788417">msgs</span>&nbsp;<span class="op" id="6788422">=</span>&nbsp;<span class="num" id="6788424">1e2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6788429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6788433">sendMsg</span>&nbsp;<span class="op" id="6788441">:=</span>&nbsp;<span class="keyword" id="6788444">func</span><span class="op" id="6788448">(</span><span class="ident" id="6788449">c</span>&nbsp;<span class="ident" id="6788451">Conn</span><span class="op" id="6788455">,</span>&nbsp;<span class="ident" id="6788457">buf</span>&nbsp;<span class="op" id="6788461">[</span><span class="op" id="6788462">]</span><span class="builtintype" id="6788463">byte</span><span class="op" id="6788467">)</span>&nbsp;<span class="builtintype" id="6788469">bool</span>&nbsp;<span class="op" id="6788474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6788478">n</span><span class="op" id="6788479">,</span>&nbsp;<span class="ident" id="6788481">err</span>&nbsp;<span class="op" id="6788485">:=</span>&nbsp;<span class="ident" id="6788488">c</span><span class="op" id="6788489">.</span><span class="ident" id="6788490">Write</span><span class="op" id="6788495">(</span><span class="ident" id="6788496">buf</span><span class="op" id="6788499">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6788503">if</span>&nbsp;<span class="ident" id="6788506">n</span>&nbsp;<span class="op" id="6788508">!=</span>&nbsp;<span class="builtinfunc" id="6788511">len</span><span class="op" id="6788514">(</span><span class="ident" id="6788515">buf</span><span class="op" id="6788518">)</span>&nbsp;<span class="op" id="6788520">||</span>&nbsp;<span class="ident" id="6788523">err</span>&nbsp;<span class="op" id="6788527">!=</span>&nbsp;<span class="builtintype" id="6788530">nil</span>&nbsp;<span class="op" id="6788534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6788539">t</span><span class="op" id="6788540">.</span><span class="ident" id="6788541">Logf</span><span class="op" id="6788545">(</span><span class="string" id="6788546">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6788564">,</span>&nbsp;<span class="ident" id="6788566">err</span><span class="op" id="6788569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6788574">return</span>&nbsp;<span class="builtintype" id="6788581">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6788589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6788593">return</span>&nbsp;<span class="builtintype" id="6788600">true</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6788606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6788609">recvMsg</span>&nbsp;<span class="op" id="6788617">:=</span>&nbsp;<span class="keyword" id="6788620">func</span><span class="op" id="6788624">(</span><span class="ident" id="6788625">c</span>&nbsp;<span class="ident" id="6788627">Conn</span><span class="op" id="6788631">,</span>&nbsp;<span class="ident" id="6788633">buf</span>&nbsp;<span class="op" id="6788637">[</span><span class="op" id="6788638">]</span><span class="builtintype" id="6788639">byte</span><span class="op" id="6788643">)</span>&nbsp;<span class="builtintype" id="6788645">bool</span>&nbsp;<span class="op" id="6788650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6788654">for</span>&nbsp;<span class="ident" id="6788658">read</span>&nbsp;<span class="op" id="6788663">:=</span>&nbsp;<span class="num" id="6788666">0</span><span class="op" id="6788667">;</span>&nbsp;<span class="ident" id="6788669">read</span>&nbsp;<span class="op" id="6788674">!=</span>&nbsp;<span class="builtinfunc" id="6788677">len</span><span class="op" id="6788680">(</span><span class="ident" id="6788681">buf</span><span class="op" id="6788684">)</span><span class="op" id="6788685">;</span>&nbsp;<span class="op" id="6788687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6788692">n</span><span class="op" id="6788693">,</span>&nbsp;<span class="ident" id="6788695">err</span>&nbsp;<span class="op" id="6788699">:=</span>&nbsp;<span class="ident" id="6788702">c</span><span class="op" id="6788703">.</span><span class="ident" id="6788704">Read</span><span class="op" id="6788708">(</span><span class="ident" id="6788709">buf</span><span class="op" id="6788712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6788717">read</span>&nbsp;<span class="op" id="6788722">+=</span>&nbsp;<span class="ident" id="6788725">n</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6788730">if</span>&nbsp;<span class="ident" id="6788733">err</span>&nbsp;<span class="op" id="6788737">!=</span>&nbsp;<span class="builtintype" id="6788740">nil</span>&nbsp;<span class="op" id="6788744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6788750">t</span><span class="op" id="6788751">.</span><span class="ident" id="6788752">Logf</span><span class="op" id="6788756">(</span><span class="string" id="6788757">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6788774">,</span>&nbsp;<span class="ident" id="6788776">err</span><span class="op" id="6788779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6788785">return</span>&nbsp;<span class="builtintype" id="6788792">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6788801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6788805">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6788809">return</span>&nbsp;<span class="builtintype" id="6788816">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6788822">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6788826">ln</span><span class="op" id="6788828">,</span>&nbsp;<span class="ident" id="6788830">err</span>&nbsp;<span class="op" id="6788834">:=</span>&nbsp;<span class="ident" id="6788837">Listen</span><span class="op" id="6788843">(</span><span class="string" id="6788844">&#34;tcp&#34;</span><span class="op" id="6788849">,</span>&nbsp;<span class="string" id="6788851">&#34;127.0.0.1:0&#34;</span><span class="op" id="6788864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6788867">if</span>&nbsp;<span class="ident" id="6788870">err</span>&nbsp;<span class="op" id="6788874">!=</span>&nbsp;<span class="builtintype" id="6788877">nil</span>&nbsp;<span class="op" id="6788881">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6788885">t</span><span class="op" id="6788886">.</span><span class="ident" id="6788887">Fatalf</span><span class="op" id="6788893">(</span><span class="string" id="6788894">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6788913">,</span>&nbsp;<span class="ident" id="6788915">err</span><span class="op" id="6788918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6788921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6788924">defer</span>&nbsp;<span class="ident" id="6788930">ln</span><span class="op" id="6788932">.</span><span class="ident" id="6788933">Close</span><span class="op" id="6788938">(</span><span class="op" id="6788939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6788942">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6788956">go</span>&nbsp;<span class="keyword" id="6788959">func</span><span class="op" id="6788963">(</span><span class="op" id="6788964">)</span>&nbsp;<span class="op" id="6788966">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6788970">for</span>&nbsp;<span class="op" id="6788974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6788979">c</span><span class="op" id="6788980">,</span>&nbsp;<span class="ident" id="6788982">err</span>&nbsp;<span class="op" id="6788986">:=</span>&nbsp;<span class="ident" id="6788989">ln</span><span class="op" id="6788991">.</span><span class="ident" id="6788992">Accept</span><span class="op" id="6788998">(</span><span class="op" id="6788999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6789004">if</span>&nbsp;<span class="ident" id="6789007">err</span>&nbsp;<span class="op" id="6789011">!=</span>&nbsp;<span class="builtintype" id="6789014">nil</span>&nbsp;<span class="op" id="6789018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6789024">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6789033">}</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6789038">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6789063">go</span>&nbsp;<span class="keyword" id="6789066">func</span><span class="op" id="6789070">(</span><span class="ident" id="6789071">c</span>&nbsp;<span class="ident" id="6789073">Conn</span><span class="op" id="6789077">)</span>&nbsp;<span class="op" id="6789079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6789085">defer</span>&nbsp;<span class="ident" id="6789091">c</span><span class="op" id="6789092">.</span><span class="ident" id="6789093">Close</span><span class="op" id="6789098">(</span><span class="op" id="6789099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6789105">var</span>&nbsp;<span class="ident" id="6789109">buf</span>&nbsp;<span class="op" id="6789113">[</span><span class="ident" id="6789114">msgLen</span><span class="op" id="6789120">]</span><span class="builtintype" id="6789121">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6789130">for</span>&nbsp;<span class="ident" id="6789134">m</span>&nbsp;<span class="op" id="6789136">:=</span>&nbsp;<span class="num" id="6789139">0</span><span class="op" id="6789140">;</span>&nbsp;<span class="ident" id="6789142">m</span>&nbsp;<span class="op" id="6789144">&lt;</span>&nbsp;<span class="ident" id="6789146">msgs</span><span class="op" id="6789150">;</span>&nbsp;<span class="ident" id="6789152">m</span><span class="op" id="6789153">++</span>&nbsp;<span class="op" id="6789156">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6789163">if</span>&nbsp;<span class="op" id="6789166">!</span><span class="ident" id="6789167">recvMsg</span><span class="op" id="6789174">(</span><span class="ident" id="6789175">c</span><span class="op" id="6789176">,</span>&nbsp;<span class="ident" id="6789178">buf</span><span class="op" id="6789181">[</span><span class="op" id="6789182">:</span><span class="op" id="6789183">]</span><span class="op" id="6789184">)</span>&nbsp;<span class="op" id="6789186">||</span>&nbsp;<span class="op" id="6789189">!</span><span class="ident" id="6789190">sendMsg</span><span class="op" id="6789197">(</span><span class="ident" id="6789198">c</span><span class="op" id="6789199">,</span>&nbsp;<span class="ident" id="6789201">buf</span><span class="op" id="6789204">[</span><span class="op" id="6789205">:</span><span class="op" id="6789206">]</span><span class="op" id="6789207">)</span>&nbsp;<span class="op" id="6789209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6789217">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6789228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6789234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6789239">}</span><span class="op" id="6789240">(</span><span class="ident" id="6789241">c</span><span class="op" id="6789242">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6789246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6789249">}</span><span class="op" id="6789250">(</span><span class="op" id="6789251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6789254">done</span>&nbsp;<span class="op" id="6789259">:=</span>&nbsp;<span class="builtinfunc" id="6789262">make</span><span class="op" id="6789266">(</span><span class="keyword" id="6789267">chan</span>&nbsp;<span class="builtintype" id="6789272">bool</span><span class="op" id="6789276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6789279">for</span>&nbsp;<span class="ident" id="6789283">i</span>&nbsp;<span class="op" id="6789285">:=</span>&nbsp;<span class="num" id="6789288">0</span><span class="op" id="6789289">;</span>&nbsp;<span class="ident" id="6789291">i</span>&nbsp;<span class="op" id="6789293">&lt;</span>&nbsp;<span class="ident" id="6789295">conns</span><span class="op" id="6789300">;</span>&nbsp;<span class="ident" id="6789302">i</span><span class="op" id="6789303">++</span>&nbsp;<span class="op" id="6789306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6789310">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6789334">go</span>&nbsp;<span class="keyword" id="6789337">func</span><span class="op" id="6789341">(</span><span class="op" id="6789342">)</span>&nbsp;<span class="op" id="6789344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6789349">defer</span>&nbsp;<span class="keyword" id="6789355">func</span><span class="op" id="6789359">(</span><span class="op" id="6789360">)</span>&nbsp;<span class="op" id="6789362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6789368">done</span>&nbsp;<span class="op" id="6789373">&lt;-</span>&nbsp;<span class="builtintype" id="6789376">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6789384">}</span><span class="op" id="6789385">(</span><span class="op" id="6789386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6789391">c</span><span class="op" id="6789392">,</span>&nbsp;<span class="ident" id="6789394">err</span>&nbsp;<span class="op" id="6789398">:=</span>&nbsp;<span class="ident" id="6789401">Dial</span><span class="op" id="6789405">(</span><span class="string" id="6789406">&#34;tcp&#34;</span><span class="op" id="6789411">,</span>&nbsp;<span class="ident" id="6789413">ln</span><span class="op" id="6789415">.</span><span class="ident" id="6789416">Addr</span><span class="op" id="6789420">(</span><span class="op" id="6789421">)</span><span class="op" id="6789422">.</span><span class="ident" id="6789423">String</span><span class="op" id="6789429">(</span><span class="op" id="6789430">)</span><span class="op" id="6789431">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6789436">if</span>&nbsp;<span class="ident" id="6789439">err</span>&nbsp;<span class="op" id="6789443">!=</span>&nbsp;<span class="builtintype" id="6789446">nil</span>&nbsp;<span class="op" id="6789450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6789456">t</span><span class="op" id="6789457">.</span><span class="ident" id="6789458">Logf</span><span class="op" id="6789462">(</span><span class="string" id="6789463">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="6789480">,</span>&nbsp;<span class="ident" id="6789482">err</span><span class="op" id="6789485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6789491">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6789501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6789506">defer</span>&nbsp;<span class="ident" id="6789512">c</span><span class="op" id="6789513">.</span><span class="ident" id="6789514">Close</span><span class="op" id="6789519">(</span><span class="op" id="6789520">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6789525">var</span>&nbsp;<span class="ident" id="6789529">buf</span>&nbsp;<span class="op" id="6789533">[</span><span class="ident" id="6789534">msgLen</span><span class="op" id="6789540">]</span><span class="builtintype" id="6789541">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6789549">for</span>&nbsp;<span class="ident" id="6789553">m</span>&nbsp;<span class="op" id="6789555">:=</span>&nbsp;<span class="num" id="6789558">0</span><span class="op" id="6789559">;</span>&nbsp;<span class="ident" id="6789561">m</span>&nbsp;<span class="op" id="6789563">&lt;</span>&nbsp;<span class="ident" id="6789565">msgs</span><span class="op" id="6789569">;</span>&nbsp;<span class="ident" id="6789571">m</span><span class="op" id="6789572">++</span>&nbsp;<span class="op" id="6789575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6789581">if</span>&nbsp;<span class="op" id="6789584">!</span><span class="ident" id="6789585">sendMsg</span><span class="op" id="6789592">(</span><span class="ident" id="6789593">c</span><span class="op" id="6789594">,</span>&nbsp;<span class="ident" id="6789596">buf</span><span class="op" id="6789599">[</span><span class="op" id="6789600">:</span><span class="op" id="6789601">]</span><span class="op" id="6789602">)</span>&nbsp;<span class="op" id="6789604">||</span>&nbsp;<span class="op" id="6789607">!</span><span class="ident" id="6789608">recvMsg</span><span class="op" id="6789615">(</span><span class="ident" id="6789616">c</span><span class="op" id="6789617">,</span>&nbsp;<span class="ident" id="6789619">buf</span><span class="op" id="6789622">[</span><span class="op" id="6789623">:</span><span class="op" id="6789624">]</span><span class="op" id="6789625">)</span>&nbsp;<span class="op" id="6789627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6789634">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6789644">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6789649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6789653">}</span><span class="op" id="6789654">(</span><span class="op" id="6789655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6789658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6789661">for</span>&nbsp;<span class="ident" id="6789665">i</span>&nbsp;<span class="op" id="6789667">:=</span>&nbsp;<span class="num" id="6789670">0</span><span class="op" id="6789671">;</span>&nbsp;<span class="ident" id="6789673">i</span>&nbsp;<span class="op" id="6789675">&lt;</span>&nbsp;<span class="ident" id="6789677">conns</span><span class="op" id="6789682">;</span>&nbsp;<span class="ident" id="6789684">i</span><span class="op" id="6789685">++</span>&nbsp;<span class="op" id="6789688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6789692">&lt;-</span><span class="ident" id="6789694">done</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6789700">}</span><br>
<span class="lineno"></span><span class="op" id="6789702">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
