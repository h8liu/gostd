<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3824528">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3824583">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3824637">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3824688">//&nbsp;HTTP&nbsp;server.&nbsp;&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3824720">package</span>&nbsp;<span class="ident" id="3824728">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3824734">import</span>&nbsp;<span class="op" id="3824741">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3824744">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3824753">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3824767">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3824777">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3824784">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3824790">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3824803">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3824810">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3824817">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3824828">&#34;os&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3824834">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3824842">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3824853">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3824864">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3824875">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3824883">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3824898">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3824905">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3824908">//&nbsp;Errors&nbsp;introduced&nbsp;by&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">30</span><span class="keyword" id="3824949">var</span>&nbsp;<span class="op" id="3824953">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3824956">ErrWriteAfterFlush</span>&nbsp;<span class="op" id="3824975">=</span>&nbsp;<span class="ident" id="3824977"><a href="/net/http/server.go.html#3824767">errors</a></span><span class="op" id="3824983">.</span><span class="ident" id="3824984">New</span><span class="op" id="3824987">(</span><span class="string" id="3824988">&#34;Conn.Write&nbsp;called&nbsp;after&nbsp;Flush&#34;</span><span class="op" id="3825019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825022">ErrBodyNotAllowed</span>&nbsp;&nbsp;<span class="op" id="3825041">=</span>&nbsp;<span class="ident" id="3825043"><a href="/net/http/server.go.html#3824767">errors</a></span><span class="op" id="3825049">.</span><span class="ident" id="3825050">New</span><span class="op" id="3825053">(</span><span class="string" id="3825054">&#34;http:&nbsp;request&nbsp;method&nbsp;or&nbsp;response&nbsp;status&nbsp;code&nbsp;does&nbsp;not&nbsp;allow&nbsp;body&#34;</span><span class="op" id="3825120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825123">ErrHijacked</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3825142">=</span>&nbsp;<span class="ident" id="3825144"><a href="/net/http/server.go.html#3824767">errors</a></span><span class="op" id="3825150">.</span><span class="ident" id="3825151">New</span><span class="op" id="3825154">(</span><span class="string" id="3825155">&#34;Conn&nbsp;has&nbsp;been&nbsp;hijacked&#34;</span><span class="op" id="3825179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825182">ErrContentLength</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3825201">=</span>&nbsp;<span class="ident" id="3825203"><a href="/net/http/server.go.html#3824767">errors</a></span><span class="op" id="3825209">.</span><span class="ident" id="3825210">New</span><span class="op" id="3825213">(</span><span class="string" id="3825214">&#34;Conn.Write&nbsp;wrote&nbsp;more&nbsp;than&nbsp;the&nbsp;declared&nbsp;Content-Length&#34;</span><span class="op" id="3825270">)</span><br>
<span class="lineno">35</span><span class="op" id="3825272">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3825275">//&nbsp;Objects&nbsp;implementing&nbsp;the&nbsp;Handler&nbsp;interface&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3825328">//&nbsp;registered&nbsp;to&nbsp;serve&nbsp;a&nbsp;particular&nbsp;path&nbsp;or&nbsp;subtree</span><br>
<span class="lineno"></span><span class="comment" id="3825380">//&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">40</span><span class="comment" id="3825403">//</span><br>
<span class="lineno"></span><span class="comment" id="3825406">//&nbsp;ServeHTTP&nbsp;should&nbsp;write&nbsp;reply&nbsp;headers&nbsp;and&nbsp;data&nbsp;to&nbsp;the&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="3825477">//&nbsp;and&nbsp;then&nbsp;return.&nbsp;&nbsp;Returning&nbsp;signals&nbsp;that&nbsp;the&nbsp;request&nbsp;is&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="3825545">//&nbsp;and&nbsp;that&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;can&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3825608">//&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">45</span><span class="comment" id="3825627">//</span><br>
<span class="lineno"></span><span class="comment" id="3825630">//&nbsp;If&nbsp;ServeHTTP&nbsp;panics,&nbsp;the&nbsp;server&nbsp;(the&nbsp;caller&nbsp;of&nbsp;ServeHTTP)&nbsp;assumes</span><br>
<span class="lineno"></span><span class="comment" id="3825699">//&nbsp;that&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;panic&nbsp;was&nbsp;isolated&nbsp;to&nbsp;the&nbsp;active&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="3825767">//&nbsp;It&nbsp;recovers&nbsp;the&nbsp;panic,&nbsp;logs&nbsp;a&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;server&nbsp;error&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="3825837">//&nbsp;and&nbsp;hangs&nbsp;up&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">50</span><span class="comment" id="3825869">//</span><br>
<span class="lineno"></span><span class="keyword" id="3825872">type</span>&nbsp;<span class="ident" id="3825877">Handler</span>&nbsp;<span class="keyword" id="3825885">interface</span>&nbsp;<span class="op" id="3825895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3825898">ServeHTTP</span><span class="op" id="3825907">(</span><span class="ident" id="3825908"><a href="/net/http/server.go.html#3826033">ResponseWriter</a></span><span class="op" id="3825922">,</span>&nbsp;<span class="op" id="3825924">*</span><span class="ident" id="3825925"><a href="/net/http/request.go.html#3791418">Request</a></span><span class="op" id="3825932">)</span><br>
<span class="lineno"></span><span class="op" id="3825934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3825937">//&nbsp;A&nbsp;ResponseWriter&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3825997">//&nbsp;construct&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3826028">type</span>&nbsp;<span class="ident" id="3826033">ResponseWriter</span>&nbsp;<span class="keyword" id="3826048">interface</span>&nbsp;<span class="op" id="3826058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826061">//&nbsp;Header&nbsp;returns&nbsp;the&nbsp;header&nbsp;map&nbsp;that&nbsp;will&nbsp;be&nbsp;sent&nbsp;by&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826129">//&nbsp;Changing&nbsp;the&nbsp;header&nbsp;after&nbsp;a&nbsp;call&nbsp;to&nbsp;WriteHeader&nbsp;(or&nbsp;Write)&nbsp;has</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826196">//&nbsp;no&nbsp;effect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826211">Header</span><span class="op" id="3826217">(</span><span class="op" id="3826218">)</span>&nbsp;<span class="ident" id="3826220"><a href="/net/http/header.go.html#3781581">Header</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826229">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;data&nbsp;to&nbsp;the&nbsp;connection&nbsp;as&nbsp;part&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826299">//&nbsp;If&nbsp;WriteHeader&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;called,&nbsp;Write&nbsp;calls&nbsp;WriteHeader(http.StatusOK)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826382">//&nbsp;before&nbsp;writing&nbsp;the&nbsp;data.&nbsp;&nbsp;If&nbsp;the&nbsp;Header&nbsp;does&nbsp;not&nbsp;contain&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826445">//&nbsp;Content-Type&nbsp;line,&nbsp;Write&nbsp;adds&nbsp;a&nbsp;Content-Type&nbsp;set&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;passing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826523">//&nbsp;the&nbsp;initial&nbsp;512&nbsp;bytes&nbsp;of&nbsp;written&nbsp;data&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826587">Write</span><span class="op" id="3826592">(</span><span class="op" id="3826593">[</span><span class="op" id="3826594">]</span><span class="builtintype" id="3826595">byte</span><span class="op" id="3826599">)</span>&nbsp;<span class="op" id="3826601">(</span><span class="builtintype" id="3826602">int</span><span class="op" id="3826605">,</span>&nbsp;<span class="builtintype" id="3826607">error</span><span class="op" id="3826612">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826616">//&nbsp;WriteHeader&nbsp;sends&nbsp;an&nbsp;HTTP&nbsp;response&nbsp;header&nbsp;with&nbsp;status&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826680">//&nbsp;If&nbsp;WriteHeader&nbsp;is&nbsp;not&nbsp;called&nbsp;explicitly,&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826749">//&nbsp;will&nbsp;trigger&nbsp;an&nbsp;implicit&nbsp;WriteHeader(http.StatusOK).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826806">//&nbsp;Thus&nbsp;explicit&nbsp;calls&nbsp;to&nbsp;WriteHeader&nbsp;are&nbsp;mainly&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3826864">//&nbsp;send&nbsp;error&nbsp;codes.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3826886">WriteHeader</span><span class="op" id="3826897">(</span><span class="builtintype" id="3826898">int</span><span class="op" id="3826901">)</span><br>
<span class="lineno"></span><span class="op" id="3826903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3826906">//&nbsp;The&nbsp;Flusher&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="3826976">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;flush&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno">80</span><span class="comment" id="3827033">//</span><br>
<span class="lineno"></span><span class="comment" id="3827036">//&nbsp;Note&nbsp;that&nbsp;even&nbsp;for&nbsp;ResponseWriters&nbsp;that&nbsp;support&nbsp;Flush,</span><br>
<span class="lineno"></span><span class="comment" id="3827094">//&nbsp;if&nbsp;the&nbsp;client&nbsp;is&nbsp;connected&nbsp;through&nbsp;an&nbsp;HTTP&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="3827147">//&nbsp;the&nbsp;buffered&nbsp;data&nbsp;may&nbsp;not&nbsp;reach&nbsp;the&nbsp;client&nbsp;until&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="3827212">//&nbsp;completes.</span><br>
<span class="lineno">85</span><span class="keyword" id="3827226">type</span>&nbsp;<span class="ident" id="3827231">Flusher</span>&nbsp;<span class="keyword" id="3827239">interface</span>&nbsp;<span class="op" id="3827249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3827252">//&nbsp;Flush&nbsp;sends&nbsp;any&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827301">Flush</span><span class="op" id="3827306">(</span><span class="op" id="3827307">)</span><br>
<span class="lineno"></span><span class="op" id="3827309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="3827312">//&nbsp;The&nbsp;Hijacker&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="3827383">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3827431">type</span>&nbsp;<span class="ident" id="3827436">Hijacker</span>&nbsp;<span class="keyword" id="3827445">interface</span>&nbsp;<span class="op" id="3827455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3827458">//&nbsp;Hijack&nbsp;lets&nbsp;the&nbsp;caller&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3827511">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Hijack(),&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;library</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3827565">//&nbsp;will&nbsp;not&nbsp;do&nbsp;anything&nbsp;else&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3827616">//&nbsp;It&nbsp;becomes&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;manage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3827669">//&nbsp;and&nbsp;close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3827699">Hijack</span><span class="op" id="3827705">(</span><span class="op" id="3827706">)</span>&nbsp;<span class="op" id="3827708">(</span><span class="ident" id="3827709"><a href="/net/http/server.go.html#3824810">net</a></span><span class="op" id="3827712">.</span><span class="ident" id="3827713">Conn</span><span class="op" id="3827717">,</span>&nbsp;<span class="op" id="3827719">*</span><span class="ident" id="3827720"><a href="/net/http/server.go.html#3824744">bufio</a></span><span class="op" id="3827725">.</span><span class="ident" id="3827726">ReadWriter</span><span class="op" id="3827736">,</span>&nbsp;<span class="builtintype" id="3827738">error</span><span class="op" id="3827743">)</span><br>
<span class="lineno"></span><span class="op" id="3827745">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="3827748">//&nbsp;The&nbsp;CloseNotifier&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="3827819">//&nbsp;allow&nbsp;detecting&nbsp;when&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span><span class="comment" id="3827884">//</span><br>
<span class="lineno"></span><span class="comment" id="3827887">//&nbsp;This&nbsp;mechanism&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;cancel&nbsp;long&nbsp;operations&nbsp;on&nbsp;the&nbsp;server</span><br>
<span class="lineno">105</span><span class="comment" id="3827957">//&nbsp;if&nbsp;the&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;before&nbsp;the&nbsp;response&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="3828021">type</span>&nbsp;<span class="ident" id="3828026">CloseNotifier</span>&nbsp;<span class="keyword" id="3828040">interface</span>&nbsp;<span class="op" id="3828050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3828053">//&nbsp;CloseNotify&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;receives&nbsp;a&nbsp;single&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3828116">//&nbsp;when&nbsp;the&nbsp;client&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828162">CloseNotify</span><span class="op" id="3828173">(</span><span class="op" id="3828174">)</span>&nbsp;<span class="op" id="3828176">&lt;-</span><span class="keyword" id="3828178">chan</span>&nbsp;<span class="builtintype" id="3828183">bool</span><br>
<span class="lineno">110</span><span class="op" id="3828188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3828191">//&nbsp;A&nbsp;conn&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3828251">type</span>&nbsp;<span class="ident" id="3828256">conn</span>&nbsp;<span class="keyword" id="3828261">struct</span>&nbsp;<span class="op" id="3828268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828271">remoteAddr</span>&nbsp;<span class="builtintype" id="3828282">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3828303">//&nbsp;network&nbsp;address&nbsp;of&nbsp;remote&nbsp;side</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828338">server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3828349">*</span><span class="ident" id="3828350"><a href="/net/http/server.go.html#3872025">Server</a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3828370">//&nbsp;the&nbsp;Server&nbsp;on&nbsp;which&nbsp;the&nbsp;connection&nbsp;arrived</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828417">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3828428"><a href="/net/http/server.go.html#3824810">net</a></span><span class="op" id="3828431">.</span><span class="ident" id="3828432">Conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3828449">//&nbsp;i/o&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828468">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3828479"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3828481">.</span><span class="ident" id="3828482">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3828500">//&nbsp;checkConnErrorWriter&#39;s&nbsp;copy&nbsp;of&nbsp;wrc,&nbsp;not&nbsp;zeroed&nbsp;on&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828561">werr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3828572">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3828593">//&nbsp;any&nbsp;errors&nbsp;writing&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828621">sr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3828632"><a href="/net/http/server.go.html#3830757">liveSwitchReader</a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3828653">//&nbsp;where&nbsp;the&nbsp;LimitReader&nbsp;reads&nbsp;from;&nbsp;usually&nbsp;the&nbsp;rwc</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828707">lr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3828718">*</span><span class="ident" id="3828719"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3828721">.</span><span class="ident" id="3828722">LimitedReader</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3828739">//&nbsp;io.LimitReader(sr)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828762">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3828773">*</span><span class="ident" id="3828774"><a href="/net/http/server.go.html#3824744">bufio</a></span><span class="op" id="3828779">.</span><span class="ident" id="3828780">ReadWriter</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3828794">//&nbsp;buffered(lr,rwc),&nbsp;reading&nbsp;from&nbsp;bufio-&gt;limitReader-&gt;sr-&gt;rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828857">tlsState</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3828868">*</span><span class="ident" id="3828869"><a href="/net/http/server.go.html#3824753">tls</a></span><span class="op" id="3828872">.</span><span class="ident" id="3828873">ConnectionState</span>&nbsp;<span class="comment" id="3828889">//&nbsp;or&nbsp;nil&nbsp;when&nbsp;not&nbsp;using&nbsp;TLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828920">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3828933"><a href="/net/http/server.go.html#3824875">sync</a></span><span class="op" id="3828937">.</span><span class="ident" id="3828938">Mutex</span>&nbsp;<span class="comment" id="3828944">//&nbsp;guards&nbsp;the&nbsp;following</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3828969">clientGone</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3828982">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3828993">//&nbsp;if&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;mid-request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829036">closeNotifyc</span>&nbsp;<span class="keyword" id="3829049">chan</span>&nbsp;<span class="builtintype" id="3829054">bool</span>&nbsp;&nbsp;<span class="comment" id="3829060">//&nbsp;made&nbsp;lazily</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829076">hijackedv</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3829089">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3829100">//&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked&nbsp;by&nbsp;handler</span><br>
<span class="lineno"></span><span class="op" id="3829143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="3829146">func</span>&nbsp;<span class="op" id="3829151">(</span><span class="ident" id="3829152">c</span>&nbsp;<span class="op" id="3829154">*</span><span class="ident" id="3829155"><a href="/net/http/server.go.html#3828256">conn</a></span><span class="op" id="3829159">)</span>&nbsp;<span class="ident" id="3829161">hijacked</span><span class="op" id="3829169">(</span><span class="op" id="3829170">)</span>&nbsp;<span class="builtintype" id="3829172">bool</span>&nbsp;<span class="op" id="3829177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829180"><a href="/net/http/server.go.html#3829152">c</a></span><span class="op" id="3829181">.</span><span class="ident" id="3829182">mu</span><span class="op" id="3829184">.</span><span class="ident" id="3829185">Lock</span><span class="op" id="3829189">(</span><span class="op" id="3829190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829193">defer</span>&nbsp;<span class="ident" id="3829199"><a href="/net/http/server.go.html#3829152">c</a></span><span class="op" id="3829200">.</span><span class="ident" id="3829201">mu</span><span class="op" id="3829203">.</span><span class="ident" id="3829204">Unlock</span><span class="op" id="3829210">(</span><span class="op" id="3829211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829214">return</span>&nbsp;<span class="ident" id="3829221"><a href="/net/http/server.go.html#3829152">c</a></span><span class="op" id="3829222">.</span><span class="ident" id="3829223">hijackedv</span><br>
<span class="lineno"></span><span class="op" id="3829233">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="3829236">func</span>&nbsp;<span class="op" id="3829241">(</span><span class="ident" id="3829242">c</span>&nbsp;<span class="op" id="3829244">*</span><span class="ident" id="3829245"><a href="/net/http/server.go.html#3828256">conn</a></span><span class="op" id="3829249">)</span>&nbsp;<span class="ident" id="3829251">hijack</span><span class="op" id="3829257">(</span><span class="op" id="3829258">)</span>&nbsp;<span class="op" id="3829260">(</span><span class="ident" id="3829261">rwc</span>&nbsp;<span class="ident" id="3829265"><a href="/net/http/server.go.html#3824810">net</a></span><span class="op" id="3829268">.</span><span class="ident" id="3829269">Conn</span><span class="op" id="3829273">,</span>&nbsp;<span class="ident" id="3829275">buf</span>&nbsp;<span class="op" id="3829279">*</span><span class="ident" id="3829280"><a href="/net/http/server.go.html#3824744">bufio</a></span><span class="op" id="3829285">.</span><span class="ident" id="3829286">ReadWriter</span><span class="op" id="3829296">,</span>&nbsp;<span class="ident" id="3829298">err</span>&nbsp;<span class="builtintype" id="3829302">error</span><span class="op" id="3829307">)</span>&nbsp;<span class="op" id="3829309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829312"><a href="/net/http/server.go.html#3829242">c</a></span><span class="op" id="3829313">.</span><span class="ident" id="3829314">mu</span><span class="op" id="3829316">.</span><span class="ident" id="3829317">Lock</span><span class="op" id="3829321">(</span><span class="op" id="3829322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829325">defer</span>&nbsp;<span class="ident" id="3829331"><a href="/net/http/server.go.html#3829242">c</a></span><span class="op" id="3829332">.</span><span class="ident" id="3829333">mu</span><span class="op" id="3829335">.</span><span class="ident" id="3829336">Unlock</span><span class="op" id="3829342">(</span><span class="op" id="3829343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829346">if</span>&nbsp;<span class="ident" id="3829349"><a href="/net/http/server.go.html#3829242">c</a></span><span class="op" id="3829350">.</span><span class="ident" id="3829351">hijackedv</span>&nbsp;<span class="op" id="3829361">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829365">return</span>&nbsp;<span class="ident" id="3829372">nil</span><span class="op" id="3829375">,</span>&nbsp;<span class="ident" id="3829377">nil</span><span class="op" id="3829380">,</span>&nbsp;<span class="ident" id="3829382"><a href="/net/http/server.go.html#3825123">ErrHijacked</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3829395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829398">if</span>&nbsp;<span class="ident" id="3829401"><a href="/net/http/server.go.html#3829242">c</a></span><span class="op" id="3829402">.</span><span class="ident" id="3829403">closeNotifyc</span>&nbsp;<span class="op" id="3829416">!=</span>&nbsp;<span class="ident" id="3829419">nil</span>&nbsp;<span class="op" id="3829423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829427">return</span>&nbsp;<span class="ident" id="3829434">nil</span><span class="op" id="3829437">,</span>&nbsp;<span class="ident" id="3829439">nil</span><span class="op" id="3829442">,</span>&nbsp;<span class="ident" id="3829444"><a href="/net/http/server.go.html#3824767">errors</a></span><span class="op" id="3829450">.</span><span class="ident" id="3829451">New</span><span class="op" id="3829454">(</span><span class="string" id="3829455">&#34;http:&nbsp;Hijack&nbsp;is&nbsp;incompatible&nbsp;with&nbsp;use&nbsp;of&nbsp;CloseNotifier&#34;</span><span class="op" id="3829511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3829514">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829517"><a href="/net/http/server.go.html#3829242">c</a></span><span class="op" id="3829518">.</span><span class="ident" id="3829519">hijackedv</span>&nbsp;<span class="op" id="3829529">=</span>&nbsp;<span class="ident" id="3829531">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829537"><a href="/net/http/server.go.html#3829261">rwc</a></span>&nbsp;<span class="op" id="3829541">=</span>&nbsp;<span class="ident" id="3829543"><a href="/net/http/server.go.html#3829242">c</a></span><span class="op" id="3829544">.</span><span class="ident" id="3829545">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829550"><a href="/net/http/server.go.html#3829275">buf</a></span>&nbsp;<span class="op" id="3829554">=</span>&nbsp;<span class="ident" id="3829556"><a href="/net/http/server.go.html#3829242">c</a></span><span class="op" id="3829557">.</span><span class="ident" id="3829558">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829563"><a href="/net/http/server.go.html#3829242">c</a></span><span class="op" id="3829564">.</span><span class="ident" id="3829565">rwc</span>&nbsp;<span class="op" id="3829569">=</span>&nbsp;<span class="ident" id="3829571">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829576"><a href="/net/http/server.go.html#3829242">c</a></span><span class="op" id="3829577">.</span><span class="ident" id="3829578">buf</span>&nbsp;<span class="op" id="3829582">=</span>&nbsp;<span class="ident" id="3829584">nil</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829589"><a href="/net/http/server.go.html#3829242">c</a></span><span class="op" id="3829590">.</span><span class="ident" id="3829591">setState</span><span class="op" id="3829599">(</span><span class="ident" id="3829600"><a href="/net/http/server.go.html#3829261">rwc</a></span><span class="op" id="3829603">,</span>&nbsp;<span class="ident" id="3829605"><a href="/net/http/server.go.html#3874605">StateHijacked</a></span><span class="op" id="3829618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829621">return</span><br>
<span class="lineno"></span><span class="op" id="3829628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3829631">func</span>&nbsp;<span class="op" id="3829636">(</span><span class="ident" id="3829637">c</span>&nbsp;<span class="op" id="3829639">*</span><span class="ident" id="3829640"><a href="/net/http/server.go.html#3828256">conn</a></span><span class="op" id="3829644">)</span>&nbsp;<span class="ident" id="3829646">closeNotify</span><span class="op" id="3829657">(</span><span class="op" id="3829658">)</span>&nbsp;<span class="op" id="3829660">&lt;-</span><span class="keyword" id="3829662">chan</span>&nbsp;<span class="builtintype" id="3829667">bool</span>&nbsp;<span class="op" id="3829672">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829675"><a href="/net/http/server.go.html#3829637">c</a></span><span class="op" id="3829676">.</span><span class="ident" id="3829677">mu</span><span class="op" id="3829679">.</span><span class="ident" id="3829680">Lock</span><span class="op" id="3829684">(</span><span class="op" id="3829685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829688">defer</span>&nbsp;<span class="ident" id="3829694"><a href="/net/http/server.go.html#3829637">c</a></span><span class="op" id="3829695">.</span><span class="ident" id="3829696">mu</span><span class="op" id="3829698">.</span><span class="ident" id="3829699">Unlock</span><span class="op" id="3829705">(</span><span class="op" id="3829706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829709">if</span>&nbsp;<span class="ident" id="3829712"><a href="/net/http/server.go.html#3829637">c</a></span><span class="op" id="3829713">.</span><span class="ident" id="3829714">closeNotifyc</span>&nbsp;<span class="op" id="3829727">==</span>&nbsp;<span class="ident" id="3829730">nil</span>&nbsp;<span class="op" id="3829734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829738"><a href="/net/http/server.go.html#3829637">c</a></span><span class="op" id="3829739">.</span><span class="ident" id="3829740">closeNotifyc</span>&nbsp;<span class="op" id="3829753">=</span>&nbsp;<span class="builtinfunc" id="3829755">make</span><span class="op" id="3829759">(</span><span class="keyword" id="3829760">chan</span>&nbsp;<span class="builtintype" id="3829765">bool</span><span class="op" id="3829769">,</span>&nbsp;<span class="num" id="3829771">1</span><span class="op" id="3829772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829776">if</span>&nbsp;<span class="ident" id="3829779"><a href="/net/http/server.go.html#3829637">c</a></span><span class="op" id="3829780">.</span><span class="ident" id="3829781">hijackedv</span>&nbsp;<span class="op" id="3829791">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3829796">//&nbsp;to&nbsp;obey&nbsp;the&nbsp;function&nbsp;signature,&nbsp;even&nbsp;though</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3829846">//&nbsp;it&#39;ll&nbsp;never&nbsp;receive&nbsp;a&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829881">return</span>&nbsp;<span class="ident" id="3829888"><a href="/net/http/server.go.html#3829637">c</a></span><span class="op" id="3829889">.</span><span class="ident" id="3829890">closeNotifyc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3829905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829909">pr</span><span class="op" id="3829911">,</span>&nbsp;<span class="ident" id="3829913">pw</span>&nbsp;<span class="op" id="3829916">:=</span>&nbsp;<span class="ident" id="3829919"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3829921">.</span><span class="ident" id="3829922">Pipe</span><span class="op" id="3829926">(</span><span class="op" id="3829927">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829932">readSource</span>&nbsp;<span class="op" id="3829943">:=</span>&nbsp;<span class="ident" id="3829946"><a href="/net/http/server.go.html#3829637">c</a></span><span class="op" id="3829947">.</span><span class="ident" id="3829948">sr</span><span class="op" id="3829950">.</span><span class="ident" id="3829951">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829955"><a href="/net/http/server.go.html#3829637">c</a></span><span class="op" id="3829956">.</span><span class="ident" id="3829957">sr</span><span class="op" id="3829959">.</span><span class="ident" id="3829960">Lock</span><span class="op" id="3829964">(</span><span class="op" id="3829965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829969"><a href="/net/http/server.go.html#3829637">c</a></span><span class="op" id="3829970">.</span><span class="ident" id="3829971">sr</span><span class="op" id="3829973">.</span><span class="ident" id="3829974">r</span>&nbsp;<span class="op" id="3829976">=</span>&nbsp;<span class="ident" id="3829978"><a href="/net/http/server.go.html#3829909">pr</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3829983"><a href="/net/http/server.go.html#3829637">c</a></span><span class="op" id="3829984">.</span><span class="ident" id="3829985">sr</span><span class="op" id="3829987">.</span><span class="ident" id="3829988">Unlock</span><span class="op" id="3829994">(</span><span class="op" id="3829995">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3829999">go</span>&nbsp;<span class="keyword" id="3830002">func</span><span class="op" id="3830006">(</span><span class="op" id="3830007">)</span>&nbsp;<span class="op" id="3830009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830014">_</span><span class="op" id="3830015">,</span>&nbsp;<span class="ident" id="3830017">err</span>&nbsp;<span class="op" id="3830021">:=</span>&nbsp;<span class="ident" id="3830024"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3830026">.</span><span class="ident" id="3830027">Copy</span><span class="op" id="3830031">(</span><span class="ident" id="3830032"><a href="/net/http/server.go.html#3829913">pw</a></span><span class="op" id="3830034">,</span>&nbsp;<span class="ident" id="3830036"><a href="/net/http/server.go.html#3829932">readSource</a></span><span class="op" id="3830046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3830051">if</span>&nbsp;<span class="ident" id="3830054"><a href="/net/http/server.go.html#3830017">err</a></span>&nbsp;<span class="op" id="3830058">==</span>&nbsp;<span class="ident" id="3830061">nil</span>&nbsp;<span class="op" id="3830065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830071"><a href="/net/http/server.go.html#3830017">err</a></span>&nbsp;<span class="op" id="3830075">=</span>&nbsp;<span class="ident" id="3830077"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3830079">.</span><span class="ident" id="3830080">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3830087">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830092"><a href="/net/http/server.go.html#3829913">pw</a></span><span class="op" id="3830094">.</span><span class="ident" id="3830095">CloseWithError</span><span class="op" id="3830109">(</span><span class="ident" id="3830110"><a href="/net/http/server.go.html#3830017">err</a></span><span class="op" id="3830113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830118"><a href="/net/http/server.go.html#3829637">c</a></span><span class="op" id="3830119">.</span><span class="ident" id="3830120">noteClientGone</span><span class="op" id="3830134">(</span><span class="op" id="3830135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3830139">}</span><span class="op" id="3830140">(</span><span class="op" id="3830141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3830144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3830147">return</span>&nbsp;<span class="ident" id="3830154"><a href="/net/http/server.go.html#3829637">c</a></span><span class="op" id="3830155">.</span><span class="ident" id="3830156">closeNotifyc</span><br>
<span class="lineno">180</span><span class="op" id="3830169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3830172">func</span>&nbsp;<span class="op" id="3830177">(</span><span class="ident" id="3830178">c</span>&nbsp;<span class="op" id="3830180">*</span><span class="ident" id="3830181"><a href="/net/http/server.go.html#3828256">conn</a></span><span class="op" id="3830185">)</span>&nbsp;<span class="ident" id="3830187">noteClientGone</span><span class="op" id="3830201">(</span><span class="op" id="3830202">)</span>&nbsp;<span class="op" id="3830204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830207"><a href="/net/http/server.go.html#3830178">c</a></span><span class="op" id="3830208">.</span><span class="ident" id="3830209">mu</span><span class="op" id="3830211">.</span><span class="ident" id="3830212">Lock</span><span class="op" id="3830216">(</span><span class="op" id="3830217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3830220">defer</span>&nbsp;<span class="ident" id="3830226"><a href="/net/http/server.go.html#3830178">c</a></span><span class="op" id="3830227">.</span><span class="ident" id="3830228">mu</span><span class="op" id="3830230">.</span><span class="ident" id="3830231">Unlock</span><span class="op" id="3830237">(</span><span class="op" id="3830238">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3830241">if</span>&nbsp;<span class="ident" id="3830244"><a href="/net/http/server.go.html#3830178">c</a></span><span class="op" id="3830245">.</span><span class="ident" id="3830246">closeNotifyc</span>&nbsp;<span class="op" id="3830259">!=</span>&nbsp;<span class="ident" id="3830262">nil</span>&nbsp;<span class="op" id="3830266">&amp;&amp;</span>&nbsp;<span class="op" id="3830269">!</span><span class="ident" id="3830270"><a href="/net/http/server.go.html#3830178">c</a></span><span class="op" id="3830271">.</span><span class="ident" id="3830272">clientGone</span>&nbsp;<span class="op" id="3830283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830287"><a href="/net/http/server.go.html#3830178">c</a></span><span class="op" id="3830288">.</span><span class="ident" id="3830289">closeNotifyc</span>&nbsp;<span class="op" id="3830302">&lt;-</span>&nbsp;<span class="ident" id="3830305">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3830311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830314"><a href="/net/http/server.go.html#3830178">c</a></span><span class="op" id="3830315">.</span><span class="ident" id="3830316">clientGone</span>&nbsp;<span class="op" id="3830327">=</span>&nbsp;<span class="ident" id="3830329">true</span><br>
<span class="lineno"></span><span class="op" id="3830334">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="3830337">//&nbsp;A&nbsp;switchReader&nbsp;can&nbsp;have&nbsp;its&nbsp;Reader&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="3830395">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Reads&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="3830447">type</span>&nbsp;<span class="ident" id="3830452">switchReader</span>&nbsp;<span class="keyword" id="3830465">struct</span>&nbsp;<span class="op" id="3830472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830475"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3830477">.</span><span class="ident" id="3830478">Reader</span><br>
<span class="lineno">195</span><span class="op" id="3830485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3830488">//&nbsp;A&nbsp;switchWriter&nbsp;can&nbsp;have&nbsp;its&nbsp;Writer&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="3830546">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Writes&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="3830599">type</span>&nbsp;<span class="ident" id="3830604">switchWriter</span>&nbsp;<span class="keyword" id="3830617">struct</span>&nbsp;<span class="op" id="3830624">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830627"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3830629">.</span><span class="ident" id="3830630">Writer</span><br>
<span class="lineno"></span><span class="op" id="3830637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3830640">//&nbsp;A&nbsp;liveSwitchReader&nbsp;is&nbsp;a&nbsp;switchReader&nbsp;that&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent</span><br>
<span class="lineno"></span><span class="comment" id="3830707">//&nbsp;reads&nbsp;and&nbsp;switches,&nbsp;if&nbsp;its&nbsp;mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno">205</span><span class="keyword" id="3830752">type</span>&nbsp;<span class="ident" id="3830757">liveSwitchReader</span>&nbsp;<span class="keyword" id="3830774">struct</span>&nbsp;<span class="op" id="3830781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830784"><a href="/net/http/server.go.html#3824875">sync</a></span><span class="op" id="3830788">.</span><span class="ident" id="3830789">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830796">r</span>&nbsp;<span class="ident" id="3830798"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3830800">.</span><span class="ident" id="3830801">Reader</span><br>
<span class="lineno"></span><span class="op" id="3830808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="keyword" id="3830811">func</span>&nbsp;<span class="op" id="3830816">(</span><span class="ident" id="3830817">sr</span>&nbsp;<span class="op" id="3830820">*</span><span class="ident" id="3830821"><a href="/net/http/server.go.html#3830757">liveSwitchReader</a></span><span class="op" id="3830837">)</span>&nbsp;<span class="ident" id="3830839">Read</span><span class="op" id="3830843">(</span><span class="ident" id="3830844">p</span>&nbsp;<span class="op" id="3830846">[</span><span class="op" id="3830847">]</span><span class="builtintype" id="3830848">byte</span><span class="op" id="3830852">)</span>&nbsp;<span class="op" id="3830854">(</span><span class="ident" id="3830855">n</span>&nbsp;<span class="builtintype" id="3830857">int</span><span class="op" id="3830860">,</span>&nbsp;<span class="ident" id="3830862">err</span>&nbsp;<span class="builtintype" id="3830866">error</span><span class="op" id="3830871">)</span>&nbsp;<span class="op" id="3830873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830876"><a href="/net/http/server.go.html#3830817">sr</a></span><span class="op" id="3830878">.</span><span class="ident" id="3830879">Lock</span><span class="op" id="3830883">(</span><span class="op" id="3830884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830887">r</span>&nbsp;<span class="op" id="3830889">:=</span>&nbsp;<span class="ident" id="3830892"><a href="/net/http/server.go.html#3830817">sr</a></span><span class="op" id="3830894">.</span><span class="ident" id="3830895">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3830898"><a href="/net/http/server.go.html#3830817">sr</a></span><span class="op" id="3830900">.</span><span class="ident" id="3830901">Unlock</span><span class="op" id="3830907">(</span><span class="op" id="3830908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3830911">return</span>&nbsp;<span class="ident" id="3830918"><a href="/net/http/server.go.html#3830887">r</a></span><span class="op" id="3830919">.</span><span class="ident" id="3830920">Read</span><span class="op" id="3830924">(</span><span class="ident" id="3830925"><a href="/net/http/server.go.html#3830844">p</a></span><span class="op" id="3830926">)</span><br>
<span class="lineno">215</span><span class="op" id="3830928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3830931">//&nbsp;This&nbsp;should&nbsp;be&nbsp;&gt;=&nbsp;512&nbsp;bytes&nbsp;for&nbsp;DetectContentType,</span><br>
<span class="lineno"></span><span class="comment" id="3830985">//&nbsp;but&nbsp;otherwise&nbsp;it&#39;s&nbsp;somewhat&nbsp;arbitrary.</span><br>
<span class="lineno"></span><span class="keyword" id="3831027">const</span>&nbsp;<span class="ident" id="3831033">bufferBeforeChunkingSize</span>&nbsp;<span class="op" id="3831058">=</span>&nbsp;<span class="num" id="3831060">2048</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="3831066">//&nbsp;chunkWriter&nbsp;writes&nbsp;to&nbsp;a&nbsp;response&#39;s&nbsp;conn&nbsp;buffer,&nbsp;and&nbsp;is&nbsp;the&nbsp;writer</span><br>
<span class="lineno"></span><span class="comment" id="3831135">//&nbsp;wrapped&nbsp;by&nbsp;the&nbsp;response.bufw&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="3831184">//</span><br>
<span class="lineno"></span><span class="comment" id="3831187">//&nbsp;chunkWriter&nbsp;also&nbsp;is&nbsp;responsible&nbsp;for&nbsp;finalizing&nbsp;the&nbsp;Header,&nbsp;including</span><br>
<span class="lineno">225</span><span class="comment" id="3831259">//&nbsp;conditionally&nbsp;setting&nbsp;the&nbsp;Content-Type&nbsp;and&nbsp;setting&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span><span class="comment" id="3831330">//&nbsp;in&nbsp;cases&nbsp;where&nbsp;the&nbsp;handler&#39;s&nbsp;final&nbsp;output&nbsp;is&nbsp;smaller&nbsp;than&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="3831402">//&nbsp;size.&nbsp;It&nbsp;also&nbsp;conditionally&nbsp;adds&nbsp;chunk&nbsp;headers,&nbsp;when&nbsp;in&nbsp;chunking&nbsp;mode.</span><br>
<span class="lineno"></span><span class="comment" id="3831476">//</span><br>
<span class="lineno"></span><span class="comment" id="3831479">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;above&nbsp;(*response).Write&nbsp;for&nbsp;the&nbsp;entire&nbsp;write&nbsp;flow.</span><br>
<span class="lineno">230</span><span class="keyword" id="3831549">type</span>&nbsp;<span class="ident" id="3831554">chunkWriter</span>&nbsp;<span class="keyword" id="3831566">struct</span>&nbsp;<span class="op" id="3831573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3831576">res</span>&nbsp;<span class="op" id="3831580">*</span><span class="ident" id="3831581"><a href="/net/http/server.go.html#3833137">response</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3831592">//&nbsp;header&nbsp;is&nbsp;either&nbsp;nil&nbsp;or&nbsp;a&nbsp;deep&nbsp;clone&nbsp;of&nbsp;res.handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3831654">//&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;res.WriteHeader,&nbsp;if&nbsp;res.WriteHeader&nbsp;is</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3831712">//&nbsp;called&nbsp;and&nbsp;extra&nbsp;buffering&nbsp;is&nbsp;being&nbsp;done&nbsp;to&nbsp;calculate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3831770">//&nbsp;Content-Type&nbsp;and/or&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3831810">header</span>&nbsp;<span class="ident" id="3831817"><a href="/net/http/header.go.html#3781581">Header</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3831826">//&nbsp;wroteHeader&nbsp;tells&nbsp;whether&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;written&nbsp;to&nbsp;&#34;the</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3831890">//&nbsp;wire&#34;&nbsp;(or&nbsp;rather:&nbsp;w.conn.buf).&nbsp;this&nbsp;is&nbsp;unlike</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3831940">//&nbsp;(*response).wroteHeader,&nbsp;which&nbsp;tells&nbsp;only&nbsp;whether&nbsp;it&nbsp;was</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3832001">//&nbsp;logically&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832024">wroteHeader</span>&nbsp;<span class="builtintype" id="3832036">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3832043">//&nbsp;set&nbsp;by&nbsp;the&nbsp;writeHeader&nbsp;method:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832078">chunking</span>&nbsp;<span class="builtintype" id="3832087">bool</span>&nbsp;<span class="comment" id="3832092">//&nbsp;using&nbsp;chunked&nbsp;transfer&nbsp;encoding&nbsp;for&nbsp;reply&nbsp;body</span><br>
<span class="lineno"></span><span class="op" id="3832142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3832145">var</span>&nbsp;<span class="op" id="3832149">(</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832152">crlf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3832163">=</span>&nbsp;<span class="op" id="3832165">[</span><span class="op" id="3832166">]</span><span class="builtintype" id="3832167">byte</span><span class="op" id="3832171">(</span><span class="string" id="3832172">&#34;\r\n&#34;</span><span class="op" id="3832178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832181">colonSpace</span>&nbsp;<span class="op" id="3832192">=</span>&nbsp;<span class="op" id="3832194">[</span><span class="op" id="3832195">]</span><span class="builtintype" id="3832196">byte</span><span class="op" id="3832200">(</span><span class="string" id="3832201">&#34;:&nbsp;&#34;</span><span class="op" id="3832205">)</span><br>
<span class="lineno"></span><span class="op" id="3832207">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3832210">func</span>&nbsp;<span class="op" id="3832215">(</span><span class="ident" id="3832216">cw</span>&nbsp;<span class="op" id="3832219">*</span><span class="ident" id="3832220"><a href="/net/http/server.go.html#3831554">chunkWriter</a></span><span class="op" id="3832231">)</span>&nbsp;<span class="ident" id="3832233">Write</span><span class="op" id="3832238">(</span><span class="ident" id="3832239">p</span>&nbsp;<span class="op" id="3832241">[</span><span class="op" id="3832242">]</span><span class="builtintype" id="3832243">byte</span><span class="op" id="3832247">)</span>&nbsp;<span class="op" id="3832249">(</span><span class="ident" id="3832250">n</span>&nbsp;<span class="builtintype" id="3832252">int</span><span class="op" id="3832255">,</span>&nbsp;<span class="ident" id="3832257">err</span>&nbsp;<span class="builtintype" id="3832261">error</span><span class="op" id="3832266">)</span>&nbsp;<span class="op" id="3832268">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832271">if</span>&nbsp;<span class="op" id="3832274">!</span><span class="ident" id="3832275"><a href="/net/http/server.go.html#3832216">cw</a></span><span class="op" id="3832277">.</span><span class="ident" id="3832278">wroteHeader</span>&nbsp;<span class="op" id="3832290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832294"><a href="/net/http/server.go.html#3832216">cw</a></span><span class="op" id="3832296">.</span><span class="ident" id="3832297">writeHeader</span><span class="op" id="3832308">(</span><span class="ident" id="3832309"><a href="/net/http/server.go.html#3832239">p</a></span><span class="op" id="3832310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832316">if</span>&nbsp;<span class="ident" id="3832319"><a href="/net/http/server.go.html#3832216">cw</a></span><span class="op" id="3832321">.</span><span class="ident" id="3832322">res</span><span class="op" id="3832325">.</span><span class="ident" id="3832326">req</span><span class="op" id="3832329">.</span><span class="ident" id="3832330">Method</span>&nbsp;<span class="op" id="3832337">==</span>&nbsp;<span class="string" id="3832340">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3832347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3832351">//&nbsp;Eat&nbsp;writes.</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832368">return</span>&nbsp;<span class="builtinfunc" id="3832375">len</span><span class="op" id="3832378">(</span><span class="ident" id="3832379"><a href="/net/http/server.go.html#3832239">p</a></span><span class="op" id="3832380">)</span><span class="op" id="3832381">,</span>&nbsp;<span class="ident" id="3832383">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832391">if</span>&nbsp;<span class="ident" id="3832394"><a href="/net/http/server.go.html#3832216">cw</a></span><span class="op" id="3832396">.</span><span class="ident" id="3832397">chunking</span>&nbsp;<span class="op" id="3832406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832410">_</span><span class="op" id="3832411">,</span>&nbsp;<span class="ident" id="3832413"><a href="/net/http/server.go.html#3832257">err</a></span>&nbsp;<span class="op" id="3832417">=</span>&nbsp;<span class="ident" id="3832419"><a href="/net/http/server.go.html#3824777">fmt</a></span><span class="op" id="3832422">.</span><span class="ident" id="3832423">Fprintf</span><span class="op" id="3832430">(</span><span class="ident" id="3832431"><a href="/net/http/server.go.html#3832216">cw</a></span><span class="op" id="3832433">.</span><span class="ident" id="3832434">res</span><span class="op" id="3832437">.</span><span class="ident" id="3832438">conn</span><span class="op" id="3832442">.</span><span class="ident" id="3832443">buf</span><span class="op" id="3832446">,</span>&nbsp;<span class="string" id="3832448">&#34;%x\r\n&#34;</span><span class="op" id="3832456">,</span>&nbsp;<span class="builtinfunc" id="3832458">len</span><span class="op" id="3832461">(</span><span class="ident" id="3832462"><a href="/net/http/server.go.html#3832239">p</a></span><span class="op" id="3832463">)</span><span class="op" id="3832464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832468">if</span>&nbsp;<span class="ident" id="3832471"><a href="/net/http/server.go.html#3832257">err</a></span>&nbsp;<span class="op" id="3832475">!=</span>&nbsp;<span class="ident" id="3832478">nil</span>&nbsp;<span class="op" id="3832482">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832487"><a href="/net/http/server.go.html#3832216">cw</a></span><span class="op" id="3832489">.</span><span class="ident" id="3832490">res</span><span class="op" id="3832493">.</span><span class="ident" id="3832494">conn</span><span class="op" id="3832498">.</span><span class="ident" id="3832499">rwc</span><span class="op" id="3832502">.</span><span class="ident" id="3832503">Close</span><span class="op" id="3832508">(</span><span class="op" id="3832509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832514">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832529"><a href="/net/http/server.go.html#3832250">n</a></span><span class="op" id="3832530">,</span>&nbsp;<span class="ident" id="3832532"><a href="/net/http/server.go.html#3832257">err</a></span>&nbsp;<span class="op" id="3832536">=</span>&nbsp;<span class="ident" id="3832538"><a href="/net/http/server.go.html#3832216">cw</a></span><span class="op" id="3832540">.</span><span class="ident" id="3832541">res</span><span class="op" id="3832544">.</span><span class="ident" id="3832545">conn</span><span class="op" id="3832549">.</span><span class="ident" id="3832550">buf</span><span class="op" id="3832553">.</span><span class="ident" id="3832554">Write</span><span class="op" id="3832559">(</span><span class="ident" id="3832560"><a href="/net/http/server.go.html#3832239">p</a></span><span class="op" id="3832561">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832564">if</span>&nbsp;<span class="ident" id="3832567"><a href="/net/http/server.go.html#3832216">cw</a></span><span class="op" id="3832569">.</span><span class="ident" id="3832570">chunking</span>&nbsp;<span class="op" id="3832579">&amp;&amp;</span>&nbsp;<span class="ident" id="3832582"><a href="/net/http/server.go.html#3832257">err</a></span>&nbsp;<span class="op" id="3832586">==</span>&nbsp;<span class="ident" id="3832589">nil</span>&nbsp;<span class="op" id="3832593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832597">_</span><span class="op" id="3832598">,</span>&nbsp;<span class="ident" id="3832600"><a href="/net/http/server.go.html#3832257">err</a></span>&nbsp;<span class="op" id="3832604">=</span>&nbsp;<span class="ident" id="3832606"><a href="/net/http/server.go.html#3832216">cw</a></span><span class="op" id="3832608">.</span><span class="ident" id="3832609">res</span><span class="op" id="3832612">.</span><span class="ident" id="3832613">conn</span><span class="op" id="3832617">.</span><span class="ident" id="3832618">buf</span><span class="op" id="3832621">.</span><span class="ident" id="3832622">Write</span><span class="op" id="3832627">(</span><span class="ident" id="3832628"><a href="/net/http/server.go.html#3832152">crlf</a></span><span class="op" id="3832632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832638">if</span>&nbsp;<span class="ident" id="3832641"><a href="/net/http/server.go.html#3832257">err</a></span>&nbsp;<span class="op" id="3832645">!=</span>&nbsp;<span class="ident" id="3832648">nil</span>&nbsp;<span class="op" id="3832652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832656"><a href="/net/http/server.go.html#3832216">cw</a></span><span class="op" id="3832658">.</span><span class="ident" id="3832659">res</span><span class="op" id="3832662">.</span><span class="ident" id="3832663">conn</span><span class="op" id="3832667">.</span><span class="ident" id="3832668">rwc</span><span class="op" id="3832671">.</span><span class="ident" id="3832672">Close</span><span class="op" id="3832677">(</span><span class="op" id="3832678">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832684">return</span><br>
<span class="lineno"></span><span class="op" id="3832691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3832694">func</span>&nbsp;<span class="op" id="3832699">(</span><span class="ident" id="3832700">cw</span>&nbsp;<span class="op" id="3832703">*</span><span class="ident" id="3832704"><a href="/net/http/server.go.html#3831554">chunkWriter</a></span><span class="op" id="3832715">)</span>&nbsp;<span class="ident" id="3832717">flush</span><span class="op" id="3832722">(</span><span class="op" id="3832723">)</span>&nbsp;<span class="op" id="3832725">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832728">if</span>&nbsp;<span class="op" id="3832731">!</span><span class="ident" id="3832732"><a href="/net/http/server.go.html#3832700">cw</a></span><span class="op" id="3832734">.</span><span class="ident" id="3832735">wroteHeader</span>&nbsp;<span class="op" id="3832747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832751"><a href="/net/http/server.go.html#3832700">cw</a></span><span class="op" id="3832753">.</span><span class="ident" id="3832754">writeHeader</span><span class="op" id="3832765">(</span><span class="ident" id="3832766">nil</span><span class="op" id="3832769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832775"><a href="/net/http/server.go.html#3832700">cw</a></span><span class="op" id="3832777">.</span><span class="ident" id="3832778">res</span><span class="op" id="3832781">.</span><span class="ident" id="3832782">conn</span><span class="op" id="3832786">.</span><span class="ident" id="3832787">buf</span><span class="op" id="3832790">.</span><span class="ident" id="3832791">Flush</span><span class="op" id="3832796">(</span><span class="op" id="3832797">)</span><br>
<span class="lineno"></span><span class="op" id="3832799">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="3832802">func</span>&nbsp;<span class="op" id="3832807">(</span><span class="ident" id="3832808">cw</span>&nbsp;<span class="op" id="3832811">*</span><span class="ident" id="3832812"><a href="/net/http/server.go.html#3831554">chunkWriter</a></span><span class="op" id="3832823">)</span>&nbsp;<span class="builtinfunc" id="3832825">close</span><span class="op" id="3832830">(</span><span class="op" id="3832831">)</span>&nbsp;<span class="op" id="3832833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832836">if</span>&nbsp;<span class="op" id="3832839">!</span><span class="ident" id="3832840"><a href="/net/http/server.go.html#3832808">cw</a></span><span class="op" id="3832842">.</span><span class="ident" id="3832843">wroteHeader</span>&nbsp;<span class="op" id="3832855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3832859"><a href="/net/http/server.go.html#3832808">cw</a></span><span class="op" id="3832861">.</span><span class="ident" id="3832862">writeHeader</span><span class="op" id="3832873">(</span><span class="ident" id="3832874">nil</span><span class="op" id="3832877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3832880">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3832883">if</span>&nbsp;<span class="ident" id="3832886"><a href="/net/http/server.go.html#3832808">cw</a></span><span class="op" id="3832888">.</span><span class="ident" id="3832889">chunking</span>&nbsp;<span class="op" id="3832898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3832902">//&nbsp;zero&nbsp;EOF&nbsp;chunk,&nbsp;trailer&nbsp;key/value&nbsp;pairs&nbsp;(currently</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3832958">//&nbsp;unsupported&nbsp;in&nbsp;Go&#39;s&nbsp;server),&nbsp;followed&nbsp;by&nbsp;a&nbsp;blank</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3833012">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833023"><a href="/net/http/server.go.html#3832808">cw</a></span><span class="op" id="3833025">.</span><span class="ident" id="3833026">res</span><span class="op" id="3833029">.</span><span class="ident" id="3833030">conn</span><span class="op" id="3833034">.</span><span class="ident" id="3833035">buf</span><span class="op" id="3833038">.</span><span class="ident" id="3833039">WriteString</span><span class="op" id="3833050">(</span><span class="string" id="3833051">&#34;0\r\n\r\n&#34;</span><span class="op" id="3833062">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3833065">}</span><br>
<span class="lineno"></span><span class="op" id="3833067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3833070">//&nbsp;A&nbsp;response&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3833132">type</span>&nbsp;<span class="ident" id="3833137">response</span>&nbsp;<span class="keyword" id="3833146">struct</span>&nbsp;<span class="op" id="3833153">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833156">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3833170">*</span><span class="ident" id="3833171"><a href="/net/http/server.go.html#3828256">conn</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833177">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3833191">*</span><span class="ident" id="3833192"><a href="/net/http/request.go.html#3791418">Request</a></span>&nbsp;<span class="comment" id="3833200">//&nbsp;request&nbsp;for&nbsp;this&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833230">wroteHeader</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3833244">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3833253">//&nbsp;reply&nbsp;header&nbsp;has&nbsp;been&nbsp;(logically)&nbsp;written</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833299">wroteContinue</span>&nbsp;<span class="builtintype" id="3833313">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3833322">//&nbsp;100&nbsp;Continue&nbsp;response&nbsp;was&nbsp;written</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833361">w</span>&nbsp;&nbsp;<span class="op" id="3833364">*</span><span class="ident" id="3833365"><a href="/net/http/server.go.html#3824744">bufio</a></span><span class="op" id="3833370">.</span><span class="ident" id="3833371">Writer</span>&nbsp;<span class="comment" id="3833378">//&nbsp;buffers&nbsp;output&nbsp;in&nbsp;chunks&nbsp;to&nbsp;chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833422">cw</span>&nbsp;<span class="ident" id="3833425"><a href="/net/http/server.go.html#3831554">chunkWriter</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833438">sw</span>&nbsp;<span class="op" id="3833441">*</span><span class="ident" id="3833442"><a href="/net/http/server.go.html#3830604">switchWriter</a></span>&nbsp;<span class="comment" id="3833455">//&nbsp;of&nbsp;the&nbsp;bufio.Writer,&nbsp;for&nbsp;return&nbsp;to&nbsp;putBufioWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3833510">//&nbsp;handlerHeader&nbsp;is&nbsp;the&nbsp;Header&nbsp;that&nbsp;Handlers&nbsp;get&nbsp;access&nbsp;to,</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3833571">//&nbsp;which&nbsp;may&nbsp;be&nbsp;retained&nbsp;and&nbsp;mutated&nbsp;even&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3833633">//&nbsp;handlerHeader&nbsp;is&nbsp;copied&nbsp;into&nbsp;cw.header&nbsp;at&nbsp;WriteHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3833691">//&nbsp;time,&nbsp;and&nbsp;privately&nbsp;mutated&nbsp;thereafter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833735">handlerHeader</span>&nbsp;<span class="ident" id="3833749"><a href="/net/http/header.go.html#3781581">Header</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833757">calledHeader</span>&nbsp;&nbsp;<span class="builtintype" id="3833771">bool</span>&nbsp;<span class="comment" id="3833776">//&nbsp;handler&nbsp;accessed&nbsp;handlerHeader&nbsp;via&nbsp;Header</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833823">written</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3833837">int64</span>&nbsp;<span class="comment" id="3833843">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;in&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833879">contentLength</span>&nbsp;<span class="ident" id="3833893">int64</span>&nbsp;<span class="comment" id="3833899">//&nbsp;explicitly-declared&nbsp;Content-Length;&nbsp;or&nbsp;-1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3833945">status</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3833959">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3833965">//&nbsp;status&nbsp;code&nbsp;passed&nbsp;to&nbsp;WriteHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834004">//&nbsp;close&nbsp;connection&nbsp;after&nbsp;this&nbsp;reply.&nbsp;&nbsp;set&nbsp;on&nbsp;request&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834063">//&nbsp;updated&nbsp;after&nbsp;response&nbsp;from&nbsp;handler&nbsp;if&nbsp;there&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834116">//&nbsp;&#34;Connection:&nbsp;keep-alive&#34;&nbsp;response&nbsp;header&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834167">//&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834187">closeAfterReply</span>&nbsp;<span class="builtintype" id="3834203">bool</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834210">//&nbsp;requestBodyLimitHit&nbsp;is&nbsp;set&nbsp;by&nbsp;requestTooLarge&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834265">//&nbsp;maxBytesReader&nbsp;hits&nbsp;its&nbsp;max&nbsp;size.&nbsp;It&nbsp;is&nbsp;checked&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834320">//&nbsp;WriteHeader,&nbsp;to&nbsp;make&nbsp;sure&nbsp;we&nbsp;don&#39;t&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834371">//&nbsp;remaining&nbsp;request&nbsp;body&nbsp;to&nbsp;try&nbsp;to&nbsp;advance&nbsp;to&nbsp;the&nbsp;next&nbsp;HTTP</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834433">//&nbsp;request.&nbsp;Instead,&nbsp;when&nbsp;this&nbsp;is&nbsp;set,&nbsp;we&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834489">//&nbsp;subsequent&nbsp;requests&nbsp;on&nbsp;this&nbsp;connection&nbsp;and&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834549">//&nbsp;input&nbsp;from&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834568">requestBodyLimitHit</span>&nbsp;<span class="builtintype" id="3834588">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834595">handlerDone</span>&nbsp;<span class="builtintype" id="3834607">bool</span>&nbsp;<span class="comment" id="3834612">//&nbsp;set&nbsp;true&nbsp;when&nbsp;the&nbsp;handler&nbsp;exits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3834649">//&nbsp;Buffers&nbsp;for&nbsp;Date&nbsp;and&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834689">dateBuf</span>&nbsp;<span class="op" id="3834697">[</span><span class="builtinfunc" id="3834698">len</span><span class="op" id="3834701">(</span><span class="ident" id="3834702"><a href="/net/http/server.go.html#3839717">TimeFormat</a></span><span class="op" id="3834712">)</span><span class="op" id="3834713">]</span><span class="builtintype" id="3834714">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834720">clenBuf</span>&nbsp;<span class="op" id="3834728">[</span><span class="num" id="3834729">10</span><span class="op" id="3834731">]</span><span class="builtintype" id="3834732">byte</span><br>
<span class="lineno">340</span><span class="op" id="3834737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3834740">//&nbsp;requestTooLarge&nbsp;is&nbsp;called&nbsp;by&nbsp;maxBytesReader&nbsp;when&nbsp;too&nbsp;much&nbsp;input&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="3834811">//&nbsp;been&nbsp;read&nbsp;from&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="3834841">func</span>&nbsp;<span class="op" id="3834846">(</span><span class="ident" id="3834847">w</span>&nbsp;<span class="op" id="3834849">*</span><span class="ident" id="3834850"><a href="/net/http/server.go.html#3833137">response</a></span><span class="op" id="3834858">)</span>&nbsp;<span class="ident" id="3834860">requestTooLarge</span><span class="op" id="3834875">(</span><span class="op" id="3834876">)</span>&nbsp;<span class="op" id="3834878">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834881"><a href="/net/http/server.go.html#3834847">w</a></span><span class="op" id="3834882">.</span><span class="ident" id="3834883">closeAfterReply</span>&nbsp;<span class="op" id="3834899">=</span>&nbsp;<span class="ident" id="3834901">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834907"><a href="/net/http/server.go.html#3834847">w</a></span><span class="op" id="3834908">.</span><span class="ident" id="3834909">requestBodyLimitHit</span>&nbsp;<span class="op" id="3834929">=</span>&nbsp;<span class="ident" id="3834931">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3834937">if</span>&nbsp;<span class="op" id="3834940">!</span><span class="ident" id="3834941"><a href="/net/http/server.go.html#3834847">w</a></span><span class="op" id="3834942">.</span><span class="ident" id="3834943">wroteHeader</span>&nbsp;<span class="op" id="3834955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834959"><a href="/net/http/server.go.html#3834847">w</a></span><span class="op" id="3834960">.</span><span class="ident" id="3834961">Header</span><span class="op" id="3834967">(</span><span class="op" id="3834968">)</span><span class="op" id="3834969">.</span><span class="ident" id="3834970">Set</span><span class="op" id="3834973">(</span><span class="string" id="3834974">&#34;Connection&#34;</span><span class="op" id="3834986">,</span>&nbsp;<span class="string" id="3834988">&#34;close&#34;</span><span class="op" id="3834995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3834998">}</span><br>
<span class="lineno">350</span><span class="op" id="3835000">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3835003">//&nbsp;needsSniff&nbsp;reports&nbsp;whether&nbsp;a&nbsp;Content-Type&nbsp;still&nbsp;needs&nbsp;to&nbsp;be&nbsp;sniffed.</span><br>
<span class="lineno"></span><span class="keyword" id="3835075">func</span>&nbsp;<span class="op" id="3835080">(</span><span class="ident" id="3835081">w</span>&nbsp;<span class="op" id="3835083">*</span><span class="ident" id="3835084"><a href="/net/http/server.go.html#3833137">response</a></span><span class="op" id="3835092">)</span>&nbsp;<span class="ident" id="3835094">needsSniff</span><span class="op" id="3835104">(</span><span class="op" id="3835105">)</span>&nbsp;<span class="builtintype" id="3835107">bool</span>&nbsp;<span class="op" id="3835112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835115">_</span><span class="op" id="3835116">,</span>&nbsp;<span class="ident" id="3835118">haveType</span>&nbsp;<span class="op" id="3835127">:=</span>&nbsp;<span class="ident" id="3835130"><a href="/net/http/server.go.html#3835081">w</a></span><span class="op" id="3835131">.</span><span class="ident" id="3835132">handlerHeader</span><span class="op" id="3835145">[</span><span class="string" id="3835146">&#34;Content-Type&#34;</span><span class="op" id="3835160">]</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835163">return</span>&nbsp;<span class="op" id="3835170">!</span><span class="ident" id="3835171"><a href="/net/http/server.go.html#3835081">w</a></span><span class="op" id="3835172">.</span><span class="ident" id="3835173">cw</span><span class="op" id="3835175">.</span><span class="ident" id="3835176">wroteHeader</span>&nbsp;<span class="op" id="3835188">&amp;&amp;</span>&nbsp;<span class="op" id="3835191">!</span><span class="ident" id="3835192"><a href="/net/http/server.go.html#3835118">haveType</a></span>&nbsp;<span class="op" id="3835201">&amp;&amp;</span>&nbsp;<span class="ident" id="3835204"><a href="/net/http/server.go.html#3835081">w</a></span><span class="op" id="3835205">.</span><span class="ident" id="3835206">written</span>&nbsp;<span class="op" id="3835214">&lt;</span>&nbsp;<span class="ident" id="3835216"><a href="/net/http/sniff.go.html#3886376">sniffLen</a></span><br>
<span class="lineno"></span><span class="op" id="3835225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3835228">//&nbsp;writerOnly&nbsp;hides&nbsp;an&nbsp;io.Writer&nbsp;value&#39;s&nbsp;optional&nbsp;ReadFrom&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="3835294">//&nbsp;from&nbsp;io.Copy.</span><br>
<span class="lineno">360</span><span class="keyword" id="3835311">type</span>&nbsp;<span class="ident" id="3835316">writerOnly</span>&nbsp;<span class="keyword" id="3835327">struct</span>&nbsp;<span class="op" id="3835334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835337"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3835339">.</span><span class="ident" id="3835340">Writer</span><br>
<span class="lineno"></span><span class="op" id="3835347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3835350">func</span>&nbsp;<span class="ident" id="3835355">srcIsRegularFile</span><span class="op" id="3835371">(</span><span class="ident" id="3835372">src</span>&nbsp;<span class="ident" id="3835376"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3835378">.</span><span class="ident" id="3835379">Reader</span><span class="op" id="3835385">)</span>&nbsp;<span class="op" id="3835387">(</span><span class="ident" id="3835388">isRegular</span>&nbsp;<span class="builtintype" id="3835398">bool</span><span class="op" id="3835402">,</span>&nbsp;<span class="ident" id="3835404">err</span>&nbsp;<span class="builtintype" id="3835408">error</span><span class="op" id="3835413">)</span>&nbsp;<span class="op" id="3835415">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835418">switch</span>&nbsp;<span class="ident" id="3835425">v</span>&nbsp;<span class="op" id="3835427">:=</span>&nbsp;<span class="ident" id="3835430"><a href="/net/http/server.go.html#3835372">src</a></span><span class="op" id="3835433">.</span><span class="op" id="3835434">(</span><span class="keyword" id="3835435">type</span><span class="op" id="3835439">)</span>&nbsp;<span class="op" id="3835441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835444">case</span>&nbsp;<span class="op" id="3835449">*</span><span class="ident" id="3835450"><a href="/net/http/server.go.html#3824828">os</a></span><span class="op" id="3835452">.</span><span class="ident" id="3835453">File</span><span class="op" id="3835457">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835461">fi</span><span class="op" id="3835463">,</span>&nbsp;<span class="ident" id="3835465">err</span>&nbsp;<span class="op" id="3835469">:=</span>&nbsp;<span class="ident" id="3835472"><a href="/net/http/server.go.html#3835425">v</a></span><span class="op" id="3835473">.</span><span class="ident" id="3835474">Stat</span><span class="op" id="3835478">(</span><span class="op" id="3835479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835483">if</span>&nbsp;<span class="ident" id="3835486"><a href="/net/http/server.go.html#3835465">err</a></span>&nbsp;<span class="op" id="3835490">!=</span>&nbsp;<span class="ident" id="3835493">nil</span>&nbsp;<span class="op" id="3835497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835502">return</span>&nbsp;<span class="ident" id="3835509">false</span><span class="op" id="3835514">,</span>&nbsp;<span class="ident" id="3835516"><a href="/net/http/server.go.html#3835465">err</a></span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3835522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835526">return</span>&nbsp;<span class="ident" id="3835533"><a href="/net/http/server.go.html#3835461">fi</a></span><span class="op" id="3835535">.</span><span class="ident" id="3835536">Mode</span><span class="op" id="3835540">(</span><span class="op" id="3835541">)</span><span class="op" id="3835542">.</span><span class="ident" id="3835543">IsRegular</span><span class="op" id="3835552">(</span><span class="op" id="3835553">)</span><span class="op" id="3835554">,</span>&nbsp;<span class="ident" id="3835556">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835561">case</span>&nbsp;<span class="op" id="3835566">*</span><span class="ident" id="3835567"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3835569">.</span><span class="ident" id="3835570">LimitedReader</span><span class="op" id="3835583">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835587">return</span>&nbsp;<span class="ident" id="3835594"><a href="/net/http/server.go.html#3835355">srcIsRegularFile</a></span><span class="op" id="3835610">(</span><span class="ident" id="3835611"><a href="/net/http/server.go.html#3835425">v</a></span><span class="op" id="3835612">.</span><span class="ident" id="3835613">R</span><span class="op" id="3835614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835617">default</span><span class="op" id="3835624">:</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835628">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3835636">}</span><br>
<span class="lineno"></span><span class="op" id="3835638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3835641">//&nbsp;ReadFrom&nbsp;is&nbsp;here&nbsp;to&nbsp;optimize&nbsp;copying&nbsp;from&nbsp;an&nbsp;*os.File&nbsp;regular&nbsp;file</span><br>
<span class="lineno">380</span><span class="comment" id="3835711">//&nbsp;to&nbsp;a&nbsp;*net.TCPConn&nbsp;with&nbsp;sendfile.</span><br>
<span class="lineno"></span><span class="keyword" id="3835747">func</span>&nbsp;<span class="op" id="3835752">(</span><span class="ident" id="3835753">w</span>&nbsp;<span class="op" id="3835755">*</span><span class="ident" id="3835756"><a href="/net/http/server.go.html#3833137">response</a></span><span class="op" id="3835764">)</span>&nbsp;<span class="ident" id="3835766">ReadFrom</span><span class="op" id="3835774">(</span><span class="ident" id="3835775">src</span>&nbsp;<span class="ident" id="3835779"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3835781">.</span><span class="ident" id="3835782">Reader</span><span class="op" id="3835788">)</span>&nbsp;<span class="op" id="3835790">(</span><span class="ident" id="3835791">n</span>&nbsp;<span class="ident" id="3835793">int64</span><span class="op" id="3835798">,</span>&nbsp;<span class="ident" id="3835800">err</span>&nbsp;<span class="builtintype" id="3835804">error</span><span class="op" id="3835809">)</span>&nbsp;<span class="op" id="3835811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3835814">//&nbsp;Our&nbsp;underlying&nbsp;w.conn.rwc&nbsp;is&nbsp;usually&nbsp;a&nbsp;*TCPConn&nbsp;(with&nbsp;its</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3835876">//&nbsp;own&nbsp;ReadFrom&nbsp;method).&nbsp;If&nbsp;not,&nbsp;or&nbsp;if&nbsp;our&nbsp;src&nbsp;isn&#39;t&nbsp;a&nbsp;regular</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3835940">//&nbsp;file,&nbsp;just&nbsp;fall&nbsp;back&nbsp;to&nbsp;the&nbsp;normal&nbsp;copy&nbsp;method.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835992">rf</span><span class="op" id="3835994">,</span>&nbsp;<span class="ident" id="3835996">ok</span>&nbsp;<span class="op" id="3835999">:=</span>&nbsp;<span class="ident" id="3836002"><a href="/net/http/server.go.html#3835753">w</a></span><span class="op" id="3836003">.</span><span class="ident" id="3836004">conn</span><span class="op" id="3836008">.</span><span class="ident" id="3836009">rwc</span><span class="op" id="3836012">.</span><span class="op" id="3836013">(</span><span class="ident" id="3836014"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3836016">.</span><span class="ident" id="3836017">ReaderFrom</span><span class="op" id="3836027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836030">regFile</span><span class="op" id="3836037">,</span>&nbsp;<span class="ident" id="3836039"><a href="/net/http/server.go.html#3835800">err</a></span>&nbsp;<span class="op" id="3836043">:=</span>&nbsp;<span class="ident" id="3836046"><a href="/net/http/server.go.html#3835355">srcIsRegularFile</a></span><span class="op" id="3836062">(</span><span class="ident" id="3836063"><a href="/net/http/server.go.html#3835775">src</a></span><span class="op" id="3836066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836069">if</span>&nbsp;<span class="ident" id="3836072"><a href="/net/http/server.go.html#3835800">err</a></span>&nbsp;<span class="op" id="3836076">!=</span>&nbsp;<span class="ident" id="3836079">nil</span>&nbsp;<span class="op" id="3836083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836087">return</span>&nbsp;<span class="num" id="3836094">0</span><span class="op" id="3836095">,</span>&nbsp;<span class="ident" id="3836097"><a href="/net/http/server.go.html#3835800">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3836102">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836105">if</span>&nbsp;<span class="op" id="3836108">!</span><span class="ident" id="3836109"><a href="/net/http/server.go.html#3835996">ok</a></span>&nbsp;<span class="op" id="3836112">||</span>&nbsp;<span class="op" id="3836115">!</span><span class="ident" id="3836116"><a href="/net/http/server.go.html#3836030">regFile</a></span>&nbsp;<span class="op" id="3836124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836128">return</span>&nbsp;<span class="ident" id="3836135"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3836137">.</span><span class="ident" id="3836138">Copy</span><span class="op" id="3836142">(</span><span class="ident" id="3836143"><a href="/net/http/server.go.html#3835316">writerOnly</a></span><span class="op" id="3836153">{</span><span class="ident" id="3836154"><a href="/net/http/server.go.html#3835753">w</a></span><span class="op" id="3836155">}</span><span class="op" id="3836156">,</span>&nbsp;<span class="ident" id="3836158"><a href="/net/http/server.go.html#3835775">src</a></span><span class="op" id="3836161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3836164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3836168">//&nbsp;sendfile&nbsp;path:</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836188">if</span>&nbsp;<span class="op" id="3836191">!</span><span class="ident" id="3836192"><a href="/net/http/server.go.html#3835753">w</a></span><span class="op" id="3836193">.</span><span class="ident" id="3836194">wroteHeader</span>&nbsp;<span class="op" id="3836206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836210"><a href="/net/http/server.go.html#3835753">w</a></span><span class="op" id="3836211">.</span><span class="ident" id="3836212">WriteHeader</span><span class="op" id="3836223">(</span><span class="ident" id="3836224"><a href="/net/http/status.go.html#3891674">StatusOK</a></span><span class="op" id="3836232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3836235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836239">if</span>&nbsp;<span class="ident" id="3836242"><a href="/net/http/server.go.html#3835753">w</a></span><span class="op" id="3836243">.</span><span class="ident" id="3836244">needsSniff</span><span class="op" id="3836254">(</span><span class="op" id="3836255">)</span>&nbsp;<span class="op" id="3836257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836261">n0</span><span class="op" id="3836263">,</span>&nbsp;<span class="ident" id="3836265">err</span>&nbsp;<span class="op" id="3836269">:=</span>&nbsp;<span class="ident" id="3836272"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3836274">.</span><span class="ident" id="3836275">Copy</span><span class="op" id="3836279">(</span><span class="ident" id="3836280"><a href="/net/http/server.go.html#3835316">writerOnly</a></span><span class="op" id="3836290">{</span><span class="ident" id="3836291"><a href="/net/http/server.go.html#3835753">w</a></span><span class="op" id="3836292">}</span><span class="op" id="3836293">,</span>&nbsp;<span class="ident" id="3836295"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3836297">.</span><span class="ident" id="3836298">LimitReader</span><span class="op" id="3836309">(</span><span class="ident" id="3836310"><a href="/net/http/server.go.html#3835775">src</a></span><span class="op" id="3836313">,</span>&nbsp;<span class="ident" id="3836315"><a href="/net/http/sniff.go.html#3886376">sniffLen</a></span><span class="op" id="3836323">)</span><span class="op" id="3836324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836328"><a href="/net/http/server.go.html#3835791">n</a></span>&nbsp;<span class="op" id="3836330">+=</span>&nbsp;<span class="ident" id="3836333"><a href="/net/http/server.go.html#3836261">n0</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836338">if</span>&nbsp;<span class="ident" id="3836341"><a href="/net/http/server.go.html#3836265">err</a></span>&nbsp;<span class="op" id="3836345">!=</span>&nbsp;<span class="ident" id="3836348">nil</span>&nbsp;<span class="op" id="3836352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836357">return</span>&nbsp;<span class="ident" id="3836364"><a href="/net/http/server.go.html#3835791">n</a></span><span class="op" id="3836365">,</span>&nbsp;<span class="ident" id="3836367"><a href="/net/http/server.go.html#3836265">err</a></span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3836373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3836376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836380"><a href="/net/http/server.go.html#3835753">w</a></span><span class="op" id="3836381">.</span><span class="ident" id="3836382">w</span><span class="op" id="3836383">.</span><span class="ident" id="3836384">Flush</span><span class="op" id="3836389">(</span><span class="op" id="3836390">)</span>&nbsp;&nbsp;<span class="comment" id="3836393">//&nbsp;get&nbsp;rid&nbsp;of&nbsp;any&nbsp;previous&nbsp;writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836428"><a href="/net/http/server.go.html#3835753">w</a></span><span class="op" id="3836429">.</span><span class="ident" id="3836430">cw</span><span class="op" id="3836432">.</span><span class="ident" id="3836433">flush</span><span class="op" id="3836438">(</span><span class="op" id="3836439">)</span>&nbsp;<span class="comment" id="3836441">//&nbsp;make&nbsp;sure&nbsp;Header&nbsp;is&nbsp;written;&nbsp;flush&nbsp;data&nbsp;to&nbsp;rwc</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3836493">//&nbsp;Now&nbsp;that&nbsp;cw&nbsp;has&nbsp;been&nbsp;flushed,&nbsp;its&nbsp;chunking&nbsp;field&nbsp;is&nbsp;guaranteed&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836573">if</span>&nbsp;<span class="op" id="3836576">!</span><span class="ident" id="3836577"><a href="/net/http/server.go.html#3835753">w</a></span><span class="op" id="3836578">.</span><span class="ident" id="3836579">cw</span><span class="op" id="3836581">.</span><span class="ident" id="3836582">chunking</span>&nbsp;<span class="op" id="3836591">&amp;&amp;</span>&nbsp;<span class="ident" id="3836594"><a href="/net/http/server.go.html#3835753">w</a></span><span class="op" id="3836595">.</span><span class="ident" id="3836596">bodyAllowed</span><span class="op" id="3836607">(</span><span class="op" id="3836608">)</span>&nbsp;<span class="op" id="3836610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836614">n0</span><span class="op" id="3836616">,</span>&nbsp;<span class="ident" id="3836618">err</span>&nbsp;<span class="op" id="3836622">:=</span>&nbsp;<span class="ident" id="3836625"><a href="/net/http/server.go.html#3835992">rf</a></span><span class="op" id="3836627">.</span><span class="ident" id="3836628">ReadFrom</span><span class="op" id="3836636">(</span><span class="ident" id="3836637"><a href="/net/http/server.go.html#3835775">src</a></span><span class="op" id="3836640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836644"><a href="/net/http/server.go.html#3835791">n</a></span>&nbsp;<span class="op" id="3836646">+=</span>&nbsp;<span class="ident" id="3836649"><a href="/net/http/server.go.html#3836614">n0</a></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836654"><a href="/net/http/server.go.html#3835753">w</a></span><span class="op" id="3836655">.</span><span class="ident" id="3836656">written</span>&nbsp;<span class="op" id="3836664">+=</span>&nbsp;<span class="ident" id="3836667"><a href="/net/http/server.go.html#3836614">n0</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836672">return</span>&nbsp;<span class="ident" id="3836679"><a href="/net/http/server.go.html#3835791">n</a></span><span class="op" id="3836680">,</span>&nbsp;<span class="ident" id="3836682"><a href="/net/http/server.go.html#3836618">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3836687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836691">n0</span><span class="op" id="3836693">,</span>&nbsp;<span class="ident" id="3836695"><a href="/net/http/server.go.html#3835800">err</a></span>&nbsp;<span class="op" id="3836699">:=</span>&nbsp;<span class="ident" id="3836702"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3836704">.</span><span class="ident" id="3836705">Copy</span><span class="op" id="3836709">(</span><span class="ident" id="3836710"><a href="/net/http/server.go.html#3835316">writerOnly</a></span><span class="op" id="3836720">{</span><span class="ident" id="3836721"><a href="/net/http/server.go.html#3835753">w</a></span><span class="op" id="3836722">}</span><span class="op" id="3836723">,</span>&nbsp;<span class="ident" id="3836725"><a href="/net/http/server.go.html#3835775">src</a></span><span class="op" id="3836728">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836731"><a href="/net/http/server.go.html#3835791">n</a></span>&nbsp;<span class="op" id="3836733">+=</span>&nbsp;<span class="ident" id="3836736"><a href="/net/http/server.go.html#3836691">n0</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836740">return</span>&nbsp;<span class="ident" id="3836747"><a href="/net/http/server.go.html#3835791">n</a></span><span class="op" id="3836748">,</span>&nbsp;<span class="ident" id="3836750"><a href="/net/http/server.go.html#3835800">err</a></span><br>
<span class="lineno"></span><span class="op" id="3836754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3836757">//&nbsp;noLimit&nbsp;is&nbsp;an&nbsp;effective&nbsp;infinite&nbsp;upper&nbsp;bound&nbsp;for&nbsp;io.LimitedReader</span><br>
<span class="lineno">425</span><span class="keyword" id="3836826">const</span>&nbsp;<span class="ident" id="3836832">noLimit</span>&nbsp;<span class="ident" id="3836840">int64</span>&nbsp;<span class="op" id="3836846">=</span>&nbsp;<span class="op" id="3836848">(</span><span class="num" id="3836849">1</span>&nbsp;<span class="op" id="3836851">&lt;&lt;</span>&nbsp;<span class="num" id="3836854">63</span><span class="op" id="3836856">)</span>&nbsp;<span class="op" id="3836858">-</span>&nbsp;<span class="num" id="3836860">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3836863">//&nbsp;debugServerConnections&nbsp;controls&nbsp;whether&nbsp;all&nbsp;server&nbsp;connections&nbsp;are&nbsp;wrapped</span><br>
<span class="lineno"></span><span class="comment" id="3836941">//&nbsp;with&nbsp;a&nbsp;verbose&nbsp;logging&nbsp;wrapper.</span><br>
<span class="lineno"></span><span class="keyword" id="3836976">const</span>&nbsp;<span class="ident" id="3836982">debugServerConnections</span>&nbsp;<span class="op" id="3837005">=</span>&nbsp;<span class="ident" id="3837007">false</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="comment" id="3837014">//&nbsp;Create&nbsp;new&nbsp;connection&nbsp;from&nbsp;rwc.</span><br>
<span class="lineno"></span><span class="keyword" id="3837049">func</span>&nbsp;<span class="op" id="3837054">(</span><span class="ident" id="3837055">srv</span>&nbsp;<span class="op" id="3837059">*</span><span class="ident" id="3837060"><a href="/net/http/server.go.html#3872025">Server</a></span><span class="op" id="3837066">)</span>&nbsp;<span class="ident" id="3837068">newConn</span><span class="op" id="3837075">(</span><span class="ident" id="3837076">rwc</span>&nbsp;<span class="ident" id="3837080"><a href="/net/http/server.go.html#3824810">net</a></span><span class="op" id="3837083">.</span><span class="ident" id="3837084">Conn</span><span class="op" id="3837088">)</span>&nbsp;<span class="op" id="3837090">(</span><span class="ident" id="3837091">c</span>&nbsp;<span class="op" id="3837093">*</span><span class="ident" id="3837094"><a href="/net/http/server.go.html#3828256">conn</a></span><span class="op" id="3837098">,</span>&nbsp;<span class="ident" id="3837100">err</span>&nbsp;<span class="builtintype" id="3837104">error</span><span class="op" id="3837109">)</span>&nbsp;<span class="op" id="3837111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837114"><a href="/net/http/server.go.html#3837091">c</a></span>&nbsp;<span class="op" id="3837116">=</span>&nbsp;<span class="builtinfunc" id="3837118">new</span><span class="op" id="3837121">(</span><span class="ident" id="3837122"><a href="/net/http/server.go.html#3828256">conn</a></span><span class="op" id="3837126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837129"><a href="/net/http/server.go.html#3837091">c</a></span><span class="op" id="3837130">.</span><span class="ident" id="3837131">remoteAddr</span>&nbsp;<span class="op" id="3837142">=</span>&nbsp;<span class="ident" id="3837144"><a href="/net/http/server.go.html#3837076">rwc</a></span><span class="op" id="3837147">.</span><span class="ident" id="3837148">RemoteAddr</span><span class="op" id="3837158">(</span><span class="op" id="3837159">)</span><span class="op" id="3837160">.</span><span class="ident" id="3837161">String</span><span class="op" id="3837167">(</span><span class="op" id="3837168">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837171"><a href="/net/http/server.go.html#3837091">c</a></span><span class="op" id="3837172">.</span><span class="ident" id="3837173">server</span>&nbsp;<span class="op" id="3837180">=</span>&nbsp;<span class="ident" id="3837182"><a href="/net/http/server.go.html#3837055">srv</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837187"><a href="/net/http/server.go.html#3837091">c</a></span><span class="op" id="3837188">.</span><span class="ident" id="3837189">rwc</span>&nbsp;<span class="op" id="3837193">=</span>&nbsp;<span class="ident" id="3837195"><a href="/net/http/server.go.html#3837076">rwc</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837200"><a href="/net/http/server.go.html#3837091">c</a></span><span class="op" id="3837201">.</span><span class="ident" id="3837202">w</span>&nbsp;<span class="op" id="3837204">=</span>&nbsp;<span class="ident" id="3837206"><a href="/net/http/server.go.html#3837076">rwc</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837211">if</span>&nbsp;<span class="ident" id="3837214"><a href="/net/http/server.go.html#3836982">debugServerConnections</a></span>&nbsp;<span class="op" id="3837237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837241"><a href="/net/http/server.go.html#3837091">c</a></span><span class="op" id="3837242">.</span><span class="ident" id="3837243">rwc</span>&nbsp;<span class="op" id="3837247">=</span>&nbsp;<span class="ident" id="3837249"><a href="/net/http/server.go.html#3884816">newLoggingConn</a></span><span class="op" id="3837263">(</span><span class="string" id="3837264">&#34;server&#34;</span><span class="op" id="3837272">,</span>&nbsp;<span class="ident" id="3837274"><a href="/net/http/server.go.html#3837091">c</a></span><span class="op" id="3837275">.</span><span class="ident" id="3837276">rwc</span><span class="op" id="3837279">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3837282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837285"><a href="/net/http/server.go.html#3837091">c</a></span><span class="op" id="3837286">.</span><span class="ident" id="3837287">sr</span>&nbsp;<span class="op" id="3837290">=</span>&nbsp;<span class="ident" id="3837292"><a href="/net/http/server.go.html#3830757">liveSwitchReader</a></span><span class="op" id="3837308">{</span><span class="ident" id="3837309">r</span><span class="op" id="3837310">:</span>&nbsp;<span class="ident" id="3837312"><a href="/net/http/server.go.html#3837091">c</a></span><span class="op" id="3837313">.</span><span class="ident" id="3837314">rwc</span><span class="op" id="3837317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837320"><a href="/net/http/server.go.html#3837091">c</a></span><span class="op" id="3837321">.</span><span class="ident" id="3837322">lr</span>&nbsp;<span class="op" id="3837325">=</span>&nbsp;<span class="ident" id="3837327"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3837329">.</span><span class="ident" id="3837330">LimitReader</span><span class="op" id="3837341">(</span><span class="op" id="3837342">&amp;</span><span class="ident" id="3837343"><a href="/net/http/server.go.html#3837091">c</a></span><span class="op" id="3837344">.</span><span class="ident" id="3837345">sr</span><span class="op" id="3837347">,</span>&nbsp;<span class="ident" id="3837349"><a href="/net/http/server.go.html#3836832">noLimit</a></span><span class="op" id="3837356">)</span><span class="op" id="3837357">.</span><span class="op" id="3837358">(</span><span class="op" id="3837359">*</span><span class="ident" id="3837360"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3837362">.</span><span class="ident" id="3837363">LimitedReader</span><span class="op" id="3837376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837379">br</span>&nbsp;<span class="op" id="3837382">:=</span>&nbsp;<span class="ident" id="3837385"><a href="/net/http/server.go.html#3837783">newBufioReader</a></span><span class="op" id="3837399">(</span><span class="ident" id="3837400"><a href="/net/http/server.go.html#3837091">c</a></span><span class="op" id="3837401">.</span><span class="ident" id="3837402">lr</span><span class="op" id="3837404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837407">bw</span>&nbsp;<span class="op" id="3837410">:=</span>&nbsp;<span class="ident" id="3837413"><a href="/net/http/server.go.html#3838043">newBufioWriterSize</a></span><span class="op" id="3837431">(</span><span class="ident" id="3837432"><a href="/net/http/server.go.html#3885830">checkConnErrorWriter</a></span><span class="op" id="3837452">{</span><span class="ident" id="3837453"><a href="/net/http/server.go.html#3837091">c</a></span><span class="op" id="3837454">}</span><span class="op" id="3837455">,</span>&nbsp;<span class="num" id="3837457">4</span><span class="op" id="3837458">&lt;&lt;</span><span class="num" id="3837460">10</span><span class="op" id="3837462">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837465"><a href="/net/http/server.go.html#3837091">c</a></span><span class="op" id="3837466">.</span><span class="ident" id="3837467">buf</span>&nbsp;<span class="op" id="3837471">=</span>&nbsp;<span class="ident" id="3837473"><a href="/net/http/server.go.html#3824744">bufio</a></span><span class="op" id="3837478">.</span><span class="ident" id="3837479">NewReadWriter</span><span class="op" id="3837492">(</span><span class="ident" id="3837493"><a href="/net/http/server.go.html#3837379">br</a></span><span class="op" id="3837495">,</span>&nbsp;<span class="ident" id="3837497"><a href="/net/http/server.go.html#3837407">bw</a></span><span class="op" id="3837499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837502">return</span>&nbsp;<span class="ident" id="3837509"><a href="/net/http/server.go.html#3837091">c</a></span><span class="op" id="3837510">,</span>&nbsp;<span class="ident" id="3837512">nil</span><br>
<span class="lineno"></span><span class="op" id="3837516">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3837519">var</span>&nbsp;<span class="op" id="3837523">(</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837526">bufioReaderPool</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3837544"><a href="/net/http/server.go.html#3824875">sync</a></span><span class="op" id="3837548">.</span><span class="ident" id="3837549">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837555">bufioWriter2kPool</span>&nbsp;<span class="ident" id="3837573"><a href="/net/http/server.go.html#3824875">sync</a></span><span class="op" id="3837577">.</span><span class="ident" id="3837578">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837584">bufioWriter4kPool</span>&nbsp;<span class="ident" id="3837602"><a href="/net/http/server.go.html#3824875">sync</a></span><span class="op" id="3837606">.</span><span class="ident" id="3837607">Pool</span><br>
<span class="lineno"></span><span class="op" id="3837612">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="keyword" id="3837615">func</span>&nbsp;<span class="ident" id="3837620">bufioWriterPool</span><span class="op" id="3837635">(</span><span class="ident" id="3837636">size</span>&nbsp;<span class="builtintype" id="3837641">int</span><span class="op" id="3837644">)</span>&nbsp;<span class="op" id="3837646">*</span><span class="ident" id="3837647"><a href="/net/http/server.go.html#3824875">sync</a></span><span class="op" id="3837651">.</span><span class="ident" id="3837652">Pool</span>&nbsp;<span class="op" id="3837657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837660">switch</span>&nbsp;<span class="ident" id="3837667"><a href="/net/http/server.go.html#3837636">size</a></span>&nbsp;<span class="op" id="3837672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837675">case</span>&nbsp;<span class="num" id="3837680">2</span>&nbsp;<span class="op" id="3837682">&lt;&lt;</span>&nbsp;<span class="num" id="3837685">10</span><span class="op" id="3837687">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837691">return</span>&nbsp;<span class="op" id="3837698">&amp;</span><span class="ident" id="3837699"><a href="/net/http/server.go.html#3837555">bufioWriter2kPool</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837718">case</span>&nbsp;<span class="num" id="3837723">4</span>&nbsp;<span class="op" id="3837725">&lt;&lt;</span>&nbsp;<span class="num" id="3837728">10</span><span class="op" id="3837730">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837734">return</span>&nbsp;<span class="op" id="3837741">&amp;</span><span class="ident" id="3837742"><a href="/net/http/server.go.html#3837584">bufioWriter4kPool</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3837761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837764">return</span>&nbsp;<span class="ident" id="3837771">nil</span><br>
<span class="lineno"></span><span class="op" id="3837775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="keyword" id="3837778">func</span>&nbsp;<span class="ident" id="3837783">newBufioReader</span><span class="op" id="3837797">(</span><span class="ident" id="3837798">r</span>&nbsp;<span class="ident" id="3837800"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3837802">.</span><span class="ident" id="3837803">Reader</span><span class="op" id="3837809">)</span>&nbsp;<span class="op" id="3837811">*</span><span class="ident" id="3837812"><a href="/net/http/server.go.html#3824744">bufio</a></span><span class="op" id="3837817">.</span><span class="ident" id="3837818">Reader</span>&nbsp;<span class="op" id="3837825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837828">if</span>&nbsp;<span class="ident" id="3837831">v</span>&nbsp;<span class="op" id="3837833">:=</span>&nbsp;<span class="ident" id="3837836"><a href="/net/http/server.go.html#3837526">bufioReaderPool</a></span><span class="op" id="3837851">.</span><span class="ident" id="3837852">Get</span><span class="op" id="3837855">(</span><span class="op" id="3837856">)</span><span class="op" id="3837857">;</span>&nbsp;<span class="ident" id="3837859"><a href="/net/http/server.go.html#3837831">v</a></span>&nbsp;<span class="op" id="3837861">!=</span>&nbsp;<span class="ident" id="3837864">nil</span>&nbsp;<span class="op" id="3837868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837872">br</span>&nbsp;<span class="op" id="3837875">:=</span>&nbsp;<span class="ident" id="3837878"><a href="/net/http/server.go.html#3837831">v</a></span><span class="op" id="3837879">.</span><span class="op" id="3837880">(</span><span class="op" id="3837881">*</span><span class="ident" id="3837882"><a href="/net/http/server.go.html#3824744">bufio</a></span><span class="op" id="3837887">.</span><span class="ident" id="3837888">Reader</span><span class="op" id="3837894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837898"><a href="/net/http/server.go.html#3837872">br</a></span><span class="op" id="3837900">.</span><span class="ident" id="3837901">Reset</span><span class="op" id="3837906">(</span><span class="ident" id="3837907"><a href="/net/http/server.go.html#3837798">r</a></span><span class="op" id="3837908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837912">return</span>&nbsp;<span class="ident" id="3837919"><a href="/net/http/server.go.html#3837872">br</a></span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3837923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837926">return</span>&nbsp;<span class="ident" id="3837933"><a href="/net/http/server.go.html#3824744">bufio</a></span><span class="op" id="3837938">.</span><span class="ident" id="3837939">NewReader</span><span class="op" id="3837948">(</span><span class="ident" id="3837949"><a href="/net/http/server.go.html#3837798">r</a></span><span class="op" id="3837950">)</span><br>
<span class="lineno"></span><span class="op" id="3837952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3837955">func</span>&nbsp;<span class="ident" id="3837960">putBufioReader</span><span class="op" id="3837974">(</span><span class="ident" id="3837975">br</span>&nbsp;<span class="op" id="3837978">*</span><span class="ident" id="3837979"><a href="/net/http/server.go.html#3824744">bufio</a></span><span class="op" id="3837984">.</span><span class="ident" id="3837985">Reader</span><span class="op" id="3837991">)</span>&nbsp;<span class="op" id="3837993">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837996"><a href="/net/http/server.go.html#3837975">br</a></span><span class="op" id="3837998">.</span><span class="ident" id="3837999">Reset</span><span class="op" id="3838004">(</span><span class="ident" id="3838005">nil</span><span class="op" id="3838008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838011"><a href="/net/http/server.go.html#3837526">bufioReaderPool</a></span><span class="op" id="3838026">.</span><span class="ident" id="3838027">Put</span><span class="op" id="3838030">(</span><span class="ident" id="3838031"><a href="/net/http/server.go.html#3837975">br</a></span><span class="op" id="3838033">)</span><br>
<span class="lineno"></span><span class="op" id="3838035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3838038">func</span>&nbsp;<span class="ident" id="3838043">newBufioWriterSize</span><span class="op" id="3838061">(</span><span class="ident" id="3838062">w</span>&nbsp;<span class="ident" id="3838064"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3838066">.</span><span class="ident" id="3838067">Writer</span><span class="op" id="3838073">,</span>&nbsp;<span class="ident" id="3838075">size</span>&nbsp;<span class="builtintype" id="3838080">int</span><span class="op" id="3838083">)</span>&nbsp;<span class="op" id="3838085">*</span><span class="ident" id="3838086"><a href="/net/http/server.go.html#3824744">bufio</a></span><span class="op" id="3838091">.</span><span class="ident" id="3838092">Writer</span>&nbsp;<span class="op" id="3838099">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838102">pool</span>&nbsp;<span class="op" id="3838107">:=</span>&nbsp;<span class="ident" id="3838110"><a href="/net/http/server.go.html#3837620">bufioWriterPool</a></span><span class="op" id="3838125">(</span><span class="ident" id="3838126"><a href="/net/http/server.go.html#3838075">size</a></span><span class="op" id="3838130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3838133">if</span>&nbsp;<span class="ident" id="3838136"><a href="/net/http/server.go.html#3838102">pool</a></span>&nbsp;<span class="op" id="3838141">!=</span>&nbsp;<span class="ident" id="3838144">nil</span>&nbsp;<span class="op" id="3838148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3838152">if</span>&nbsp;<span class="ident" id="3838155">v</span>&nbsp;<span class="op" id="3838157">:=</span>&nbsp;<span class="ident" id="3838160"><a href="/net/http/server.go.html#3838102">pool</a></span><span class="op" id="3838164">.</span><span class="ident" id="3838165">Get</span><span class="op" id="3838168">(</span><span class="op" id="3838169">)</span><span class="op" id="3838170">;</span>&nbsp;<span class="ident" id="3838172"><a href="/net/http/server.go.html#3838155">v</a></span>&nbsp;<span class="op" id="3838174">!=</span>&nbsp;<span class="ident" id="3838177">nil</span>&nbsp;<span class="op" id="3838181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838186">bw</span>&nbsp;<span class="op" id="3838189">:=</span>&nbsp;<span class="ident" id="3838192"><a href="/net/http/server.go.html#3838155">v</a></span><span class="op" id="3838193">.</span><span class="op" id="3838194">(</span><span class="op" id="3838195">*</span><span class="ident" id="3838196"><a href="/net/http/server.go.html#3824744">bufio</a></span><span class="op" id="3838201">.</span><span class="ident" id="3838202">Writer</span><span class="op" id="3838208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838213"><a href="/net/http/server.go.html#3838186">bw</a></span><span class="op" id="3838215">.</span><span class="ident" id="3838216">Reset</span><span class="op" id="3838221">(</span><span class="ident" id="3838222"><a href="/net/http/server.go.html#3838062">w</a></span><span class="op" id="3838223">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3838228">return</span>&nbsp;<span class="ident" id="3838235"><a href="/net/http/server.go.html#3838186">bw</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3838240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3838243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3838246">return</span>&nbsp;<span class="ident" id="3838253"><a href="/net/http/server.go.html#3824744">bufio</a></span><span class="op" id="3838258">.</span><span class="ident" id="3838259">NewWriterSize</span><span class="op" id="3838272">(</span><span class="ident" id="3838273"><a href="/net/http/server.go.html#3838062">w</a></span><span class="op" id="3838274">,</span>&nbsp;<span class="ident" id="3838276"><a href="/net/http/server.go.html#3838075">size</a></span><span class="op" id="3838280">)</span><br>
<span class="lineno"></span><span class="op" id="3838282">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="keyword" id="3838285">func</span>&nbsp;<span class="ident" id="3838290">putBufioWriter</span><span class="op" id="3838304">(</span><span class="ident" id="3838305">bw</span>&nbsp;<span class="op" id="3838308">*</span><span class="ident" id="3838309"><a href="/net/http/server.go.html#3824744">bufio</a></span><span class="op" id="3838314">.</span><span class="ident" id="3838315">Writer</span><span class="op" id="3838321">)</span>&nbsp;<span class="op" id="3838323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838326"><a href="/net/http/server.go.html#3838305">bw</a></span><span class="op" id="3838328">.</span><span class="ident" id="3838329">Reset</span><span class="op" id="3838334">(</span><span class="ident" id="3838335">nil</span><span class="op" id="3838338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3838341">if</span>&nbsp;<span class="ident" id="3838344">pool</span>&nbsp;<span class="op" id="3838349">:=</span>&nbsp;<span class="ident" id="3838352"><a href="/net/http/server.go.html#3837620">bufioWriterPool</a></span><span class="op" id="3838367">(</span><span class="ident" id="3838368"><a href="/net/http/server.go.html#3838305">bw</a></span><span class="op" id="3838370">.</span><span class="ident" id="3838371">Available</span><span class="op" id="3838380">(</span><span class="op" id="3838381">)</span><span class="op" id="3838382">)</span><span class="op" id="3838383">;</span>&nbsp;<span class="ident" id="3838385"><a href="/net/http/server.go.html#3838344">pool</a></span>&nbsp;<span class="op" id="3838390">!=</span>&nbsp;<span class="ident" id="3838393">nil</span>&nbsp;<span class="op" id="3838397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838401"><a href="/net/http/server.go.html#3838344">pool</a></span><span class="op" id="3838405">.</span><span class="ident" id="3838406">Put</span><span class="op" id="3838409">(</span><span class="ident" id="3838410"><a href="/net/http/server.go.html#3838305">bw</a></span><span class="op" id="3838412">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3838415">}</span><br>
<span class="lineno"></span><span class="op" id="3838417">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3838420">//&nbsp;DefaultMaxHeaderBytes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;permitted&nbsp;size&nbsp;of&nbsp;the&nbsp;headers</span><br>
<span class="lineno"></span><span class="comment" id="3838490">//&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;request.</span><br>
<span class="lineno">500</span><span class="comment" id="3838513">//&nbsp;This&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;setting&nbsp;Server.MaxHeaderBytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3838573">const</span>&nbsp;<span class="ident" id="3838579">DefaultMaxHeaderBytes</span>&nbsp;<span class="op" id="3838601">=</span>&nbsp;<span class="num" id="3838603">1</span>&nbsp;<span class="op" id="3838605">&lt;&lt;</span>&nbsp;<span class="num" id="3838608">20</span>&nbsp;<span class="comment" id="3838611">//&nbsp;1&nbsp;MB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3838620">func</span>&nbsp;<span class="op" id="3838625">(</span><span class="ident" id="3838626">srv</span>&nbsp;<span class="op" id="3838630">*</span><span class="ident" id="3838631"><a href="/net/http/server.go.html#3872025">Server</a></span><span class="op" id="3838637">)</span>&nbsp;<span class="ident" id="3838639">maxHeaderBytes</span><span class="op" id="3838653">(</span><span class="op" id="3838654">)</span>&nbsp;<span class="builtintype" id="3838656">int</span>&nbsp;<span class="op" id="3838660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3838663">if</span>&nbsp;<span class="ident" id="3838666"><a href="/net/http/server.go.html#3838626">srv</a></span><span class="op" id="3838669">.</span><span class="ident" id="3838670">MaxHeaderBytes</span>&nbsp;<span class="op" id="3838685">&gt;</span>&nbsp;<span class="num" id="3838687">0</span>&nbsp;<span class="op" id="3838689">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3838693">return</span>&nbsp;<span class="ident" id="3838700"><a href="/net/http/server.go.html#3838626">srv</a></span><span class="op" id="3838703">.</span><span class="ident" id="3838704">MaxHeaderBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3838720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3838723">return</span>&nbsp;<span class="ident" id="3838730"><a href="/net/http/server.go.html#3838579">DefaultMaxHeaderBytes</a></span><br>
<span class="lineno"></span><span class="op" id="3838752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="3838755">func</span>&nbsp;<span class="op" id="3838760">(</span><span class="ident" id="3838761">srv</span>&nbsp;<span class="op" id="3838765">*</span><span class="ident" id="3838766"><a href="/net/http/server.go.html#3872025">Server</a></span><span class="op" id="3838772">)</span>&nbsp;<span class="ident" id="3838774">initialLimitedReaderSize</span><span class="op" id="3838798">(</span><span class="op" id="3838799">)</span>&nbsp;<span class="ident" id="3838801">int64</span>&nbsp;<span class="op" id="3838807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3838810">return</span>&nbsp;<span class="ident" id="3838817">int64</span><span class="op" id="3838822">(</span><span class="ident" id="3838823"><a href="/net/http/server.go.html#3838761">srv</a></span><span class="op" id="3838826">.</span><span class="ident" id="3838827">maxHeaderBytes</span><span class="op" id="3838841">(</span><span class="op" id="3838842">)</span><span class="op" id="3838843">)</span>&nbsp;<span class="op" id="3838845">+</span>&nbsp;<span class="num" id="3838847">4096</span>&nbsp;<span class="comment" id="3838852">//&nbsp;bufio&nbsp;slop</span><br>
<span class="lineno"></span><span class="op" id="3838866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3838869">//&nbsp;wrapper&nbsp;around&nbsp;io.ReaderCloser&nbsp;which&nbsp;on&nbsp;first&nbsp;read,&nbsp;sends&nbsp;an</span><br>
<span class="lineno">515</span><span class="comment" id="3838933">//&nbsp;HTTP/1.1&nbsp;100&nbsp;Continue&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="3838965">type</span>&nbsp;<span class="ident" id="3838970">expectContinueReader</span>&nbsp;<span class="keyword" id="3838991">struct</span>&nbsp;<span class="op" id="3838998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839001">resp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3839012">*</span><span class="ident" id="3839013"><a href="/net/http/server.go.html#3833137">response</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839023">readCloser</span>&nbsp;<span class="ident" id="3839034"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3839036">.</span><span class="ident" id="3839037">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839049">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3839060">bool</span><br>
<span class="lineno">520</span><span class="op" id="3839065">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3839068">func</span>&nbsp;<span class="op" id="3839073">(</span><span class="ident" id="3839074">ecr</span>&nbsp;<span class="op" id="3839078">*</span><span class="ident" id="3839079"><a href="/net/http/server.go.html#3838970">expectContinueReader</a></span><span class="op" id="3839099">)</span>&nbsp;<span class="ident" id="3839101">Read</span><span class="op" id="3839105">(</span><span class="ident" id="3839106">p</span>&nbsp;<span class="op" id="3839108">[</span><span class="op" id="3839109">]</span><span class="builtintype" id="3839110">byte</span><span class="op" id="3839114">)</span>&nbsp;<span class="op" id="3839116">(</span><span class="ident" id="3839117">n</span>&nbsp;<span class="builtintype" id="3839119">int</span><span class="op" id="3839122">,</span>&nbsp;<span class="ident" id="3839124">err</span>&nbsp;<span class="builtintype" id="3839128">error</span><span class="op" id="3839133">)</span>&nbsp;<span class="op" id="3839135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839138">if</span>&nbsp;<span class="ident" id="3839141"><a href="/net/http/server.go.html#3839074">ecr</a></span><span class="op" id="3839144">.</span><span class="ident" id="3839145">closed</span>&nbsp;<span class="op" id="3839152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839156">return</span>&nbsp;<span class="num" id="3839163">0</span><span class="op" id="3839164">,</span>&nbsp;<span class="ident" id="3839166"><a href="/net/http/transfer.go.html#3910886">ErrBodyReadAfterClose</a></span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3839189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839192">if</span>&nbsp;<span class="op" id="3839195">!</span><span class="ident" id="3839196"><a href="/net/http/server.go.html#3839074">ecr</a></span><span class="op" id="3839199">.</span><span class="ident" id="3839200">resp</span><span class="op" id="3839204">.</span><span class="ident" id="3839205">wroteContinue</span>&nbsp;<span class="op" id="3839219">&amp;&amp;</span>&nbsp;<span class="op" id="3839222">!</span><span class="ident" id="3839223"><a href="/net/http/server.go.html#3839074">ecr</a></span><span class="op" id="3839226">.</span><span class="ident" id="3839227">resp</span><span class="op" id="3839231">.</span><span class="ident" id="3839232">conn</span><span class="op" id="3839236">.</span><span class="ident" id="3839237">hijacked</span><span class="op" id="3839245">(</span><span class="op" id="3839246">)</span>&nbsp;<span class="op" id="3839248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839252"><a href="/net/http/server.go.html#3839074">ecr</a></span><span class="op" id="3839255">.</span><span class="ident" id="3839256">resp</span><span class="op" id="3839260">.</span><span class="ident" id="3839261">wroteContinue</span>&nbsp;<span class="op" id="3839275">=</span>&nbsp;<span class="ident" id="3839277">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839284"><a href="/net/http/server.go.html#3839074">ecr</a></span><span class="op" id="3839287">.</span><span class="ident" id="3839288">resp</span><span class="op" id="3839292">.</span><span class="ident" id="3839293">conn</span><span class="op" id="3839297">.</span><span class="ident" id="3839298">buf</span><span class="op" id="3839301">.</span><span class="ident" id="3839302">WriteString</span><span class="op" id="3839313">(</span><span class="string" id="3839314">&#34;HTTP/1.1&nbsp;100&nbsp;Continue\r\n\r\n&#34;</span><span class="op" id="3839345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839349"><a href="/net/http/server.go.html#3839074">ecr</a></span><span class="op" id="3839352">.</span><span class="ident" id="3839353">resp</span><span class="op" id="3839357">.</span><span class="ident" id="3839358">conn</span><span class="op" id="3839362">.</span><span class="ident" id="3839363">buf</span><span class="op" id="3839366">.</span><span class="ident" id="3839367">Flush</span><span class="op" id="3839372">(</span><span class="op" id="3839373">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3839376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839379">return</span>&nbsp;<span class="ident" id="3839386"><a href="/net/http/server.go.html#3839074">ecr</a></span><span class="op" id="3839389">.</span><span class="ident" id="3839390">readCloser</span><span class="op" id="3839400">.</span><span class="ident" id="3839401">Read</span><span class="op" id="3839405">(</span><span class="ident" id="3839406"><a href="/net/http/server.go.html#3839106">p</a></span><span class="op" id="3839407">)</span><br>
<span class="lineno"></span><span class="op" id="3839409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3839412">func</span>&nbsp;<span class="op" id="3839417">(</span><span class="ident" id="3839418">ecr</span>&nbsp;<span class="op" id="3839422">*</span><span class="ident" id="3839423"><a href="/net/http/server.go.html#3838970">expectContinueReader</a></span><span class="op" id="3839443">)</span>&nbsp;<span class="ident" id="3839445">Close</span><span class="op" id="3839450">(</span><span class="op" id="3839451">)</span>&nbsp;<span class="builtintype" id="3839453">error</span>&nbsp;<span class="op" id="3839459">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839462"><a href="/net/http/server.go.html#3839418">ecr</a></span><span class="op" id="3839465">.</span><span class="ident" id="3839466">closed</span>&nbsp;<span class="op" id="3839473">=</span>&nbsp;<span class="ident" id="3839475">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839481">return</span>&nbsp;<span class="ident" id="3839488"><a href="/net/http/server.go.html#3839418">ecr</a></span><span class="op" id="3839491">.</span><span class="ident" id="3839492">readCloser</span><span class="op" id="3839502">.</span><span class="ident" id="3839503">Close</span><span class="op" id="3839508">(</span><span class="op" id="3839509">)</span><br>
<span class="lineno"></span><span class="op" id="3839511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3839514">//&nbsp;TimeFormat&nbsp;is&nbsp;the&nbsp;time&nbsp;format&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno">540</span><span class="comment" id="3839559">//&nbsp;time.Parse&nbsp;and&nbsp;time.Time.Format&nbsp;when&nbsp;parsing</span><br>
<span class="lineno"></span><span class="comment" id="3839607">//&nbsp;or&nbsp;generating&nbsp;times&nbsp;in&nbsp;HTTP&nbsp;headers.</span><br>
<span class="lineno"></span><span class="comment" id="3839647">//&nbsp;It&nbsp;is&nbsp;like&nbsp;time.RFC1123&nbsp;but&nbsp;hard&nbsp;codes&nbsp;GMT&nbsp;as&nbsp;the&nbsp;time&nbsp;zone.</span><br>
<span class="lineno"></span><span class="keyword" id="3839711">const</span>&nbsp;<span class="ident" id="3839717">TimeFormat</span>&nbsp;<span class="op" id="3839728">=</span>&nbsp;<span class="string" id="3839730">&#34;Mon,&nbsp;02&nbsp;Jan&nbsp;2006&nbsp;15:04:05&nbsp;GMT&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span><span class="comment" id="3839763">//&nbsp;appendTime&nbsp;is&nbsp;a&nbsp;non-allocating&nbsp;version&nbsp;of&nbsp;[]byte(t.UTC().Format(TimeFormat))</span><br>
<span class="lineno"></span><span class="keyword" id="3839843">func</span>&nbsp;<span class="ident" id="3839848">appendTime</span><span class="op" id="3839858">(</span><span class="ident" id="3839859">b</span>&nbsp;<span class="op" id="3839861">[</span><span class="op" id="3839862">]</span><span class="builtintype" id="3839863">byte</span><span class="op" id="3839867">,</span>&nbsp;<span class="ident" id="3839869">t</span>&nbsp;<span class="ident" id="3839871"><a href="/net/http/server.go.html#3824898">time</a></span><span class="op" id="3839875">.</span><span class="ident" id="3839876">Time</span><span class="op" id="3839880">)</span>&nbsp;<span class="op" id="3839882">[</span><span class="op" id="3839883">]</span><span class="builtintype" id="3839884">byte</span>&nbsp;<span class="op" id="3839889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839892">const</span>&nbsp;<span class="ident" id="3839898">days</span>&nbsp;<span class="op" id="3839903">=</span>&nbsp;<span class="string" id="3839905">&#34;SunMonTueWedThuFriSat&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839930">const</span>&nbsp;<span class="ident" id="3839936">months</span>&nbsp;<span class="op" id="3839943">=</span>&nbsp;<span class="string" id="3839945">&#34;JanFebMarAprMayJunJulAugSepOctNovDec&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839986"><a href="/net/http/server.go.html#3839869">t</a></span>&nbsp;<span class="op" id="3839988">=</span>&nbsp;<span class="ident" id="3839990"><a href="/net/http/server.go.html#3839869">t</a></span><span class="op" id="3839991">.</span><span class="ident" id="3839992">UTC</span><span class="op" id="3839995">(</span><span class="op" id="3839996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3839999">yy</span><span class="op" id="3840001">,</span>&nbsp;<span class="ident" id="3840003">mm</span><span class="op" id="3840005">,</span>&nbsp;<span class="ident" id="3840007">dd</span>&nbsp;<span class="op" id="3840010">:=</span>&nbsp;<span class="ident" id="3840013"><a href="/net/http/server.go.html#3839869">t</a></span><span class="op" id="3840014">.</span><span class="ident" id="3840015">Date</span><span class="op" id="3840019">(</span><span class="op" id="3840020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840023">hh</span><span class="op" id="3840025">,</span>&nbsp;<span class="ident" id="3840027">mn</span><span class="op" id="3840029">,</span>&nbsp;<span class="ident" id="3840031">ss</span>&nbsp;<span class="op" id="3840034">:=</span>&nbsp;<span class="ident" id="3840037"><a href="/net/http/server.go.html#3839869">t</a></span><span class="op" id="3840038">.</span><span class="ident" id="3840039">Clock</span><span class="op" id="3840044">(</span><span class="op" id="3840045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840048">day</span>&nbsp;<span class="op" id="3840052">:=</span>&nbsp;<span class="ident" id="3840055"><a href="/net/http/server.go.html#3839898">days</a></span><span class="op" id="3840059">[</span><span class="num" id="3840060">3</span><span class="op" id="3840061">*</span><span class="ident" id="3840062"><a href="/net/http/server.go.html#3839869">t</a></span><span class="op" id="3840063">.</span><span class="ident" id="3840064">Weekday</span><span class="op" id="3840071">(</span><span class="op" id="3840072">)</span><span class="op" id="3840073">:</span><span class="op" id="3840074">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840077">mon</span>&nbsp;<span class="op" id="3840081">:=</span>&nbsp;<span class="ident" id="3840084"><a href="/net/http/server.go.html#3839936">months</a></span><span class="op" id="3840090">[</span><span class="num" id="3840091">3</span><span class="op" id="3840092">*</span><span class="op" id="3840093">(</span><span class="ident" id="3840094"><a href="/net/http/server.go.html#3840003">mm</a></span><span class="op" id="3840096">-</span><span class="num" id="3840097">1</span><span class="op" id="3840098">)</span><span class="op" id="3840099">:</span><span class="op" id="3840100">]</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840104">return</span>&nbsp;<span class="builtinfunc" id="3840111">append</span><span class="op" id="3840117">(</span><span class="ident" id="3840118"><a href="/net/http/server.go.html#3839859">b</a></span><span class="op" id="3840119">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840123"><a href="/net/http/server.go.html#3840048">day</a></span><span class="op" id="3840126">[</span><span class="num" id="3840127">0</span><span class="op" id="3840128">]</span><span class="op" id="3840129">,</span>&nbsp;<span class="ident" id="3840131"><a href="/net/http/server.go.html#3840048">day</a></span><span class="op" id="3840134">[</span><span class="num" id="3840135">1</span><span class="op" id="3840136">]</span><span class="op" id="3840137">,</span>&nbsp;<span class="ident" id="3840139"><a href="/net/http/server.go.html#3840048">day</a></span><span class="op" id="3840142">[</span><span class="num" id="3840143">2</span><span class="op" id="3840144">]</span><span class="op" id="3840145">,</span>&nbsp;<span class="string" id="3840147">&#39;,&#39;</span><span class="op" id="3840150">,</span>&nbsp;<span class="string" id="3840152">&#39;&nbsp;&#39;</span><span class="op" id="3840155">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3840159">byte</span><span class="op" id="3840163">(</span><span class="string" id="3840164">&#39;0&#39;</span><span class="op" id="3840167">+</span><span class="ident" id="3840168"><a href="/net/http/server.go.html#3840007">dd</a></span><span class="op" id="3840170">/</span><span class="num" id="3840171">10</span><span class="op" id="3840173">)</span><span class="op" id="3840174">,</span>&nbsp;<span class="builtintype" id="3840176">byte</span><span class="op" id="3840180">(</span><span class="string" id="3840181">&#39;0&#39;</span><span class="op" id="3840184">+</span><span class="ident" id="3840185"><a href="/net/http/server.go.html#3840007">dd</a></span><span class="op" id="3840187">%</span><span class="num" id="3840188">10</span><span class="op" id="3840190">)</span><span class="op" id="3840191">,</span>&nbsp;<span class="string" id="3840193">&#39;&nbsp;&#39;</span><span class="op" id="3840196">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840200"><a href="/net/http/server.go.html#3840077">mon</a></span><span class="op" id="3840203">[</span><span class="num" id="3840204">0</span><span class="op" id="3840205">]</span><span class="op" id="3840206">,</span>&nbsp;<span class="ident" id="3840208"><a href="/net/http/server.go.html#3840077">mon</a></span><span class="op" id="3840211">[</span><span class="num" id="3840212">1</span><span class="op" id="3840213">]</span><span class="op" id="3840214">,</span>&nbsp;<span class="ident" id="3840216"><a href="/net/http/server.go.html#3840077">mon</a></span><span class="op" id="3840219">[</span><span class="num" id="3840220">2</span><span class="op" id="3840221">]</span><span class="op" id="3840222">,</span>&nbsp;<span class="string" id="3840224">&#39;&nbsp;&#39;</span><span class="op" id="3840227">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3840231">byte</span><span class="op" id="3840235">(</span><span class="string" id="3840236">&#39;0&#39;</span><span class="op" id="3840239">+</span><span class="ident" id="3840240"><a href="/net/http/server.go.html#3839999">yy</a></span><span class="op" id="3840242">/</span><span class="num" id="3840243">1000</span><span class="op" id="3840247">)</span><span class="op" id="3840248">,</span>&nbsp;<span class="builtintype" id="3840250">byte</span><span class="op" id="3840254">(</span><span class="string" id="3840255">&#39;0&#39;</span><span class="op" id="3840258">+</span><span class="op" id="3840259">(</span><span class="ident" id="3840260"><a href="/net/http/server.go.html#3839999">yy</a></span><span class="op" id="3840262">/</span><span class="num" id="3840263">100</span><span class="op" id="3840266">)</span><span class="op" id="3840267">%</span><span class="num" id="3840268">10</span><span class="op" id="3840270">)</span><span class="op" id="3840271">,</span>&nbsp;<span class="builtintype" id="3840273">byte</span><span class="op" id="3840277">(</span><span class="string" id="3840278">&#39;0&#39;</span><span class="op" id="3840281">+</span><span class="op" id="3840282">(</span><span class="ident" id="3840283"><a href="/net/http/server.go.html#3839999">yy</a></span><span class="op" id="3840285">/</span><span class="num" id="3840286">10</span><span class="op" id="3840288">)</span><span class="op" id="3840289">%</span><span class="num" id="3840290">10</span><span class="op" id="3840292">)</span><span class="op" id="3840293">,</span>&nbsp;<span class="builtintype" id="3840295">byte</span><span class="op" id="3840299">(</span><span class="string" id="3840300">&#39;0&#39;</span><span class="op" id="3840303">+</span><span class="ident" id="3840304"><a href="/net/http/server.go.html#3839999">yy</a></span><span class="op" id="3840306">%</span><span class="num" id="3840307">10</span><span class="op" id="3840309">)</span><span class="op" id="3840310">,</span>&nbsp;<span class="string" id="3840312">&#39;&nbsp;&#39;</span><span class="op" id="3840315">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3840319">byte</span><span class="op" id="3840323">(</span><span class="string" id="3840324">&#39;0&#39;</span><span class="op" id="3840327">+</span><span class="ident" id="3840328"><a href="/net/http/server.go.html#3840023">hh</a></span><span class="op" id="3840330">/</span><span class="num" id="3840331">10</span><span class="op" id="3840333">)</span><span class="op" id="3840334">,</span>&nbsp;<span class="builtintype" id="3840336">byte</span><span class="op" id="3840340">(</span><span class="string" id="3840341">&#39;0&#39;</span><span class="op" id="3840344">+</span><span class="ident" id="3840345"><a href="/net/http/server.go.html#3840023">hh</a></span><span class="op" id="3840347">%</span><span class="num" id="3840348">10</span><span class="op" id="3840350">)</span><span class="op" id="3840351">,</span>&nbsp;<span class="string" id="3840353">&#39;:&#39;</span><span class="op" id="3840356">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3840360">byte</span><span class="op" id="3840364">(</span><span class="string" id="3840365">&#39;0&#39;</span><span class="op" id="3840368">+</span><span class="ident" id="3840369"><a href="/net/http/server.go.html#3840027">mn</a></span><span class="op" id="3840371">/</span><span class="num" id="3840372">10</span><span class="op" id="3840374">)</span><span class="op" id="3840375">,</span>&nbsp;<span class="builtintype" id="3840377">byte</span><span class="op" id="3840381">(</span><span class="string" id="3840382">&#39;0&#39;</span><span class="op" id="3840385">+</span><span class="ident" id="3840386"><a href="/net/http/server.go.html#3840027">mn</a></span><span class="op" id="3840388">%</span><span class="num" id="3840389">10</span><span class="op" id="3840391">)</span><span class="op" id="3840392">,</span>&nbsp;<span class="string" id="3840394">&#39;:&#39;</span><span class="op" id="3840397">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3840401">byte</span><span class="op" id="3840405">(</span><span class="string" id="3840406">&#39;0&#39;</span><span class="op" id="3840409">+</span><span class="ident" id="3840410"><a href="/net/http/server.go.html#3840031">ss</a></span><span class="op" id="3840412">/</span><span class="num" id="3840413">10</span><span class="op" id="3840415">)</span><span class="op" id="3840416">,</span>&nbsp;<span class="builtintype" id="3840418">byte</span><span class="op" id="3840422">(</span><span class="string" id="3840423">&#39;0&#39;</span><span class="op" id="3840426">+</span><span class="ident" id="3840427"><a href="/net/http/server.go.html#3840031">ss</a></span><span class="op" id="3840429">%</span><span class="num" id="3840430">10</span><span class="op" id="3840432">)</span><span class="op" id="3840433">,</span>&nbsp;<span class="string" id="3840435">&#39;&nbsp;&#39;</span><span class="op" id="3840438">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3840442">&#39;G&#39;</span><span class="op" id="3840445">,</span>&nbsp;<span class="string" id="3840447">&#39;M&#39;</span><span class="op" id="3840450">,</span>&nbsp;<span class="string" id="3840452">&#39;T&#39;</span><span class="op" id="3840455">)</span><br>
<span class="lineno">565</span><span class="op" id="3840457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3840460">var</span>&nbsp;<span class="ident" id="3840464">errTooLarge</span>&nbsp;<span class="op" id="3840476">=</span>&nbsp;<span class="ident" id="3840478"><a href="/net/http/server.go.html#3824767">errors</a></span><span class="op" id="3840484">.</span><span class="ident" id="3840485">New</span><span class="op" id="3840488">(</span><span class="string" id="3840489">&#34;http:&nbsp;request&nbsp;too&nbsp;large&#34;</span><span class="op" id="3840514">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3840517">//&nbsp;Read&nbsp;next&nbsp;request&nbsp;from&nbsp;connection.</span><br>
<span class="lineno">570</span><span class="keyword" id="3840555">func</span>&nbsp;<span class="op" id="3840560">(</span><span class="ident" id="3840561">c</span>&nbsp;<span class="op" id="3840563">*</span><span class="ident" id="3840564"><a href="/net/http/server.go.html#3828256">conn</a></span><span class="op" id="3840568">)</span>&nbsp;<span class="ident" id="3840570">readRequest</span><span class="op" id="3840581">(</span><span class="op" id="3840582">)</span>&nbsp;<span class="op" id="3840584">(</span><span class="ident" id="3840585">w</span>&nbsp;<span class="op" id="3840587">*</span><span class="ident" id="3840588"><a href="/net/http/server.go.html#3833137">response</a></span><span class="op" id="3840596">,</span>&nbsp;<span class="ident" id="3840598">err</span>&nbsp;<span class="builtintype" id="3840602">error</span><span class="op" id="3840607">)</span>&nbsp;<span class="op" id="3840609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840612">if</span>&nbsp;<span class="ident" id="3840615"><a href="/net/http/server.go.html#3840561">c</a></span><span class="op" id="3840616">.</span><span class="ident" id="3840617">hijacked</span><span class="op" id="3840625">(</span><span class="op" id="3840626">)</span>&nbsp;<span class="op" id="3840628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840632">return</span>&nbsp;<span class="ident" id="3840639">nil</span><span class="op" id="3840642">,</span>&nbsp;<span class="ident" id="3840644"><a href="/net/http/server.go.html#3825123">ErrHijacked</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3840657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840661">if</span>&nbsp;<span class="ident" id="3840664">d</span>&nbsp;<span class="op" id="3840666">:=</span>&nbsp;<span class="ident" id="3840669"><a href="/net/http/server.go.html#3840561">c</a></span><span class="op" id="3840670">.</span><span class="ident" id="3840671">server</span><span class="op" id="3840677">.</span><span class="ident" id="3840678">ReadTimeout</span><span class="op" id="3840689">;</span>&nbsp;<span class="ident" id="3840691"><a href="/net/http/server.go.html#3840664">d</a></span>&nbsp;<span class="op" id="3840693">!=</span>&nbsp;<span class="num" id="3840696">0</span>&nbsp;<span class="op" id="3840698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840702"><a href="/net/http/server.go.html#3840561">c</a></span><span class="op" id="3840703">.</span><span class="ident" id="3840704">rwc</span><span class="op" id="3840707">.</span><span class="ident" id="3840708">SetReadDeadline</span><span class="op" id="3840723">(</span><span class="ident" id="3840724"><a href="/net/http/server.go.html#3824898">time</a></span><span class="op" id="3840728">.</span><span class="ident" id="3840729">Now</span><span class="op" id="3840732">(</span><span class="op" id="3840733">)</span><span class="op" id="3840734">.</span><span class="ident" id="3840735">Add</span><span class="op" id="3840738">(</span><span class="ident" id="3840739"><a href="/net/http/server.go.html#3840664">d</a></span><span class="op" id="3840740">)</span><span class="op" id="3840741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3840744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840747">if</span>&nbsp;<span class="ident" id="3840750">d</span>&nbsp;<span class="op" id="3840752">:=</span>&nbsp;<span class="ident" id="3840755"><a href="/net/http/server.go.html#3840561">c</a></span><span class="op" id="3840756">.</span><span class="ident" id="3840757">server</span><span class="op" id="3840763">.</span><span class="ident" id="3840764">WriteTimeout</span><span class="op" id="3840776">;</span>&nbsp;<span class="ident" id="3840778"><a href="/net/http/server.go.html#3840750">d</a></span>&nbsp;<span class="op" id="3840780">!=</span>&nbsp;<span class="num" id="3840783">0</span>&nbsp;<span class="op" id="3840785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840789">defer</span>&nbsp;<span class="keyword" id="3840795">func</span><span class="op" id="3840799">(</span><span class="op" id="3840800">)</span>&nbsp;<span class="op" id="3840802">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840807"><a href="/net/http/server.go.html#3840561">c</a></span><span class="op" id="3840808">.</span><span class="ident" id="3840809">rwc</span><span class="op" id="3840812">.</span><span class="ident" id="3840813">SetWriteDeadline</span><span class="op" id="3840829">(</span><span class="ident" id="3840830"><a href="/net/http/server.go.html#3824898">time</a></span><span class="op" id="3840834">.</span><span class="ident" id="3840835">Now</span><span class="op" id="3840838">(</span><span class="op" id="3840839">)</span><span class="op" id="3840840">.</span><span class="ident" id="3840841">Add</span><span class="op" id="3840844">(</span><span class="ident" id="3840845"><a href="/net/http/server.go.html#3840750">d</a></span><span class="op" id="3840846">)</span><span class="op" id="3840847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3840851">}</span><span class="op" id="3840852">(</span><span class="op" id="3840853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3840856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3840860"><a href="/net/http/server.go.html#3840561">c</a></span><span class="op" id="3840861">.</span><span class="ident" id="3840862">lr</span><span class="op" id="3840864">.</span><span class="ident" id="3840865">N</span>&nbsp;<span class="op" id="3840867">=</span>&nbsp;<span class="ident" id="3840869"><a href="/net/http/server.go.html#3840561">c</a></span><span class="op" id="3840870">.</span><span class="ident" id="3840871">server</span><span class="op" id="3840877">.</span><span class="ident" id="3840878">initialLimitedReaderSize</span><span class="op" id="3840902">(</span><span class="op" id="3840903">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840906">var</span>&nbsp;<span class="ident" id="3840910">req</span>&nbsp;<span class="op" id="3840914">*</span><span class="ident" id="3840915"><a href="/net/http/request.go.html#3791418">Request</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840924">if</span>&nbsp;<span class="ident" id="3840927"><a href="/net/http/server.go.html#3840910">req</a></span><span class="op" id="3840930">,</span>&nbsp;<span class="ident" id="3840932"><a href="/net/http/server.go.html#3840598">err</a></span>&nbsp;<span class="op" id="3840936">=</span>&nbsp;<span class="ident" id="3840938"><a href="/net/http/request.go.html#3807559">ReadRequest</a></span><span class="op" id="3840949">(</span><span class="ident" id="3840950"><a href="/net/http/server.go.html#3840561">c</a></span><span class="op" id="3840951">.</span><span class="ident" id="3840952">buf</span><span class="op" id="3840955">.</span><span class="ident" id="3840956">Reader</span><span class="op" id="3840962">)</span><span class="op" id="3840963">;</span>&nbsp;<span class="ident" id="3840965"><a href="/net/http/server.go.html#3840598">err</a></span>&nbsp;<span class="op" id="3840969">!=</span>&nbsp;<span class="ident" id="3840972">nil</span>&nbsp;<span class="op" id="3840976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3840980">if</span>&nbsp;<span class="ident" id="3840983"><a href="/net/http/server.go.html#3840561">c</a></span><span class="op" id="3840984">.</span><span class="ident" id="3840985">lr</span><span class="op" id="3840987">.</span><span class="ident" id="3840988">N</span>&nbsp;<span class="op" id="3840990">==</span>&nbsp;<span class="num" id="3840993">0</span>&nbsp;<span class="op" id="3840995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3841000">return</span>&nbsp;<span class="ident" id="3841007">nil</span><span class="op" id="3841010">,</span>&nbsp;<span class="ident" id="3841012"><a href="/net/http/server.go.html#3840464">errTooLarge</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3841026">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3841030">return</span>&nbsp;<span class="ident" id="3841037">nil</span><span class="op" id="3841040">,</span>&nbsp;<span class="ident" id="3841042"><a href="/net/http/server.go.html#3840598">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3841047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3841050"><a href="/net/http/server.go.html#3840561">c</a></span><span class="op" id="3841051">.</span><span class="ident" id="3841052">lr</span><span class="op" id="3841054">.</span><span class="ident" id="3841055">N</span>&nbsp;<span class="op" id="3841057">=</span>&nbsp;<span class="ident" id="3841059"><a href="/net/http/server.go.html#3836832">noLimit</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3841069"><a href="/net/http/server.go.html#3840910">req</a></span><span class="op" id="3841072">.</span><span class="ident" id="3841073">RemoteAddr</span>&nbsp;<span class="op" id="3841084">=</span>&nbsp;<span class="ident" id="3841086"><a href="/net/http/server.go.html#3840561">c</a></span><span class="op" id="3841087">.</span><span class="ident" id="3841088">remoteAddr</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3841100"><a href="/net/http/server.go.html#3840910">req</a></span><span class="op" id="3841103">.</span><span class="ident" id="3841104">TLS</span>&nbsp;<span class="op" id="3841108">=</span>&nbsp;<span class="ident" id="3841110"><a href="/net/http/server.go.html#3840561">c</a></span><span class="op" id="3841111">.</span><span class="ident" id="3841112">tlsState</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3841123"><a href="/net/http/server.go.html#3840585">w</a></span>&nbsp;<span class="op" id="3841125">=</span>&nbsp;<span class="op" id="3841127">&amp;</span><span class="ident" id="3841128"><a href="/net/http/server.go.html#3833137">response</a></span><span class="op" id="3841136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3841140">conn</span><span class="op" id="3841144">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3841155"><a href="/net/http/server.go.html#3840561">c</a></span><span class="op" id="3841156">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3841160">req</span><span class="op" id="3841163">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3841175"><a href="/net/http/server.go.html#3840910">req</a></span><span class="op" id="3841178">,</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3841182">handlerHeader</span><span class="op" id="3841195">:</span>&nbsp;<span class="builtinfunc" id="3841197">make</span><span class="op" id="3841201">(</span><span class="ident" id="3841202"><a href="/net/http/header.go.html#3781581">Header</a></span><span class="op" id="3841208">)</span><span class="op" id="3841209">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3841213">contentLength</span><span class="op" id="3841226">:</span>&nbsp;<span class="op" id="3841228">-</span><span class="num" id="3841229">1</span><span class="op" id="3841230">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3841233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3841236"><a href="/net/http/server.go.html#3840585">w</a></span><span class="op" id="3841237">.</span><span class="ident" id="3841238">cw</span><span class="op" id="3841240">.</span><span class="ident" id="3841241">res</span>&nbsp;<span class="op" id="3841245">=</span>&nbsp;<span class="ident" id="3841247"><a href="/net/http/server.go.html#3840585">w</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3841250"><a href="/net/http/server.go.html#3840585">w</a></span><span class="op" id="3841251">.</span><span class="ident" id="3841252">w</span>&nbsp;<span class="op" id="3841254">=</span>&nbsp;<span class="ident" id="3841256"><a href="/net/http/server.go.html#3838043">newBufioWriterSize</a></span><span class="op" id="3841274">(</span><span class="op" id="3841275">&amp;</span><span class="ident" id="3841276"><a href="/net/http/server.go.html#3840585">w</a></span><span class="op" id="3841277">.</span><span class="ident" id="3841278">cw</span><span class="op" id="3841280">,</span>&nbsp;<span class="ident" id="3841282"><a href="/net/http/server.go.html#3831033">bufferBeforeChunkingSize</a></span><span class="op" id="3841306">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3841309">return</span>&nbsp;<span class="ident" id="3841316"><a href="/net/http/server.go.html#3840585">w</a></span><span class="op" id="3841317">,</span>&nbsp;<span class="ident" id="3841319">nil</span><br>
<span class="lineno"></span><span class="op" id="3841323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3841326">func</span>&nbsp;<span class="op" id="3841331">(</span><span class="ident" id="3841332">w</span>&nbsp;<span class="op" id="3841334">*</span><span class="ident" id="3841335"><a href="/net/http/server.go.html#3833137">response</a></span><span class="op" id="3841343">)</span>&nbsp;<span class="ident" id="3841345">Header</span><span class="op" id="3841351">(</span><span class="op" id="3841352">)</span>&nbsp;<span class="ident" id="3841354"><a href="/net/http/header.go.html#3781581">Header</a></span>&nbsp;<span class="op" id="3841361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3841364">if</span>&nbsp;<span class="ident" id="3841367"><a href="/net/http/server.go.html#3841332">w</a></span><span class="op" id="3841368">.</span><span class="ident" id="3841369">cw</span><span class="op" id="3841371">.</span><span class="ident" id="3841372">header</span>&nbsp;<span class="op" id="3841379">==</span>&nbsp;<span class="ident" id="3841382">nil</span>&nbsp;<span class="op" id="3841386">&amp;&amp;</span>&nbsp;<span class="ident" id="3841389"><a href="/net/http/server.go.html#3841332">w</a></span><span class="op" id="3841390">.</span><span class="ident" id="3841391">wroteHeader</span>&nbsp;<span class="op" id="3841403">&amp;&amp;</span>&nbsp;<span class="op" id="3841406">!</span><span class="ident" id="3841407"><a href="/net/http/server.go.html#3841332">w</a></span><span class="op" id="3841408">.</span><span class="ident" id="3841409">cw</span><span class="op" id="3841411">.</span><span class="ident" id="3841412">wroteHeader</span>&nbsp;<span class="op" id="3841424">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3841428">//&nbsp;Accessing&nbsp;the&nbsp;header&nbsp;between&nbsp;logically&nbsp;writing&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3841483">//&nbsp;and&nbsp;physically&nbsp;writing&nbsp;it&nbsp;means&nbsp;we&nbsp;need&nbsp;to&nbsp;allocate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3841540">//&nbsp;a&nbsp;clone&nbsp;to&nbsp;snapshot&nbsp;the&nbsp;logically&nbsp;written&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3841594"><a href="/net/http/server.go.html#3841332">w</a></span><span class="op" id="3841595">.</span><span class="ident" id="3841596">cw</span><span class="op" id="3841598">.</span><span class="ident" id="3841599">header</span>&nbsp;<span class="op" id="3841606">=</span>&nbsp;<span class="ident" id="3841608"><a href="/net/http/server.go.html#3841332">w</a></span><span class="op" id="3841609">.</span><span class="ident" id="3841610">handlerHeader</span><span class="op" id="3841623">.</span><span class="ident" id="3841624">clone</span><span class="op" id="3841629">(</span><span class="op" id="3841630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3841633">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3841636"><a href="/net/http/server.go.html#3841332">w</a></span><span class="op" id="3841637">.</span><span class="ident" id="3841638">calledHeader</span>&nbsp;<span class="op" id="3841651">=</span>&nbsp;<span class="ident" id="3841653">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3841659">return</span>&nbsp;<span class="ident" id="3841666"><a href="/net/http/server.go.html#3841332">w</a></span><span class="op" id="3841667">.</span><span class="ident" id="3841668">handlerHeader</span><br>
<span class="lineno"></span><span class="op" id="3841682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3841685">//&nbsp;maxPostHandlerReadBytes&nbsp;is&nbsp;the&nbsp;max&nbsp;number&nbsp;of&nbsp;Request.Body&nbsp;bytes&nbsp;not</span><br>
<span class="lineno">620</span><span class="comment" id="3841756">//&nbsp;consumed&nbsp;by&nbsp;a&nbsp;handler&nbsp;that&nbsp;the&nbsp;server&nbsp;will&nbsp;read&nbsp;from&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="3841823">//&nbsp;in&nbsp;order&nbsp;to&nbsp;keep&nbsp;a&nbsp;connection&nbsp;alive.&nbsp;&nbsp;If&nbsp;there&nbsp;are&nbsp;more&nbsp;bytes&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="3841893">//&nbsp;this&nbsp;then&nbsp;the&nbsp;server&nbsp;to&nbsp;be&nbsp;paranoid&nbsp;instead&nbsp;sends&nbsp;a&nbsp;&#34;Connection:</span><br>
<span class="lineno"></span><span class="comment" id="3841961">//&nbsp;close&#34;&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="3841981">//</span><br>
<span class="lineno">625</span><span class="comment" id="3841984">//&nbsp;This&nbsp;number&nbsp;is&nbsp;approximately&nbsp;what&nbsp;a&nbsp;typical&nbsp;machine&#39;s&nbsp;TCP&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="3842052">//&nbsp;size&nbsp;is&nbsp;anyway.&nbsp;&nbsp;(if&nbsp;we&nbsp;have&nbsp;the&nbsp;bytes&nbsp;on&nbsp;the&nbsp;machine,&nbsp;we&nbsp;might&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="3842122">//&nbsp;well&nbsp;read&nbsp;them)</span><br>
<span class="lineno"></span><span class="keyword" id="3842141">const</span>&nbsp;<span class="ident" id="3842147">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="3842171">=</span>&nbsp;<span class="num" id="3842173">256</span>&nbsp;<span class="op" id="3842177">&lt;&lt;</span>&nbsp;<span class="num" id="3842180">10</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="3842184">func</span>&nbsp;<span class="op" id="3842189">(</span><span class="ident" id="3842190">w</span>&nbsp;<span class="op" id="3842192">*</span><span class="ident" id="3842193"><a href="/net/http/server.go.html#3833137">response</a></span><span class="op" id="3842201">)</span>&nbsp;<span class="ident" id="3842203">WriteHeader</span><span class="op" id="3842214">(</span><span class="ident" id="3842215">code</span>&nbsp;<span class="builtintype" id="3842220">int</span><span class="op" id="3842223">)</span>&nbsp;<span class="op" id="3842225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842228">if</span>&nbsp;<span class="ident" id="3842231"><a href="/net/http/server.go.html#3842190">w</a></span><span class="op" id="3842232">.</span><span class="ident" id="3842233">conn</span><span class="op" id="3842237">.</span><span class="ident" id="3842238">hijacked</span><span class="op" id="3842246">(</span><span class="op" id="3842247">)</span>&nbsp;<span class="op" id="3842249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842253"><a href="/net/http/server.go.html#3842190">w</a></span><span class="op" id="3842254">.</span><span class="ident" id="3842255">conn</span><span class="op" id="3842259">.</span><span class="ident" id="3842260">server</span><span class="op" id="3842266">.</span><span class="ident" id="3842267">logf</span><span class="op" id="3842271">(</span><span class="string" id="3842272">&#34;http:&nbsp;response.WriteHeader&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="3842323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842327">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3842335">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842338">if</span>&nbsp;<span class="ident" id="3842341"><a href="/net/http/server.go.html#3842190">w</a></span><span class="op" id="3842342">.</span><span class="ident" id="3842343">wroteHeader</span>&nbsp;<span class="op" id="3842355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842359"><a href="/net/http/server.go.html#3842190">w</a></span><span class="op" id="3842360">.</span><span class="ident" id="3842361">conn</span><span class="op" id="3842365">.</span><span class="ident" id="3842366">server</span><span class="op" id="3842372">.</span><span class="ident" id="3842373">logf</span><span class="op" id="3842377">(</span><span class="string" id="3842378">&#34;http:&nbsp;multiple&nbsp;response.WriteHeader&nbsp;calls&#34;</span><span class="op" id="3842421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842425">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3842433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842436"><a href="/net/http/server.go.html#3842190">w</a></span><span class="op" id="3842437">.</span><span class="ident" id="3842438">wroteHeader</span>&nbsp;<span class="op" id="3842450">=</span>&nbsp;<span class="ident" id="3842452">true</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842458"><a href="/net/http/server.go.html#3842190">w</a></span><span class="op" id="3842459">.</span><span class="ident" id="3842460">status</span>&nbsp;<span class="op" id="3842467">=</span>&nbsp;<span class="ident" id="3842469"><a href="/net/http/server.go.html#3842215">code</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842476">if</span>&nbsp;<span class="ident" id="3842479"><a href="/net/http/server.go.html#3842190">w</a></span><span class="op" id="3842480">.</span><span class="ident" id="3842481">calledHeader</span>&nbsp;<span class="op" id="3842494">&amp;&amp;</span>&nbsp;<span class="ident" id="3842497"><a href="/net/http/server.go.html#3842190">w</a></span><span class="op" id="3842498">.</span><span class="ident" id="3842499">cw</span><span class="op" id="3842501">.</span><span class="ident" id="3842502">header</span>&nbsp;<span class="op" id="3842509">==</span>&nbsp;<span class="ident" id="3842512">nil</span>&nbsp;<span class="op" id="3842516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842520"><a href="/net/http/server.go.html#3842190">w</a></span><span class="op" id="3842521">.</span><span class="ident" id="3842522">cw</span><span class="op" id="3842524">.</span><span class="ident" id="3842525">header</span>&nbsp;<span class="op" id="3842532">=</span>&nbsp;<span class="ident" id="3842534"><a href="/net/http/server.go.html#3842190">w</a></span><span class="op" id="3842535">.</span><span class="ident" id="3842536">handlerHeader</span><span class="op" id="3842549">.</span><span class="ident" id="3842550">clone</span><span class="op" id="3842555">(</span><span class="op" id="3842556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3842559">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842563">if</span>&nbsp;<span class="ident" id="3842566">cl</span>&nbsp;<span class="op" id="3842569">:=</span>&nbsp;<span class="ident" id="3842572"><a href="/net/http/server.go.html#3842190">w</a></span><span class="op" id="3842573">.</span><span class="ident" id="3842574">handlerHeader</span><span class="op" id="3842587">.</span><span class="ident" id="3842588">get</span><span class="op" id="3842591">(</span><span class="string" id="3842592">&#34;Content-Length&#34;</span><span class="op" id="3842608">)</span><span class="op" id="3842609">;</span>&nbsp;<span class="ident" id="3842611"><a href="/net/http/server.go.html#3842566">cl</a></span>&nbsp;<span class="op" id="3842614">!=</span>&nbsp;<span class="string" id="3842617">&#34;&#34;</span>&nbsp;<span class="op" id="3842620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842624">v</span><span class="op" id="3842625">,</span>&nbsp;<span class="ident" id="3842627">err</span>&nbsp;<span class="op" id="3842631">:=</span>&nbsp;<span class="ident" id="3842634"><a href="/net/http/server.go.html#3824853">strconv</a></span><span class="op" id="3842641">.</span><span class="ident" id="3842642">ParseInt</span><span class="op" id="3842650">(</span><span class="ident" id="3842651"><a href="/net/http/server.go.html#3842566">cl</a></span><span class="op" id="3842653">,</span>&nbsp;<span class="num" id="3842655">10</span><span class="op" id="3842657">,</span>&nbsp;<span class="num" id="3842659">64</span><span class="op" id="3842661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3842665">if</span>&nbsp;<span class="ident" id="3842668"><a href="/net/http/server.go.html#3842627">err</a></span>&nbsp;<span class="op" id="3842672">==</span>&nbsp;<span class="ident" id="3842675">nil</span>&nbsp;<span class="op" id="3842679">&amp;&amp;</span>&nbsp;<span class="ident" id="3842682"><a href="/net/http/server.go.html#3842624">v</a></span>&nbsp;<span class="op" id="3842684">&gt;=</span>&nbsp;<span class="num" id="3842687">0</span>&nbsp;<span class="op" id="3842689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842694"><a href="/net/http/server.go.html#3842190">w</a></span><span class="op" id="3842695">.</span><span class="ident" id="3842696">contentLength</span>&nbsp;<span class="op" id="3842710">=</span>&nbsp;<span class="ident" id="3842712"><a href="/net/http/server.go.html#3842624">v</a></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3842716">}</span>&nbsp;<span class="keyword" id="3842718">else</span>&nbsp;<span class="op" id="3842723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842728"><a href="/net/http/server.go.html#3842190">w</a></span><span class="op" id="3842729">.</span><span class="ident" id="3842730">conn</span><span class="op" id="3842734">.</span><span class="ident" id="3842735">server</span><span class="op" id="3842741">.</span><span class="ident" id="3842742">logf</span><span class="op" id="3842746">(</span><span class="string" id="3842747">&#34;http:&nbsp;invalid&nbsp;Content-Length&nbsp;of&nbsp;%q&#34;</span><span class="op" id="3842783">,</span>&nbsp;<span class="ident" id="3842785"><a href="/net/http/server.go.html#3842566">cl</a></span><span class="op" id="3842787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3842792"><a href="/net/http/server.go.html#3842190">w</a></span><span class="op" id="3842793">.</span><span class="ident" id="3842794">handlerHeader</span><span class="op" id="3842807">.</span><span class="ident" id="3842808">Del</span><span class="op" id="3842811">(</span><span class="string" id="3842812">&#34;Content-Length&#34;</span><span class="op" id="3842828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3842832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3842835">}</span><br>
<span class="lineno">655</span><span class="op" id="3842837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3842840">//&nbsp;extraHeader&nbsp;is&nbsp;the&nbsp;set&nbsp;of&nbsp;headers&nbsp;sometimes&nbsp;added&nbsp;by&nbsp;chunkWriter.writeHeader.</span><br>
<span class="lineno"></span><span class="comment" id="3842921">//&nbsp;This&nbsp;type&nbsp;is&nbsp;used&nbsp;to&nbsp;avoid&nbsp;extra&nbsp;allocations&nbsp;from&nbsp;cloning&nbsp;and/or&nbsp;populating</span><br>
<span class="lineno"></span><span class="comment" id="3843000">//&nbsp;the&nbsp;response&nbsp;Header&nbsp;map&nbsp;and&nbsp;all&nbsp;its&nbsp;1-element&nbsp;slices.</span><br>
<span class="lineno">660</span><span class="keyword" id="3843057">type</span>&nbsp;<span class="ident" id="3843062">extraHeader</span>&nbsp;<span class="keyword" id="3843074">struct</span>&nbsp;<span class="op" id="3843081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843084">contentType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3843101">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843109">connection</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3843126">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843134">transferEncoding</span>&nbsp;<span class="builtintype" id="3843151">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843159">date</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3843176">[</span><span class="op" id="3843177">]</span><span class="builtintype" id="3843178">byte</span>&nbsp;<span class="comment" id="3843183">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843206">contentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3843223">[</span><span class="op" id="3843224">]</span><span class="builtintype" id="3843225">byte</span>&nbsp;<span class="comment" id="3843230">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="3843252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3843255">//&nbsp;Sorted&nbsp;the&nbsp;same&nbsp;as&nbsp;extraHeader.Write&#39;s&nbsp;loop.</span><br>
<span class="lineno"></span><span class="keyword" id="3843303">var</span>&nbsp;<span class="ident" id="3843307">extraHeaderKeys</span>&nbsp;<span class="op" id="3843323">=</span>&nbsp;<span class="op" id="3843325">[</span><span class="op" id="3843326">]</span><span class="op" id="3843327">[</span><span class="op" id="3843328">]</span><span class="builtintype" id="3843329">byte</span><span class="op" id="3843333">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3843336">[</span><span class="op" id="3843337">]</span><span class="builtintype" id="3843338">byte</span><span class="op" id="3843342">(</span><span class="string" id="3843343">&#34;Content-Type&#34;</span><span class="op" id="3843357">)</span><span class="op" id="3843358">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3843361">[</span><span class="op" id="3843362">]</span><span class="builtintype" id="3843363">byte</span><span class="op" id="3843367">(</span><span class="string" id="3843368">&#34;Connection&#34;</span><span class="op" id="3843380">)</span><span class="op" id="3843381">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3843384">[</span><span class="op" id="3843385">]</span><span class="builtintype" id="3843386">byte</span><span class="op" id="3843390">(</span><span class="string" id="3843391">&#34;Transfer-Encoding&#34;</span><span class="op" id="3843410">)</span><span class="op" id="3843411">,</span><br>
<span class="lineno"></span><span class="op" id="3843413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span><span class="keyword" id="3843416">var</span>&nbsp;<span class="op" id="3843420">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843423">headerContentLength</span>&nbsp;<span class="op" id="3843443">=</span>&nbsp;<span class="op" id="3843445">[</span><span class="op" id="3843446">]</span><span class="builtintype" id="3843447">byte</span><span class="op" id="3843451">(</span><span class="string" id="3843452">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="3843470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843473">headerDate</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3843493">=</span>&nbsp;<span class="op" id="3843495">[</span><span class="op" id="3843496">]</span><span class="builtintype" id="3843497">byte</span><span class="op" id="3843501">(</span><span class="string" id="3843502">&#34;Date:&nbsp;&#34;</span><span class="op" id="3843510">)</span><br>
<span class="lineno"></span><span class="op" id="3843512">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="comment" id="3843515">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;headers&nbsp;described&nbsp;in&nbsp;h&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="3843564">//</span><br>
<span class="lineno"></span><span class="comment" id="3843567">//&nbsp;This&nbsp;method&nbsp;has&nbsp;a&nbsp;value&nbsp;receiver,&nbsp;despite&nbsp;the&nbsp;somewhat&nbsp;large&nbsp;size</span><br>
<span class="lineno"></span><span class="comment" id="3843636">//&nbsp;of&nbsp;h,&nbsp;because&nbsp;it&nbsp;prevents&nbsp;an&nbsp;allocation.&nbsp;The&nbsp;escape&nbsp;analysis&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="3843706">//&nbsp;smart&nbsp;enough&nbsp;to&nbsp;realize&nbsp;this&nbsp;function&nbsp;doesn&#39;t&nbsp;mutate&nbsp;h.</span><br>
<span class="lineno">685</span><span class="keyword" id="3843765">func</span>&nbsp;<span class="op" id="3843770">(</span><span class="ident" id="3843771">h</span>&nbsp;<span class="ident" id="3843773"><a href="/net/http/server.go.html#3843062">extraHeader</a></span><span class="op" id="3843784">)</span>&nbsp;<span class="ident" id="3843786">Write</span><span class="op" id="3843791">(</span><span class="ident" id="3843792">w</span>&nbsp;<span class="op" id="3843794">*</span><span class="ident" id="3843795"><a href="/net/http/server.go.html#3824744">bufio</a></span><span class="op" id="3843800">.</span><span class="ident" id="3843801">Writer</span><span class="op" id="3843807">)</span>&nbsp;<span class="op" id="3843809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3843812">if</span>&nbsp;<span class="ident" id="3843815"><a href="/net/http/server.go.html#3843771">h</a></span><span class="op" id="3843816">.</span><span class="ident" id="3843817">date</span>&nbsp;<span class="op" id="3843822">!=</span>&nbsp;<span class="ident" id="3843825">nil</span>&nbsp;<span class="op" id="3843829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843833"><a href="/net/http/server.go.html#3843792">w</a></span><span class="op" id="3843834">.</span><span class="ident" id="3843835">Write</span><span class="op" id="3843840">(</span><span class="ident" id="3843841"><a href="/net/http/server.go.html#3843473">headerDate</a></span><span class="op" id="3843851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843855"><a href="/net/http/server.go.html#3843792">w</a></span><span class="op" id="3843856">.</span><span class="ident" id="3843857">Write</span><span class="op" id="3843862">(</span><span class="ident" id="3843863"><a href="/net/http/server.go.html#3843771">h</a></span><span class="op" id="3843864">.</span><span class="ident" id="3843865">date</span><span class="op" id="3843869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843873"><a href="/net/http/server.go.html#3843792">w</a></span><span class="op" id="3843874">.</span><span class="ident" id="3843875">Write</span><span class="op" id="3843880">(</span><span class="ident" id="3843881"><a href="/net/http/server.go.html#3832152">crlf</a></span><span class="op" id="3843885">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3843888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3843891">if</span>&nbsp;<span class="ident" id="3843894"><a href="/net/http/server.go.html#3843771">h</a></span><span class="op" id="3843895">.</span><span class="ident" id="3843896">contentLength</span>&nbsp;<span class="op" id="3843910">!=</span>&nbsp;<span class="ident" id="3843913">nil</span>&nbsp;<span class="op" id="3843917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843921"><a href="/net/http/server.go.html#3843792">w</a></span><span class="op" id="3843922">.</span><span class="ident" id="3843923">Write</span><span class="op" id="3843928">(</span><span class="ident" id="3843929"><a href="/net/http/server.go.html#3843423">headerContentLength</a></span><span class="op" id="3843948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843952"><a href="/net/http/server.go.html#3843792">w</a></span><span class="op" id="3843953">.</span><span class="ident" id="3843954">Write</span><span class="op" id="3843959">(</span><span class="ident" id="3843960"><a href="/net/http/server.go.html#3843771">h</a></span><span class="op" id="3843961">.</span><span class="ident" id="3843962">contentLength</span><span class="op" id="3843975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3843979"><a href="/net/http/server.go.html#3843792">w</a></span><span class="op" id="3843980">.</span><span class="ident" id="3843981">Write</span><span class="op" id="3843986">(</span><span class="ident" id="3843987"><a href="/net/http/server.go.html#3832152">crlf</a></span><span class="op" id="3843991">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3843994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3843997">for</span>&nbsp;<span class="ident" id="3844001">i</span><span class="op" id="3844002">,</span>&nbsp;<span class="ident" id="3844004">v</span>&nbsp;<span class="op" id="3844006">:=</span>&nbsp;<span class="keyword" id="3844009">range</span>&nbsp;<span class="op" id="3844015">[</span><span class="op" id="3844016">]</span><span class="builtintype" id="3844017">string</span><span class="op" id="3844023">{</span><span class="ident" id="3844024"><a href="/net/http/server.go.html#3843771">h</a></span><span class="op" id="3844025">.</span><span class="ident" id="3844026">contentType</span><span class="op" id="3844037">,</span>&nbsp;<span class="ident" id="3844039"><a href="/net/http/server.go.html#3843771">h</a></span><span class="op" id="3844040">.</span><span class="ident" id="3844041">connection</span><span class="op" id="3844051">,</span>&nbsp;<span class="ident" id="3844053"><a href="/net/http/server.go.html#3843771">h</a></span><span class="op" id="3844054">.</span><span class="ident" id="3844055">transferEncoding</span><span class="op" id="3844071">}</span>&nbsp;<span class="op" id="3844073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3844077">if</span>&nbsp;<span class="ident" id="3844080"><a href="/net/http/server.go.html#3844004">v</a></span>&nbsp;<span class="op" id="3844082">!=</span>&nbsp;<span class="string" id="3844085">&#34;&#34;</span>&nbsp;<span class="op" id="3844088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3844093"><a href="/net/http/server.go.html#3843792">w</a></span><span class="op" id="3844094">.</span><span class="ident" id="3844095">Write</span><span class="op" id="3844100">(</span><span class="ident" id="3844101"><a href="/net/http/server.go.html#3843307">extraHeaderKeys</a></span><span class="op" id="3844116">[</span><span class="ident" id="3844117"><a href="/net/http/server.go.html#3844001">i</a></span><span class="op" id="3844118">]</span><span class="op" id="3844119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3844124"><a href="/net/http/server.go.html#3843792">w</a></span><span class="op" id="3844125">.</span><span class="ident" id="3844126">Write</span><span class="op" id="3844131">(</span><span class="ident" id="3844132"><a href="/net/http/server.go.html#3832181">colonSpace</a></span><span class="op" id="3844142">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3844147"><a href="/net/http/server.go.html#3843792">w</a></span><span class="op" id="3844148">.</span><span class="ident" id="3844149">WriteString</span><span class="op" id="3844160">(</span><span class="ident" id="3844161"><a href="/net/http/server.go.html#3844004">v</a></span><span class="op" id="3844162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3844167"><a href="/net/http/server.go.html#3843792">w</a></span><span class="op" id="3844168">.</span><span class="ident" id="3844169">Write</span><span class="op" id="3844174">(</span><span class="ident" id="3844175"><a href="/net/http/server.go.html#3832152">crlf</a></span><span class="op" id="3844179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3844183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3844186">}</span><br>
<span class="lineno"></span><span class="op" id="3844188">}</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span><span class="comment" id="3844191">//&nbsp;writeHeader&nbsp;finalizes&nbsp;the&nbsp;header&nbsp;sent&nbsp;to&nbsp;the&nbsp;client&nbsp;and&nbsp;writes&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3844260">//&nbsp;to&nbsp;cw.res.conn.buf.</span><br>
<span class="lineno"></span><span class="comment" id="3844283">//</span><br>
<span class="lineno"></span><span class="comment" id="3844286">//&nbsp;p&nbsp;is&nbsp;not&nbsp;written&nbsp;by&nbsp;writeHeader,&nbsp;but&nbsp;is&nbsp;the&nbsp;first&nbsp;chunk&nbsp;of&nbsp;the&nbsp;body</span><br>
<span class="lineno">710</span><span class="comment" id="3844357">//&nbsp;that&nbsp;will&nbsp;be&nbsp;written.&nbsp;&nbsp;It&nbsp;is&nbsp;sniffed&nbsp;for&nbsp;a&nbsp;Content-Type&nbsp;if&nbsp;none&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3844427">//&nbsp;set&nbsp;explicitly.&nbsp;&nbsp;It&#39;s&nbsp;also&nbsp;used&nbsp;to&nbsp;set&nbsp;the&nbsp;Content-Length,&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3844496">//&nbsp;total&nbsp;body&nbsp;size&nbsp;was&nbsp;small&nbsp;and&nbsp;the&nbsp;handler&nbsp;has&nbsp;already&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="3844562">//&nbsp;running.</span><br>
<span class="lineno"></span><span class="keyword" id="3844574">func</span>&nbsp;<span class="op" id="3844579">(</span><span class="ident" id="3844580">cw</span>&nbsp;<span class="op" id="3844583">*</span><span class="ident" id="3844584"><a href="/net/http/server.go.html#3831554">chunkWriter</a></span><span class="op" id="3844595">)</span>&nbsp;<span class="ident" id="3844597">writeHeader</span><span class="op" id="3844608">(</span><span class="ident" id="3844609">p</span>&nbsp;<span class="op" id="3844611">[</span><span class="op" id="3844612">]</span><span class="builtintype" id="3844613">byte</span><span class="op" id="3844617">)</span>&nbsp;<span class="op" id="3844619">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3844622">if</span>&nbsp;<span class="ident" id="3844625"><a href="/net/http/server.go.html#3844580">cw</a></span><span class="op" id="3844627">.</span><span class="ident" id="3844628">wroteHeader</span>&nbsp;<span class="op" id="3844640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3844644">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3844652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3844655"><a href="/net/http/server.go.html#3844580">cw</a></span><span class="op" id="3844657">.</span><span class="ident" id="3844658">wroteHeader</span>&nbsp;<span class="op" id="3844670">=</span>&nbsp;<span class="ident" id="3844672">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3844679">w</span>&nbsp;<span class="op" id="3844681">:=</span>&nbsp;<span class="ident" id="3844684"><a href="/net/http/server.go.html#3844580">cw</a></span><span class="op" id="3844686">.</span><span class="ident" id="3844687">res</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3844692">keepAlivesEnabled</span>&nbsp;<span class="op" id="3844710">:=</span>&nbsp;<span class="ident" id="3844713"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3844714">.</span><span class="ident" id="3844715">conn</span><span class="op" id="3844719">.</span><span class="ident" id="3844720">server</span><span class="op" id="3844726">.</span><span class="ident" id="3844727">doKeepAlives</span><span class="op" id="3844739">(</span><span class="op" id="3844740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3844743">isHEAD</span>&nbsp;<span class="op" id="3844750">:=</span>&nbsp;<span class="ident" id="3844753"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3844754">.</span><span class="ident" id="3844755">req</span><span class="op" id="3844758">.</span><span class="ident" id="3844759">Method</span>&nbsp;<span class="op" id="3844766">==</span>&nbsp;<span class="string" id="3844769">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3844778">//&nbsp;header&nbsp;is&nbsp;written&nbsp;out&nbsp;to&nbsp;w.conn.buf&nbsp;below.&nbsp;Depending&nbsp;on&nbsp;the</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3844842">//&nbsp;state&nbsp;of&nbsp;the&nbsp;handler,&nbsp;we&nbsp;either&nbsp;own&nbsp;the&nbsp;map&nbsp;or&nbsp;not.&nbsp;If&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3844904">//&nbsp;don&#39;t&nbsp;own&nbsp;it,&nbsp;the&nbsp;exclude&nbsp;map&nbsp;is&nbsp;created&nbsp;lazily&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3844960">//&nbsp;WriteSubset&nbsp;to&nbsp;remove&nbsp;headers.&nbsp;The&nbsp;setHeader&nbsp;struct&nbsp;holds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3845022">//&nbsp;headers&nbsp;we&nbsp;need&nbsp;to&nbsp;add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845050">header</span>&nbsp;<span class="op" id="3845057">:=</span>&nbsp;<span class="ident" id="3845060"><a href="/net/http/server.go.html#3844580">cw</a></span><span class="op" id="3845062">.</span><span class="ident" id="3845063">header</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845071">owned</span>&nbsp;<span class="op" id="3845077">:=</span>&nbsp;<span class="ident" id="3845080"><a href="/net/http/server.go.html#3845050">header</a></span>&nbsp;<span class="op" id="3845087">!=</span>&nbsp;<span class="ident" id="3845090">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845095">if</span>&nbsp;<span class="op" id="3845098">!</span><span class="ident" id="3845099"><a href="/net/http/server.go.html#3845071">owned</a></span>&nbsp;<span class="op" id="3845105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845109"><a href="/net/http/server.go.html#3845050">header</a></span>&nbsp;<span class="op" id="3845116">=</span>&nbsp;<span class="ident" id="3845118"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3845119">.</span><span class="ident" id="3845120">handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3845135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845138">var</span>&nbsp;<span class="ident" id="3845142">excludeHeader</span>&nbsp;<span class="keyword" id="3845156">map</span><span class="op" id="3845159">[</span><span class="builtintype" id="3845160">string</span><span class="op" id="3845166">]</span><span class="builtintype" id="3845167">bool</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845173">delHeader</span>&nbsp;<span class="op" id="3845183">:=</span>&nbsp;<span class="keyword" id="3845186">func</span><span class="op" id="3845190">(</span><span class="ident" id="3845191">key</span>&nbsp;<span class="builtintype" id="3845195">string</span><span class="op" id="3845201">)</span>&nbsp;<span class="op" id="3845203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845207">if</span>&nbsp;<span class="ident" id="3845210"><a href="/net/http/server.go.html#3845071">owned</a></span>&nbsp;<span class="op" id="3845216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845221"><a href="/net/http/server.go.html#3845050">header</a></span><span class="op" id="3845227">.</span><span class="ident" id="3845228">Del</span><span class="op" id="3845231">(</span><span class="ident" id="3845232"><a href="/net/http/server.go.html#3845191">key</a></span><span class="op" id="3845235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845240">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3845249">}</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845253">if</span>&nbsp;<span class="ident" id="3845256">_</span><span class="op" id="3845257">,</span>&nbsp;<span class="ident" id="3845259">ok</span>&nbsp;<span class="op" id="3845262">:=</span>&nbsp;<span class="ident" id="3845265"><a href="/net/http/server.go.html#3845050">header</a></span><span class="op" id="3845271">[</span><span class="ident" id="3845272"><a href="/net/http/server.go.html#3845191">key</a></span><span class="op" id="3845275">]</span><span class="op" id="3845276">;</span>&nbsp;<span class="op" id="3845278">!</span><span class="ident" id="3845279"><a href="/net/http/server.go.html#3845259">ok</a></span>&nbsp;<span class="op" id="3845282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845287">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3845296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845300">if</span>&nbsp;<span class="ident" id="3845303"><a href="/net/http/server.go.html#3845142">excludeHeader</a></span>&nbsp;<span class="op" id="3845317">==</span>&nbsp;<span class="ident" id="3845320">nil</span>&nbsp;<span class="op" id="3845324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845329"><a href="/net/http/server.go.html#3845142">excludeHeader</a></span>&nbsp;<span class="op" id="3845343">=</span>&nbsp;<span class="builtinfunc" id="3845345">make</span><span class="op" id="3845349">(</span><span class="keyword" id="3845350">map</span><span class="op" id="3845353">[</span><span class="builtintype" id="3845354">string</span><span class="op" id="3845360">]</span><span class="builtintype" id="3845361">bool</span><span class="op" id="3845365">)</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3845369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3845373"><a href="/net/http/server.go.html#3845142">excludeHeader</a></span><span class="op" id="3845386">[</span><span class="ident" id="3845387"><a href="/net/http/server.go.html#3845191">key</a></span><span class="op" id="3845390">]</span>&nbsp;<span class="op" id="3845392">=</span>&nbsp;<span class="ident" id="3845394">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3845400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3845403">var</span>&nbsp;<span class="ident" id="3845407">setHeader</span>&nbsp;<span class="ident" id="3845417"><a href="/net/http/server.go.html#3843062">extraHeader</a></span><br>
<span class="lineno"></span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3845431">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;is&nbsp;done&nbsp;but&nbsp;never&nbsp;sent&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3845490">//&nbsp;response&nbsp;header&nbsp;and&nbsp;this&nbsp;is&nbsp;our&nbsp;first&nbsp;(and&nbsp;last)&nbsp;write,&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3845554">//&nbsp;it,&nbsp;even&nbsp;to&nbsp;zero.&nbsp;This&nbsp;helps&nbsp;HTTP/1.0&nbsp;clients&nbsp;keep&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3845615">//&nbsp;&#34;keep-alive&#34;&nbsp;connections&nbsp;alive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3845651">//&nbsp;Exceptions:&nbsp;304/204/1xx&nbsp;responses&nbsp;never&nbsp;get&nbsp;Content-Length,&nbsp;and&nbsp;if</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3845722">//&nbsp;it&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;difference&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3845786">//&nbsp;0&nbsp;actual&nbsp;bytes&nbsp;and&nbsp;0&nbsp;bytes&nbsp;because&nbsp;the&nbsp;handler&nbsp;noticed&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3845848">//&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request&nbsp;and&nbsp;chose&nbsp;not&nbsp;to&nbsp;write&nbsp;anything.&nbsp;&nbsp;So&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3845912">//&nbsp;HEAD,&nbsp;the&nbsp;handler&nbsp;should&nbsp;either&nbsp;write&nbsp;the&nbsp;Content-Length&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3845976">//&nbsp;write&nbsp;non-zero&nbsp;bytes.&nbsp;&nbsp;If&nbsp;it&#39;s&nbsp;actually&nbsp;0&nbsp;bytes&nbsp;and&nbsp;the</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846036">//&nbsp;handler&nbsp;never&nbsp;looked&nbsp;at&nbsp;the&nbsp;Request.Method,&nbsp;we&nbsp;just&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846098">//&nbsp;send&nbsp;a&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3846132">if</span>&nbsp;<span class="ident" id="3846135"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3846136">.</span><span class="ident" id="3846137">handlerDone</span>&nbsp;<span class="op" id="3846149">&amp;&amp;</span>&nbsp;<span class="ident" id="3846152"><a href="/net/http/transfer.go.html#3902575">bodyAllowedForStatus</a></span><span class="op" id="3846172">(</span><span class="ident" id="3846173"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3846174">.</span><span class="ident" id="3846175">status</span><span class="op" id="3846181">)</span>&nbsp;<span class="op" id="3846183">&amp;&amp;</span>&nbsp;<span class="ident" id="3846186"><a href="/net/http/server.go.html#3845050">header</a></span><span class="op" id="3846192">.</span><span class="ident" id="3846193">get</span><span class="op" id="3846196">(</span><span class="string" id="3846197">&#34;Content-Length&#34;</span><span class="op" id="3846213">)</span>&nbsp;<span class="op" id="3846215">==</span>&nbsp;<span class="string" id="3846218">&#34;&#34;</span>&nbsp;<span class="op" id="3846221">&amp;&amp;</span>&nbsp;<span class="op" id="3846224">(</span><span class="op" id="3846225">!</span><span class="ident" id="3846226"><a href="/net/http/server.go.html#3844743">isHEAD</a></span>&nbsp;<span class="op" id="3846233">||</span>&nbsp;<span class="builtinfunc" id="3846236">len</span><span class="op" id="3846239">(</span><span class="ident" id="3846240"><a href="/net/http/server.go.html#3844609">p</a></span><span class="op" id="3846241">)</span>&nbsp;<span class="op" id="3846243">&gt;</span>&nbsp;<span class="num" id="3846245">0</span><span class="op" id="3846246">)</span>&nbsp;<span class="op" id="3846248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846252"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3846253">.</span><span class="ident" id="3846254">contentLength</span>&nbsp;<span class="op" id="3846268">=</span>&nbsp;<span class="ident" id="3846270">int64</span><span class="op" id="3846275">(</span><span class="builtinfunc" id="3846276">len</span><span class="op" id="3846279">(</span><span class="ident" id="3846280"><a href="/net/http/server.go.html#3844609">p</a></span><span class="op" id="3846281">)</span><span class="op" id="3846282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846286"><a href="/net/http/server.go.html#3845407">setHeader</a></span><span class="op" id="3846295">.</span><span class="ident" id="3846296">contentLength</span>&nbsp;<span class="op" id="3846310">=</span>&nbsp;<span class="ident" id="3846312"><a href="/net/http/server.go.html#3824853">strconv</a></span><span class="op" id="3846319">.</span><span class="ident" id="3846320">AppendInt</span><span class="op" id="3846329">(</span><span class="ident" id="3846330"><a href="/net/http/server.go.html#3844580">cw</a></span><span class="op" id="3846332">.</span><span class="ident" id="3846333">res</span><span class="op" id="3846336">.</span><span class="ident" id="3846337">clenBuf</span><span class="op" id="3846344">[</span><span class="op" id="3846345">:</span><span class="num" id="3846346">0</span><span class="op" id="3846347">]</span><span class="op" id="3846348">,</span>&nbsp;<span class="ident" id="3846350">int64</span><span class="op" id="3846355">(</span><span class="builtinfunc" id="3846356">len</span><span class="op" id="3846359">(</span><span class="ident" id="3846360"><a href="/net/http/server.go.html#3844609">p</a></span><span class="op" id="3846361">)</span><span class="op" id="3846362">)</span><span class="op" id="3846363">,</span>&nbsp;<span class="num" id="3846365">10</span><span class="op" id="3846367">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3846370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846374">//&nbsp;If&nbsp;this&nbsp;was&nbsp;an&nbsp;HTTP/1.0&nbsp;request&nbsp;with&nbsp;keep-alive&nbsp;and&nbsp;we&nbsp;sent&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846440">//&nbsp;Content-Length&nbsp;back,&nbsp;we&nbsp;can&nbsp;make&nbsp;this&nbsp;a&nbsp;keep-alive&nbsp;response&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3846508">if</span>&nbsp;<span class="ident" id="3846511"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3846512">.</span><span class="ident" id="3846513">req</span><span class="op" id="3846516">.</span><span class="ident" id="3846517">wantsHttp10KeepAlive</span><span class="op" id="3846537">(</span><span class="op" id="3846538">)</span>&nbsp;<span class="op" id="3846540">&amp;&amp;</span>&nbsp;<span class="ident" id="3846543"><a href="/net/http/server.go.html#3844692">keepAlivesEnabled</a></span>&nbsp;<span class="op" id="3846561">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846565">sentLength</span>&nbsp;<span class="op" id="3846576">:=</span>&nbsp;<span class="ident" id="3846579"><a href="/net/http/server.go.html#3845050">header</a></span><span class="op" id="3846585">.</span><span class="ident" id="3846586">get</span><span class="op" id="3846589">(</span><span class="string" id="3846590">&#34;Content-Length&#34;</span><span class="op" id="3846606">)</span>&nbsp;<span class="op" id="3846608">!=</span>&nbsp;<span class="string" id="3846611">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3846616">if</span>&nbsp;<span class="ident" id="3846619"><a href="/net/http/server.go.html#3846565">sentLength</a></span>&nbsp;<span class="op" id="3846630">&amp;&amp;</span>&nbsp;<span class="ident" id="3846633"><a href="/net/http/server.go.html#3845050">header</a></span><span class="op" id="3846639">.</span><span class="ident" id="3846640">get</span><span class="op" id="3846643">(</span><span class="string" id="3846644">&#34;Connection&#34;</span><span class="op" id="3846656">)</span>&nbsp;<span class="op" id="3846658">==</span>&nbsp;<span class="string" id="3846661">&#34;keep-alive&#34;</span>&nbsp;<span class="op" id="3846674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846679"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3846680">.</span><span class="ident" id="3846681">closeAfterReply</span>&nbsp;<span class="op" id="3846697">=</span>&nbsp;<span class="ident" id="3846699">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3846707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3846710">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3846714">//&nbsp;Check&nbsp;for&nbsp;a&nbsp;explicit&nbsp;(and&nbsp;valid)&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846774">hasCL</span>&nbsp;<span class="op" id="3846780">:=</span>&nbsp;<span class="ident" id="3846783"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3846784">.</span><span class="ident" id="3846785">contentLength</span>&nbsp;<span class="op" id="3846799">!=</span>&nbsp;<span class="op" id="3846802">-</span><span class="num" id="3846803">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3846807">if</span>&nbsp;<span class="ident" id="3846810"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3846811">.</span><span class="ident" id="3846812">req</span><span class="op" id="3846815">.</span><span class="ident" id="3846816">wantsHttp10KeepAlive</span><span class="op" id="3846836">(</span><span class="op" id="3846837">)</span>&nbsp;<span class="op" id="3846839">&amp;&amp;</span>&nbsp;<span class="op" id="3846842">(</span><span class="ident" id="3846843"><a href="/net/http/server.go.html#3844743">isHEAD</a></span>&nbsp;<span class="op" id="3846850">||</span>&nbsp;<span class="ident" id="3846853"><a href="/net/http/server.go.html#3846774">hasCL</a></span><span class="op" id="3846858">)</span>&nbsp;<span class="op" id="3846860">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846864">_</span><span class="op" id="3846865">,</span>&nbsp;<span class="ident" id="3846867">connectionHeaderSet</span>&nbsp;<span class="op" id="3846887">:=</span>&nbsp;<span class="ident" id="3846890"><a href="/net/http/server.go.html#3845050">header</a></span><span class="op" id="3846896">[</span><span class="string" id="3846897">&#34;Connection&#34;</span><span class="op" id="3846909">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3846913">if</span>&nbsp;<span class="op" id="3846916">!</span><span class="ident" id="3846917"><a href="/net/http/server.go.html#3846867">connectionHeaderSet</a></span>&nbsp;<span class="op" id="3846937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3846942"><a href="/net/http/server.go.html#3845407">setHeader</a></span><span class="op" id="3846951">.</span><span class="ident" id="3846952">connection</span>&nbsp;<span class="op" id="3846963">=</span>&nbsp;<span class="string" id="3846965">&#34;keep-alive&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3846980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3846983">}</span>&nbsp;<span class="keyword" id="3846985">else</span>&nbsp;<span class="keyword" id="3846990">if</span>&nbsp;<span class="op" id="3846993">!</span><span class="ident" id="3846994"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3846995">.</span><span class="ident" id="3846996">req</span><span class="op" id="3846999">.</span><span class="ident" id="3847000">ProtoAtLeast</span><span class="op" id="3847012">(</span><span class="num" id="3847013">1</span><span class="op" id="3847014">,</span>&nbsp;<span class="num" id="3847016">1</span><span class="op" id="3847017">)</span>&nbsp;<span class="op" id="3847019">||</span>&nbsp;<span class="ident" id="3847022"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3847023">.</span><span class="ident" id="3847024">req</span><span class="op" id="3847027">.</span><span class="ident" id="3847028">wantsClose</span><span class="op" id="3847038">(</span><span class="op" id="3847039">)</span>&nbsp;<span class="op" id="3847041">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847045"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3847046">.</span><span class="ident" id="3847047">closeAfterReply</span>&nbsp;<span class="op" id="3847063">=</span>&nbsp;<span class="ident" id="3847065">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3847071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847075">if</span>&nbsp;<span class="ident" id="3847078"><a href="/net/http/server.go.html#3845050">header</a></span><span class="op" id="3847084">.</span><span class="ident" id="3847085">get</span><span class="op" id="3847088">(</span><span class="string" id="3847089">&#34;Connection&#34;</span><span class="op" id="3847101">)</span>&nbsp;<span class="op" id="3847103">==</span>&nbsp;<span class="string" id="3847106">&#34;close&#34;</span>&nbsp;<span class="op" id="3847114">||</span>&nbsp;<span class="op" id="3847117">!</span><span class="ident" id="3847118"><a href="/net/http/server.go.html#3844692">keepAlivesEnabled</a></span>&nbsp;<span class="op" id="3847136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847140"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3847141">.</span><span class="ident" id="3847142">closeAfterReply</span>&nbsp;<span class="op" id="3847158">=</span>&nbsp;<span class="ident" id="3847160">true</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3847166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3847170">//&nbsp;Per&nbsp;RFC&nbsp;2616,&nbsp;we&nbsp;should&nbsp;consume&nbsp;the&nbsp;request&nbsp;body&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3847230">//&nbsp;replying,&nbsp;if&nbsp;the&nbsp;handler&nbsp;hasn&#39;t&nbsp;already&nbsp;done&nbsp;so.&nbsp;&nbsp;But&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3847291">//&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;do&nbsp;an&nbsp;unbounded&nbsp;amount&nbsp;of&nbsp;reading&nbsp;here&nbsp;for</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3847352">//&nbsp;DoS&nbsp;reasons,&nbsp;so&nbsp;we&nbsp;only&nbsp;try&nbsp;up&nbsp;to&nbsp;a&nbsp;threshold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847403">if</span>&nbsp;<span class="ident" id="3847406"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3847407">.</span><span class="ident" id="3847408">req</span><span class="op" id="3847411">.</span><span class="ident" id="3847412">ContentLength</span>&nbsp;<span class="op" id="3847426">!=</span>&nbsp;<span class="num" id="3847429">0</span>&nbsp;<span class="op" id="3847431">&amp;&amp;</span>&nbsp;<span class="op" id="3847434">!</span><span class="ident" id="3847435"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3847436">.</span><span class="ident" id="3847437">closeAfterReply</span>&nbsp;<span class="op" id="3847453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847457">ecr</span><span class="op" id="3847460">,</span>&nbsp;<span class="ident" id="3847462">isExpecter</span>&nbsp;<span class="op" id="3847473">:=</span>&nbsp;<span class="ident" id="3847476"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3847477">.</span><span class="ident" id="3847478">req</span><span class="op" id="3847481">.</span><span class="ident" id="3847482">Body</span><span class="op" id="3847486">.</span><span class="op" id="3847487">(</span><span class="op" id="3847488">*</span><span class="ident" id="3847489"><a href="/net/http/server.go.html#3838970">expectContinueReader</a></span><span class="op" id="3847509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847513">if</span>&nbsp;<span class="op" id="3847516">!</span><span class="ident" id="3847517"><a href="/net/http/server.go.html#3847462">isExpecter</a></span>&nbsp;<span class="op" id="3847528">||</span>&nbsp;<span class="ident" id="3847531"><a href="/net/http/server.go.html#3847457">ecr</a></span><span class="op" id="3847534">.</span><span class="ident" id="3847535">resp</span><span class="op" id="3847539">.</span><span class="ident" id="3847540">wroteContinue</span>&nbsp;<span class="op" id="3847554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847559">n</span><span class="op" id="3847560">,</span>&nbsp;<span class="ident" id="3847562">_</span>&nbsp;<span class="op" id="3847564">:=</span>&nbsp;<span class="ident" id="3847567"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3847569">.</span><span class="ident" id="3847570">CopyN</span><span class="op" id="3847575">(</span><span class="ident" id="3847576"><a href="/net/http/server.go.html#3824790">ioutil</a></span><span class="op" id="3847582">.</span><span class="ident" id="3847583">Discard</span><span class="op" id="3847590">,</span>&nbsp;<span class="ident" id="3847592"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3847593">.</span><span class="ident" id="3847594">req</span><span class="op" id="3847597">.</span><span class="ident" id="3847598">Body</span><span class="op" id="3847602">,</span>&nbsp;<span class="ident" id="3847604"><a href="/net/http/server.go.html#3842147">maxPostHandlerReadBytes</a></span><span class="op" id="3847627">+</span><span class="num" id="3847628">1</span><span class="op" id="3847629">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847634">if</span>&nbsp;<span class="ident" id="3847637"><a href="/net/http/server.go.html#3847559">n</a></span>&nbsp;<span class="op" id="3847639">&gt;=</span>&nbsp;<span class="ident" id="3847642"><a href="/net/http/server.go.html#3842147">maxPostHandlerReadBytes</a></span>&nbsp;<span class="op" id="3847666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847672"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3847673">.</span><span class="ident" id="3847674">requestTooLarge</span><span class="op" id="3847689">(</span><span class="op" id="3847690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847696"><a href="/net/http/server.go.html#3845173">delHeader</a></span><span class="op" id="3847705">(</span><span class="string" id="3847706">&#34;Connection&#34;</span><span class="op" id="3847718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847724"><a href="/net/http/server.go.html#3845407">setHeader</a></span><span class="op" id="3847733">.</span><span class="ident" id="3847734">connection</span>&nbsp;<span class="op" id="3847745">=</span>&nbsp;<span class="string" id="3847747">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3847758">}</span>&nbsp;<span class="keyword" id="3847760">else</span>&nbsp;<span class="op" id="3847765">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847771"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3847772">.</span><span class="ident" id="3847773">req</span><span class="op" id="3847776">.</span><span class="ident" id="3847777">Body</span><span class="op" id="3847781">.</span><span class="ident" id="3847782">Close</span><span class="op" id="3847787">(</span><span class="op" id="3847788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3847793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3847797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3847800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847804">code</span>&nbsp;<span class="op" id="3847809">:=</span>&nbsp;<span class="ident" id="3847812"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3847813">.</span><span class="ident" id="3847814">status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847822">if</span>&nbsp;<span class="ident" id="3847825"><a href="/net/http/transfer.go.html#3902575">bodyAllowedForStatus</a></span><span class="op" id="3847845">(</span><span class="ident" id="3847846"><a href="/net/http/server.go.html#3847804">code</a></span><span class="op" id="3847850">)</span>&nbsp;<span class="op" id="3847852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3847856">//&nbsp;If&nbsp;no&nbsp;content&nbsp;type,&nbsp;apply&nbsp;sniffing&nbsp;algorithm&nbsp;to&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847915">_</span><span class="op" id="3847916">,</span>&nbsp;<span class="ident" id="3847918">haveType</span>&nbsp;<span class="op" id="3847927">:=</span>&nbsp;<span class="ident" id="3847930"><a href="/net/http/server.go.html#3845050">header</a></span><span class="op" id="3847936">[</span><span class="string" id="3847937">&#34;Content-Type&#34;</span><span class="op" id="3847951">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3847955">if</span>&nbsp;<span class="op" id="3847958">!</span><span class="ident" id="3847959"><a href="/net/http/server.go.html#3847918">haveType</a></span>&nbsp;<span class="op" id="3847968">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3847973"><a href="/net/http/server.go.html#3845407">setHeader</a></span><span class="op" id="3847982">.</span><span class="ident" id="3847983">contentType</span>&nbsp;<span class="op" id="3847995">=</span>&nbsp;<span class="ident" id="3847997"><a href="/net/http/sniff.go.html#3886741">DetectContentType</a></span><span class="op" id="3848014">(</span><span class="ident" id="3848015"><a href="/net/http/server.go.html#3844609">p</a></span><span class="op" id="3848016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3848020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3848023">}</span>&nbsp;<span class="keyword" id="3848025">else</span>&nbsp;<span class="op" id="3848030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3848034">for</span>&nbsp;<span class="ident" id="3848038">_</span><span class="op" id="3848039">,</span>&nbsp;<span class="ident" id="3848041">k</span>&nbsp;<span class="op" id="3848043">:=</span>&nbsp;<span class="keyword" id="3848046">range</span>&nbsp;<span class="ident" id="3848052"><a href="/net/http/transfer.go.html#3902949">suppressedHeaders</a></span><span class="op" id="3848069">(</span><span class="ident" id="3848070"><a href="/net/http/server.go.html#3847804">code</a></span><span class="op" id="3848074">)</span>&nbsp;<span class="op" id="3848076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848081"><a href="/net/http/server.go.html#3845173">delHeader</a></span><span class="op" id="3848090">(</span><span class="ident" id="3848091"><a href="/net/http/server.go.html#3848041">k</a></span><span class="op" id="3848092">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3848096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3848099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3848103">if</span>&nbsp;<span class="ident" id="3848106">_</span><span class="op" id="3848107">,</span>&nbsp;<span class="ident" id="3848109">ok</span>&nbsp;<span class="op" id="3848112">:=</span>&nbsp;<span class="ident" id="3848115"><a href="/net/http/server.go.html#3845050">header</a></span><span class="op" id="3848121">[</span><span class="string" id="3848122">&#34;Date&#34;</span><span class="op" id="3848128">]</span><span class="op" id="3848129">;</span>&nbsp;<span class="op" id="3848131">!</span><span class="ident" id="3848132"><a href="/net/http/server.go.html#3848109">ok</a></span>&nbsp;<span class="op" id="3848135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848139"><a href="/net/http/server.go.html#3845407">setHeader</a></span><span class="op" id="3848148">.</span><span class="ident" id="3848149">date</span>&nbsp;<span class="op" id="3848154">=</span>&nbsp;<span class="ident" id="3848156"><a href="/net/http/server.go.html#3839848">appendTime</a></span><span class="op" id="3848166">(</span><span class="ident" id="3848167"><a href="/net/http/server.go.html#3844580">cw</a></span><span class="op" id="3848169">.</span><span class="ident" id="3848170">res</span><span class="op" id="3848173">.</span><span class="ident" id="3848174">dateBuf</span><span class="op" id="3848181">[</span><span class="op" id="3848182">:</span><span class="num" id="3848183">0</span><span class="op" id="3848184">]</span><span class="op" id="3848185">,</span>&nbsp;<span class="ident" id="3848187"><a href="/net/http/server.go.html#3824898">time</a></span><span class="op" id="3848191">.</span><span class="ident" id="3848192">Now</span><span class="op" id="3848195">(</span><span class="op" id="3848196">)</span><span class="op" id="3848197">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3848200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848204">te</span>&nbsp;<span class="op" id="3848207">:=</span>&nbsp;<span class="ident" id="3848210"><a href="/net/http/server.go.html#3845050">header</a></span><span class="op" id="3848216">.</span><span class="ident" id="3848217">get</span><span class="op" id="3848220">(</span><span class="string" id="3848221">&#34;Transfer-Encoding&#34;</span><span class="op" id="3848240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848243">hasTE</span>&nbsp;<span class="op" id="3848249">:=</span>&nbsp;<span class="ident" id="3848252"><a href="/net/http/server.go.html#3848204">te</a></span>&nbsp;<span class="op" id="3848255">!=</span>&nbsp;<span class="string" id="3848258">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3848262">if</span>&nbsp;<span class="ident" id="3848265"><a href="/net/http/server.go.html#3846774">hasCL</a></span>&nbsp;<span class="op" id="3848271">&amp;&amp;</span>&nbsp;<span class="ident" id="3848274"><a href="/net/http/server.go.html#3848243">hasTE</a></span>&nbsp;<span class="op" id="3848280">&amp;&amp;</span>&nbsp;<span class="ident" id="3848283"><a href="/net/http/server.go.html#3848204">te</a></span>&nbsp;<span class="op" id="3848286">!=</span>&nbsp;<span class="string" id="3848289">&#34;identity&#34;</span>&nbsp;<span class="op" id="3848300">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3848304">//&nbsp;TODO:&nbsp;return&nbsp;an&nbsp;error&nbsp;if&nbsp;WriteHeader&nbsp;gets&nbsp;a&nbsp;return&nbsp;parameter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3848370">//&nbsp;For&nbsp;now&nbsp;just&nbsp;ignore&nbsp;the&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848415"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3848416">.</span><span class="ident" id="3848417">conn</span><span class="op" id="3848421">.</span><span class="ident" id="3848422">server</span><span class="op" id="3848428">.</span><span class="ident" id="3848429">logf</span><span class="op" id="3848433">(</span><span class="string" id="3848434">&#34;http:&nbsp;WriteHeader&nbsp;called&nbsp;with&nbsp;both&nbsp;Transfer-Encoding&nbsp;of&nbsp;%q&nbsp;and&nbsp;a&nbsp;Content-Length&nbsp;of&nbsp;%d&#34;</span><span class="op" id="3848521">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848526"><a href="/net/http/server.go.html#3848204">te</a></span><span class="op" id="3848528">,</span>&nbsp;<span class="ident" id="3848530"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3848531">.</span><span class="ident" id="3848532">contentLength</span><span class="op" id="3848545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848549"><a href="/net/http/server.go.html#3845173">delHeader</a></span><span class="op" id="3848558">(</span><span class="string" id="3848559">&#34;Content-Length&#34;</span><span class="op" id="3848575">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848579"><a href="/net/http/server.go.html#3846774">hasCL</a></span>&nbsp;<span class="op" id="3848585">=</span>&nbsp;<span class="ident" id="3848587">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3848594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3848598">if</span>&nbsp;<span class="ident" id="3848601"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3848602">.</span><span class="ident" id="3848603">req</span><span class="op" id="3848606">.</span><span class="ident" id="3848607">Method</span>&nbsp;<span class="op" id="3848614">==</span>&nbsp;<span class="string" id="3848617">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3848624">||</span>&nbsp;<span class="op" id="3848627">!</span><span class="ident" id="3848628"><a href="/net/http/transfer.go.html#3902575">bodyAllowedForStatus</a></span><span class="op" id="3848648">(</span><span class="ident" id="3848649"><a href="/net/http/server.go.html#3847804">code</a></span><span class="op" id="3848653">)</span>&nbsp;<span class="op" id="3848655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3848659">//&nbsp;do&nbsp;nothing</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3848674">}</span>&nbsp;<span class="keyword" id="3848676">else</span>&nbsp;<span class="keyword" id="3848681">if</span>&nbsp;<span class="ident" id="3848684"><a href="/net/http/server.go.html#3847804">code</a></span>&nbsp;<span class="op" id="3848689">==</span>&nbsp;<span class="ident" id="3848692"><a href="/net/http/status.go.html#3891810">StatusNoContent</a></span>&nbsp;<span class="op" id="3848708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848712"><a href="/net/http/server.go.html#3845173">delHeader</a></span><span class="op" id="3848721">(</span><span class="string" id="3848722">&#34;Transfer-Encoding&#34;</span><span class="op" id="3848741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3848744">}</span>&nbsp;<span class="keyword" id="3848746">else</span>&nbsp;<span class="keyword" id="3848751">if</span>&nbsp;<span class="ident" id="3848754"><a href="/net/http/server.go.html#3846774">hasCL</a></span>&nbsp;<span class="op" id="3848760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3848764"><a href="/net/http/server.go.html#3845173">delHeader</a></span><span class="op" id="3848773">(</span><span class="string" id="3848774">&#34;Transfer-Encoding&#34;</span><span class="op" id="3848793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3848796">}</span>&nbsp;<span class="keyword" id="3848798">else</span>&nbsp;<span class="keyword" id="3848803">if</span>&nbsp;<span class="ident" id="3848806"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3848807">.</span><span class="ident" id="3848808">req</span><span class="op" id="3848811">.</span><span class="ident" id="3848812">ProtoAtLeast</span><span class="op" id="3848824">(</span><span class="num" id="3848825">1</span><span class="op" id="3848826">,</span>&nbsp;<span class="num" id="3848828">1</span><span class="op" id="3848829">)</span>&nbsp;<span class="op" id="3848831">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3848835">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;Transfer-Encoding&nbsp;has&nbsp;been&nbsp;set&nbsp;to&nbsp;identity,&nbsp;&nbsp;and&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3848913">//&nbsp;content-length&nbsp;has&nbsp;been&nbsp;provided.&nbsp;The&nbsp;connection&nbsp;must&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3848992">//&nbsp;reply&nbsp;is&nbsp;written,&nbsp;and&nbsp;no&nbsp;chunking&nbsp;is&nbsp;to&nbsp;be&nbsp;done.&nbsp;This&nbsp;is&nbsp;the&nbsp;setup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3849064">//&nbsp;recommended&nbsp;in&nbsp;the&nbsp;Server-Sent&nbsp;Events&nbsp;candidate&nbsp;recommendation&nbsp;11,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3849136">//&nbsp;section&nbsp;8.</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849152">if</span>&nbsp;<span class="ident" id="3849155"><a href="/net/http/server.go.html#3848243">hasTE</a></span>&nbsp;<span class="op" id="3849161">&amp;&amp;</span>&nbsp;<span class="ident" id="3849164"><a href="/net/http/server.go.html#3848204">te</a></span>&nbsp;<span class="op" id="3849167">==</span>&nbsp;<span class="string" id="3849170">&#34;identity&#34;</span>&nbsp;<span class="op" id="3849181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849186"><a href="/net/http/server.go.html#3844580">cw</a></span><span class="op" id="3849188">.</span><span class="ident" id="3849189">chunking</span>&nbsp;<span class="op" id="3849198">=</span>&nbsp;<span class="ident" id="3849200">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849209"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3849210">.</span><span class="ident" id="3849211">closeAfterReply</span>&nbsp;<span class="op" id="3849227">=</span>&nbsp;<span class="ident" id="3849229">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3849236">}</span>&nbsp;<span class="keyword" id="3849238">else</span>&nbsp;<span class="op" id="3849243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3849248">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;use&nbsp;chunked&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3849305">//&nbsp;to&nbsp;avoid&nbsp;closing&nbsp;the&nbsp;connection&nbsp;at&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849351"><a href="/net/http/server.go.html#3844580">cw</a></span><span class="op" id="3849353">.</span><span class="ident" id="3849354">chunking</span>&nbsp;<span class="op" id="3849363">=</span>&nbsp;<span class="ident" id="3849365">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849373"><a href="/net/http/server.go.html#3845407">setHeader</a></span><span class="op" id="3849382">.</span><span class="ident" id="3849383">transferEncoding</span>&nbsp;<span class="op" id="3849400">=</span>&nbsp;<span class="string" id="3849402">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3849414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3849417">}</span>&nbsp;<span class="keyword" id="3849419">else</span>&nbsp;<span class="op" id="3849424">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3849428">//&nbsp;HTTP&nbsp;version&nbsp;&lt;&nbsp;1.1:&nbsp;cannot&nbsp;do&nbsp;chunked&nbsp;transfer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3849480">//&nbsp;encoding&nbsp;and&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;Content-Length&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3849534">//&nbsp;signal&nbsp;EOF&nbsp;by&nbsp;closing&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849573"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3849574">.</span><span class="ident" id="3849575">closeAfterReply</span>&nbsp;<span class="op" id="3849591">=</span>&nbsp;<span class="ident" id="3849593">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849600"><a href="/net/http/server.go.html#3845173">delHeader</a></span><span class="op" id="3849609">(</span><span class="string" id="3849610">&#34;Transfer-Encoding&#34;</span><span class="op" id="3849629">)</span>&nbsp;<span class="comment" id="3849631">//&nbsp;in&nbsp;case&nbsp;already&nbsp;set</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3849655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3849659">//&nbsp;Cannot&nbsp;use&nbsp;Content-Length&nbsp;with&nbsp;non-identity&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849726">if</span>&nbsp;<span class="ident" id="3849729"><a href="/net/http/server.go.html#3844580">cw</a></span><span class="op" id="3849731">.</span><span class="ident" id="3849732">chunking</span>&nbsp;<span class="op" id="3849741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849745"><a href="/net/http/server.go.html#3845173">delHeader</a></span><span class="op" id="3849754">(</span><span class="string" id="3849755">&#34;Content-Length&#34;</span><span class="op" id="3849771">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3849774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849777">if</span>&nbsp;<span class="op" id="3849780">!</span><span class="ident" id="3849781"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3849782">.</span><span class="ident" id="3849783">req</span><span class="op" id="3849786">.</span><span class="ident" id="3849787">ProtoAtLeast</span><span class="op" id="3849799">(</span><span class="num" id="3849800">1</span><span class="op" id="3849801">,</span>&nbsp;<span class="num" id="3849803">0</span><span class="op" id="3849804">)</span>&nbsp;<span class="op" id="3849806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849810">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3849818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849822">if</span>&nbsp;<span class="ident" id="3849825"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3849826">.</span><span class="ident" id="3849827">closeAfterReply</span>&nbsp;<span class="op" id="3849843">&amp;&amp;</span>&nbsp;<span class="op" id="3849846">(</span><span class="op" id="3849847">!</span><span class="ident" id="3849848"><a href="/net/http/server.go.html#3844692">keepAlivesEnabled</a></span>&nbsp;<span class="op" id="3849866">||</span>&nbsp;<span class="op" id="3849869">!</span><span class="ident" id="3849870"><a href="/net/http/header.go.html#3785956">hasToken</a></span><span class="op" id="3849878">(</span><span class="ident" id="3849879"><a href="/net/http/server.go.html#3844580">cw</a></span><span class="op" id="3849881">.</span><span class="ident" id="3849882">header</span><span class="op" id="3849888">.</span><span class="ident" id="3849889">get</span><span class="op" id="3849892">(</span><span class="string" id="3849893">&#34;Connection&#34;</span><span class="op" id="3849905">)</span><span class="op" id="3849906">,</span>&nbsp;<span class="string" id="3849908">&#34;close&#34;</span><span class="op" id="3849915">)</span><span class="op" id="3849916">)</span>&nbsp;<span class="op" id="3849918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849922"><a href="/net/http/server.go.html#3845173">delHeader</a></span><span class="op" id="3849931">(</span><span class="string" id="3849932">&#34;Connection&#34;</span><span class="op" id="3849944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3849948">if</span>&nbsp;<span class="ident" id="3849951"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3849952">.</span><span class="ident" id="3849953">req</span><span class="op" id="3849956">.</span><span class="ident" id="3849957">ProtoAtLeast</span><span class="op" id="3849969">(</span><span class="num" id="3849970">1</span><span class="op" id="3849971">,</span>&nbsp;<span class="num" id="3849973">1</span><span class="op" id="3849974">)</span>&nbsp;<span class="op" id="3849976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3849981"><a href="/net/http/server.go.html#3845407">setHeader</a></span><span class="op" id="3849990">.</span><span class="ident" id="3849991">connection</span>&nbsp;<span class="op" id="3850002">=</span>&nbsp;<span class="string" id="3850004">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3850014">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3850017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850021"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3850022">.</span><span class="ident" id="3850023">conn</span><span class="op" id="3850027">.</span><span class="ident" id="3850028">buf</span><span class="op" id="3850031">.</span><span class="ident" id="3850032">WriteString</span><span class="op" id="3850043">(</span><span class="ident" id="3850044"><a href="/net/http/server.go.html#3850689">statusLine</a></span><span class="op" id="3850054">(</span><span class="ident" id="3850055"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3850056">.</span><span class="ident" id="3850057">req</span><span class="op" id="3850060">,</span>&nbsp;<span class="ident" id="3850062"><a href="/net/http/server.go.html#3847804">code</a></span><span class="op" id="3850066">)</span><span class="op" id="3850067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850070"><a href="/net/http/server.go.html#3844580">cw</a></span><span class="op" id="3850072">.</span><span class="ident" id="3850073">header</span><span class="op" id="3850079">.</span><span class="ident" id="3850080">WriteSubset</span><span class="op" id="3850091">(</span><span class="ident" id="3850092"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3850093">.</span><span class="ident" id="3850094">conn</span><span class="op" id="3850098">.</span><span class="ident" id="3850099">buf</span><span class="op" id="3850102">,</span>&nbsp;<span class="ident" id="3850104"><a href="/net/http/server.go.html#3845142">excludeHeader</a></span><span class="op" id="3850117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850120"><a href="/net/http/server.go.html#3845407">setHeader</a></span><span class="op" id="3850129">.</span><span class="ident" id="3850130">Write</span><span class="op" id="3850135">(</span><span class="ident" id="3850136"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3850137">.</span><span class="ident" id="3850138">conn</span><span class="op" id="3850142">.</span><span class="ident" id="3850143">buf</span><span class="op" id="3850146">.</span><span class="ident" id="3850147">Writer</span><span class="op" id="3850153">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850156"><a href="/net/http/server.go.html#3844679">w</a></span><span class="op" id="3850157">.</span><span class="ident" id="3850158">conn</span><span class="op" id="3850162">.</span><span class="ident" id="3850163">buf</span><span class="op" id="3850166">.</span><span class="ident" id="3850167">Write</span><span class="op" id="3850172">(</span><span class="ident" id="3850173"><a href="/net/http/server.go.html#3832152">crlf</a></span><span class="op" id="3850177">)</span><br>
<span class="lineno"></span><span class="op" id="3850179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3850182">//&nbsp;statusLines&nbsp;is&nbsp;a&nbsp;cache&nbsp;of&nbsp;Status-Line&nbsp;strings,&nbsp;keyed&nbsp;by&nbsp;code&nbsp;(for</span><br>
<span class="lineno"></span><span class="comment" id="3850251">//&nbsp;HTTP/1.1)&nbsp;or&nbsp;negative&nbsp;code&nbsp;(for&nbsp;HTTP/1.0).&nbsp;This&nbsp;is&nbsp;faster&nbsp;than&nbsp;a</span><br>
<span class="lineno">890</span><span class="comment" id="3850319">//&nbsp;map&nbsp;keyed&nbsp;by&nbsp;struct&nbsp;of&nbsp;two&nbsp;fields.&nbsp;This&nbsp;map&#39;s&nbsp;max&nbsp;size&nbsp;is&nbsp;bounded</span><br>
<span class="lineno"></span><span class="comment" id="3850388">//&nbsp;by&nbsp;2*len(statusText),&nbsp;two&nbsp;protocol&nbsp;types&nbsp;for&nbsp;each&nbsp;known&nbsp;official</span><br>
<span class="lineno"></span><span class="comment" id="3850456">//&nbsp;status&nbsp;code&nbsp;in&nbsp;the&nbsp;statusText&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="3850494">var</span>&nbsp;<span class="op" id="3850498">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850501">statusMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3850513"><a href="/net/http/server.go.html#3824875">sync</a></span><span class="op" id="3850517">.</span><span class="ident" id="3850518">RWMutex</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850527">statusLines</span>&nbsp;<span class="op" id="3850539">=</span>&nbsp;<span class="builtinfunc" id="3850541">make</span><span class="op" id="3850545">(</span><span class="keyword" id="3850546">map</span><span class="op" id="3850549">[</span><span class="builtintype" id="3850550">int</span><span class="op" id="3850553">]</span><span class="builtintype" id="3850554">string</span><span class="op" id="3850560">)</span><br>
<span class="lineno"></span><span class="op" id="3850562">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3850565">//&nbsp;statusLine&nbsp;returns&nbsp;a&nbsp;response&nbsp;Status-Line&nbsp;(RFC&nbsp;2616&nbsp;Section&nbsp;6.1)</span><br>
<span class="lineno"></span><span class="comment" id="3850633">//&nbsp;for&nbsp;the&nbsp;given&nbsp;request&nbsp;and&nbsp;response&nbsp;status&nbsp;code.</span><br>
<span class="lineno">900</span><span class="keyword" id="3850684">func</span>&nbsp;<span class="ident" id="3850689">statusLine</span><span class="op" id="3850699">(</span><span class="ident" id="3850700">req</span>&nbsp;<span class="op" id="3850704">*</span><span class="ident" id="3850705"><a href="/net/http/request.go.html#3791418">Request</a></span><span class="op" id="3850712">,</span>&nbsp;<span class="ident" id="3850714">code</span>&nbsp;<span class="builtintype" id="3850719">int</span><span class="op" id="3850722">)</span>&nbsp;<span class="builtintype" id="3850724">string</span>&nbsp;<span class="op" id="3850731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3850734">//&nbsp;Fast&nbsp;path:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850749">key</span>&nbsp;<span class="op" id="3850753">:=</span>&nbsp;<span class="ident" id="3850756"><a href="/net/http/server.go.html#3850714">code</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850762">proto11</span>&nbsp;<span class="op" id="3850770">:=</span>&nbsp;<span class="ident" id="3850773"><a href="/net/http/server.go.html#3850700">req</a></span><span class="op" id="3850776">.</span><span class="ident" id="3850777">ProtoAtLeast</span><span class="op" id="3850789">(</span><span class="num" id="3850790">1</span><span class="op" id="3850791">,</span>&nbsp;<span class="num" id="3850793">1</span><span class="op" id="3850794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3850797">if</span>&nbsp;<span class="op" id="3850800">!</span><span class="ident" id="3850801"><a href="/net/http/server.go.html#3850762">proto11</a></span>&nbsp;<span class="op" id="3850809">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850813"><a href="/net/http/server.go.html#3850749">key</a></span>&nbsp;<span class="op" id="3850817">=</span>&nbsp;<span class="op" id="3850819">-</span><span class="ident" id="3850820"><a href="/net/http/server.go.html#3850749">key</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3850825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850828"><a href="/net/http/server.go.html#3850501">statusMu</a></span><span class="op" id="3850836">.</span><span class="ident" id="3850837">RLock</span><span class="op" id="3850842">(</span><span class="op" id="3850843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850846">line</span><span class="op" id="3850850">,</span>&nbsp;<span class="ident" id="3850852">ok</span>&nbsp;<span class="op" id="3850855">:=</span>&nbsp;<span class="ident" id="3850858"><a href="/net/http/server.go.html#3850527">statusLines</a></span><span class="op" id="3850869">[</span><span class="ident" id="3850870"><a href="/net/http/server.go.html#3850749">key</a></span><span class="op" id="3850873">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850876"><a href="/net/http/server.go.html#3850501">statusMu</a></span><span class="op" id="3850884">.</span><span class="ident" id="3850885">RUnlock</span><span class="op" id="3850892">(</span><span class="op" id="3850893">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3850896">if</span>&nbsp;<span class="ident" id="3850899"><a href="/net/http/server.go.html#3850852">ok</a></span>&nbsp;<span class="op" id="3850902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3850906">return</span>&nbsp;<span class="ident" id="3850913"><a href="/net/http/server.go.html#3850846">line</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3850919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3850923">//&nbsp;Slow&nbsp;path:</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850938">proto</span>&nbsp;<span class="op" id="3850944">:=</span>&nbsp;<span class="string" id="3850947">&#34;HTTP/1.0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3850959">if</span>&nbsp;<span class="ident" id="3850962"><a href="/net/http/server.go.html#3850762">proto11</a></span>&nbsp;<span class="op" id="3850970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850974"><a href="/net/http/server.go.html#3850938">proto</a></span>&nbsp;<span class="op" id="3850980">=</span>&nbsp;<span class="string" id="3850982">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3850994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3850997">codestring</span>&nbsp;<span class="op" id="3851008">:=</span>&nbsp;<span class="ident" id="3851011"><a href="/net/http/server.go.html#3824853">strconv</a></span><span class="op" id="3851018">.</span><span class="ident" id="3851019">Itoa</span><span class="op" id="3851023">(</span><span class="ident" id="3851024"><a href="/net/http/server.go.html#3850714">code</a></span><span class="op" id="3851028">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851031">text</span><span class="op" id="3851035">,</span>&nbsp;<span class="ident" id="3851037"><a href="/net/http/server.go.html#3850852">ok</a></span>&nbsp;<span class="op" id="3851040">:=</span>&nbsp;<span class="ident" id="3851043"><a href="/net/http/status.go.html#3893462">statusText</a></span><span class="op" id="3851053">[</span><span class="ident" id="3851054"><a href="/net/http/server.go.html#3850714">code</a></span><span class="op" id="3851058">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851061">if</span>&nbsp;<span class="op" id="3851064">!</span><span class="ident" id="3851065"><a href="/net/http/server.go.html#3850852">ok</a></span>&nbsp;<span class="op" id="3851068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851072"><a href="/net/http/server.go.html#3851031">text</a></span>&nbsp;<span class="op" id="3851077">=</span>&nbsp;<span class="string" id="3851079">&#34;status&nbsp;code&nbsp;&#34;</span>&nbsp;<span class="op" id="3851094">+</span>&nbsp;<span class="ident" id="3851096"><a href="/net/http/server.go.html#3850997">codestring</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3851108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851111"><a href="/net/http/server.go.html#3850846">line</a></span>&nbsp;<span class="op" id="3851116">=</span>&nbsp;<span class="ident" id="3851118"><a href="/net/http/server.go.html#3850938">proto</a></span>&nbsp;<span class="op" id="3851124">+</span>&nbsp;<span class="string" id="3851126">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="3851130">+</span>&nbsp;<span class="ident" id="3851132"><a href="/net/http/server.go.html#3850997">codestring</a></span>&nbsp;<span class="op" id="3851143">+</span>&nbsp;<span class="string" id="3851145">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="3851149">+</span>&nbsp;<span class="ident" id="3851151"><a href="/net/http/server.go.html#3851031">text</a></span>&nbsp;<span class="op" id="3851156">+</span>&nbsp;<span class="string" id="3851158">&#34;\r\n&#34;</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851166">if</span>&nbsp;<span class="ident" id="3851169"><a href="/net/http/server.go.html#3850852">ok</a></span>&nbsp;<span class="op" id="3851172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851176"><a href="/net/http/server.go.html#3850501">statusMu</a></span><span class="op" id="3851184">.</span><span class="ident" id="3851185">Lock</span><span class="op" id="3851189">(</span><span class="op" id="3851190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851194">defer</span>&nbsp;<span class="ident" id="3851200"><a href="/net/http/server.go.html#3850501">statusMu</a></span><span class="op" id="3851208">.</span><span class="ident" id="3851209">Unlock</span><span class="op" id="3851215">(</span><span class="op" id="3851216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3851220"><a href="/net/http/server.go.html#3850527">statusLines</a></span><span class="op" id="3851231">[</span><span class="ident" id="3851232"><a href="/net/http/server.go.html#3850749">key</a></span><span class="op" id="3851235">]</span>&nbsp;<span class="op" id="3851237">=</span>&nbsp;<span class="ident" id="3851239"><a href="/net/http/server.go.html#3850846">line</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3851245">}</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851248">return</span>&nbsp;<span class="ident" id="3851255"><a href="/net/http/server.go.html#3850846">line</a></span><br>
<span class="lineno"></span><span class="op" id="3851260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3851263">//&nbsp;bodyAllowed&nbsp;returns&nbsp;true&nbsp;if&nbsp;a&nbsp;Write&nbsp;is&nbsp;allowed&nbsp;for&nbsp;this&nbsp;response&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="3851337">//&nbsp;It&#39;s&nbsp;illegal&nbsp;to&nbsp;call&nbsp;this&nbsp;before&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;flushed.</span><br>
<span class="lineno">935</span><span class="keyword" id="3851402">func</span>&nbsp;<span class="op" id="3851407">(</span><span class="ident" id="3851408">w</span>&nbsp;<span class="op" id="3851410">*</span><span class="ident" id="3851411"><a href="/net/http/server.go.html#3833137">response</a></span><span class="op" id="3851419">)</span>&nbsp;<span class="ident" id="3851421">bodyAllowed</span><span class="op" id="3851432">(</span><span class="op" id="3851433">)</span>&nbsp;<span class="builtintype" id="3851435">bool</span>&nbsp;<span class="op" id="3851440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851443">if</span>&nbsp;<span class="op" id="3851446">!</span><span class="ident" id="3851447"><a href="/net/http/server.go.html#3851408">w</a></span><span class="op" id="3851448">.</span><span class="ident" id="3851449">wroteHeader</span>&nbsp;<span class="op" id="3851461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3851465">panic</span><span class="op" id="3851470">(</span><span class="string" id="3851471">&#34;&#34;</span><span class="op" id="3851473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3851476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3851479">return</span>&nbsp;<span class="ident" id="3851486"><a href="/net/http/transfer.go.html#3902575">bodyAllowedForStatus</a></span><span class="op" id="3851506">(</span><span class="ident" id="3851507"><a href="/net/http/server.go.html#3851408">w</a></span><span class="op" id="3851508">.</span><span class="ident" id="3851509">status</span><span class="op" id="3851515">)</span><br>
<span class="lineno">940</span><span class="op" id="3851517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3851520">//&nbsp;The&nbsp;Life&nbsp;Of&nbsp;A&nbsp;Write&nbsp;is&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span><span class="comment" id="3851557">//</span><br>
<span class="lineno"></span><span class="comment" id="3851560">//&nbsp;Handler&nbsp;starts.&nbsp;No&nbsp;header&nbsp;has&nbsp;been&nbsp;sent.&nbsp;The&nbsp;handler&nbsp;can&nbsp;either</span><br>
<span class="lineno">945</span><span class="comment" id="3851627">//&nbsp;write&nbsp;a&nbsp;header,&nbsp;or&nbsp;just&nbsp;start&nbsp;writing.&nbsp;&nbsp;Writing&nbsp;before&nbsp;sending&nbsp;a&nbsp;header</span><br>
<span class="lineno"></span><span class="comment" id="3851702">//&nbsp;sends&nbsp;an&nbsp;implicitly&nbsp;empty&nbsp;200&nbsp;OK&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="3851746">//</span><br>
<span class="lineno"></span><span class="comment" id="3851749">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;declare&nbsp;a&nbsp;Content-Length&nbsp;up&nbsp;front,&nbsp;we&nbsp;either</span><br>
<span class="lineno"></span><span class="comment" id="3851819">//&nbsp;go&nbsp;into&nbsp;chunking&nbsp;mode&nbsp;or,&nbsp;if&nbsp;the&nbsp;handler&nbsp;finishes&nbsp;running&nbsp;before</span><br>
<span class="lineno">950</span><span class="comment" id="3851887">//&nbsp;the&nbsp;chunking&nbsp;buffer&nbsp;size,&nbsp;we&nbsp;compute&nbsp;a&nbsp;Content-Length&nbsp;and&nbsp;send&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3851958">//&nbsp;in&nbsp;the&nbsp;header&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="3851984">//</span><br>
<span class="lineno"></span><span class="comment" id="3851987">//&nbsp;Likewise,&nbsp;if&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;set&nbsp;a&nbsp;Content-Type,&nbsp;we&nbsp;sniff&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3852056">//&nbsp;from&nbsp;the&nbsp;initial&nbsp;chunk&nbsp;of&nbsp;output.</span><br>
<span class="lineno">955</span><span class="comment" id="3852093">//</span><br>
<span class="lineno"></span><span class="comment" id="3852096">//&nbsp;The&nbsp;Writers&nbsp;are&nbsp;wired&nbsp;together&nbsp;like:</span><br>
<span class="lineno"></span><span class="comment" id="3852136">//</span><br>
<span class="lineno"></span><span class="comment" id="3852139">//&nbsp;1.&nbsp;*response&nbsp;(the&nbsp;ResponseWriter)&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="3852179">//&nbsp;2.&nbsp;(*response).w,&nbsp;a&nbsp;*bufio.Writer&nbsp;of&nbsp;bufferBeforeChunkingSize&nbsp;bytes</span><br>
<span class="lineno">960</span><span class="comment" id="3852250">//&nbsp;3.&nbsp;chunkWriter.Writer&nbsp;(whose&nbsp;writeHeader&nbsp;finalizes&nbsp;Content-Length/Type)</span><br>
<span class="lineno"></span><span class="comment" id="3852325">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;which&nbsp;writes&nbsp;the&nbsp;chunk&nbsp;headers,&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="comment" id="3852378">//&nbsp;4.&nbsp;conn.buf,&nbsp;a&nbsp;bufio.Writer&nbsp;of&nbsp;default&nbsp;(4kB)&nbsp;bytes,&nbsp;writing&nbsp;to&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="3852447">//&nbsp;5.&nbsp;checkConnErrorWriter{c},&nbsp;which&nbsp;notes&nbsp;any&nbsp;non-nil&nbsp;error&nbsp;on&nbsp;Write</span><br>
<span class="lineno"></span><span class="comment" id="3852517">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;populates&nbsp;c.werr&nbsp;with&nbsp;it&nbsp;if&nbsp;so.&nbsp;but&nbsp;otherwise&nbsp;writes&nbsp;to:</span><br>
<span class="lineno">965</span><span class="comment" id="3852584">//&nbsp;6.&nbsp;the&nbsp;rwc,&nbsp;the&nbsp;net.Conn.</span><br>
<span class="lineno"></span><span class="comment" id="3852613">//</span><br>
<span class="lineno"></span><span class="comment" id="3852616">//&nbsp;TODO(bradfitz):&nbsp;short-circuit&nbsp;some&nbsp;of&nbsp;the&nbsp;buffering&nbsp;when&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3852680">//&nbsp;initial&nbsp;header&nbsp;contains&nbsp;both&nbsp;a&nbsp;Content-Type&nbsp;and&nbsp;Content-Length.</span><br>
<span class="lineno"></span><span class="comment" id="3852747">//&nbsp;Also&nbsp;short-circuit&nbsp;in&nbsp;(1)&nbsp;when&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;sent&nbsp;and&nbsp;not&nbsp;in</span><br>
<span class="lineno">970</span><span class="comment" id="3852815">//&nbsp;chunking&nbsp;mode,&nbsp;writing&nbsp;directly&nbsp;to&nbsp;(4)&nbsp;instead,&nbsp;if&nbsp;(2)&nbsp;has&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="3852880">//&nbsp;buffered&nbsp;data.&nbsp;&nbsp;More&nbsp;generally,&nbsp;we&nbsp;could&nbsp;short-circuit&nbsp;from&nbsp;(1)&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3852950">//&nbsp;(3)&nbsp;even&nbsp;in&nbsp;chunking&nbsp;mode&nbsp;if&nbsp;the&nbsp;write&nbsp;size&nbsp;from&nbsp;(1)&nbsp;is&nbsp;over&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="3853019">//&nbsp;threshold&nbsp;and&nbsp;nothing&nbsp;is&nbsp;in&nbsp;(2).&nbsp;&nbsp;The&nbsp;answer&nbsp;might&nbsp;be&nbsp;mostly&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="3853090">//&nbsp;bufferBeforeChunkingSize&nbsp;smaller&nbsp;and&nbsp;having&nbsp;bufio&#39;s&nbsp;fast-paths&nbsp;deal</span><br>
<span class="lineno">975</span><span class="comment" id="3853161">//&nbsp;with&nbsp;this&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="3853183">func</span>&nbsp;<span class="op" id="3853188">(</span><span class="ident" id="3853189">w</span>&nbsp;<span class="op" id="3853191">*</span><span class="ident" id="3853192"><a href="/net/http/server.go.html#3833137">response</a></span><span class="op" id="3853200">)</span>&nbsp;<span class="ident" id="3853202">Write</span><span class="op" id="3853207">(</span><span class="ident" id="3853208">data</span>&nbsp;<span class="op" id="3853213">[</span><span class="op" id="3853214">]</span><span class="builtintype" id="3853215">byte</span><span class="op" id="3853219">)</span>&nbsp;<span class="op" id="3853221">(</span><span class="ident" id="3853222">n</span>&nbsp;<span class="builtintype" id="3853224">int</span><span class="op" id="3853227">,</span>&nbsp;<span class="ident" id="3853229">err</span>&nbsp;<span class="builtintype" id="3853233">error</span><span class="op" id="3853238">)</span>&nbsp;<span class="op" id="3853240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853243">return</span>&nbsp;<span class="ident" id="3853250"><a href="/net/http/server.go.html#3853189">w</a></span><span class="op" id="3853251">.</span><span class="ident" id="3853252">write</span><span class="op" id="3853257">(</span><span class="builtinfunc" id="3853258">len</span><span class="op" id="3853261">(</span><span class="ident" id="3853262"><a href="/net/http/server.go.html#3853208">data</a></span><span class="op" id="3853266">)</span><span class="op" id="3853267">,</span>&nbsp;<span class="ident" id="3853269"><a href="/net/http/server.go.html#3853208">data</a></span><span class="op" id="3853273">,</span>&nbsp;<span class="string" id="3853275">&#34;&#34;</span><span class="op" id="3853277">)</span><br>
<span class="lineno"></span><span class="op" id="3853279">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="3853282">func</span>&nbsp;<span class="op" id="3853287">(</span><span class="ident" id="3853288">w</span>&nbsp;<span class="op" id="3853290">*</span><span class="ident" id="3853291"><a href="/net/http/server.go.html#3833137">response</a></span><span class="op" id="3853299">)</span>&nbsp;<span class="ident" id="3853301">WriteString</span><span class="op" id="3853312">(</span><span class="ident" id="3853313">data</span>&nbsp;<span class="builtintype" id="3853318">string</span><span class="op" id="3853324">)</span>&nbsp;<span class="op" id="3853326">(</span><span class="ident" id="3853327">n</span>&nbsp;<span class="builtintype" id="3853329">int</span><span class="op" id="3853332">,</span>&nbsp;<span class="ident" id="3853334">err</span>&nbsp;<span class="builtintype" id="3853338">error</span><span class="op" id="3853343">)</span>&nbsp;<span class="op" id="3853345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853348">return</span>&nbsp;<span class="ident" id="3853355"><a href="/net/http/server.go.html#3853288">w</a></span><span class="op" id="3853356">.</span><span class="ident" id="3853357">write</span><span class="op" id="3853362">(</span><span class="builtinfunc" id="3853363">len</span><span class="op" id="3853366">(</span><span class="ident" id="3853367"><a href="/net/http/server.go.html#3853313">data</a></span><span class="op" id="3853371">)</span><span class="op" id="3853372">,</span>&nbsp;<span class="ident" id="3853374">nil</span><span class="op" id="3853377">,</span>&nbsp;<span class="ident" id="3853379"><a href="/net/http/server.go.html#3853313">data</a></span><span class="op" id="3853383">)</span><br>
<span class="lineno"></span><span class="op" id="3853385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3853388">//&nbsp;either&nbsp;dataB&nbsp;or&nbsp;dataS&nbsp;is&nbsp;non-zero.</span><br>
<span class="lineno">985</span><span class="keyword" id="3853426">func</span>&nbsp;<span class="op" id="3853431">(</span><span class="ident" id="3853432">w</span>&nbsp;<span class="op" id="3853434">*</span><span class="ident" id="3853435"><a href="/net/http/server.go.html#3833137">response</a></span><span class="op" id="3853443">)</span>&nbsp;<span class="ident" id="3853445">write</span><span class="op" id="3853450">(</span><span class="ident" id="3853451">lenData</span>&nbsp;<span class="builtintype" id="3853459">int</span><span class="op" id="3853462">,</span>&nbsp;<span class="ident" id="3853464">dataB</span>&nbsp;<span class="op" id="3853470">[</span><span class="op" id="3853471">]</span><span class="builtintype" id="3853472">byte</span><span class="op" id="3853476">,</span>&nbsp;<span class="ident" id="3853478">dataS</span>&nbsp;<span class="builtintype" id="3853484">string</span><span class="op" id="3853490">)</span>&nbsp;<span class="op" id="3853492">(</span><span class="ident" id="3853493">n</span>&nbsp;<span class="builtintype" id="3853495">int</span><span class="op" id="3853498">,</span>&nbsp;<span class="ident" id="3853500">err</span>&nbsp;<span class="builtintype" id="3853504">error</span><span class="op" id="3853509">)</span>&nbsp;<span class="op" id="3853511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853514">if</span>&nbsp;<span class="ident" id="3853517"><a href="/net/http/server.go.html#3853432">w</a></span><span class="op" id="3853518">.</span><span class="ident" id="3853519">conn</span><span class="op" id="3853523">.</span><span class="ident" id="3853524">hijacked</span><span class="op" id="3853532">(</span><span class="op" id="3853533">)</span>&nbsp;<span class="op" id="3853535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853539"><a href="/net/http/server.go.html#3853432">w</a></span><span class="op" id="3853540">.</span><span class="ident" id="3853541">conn</span><span class="op" id="3853545">.</span><span class="ident" id="3853546">server</span><span class="op" id="3853552">.</span><span class="ident" id="3853553">logf</span><span class="op" id="3853557">(</span><span class="string" id="3853558">&#34;http:&nbsp;response.Write&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="3853603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853607">return</span>&nbsp;<span class="num" id="3853614">0</span><span class="op" id="3853615">,</span>&nbsp;<span class="ident" id="3853617"><a href="/net/http/server.go.html#3825123">ErrHijacked</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3853630">}</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853633">if</span>&nbsp;<span class="op" id="3853636">!</span><span class="ident" id="3853637"><a href="/net/http/server.go.html#3853432">w</a></span><span class="op" id="3853638">.</span><span class="ident" id="3853639">wroteHeader</span>&nbsp;<span class="op" id="3853651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853655"><a href="/net/http/server.go.html#3853432">w</a></span><span class="op" id="3853656">.</span><span class="ident" id="3853657">WriteHeader</span><span class="op" id="3853668">(</span><span class="ident" id="3853669"><a href="/net/http/status.go.html#3891674">StatusOK</a></span><span class="op" id="3853677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3853680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853683">if</span>&nbsp;<span class="ident" id="3853686"><a href="/net/http/server.go.html#3853451">lenData</a></span>&nbsp;<span class="op" id="3853694">==</span>&nbsp;<span class="num" id="3853697">0</span>&nbsp;<span class="op" id="3853699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853703">return</span>&nbsp;<span class="num" id="3853710">0</span><span class="op" id="3853711">,</span>&nbsp;<span class="ident" id="3853713">nil</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3853718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853721">if</span>&nbsp;<span class="op" id="3853724">!</span><span class="ident" id="3853725"><a href="/net/http/server.go.html#3853432">w</a></span><span class="op" id="3853726">.</span><span class="ident" id="3853727">bodyAllowed</span><span class="op" id="3853738">(</span><span class="op" id="3853739">)</span>&nbsp;<span class="op" id="3853741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853745">return</span>&nbsp;<span class="num" id="3853752">0</span><span class="op" id="3853753">,</span>&nbsp;<span class="ident" id="3853755"><a href="/net/http/server.go.html#3825022">ErrBodyNotAllowed</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3853774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3853778"><a href="/net/http/server.go.html#3853432">w</a></span><span class="op" id="3853779">.</span><span class="ident" id="3853780">written</span>&nbsp;<span class="op" id="3853788">+=</span>&nbsp;<span class="ident" id="3853791">int64</span><span class="op" id="3853796">(</span><span class="ident" id="3853797"><a href="/net/http/server.go.html#3853451">lenData</a></span><span class="op" id="3853804">)</span>&nbsp;<span class="comment" id="3853806">//&nbsp;ignoring&nbsp;errors,&nbsp;for&nbsp;errorKludge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853843">if</span>&nbsp;<span class="ident" id="3853846"><a href="/net/http/server.go.html#3853432">w</a></span><span class="op" id="3853847">.</span><span class="ident" id="3853848">contentLength</span>&nbsp;<span class="op" id="3853862">!=</span>&nbsp;<span class="op" id="3853865">-</span><span class="num" id="3853866">1</span>&nbsp;<span class="op" id="3853868">&amp;&amp;</span>&nbsp;<span class="ident" id="3853871"><a href="/net/http/server.go.html#3853432">w</a></span><span class="op" id="3853872">.</span><span class="ident" id="3853873">written</span>&nbsp;<span class="op" id="3853881">&gt;</span>&nbsp;<span class="ident" id="3853883"><a href="/net/http/server.go.html#3853432">w</a></span><span class="op" id="3853884">.</span><span class="ident" id="3853885">contentLength</span>&nbsp;<span class="op" id="3853899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853903">return</span>&nbsp;<span class="num" id="3853910">0</span><span class="op" id="3853911">,</span>&nbsp;<span class="ident" id="3853913"><a href="/net/http/server.go.html#3825182">ErrContentLength</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3853931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853934">if</span>&nbsp;<span class="ident" id="3853937"><a href="/net/http/server.go.html#3853464">dataB</a></span>&nbsp;<span class="op" id="3853943">!=</span>&nbsp;<span class="ident" id="3853946">nil</span>&nbsp;<span class="op" id="3853950">{</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853954">return</span>&nbsp;<span class="ident" id="3853961"><a href="/net/http/server.go.html#3853432">w</a></span><span class="op" id="3853962">.</span><span class="ident" id="3853963">w</span><span class="op" id="3853964">.</span><span class="ident" id="3853965">Write</span><span class="op" id="3853970">(</span><span class="ident" id="3853971"><a href="/net/http/server.go.html#3853464">dataB</a></span><span class="op" id="3853976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3853979">}</span>&nbsp;<span class="keyword" id="3853981">else</span>&nbsp;<span class="op" id="3853986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3853990">return</span>&nbsp;<span class="ident" id="3853997"><a href="/net/http/server.go.html#3853432">w</a></span><span class="op" id="3853998">.</span><span class="ident" id="3853999">w</span><span class="op" id="3854000">.</span><span class="ident" id="3854001">WriteString</span><span class="op" id="3854012">(</span><span class="ident" id="3854013"><a href="/net/http/server.go.html#3853478">dataS</a></span><span class="op" id="3854018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854021">}</span><br>
<span class="lineno"></span><span class="op" id="3854023">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span><span class="keyword" id="3854026">func</span>&nbsp;<span class="op" id="3854031">(</span><span class="ident" id="3854032">w</span>&nbsp;<span class="op" id="3854034">*</span><span class="ident" id="3854035"><a href="/net/http/server.go.html#3833137">response</a></span><span class="op" id="3854043">)</span>&nbsp;<span class="ident" id="3854045">finishRequest</span><span class="op" id="3854058">(</span><span class="op" id="3854059">)</span>&nbsp;<span class="op" id="3854061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854064"><a href="/net/http/server.go.html#3854032">w</a></span><span class="op" id="3854065">.</span><span class="ident" id="3854066">handlerDone</span>&nbsp;<span class="op" id="3854078">=</span>&nbsp;<span class="ident" id="3854080">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854087">if</span>&nbsp;<span class="op" id="3854090">!</span><span class="ident" id="3854091"><a href="/net/http/server.go.html#3854032">w</a></span><span class="op" id="3854092">.</span><span class="ident" id="3854093">wroteHeader</span>&nbsp;<span class="op" id="3854105">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854109"><a href="/net/http/server.go.html#3854032">w</a></span><span class="op" id="3854110">.</span><span class="ident" id="3854111">WriteHeader</span><span class="op" id="3854122">(</span><span class="ident" id="3854123"><a href="/net/http/status.go.html#3891674">StatusOK</a></span><span class="op" id="3854131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854138"><a href="/net/http/server.go.html#3854032">w</a></span><span class="op" id="3854139">.</span><span class="ident" id="3854140">w</span><span class="op" id="3854141">.</span><span class="ident" id="3854142">Flush</span><span class="op" id="3854147">(</span><span class="op" id="3854148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854151"><a href="/net/http/server.go.html#3838290">putBufioWriter</a></span><span class="op" id="3854165">(</span><span class="ident" id="3854166"><a href="/net/http/server.go.html#3854032">w</a></span><span class="op" id="3854167">.</span><span class="ident" id="3854168">w</span><span class="op" id="3854169">)</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854172"><a href="/net/http/server.go.html#3854032">w</a></span><span class="op" id="3854173">.</span><span class="ident" id="3854174">cw</span><span class="op" id="3854176">.</span><span class="builtinfunc" id="3854177">close</span><span class="op" id="3854182">(</span><span class="op" id="3854183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854186"><a href="/net/http/server.go.html#3854032">w</a></span><span class="op" id="3854187">.</span><span class="ident" id="3854188">conn</span><span class="op" id="3854192">.</span><span class="ident" id="3854193">buf</span><span class="op" id="3854196">.</span><span class="ident" id="3854197">Flush</span><span class="op" id="3854202">(</span><span class="op" id="3854203">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3854207">//&nbsp;Close&nbsp;the&nbsp;body&nbsp;(regardless&nbsp;of&nbsp;w.closeAfterReply)&nbsp;so&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3854270">//&nbsp;re-use&nbsp;its&nbsp;bufio.Reader&nbsp;later&nbsp;safely.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854312"><a href="/net/http/server.go.html#3854032">w</a></span><span class="op" id="3854313">.</span><span class="ident" id="3854314">req</span><span class="op" id="3854317">.</span><span class="ident" id="3854318">Body</span><span class="op" id="3854322">.</span><span class="ident" id="3854323">Close</span><span class="op" id="3854328">(</span><span class="op" id="3854329">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854333">if</span>&nbsp;<span class="ident" id="3854336"><a href="/net/http/server.go.html#3854032">w</a></span><span class="op" id="3854337">.</span><span class="ident" id="3854338">req</span><span class="op" id="3854341">.</span><span class="ident" id="3854342">MultipartForm</span>&nbsp;<span class="op" id="3854356">!=</span>&nbsp;<span class="ident" id="3854359">nil</span>&nbsp;<span class="op" id="3854363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854367"><a href="/net/http/server.go.html#3854032">w</a></span><span class="op" id="3854368">.</span><span class="ident" id="3854369">req</span><span class="op" id="3854372">.</span><span class="ident" id="3854373">MultipartForm</span><span class="op" id="3854386">.</span><span class="ident" id="3854387">RemoveAll</span><span class="op" id="3854396">(</span><span class="op" id="3854397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854400">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854404">if</span>&nbsp;<span class="ident" id="3854407"><a href="/net/http/server.go.html#3854032">w</a></span><span class="op" id="3854408">.</span><span class="ident" id="3854409">req</span><span class="op" id="3854412">.</span><span class="ident" id="3854413">Method</span>&nbsp;<span class="op" id="3854420">!=</span>&nbsp;<span class="string" id="3854423">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3854430">&amp;&amp;</span>&nbsp;<span class="ident" id="3854433"><a href="/net/http/server.go.html#3854032">w</a></span><span class="op" id="3854434">.</span><span class="ident" id="3854435">contentLength</span>&nbsp;<span class="op" id="3854449">!=</span>&nbsp;<span class="op" id="3854452">-</span><span class="num" id="3854453">1</span>&nbsp;<span class="op" id="3854455">&amp;&amp;</span>&nbsp;<span class="ident" id="3854458"><a href="/net/http/server.go.html#3854032">w</a></span><span class="op" id="3854459">.</span><span class="ident" id="3854460">bodyAllowed</span><span class="op" id="3854471">(</span><span class="op" id="3854472">)</span>&nbsp;<span class="op" id="3854474">&amp;&amp;</span>&nbsp;<span class="ident" id="3854477"><a href="/net/http/server.go.html#3854032">w</a></span><span class="op" id="3854478">.</span><span class="ident" id="3854479">contentLength</span>&nbsp;<span class="op" id="3854493">!=</span>&nbsp;<span class="ident" id="3854496"><a href="/net/http/server.go.html#3854032">w</a></span><span class="op" id="3854497">.</span><span class="ident" id="3854498">written</span>&nbsp;<span class="op" id="3854506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3854510">//&nbsp;Did&nbsp;not&nbsp;write&nbsp;enough.&nbsp;Avoid&nbsp;getting&nbsp;out&nbsp;of&nbsp;sync.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854564"><a href="/net/http/server.go.html#3854032">w</a></span><span class="op" id="3854565">.</span><span class="ident" id="3854566">closeAfterReply</span>&nbsp;<span class="op" id="3854582">=</span>&nbsp;<span class="ident" id="3854584">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854590">}</span><br>
<span class="lineno">1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3854594">//&nbsp;There&nbsp;was&nbsp;some&nbsp;error&nbsp;writing&nbsp;to&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3854656">//&nbsp;during&nbsp;the&nbsp;request,&nbsp;so&nbsp;don&#39;t&nbsp;re-use&nbsp;this&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854707">if</span>&nbsp;<span class="ident" id="3854710"><a href="/net/http/server.go.html#3854032">w</a></span><span class="op" id="3854711">.</span><span class="ident" id="3854712">conn</span><span class="op" id="3854716">.</span><span class="ident" id="3854717">werr</span>&nbsp;<span class="op" id="3854722">!=</span>&nbsp;<span class="ident" id="3854725">nil</span>&nbsp;<span class="op" id="3854729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854733"><a href="/net/http/server.go.html#3854032">w</a></span><span class="op" id="3854734">.</span><span class="ident" id="3854735">closeAfterReply</span>&nbsp;<span class="op" id="3854751">=</span>&nbsp;<span class="ident" id="3854753">true</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854759">}</span><br>
<span class="lineno"></span><span class="op" id="3854761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3854764">func</span>&nbsp;<span class="op" id="3854769">(</span><span class="ident" id="3854770">w</span>&nbsp;<span class="op" id="3854772">*</span><span class="ident" id="3854773"><a href="/net/http/server.go.html#3833137">response</a></span><span class="op" id="3854781">)</span>&nbsp;<span class="ident" id="3854783">Flush</span><span class="op" id="3854788">(</span><span class="op" id="3854789">)</span>&nbsp;<span class="op" id="3854791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854794">if</span>&nbsp;<span class="op" id="3854797">!</span><span class="ident" id="3854798"><a href="/net/http/server.go.html#3854770">w</a></span><span class="op" id="3854799">.</span><span class="ident" id="3854800">wroteHeader</span>&nbsp;<span class="op" id="3854812">{</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854816"><a href="/net/http/server.go.html#3854770">w</a></span><span class="op" id="3854817">.</span><span class="ident" id="3854818">WriteHeader</span><span class="op" id="3854829">(</span><span class="ident" id="3854830"><a href="/net/http/status.go.html#3891674">StatusOK</a></span><span class="op" id="3854838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3854841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854844"><a href="/net/http/server.go.html#3854770">w</a></span><span class="op" id="3854845">.</span><span class="ident" id="3854846">w</span><span class="op" id="3854847">.</span><span class="ident" id="3854848">Flush</span><span class="op" id="3854853">(</span><span class="op" id="3854854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854857"><a href="/net/http/server.go.html#3854770">w</a></span><span class="op" id="3854858">.</span><span class="ident" id="3854859">cw</span><span class="op" id="3854861">.</span><span class="ident" id="3854862">flush</span><span class="op" id="3854867">(</span><span class="op" id="3854868">)</span><br>
<span class="lineno"></span><span class="op" id="3854870">}</span><br>
<span class="lineno">1050</span><br>
<span class="lineno"></span><span class="keyword" id="3854873">func</span>&nbsp;<span class="op" id="3854878">(</span><span class="ident" id="3854879">c</span>&nbsp;<span class="op" id="3854881">*</span><span class="ident" id="3854882"><a href="/net/http/server.go.html#3828256">conn</a></span><span class="op" id="3854886">)</span>&nbsp;<span class="ident" id="3854888">finalFlush</span><span class="op" id="3854898">(</span><span class="op" id="3854899">)</span>&nbsp;<span class="op" id="3854901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3854904">if</span>&nbsp;<span class="ident" id="3854907"><a href="/net/http/server.go.html#3854879">c</a></span><span class="op" id="3854908">.</span><span class="ident" id="3854909">buf</span>&nbsp;<span class="op" id="3854913">!=</span>&nbsp;<span class="ident" id="3854916">nil</span>&nbsp;<span class="op" id="3854920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3854924"><a href="/net/http/server.go.html#3854879">c</a></span><span class="op" id="3854925">.</span><span class="ident" id="3854926">buf</span><span class="op" id="3854929">.</span><span class="ident" id="3854930">Flush</span><span class="op" id="3854935">(</span><span class="op" id="3854936">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3854941">//&nbsp;Steal&nbsp;the&nbsp;bufio.Reader&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3855011">//&nbsp;reader&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855048"><a href="/net/http/server.go.html#3837960">putBufioReader</a></span><span class="op" id="3855062">(</span><span class="ident" id="3855063"><a href="/net/http/server.go.html#3854879">c</a></span><span class="op" id="3855064">.</span><span class="ident" id="3855065">buf</span><span class="op" id="3855068">.</span><span class="ident" id="3855069">Reader</span><span class="op" id="3855075">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3855080">//&nbsp;Steal&nbsp;the&nbsp;bufio.Writer&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3855150">//&nbsp;writer&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855187"><a href="/net/http/server.go.html#3838290">putBufioWriter</a></span><span class="op" id="3855201">(</span><span class="ident" id="3855202"><a href="/net/http/server.go.html#3854879">c</a></span><span class="op" id="3855203">.</span><span class="ident" id="3855204">buf</span><span class="op" id="3855207">.</span><span class="ident" id="3855208">Writer</span><span class="op" id="3855214">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855219"><a href="/net/http/server.go.html#3854879">c</a></span><span class="op" id="3855220">.</span><span class="ident" id="3855221">buf</span>&nbsp;<span class="op" id="3855225">=</span>&nbsp;<span class="ident" id="3855227">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3855232">}</span><br>
<span class="lineno">1065</span><span class="op" id="3855234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3855237">//&nbsp;Close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3855262">func</span>&nbsp;<span class="op" id="3855267">(</span><span class="ident" id="3855268">c</span>&nbsp;<span class="op" id="3855270">*</span><span class="ident" id="3855271"><a href="/net/http/server.go.html#3828256">conn</a></span><span class="op" id="3855275">)</span>&nbsp;<span class="builtinfunc" id="3855277">close</span><span class="op" id="3855282">(</span><span class="op" id="3855283">)</span>&nbsp;<span class="op" id="3855285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855288"><a href="/net/http/server.go.html#3855268">c</a></span><span class="op" id="3855289">.</span><span class="ident" id="3855290">finalFlush</span><span class="op" id="3855300">(</span><span class="op" id="3855301">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3855304">if</span>&nbsp;<span class="ident" id="3855307"><a href="/net/http/server.go.html#3855268">c</a></span><span class="op" id="3855308">.</span><span class="ident" id="3855309">rwc</span>&nbsp;<span class="op" id="3855313">!=</span>&nbsp;<span class="ident" id="3855316">nil</span>&nbsp;<span class="op" id="3855320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855324"><a href="/net/http/server.go.html#3855268">c</a></span><span class="op" id="3855325">.</span><span class="ident" id="3855326">rwc</span><span class="op" id="3855329">.</span><span class="ident" id="3855330">Close</span><span class="op" id="3855335">(</span><span class="op" id="3855336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855340"><a href="/net/http/server.go.html#3855268">c</a></span><span class="op" id="3855341">.</span><span class="ident" id="3855342">rwc</span>&nbsp;<span class="op" id="3855346">=</span>&nbsp;<span class="ident" id="3855348">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3855353">}</span><br>
<span class="lineno"></span><span class="op" id="3855355">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span><span class="comment" id="3855358">//&nbsp;rstAvoidanceDelay&nbsp;is&nbsp;the&nbsp;amount&nbsp;of&nbsp;time&nbsp;we&nbsp;sleep&nbsp;after&nbsp;closing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3855428">//&nbsp;write&nbsp;side&nbsp;of&nbsp;a&nbsp;TCP&nbsp;connection&nbsp;before&nbsp;closing&nbsp;the&nbsp;entire&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="3855496">//&nbsp;By&nbsp;sleeping,&nbsp;we&nbsp;increase&nbsp;the&nbsp;chances&nbsp;that&nbsp;the&nbsp;client&nbsp;sees&nbsp;our&nbsp;FIN</span><br>
<span class="lineno"></span><span class="comment" id="3855565">//&nbsp;and&nbsp;processes&nbsp;its&nbsp;final&nbsp;data&nbsp;before&nbsp;they&nbsp;process&nbsp;the&nbsp;subsequent&nbsp;RST</span><br>
<span class="lineno">1080</span><span class="comment" id="3855636">//&nbsp;from&nbsp;closing&nbsp;a&nbsp;connection&nbsp;with&nbsp;known&nbsp;unread&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="3855689">//&nbsp;This&nbsp;RST&nbsp;seems&nbsp;to&nbsp;occur&nbsp;mostly&nbsp;on&nbsp;BSD&nbsp;systems.&nbsp;(And&nbsp;Windows?)</span><br>
<span class="lineno"></span><span class="comment" id="3855754">//&nbsp;This&nbsp;timeout&nbsp;is&nbsp;somewhat&nbsp;arbitrary&nbsp;(~latency&nbsp;around&nbsp;the&nbsp;planet).</span><br>
<span class="lineno"></span><span class="keyword" id="3855822">const</span>&nbsp;<span class="ident" id="3855828">rstAvoidanceDelay</span>&nbsp;<span class="op" id="3855846">=</span>&nbsp;<span class="num" id="3855848">500</span>&nbsp;<span class="op" id="3855852">*</span>&nbsp;<span class="ident" id="3855854"><a href="/net/http/server.go.html#3824898">time</a></span><span class="op" id="3855858">.</span><span class="ident" id="3855859">Millisecond</span><br>
<span class="lineno"></span><br>
<span class="lineno">1085</span><span class="keyword" id="3855872">type</span>&nbsp;<span class="ident" id="3855877">closeWriter</span>&nbsp;<span class="keyword" id="3855889">interface</span>&nbsp;<span class="op" id="3855899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3855902">CloseWrite</span><span class="op" id="3855912">(</span><span class="op" id="3855913">)</span>&nbsp;<span class="builtintype" id="3855915">error</span><br>
<span class="lineno"></span><span class="op" id="3855921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3855924">var</span>&nbsp;<span class="ident" id="3855928">_</span>&nbsp;<span class="ident" id="3855930"><a href="/net/http/server.go.html#3855877">closeWriter</a></span>&nbsp;<span class="op" id="3855942">=</span>&nbsp;<span class="op" id="3855944">(</span><span class="op" id="3855945">*</span><span class="ident" id="3855946"><a href="/net/http/server.go.html#3824810">net</a></span><span class="op" id="3855949">.</span><span class="ident" id="3855950">TCPConn</span><span class="op" id="3855957">)</span><span class="op" id="3855958">(</span><span class="ident" id="3855959">nil</span><span class="op" id="3855962">)</span><br>
<span class="lineno">1090</span><br>
<span class="lineno"></span><span class="comment" id="3855965">//&nbsp;closeWrite&nbsp;flushes&nbsp;any&nbsp;outstanding&nbsp;data&nbsp;and&nbsp;sends&nbsp;a&nbsp;FIN&nbsp;packet&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="3856035">//&nbsp;client&nbsp;is&nbsp;connected&nbsp;via&nbsp;TCP),&nbsp;signalling&nbsp;that&nbsp;we&#39;re&nbsp;done.&nbsp;&nbsp;We&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3856105">//&nbsp;pause&nbsp;for&nbsp;a&nbsp;bit,&nbsp;hoping&nbsp;the&nbsp;client&nbsp;processes&nbsp;it&nbsp;before&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="3856167">//&nbsp;subsequent&nbsp;RST.</span><br>
<span class="lineno">1095</span><span class="comment" id="3856186">//</span><br>
<span class="lineno"></span><span class="comment" id="3856189">//&nbsp;See&nbsp;http://golang.org/issue/3595</span><br>
<span class="lineno"></span><span class="keyword" id="3856225">func</span>&nbsp;<span class="op" id="3856230">(</span><span class="ident" id="3856231">c</span>&nbsp;<span class="op" id="3856233">*</span><span class="ident" id="3856234"><a href="/net/http/server.go.html#3828256">conn</a></span><span class="op" id="3856238">)</span>&nbsp;<span class="ident" id="3856240">closeWriteAndWait</span><span class="op" id="3856257">(</span><span class="op" id="3856258">)</span>&nbsp;<span class="op" id="3856260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856263"><a href="/net/http/server.go.html#3856231">c</a></span><span class="op" id="3856264">.</span><span class="ident" id="3856265">finalFlush</span><span class="op" id="3856275">(</span><span class="op" id="3856276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856279">if</span>&nbsp;<span class="ident" id="3856282">tcp</span><span class="op" id="3856285">,</span>&nbsp;<span class="ident" id="3856287">ok</span>&nbsp;<span class="op" id="3856290">:=</span>&nbsp;<span class="ident" id="3856293"><a href="/net/http/server.go.html#3856231">c</a></span><span class="op" id="3856294">.</span><span class="ident" id="3856295">rwc</span><span class="op" id="3856298">.</span><span class="op" id="3856299">(</span><span class="ident" id="3856300"><a href="/net/http/server.go.html#3855877">closeWriter</a></span><span class="op" id="3856311">)</span><span class="op" id="3856312">;</span>&nbsp;<span class="ident" id="3856314"><a href="/net/http/server.go.html#3856287">ok</a></span>&nbsp;<span class="op" id="3856317">{</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856321"><a href="/net/http/server.go.html#3856282">tcp</a></span><span class="op" id="3856324">.</span><span class="ident" id="3856325">CloseWrite</span><span class="op" id="3856335">(</span><span class="op" id="3856336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3856339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856342"><a href="/net/http/server.go.html#3824898">time</a></span><span class="op" id="3856346">.</span><span class="ident" id="3856347">Sleep</span><span class="op" id="3856352">(</span><span class="ident" id="3856353"><a href="/net/http/server.go.html#3855828">rstAvoidanceDelay</a></span><span class="op" id="3856370">)</span><br>
<span class="lineno"></span><span class="op" id="3856372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1105</span><span class="comment" id="3856375">//&nbsp;validNPN&nbsp;reports&nbsp;whether&nbsp;the&nbsp;proto&nbsp;is&nbsp;not&nbsp;a&nbsp;blacklisted&nbsp;Next</span><br>
<span class="lineno"></span><span class="comment" id="3856439">//&nbsp;Protocol&nbsp;Negotiation&nbsp;protocol.&nbsp;&nbsp;Empty&nbsp;and&nbsp;built-in&nbsp;protocol&nbsp;types</span><br>
<span class="lineno"></span><span class="comment" id="3856508">//&nbsp;are&nbsp;blacklisted&nbsp;and&nbsp;can&#39;t&nbsp;be&nbsp;overridden&nbsp;with&nbsp;alternate</span><br>
<span class="lineno"></span><span class="comment" id="3856566">//&nbsp;implementations.</span><br>
<span class="lineno"></span><span class="keyword" id="3856586">func</span>&nbsp;<span class="ident" id="3856591">validNPN</span><span class="op" id="3856599">(</span><span class="ident" id="3856600">proto</span>&nbsp;<span class="builtintype" id="3856606">string</span><span class="op" id="3856612">)</span>&nbsp;<span class="builtintype" id="3856614">bool</span>&nbsp;<span class="op" id="3856619">{</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856622">switch</span>&nbsp;<span class="ident" id="3856629"><a href="/net/http/server.go.html#3856600">proto</a></span>&nbsp;<span class="op" id="3856635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856638">case</span>&nbsp;<span class="string" id="3856643">&#34;&#34;</span><span class="op" id="3856645">,</span>&nbsp;<span class="string" id="3856647">&#34;http/1.1&#34;</span><span class="op" id="3856657">,</span>&nbsp;<span class="string" id="3856659">&#34;http/1.0&#34;</span><span class="op" id="3856669">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856673">return</span>&nbsp;<span class="ident" id="3856680">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3856687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856690">return</span>&nbsp;<span class="ident" id="3856697">true</span><br>
<span class="lineno">1115</span><span class="op" id="3856702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3856705">func</span>&nbsp;<span class="op" id="3856710">(</span><span class="ident" id="3856711">c</span>&nbsp;<span class="op" id="3856713">*</span><span class="ident" id="3856714"><a href="/net/http/server.go.html#3828256">conn</a></span><span class="op" id="3856718">)</span>&nbsp;<span class="ident" id="3856720">setState</span><span class="op" id="3856728">(</span><span class="ident" id="3856729">nc</span>&nbsp;<span class="ident" id="3856732"><a href="/net/http/server.go.html#3824810">net</a></span><span class="op" id="3856735">.</span><span class="ident" id="3856736">Conn</span><span class="op" id="3856740">,</span>&nbsp;<span class="ident" id="3856742">state</span>&nbsp;<span class="ident" id="3856748"><a href="/net/http/server.go.html#3873644">ConnState</a></span><span class="op" id="3856757">)</span>&nbsp;<span class="op" id="3856759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856762">if</span>&nbsp;<span class="ident" id="3856765">hook</span>&nbsp;<span class="op" id="3856770">:=</span>&nbsp;<span class="ident" id="3856773"><a href="/net/http/server.go.html#3856711">c</a></span><span class="op" id="3856774">.</span><span class="ident" id="3856775">server</span><span class="op" id="3856781">.</span><span class="ident" id="3856782">ConnState</span><span class="op" id="3856791">;</span>&nbsp;<span class="ident" id="3856793"><a href="/net/http/server.go.html#3856765">hook</a></span>&nbsp;<span class="op" id="3856798">!=</span>&nbsp;<span class="ident" id="3856801">nil</span>&nbsp;<span class="op" id="3856805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856809"><a href="/net/http/server.go.html#3856765">hook</a></span><span class="op" id="3856813">(</span><span class="ident" id="3856814"><a href="/net/http/server.go.html#3856729">nc</a></span><span class="op" id="3856816">,</span>&nbsp;<span class="ident" id="3856818"><a href="/net/http/server.go.html#3856742">state</a></span><span class="op" id="3856823">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3856826">}</span><br>
<span class="lineno"></span><span class="op" id="3856828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3856831">//&nbsp;Serve&nbsp;a&nbsp;new&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3856858">func</span>&nbsp;<span class="op" id="3856863">(</span><span class="ident" id="3856864">c</span>&nbsp;<span class="op" id="3856866">*</span><span class="ident" id="3856867"><a href="/net/http/server.go.html#3828256">conn</a></span><span class="op" id="3856871">)</span>&nbsp;<span class="ident" id="3856873">serve</span><span class="op" id="3856878">(</span><span class="op" id="3856879">)</span>&nbsp;<span class="op" id="3856881">{</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3856884">origConn</span>&nbsp;<span class="op" id="3856893">:=</span>&nbsp;<span class="ident" id="3856896"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3856897">.</span><span class="ident" id="3856898">rwc</span>&nbsp;<span class="comment" id="3856902">//&nbsp;copy&nbsp;it&nbsp;before&nbsp;it&#39;s&nbsp;set&nbsp;nil&nbsp;on&nbsp;Close&nbsp;or&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856953">defer</span>&nbsp;<span class="keyword" id="3856959">func</span><span class="op" id="3856963">(</span><span class="op" id="3856964">)</span>&nbsp;<span class="op" id="3856966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3856970">if</span>&nbsp;<span class="ident" id="3856973">err</span>&nbsp;<span class="op" id="3856977">:=</span>&nbsp;<span class="builtinfunc" id="3856980">recover</span><span class="op" id="3856987">(</span><span class="op" id="3856988">)</span><span class="op" id="3856989">;</span>&nbsp;<span class="ident" id="3856991"><a href="/net/http/server.go.html#3856973">err</a></span>&nbsp;<span class="op" id="3856995">!=</span>&nbsp;<span class="ident" id="3856998">nil</span>&nbsp;<span class="op" id="3857002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857007">const</span>&nbsp;<span class="ident" id="3857013">size</span>&nbsp;<span class="op" id="3857018">=</span>&nbsp;<span class="num" id="3857020">64</span>&nbsp;<span class="op" id="3857023">&lt;&lt;</span>&nbsp;<span class="num" id="3857026">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857032">buf</span>&nbsp;<span class="op" id="3857036">:=</span>&nbsp;<span class="builtinfunc" id="3857039">make</span><span class="op" id="3857043">(</span><span class="op" id="3857044">[</span><span class="op" id="3857045">]</span><span class="builtintype" id="3857046">byte</span><span class="op" id="3857050">,</span>&nbsp;<span class="ident" id="3857052"><a href="/net/http/server.go.html#3857013">size</a></span><span class="op" id="3857056">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857061"><a href="/net/http/server.go.html#3857032">buf</a></span>&nbsp;<span class="op" id="3857065">=</span>&nbsp;<span class="ident" id="3857067"><a href="/net/http/server.go.html#3857032">buf</a></span><span class="op" id="3857070">[</span><span class="op" id="3857071">:</span><span class="ident" id="3857072"><a href="/net/http/server.go.html#3824842">runtime</a></span><span class="op" id="3857079">.</span><span class="ident" id="3857080">Stack</span><span class="op" id="3857085">(</span><span class="ident" id="3857086"><a href="/net/http/server.go.html#3857032">buf</a></span><span class="op" id="3857089">,</span>&nbsp;<span class="ident" id="3857091">false</span><span class="op" id="3857096">)</span><span class="op" id="3857097">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857102"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3857103">.</span><span class="ident" id="3857104">server</span><span class="op" id="3857110">.</span><span class="ident" id="3857111">logf</span><span class="op" id="3857115">(</span><span class="string" id="3857116">&#34;http:&nbsp;panic&nbsp;serving&nbsp;%v:&nbsp;%v\n%s&#34;</span><span class="op" id="3857148">,</span>&nbsp;<span class="ident" id="3857150"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3857151">.</span><span class="ident" id="3857152">remoteAddr</span><span class="op" id="3857162">,</span>&nbsp;<span class="ident" id="3857164"><a href="/net/http/server.go.html#3856973">err</a></span><span class="op" id="3857167">,</span>&nbsp;<span class="ident" id="3857169"><a href="/net/http/server.go.html#3857032">buf</a></span><span class="op" id="3857172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3857176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857180">if</span>&nbsp;<span class="op" id="3857183">!</span><span class="ident" id="3857184"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3857185">.</span><span class="ident" id="3857186">hijacked</span><span class="op" id="3857194">(</span><span class="op" id="3857195">)</span>&nbsp;<span class="op" id="3857197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857202"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3857203">.</span><span class="builtinfunc" id="3857204">close</span><span class="op" id="3857209">(</span><span class="op" id="3857210">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857215"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3857216">.</span><span class="ident" id="3857217">setState</span><span class="op" id="3857225">(</span><span class="ident" id="3857226"><a href="/net/http/server.go.html#3856884">origConn</a></span><span class="op" id="3857234">,</span>&nbsp;<span class="ident" id="3857236"><a href="/net/http/server.go.html#3874758">StateClosed</a></span><span class="op" id="3857247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3857251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3857254">}</span><span class="op" id="3857255">(</span><span class="op" id="3857256">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857260">if</span>&nbsp;<span class="ident" id="3857263">tlsConn</span><span class="op" id="3857270">,</span>&nbsp;<span class="ident" id="3857272">ok</span>&nbsp;<span class="op" id="3857275">:=</span>&nbsp;<span class="ident" id="3857278"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3857279">.</span><span class="ident" id="3857280">rwc</span><span class="op" id="3857283">.</span><span class="op" id="3857284">(</span><span class="op" id="3857285">*</span><span class="ident" id="3857286"><a href="/net/http/server.go.html#3824753">tls</a></span><span class="op" id="3857289">.</span><span class="ident" id="3857290">Conn</span><span class="op" id="3857294">)</span><span class="op" id="3857295">;</span>&nbsp;<span class="ident" id="3857297"><a href="/net/http/server.go.html#3857272">ok</a></span>&nbsp;<span class="op" id="3857300">{</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857304">if</span>&nbsp;<span class="ident" id="3857307">d</span>&nbsp;<span class="op" id="3857309">:=</span>&nbsp;<span class="ident" id="3857312"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3857313">.</span><span class="ident" id="3857314">server</span><span class="op" id="3857320">.</span><span class="ident" id="3857321">ReadTimeout</span><span class="op" id="3857332">;</span>&nbsp;<span class="ident" id="3857334"><a href="/net/http/server.go.html#3857307">d</a></span>&nbsp;<span class="op" id="3857336">!=</span>&nbsp;<span class="num" id="3857339">0</span>&nbsp;<span class="op" id="3857341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857346"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3857347">.</span><span class="ident" id="3857348">rwc</span><span class="op" id="3857351">.</span><span class="ident" id="3857352">SetReadDeadline</span><span class="op" id="3857367">(</span><span class="ident" id="3857368"><a href="/net/http/server.go.html#3824898">time</a></span><span class="op" id="3857372">.</span><span class="ident" id="3857373">Now</span><span class="op" id="3857376">(</span><span class="op" id="3857377">)</span><span class="op" id="3857378">.</span><span class="ident" id="3857379">Add</span><span class="op" id="3857382">(</span><span class="ident" id="3857383"><a href="/net/http/server.go.html#3857307">d</a></span><span class="op" id="3857384">)</span><span class="op" id="3857385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3857389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857393">if</span>&nbsp;<span class="ident" id="3857396">d</span>&nbsp;<span class="op" id="3857398">:=</span>&nbsp;<span class="ident" id="3857401"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3857402">.</span><span class="ident" id="3857403">server</span><span class="op" id="3857409">.</span><span class="ident" id="3857410">WriteTimeout</span><span class="op" id="3857422">;</span>&nbsp;<span class="ident" id="3857424"><a href="/net/http/server.go.html#3857396">d</a></span>&nbsp;<span class="op" id="3857426">!=</span>&nbsp;<span class="num" id="3857429">0</span>&nbsp;<span class="op" id="3857431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857436"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3857437">.</span><span class="ident" id="3857438">rwc</span><span class="op" id="3857441">.</span><span class="ident" id="3857442">SetWriteDeadline</span><span class="op" id="3857458">(</span><span class="ident" id="3857459"><a href="/net/http/server.go.html#3824898">time</a></span><span class="op" id="3857463">.</span><span class="ident" id="3857464">Now</span><span class="op" id="3857467">(</span><span class="op" id="3857468">)</span><span class="op" id="3857469">.</span><span class="ident" id="3857470">Add</span><span class="op" id="3857473">(</span><span class="ident" id="3857474"><a href="/net/http/server.go.html#3857396">d</a></span><span class="op" id="3857475">)</span><span class="op" id="3857476">)</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3857480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857484">if</span>&nbsp;<span class="ident" id="3857487">err</span>&nbsp;<span class="op" id="3857491">:=</span>&nbsp;<span class="ident" id="3857494"><a href="/net/http/server.go.html#3857263">tlsConn</a></span><span class="op" id="3857501">.</span><span class="ident" id="3857502">Handshake</span><span class="op" id="3857511">(</span><span class="op" id="3857512">)</span><span class="op" id="3857513">;</span>&nbsp;<span class="ident" id="3857515"><a href="/net/http/server.go.html#3857487">err</a></span>&nbsp;<span class="op" id="3857519">!=</span>&nbsp;<span class="ident" id="3857522">nil</span>&nbsp;<span class="op" id="3857526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857531"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3857532">.</span><span class="ident" id="3857533">server</span><span class="op" id="3857539">.</span><span class="ident" id="3857540">logf</span><span class="op" id="3857544">(</span><span class="string" id="3857545">&#34;http:&nbsp;TLS&nbsp;handshake&nbsp;error&nbsp;from&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="3857584">,</span>&nbsp;<span class="ident" id="3857586"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3857587">.</span><span class="ident" id="3857588">rwc</span><span class="op" id="3857591">.</span><span class="ident" id="3857592">RemoteAddr</span><span class="op" id="3857602">(</span><span class="op" id="3857603">)</span><span class="op" id="3857604">,</span>&nbsp;<span class="ident" id="3857606"><a href="/net/http/server.go.html#3857487">err</a></span><span class="op" id="3857609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857614">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3857623">}</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857627"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3857628">.</span><span class="ident" id="3857629">tlsState</span>&nbsp;<span class="op" id="3857638">=</span>&nbsp;<span class="builtinfunc" id="3857640">new</span><span class="op" id="3857643">(</span><span class="ident" id="3857644"><a href="/net/http/server.go.html#3824753">tls</a></span><span class="op" id="3857647">.</span><span class="ident" id="3857648">ConnectionState</span><span class="op" id="3857663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3857667">*</span><span class="ident" id="3857668"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3857669">.</span><span class="ident" id="3857670">tlsState</span>&nbsp;<span class="op" id="3857679">=</span>&nbsp;<span class="ident" id="3857681"><a href="/net/http/server.go.html#3857263">tlsConn</a></span><span class="op" id="3857688">.</span><span class="ident" id="3857689">ConnectionState</span><span class="op" id="3857704">(</span><span class="op" id="3857705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857709">if</span>&nbsp;<span class="ident" id="3857712">proto</span>&nbsp;<span class="op" id="3857718">:=</span>&nbsp;<span class="ident" id="3857721"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3857722">.</span><span class="ident" id="3857723">tlsState</span><span class="op" id="3857731">.</span><span class="ident" id="3857732">NegotiatedProtocol</span><span class="op" id="3857750">;</span>&nbsp;<span class="ident" id="3857752"><a href="/net/http/server.go.html#3856591">validNPN</a></span><span class="op" id="3857760">(</span><span class="ident" id="3857761"><a href="/net/http/server.go.html#3857712">proto</a></span><span class="op" id="3857766">)</span>&nbsp;<span class="op" id="3857768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857773">if</span>&nbsp;<span class="ident" id="3857776">fn</span>&nbsp;<span class="op" id="3857779">:=</span>&nbsp;<span class="ident" id="3857782"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3857783">.</span><span class="ident" id="3857784">server</span><span class="op" id="3857790">.</span><span class="ident" id="3857791">TLSNextProto</span><span class="op" id="3857803">[</span><span class="ident" id="3857804"><a href="/net/http/server.go.html#3857712">proto</a></span><span class="op" id="3857809">]</span><span class="op" id="3857810">;</span>&nbsp;<span class="ident" id="3857812"><a href="/net/http/server.go.html#3857776">fn</a></span>&nbsp;<span class="op" id="3857815">!=</span>&nbsp;<span class="ident" id="3857818">nil</span>&nbsp;<span class="op" id="3857822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857828">h</span>&nbsp;<span class="op" id="3857830">:=</span>&nbsp;<span class="ident" id="3857833"><a href="/net/http/server.go.html#3884280">initNPNRequest</a></span><span class="op" id="3857847">{</span><span class="ident" id="3857848"><a href="/net/http/server.go.html#3857263">tlsConn</a></span><span class="op" id="3857855">,</span>&nbsp;<span class="ident" id="3857857"><a href="/net/http/server.go.html#3875126">serverHandler</a></span><span class="op" id="3857870">{</span><span class="ident" id="3857871"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3857872">.</span><span class="ident" id="3857873">server</span><span class="op" id="3857879">}</span><span class="op" id="3857880">}</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857886"><a href="/net/http/server.go.html#3857776">fn</a></span><span class="op" id="3857888">(</span><span class="ident" id="3857889"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3857890">.</span><span class="ident" id="3857891">server</span><span class="op" id="3857897">,</span>&nbsp;<span class="ident" id="3857899"><a href="/net/http/server.go.html#3857263">tlsConn</a></span><span class="op" id="3857906">,</span>&nbsp;<span class="ident" id="3857908"><a href="/net/http/server.go.html#3857828">h</a></span><span class="op" id="3857909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3857914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857919">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3857928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3857931">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857935">for</span>&nbsp;<span class="op" id="3857939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3857943">w</span><span class="op" id="3857944">,</span>&nbsp;<span class="ident" id="3857946">err</span>&nbsp;<span class="op" id="3857950">:=</span>&nbsp;<span class="ident" id="3857953"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3857954">.</span><span class="ident" id="3857955">readRequest</span><span class="op" id="3857966">(</span><span class="op" id="3857967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3857971">if</span>&nbsp;<span class="ident" id="3857974"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3857975">.</span><span class="ident" id="3857976">lr</span><span class="op" id="3857978">.</span><span class="ident" id="3857979">N</span>&nbsp;<span class="op" id="3857981">!=</span>&nbsp;<span class="ident" id="3857984"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3857985">.</span><span class="ident" id="3857986">server</span><span class="op" id="3857992">.</span><span class="ident" id="3857993">initialLimitedReaderSize</span><span class="op" id="3858017">(</span><span class="op" id="3858018">)</span>&nbsp;<span class="op" id="3858020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3858025">//&nbsp;If&nbsp;we&nbsp;read&nbsp;any&nbsp;bytes&nbsp;off&nbsp;the&nbsp;wire,&nbsp;we&#39;re&nbsp;active.</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858080"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3858081">.</span><span class="ident" id="3858082">setState</span><span class="op" id="3858090">(</span><span class="ident" id="3858091"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3858092">.</span><span class="ident" id="3858093">rwc</span><span class="op" id="3858096">,</span>&nbsp;<span class="ident" id="3858098"><a href="/net/http/server.go.html#3874236">StateActive</a></span><span class="op" id="3858109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3858113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3858117">if</span>&nbsp;<span class="ident" id="3858120"><a href="/net/http/server.go.html#3857946">err</a></span>&nbsp;<span class="op" id="3858124">!=</span>&nbsp;<span class="ident" id="3858127">nil</span>&nbsp;<span class="op" id="3858131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3858136">if</span>&nbsp;<span class="ident" id="3858139"><a href="/net/http/server.go.html#3857946">err</a></span>&nbsp;<span class="op" id="3858143">==</span>&nbsp;<span class="ident" id="3858146"><a href="/net/http/server.go.html#3840464">errTooLarge</a></span>&nbsp;<span class="op" id="3858158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3858164">//&nbsp;Their&nbsp;HTTP&nbsp;client&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;be</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3858207">//&nbsp;able&nbsp;to&nbsp;read&nbsp;this&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3858241">//&nbsp;responding&nbsp;to&nbsp;them&nbsp;and&nbsp;hanging&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3858282">//&nbsp;while&nbsp;they&#39;re&nbsp;still&nbsp;writing&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3858323">//&nbsp;request.&nbsp;&nbsp;Undefined&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858360"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3858362">.</span><span class="ident" id="3858363">WriteString</span><span class="op" id="3858374">(</span><span class="ident" id="3858375"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3858376">.</span><span class="ident" id="3858377">rwc</span><span class="op" id="3858380">,</span>&nbsp;<span class="string" id="3858382">&#34;HTTP/1.1&nbsp;413&nbsp;Request&nbsp;Entity&nbsp;Too&nbsp;Large\r\n\r\n&#34;</span><span class="op" id="3858429">)</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858435"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3858436">.</span><span class="ident" id="3858437">closeWriteAndWait</span><span class="op" id="3858454">(</span><span class="op" id="3858455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3858461">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3858470">}</span>&nbsp;<span class="keyword" id="3858472">else</span>&nbsp;<span class="keyword" id="3858477">if</span>&nbsp;<span class="ident" id="3858480"><a href="/net/http/server.go.html#3857946">err</a></span>&nbsp;<span class="op" id="3858484">==</span>&nbsp;<span class="ident" id="3858487"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3858489">.</span><span class="ident" id="3858490">EOF</span>&nbsp;<span class="op" id="3858494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3858500">break</span>&nbsp;<span class="comment" id="3858506">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3858524">}</span>&nbsp;<span class="keyword" id="3858526">else</span>&nbsp;<span class="keyword" id="3858531">if</span>&nbsp;<span class="ident" id="3858534">neterr</span><span class="op" id="3858540">,</span>&nbsp;<span class="ident" id="3858542">ok</span>&nbsp;<span class="op" id="3858545">:=</span>&nbsp;<span class="ident" id="3858548"><a href="/net/http/server.go.html#3857946">err</a></span><span class="op" id="3858551">.</span><span class="op" id="3858552">(</span><span class="ident" id="3858553"><a href="/net/http/server.go.html#3824810">net</a></span><span class="op" id="3858556">.</span><span class="ident" id="3858557">Error</span><span class="op" id="3858562">)</span><span class="op" id="3858563">;</span>&nbsp;<span class="ident" id="3858565"><a href="/net/http/server.go.html#3858542">ok</a></span>&nbsp;<span class="op" id="3858568">&amp;&amp;</span>&nbsp;<span class="ident" id="3858571"><a href="/net/http/server.go.html#3858534">neterr</a></span><span class="op" id="3858577">.</span><span class="ident" id="3858578">Timeout</span><span class="op" id="3858585">(</span><span class="op" id="3858586">)</span>&nbsp;<span class="op" id="3858588">{</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3858594">break</span>&nbsp;<span class="comment" id="3858600">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3858618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858623"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3858625">.</span><span class="ident" id="3858626">WriteString</span><span class="op" id="3858637">(</span><span class="ident" id="3858638"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3858639">.</span><span class="ident" id="3858640">rwc</span><span class="op" id="3858643">,</span>&nbsp;<span class="string" id="3858645">&#34;HTTP/1.1&nbsp;400&nbsp;Bad&nbsp;Request\r\n\r\n&#34;</span><span class="op" id="3858679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3858684">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3858692">}</span><br>
<span class="lineno">1185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3858697">//&nbsp;Expect&nbsp;100&nbsp;Continue&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858730">req</span>&nbsp;<span class="op" id="3858734">:=</span>&nbsp;<span class="ident" id="3858737"><a href="/net/http/server.go.html#3857943">w</a></span><span class="op" id="3858738">.</span><span class="ident" id="3858739">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3858745">if</span>&nbsp;<span class="ident" id="3858748"><a href="/net/http/server.go.html#3858730">req</a></span><span class="op" id="3858751">.</span><span class="ident" id="3858752">expectsContinue</span><span class="op" id="3858767">(</span><span class="op" id="3858768">)</span>&nbsp;<span class="op" id="3858770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3858775">if</span>&nbsp;<span class="ident" id="3858778"><a href="/net/http/server.go.html#3858730">req</a></span><span class="op" id="3858781">.</span><span class="ident" id="3858782">ProtoAtLeast</span><span class="op" id="3858794">(</span><span class="num" id="3858795">1</span><span class="op" id="3858796">,</span>&nbsp;<span class="num" id="3858798">1</span><span class="op" id="3858799">)</span>&nbsp;<span class="op" id="3858801">&amp;&amp;</span>&nbsp;<span class="ident" id="3858804"><a href="/net/http/server.go.html#3858730">req</a></span><span class="op" id="3858807">.</span><span class="ident" id="3858808">ContentLength</span>&nbsp;<span class="op" id="3858822">!=</span>&nbsp;<span class="num" id="3858825">0</span>&nbsp;<span class="op" id="3858827">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3858833">//&nbsp;Wrap&nbsp;the&nbsp;Body&nbsp;reader&nbsp;with&nbsp;one&nbsp;that&nbsp;replies&nbsp;on&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858901"><a href="/net/http/server.go.html#3858730">req</a></span><span class="op" id="3858904">.</span><span class="ident" id="3858905">Body</span>&nbsp;<span class="op" id="3858910">=</span>&nbsp;<span class="op" id="3858912">&amp;</span><span class="ident" id="3858913"><a href="/net/http/server.go.html#3838970">expectContinueReader</a></span><span class="op" id="3858933">{</span><span class="ident" id="3858934">readCloser</span><span class="op" id="3858944">:</span>&nbsp;<span class="ident" id="3858946"><a href="/net/http/server.go.html#3858730">req</a></span><span class="op" id="3858949">.</span><span class="ident" id="3858950">Body</span><span class="op" id="3858954">,</span>&nbsp;<span class="ident" id="3858956">resp</span><span class="op" id="3858960">:</span>&nbsp;<span class="ident" id="3858962"><a href="/net/http/server.go.html#3857943">w</a></span><span class="op" id="3858963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3858968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3858973"><a href="/net/http/server.go.html#3858730">req</a></span><span class="op" id="3858976">.</span><span class="ident" id="3858977">Header</span><span class="op" id="3858983">.</span><span class="ident" id="3858984">Del</span><span class="op" id="3858987">(</span><span class="string" id="3858988">&#34;Expect&#34;</span><span class="op" id="3858996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859000">}</span>&nbsp;<span class="keyword" id="3859002">else</span>&nbsp;<span class="keyword" id="3859007">if</span>&nbsp;<span class="ident" id="3859010"><a href="/net/http/server.go.html#3858730">req</a></span><span class="op" id="3859013">.</span><span class="ident" id="3859014">Header</span><span class="op" id="3859020">.</span><span class="ident" id="3859021">get</span><span class="op" id="3859024">(</span><span class="string" id="3859025">&#34;Expect&#34;</span><span class="op" id="3859033">)</span>&nbsp;<span class="op" id="3859035">!=</span>&nbsp;<span class="string" id="3859038">&#34;&#34;</span>&nbsp;<span class="op" id="3859041">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859046"><a href="/net/http/server.go.html#3857943">w</a></span><span class="op" id="3859047">.</span><span class="ident" id="3859048">sendExpectationFailed</span><span class="op" id="3859069">(</span><span class="op" id="3859070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859075">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859088">//&nbsp;HTTP&nbsp;cannot&nbsp;have&nbsp;multiple&nbsp;simultaneous&nbsp;active&nbsp;requests.[*]</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859152">//&nbsp;Until&nbsp;the&nbsp;server&nbsp;replies&nbsp;to&nbsp;this&nbsp;request,&nbsp;it&nbsp;can&#39;t&nbsp;read&nbsp;another,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859222">//&nbsp;so&nbsp;we&nbsp;might&nbsp;as&nbsp;well&nbsp;run&nbsp;the&nbsp;handler&nbsp;in&nbsp;this&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859282">//&nbsp;[*]&nbsp;Not&nbsp;strictly&nbsp;true:&nbsp;HTTP&nbsp;pipelining.&nbsp;&nbsp;We&nbsp;could&nbsp;let&nbsp;them&nbsp;all&nbsp;process</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859358">//&nbsp;in&nbsp;parallel&nbsp;even&nbsp;if&nbsp;their&nbsp;responses&nbsp;need&nbsp;to&nbsp;be&nbsp;serialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859422"><a href="/net/http/server.go.html#3875126">serverHandler</a></span><span class="op" id="3859435">{</span><span class="ident" id="3859436"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3859437">.</span><span class="ident" id="3859438">server</span><span class="op" id="3859444">}</span><span class="op" id="3859445">.</span><span class="ident" id="3859446">ServeHTTP</span><span class="op" id="3859455">(</span><span class="ident" id="3859456"><a href="/net/http/server.go.html#3857943">w</a></span><span class="op" id="3859457">,</span>&nbsp;<span class="ident" id="3859459"><a href="/net/http/server.go.html#3857943">w</a></span><span class="op" id="3859460">.</span><span class="ident" id="3859461">req</span><span class="op" id="3859464">)</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859468">if</span>&nbsp;<span class="ident" id="3859471"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3859472">.</span><span class="ident" id="3859473">hijacked</span><span class="op" id="3859481">(</span><span class="op" id="3859482">)</span>&nbsp;<span class="op" id="3859484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859489">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859502"><a href="/net/http/server.go.html#3857943">w</a></span><span class="op" id="3859503">.</span><span class="ident" id="3859504">finishRequest</span><span class="op" id="3859517">(</span><span class="op" id="3859518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859522">if</span>&nbsp;<span class="ident" id="3859525"><a href="/net/http/server.go.html#3857943">w</a></span><span class="op" id="3859526">.</span><span class="ident" id="3859527">closeAfterReply</span>&nbsp;<span class="op" id="3859543">{</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859548">if</span>&nbsp;<span class="ident" id="3859551"><a href="/net/http/server.go.html#3857943">w</a></span><span class="op" id="3859552">.</span><span class="ident" id="3859553">requestBodyLimitHit</span>&nbsp;<span class="op" id="3859573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859579"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3859580">.</span><span class="ident" id="3859581">closeWriteAndWait</span><span class="op" id="3859598">(</span><span class="op" id="3859599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3859609">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859617">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859621"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3859622">.</span><span class="ident" id="3859623">setState</span><span class="op" id="3859631">(</span><span class="ident" id="3859632"><a href="/net/http/server.go.html#3856864">c</a></span><span class="op" id="3859633">.</span><span class="ident" id="3859634">rwc</span><span class="op" id="3859637">,</span>&nbsp;<span class="ident" id="3859639"><a href="/net/http/server.go.html#3874472">StateIdle</a></span><span class="op" id="3859648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3859651">}</span><br>
<span class="lineno"></span><span class="op" id="3859653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3859656">func</span>&nbsp;<span class="op" id="3859661">(</span><span class="ident" id="3859662">w</span>&nbsp;<span class="op" id="3859664">*</span><span class="ident" id="3859665"><a href="/net/http/server.go.html#3833137">response</a></span><span class="op" id="3859673">)</span>&nbsp;<span class="ident" id="3859675">sendExpectationFailed</span><span class="op" id="3859696">(</span><span class="op" id="3859697">)</span>&nbsp;<span class="op" id="3859699">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859702">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;ServeHTTP&nbsp;handlers&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859752">//&nbsp;requests&nbsp;with&nbsp;non-standard&nbsp;expectation[s]?&nbsp;Seems</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859805">//&nbsp;theoretical&nbsp;at&nbsp;best,&nbsp;and&nbsp;doesn&#39;t&nbsp;fit&nbsp;into&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859855">//&nbsp;current&nbsp;ServeHTTP&nbsp;model&nbsp;anyway.&nbsp;&nbsp;We&#39;d&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859905">//&nbsp;make&nbsp;the&nbsp;ResponseWriter&nbsp;an&nbsp;optional</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859945">//&nbsp;&#34;ExpectReplier&#34;&nbsp;interface&nbsp;or&nbsp;something.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859989">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3859993">//&nbsp;For&nbsp;now&nbsp;we&#39;ll&nbsp;just&nbsp;obey&nbsp;RFC&nbsp;2616&nbsp;14.20&nbsp;which&nbsp;says</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860047">//&nbsp;&#34;If&nbsp;a&nbsp;server&nbsp;receives&nbsp;a&nbsp;request&nbsp;containing&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860097">//&nbsp;Expect&nbsp;field&nbsp;that&nbsp;includes&nbsp;an&nbsp;expectation-</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860144">//&nbsp;extension&nbsp;that&nbsp;it&nbsp;does&nbsp;not&nbsp;support,&nbsp;it&nbsp;MUST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860192">//&nbsp;respond&nbsp;with&nbsp;a&nbsp;417&nbsp;(Expectation&nbsp;Failed)&nbsp;status.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860245"><a href="/net/http/server.go.html#3859662">w</a></span><span class="op" id="3860246">.</span><span class="ident" id="3860247">Header</span><span class="op" id="3860253">(</span><span class="op" id="3860254">)</span><span class="op" id="3860255">.</span><span class="ident" id="3860256">Set</span><span class="op" id="3860259">(</span><span class="string" id="3860260">&#34;Connection&#34;</span><span class="op" id="3860272">,</span>&nbsp;<span class="string" id="3860274">&#34;close&#34;</span><span class="op" id="3860281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860284"><a href="/net/http/server.go.html#3859662">w</a></span><span class="op" id="3860285">.</span><span class="ident" id="3860286">WriteHeader</span><span class="op" id="3860297">(</span><span class="ident" id="3860298"><a href="/net/http/status.go.html#3892845">StatusExpectationFailed</a></span><span class="op" id="3860321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860324"><a href="/net/http/server.go.html#3859662">w</a></span><span class="op" id="3860325">.</span><span class="ident" id="3860326">finishRequest</span><span class="op" id="3860339">(</span><span class="op" id="3860340">)</span><br>
<span class="lineno">1235</span><span class="op" id="3860342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3860345">//&nbsp;Hijack&nbsp;implements&nbsp;the&nbsp;Hijacker.Hijack&nbsp;method.&nbsp;Our&nbsp;response&nbsp;is&nbsp;both&nbsp;a&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="3860432">//&nbsp;and&nbsp;a&nbsp;Hijacker.</span><br>
<span class="lineno"></span><span class="keyword" id="3860451">func</span>&nbsp;<span class="op" id="3860456">(</span><span class="ident" id="3860457">w</span>&nbsp;<span class="op" id="3860459">*</span><span class="ident" id="3860460"><a href="/net/http/server.go.html#3833137">response</a></span><span class="op" id="3860468">)</span>&nbsp;<span class="ident" id="3860470">Hijack</span><span class="op" id="3860476">(</span><span class="op" id="3860477">)</span>&nbsp;<span class="op" id="3860479">(</span><span class="ident" id="3860480">rwc</span>&nbsp;<span class="ident" id="3860484"><a href="/net/http/server.go.html#3824810">net</a></span><span class="op" id="3860487">.</span><span class="ident" id="3860488">Conn</span><span class="op" id="3860492">,</span>&nbsp;<span class="ident" id="3860494">buf</span>&nbsp;<span class="op" id="3860498">*</span><span class="ident" id="3860499"><a href="/net/http/server.go.html#3824744">bufio</a></span><span class="op" id="3860504">.</span><span class="ident" id="3860505">ReadWriter</span><span class="op" id="3860515">,</span>&nbsp;<span class="ident" id="3860517">err</span>&nbsp;<span class="builtintype" id="3860521">error</span><span class="op" id="3860526">)</span>&nbsp;<span class="op" id="3860528">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860531">if</span>&nbsp;<span class="ident" id="3860534"><a href="/net/http/server.go.html#3860457">w</a></span><span class="op" id="3860535">.</span><span class="ident" id="3860536">wroteHeader</span>&nbsp;<span class="op" id="3860548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860552"><a href="/net/http/server.go.html#3860457">w</a></span><span class="op" id="3860553">.</span><span class="ident" id="3860554">cw</span><span class="op" id="3860556">.</span><span class="ident" id="3860557">flush</span><span class="op" id="3860562">(</span><span class="op" id="3860563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860569">//&nbsp;Release&nbsp;the&nbsp;bufioWriter&nbsp;that&nbsp;writes&nbsp;to&nbsp;the&nbsp;chunk&nbsp;writer,&nbsp;it&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860640">//&nbsp;used&nbsp;after&nbsp;a&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked.</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860687"><a href="/net/http/server.go.html#3860480">rwc</a></span><span class="op" id="3860690">,</span>&nbsp;<span class="ident" id="3860692"><a href="/net/http/server.go.html#3860494">buf</a></span><span class="op" id="3860695">,</span>&nbsp;<span class="ident" id="3860697"><a href="/net/http/server.go.html#3860517">err</a></span>&nbsp;<span class="op" id="3860701">=</span>&nbsp;<span class="ident" id="3860703"><a href="/net/http/server.go.html#3860457">w</a></span><span class="op" id="3860704">.</span><span class="ident" id="3860705">conn</span><span class="op" id="3860709">.</span><span class="ident" id="3860710">hijack</span><span class="op" id="3860716">(</span><span class="op" id="3860717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860720">if</span>&nbsp;<span class="ident" id="3860723"><a href="/net/http/server.go.html#3860517">err</a></span>&nbsp;<span class="op" id="3860727">==</span>&nbsp;<span class="ident" id="3860730">nil</span>&nbsp;<span class="op" id="3860734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860738"><a href="/net/http/server.go.html#3838290">putBufioWriter</a></span><span class="op" id="3860752">(</span><span class="ident" id="3860753"><a href="/net/http/server.go.html#3860457">w</a></span><span class="op" id="3860754">.</span><span class="ident" id="3860755">w</span><span class="op" id="3860756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860760"><a href="/net/http/server.go.html#3860457">w</a></span><span class="op" id="3860761">.</span><span class="ident" id="3860762">w</span>&nbsp;<span class="op" id="3860764">=</span>&nbsp;<span class="ident" id="3860766">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860771">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860774">return</span>&nbsp;<span class="ident" id="3860781"><a href="/net/http/server.go.html#3860480">rwc</a></span><span class="op" id="3860784">,</span>&nbsp;<span class="ident" id="3860786"><a href="/net/http/server.go.html#3860494">buf</a></span><span class="op" id="3860789">,</span>&nbsp;<span class="ident" id="3860791"><a href="/net/http/server.go.html#3860517">err</a></span><br>
<span class="lineno"></span><span class="op" id="3860795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3860798">func</span>&nbsp;<span class="op" id="3860803">(</span><span class="ident" id="3860804">w</span>&nbsp;<span class="op" id="3860806">*</span><span class="ident" id="3860807"><a href="/net/http/server.go.html#3833137">response</a></span><span class="op" id="3860815">)</span>&nbsp;<span class="ident" id="3860817">CloseNotify</span><span class="op" id="3860828">(</span><span class="op" id="3860829">)</span>&nbsp;<span class="op" id="3860831">&lt;-</span><span class="keyword" id="3860833">chan</span>&nbsp;<span class="builtintype" id="3860838">bool</span>&nbsp;<span class="op" id="3860843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860846">return</span>&nbsp;<span class="ident" id="3860853"><a href="/net/http/server.go.html#3860804">w</a></span><span class="op" id="3860854">.</span><span class="ident" id="3860855">conn</span><span class="op" id="3860859">.</span><span class="ident" id="3860860">closeNotify</span><span class="op" id="3860871">(</span><span class="op" id="3860872">)</span><br>
<span class="lineno">1255</span><span class="op" id="3860874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3860877">//&nbsp;The&nbsp;HandlerFunc&nbsp;type&nbsp;is&nbsp;an&nbsp;adapter&nbsp;to&nbsp;allow&nbsp;the&nbsp;use&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3860935">//&nbsp;ordinary&nbsp;functions&nbsp;as&nbsp;HTTP&nbsp;handlers.&nbsp;&nbsp;If&nbsp;f&nbsp;is&nbsp;a&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="3860995">//&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;signature,&nbsp;HandlerFunc(f)&nbsp;is&nbsp;a</span><br>
<span class="lineno">1260</span><span class="comment" id="3861050">//&nbsp;Handler&nbsp;object&nbsp;that&nbsp;calls&nbsp;f.</span><br>
<span class="lineno"></span><span class="keyword" id="3861082">type</span>&nbsp;<span class="ident" id="3861087">HandlerFunc</span>&nbsp;<span class="keyword" id="3861099">func</span><span class="op" id="3861103">(</span><span class="ident" id="3861104"><a href="/net/http/server.go.html#3826033">ResponseWriter</a></span><span class="op" id="3861118">,</span>&nbsp;<span class="op" id="3861120">*</span><span class="ident" id="3861121"><a href="/net/http/request.go.html#3791418">Request</a></span><span class="op" id="3861128">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3861131">//&nbsp;ServeHTTP&nbsp;calls&nbsp;f(w,&nbsp;r).</span><br>
<span class="lineno"></span><span class="keyword" id="3861159">func</span>&nbsp;<span class="op" id="3861164">(</span><span class="ident" id="3861165">f</span>&nbsp;<span class="ident" id="3861167"><a href="/net/http/server.go.html#3861087">HandlerFunc</a></span><span class="op" id="3861178">)</span>&nbsp;<span class="ident" id="3861180">ServeHTTP</span><span class="op" id="3861189">(</span><span class="ident" id="3861190">w</span>&nbsp;<span class="ident" id="3861192"><a href="/net/http/server.go.html#3826033">ResponseWriter</a></span><span class="op" id="3861206">,</span>&nbsp;<span class="ident" id="3861208">r</span>&nbsp;<span class="op" id="3861210">*</span><span class="ident" id="3861211"><a href="/net/http/request.go.html#3791418">Request</a></span><span class="op" id="3861218">)</span>&nbsp;<span class="op" id="3861220">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861223"><a href="/net/http/server.go.html#3861165">f</a></span><span class="op" id="3861224">(</span><span class="ident" id="3861225"><a href="/net/http/server.go.html#3861190">w</a></span><span class="op" id="3861226">,</span>&nbsp;<span class="ident" id="3861228"><a href="/net/http/server.go.html#3861208">r</a></span><span class="op" id="3861229">)</span><br>
<span class="lineno"></span><span class="op" id="3861231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3861234">//&nbsp;Helper&nbsp;handlers</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="3861254">//&nbsp;Error&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;specified&nbsp;error&nbsp;message&nbsp;and&nbsp;HTTP&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment" id="3861334">//&nbsp;The&nbsp;error&nbsp;message&nbsp;should&nbsp;be&nbsp;plain&nbsp;text.</span><br>
<span class="lineno"></span><span class="keyword" id="3861377">func</span>&nbsp;<span class="ident" id="3861382">Error</span><span class="op" id="3861387">(</span><span class="ident" id="3861388">w</span>&nbsp;<span class="ident" id="3861390"><a href="/net/http/server.go.html#3826033">ResponseWriter</a></span><span class="op" id="3861404">,</span>&nbsp;<span class="builtintype" id="3861406">error</span>&nbsp;<span class="builtintype" id="3861412">string</span><span class="op" id="3861418">,</span>&nbsp;<span class="ident" id="3861420">code</span>&nbsp;<span class="builtintype" id="3861425">int</span><span class="op" id="3861428">)</span>&nbsp;<span class="op" id="3861430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861433"><a href="/net/http/server.go.html#3861388">w</a></span><span class="op" id="3861434">.</span><span class="ident" id="3861435">Header</span><span class="op" id="3861441">(</span><span class="op" id="3861442">)</span><span class="op" id="3861443">.</span><span class="ident" id="3861444">Set</span><span class="op" id="3861447">(</span><span class="string" id="3861448">&#34;Content-Type&#34;</span><span class="op" id="3861462">,</span>&nbsp;<span class="string" id="3861464">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="3861491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861494"><a href="/net/http/server.go.html#3861388">w</a></span><span class="op" id="3861495">.</span><span class="ident" id="3861496">WriteHeader</span><span class="op" id="3861507">(</span><span class="ident" id="3861508"><a href="/net/http/server.go.html#3861420">code</a></span><span class="op" id="3861512">)</span><br>
<span class="lineno">1275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861515"><a href="/net/http/server.go.html#3824777">fmt</a></span><span class="op" id="3861518">.</span><span class="ident" id="3861519">Fprintln</span><span class="op" id="3861527">(</span><span class="ident" id="3861528"><a href="/net/http/server.go.html#3861388">w</a></span><span class="op" id="3861529">,</span>&nbsp;<span class="builtintype" id="3861531"><a href="/net/http/server.go.html#3861406">error</a></span><span class="op" id="3861536">)</span><br>
<span class="lineno"></span><span class="op" id="3861538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3861541">//&nbsp;NotFound&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3861610">func</span>&nbsp;<span class="ident" id="3861615">NotFound</span><span class="op" id="3861623">(</span><span class="ident" id="3861624">w</span>&nbsp;<span class="ident" id="3861626"><a href="/net/http/server.go.html#3826033">ResponseWriter</a></span><span class="op" id="3861640">,</span>&nbsp;<span class="ident" id="3861642">r</span>&nbsp;<span class="op" id="3861644">*</span><span class="ident" id="3861645"><a href="/net/http/request.go.html#3791418">Request</a></span><span class="op" id="3861652">)</span>&nbsp;<span class="op" id="3861654">{</span>&nbsp;<span class="ident" id="3861656"><a href="/net/http/server.go.html#3861382">Error</a></span><span class="op" id="3861661">(</span><span class="ident" id="3861662"><a href="/net/http/server.go.html#3861624">w</a></span><span class="op" id="3861663">,</span>&nbsp;<span class="string" id="3861665">&#34;404&nbsp;page&nbsp;not&nbsp;found&#34;</span><span class="op" id="3861685">,</span>&nbsp;<span class="ident" id="3861687"><a href="/net/http/status.go.html#3892299">StatusNotFound</a></span><span class="op" id="3861701">)</span>&nbsp;<span class="op" id="3861703">}</span><br>
<span class="lineno">1280</span><br>
<span class="lineno"></span><span class="comment" id="3861706">//&nbsp;NotFoundHandler&nbsp;returns&nbsp;a&nbsp;simple&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="3861758">//&nbsp;that&nbsp;replies&nbsp;to&nbsp;each&nbsp;request&nbsp;with&nbsp;a&nbsp;``404&nbsp;page&nbsp;not&nbsp;found&#39;&#39;&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="3861827">func</span>&nbsp;<span class="ident" id="3861832">NotFoundHandler</span><span class="op" id="3861847">(</span><span class="op" id="3861848">)</span>&nbsp;<span class="ident" id="3861850"><a href="/net/http/server.go.html#3825877">Handler</a></span>&nbsp;<span class="op" id="3861858">{</span>&nbsp;<span class="keyword" id="3861860">return</span>&nbsp;<span class="ident" id="3861867"><a href="/net/http/server.go.html#3861087">HandlerFunc</a></span><span class="op" id="3861878">(</span><span class="ident" id="3861879"><a href="/net/http/server.go.html#3861615">NotFound</a></span><span class="op" id="3861887">)</span>&nbsp;<span class="op" id="3861889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span><span class="comment" id="3861892">//&nbsp;StripPrefix&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3861951">//&nbsp;by&nbsp;removing&nbsp;the&nbsp;given&nbsp;prefix&nbsp;from&nbsp;the&nbsp;request&nbsp;URL&#39;s&nbsp;Path</span><br>
<span class="lineno"></span><span class="comment" id="3862011">//&nbsp;and&nbsp;invoking&nbsp;the&nbsp;handler&nbsp;h.&nbsp;StripPrefix&nbsp;handles&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3862064">//&nbsp;request&nbsp;for&nbsp;a&nbsp;path&nbsp;that&nbsp;doesn&#39;t&nbsp;begin&nbsp;with&nbsp;prefix&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3862120">//&nbsp;replying&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno">1290</span><span class="keyword" id="3862166">func</span>&nbsp;<span class="ident" id="3862171">StripPrefix</span><span class="op" id="3862182">(</span><span class="ident" id="3862183">prefix</span>&nbsp;<span class="builtintype" id="3862190">string</span><span class="op" id="3862196">,</span>&nbsp;<span class="ident" id="3862198">h</span>&nbsp;<span class="ident" id="3862200"><a href="/net/http/server.go.html#3825877">Handler</a></span><span class="op" id="3862207">)</span>&nbsp;<span class="ident" id="3862209"><a href="/net/http/server.go.html#3825877">Handler</a></span>&nbsp;<span class="op" id="3862217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862220">if</span>&nbsp;<span class="ident" id="3862223"><a href="/net/http/server.go.html#3862183">prefix</a></span>&nbsp;<span class="op" id="3862230">==</span>&nbsp;<span class="string" id="3862233">&#34;&#34;</span>&nbsp;<span class="op" id="3862236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862240">return</span>&nbsp;<span class="ident" id="3862247"><a href="/net/http/server.go.html#3862198">h</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862253">return</span>&nbsp;<span class="ident" id="3862260"><a href="/net/http/server.go.html#3861087">HandlerFunc</a></span><span class="op" id="3862271">(</span><span class="keyword" id="3862272">func</span><span class="op" id="3862276">(</span><span class="ident" id="3862277">w</span>&nbsp;<span class="ident" id="3862279"><a href="/net/http/server.go.html#3826033">ResponseWriter</a></span><span class="op" id="3862293">,</span>&nbsp;<span class="ident" id="3862295">r</span>&nbsp;<span class="op" id="3862297">*</span><span class="ident" id="3862298"><a href="/net/http/request.go.html#3791418">Request</a></span><span class="op" id="3862305">)</span>&nbsp;<span class="op" id="3862307">{</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862311">if</span>&nbsp;<span class="ident" id="3862314">p</span>&nbsp;<span class="op" id="3862316">:=</span>&nbsp;<span class="ident" id="3862319"><a href="/net/http/server.go.html#3824864">strings</a></span><span class="op" id="3862326">.</span><span class="ident" id="3862327">TrimPrefix</span><span class="op" id="3862337">(</span><span class="ident" id="3862338"><a href="/net/http/server.go.html#3862295">r</a></span><span class="op" id="3862339">.</span><span class="ident" id="3862340">URL</span><span class="op" id="3862343">.</span><span class="ident" id="3862344">Path</span><span class="op" id="3862348">,</span>&nbsp;<span class="ident" id="3862350"><a href="/net/http/server.go.html#3862183">prefix</a></span><span class="op" id="3862356">)</span><span class="op" id="3862357">;</span>&nbsp;<span class="builtinfunc" id="3862359">len</span><span class="op" id="3862362">(</span><span class="ident" id="3862363"><a href="/net/http/server.go.html#3862314">p</a></span><span class="op" id="3862364">)</span>&nbsp;<span class="op" id="3862366">&lt;</span>&nbsp;<span class="builtinfunc" id="3862368">len</span><span class="op" id="3862371">(</span><span class="ident" id="3862372"><a href="/net/http/server.go.html#3862295">r</a></span><span class="op" id="3862373">.</span><span class="ident" id="3862374">URL</span><span class="op" id="3862377">.</span><span class="ident" id="3862378">Path</span><span class="op" id="3862382">)</span>&nbsp;<span class="op" id="3862384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862389"><a href="/net/http/server.go.html#3862295">r</a></span><span class="op" id="3862390">.</span><span class="ident" id="3862391">URL</span><span class="op" id="3862394">.</span><span class="ident" id="3862395">Path</span>&nbsp;<span class="op" id="3862400">=</span>&nbsp;<span class="ident" id="3862402"><a href="/net/http/server.go.html#3862314">p</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862407"><a href="/net/http/server.go.html#3862198">h</a></span><span class="op" id="3862408">.</span><span class="ident" id="3862409">ServeHTTP</span><span class="op" id="3862418">(</span><span class="ident" id="3862419"><a href="/net/http/server.go.html#3862277">w</a></span><span class="op" id="3862420">,</span>&nbsp;<span class="ident" id="3862422"><a href="/net/http/server.go.html#3862295">r</a></span><span class="op" id="3862423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862427">}</span>&nbsp;<span class="keyword" id="3862429">else</span>&nbsp;<span class="op" id="3862434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862439"><a href="/net/http/server.go.html#3861615">NotFound</a></span><span class="op" id="3862447">(</span><span class="ident" id="3862448"><a href="/net/http/server.go.html#3862277">w</a></span><span class="op" id="3862449">,</span>&nbsp;<span class="ident" id="3862451"><a href="/net/http/server.go.html#3862295">r</a></span><span class="op" id="3862452">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862459">}</span><span class="op" id="3862460">)</span><br>
<span class="lineno"></span><span class="op" id="3862462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3862465">//&nbsp;Redirect&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;a&nbsp;redirect&nbsp;to&nbsp;url,</span><br>
<span class="lineno">1305</span><span class="comment" id="3862524">//&nbsp;which&nbsp;may&nbsp;be&nbsp;a&nbsp;path&nbsp;relative&nbsp;to&nbsp;the&nbsp;request&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="3862577">func</span>&nbsp;<span class="ident" id="3862582">Redirect</span><span class="op" id="3862590">(</span><span class="ident" id="3862591">w</span>&nbsp;<span class="ident" id="3862593"><a href="/net/http/server.go.html#3826033">ResponseWriter</a></span><span class="op" id="3862607">,</span>&nbsp;<span class="ident" id="3862609">r</span>&nbsp;<span class="op" id="3862611">*</span><span class="ident" id="3862612"><a href="/net/http/request.go.html#3791418">Request</a></span><span class="op" id="3862619">,</span>&nbsp;<span class="ident" id="3862621">urlStr</span>&nbsp;<span class="builtintype" id="3862628">string</span><span class="op" id="3862634">,</span>&nbsp;<span class="ident" id="3862636">code</span>&nbsp;<span class="builtintype" id="3862641">int</span><span class="op" id="3862644">)</span>&nbsp;<span class="op" id="3862646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862649">if</span>&nbsp;<span class="ident" id="3862652">u</span><span class="op" id="3862653">,</span>&nbsp;<span class="ident" id="3862655">err</span>&nbsp;<span class="op" id="3862659">:=</span>&nbsp;<span class="ident" id="3862662"><a href="/net/http/server.go.html#3824817">url</a></span><span class="op" id="3862665">.</span><span class="ident" id="3862666">Parse</span><span class="op" id="3862671">(</span><span class="ident" id="3862672"><a href="/net/http/server.go.html#3862621">urlStr</a></span><span class="op" id="3862678">)</span><span class="op" id="3862679">;</span>&nbsp;<span class="ident" id="3862681"><a href="/net/http/server.go.html#3862655">err</a></span>&nbsp;<span class="op" id="3862685">==</span>&nbsp;<span class="ident" id="3862688">nil</span>&nbsp;<span class="op" id="3862692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3862696">//&nbsp;If&nbsp;url&nbsp;was&nbsp;relative,&nbsp;make&nbsp;absolute&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3862739">//&nbsp;combining&nbsp;with&nbsp;request&nbsp;path.</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3862773">//&nbsp;The&nbsp;browser&nbsp;would&nbsp;probably&nbsp;do&nbsp;this&nbsp;for&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3862821">//&nbsp;but&nbsp;doing&nbsp;it&nbsp;ourselves&nbsp;is&nbsp;more&nbsp;reliable.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3862868">//&nbsp;NOTE(rsc):&nbsp;RFC&nbsp;2616&nbsp;says&nbsp;that&nbsp;the&nbsp;Location</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3862916">//&nbsp;line&nbsp;must&nbsp;be&nbsp;an&nbsp;absolute&nbsp;URI,&nbsp;like</span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3862956">//&nbsp;&#34;http://www.google.com/redirect/&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3862996">//&nbsp;not&nbsp;a&nbsp;path&nbsp;like&nbsp;&#34;/redirect/&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3863031">//&nbsp;Unfortunately,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;what&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3863073">//&nbsp;put&nbsp;in&nbsp;the&nbsp;host&nbsp;name&nbsp;section&nbsp;to&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3863118">//&nbsp;client&nbsp;to&nbsp;connect&nbsp;to&nbsp;us&nbsp;again,&nbsp;so&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3863166">//&nbsp;know&nbsp;the&nbsp;right&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;send&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3863213">//&nbsp;Because&nbsp;of&nbsp;this&nbsp;problem,&nbsp;no&nbsp;one&nbsp;pays&nbsp;attention</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3863265">//&nbsp;to&nbsp;the&nbsp;RFC;&nbsp;they&nbsp;all&nbsp;send&nbsp;back&nbsp;just&nbsp;a&nbsp;new&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3863318">//&nbsp;So&nbsp;do&nbsp;we.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863333">oldpath</span>&nbsp;<span class="op" id="3863341">:=</span>&nbsp;<span class="ident" id="3863344"><a href="/net/http/server.go.html#3862609">r</a></span><span class="op" id="3863345">.</span><span class="ident" id="3863346">URL</span><span class="op" id="3863349">.</span><span class="ident" id="3863350">Path</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863357">if</span>&nbsp;<span class="ident" id="3863360"><a href="/net/http/server.go.html#3863333">oldpath</a></span>&nbsp;<span class="op" id="3863368">==</span>&nbsp;<span class="string" id="3863371">&#34;&#34;</span>&nbsp;<span class="op" id="3863374">{</span>&nbsp;<span class="comment" id="3863376">//&nbsp;should&nbsp;not&nbsp;happen,&nbsp;but&nbsp;avoid&nbsp;a&nbsp;crash&nbsp;if&nbsp;it&nbsp;does</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863430"><a href="/net/http/server.go.html#3863333">oldpath</a></span>&nbsp;<span class="op" id="3863438">=</span>&nbsp;<span class="string" id="3863440">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863450">if</span>&nbsp;<span class="ident" id="3863453"><a href="/net/http/server.go.html#3862652">u</a></span><span class="op" id="3863454">.</span><span class="ident" id="3863455">Scheme</span>&nbsp;<span class="op" id="3863462">==</span>&nbsp;<span class="string" id="3863465">&#34;&#34;</span>&nbsp;<span class="op" id="3863468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3863473">//&nbsp;no&nbsp;leading&nbsp;http://server</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863504">if</span>&nbsp;<span class="ident" id="3863507"><a href="/net/http/server.go.html#3862621">urlStr</a></span>&nbsp;<span class="op" id="3863514">==</span>&nbsp;<span class="string" id="3863517">&#34;&#34;</span>&nbsp;<span class="op" id="3863520">||</span>&nbsp;<span class="ident" id="3863523"><a href="/net/http/server.go.html#3862621">urlStr</a></span><span class="op" id="3863529">[</span><span class="num" id="3863530">0</span><span class="op" id="3863531">]</span>&nbsp;<span class="op" id="3863533">!=</span>&nbsp;<span class="string" id="3863536">&#39;/&#39;</span>&nbsp;<span class="op" id="3863540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3863546">//&nbsp;make&nbsp;relative&nbsp;path&nbsp;absolute</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863581">olddir</span><span class="op" id="3863587">,</span>&nbsp;<span class="ident" id="3863589">_</span>&nbsp;<span class="op" id="3863591">:=</span>&nbsp;<span class="ident" id="3863594"><a href="/net/http/server.go.html#3824834">path</a></span><span class="op" id="3863598">.</span><span class="ident" id="3863599">Split</span><span class="op" id="3863604">(</span><span class="ident" id="3863605"><a href="/net/http/server.go.html#3863333">oldpath</a></span><span class="op" id="3863612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863618"><a href="/net/http/server.go.html#3862621">urlStr</a></span>&nbsp;<span class="op" id="3863625">=</span>&nbsp;<span class="ident" id="3863627"><a href="/net/http/server.go.html#3863581">olddir</a></span>&nbsp;<span class="op" id="3863634">+</span>&nbsp;<span class="ident" id="3863636"><a href="/net/http/server.go.html#3862621">urlStr</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863646">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863652">var</span>&nbsp;<span class="ident" id="3863656">query</span>&nbsp;<span class="builtintype" id="3863662">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863672">if</span>&nbsp;<span class="ident" id="3863675">i</span>&nbsp;<span class="op" id="3863677">:=</span>&nbsp;<span class="ident" id="3863680"><a href="/net/http/server.go.html#3824864">strings</a></span><span class="op" id="3863687">.</span><span class="ident" id="3863688">Index</span><span class="op" id="3863693">(</span><span class="ident" id="3863694"><a href="/net/http/server.go.html#3862621">urlStr</a></span><span class="op" id="3863700">,</span>&nbsp;<span class="string" id="3863702">&#34;?&#34;</span><span class="op" id="3863705">)</span><span class="op" id="3863706">;</span>&nbsp;<span class="ident" id="3863708"><a href="/net/http/server.go.html#3863675">i</a></span>&nbsp;<span class="op" id="3863710">!=</span>&nbsp;<span class="op" id="3863713">-</span><span class="num" id="3863714">1</span>&nbsp;<span class="op" id="3863716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863722"><a href="/net/http/server.go.html#3862621">urlStr</a></span><span class="op" id="3863728">,</span>&nbsp;<span class="ident" id="3863730"><a href="/net/http/server.go.html#3863656">query</a></span>&nbsp;<span class="op" id="3863736">=</span>&nbsp;<span class="ident" id="3863738"><a href="/net/http/server.go.html#3862621">urlStr</a></span><span class="op" id="3863744">[</span><span class="op" id="3863745">:</span><span class="ident" id="3863746"><a href="/net/http/server.go.html#3863675">i</a></span><span class="op" id="3863747">]</span><span class="op" id="3863748">,</span>&nbsp;<span class="ident" id="3863750"><a href="/net/http/server.go.html#3862621">urlStr</a></span><span class="op" id="3863756">[</span><span class="ident" id="3863757"><a href="/net/http/server.go.html#3863675">i</a></span><span class="op" id="3863758">:</span><span class="op" id="3863759">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863764">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3863770">//&nbsp;clean&nbsp;up&nbsp;but&nbsp;preserve&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863813">trailing</span>&nbsp;<span class="op" id="3863822">:=</span>&nbsp;<span class="ident" id="3863825"><a href="/net/http/server.go.html#3824864">strings</a></span><span class="op" id="3863832">.</span><span class="ident" id="3863833">HasSuffix</span><span class="op" id="3863842">(</span><span class="ident" id="3863843"><a href="/net/http/server.go.html#3862621">urlStr</a></span><span class="op" id="3863849">,</span>&nbsp;<span class="string" id="3863851">&#34;/&#34;</span><span class="op" id="3863854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863859"><a href="/net/http/server.go.html#3862621">urlStr</a></span>&nbsp;<span class="op" id="3863866">=</span>&nbsp;<span class="ident" id="3863868"><a href="/net/http/server.go.html#3824834">path</a></span><span class="op" id="3863872">.</span><span class="ident" id="3863873">Clean</span><span class="op" id="3863878">(</span><span class="ident" id="3863879"><a href="/net/http/server.go.html#3862621">urlStr</a></span><span class="op" id="3863885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863890">if</span>&nbsp;<span class="ident" id="3863893"><a href="/net/http/server.go.html#3863813">trailing</a></span>&nbsp;<span class="op" id="3863902">&amp;&amp;</span>&nbsp;<span class="op" id="3863905">!</span><span class="ident" id="3863906"><a href="/net/http/server.go.html#3824864">strings</a></span><span class="op" id="3863913">.</span><span class="ident" id="3863914">HasSuffix</span><span class="op" id="3863923">(</span><span class="ident" id="3863924"><a href="/net/http/server.go.html#3862621">urlStr</a></span><span class="op" id="3863930">,</span>&nbsp;<span class="string" id="3863932">&#34;/&#34;</span><span class="op" id="3863935">)</span>&nbsp;<span class="op" id="3863937">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863943"><a href="/net/http/server.go.html#3862621">urlStr</a></span>&nbsp;<span class="op" id="3863950">+=</span>&nbsp;<span class="string" id="3863953">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863965"><a href="/net/http/server.go.html#3862621">urlStr</a></span>&nbsp;<span class="op" id="3863972">+=</span>&nbsp;<span class="ident" id="3863975"><a href="/net/http/server.go.html#3863656">query</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863986">}</span><br>
<span class="lineno">1350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863990"><a href="/net/http/server.go.html#3862591">w</a></span><span class="op" id="3863991">.</span><span class="ident" id="3863992">Header</span><span class="op" id="3863998">(</span><span class="op" id="3863999">)</span><span class="op" id="3864000">.</span><span class="ident" id="3864001">Set</span><span class="op" id="3864004">(</span><span class="string" id="3864005">&#34;Location&#34;</span><span class="op" id="3864015">,</span>&nbsp;<span class="ident" id="3864017"><a href="/net/http/server.go.html#3862621">urlStr</a></span><span class="op" id="3864023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864026"><a href="/net/http/server.go.html#3862591">w</a></span><span class="op" id="3864027">.</span><span class="ident" id="3864028">WriteHeader</span><span class="op" id="3864039">(</span><span class="ident" id="3864040"><a href="/net/http/server.go.html#3862636">code</a></span><span class="op" id="3864044">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3864048">//&nbsp;RFC2616&nbsp;recommends&nbsp;that&nbsp;a&nbsp;short&nbsp;note&nbsp;&#34;SHOULD&#34;&nbsp;be&nbsp;included&nbsp;in&nbsp;the</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3864117">//&nbsp;response&nbsp;because&nbsp;older&nbsp;user&nbsp;agents&nbsp;may&nbsp;not&nbsp;understand&nbsp;301/307.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3864184">//&nbsp;Shouldn&#39;t&nbsp;send&nbsp;the&nbsp;response&nbsp;for&nbsp;POST&nbsp;or&nbsp;HEAD;&nbsp;that&nbsp;leaves&nbsp;GET.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864251">if</span>&nbsp;<span class="ident" id="3864254"><a href="/net/http/server.go.html#3862609">r</a></span><span class="op" id="3864255">.</span><span class="ident" id="3864256">Method</span>&nbsp;<span class="op" id="3864263">==</span>&nbsp;<span class="string" id="3864266">&#34;GET&#34;</span>&nbsp;<span class="op" id="3864272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864276">note</span>&nbsp;<span class="op" id="3864281">:=</span>&nbsp;<span class="string" id="3864284">&#34;&lt;a&nbsp;href=\&#34;&#34;</span>&nbsp;<span class="op" id="3864297">+</span>&nbsp;<span class="ident" id="3864299"><a href="/net/http/server.go.html#3864621">htmlEscape</a></span><span class="op" id="3864309">(</span><span class="ident" id="3864310"><a href="/net/http/server.go.html#3862621">urlStr</a></span><span class="op" id="3864316">)</span>&nbsp;<span class="op" id="3864318">+</span>&nbsp;<span class="string" id="3864320">&#34;\&#34;&gt;&#34;</span>&nbsp;<span class="op" id="3864326">+</span>&nbsp;<span class="ident" id="3864328"><a href="/net/http/status.go.html#3893462">statusText</a></span><span class="op" id="3864338">[</span><span class="ident" id="3864339"><a href="/net/http/server.go.html#3862636">code</a></span><span class="op" id="3864343">]</span>&nbsp;<span class="op" id="3864345">+</span>&nbsp;<span class="string" id="3864347">&#34;&lt;/a&gt;.\n&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864359"><a href="/net/http/server.go.html#3824777">fmt</a></span><span class="op" id="3864362">.</span><span class="ident" id="3864363">Fprintln</span><span class="op" id="3864371">(</span><span class="ident" id="3864372"><a href="/net/http/server.go.html#3862591">w</a></span><span class="op" id="3864373">,</span>&nbsp;<span class="ident" id="3864375"><a href="/net/http/server.go.html#3864276">note</a></span><span class="op" id="3864379">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3864382">}</span><br>
<span class="lineno"></span><span class="op" id="3864384">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3864387">var</span>&nbsp;<span class="ident" id="3864391">htmlReplacer</span>&nbsp;<span class="op" id="3864404">=</span>&nbsp;<span class="ident" id="3864406"><a href="/net/http/server.go.html#3824864">strings</a></span><span class="op" id="3864413">.</span><span class="ident" id="3864414">NewReplacer</span><span class="op" id="3864425">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3864428">&#34;&amp;&#34;</span><span class="op" id="3864431">,</span>&nbsp;<span class="string" id="3864433">&#34;&amp;amp;&#34;</span><span class="op" id="3864440">,</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3864443">&#34;&lt;&#34;</span><span class="op" id="3864446">,</span>&nbsp;<span class="string" id="3864448">&#34;&amp;lt;&#34;</span><span class="op" id="3864454">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3864457">&#34;&gt;&#34;</span><span class="op" id="3864460">,</span>&nbsp;<span class="string" id="3864462">&#34;&amp;gt;&#34;</span><span class="op" id="3864468">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3864471">//&nbsp;&#34;&amp;#34;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;quot;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3864509">`&#34;`</span><span class="op" id="3864512">,</span>&nbsp;<span class="string" id="3864514">&#34;&amp;#34;&#34;</span><span class="op" id="3864521">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3864524">//&nbsp;&#34;&amp;#39;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;apos;&#34;&nbsp;and&nbsp;apos&nbsp;was&nbsp;not&nbsp;in&nbsp;HTML&nbsp;until&nbsp;HTML5.</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3864599">&#34;&#39;&#34;</span><span class="op" id="3864602">,</span>&nbsp;<span class="string" id="3864604">&#34;&amp;#39;&#34;</span><span class="op" id="3864611">,</span><br>
<span class="lineno"></span><span class="op" id="3864613">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3864616">func</span>&nbsp;<span class="ident" id="3864621">htmlEscape</span><span class="op" id="3864631">(</span><span class="ident" id="3864632">s</span>&nbsp;<span class="builtintype" id="3864634">string</span><span class="op" id="3864640">)</span>&nbsp;<span class="builtintype" id="3864642">string</span>&nbsp;<span class="op" id="3864649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864652">return</span>&nbsp;<span class="ident" id="3864659"><a href="/net/http/server.go.html#3864391">htmlReplacer</a></span><span class="op" id="3864671">.</span><span class="ident" id="3864672">Replace</span><span class="op" id="3864679">(</span><span class="ident" id="3864680"><a href="/net/http/server.go.html#3864632">s</a></span><span class="op" id="3864681">)</span><br>
<span class="lineno">1375</span><span class="op" id="3864683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3864686">//&nbsp;Redirect&nbsp;to&nbsp;a&nbsp;fixed&nbsp;URL</span><br>
<span class="lineno"></span><span class="keyword" id="3864713">type</span>&nbsp;<span class="ident" id="3864718">redirectHandler</span>&nbsp;<span class="keyword" id="3864734">struct</span>&nbsp;<span class="op" id="3864741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864744">url</span>&nbsp;&nbsp;<span class="builtintype" id="3864749">string</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864757">code</span>&nbsp;<span class="builtintype" id="3864762">int</span><br>
<span class="lineno"></span><span class="op" id="3864766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3864769">func</span>&nbsp;<span class="op" id="3864774">(</span><span class="ident" id="3864775">rh</span>&nbsp;<span class="op" id="3864778">*</span><span class="ident" id="3864779"><a href="/net/http/server.go.html#3864718">redirectHandler</a></span><span class="op" id="3864794">)</span>&nbsp;<span class="ident" id="3864796">ServeHTTP</span><span class="op" id="3864805">(</span><span class="ident" id="3864806">w</span>&nbsp;<span class="ident" id="3864808"><a href="/net/http/server.go.html#3826033">ResponseWriter</a></span><span class="op" id="3864822">,</span>&nbsp;<span class="ident" id="3864824">r</span>&nbsp;<span class="op" id="3864826">*</span><span class="ident" id="3864827"><a href="/net/http/request.go.html#3791418">Request</a></span><span class="op" id="3864834">)</span>&nbsp;<span class="op" id="3864836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864839"><a href="/net/http/server.go.html#3862582">Redirect</a></span><span class="op" id="3864847">(</span><span class="ident" id="3864848"><a href="/net/http/server.go.html#3864806">w</a></span><span class="op" id="3864849">,</span>&nbsp;<span class="ident" id="3864851"><a href="/net/http/server.go.html#3864824">r</a></span><span class="op" id="3864852">,</span>&nbsp;<span class="ident" id="3864854"><a href="/net/http/server.go.html#3864775">rh</a></span><span class="op" id="3864856">.</span><span class="ident" id="3864857">url</span><span class="op" id="3864860">,</span>&nbsp;<span class="ident" id="3864862"><a href="/net/http/server.go.html#3864775">rh</a></span><span class="op" id="3864864">.</span><span class="ident" id="3864865">code</span><span class="op" id="3864869">)</span><br>
<span class="lineno">1385</span><span class="op" id="3864871">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3864874">//&nbsp;RedirectHandler&nbsp;returns&nbsp;a&nbsp;request&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno"></span><span class="comment" id="3864934">//&nbsp;each&nbsp;request&nbsp;it&nbsp;receives&nbsp;to&nbsp;the&nbsp;given&nbsp;url&nbsp;using&nbsp;the&nbsp;given</span><br>
<span class="lineno"></span><span class="comment" id="3864995">//&nbsp;status&nbsp;code.</span><br>
<span class="lineno">1390</span><span class="keyword" id="3865011">func</span>&nbsp;<span class="ident" id="3865016">RedirectHandler</span><span class="op" id="3865031">(</span><span class="ident" id="3865032">url</span>&nbsp;<span class="builtintype" id="3865036">string</span><span class="op" id="3865042">,</span>&nbsp;<span class="ident" id="3865044">code</span>&nbsp;<span class="builtintype" id="3865049">int</span><span class="op" id="3865052">)</span>&nbsp;<span class="ident" id="3865054"><a href="/net/http/server.go.html#3825877">Handler</a></span>&nbsp;<span class="op" id="3865062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865065">return</span>&nbsp;<span class="op" id="3865072">&amp;</span><span class="ident" id="3865073"><a href="/net/http/server.go.html#3864718">redirectHandler</a></span><span class="op" id="3865088">{</span><span class="ident" id="3865089"><a href="/net/http/server.go.html#3865032">url</a></span><span class="op" id="3865092">,</span>&nbsp;<span class="ident" id="3865094"><a href="/net/http/server.go.html#3865044">code</a></span><span class="op" id="3865098">}</span><br>
<span class="lineno"></span><span class="op" id="3865100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3865103">//&nbsp;ServeMux&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;request&nbsp;multiplexer.</span><br>
<span class="lineno">1395</span><span class="comment" id="3865147">//&nbsp;It&nbsp;matches&nbsp;the&nbsp;URL&nbsp;of&nbsp;each&nbsp;incoming&nbsp;request&nbsp;against&nbsp;a&nbsp;list&nbsp;of&nbsp;registered</span><br>
<span class="lineno"></span><span class="comment" id="3865223">//&nbsp;patterns&nbsp;and&nbsp;calls&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;pattern&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3865278">//&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;URL.</span><br>
<span class="lineno"></span><span class="comment" id="3865311">//</span><br>
<span class="lineno"></span><span class="comment" id="3865314">//&nbsp;Patterns&nbsp;name&nbsp;fixed,&nbsp;rooted&nbsp;paths,&nbsp;like&nbsp;&#34;/favicon.ico&#34;,</span><br>
<span class="lineno">1400</span><span class="comment" id="3865373">//&nbsp;or&nbsp;rooted&nbsp;subtrees,&nbsp;like&nbsp;&#34;/images/&#34;&nbsp;(note&nbsp;the&nbsp;trailing&nbsp;slash).</span><br>
<span class="lineno"></span><span class="comment" id="3865439">//&nbsp;Longer&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over&nbsp;shorter&nbsp;ones,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3865501">//&nbsp;if&nbsp;there&nbsp;are&nbsp;handlers&nbsp;registered&nbsp;for&nbsp;both&nbsp;&#34;/images/&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3865557">//&nbsp;and&nbsp;&#34;/images/thumbnails/&#34;,&nbsp;the&nbsp;latter&nbsp;handler&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3865614">//&nbsp;called&nbsp;for&nbsp;paths&nbsp;beginning&nbsp;&#34;/images/thumbnails/&#34;&nbsp;and&nbsp;the</span><br>
<span class="lineno">1405</span><span class="comment" id="3865674">//&nbsp;former&nbsp;will&nbsp;receive&nbsp;requests&nbsp;for&nbsp;any&nbsp;other&nbsp;paths&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3865733">//&nbsp;&#34;/images/&#34;&nbsp;subtree.</span><br>
<span class="lineno"></span><span class="comment" id="3865756">//</span><br>
<span class="lineno"></span><span class="comment" id="3865759">//&nbsp;Note&nbsp;that&nbsp;since&nbsp;a&nbsp;pattern&nbsp;ending&nbsp;in&nbsp;a&nbsp;slash&nbsp;names&nbsp;a&nbsp;rooted&nbsp;subtree,</span><br>
<span class="lineno"></span><span class="comment" id="3865830">//&nbsp;the&nbsp;pattern&nbsp;&#34;/&#34;&nbsp;matches&nbsp;all&nbsp;paths&nbsp;not&nbsp;matched&nbsp;by&nbsp;other&nbsp;registered</span><br>
<span class="lineno">1410</span><span class="comment" id="3865899">//&nbsp;patterns,&nbsp;not&nbsp;just&nbsp;the&nbsp;URL&nbsp;with&nbsp;Path&nbsp;==&nbsp;&#34;/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3865947">//</span><br>
<span class="lineno"></span><span class="comment" id="3865950">//&nbsp;Patterns&nbsp;may&nbsp;optionally&nbsp;begin&nbsp;with&nbsp;a&nbsp;host&nbsp;name,&nbsp;restricting&nbsp;matches&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3866024">//&nbsp;URLs&nbsp;on&nbsp;that&nbsp;host&nbsp;only.&nbsp;&nbsp;Host-specific&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="3866096">//&nbsp;general&nbsp;patterns,&nbsp;so&nbsp;that&nbsp;a&nbsp;handler&nbsp;might&nbsp;register&nbsp;for&nbsp;the&nbsp;two&nbsp;patterns</span><br>
<span class="lineno">1415</span><span class="comment" id="3866171">//&nbsp;&#34;/codesearch&#34;&nbsp;and&nbsp;&#34;codesearch.google.com/&#34;&nbsp;without&nbsp;also&nbsp;taking&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="3866242">//&nbsp;requests&nbsp;for&nbsp;&#34;http://www.google.com/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3866284">//</span><br>
<span class="lineno"></span><span class="comment" id="3866287">//&nbsp;ServeMux&nbsp;also&nbsp;takes&nbsp;care&nbsp;of&nbsp;sanitizing&nbsp;the&nbsp;URL&nbsp;request&nbsp;path,</span><br>
<span class="lineno"></span><span class="comment" id="3866351">//&nbsp;redirecting&nbsp;any&nbsp;request&nbsp;containing&nbsp;.&nbsp;or&nbsp;..&nbsp;elements&nbsp;to&nbsp;an</span><br>
<span class="lineno">1420</span><span class="comment" id="3866412">//&nbsp;equivalent&nbsp;.-&nbsp;and&nbsp;..-free&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3866446">type</span>&nbsp;<span class="ident" id="3866451">ServeMux</span>&nbsp;<span class="keyword" id="3866460">struct</span>&nbsp;<span class="op" id="3866467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866470">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3866476"><a href="/net/http/server.go.html#3824875">sync</a></span><span class="op" id="3866480">.</span><span class="ident" id="3866481">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866490">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3866496">map</span><span class="op" id="3866499">[</span><span class="builtintype" id="3866500">string</span><span class="op" id="3866506">]</span><span class="ident" id="3866507"><a href="/net/http/server.go.html#3866578">muxEntry</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866517">hosts</span>&nbsp;<span class="builtintype" id="3866523">bool</span>&nbsp;<span class="comment" id="3866528">//&nbsp;whether&nbsp;any&nbsp;patterns&nbsp;contain&nbsp;hostnames</span><br>
<span class="lineno">1425</span><span class="op" id="3866570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3866573">type</span>&nbsp;<span class="ident" id="3866578">muxEntry</span>&nbsp;<span class="keyword" id="3866587">struct</span>&nbsp;<span class="op" id="3866594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866597">explicit</span>&nbsp;<span class="builtintype" id="3866606">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866612">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3866621"><a href="/net/http/server.go.html#3825877">Handler</a></span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866630">pattern</span>&nbsp;&nbsp;<span class="builtintype" id="3866639">string</span><br>
<span class="lineno"></span><span class="op" id="3866646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3866649">//&nbsp;NewServeMux&nbsp;allocates&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="3866702">func</span>&nbsp;<span class="ident" id="3866707">NewServeMux</span><span class="op" id="3866718">(</span><span class="op" id="3866719">)</span>&nbsp;<span class="op" id="3866721">*</span><span class="ident" id="3866722"><a href="/net/http/server.go.html#3866451">ServeMux</a></span>&nbsp;<span class="op" id="3866731">{</span>&nbsp;<span class="keyword" id="3866733">return</span>&nbsp;<span class="op" id="3866740">&amp;</span><span class="ident" id="3866741"><a href="/net/http/server.go.html#3866451">ServeMux</a></span><span class="op" id="3866749">{</span><span class="ident" id="3866750">m</span><span class="op" id="3866751">:</span>&nbsp;<span class="builtinfunc" id="3866753">make</span><span class="op" id="3866757">(</span><span class="keyword" id="3866758">map</span><span class="op" id="3866761">[</span><span class="builtintype" id="3866762">string</span><span class="op" id="3866768">]</span><span class="ident" id="3866769"><a href="/net/http/server.go.html#3866578">muxEntry</a></span><span class="op" id="3866777">)</span><span class="op" id="3866778">}</span>&nbsp;<span class="op" id="3866780">}</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span><span class="comment" id="3866783">//&nbsp;DefaultServeMux&nbsp;is&nbsp;the&nbsp;default&nbsp;ServeMux&nbsp;used&nbsp;by&nbsp;Serve.</span><br>
<span class="lineno"></span><span class="keyword" id="3866841">var</span>&nbsp;<span class="ident" id="3866845">DefaultServeMux</span>&nbsp;<span class="op" id="3866861">=</span>&nbsp;<span class="ident" id="3866863"><a href="/net/http/server.go.html#3866707">NewServeMux</a></span><span class="op" id="3866874">(</span><span class="op" id="3866875">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3866878">//&nbsp;Does&nbsp;path&nbsp;match&nbsp;pattern?</span><br>
<span class="lineno">1440</span><span class="keyword" id="3866906">func</span>&nbsp;<span class="ident" id="3866911">pathMatch</span><span class="op" id="3866920">(</span><span class="ident" id="3866921">pattern</span><span class="op" id="3866928">,</span>&nbsp;<span class="ident" id="3866930">path</span>&nbsp;<span class="builtintype" id="3866935">string</span><span class="op" id="3866941">)</span>&nbsp;<span class="builtintype" id="3866943">bool</span>&nbsp;<span class="op" id="3866948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866951">if</span>&nbsp;<span class="builtinfunc" id="3866954">len</span><span class="op" id="3866957">(</span><span class="ident" id="3866958"><a href="/net/http/server.go.html#3866921">pattern</a></span><span class="op" id="3866965">)</span>&nbsp;<span class="op" id="3866967">==</span>&nbsp;<span class="num" id="3866970">0</span>&nbsp;<span class="op" id="3866972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3866976">//&nbsp;should&nbsp;not&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866999">return</span>&nbsp;<span class="ident" id="3867006">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867013">}</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867016">n</span>&nbsp;<span class="op" id="3867018">:=</span>&nbsp;<span class="builtinfunc" id="3867021">len</span><span class="op" id="3867024">(</span><span class="ident" id="3867025"><a href="/net/http/server.go.html#3866921">pattern</a></span><span class="op" id="3867032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867035">if</span>&nbsp;<span class="ident" id="3867038"><a href="/net/http/server.go.html#3866921">pattern</a></span><span class="op" id="3867045">[</span><span class="ident" id="3867046"><a href="/net/http/server.go.html#3867016">n</a></span><span class="op" id="3867047">-</span><span class="num" id="3867048">1</span><span class="op" id="3867049">]</span>&nbsp;<span class="op" id="3867051">!=</span>&nbsp;<span class="string" id="3867054">&#39;/&#39;</span>&nbsp;<span class="op" id="3867058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867062">return</span>&nbsp;<span class="ident" id="3867069"><a href="/net/http/server.go.html#3866921">pattern</a></span>&nbsp;<span class="op" id="3867077">==</span>&nbsp;<span class="ident" id="3867080"><a href="/net/http/server.go.html#3866930">path</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867089">return</span>&nbsp;<span class="builtinfunc" id="3867096">len</span><span class="op" id="3867099">(</span><span class="ident" id="3867100"><a href="/net/http/server.go.html#3866930">path</a></span><span class="op" id="3867104">)</span>&nbsp;<span class="op" id="3867106">&gt;=</span>&nbsp;<span class="ident" id="3867109"><a href="/net/http/server.go.html#3867016">n</a></span>&nbsp;<span class="op" id="3867111">&amp;&amp;</span>&nbsp;<span class="ident" id="3867114"><a href="/net/http/server.go.html#3866930">path</a></span><span class="op" id="3867118">[</span><span class="num" id="3867119">0</span><span class="op" id="3867120">:</span><span class="ident" id="3867121"><a href="/net/http/server.go.html#3867016">n</a></span><span class="op" id="3867122">]</span>&nbsp;<span class="op" id="3867124">==</span>&nbsp;<span class="ident" id="3867127"><a href="/net/http/server.go.html#3866921">pattern</a></span><br>
<span class="lineno">1450</span><span class="op" id="3867135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3867138">//&nbsp;Return&nbsp;the&nbsp;canonical&nbsp;path&nbsp;for&nbsp;p,&nbsp;eliminating&nbsp;.&nbsp;and&nbsp;..&nbsp;elements.</span><br>
<span class="lineno"></span><span class="keyword" id="3867205">func</span>&nbsp;<span class="ident" id="3867210">cleanPath</span><span class="op" id="3867219">(</span><span class="ident" id="3867220">p</span>&nbsp;<span class="builtintype" id="3867222">string</span><span class="op" id="3867228">)</span>&nbsp;<span class="builtintype" id="3867230">string</span>&nbsp;<span class="op" id="3867237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867240">if</span>&nbsp;<span class="ident" id="3867243"><a href="/net/http/server.go.html#3867220">p</a></span>&nbsp;<span class="op" id="3867245">==</span>&nbsp;<span class="string" id="3867248">&#34;&#34;</span>&nbsp;<span class="op" id="3867251">{</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867255">return</span>&nbsp;<span class="string" id="3867262">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867270">if</span>&nbsp;<span class="ident" id="3867273"><a href="/net/http/server.go.html#3867220">p</a></span><span class="op" id="3867274">[</span><span class="num" id="3867275">0</span><span class="op" id="3867276">]</span>&nbsp;<span class="op" id="3867278">!=</span>&nbsp;<span class="string" id="3867281">&#39;/&#39;</span>&nbsp;<span class="op" id="3867285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867289"><a href="/net/http/server.go.html#3867220">p</a></span>&nbsp;<span class="op" id="3867291">=</span>&nbsp;<span class="string" id="3867293">&#34;/&#34;</span>&nbsp;<span class="op" id="3867297">+</span>&nbsp;<span class="ident" id="3867299"><a href="/net/http/server.go.html#3867220">p</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867302">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867305">np</span>&nbsp;<span class="op" id="3867308">:=</span>&nbsp;<span class="ident" id="3867311"><a href="/net/http/server.go.html#3824834">path</a></span><span class="op" id="3867315">.</span><span class="ident" id="3867316">Clean</span><span class="op" id="3867321">(</span><span class="ident" id="3867322"><a href="/net/http/server.go.html#3867220">p</a></span><span class="op" id="3867323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3867326">//&nbsp;path.Clean&nbsp;removes&nbsp;trailing&nbsp;slash&nbsp;except&nbsp;for&nbsp;root;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3867381">//&nbsp;put&nbsp;the&nbsp;trailing&nbsp;slash&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867427">if</span>&nbsp;<span class="ident" id="3867430"><a href="/net/http/server.go.html#3867220">p</a></span><span class="op" id="3867431">[</span><span class="builtinfunc" id="3867432">len</span><span class="op" id="3867435">(</span><span class="ident" id="3867436"><a href="/net/http/server.go.html#3867220">p</a></span><span class="op" id="3867437">)</span><span class="op" id="3867438">-</span><span class="num" id="3867439">1</span><span class="op" id="3867440">]</span>&nbsp;<span class="op" id="3867442">==</span>&nbsp;<span class="string" id="3867445">&#39;/&#39;</span>&nbsp;<span class="op" id="3867449">&amp;&amp;</span>&nbsp;<span class="ident" id="3867452"><a href="/net/http/server.go.html#3867305">np</a></span>&nbsp;<span class="op" id="3867455">!=</span>&nbsp;<span class="string" id="3867458">&#34;/&#34;</span>&nbsp;<span class="op" id="3867462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867466"><a href="/net/http/server.go.html#3867305">np</a></span>&nbsp;<span class="op" id="3867469">+=</span>&nbsp;<span class="string" id="3867472">&#34;/&#34;</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867480">return</span>&nbsp;<span class="ident" id="3867487"><a href="/net/http/server.go.html#3867305">np</a></span><br>
<span class="lineno"></span><span class="op" id="3867490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3867493">//&nbsp;Find&nbsp;a&nbsp;handler&nbsp;on&nbsp;a&nbsp;handler&nbsp;map&nbsp;given&nbsp;a&nbsp;path&nbsp;string</span><br>
<span class="lineno">1470</span><span class="comment" id="3867548">//&nbsp;Most-specific&nbsp;(longest)&nbsp;pattern&nbsp;wins</span><br>
<span class="lineno"></span><span class="keyword" id="3867588">func</span>&nbsp;<span class="op" id="3867593">(</span><span class="ident" id="3867594">mux</span>&nbsp;<span class="op" id="3867598">*</span><span class="ident" id="3867599"><a href="/net/http/server.go.html#3866451">ServeMux</a></span><span class="op" id="3867607">)</span>&nbsp;<span class="ident" id="3867609">match</span><span class="op" id="3867614">(</span><span class="ident" id="3867615">path</span>&nbsp;<span class="builtintype" id="3867620">string</span><span class="op" id="3867626">)</span>&nbsp;<span class="op" id="3867628">(</span><span class="ident" id="3867629">h</span>&nbsp;<span class="ident" id="3867631"><a href="/net/http/server.go.html#3825877">Handler</a></span><span class="op" id="3867638">,</span>&nbsp;<span class="ident" id="3867640">pattern</span>&nbsp;<span class="builtintype" id="3867648">string</span><span class="op" id="3867654">)</span>&nbsp;<span class="op" id="3867656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867659">var</span>&nbsp;<span class="ident" id="3867663">n</span>&nbsp;<span class="op" id="3867665">=</span>&nbsp;<span class="num" id="3867667">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867670">for</span>&nbsp;<span class="ident" id="3867674">k</span><span class="op" id="3867675">,</span>&nbsp;<span class="ident" id="3867677">v</span>&nbsp;<span class="op" id="3867679">:=</span>&nbsp;<span class="keyword" id="3867682">range</span>&nbsp;<span class="ident" id="3867688"><a href="/net/http/server.go.html#3867594">mux</a></span><span class="op" id="3867691">.</span><span class="ident" id="3867692">m</span>&nbsp;<span class="op" id="3867694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867698">if</span>&nbsp;<span class="op" id="3867701">!</span><span class="ident" id="3867702"><a href="/net/http/server.go.html#3866911">pathMatch</a></span><span class="op" id="3867711">(</span><span class="ident" id="3867712"><a href="/net/http/server.go.html#3867674">k</a></span><span class="op" id="3867713">,</span>&nbsp;<span class="ident" id="3867715"><a href="/net/http/server.go.html#3867615">path</a></span><span class="op" id="3867719">)</span>&nbsp;<span class="op" id="3867721">{</span><br>
<span class="lineno">1475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867726">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867741">if</span>&nbsp;<span class="ident" id="3867744"><a href="/net/http/server.go.html#3867629">h</a></span>&nbsp;<span class="op" id="3867746">==</span>&nbsp;<span class="ident" id="3867749">nil</span>&nbsp;<span class="op" id="3867753">||</span>&nbsp;<span class="builtinfunc" id="3867756">len</span><span class="op" id="3867759">(</span><span class="ident" id="3867760"><a href="/net/http/server.go.html#3867674">k</a></span><span class="op" id="3867761">)</span>&nbsp;<span class="op" id="3867763">&gt;</span>&nbsp;<span class="ident" id="3867765"><a href="/net/http/server.go.html#3867663">n</a></span>&nbsp;<span class="op" id="3867767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867772"><a href="/net/http/server.go.html#3867663">n</a></span>&nbsp;<span class="op" id="3867774">=</span>&nbsp;<span class="builtinfunc" id="3867776">len</span><span class="op" id="3867779">(</span><span class="ident" id="3867780"><a href="/net/http/server.go.html#3867674">k</a></span><span class="op" id="3867781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867786"><a href="/net/http/server.go.html#3867629">h</a></span>&nbsp;<span class="op" id="3867788">=</span>&nbsp;<span class="ident" id="3867790"><a href="/net/http/server.go.html#3867677">v</a></span><span class="op" id="3867791">.</span><span class="ident" id="3867792">h</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867797"><a href="/net/http/server.go.html#3867640">pattern</a></span>&nbsp;<span class="op" id="3867805">=</span>&nbsp;<span class="ident" id="3867807"><a href="/net/http/server.go.html#3867677">v</a></span><span class="op" id="3867808">.</span><span class="ident" id="3867809">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867825">return</span><br>
<span class="lineno"></span><span class="op" id="3867832">}</span><br>
<span class="lineno">1485</span><br>
<span class="lineno"></span><span class="comment" id="3867835">//&nbsp;Handler&nbsp;returns&nbsp;the&nbsp;handler&nbsp;to&nbsp;use&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3867896">//&nbsp;consulting&nbsp;r.Method,&nbsp;r.Host,&nbsp;and&nbsp;r.URL.Path.&nbsp;It&nbsp;always&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="3867962">//&nbsp;a&nbsp;non-nil&nbsp;handler.&nbsp;If&nbsp;the&nbsp;path&nbsp;is&nbsp;not&nbsp;in&nbsp;its&nbsp;canonical&nbsp;form,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3868030">//&nbsp;handler&nbsp;will&nbsp;be&nbsp;an&nbsp;internally-generated&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno">1490</span><span class="comment" id="3868096">//&nbsp;to&nbsp;the&nbsp;canonical&nbsp;path.</span><br>
<span class="lineno"></span><span class="comment" id="3868122">//</span><br>
<span class="lineno"></span><span class="comment" id="3868125">//&nbsp;Handler&nbsp;also&nbsp;returns&nbsp;the&nbsp;registered&nbsp;pattern&nbsp;that&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3868189">//&nbsp;request&nbsp;or,&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;internally-generated&nbsp;redirects,</span><br>
<span class="lineno"></span><span class="comment" id="3868251">//&nbsp;the&nbsp;pattern&nbsp;that&nbsp;will&nbsp;match&nbsp;after&nbsp;following&nbsp;the&nbsp;redirect.</span><br>
<span class="lineno">1495</span><span class="comment" id="3868312">//</span><br>
<span class="lineno"></span><span class="comment" id="3868315">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;registered&nbsp;handler&nbsp;that&nbsp;applies&nbsp;to&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3868381">//&nbsp;Handler&nbsp;returns&nbsp;a&nbsp;``page&nbsp;not&nbsp;found&#39;&#39;&nbsp;handler&nbsp;and&nbsp;an&nbsp;empty&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="3868451">func</span>&nbsp;<span class="op" id="3868456">(</span><span class="ident" id="3868457">mux</span>&nbsp;<span class="op" id="3868461">*</span><span class="ident" id="3868462"><a href="/net/http/server.go.html#3866451">ServeMux</a></span><span class="op" id="3868470">)</span>&nbsp;<span class="ident" id="3868472">Handler</span><span class="op" id="3868479">(</span><span class="ident" id="3868480">r</span>&nbsp;<span class="op" id="3868482">*</span><span class="ident" id="3868483"><a href="/net/http/request.go.html#3791418">Request</a></span><span class="op" id="3868490">)</span>&nbsp;<span class="op" id="3868492">(</span><span class="ident" id="3868493">h</span>&nbsp;<span class="ident" id="3868495"><a href="/net/http/server.go.html#3825877">Handler</a></span><span class="op" id="3868502">,</span>&nbsp;<span class="ident" id="3868504">pattern</span>&nbsp;<span class="builtintype" id="3868512">string</span><span class="op" id="3868518">)</span>&nbsp;<span class="op" id="3868520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868523">if</span>&nbsp;<span class="ident" id="3868526"><a href="/net/http/server.go.html#3868480">r</a></span><span class="op" id="3868527">.</span><span class="ident" id="3868528">Method</span>&nbsp;<span class="op" id="3868535">!=</span>&nbsp;<span class="string" id="3868538">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="3868548">{</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868552">if</span>&nbsp;<span class="ident" id="3868555">p</span>&nbsp;<span class="op" id="3868557">:=</span>&nbsp;<span class="ident" id="3868560"><a href="/net/http/server.go.html#3867210">cleanPath</a></span><span class="op" id="3868569">(</span><span class="ident" id="3868570"><a href="/net/http/server.go.html#3868480">r</a></span><span class="op" id="3868571">.</span><span class="ident" id="3868572">URL</span><span class="op" id="3868575">.</span><span class="ident" id="3868576">Path</span><span class="op" id="3868580">)</span><span class="op" id="3868581">;</span>&nbsp;<span class="ident" id="3868583"><a href="/net/http/server.go.html#3868555">p</a></span>&nbsp;<span class="op" id="3868585">!=</span>&nbsp;<span class="ident" id="3868588"><a href="/net/http/server.go.html#3868480">r</a></span><span class="op" id="3868589">.</span><span class="ident" id="3868590">URL</span><span class="op" id="3868593">.</span><span class="ident" id="3868594">Path</span>&nbsp;<span class="op" id="3868599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868604">_</span><span class="op" id="3868605">,</span>&nbsp;<span class="ident" id="3868607"><a href="/net/http/server.go.html#3868504">pattern</a></span>&nbsp;<span class="op" id="3868615">=</span>&nbsp;<span class="ident" id="3868617"><a href="/net/http/server.go.html#3868457">mux</a></span><span class="op" id="3868620">.</span><span class="ident" id="3868621">handler</span><span class="op" id="3868628">(</span><span class="ident" id="3868629"><a href="/net/http/server.go.html#3868480">r</a></span><span class="op" id="3868630">.</span><span class="ident" id="3868631">Host</span><span class="op" id="3868635">,</span>&nbsp;<span class="ident" id="3868637"><a href="/net/http/server.go.html#3868555">p</a></span><span class="op" id="3868638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868643">url</span>&nbsp;<span class="op" id="3868647">:=</span>&nbsp;<span class="op" id="3868650">*</span><span class="ident" id="3868651"><a href="/net/http/server.go.html#3868480">r</a></span><span class="op" id="3868652">.</span><span class="ident" id="3868653">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868660"><a href="/net/http/server.go.html#3868643">url</a></span><span class="op" id="3868663">.</span><span class="ident" id="3868664">Path</span>&nbsp;<span class="op" id="3868669">=</span>&nbsp;<span class="ident" id="3868671"><a href="/net/http/server.go.html#3868555">p</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868676">return</span>&nbsp;<span class="ident" id="3868683"><a href="/net/http/server.go.html#3865016">RedirectHandler</a></span><span class="op" id="3868698">(</span><span class="ident" id="3868699"><a href="/net/http/server.go.html#3868643">url</a></span><span class="op" id="3868702">.</span><span class="ident" id="3868703">String</span><span class="op" id="3868709">(</span><span class="op" id="3868710">)</span><span class="op" id="3868711">,</span>&nbsp;<span class="ident" id="3868713"><a href="/net/http/status.go.html#3891944">StatusMovedPermanently</a></span><span class="op" id="3868735">)</span><span class="op" id="3868736">,</span>&nbsp;<span class="ident" id="3868738"><a href="/net/http/server.go.html#3868504">pattern</a></span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3868748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3868751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868755">return</span>&nbsp;<span class="ident" id="3868762"><a href="/net/http/server.go.html#3868457">mux</a></span><span class="op" id="3868765">.</span><span class="ident" id="3868766">handler</span><span class="op" id="3868773">(</span><span class="ident" id="3868774"><a href="/net/http/server.go.html#3868480">r</a></span><span class="op" id="3868775">.</span><span class="ident" id="3868776">Host</span><span class="op" id="3868780">,</span>&nbsp;<span class="ident" id="3868782"><a href="/net/http/server.go.html#3868480">r</a></span><span class="op" id="3868783">.</span><span class="ident" id="3868784">URL</span><span class="op" id="3868787">.</span><span class="ident" id="3868788">Path</span><span class="op" id="3868792">)</span><br>
<span class="lineno"></span><span class="op" id="3868794">}</span><br>
<span class="lineno">1510</span><br>
<span class="lineno"></span><span class="comment" id="3868797">//&nbsp;handler&nbsp;is&nbsp;the&nbsp;main&nbsp;implementation&nbsp;of&nbsp;Handler.</span><br>
<span class="lineno"></span><span class="comment" id="3868847">//&nbsp;The&nbsp;path&nbsp;is&nbsp;known&nbsp;to&nbsp;be&nbsp;in&nbsp;canonical&nbsp;form,&nbsp;except&nbsp;for&nbsp;CONNECT&nbsp;methods.</span><br>
<span class="lineno"></span><span class="keyword" id="3868921">func</span>&nbsp;<span class="op" id="3868926">(</span><span class="ident" id="3868927">mux</span>&nbsp;<span class="op" id="3868931">*</span><span class="ident" id="3868932"><a href="/net/http/server.go.html#3866451">ServeMux</a></span><span class="op" id="3868940">)</span>&nbsp;<span class="ident" id="3868942">handler</span><span class="op" id="3868949">(</span><span class="ident" id="3868950">host</span><span class="op" id="3868954">,</span>&nbsp;<span class="ident" id="3868956">path</span>&nbsp;<span class="builtintype" id="3868961">string</span><span class="op" id="3868967">)</span>&nbsp;<span class="op" id="3868969">(</span><span class="ident" id="3868970">h</span>&nbsp;<span class="ident" id="3868972"><a href="/net/http/server.go.html#3825877">Handler</a></span><span class="op" id="3868979">,</span>&nbsp;<span class="ident" id="3868981">pattern</span>&nbsp;<span class="builtintype" id="3868989">string</span><span class="op" id="3868995">)</span>&nbsp;<span class="op" id="3868997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869000"><a href="/net/http/server.go.html#3868927">mux</a></span><span class="op" id="3869003">.</span><span class="ident" id="3869004">mu</span><span class="op" id="3869006">.</span><span class="ident" id="3869007">RLock</span><span class="op" id="3869012">(</span><span class="op" id="3869013">)</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869016">defer</span>&nbsp;<span class="ident" id="3869022"><a href="/net/http/server.go.html#3868927">mux</a></span><span class="op" id="3869025">.</span><span class="ident" id="3869026">mu</span><span class="op" id="3869028">.</span><span class="ident" id="3869029">RUnlock</span><span class="op" id="3869036">(</span><span class="op" id="3869037">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3869041">//&nbsp;Host-specific&nbsp;pattern&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;generic&nbsp;ones</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869102">if</span>&nbsp;<span class="ident" id="3869105"><a href="/net/http/server.go.html#3868927">mux</a></span><span class="op" id="3869108">.</span><span class="ident" id="3869109">hosts</span>&nbsp;<span class="op" id="3869115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869119"><a href="/net/http/server.go.html#3868970">h</a></span><span class="op" id="3869120">,</span>&nbsp;<span class="ident" id="3869122"><a href="/net/http/server.go.html#3868981">pattern</a></span>&nbsp;<span class="op" id="3869130">=</span>&nbsp;<span class="ident" id="3869132"><a href="/net/http/server.go.html#3868927">mux</a></span><span class="op" id="3869135">.</span><span class="ident" id="3869136">match</span><span class="op" id="3869141">(</span><span class="ident" id="3869142"><a href="/net/http/server.go.html#3868950">host</a></span>&nbsp;<span class="op" id="3869147">+</span>&nbsp;<span class="ident" id="3869149"><a href="/net/http/server.go.html#3868956">path</a></span><span class="op" id="3869153">)</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3869156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869159">if</span>&nbsp;<span class="ident" id="3869162"><a href="/net/http/server.go.html#3868970">h</a></span>&nbsp;<span class="op" id="3869164">==</span>&nbsp;<span class="ident" id="3869167">nil</span>&nbsp;<span class="op" id="3869171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869175"><a href="/net/http/server.go.html#3868970">h</a></span><span class="op" id="3869176">,</span>&nbsp;<span class="ident" id="3869178"><a href="/net/http/server.go.html#3868981">pattern</a></span>&nbsp;<span class="op" id="3869186">=</span>&nbsp;<span class="ident" id="3869188"><a href="/net/http/server.go.html#3868927">mux</a></span><span class="op" id="3869191">.</span><span class="ident" id="3869192">match</span><span class="op" id="3869197">(</span><span class="ident" id="3869198"><a href="/net/http/server.go.html#3868956">path</a></span><span class="op" id="3869202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3869205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869208">if</span>&nbsp;<span class="ident" id="3869211"><a href="/net/http/server.go.html#3868970">h</a></span>&nbsp;<span class="op" id="3869213">==</span>&nbsp;<span class="ident" id="3869216">nil</span>&nbsp;<span class="op" id="3869220">{</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869224"><a href="/net/http/server.go.html#3868970">h</a></span><span class="op" id="3869225">,</span>&nbsp;<span class="ident" id="3869227"><a href="/net/http/server.go.html#3868981">pattern</a></span>&nbsp;<span class="op" id="3869235">=</span>&nbsp;<span class="ident" id="3869237"><a href="/net/http/server.go.html#3861832">NotFoundHandler</a></span><span class="op" id="3869252">(</span><span class="op" id="3869253">)</span><span class="op" id="3869254">,</span>&nbsp;<span class="string" id="3869256">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3869260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869263">return</span><br>
<span class="lineno"></span><span class="op" id="3869270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1530</span><span class="comment" id="3869273">//&nbsp;ServeHTTP&nbsp;dispatches&nbsp;the&nbsp;request&nbsp;to&nbsp;the&nbsp;handler&nbsp;whose</span><br>
<span class="lineno"></span><span class="comment" id="3869330">//&nbsp;pattern&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;request&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3869379">func</span>&nbsp;<span class="op" id="3869384">(</span><span class="ident" id="3869385">mux</span>&nbsp;<span class="op" id="3869389">*</span><span class="ident" id="3869390"><a href="/net/http/server.go.html#3866451">ServeMux</a></span><span class="op" id="3869398">)</span>&nbsp;<span class="ident" id="3869400">ServeHTTP</span><span class="op" id="3869409">(</span><span class="ident" id="3869410">w</span>&nbsp;<span class="ident" id="3869412"><a href="/net/http/server.go.html#3826033">ResponseWriter</a></span><span class="op" id="3869426">,</span>&nbsp;<span class="ident" id="3869428">r</span>&nbsp;<span class="op" id="3869430">*</span><span class="ident" id="3869431"><a href="/net/http/request.go.html#3791418">Request</a></span><span class="op" id="3869438">)</span>&nbsp;<span class="op" id="3869440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869443">if</span>&nbsp;<span class="ident" id="3869446"><a href="/net/http/server.go.html#3869428">r</a></span><span class="op" id="3869447">.</span><span class="ident" id="3869448">RequestURI</span>&nbsp;<span class="op" id="3869459">==</span>&nbsp;<span class="string" id="3869462">&#34;*&#34;</span>&nbsp;<span class="op" id="3869466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869470">if</span>&nbsp;<span class="ident" id="3869473"><a href="/net/http/server.go.html#3869428">r</a></span><span class="op" id="3869474">.</span><span class="ident" id="3869475">ProtoAtLeast</span><span class="op" id="3869487">(</span><span class="num" id="3869488">1</span><span class="op" id="3869489">,</span>&nbsp;<span class="num" id="3869491">1</span><span class="op" id="3869492">)</span>&nbsp;<span class="op" id="3869494">{</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869499"><a href="/net/http/server.go.html#3869410">w</a></span><span class="op" id="3869500">.</span><span class="ident" id="3869501">Header</span><span class="op" id="3869507">(</span><span class="op" id="3869508">)</span><span class="op" id="3869509">.</span><span class="ident" id="3869510">Set</span><span class="op" id="3869513">(</span><span class="string" id="3869514">&#34;Connection&#34;</span><span class="op" id="3869526">,</span>&nbsp;<span class="string" id="3869528">&#34;close&#34;</span><span class="op" id="3869535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3869539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869543"><a href="/net/http/server.go.html#3869410">w</a></span><span class="op" id="3869544">.</span><span class="ident" id="3869545">WriteHeader</span><span class="op" id="3869556">(</span><span class="ident" id="3869557"><a href="/net/http/status.go.html#3892131">StatusBadRequest</a></span><span class="op" id="3869573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869577">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3869585">}</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869588">h</span><span class="op" id="3869589">,</span>&nbsp;<span class="ident" id="3869591">_</span>&nbsp;<span class="op" id="3869593">:=</span>&nbsp;<span class="ident" id="3869596"><a href="/net/http/server.go.html#3869385">mux</a></span><span class="op" id="3869599">.</span><span class="ident" id="3869600">Handler</span><span class="op" id="3869607">(</span><span class="ident" id="3869608"><a href="/net/http/server.go.html#3869428">r</a></span><span class="op" id="3869609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869612"><a href="/net/http/server.go.html#3869588">h</a></span><span class="op" id="3869613">.</span><span class="ident" id="3869614">ServeHTTP</span><span class="op" id="3869623">(</span><span class="ident" id="3869624"><a href="/net/http/server.go.html#3869410">w</a></span><span class="op" id="3869625">,</span>&nbsp;<span class="ident" id="3869627"><a href="/net/http/server.go.html#3869428">r</a></span><span class="op" id="3869628">)</span><br>
<span class="lineno"></span><span class="op" id="3869630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3869633">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno">1545</span><span class="comment" id="3869688">//&nbsp;If&nbsp;a&nbsp;handler&nbsp;already&nbsp;exists&nbsp;for&nbsp;pattern,&nbsp;Handle&nbsp;panics.</span><br>
<span class="lineno"></span><span class="keyword" id="3869747">func</span>&nbsp;<span class="op" id="3869752">(</span><span class="ident" id="3869753">mux</span>&nbsp;<span class="op" id="3869757">*</span><span class="ident" id="3869758"><a href="/net/http/server.go.html#3866451">ServeMux</a></span><span class="op" id="3869766">)</span>&nbsp;<span class="ident" id="3869768">Handle</span><span class="op" id="3869774">(</span><span class="ident" id="3869775">pattern</span>&nbsp;<span class="builtintype" id="3869783">string</span><span class="op" id="3869789">,</span>&nbsp;<span class="ident" id="3869791">handler</span>&nbsp;<span class="ident" id="3869799"><a href="/net/http/server.go.html#3825877">Handler</a></span><span class="op" id="3869806">)</span>&nbsp;<span class="op" id="3869808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869811"><a href="/net/http/server.go.html#3869753">mux</a></span><span class="op" id="3869814">.</span><span class="ident" id="3869815">mu</span><span class="op" id="3869817">.</span><span class="ident" id="3869818">Lock</span><span class="op" id="3869822">(</span><span class="op" id="3869823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869826">defer</span>&nbsp;<span class="ident" id="3869832"><a href="/net/http/server.go.html#3869753">mux</a></span><span class="op" id="3869835">.</span><span class="ident" id="3869836">mu</span><span class="op" id="3869838">.</span><span class="ident" id="3869839">Unlock</span><span class="op" id="3869845">(</span><span class="op" id="3869846">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869850">if</span>&nbsp;<span class="ident" id="3869853"><a href="/net/http/server.go.html#3869775">pattern</a></span>&nbsp;<span class="op" id="3869861">==</span>&nbsp;<span class="string" id="3869864">&#34;&#34;</span>&nbsp;<span class="op" id="3869867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3869871">panic</span><span class="op" id="3869876">(</span><span class="string" id="3869877">&#34;http:&nbsp;invalid&nbsp;pattern&nbsp;&#34;</span>&nbsp;<span class="op" id="3869902">+</span>&nbsp;<span class="ident" id="3869904"><a href="/net/http/server.go.html#3869775">pattern</a></span><span class="op" id="3869911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3869914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869917">if</span>&nbsp;<span class="ident" id="3869920"><a href="/net/http/server.go.html#3869791">handler</a></span>&nbsp;<span class="op" id="3869928">==</span>&nbsp;<span class="ident" id="3869931">nil</span>&nbsp;<span class="op" id="3869935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3869939">panic</span><span class="op" id="3869944">(</span><span class="string" id="3869945">&#34;http:&nbsp;nil&nbsp;handler&#34;</span><span class="op" id="3869964">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3869967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869970">if</span>&nbsp;<span class="ident" id="3869973"><a href="/net/http/server.go.html#3869753">mux</a></span><span class="op" id="3869976">.</span><span class="ident" id="3869977">m</span><span class="op" id="3869978">[</span><span class="ident" id="3869979"><a href="/net/http/server.go.html#3869775">pattern</a></span><span class="op" id="3869986">]</span><span class="op" id="3869987">.</span><span class="ident" id="3869988">explicit</span>&nbsp;<span class="op" id="3869997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3870001">panic</span><span class="op" id="3870006">(</span><span class="string" id="3870007">&#34;http:&nbsp;multiple&nbsp;registrations&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="3870043">+</span>&nbsp;<span class="ident" id="3870045"><a href="/net/http/server.go.html#3869775">pattern</a></span><span class="op" id="3870052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3870055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870059"><a href="/net/http/server.go.html#3869753">mux</a></span><span class="op" id="3870062">.</span><span class="ident" id="3870063">m</span><span class="op" id="3870064">[</span><span class="ident" id="3870065"><a href="/net/http/server.go.html#3869775">pattern</a></span><span class="op" id="3870072">]</span>&nbsp;<span class="op" id="3870074">=</span>&nbsp;<span class="ident" id="3870076"><a href="/net/http/server.go.html#3866578">muxEntry</a></span><span class="op" id="3870084">{</span><span class="ident" id="3870085">explicit</span><span class="op" id="3870093">:</span>&nbsp;<span class="ident" id="3870095">true</span><span class="op" id="3870099">,</span>&nbsp;<span class="ident" id="3870101">h</span><span class="op" id="3870102">:</span>&nbsp;<span class="ident" id="3870104"><a href="/net/http/server.go.html#3869791">handler</a></span><span class="op" id="3870111">,</span>&nbsp;<span class="ident" id="3870113">pattern</span><span class="op" id="3870120">:</span>&nbsp;<span class="ident" id="3870122"><a href="/net/http/server.go.html#3869775">pattern</a></span><span class="op" id="3870129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870133">if</span>&nbsp;<span class="ident" id="3870136"><a href="/net/http/server.go.html#3869775">pattern</a></span><span class="op" id="3870143">[</span><span class="num" id="3870144">0</span><span class="op" id="3870145">]</span>&nbsp;<span class="op" id="3870147">!=</span>&nbsp;<span class="string" id="3870150">&#39;/&#39;</span>&nbsp;<span class="op" id="3870154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870158"><a href="/net/http/server.go.html#3869753">mux</a></span><span class="op" id="3870161">.</span><span class="ident" id="3870162">hosts</span>&nbsp;<span class="op" id="3870168">=</span>&nbsp;<span class="ident" id="3870170">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3870176">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3870180">//&nbsp;Helpful&nbsp;behavior:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3870202">//&nbsp;If&nbsp;pattern&nbsp;is&nbsp;/tree/,&nbsp;insert&nbsp;an&nbsp;implicit&nbsp;permanent&nbsp;redirect&nbsp;for&nbsp;/tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3870277">//&nbsp;It&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;an&nbsp;explicit&nbsp;registration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870331">n</span>&nbsp;<span class="op" id="3870333">:=</span>&nbsp;<span class="builtinfunc" id="3870336">len</span><span class="op" id="3870339">(</span><span class="ident" id="3870340"><a href="/net/http/server.go.html#3869775">pattern</a></span><span class="op" id="3870347">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870350">if</span>&nbsp;<span class="ident" id="3870353"><a href="/net/http/server.go.html#3870331">n</a></span>&nbsp;<span class="op" id="3870355">&gt;</span>&nbsp;<span class="num" id="3870357">0</span>&nbsp;<span class="op" id="3870359">&amp;&amp;</span>&nbsp;<span class="ident" id="3870362"><a href="/net/http/server.go.html#3869775">pattern</a></span><span class="op" id="3870369">[</span><span class="ident" id="3870370"><a href="/net/http/server.go.html#3870331">n</a></span><span class="op" id="3870371">-</span><span class="num" id="3870372">1</span><span class="op" id="3870373">]</span>&nbsp;<span class="op" id="3870375">==</span>&nbsp;<span class="string" id="3870378">&#39;/&#39;</span>&nbsp;<span class="op" id="3870382">&amp;&amp;</span>&nbsp;<span class="op" id="3870385">!</span><span class="ident" id="3870386"><a href="/net/http/server.go.html#3869753">mux</a></span><span class="op" id="3870389">.</span><span class="ident" id="3870390">m</span><span class="op" id="3870391">[</span><span class="ident" id="3870392"><a href="/net/http/server.go.html#3869775">pattern</a></span><span class="op" id="3870399">[</span><span class="num" id="3870400">0</span><span class="op" id="3870401">:</span><span class="ident" id="3870402"><a href="/net/http/server.go.html#3870331">n</a></span><span class="op" id="3870403">-</span><span class="num" id="3870404">1</span><span class="op" id="3870405">]</span><span class="op" id="3870406">]</span><span class="op" id="3870407">.</span><span class="ident" id="3870408">explicit</span>&nbsp;<span class="op" id="3870417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3870421">//&nbsp;If&nbsp;pattern&nbsp;contains&nbsp;a&nbsp;host&nbsp;name,&nbsp;strip&nbsp;it&nbsp;and&nbsp;use&nbsp;remaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3870486">//&nbsp;path&nbsp;for&nbsp;redirect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870510">path</span>&nbsp;<span class="op" id="3870515">:=</span>&nbsp;<span class="ident" id="3870518"><a href="/net/http/server.go.html#3869775">pattern</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870528">if</span>&nbsp;<span class="ident" id="3870531"><a href="/net/http/server.go.html#3869775">pattern</a></span><span class="op" id="3870538">[</span><span class="num" id="3870539">0</span><span class="op" id="3870540">]</span>&nbsp;<span class="op" id="3870542">!=</span>&nbsp;<span class="string" id="3870545">&#39;/&#39;</span>&nbsp;<span class="op" id="3870549">{</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3870554">//&nbsp;In&nbsp;pattern,&nbsp;at&nbsp;least&nbsp;the&nbsp;last&nbsp;character&nbsp;is&nbsp;a&nbsp;&#39;/&#39;,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3870613">//&nbsp;strings.Index&nbsp;can&#39;t&nbsp;be&nbsp;-1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870646"><a href="/net/http/server.go.html#3870510">path</a></span>&nbsp;<span class="op" id="3870651">=</span>&nbsp;<span class="ident" id="3870653"><a href="/net/http/server.go.html#3869775">pattern</a></span><span class="op" id="3870660">[</span><span class="ident" id="3870661"><a href="/net/http/server.go.html#3824864">strings</a></span><span class="op" id="3870668">.</span><span class="ident" id="3870669">Index</span><span class="op" id="3870674">(</span><span class="ident" id="3870675"><a href="/net/http/server.go.html#3869775">pattern</a></span><span class="op" id="3870682">,</span>&nbsp;<span class="string" id="3870684">&#34;/&#34;</span><span class="op" id="3870687">)</span><span class="op" id="3870688">:</span><span class="op" id="3870689">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3870693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870697"><a href="/net/http/server.go.html#3869753">mux</a></span><span class="op" id="3870700">.</span><span class="ident" id="3870701">m</span><span class="op" id="3870702">[</span><span class="ident" id="3870703"><a href="/net/http/server.go.html#3869775">pattern</a></span><span class="op" id="3870710">[</span><span class="num" id="3870711">0</span><span class="op" id="3870712">:</span><span class="ident" id="3870713"><a href="/net/http/server.go.html#3870331">n</a></span><span class="op" id="3870714">-</span><span class="num" id="3870715">1</span><span class="op" id="3870716">]</span><span class="op" id="3870717">]</span>&nbsp;<span class="op" id="3870719">=</span>&nbsp;<span class="ident" id="3870721"><a href="/net/http/server.go.html#3866578">muxEntry</a></span><span class="op" id="3870729">{</span><span class="ident" id="3870730">h</span><span class="op" id="3870731">:</span>&nbsp;<span class="ident" id="3870733"><a href="/net/http/server.go.html#3865016">RedirectHandler</a></span><span class="op" id="3870748">(</span><span class="ident" id="3870749"><a href="/net/http/server.go.html#3870510">path</a></span><span class="op" id="3870753">,</span>&nbsp;<span class="ident" id="3870755"><a href="/net/http/status.go.html#3891944">StatusMovedPermanently</a></span><span class="op" id="3870777">)</span><span class="op" id="3870778">,</span>&nbsp;<span class="ident" id="3870780">pattern</span><span class="op" id="3870787">:</span>&nbsp;<span class="ident" id="3870789"><a href="/net/http/server.go.html#3869775">pattern</a></span><span class="op" id="3870796">}</span><br>
<span class="lineno">1580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3870799">}</span><br>
<span class="lineno"></span><span class="op" id="3870801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3870804">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="3870872">func</span>&nbsp;<span class="op" id="3870877">(</span><span class="ident" id="3870878">mux</span>&nbsp;<span class="op" id="3870882">*</span><span class="ident" id="3870883"><a href="/net/http/server.go.html#3866451">ServeMux</a></span><span class="op" id="3870891">)</span>&nbsp;<span class="ident" id="3870893">HandleFunc</span><span class="op" id="3870903">(</span><span class="ident" id="3870904">pattern</span>&nbsp;<span class="builtintype" id="3870912">string</span><span class="op" id="3870918">,</span>&nbsp;<span class="ident" id="3870920">handler</span>&nbsp;<span class="keyword" id="3870928">func</span><span class="op" id="3870932">(</span><span class="ident" id="3870933"><a href="/net/http/server.go.html#3826033">ResponseWriter</a></span><span class="op" id="3870947">,</span>&nbsp;<span class="op" id="3870949">*</span><span class="ident" id="3870950"><a href="/net/http/request.go.html#3791418">Request</a></span><span class="op" id="3870957">)</span><span class="op" id="3870958">)</span>&nbsp;<span class="op" id="3870960">{</span><br>
<span class="lineno">1585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870963"><a href="/net/http/server.go.html#3870878">mux</a></span><span class="op" id="3870966">.</span><span class="ident" id="3870967">Handle</span><span class="op" id="3870973">(</span><span class="ident" id="3870974"><a href="/net/http/server.go.html#3870904">pattern</a></span><span class="op" id="3870981">,</span>&nbsp;<span class="ident" id="3870983"><a href="/net/http/server.go.html#3861087">HandlerFunc</a></span><span class="op" id="3870994">(</span><span class="ident" id="3870995"><a href="/net/http/server.go.html#3870920">handler</a></span><span class="op" id="3871002">)</span><span class="op" id="3871003">)</span><br>
<span class="lineno"></span><span class="op" id="3871005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3871008">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="3871062">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1590</span><span class="comment" id="3871089">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="3871158">func</span>&nbsp;<span class="ident" id="3871163">Handle</span><span class="op" id="3871169">(</span><span class="ident" id="3871170">pattern</span>&nbsp;<span class="builtintype" id="3871178">string</span><span class="op" id="3871184">,</span>&nbsp;<span class="ident" id="3871186">handler</span>&nbsp;<span class="ident" id="3871194"><a href="/net/http/server.go.html#3825877">Handler</a></span><span class="op" id="3871201">)</span>&nbsp;<span class="op" id="3871203">{</span>&nbsp;<span class="ident" id="3871205"><a href="/net/http/server.go.html#3866845">DefaultServeMux</a></span><span class="op" id="3871220">.</span><span class="ident" id="3871221">Handle</span><span class="op" id="3871227">(</span><span class="ident" id="3871228"><a href="/net/http/server.go.html#3871170">pattern</a></span><span class="op" id="3871235">,</span>&nbsp;<span class="ident" id="3871237"><a href="/net/http/server.go.html#3871186">handler</a></span><span class="op" id="3871244">)</span>&nbsp;<span class="op" id="3871246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3871249">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="3871316">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1595</span><span class="comment" id="3871343">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="3871412">func</span>&nbsp;<span class="ident" id="3871417">HandleFunc</span><span class="op" id="3871427">(</span><span class="ident" id="3871428">pattern</span>&nbsp;<span class="builtintype" id="3871436">string</span><span class="op" id="3871442">,</span>&nbsp;<span class="ident" id="3871444">handler</span>&nbsp;<span class="keyword" id="3871452">func</span><span class="op" id="3871456">(</span><span class="ident" id="3871457"><a href="/net/http/server.go.html#3826033">ResponseWriter</a></span><span class="op" id="3871471">,</span>&nbsp;<span class="op" id="3871473">*</span><span class="ident" id="3871474"><a href="/net/http/request.go.html#3791418">Request</a></span><span class="op" id="3871481">)</span><span class="op" id="3871482">)</span>&nbsp;<span class="op" id="3871484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871487"><a href="/net/http/server.go.html#3866845">DefaultServeMux</a></span><span class="op" id="3871502">.</span><span class="ident" id="3871503">HandleFunc</span><span class="op" id="3871513">(</span><span class="ident" id="3871514"><a href="/net/http/server.go.html#3871428">pattern</a></span><span class="op" id="3871521">,</span>&nbsp;<span class="ident" id="3871523"><a href="/net/http/server.go.html#3871444">handler</a></span><span class="op" id="3871530">)</span><br>
<span class="lineno"></span><span class="op" id="3871532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="3871535">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;HTTP&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,</span><br>
<span class="lineno"></span><span class="comment" id="3871597">//&nbsp;creating&nbsp;a&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="3871667">//&nbsp;read&nbsp;requests&nbsp;and&nbsp;then&nbsp;call&nbsp;handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="3871724">//&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3871796">func</span>&nbsp;<span class="ident" id="3871801">Serve</span><span class="op" id="3871806">(</span><span class="ident" id="3871807">l</span>&nbsp;<span class="ident" id="3871809"><a href="/net/http/server.go.html#3824810">net</a></span><span class="op" id="3871812">.</span><span class="ident" id="3871813">Listener</span><span class="op" id="3871821">,</span>&nbsp;<span class="ident" id="3871823">handler</span>&nbsp;<span class="ident" id="3871831"><a href="/net/http/server.go.html#3825877">Handler</a></span><span class="op" id="3871838">)</span>&nbsp;<span class="builtintype" id="3871840">error</span>&nbsp;<span class="op" id="3871846">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871849">srv</span>&nbsp;<span class="op" id="3871853">:=</span>&nbsp;<span class="op" id="3871856">&amp;</span><span class="ident" id="3871857"><a href="/net/http/server.go.html#3872025">Server</a></span><span class="op" id="3871863">{</span><span class="ident" id="3871864">Handler</span><span class="op" id="3871871">:</span>&nbsp;<span class="ident" id="3871873"><a href="/net/http/server.go.html#3871823">handler</a></span><span class="op" id="3871880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3871883">return</span>&nbsp;<span class="ident" id="3871890"><a href="/net/http/server.go.html#3871849">srv</a></span><span class="op" id="3871893">.</span><span class="ident" id="3871894">Serve</span><span class="op" id="3871899">(</span><span class="ident" id="3871900"><a href="/net/http/server.go.html#3871807">l</a></span><span class="op" id="3871901">)</span><br>
<span class="lineno"></span><span class="op" id="3871903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3871906">//&nbsp;A&nbsp;Server&nbsp;defines&nbsp;parameters&nbsp;for&nbsp;running&nbsp;an&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">1610</span><span class="comment" id="3871965">//&nbsp;The&nbsp;zero&nbsp;value&nbsp;for&nbsp;Server&nbsp;is&nbsp;a&nbsp;valid&nbsp;configuration.</span><br>
<span class="lineno"></span><span class="keyword" id="3872020">type</span>&nbsp;<span class="ident" id="3872025">Server</span>&nbsp;<span class="keyword" id="3872032">struct</span>&nbsp;<span class="op" id="3872039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872042">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3872057">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3872071">//&nbsp;TCP&nbsp;address&nbsp;to&nbsp;listen&nbsp;on,&nbsp;&#34;:http&#34;&nbsp;if&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872118">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3872133"><a href="/net/http/server.go.html#3825877">Handler</a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3872147">//&nbsp;handler&nbsp;to&nbsp;invoke,&nbsp;http.DefaultServeMux&nbsp;if&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872198">ReadTimeout</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3872213"><a href="/net/http/server.go.html#3824898">time</a></span><span class="op" id="3872217">.</span><span class="ident" id="3872218">Duration</span>&nbsp;<span class="comment" id="3872227">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;read&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872286">WriteTimeout</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3872301"><a href="/net/http/server.go.html#3824898">time</a></span><span class="op" id="3872305">.</span><span class="ident" id="3872306">Duration</span>&nbsp;<span class="comment" id="3872315">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;write&nbsp;of&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872376">MaxHeaderBytes</span>&nbsp;<span class="builtintype" id="3872391">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3872405">//&nbsp;maximum&nbsp;size&nbsp;of&nbsp;request&nbsp;headers,&nbsp;DefaultMaxHeaderBytes&nbsp;if&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872469">TLSConfig</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3872484">*</span><span class="ident" id="3872485"><a href="/net/http/server.go.html#3824753">tls</a></span><span class="op" id="3872488">.</span><span class="ident" id="3872489">Config</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3872498">//&nbsp;optional&nbsp;TLS&nbsp;config,&nbsp;used&nbsp;by&nbsp;ListenAndServeTLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3872550">//&nbsp;TLSNextProto&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;take&nbsp;over</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3872612">//&nbsp;ownership&nbsp;of&nbsp;the&nbsp;provided&nbsp;TLS&nbsp;connection&nbsp;when&nbsp;an&nbsp;NPN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3872669">//&nbsp;protocol&nbsp;upgrade&nbsp;has&nbsp;occurred.&nbsp;&nbsp;The&nbsp;map&nbsp;key&nbsp;is&nbsp;the&nbsp;protocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3872733">//&nbsp;name&nbsp;negotiated.&nbsp;The&nbsp;Handler&nbsp;argument&nbsp;should&nbsp;be&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3872793">//&nbsp;handle&nbsp;HTTP&nbsp;requests&nbsp;and&nbsp;will&nbsp;initialize&nbsp;the&nbsp;Request&#39;s&nbsp;TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3872856">//&nbsp;and&nbsp;RemoteAddr&nbsp;if&nbsp;not&nbsp;already&nbsp;set.&nbsp;&nbsp;The&nbsp;connection&nbsp;is</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3872914">//&nbsp;automatically&nbsp;closed&nbsp;when&nbsp;the&nbsp;function&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872966">TLSNextProto</span>&nbsp;<span class="keyword" id="3872979">map</span><span class="op" id="3872982">[</span><span class="builtintype" id="3872983">string</span><span class="op" id="3872989">]</span><span class="keyword" id="3872990">func</span><span class="op" id="3872994">(</span><span class="op" id="3872995">*</span><span class="ident" id="3872996"><a href="/net/http/server.go.html#3872025">Server</a></span><span class="op" id="3873002">,</span>&nbsp;<span class="op" id="3873004">*</span><span class="ident" id="3873005"><a href="/net/http/server.go.html#3824753">tls</a></span><span class="op" id="3873008">.</span><span class="ident" id="3873009">Conn</span><span class="op" id="3873013">,</span>&nbsp;<span class="ident" id="3873015"><a href="/net/http/server.go.html#3825877">Handler</a></span><span class="op" id="3873022">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3873026">//&nbsp;ConnState&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;callback&nbsp;function&nbsp;that&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3873088">//&nbsp;called&nbsp;when&nbsp;a&nbsp;client&nbsp;connection&nbsp;changes&nbsp;state.&nbsp;See&nbsp;the</span><br>
<span class="lineno">1630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3873147">//&nbsp;ConnState&nbsp;type&nbsp;and&nbsp;associated&nbsp;constants&nbsp;for&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873204">ConnState</span>&nbsp;<span class="keyword" id="3873214">func</span><span class="op" id="3873218">(</span><span class="ident" id="3873219"><a href="/net/http/server.go.html#3824810">net</a></span><span class="op" id="3873222">.</span><span class="ident" id="3873223">Conn</span><span class="op" id="3873227">,</span>&nbsp;<span class="ident" id="3873229"><a href="/net/http/server.go.html#3873644">ConnState</a></span><span class="op" id="3873238">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3873242">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors&nbsp;accepting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3873305">//&nbsp;connections&nbsp;and&nbsp;unexpected&nbsp;behavior&nbsp;from&nbsp;handlers.</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3873360">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3873420">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873441">ErrorLog</span>&nbsp;<span class="op" id="3873450">*</span><span class="ident" id="3873451"><a href="/net/http/server.go.html#3824803">log</a></span><span class="op" id="3873454">.</span><span class="ident" id="3873455">Logger</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873464">disableKeepAlives</span>&nbsp;<span class="builtintype" id="3873482">int32</span>&nbsp;<span class="comment" id="3873488">//&nbsp;accessed&nbsp;atomically.</span><br>
<span class="lineno">1640</span><span class="op" id="3873512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3873515">//&nbsp;A&nbsp;ConnState&nbsp;represents&nbsp;the&nbsp;state&nbsp;of&nbsp;a&nbsp;client&nbsp;connection&nbsp;to&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="comment" id="3873587">//&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;the&nbsp;optional&nbsp;Server.ConnState&nbsp;hook.</span><br>
<span class="lineno"></span><span class="keyword" id="3873639">type</span>&nbsp;<span class="ident" id="3873644">ConnState</span>&nbsp;<span class="builtintype" id="3873654">int</span><br>
<span class="lineno">1645</span><br>
<span class="lineno"></span><span class="keyword" id="3873659">const</span>&nbsp;<span class="op" id="3873665">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3873668">//&nbsp;StateNew&nbsp;represents&nbsp;a&nbsp;new&nbsp;connection&nbsp;that&nbsp;is&nbsp;expected&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3873729">//&nbsp;send&nbsp;a&nbsp;request&nbsp;immediately.&nbsp;Connections&nbsp;begin&nbsp;at&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3873787">//&nbsp;state&nbsp;and&nbsp;then&nbsp;transition&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3873842">//&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873859">StateNew</span>&nbsp;<span class="ident" id="3873868"><a href="/net/http/server.go.html#3873644">ConnState</a></span>&nbsp;<span class="op" id="3873878">=</span>&nbsp;<span class="ident" id="3873880">iota</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3873887">//&nbsp;StateActive&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;read&nbsp;1&nbsp;or&nbsp;more</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3873951">//&nbsp;bytes&nbsp;of&nbsp;a&nbsp;request.&nbsp;The&nbsp;Server.ConnState&nbsp;hook&nbsp;for</span><br>
<span class="lineno">1655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3874005">//&nbsp;StateActive&nbsp;fires&nbsp;before&nbsp;the&nbsp;request&nbsp;has&nbsp;entered&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3874068">//&nbsp;and&nbsp;doesn&#39;t&nbsp;fire&nbsp;again&nbsp;until&nbsp;the&nbsp;request&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3874122">//&nbsp;handled.&nbsp;After&nbsp;the&nbsp;request&nbsp;is&nbsp;handled,&nbsp;the&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3874175">//&nbsp;transitions&nbsp;to&nbsp;StateClosed,&nbsp;StateHijacked,&nbsp;or&nbsp;StateIdle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874236">StateActive</span><br>
<span class="lineno">1660</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3874250">//&nbsp;StateIdle&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3874306">//&nbsp;handling&nbsp;a&nbsp;request&nbsp;and&nbsp;is&nbsp;in&nbsp;the&nbsp;keep-alive&nbsp;state,&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3874369">//&nbsp;for&nbsp;a&nbsp;new&nbsp;request.&nbsp;Connections&nbsp;transition&nbsp;from&nbsp;StateIdle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3874430">//&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or&nbsp;StateClosed.</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874472">StateIdle</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3874484">//&nbsp;StateHijacked&nbsp;represents&nbsp;a&nbsp;hijacked&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3874536">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874605">StateHijacked</span><br>
<span class="lineno">1670</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3874621">//&nbsp;StateClosed&nbsp;represents&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3874669">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;Hijacked&nbsp;connections&nbsp;do&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3874727">//&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874758">StateClosed</span><br>
<span class="lineno">1675</span><span class="op" id="3874770">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3874773">var</span>&nbsp;<span class="ident" id="3874777">stateName</span>&nbsp;<span class="op" id="3874787">=</span>&nbsp;<span class="keyword" id="3874789">map</span><span class="op" id="3874792">[</span><span class="ident" id="3874793"><a href="/net/http/server.go.html#3873644">ConnState</a></span><span class="op" id="3874802">]</span><span class="builtintype" id="3874803">string</span><span class="op" id="3874809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874812"><a href="/net/http/server.go.html#3873859">StateNew</a></span><span class="op" id="3874820">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3874827">&#34;new&#34;</span><span class="op" id="3874832">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874835"><a href="/net/http/server.go.html#3874236">StateActive</a></span><span class="op" id="3874846">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="3874850">&#34;active&#34;</span><span class="op" id="3874858">,</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874861"><a href="/net/http/server.go.html#3874472">StateIdle</a></span><span class="op" id="3874870">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3874876">&#34;idle&#34;</span><span class="op" id="3874882">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874885"><a href="/net/http/server.go.html#3874605">StateHijacked</a></span><span class="op" id="3874898">:</span>&nbsp;<span class="string" id="3874900">&#34;hijacked&#34;</span><span class="op" id="3874910">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874913"><a href="/net/http/server.go.html#3874758">StateClosed</a></span><span class="op" id="3874924">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="3874928">&#34;closed&#34;</span><span class="op" id="3874936">,</span><br>
<span class="lineno"></span><span class="op" id="3874938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1685</span><span class="keyword" id="3874941">func</span>&nbsp;<span class="op" id="3874946">(</span><span class="ident" id="3874947">c</span>&nbsp;<span class="ident" id="3874949"><a href="/net/http/server.go.html#3873644">ConnState</a></span><span class="op" id="3874958">)</span>&nbsp;<span class="ident" id="3874960">String</span><span class="op" id="3874966">(</span><span class="op" id="3874967">)</span>&nbsp;<span class="builtintype" id="3874969">string</span>&nbsp;<span class="op" id="3874976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3874979">return</span>&nbsp;<span class="ident" id="3874986"><a href="/net/http/server.go.html#3874777">stateName</a></span><span class="op" id="3874995">[</span><span class="ident" id="3874996"><a href="/net/http/server.go.html#3874947">c</a></span><span class="op" id="3874997">]</span><br>
<span class="lineno"></span><span class="op" id="3874999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3875002">//&nbsp;serverHandler&nbsp;delegates&nbsp;to&nbsp;either&nbsp;the&nbsp;server&#39;s&nbsp;Handler&nbsp;or</span><br>
<span class="lineno">1690</span><span class="comment" id="3875063">//&nbsp;DefaultServeMux&nbsp;and&nbsp;also&nbsp;handles&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="3875121">type</span>&nbsp;<span class="ident" id="3875126">serverHandler</span>&nbsp;<span class="keyword" id="3875140">struct</span>&nbsp;<span class="op" id="3875147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875150">srv</span>&nbsp;<span class="op" id="3875154">*</span><span class="ident" id="3875155"><a href="/net/http/server.go.html#3872025">Server</a></span><br>
<span class="lineno"></span><span class="op" id="3875162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1695</span><span class="keyword" id="3875165">func</span>&nbsp;<span class="op" id="3875170">(</span><span class="ident" id="3875171">sh</span>&nbsp;<span class="ident" id="3875174"><a href="/net/http/server.go.html#3875126">serverHandler</a></span><span class="op" id="3875187">)</span>&nbsp;<span class="ident" id="3875189">ServeHTTP</span><span class="op" id="3875198">(</span><span class="ident" id="3875199">rw</span>&nbsp;<span class="ident" id="3875202"><a href="/net/http/server.go.html#3826033">ResponseWriter</a></span><span class="op" id="3875216">,</span>&nbsp;<span class="ident" id="3875218">req</span>&nbsp;<span class="op" id="3875222">*</span><span class="ident" id="3875223"><a href="/net/http/request.go.html#3791418">Request</a></span><span class="op" id="3875230">)</span>&nbsp;<span class="op" id="3875232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875235">handler</span>&nbsp;<span class="op" id="3875243">:=</span>&nbsp;<span class="ident" id="3875246"><a href="/net/http/server.go.html#3875171">sh</a></span><span class="op" id="3875248">.</span><span class="ident" id="3875249">srv</span><span class="op" id="3875252">.</span><span class="ident" id="3875253">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3875262">if</span>&nbsp;<span class="ident" id="3875265"><a href="/net/http/server.go.html#3875235">handler</a></span>&nbsp;<span class="op" id="3875273">==</span>&nbsp;<span class="ident" id="3875276">nil</span>&nbsp;<span class="op" id="3875280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875284"><a href="/net/http/server.go.html#3875235">handler</a></span>&nbsp;<span class="op" id="3875292">=</span>&nbsp;<span class="ident" id="3875294"><a href="/net/http/server.go.html#3866845">DefaultServeMux</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3875311">}</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3875314">if</span>&nbsp;<span class="ident" id="3875317"><a href="/net/http/server.go.html#3875218">req</a></span><span class="op" id="3875320">.</span><span class="ident" id="3875321">RequestURI</span>&nbsp;<span class="op" id="3875332">==</span>&nbsp;<span class="string" id="3875335">&#34;*&#34;</span>&nbsp;<span class="op" id="3875339">&amp;&amp;</span>&nbsp;<span class="ident" id="3875342"><a href="/net/http/server.go.html#3875218">req</a></span><span class="op" id="3875345">.</span><span class="ident" id="3875346">Method</span>&nbsp;<span class="op" id="3875353">==</span>&nbsp;<span class="string" id="3875356">&#34;OPTIONS&#34;</span>&nbsp;<span class="op" id="3875366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875370"><a href="/net/http/server.go.html#3875235">handler</a></span>&nbsp;<span class="op" id="3875378">=</span>&nbsp;<span class="ident" id="3875380"><a href="/net/http/server.go.html#3883040">globalOptionsHandler</a></span><span class="op" id="3875400">{</span><span class="op" id="3875401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3875404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875407"><a href="/net/http/server.go.html#3875235">handler</a></span><span class="op" id="3875414">.</span><span class="ident" id="3875415">ServeHTTP</span><span class="op" id="3875424">(</span><span class="ident" id="3875425"><a href="/net/http/server.go.html#3875199">rw</a></span><span class="op" id="3875427">,</span>&nbsp;<span class="ident" id="3875429"><a href="/net/http/server.go.html#3875218">req</a></span><span class="op" id="3875432">)</span><br>
<span class="lineno"></span><span class="op" id="3875434">}</span><br>
<span class="lineno">1705</span><br>
<span class="lineno"></span><span class="comment" id="3875437">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3875508">//&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;If</span><br>
<span class="lineno"></span><span class="comment" id="3875571">//&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:http&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3875610">func</span>&nbsp;<span class="op" id="3875615">(</span><span class="ident" id="3875616">srv</span>&nbsp;<span class="op" id="3875620">*</span><span class="ident" id="3875621"><a href="/net/http/server.go.html#3872025">Server</a></span><span class="op" id="3875627">)</span>&nbsp;<span class="ident" id="3875629">ListenAndServe</span><span class="op" id="3875643">(</span><span class="op" id="3875644">)</span>&nbsp;<span class="builtintype" id="3875646">error</span>&nbsp;<span class="op" id="3875652">{</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875655">addr</span>&nbsp;<span class="op" id="3875660">:=</span>&nbsp;<span class="ident" id="3875663"><a href="/net/http/server.go.html#3875616">srv</a></span><span class="op" id="3875666">.</span><span class="ident" id="3875667">Addr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3875673">if</span>&nbsp;<span class="ident" id="3875676"><a href="/net/http/server.go.html#3875655">addr</a></span>&nbsp;<span class="op" id="3875681">==</span>&nbsp;<span class="string" id="3875684">&#34;&#34;</span>&nbsp;<span class="op" id="3875687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875691"><a href="/net/http/server.go.html#3875655">addr</a></span>&nbsp;<span class="op" id="3875696">=</span>&nbsp;<span class="string" id="3875698">&#34;:http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3875707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875710">ln</span><span class="op" id="3875712">,</span>&nbsp;<span class="ident" id="3875714">err</span>&nbsp;<span class="op" id="3875718">:=</span>&nbsp;<span class="ident" id="3875721"><a href="/net/http/server.go.html#3824810">net</a></span><span class="op" id="3875724">.</span><span class="ident" id="3875725">Listen</span><span class="op" id="3875731">(</span><span class="string" id="3875732">&#34;tcp&#34;</span><span class="op" id="3875737">,</span>&nbsp;<span class="ident" id="3875739"><a href="/net/http/server.go.html#3875655">addr</a></span><span class="op" id="3875743">)</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3875746">if</span>&nbsp;<span class="ident" id="3875749"><a href="/net/http/server.go.html#3875714">err</a></span>&nbsp;<span class="op" id="3875753">!=</span>&nbsp;<span class="ident" id="3875756">nil</span>&nbsp;<span class="op" id="3875760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3875764">return</span>&nbsp;<span class="ident" id="3875771"><a href="/net/http/server.go.html#3875714">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3875776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3875779">return</span>&nbsp;<span class="ident" id="3875786"><a href="/net/http/server.go.html#3875616">srv</a></span><span class="op" id="3875789">.</span><span class="ident" id="3875790">Serve</span><span class="op" id="3875795">(</span><span class="ident" id="3875796"><a href="/net/http/server.go.html#3882722">tcpKeepAliveListener</a></span><span class="op" id="3875816">{</span><span class="ident" id="3875817"><a href="/net/http/server.go.html#3875710">ln</a></span><span class="op" id="3875819">.</span><span class="op" id="3875820">(</span><span class="op" id="3875821">*</span><span class="ident" id="3875822"><a href="/net/http/server.go.html#3824810">net</a></span><span class="op" id="3875825">.</span><span class="ident" id="3875826">TCPListener</span><span class="op" id="3875837">)</span><span class="op" id="3875838">}</span><span class="op" id="3875839">)</span><br>
<span class="lineno"></span><span class="op" id="3875841">}</span><br>
<span class="lineno">1720</span><br>
<span class="lineno"></span><span class="comment" id="3875844">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;connections&nbsp;on&nbsp;the&nbsp;Listener&nbsp;l,&nbsp;creating&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3875912">//&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines&nbsp;read&nbsp;requests&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3875989">//&nbsp;then&nbsp;call&nbsp;srv.Handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="3876032">func</span>&nbsp;<span class="op" id="3876037">(</span><span class="ident" id="3876038">srv</span>&nbsp;<span class="op" id="3876042">*</span><span class="ident" id="3876043"><a href="/net/http/server.go.html#3872025">Server</a></span><span class="op" id="3876049">)</span>&nbsp;<span class="ident" id="3876051">Serve</span><span class="op" id="3876056">(</span><span class="ident" id="3876057">l</span>&nbsp;<span class="ident" id="3876059"><a href="/net/http/server.go.html#3824810">net</a></span><span class="op" id="3876062">.</span><span class="ident" id="3876063">Listener</span><span class="op" id="3876071">)</span>&nbsp;<span class="builtintype" id="3876073">error</span>&nbsp;<span class="op" id="3876079">{</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876082">defer</span>&nbsp;<span class="ident" id="3876088"><a href="/net/http/server.go.html#3876057">l</a></span><span class="op" id="3876089">.</span><span class="ident" id="3876090">Close</span><span class="op" id="3876095">(</span><span class="op" id="3876096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876099">var</span>&nbsp;<span class="ident" id="3876103">tempDelay</span>&nbsp;<span class="ident" id="3876113"><a href="/net/http/server.go.html#3824898">time</a></span><span class="op" id="3876117">.</span><span class="ident" id="3876118">Duration</span>&nbsp;<span class="comment" id="3876127">//&nbsp;how&nbsp;long&nbsp;to&nbsp;sleep&nbsp;on&nbsp;accept&nbsp;failure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876167">for</span>&nbsp;<span class="op" id="3876171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876175">rw</span><span class="op" id="3876177">,</span>&nbsp;<span class="ident" id="3876179">e</span>&nbsp;<span class="op" id="3876181">:=</span>&nbsp;<span class="ident" id="3876184"><a href="/net/http/server.go.html#3876057">l</a></span><span class="op" id="3876185">.</span><span class="ident" id="3876186">Accept</span><span class="op" id="3876192">(</span><span class="op" id="3876193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876197">if</span>&nbsp;<span class="ident" id="3876200"><a href="/net/http/server.go.html#3876179">e</a></span>&nbsp;<span class="op" id="3876202">!=</span>&nbsp;<span class="ident" id="3876205">nil</span>&nbsp;<span class="op" id="3876209">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876214">if</span>&nbsp;<span class="ident" id="3876217">ne</span><span class="op" id="3876219">,</span>&nbsp;<span class="ident" id="3876221">ok</span>&nbsp;<span class="op" id="3876224">:=</span>&nbsp;<span class="ident" id="3876227"><a href="/net/http/server.go.html#3876179">e</a></span><span class="op" id="3876228">.</span><span class="op" id="3876229">(</span><span class="ident" id="3876230"><a href="/net/http/server.go.html#3824810">net</a></span><span class="op" id="3876233">.</span><span class="ident" id="3876234">Error</span><span class="op" id="3876239">)</span><span class="op" id="3876240">;</span>&nbsp;<span class="ident" id="3876242"><a href="/net/http/server.go.html#3876221">ok</a></span>&nbsp;<span class="op" id="3876245">&amp;&amp;</span>&nbsp;<span class="ident" id="3876248"><a href="/net/http/server.go.html#3876217">ne</a></span><span class="op" id="3876250">.</span><span class="ident" id="3876251">Temporary</span><span class="op" id="3876260">(</span><span class="op" id="3876261">)</span>&nbsp;<span class="op" id="3876263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876269">if</span>&nbsp;<span class="ident" id="3876272"><a href="/net/http/server.go.html#3876103">tempDelay</a></span>&nbsp;<span class="op" id="3876282">==</span>&nbsp;<span class="num" id="3876285">0</span>&nbsp;<span class="op" id="3876287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876294"><a href="/net/http/server.go.html#3876103">tempDelay</a></span>&nbsp;<span class="op" id="3876304">=</span>&nbsp;<span class="num" id="3876306">5</span>&nbsp;<span class="op" id="3876308">*</span>&nbsp;<span class="ident" id="3876310"><a href="/net/http/server.go.html#3824898">time</a></span><span class="op" id="3876314">.</span><span class="ident" id="3876315">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3876331">}</span>&nbsp;<span class="keyword" id="3876333">else</span>&nbsp;<span class="op" id="3876338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876345"><a href="/net/http/server.go.html#3876103">tempDelay</a></span>&nbsp;<span class="op" id="3876355">*=</span>&nbsp;<span class="num" id="3876358">2</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3876364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876370">if</span>&nbsp;<span class="ident" id="3876373">max</span>&nbsp;<span class="op" id="3876377">:=</span>&nbsp;<span class="num" id="3876380">1</span>&nbsp;<span class="op" id="3876382">*</span>&nbsp;<span class="ident" id="3876384"><a href="/net/http/server.go.html#3824898">time</a></span><span class="op" id="3876388">.</span><span class="ident" id="3876389">Second</span><span class="op" id="3876395">;</span>&nbsp;<span class="ident" id="3876397"><a href="/net/http/server.go.html#3876103">tempDelay</a></span>&nbsp;<span class="op" id="3876407">&gt;</span>&nbsp;<span class="ident" id="3876409"><a href="/net/http/server.go.html#3876373">max</a></span>&nbsp;<span class="op" id="3876413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876420"><a href="/net/http/server.go.html#3876103">tempDelay</a></span>&nbsp;<span class="op" id="3876430">=</span>&nbsp;<span class="ident" id="3876432"><a href="/net/http/server.go.html#3876373">max</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3876440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876446"><a href="/net/http/server.go.html#3876038">srv</a></span><span class="op" id="3876449">.</span><span class="ident" id="3876450">logf</span><span class="op" id="3876454">(</span><span class="string" id="3876455">&#34;http:&nbsp;Accept&nbsp;error:&nbsp;%v;&nbsp;retrying&nbsp;in&nbsp;%v&#34;</span><span class="op" id="3876495">,</span>&nbsp;<span class="ident" id="3876497"><a href="/net/http/server.go.html#3876179">e</a></span><span class="op" id="3876498">,</span>&nbsp;<span class="ident" id="3876500"><a href="/net/http/server.go.html#3876103">tempDelay</a></span><span class="op" id="3876509">)</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876515"><a href="/net/http/server.go.html#3824898">time</a></span><span class="op" id="3876519">.</span><span class="ident" id="3876520">Sleep</span><span class="op" id="3876525">(</span><span class="ident" id="3876526"><a href="/net/http/server.go.html#3876103">tempDelay</a></span><span class="op" id="3876535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876541">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3876553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876558">return</span>&nbsp;<span class="ident" id="3876565"><a href="/net/http/server.go.html#3876179">e</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3876569">}</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876573"><a href="/net/http/server.go.html#3876103">tempDelay</a></span>&nbsp;<span class="op" id="3876583">=</span>&nbsp;<span class="num" id="3876585">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876589">c</span><span class="op" id="3876590">,</span>&nbsp;<span class="ident" id="3876592">err</span>&nbsp;<span class="op" id="3876596">:=</span>&nbsp;<span class="ident" id="3876599"><a href="/net/http/server.go.html#3876038">srv</a></span><span class="op" id="3876602">.</span><span class="ident" id="3876603">newConn</span><span class="op" id="3876610">(</span><span class="ident" id="3876611"><a href="/net/http/server.go.html#3876175">rw</a></span><span class="op" id="3876613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876617">if</span>&nbsp;<span class="ident" id="3876620"><a href="/net/http/server.go.html#3876592">err</a></span>&nbsp;<span class="op" id="3876624">!=</span>&nbsp;<span class="ident" id="3876627">nil</span>&nbsp;<span class="op" id="3876631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876636">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3876647">}</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876651"><a href="/net/http/server.go.html#3876589">c</a></span><span class="op" id="3876652">.</span><span class="ident" id="3876653">setState</span><span class="op" id="3876661">(</span><span class="ident" id="3876662"><a href="/net/http/server.go.html#3876589">c</a></span><span class="op" id="3876663">.</span><span class="ident" id="3876664">rwc</span><span class="op" id="3876667">,</span>&nbsp;<span class="ident" id="3876669"><a href="/net/http/server.go.html#3873859">StateNew</a></span><span class="op" id="3876677">)</span>&nbsp;<span class="comment" id="3876679">//&nbsp;before&nbsp;Serve&nbsp;can&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876708">go</span>&nbsp;<span class="ident" id="3876711"><a href="/net/http/server.go.html#3876589">c</a></span><span class="op" id="3876712">.</span><span class="ident" id="3876713">serve</span><span class="op" id="3876718">(</span><span class="op" id="3876719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3876722">}</span><br>
<span class="lineno"></span><span class="op" id="3876724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1755</span><span class="keyword" id="3876727">func</span>&nbsp;<span class="op" id="3876732">(</span><span class="ident" id="3876733">s</span>&nbsp;<span class="op" id="3876735">*</span><span class="ident" id="3876736"><a href="/net/http/server.go.html#3872025">Server</a></span><span class="op" id="3876742">)</span>&nbsp;<span class="ident" id="3876744">doKeepAlives</span><span class="op" id="3876756">(</span><span class="op" id="3876757">)</span>&nbsp;<span class="builtintype" id="3876759">bool</span>&nbsp;<span class="op" id="3876764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876767">return</span>&nbsp;<span class="ident" id="3876774"><a href="/net/http/server.go.html#3824883">atomic</a></span><span class="op" id="3876780">.</span><span class="ident" id="3876781">LoadInt32</span><span class="op" id="3876790">(</span><span class="op" id="3876791">&amp;</span><span class="ident" id="3876792"><a href="/net/http/server.go.html#3876733">s</a></span><span class="op" id="3876793">.</span><span class="ident" id="3876794">disableKeepAlives</span><span class="op" id="3876811">)</span>&nbsp;<span class="op" id="3876813">==</span>&nbsp;<span class="num" id="3876816">0</span><br>
<span class="lineno"></span><span class="op" id="3876818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3876821">//&nbsp;SetKeepAlivesEnabled&nbsp;controls&nbsp;whether&nbsp;HTTP&nbsp;keep-alives&nbsp;are&nbsp;enabled.</span><br>
<span class="lineno">1760</span><span class="comment" id="3876892">//&nbsp;By&nbsp;default,&nbsp;keep-alives&nbsp;are&nbsp;always&nbsp;enabled.&nbsp;Only&nbsp;very</span><br>
<span class="lineno"></span><span class="comment" id="3876949">//&nbsp;resource-constrained&nbsp;environments&nbsp;or&nbsp;servers&nbsp;in&nbsp;the&nbsp;process&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3877015">//&nbsp;shutting&nbsp;down&nbsp;should&nbsp;disable&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="3877053">func</span>&nbsp;<span class="op" id="3877058">(</span><span class="ident" id="3877059">s</span>&nbsp;<span class="op" id="3877061">*</span><span class="ident" id="3877062"><a href="/net/http/server.go.html#3872025">Server</a></span><span class="op" id="3877068">)</span>&nbsp;<span class="ident" id="3877070">SetKeepAlivesEnabled</span><span class="op" id="3877090">(</span><span class="ident" id="3877091">v</span>&nbsp;<span class="builtintype" id="3877093">bool</span><span class="op" id="3877097">)</span>&nbsp;<span class="op" id="3877099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877102">if</span>&nbsp;<span class="ident" id="3877105"><a href="/net/http/server.go.html#3877091">v</a></span>&nbsp;<span class="op" id="3877107">{</span><br>
<span class="lineno">1765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877111"><a href="/net/http/server.go.html#3824883">atomic</a></span><span class="op" id="3877117">.</span><span class="ident" id="3877118">StoreInt32</span><span class="op" id="3877128">(</span><span class="op" id="3877129">&amp;</span><span class="ident" id="3877130"><a href="/net/http/server.go.html#3877059">s</a></span><span class="op" id="3877131">.</span><span class="ident" id="3877132">disableKeepAlives</span><span class="op" id="3877149">,</span>&nbsp;<span class="num" id="3877151">0</span><span class="op" id="3877152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3877155">}</span>&nbsp;<span class="keyword" id="3877157">else</span>&nbsp;<span class="op" id="3877162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877166"><a href="/net/http/server.go.html#3824883">atomic</a></span><span class="op" id="3877172">.</span><span class="ident" id="3877173">StoreInt32</span><span class="op" id="3877183">(</span><span class="op" id="3877184">&amp;</span><span class="ident" id="3877185"><a href="/net/http/server.go.html#3877059">s</a></span><span class="op" id="3877186">.</span><span class="ident" id="3877187">disableKeepAlives</span><span class="op" id="3877204">,</span>&nbsp;<span class="num" id="3877206">1</span><span class="op" id="3877207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3877210">}</span><br>
<span class="lineno"></span><span class="op" id="3877212">}</span><br>
<span class="lineno">1770</span><br>
<span class="lineno"></span><span class="keyword" id="3877215">func</span>&nbsp;<span class="op" id="3877220">(</span><span class="ident" id="3877221">s</span>&nbsp;<span class="op" id="3877223">*</span><span class="ident" id="3877224"><a href="/net/http/server.go.html#3872025">Server</a></span><span class="op" id="3877230">)</span>&nbsp;<span class="ident" id="3877232">logf</span><span class="op" id="3877236">(</span><span class="ident" id="3877237">format</span>&nbsp;<span class="builtintype" id="3877244">string</span><span class="op" id="3877250">,</span>&nbsp;<span class="ident" id="3877252">args</span>&nbsp;<span class="op" id="3877257">...</span><span class="keyword" id="3877260">interface</span><span class="op" id="3877269">{</span><span class="op" id="3877270">}</span><span class="op" id="3877271">)</span>&nbsp;<span class="op" id="3877273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877276">if</span>&nbsp;<span class="ident" id="3877279"><a href="/net/http/server.go.html#3877221">s</a></span><span class="op" id="3877280">.</span><span class="ident" id="3877281">ErrorLog</span>&nbsp;<span class="op" id="3877290">!=</span>&nbsp;<span class="ident" id="3877293">nil</span>&nbsp;<span class="op" id="3877297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877301"><a href="/net/http/server.go.html#3877221">s</a></span><span class="op" id="3877302">.</span><span class="ident" id="3877303">ErrorLog</span><span class="op" id="3877311">.</span><span class="ident" id="3877312">Printf</span><span class="op" id="3877318">(</span><span class="ident" id="3877319"><a href="/net/http/server.go.html#3877237">format</a></span><span class="op" id="3877325">,</span>&nbsp;<span class="ident" id="3877327"><a href="/net/http/server.go.html#3877252">args</a></span><span class="op" id="3877331">...</span><span class="op" id="3877334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3877337">}</span>&nbsp;<span class="keyword" id="3877339">else</span>&nbsp;<span class="op" id="3877344">{</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877348"><a href="/net/http/server.go.html#3824803">log</a></span><span class="op" id="3877351">.</span><span class="ident" id="3877352">Printf</span><span class="op" id="3877358">(</span><span class="ident" id="3877359"><a href="/net/http/server.go.html#3877237">format</a></span><span class="op" id="3877365">,</span>&nbsp;<span class="ident" id="3877367"><a href="/net/http/server.go.html#3877252">args</a></span><span class="op" id="3877371">...</span><span class="op" id="3877374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3877377">}</span><br>
<span class="lineno"></span><span class="op" id="3877379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3877382">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;addr</span><br>
<span class="lineno">1780</span><span class="comment" id="3877440">//&nbsp;and&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;with&nbsp;handler&nbsp;to&nbsp;handle&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3877496">//&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="3877551">//&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="3877597">//</span><br>
<span class="lineno"></span><span class="comment" id="3877600">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno">1785</span><span class="comment" id="3877632">//</span><br>
<span class="lineno"></span><span class="comment" id="3877635">//&nbsp;&nbsp;&nbsp;&nbsppackage&nbsp;main</span><br>
<span class="lineno"></span><span class="comment" id="3877651">//</span><br>
<span class="lineno"></span><span class="comment" id="3877654">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;(</span><br>
<span class="lineno"></span><span class="comment" id="3877666">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;io&#34;</span><br>
<span class="lineno">1790</span><span class="comment" id="3877675">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3877690">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3877700">//&nbsp;&nbsp;&nbsp;&nbsp)</span><br>
<span class="lineno"></span><span class="comment" id="3877705">//</span><br>
<span class="lineno"></span><span class="comment" id="3877708">//&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;hello&nbsp;world,&nbsp;the&nbsp;web&nbsp;server</span><br>
<span class="lineno">1795</span><span class="comment" id="3877742">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;HelloServer(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3877806">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspio.WriteString(w,&nbsp;&#34;hello,&nbsp;world!\n&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3877847">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3877852">//</span><br>
<span class="lineno"></span><span class="comment" id="3877855">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1800</span><span class="comment" id="3877872">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsphttp.HandleFunc(&#34;/hello&#34;,&nbsp;HelloServer)</span><br>
<span class="lineno"></span><span class="comment" id="3877915">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;:=&nbsp;http.ListenAndServe(&#34;:12345&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="3877961">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3877981">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;ListenAndServe:&nbsp;&#34;,&nbsp;err)</span><br>
<span class="lineno"></span><span class="comment" id="3878021">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno">1805</span><span class="comment" id="3878027">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="keyword" id="3878032">func</span>&nbsp;<span class="ident" id="3878037">ListenAndServe</span><span class="op" id="3878051">(</span><span class="ident" id="3878052">addr</span>&nbsp;<span class="builtintype" id="3878057">string</span><span class="op" id="3878063">,</span>&nbsp;<span class="ident" id="3878065">handler</span>&nbsp;<span class="ident" id="3878073"><a href="/net/http/server.go.html#3825877">Handler</a></span><span class="op" id="3878080">)</span>&nbsp;<span class="builtintype" id="3878082">error</span>&nbsp;<span class="op" id="3878088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878091">server</span>&nbsp;<span class="op" id="3878098">:=</span>&nbsp;<span class="op" id="3878101">&amp;</span><span class="ident" id="3878102"><a href="/net/http/server.go.html#3872025">Server</a></span><span class="op" id="3878108">{</span><span class="ident" id="3878109">Addr</span><span class="op" id="3878113">:</span>&nbsp;<span class="ident" id="3878115"><a href="/net/http/server.go.html#3878052">addr</a></span><span class="op" id="3878119">,</span>&nbsp;<span class="ident" id="3878121">Handler</span><span class="op" id="3878128">:</span>&nbsp;<span class="ident" id="3878130"><a href="/net/http/server.go.html#3878065">handler</a></span><span class="op" id="3878137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878140">return</span>&nbsp;<span class="ident" id="3878147"><a href="/net/http/server.go.html#3878091">server</a></span><span class="op" id="3878153">.</span><span class="ident" id="3878154">ListenAndServe</span><span class="op" id="3878168">(</span><span class="op" id="3878169">)</span><br>
<span class="lineno"></span><span class="op" id="3878171">}</span><br>
<span class="lineno">1810</span><br>
<span class="lineno"></span><span class="comment" id="3878174">//&nbsp;ListenAndServeTLS&nbsp;acts&nbsp;identically&nbsp;to&nbsp;ListenAndServe,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3878246">//&nbsp;expects&nbsp;HTTPS&nbsp;connections.&nbsp;Additionally,&nbsp;files&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3878325">//&nbsp;matching&nbsp;private&nbsp;key&nbsp;for&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate</span><br>
<span class="lineno"></span><span class="comment" id="3878401">//&nbsp;is&nbsp;signed&nbsp;by&nbsp;a&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1815</span><span class="comment" id="3878483">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="3878548">//</span><br>
<span class="lineno"></span><span class="comment" id="3878551">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno"></span><span class="comment" id="3878583">//</span><br>
<span class="lineno"></span><span class="comment" id="3878586">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;(</span><br>
<span class="lineno">1820</span><span class="comment" id="3878598">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3878608">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3878623">//&nbsp;&nbsp;&nbsp;&nbsp)</span><br>
<span class="lineno"></span><span class="comment" id="3878628">//</span><br>
<span class="lineno"></span><span class="comment" id="3878631">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;handler(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno">1825</span><span class="comment" id="3878691">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspw.Header().Set(&#34;Content-Type&#34;,&nbsp;&#34;text/plain&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3878740">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspw.Write([]byte(&#34;This&nbsp;is&nbsp;an&nbsp;example&nbsp;server.\n&#34;))</span><br>
<span class="lineno"></span><span class="comment" id="3878792">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3878797">//</span><br>
<span class="lineno"></span><span class="comment" id="3878800">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1830</span><span class="comment" id="3878817">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsphttp.HandleFunc(&#34;/&#34;,&nbsp;handler)</span><br>
<span class="lineno"></span><span class="comment" id="3878851">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Printf(&#34;About&nbsp;to&nbsp;listen&nbsp;on&nbsp;10443.&nbsp;Go&nbsp;to&nbsp;https://127.0.0.1:10443/&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3878926">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;:=&nbsp;http.ListenAndServeTLS(&#34;:10443&#34;,&nbsp;&#34;cert.pem&#34;,&nbsp;&#34;key.pem&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="3878998">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3879018">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(err)</span><br>
<span class="lineno">1835</span><span class="comment" id="3879038">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3879044">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="3879049">//</span><br>
<span class="lineno"></span><span class="comment" id="3879052">//&nbsp;One&nbsp;can&nbsp;use&nbsp;generate_cert.go&nbsp;in&nbsp;crypto/tls&nbsp;to&nbsp;generate&nbsp;cert.pem&nbsp;and&nbsp;key.pem.</span><br>
<span class="lineno"></span><span class="keyword" id="3879132">func</span>&nbsp;<span class="ident" id="3879137">ListenAndServeTLS</span><span class="op" id="3879154">(</span><span class="ident" id="3879155">addr</span>&nbsp;<span class="builtintype" id="3879160">string</span><span class="op" id="3879166">,</span>&nbsp;<span class="ident" id="3879168">certFile</span>&nbsp;<span class="builtintype" id="3879177">string</span><span class="op" id="3879183">,</span>&nbsp;<span class="ident" id="3879185">keyFile</span>&nbsp;<span class="builtintype" id="3879193">string</span><span class="op" id="3879199">,</span>&nbsp;<span class="ident" id="3879201">handler</span>&nbsp;<span class="ident" id="3879209"><a href="/net/http/server.go.html#3825877">Handler</a></span><span class="op" id="3879216">)</span>&nbsp;<span class="builtintype" id="3879218">error</span>&nbsp;<span class="op" id="3879224">{</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879227">server</span>&nbsp;<span class="op" id="3879234">:=</span>&nbsp;<span class="op" id="3879237">&amp;</span><span class="ident" id="3879238"><a href="/net/http/server.go.html#3872025">Server</a></span><span class="op" id="3879244">{</span><span class="ident" id="3879245">Addr</span><span class="op" id="3879249">:</span>&nbsp;<span class="ident" id="3879251"><a href="/net/http/server.go.html#3879155">addr</a></span><span class="op" id="3879255">,</span>&nbsp;<span class="ident" id="3879257">Handler</span><span class="op" id="3879264">:</span>&nbsp;<span class="ident" id="3879266"><a href="/net/http/server.go.html#3879201">handler</a></span><span class="op" id="3879273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879276">return</span>&nbsp;<span class="ident" id="3879283"><a href="/net/http/server.go.html#3879227">server</a></span><span class="op" id="3879289">.</span><span class="ident" id="3879290">ListenAndServeTLS</span><span class="op" id="3879307">(</span><span class="ident" id="3879308"><a href="/net/http/server.go.html#3879168">certFile</a></span><span class="op" id="3879316">,</span>&nbsp;<span class="ident" id="3879318"><a href="/net/http/server.go.html#3879185">keyFile</a></span><span class="op" id="3879325">)</span><br>
<span class="lineno"></span><span class="op" id="3879327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3879330">//&nbsp;ListenAndServeTLS&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and</span><br>
<span class="lineno">1845</span><span class="comment" id="3879399">//&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="3879467">//</span><br>
<span class="lineno"></span><span class="comment" id="3879470">//&nbsp;Filenames&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and&nbsp;matching&nbsp;private&nbsp;key&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3879537">//&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3879603">//&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1850</span><span class="comment" id="3879670">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="3879735">//</span><br>
<span class="lineno"></span><span class="comment" id="3879738">//&nbsp;If&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:https&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3879781">func</span>&nbsp;<span class="op" id="3879786">(</span><span class="ident" id="3879787">srv</span>&nbsp;<span class="op" id="3879791">*</span><span class="ident" id="3879792"><a href="/net/http/server.go.html#3872025">Server</a></span><span class="op" id="3879798">)</span>&nbsp;<span class="ident" id="3879800">ListenAndServeTLS</span><span class="op" id="3879817">(</span><span class="ident" id="3879818">certFile</span><span class="op" id="3879826">,</span>&nbsp;<span class="ident" id="3879828">keyFile</span>&nbsp;<span class="builtintype" id="3879836">string</span><span class="op" id="3879842">)</span>&nbsp;<span class="builtintype" id="3879844">error</span>&nbsp;<span class="op" id="3879850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879853">addr</span>&nbsp;<span class="op" id="3879858">:=</span>&nbsp;<span class="ident" id="3879861"><a href="/net/http/server.go.html#3879787">srv</a></span><span class="op" id="3879864">.</span><span class="ident" id="3879865">Addr</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879871">if</span>&nbsp;<span class="ident" id="3879874"><a href="/net/http/server.go.html#3879853">addr</a></span>&nbsp;<span class="op" id="3879879">==</span>&nbsp;<span class="string" id="3879882">&#34;&#34;</span>&nbsp;<span class="op" id="3879885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879889"><a href="/net/http/server.go.html#3879853">addr</a></span>&nbsp;<span class="op" id="3879894">=</span>&nbsp;<span class="string" id="3879896">&#34;:https&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3879906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3879909">config</span>&nbsp;<span class="op" id="3879916">:=</span>&nbsp;<span class="op" id="3879919">&amp;</span><span class="ident" id="3879920"><a href="/net/http/server.go.html#3824753">tls</a></span><span class="op" id="3879923">.</span><span class="ident" id="3879924">Config</span><span class="op" id="3879930">{</span><span class="op" id="3879931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879934">if</span>&nbsp;<span class="ident" id="3879937"><a href="/net/http/server.go.html#3879787">srv</a></span><span class="op" id="3879940">.</span><span class="ident" id="3879941">TLSConfig</span>&nbsp;<span class="op" id="3879951">!=</span>&nbsp;<span class="ident" id="3879954">nil</span>&nbsp;<span class="op" id="3879958">{</span><br>
<span class="lineno">1860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3879962">*</span><span class="ident" id="3879963"><a href="/net/http/server.go.html#3879909">config</a></span>&nbsp;<span class="op" id="3879970">=</span>&nbsp;<span class="op" id="3879972">*</span><span class="ident" id="3879973"><a href="/net/http/server.go.html#3879787">srv</a></span><span class="op" id="3879976">.</span><span class="ident" id="3879977">TLSConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3879988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3879991">if</span>&nbsp;<span class="ident" id="3879994"><a href="/net/http/server.go.html#3879909">config</a></span><span class="op" id="3880000">.</span><span class="ident" id="3880001">NextProtos</span>&nbsp;<span class="op" id="3880012">==</span>&nbsp;<span class="ident" id="3880015">nil</span>&nbsp;<span class="op" id="3880019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880023"><a href="/net/http/server.go.html#3879909">config</a></span><span class="op" id="3880029">.</span><span class="ident" id="3880030">NextProtos</span>&nbsp;<span class="op" id="3880041">=</span>&nbsp;<span class="op" id="3880043">[</span><span class="op" id="3880044">]</span><span class="builtintype" id="3880045">string</span><span class="op" id="3880051">{</span><span class="string" id="3880052">&#34;http/1.1&#34;</span><span class="op" id="3880062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3880065">}</span><br>
<span class="lineno">1865</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880069">var</span>&nbsp;<span class="ident" id="3880073">err</span>&nbsp;<span class="builtintype" id="3880077">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880084"><a href="/net/http/server.go.html#3879909">config</a></span><span class="op" id="3880090">.</span><span class="ident" id="3880091">Certificates</span>&nbsp;<span class="op" id="3880104">=</span>&nbsp;<span class="builtinfunc" id="3880106">make</span><span class="op" id="3880110">(</span><span class="op" id="3880111">[</span><span class="op" id="3880112">]</span><span class="ident" id="3880113"><a href="/net/http/server.go.html#3824753">tls</a></span><span class="op" id="3880116">.</span><span class="ident" id="3880117">Certificate</span><span class="op" id="3880128">,</span>&nbsp;<span class="num" id="3880130">1</span><span class="op" id="3880131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880134"><a href="/net/http/server.go.html#3879909">config</a></span><span class="op" id="3880140">.</span><span class="ident" id="3880141">Certificates</span><span class="op" id="3880153">[</span><span class="num" id="3880154">0</span><span class="op" id="3880155">]</span><span class="op" id="3880156">,</span>&nbsp;<span class="ident" id="3880158"><a href="/net/http/server.go.html#3880073">err</a></span>&nbsp;<span class="op" id="3880162">=</span>&nbsp;<span class="ident" id="3880164"><a href="/net/http/server.go.html#3824753">tls</a></span><span class="op" id="3880167">.</span><span class="ident" id="3880168">LoadX509KeyPair</span><span class="op" id="3880183">(</span><span class="ident" id="3880184"><a href="/net/http/server.go.html#3879818">certFile</a></span><span class="op" id="3880192">,</span>&nbsp;<span class="ident" id="3880194"><a href="/net/http/server.go.html#3879828">keyFile</a></span><span class="op" id="3880201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880204">if</span>&nbsp;<span class="ident" id="3880207"><a href="/net/http/server.go.html#3880073">err</a></span>&nbsp;<span class="op" id="3880211">!=</span>&nbsp;<span class="ident" id="3880214">nil</span>&nbsp;<span class="op" id="3880218">{</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880222">return</span>&nbsp;<span class="ident" id="3880229"><a href="/net/http/server.go.html#3880073">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3880234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880238">ln</span><span class="op" id="3880240">,</span>&nbsp;<span class="ident" id="3880242"><a href="/net/http/server.go.html#3880073">err</a></span>&nbsp;<span class="op" id="3880246">:=</span>&nbsp;<span class="ident" id="3880249"><a href="/net/http/server.go.html#3824810">net</a></span><span class="op" id="3880252">.</span><span class="ident" id="3880253">Listen</span><span class="op" id="3880259">(</span><span class="string" id="3880260">&#34;tcp&#34;</span><span class="op" id="3880265">,</span>&nbsp;<span class="ident" id="3880267"><a href="/net/http/server.go.html#3879853">addr</a></span><span class="op" id="3880271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880274">if</span>&nbsp;<span class="ident" id="3880277"><a href="/net/http/server.go.html#3880073">err</a></span>&nbsp;<span class="op" id="3880281">!=</span>&nbsp;<span class="ident" id="3880284">nil</span>&nbsp;<span class="op" id="3880288">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880292">return</span>&nbsp;<span class="ident" id="3880299"><a href="/net/http/server.go.html#3880073">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3880304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880308">tlsListener</span>&nbsp;<span class="op" id="3880320">:=</span>&nbsp;<span class="ident" id="3880323"><a href="/net/http/server.go.html#3824753">tls</a></span><span class="op" id="3880326">.</span><span class="ident" id="3880327">NewListener</span><span class="op" id="3880338">(</span><span class="ident" id="3880339"><a href="/net/http/server.go.html#3882722">tcpKeepAliveListener</a></span><span class="op" id="3880359">{</span><span class="ident" id="3880360"><a href="/net/http/server.go.html#3880238">ln</a></span><span class="op" id="3880362">.</span><span class="op" id="3880363">(</span><span class="op" id="3880364">*</span><span class="ident" id="3880365"><a href="/net/http/server.go.html#3824810">net</a></span><span class="op" id="3880368">.</span><span class="ident" id="3880369">TCPListener</span><span class="op" id="3880380">)</span><span class="op" id="3880381">}</span><span class="op" id="3880382">,</span>&nbsp;<span class="ident" id="3880384"><a href="/net/http/server.go.html#3879909">config</a></span><span class="op" id="3880390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880393">return</span>&nbsp;<span class="ident" id="3880400"><a href="/net/http/server.go.html#3879787">srv</a></span><span class="op" id="3880403">.</span><span class="ident" id="3880404">Serve</span><span class="op" id="3880409">(</span><span class="ident" id="3880410"><a href="/net/http/server.go.html#3880308">tlsListener</a></span><span class="op" id="3880421">)</span><br>
<span class="lineno">1880</span><span class="op" id="3880423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3880426">//&nbsp;TimeoutHandler&nbsp;returns&nbsp;a&nbsp;Handler&nbsp;that&nbsp;runs&nbsp;h&nbsp;with&nbsp;the&nbsp;given&nbsp;time&nbsp;limit.</span><br>
<span class="lineno"></span><span class="comment" id="3880501">//</span><br>
<span class="lineno"></span><span class="comment" id="3880504">//&nbsp;The&nbsp;new&nbsp;Handler&nbsp;calls&nbsp;h.ServeHTTP&nbsp;to&nbsp;handle&nbsp;each&nbsp;request,&nbsp;but&nbsp;if&nbsp;a</span><br>
<span class="lineno">1885</span><span class="comment" id="3880574">//&nbsp;call&nbsp;runs&nbsp;for&nbsp;longer&nbsp;than&nbsp;its&nbsp;time&nbsp;limit,&nbsp;the&nbsp;handler&nbsp;responds&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="3880645">//&nbsp;a&nbsp;503&nbsp;Service&nbsp;Unavailable&nbsp;error&nbsp;and&nbsp;the&nbsp;given&nbsp;message&nbsp;in&nbsp;its&nbsp;body.</span><br>
<span class="lineno"></span><span class="comment" id="3880715">//&nbsp;(If&nbsp;msg&nbsp;is&nbsp;empty,&nbsp;a&nbsp;suitable&nbsp;default&nbsp;message&nbsp;will&nbsp;be&nbsp;sent.)</span><br>
<span class="lineno"></span><span class="comment" id="3880778">//&nbsp;After&nbsp;such&nbsp;a&nbsp;timeout,&nbsp;writes&nbsp;by&nbsp;h&nbsp;to&nbsp;its&nbsp;ResponseWriter&nbsp;will&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="3880849">//&nbsp;ErrHandlerTimeout.</span><br>
<span class="lineno">1890</span><span class="keyword" id="3880871">func</span>&nbsp;<span class="ident" id="3880876">TimeoutHandler</span><span class="op" id="3880890">(</span><span class="ident" id="3880891">h</span>&nbsp;<span class="ident" id="3880893"><a href="/net/http/server.go.html#3825877">Handler</a></span><span class="op" id="3880900">,</span>&nbsp;<span class="ident" id="3880902">dt</span>&nbsp;<span class="ident" id="3880905"><a href="/net/http/server.go.html#3824898">time</a></span><span class="op" id="3880909">.</span><span class="ident" id="3880910">Duration</span><span class="op" id="3880918">,</span>&nbsp;<span class="ident" id="3880920">msg</span>&nbsp;<span class="builtintype" id="3880924">string</span><span class="op" id="3880930">)</span>&nbsp;<span class="ident" id="3880932"><a href="/net/http/server.go.html#3825877">Handler</a></span>&nbsp;<span class="op" id="3880940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3880943">f</span>&nbsp;<span class="op" id="3880945">:=</span>&nbsp;<span class="keyword" id="3880948">func</span><span class="op" id="3880952">(</span><span class="op" id="3880953">)</span>&nbsp;<span class="op" id="3880955">&lt;-</span><span class="keyword" id="3880957">chan</span>&nbsp;<span class="ident" id="3880962"><a href="/net/http/server.go.html#3824898">time</a></span><span class="op" id="3880966">.</span><span class="ident" id="3880967">Time</span>&nbsp;<span class="op" id="3880972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3880976">return</span>&nbsp;<span class="ident" id="3880983"><a href="/net/http/server.go.html#3824898">time</a></span><span class="op" id="3880987">.</span><span class="ident" id="3880988">After</span><span class="op" id="3880993">(</span><span class="ident" id="3880994"><a href="/net/http/server.go.html#3880902">dt</a></span><span class="op" id="3880996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3880999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881002">return</span>&nbsp;<span class="op" id="3881009">&amp;</span><span class="ident" id="3881010"><a href="/net/http/server.go.html#3881205">timeoutHandler</a></span><span class="op" id="3881024">{</span><span class="ident" id="3881025"><a href="/net/http/server.go.html#3880891">h</a></span><span class="op" id="3881026">,</span>&nbsp;<span class="ident" id="3881028"><a href="/net/http/server.go.html#3880943">f</a></span><span class="op" id="3881029">,</span>&nbsp;<span class="ident" id="3881031"><a href="/net/http/server.go.html#3880920">msg</a></span><span class="op" id="3881034">}</span><br>
<span class="lineno">1895</span><span class="op" id="3881036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3881039">//&nbsp;ErrHandlerTimeout&nbsp;is&nbsp;returned&nbsp;on&nbsp;ResponseWriter&nbsp;Write&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="3881102">//&nbsp;in&nbsp;handlers&nbsp;which&nbsp;have&nbsp;timed&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3881139">var</span>&nbsp;<span class="ident" id="3881143">ErrHandlerTimeout</span>&nbsp;<span class="op" id="3881161">=</span>&nbsp;<span class="ident" id="3881163"><a href="/net/http/server.go.html#3824767">errors</a></span><span class="op" id="3881169">.</span><span class="ident" id="3881170">New</span><span class="op" id="3881173">(</span><span class="string" id="3881174">&#34;http:&nbsp;Handler&nbsp;timeout&#34;</span><span class="op" id="3881197">)</span><br>
<span class="lineno">1900</span><br>
<span class="lineno"></span><span class="keyword" id="3881200">type</span>&nbsp;<span class="ident" id="3881205">timeoutHandler</span>&nbsp;<span class="keyword" id="3881220">struct</span>&nbsp;<span class="op" id="3881227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881230">handler</span>&nbsp;<span class="ident" id="3881238"><a href="/net/http/server.go.html#3825877">Handler</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881247">timeout</span>&nbsp;<span class="keyword" id="3881255">func</span><span class="op" id="3881259">(</span><span class="op" id="3881260">)</span>&nbsp;<span class="op" id="3881262">&lt;-</span><span class="keyword" id="3881264">chan</span>&nbsp;<span class="ident" id="3881269"><a href="/net/http/server.go.html#3824898">time</a></span><span class="op" id="3881273">.</span><span class="ident" id="3881274">Time</span>&nbsp;<span class="comment" id="3881279">//&nbsp;returns&nbsp;channel&nbsp;producing&nbsp;a&nbsp;timeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881319">body</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3881327">string</span><br>
<span class="lineno">1905</span><span class="op" id="3881334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3881337">func</span>&nbsp;<span class="op" id="3881342">(</span><span class="ident" id="3881343">h</span>&nbsp;<span class="op" id="3881345">*</span><span class="ident" id="3881346"><a href="/net/http/server.go.html#3881205">timeoutHandler</a></span><span class="op" id="3881360">)</span>&nbsp;<span class="ident" id="3881362">errorBody</span><span class="op" id="3881371">(</span><span class="op" id="3881372">)</span>&nbsp;<span class="builtintype" id="3881374">string</span>&nbsp;<span class="op" id="3881381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881384">if</span>&nbsp;<span class="ident" id="3881387"><a href="/net/http/server.go.html#3881343">h</a></span><span class="op" id="3881388">.</span><span class="ident" id="3881389">body</span>&nbsp;<span class="op" id="3881394">!=</span>&nbsp;<span class="string" id="3881397">&#34;&#34;</span>&nbsp;<span class="op" id="3881400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881404">return</span>&nbsp;<span class="ident" id="3881411"><a href="/net/http/server.go.html#3881343">h</a></span><span class="op" id="3881412">.</span><span class="ident" id="3881413">body</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3881419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881422">return</span>&nbsp;<span class="string" id="3881429">&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Timeout&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Timeout&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3881509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3881512">func</span>&nbsp;<span class="op" id="3881517">(</span><span class="ident" id="3881518">h</span>&nbsp;<span class="op" id="3881520">*</span><span class="ident" id="3881521"><a href="/net/http/server.go.html#3881205">timeoutHandler</a></span><span class="op" id="3881535">)</span>&nbsp;<span class="ident" id="3881537">ServeHTTP</span><span class="op" id="3881546">(</span><span class="ident" id="3881547">w</span>&nbsp;<span class="ident" id="3881549"><a href="/net/http/server.go.html#3826033">ResponseWriter</a></span><span class="op" id="3881563">,</span>&nbsp;<span class="ident" id="3881565">r</span>&nbsp;<span class="op" id="3881567">*</span><span class="ident" id="3881568"><a href="/net/http/request.go.html#3791418">Request</a></span><span class="op" id="3881575">)</span>&nbsp;<span class="op" id="3881577">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881580">done</span>&nbsp;<span class="op" id="3881585">:=</span>&nbsp;<span class="builtinfunc" id="3881588">make</span><span class="op" id="3881592">(</span><span class="keyword" id="3881593">chan</span>&nbsp;<span class="builtintype" id="3881598">bool</span><span class="op" id="3881602">,</span>&nbsp;<span class="num" id="3881604">1</span><span class="op" id="3881605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881608">tw</span>&nbsp;<span class="op" id="3881611">:=</span>&nbsp;<span class="op" id="3881614">&amp;</span><span class="ident" id="3881615"><a href="/net/http/server.go.html#3881931">timeoutWriter</a></span><span class="op" id="3881628">{</span><span class="ident" id="3881629">w</span><span class="op" id="3881630">:</span>&nbsp;<span class="ident" id="3881632"><a href="/net/http/server.go.html#3881547">w</a></span><span class="op" id="3881633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881636">go</span>&nbsp;<span class="keyword" id="3881639">func</span><span class="op" id="3881643">(</span><span class="op" id="3881644">)</span>&nbsp;<span class="op" id="3881646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881650"><a href="/net/http/server.go.html#3881518">h</a></span><span class="op" id="3881651">.</span><span class="ident" id="3881652">handler</span><span class="op" id="3881659">.</span><span class="ident" id="3881660">ServeHTTP</span><span class="op" id="3881669">(</span><span class="ident" id="3881670"><a href="/net/http/server.go.html#3881608">tw</a></span><span class="op" id="3881672">,</span>&nbsp;<span class="ident" id="3881674"><a href="/net/http/server.go.html#3881565">r</a></span><span class="op" id="3881675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881679"><a href="/net/http/server.go.html#3881580">done</a></span>&nbsp;<span class="op" id="3881684">&lt;-</span>&nbsp;<span class="ident" id="3881687">true</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3881693">}</span><span class="op" id="3881694">(</span><span class="op" id="3881695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881698">select</span>&nbsp;<span class="op" id="3881705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881708">case</span>&nbsp;<span class="op" id="3881713">&lt;-</span><span class="ident" id="3881715"><a href="/net/http/server.go.html#3881580">done</a></span><span class="op" id="3881719">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881723">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881731">case</span>&nbsp;<span class="op" id="3881736">&lt;-</span><span class="ident" id="3881738"><a href="/net/http/server.go.html#3881518">h</a></span><span class="op" id="3881739">.</span><span class="ident" id="3881740">timeout</span><span class="op" id="3881747">(</span><span class="op" id="3881748">)</span><span class="op" id="3881749">:</span><br>
<span class="lineno">1925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881753"><a href="/net/http/server.go.html#3881608">tw</a></span><span class="op" id="3881755">.</span><span class="ident" id="3881756">mu</span><span class="op" id="3881758">.</span><span class="ident" id="3881759">Lock</span><span class="op" id="3881763">(</span><span class="op" id="3881764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881768">defer</span>&nbsp;<span class="ident" id="3881774"><a href="/net/http/server.go.html#3881608">tw</a></span><span class="op" id="3881776">.</span><span class="ident" id="3881777">mu</span><span class="op" id="3881779">.</span><span class="ident" id="3881780">Unlock</span><span class="op" id="3881786">(</span><span class="op" id="3881787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3881791">if</span>&nbsp;<span class="op" id="3881794">!</span><span class="ident" id="3881795"><a href="/net/http/server.go.html#3881608">tw</a></span><span class="op" id="3881797">.</span><span class="ident" id="3881798">wroteHeader</span>&nbsp;<span class="op" id="3881810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881815"><a href="/net/http/server.go.html#3881608">tw</a></span><span class="op" id="3881817">.</span><span class="ident" id="3881818">w</span><span class="op" id="3881819">.</span><span class="ident" id="3881820">WriteHeader</span><span class="op" id="3881831">(</span><span class="ident" id="3881832"><a href="/net/http/status.go.html#3893041">StatusServiceUnavailable</a></span><span class="op" id="3881856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881861"><a href="/net/http/server.go.html#3881608">tw</a></span><span class="op" id="3881863">.</span><span class="ident" id="3881864">w</span><span class="op" id="3881865">.</span><span class="ident" id="3881866">Write</span><span class="op" id="3881871">(</span><span class="op" id="3881872">[</span><span class="op" id="3881873">]</span><span class="builtintype" id="3881874">byte</span><span class="op" id="3881878">(</span><span class="ident" id="3881879"><a href="/net/http/server.go.html#3881518">h</a></span><span class="op" id="3881880">.</span><span class="ident" id="3881881">errorBody</span><span class="op" id="3881890">(</span><span class="op" id="3881891">)</span><span class="op" id="3881892">)</span><span class="op" id="3881893">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3881897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881901"><a href="/net/http/server.go.html#3881608">tw</a></span><span class="op" id="3881903">.</span><span class="ident" id="3881904">timedOut</span>&nbsp;<span class="op" id="3881913">=</span>&nbsp;<span class="ident" id="3881915">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3881921">}</span><br>
<span class="lineno"></span><span class="op" id="3881923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1935</span><span class="keyword" id="3881926">type</span>&nbsp;<span class="ident" id="3881931">timeoutWriter</span>&nbsp;<span class="keyword" id="3881945">struct</span>&nbsp;<span class="op" id="3881952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881955">w</span>&nbsp;<span class="ident" id="3881957"><a href="/net/http/server.go.html#3826033">ResponseWriter</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881974">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3881986"><a href="/net/http/server.go.html#3824875">sync</a></span><span class="op" id="3881990">.</span><span class="ident" id="3881991">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3881998">timedOut</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3882010">bool</span><br>
<span class="lineno">1940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882016">wroteHeader</span>&nbsp;<span class="builtintype" id="3882028">bool</span><br>
<span class="lineno"></span><span class="op" id="3882033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3882036">func</span>&nbsp;<span class="op" id="3882041">(</span><span class="ident" id="3882042">tw</span>&nbsp;<span class="op" id="3882045">*</span><span class="ident" id="3882046"><a href="/net/http/server.go.html#3881931">timeoutWriter</a></span><span class="op" id="3882059">)</span>&nbsp;<span class="ident" id="3882061">Header</span><span class="op" id="3882067">(</span><span class="op" id="3882068">)</span>&nbsp;<span class="ident" id="3882070"><a href="/net/http/header.go.html#3781581">Header</a></span>&nbsp;<span class="op" id="3882077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882080">return</span>&nbsp;<span class="ident" id="3882087"><a href="/net/http/server.go.html#3882042">tw</a></span><span class="op" id="3882089">.</span><span class="ident" id="3882090">w</span><span class="op" id="3882091">.</span><span class="ident" id="3882092">Header</span><span class="op" id="3882098">(</span><span class="op" id="3882099">)</span><br>
<span class="lineno">1945</span><span class="op" id="3882101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3882104">func</span>&nbsp;<span class="op" id="3882109">(</span><span class="ident" id="3882110">tw</span>&nbsp;<span class="op" id="3882113">*</span><span class="ident" id="3882114"><a href="/net/http/server.go.html#3881931">timeoutWriter</a></span><span class="op" id="3882127">)</span>&nbsp;<span class="ident" id="3882129">Write</span><span class="op" id="3882134">(</span><span class="ident" id="3882135">p</span>&nbsp;<span class="op" id="3882137">[</span><span class="op" id="3882138">]</span><span class="builtintype" id="3882139">byte</span><span class="op" id="3882143">)</span>&nbsp;<span class="op" id="3882145">(</span><span class="builtintype" id="3882146">int</span><span class="op" id="3882149">,</span>&nbsp;<span class="builtintype" id="3882151">error</span><span class="op" id="3882156">)</span>&nbsp;<span class="op" id="3882158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882161"><a href="/net/http/server.go.html#3882110">tw</a></span><span class="op" id="3882163">.</span><span class="ident" id="3882164">mu</span><span class="op" id="3882166">.</span><span class="ident" id="3882167">Lock</span><span class="op" id="3882171">(</span><span class="op" id="3882172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882175">defer</span>&nbsp;<span class="ident" id="3882181"><a href="/net/http/server.go.html#3882110">tw</a></span><span class="op" id="3882183">.</span><span class="ident" id="3882184">mu</span><span class="op" id="3882186">.</span><span class="ident" id="3882187">Unlock</span><span class="op" id="3882193">(</span><span class="op" id="3882194">)</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882197"><a href="/net/http/server.go.html#3882110">tw</a></span><span class="op" id="3882199">.</span><span class="ident" id="3882200">wroteHeader</span>&nbsp;<span class="op" id="3882212">=</span>&nbsp;<span class="ident" id="3882214">true</span>&nbsp;<span class="comment" id="3882219">//&nbsp;implicitly&nbsp;at&nbsp;least</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882243">if</span>&nbsp;<span class="ident" id="3882246"><a href="/net/http/server.go.html#3882110">tw</a></span><span class="op" id="3882248">.</span><span class="ident" id="3882249">timedOut</span>&nbsp;<span class="op" id="3882258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882262">return</span>&nbsp;<span class="num" id="3882269">0</span><span class="op" id="3882270">,</span>&nbsp;<span class="ident" id="3882272"><a href="/net/http/server.go.html#3881143">ErrHandlerTimeout</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3882291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882294">return</span>&nbsp;<span class="ident" id="3882301"><a href="/net/http/server.go.html#3882110">tw</a></span><span class="op" id="3882303">.</span><span class="ident" id="3882304">w</span><span class="op" id="3882305">.</span><span class="ident" id="3882306">Write</span><span class="op" id="3882311">(</span><span class="ident" id="3882312"><a href="/net/http/server.go.html#3882135">p</a></span><span class="op" id="3882313">)</span><br>
<span class="lineno">1955</span><span class="op" id="3882315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3882318">func</span>&nbsp;<span class="op" id="3882323">(</span><span class="ident" id="3882324">tw</span>&nbsp;<span class="op" id="3882327">*</span><span class="ident" id="3882328"><a href="/net/http/server.go.html#3881931">timeoutWriter</a></span><span class="op" id="3882341">)</span>&nbsp;<span class="ident" id="3882343">WriteHeader</span><span class="op" id="3882354">(</span><span class="ident" id="3882355">code</span>&nbsp;<span class="builtintype" id="3882360">int</span><span class="op" id="3882363">)</span>&nbsp;<span class="op" id="3882365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882368"><a href="/net/http/server.go.html#3882324">tw</a></span><span class="op" id="3882370">.</span><span class="ident" id="3882371">mu</span><span class="op" id="3882373">.</span><span class="ident" id="3882374">Lock</span><span class="op" id="3882378">(</span><span class="op" id="3882379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882382">defer</span>&nbsp;<span class="ident" id="3882388"><a href="/net/http/server.go.html#3882324">tw</a></span><span class="op" id="3882390">.</span><span class="ident" id="3882391">mu</span><span class="op" id="3882393">.</span><span class="ident" id="3882394">Unlock</span><span class="op" id="3882400">(</span><span class="op" id="3882401">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882404">if</span>&nbsp;<span class="ident" id="3882407"><a href="/net/http/server.go.html#3882324">tw</a></span><span class="op" id="3882409">.</span><span class="ident" id="3882410">timedOut</span>&nbsp;<span class="op" id="3882419">||</span>&nbsp;<span class="ident" id="3882422"><a href="/net/http/server.go.html#3882324">tw</a></span><span class="op" id="3882424">.</span><span class="ident" id="3882425">wroteHeader</span>&nbsp;<span class="op" id="3882437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882441">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3882449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882452"><a href="/net/http/server.go.html#3882324">tw</a></span><span class="op" id="3882454">.</span><span class="ident" id="3882455">wroteHeader</span>&nbsp;<span class="op" id="3882467">=</span>&nbsp;<span class="ident" id="3882469">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882475"><a href="/net/http/server.go.html#3882324">tw</a></span><span class="op" id="3882477">.</span><span class="ident" id="3882478">w</span><span class="op" id="3882479">.</span><span class="ident" id="3882480">WriteHeader</span><span class="op" id="3882491">(</span><span class="ident" id="3882492"><a href="/net/http/server.go.html#3882355">code</a></span><span class="op" id="3882496">)</span><br>
<span class="lineno">1965</span><span class="op" id="3882498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3882501">//&nbsp;tcpKeepAliveListener&nbsp;sets&nbsp;TCP&nbsp;keep-alive&nbsp;timeouts&nbsp;on&nbsp;accepted</span><br>
<span class="lineno"></span><span class="comment" id="3882566">//&nbsp;connections.&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;ListenAndServe&nbsp;and&nbsp;ListenAndServeTLS&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="3882635">//&nbsp;dead&nbsp;TCP&nbsp;connections&nbsp;(e.g.&nbsp;closing&nbsp;laptop&nbsp;mid-download)&nbsp;eventually</span><br>
<span class="lineno">1970</span><span class="comment" id="3882705">//&nbsp;go&nbsp;away.</span><br>
<span class="lineno"></span><span class="keyword" id="3882717">type</span>&nbsp;<span class="ident" id="3882722">tcpKeepAliveListener</span>&nbsp;<span class="keyword" id="3882743">struct</span>&nbsp;<span class="op" id="3882750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3882753">*</span><span class="ident" id="3882754"><a href="/net/http/server.go.html#3824810">net</a></span><span class="op" id="3882757">.</span><span class="ident" id="3882758">TCPListener</span><br>
<span class="lineno"></span><span class="op" id="3882770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1975</span><span class="keyword" id="3882773">func</span>&nbsp;<span class="op" id="3882778">(</span><span class="ident" id="3882779">ln</span>&nbsp;<span class="ident" id="3882782"><a href="/net/http/server.go.html#3882722">tcpKeepAliveListener</a></span><span class="op" id="3882802">)</span>&nbsp;<span class="ident" id="3882804">Accept</span><span class="op" id="3882810">(</span><span class="op" id="3882811">)</span>&nbsp;<span class="op" id="3882813">(</span><span class="ident" id="3882814">c</span>&nbsp;<span class="ident" id="3882816"><a href="/net/http/server.go.html#3824810">net</a></span><span class="op" id="3882819">.</span><span class="ident" id="3882820">Conn</span><span class="op" id="3882824">,</span>&nbsp;<span class="ident" id="3882826">err</span>&nbsp;<span class="builtintype" id="3882830">error</span><span class="op" id="3882835">)</span>&nbsp;<span class="op" id="3882837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882840">tc</span><span class="op" id="3882842">,</span>&nbsp;<span class="ident" id="3882844"><a href="/net/http/server.go.html#3882826">err</a></span>&nbsp;<span class="op" id="3882848">:=</span>&nbsp;<span class="ident" id="3882851"><a href="/net/http/server.go.html#3882779">ln</a></span><span class="op" id="3882853">.</span><span class="ident" id="3882854">AcceptTCP</span><span class="op" id="3882863">(</span><span class="op" id="3882864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882867">if</span>&nbsp;<span class="ident" id="3882870"><a href="/net/http/server.go.html#3882826">err</a></span>&nbsp;<span class="op" id="3882874">!=</span>&nbsp;<span class="ident" id="3882877">nil</span>&nbsp;<span class="op" id="3882881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882885">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3882893">}</span><br>
<span class="lineno">1980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882896"><a href="/net/http/server.go.html#3882840">tc</a></span><span class="op" id="3882898">.</span><span class="ident" id="3882899">SetKeepAlive</span><span class="op" id="3882911">(</span><span class="ident" id="3882912">true</span><span class="op" id="3882916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3882919"><a href="/net/http/server.go.html#3882840">tc</a></span><span class="op" id="3882921">.</span><span class="ident" id="3882922">SetKeepAlivePeriod</span><span class="op" id="3882940">(</span><span class="num" id="3882941">3</span>&nbsp;<span class="op" id="3882943">*</span>&nbsp;<span class="ident" id="3882945"><a href="/net/http/server.go.html#3824898">time</a></span><span class="op" id="3882949">.</span><span class="ident" id="3882950">Minute</span><span class="op" id="3882956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3882959">return</span>&nbsp;<span class="ident" id="3882966"><a href="/net/http/server.go.html#3882840">tc</a></span><span class="op" id="3882968">,</span>&nbsp;<span class="ident" id="3882970">nil</span><br>
<span class="lineno"></span><span class="op" id="3882974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1985</span><span class="comment" id="3882977">//&nbsp;globalOptionsHandler&nbsp;responds&nbsp;to&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="3883035">type</span>&nbsp;<span class="ident" id="3883040">globalOptionsHandler</span>&nbsp;<span class="keyword" id="3883061">struct</span><span class="op" id="3883067">{</span><span class="op" id="3883068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3883071">func</span>&nbsp;<span class="op" id="3883076">(</span><span class="ident" id="3883077"><a href="/net/http/server.go.html#3883040">globalOptionsHandler</a></span><span class="op" id="3883097">)</span>&nbsp;<span class="ident" id="3883099">ServeHTTP</span><span class="op" id="3883108">(</span><span class="ident" id="3883109">w</span>&nbsp;<span class="ident" id="3883111"><a href="/net/http/server.go.html#3826033">ResponseWriter</a></span><span class="op" id="3883125">,</span>&nbsp;<span class="ident" id="3883127">r</span>&nbsp;<span class="op" id="3883129">*</span><span class="ident" id="3883130"><a href="/net/http/request.go.html#3791418">Request</a></span><span class="op" id="3883137">)</span>&nbsp;<span class="op" id="3883139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3883142"><a href="/net/http/server.go.html#3883109">w</a></span><span class="op" id="3883143">.</span><span class="ident" id="3883144">Header</span><span class="op" id="3883150">(</span><span class="op" id="3883151">)</span><span class="op" id="3883152">.</span><span class="ident" id="3883153">Set</span><span class="op" id="3883156">(</span><span class="string" id="3883157">&#34;Content-Length&#34;</span><span class="op" id="3883173">,</span>&nbsp;<span class="string" id="3883175">&#34;0&#34;</span><span class="op" id="3883178">)</span><br>
<span class="lineno">1990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3883181">if</span>&nbsp;<span class="ident" id="3883184"><a href="/net/http/server.go.html#3883127">r</a></span><span class="op" id="3883185">.</span><span class="ident" id="3883186">ContentLength</span>&nbsp;<span class="op" id="3883200">!=</span>&nbsp;<span class="num" id="3883203">0</span>&nbsp;<span class="op" id="3883205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3883209">//&nbsp;Read&nbsp;up&nbsp;to&nbsp;4KB&nbsp;of&nbsp;OPTIONS&nbsp;body&nbsp;(as&nbsp;mentioned&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3883266">//&nbsp;spec&nbsp;as&nbsp;being&nbsp;reserved&nbsp;for&nbsp;future&nbsp;use),&nbsp;but&nbsp;anything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3883324">//&nbsp;over&nbsp;that&nbsp;is&nbsp;considered&nbsp;a&nbsp;waste&nbsp;of&nbsp;server&nbsp;resources</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3883381">//&nbsp;(or&nbsp;an&nbsp;attack)&nbsp;and&nbsp;we&nbsp;abort&nbsp;and&nbsp;close&nbsp;the&nbsp;connection,</span><br>
<span class="lineno">1995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3883440">//&nbsp;courtesy&nbsp;of&nbsp;MaxBytesReader&#39;s&nbsp;EOF&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3883488">mb</span>&nbsp;<span class="op" id="3883491">:=</span>&nbsp;<span class="ident" id="3883494"><a href="/net/http/request.go.html#3810196">MaxBytesReader</a></span><span class="op" id="3883508">(</span><span class="ident" id="3883509"><a href="/net/http/server.go.html#3883109">w</a></span><span class="op" id="3883510">,</span>&nbsp;<span class="ident" id="3883512"><a href="/net/http/server.go.html#3883127">r</a></span><span class="op" id="3883513">.</span><span class="ident" id="3883514">Body</span><span class="op" id="3883518">,</span>&nbsp;<span class="num" id="3883520">4</span><span class="op" id="3883521">&lt;&lt;</span><span class="num" id="3883523">10</span><span class="op" id="3883525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3883529"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3883531">.</span><span class="ident" id="3883532">Copy</span><span class="op" id="3883536">(</span><span class="ident" id="3883537"><a href="/net/http/server.go.html#3824790">ioutil</a></span><span class="op" id="3883543">.</span><span class="ident" id="3883544">Discard</span><span class="op" id="3883551">,</span>&nbsp;<span class="ident" id="3883553"><a href="/net/http/server.go.html#3883488">mb</a></span><span class="op" id="3883555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3883558">}</span><br>
<span class="lineno"></span><span class="op" id="3883560">}</span><br>
<span class="lineno">2000</span><br>
<span class="lineno"></span><span class="keyword" id="3883563">type</span>&nbsp;<span class="ident" id="3883568">eofReaderWithWriteTo</span>&nbsp;<span class="keyword" id="3883589">struct</span><span class="op" id="3883595">{</span><span class="op" id="3883596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3883599">func</span>&nbsp;<span class="op" id="3883604">(</span><span class="ident" id="3883605"><a href="/net/http/server.go.html#3883568">eofReaderWithWriteTo</a></span><span class="op" id="3883625">)</span>&nbsp;<span class="ident" id="3883627">WriteTo</span><span class="op" id="3883634">(</span><span class="ident" id="3883635"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3883637">.</span><span class="ident" id="3883638">Writer</span><span class="op" id="3883644">)</span>&nbsp;<span class="op" id="3883646">(</span><span class="ident" id="3883647">int64</span><span class="op" id="3883652">,</span>&nbsp;<span class="builtintype" id="3883654">error</span><span class="op" id="3883659">)</span>&nbsp;<span class="op" id="3883661">{</span>&nbsp;<span class="keyword" id="3883663">return</span>&nbsp;<span class="num" id="3883670">0</span><span class="op" id="3883671">,</span>&nbsp;<span class="ident" id="3883673">nil</span>&nbsp;<span class="op" id="3883677">}</span><br>
<span class="lineno"></span><span class="keyword" id="3883679">func</span>&nbsp;<span class="op" id="3883684">(</span><span class="ident" id="3883685"><a href="/net/http/server.go.html#3883568">eofReaderWithWriteTo</a></span><span class="op" id="3883705">)</span>&nbsp;<span class="ident" id="3883707">Read</span><span class="op" id="3883711">(</span><span class="op" id="3883712">[</span><span class="op" id="3883713">]</span><span class="builtintype" id="3883714">byte</span><span class="op" id="3883718">)</span>&nbsp;<span class="op" id="3883720">(</span><span class="builtintype" id="3883721">int</span><span class="op" id="3883724">,</span>&nbsp;<span class="builtintype" id="3883726">error</span><span class="op" id="3883731">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3883741">{</span>&nbsp;<span class="keyword" id="3883743">return</span>&nbsp;<span class="num" id="3883750">0</span><span class="op" id="3883751">,</span>&nbsp;<span class="ident" id="3883753"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3883755">.</span><span class="ident" id="3883756">EOF</span>&nbsp;<span class="op" id="3883760">}</span><br>
<span class="lineno">2005</span><br>
<span class="lineno"></span><span class="comment" id="3883763">//&nbsp;eofReader&nbsp;is&nbsp;a&nbsp;non-nil&nbsp;io.ReadCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="comment" id="3883828">//&nbsp;It&nbsp;has&nbsp;a&nbsp;WriteTo&nbsp;method&nbsp;so&nbsp;io.Copy&nbsp;won&#39;t&nbsp;need&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3883887">var</span>&nbsp;<span class="ident" id="3883891">eofReader</span>&nbsp;<span class="op" id="3883901">=</span>&nbsp;<span class="op" id="3883903">&amp;</span><span class="keyword" id="3883904">struct</span>&nbsp;<span class="op" id="3883911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3883914"><a href="/net/http/server.go.html#3883568">eofReaderWithWriteTo</a></span><br>
<span class="lineno">2010</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3883936"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3883938">.</span><span class="ident" id="3883939">Closer</span><br>
<span class="lineno"></span><span class="op" id="3883946">}</span><span class="op" id="3883947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3883950"><a href="/net/http/server.go.html#3883568">eofReaderWithWriteTo</a></span><span class="op" id="3883970">{</span><span class="op" id="3883971">}</span><span class="op" id="3883972">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3883975"><a href="/net/http/server.go.html#3824790">ioutil</a></span><span class="op" id="3883981">.</span><span class="ident" id="3883982">NopCloser</span><span class="op" id="3883991">(</span><span class="ident" id="3883992">nil</span><span class="op" id="3883995">)</span><span class="op" id="3883996">,</span><br>
<span class="lineno"></span><span class="op" id="3883998">}</span><br>
<span class="lineno">2015</span><br>
<span class="lineno"></span><span class="comment" id="3884001">//&nbsp;Verify&nbsp;that&nbsp;an&nbsp;io.Copy&nbsp;from&nbsp;an&nbsp;eofReader&nbsp;won&#39;t&nbsp;require&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3884069">var</span>&nbsp;<span class="ident" id="3884073">_</span>&nbsp;<span class="ident" id="3884075"><a href="/net/http/server.go.html#3824784">io</a></span><span class="op" id="3884077">.</span><span class="ident" id="3884078">WriterTo</span>&nbsp;<span class="op" id="3884087">=</span>&nbsp;<span class="ident" id="3884089"><a href="/net/http/server.go.html#3883891">eofReader</a></span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3884100">//&nbsp;initNPNRequest&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;that&nbsp;initializes&nbsp;certain</span><br>
<span class="lineno">2020</span><span class="comment" id="3884162">//&nbsp;uninitialized&nbsp;fields&nbsp;in&nbsp;its&nbsp;*Request.&nbsp;Such&nbsp;partially-initialized</span><br>
<span class="lineno"></span><span class="comment" id="3884230">//&nbsp;Requests&nbsp;come&nbsp;from&nbsp;NPN&nbsp;protocol&nbsp;handlers.</span><br>
<span class="lineno"></span><span class="keyword" id="3884275">type</span>&nbsp;<span class="ident" id="3884280">initNPNRequest</span>&nbsp;<span class="keyword" id="3884295">struct</span>&nbsp;<span class="op" id="3884302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884305">c</span>&nbsp;<span class="op" id="3884307">*</span><span class="ident" id="3884308"><a href="/net/http/server.go.html#3824753">tls</a></span><span class="op" id="3884311">.</span><span class="ident" id="3884312">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884318">h</span>&nbsp;<span class="ident" id="3884320"><a href="/net/http/server.go.html#3875126">serverHandler</a></span><br>
<span class="lineno">2025</span><span class="op" id="3884334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3884337">func</span>&nbsp;<span class="op" id="3884342">(</span><span class="ident" id="3884343">h</span>&nbsp;<span class="ident" id="3884345"><a href="/net/http/server.go.html#3884280">initNPNRequest</a></span><span class="op" id="3884359">)</span>&nbsp;<span class="ident" id="3884361">ServeHTTP</span><span class="op" id="3884370">(</span><span class="ident" id="3884371">rw</span>&nbsp;<span class="ident" id="3884374"><a href="/net/http/server.go.html#3826033">ResponseWriter</a></span><span class="op" id="3884388">,</span>&nbsp;<span class="ident" id="3884390">req</span>&nbsp;<span class="op" id="3884394">*</span><span class="ident" id="3884395"><a href="/net/http/request.go.html#3791418">Request</a></span><span class="op" id="3884402">)</span>&nbsp;<span class="op" id="3884404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884407">if</span>&nbsp;<span class="ident" id="3884410"><a href="/net/http/server.go.html#3884390">req</a></span><span class="op" id="3884413">.</span><span class="ident" id="3884414">TLS</span>&nbsp;<span class="op" id="3884418">==</span>&nbsp;<span class="ident" id="3884421">nil</span>&nbsp;<span class="op" id="3884425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884429"><a href="/net/http/server.go.html#3884390">req</a></span><span class="op" id="3884432">.</span><span class="ident" id="3884433">TLS</span>&nbsp;<span class="op" id="3884437">=</span>&nbsp;<span class="op" id="3884439">&amp;</span><span class="ident" id="3884440"><a href="/net/http/server.go.html#3824753">tls</a></span><span class="op" id="3884443">.</span><span class="ident" id="3884444">ConnectionState</span><span class="op" id="3884459">{</span><span class="op" id="3884460">}</span><br>
<span class="lineno">2030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3884464">*</span><span class="ident" id="3884465"><a href="/net/http/server.go.html#3884390">req</a></span><span class="op" id="3884468">.</span><span class="ident" id="3884469">TLS</span>&nbsp;<span class="op" id="3884473">=</span>&nbsp;<span class="ident" id="3884475"><a href="/net/http/server.go.html#3884343">h</a></span><span class="op" id="3884476">.</span><span class="ident" id="3884477">c</span><span class="op" id="3884478">.</span><span class="ident" id="3884479">ConnectionState</span><span class="op" id="3884494">(</span><span class="op" id="3884495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3884498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884501">if</span>&nbsp;<span class="ident" id="3884504"><a href="/net/http/server.go.html#3884390">req</a></span><span class="op" id="3884507">.</span><span class="ident" id="3884508">Body</span>&nbsp;<span class="op" id="3884513">==</span>&nbsp;<span class="ident" id="3884516">nil</span>&nbsp;<span class="op" id="3884520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884524"><a href="/net/http/server.go.html#3884390">req</a></span><span class="op" id="3884527">.</span><span class="ident" id="3884528">Body</span>&nbsp;<span class="op" id="3884533">=</span>&nbsp;<span class="ident" id="3884535"><a href="/net/http/server.go.html#3883891">eofReader</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3884546">}</span><br>
<span class="lineno">2035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884549">if</span>&nbsp;<span class="ident" id="3884552"><a href="/net/http/server.go.html#3884390">req</a></span><span class="op" id="3884555">.</span><span class="ident" id="3884556">RemoteAddr</span>&nbsp;<span class="op" id="3884567">==</span>&nbsp;<span class="string" id="3884570">&#34;&#34;</span>&nbsp;<span class="op" id="3884573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884577"><a href="/net/http/server.go.html#3884390">req</a></span><span class="op" id="3884580">.</span><span class="ident" id="3884581">RemoteAddr</span>&nbsp;<span class="op" id="3884592">=</span>&nbsp;<span class="ident" id="3884594"><a href="/net/http/server.go.html#3884343">h</a></span><span class="op" id="3884595">.</span><span class="ident" id="3884596">c</span><span class="op" id="3884597">.</span><span class="ident" id="3884598">RemoteAddr</span><span class="op" id="3884608">(</span><span class="op" id="3884609">)</span><span class="op" id="3884610">.</span><span class="ident" id="3884611">String</span><span class="op" id="3884617">(</span><span class="op" id="3884618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3884621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884624"><a href="/net/http/server.go.html#3884343">h</a></span><span class="op" id="3884625">.</span><span class="ident" id="3884626">h</span><span class="op" id="3884627">.</span><span class="ident" id="3884628">ServeHTTP</span><span class="op" id="3884637">(</span><span class="ident" id="3884638"><a href="/net/http/server.go.html#3884371">rw</a></span><span class="op" id="3884640">,</span>&nbsp;<span class="ident" id="3884642"><a href="/net/http/server.go.html#3884390">req</a></span><span class="op" id="3884645">)</span><br>
<span class="lineno"></span><span class="op" id="3884647">}</span><br>
<span class="lineno">2040</span><br>
<span class="lineno"></span><span class="comment" id="3884650">//&nbsp;loggingConn&nbsp;is&nbsp;used&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="keyword" id="3884688">type</span>&nbsp;<span class="ident" id="3884693">loggingConn</span>&nbsp;<span class="keyword" id="3884705">struct</span>&nbsp;<span class="op" id="3884712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884715">name</span>&nbsp;<span class="builtintype" id="3884720">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884728"><a href="/net/http/server.go.html#3824810">net</a></span><span class="op" id="3884731">.</span><span class="ident" id="3884732">Conn</span><br>
<span class="lineno">2045</span><span class="op" id="3884737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3884740">var</span>&nbsp;<span class="op" id="3884744">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884747">uniqNameMu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3884760"><a href="/net/http/server.go.html#3824875">sync</a></span><span class="op" id="3884764">.</span><span class="ident" id="3884765">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884772">uniqNameNext</span>&nbsp;<span class="op" id="3884785">=</span>&nbsp;<span class="builtinfunc" id="3884787">make</span><span class="op" id="3884791">(</span><span class="keyword" id="3884792">map</span><span class="op" id="3884795">[</span><span class="builtintype" id="3884796">string</span><span class="op" id="3884802">]</span><span class="builtintype" id="3884803">int</span><span class="op" id="3884806">)</span><br>
<span class="lineno">2050</span><span class="op" id="3884808">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3884811">func</span>&nbsp;<span class="ident" id="3884816">newLoggingConn</span><span class="op" id="3884830">(</span><span class="ident" id="3884831">baseName</span>&nbsp;<span class="builtintype" id="3884840">string</span><span class="op" id="3884846">,</span>&nbsp;<span class="ident" id="3884848">c</span>&nbsp;<span class="ident" id="3884850"><a href="/net/http/server.go.html#3824810">net</a></span><span class="op" id="3884853">.</span><span class="ident" id="3884854">Conn</span><span class="op" id="3884858">)</span>&nbsp;<span class="ident" id="3884860"><a href="/net/http/server.go.html#3824810">net</a></span><span class="op" id="3884863">.</span><span class="ident" id="3884864">Conn</span>&nbsp;<span class="op" id="3884869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884872"><a href="/net/http/server.go.html#3884747">uniqNameMu</a></span><span class="op" id="3884882">.</span><span class="ident" id="3884883">Lock</span><span class="op" id="3884887">(</span><span class="op" id="3884888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884891">defer</span>&nbsp;<span class="ident" id="3884897"><a href="/net/http/server.go.html#3884747">uniqNameMu</a></span><span class="op" id="3884907">.</span><span class="ident" id="3884908">Unlock</span><span class="op" id="3884914">(</span><span class="op" id="3884915">)</span><br>
<span class="lineno">2055</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884918"><a href="/net/http/server.go.html#3884772">uniqNameNext</a></span><span class="op" id="3884930">[</span><span class="ident" id="3884931"><a href="/net/http/server.go.html#3884831">baseName</a></span><span class="op" id="3884939">]</span><span class="op" id="3884940">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3884944">return</span>&nbsp;<span class="op" id="3884951">&amp;</span><span class="ident" id="3884952"><a href="/net/http/server.go.html#3884693">loggingConn</a></span><span class="op" id="3884963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3884967">name</span><span class="op" id="3884971">:</span>&nbsp;<span class="ident" id="3884973"><a href="/net/http/server.go.html#3824777">fmt</a></span><span class="op" id="3884976">.</span><span class="ident" id="3884977">Sprintf</span><span class="op" id="3884984">(</span><span class="string" id="3884985">&#34;%s-%d&#34;</span><span class="op" id="3884992">,</span>&nbsp;<span class="ident" id="3884994"><a href="/net/http/server.go.html#3884831">baseName</a></span><span class="op" id="3885002">,</span>&nbsp;<span class="ident" id="3885004"><a href="/net/http/server.go.html#3884772">uniqNameNext</a></span><span class="op" id="3885016">[</span><span class="ident" id="3885017"><a href="/net/http/server.go.html#3884831">baseName</a></span><span class="op" id="3885025">]</span><span class="op" id="3885026">)</span><span class="op" id="3885027">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885031">Conn</span><span class="op" id="3885035">:</span>&nbsp;<span class="ident" id="3885037"><a href="/net/http/server.go.html#3884848">c</a></span><span class="op" id="3885038">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3885041">}</span><br>
<span class="lineno">2060</span><span class="op" id="3885043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3885046">func</span>&nbsp;<span class="op" id="3885051">(</span><span class="ident" id="3885052">c</span>&nbsp;<span class="op" id="3885054">*</span><span class="ident" id="3885055"><a href="/net/http/server.go.html#3884693">loggingConn</a></span><span class="op" id="3885066">)</span>&nbsp;<span class="ident" id="3885068">Write</span><span class="op" id="3885073">(</span><span class="ident" id="3885074">p</span>&nbsp;<span class="op" id="3885076">[</span><span class="op" id="3885077">]</span><span class="builtintype" id="3885078">byte</span><span class="op" id="3885082">)</span>&nbsp;<span class="op" id="3885084">(</span><span class="ident" id="3885085">n</span>&nbsp;<span class="builtintype" id="3885087">int</span><span class="op" id="3885090">,</span>&nbsp;<span class="ident" id="3885092">err</span>&nbsp;<span class="builtintype" id="3885096">error</span><span class="op" id="3885101">)</span>&nbsp;<span class="op" id="3885103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885106"><a href="/net/http/server.go.html#3824803">log</a></span><span class="op" id="3885109">.</span><span class="ident" id="3885110">Printf</span><span class="op" id="3885116">(</span><span class="string" id="3885117">&#34;%s.Write(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="3885138">,</span>&nbsp;<span class="ident" id="3885140"><a href="/net/http/server.go.html#3885052">c</a></span><span class="op" id="3885141">.</span><span class="ident" id="3885142">name</span><span class="op" id="3885146">,</span>&nbsp;<span class="builtinfunc" id="3885148">len</span><span class="op" id="3885151">(</span><span class="ident" id="3885152"><a href="/net/http/server.go.html#3885074">p</a></span><span class="op" id="3885153">)</span><span class="op" id="3885154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885157"><a href="/net/http/server.go.html#3885085">n</a></span><span class="op" id="3885158">,</span>&nbsp;<span class="ident" id="3885160"><a href="/net/http/server.go.html#3885092">err</a></span>&nbsp;<span class="op" id="3885164">=</span>&nbsp;<span class="ident" id="3885166"><a href="/net/http/server.go.html#3885052">c</a></span><span class="op" id="3885167">.</span><span class="ident" id="3885168">Conn</span><span class="op" id="3885172">.</span><span class="ident" id="3885173">Write</span><span class="op" id="3885178">(</span><span class="ident" id="3885179"><a href="/net/http/server.go.html#3885074">p</a></span><span class="op" id="3885180">)</span><br>
<span class="lineno">2065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885183"><a href="/net/http/server.go.html#3824803">log</a></span><span class="op" id="3885186">.</span><span class="ident" id="3885187">Printf</span><span class="op" id="3885193">(</span><span class="string" id="3885194">&#34;%s.Write(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="3885217">,</span>&nbsp;<span class="ident" id="3885219"><a href="/net/http/server.go.html#3885052">c</a></span><span class="op" id="3885220">.</span><span class="ident" id="3885221">name</span><span class="op" id="3885225">,</span>&nbsp;<span class="builtinfunc" id="3885227">len</span><span class="op" id="3885230">(</span><span class="ident" id="3885231"><a href="/net/http/server.go.html#3885074">p</a></span><span class="op" id="3885232">)</span><span class="op" id="3885233">,</span>&nbsp;<span class="ident" id="3885235"><a href="/net/http/server.go.html#3885085">n</a></span><span class="op" id="3885236">,</span>&nbsp;<span class="ident" id="3885238"><a href="/net/http/server.go.html#3885092">err</a></span><span class="op" id="3885241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885244">return</span><br>
<span class="lineno"></span><span class="op" id="3885251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3885254">func</span>&nbsp;<span class="op" id="3885259">(</span><span class="ident" id="3885260">c</span>&nbsp;<span class="op" id="3885262">*</span><span class="ident" id="3885263"><a href="/net/http/server.go.html#3884693">loggingConn</a></span><span class="op" id="3885274">)</span>&nbsp;<span class="ident" id="3885276">Read</span><span class="op" id="3885280">(</span><span class="ident" id="3885281">p</span>&nbsp;<span class="op" id="3885283">[</span><span class="op" id="3885284">]</span><span class="builtintype" id="3885285">byte</span><span class="op" id="3885289">)</span>&nbsp;<span class="op" id="3885291">(</span><span class="ident" id="3885292">n</span>&nbsp;<span class="builtintype" id="3885294">int</span><span class="op" id="3885297">,</span>&nbsp;<span class="ident" id="3885299">err</span>&nbsp;<span class="builtintype" id="3885303">error</span><span class="op" id="3885308">)</span>&nbsp;<span class="op" id="3885310">{</span><br>
<span class="lineno">2070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885313"><a href="/net/http/server.go.html#3824803">log</a></span><span class="op" id="3885316">.</span><span class="ident" id="3885317">Printf</span><span class="op" id="3885323">(</span><span class="string" id="3885324">&#34;%s.Read(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="3885344">,</span>&nbsp;<span class="ident" id="3885346"><a href="/net/http/server.go.html#3885260">c</a></span><span class="op" id="3885347">.</span><span class="ident" id="3885348">name</span><span class="op" id="3885352">,</span>&nbsp;<span class="builtinfunc" id="3885354">len</span><span class="op" id="3885357">(</span><span class="ident" id="3885358"><a href="/net/http/server.go.html#3885281">p</a></span><span class="op" id="3885359">)</span><span class="op" id="3885360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885363"><a href="/net/http/server.go.html#3885292">n</a></span><span class="op" id="3885364">,</span>&nbsp;<span class="ident" id="3885366"><a href="/net/http/server.go.html#3885299">err</a></span>&nbsp;<span class="op" id="3885370">=</span>&nbsp;<span class="ident" id="3885372"><a href="/net/http/server.go.html#3885260">c</a></span><span class="op" id="3885373">.</span><span class="ident" id="3885374">Conn</span><span class="op" id="3885378">.</span><span class="ident" id="3885379">Read</span><span class="op" id="3885383">(</span><span class="ident" id="3885384"><a href="/net/http/server.go.html#3885281">p</a></span><span class="op" id="3885385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885388"><a href="/net/http/server.go.html#3824803">log</a></span><span class="op" id="3885391">.</span><span class="ident" id="3885392">Printf</span><span class="op" id="3885398">(</span><span class="string" id="3885399">&#34;%s.Read(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="3885421">,</span>&nbsp;<span class="ident" id="3885423"><a href="/net/http/server.go.html#3885260">c</a></span><span class="op" id="3885424">.</span><span class="ident" id="3885425">name</span><span class="op" id="3885429">,</span>&nbsp;<span class="builtinfunc" id="3885431">len</span><span class="op" id="3885434">(</span><span class="ident" id="3885435"><a href="/net/http/server.go.html#3885281">p</a></span><span class="op" id="3885436">)</span><span class="op" id="3885437">,</span>&nbsp;<span class="ident" id="3885439"><a href="/net/http/server.go.html#3885292">n</a></span><span class="op" id="3885440">,</span>&nbsp;<span class="ident" id="3885442"><a href="/net/http/server.go.html#3885299">err</a></span><span class="op" id="3885445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885448">return</span><br>
<span class="lineno"></span><span class="op" id="3885455">}</span><br>
<span class="lineno">2075</span><br>
<span class="lineno"></span><span class="keyword" id="3885458">func</span>&nbsp;<span class="op" id="3885463">(</span><span class="ident" id="3885464">c</span>&nbsp;<span class="op" id="3885466">*</span><span class="ident" id="3885467"><a href="/net/http/server.go.html#3884693">loggingConn</a></span><span class="op" id="3885478">)</span>&nbsp;<span class="ident" id="3885480">Close</span><span class="op" id="3885485">(</span><span class="op" id="3885486">)</span>&nbsp;<span class="op" id="3885488">(</span><span class="ident" id="3885489">err</span>&nbsp;<span class="builtintype" id="3885493">error</span><span class="op" id="3885498">)</span>&nbsp;<span class="op" id="3885500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885503"><a href="/net/http/server.go.html#3824803">log</a></span><span class="op" id="3885506">.</span><span class="ident" id="3885507">Printf</span><span class="op" id="3885513">(</span><span class="string" id="3885514">&#34;%s.Close()&nbsp;=&nbsp;...&#34;</span><span class="op" id="3885532">,</span>&nbsp;<span class="ident" id="3885534"><a href="/net/http/server.go.html#3885464">c</a></span><span class="op" id="3885535">.</span><span class="ident" id="3885536">name</span><span class="op" id="3885540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885543"><a href="/net/http/server.go.html#3885489">err</a></span>&nbsp;<span class="op" id="3885547">=</span>&nbsp;<span class="ident" id="3885549"><a href="/net/http/server.go.html#3885464">c</a></span><span class="op" id="3885550">.</span><span class="ident" id="3885551">Conn</span><span class="op" id="3885555">.</span><span class="ident" id="3885556">Close</span><span class="op" id="3885561">(</span><span class="op" id="3885562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885565"><a href="/net/http/server.go.html#3824803">log</a></span><span class="op" id="3885568">.</span><span class="ident" id="3885569">Printf</span><span class="op" id="3885575">(</span><span class="string" id="3885576">&#34;%s.Close()&nbsp;=&nbsp;%v&#34;</span><span class="op" id="3885593">,</span>&nbsp;<span class="ident" id="3885595"><a href="/net/http/server.go.html#3885464">c</a></span><span class="op" id="3885596">.</span><span class="ident" id="3885597">name</span><span class="op" id="3885601">,</span>&nbsp;<span class="ident" id="3885603"><a href="/net/http/server.go.html#3885489">err</a></span><span class="op" id="3885606">)</span><br>
<span class="lineno">2080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3885609">return</span><br>
<span class="lineno"></span><span class="op" id="3885616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3885619">//&nbsp;checkConnErrorWriter&nbsp;writes&nbsp;to&nbsp;c.rwc&nbsp;and&nbsp;records&nbsp;any&nbsp;write&nbsp;errors&nbsp;to&nbsp;c.werr.</span><br>
<span class="lineno"></span><span class="comment" id="3885699">//&nbsp;It&nbsp;only&nbsp;contains&nbsp;one&nbsp;field&nbsp;(and&nbsp;a&nbsp;pointer&nbsp;field&nbsp;at&nbsp;that),&nbsp;so&nbsp;it</span><br>
<span class="lineno">2085</span><span class="comment" id="3885766">//&nbsp;fits&nbsp;in&nbsp;an&nbsp;interface&nbsp;value&nbsp;without&nbsp;an&nbsp;extra&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="3885825">type</span>&nbsp;<span class="ident" id="3885830">checkConnErrorWriter</span>&nbsp;<span class="keyword" id="3885851">struct</span>&nbsp;<span class="op" id="3885858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885861">c</span>&nbsp;<span class="op" id="3885863">*</span><span class="ident" id="3885864"><a href="/net/http/server.go.html#3828256">conn</a></span><br>
<span class="lineno"></span><span class="op" id="3885869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2090</span><span class="keyword" id="3885872">func</span>&nbsp;<span class="op" id="3885877">(</span><span class="ident" id="3885878">w</span>&nbsp;<span class="ident" id="3885880"><a href="/net/http/server.go.html#3885830">checkConnErrorWriter</a></span><span class="op" id="3885900">)</span>&nbsp;<span class="ident" id="3885902">Write</span><span class="op" id="3885907">(</span><span class="ident" id="3885908">p</span>&nbsp;<span class="op" id="3885910">[</span><span class="op" id="3885911">]</span><span class="builtintype" id="3885912">byte</span><span class="op" id="3885916">)</span>&nbsp;<span class="op" id="3885918">(</span><span class="ident" id="3885919">n</span>&nbsp;<span class="builtintype" id="3885921">int</span><span class="op" id="3885924">,</span>&nbsp;<span class="ident" id="3885926">err</span>&nbsp;<span class="builtintype" id="3885930">error</span><span class="op" id="3885935">)</span>&nbsp;<span class="op" id="3885937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3885940"><a href="/net/http/server.go.html#3885919">n</a></span><span class="op" id="3885941">,</span>&nbsp;<span class="ident" id="3885943"><a href="/net/http/server.go.html#3885926">err</a></span>&nbsp;<span class="op" id="3885947">=</span>&nbsp;<span class="ident" id="3885949"><a href="/net/http/server.go.html#3885878">w</a></span><span class="op" id="3885950">.</span><span class="ident" id="3885951">c</span><span class="op" id="3885952">.</span><span class="ident" id="3885953">w</span><span class="op" id="3885954">.</span><span class="ident" id="3885955">Write</span><span class="op" id="3885960">(</span><span class="ident" id="3885961"><a href="/net/http/server.go.html#3885908">p</a></span><span class="op" id="3885962">)</span>&nbsp;<span class="comment" id="3885964">//&nbsp;c.w&nbsp;==&nbsp;c.rwc,&nbsp;except&nbsp;after&nbsp;a&nbsp;hijack,&nbsp;when&nbsp;rwc&nbsp;is&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886022">if</span>&nbsp;<span class="ident" id="3886025"><a href="/net/http/server.go.html#3885926">err</a></span>&nbsp;<span class="op" id="3886029">!=</span>&nbsp;<span class="ident" id="3886032">nil</span>&nbsp;<span class="op" id="3886036">&amp;&amp;</span>&nbsp;<span class="ident" id="3886039"><a href="/net/http/server.go.html#3885878">w</a></span><span class="op" id="3886040">.</span><span class="ident" id="3886041">c</span><span class="op" id="3886042">.</span><span class="ident" id="3886043">werr</span>&nbsp;<span class="op" id="3886048">==</span>&nbsp;<span class="ident" id="3886051">nil</span>&nbsp;<span class="op" id="3886055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3886059"><a href="/net/http/server.go.html#3885878">w</a></span><span class="op" id="3886060">.</span><span class="ident" id="3886061">c</span><span class="op" id="3886062">.</span><span class="ident" id="3886063">werr</span>&nbsp;<span class="op" id="3886068">=</span>&nbsp;<span class="ident" id="3886070"><a href="/net/http/server.go.html#3885926">err</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3886075">}</span><br>
<span class="lineno">2095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3886078">return</span><br>
<span class="lineno"></span><span class="op" id="3886085">}</span>
</div>
</body>
</html>
