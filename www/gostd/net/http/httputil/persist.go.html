<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html" class="current">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3816569">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3816624">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3816678">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3816729">package</span>&nbsp;<span class="ident" id="3816737">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3816747">import</span>&nbsp;<span class="op" id="3816754">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3816757">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3816766">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3816776">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3816782">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3816789">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3816801">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3816818">&#34;sync&#34;</span><br>
<span class="lineno">15</span><span class="op" id="3816825">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3816828">var</span>&nbsp;<span class="op" id="3816832">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3816835">ErrPersistEOF</span>&nbsp;<span class="op" id="3816849">=</span>&nbsp;<span class="op" id="3816851">&amp;</span><span class="ident" id="3816852">http</span><span class="op" id="3816856">.</span><span class="ident" id="3816857">ProtocolError</span><span class="op" id="3816870">{</span><span class="ident" id="3816871">ErrorString</span><span class="op" id="3816882">:</span>&nbsp;<span class="string" id="3816884">&#34;persistent&nbsp;connection&nbsp;closed&#34;</span><span class="op" id="3816914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3816917">ErrClosed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3816931">=</span>&nbsp;<span class="op" id="3816933">&amp;</span><span class="ident" id="3816934">http</span><span class="op" id="3816938">.</span><span class="ident" id="3816939">ProtocolError</span><span class="op" id="3816952">{</span><span class="ident" id="3816953">ErrorString</span><span class="op" id="3816964">:</span>&nbsp;<span class="string" id="3816966">&#34;connection&nbsp;closed&nbsp;by&nbsp;user&#34;</span><span class="op" id="3816993">}</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3816996">ErrPipeline</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3817010">=</span>&nbsp;<span class="op" id="3817012">&amp;</span><span class="ident" id="3817013">http</span><span class="op" id="3817017">.</span><span class="ident" id="3817018">ProtocolError</span><span class="op" id="3817031">{</span><span class="ident" id="3817032">ErrorString</span><span class="op" id="3817043">:</span>&nbsp;<span class="string" id="3817045">&#34;pipeline&nbsp;error&#34;</span><span class="op" id="3817061">}</span><br>
<span class="lineno"></span><span class="op" id="3817063">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3817066">//&nbsp;This&nbsp;is&nbsp;an&nbsp;API&nbsp;usage&nbsp;error&nbsp;-&nbsp;the&nbsp;local&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="3817124">//&nbsp;ErrPersistEOF&nbsp;(above)&nbsp;reports&nbsp;that&nbsp;the&nbsp;remote&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno">25</span><span class="keyword" id="3817189">var</span>&nbsp;<span class="ident" id="3817193">errClosed</span>&nbsp;<span class="op" id="3817203">=</span>&nbsp;<span class="ident" id="3817205">errors</span><span class="op" id="3817211">.</span><span class="ident" id="3817212">New</span><span class="op" id="3817215">(</span><span class="string" id="3817216">&#34;i/o&nbsp;operation&nbsp;on&nbsp;closed&nbsp;connection&#34;</span><span class="op" id="3817252">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3817255">//&nbsp;A&nbsp;ServerConn&nbsp;reads&nbsp;requests&nbsp;and&nbsp;sends&nbsp;responses&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="3817325">//&nbsp;connection,&nbsp;until&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic&nbsp;commands&nbsp;an&nbsp;end.&nbsp;ServerConn</span><br>
<span class="lineno"></span><span class="comment" id="3817399">//&nbsp;also&nbsp;allows&nbsp;hijacking&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;by&nbsp;calling&nbsp;Hijack</span><br>
<span class="lineno">30</span><span class="comment" id="3817468">//&nbsp;to&nbsp;regain&nbsp;control&nbsp;over&nbsp;the&nbsp;connection.&nbsp;ServerConn&nbsp;supports&nbsp;pipe-lining,</span><br>
<span class="lineno"></span><span class="comment" id="3817543">//&nbsp;i.e.&nbsp;requests&nbsp;can&nbsp;be&nbsp;read&nbsp;out&nbsp;of&nbsp;sync&nbsp;(but&nbsp;in&nbsp;the&nbsp;same&nbsp;order)&nbsp;while&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3817618">//&nbsp;respective&nbsp;responses&nbsp;are&nbsp;sent.</span><br>
<span class="lineno"></span><span class="comment" id="3817652">//</span><br>
<span class="lineno"></span><span class="comment" id="3817655">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno">35</span><span class="comment" id="3817730">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="3817758">type</span>&nbsp;<span class="ident" id="3817763">ServerConn</span>&nbsp;<span class="keyword" id="3817774">struct</span>&nbsp;<span class="op" id="3817781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3817784">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3817800">sync</span><span class="op" id="3817804">.</span><span class="ident" id="3817805">Mutex</span>&nbsp;<span class="comment" id="3817811">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3817856">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3817872">net</span><span class="op" id="3817875">.</span><span class="ident" id="3817876">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3817882">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3817898">*</span><span class="ident" id="3817899">bufio</span><span class="op" id="3817904">.</span><span class="ident" id="3817905">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3817913">re</span><span class="op" id="3817915">,</span>&nbsp;<span class="ident" id="3817917">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3817929">error</span>&nbsp;<span class="comment" id="3817935">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3817957">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3817973">io</span><span class="op" id="3817975">.</span><span class="ident" id="3817976">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3817988">nread</span><span class="op" id="3817993">,</span>&nbsp;<span class="ident" id="3817995">nwritten</span>&nbsp;<span class="builtintype" id="3818004">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3818009">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3818025">map</span><span class="op" id="3818028">[</span><span class="op" id="3818029">*</span><span class="ident" id="3818030">http</span><span class="op" id="3818034">.</span><span class="ident" id="3818035">Request</span><span class="op" id="3818042">]</span><span class="builtintype" id="3818043">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3818050">pipe</span>&nbsp;<span class="ident" id="3818055">textproto</span><span class="op" id="3818064">.</span><span class="ident" id="3818065">Pipeline</span><br>
<span class="lineno"></span><span class="op" id="3818074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3818077">//&nbsp;NewServerConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServerConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="3818154">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno">50</span><span class="comment" id="3818202">//</span><br>
<span class="lineno"></span><span class="comment" id="3818205">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno"></span><span class="comment" id="3818280">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="3818308">func</span>&nbsp;<span class="ident" id="3818313">NewServerConn</span><span class="op" id="3818326">(</span><span class="ident" id="3818327">c</span>&nbsp;<span class="ident" id="3818329">net</span><span class="op" id="3818332">.</span><span class="ident" id="3818333">Conn</span><span class="op" id="3818337">,</span>&nbsp;<span class="ident" id="3818339">r</span>&nbsp;<span class="op" id="3818341">*</span><span class="ident" id="3818342">bufio</span><span class="op" id="3818347">.</span><span class="ident" id="3818348">Reader</span><span class="op" id="3818354">)</span>&nbsp;<span class="op" id="3818356">*</span><span class="ident" id="3818357">ServerConn</span>&nbsp;<span class="op" id="3818368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3818371">if</span>&nbsp;<span class="ident" id="3818374">r</span>&nbsp;<span class="op" id="3818376">==</span>&nbsp;<span class="builtintype" id="3818379">nil</span>&nbsp;<span class="op" id="3818383">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3818387">r</span>&nbsp;<span class="op" id="3818389">=</span>&nbsp;<span class="ident" id="3818391">bufio</span><span class="op" id="3818396">.</span><span class="ident" id="3818397">NewReader</span><span class="op" id="3818406">(</span><span class="ident" id="3818407">c</span><span class="op" id="3818408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3818411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3818414">return</span>&nbsp;<span class="op" id="3818421">&amp;</span><span class="ident" id="3818422">ServerConn</span><span class="op" id="3818432">{</span><span class="ident" id="3818433">c</span><span class="op" id="3818434">:</span>&nbsp;<span class="ident" id="3818436">c</span><span class="op" id="3818437">,</span>&nbsp;<span class="ident" id="3818439">r</span><span class="op" id="3818440">:</span>&nbsp;<span class="ident" id="3818442">r</span><span class="op" id="3818443">,</span>&nbsp;<span class="ident" id="3818445">pipereq</span><span class="op" id="3818452">:</span>&nbsp;<span class="builtinfunc" id="3818454">make</span><span class="op" id="3818458">(</span><span class="keyword" id="3818459">map</span><span class="op" id="3818462">[</span><span class="op" id="3818463">*</span><span class="ident" id="3818464">http</span><span class="op" id="3818468">.</span><span class="ident" id="3818469">Request</span><span class="op" id="3818476">]</span><span class="builtintype" id="3818477">uint</span><span class="op" id="3818481">)</span><span class="op" id="3818482">}</span><br>
<span class="lineno"></span><span class="op" id="3818484">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="3818487">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ServerConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="3818567">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3818643">//&nbsp;called&nbsp;before&nbsp;Read&nbsp;has&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive&nbsp;logic.&nbsp;The&nbsp;user</span><br>
<span class="lineno"></span><span class="comment" id="3818720">//&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="3818782">func</span>&nbsp;<span class="op" id="3818787">(</span><span class="ident" id="3818788">sc</span>&nbsp;<span class="op" id="3818791">*</span><span class="ident" id="3818792">ServerConn</span><span class="op" id="3818802">)</span>&nbsp;<span class="ident" id="3818804">Hijack</span><span class="op" id="3818810">(</span><span class="op" id="3818811">)</span>&nbsp;<span class="op" id="3818813">(</span><span class="ident" id="3818814">c</span>&nbsp;<span class="ident" id="3818816">net</span><span class="op" id="3818819">.</span><span class="ident" id="3818820">Conn</span><span class="op" id="3818824">,</span>&nbsp;<span class="ident" id="3818826">r</span>&nbsp;<span class="op" id="3818828">*</span><span class="ident" id="3818829">bufio</span><span class="op" id="3818834">.</span><span class="ident" id="3818835">Reader</span><span class="op" id="3818841">)</span>&nbsp;<span class="op" id="3818843">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3818846">sc</span><span class="op" id="3818848">.</span><span class="ident" id="3818849">lk</span><span class="op" id="3818851">.</span><span class="ident" id="3818852">Lock</span><span class="op" id="3818856">(</span><span class="op" id="3818857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3818860">defer</span>&nbsp;<span class="ident" id="3818866">sc</span><span class="op" id="3818868">.</span><span class="ident" id="3818869">lk</span><span class="op" id="3818871">.</span><span class="ident" id="3818872">Unlock</span><span class="op" id="3818878">(</span><span class="op" id="3818879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3818882">c</span>&nbsp;<span class="op" id="3818884">=</span>&nbsp;<span class="ident" id="3818886">sc</span><span class="op" id="3818888">.</span><span class="ident" id="3818889">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3818892">r</span>&nbsp;<span class="op" id="3818894">=</span>&nbsp;<span class="ident" id="3818896">sc</span><span class="op" id="3818898">.</span><span class="ident" id="3818899">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3818902">sc</span><span class="op" id="3818904">.</span><span class="ident" id="3818905">c</span>&nbsp;<span class="op" id="3818907">=</span>&nbsp;<span class="builtintype" id="3818909">nil</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3818914">sc</span><span class="op" id="3818916">.</span><span class="ident" id="3818917">r</span>&nbsp;<span class="op" id="3818919">=</span>&nbsp;<span class="builtintype" id="3818921">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3818926">return</span><br>
<span class="lineno"></span><span class="op" id="3818933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3818936">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">75</span><span class="keyword" id="3819005">func</span>&nbsp;<span class="op" id="3819010">(</span><span class="ident" id="3819011">sc</span>&nbsp;<span class="op" id="3819014">*</span><span class="ident" id="3819015">ServerConn</span><span class="op" id="3819025">)</span>&nbsp;<span class="ident" id="3819027">Close</span><span class="op" id="3819032">(</span><span class="op" id="3819033">)</span>&nbsp;<span class="builtintype" id="3819035">error</span>&nbsp;<span class="op" id="3819041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3819044">c</span><span class="op" id="3819045">,</span>&nbsp;<span class="ident" id="3819047">_</span>&nbsp;<span class="op" id="3819049">:=</span>&nbsp;<span class="ident" id="3819052">sc</span><span class="op" id="3819054">.</span><span class="ident" id="3819055">Hijack</span><span class="op" id="3819061">(</span><span class="op" id="3819062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3819065">if</span>&nbsp;<span class="ident" id="3819068">c</span>&nbsp;<span class="op" id="3819070">!=</span>&nbsp;<span class="builtintype" id="3819073">nil</span>&nbsp;<span class="op" id="3819077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3819081">return</span>&nbsp;<span class="ident" id="3819088">c</span><span class="op" id="3819089">.</span><span class="ident" id="3819090">Close</span><span class="op" id="3819095">(</span><span class="op" id="3819096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3819099">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3819102">return</span>&nbsp;<span class="builtintype" id="3819109">nil</span><br>
<span class="lineno"></span><span class="op" id="3819113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3819116">//&nbsp;Read&nbsp;returns&nbsp;the&nbsp;next&nbsp;request&nbsp;on&nbsp;the&nbsp;wire.&nbsp;An&nbsp;ErrPersistEOF&nbsp;is&nbsp;returned&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="3819194">//&nbsp;it&nbsp;is&nbsp;gracefully&nbsp;determined&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;requests&nbsp;(e.g.&nbsp;after&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="3819273">//&nbsp;first&nbsp;request&nbsp;on&nbsp;an&nbsp;HTTP/1.0&nbsp;connection,&nbsp;or&nbsp;after&nbsp;a&nbsp;Connection:close&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3819350">//&nbsp;HTTP/1.1&nbsp;connection).</span><br>
<span class="lineno"></span><span class="keyword" id="3819375">func</span>&nbsp;<span class="op" id="3819380">(</span><span class="ident" id="3819381">sc</span>&nbsp;<span class="op" id="3819384">*</span><span class="ident" id="3819385">ServerConn</span><span class="op" id="3819395">)</span>&nbsp;<span class="ident" id="3819397">Read</span><span class="op" id="3819401">(</span><span class="op" id="3819402">)</span>&nbsp;<span class="op" id="3819404">(</span><span class="ident" id="3819405">req</span>&nbsp;<span class="op" id="3819409">*</span><span class="ident" id="3819410">http</span><span class="op" id="3819414">.</span><span class="ident" id="3819415">Request</span><span class="op" id="3819422">,</span>&nbsp;<span class="ident" id="3819424">err</span>&nbsp;<span class="builtintype" id="3819428">error</span><span class="op" id="3819433">)</span>&nbsp;<span class="op" id="3819435">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3819439">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Reads&nbsp;and&nbsp;Writes</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3819488">id</span>&nbsp;<span class="op" id="3819491">:=</span>&nbsp;<span class="ident" id="3819494">sc</span><span class="op" id="3819496">.</span><span class="ident" id="3819497">pipe</span><span class="op" id="3819501">.</span><span class="ident" id="3819502">Next</span><span class="op" id="3819506">(</span><span class="op" id="3819507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3819510">sc</span><span class="op" id="3819512">.</span><span class="ident" id="3819513">pipe</span><span class="op" id="3819517">.</span><span class="ident" id="3819518">StartRequest</span><span class="op" id="3819530">(</span><span class="ident" id="3819531">id</span><span class="op" id="3819533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3819536">defer</span>&nbsp;<span class="keyword" id="3819542">func</span><span class="op" id="3819546">(</span><span class="op" id="3819547">)</span>&nbsp;<span class="op" id="3819549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3819553">sc</span><span class="op" id="3819555">.</span><span class="ident" id="3819556">pipe</span><span class="op" id="3819560">.</span><span class="ident" id="3819561">EndRequest</span><span class="op" id="3819571">(</span><span class="ident" id="3819572">id</span><span class="op" id="3819574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3819578">if</span>&nbsp;<span class="ident" id="3819581">req</span>&nbsp;<span class="op" id="3819585">==</span>&nbsp;<span class="builtintype" id="3819588">nil</span>&nbsp;<span class="op" id="3819592">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3819597">sc</span><span class="op" id="3819599">.</span><span class="ident" id="3819600">pipe</span><span class="op" id="3819604">.</span><span class="ident" id="3819605">StartResponse</span><span class="op" id="3819618">(</span><span class="ident" id="3819619">id</span><span class="op" id="3819621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3819626">sc</span><span class="op" id="3819628">.</span><span class="ident" id="3819629">pipe</span><span class="op" id="3819633">.</span><span class="ident" id="3819634">EndResponse</span><span class="op" id="3819645">(</span><span class="ident" id="3819646">id</span><span class="op" id="3819648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3819652">}</span>&nbsp;<span class="keyword" id="3819654">else</span>&nbsp;<span class="op" id="3819659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3819664">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3819711">sc</span><span class="op" id="3819713">.</span><span class="ident" id="3819714">lk</span><span class="op" id="3819716">.</span><span class="ident" id="3819717">Lock</span><span class="op" id="3819721">(</span><span class="op" id="3819722">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3819727">sc</span><span class="op" id="3819729">.</span><span class="ident" id="3819730">pipereq</span><span class="op" id="3819737">[</span><span class="ident" id="3819738">req</span><span class="op" id="3819741">]</span>&nbsp;<span class="op" id="3819743">=</span>&nbsp;<span class="ident" id="3819745">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3819751">sc</span><span class="op" id="3819753">.</span><span class="ident" id="3819754">lk</span><span class="op" id="3819756">.</span><span class="ident" id="3819757">Unlock</span><span class="op" id="3819763">(</span><span class="op" id="3819764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3819768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3819771">}</span><span class="op" id="3819772">(</span><span class="op" id="3819773">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3819777">sc</span><span class="op" id="3819779">.</span><span class="ident" id="3819780">lk</span><span class="op" id="3819782">.</span><span class="ident" id="3819783">Lock</span><span class="op" id="3819787">(</span><span class="op" id="3819788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3819791">if</span>&nbsp;<span class="ident" id="3819794">sc</span><span class="op" id="3819796">.</span><span class="ident" id="3819797">we</span>&nbsp;<span class="op" id="3819800">!=</span>&nbsp;<span class="builtintype" id="3819803">nil</span>&nbsp;<span class="op" id="3819807">{</span>&nbsp;<span class="comment" id="3819809">//&nbsp;no&nbsp;point&nbsp;receiving&nbsp;if&nbsp;write-side&nbsp;broken&nbsp;or&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3819864">defer</span>&nbsp;<span class="ident" id="3819870">sc</span><span class="op" id="3819872">.</span><span class="ident" id="3819873">lk</span><span class="op" id="3819875">.</span><span class="ident" id="3819876">Unlock</span><span class="op" id="3819882">(</span><span class="op" id="3819883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3819887">return</span>&nbsp;<span class="builtintype" id="3819894">nil</span><span class="op" id="3819897">,</span>&nbsp;<span class="ident" id="3819899">sc</span><span class="op" id="3819901">.</span><span class="ident" id="3819902">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3819906">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3819909">if</span>&nbsp;<span class="ident" id="3819912">sc</span><span class="op" id="3819914">.</span><span class="ident" id="3819915">re</span>&nbsp;<span class="op" id="3819918">!=</span>&nbsp;<span class="builtintype" id="3819921">nil</span>&nbsp;<span class="op" id="3819925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3819929">defer</span>&nbsp;<span class="ident" id="3819935">sc</span><span class="op" id="3819937">.</span><span class="ident" id="3819938">lk</span><span class="op" id="3819940">.</span><span class="ident" id="3819941">Unlock</span><span class="op" id="3819947">(</span><span class="op" id="3819948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3819952">return</span>&nbsp;<span class="builtintype" id="3819959">nil</span><span class="op" id="3819962">,</span>&nbsp;<span class="ident" id="3819964">sc</span><span class="op" id="3819966">.</span><span class="ident" id="3819967">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3819971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3819974">if</span>&nbsp;<span class="ident" id="3819977">sc</span><span class="op" id="3819979">.</span><span class="ident" id="3819980">r</span>&nbsp;<span class="op" id="3819982">==</span>&nbsp;<span class="builtintype" id="3819985">nil</span>&nbsp;<span class="op" id="3819989">{</span>&nbsp;<span class="comment" id="3819991">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3820038">defer</span>&nbsp;<span class="ident" id="3820044">sc</span><span class="op" id="3820046">.</span><span class="ident" id="3820047">lk</span><span class="op" id="3820049">.</span><span class="ident" id="3820050">Unlock</span><span class="op" id="3820056">(</span><span class="op" id="3820057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3820061">return</span>&nbsp;<span class="builtintype" id="3820068">nil</span><span class="op" id="3820071">,</span>&nbsp;<span class="ident" id="3820073">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3820084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3820087">r</span>&nbsp;<span class="op" id="3820089">:=</span>&nbsp;<span class="ident" id="3820092">sc</span><span class="op" id="3820094">.</span><span class="ident" id="3820095">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3820098">lastbody</span>&nbsp;<span class="op" id="3820107">:=</span>&nbsp;<span class="ident" id="3820110">sc</span><span class="op" id="3820112">.</span><span class="ident" id="3820113">lastbody</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3820123">sc</span><span class="op" id="3820125">.</span><span class="ident" id="3820126">lastbody</span>&nbsp;<span class="op" id="3820135">=</span>&nbsp;<span class="builtintype" id="3820137">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3820142">sc</span><span class="op" id="3820144">.</span><span class="ident" id="3820145">lk</span><span class="op" id="3820147">.</span><span class="ident" id="3820148">Unlock</span><span class="op" id="3820154">(</span><span class="op" id="3820155">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3820159">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3820235">if</span>&nbsp;<span class="ident" id="3820238">lastbody</span>&nbsp;<span class="op" id="3820247">!=</span>&nbsp;<span class="builtintype" id="3820250">nil</span>&nbsp;<span class="op" id="3820254">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3820258">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3820324">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3820382">//&nbsp;returned.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3820397">err</span>&nbsp;<span class="op" id="3820401">=</span>&nbsp;<span class="ident" id="3820403">lastbody</span><span class="op" id="3820411">.</span><span class="ident" id="3820412">Close</span><span class="op" id="3820417">(</span><span class="op" id="3820418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3820422">if</span>&nbsp;<span class="ident" id="3820425">err</span>&nbsp;<span class="op" id="3820429">!=</span>&nbsp;<span class="builtintype" id="3820432">nil</span>&nbsp;<span class="op" id="3820436">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3820441">sc</span><span class="op" id="3820443">.</span><span class="ident" id="3820444">lk</span><span class="op" id="3820446">.</span><span class="ident" id="3820447">Lock</span><span class="op" id="3820451">(</span><span class="op" id="3820452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3820457">defer</span>&nbsp;<span class="ident" id="3820463">sc</span><span class="op" id="3820465">.</span><span class="ident" id="3820466">lk</span><span class="op" id="3820468">.</span><span class="ident" id="3820469">Unlock</span><span class="op" id="3820475">(</span><span class="op" id="3820476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3820481">sc</span><span class="op" id="3820483">.</span><span class="ident" id="3820484">re</span>&nbsp;<span class="op" id="3820487">=</span>&nbsp;<span class="ident" id="3820489">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3820496">return</span>&nbsp;<span class="builtintype" id="3820503">nil</span><span class="op" id="3820506">,</span>&nbsp;<span class="ident" id="3820508">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3820514">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3820517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3820521">req</span><span class="op" id="3820524">,</span>&nbsp;<span class="ident" id="3820526">err</span>&nbsp;<span class="op" id="3820530">=</span>&nbsp;<span class="ident" id="3820532">http</span><span class="op" id="3820536">.</span><span class="ident" id="3820537">ReadRequest</span><span class="op" id="3820548">(</span><span class="ident" id="3820549">r</span><span class="op" id="3820550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3820553">sc</span><span class="op" id="3820555">.</span><span class="ident" id="3820556">lk</span><span class="op" id="3820558">.</span><span class="ident" id="3820559">Lock</span><span class="op" id="3820563">(</span><span class="op" id="3820564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3820567">defer</span>&nbsp;<span class="ident" id="3820573">sc</span><span class="op" id="3820575">.</span><span class="ident" id="3820576">lk</span><span class="op" id="3820578">.</span><span class="ident" id="3820579">Unlock</span><span class="op" id="3820585">(</span><span class="op" id="3820586">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3820589">if</span>&nbsp;<span class="ident" id="3820592">err</span>&nbsp;<span class="op" id="3820596">!=</span>&nbsp;<span class="builtintype" id="3820599">nil</span>&nbsp;<span class="op" id="3820603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3820607">if</span>&nbsp;<span class="ident" id="3820610">err</span>&nbsp;<span class="op" id="3820614">==</span>&nbsp;<span class="ident" id="3820617">io</span><span class="op" id="3820619">.</span><span class="ident" id="3820620">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="3820637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3820642">//&nbsp;A&nbsp;close&nbsp;from&nbsp;the&nbsp;opposing&nbsp;client&nbsp;is&nbsp;treated&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3820697">//&nbsp;graceful&nbsp;close,&nbsp;even&nbsp;if&nbsp;there&nbsp;was&nbsp;some&nbsp;unparse-able</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3820755">//&nbsp;data&nbsp;before&nbsp;the&nbsp;close.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3820784">sc</span><span class="op" id="3820786">.</span><span class="ident" id="3820787">re</span>&nbsp;<span class="op" id="3820790">=</span>&nbsp;<span class="ident" id="3820792">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3820809">return</span>&nbsp;<span class="builtintype" id="3820816">nil</span><span class="op" id="3820819">,</span>&nbsp;<span class="ident" id="3820821">sc</span><span class="op" id="3820823">.</span><span class="ident" id="3820824">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3820829">}</span>&nbsp;<span class="keyword" id="3820831">else</span>&nbsp;<span class="op" id="3820836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3820841">sc</span><span class="op" id="3820843">.</span><span class="ident" id="3820844">re</span>&nbsp;<span class="op" id="3820847">=</span>&nbsp;<span class="ident" id="3820849">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3820856">return</span>&nbsp;<span class="ident" id="3820863">req</span><span class="op" id="3820866">,</span>&nbsp;<span class="ident" id="3820868">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3820874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3820877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3820880">sc</span><span class="op" id="3820882">.</span><span class="ident" id="3820883">lastbody</span>&nbsp;<span class="op" id="3820892">=</span>&nbsp;<span class="ident" id="3820894">req</span><span class="op" id="3820897">.</span><span class="ident" id="3820898">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3820904">sc</span><span class="op" id="3820906">.</span><span class="ident" id="3820907">nread</span><span class="op" id="3820912">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3820916">if</span>&nbsp;<span class="ident" id="3820919">req</span><span class="op" id="3820922">.</span><span class="ident" id="3820923">Close</span>&nbsp;<span class="op" id="3820929">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3820933">sc</span><span class="op" id="3820935">.</span><span class="ident" id="3820936">re</span>&nbsp;<span class="op" id="3820939">=</span>&nbsp;<span class="ident" id="3820941">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3820957">return</span>&nbsp;<span class="ident" id="3820964">req</span><span class="op" id="3820967">,</span>&nbsp;<span class="ident" id="3820969">sc</span><span class="op" id="3820971">.</span><span class="ident" id="3820972">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3820976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3820979">return</span>&nbsp;<span class="ident" id="3820986">req</span><span class="op" id="3820989">,</span>&nbsp;<span class="ident" id="3820991">err</span><br>
<span class="lineno"></span><span class="op" id="3820995">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="3820998">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3821051">//&nbsp;that&nbsp;have&nbsp;been&nbsp;received&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3821097">func</span>&nbsp;<span class="op" id="3821102">(</span><span class="ident" id="3821103">sc</span>&nbsp;<span class="op" id="3821106">*</span><span class="ident" id="3821107">ServerConn</span><span class="op" id="3821117">)</span>&nbsp;<span class="ident" id="3821119">Pending</span><span class="op" id="3821126">(</span><span class="op" id="3821127">)</span>&nbsp;<span class="builtintype" id="3821129">int</span>&nbsp;<span class="op" id="3821133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3821136">sc</span><span class="op" id="3821138">.</span><span class="ident" id="3821139">lk</span><span class="op" id="3821141">.</span><span class="ident" id="3821142">Lock</span><span class="op" id="3821146">(</span><span class="op" id="3821147">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3821150">defer</span>&nbsp;<span class="ident" id="3821156">sc</span><span class="op" id="3821158">.</span><span class="ident" id="3821159">lk</span><span class="op" id="3821161">.</span><span class="ident" id="3821162">Unlock</span><span class="op" id="3821168">(</span><span class="op" id="3821169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3821172">return</span>&nbsp;<span class="ident" id="3821179">sc</span><span class="op" id="3821181">.</span><span class="ident" id="3821182">nread</span>&nbsp;<span class="op" id="3821188">-</span>&nbsp;<span class="ident" id="3821190">sc</span><span class="op" id="3821192">.</span><span class="ident" id="3821193">nwritten</span><br>
<span class="lineno"></span><span class="op" id="3821202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3821205">//&nbsp;Write&nbsp;writes&nbsp;resp&nbsp;in&nbsp;response&nbsp;to&nbsp;req.&nbsp;To&nbsp;close&nbsp;the&nbsp;connection&nbsp;gracefully,&nbsp;set&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="3821290">//&nbsp;Response.Close&nbsp;field&nbsp;to&nbsp;true.&nbsp;Write&nbsp;should&nbsp;be&nbsp;considered&nbsp;operational&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="3821368">//&nbsp;it&nbsp;returns&nbsp;an&nbsp;error,&nbsp;regardless&nbsp;of&nbsp;any&nbsp;errors&nbsp;returned&nbsp;on&nbsp;the&nbsp;Read&nbsp;side.</span><br>
<span class="lineno"></span><span class="keyword" id="3821444">func</span>&nbsp;<span class="op" id="3821449">(</span><span class="ident" id="3821450">sc</span>&nbsp;<span class="op" id="3821453">*</span><span class="ident" id="3821454">ServerConn</span><span class="op" id="3821464">)</span>&nbsp;<span class="ident" id="3821466">Write</span><span class="op" id="3821471">(</span><span class="ident" id="3821472">req</span>&nbsp;<span class="op" id="3821476">*</span><span class="ident" id="3821477">http</span><span class="op" id="3821481">.</span><span class="ident" id="3821482">Request</span><span class="op" id="3821489">,</span>&nbsp;<span class="ident" id="3821491">resp</span>&nbsp;<span class="op" id="3821496">*</span><span class="ident" id="3821497">http</span><span class="op" id="3821501">.</span><span class="ident" id="3821502">Response</span><span class="op" id="3821510">)</span>&nbsp;<span class="builtintype" id="3821512">error</span>&nbsp;<span class="op" id="3821518">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3821522">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3821581">sc</span><span class="op" id="3821583">.</span><span class="ident" id="3821584">lk</span><span class="op" id="3821586">.</span><span class="ident" id="3821587">Lock</span><span class="op" id="3821591">(</span><span class="op" id="3821592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3821595">id</span><span class="op" id="3821597">,</span>&nbsp;<span class="ident" id="3821599">ok</span>&nbsp;<span class="op" id="3821602">:=</span>&nbsp;<span class="ident" id="3821605">sc</span><span class="op" id="3821607">.</span><span class="ident" id="3821608">pipereq</span><span class="op" id="3821615">[</span><span class="ident" id="3821616">req</span><span class="op" id="3821619">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3821622">delete</span><span class="op" id="3821628">(</span><span class="ident" id="3821629">sc</span><span class="op" id="3821631">.</span><span class="ident" id="3821632">pipereq</span><span class="op" id="3821639">,</span>&nbsp;<span class="ident" id="3821641">req</span><span class="op" id="3821644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3821647">if</span>&nbsp;<span class="op" id="3821650">!</span><span class="ident" id="3821651">ok</span>&nbsp;<span class="op" id="3821654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3821658">sc</span><span class="op" id="3821660">.</span><span class="ident" id="3821661">lk</span><span class="op" id="3821663">.</span><span class="ident" id="3821664">Unlock</span><span class="op" id="3821670">(</span><span class="op" id="3821671">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3821675">return</span>&nbsp;<span class="ident" id="3821682">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3821695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3821698">sc</span><span class="op" id="3821700">.</span><span class="ident" id="3821701">lk</span><span class="op" id="3821703">.</span><span class="ident" id="3821704">Unlock</span><span class="op" id="3821710">(</span><span class="op" id="3821711">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3821715">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3821741">sc</span><span class="op" id="3821743">.</span><span class="ident" id="3821744">pipe</span><span class="op" id="3821748">.</span><span class="ident" id="3821749">StartResponse</span><span class="op" id="3821762">(</span><span class="ident" id="3821763">id</span><span class="op" id="3821765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3821768">defer</span>&nbsp;<span class="ident" id="3821774">sc</span><span class="op" id="3821776">.</span><span class="ident" id="3821777">pipe</span><span class="op" id="3821781">.</span><span class="ident" id="3821782">EndResponse</span><span class="op" id="3821793">(</span><span class="ident" id="3821794">id</span><span class="op" id="3821796">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3821800">sc</span><span class="op" id="3821802">.</span><span class="ident" id="3821803">lk</span><span class="op" id="3821805">.</span><span class="ident" id="3821806">Lock</span><span class="op" id="3821810">(</span><span class="op" id="3821811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3821814">if</span>&nbsp;<span class="ident" id="3821817">sc</span><span class="op" id="3821819">.</span><span class="ident" id="3821820">we</span>&nbsp;<span class="op" id="3821823">!=</span>&nbsp;<span class="builtintype" id="3821826">nil</span>&nbsp;<span class="op" id="3821830">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3821834">defer</span>&nbsp;<span class="ident" id="3821840">sc</span><span class="op" id="3821842">.</span><span class="ident" id="3821843">lk</span><span class="op" id="3821845">.</span><span class="ident" id="3821846">Unlock</span><span class="op" id="3821852">(</span><span class="op" id="3821853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3821857">return</span>&nbsp;<span class="ident" id="3821864">sc</span><span class="op" id="3821866">.</span><span class="ident" id="3821867">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3821871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3821874">if</span>&nbsp;<span class="ident" id="3821877">sc</span><span class="op" id="3821879">.</span><span class="ident" id="3821880">c</span>&nbsp;<span class="op" id="3821882">==</span>&nbsp;<span class="builtintype" id="3821885">nil</span>&nbsp;<span class="op" id="3821889">{</span>&nbsp;<span class="comment" id="3821891">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3821938">defer</span>&nbsp;<span class="ident" id="3821944">sc</span><span class="op" id="3821946">.</span><span class="ident" id="3821947">lk</span><span class="op" id="3821949">.</span><span class="ident" id="3821950">Unlock</span><span class="op" id="3821956">(</span><span class="op" id="3821957">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3821961">return</span>&nbsp;<span class="ident" id="3821968">ErrClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3821979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3821982">c</span>&nbsp;<span class="op" id="3821984">:=</span>&nbsp;<span class="ident" id="3821987">sc</span><span class="op" id="3821989">.</span><span class="ident" id="3821990">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3821993">if</span>&nbsp;<span class="ident" id="3821996">sc</span><span class="op" id="3821998">.</span><span class="ident" id="3821999">nread</span>&nbsp;<span class="op" id="3822005">&lt;=</span>&nbsp;<span class="ident" id="3822008">sc</span><span class="op" id="3822010">.</span><span class="ident" id="3822011">nwritten</span>&nbsp;<span class="op" id="3822020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3822024">defer</span>&nbsp;<span class="ident" id="3822030">sc</span><span class="op" id="3822032">.</span><span class="ident" id="3822033">lk</span><span class="op" id="3822035">.</span><span class="ident" id="3822036">Unlock</span><span class="op" id="3822042">(</span><span class="op" id="3822043">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3822047">return</span>&nbsp;<span class="ident" id="3822054">errors</span><span class="op" id="3822060">.</span><span class="ident" id="3822061">New</span><span class="op" id="3822064">(</span><span class="string" id="3822065">&#34;persist&nbsp;server&nbsp;pipe&nbsp;count&#34;</span><span class="op" id="3822092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3822095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3822098">if</span>&nbsp;<span class="ident" id="3822101">resp</span><span class="op" id="3822105">.</span><span class="ident" id="3822106">Close</span>&nbsp;<span class="op" id="3822112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3822116">//&nbsp;After&nbsp;signaling&nbsp;a&nbsp;keep-alive&nbsp;close,&nbsp;any&nbsp;pipelined&nbsp;unread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3822178">//&nbsp;requests&nbsp;will&nbsp;be&nbsp;lost.&nbsp;It&nbsp;is&nbsp;up&nbsp;to&nbsp;the&nbsp;user&nbsp;to&nbsp;drain&nbsp;them</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3822241">//&nbsp;before&nbsp;signaling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822264">sc</span><span class="op" id="3822266">.</span><span class="ident" id="3822267">re</span>&nbsp;<span class="op" id="3822270">=</span>&nbsp;<span class="ident" id="3822272">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3822287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822290">sc</span><span class="op" id="3822292">.</span><span class="ident" id="3822293">lk</span><span class="op" id="3822295">.</span><span class="ident" id="3822296">Unlock</span><span class="op" id="3822302">(</span><span class="op" id="3822303">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822307">err</span>&nbsp;<span class="op" id="3822311">:=</span>&nbsp;<span class="ident" id="3822314">resp</span><span class="op" id="3822318">.</span><span class="ident" id="3822319">Write</span><span class="op" id="3822324">(</span><span class="ident" id="3822325">c</span><span class="op" id="3822326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822329">sc</span><span class="op" id="3822331">.</span><span class="ident" id="3822332">lk</span><span class="op" id="3822334">.</span><span class="ident" id="3822335">Lock</span><span class="op" id="3822339">(</span><span class="op" id="3822340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3822343">defer</span>&nbsp;<span class="ident" id="3822349">sc</span><span class="op" id="3822351">.</span><span class="ident" id="3822352">lk</span><span class="op" id="3822354">.</span><span class="ident" id="3822355">Unlock</span><span class="op" id="3822361">(</span><span class="op" id="3822362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3822365">if</span>&nbsp;<span class="ident" id="3822368">err</span>&nbsp;<span class="op" id="3822372">!=</span>&nbsp;<span class="builtintype" id="3822375">nil</span>&nbsp;<span class="op" id="3822379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822383">sc</span><span class="op" id="3822385">.</span><span class="ident" id="3822386">we</span>&nbsp;<span class="op" id="3822389">=</span>&nbsp;<span class="ident" id="3822391">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3822397">return</span>&nbsp;<span class="ident" id="3822404">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3822409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822412">sc</span><span class="op" id="3822414">.</span><span class="ident" id="3822415">nwritten</span><span class="op" id="3822423">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3822428">return</span>&nbsp;<span class="builtintype" id="3822435">nil</span><br>
<span class="lineno">220</span><span class="op" id="3822439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3822442">//&nbsp;A&nbsp;ClientConn&nbsp;sends&nbsp;request&nbsp;and&nbsp;receives&nbsp;headers&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="3822512">//&nbsp;connection,&nbsp;while&nbsp;respecting&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic.&nbsp;ClientConn</span><br>
<span class="lineno"></span><span class="comment" id="3822581">//&nbsp;supports&nbsp;hijacking&nbsp;the&nbsp;connection&nbsp;calling&nbsp;Hijack&nbsp;to</span><br>
<span class="lineno">225</span><span class="comment" id="3822636">//&nbsp;regain&nbsp;control&nbsp;of&nbsp;the&nbsp;underlying&nbsp;net.Conn&nbsp;and&nbsp;deal&nbsp;with&nbsp;it&nbsp;as&nbsp;desired.</span><br>
<span class="lineno"></span><span class="comment" id="3822710">//</span><br>
<span class="lineno"></span><span class="comment" id="3822713">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="3822781">//&nbsp;Client&nbsp;or&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="3822829">type</span>&nbsp;<span class="ident" id="3822834">ClientConn</span>&nbsp;<span class="keyword" id="3822845">struct</span>&nbsp;<span class="op" id="3822852">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822855">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822871">sync</span><span class="op" id="3822875">.</span><span class="ident" id="3822876">Mutex</span>&nbsp;<span class="comment" id="3822882">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822927">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822943">net</span><span class="op" id="3822946">.</span><span class="ident" id="3822947">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822953">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3822969">*</span><span class="ident" id="3822970">bufio</span><span class="op" id="3822975">.</span><span class="ident" id="3822976">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3822984">re</span><span class="op" id="3822986">,</span>&nbsp;<span class="ident" id="3822988">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3823000">error</span>&nbsp;<span class="comment" id="3823006">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3823028">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3823044">io</span><span class="op" id="3823046">.</span><span class="ident" id="3823047">ReadCloser</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3823059">nread</span><span class="op" id="3823064">,</span>&nbsp;<span class="ident" id="3823066">nwritten</span>&nbsp;<span class="builtintype" id="3823075">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3823080">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823096">map</span><span class="op" id="3823099">[</span><span class="op" id="3823100">*</span><span class="ident" id="3823101">http</span><span class="op" id="3823105">.</span><span class="ident" id="3823106">Request</span><span class="op" id="3823113">]</span><span class="builtintype" id="3823114">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3823121">pipe</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3823130">textproto</span><span class="op" id="3823139">.</span><span class="ident" id="3823140">Pipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3823150">writeReq</span>&nbsp;<span class="keyword" id="3823159">func</span><span class="op" id="3823163">(</span><span class="op" id="3823164">*</span><span class="ident" id="3823165">http</span><span class="op" id="3823169">.</span><span class="ident" id="3823170">Request</span><span class="op" id="3823177">,</span>&nbsp;<span class="ident" id="3823179">io</span><span class="op" id="3823181">.</span><span class="ident" id="3823182">Writer</span><span class="op" id="3823188">)</span>&nbsp;<span class="builtintype" id="3823190">error</span><br>
<span class="lineno">240</span><span class="op" id="3823196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3823199">//&nbsp;NewClientConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ClientConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="3823277">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno"></span><span class="comment" id="3823325">//</span><br>
<span class="lineno">245</span><span class="comment" id="3823328">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;use&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3823398">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="3823436">func</span>&nbsp;<span class="ident" id="3823441">NewClientConn</span><span class="op" id="3823454">(</span><span class="ident" id="3823455">c</span>&nbsp;<span class="ident" id="3823457">net</span><span class="op" id="3823460">.</span><span class="ident" id="3823461">Conn</span><span class="op" id="3823465">,</span>&nbsp;<span class="ident" id="3823467">r</span>&nbsp;<span class="op" id="3823469">*</span><span class="ident" id="3823470">bufio</span><span class="op" id="3823475">.</span><span class="ident" id="3823476">Reader</span><span class="op" id="3823482">)</span>&nbsp;<span class="op" id="3823484">*</span><span class="ident" id="3823485">ClientConn</span>&nbsp;<span class="op" id="3823496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823499">if</span>&nbsp;<span class="ident" id="3823502">r</span>&nbsp;<span class="op" id="3823504">==</span>&nbsp;<span class="builtintype" id="3823507">nil</span>&nbsp;<span class="op" id="3823511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3823515">r</span>&nbsp;<span class="op" id="3823517">=</span>&nbsp;<span class="ident" id="3823519">bufio</span><span class="op" id="3823524">.</span><span class="ident" id="3823525">NewReader</span><span class="op" id="3823534">(</span><span class="ident" id="3823535">c</span><span class="op" id="3823536">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3823539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3823542">return</span>&nbsp;<span class="op" id="3823549">&amp;</span><span class="ident" id="3823550">ClientConn</span><span class="op" id="3823560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3823564">c</span><span class="op" id="3823565">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3823574">c</span><span class="op" id="3823575">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3823579">r</span><span class="op" id="3823580">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3823589">r</span><span class="op" id="3823590">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3823594">pipereq</span><span class="op" id="3823601">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="3823604">make</span><span class="op" id="3823608">(</span><span class="keyword" id="3823609">map</span><span class="op" id="3823612">[</span><span class="op" id="3823613">*</span><span class="ident" id="3823614">http</span><span class="op" id="3823618">.</span><span class="ident" id="3823619">Request</span><span class="op" id="3823626">]</span><span class="builtintype" id="3823627">uint</span><span class="op" id="3823631">)</span><span class="op" id="3823632">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3823636">writeReq</span><span class="op" id="3823644">:</span>&nbsp;<span class="op" id="3823646">(</span><span class="op" id="3823647">*</span><span class="ident" id="3823648">http</span><span class="op" id="3823652">.</span><span class="ident" id="3823653">Request</span><span class="op" id="3823660">)</span><span class="op" id="3823661">.</span><span class="ident" id="3823662">Write</span><span class="op" id="3823667">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3823670">}</span><br>
<span class="lineno"></span><span class="op" id="3823672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3823675">//&nbsp;NewProxyClientConn&nbsp;works&nbsp;like&nbsp;NewClientConn&nbsp;but&nbsp;writes&nbsp;Requests</span><br>
<span class="lineno">260</span><span class="comment" id="3823742">//&nbsp;using&nbsp;Request&#39;s&nbsp;WriteProxy&nbsp;method.</span><br>
<span class="lineno"></span><span class="comment" id="3823780">//</span><br>
<span class="lineno"></span><span class="comment" id="3823783">//&nbsp;New&nbsp;code&nbsp;should&nbsp;not&nbsp;use&nbsp;NewProxyClientConn.&nbsp;See&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3823844">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="3823890">func</span>&nbsp;<span class="ident" id="3823895">NewProxyClientConn</span><span class="op" id="3823913">(</span><span class="ident" id="3823914">c</span>&nbsp;<span class="ident" id="3823916">net</span><span class="op" id="3823919">.</span><span class="ident" id="3823920">Conn</span><span class="op" id="3823924">,</span>&nbsp;<span class="ident" id="3823926">r</span>&nbsp;<span class="op" id="3823928">*</span><span class="ident" id="3823929">bufio</span><span class="op" id="3823934">.</span><span class="ident" id="3823935">Reader</span><span class="op" id="3823941">)</span>&nbsp;<span class="op" id="3823943">*</span><span class="ident" id="3823944">ClientConn</span>&nbsp;<span class="op" id="3823955">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3823958">cc</span>&nbsp;<span class="op" id="3823961">:=</span>&nbsp;<span class="ident" id="3823964">NewClientConn</span><span class="op" id="3823977">(</span><span class="ident" id="3823978">c</span><span class="op" id="3823979">,</span>&nbsp;<span class="ident" id="3823981">r</span><span class="op" id="3823982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3823985">cc</span><span class="op" id="3823987">.</span><span class="ident" id="3823988">writeReq</span>&nbsp;<span class="op" id="3823997">=</span>&nbsp;<span class="op" id="3823999">(</span><span class="op" id="3824000">*</span><span class="ident" id="3824001">http</span><span class="op" id="3824005">.</span><span class="ident" id="3824006">Request</span><span class="op" id="3824013">)</span><span class="op" id="3824014">.</span><span class="ident" id="3824015">WriteProxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3824027">return</span>&nbsp;<span class="ident" id="3824034">cc</span><br>
<span class="lineno"></span><span class="op" id="3824037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="3824040">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ClientConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="3824120">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3824196">//&nbsp;called&nbsp;before&nbsp;the&nbsp;user&nbsp;or&nbsp;Read&nbsp;have&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive</span><br>
<span class="lineno"></span><span class="comment" id="3824270">//&nbsp;logic.&nbsp;The&nbsp;user&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="3824348">func</span>&nbsp;<span class="op" id="3824353">(</span><span class="ident" id="3824354">cc</span>&nbsp;<span class="op" id="3824357">*</span><span class="ident" id="3824358">ClientConn</span><span class="op" id="3824368">)</span>&nbsp;<span class="ident" id="3824370">Hijack</span><span class="op" id="3824376">(</span><span class="op" id="3824377">)</span>&nbsp;<span class="op" id="3824379">(</span><span class="ident" id="3824380">c</span>&nbsp;<span class="ident" id="3824382">net</span><span class="op" id="3824385">.</span><span class="ident" id="3824386">Conn</span><span class="op" id="3824390">,</span>&nbsp;<span class="ident" id="3824392">r</span>&nbsp;<span class="op" id="3824394">*</span><span class="ident" id="3824395">bufio</span><span class="op" id="3824400">.</span><span class="ident" id="3824401">Reader</span><span class="op" id="3824407">)</span>&nbsp;<span class="op" id="3824409">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3824412">cc</span><span class="op" id="3824414">.</span><span class="ident" id="3824415">lk</span><span class="op" id="3824417">.</span><span class="ident" id="3824418">Lock</span><span class="op" id="3824422">(</span><span class="op" id="3824423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3824426">defer</span>&nbsp;<span class="ident" id="3824432">cc</span><span class="op" id="3824434">.</span><span class="ident" id="3824435">lk</span><span class="op" id="3824437">.</span><span class="ident" id="3824438">Unlock</span><span class="op" id="3824444">(</span><span class="op" id="3824445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3824448">c</span>&nbsp;<span class="op" id="3824450">=</span>&nbsp;<span class="ident" id="3824452">cc</span><span class="op" id="3824454">.</span><span class="ident" id="3824455">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3824458">r</span>&nbsp;<span class="op" id="3824460">=</span>&nbsp;<span class="ident" id="3824462">cc</span><span class="op" id="3824464">.</span><span class="ident" id="3824465">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3824468">cc</span><span class="op" id="3824470">.</span><span class="ident" id="3824471">c</span>&nbsp;<span class="op" id="3824473">=</span>&nbsp;<span class="builtintype" id="3824475">nil</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3824480">cc</span><span class="op" id="3824482">.</span><span class="ident" id="3824483">r</span>&nbsp;<span class="op" id="3824485">=</span>&nbsp;<span class="builtintype" id="3824487">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3824492">return</span><br>
<span class="lineno"></span><span class="op" id="3824499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3824502">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">285</span><span class="keyword" id="3824571">func</span>&nbsp;<span class="op" id="3824576">(</span><span class="ident" id="3824577">cc</span>&nbsp;<span class="op" id="3824580">*</span><span class="ident" id="3824581">ClientConn</span><span class="op" id="3824591">)</span>&nbsp;<span class="ident" id="3824593">Close</span><span class="op" id="3824598">(</span><span class="op" id="3824599">)</span>&nbsp;<span class="builtintype" id="3824601">error</span>&nbsp;<span class="op" id="3824607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3824610">c</span><span class="op" id="3824611">,</span>&nbsp;<span class="ident" id="3824613">_</span>&nbsp;<span class="op" id="3824615">:=</span>&nbsp;<span class="ident" id="3824618">cc</span><span class="op" id="3824620">.</span><span class="ident" id="3824621">Hijack</span><span class="op" id="3824627">(</span><span class="op" id="3824628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3824631">if</span>&nbsp;<span class="ident" id="3824634">c</span>&nbsp;<span class="op" id="3824636">!=</span>&nbsp;<span class="builtintype" id="3824639">nil</span>&nbsp;<span class="op" id="3824643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3824647">return</span>&nbsp;<span class="ident" id="3824654">c</span><span class="op" id="3824655">.</span><span class="ident" id="3824656">Close</span><span class="op" id="3824661">(</span><span class="op" id="3824662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3824665">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3824668">return</span>&nbsp;<span class="builtintype" id="3824675">nil</span><br>
<span class="lineno"></span><span class="op" id="3824679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3824682">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;request.&nbsp;An&nbsp;ErrPersistEOF&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="3824762">//&nbsp;has&nbsp;been&nbsp;closed&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;keepalive&nbsp;sense.&nbsp;If&nbsp;req.Close&nbsp;equals&nbsp;true,&nbsp;the</span><br>
<span class="lineno">295</span><span class="comment" id="3824839">//&nbsp;keepalive&nbsp;connection&nbsp;is&nbsp;logically&nbsp;closed&nbsp;after&nbsp;this&nbsp;request&nbsp;and&nbsp;the&nbsp;opposing</span><br>
<span class="lineno"></span><span class="comment" id="3824919">//&nbsp;server&nbsp;is&nbsp;informed.&nbsp;An&nbsp;ErrUnexpectedEOF&nbsp;indicates&nbsp;the&nbsp;remote&nbsp;closed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3824994">//&nbsp;underlying&nbsp;TCP&nbsp;connection,&nbsp;which&nbsp;is&nbsp;usually&nbsp;considered&nbsp;as&nbsp;graceful&nbsp;close.</span><br>
<span class="lineno"></span><span class="keyword" id="3825071">func</span>&nbsp;<span class="op" id="3825076">(</span><span class="ident" id="3825077">cc</span>&nbsp;<span class="op" id="3825080">*</span><span class="ident" id="3825081">ClientConn</span><span class="op" id="3825091">)</span>&nbsp;<span class="ident" id="3825093">Write</span><span class="op" id="3825098">(</span><span class="ident" id="3825099">req</span>&nbsp;<span class="op" id="3825103">*</span><span class="ident" id="3825104">http</span><span class="op" id="3825108">.</span><span class="ident" id="3825109">Request</span><span class="op" id="3825116">)</span>&nbsp;<span class="op" id="3825118">(</span><span class="ident" id="3825119">err</span>&nbsp;<span class="builtintype" id="3825123">error</span><span class="op" id="3825128">)</span>&nbsp;<span class="op" id="3825130">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3825134">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825173">id</span>&nbsp;<span class="op" id="3825176">:=</span>&nbsp;<span class="ident" id="3825179">cc</span><span class="op" id="3825181">.</span><span class="ident" id="3825182">pipe</span><span class="op" id="3825186">.</span><span class="ident" id="3825187">Next</span><span class="op" id="3825191">(</span><span class="op" id="3825192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825195">cc</span><span class="op" id="3825197">.</span><span class="ident" id="3825198">pipe</span><span class="op" id="3825202">.</span><span class="ident" id="3825203">StartRequest</span><span class="op" id="3825215">(</span><span class="ident" id="3825216">id</span><span class="op" id="3825218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825221">defer</span>&nbsp;<span class="keyword" id="3825227">func</span><span class="op" id="3825231">(</span><span class="op" id="3825232">)</span>&nbsp;<span class="op" id="3825234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825238">cc</span><span class="op" id="3825240">.</span><span class="ident" id="3825241">pipe</span><span class="op" id="3825245">.</span><span class="ident" id="3825246">EndRequest</span><span class="op" id="3825256">(</span><span class="ident" id="3825257">id</span><span class="op" id="3825259">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825263">if</span>&nbsp;<span class="ident" id="3825266">err</span>&nbsp;<span class="op" id="3825270">!=</span>&nbsp;<span class="builtintype" id="3825273">nil</span>&nbsp;<span class="op" id="3825277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825282">cc</span><span class="op" id="3825284">.</span><span class="ident" id="3825285">pipe</span><span class="op" id="3825289">.</span><span class="ident" id="3825290">StartResponse</span><span class="op" id="3825303">(</span><span class="ident" id="3825304">id</span><span class="op" id="3825306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825311">cc</span><span class="op" id="3825313">.</span><span class="ident" id="3825314">pipe</span><span class="op" id="3825318">.</span><span class="ident" id="3825319">EndResponse</span><span class="op" id="3825330">(</span><span class="ident" id="3825331">id</span><span class="op" id="3825333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3825337">}</span>&nbsp;<span class="keyword" id="3825339">else</span>&nbsp;<span class="op" id="3825344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3825349">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825396">cc</span><span class="op" id="3825398">.</span><span class="ident" id="3825399">lk</span><span class="op" id="3825401">.</span><span class="ident" id="3825402">Lock</span><span class="op" id="3825406">(</span><span class="op" id="3825407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825412">cc</span><span class="op" id="3825414">.</span><span class="ident" id="3825415">pipereq</span><span class="op" id="3825422">[</span><span class="ident" id="3825423">req</span><span class="op" id="3825426">]</span>&nbsp;<span class="op" id="3825428">=</span>&nbsp;<span class="ident" id="3825430">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825436">cc</span><span class="op" id="3825438">.</span><span class="ident" id="3825439">lk</span><span class="op" id="3825441">.</span><span class="ident" id="3825442">Unlock</span><span class="op" id="3825448">(</span><span class="op" id="3825449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3825453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3825456">}</span><span class="op" id="3825457">(</span><span class="op" id="3825458">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825462">cc</span><span class="op" id="3825464">.</span><span class="ident" id="3825465">lk</span><span class="op" id="3825467">.</span><span class="ident" id="3825468">Lock</span><span class="op" id="3825472">(</span><span class="op" id="3825473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825476">if</span>&nbsp;<span class="ident" id="3825479">cc</span><span class="op" id="3825481">.</span><span class="ident" id="3825482">re</span>&nbsp;<span class="op" id="3825485">!=</span>&nbsp;<span class="builtintype" id="3825488">nil</span>&nbsp;<span class="op" id="3825492">{</span>&nbsp;<span class="comment" id="3825494">//&nbsp;no&nbsp;point&nbsp;sending&nbsp;if&nbsp;read-side&nbsp;closed&nbsp;or&nbsp;broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825546">defer</span>&nbsp;<span class="ident" id="3825552">cc</span><span class="op" id="3825554">.</span><span class="ident" id="3825555">lk</span><span class="op" id="3825557">.</span><span class="ident" id="3825558">Unlock</span><span class="op" id="3825564">(</span><span class="op" id="3825565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825569">return</span>&nbsp;<span class="ident" id="3825576">cc</span><span class="op" id="3825578">.</span><span class="ident" id="3825579">re</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3825583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825586">if</span>&nbsp;<span class="ident" id="3825589">cc</span><span class="op" id="3825591">.</span><span class="ident" id="3825592">we</span>&nbsp;<span class="op" id="3825595">!=</span>&nbsp;<span class="builtintype" id="3825598">nil</span>&nbsp;<span class="op" id="3825602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825606">defer</span>&nbsp;<span class="ident" id="3825612">cc</span><span class="op" id="3825614">.</span><span class="ident" id="3825615">lk</span><span class="op" id="3825617">.</span><span class="ident" id="3825618">Unlock</span><span class="op" id="3825624">(</span><span class="op" id="3825625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825629">return</span>&nbsp;<span class="ident" id="3825636">cc</span><span class="op" id="3825638">.</span><span class="ident" id="3825639">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3825643">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825646">if</span>&nbsp;<span class="ident" id="3825649">cc</span><span class="op" id="3825651">.</span><span class="ident" id="3825652">c</span>&nbsp;<span class="op" id="3825654">==</span>&nbsp;<span class="builtintype" id="3825657">nil</span>&nbsp;<span class="op" id="3825661">{</span>&nbsp;<span class="comment" id="3825663">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825710">defer</span>&nbsp;<span class="ident" id="3825716">cc</span><span class="op" id="3825718">.</span><span class="ident" id="3825719">lk</span><span class="op" id="3825721">.</span><span class="ident" id="3825722">Unlock</span><span class="op" id="3825728">(</span><span class="op" id="3825729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825733">return</span>&nbsp;<span class="ident" id="3825740">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3825751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825754">c</span>&nbsp;<span class="op" id="3825756">:=</span>&nbsp;<span class="ident" id="3825759">cc</span><span class="op" id="3825761">.</span><span class="ident" id="3825762">c</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825765">if</span>&nbsp;<span class="ident" id="3825768">req</span><span class="op" id="3825771">.</span><span class="ident" id="3825772">Close</span>&nbsp;<span class="op" id="3825778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3825782">//&nbsp;We&nbsp;write&nbsp;the&nbsp;EOF&nbsp;to&nbsp;the&nbsp;write-side&nbsp;error,&nbsp;because&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3825843">//&nbsp;still&nbsp;might&nbsp;be&nbsp;some&nbsp;pipelined&nbsp;reads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825884">cc</span><span class="op" id="3825886">.</span><span class="ident" id="3825887">we</span>&nbsp;<span class="op" id="3825890">=</span>&nbsp;<span class="ident" id="3825892">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3825907">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825910">cc</span><span class="op" id="3825912">.</span><span class="ident" id="3825913">lk</span><span class="op" id="3825915">.</span><span class="ident" id="3825916">Unlock</span><span class="op" id="3825922">(</span><span class="op" id="3825923">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825927">err</span>&nbsp;<span class="op" id="3825931">=</span>&nbsp;<span class="ident" id="3825933">cc</span><span class="op" id="3825935">.</span><span class="ident" id="3825936">writeReq</span><span class="op" id="3825944">(</span><span class="ident" id="3825945">req</span><span class="op" id="3825948">,</span>&nbsp;<span class="ident" id="3825950">c</span><span class="op" id="3825951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3825954">cc</span><span class="op" id="3825956">.</span><span class="ident" id="3825957">lk</span><span class="op" id="3825959">.</span><span class="ident" id="3825960">Lock</span><span class="op" id="3825964">(</span><span class="op" id="3825965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825968">defer</span>&nbsp;<span class="ident" id="3825974">cc</span><span class="op" id="3825976">.</span><span class="ident" id="3825977">lk</span><span class="op" id="3825979">.</span><span class="ident" id="3825980">Unlock</span><span class="op" id="3825986">(</span><span class="op" id="3825987">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3825990">if</span>&nbsp;<span class="ident" id="3825993">err</span>&nbsp;<span class="op" id="3825997">!=</span>&nbsp;<span class="builtintype" id="3826000">nil</span>&nbsp;<span class="op" id="3826004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3826008">cc</span><span class="op" id="3826010">.</span><span class="ident" id="3826011">we</span>&nbsp;<span class="op" id="3826014">=</span>&nbsp;<span class="ident" id="3826016">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3826022">return</span>&nbsp;<span class="ident" id="3826029">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3826034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3826037">cc</span><span class="op" id="3826039">.</span><span class="ident" id="3826040">nwritten</span><span class="op" id="3826048">++</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3826053">return</span>&nbsp;<span class="builtintype" id="3826060">nil</span><br>
<span class="lineno"></span><span class="op" id="3826064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3826067">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno">350</span><span class="comment" id="3826120">//&nbsp;that&nbsp;have&nbsp;been&nbsp;sent&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3826162">func</span>&nbsp;<span class="op" id="3826167">(</span><span class="ident" id="3826168">cc</span>&nbsp;<span class="op" id="3826171">*</span><span class="ident" id="3826172">ClientConn</span><span class="op" id="3826182">)</span>&nbsp;<span class="ident" id="3826184">Pending</span><span class="op" id="3826191">(</span><span class="op" id="3826192">)</span>&nbsp;<span class="builtintype" id="3826194">int</span>&nbsp;<span class="op" id="3826198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3826201">cc</span><span class="op" id="3826203">.</span><span class="ident" id="3826204">lk</span><span class="op" id="3826206">.</span><span class="ident" id="3826207">Lock</span><span class="op" id="3826211">(</span><span class="op" id="3826212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3826215">defer</span>&nbsp;<span class="ident" id="3826221">cc</span><span class="op" id="3826223">.</span><span class="ident" id="3826224">lk</span><span class="op" id="3826226">.</span><span class="ident" id="3826227">Unlock</span><span class="op" id="3826233">(</span><span class="op" id="3826234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3826237">return</span>&nbsp;<span class="ident" id="3826244">cc</span><span class="op" id="3826246">.</span><span class="ident" id="3826247">nwritten</span>&nbsp;<span class="op" id="3826256">-</span>&nbsp;<span class="ident" id="3826258">cc</span><span class="op" id="3826260">.</span><span class="ident" id="3826261">nread</span><br>
<span class="lineno">355</span><span class="op" id="3826267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3826270">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;next&nbsp;response&nbsp;from&nbsp;the&nbsp;wire.&nbsp;A&nbsp;valid&nbsp;response&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3826343">//&nbsp;returned&nbsp;together&nbsp;with&nbsp;an&nbsp;ErrPersistEOF,&nbsp;which&nbsp;means&nbsp;that&nbsp;the&nbsp;remote</span><br>
<span class="lineno"></span><span class="comment" id="3826415">//&nbsp;requested&nbsp;that&nbsp;this&nbsp;be&nbsp;the&nbsp;last&nbsp;request&nbsp;serviced.&nbsp;Read&nbsp;can&nbsp;be&nbsp;called</span><br>
<span class="lineno">360</span><span class="comment" id="3826487">//&nbsp;concurrently&nbsp;with&nbsp;Write,&nbsp;but&nbsp;not&nbsp;with&nbsp;another&nbsp;Read.</span><br>
<span class="lineno"></span><span class="keyword" id="3826542">func</span>&nbsp;<span class="op" id="3826547">(</span><span class="ident" id="3826548">cc</span>&nbsp;<span class="op" id="3826551">*</span><span class="ident" id="3826552">ClientConn</span><span class="op" id="3826562">)</span>&nbsp;<span class="ident" id="3826564">Read</span><span class="op" id="3826568">(</span><span class="ident" id="3826569">req</span>&nbsp;<span class="op" id="3826573">*</span><span class="ident" id="3826574">http</span><span class="op" id="3826578">.</span><span class="ident" id="3826579">Request</span><span class="op" id="3826586">)</span>&nbsp;<span class="op" id="3826588">(</span><span class="ident" id="3826589">resp</span>&nbsp;<span class="op" id="3826594">*</span><span class="ident" id="3826595">http</span><span class="op" id="3826599">.</span><span class="ident" id="3826600">Response</span><span class="op" id="3826608">,</span>&nbsp;<span class="ident" id="3826610">err</span>&nbsp;<span class="builtintype" id="3826614">error</span><span class="op" id="3826619">)</span>&nbsp;<span class="op" id="3826621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3826624">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3826683">cc</span><span class="op" id="3826685">.</span><span class="ident" id="3826686">lk</span><span class="op" id="3826688">.</span><span class="ident" id="3826689">Lock</span><span class="op" id="3826693">(</span><span class="op" id="3826694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3826697">id</span><span class="op" id="3826699">,</span>&nbsp;<span class="ident" id="3826701">ok</span>&nbsp;<span class="op" id="3826704">:=</span>&nbsp;<span class="ident" id="3826707">cc</span><span class="op" id="3826709">.</span><span class="ident" id="3826710">pipereq</span><span class="op" id="3826717">[</span><span class="ident" id="3826718">req</span><span class="op" id="3826721">]</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3826724">delete</span><span class="op" id="3826730">(</span><span class="ident" id="3826731">cc</span><span class="op" id="3826733">.</span><span class="ident" id="3826734">pipereq</span><span class="op" id="3826741">,</span>&nbsp;<span class="ident" id="3826743">req</span><span class="op" id="3826746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3826749">if</span>&nbsp;<span class="op" id="3826752">!</span><span class="ident" id="3826753">ok</span>&nbsp;<span class="op" id="3826756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3826760">cc</span><span class="op" id="3826762">.</span><span class="ident" id="3826763">lk</span><span class="op" id="3826765">.</span><span class="ident" id="3826766">Unlock</span><span class="op" id="3826772">(</span><span class="op" id="3826773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3826777">return</span>&nbsp;<span class="builtintype" id="3826784">nil</span><span class="op" id="3826787">,</span>&nbsp;<span class="ident" id="3826789">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3826802">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3826805">cc</span><span class="op" id="3826807">.</span><span class="ident" id="3826808">lk</span><span class="op" id="3826810">.</span><span class="ident" id="3826811">Unlock</span><span class="op" id="3826817">(</span><span class="op" id="3826818">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3826822">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3826848">cc</span><span class="op" id="3826850">.</span><span class="ident" id="3826851">pipe</span><span class="op" id="3826855">.</span><span class="ident" id="3826856">StartResponse</span><span class="op" id="3826869">(</span><span class="ident" id="3826870">id</span><span class="op" id="3826872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3826875">defer</span>&nbsp;<span class="ident" id="3826881">cc</span><span class="op" id="3826883">.</span><span class="ident" id="3826884">pipe</span><span class="op" id="3826888">.</span><span class="ident" id="3826889">EndResponse</span><span class="op" id="3826900">(</span><span class="ident" id="3826901">id</span><span class="op" id="3826903">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3826907">cc</span><span class="op" id="3826909">.</span><span class="ident" id="3826910">lk</span><span class="op" id="3826912">.</span><span class="ident" id="3826913">Lock</span><span class="op" id="3826917">(</span><span class="op" id="3826918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3826921">if</span>&nbsp;<span class="ident" id="3826924">cc</span><span class="op" id="3826926">.</span><span class="ident" id="3826927">re</span>&nbsp;<span class="op" id="3826930">!=</span>&nbsp;<span class="builtintype" id="3826933">nil</span>&nbsp;<span class="op" id="3826937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3826941">defer</span>&nbsp;<span class="ident" id="3826947">cc</span><span class="op" id="3826949">.</span><span class="ident" id="3826950">lk</span><span class="op" id="3826952">.</span><span class="ident" id="3826953">Unlock</span><span class="op" id="3826959">(</span><span class="op" id="3826960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3826964">return</span>&nbsp;<span class="builtintype" id="3826971">nil</span><span class="op" id="3826974">,</span>&nbsp;<span class="ident" id="3826976">cc</span><span class="op" id="3826978">.</span><span class="ident" id="3826979">re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3826983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3826986">if</span>&nbsp;<span class="ident" id="3826989">cc</span><span class="op" id="3826991">.</span><span class="ident" id="3826992">r</span>&nbsp;<span class="op" id="3826994">==</span>&nbsp;<span class="builtintype" id="3826997">nil</span>&nbsp;<span class="op" id="3827001">{</span>&nbsp;<span class="comment" id="3827003">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827050">defer</span>&nbsp;<span class="ident" id="3827056">cc</span><span class="op" id="3827058">.</span><span class="ident" id="3827059">lk</span><span class="op" id="3827061">.</span><span class="ident" id="3827062">Unlock</span><span class="op" id="3827068">(</span><span class="op" id="3827069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827073">return</span>&nbsp;<span class="builtintype" id="3827080">nil</span><span class="op" id="3827083">,</span>&nbsp;<span class="ident" id="3827085">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3827096">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827099">r</span>&nbsp;<span class="op" id="3827101">:=</span>&nbsp;<span class="ident" id="3827104">cc</span><span class="op" id="3827106">.</span><span class="ident" id="3827107">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827110">lastbody</span>&nbsp;<span class="op" id="3827119">:=</span>&nbsp;<span class="ident" id="3827122">cc</span><span class="op" id="3827124">.</span><span class="ident" id="3827125">lastbody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827135">cc</span><span class="op" id="3827137">.</span><span class="ident" id="3827138">lastbody</span>&nbsp;<span class="op" id="3827147">=</span>&nbsp;<span class="builtintype" id="3827149">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827154">cc</span><span class="op" id="3827156">.</span><span class="ident" id="3827157">lk</span><span class="op" id="3827159">.</span><span class="ident" id="3827160">Unlock</span><span class="op" id="3827166">(</span><span class="op" id="3827167">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3827171">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827247">if</span>&nbsp;<span class="ident" id="3827250">lastbody</span>&nbsp;<span class="op" id="3827259">!=</span>&nbsp;<span class="builtintype" id="3827262">nil</span>&nbsp;<span class="op" id="3827266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3827270">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3827336">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3827394">//&nbsp;returned.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827409">err</span>&nbsp;<span class="op" id="3827413">=</span>&nbsp;<span class="ident" id="3827415">lastbody</span><span class="op" id="3827423">.</span><span class="ident" id="3827424">Close</span><span class="op" id="3827429">(</span><span class="op" id="3827430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827434">if</span>&nbsp;<span class="ident" id="3827437">err</span>&nbsp;<span class="op" id="3827441">!=</span>&nbsp;<span class="builtintype" id="3827444">nil</span>&nbsp;<span class="op" id="3827448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827453">cc</span><span class="op" id="3827455">.</span><span class="ident" id="3827456">lk</span><span class="op" id="3827458">.</span><span class="ident" id="3827459">Lock</span><span class="op" id="3827463">(</span><span class="op" id="3827464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827469">defer</span>&nbsp;<span class="ident" id="3827475">cc</span><span class="op" id="3827477">.</span><span class="ident" id="3827478">lk</span><span class="op" id="3827480">.</span><span class="ident" id="3827481">Unlock</span><span class="op" id="3827487">(</span><span class="op" id="3827488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827493">cc</span><span class="op" id="3827495">.</span><span class="ident" id="3827496">re</span>&nbsp;<span class="op" id="3827499">=</span>&nbsp;<span class="ident" id="3827501">err</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827508">return</span>&nbsp;<span class="builtintype" id="3827515">nil</span><span class="op" id="3827518">,</span>&nbsp;<span class="ident" id="3827520">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3827526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3827529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827533">resp</span><span class="op" id="3827537">,</span>&nbsp;<span class="ident" id="3827539">err</span>&nbsp;<span class="op" id="3827543">=</span>&nbsp;<span class="ident" id="3827545">http</span><span class="op" id="3827549">.</span><span class="ident" id="3827550">ReadResponse</span><span class="op" id="3827562">(</span><span class="ident" id="3827563">r</span><span class="op" id="3827564">,</span>&nbsp;<span class="ident" id="3827566">req</span><span class="op" id="3827569">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827572">cc</span><span class="op" id="3827574">.</span><span class="ident" id="3827575">lk</span><span class="op" id="3827577">.</span><span class="ident" id="3827578">Lock</span><span class="op" id="3827582">(</span><span class="op" id="3827583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827586">defer</span>&nbsp;<span class="ident" id="3827592">cc</span><span class="op" id="3827594">.</span><span class="ident" id="3827595">lk</span><span class="op" id="3827597">.</span><span class="ident" id="3827598">Unlock</span><span class="op" id="3827604">(</span><span class="op" id="3827605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827608">if</span>&nbsp;<span class="ident" id="3827611">err</span>&nbsp;<span class="op" id="3827615">!=</span>&nbsp;<span class="builtintype" id="3827618">nil</span>&nbsp;<span class="op" id="3827622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827626">cc</span><span class="op" id="3827628">.</span><span class="ident" id="3827629">re</span>&nbsp;<span class="op" id="3827632">=</span>&nbsp;<span class="ident" id="3827634">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827640">return</span>&nbsp;<span class="ident" id="3827647">resp</span><span class="op" id="3827651">,</span>&nbsp;<span class="ident" id="3827653">err</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3827658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827661">cc</span><span class="op" id="3827663">.</span><span class="ident" id="3827664">lastbody</span>&nbsp;<span class="op" id="3827673">=</span>&nbsp;<span class="ident" id="3827675">resp</span><span class="op" id="3827679">.</span><span class="ident" id="3827680">Body</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827687">cc</span><span class="op" id="3827689">.</span><span class="ident" id="3827690">nread</span><span class="op" id="3827695">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827700">if</span>&nbsp;<span class="ident" id="3827703">resp</span><span class="op" id="3827707">.</span><span class="ident" id="3827708">Close</span>&nbsp;<span class="op" id="3827714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827718">cc</span><span class="op" id="3827720">.</span><span class="ident" id="3827721">re</span>&nbsp;<span class="op" id="3827724">=</span>&nbsp;<span class="ident" id="3827726">ErrPersistEOF</span>&nbsp;<span class="comment" id="3827740">//&nbsp;don&#39;t&nbsp;send&nbsp;any&nbsp;more&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827774">return</span>&nbsp;<span class="ident" id="3827781">resp</span><span class="op" id="3827785">,</span>&nbsp;<span class="ident" id="3827787">cc</span><span class="op" id="3827789">.</span><span class="ident" id="3827790">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3827794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827797">return</span>&nbsp;<span class="ident" id="3827804">resp</span><span class="op" id="3827808">,</span>&nbsp;<span class="ident" id="3827810">err</span><br>
<span class="lineno">420</span><span class="op" id="3827814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3827817">//&nbsp;Do&nbsp;is&nbsp;convenience&nbsp;method&nbsp;that&nbsp;writes&nbsp;a&nbsp;request&nbsp;and&nbsp;reads&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3827889">func</span>&nbsp;<span class="op" id="3827894">(</span><span class="ident" id="3827895">cc</span>&nbsp;<span class="op" id="3827898">*</span><span class="ident" id="3827899">ClientConn</span><span class="op" id="3827909">)</span>&nbsp;<span class="ident" id="3827911">Do</span><span class="op" id="3827913">(</span><span class="ident" id="3827914">req</span>&nbsp;<span class="op" id="3827918">*</span><span class="ident" id="3827919">http</span><span class="op" id="3827923">.</span><span class="ident" id="3827924">Request</span><span class="op" id="3827931">)</span>&nbsp;<span class="op" id="3827933">(</span><span class="ident" id="3827934">resp</span>&nbsp;<span class="op" id="3827939">*</span><span class="ident" id="3827940">http</span><span class="op" id="3827944">.</span><span class="ident" id="3827945">Response</span><span class="op" id="3827953">,</span>&nbsp;<span class="ident" id="3827955">err</span>&nbsp;<span class="builtintype" id="3827959">error</span><span class="op" id="3827964">)</span>&nbsp;<span class="op" id="3827966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3827969">err</span>&nbsp;<span class="op" id="3827973">=</span>&nbsp;<span class="ident" id="3827975">cc</span><span class="op" id="3827977">.</span><span class="ident" id="3827978">Write</span><span class="op" id="3827983">(</span><span class="ident" id="3827984">req</span><span class="op" id="3827987">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3827990">if</span>&nbsp;<span class="ident" id="3827993">err</span>&nbsp;<span class="op" id="3827997">!=</span>&nbsp;<span class="builtintype" id="3828000">nil</span>&nbsp;<span class="op" id="3828004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3828008">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3828016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3828019">return</span>&nbsp;<span class="ident" id="3828026">cc</span><span class="op" id="3828028">.</span><span class="ident" id="3828029">Read</span><span class="op" id="3828033">(</span><span class="ident" id="3828034">req</span><span class="op" id="3828037">)</span><br>
<span class="lineno"></span><span class="op" id="3828039">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
