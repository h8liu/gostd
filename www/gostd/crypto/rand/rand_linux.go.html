<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/rand</h2>
<ul>
<li><a href="/gostd/crypto/rand/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand.go.html">rand.go</a></li>
<li><a href="/gostd/crypto/rand/rand_linux.go.html" class="current">rand_linux.go</a></li>
<li><a href="/gostd/crypto/rand/rand_test.go.html">rand_test.go</a></li>
<li><a href="/gostd/crypto/rand/rand_unix.go.html">rand_unix.go</a></li>
<li><a href="/gostd/crypto/rand/util.go.html">util.go</a></li>
<li><a href="/gostd/crypto/rand/util_test.go.html">util_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3682803">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3682859">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3682913">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3682964">package</span>&nbsp;<span class="ident" id="3682972">rand</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3682978">import</span>&nbsp;<span class="op" id="3682985">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3682988">&#34;internal/syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3683008">&#34;sync&#34;</span><br>
<span class="lineno">10</span><span class="op" id="3683015">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3683018">func</span>&nbsp;<span class="ident" id="3683023">init</span><span class="op" id="3683027">(</span><span class="op" id="3683028">)</span>&nbsp;<span class="op" id="3683030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3683033">altGetRandom</span>&nbsp;<span class="op" id="3683046">=</span>&nbsp;<span class="ident" id="3683048">getRandomLinux</span><br>
<span class="lineno"></span><span class="op" id="3683063">}</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3683066">var</span>&nbsp;<span class="op" id="3683070">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3683073">once</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3683084">sync</span><span class="op" id="3683088">.</span><span class="ident" id="3683089">Once</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3683095">useSyscall</span>&nbsp;<span class="builtintype" id="3683106">bool</span><br>
<span class="lineno"></span><span class="op" id="3683111">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3683114">func</span>&nbsp;<span class="ident" id="3683119">pickStrategy</span><span class="op" id="3683131">(</span><span class="op" id="3683132">)</span>&nbsp;<span class="op" id="3683134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3683137">//&nbsp;Test&nbsp;whether&nbsp;we&nbsp;should&nbsp;use&nbsp;the&nbsp;system&nbsp;call&nbsp;or&nbsp;/dev/urandom.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3683201">//&nbsp;We&#39;ll&nbsp;fall&nbsp;back&nbsp;to&nbsp;urandom&nbsp;if:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3683236">//&nbsp;-&nbsp;the&nbsp;kernel&nbsp;is&nbsp;too&nbsp;old&nbsp;(before&nbsp;3.17)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3683278">//&nbsp;-&nbsp;the&nbsp;machine&nbsp;has&nbsp;no&nbsp;entropy&nbsp;available&nbsp;(early&nbsp;boot&nbsp;+&nbsp;no&nbsp;hardware</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3683347">//&nbsp;&nbsp;&nbsp;entropy&nbsp;source?)&nbsp;and&nbsp;we&nbsp;want&nbsp;to&nbsp;avoid&nbsp;blocking&nbsp;later.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3683407">var</span>&nbsp;<span class="ident" id="3683411">buf</span>&nbsp;<span class="op" id="3683415">[</span><span class="num" id="3683416">1</span><span class="op" id="3683417">]</span><span class="builtintype" id="3683418">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3683424">n</span><span class="op" id="3683425">,</span>&nbsp;<span class="ident" id="3683427">err</span>&nbsp;<span class="op" id="3683431">:=</span>&nbsp;<span class="ident" id="3683434">syscall</span><span class="op" id="3683441">.</span><span class="ident" id="3683442">GetRandom</span><span class="op" id="3683451">(</span><span class="ident" id="3683452">buf</span><span class="op" id="3683455">[</span><span class="op" id="3683456">:</span><span class="op" id="3683457">]</span><span class="op" id="3683458">,</span>&nbsp;<span class="ident" id="3683460">syscall</span><span class="op" id="3683467">.</span><span class="ident" id="3683468">GRND_NONBLOCK</span><span class="op" id="3683481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3683484">useSyscall</span>&nbsp;<span class="op" id="3683495">=</span>&nbsp;<span class="ident" id="3683497">n</span>&nbsp;<span class="op" id="3683499">==</span>&nbsp;<span class="num" id="3683502">1</span>&nbsp;<span class="op" id="3683504">&amp;&amp;</span>&nbsp;<span class="ident" id="3683507">err</span>&nbsp;<span class="op" id="3683511">==</span>&nbsp;<span class="ident" id="3683514">nil</span><br>
<span class="lineno">30</span><span class="op" id="3683518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3683521">func</span>&nbsp;<span class="ident" id="3683526">getRandomLinux</span><span class="op" id="3683540">(</span><span class="ident" id="3683541">p</span>&nbsp;<span class="op" id="3683543">[</span><span class="op" id="3683544">]</span><span class="builtintype" id="3683545">byte</span><span class="op" id="3683549">)</span>&nbsp;<span class="op" id="3683551">(</span><span class="ident" id="3683552">ok</span>&nbsp;<span class="builtintype" id="3683555">bool</span><span class="op" id="3683559">)</span>&nbsp;<span class="op" id="3683561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3683564">once</span><span class="op" id="3683568">.</span><span class="ident" id="3683569">Do</span><span class="op" id="3683571">(</span><span class="ident" id="3683572">pickStrategy</span><span class="op" id="3683584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3683587">if</span>&nbsp;<span class="op" id="3683590">!</span><span class="ident" id="3683591">useSyscall</span>&nbsp;<span class="op" id="3683602">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3683606">return</span>&nbsp;<span class="builtintype" id="3683613">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3683620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3683623">n</span><span class="op" id="3683624">,</span>&nbsp;<span class="ident" id="3683626">err</span>&nbsp;<span class="op" id="3683630">:=</span>&nbsp;<span class="ident" id="3683633">syscall</span><span class="op" id="3683640">.</span><span class="ident" id="3683641">GetRandom</span><span class="op" id="3683650">(</span><span class="ident" id="3683651">p</span><span class="op" id="3683652">,</span>&nbsp;<span class="num" id="3683654">0</span><span class="op" id="3683655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3683658">return</span>&nbsp;<span class="ident" id="3683665">n</span>&nbsp;<span class="op" id="3683667">==</span>&nbsp;<span class="builtinfunc" id="3683670">len</span><span class="op" id="3683673">(</span><span class="ident" id="3683674">p</span><span class="op" id="3683675">)</span>&nbsp;<span class="op" id="3683677">&amp;&amp;</span>&nbsp;<span class="ident" id="3683680">err</span>&nbsp;<span class="op" id="3683684">==</span>&nbsp;<span class="ident" id="3683687">nil</span><br>
<span class="lineno"></span><span class="op" id="3683691">}</span>
</div>
</body>
</html>
