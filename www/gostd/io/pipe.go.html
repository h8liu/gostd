<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>io</h2>
<ul>
<li><a href="/gostd/io/io.go.html">io.go</a></li>
<li><a href="/gostd/io/io_test.go.html">io_test.go</a></li>
<li><a href="/gostd/io/multi.go.html">multi.go</a></li>
<li><a href="/gostd/io/multi_test.go.html">multi_test.go</a></li>
<li><a href="/gostd/io/pipe.go.html" class="current">pipe.go</a></li>
<li><a href="/gostd/io/pipe_test.go.html">pipe_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1382596">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1382651">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1382705">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1382756">//&nbsp;Pipe&nbsp;adapter&nbsp;to&nbsp;connect&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Reader</span><br>
<span class="lineno"></span><span class="comment" id="1382811">//&nbsp;with&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1382849">package</span>&nbsp;<span class="ident" id="1382857">io</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="1382861">import</span>&nbsp;<span class="op" id="1382868">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1382871">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1382881">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="1382888">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="1382891">//&nbsp;ErrClosedPipe&nbsp;is&nbsp;the&nbsp;error&nbsp;used&nbsp;for&nbsp;read&nbsp;or&nbsp;write&nbsp;operations&nbsp;on&nbsp;a&nbsp;closed&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1382973">var</span>&nbsp;<span class="ident" id="1382977">ErrClosedPipe</span>&nbsp;<span class="op" id="1382991">=</span>&nbsp;<span class="ident" id="1382993">errors</span><span class="op" id="1382999">.</span><span class="ident" id="1383000">New</span><span class="op" id="1383003">(</span><span class="string" id="1383004">&#34;io:&nbsp;read/write&nbsp;on&nbsp;closed&nbsp;pipe&#34;</span><span class="op" id="1383035">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1383038">type</span>&nbsp;<span class="ident" id="1383043">pipeResult</span>&nbsp;<span class="keyword" id="1383054">struct</span>&nbsp;<span class="op" id="1383061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1383064">n</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1383068">int</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1383073">err</span>&nbsp;<span class="builtintype" id="1383077">error</span><br>
<span class="lineno"></span><span class="op" id="1383083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1383086">//&nbsp;A&nbsp;pipe&nbsp;is&nbsp;the&nbsp;shared&nbsp;pipe&nbsp;structure&nbsp;underlying&nbsp;PipeReader&nbsp;and&nbsp;PipeWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="1383163">type</span>&nbsp;<span class="ident" id="1383168">pipe</span>&nbsp;<span class="keyword" id="1383173">struct</span>&nbsp;<span class="op" id="1383180">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1383183">rl</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1383189">sync</span><span class="op" id="1383193">.</span><span class="ident" id="1383194">Mutex</span>&nbsp;<span class="comment" id="1383200">//&nbsp;gates&nbsp;readers&nbsp;one&nbsp;at&nbsp;a&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1383232">wl</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1383238">sync</span><span class="op" id="1383242">.</span><span class="ident" id="1383243">Mutex</span>&nbsp;<span class="comment" id="1383249">//&nbsp;gates&nbsp;writers&nbsp;one&nbsp;at&nbsp;a&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1383281">l</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1383287">sync</span><span class="op" id="1383291">.</span><span class="ident" id="1383292">Mutex</span>&nbsp;<span class="comment" id="1383298">//&nbsp;protects&nbsp;remaining&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1383328">data</span>&nbsp;&nbsp;<span class="op" id="1383334">[</span><span class="op" id="1383335">]</span><span class="builtintype" id="1383336">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1383345">//&nbsp;data&nbsp;remaining&nbsp;in&nbsp;pending&nbsp;write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1383381">rwait</span>&nbsp;<span class="ident" id="1383387">sync</span><span class="op" id="1383391">.</span><span class="ident" id="1383392">Cond</span>&nbsp;&nbsp;<span class="comment" id="1383398">//&nbsp;waiting&nbsp;reader</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1383417">wwait</span>&nbsp;<span class="ident" id="1383423">sync</span><span class="op" id="1383427">.</span><span class="ident" id="1383428">Cond</span>&nbsp;&nbsp;<span class="comment" id="1383434">//&nbsp;waiting&nbsp;writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1383453">rerr</span>&nbsp;&nbsp;<span class="builtintype" id="1383459">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1383470">//&nbsp;if&nbsp;reader&nbsp;closed,&nbsp;error&nbsp;to&nbsp;give&nbsp;writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1383513">werr</span>&nbsp;&nbsp;<span class="builtintype" id="1383519">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1383530">//&nbsp;if&nbsp;writer&nbsp;closed,&nbsp;error&nbsp;to&nbsp;give&nbsp;reads</span><br>
<span class="lineno"></span><span class="op" id="1383571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="1383574">func</span>&nbsp;<span class="op" id="1383579">(</span><span class="ident" id="1383580">p</span>&nbsp;<span class="op" id="1383582">*</span><span class="ident" id="1383583">pipe</span><span class="op" id="1383587">)</span>&nbsp;<span class="ident" id="1383589">read</span><span class="op" id="1383593">(</span><span class="ident" id="1383594">b</span>&nbsp;<span class="op" id="1383596">[</span><span class="op" id="1383597">]</span><span class="builtintype" id="1383598">byte</span><span class="op" id="1383602">)</span>&nbsp;<span class="op" id="1383604">(</span><span class="ident" id="1383605">n</span>&nbsp;<span class="builtintype" id="1383607">int</span><span class="op" id="1383610">,</span>&nbsp;<span class="ident" id="1383612">err</span>&nbsp;<span class="builtintype" id="1383616">error</span><span class="op" id="1383621">)</span>&nbsp;<span class="op" id="1383623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1383626">//&nbsp;One&nbsp;reader&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1383652">p</span><span class="op" id="1383653">.</span><span class="ident" id="1383654">rl</span><span class="op" id="1383656">.</span><span class="ident" id="1383657">Lock</span><span class="op" id="1383661">(</span><span class="op" id="1383662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1383665">defer</span>&nbsp;<span class="ident" id="1383671">p</span><span class="op" id="1383672">.</span><span class="ident" id="1383673">rl</span><span class="op" id="1383675">.</span><span class="ident" id="1383676">Unlock</span><span class="op" id="1383682">(</span><span class="op" id="1383683">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1383687">p</span><span class="op" id="1383688">.</span><span class="ident" id="1383689">l</span><span class="op" id="1383690">.</span><span class="ident" id="1383691">Lock</span><span class="op" id="1383695">(</span><span class="op" id="1383696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1383699">defer</span>&nbsp;<span class="ident" id="1383705">p</span><span class="op" id="1383706">.</span><span class="ident" id="1383707">l</span><span class="op" id="1383708">.</span><span class="ident" id="1383709">Unlock</span><span class="op" id="1383715">(</span><span class="op" id="1383716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1383719">for</span>&nbsp;<span class="op" id="1383723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1383727">if</span>&nbsp;<span class="ident" id="1383730">p</span><span class="op" id="1383731">.</span><span class="ident" id="1383732">rerr</span>&nbsp;<span class="op" id="1383737">!=</span>&nbsp;<span class="ident" id="1383740">nil</span>&nbsp;<span class="op" id="1383744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1383749">return</span>&nbsp;<span class="num" id="1383756">0</span><span class="op" id="1383757">,</span>&nbsp;<span class="ident" id="1383759">ErrClosedPipe</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1383775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1383779">if</span>&nbsp;<span class="ident" id="1383782">p</span><span class="op" id="1383783">.</span><span class="ident" id="1383784">data</span>&nbsp;<span class="op" id="1383789">!=</span>&nbsp;<span class="ident" id="1383792">nil</span>&nbsp;<span class="op" id="1383796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1383801">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1383809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1383813">if</span>&nbsp;<span class="ident" id="1383816">p</span><span class="op" id="1383817">.</span><span class="ident" id="1383818">werr</span>&nbsp;<span class="op" id="1383823">!=</span>&nbsp;<span class="ident" id="1383826">nil</span>&nbsp;<span class="op" id="1383830">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1383835">return</span>&nbsp;<span class="num" id="1383842">0</span><span class="op" id="1383843">,</span>&nbsp;<span class="ident" id="1383845">p</span><span class="op" id="1383846">.</span><span class="ident" id="1383847">werr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1383854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1383858">p</span><span class="op" id="1383859">.</span><span class="ident" id="1383860">rwait</span><span class="op" id="1383865">.</span><span class="ident" id="1383866">Wait</span><span class="op" id="1383870">(</span><span class="op" id="1383871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1383874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1383877">n</span>&nbsp;<span class="op" id="1383879">=</span>&nbsp;<span class="builtinfunc" id="1383881">copy</span><span class="op" id="1383885">(</span><span class="ident" id="1383886">b</span><span class="op" id="1383887">,</span>&nbsp;<span class="ident" id="1383889">p</span><span class="op" id="1383890">.</span><span class="ident" id="1383891">data</span><span class="op" id="1383895">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1383898">p</span><span class="op" id="1383899">.</span><span class="ident" id="1383900">data</span>&nbsp;<span class="op" id="1383905">=</span>&nbsp;<span class="ident" id="1383907">p</span><span class="op" id="1383908">.</span><span class="ident" id="1383909">data</span><span class="op" id="1383913">[</span><span class="ident" id="1383914">n</span><span class="op" id="1383915">:</span><span class="op" id="1383916">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1383919">if</span>&nbsp;<span class="builtinfunc" id="1383922">len</span><span class="op" id="1383925">(</span><span class="ident" id="1383926">p</span><span class="op" id="1383927">.</span><span class="ident" id="1383928">data</span><span class="op" id="1383932">)</span>&nbsp;<span class="op" id="1383934">==</span>&nbsp;<span class="num" id="1383937">0</span>&nbsp;<span class="op" id="1383939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1383943">p</span><span class="op" id="1383944">.</span><span class="ident" id="1383945">data</span>&nbsp;<span class="op" id="1383950">=</span>&nbsp;<span class="ident" id="1383952">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1383958">p</span><span class="op" id="1383959">.</span><span class="ident" id="1383960">wwait</span><span class="op" id="1383965">.</span><span class="ident" id="1383966">Signal</span><span class="op" id="1383972">(</span><span class="op" id="1383973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1383976">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1383979">return</span><br>
<span class="lineno"></span><span class="op" id="1383986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1383989">var</span>&nbsp;<span class="ident" id="1383993">zero</span>&nbsp;<span class="op" id="1383998">[</span><span class="num" id="1383999">0</span><span class="op" id="1384000">]</span><span class="builtintype" id="1384001">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="1384007">func</span>&nbsp;<span class="op" id="1384012">(</span><span class="ident" id="1384013">p</span>&nbsp;<span class="op" id="1384015">*</span><span class="ident" id="1384016">pipe</span><span class="op" id="1384020">)</span>&nbsp;<span class="ident" id="1384022">write</span><span class="op" id="1384027">(</span><span class="ident" id="1384028">b</span>&nbsp;<span class="op" id="1384030">[</span><span class="op" id="1384031">]</span><span class="builtintype" id="1384032">byte</span><span class="op" id="1384036">)</span>&nbsp;<span class="op" id="1384038">(</span><span class="ident" id="1384039">n</span>&nbsp;<span class="builtintype" id="1384041">int</span><span class="op" id="1384044">,</span>&nbsp;<span class="ident" id="1384046">err</span>&nbsp;<span class="builtintype" id="1384050">error</span><span class="op" id="1384055">)</span>&nbsp;<span class="op" id="1384057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1384060">//&nbsp;pipe&nbsp;uses&nbsp;nil&nbsp;to&nbsp;mean&nbsp;not&nbsp;available</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1384100">if</span>&nbsp;<span class="ident" id="1384103">b</span>&nbsp;<span class="op" id="1384105">==</span>&nbsp;<span class="ident" id="1384108">nil</span>&nbsp;<span class="op" id="1384112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384116">b</span>&nbsp;<span class="op" id="1384118">=</span>&nbsp;<span class="ident" id="1384120">zero</span><span class="op" id="1384124">[</span><span class="op" id="1384125">:</span><span class="op" id="1384126">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1384129">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1384133">//&nbsp;One&nbsp;writer&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384159">p</span><span class="op" id="1384160">.</span><span class="ident" id="1384161">wl</span><span class="op" id="1384163">.</span><span class="ident" id="1384164">Lock</span><span class="op" id="1384168">(</span><span class="op" id="1384169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1384172">defer</span>&nbsp;<span class="ident" id="1384178">p</span><span class="op" id="1384179">.</span><span class="ident" id="1384180">wl</span><span class="op" id="1384182">.</span><span class="ident" id="1384183">Unlock</span><span class="op" id="1384189">(</span><span class="op" id="1384190">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384194">p</span><span class="op" id="1384195">.</span><span class="ident" id="1384196">l</span><span class="op" id="1384197">.</span><span class="ident" id="1384198">Lock</span><span class="op" id="1384202">(</span><span class="op" id="1384203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1384206">defer</span>&nbsp;<span class="ident" id="1384212">p</span><span class="op" id="1384213">.</span><span class="ident" id="1384214">l</span><span class="op" id="1384215">.</span><span class="ident" id="1384216">Unlock</span><span class="op" id="1384222">(</span><span class="op" id="1384223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1384226">if</span>&nbsp;<span class="ident" id="1384229">p</span><span class="op" id="1384230">.</span><span class="ident" id="1384231">werr</span>&nbsp;<span class="op" id="1384236">!=</span>&nbsp;<span class="ident" id="1384239">nil</span>&nbsp;<span class="op" id="1384243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384247">err</span>&nbsp;<span class="op" id="1384251">=</span>&nbsp;<span class="ident" id="1384253">ErrClosedPipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1384269">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1384277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384280">p</span><span class="op" id="1384281">.</span><span class="ident" id="1384282">data</span>&nbsp;<span class="op" id="1384287">=</span>&nbsp;<span class="ident" id="1384289">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384292">p</span><span class="op" id="1384293">.</span><span class="ident" id="1384294">rwait</span><span class="op" id="1384299">.</span><span class="ident" id="1384300">Signal</span><span class="op" id="1384306">(</span><span class="op" id="1384307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1384310">for</span>&nbsp;<span class="op" id="1384314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1384318">if</span>&nbsp;<span class="ident" id="1384321">p</span><span class="op" id="1384322">.</span><span class="ident" id="1384323">data</span>&nbsp;<span class="op" id="1384328">==</span>&nbsp;<span class="ident" id="1384331">nil</span>&nbsp;<span class="op" id="1384335">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1384340">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1384348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1384352">if</span>&nbsp;<span class="ident" id="1384355">p</span><span class="op" id="1384356">.</span><span class="ident" id="1384357">rerr</span>&nbsp;<span class="op" id="1384362">!=</span>&nbsp;<span class="ident" id="1384365">nil</span>&nbsp;<span class="op" id="1384369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384374">err</span>&nbsp;<span class="op" id="1384378">=</span>&nbsp;<span class="ident" id="1384380">p</span><span class="op" id="1384381">.</span><span class="ident" id="1384382">rerr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1384390">break</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1384398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1384402">if</span>&nbsp;<span class="ident" id="1384405">p</span><span class="op" id="1384406">.</span><span class="ident" id="1384407">werr</span>&nbsp;<span class="op" id="1384412">!=</span>&nbsp;<span class="ident" id="1384415">nil</span>&nbsp;<span class="op" id="1384419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384424">err</span>&nbsp;<span class="op" id="1384428">=</span>&nbsp;<span class="ident" id="1384430">ErrClosedPipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1384446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384450">p</span><span class="op" id="1384451">.</span><span class="ident" id="1384452">wwait</span><span class="op" id="1384457">.</span><span class="ident" id="1384458">Wait</span><span class="op" id="1384462">(</span><span class="op" id="1384463">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1384466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384469">n</span>&nbsp;<span class="op" id="1384471">=</span>&nbsp;<span class="builtinfunc" id="1384473">len</span><span class="op" id="1384476">(</span><span class="ident" id="1384477">b</span><span class="op" id="1384478">)</span>&nbsp;<span class="op" id="1384480">-</span>&nbsp;<span class="builtinfunc" id="1384482">len</span><span class="op" id="1384485">(</span><span class="ident" id="1384486">p</span><span class="op" id="1384487">.</span><span class="ident" id="1384488">data</span><span class="op" id="1384492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384495">p</span><span class="op" id="1384496">.</span><span class="ident" id="1384497">data</span>&nbsp;<span class="op" id="1384502">=</span>&nbsp;<span class="ident" id="1384504">nil</span>&nbsp;<span class="comment" id="1384508">//&nbsp;in&nbsp;case&nbsp;of&nbsp;rerr&nbsp;or&nbsp;werr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1384536">return</span><br>
<span class="lineno"></span><span class="op" id="1384543">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="1384546">func</span>&nbsp;<span class="op" id="1384551">(</span><span class="ident" id="1384552">p</span>&nbsp;<span class="op" id="1384554">*</span><span class="ident" id="1384555">pipe</span><span class="op" id="1384559">)</span>&nbsp;<span class="ident" id="1384561">rclose</span><span class="op" id="1384567">(</span><span class="ident" id="1384568">err</span>&nbsp;<span class="builtintype" id="1384572">error</span><span class="op" id="1384577">)</span>&nbsp;<span class="op" id="1384579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1384582">if</span>&nbsp;<span class="ident" id="1384585">err</span>&nbsp;<span class="op" id="1384589">==</span>&nbsp;<span class="ident" id="1384592">nil</span>&nbsp;<span class="op" id="1384596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384600">err</span>&nbsp;<span class="op" id="1384604">=</span>&nbsp;<span class="ident" id="1384606">ErrClosedPipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1384621">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384624">p</span><span class="op" id="1384625">.</span><span class="ident" id="1384626">l</span><span class="op" id="1384627">.</span><span class="ident" id="1384628">Lock</span><span class="op" id="1384632">(</span><span class="op" id="1384633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1384636">defer</span>&nbsp;<span class="ident" id="1384642">p</span><span class="op" id="1384643">.</span><span class="ident" id="1384644">l</span><span class="op" id="1384645">.</span><span class="ident" id="1384646">Unlock</span><span class="op" id="1384652">(</span><span class="op" id="1384653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384656">p</span><span class="op" id="1384657">.</span><span class="ident" id="1384658">rerr</span>&nbsp;<span class="op" id="1384663">=</span>&nbsp;<span class="ident" id="1384665">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384670">p</span><span class="op" id="1384671">.</span><span class="ident" id="1384672">rwait</span><span class="op" id="1384677">.</span><span class="ident" id="1384678">Signal</span><span class="op" id="1384684">(</span><span class="op" id="1384685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384688">p</span><span class="op" id="1384689">.</span><span class="ident" id="1384690">wwait</span><span class="op" id="1384695">.</span><span class="ident" id="1384696">Signal</span><span class="op" id="1384702">(</span><span class="op" id="1384703">)</span><br>
<span class="lineno">110</span><span class="op" id="1384705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1384708">func</span>&nbsp;<span class="op" id="1384713">(</span><span class="ident" id="1384714">p</span>&nbsp;<span class="op" id="1384716">*</span><span class="ident" id="1384717">pipe</span><span class="op" id="1384721">)</span>&nbsp;<span class="ident" id="1384723">wclose</span><span class="op" id="1384729">(</span><span class="ident" id="1384730">err</span>&nbsp;<span class="builtintype" id="1384734">error</span><span class="op" id="1384739">)</span>&nbsp;<span class="op" id="1384741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1384744">if</span>&nbsp;<span class="ident" id="1384747">err</span>&nbsp;<span class="op" id="1384751">==</span>&nbsp;<span class="ident" id="1384754">nil</span>&nbsp;<span class="op" id="1384758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384762">err</span>&nbsp;<span class="op" id="1384766">=</span>&nbsp;<span class="ident" id="1384768">EOF</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1384773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384776">p</span><span class="op" id="1384777">.</span><span class="ident" id="1384778">l</span><span class="op" id="1384779">.</span><span class="ident" id="1384780">Lock</span><span class="op" id="1384784">(</span><span class="op" id="1384785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1384788">defer</span>&nbsp;<span class="ident" id="1384794">p</span><span class="op" id="1384795">.</span><span class="ident" id="1384796">l</span><span class="op" id="1384797">.</span><span class="ident" id="1384798">Unlock</span><span class="op" id="1384804">(</span><span class="op" id="1384805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384808">p</span><span class="op" id="1384809">.</span><span class="ident" id="1384810">werr</span>&nbsp;<span class="op" id="1384815">=</span>&nbsp;<span class="ident" id="1384817">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384822">p</span><span class="op" id="1384823">.</span><span class="ident" id="1384824">rwait</span><span class="op" id="1384829">.</span><span class="ident" id="1384830">Signal</span><span class="op" id="1384836">(</span><span class="op" id="1384837">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384840">p</span><span class="op" id="1384841">.</span><span class="ident" id="1384842">wwait</span><span class="op" id="1384847">.</span><span class="ident" id="1384848">Signal</span><span class="op" id="1384854">(</span><span class="op" id="1384855">)</span><br>
<span class="lineno"></span><span class="op" id="1384857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1384860">//&nbsp;A&nbsp;PipeReader&nbsp;is&nbsp;the&nbsp;read&nbsp;half&nbsp;of&nbsp;a&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1384904">type</span>&nbsp;<span class="ident" id="1384909">PipeReader</span>&nbsp;<span class="keyword" id="1384920">struct</span>&nbsp;<span class="op" id="1384927">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1384930">p</span>&nbsp;<span class="op" id="1384932">*</span><span class="ident" id="1384933">pipe</span><br>
<span class="lineno"></span><span class="op" id="1384938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1384941">//&nbsp;Read&nbsp;implements&nbsp;the&nbsp;standard&nbsp;Read&nbsp;interface:</span><br>
<span class="lineno"></span><span class="comment" id="1384989">//&nbsp;it&nbsp;reads&nbsp;data&nbsp;from&nbsp;the&nbsp;pipe,&nbsp;blocking&nbsp;until&nbsp;a&nbsp;writer</span><br>
<span class="lineno">130</span><span class="comment" id="1385045">//&nbsp;arrives&nbsp;or&nbsp;the&nbsp;write&nbsp;end&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="1385084">//&nbsp;If&nbsp;the&nbsp;write&nbsp;end&nbsp;is&nbsp;closed&nbsp;with&nbsp;an&nbsp;error,&nbsp;that&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1385143">//&nbsp;returned&nbsp;as&nbsp;err;&nbsp;otherwise&nbsp;err&nbsp;is&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="1385185">func</span>&nbsp;<span class="op" id="1385190">(</span><span class="ident" id="1385191">r</span>&nbsp;<span class="op" id="1385193">*</span><span class="ident" id="1385194">PipeReader</span><span class="op" id="1385204">)</span>&nbsp;<span class="ident" id="1385206">Read</span><span class="op" id="1385210">(</span><span class="ident" id="1385211">data</span>&nbsp;<span class="op" id="1385216">[</span><span class="op" id="1385217">]</span><span class="builtintype" id="1385218">byte</span><span class="op" id="1385222">)</span>&nbsp;<span class="op" id="1385224">(</span><span class="ident" id="1385225">n</span>&nbsp;<span class="builtintype" id="1385227">int</span><span class="op" id="1385230">,</span>&nbsp;<span class="ident" id="1385232">err</span>&nbsp;<span class="builtintype" id="1385236">error</span><span class="op" id="1385241">)</span>&nbsp;<span class="op" id="1385243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1385246">return</span>&nbsp;<span class="ident" id="1385253">r</span><span class="op" id="1385254">.</span><span class="ident" id="1385255">p</span><span class="op" id="1385256">.</span><span class="ident" id="1385257">read</span><span class="op" id="1385261">(</span><span class="ident" id="1385262">data</span><span class="op" id="1385266">)</span><br>
<span class="lineno">135</span><span class="op" id="1385268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1385271">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;reader;&nbsp;subsequent&nbsp;writes&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1385324">//&nbsp;write&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;the&nbsp;error&nbsp;ErrClosedPipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1385387">func</span>&nbsp;<span class="op" id="1385392">(</span><span class="ident" id="1385393">r</span>&nbsp;<span class="op" id="1385395">*</span><span class="ident" id="1385396">PipeReader</span><span class="op" id="1385406">)</span>&nbsp;<span class="ident" id="1385408">Close</span><span class="op" id="1385413">(</span><span class="op" id="1385414">)</span>&nbsp;<span class="builtintype" id="1385416">error</span>&nbsp;<span class="op" id="1385422">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1385425">return</span>&nbsp;<span class="ident" id="1385432">r</span><span class="op" id="1385433">.</span><span class="ident" id="1385434">CloseWithError</span><span class="op" id="1385448">(</span><span class="ident" id="1385449">nil</span><span class="op" id="1385452">)</span><br>
<span class="lineno"></span><span class="op" id="1385454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1385457">//&nbsp;CloseWithError&nbsp;closes&nbsp;the&nbsp;reader;&nbsp;subsequent&nbsp;writes</span><br>
<span class="lineno"></span><span class="comment" id="1385512">//&nbsp;to&nbsp;the&nbsp;write&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;the&nbsp;error&nbsp;err.</span><br>
<span class="lineno">145</span><span class="keyword" id="1385572">func</span>&nbsp;<span class="op" id="1385577">(</span><span class="ident" id="1385578">r</span>&nbsp;<span class="op" id="1385580">*</span><span class="ident" id="1385581">PipeReader</span><span class="op" id="1385591">)</span>&nbsp;<span class="ident" id="1385593">CloseWithError</span><span class="op" id="1385607">(</span><span class="ident" id="1385608">err</span>&nbsp;<span class="builtintype" id="1385612">error</span><span class="op" id="1385617">)</span>&nbsp;<span class="builtintype" id="1385619">error</span>&nbsp;<span class="op" id="1385625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1385628">r</span><span class="op" id="1385629">.</span><span class="ident" id="1385630">p</span><span class="op" id="1385631">.</span><span class="ident" id="1385632">rclose</span><span class="op" id="1385638">(</span><span class="ident" id="1385639">err</span><span class="op" id="1385642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1385645">return</span>&nbsp;<span class="ident" id="1385652">nil</span><br>
<span class="lineno"></span><span class="op" id="1385656">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="1385659">//&nbsp;A&nbsp;PipeWriter&nbsp;is&nbsp;the&nbsp;write&nbsp;half&nbsp;of&nbsp;a&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="keyword" id="1385704">type</span>&nbsp;<span class="ident" id="1385709">PipeWriter</span>&nbsp;<span class="keyword" id="1385720">struct</span>&nbsp;<span class="op" id="1385727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1385730">p</span>&nbsp;<span class="op" id="1385732">*</span><span class="ident" id="1385733">pipe</span><br>
<span class="lineno"></span><span class="op" id="1385738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="comment" id="1385741">//&nbsp;Write&nbsp;implements&nbsp;the&nbsp;standard&nbsp;Write&nbsp;interface:</span><br>
<span class="lineno"></span><span class="comment" id="1385791">//&nbsp;it&nbsp;writes&nbsp;data&nbsp;to&nbsp;the&nbsp;pipe,&nbsp;blocking&nbsp;until&nbsp;readers</span><br>
<span class="lineno"></span><span class="comment" id="1385845">//&nbsp;have&nbsp;consumed&nbsp;all&nbsp;the&nbsp;data&nbsp;or&nbsp;the&nbsp;read&nbsp;end&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="1385902">//&nbsp;If&nbsp;the&nbsp;read&nbsp;end&nbsp;is&nbsp;closed&nbsp;with&nbsp;an&nbsp;error,&nbsp;that&nbsp;err&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1385958">//&nbsp;returned&nbsp;as&nbsp;err;&nbsp;otherwise&nbsp;err&nbsp;is&nbsp;ErrClosedPipe.</span><br>
<span class="lineno">160</span><span class="keyword" id="1386010">func</span>&nbsp;<span class="op" id="1386015">(</span><span class="ident" id="1386016">w</span>&nbsp;<span class="op" id="1386018">*</span><span class="ident" id="1386019">PipeWriter</span><span class="op" id="1386029">)</span>&nbsp;<span class="ident" id="1386031">Write</span><span class="op" id="1386036">(</span><span class="ident" id="1386037">data</span>&nbsp;<span class="op" id="1386042">[</span><span class="op" id="1386043">]</span><span class="builtintype" id="1386044">byte</span><span class="op" id="1386048">)</span>&nbsp;<span class="op" id="1386050">(</span><span class="ident" id="1386051">n</span>&nbsp;<span class="builtintype" id="1386053">int</span><span class="op" id="1386056">,</span>&nbsp;<span class="ident" id="1386058">err</span>&nbsp;<span class="builtintype" id="1386062">error</span><span class="op" id="1386067">)</span>&nbsp;<span class="op" id="1386069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1386072">return</span>&nbsp;<span class="ident" id="1386079">w</span><span class="op" id="1386080">.</span><span class="ident" id="1386081">p</span><span class="op" id="1386082">.</span><span class="ident" id="1386083">write</span><span class="op" id="1386088">(</span><span class="ident" id="1386089">data</span><span class="op" id="1386093">)</span><br>
<span class="lineno"></span><span class="op" id="1386095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1386098">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;writer;&nbsp;subsequent&nbsp;reads&nbsp;from&nbsp;the</span><br>
<span class="lineno">165</span><span class="comment" id="1386152">//&nbsp;read&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;no&nbsp;bytes&nbsp;and&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="1386207">func</span>&nbsp;<span class="op" id="1386212">(</span><span class="ident" id="1386213">w</span>&nbsp;<span class="op" id="1386215">*</span><span class="ident" id="1386216">PipeWriter</span><span class="op" id="1386226">)</span>&nbsp;<span class="ident" id="1386228">Close</span><span class="op" id="1386233">(</span><span class="op" id="1386234">)</span>&nbsp;<span class="builtintype" id="1386236">error</span>&nbsp;<span class="op" id="1386242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1386245">return</span>&nbsp;<span class="ident" id="1386252">w</span><span class="op" id="1386253">.</span><span class="ident" id="1386254">CloseWithError</span><span class="op" id="1386268">(</span><span class="ident" id="1386269">nil</span><span class="op" id="1386272">)</span><br>
<span class="lineno"></span><span class="op" id="1386274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="1386277">//&nbsp;CloseWithError&nbsp;closes&nbsp;the&nbsp;writer;&nbsp;subsequent&nbsp;reads&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1386340">//&nbsp;read&nbsp;half&nbsp;of&nbsp;the&nbsp;pipe&nbsp;will&nbsp;return&nbsp;no&nbsp;bytes&nbsp;and&nbsp;the&nbsp;error&nbsp;err.</span><br>
<span class="lineno"></span><span class="keyword" id="1386405">func</span>&nbsp;<span class="op" id="1386410">(</span><span class="ident" id="1386411">w</span>&nbsp;<span class="op" id="1386413">*</span><span class="ident" id="1386414">PipeWriter</span><span class="op" id="1386424">)</span>&nbsp;<span class="ident" id="1386426">CloseWithError</span><span class="op" id="1386440">(</span><span class="ident" id="1386441">err</span>&nbsp;<span class="builtintype" id="1386445">error</span><span class="op" id="1386450">)</span>&nbsp;<span class="builtintype" id="1386452">error</span>&nbsp;<span class="op" id="1386458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1386461">w</span><span class="op" id="1386462">.</span><span class="ident" id="1386463">p</span><span class="op" id="1386464">.</span><span class="ident" id="1386465">wclose</span><span class="op" id="1386471">(</span><span class="ident" id="1386472">err</span><span class="op" id="1386475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1386478">return</span>&nbsp;<span class="ident" id="1386485">nil</span><br>
<span class="lineno">175</span><span class="op" id="1386489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1386492">//&nbsp;Pipe&nbsp;creates&nbsp;a&nbsp;synchronous&nbsp;in-memory&nbsp;pipe.</span><br>
<span class="lineno"></span><span class="comment" id="1386538">//&nbsp;It&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;connect&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Reader</span><br>
<span class="lineno"></span><span class="comment" id="1386595">//&nbsp;with&nbsp;code&nbsp;expecting&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno">180</span><span class="comment" id="1386632">//&nbsp;Reads&nbsp;on&nbsp;one&nbsp;end&nbsp;are&nbsp;matched&nbsp;with&nbsp;writes&nbsp;on&nbsp;the&nbsp;other,</span><br>
<span class="lineno"></span><span class="comment" id="1386690">//&nbsp;copying&nbsp;data&nbsp;directly&nbsp;between&nbsp;the&nbsp;two;&nbsp;there&nbsp;is&nbsp;no&nbsp;internal&nbsp;buffering.</span><br>
<span class="lineno"></span><span class="comment" id="1386764">//&nbsp;It&nbsp;is&nbsp;safe&nbsp;to&nbsp;call&nbsp;Read&nbsp;and&nbsp;Write&nbsp;in&nbsp;parallel&nbsp;with&nbsp;each&nbsp;other&nbsp;or&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="1386837">//&nbsp;Close.&nbsp;Close&nbsp;will&nbsp;complete&nbsp;once&nbsp;pending&nbsp;I/O&nbsp;is&nbsp;done.&nbsp;Parallel&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1386911">//&nbsp;Read,&nbsp;and&nbsp;parallel&nbsp;calls&nbsp;to&nbsp;Write,&nbsp;are&nbsp;also&nbsp;safe:</span><br>
<span class="lineno">185</span><span class="comment" id="1386964">//&nbsp;the&nbsp;individual&nbsp;calls&nbsp;will&nbsp;be&nbsp;gated&nbsp;sequentially.</span><br>
<span class="lineno"></span><span class="keyword" id="1387016">func</span>&nbsp;<span class="ident" id="1387021">Pipe</span><span class="op" id="1387025">(</span><span class="op" id="1387026">)</span>&nbsp;<span class="op" id="1387028">(</span><span class="op" id="1387029">*</span><span class="ident" id="1387030">PipeReader</span><span class="op" id="1387040">,</span>&nbsp;<span class="op" id="1387042">*</span><span class="ident" id="1387043">PipeWriter</span><span class="op" id="1387053">)</span>&nbsp;<span class="op" id="1387055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1387058">p</span>&nbsp;<span class="op" id="1387060">:=</span>&nbsp;<span class="builtinfunc" id="1387063">new</span><span class="op" id="1387066">(</span><span class="ident" id="1387067">pipe</span><span class="op" id="1387071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1387074">p</span><span class="op" id="1387075">.</span><span class="ident" id="1387076">rwait</span><span class="op" id="1387081">.</span><span class="ident" id="1387082">L</span>&nbsp;<span class="op" id="1387084">=</span>&nbsp;<span class="op" id="1387086">&amp;</span><span class="ident" id="1387087">p</span><span class="op" id="1387088">.</span><span class="ident" id="1387089">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1387092">p</span><span class="op" id="1387093">.</span><span class="ident" id="1387094">wwait</span><span class="op" id="1387099">.</span><span class="ident" id="1387100">L</span>&nbsp;<span class="op" id="1387102">=</span>&nbsp;<span class="op" id="1387104">&amp;</span><span class="ident" id="1387105">p</span><span class="op" id="1387106">.</span><span class="ident" id="1387107">l</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1387110">r</span>&nbsp;<span class="op" id="1387112">:=</span>&nbsp;<span class="op" id="1387115">&amp;</span><span class="ident" id="1387116">PipeReader</span><span class="op" id="1387126">{</span><span class="ident" id="1387127">p</span><span class="op" id="1387128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1387131">w</span>&nbsp;<span class="op" id="1387133">:=</span>&nbsp;<span class="op" id="1387136">&amp;</span><span class="ident" id="1387137">PipeWriter</span><span class="op" id="1387147">{</span><span class="ident" id="1387148">p</span><span class="op" id="1387149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1387152">return</span>&nbsp;<span class="ident" id="1387159">r</span><span class="op" id="1387160">,</span>&nbsp;<span class="ident" id="1387162">w</span><br>
<span class="lineno"></span><span class="op" id="1387164">}</span>
</div>
</body>
</html>
