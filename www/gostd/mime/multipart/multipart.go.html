<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>mime/multipart</h2>
<ul>
<li><a href="/gostd/mime/multipart/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/mime/multipart/formdata.go.html">formdata.go</a></li>
<li><a href="/gostd/mime/multipart/formdata_test.go.html">formdata_test.go</a></li>
<li><a href="/gostd/mime/multipart/multipart.go.html" class="current">multipart.go</a></li>
<li><a href="/gostd/mime/multipart/multipart_test.go.html">multipart_test.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable.go.html">quotedprintable.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable_test.go.html">quotedprintable_test.go</a></li>
<li><a href="/gostd/mime/multipart/writer.go.html">writer.go</a></li>
<li><a href="/gostd/mime/multipart/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4268836">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4268891">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4268945">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="4268995">//</span><br>
<span class="lineno">5</span><br>
<span class="lineno"></span><span class="comment" id="4268999">/*<br>
<span class="lineno"></span>Package&nbsp;multipart&nbsp;implements&nbsp;MIME&nbsp;multipart&nbsp;parsing,&nbsp;as&nbsp;defined&nbsp;in&nbsp;RFC<br>
<span class="lineno"></span>2046.<br>
<span class="lineno"></span><br>
<span class="lineno">10</span>The&nbsp;implementation&nbsp;is&nbsp;sufficient&nbsp;for&nbsp;HTTP&nbsp;(RFC&nbsp;2388)&nbsp;and&nbsp;the&nbsp;multipart<br>
<span class="lineno"></span>bodies&nbsp;generated&nbsp;by&nbsp;popular&nbsp;browsers.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="4269192">package</span>&nbsp;<span class="ident" id="4269200">multipart</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="4269211">import</span>&nbsp;<span class="op" id="4269218">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4269221">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4269230">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4269239">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4269246">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4269252">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4269265">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4269273">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span><span class="op" id="4269289">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="4269292">var</span>&nbsp;<span class="ident" id="4269296">emptyParams</span>&nbsp;<span class="op" id="4269308">=</span>&nbsp;<span class="builtinfunc" id="4269310">make</span><span class="op" id="4269314">(</span><span class="keyword" id="4269315">map</span><span class="op" id="4269318">[</span><span class="builtintype" id="4269319">string</span><span class="op" id="4269325">]</span><span class="builtintype" id="4269326">string</span><span class="op" id="4269332">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4269335">//&nbsp;A&nbsp;Part&nbsp;represents&nbsp;a&nbsp;single&nbsp;part&nbsp;in&nbsp;a&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="4269391">type</span>&nbsp;<span class="ident" id="4269396">Part</span>&nbsp;<span class="keyword" id="4269401">struct</span>&nbsp;<span class="op" id="4269408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4269411">//&nbsp;The&nbsp;headers&nbsp;of&nbsp;the&nbsp;body,&nbsp;if&nbsp;any,&nbsp;with&nbsp;the&nbsp;keys&nbsp;canonicalized</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4269476">//&nbsp;in&nbsp;the&nbsp;same&nbsp;fashion&nbsp;that&nbsp;the&nbsp;Go&nbsp;http.Request&nbsp;headers&nbsp;are.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4269538">//&nbsp;For&nbsp;example,&nbsp;&#34;foo-bar&#34;&nbsp;changes&nbsp;case&nbsp;to&nbsp;&#34;Foo-Bar&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4269591">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4269595">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;the&nbsp;&#34;Content-Transfer-Encoding&#34;&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4269660">//&nbsp;has&nbsp;a&nbsp;value&nbsp;of&nbsp;&#34;quoted-printable&#34;,&nbsp;that&nbsp;header&nbsp;is&nbsp;instead</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4269722">//&nbsp;hidden&nbsp;from&nbsp;this&nbsp;map&nbsp;and&nbsp;the&nbsp;body&nbsp;is&nbsp;transparently&nbsp;decoded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4269785">//&nbsp;during&nbsp;Read&nbsp;calls.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4269808">Header</span>&nbsp;<span class="ident" id="4269815">textproto</span><span class="op" id="4269824">.</span><span class="ident" id="4269825">MIMEHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4269838">buffer</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4269848">*</span><span class="ident" id="4269849">bytes</span><span class="op" id="4269854">.</span><span class="ident" id="4269855">Buffer</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4269863">mr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4269873">*</span><span class="ident" id="4269874">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4269882">bytesRead</span>&nbsp;<span class="builtintype" id="4269892">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4269898">disposition</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4269916">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4269924">dispositionParams</span>&nbsp;<span class="keyword" id="4269942">map</span><span class="op" id="4269945">[</span><span class="builtintype" id="4269946">string</span><span class="op" id="4269952">]</span><span class="builtintype" id="4269953">string</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4269962">//&nbsp;r&nbsp;is&nbsp;either&nbsp;a&nbsp;reader&nbsp;directly&nbsp;reading&nbsp;from&nbsp;mr,&nbsp;or&nbsp;it&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4270023">//&nbsp;wrapper&nbsp;around&nbsp;such&nbsp;a&nbsp;reader,&nbsp;decoding&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4270070">//&nbsp;Content-Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4270100">r</span>&nbsp;<span class="ident" id="4270102">io</span><span class="op" id="4270104">.</span><span class="ident" id="4270105">Reader</span><br>
<span class="lineno">50</span><span class="op" id="4270112">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4270115">//&nbsp;FormName&nbsp;returns&nbsp;the&nbsp;name&nbsp;parameter&nbsp;if&nbsp;p&nbsp;has&nbsp;a&nbsp;Content-Disposition</span><br>
<span class="lineno"></span><span class="comment" id="4270185">//&nbsp;of&nbsp;type&nbsp;&#34;form-data&#34;.&nbsp;&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="4270249">func</span>&nbsp;<span class="op" id="4270254">(</span><span class="ident" id="4270255">p</span>&nbsp;<span class="op" id="4270257">*</span><span class="ident" id="4270258">Part</span><span class="op" id="4270262">)</span>&nbsp;<span class="ident" id="4270264">FormName</span><span class="op" id="4270272">(</span><span class="op" id="4270273">)</span>&nbsp;<span class="builtintype" id="4270275">string</span>&nbsp;<span class="op" id="4270282">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4270285">//&nbsp;See&nbsp;http://tools.ietf.org/html/rfc2183&nbsp;section&nbsp;2&nbsp;for&nbsp;EBNF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4270347">//&nbsp;of&nbsp;Content-Disposition&nbsp;value&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4270388">if</span>&nbsp;<span class="ident" id="4270391">p</span><span class="op" id="4270392">.</span><span class="ident" id="4270393">dispositionParams</span>&nbsp;<span class="op" id="4270411">==</span>&nbsp;<span class="ident" id="4270414">nil</span>&nbsp;<span class="op" id="4270418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4270422">p</span><span class="op" id="4270423">.</span><span class="ident" id="4270424">parseContentDisposition</span><span class="op" id="4270447">(</span><span class="op" id="4270448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4270451">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4270454">if</span>&nbsp;<span class="ident" id="4270457">p</span><span class="op" id="4270458">.</span><span class="ident" id="4270459">disposition</span>&nbsp;<span class="op" id="4270471">!=</span>&nbsp;<span class="string" id="4270474">&#34;form-data&#34;</span>&nbsp;<span class="op" id="4270486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4270490">return</span>&nbsp;<span class="string" id="4270497">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4270501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4270504">return</span>&nbsp;<span class="ident" id="4270511">p</span><span class="op" id="4270512">.</span><span class="ident" id="4270513">dispositionParams</span><span class="op" id="4270530">[</span><span class="string" id="4270531">&#34;name&#34;</span><span class="op" id="4270537">]</span><br>
<span class="lineno"></span><span class="op" id="4270539">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="4270542">//&nbsp;FileName&nbsp;returns&nbsp;the&nbsp;filename&nbsp;parameter&nbsp;of&nbsp;the&nbsp;Part&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="4270599">//&nbsp;Content-Disposition&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="4270630">func</span>&nbsp;<span class="op" id="4270635">(</span><span class="ident" id="4270636">p</span>&nbsp;<span class="op" id="4270638">*</span><span class="ident" id="4270639">Part</span><span class="op" id="4270643">)</span>&nbsp;<span class="ident" id="4270645">FileName</span><span class="op" id="4270653">(</span><span class="op" id="4270654">)</span>&nbsp;<span class="builtintype" id="4270656">string</span>&nbsp;<span class="op" id="4270663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4270666">if</span>&nbsp;<span class="ident" id="4270669">p</span><span class="op" id="4270670">.</span><span class="ident" id="4270671">dispositionParams</span>&nbsp;<span class="op" id="4270689">==</span>&nbsp;<span class="ident" id="4270692">nil</span>&nbsp;<span class="op" id="4270696">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4270700">p</span><span class="op" id="4270701">.</span><span class="ident" id="4270702">parseContentDisposition</span><span class="op" id="4270725">(</span><span class="op" id="4270726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4270729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4270732">return</span>&nbsp;<span class="ident" id="4270739">p</span><span class="op" id="4270740">.</span><span class="ident" id="4270741">dispositionParams</span><span class="op" id="4270758">[</span><span class="string" id="4270759">&#34;filename&#34;</span><span class="op" id="4270769">]</span><br>
<span class="lineno"></span><span class="op" id="4270771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="4270774">func</span>&nbsp;<span class="op" id="4270779">(</span><span class="ident" id="4270780">p</span>&nbsp;<span class="op" id="4270782">*</span><span class="ident" id="4270783">Part</span><span class="op" id="4270787">)</span>&nbsp;<span class="ident" id="4270789">parseContentDisposition</span><span class="op" id="4270812">(</span><span class="op" id="4270813">)</span>&nbsp;<span class="op" id="4270815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4270818">v</span>&nbsp;<span class="op" id="4270820">:=</span>&nbsp;<span class="ident" id="4270823">p</span><span class="op" id="4270824">.</span><span class="ident" id="4270825">Header</span><span class="op" id="4270831">.</span><span class="ident" id="4270832">Get</span><span class="op" id="4270835">(</span><span class="string" id="4270836">&#34;Content-Disposition&#34;</span><span class="op" id="4270857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4270860">var</span>&nbsp;<span class="ident" id="4270864">err</span>&nbsp;<span class="builtintype" id="4270868">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4270875">p</span><span class="op" id="4270876">.</span><span class="ident" id="4270877">disposition</span><span class="op" id="4270888">,</span>&nbsp;<span class="ident" id="4270890">p</span><span class="op" id="4270891">.</span><span class="ident" id="4270892">dispositionParams</span><span class="op" id="4270909">,</span>&nbsp;<span class="ident" id="4270911">err</span>&nbsp;<span class="op" id="4270915">=</span>&nbsp;<span class="ident" id="4270917">mime</span><span class="op" id="4270921">.</span><span class="ident" id="4270922">ParseMediaType</span><span class="op" id="4270936">(</span><span class="ident" id="4270937">v</span><span class="op" id="4270938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4270941">if</span>&nbsp;<span class="ident" id="4270944">err</span>&nbsp;<span class="op" id="4270948">!=</span>&nbsp;<span class="ident" id="4270951">nil</span>&nbsp;<span class="op" id="4270955">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4270959">p</span><span class="op" id="4270960">.</span><span class="ident" id="4270961">dispositionParams</span>&nbsp;<span class="op" id="4270979">=</span>&nbsp;<span class="ident" id="4270981">emptyParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4270994">}</span><br>
<span class="lineno"></span><span class="op" id="4270996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4270999">//&nbsp;NewReader&nbsp;creates&nbsp;a&nbsp;new&nbsp;multipart&nbsp;Reader&nbsp;reading&nbsp;from&nbsp;r&nbsp;using&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="4271068">//&nbsp;given&nbsp;MIME&nbsp;boundary.</span><br>
<span class="lineno"></span><span class="comment" id="4271092">//</span><br>
<span class="lineno"></span><span class="comment" id="4271095">//&nbsp;The&nbsp;boundary&nbsp;is&nbsp;usually&nbsp;obtained&nbsp;from&nbsp;the&nbsp;&#34;boundary&#34;&nbsp;parameter&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4271164">//&nbsp;the&nbsp;message&#39;s&nbsp;&#34;Content-Type&#34;&nbsp;header.&nbsp;Use&nbsp;mime.ParseMediaType&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4271231">//&nbsp;parse&nbsp;such&nbsp;headers.</span><br>
<span class="lineno">90</span><span class="keyword" id="4271254">func</span>&nbsp;<span class="ident" id="4271259">NewReader</span><span class="op" id="4271268">(</span><span class="ident" id="4271269">r</span>&nbsp;<span class="ident" id="4271271">io</span><span class="op" id="4271273">.</span><span class="ident" id="4271274">Reader</span><span class="op" id="4271280">,</span>&nbsp;<span class="ident" id="4271282">boundary</span>&nbsp;<span class="builtintype" id="4271291">string</span><span class="op" id="4271297">)</span>&nbsp;<span class="op" id="4271299">*</span><span class="ident" id="4271300">Reader</span>&nbsp;<span class="op" id="4271307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4271310">b</span>&nbsp;<span class="op" id="4271312">:=</span>&nbsp;<span class="op" id="4271315">[</span><span class="op" id="4271316">]</span><span class="builtintype" id="4271317">byte</span><span class="op" id="4271321">(</span><span class="string" id="4271322">&#34;\r\n--&#34;</span>&nbsp;<span class="op" id="4271331">+</span>&nbsp;<span class="ident" id="4271333">boundary</span>&nbsp;<span class="op" id="4271342">+</span>&nbsp;<span class="string" id="4271344">&#34;--&#34;</span><span class="op" id="4271348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4271351">return</span>&nbsp;<span class="op" id="4271358">&amp;</span><span class="ident" id="4271359">Reader</span><span class="op" id="4271365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4271369">bufReader</span><span class="op" id="4271378">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271387">bufio</span><span class="op" id="4271392">.</span><span class="ident" id="4271393">NewReader</span><span class="op" id="4271402">(</span><span class="ident" id="4271403">r</span><span class="op" id="4271404">)</span><span class="op" id="4271405">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4271409">nl</span><span class="op" id="4271411">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271427">b</span><span class="op" id="4271428">[</span><span class="op" id="4271429">:</span><span class="num" id="4271430">2</span><span class="op" id="4271431">]</span><span class="op" id="4271432">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4271436">nlDashBoundary</span><span class="op" id="4271450">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4271454">b</span><span class="op" id="4271455">[</span><span class="op" id="4271456">:</span><span class="builtinfunc" id="4271457">len</span><span class="op" id="4271460">(</span><span class="ident" id="4271461">b</span><span class="op" id="4271462">)</span><span class="op" id="4271463">-</span><span class="num" id="4271464">2</span><span class="op" id="4271465">]</span><span class="op" id="4271466">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4271470">dashBoundaryDash</span><span class="op" id="4271486">:</span>&nbsp;<span class="ident" id="4271488">b</span><span class="op" id="4271489">[</span><span class="num" id="4271490">2</span><span class="op" id="4271491">:</span><span class="op" id="4271492">]</span><span class="op" id="4271493">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4271497">dashBoundary</span><span class="op" id="4271509">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271515">b</span><span class="op" id="4271516">[</span><span class="num" id="4271517">2</span>&nbsp;<span class="op" id="4271519">:</span>&nbsp;<span class="builtinfunc" id="4271521">len</span><span class="op" id="4271524">(</span><span class="ident" id="4271525">b</span><span class="op" id="4271526">)</span><span class="op" id="4271527">-</span><span class="num" id="4271528">2</span><span class="op" id="4271529">]</span><span class="op" id="4271530">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4271533">}</span><br>
<span class="lineno"></span><span class="op" id="4271535">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="4271538">func</span>&nbsp;<span class="ident" id="4271543">newPart</span><span class="op" id="4271550">(</span><span class="ident" id="4271551">mr</span>&nbsp;<span class="op" id="4271554">*</span><span class="ident" id="4271555">Reader</span><span class="op" id="4271561">)</span>&nbsp;<span class="op" id="4271563">(</span><span class="op" id="4271564">*</span><span class="ident" id="4271565">Part</span><span class="op" id="4271569">,</span>&nbsp;<span class="builtintype" id="4271571">error</span><span class="op" id="4271576">)</span>&nbsp;<span class="op" id="4271578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4271581">bp</span>&nbsp;<span class="op" id="4271584">:=</span>&nbsp;<span class="op" id="4271587">&amp;</span><span class="ident" id="4271588">Part</span><span class="op" id="4271592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4271596">Header</span><span class="op" id="4271602">:</span>&nbsp;<span class="builtinfunc" id="4271604">make</span><span class="op" id="4271608">(</span><span class="keyword" id="4271609">map</span><span class="op" id="4271612">[</span><span class="builtintype" id="4271613">string</span><span class="op" id="4271619">]</span><span class="op" id="4271620">[</span><span class="op" id="4271621">]</span><span class="builtintype" id="4271622">string</span><span class="op" id="4271628">)</span><span class="op" id="4271629">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4271633">mr</span><span class="op" id="4271635">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271641">mr</span><span class="op" id="4271643">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4271647">buffer</span><span class="op" id="4271653">:</span>&nbsp;<span class="builtinfunc" id="4271655">new</span><span class="op" id="4271658">(</span><span class="ident" id="4271659">bytes</span><span class="op" id="4271664">.</span><span class="ident" id="4271665">Buffer</span><span class="op" id="4271671">)</span><span class="op" id="4271672">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4271675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4271678">if</span>&nbsp;<span class="ident" id="4271681">err</span>&nbsp;<span class="op" id="4271685">:=</span>&nbsp;<span class="ident" id="4271688">bp</span><span class="op" id="4271690">.</span><span class="ident" id="4271691">populateHeaders</span><span class="op" id="4271706">(</span><span class="op" id="4271707">)</span><span class="op" id="4271708">;</span>&nbsp;<span class="ident" id="4271710">err</span>&nbsp;<span class="op" id="4271714">!=</span>&nbsp;<span class="ident" id="4271717">nil</span>&nbsp;<span class="op" id="4271721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4271725">return</span>&nbsp;<span class="ident" id="4271732">nil</span><span class="op" id="4271735">,</span>&nbsp;<span class="ident" id="4271737">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4271742">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4271745">bp</span><span class="op" id="4271747">.</span><span class="ident" id="4271748">r</span>&nbsp;<span class="op" id="4271750">=</span>&nbsp;<span class="ident" id="4271752">partReader</span><span class="op" id="4271762">{</span><span class="ident" id="4271763">bp</span><span class="op" id="4271765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4271768">const</span>&nbsp;<span class="ident" id="4271774">cte</span>&nbsp;<span class="op" id="4271778">=</span>&nbsp;<span class="string" id="4271780">&#34;Content-Transfer-Encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4271809">if</span>&nbsp;<span class="ident" id="4271812">bp</span><span class="op" id="4271814">.</span><span class="ident" id="4271815">Header</span><span class="op" id="4271821">.</span><span class="ident" id="4271822">Get</span><span class="op" id="4271825">(</span><span class="ident" id="4271826">cte</span><span class="op" id="4271829">)</span>&nbsp;<span class="op" id="4271831">==</span>&nbsp;<span class="string" id="4271834">&#34;quoted-printable&#34;</span>&nbsp;<span class="op" id="4271853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4271857">bp</span><span class="op" id="4271859">.</span><span class="ident" id="4271860">Header</span><span class="op" id="4271866">.</span><span class="ident" id="4271867">Del</span><span class="op" id="4271870">(</span><span class="ident" id="4271871">cte</span><span class="op" id="4271874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4271878">bp</span><span class="op" id="4271880">.</span><span class="ident" id="4271881">r</span>&nbsp;<span class="op" id="4271883">=</span>&nbsp;<span class="ident" id="4271885">newQuotedPrintableReader</span><span class="op" id="4271909">(</span><span class="ident" id="4271910">bp</span><span class="op" id="4271912">.</span><span class="ident" id="4271913">r</span><span class="op" id="4271914">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4271917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4271920">return</span>&nbsp;<span class="ident" id="4271927">bp</span><span class="op" id="4271929">,</span>&nbsp;<span class="ident" id="4271931">nil</span><br>
<span class="lineno"></span><span class="op" id="4271935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4271938">func</span>&nbsp;<span class="op" id="4271943">(</span><span class="ident" id="4271944">bp</span>&nbsp;<span class="op" id="4271947">*</span><span class="ident" id="4271948">Part</span><span class="op" id="4271952">)</span>&nbsp;<span class="ident" id="4271954">populateHeaders</span><span class="op" id="4271969">(</span><span class="op" id="4271970">)</span>&nbsp;<span class="builtintype" id="4271972">error</span>&nbsp;<span class="op" id="4271978">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4271981">r</span>&nbsp;<span class="op" id="4271983">:=</span>&nbsp;<span class="ident" id="4271986">textproto</span><span class="op" id="4271995">.</span><span class="ident" id="4271996">NewReader</span><span class="op" id="4272005">(</span><span class="ident" id="4272006">bp</span><span class="op" id="4272008">.</span><span class="ident" id="4272009">mr</span><span class="op" id="4272011">.</span><span class="ident" id="4272012">bufReader</span><span class="op" id="4272021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4272024">header</span><span class="op" id="4272030">,</span>&nbsp;<span class="ident" id="4272032">err</span>&nbsp;<span class="op" id="4272036">:=</span>&nbsp;<span class="ident" id="4272039">r</span><span class="op" id="4272040">.</span><span class="ident" id="4272041">ReadMIMEHeader</span><span class="op" id="4272055">(</span><span class="op" id="4272056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4272059">if</span>&nbsp;<span class="ident" id="4272062">err</span>&nbsp;<span class="op" id="4272066">==</span>&nbsp;<span class="ident" id="4272069">nil</span>&nbsp;<span class="op" id="4272073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4272077">bp</span><span class="op" id="4272079">.</span><span class="ident" id="4272080">Header</span>&nbsp;<span class="op" id="4272087">=</span>&nbsp;<span class="ident" id="4272089">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4272097">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4272100">return</span>&nbsp;<span class="ident" id="4272107">err</span><br>
<span class="lineno"></span><span class="op" id="4272111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4272114">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;body&nbsp;of&nbsp;a&nbsp;part,&nbsp;after&nbsp;its&nbsp;headers&nbsp;and&nbsp;before&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4272181">//&nbsp;next&nbsp;part&nbsp;(if&nbsp;any)&nbsp;begins.</span><br>
<span class="lineno">130</span><span class="keyword" id="4272211">func</span>&nbsp;<span class="op" id="4272216">(</span><span class="ident" id="4272217">p</span>&nbsp;<span class="op" id="4272219">*</span><span class="ident" id="4272220">Part</span><span class="op" id="4272224">)</span>&nbsp;<span class="ident" id="4272226">Read</span><span class="op" id="4272230">(</span><span class="ident" id="4272231">d</span>&nbsp;<span class="op" id="4272233">[</span><span class="op" id="4272234">]</span><span class="builtintype" id="4272235">byte</span><span class="op" id="4272239">)</span>&nbsp;<span class="op" id="4272241">(</span><span class="ident" id="4272242">n</span>&nbsp;<span class="builtintype" id="4272244">int</span><span class="op" id="4272247">,</span>&nbsp;<span class="ident" id="4272249">err</span>&nbsp;<span class="builtintype" id="4272253">error</span><span class="op" id="4272258">)</span>&nbsp;<span class="op" id="4272260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4272263">return</span>&nbsp;<span class="ident" id="4272270">p</span><span class="op" id="4272271">.</span><span class="ident" id="4272272">r</span><span class="op" id="4272273">.</span><span class="ident" id="4272274">Read</span><span class="op" id="4272278">(</span><span class="ident" id="4272279">d</span><span class="op" id="4272280">)</span><br>
<span class="lineno"></span><span class="op" id="4272282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4272285">//&nbsp;partReader&nbsp;implements&nbsp;io.Reader&nbsp;by&nbsp;reading&nbsp;raw&nbsp;bytes&nbsp;directly&nbsp;from&nbsp;the</span><br>
<span class="lineno">135</span><span class="comment" id="4272359">//&nbsp;wrapped&nbsp;*Part,&nbsp;without&nbsp;doing&nbsp;any&nbsp;Transfer-Encoding&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="keyword" id="4272423">type</span>&nbsp;<span class="ident" id="4272428">partReader</span>&nbsp;<span class="keyword" id="4272439">struct</span>&nbsp;<span class="op" id="4272446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4272449">p</span>&nbsp;<span class="op" id="4272451">*</span><span class="ident" id="4272452">Part</span><br>
<span class="lineno"></span><span class="op" id="4272457">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="4272460">func</span>&nbsp;<span class="op" id="4272465">(</span><span class="ident" id="4272466">pr</span>&nbsp;<span class="ident" id="4272469">partReader</span><span class="op" id="4272479">)</span>&nbsp;<span class="ident" id="4272481">Read</span><span class="op" id="4272485">(</span><span class="ident" id="4272486">d</span>&nbsp;<span class="op" id="4272488">[</span><span class="op" id="4272489">]</span><span class="builtintype" id="4272490">byte</span><span class="op" id="4272494">)</span>&nbsp;<span class="op" id="4272496">(</span><span class="ident" id="4272497">n</span>&nbsp;<span class="builtintype" id="4272499">int</span><span class="op" id="4272502">,</span>&nbsp;<span class="ident" id="4272504">err</span>&nbsp;<span class="builtintype" id="4272508">error</span><span class="op" id="4272513">)</span>&nbsp;<span class="op" id="4272515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4272518">p</span>&nbsp;<span class="op" id="4272520">:=</span>&nbsp;<span class="ident" id="4272523">pr</span><span class="op" id="4272525">.</span><span class="ident" id="4272526">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4272529">defer</span>&nbsp;<span class="keyword" id="4272535">func</span><span class="op" id="4272539">(</span><span class="op" id="4272540">)</span>&nbsp;<span class="op" id="4272542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4272546">p</span><span class="op" id="4272547">.</span><span class="ident" id="4272548">bytesRead</span>&nbsp;<span class="op" id="4272558">+=</span>&nbsp;<span class="ident" id="4272561">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4272564">}</span><span class="op" id="4272565">(</span><span class="op" id="4272566">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4272569">if</span>&nbsp;<span class="ident" id="4272572">p</span><span class="op" id="4272573">.</span><span class="ident" id="4272574">buffer</span><span class="op" id="4272580">.</span><span class="ident" id="4272581">Len</span><span class="op" id="4272584">(</span><span class="op" id="4272585">)</span>&nbsp;<span class="op" id="4272587">&gt;=</span>&nbsp;<span class="builtinfunc" id="4272590">len</span><span class="op" id="4272593">(</span><span class="ident" id="4272594">d</span><span class="op" id="4272595">)</span>&nbsp;<span class="op" id="4272597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4272601">//&nbsp;Internal&nbsp;buffer&nbsp;of&nbsp;unconsumed&nbsp;data&nbsp;is&nbsp;large&nbsp;enough&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4272661">//&nbsp;the&nbsp;read&nbsp;request.&nbsp;&nbsp;No&nbsp;need&nbsp;to&nbsp;parse&nbsp;more&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4272722">return</span>&nbsp;<span class="ident" id="4272729">p</span><span class="op" id="4272730">.</span><span class="ident" id="4272731">buffer</span><span class="op" id="4272737">.</span><span class="ident" id="4272738">Read</span><span class="op" id="4272742">(</span><span class="ident" id="4272743">d</span><span class="op" id="4272744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4272747">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4272750">peek</span><span class="op" id="4272754">,</span>&nbsp;<span class="ident" id="4272756">err</span>&nbsp;<span class="op" id="4272760">:=</span>&nbsp;<span class="ident" id="4272763">p</span><span class="op" id="4272764">.</span><span class="ident" id="4272765">mr</span><span class="op" id="4272767">.</span><span class="ident" id="4272768">bufReader</span><span class="op" id="4272777">.</span><span class="ident" id="4272778">Peek</span><span class="op" id="4272782">(</span><span class="num" id="4272783">4096</span><span class="op" id="4272787">)</span>&nbsp;<span class="comment" id="4272789">//&nbsp;TODO(bradfitz):&nbsp;add&nbsp;buffer&nbsp;size&nbsp;accessor</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4272835">//&nbsp;Look&nbsp;for&nbsp;an&nbsp;immediate&nbsp;empty&nbsp;part&nbsp;without&nbsp;a&nbsp;leading&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4272895">//&nbsp;before&nbsp;the&nbsp;boundary&nbsp;separator.&nbsp;&nbsp;Some&nbsp;MIME&nbsp;code&nbsp;makes&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4272958">//&nbsp;parts&nbsp;like&nbsp;this.&nbsp;Most&nbsp;browsers,&nbsp;however,&nbsp;write&nbsp;the&nbsp;\r\n</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4273018">//&nbsp;before&nbsp;the&nbsp;subsequent&nbsp;boundary&nbsp;even&nbsp;for&nbsp;empty&nbsp;parts&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4273078">//&nbsp;won&#39;t&nbsp;hit&nbsp;this&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4273103">if</span>&nbsp;<span class="ident" id="4273106">p</span><span class="op" id="4273107">.</span><span class="ident" id="4273108">bytesRead</span>&nbsp;<span class="op" id="4273118">==</span>&nbsp;<span class="num" id="4273121">0</span>&nbsp;<span class="op" id="4273123">&amp;&amp;</span>&nbsp;<span class="ident" id="4273126">p</span><span class="op" id="4273127">.</span><span class="ident" id="4273128">mr</span><span class="op" id="4273130">.</span><span class="ident" id="4273131">peekBufferIsEmptyPart</span><span class="op" id="4273152">(</span><span class="ident" id="4273153">peek</span><span class="op" id="4273157">)</span>&nbsp;<span class="op" id="4273159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4273163">return</span>&nbsp;<span class="num" id="4273170">0</span><span class="op" id="4273171">,</span>&nbsp;<span class="ident" id="4273173">io</span><span class="op" id="4273175">.</span><span class="ident" id="4273176">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4273181">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4273184">unexpectedEOF</span>&nbsp;<span class="op" id="4273198">:=</span>&nbsp;<span class="ident" id="4273201">err</span>&nbsp;<span class="op" id="4273205">==</span>&nbsp;<span class="ident" id="4273208">io</span><span class="op" id="4273210">.</span><span class="ident" id="4273211">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4273216">if</span>&nbsp;<span class="ident" id="4273219">err</span>&nbsp;<span class="op" id="4273223">!=</span>&nbsp;<span class="ident" id="4273226">nil</span>&nbsp;<span class="op" id="4273230">&amp;&amp;</span>&nbsp;<span class="op" id="4273233">!</span><span class="ident" id="4273234">unexpectedEOF</span>&nbsp;<span class="op" id="4273248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4273252">return</span>&nbsp;<span class="num" id="4273259">0</span><span class="op" id="4273260">,</span>&nbsp;<span class="ident" id="4273262">fmt</span><span class="op" id="4273265">.</span><span class="ident" id="4273266">Errorf</span><span class="op" id="4273272">(</span><span class="string" id="4273273">&#34;multipart:&nbsp;Part&nbsp;Read:&nbsp;%v&#34;</span><span class="op" id="4273299">,</span>&nbsp;<span class="ident" id="4273301">err</span><span class="op" id="4273304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4273307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4273310">if</span>&nbsp;<span class="ident" id="4273313">peek</span>&nbsp;<span class="op" id="4273318">==</span>&nbsp;<span class="ident" id="4273321">nil</span>&nbsp;<span class="op" id="4273325">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4273329">panic</span><span class="op" id="4273334">(</span><span class="string" id="4273335">&#34;nil&nbsp;peek&nbsp;buf&#34;</span><span class="op" id="4273349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4273352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4273356">//&nbsp;Search&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;for&nbsp;&#34;\r\n--boundary&#34;.&nbsp;If&nbsp;found,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4273415">//&nbsp;consume&nbsp;everything&nbsp;up&nbsp;to&nbsp;the&nbsp;boundary.&nbsp;If&nbsp;not,&nbsp;consume&nbsp;only</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4273479">//&nbsp;as&nbsp;much&nbsp;of&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;as&nbsp;cannot&nbsp;hold&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4273538">//&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4273550">nCopy</span>&nbsp;<span class="op" id="4273556">:=</span>&nbsp;<span class="num" id="4273559">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4273562">foundBoundary</span>&nbsp;<span class="op" id="4273576">:=</span>&nbsp;<span class="builtintype" id="4273579">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4273586">if</span>&nbsp;<span class="ident" id="4273589">idx</span>&nbsp;<span class="op" id="4273593">:=</span>&nbsp;<span class="ident" id="4273596">bytes</span><span class="op" id="4273601">.</span><span class="ident" id="4273602">Index</span><span class="op" id="4273607">(</span><span class="ident" id="4273608">peek</span><span class="op" id="4273612">,</span>&nbsp;<span class="ident" id="4273614">p</span><span class="op" id="4273615">.</span><span class="ident" id="4273616">mr</span><span class="op" id="4273618">.</span><span class="ident" id="4273619">nlDashBoundary</span><span class="op" id="4273633">)</span><span class="op" id="4273634">;</span>&nbsp;<span class="ident" id="4273636">idx</span>&nbsp;<span class="op" id="4273640">!=</span>&nbsp;<span class="op" id="4273643">-</span><span class="num" id="4273644">1</span>&nbsp;<span class="op" id="4273646">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4273650">nCopy</span>&nbsp;<span class="op" id="4273656">=</span>&nbsp;<span class="ident" id="4273658">idx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4273664">foundBoundary</span>&nbsp;<span class="op" id="4273678">=</span>&nbsp;<span class="builtintype" id="4273680">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4273686">}</span>&nbsp;<span class="keyword" id="4273688">else</span>&nbsp;<span class="keyword" id="4273693">if</span>&nbsp;<span class="ident" id="4273696">safeCount</span>&nbsp;<span class="op" id="4273706">:=</span>&nbsp;<span class="builtinfunc" id="4273709">len</span><span class="op" id="4273712">(</span><span class="ident" id="4273713">peek</span><span class="op" id="4273717">)</span>&nbsp;<span class="op" id="4273719">-</span>&nbsp;<span class="builtinfunc" id="4273721">len</span><span class="op" id="4273724">(</span><span class="ident" id="4273725">p</span><span class="op" id="4273726">.</span><span class="ident" id="4273727">mr</span><span class="op" id="4273729">.</span><span class="ident" id="4273730">nlDashBoundary</span><span class="op" id="4273744">)</span><span class="op" id="4273745">;</span>&nbsp;<span class="ident" id="4273747">safeCount</span>&nbsp;<span class="op" id="4273757">&gt;</span>&nbsp;<span class="num" id="4273759">0</span>&nbsp;<span class="op" id="4273761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4273765">nCopy</span>&nbsp;<span class="op" id="4273771">=</span>&nbsp;<span class="ident" id="4273773">safeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4273784">}</span>&nbsp;<span class="keyword" id="4273786">else</span>&nbsp;<span class="keyword" id="4273791">if</span>&nbsp;<span class="ident" id="4273794">unexpectedEOF</span>&nbsp;<span class="op" id="4273808">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4273812">//&nbsp;If&nbsp;we&#39;ve&nbsp;run&nbsp;out&nbsp;of&nbsp;peek&nbsp;buffer&nbsp;and&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4273866">//&nbsp;wasn&#39;t&nbsp;found&nbsp;(and&nbsp;can&#39;t&nbsp;possibly&nbsp;fit),&nbsp;we&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4273923">//&nbsp;hit&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file&nbsp;unexpectedly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4273966">return</span>&nbsp;<span class="num" id="4273973">0</span><span class="op" id="4273974">,</span>&nbsp;<span class="ident" id="4273976">io</span><span class="op" id="4273978">.</span><span class="ident" id="4273979">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4273997">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4274000">if</span>&nbsp;<span class="ident" id="4274003">nCopy</span>&nbsp;<span class="op" id="4274009">&gt;</span>&nbsp;<span class="num" id="4274011">0</span>&nbsp;<span class="op" id="4274013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4274017">if</span>&nbsp;<span class="ident" id="4274020">_</span><span class="op" id="4274021">,</span>&nbsp;<span class="ident" id="4274023">err</span>&nbsp;<span class="op" id="4274027">:=</span>&nbsp;<span class="ident" id="4274030">io</span><span class="op" id="4274032">.</span><span class="ident" id="4274033">CopyN</span><span class="op" id="4274038">(</span><span class="ident" id="4274039">p</span><span class="op" id="4274040">.</span><span class="ident" id="4274041">buffer</span><span class="op" id="4274047">,</span>&nbsp;<span class="ident" id="4274049">p</span><span class="op" id="4274050">.</span><span class="ident" id="4274051">mr</span><span class="op" id="4274053">.</span><span class="ident" id="4274054">bufReader</span><span class="op" id="4274063">,</span>&nbsp;<span class="ident" id="4274065">int64</span><span class="op" id="4274070">(</span><span class="ident" id="4274071">nCopy</span><span class="op" id="4274076">)</span><span class="op" id="4274077">)</span><span class="op" id="4274078">;</span>&nbsp;<span class="ident" id="4274080">err</span>&nbsp;<span class="op" id="4274084">!=</span>&nbsp;<span class="ident" id="4274087">nil</span>&nbsp;<span class="op" id="4274091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4274096">return</span>&nbsp;<span class="num" id="4274103">0</span><span class="op" id="4274104">,</span>&nbsp;<span class="ident" id="4274106">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4274112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4274115">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4274118">n</span><span class="op" id="4274119">,</span>&nbsp;<span class="ident" id="4274121">err</span>&nbsp;<span class="op" id="4274125">=</span>&nbsp;<span class="ident" id="4274127">p</span><span class="op" id="4274128">.</span><span class="ident" id="4274129">buffer</span><span class="op" id="4274135">.</span><span class="ident" id="4274136">Read</span><span class="op" id="4274140">(</span><span class="ident" id="4274141">d</span><span class="op" id="4274142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4274145">if</span>&nbsp;<span class="ident" id="4274148">err</span>&nbsp;<span class="op" id="4274152">==</span>&nbsp;<span class="ident" id="4274155">io</span><span class="op" id="4274157">.</span><span class="ident" id="4274158">EOF</span>&nbsp;<span class="op" id="4274162">&amp;&amp;</span>&nbsp;<span class="op" id="4274165">!</span><span class="ident" id="4274166">foundBoundary</span>&nbsp;<span class="op" id="4274180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4274184">//&nbsp;If&nbsp;the&nbsp;boundary&nbsp;hasn&#39;t&nbsp;been&nbsp;reached&nbsp;there&#39;s&nbsp;more&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4274241">//&nbsp;read,&nbsp;so&nbsp;don&#39;t&nbsp;pass&nbsp;through&nbsp;an&nbsp;EOF&nbsp;from&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4274297">err</span>&nbsp;<span class="op" id="4274301">=</span>&nbsp;<span class="ident" id="4274303">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4274308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4274311">return</span><br>
<span class="lineno"></span><span class="op" id="4274318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4274321">func</span>&nbsp;<span class="op" id="4274326">(</span><span class="ident" id="4274327">p</span>&nbsp;<span class="op" id="4274329">*</span><span class="ident" id="4274330">Part</span><span class="op" id="4274334">)</span>&nbsp;<span class="ident" id="4274336">Close</span><span class="op" id="4274341">(</span><span class="op" id="4274342">)</span>&nbsp;<span class="builtintype" id="4274344">error</span>&nbsp;<span class="op" id="4274350">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4274353">io</span><span class="op" id="4274355">.</span><span class="ident" id="4274356">Copy</span><span class="op" id="4274360">(</span><span class="ident" id="4274361">ioutil</span><span class="op" id="4274367">.</span><span class="ident" id="4274368">Discard</span><span class="op" id="4274375">,</span>&nbsp;<span class="ident" id="4274377">p</span><span class="op" id="4274378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4274381">return</span>&nbsp;<span class="ident" id="4274388">nil</span><br>
<span class="lineno"></span><span class="op" id="4274392">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4274395">//&nbsp;Reader&nbsp;is&nbsp;an&nbsp;iterator&nbsp;over&nbsp;parts&nbsp;in&nbsp;a&nbsp;MIME&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno">205</span><span class="comment" id="4274457">//&nbsp;Reader&#39;s&nbsp;underlying&nbsp;parser&nbsp;consumes&nbsp;its&nbsp;input&nbsp;as&nbsp;needed.&nbsp;&nbsp;Seeking</span><br>
<span class="lineno"></span><span class="comment" id="4274526">//&nbsp;isn&#39;t&nbsp;supported.</span><br>
<span class="lineno"></span><span class="keyword" id="4274546">type</span>&nbsp;<span class="ident" id="4274551">Reader</span>&nbsp;<span class="keyword" id="4274558">struct</span>&nbsp;<span class="op" id="4274565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4274568">bufReader</span>&nbsp;<span class="op" id="4274578">*</span><span class="ident" id="4274579">bufio</span><span class="op" id="4274584">.</span><span class="ident" id="4274585">Reader</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4274594">currentPart</span>&nbsp;<span class="op" id="4274606">*</span><span class="ident" id="4274607">Part</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4274613">partsRead</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4274625">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4274631">nl</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4274648">[</span><span class="op" id="4274649">]</span><span class="builtintype" id="4274650">byte</span>&nbsp;<span class="comment" id="4274655">//&nbsp;&#34;\r\n&#34;&nbsp;or&nbsp;&#34;\n&#34;&nbsp;(set&nbsp;after&nbsp;seeing&nbsp;first&nbsp;boundary&nbsp;line)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4274713">nlDashBoundary</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4274730">[</span><span class="op" id="4274731">]</span><span class="builtintype" id="4274732">byte</span>&nbsp;<span class="comment" id="4274737">//&nbsp;nl&nbsp;+&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4274759">dashBoundaryDash</span>&nbsp;<span class="op" id="4274776">[</span><span class="op" id="4274777">]</span><span class="builtintype" id="4274778">byte</span>&nbsp;<span class="comment" id="4274783">//&nbsp;&#34;--boundary--&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4274802">dashBoundary</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4274819">[</span><span class="op" id="4274820">]</span><span class="builtintype" id="4274821">byte</span>&nbsp;<span class="comment" id="4274826">//&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno"></span><span class="op" id="4274842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4274845">//&nbsp;NextPart&nbsp;returns&nbsp;the&nbsp;next&nbsp;part&nbsp;in&nbsp;the&nbsp;multipart&nbsp;or&nbsp;an&nbsp;error.</span><br>
<span class="lineno">220</span><span class="comment" id="4274909">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;parts,&nbsp;the&nbsp;error&nbsp;io.EOF&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="4274972">func</span>&nbsp;<span class="op" id="4274977">(</span><span class="ident" id="4274978">r</span>&nbsp;<span class="op" id="4274980">*</span><span class="ident" id="4274981">Reader</span><span class="op" id="4274987">)</span>&nbsp;<span class="ident" id="4274989">NextPart</span><span class="op" id="4274997">(</span><span class="op" id="4274998">)</span>&nbsp;<span class="op" id="4275000">(</span><span class="op" id="4275001">*</span><span class="ident" id="4275002">Part</span><span class="op" id="4275006">,</span>&nbsp;<span class="builtintype" id="4275008">error</span><span class="op" id="4275013">)</span>&nbsp;<span class="op" id="4275015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4275018">if</span>&nbsp;<span class="ident" id="4275021">r</span><span class="op" id="4275022">.</span><span class="ident" id="4275023">currentPart</span>&nbsp;<span class="op" id="4275035">!=</span>&nbsp;<span class="ident" id="4275038">nil</span>&nbsp;<span class="op" id="4275042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4275046">r</span><span class="op" id="4275047">.</span><span class="ident" id="4275048">currentPart</span><span class="op" id="4275059">.</span><span class="ident" id="4275060">Close</span><span class="op" id="4275065">(</span><span class="op" id="4275066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4275069">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4275073">expectNewPart</span>&nbsp;<span class="op" id="4275087">:=</span>&nbsp;<span class="builtintype" id="4275090">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4275097">for</span>&nbsp;<span class="op" id="4275101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4275105">line</span><span class="op" id="4275109">,</span>&nbsp;<span class="ident" id="4275111">err</span>&nbsp;<span class="op" id="4275115">:=</span>&nbsp;<span class="ident" id="4275118">r</span><span class="op" id="4275119">.</span><span class="ident" id="4275120">bufReader</span><span class="op" id="4275129">.</span><span class="ident" id="4275130">ReadSlice</span><span class="op" id="4275139">(</span><span class="string" id="4275140">&#39;\n&#39;</span><span class="op" id="4275144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4275148">if</span>&nbsp;<span class="ident" id="4275151">err</span>&nbsp;<span class="op" id="4275155">==</span>&nbsp;<span class="ident" id="4275158">io</span><span class="op" id="4275160">.</span><span class="ident" id="4275161">EOF</span>&nbsp;<span class="op" id="4275165">&amp;&amp;</span>&nbsp;<span class="ident" id="4275168">r</span><span class="op" id="4275169">.</span><span class="ident" id="4275170">isFinalBoundary</span><span class="op" id="4275185">(</span><span class="ident" id="4275186">line</span><span class="op" id="4275190">)</span>&nbsp;<span class="op" id="4275192">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4275197">//&nbsp;If&nbsp;the&nbsp;buffer&nbsp;ends&nbsp;in&nbsp;&#34;--boundary--&#34;&nbsp;without&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4275252">//&nbsp;trailing&nbsp;&#34;\r\n&#34;,&nbsp;ReadSlice&nbsp;will&nbsp;return&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4275306">//&nbsp;(since&nbsp;it&#39;s&nbsp;missing&nbsp;the&nbsp;&#39;\n&#39;),&nbsp;but&nbsp;this&nbsp;is&nbsp;a&nbsp;valid</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4275363">//&nbsp;multipart&nbsp;EOF&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;return&nbsp;io.EOF&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4275422">//&nbsp;a&nbsp;fmt-wrapped&nbsp;one.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4275447">return</span>&nbsp;<span class="ident" id="4275454">nil</span><span class="op" id="4275457">,</span>&nbsp;<span class="ident" id="4275459">io</span><span class="op" id="4275461">.</span><span class="ident" id="4275462">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4275468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4275472">if</span>&nbsp;<span class="ident" id="4275475">err</span>&nbsp;<span class="op" id="4275479">!=</span>&nbsp;<span class="ident" id="4275482">nil</span>&nbsp;<span class="op" id="4275486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4275491">return</span>&nbsp;<span class="ident" id="4275498">nil</span><span class="op" id="4275501">,</span>&nbsp;<span class="ident" id="4275503">fmt</span><span class="op" id="4275506">.</span><span class="ident" id="4275507">Errorf</span><span class="op" id="4275513">(</span><span class="string" id="4275514">&#34;multipart:&nbsp;NextPart:&nbsp;%v&#34;</span><span class="op" id="4275539">,</span>&nbsp;<span class="ident" id="4275541">err</span><span class="op" id="4275544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4275548">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4275553">if</span>&nbsp;<span class="ident" id="4275556">r</span><span class="op" id="4275557">.</span><span class="ident" id="4275558">isBoundaryDelimiterLine</span><span class="op" id="4275581">(</span><span class="ident" id="4275582">line</span><span class="op" id="4275586">)</span>&nbsp;<span class="op" id="4275588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4275593">r</span><span class="op" id="4275594">.</span><span class="ident" id="4275595">partsRead</span><span class="op" id="4275604">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4275610">bp</span><span class="op" id="4275612">,</span>&nbsp;<span class="ident" id="4275614">err</span>&nbsp;<span class="op" id="4275618">:=</span>&nbsp;<span class="ident" id="4275621">newPart</span><span class="op" id="4275628">(</span><span class="ident" id="4275629">r</span><span class="op" id="4275630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4275635">if</span>&nbsp;<span class="ident" id="4275638">err</span>&nbsp;<span class="op" id="4275642">!=</span>&nbsp;<span class="ident" id="4275645">nil</span>&nbsp;<span class="op" id="4275649">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4275655">return</span>&nbsp;<span class="ident" id="4275662">nil</span><span class="op" id="4275665">,</span>&nbsp;<span class="ident" id="4275667">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4275674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4275679">r</span><span class="op" id="4275680">.</span><span class="ident" id="4275681">currentPart</span>&nbsp;<span class="op" id="4275693">=</span>&nbsp;<span class="ident" id="4275695">bp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4275701">return</span>&nbsp;<span class="ident" id="4275708">bp</span><span class="op" id="4275710">,</span>&nbsp;<span class="ident" id="4275712">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4275718">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4275723">if</span>&nbsp;<span class="ident" id="4275726">r</span><span class="op" id="4275727">.</span><span class="ident" id="4275728">isFinalBoundary</span><span class="op" id="4275743">(</span><span class="ident" id="4275744">line</span><span class="op" id="4275748">)</span>&nbsp;<span class="op" id="4275750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4275755">//&nbsp;Expected&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4275774">return</span>&nbsp;<span class="ident" id="4275781">nil</span><span class="op" id="4275784">,</span>&nbsp;<span class="ident" id="4275786">io</span><span class="op" id="4275788">.</span><span class="ident" id="4275789">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4275795">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4275800">if</span>&nbsp;<span class="ident" id="4275803">expectNewPart</span>&nbsp;<span class="op" id="4275817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4275822">return</span>&nbsp;<span class="ident" id="4275829">nil</span><span class="op" id="4275832">,</span>&nbsp;<span class="ident" id="4275834">fmt</span><span class="op" id="4275837">.</span><span class="ident" id="4275838">Errorf</span><span class="op" id="4275844">(</span><span class="string" id="4275845">&#34;multipart:&nbsp;expecting&nbsp;a&nbsp;new&nbsp;Part;&nbsp;got&nbsp;line&nbsp;%q&#34;</span><span class="op" id="4275891">,</span>&nbsp;<span class="builtintype" id="4275893">string</span><span class="op" id="4275899">(</span><span class="ident" id="4275900">line</span><span class="op" id="4275904">)</span><span class="op" id="4275905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4275909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4275914">if</span>&nbsp;<span class="ident" id="4275917">r</span><span class="op" id="4275918">.</span><span class="ident" id="4275919">partsRead</span>&nbsp;<span class="op" id="4275929">==</span>&nbsp;<span class="num" id="4275932">0</span>&nbsp;<span class="op" id="4275934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4275939">//&nbsp;skip&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4275955">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4275966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4275971">//&nbsp;Consume&nbsp;the&nbsp;&#34;\n&#34;&nbsp;or&nbsp;&#34;\r\n&#34;&nbsp;separator&nbsp;between&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4276025">//&nbsp;body&nbsp;of&nbsp;the&nbsp;previous&nbsp;part&nbsp;and&nbsp;the&nbsp;boundary&nbsp;line&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4276081">//&nbsp;now&nbsp;expect&nbsp;will&nbsp;follow.&nbsp;(either&nbsp;a&nbsp;new&nbsp;part&nbsp;or&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4276136">//&nbsp;end&nbsp;boundary)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4276155">if</span>&nbsp;<span class="ident" id="4276158">bytes</span><span class="op" id="4276163">.</span><span class="ident" id="4276164">Equal</span><span class="op" id="4276169">(</span><span class="ident" id="4276170">line</span><span class="op" id="4276174">,</span>&nbsp;<span class="ident" id="4276176">r</span><span class="op" id="4276177">.</span><span class="ident" id="4276178">nl</span><span class="op" id="4276180">)</span>&nbsp;<span class="op" id="4276182">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4276187">expectNewPart</span>&nbsp;<span class="op" id="4276201">=</span>&nbsp;<span class="builtintype" id="4276203">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4276211">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4276222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4276227">return</span>&nbsp;<span class="ident" id="4276234">nil</span><span class="op" id="4276237">,</span>&nbsp;<span class="ident" id="4276239">fmt</span><span class="op" id="4276242">.</span><span class="ident" id="4276243">Errorf</span><span class="op" id="4276249">(</span><span class="string" id="4276250">&#34;multipart:&nbsp;unexpected&nbsp;line&nbsp;in&nbsp;Next():&nbsp;%q&#34;</span><span class="op" id="4276292">,</span>&nbsp;<span class="ident" id="4276294">line</span><span class="op" id="4276298">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4276301">}</span><br>
<span class="lineno"></span><span class="op" id="4276303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4276306">//&nbsp;isFinalBoundary&nbsp;reports&nbsp;whether&nbsp;line&nbsp;is&nbsp;the&nbsp;final&nbsp;boundary&nbsp;line</span><br>
<span class="lineno"></span><span class="comment" id="4276373">//&nbsp;indicating&nbsp;that&nbsp;all&nbsp;parts&nbsp;are&nbsp;over.</span><br>
<span class="lineno">280</span><span class="comment" id="4276412">//&nbsp;It&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(\r\n)?$`</span><br>
<span class="lineno"></span><span class="keyword" id="4276456">func</span>&nbsp;<span class="op" id="4276461">(</span><span class="ident" id="4276462">mr</span>&nbsp;<span class="op" id="4276465">*</span><span class="ident" id="4276466">Reader</span><span class="op" id="4276472">)</span>&nbsp;<span class="ident" id="4276474">isFinalBoundary</span><span class="op" id="4276489">(</span><span class="ident" id="4276490">line</span>&nbsp;<span class="op" id="4276495">[</span><span class="op" id="4276496">]</span><span class="builtintype" id="4276497">byte</span><span class="op" id="4276501">)</span>&nbsp;<span class="builtintype" id="4276503">bool</span>&nbsp;<span class="op" id="4276508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4276511">if</span>&nbsp;<span class="op" id="4276514">!</span><span class="ident" id="4276515">bytes</span><span class="op" id="4276520">.</span><span class="ident" id="4276521">HasPrefix</span><span class="op" id="4276530">(</span><span class="ident" id="4276531">line</span><span class="op" id="4276535">,</span>&nbsp;<span class="ident" id="4276537">mr</span><span class="op" id="4276539">.</span><span class="ident" id="4276540">dashBoundaryDash</span><span class="op" id="4276556">)</span>&nbsp;<span class="op" id="4276558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4276562">return</span>&nbsp;<span class="builtintype" id="4276569">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4276576">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4276579">rest</span>&nbsp;<span class="op" id="4276584">:=</span>&nbsp;<span class="ident" id="4276587">line</span><span class="op" id="4276591">[</span><span class="builtinfunc" id="4276592">len</span><span class="op" id="4276595">(</span><span class="ident" id="4276596">mr</span><span class="op" id="4276598">.</span><span class="ident" id="4276599">dashBoundaryDash</span><span class="op" id="4276615">)</span><span class="op" id="4276616">:</span><span class="op" id="4276617">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4276620">rest</span>&nbsp;<span class="op" id="4276625">=</span>&nbsp;<span class="ident" id="4276627">skipLWSPChar</span><span class="op" id="4276639">(</span><span class="ident" id="4276640">rest</span><span class="op" id="4276644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4276647">return</span>&nbsp;<span class="builtinfunc" id="4276654">len</span><span class="op" id="4276657">(</span><span class="ident" id="4276658">rest</span><span class="op" id="4276662">)</span>&nbsp;<span class="op" id="4276664">==</span>&nbsp;<span class="num" id="4276667">0</span>&nbsp;<span class="op" id="4276669">||</span>&nbsp;<span class="ident" id="4276672">bytes</span><span class="op" id="4276677">.</span><span class="ident" id="4276678">Equal</span><span class="op" id="4276683">(</span><span class="ident" id="4276684">rest</span><span class="op" id="4276688">,</span>&nbsp;<span class="ident" id="4276690">mr</span><span class="op" id="4276692">.</span><span class="ident" id="4276693">nl</span><span class="op" id="4276695">)</span><br>
<span class="lineno"></span><span class="op" id="4276697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="4276700">func</span>&nbsp;<span class="op" id="4276705">(</span><span class="ident" id="4276706">mr</span>&nbsp;<span class="op" id="4276709">*</span><span class="ident" id="4276710">Reader</span><span class="op" id="4276716">)</span>&nbsp;<span class="ident" id="4276718">isBoundaryDelimiterLine</span><span class="op" id="4276741">(</span><span class="ident" id="4276742">line</span>&nbsp;<span class="op" id="4276747">[</span><span class="op" id="4276748">]</span><span class="builtintype" id="4276749">byte</span><span class="op" id="4276753">)</span>&nbsp;<span class="op" id="4276755">(</span><span class="ident" id="4276756">ret</span>&nbsp;<span class="builtintype" id="4276760">bool</span><span class="op" id="4276764">)</span>&nbsp;<span class="op" id="4276766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4276769">//&nbsp;http://tools.ietf.org/html/rfc2046#section-5.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4276820">//&nbsp;&nbsp;&nbsp;The&nbsp;boundary&nbsp;delimiter&nbsp;line&nbsp;is&nbsp;then&nbsp;defined&nbsp;as&nbsp;a&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4276880">//&nbsp;&nbsp;&nbsp;consisting&nbsp;entirely&nbsp;of&nbsp;two&nbsp;hyphen&nbsp;characters&nbsp;(&#34;-&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4276937">//&nbsp;&nbsp;&nbsp;decimal&nbsp;value&nbsp;45)&nbsp;followed&nbsp;by&nbsp;the&nbsp;boundary&nbsp;parameter</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4276996">//&nbsp;&nbsp;&nbsp;value&nbsp;from&nbsp;the&nbsp;Content-Type&nbsp;header&nbsp;field,&nbsp;optional&nbsp;linear</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4277060">//&nbsp;&nbsp;&nbsp;whitespace,&nbsp;and&nbsp;a&nbsp;terminating&nbsp;CRLF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4277102">if</span>&nbsp;<span class="op" id="4277105">!</span><span class="ident" id="4277106">bytes</span><span class="op" id="4277111">.</span><span class="ident" id="4277112">HasPrefix</span><span class="op" id="4277121">(</span><span class="ident" id="4277122">line</span><span class="op" id="4277126">,</span>&nbsp;<span class="ident" id="4277128">mr</span><span class="op" id="4277130">.</span><span class="ident" id="4277131">dashBoundary</span><span class="op" id="4277143">)</span>&nbsp;<span class="op" id="4277145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4277149">return</span>&nbsp;<span class="builtintype" id="4277156">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4277163">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4277166">rest</span>&nbsp;<span class="op" id="4277171">:=</span>&nbsp;<span class="ident" id="4277174">line</span><span class="op" id="4277178">[</span><span class="builtinfunc" id="4277179">len</span><span class="op" id="4277182">(</span><span class="ident" id="4277183">mr</span><span class="op" id="4277185">.</span><span class="ident" id="4277186">dashBoundary</span><span class="op" id="4277198">)</span><span class="op" id="4277199">:</span><span class="op" id="4277200">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4277203">rest</span>&nbsp;<span class="op" id="4277208">=</span>&nbsp;<span class="ident" id="4277210">skipLWSPChar</span><span class="op" id="4277222">(</span><span class="ident" id="4277223">rest</span><span class="op" id="4277227">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4277231">//&nbsp;On&nbsp;the&nbsp;first&nbsp;part,&nbsp;see&nbsp;our&nbsp;lines&nbsp;are&nbsp;ending&nbsp;in&nbsp;\n&nbsp;instead&nbsp;of&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4277301">//&nbsp;and&nbsp;switch&nbsp;into&nbsp;that&nbsp;mode&nbsp;if&nbsp;so.&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;violation&nbsp;of&nbsp;the&nbsp;spec,</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4277372">//&nbsp;but&nbsp;occurs&nbsp;in&nbsp;practice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4277400">if</span>&nbsp;<span class="ident" id="4277403">mr</span><span class="op" id="4277405">.</span><span class="ident" id="4277406">partsRead</span>&nbsp;<span class="op" id="4277416">==</span>&nbsp;<span class="num" id="4277419">0</span>&nbsp;<span class="op" id="4277421">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4277424">len</span><span class="op" id="4277427">(</span><span class="ident" id="4277428">rest</span><span class="op" id="4277432">)</span>&nbsp;<span class="op" id="4277434">==</span>&nbsp;<span class="num" id="4277437">1</span>&nbsp;<span class="op" id="4277439">&amp;&amp;</span>&nbsp;<span class="ident" id="4277442">rest</span><span class="op" id="4277446">[</span><span class="num" id="4277447">0</span><span class="op" id="4277448">]</span>&nbsp;<span class="op" id="4277450">==</span>&nbsp;<span class="string" id="4277453">&#39;\n&#39;</span>&nbsp;<span class="op" id="4277458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4277462">mr</span><span class="op" id="4277464">.</span><span class="ident" id="4277465">nl</span>&nbsp;<span class="op" id="4277468">=</span>&nbsp;<span class="ident" id="4277470">mr</span><span class="op" id="4277472">.</span><span class="ident" id="4277473">nl</span><span class="op" id="4277475">[</span><span class="num" id="4277476">1</span><span class="op" id="4277477">:</span><span class="op" id="4277478">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4277482">mr</span><span class="op" id="4277484">.</span><span class="ident" id="4277485">nlDashBoundary</span>&nbsp;<span class="op" id="4277500">=</span>&nbsp;<span class="ident" id="4277502">mr</span><span class="op" id="4277504">.</span><span class="ident" id="4277505">nlDashBoundary</span><span class="op" id="4277519">[</span><span class="num" id="4277520">1</span><span class="op" id="4277521">:</span><span class="op" id="4277522">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4277525">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4277528">return</span>&nbsp;<span class="ident" id="4277535">bytes</span><span class="op" id="4277540">.</span><span class="ident" id="4277541">Equal</span><span class="op" id="4277546">(</span><span class="ident" id="4277547">rest</span><span class="op" id="4277551">,</span>&nbsp;<span class="ident" id="4277553">mr</span><span class="op" id="4277555">.</span><span class="ident" id="4277556">nl</span><span class="op" id="4277558">)</span><br>
<span class="lineno"></span><span class="op" id="4277560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4277563">//&nbsp;peekBufferIsEmptyPart&nbsp;reports&nbsp;whether&nbsp;the&nbsp;provided&nbsp;peek-ahead</span><br>
<span class="lineno"></span><span class="comment" id="4277628">//&nbsp;buffer&nbsp;represents&nbsp;an&nbsp;empty&nbsp;part.&nbsp;It&nbsp;is&nbsp;called&nbsp;only&nbsp;if&nbsp;we&#39;ve&nbsp;not</span><br>
<span class="lineno">315</span><span class="comment" id="4277695">//&nbsp;already&nbsp;read&nbsp;any&nbsp;bytes&nbsp;in&nbsp;this&nbsp;part&nbsp;and&nbsp;checks&nbsp;for&nbsp;the&nbsp;case&nbsp;of&nbsp;MIME</span><br>
<span class="lineno"></span><span class="comment" id="4277766">//&nbsp;software&nbsp;not&nbsp;writing&nbsp;the&nbsp;\r\n&nbsp;on&nbsp;empty&nbsp;parts.&nbsp;Some&nbsp;does,&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="4277831">//&nbsp;doesn&#39;t.</span><br>
<span class="lineno"></span><span class="comment" id="4277843">//</span><br>
<span class="lineno"></span><span class="comment" id="4277846">//&nbsp;This&nbsp;checks&nbsp;that&nbsp;what&nbsp;follows&nbsp;the&nbsp;&#34;--boundary&#34;&nbsp;is&nbsp;actually&nbsp;the&nbsp;end</span><br>
<span class="lineno">320</span><span class="comment" id="4277916">//&nbsp;(&#34;--boundary--&#34;&nbsp;with&nbsp;optional&nbsp;whitespace)&nbsp;or&nbsp;optional&nbsp;whitespace</span><br>
<span class="lineno"></span><span class="comment" id="4277984">//&nbsp;and&nbsp;then&nbsp;a&nbsp;newline,&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;catch&nbsp;&#34;--boundaryFAKE&#34;,&nbsp;in&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="4278052">//&nbsp;case&nbsp;the&nbsp;whole&nbsp;line&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="4278096">func</span>&nbsp;<span class="op" id="4278101">(</span><span class="ident" id="4278102">mr</span>&nbsp;<span class="op" id="4278105">*</span><span class="ident" id="4278106">Reader</span><span class="op" id="4278112">)</span>&nbsp;<span class="ident" id="4278114">peekBufferIsEmptyPart</span><span class="op" id="4278135">(</span><span class="ident" id="4278136">peek</span>&nbsp;<span class="op" id="4278141">[</span><span class="op" id="4278142">]</span><span class="builtintype" id="4278143">byte</span><span class="op" id="4278147">)</span>&nbsp;<span class="builtintype" id="4278149">bool</span>&nbsp;<span class="op" id="4278154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4278157">//&nbsp;End&nbsp;of&nbsp;parts&nbsp;case.</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4278180">//&nbsp;Test&nbsp;whether&nbsp;peek&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(?:\r\n|$)`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4278242">if</span>&nbsp;<span class="ident" id="4278245">bytes</span><span class="op" id="4278250">.</span><span class="ident" id="4278251">HasPrefix</span><span class="op" id="4278260">(</span><span class="ident" id="4278261">peek</span><span class="op" id="4278265">,</span>&nbsp;<span class="ident" id="4278267">mr</span><span class="op" id="4278269">.</span><span class="ident" id="4278270">dashBoundaryDash</span><span class="op" id="4278286">)</span>&nbsp;<span class="op" id="4278288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4278292">rest</span>&nbsp;<span class="op" id="4278297">:=</span>&nbsp;<span class="ident" id="4278300">peek</span><span class="op" id="4278304">[</span><span class="builtinfunc" id="4278305">len</span><span class="op" id="4278308">(</span><span class="ident" id="4278309">mr</span><span class="op" id="4278311">.</span><span class="ident" id="4278312">dashBoundaryDash</span><span class="op" id="4278328">)</span><span class="op" id="4278329">:</span><span class="op" id="4278330">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4278334">rest</span>&nbsp;<span class="op" id="4278339">=</span>&nbsp;<span class="ident" id="4278341">skipLWSPChar</span><span class="op" id="4278353">(</span><span class="ident" id="4278354">rest</span><span class="op" id="4278358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4278362">return</span>&nbsp;<span class="ident" id="4278369">bytes</span><span class="op" id="4278374">.</span><span class="ident" id="4278375">HasPrefix</span><span class="op" id="4278384">(</span><span class="ident" id="4278385">rest</span><span class="op" id="4278389">,</span>&nbsp;<span class="ident" id="4278391">mr</span><span class="op" id="4278393">.</span><span class="ident" id="4278394">nl</span><span class="op" id="4278396">)</span>&nbsp;<span class="op" id="4278398">||</span>&nbsp;<span class="builtinfunc" id="4278401">len</span><span class="op" id="4278404">(</span><span class="ident" id="4278405">rest</span><span class="op" id="4278409">)</span>&nbsp;<span class="op" id="4278411">==</span>&nbsp;<span class="num" id="4278414">0</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4278417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4278420">if</span>&nbsp;<span class="op" id="4278423">!</span><span class="ident" id="4278424">bytes</span><span class="op" id="4278429">.</span><span class="ident" id="4278430">HasPrefix</span><span class="op" id="4278439">(</span><span class="ident" id="4278440">peek</span><span class="op" id="4278444">,</span>&nbsp;<span class="ident" id="4278446">mr</span><span class="op" id="4278448">.</span><span class="ident" id="4278449">dashBoundary</span><span class="op" id="4278461">)</span>&nbsp;<span class="op" id="4278463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4278467">return</span>&nbsp;<span class="builtintype" id="4278474">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4278481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4278484">//&nbsp;Test&nbsp;whether&nbsp;rest&nbsp;matches&nbsp;`^[&nbsp;\t]*\r\n`)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4278529">rest</span>&nbsp;<span class="op" id="4278534">:=</span>&nbsp;<span class="ident" id="4278537">peek</span><span class="op" id="4278541">[</span><span class="builtinfunc" id="4278542">len</span><span class="op" id="4278545">(</span><span class="ident" id="4278546">mr</span><span class="op" id="4278548">.</span><span class="ident" id="4278549">dashBoundary</span><span class="op" id="4278561">)</span><span class="op" id="4278562">:</span><span class="op" id="4278563">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4278566">rest</span>&nbsp;<span class="op" id="4278571">=</span>&nbsp;<span class="ident" id="4278573">skipLWSPChar</span><span class="op" id="4278585">(</span><span class="ident" id="4278586">rest</span><span class="op" id="4278590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4278593">return</span>&nbsp;<span class="ident" id="4278600">bytes</span><span class="op" id="4278605">.</span><span class="ident" id="4278606">HasPrefix</span><span class="op" id="4278615">(</span><span class="ident" id="4278616">rest</span><span class="op" id="4278620">,</span>&nbsp;<span class="ident" id="4278622">mr</span><span class="op" id="4278624">.</span><span class="ident" id="4278625">nl</span><span class="op" id="4278627">)</span><br>
<span class="lineno"></span><span class="op" id="4278629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span><span class="comment" id="4278632">//&nbsp;skipLWSPChar&nbsp;returns&nbsp;b&nbsp;with&nbsp;leading&nbsp;spaces&nbsp;and&nbsp;tabs&nbsp;removed.</span><br>
<span class="lineno"></span><span class="comment" id="4278696">//&nbsp;RFC&nbsp;822&nbsp;defines:</span><br>
<span class="lineno"></span><span class="comment" id="4278716">//&nbsp;&nbsp;&nbsp;&nbsp;LWSP-char&nbsp;=&nbsp;SPACE&nbsp;/&nbsp;HTAB</span><br>
<span class="lineno"></span><span class="keyword" id="4278747">func</span>&nbsp;<span class="ident" id="4278752">skipLWSPChar</span><span class="op" id="4278764">(</span><span class="ident" id="4278765">b</span>&nbsp;<span class="op" id="4278767">[</span><span class="op" id="4278768">]</span><span class="builtintype" id="4278769">byte</span><span class="op" id="4278773">)</span>&nbsp;<span class="op" id="4278775">[</span><span class="op" id="4278776">]</span><span class="builtintype" id="4278777">byte</span>&nbsp;<span class="op" id="4278782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4278785">for</span>&nbsp;<span class="builtinfunc" id="4278789">len</span><span class="op" id="4278792">(</span><span class="ident" id="4278793">b</span><span class="op" id="4278794">)</span>&nbsp;<span class="op" id="4278796">&gt;</span>&nbsp;<span class="num" id="4278798">0</span>&nbsp;<span class="op" id="4278800">&amp;&amp;</span>&nbsp;<span class="op" id="4278803">(</span><span class="ident" id="4278804">b</span><span class="op" id="4278805">[</span><span class="num" id="4278806">0</span><span class="op" id="4278807">]</span>&nbsp;<span class="op" id="4278809">==</span>&nbsp;<span class="string" id="4278812">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4278816">||</span>&nbsp;<span class="ident" id="4278819">b</span><span class="op" id="4278820">[</span><span class="num" id="4278821">0</span><span class="op" id="4278822">]</span>&nbsp;<span class="op" id="4278824">==</span>&nbsp;<span class="string" id="4278827">&#39;\t&#39;</span><span class="op" id="4278831">)</span>&nbsp;<span class="op" id="4278833">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4278837">b</span>&nbsp;<span class="op" id="4278839">=</span>&nbsp;<span class="ident" id="4278841">b</span><span class="op" id="4278842">[</span><span class="num" id="4278843">1</span><span class="op" id="4278844">:</span><span class="op" id="4278845">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4278848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4278851">return</span>&nbsp;<span class="ident" id="4278858">b</span><br>
<span class="lineno"></span><span class="op" id="4278860">}</span>
</div>
</body>
</html>
