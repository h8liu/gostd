<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html" class="current">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8003360">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8003415">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8003469">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8003520">package</span>&nbsp;<span class="ident" id="8003528">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8003533">import</span>&nbsp;<span class="op" id="8003540">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8003543">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8003566">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8003576">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8003583">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8003596">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8003607">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8003618">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8003629">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8003637">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="8003648">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8003655">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="8003658">func</span>&nbsp;<span class="ident" id="8003663">init</span><span class="op" id="8003667">(</span><span class="op" id="8003668">)</span>&nbsp;<span class="op" id="8003670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8003673">type</span>&nbsp;<span class="ident" id="8003678">dbConn</span>&nbsp;<span class="keyword" id="8003685">struct</span>&nbsp;<span class="op" id="8003692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8003696">db</span>&nbsp;<span class="op" id="8003699">*</span><span class="ident" id="8003700">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8003705">c</span>&nbsp;&nbsp;<span class="op" id="8003708">*</span><span class="ident" id="8003709">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8003721">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8003724">freedFrom</span>&nbsp;<span class="op" id="8003734">:=</span>&nbsp;<span class="builtinfunc" id="8003737">make</span><span class="op" id="8003741">(</span><span class="keyword" id="8003742">map</span><span class="op" id="8003745">[</span><span class="ident" id="8003746">dbConn</span><span class="op" id="8003752">]</span><span class="builtintype" id="8003753">string</span><span class="op" id="8003759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8003762">putConnHook</span>&nbsp;<span class="op" id="8003774">=</span>&nbsp;<span class="keyword" id="8003776">func</span><span class="op" id="8003780">(</span><span class="ident" id="8003781">db</span>&nbsp;<span class="op" id="8003784">*</span><span class="ident" id="8003785">DB</span><span class="op" id="8003787">,</span>&nbsp;<span class="ident" id="8003789">c</span>&nbsp;<span class="op" id="8003791">*</span><span class="ident" id="8003792">driverConn</span><span class="op" id="8003802">)</span>&nbsp;<span class="op" id="8003804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8003808">idx</span>&nbsp;<span class="op" id="8003812">:=</span>&nbsp;<span class="op" id="8003815">-</span><span class="num" id="8003816">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8003820">for</span>&nbsp;<span class="ident" id="8003824">i</span><span class="op" id="8003825">,</span>&nbsp;<span class="ident" id="8003827">v</span>&nbsp;<span class="op" id="8003829">:=</span>&nbsp;<span class="keyword" id="8003832">range</span>&nbsp;<span class="ident" id="8003838">db</span><span class="op" id="8003840">.</span><span class="ident" id="8003841">freeConn</span>&nbsp;<span class="op" id="8003850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8003855">if</span>&nbsp;<span class="ident" id="8003858">v</span>&nbsp;<span class="op" id="8003860">==</span>&nbsp;<span class="ident" id="8003863">c</span>&nbsp;<span class="op" id="8003865">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8003871">idx</span>&nbsp;<span class="op" id="8003875">=</span>&nbsp;<span class="ident" id="8003877">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8003883">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8003892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8003896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8003900">if</span>&nbsp;<span class="ident" id="8003903">idx</span>&nbsp;<span class="op" id="8003907">&gt;=</span>&nbsp;<span class="num" id="8003910">0</span>&nbsp;<span class="op" id="8003912">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8003917">//&nbsp;print&nbsp;before&nbsp;panic,&nbsp;as&nbsp;panic&nbsp;may&nbsp;get&nbsp;lost&nbsp;due&nbsp;to&nbsp;conflicting&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8003990">//&nbsp;(all&nbsp;goroutines&nbsp;asleep)&nbsp;elsewhere,&nbsp;since&nbsp;we&nbsp;might&nbsp;not&nbsp;unlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8004057">//&nbsp;the&nbsp;mutex&nbsp;in&nbsp;freeConn&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8004091">println</span><span class="op" id="8004098">(</span><span class="string" id="8004099">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&nbsp;conflicts&nbsp;are:\nA)&nbsp;&#34;</span>&nbsp;<span class="op" id="8004142">+</span>&nbsp;<span class="ident" id="8004144">freedFrom</span><span class="op" id="8004153">[</span><span class="ident" id="8004154">dbConn</span><span class="op" id="8004160">{</span><span class="ident" id="8004161">db</span><span class="op" id="8004163">,</span>&nbsp;<span class="ident" id="8004165">c</span><span class="op" id="8004166">}</span><span class="op" id="8004167">]</span>&nbsp;<span class="op" id="8004169">+</span>&nbsp;<span class="string" id="8004171">&#34;\n\nand\nB)&nbsp;&#34;</span>&nbsp;<span class="op" id="8004186">+</span>&nbsp;<span class="ident" id="8004188">stack</span><span class="op" id="8004193">(</span><span class="op" id="8004194">)</span><span class="op" id="8004195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8004200">panic</span><span class="op" id="8004205">(</span><span class="string" id="8004206">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&#34;</span><span class="op" id="8004228">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8004232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8004236">freedFrom</span><span class="op" id="8004245">[</span><span class="ident" id="8004246">dbConn</span><span class="op" id="8004252">{</span><span class="ident" id="8004253">db</span><span class="op" id="8004255">,</span>&nbsp;<span class="ident" id="8004257">c</span><span class="op" id="8004258">}</span><span class="op" id="8004259">]</span>&nbsp;<span class="op" id="8004261">=</span>&nbsp;<span class="ident" id="8004263">stack</span><span class="op" id="8004268">(</span><span class="op" id="8004269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8004272">}</span><br>
<span class="lineno"></span><span class="op" id="8004274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="8004277">const</span>&nbsp;<span class="ident" id="8004283">fakeDBName</span>&nbsp;<span class="op" id="8004294">=</span>&nbsp;<span class="string" id="8004296">&#34;foo&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8004303">var</span>&nbsp;<span class="ident" id="8004307">chrisBirthday</span>&nbsp;<span class="op" id="8004321">=</span>&nbsp;<span class="ident" id="8004323">time</span><span class="op" id="8004327">.</span><span class="ident" id="8004328">Unix</span><span class="op" id="8004332">(</span><span class="num" id="8004333">123456789</span><span class="op" id="8004342">,</span>&nbsp;<span class="num" id="8004344">0</span><span class="op" id="8004345">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8004348">func</span>&nbsp;<span class="ident" id="8004353">newTestDB</span><span class="op" id="8004362">(</span><span class="ident" id="8004363">t</span>&nbsp;<span class="ident" id="8004365">testing</span><span class="op" id="8004372">.</span><span class="ident" id="8004373">TB</span><span class="op" id="8004375">,</span>&nbsp;<span class="ident" id="8004377">name</span>&nbsp;<span class="builtintype" id="8004382">string</span><span class="op" id="8004388">)</span>&nbsp;<span class="op" id="8004390">*</span><span class="ident" id="8004391">DB</span>&nbsp;<span class="op" id="8004394">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8004397">db</span><span class="op" id="8004399">,</span>&nbsp;<span class="ident" id="8004401">err</span>&nbsp;<span class="op" id="8004405">:=</span>&nbsp;<span class="ident" id="8004408">Open</span><span class="op" id="8004412">(</span><span class="string" id="8004413">&#34;test&#34;</span><span class="op" id="8004419">,</span>&nbsp;<span class="ident" id="8004421">fakeDBName</span><span class="op" id="8004431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8004434">if</span>&nbsp;<span class="ident" id="8004437">err</span>&nbsp;<span class="op" id="8004441">!=</span>&nbsp;<span class="builtintype" id="8004444">nil</span>&nbsp;<span class="op" id="8004448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8004452">t</span><span class="op" id="8004453">.</span><span class="ident" id="8004454">Fatalf</span><span class="op" id="8004460">(</span><span class="string" id="8004461">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="8004471">,</span>&nbsp;<span class="ident" id="8004473">err</span><span class="op" id="8004476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8004479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8004482">if</span>&nbsp;<span class="ident" id="8004485">_</span><span class="op" id="8004486">,</span>&nbsp;<span class="ident" id="8004488">err</span>&nbsp;<span class="op" id="8004492">:=</span>&nbsp;<span class="ident" id="8004495">db</span><span class="op" id="8004497">.</span><span class="ident" id="8004498">Exec</span><span class="op" id="8004502">(</span><span class="string" id="8004503">&#34;WIPE&#34;</span><span class="op" id="8004509">)</span><span class="op" id="8004510">;</span>&nbsp;<span class="ident" id="8004512">err</span>&nbsp;<span class="op" id="8004516">!=</span>&nbsp;<span class="builtintype" id="8004519">nil</span>&nbsp;<span class="op" id="8004523">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8004527">t</span><span class="op" id="8004528">.</span><span class="ident" id="8004529">Fatalf</span><span class="op" id="8004535">(</span><span class="string" id="8004536">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="8004551">,</span>&nbsp;<span class="ident" id="8004553">err</span><span class="op" id="8004556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8004559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8004562">if</span>&nbsp;<span class="ident" id="8004565">name</span>&nbsp;<span class="op" id="8004570">==</span>&nbsp;<span class="string" id="8004573">&#34;people&#34;</span>&nbsp;<span class="op" id="8004582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8004586">exec</span><span class="op" id="8004590">(</span><span class="ident" id="8004591">t</span><span class="op" id="8004592">,</span>&nbsp;<span class="ident" id="8004594">db</span><span class="op" id="8004596">,</span>&nbsp;<span class="string" id="8004598">&#34;CREATE|people|name=string,age=int32,photo=blob,dead=bool,bdate=datetime&#34;</span><span class="op" id="8004671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8004675">exec</span><span class="op" id="8004679">(</span><span class="ident" id="8004680">t</span><span class="op" id="8004681">,</span>&nbsp;<span class="ident" id="8004683">db</span><span class="op" id="8004685">,</span>&nbsp;<span class="string" id="8004687">&#34;INSERT|people|name=Alice,age=?,photo=APHOTO&#34;</span><span class="op" id="8004732">,</span>&nbsp;<span class="num" id="8004734">1</span><span class="op" id="8004735">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8004739">exec</span><span class="op" id="8004743">(</span><span class="ident" id="8004744">t</span><span class="op" id="8004745">,</span>&nbsp;<span class="ident" id="8004747">db</span><span class="op" id="8004749">,</span>&nbsp;<span class="string" id="8004751">&#34;INSERT|people|name=Bob,age=?,photo=BPHOTO&#34;</span><span class="op" id="8004794">,</span>&nbsp;<span class="num" id="8004796">2</span><span class="op" id="8004797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8004801">exec</span><span class="op" id="8004805">(</span><span class="ident" id="8004806">t</span><span class="op" id="8004807">,</span>&nbsp;<span class="ident" id="8004809">db</span><span class="op" id="8004811">,</span>&nbsp;<span class="string" id="8004813">&#34;INSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="8004866">,</span>&nbsp;<span class="num" id="8004868">3</span><span class="op" id="8004869">,</span>&nbsp;<span class="ident" id="8004871">chrisBirthday</span><span class="op" id="8004884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8004887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8004890">if</span>&nbsp;<span class="ident" id="8004893">name</span>&nbsp;<span class="op" id="8004898">==</span>&nbsp;<span class="string" id="8004901">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="8004914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8004918">//&nbsp;Magic&nbsp;table&nbsp;name&nbsp;and&nbsp;column,&nbsp;known&nbsp;by&nbsp;fakedb_test.go.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8004977">exec</span><span class="op" id="8004981">(</span><span class="ident" id="8004982">t</span><span class="op" id="8004983">,</span>&nbsp;<span class="ident" id="8004985">db</span><span class="op" id="8004987">,</span>&nbsp;<span class="string" id="8004989">&#34;CREATE|magicquery|op=string,millis=int32&#34;</span><span class="op" id="8005031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8005035">exec</span><span class="op" id="8005039">(</span><span class="ident" id="8005040">t</span><span class="op" id="8005041">,</span>&nbsp;<span class="ident" id="8005043">db</span><span class="op" id="8005045">,</span>&nbsp;<span class="string" id="8005047">&#34;INSERT|magicquery|op=sleep,millis=10&#34;</span><span class="op" id="8005085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8005088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8005091">return</span>&nbsp;<span class="ident" id="8005098">db</span><br>
<span class="lineno"></span><span class="op" id="8005101">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="8005104">func</span>&nbsp;<span class="ident" id="8005109">exec</span><span class="op" id="8005113">(</span><span class="ident" id="8005114">t</span>&nbsp;<span class="ident" id="8005116">testing</span><span class="op" id="8005123">.</span><span class="ident" id="8005124">TB</span><span class="op" id="8005126">,</span>&nbsp;<span class="ident" id="8005128">db</span>&nbsp;<span class="op" id="8005131">*</span><span class="ident" id="8005132">DB</span><span class="op" id="8005134">,</span>&nbsp;<span class="ident" id="8005136">query</span>&nbsp;<span class="builtintype" id="8005142">string</span><span class="op" id="8005148">,</span>&nbsp;<span class="ident" id="8005150">args</span>&nbsp;<span class="op" id="8005155">...</span><span class="keyword" id="8005158">interface</span><span class="op" id="8005167">{</span><span class="op" id="8005168">}</span><span class="op" id="8005169">)</span>&nbsp;<span class="op" id="8005171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8005174">_</span><span class="op" id="8005175">,</span>&nbsp;<span class="ident" id="8005177">err</span>&nbsp;<span class="op" id="8005181">:=</span>&nbsp;<span class="ident" id="8005184">db</span><span class="op" id="8005186">.</span><span class="ident" id="8005187">Exec</span><span class="op" id="8005191">(</span><span class="ident" id="8005192">query</span><span class="op" id="8005197">,</span>&nbsp;<span class="ident" id="8005199">args</span><span class="op" id="8005203">...</span><span class="op" id="8005206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8005209">if</span>&nbsp;<span class="ident" id="8005212">err</span>&nbsp;<span class="op" id="8005216">!=</span>&nbsp;<span class="builtintype" id="8005219">nil</span>&nbsp;<span class="op" id="8005223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8005227">t</span><span class="op" id="8005228">.</span><span class="ident" id="8005229">Fatalf</span><span class="op" id="8005235">(</span><span class="string" id="8005236">&#34;Exec&nbsp;of&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="8005252">,</span>&nbsp;<span class="ident" id="8005254">query</span><span class="op" id="8005259">,</span>&nbsp;<span class="ident" id="8005261">err</span><span class="op" id="8005264">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8005267">}</span><br>
<span class="lineno"></span><span class="op" id="8005269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8005272">func</span>&nbsp;<span class="ident" id="8005277">closeDB</span><span class="op" id="8005284">(</span><span class="ident" id="8005285">t</span>&nbsp;<span class="ident" id="8005287">testing</span><span class="op" id="8005294">.</span><span class="ident" id="8005295">TB</span><span class="op" id="8005297">,</span>&nbsp;<span class="ident" id="8005299">db</span>&nbsp;<span class="op" id="8005302">*</span><span class="ident" id="8005303">DB</span><span class="op" id="8005305">)</span>&nbsp;<span class="op" id="8005307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8005310">if</span>&nbsp;<span class="ident" id="8005313">e</span>&nbsp;<span class="op" id="8005315">:=</span>&nbsp;<span class="builtinfunc" id="8005318">recover</span><span class="op" id="8005325">(</span><span class="op" id="8005326">)</span><span class="op" id="8005327">;</span>&nbsp;<span class="ident" id="8005329">e</span>&nbsp;<span class="op" id="8005331">!=</span>&nbsp;<span class="builtintype" id="8005334">nil</span>&nbsp;<span class="op" id="8005338">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8005342">fmt</span><span class="op" id="8005345">.</span><span class="ident" id="8005346">Printf</span><span class="op" id="8005352">(</span><span class="string" id="8005353">&#34;Panic:&nbsp;%v\n&#34;</span><span class="op" id="8005366">,</span>&nbsp;<span class="ident" id="8005368">e</span><span class="op" id="8005369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8005373">panic</span><span class="op" id="8005378">(</span><span class="ident" id="8005379">e</span><span class="op" id="8005380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8005383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8005386">defer</span>&nbsp;<span class="ident" id="8005392">setHookpostCloseConn</span><span class="op" id="8005412">(</span><span class="builtintype" id="8005413">nil</span><span class="op" id="8005416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8005419">setHookpostCloseConn</span><span class="op" id="8005439">(</span><span class="keyword" id="8005440">func</span><span class="op" id="8005444">(</span><span class="ident" id="8005445">_</span>&nbsp;<span class="op" id="8005447">*</span><span class="ident" id="8005448">fakeConn</span><span class="op" id="8005456">,</span>&nbsp;<span class="ident" id="8005458">err</span>&nbsp;<span class="builtintype" id="8005462">error</span><span class="op" id="8005467">)</span>&nbsp;<span class="op" id="8005469">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8005473">if</span>&nbsp;<span class="ident" id="8005476">err</span>&nbsp;<span class="op" id="8005480">!=</span>&nbsp;<span class="builtintype" id="8005483">nil</span>&nbsp;<span class="op" id="8005487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8005492">t</span><span class="op" id="8005493">.</span><span class="ident" id="8005494">Errorf</span><span class="op" id="8005500">(</span><span class="string" id="8005501">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="8005529">,</span>&nbsp;<span class="ident" id="8005531">err</span><span class="op" id="8005534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8005538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8005541">}</span><span class="op" id="8005542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8005545">for</span>&nbsp;<span class="ident" id="8005549">i</span><span class="op" id="8005550">,</span>&nbsp;<span class="ident" id="8005552">dc</span>&nbsp;<span class="op" id="8005555">:=</span>&nbsp;<span class="keyword" id="8005558">range</span>&nbsp;<span class="ident" id="8005564">db</span><span class="op" id="8005566">.</span><span class="ident" id="8005567">freeConn</span>&nbsp;<span class="op" id="8005576">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8005580">if</span>&nbsp;<span class="ident" id="8005583">n</span>&nbsp;<span class="op" id="8005585">:=</span>&nbsp;<span class="builtinfunc" id="8005588">len</span><span class="op" id="8005591">(</span><span class="ident" id="8005592">dc</span><span class="op" id="8005594">.</span><span class="ident" id="8005595">openStmt</span><span class="op" id="8005603">)</span><span class="op" id="8005604">;</span>&nbsp;<span class="ident" id="8005606">n</span>&nbsp;<span class="op" id="8005608">&gt;</span>&nbsp;<span class="num" id="8005610">0</span>&nbsp;<span class="op" id="8005612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8005617">//&nbsp;Just&nbsp;a&nbsp;sanity&nbsp;check.&nbsp;This&nbsp;is&nbsp;legal&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8005661">//&nbsp;general,&nbsp;but&nbsp;if&nbsp;we&nbsp;make&nbsp;the&nbsp;tests&nbsp;clean&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8005710">//&nbsp;their&nbsp;statements&nbsp;first,&nbsp;then&nbsp;we&nbsp;can&nbsp;safely</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8005759">//&nbsp;verify&nbsp;this&nbsp;is&nbsp;always&nbsp;zero&nbsp;here,&nbsp;and&nbsp;any</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8005806">//&nbsp;other&nbsp;value&nbsp;is&nbsp;a&nbsp;leak.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8005835">t</span><span class="op" id="8005836">.</span><span class="ident" id="8005837">Errorf</span><span class="op" id="8005843">(</span><span class="string" id="8005844">&#34;while&nbsp;closing&nbsp;db,&nbsp;freeConn&nbsp;%d/%d&nbsp;had&nbsp;%d&nbsp;open&nbsp;stmts;&nbsp;want&nbsp;0&#34;</span><span class="op" id="8005904">,</span>&nbsp;<span class="ident" id="8005906">i</span><span class="op" id="8005907">,</span>&nbsp;<span class="builtinfunc" id="8005909">len</span><span class="op" id="8005912">(</span><span class="ident" id="8005913">db</span><span class="op" id="8005915">.</span><span class="ident" id="8005916">freeConn</span><span class="op" id="8005924">)</span><span class="op" id="8005925">,</span>&nbsp;<span class="ident" id="8005927">n</span><span class="op" id="8005928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8005932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8005935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8005938">err</span>&nbsp;<span class="op" id="8005942">:=</span>&nbsp;<span class="ident" id="8005945">db</span><span class="op" id="8005947">.</span><span class="ident" id="8005948">Close</span><span class="op" id="8005953">(</span><span class="op" id="8005954">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8005957">if</span>&nbsp;<span class="ident" id="8005960">err</span>&nbsp;<span class="op" id="8005964">!=</span>&nbsp;<span class="builtintype" id="8005967">nil</span>&nbsp;<span class="op" id="8005971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8005975">t</span><span class="op" id="8005976">.</span><span class="ident" id="8005977">Fatalf</span><span class="op" id="8005983">(</span><span class="string" id="8005984">&#34;error&nbsp;closing&nbsp;DB:&nbsp;%v&#34;</span><span class="op" id="8006006">,</span>&nbsp;<span class="ident" id="8006008">err</span><span class="op" id="8006011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8006014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8006017">db</span><span class="op" id="8006019">.</span><span class="ident" id="8006020">mu</span><span class="op" id="8006022">.</span><span class="ident" id="8006023">Lock</span><span class="op" id="8006027">(</span><span class="op" id="8006028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8006031">count</span>&nbsp;<span class="op" id="8006037">:=</span>&nbsp;<span class="ident" id="8006040">db</span><span class="op" id="8006042">.</span><span class="ident" id="8006043">numOpen</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8006052">db</span><span class="op" id="8006054">.</span><span class="ident" id="8006055">mu</span><span class="op" id="8006057">.</span><span class="ident" id="8006058">Unlock</span><span class="op" id="8006064">(</span><span class="op" id="8006065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8006068">if</span>&nbsp;<span class="ident" id="8006071">count</span>&nbsp;<span class="op" id="8006077">!=</span>&nbsp;<span class="num" id="8006080">0</span>&nbsp;<span class="op" id="8006082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8006086">t</span><span class="op" id="8006087">.</span><span class="ident" id="8006088">Fatalf</span><span class="op" id="8006094">(</span><span class="string" id="8006095">&#34;%d&nbsp;connections&nbsp;still&nbsp;open&nbsp;after&nbsp;closing&nbsp;DB&#34;</span><span class="op" id="8006139">,</span>&nbsp;<span class="ident" id="8006141">db</span><span class="op" id="8006143">.</span><span class="ident" id="8006144">numOpen</span><span class="op" id="8006151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8006154">}</span><br>
<span class="lineno"></span><span class="op" id="8006156">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="comment" id="8006159">//&nbsp;numPrepares&nbsp;assumes&nbsp;that&nbsp;db&nbsp;has&nbsp;exactly&nbsp;1&nbsp;idle&nbsp;conn&nbsp;and&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="8006226">//&nbsp;its&nbsp;count&nbsp;of&nbsp;calls&nbsp;to&nbsp;Prepare</span><br>
<span class="lineno"></span><span class="keyword" id="8006259">func</span>&nbsp;<span class="ident" id="8006264">numPrepares</span><span class="op" id="8006275">(</span><span class="ident" id="8006276">t</span>&nbsp;<span class="op" id="8006278">*</span><span class="ident" id="8006279">testing</span><span class="op" id="8006286">.</span><span class="ident" id="8006287">T</span><span class="op" id="8006288">,</span>&nbsp;<span class="ident" id="8006290">db</span>&nbsp;<span class="op" id="8006293">*</span><span class="ident" id="8006294">DB</span><span class="op" id="8006296">)</span>&nbsp;<span class="builtintype" id="8006298">int</span>&nbsp;<span class="op" id="8006302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8006305">if</span>&nbsp;<span class="ident" id="8006308">n</span>&nbsp;<span class="op" id="8006310">:=</span>&nbsp;<span class="builtinfunc" id="8006313">len</span><span class="op" id="8006316">(</span><span class="ident" id="8006317">db</span><span class="op" id="8006319">.</span><span class="ident" id="8006320">freeConn</span><span class="op" id="8006328">)</span><span class="op" id="8006329">;</span>&nbsp;<span class="ident" id="8006331">n</span>&nbsp;<span class="op" id="8006333">!=</span>&nbsp;<span class="num" id="8006336">1</span>&nbsp;<span class="op" id="8006338">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8006342">t</span><span class="op" id="8006343">.</span><span class="ident" id="8006344">Fatalf</span><span class="op" id="8006350">(</span><span class="string" id="8006351">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="8006376">,</span>&nbsp;<span class="ident" id="8006378">n</span><span class="op" id="8006379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8006382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8006385">return</span>&nbsp;<span class="ident" id="8006392">db</span><span class="op" id="8006394">.</span><span class="ident" id="8006395">freeConn</span><span class="op" id="8006403">[</span><span class="num" id="8006404">0</span><span class="op" id="8006405">]</span><span class="op" id="8006406">.</span><span class="ident" id="8006407">ci</span><span class="op" id="8006409">.</span><span class="op" id="8006410">(</span><span class="op" id="8006411">*</span><span class="ident" id="8006412">fakeConn</span><span class="op" id="8006420">)</span><span class="op" id="8006421">.</span><span class="ident" id="8006422">numPrepare</span><br>
<span class="lineno"></span><span class="op" id="8006433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="8006436">func</span>&nbsp;<span class="op" id="8006441">(</span><span class="ident" id="8006442">db</span>&nbsp;<span class="op" id="8006445">*</span><span class="ident" id="8006446">DB</span><span class="op" id="8006448">)</span>&nbsp;<span class="ident" id="8006450">numDeps</span><span class="op" id="8006457">(</span><span class="op" id="8006458">)</span>&nbsp;<span class="builtintype" id="8006460">int</span>&nbsp;<span class="op" id="8006464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8006467">db</span><span class="op" id="8006469">.</span><span class="ident" id="8006470">mu</span><span class="op" id="8006472">.</span><span class="ident" id="8006473">Lock</span><span class="op" id="8006477">(</span><span class="op" id="8006478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8006481">defer</span>&nbsp;<span class="ident" id="8006487">db</span><span class="op" id="8006489">.</span><span class="ident" id="8006490">mu</span><span class="op" id="8006492">.</span><span class="ident" id="8006493">Unlock</span><span class="op" id="8006499">(</span><span class="op" id="8006500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8006503">return</span>&nbsp;<span class="builtinfunc" id="8006510">len</span><span class="op" id="8006513">(</span><span class="ident" id="8006514">db</span><span class="op" id="8006516">.</span><span class="ident" id="8006517">dep</span><span class="op" id="8006520">)</span><br>
<span class="lineno"></span><span class="op" id="8006522">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="8006525">//&nbsp;Dependencies&nbsp;are&nbsp;closed&nbsp;via&nbsp;a&nbsp;goroutine,&nbsp;so&nbsp;this&nbsp;polls&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="8006595">//&nbsp;numDeps&nbsp;to&nbsp;fall&nbsp;to&nbsp;want,&nbsp;waiting&nbsp;up&nbsp;to&nbsp;d.</span><br>
<span class="lineno"></span><span class="keyword" id="8006640">func</span>&nbsp;<span class="op" id="8006645">(</span><span class="ident" id="8006646">db</span>&nbsp;<span class="op" id="8006649">*</span><span class="ident" id="8006650">DB</span><span class="op" id="8006652">)</span>&nbsp;<span class="ident" id="8006654">numDepsPollUntil</span><span class="op" id="8006670">(</span><span class="ident" id="8006671">want</span>&nbsp;<span class="builtintype" id="8006676">int</span><span class="op" id="8006679">,</span>&nbsp;<span class="ident" id="8006681">d</span>&nbsp;<span class="ident" id="8006683">time</span><span class="op" id="8006687">.</span><span class="ident" id="8006688">Duration</span><span class="op" id="8006696">)</span>&nbsp;<span class="builtintype" id="8006698">int</span>&nbsp;<span class="op" id="8006702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8006705">deadline</span>&nbsp;<span class="op" id="8006714">:=</span>&nbsp;<span class="ident" id="8006717">time</span><span class="op" id="8006721">.</span><span class="ident" id="8006722">Now</span><span class="op" id="8006725">(</span><span class="op" id="8006726">)</span><span class="op" id="8006727">.</span><span class="ident" id="8006728">Add</span><span class="op" id="8006731">(</span><span class="ident" id="8006732">d</span><span class="op" id="8006733">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8006736">for</span>&nbsp;<span class="op" id="8006740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8006744">n</span>&nbsp;<span class="op" id="8006746">:=</span>&nbsp;<span class="ident" id="8006749">db</span><span class="op" id="8006751">.</span><span class="ident" id="8006752">numDeps</span><span class="op" id="8006759">(</span><span class="op" id="8006760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8006764">if</span>&nbsp;<span class="ident" id="8006767">n</span>&nbsp;<span class="op" id="8006769">&lt;=</span>&nbsp;<span class="ident" id="8006772">want</span>&nbsp;<span class="op" id="8006777">||</span>&nbsp;<span class="ident" id="8006780">time</span><span class="op" id="8006784">.</span><span class="ident" id="8006785">Now</span><span class="op" id="8006788">(</span><span class="op" id="8006789">)</span><span class="op" id="8006790">.</span><span class="ident" id="8006791">After</span><span class="op" id="8006796">(</span><span class="ident" id="8006797">deadline</span><span class="op" id="8006805">)</span>&nbsp;<span class="op" id="8006807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8006812">return</span>&nbsp;<span class="ident" id="8006819">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8006823">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8006827">time</span><span class="op" id="8006831">.</span><span class="ident" id="8006832">Sleep</span><span class="op" id="8006837">(</span><span class="num" id="8006838">50</span>&nbsp;<span class="op" id="8006841">*</span>&nbsp;<span class="ident" id="8006843">time</span><span class="op" id="8006847">.</span><span class="ident" id="8006848">Millisecond</span><span class="op" id="8006859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8006862">}</span><br>
<span class="lineno"></span><span class="op" id="8006864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8006867">func</span>&nbsp;<span class="op" id="8006872">(</span><span class="ident" id="8006873">db</span>&nbsp;<span class="op" id="8006876">*</span><span class="ident" id="8006877">DB</span><span class="op" id="8006879">)</span>&nbsp;<span class="ident" id="8006881">numFreeConns</span><span class="op" id="8006893">(</span><span class="op" id="8006894">)</span>&nbsp;<span class="builtintype" id="8006896">int</span>&nbsp;<span class="op" id="8006900">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8006903">db</span><span class="op" id="8006905">.</span><span class="ident" id="8006906">mu</span><span class="op" id="8006908">.</span><span class="ident" id="8006909">Lock</span><span class="op" id="8006913">(</span><span class="op" id="8006914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8006917">defer</span>&nbsp;<span class="ident" id="8006923">db</span><span class="op" id="8006925">.</span><span class="ident" id="8006926">mu</span><span class="op" id="8006928">.</span><span class="ident" id="8006929">Unlock</span><span class="op" id="8006935">(</span><span class="op" id="8006936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8006939">return</span>&nbsp;<span class="builtinfunc" id="8006946">len</span><span class="op" id="8006949">(</span><span class="ident" id="8006950">db</span><span class="op" id="8006952">.</span><span class="ident" id="8006953">freeConn</span><span class="op" id="8006961">)</span><br>
<span class="lineno"></span><span class="op" id="8006963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="8006966">func</span>&nbsp;<span class="op" id="8006971">(</span><span class="ident" id="8006972">db</span>&nbsp;<span class="op" id="8006975">*</span><span class="ident" id="8006976">DB</span><span class="op" id="8006978">)</span>&nbsp;<span class="ident" id="8006980">dumpDeps</span><span class="op" id="8006988">(</span><span class="ident" id="8006989">t</span>&nbsp;<span class="op" id="8006991">*</span><span class="ident" id="8006992">testing</span><span class="op" id="8006999">.</span><span class="ident" id="8007000">T</span><span class="op" id="8007001">)</span>&nbsp;<span class="op" id="8007003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8007006">for</span>&nbsp;<span class="ident" id="8007010">fc</span>&nbsp;<span class="op" id="8007013">:=</span>&nbsp;<span class="keyword" id="8007016">range</span>&nbsp;<span class="ident" id="8007022">db</span><span class="op" id="8007024">.</span><span class="ident" id="8007025">dep</span>&nbsp;<span class="op" id="8007029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8007033">db</span><span class="op" id="8007035">.</span><span class="ident" id="8007036">dumpDep</span><span class="op" id="8007043">(</span><span class="ident" id="8007044">t</span><span class="op" id="8007045">,</span>&nbsp;<span class="num" id="8007047">0</span><span class="op" id="8007048">,</span>&nbsp;<span class="ident" id="8007050">fc</span><span class="op" id="8007052">,</span>&nbsp;<span class="keyword" id="8007054">map</span><span class="op" id="8007057">[</span><span class="ident" id="8007058">finalCloser</span><span class="op" id="8007069">]</span><span class="builtintype" id="8007070">bool</span><span class="op" id="8007074">{</span><span class="op" id="8007075">}</span><span class="op" id="8007076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8007079">}</span><br>
<span class="lineno"></span><span class="op" id="8007081">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="8007084">func</span>&nbsp;<span class="op" id="8007089">(</span><span class="ident" id="8007090">db</span>&nbsp;<span class="op" id="8007093">*</span><span class="ident" id="8007094">DB</span><span class="op" id="8007096">)</span>&nbsp;<span class="ident" id="8007098">dumpDep</span><span class="op" id="8007105">(</span><span class="ident" id="8007106">t</span>&nbsp;<span class="op" id="8007108">*</span><span class="ident" id="8007109">testing</span><span class="op" id="8007116">.</span><span class="ident" id="8007117">T</span><span class="op" id="8007118">,</span>&nbsp;<span class="ident" id="8007120">depth</span>&nbsp;<span class="builtintype" id="8007126">int</span><span class="op" id="8007129">,</span>&nbsp;<span class="ident" id="8007131">dep</span>&nbsp;<span class="ident" id="8007135">finalCloser</span><span class="op" id="8007146">,</span>&nbsp;<span class="ident" id="8007148">seen</span>&nbsp;<span class="keyword" id="8007153">map</span><span class="op" id="8007156">[</span><span class="ident" id="8007157">finalCloser</span><span class="op" id="8007168">]</span><span class="builtintype" id="8007169">bool</span><span class="op" id="8007173">)</span>&nbsp;<span class="op" id="8007175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8007178">seen</span><span class="op" id="8007182">[</span><span class="ident" id="8007183">dep</span><span class="op" id="8007186">]</span>&nbsp;<span class="op" id="8007188">=</span>&nbsp;<span class="builtintype" id="8007190">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8007196">indent</span>&nbsp;<span class="op" id="8007203">:=</span>&nbsp;<span class="ident" id="8007206">strings</span><span class="op" id="8007213">.</span><span class="ident" id="8007214">Repeat</span><span class="op" id="8007220">(</span><span class="string" id="8007221">&#34;&nbsp;&nbsp;&#34;</span><span class="op" id="8007225">,</span>&nbsp;<span class="ident" id="8007227">depth</span><span class="op" id="8007232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8007235">ds</span>&nbsp;<span class="op" id="8007238">:=</span>&nbsp;<span class="ident" id="8007241">db</span><span class="op" id="8007243">.</span><span class="ident" id="8007244">dep</span><span class="op" id="8007247">[</span><span class="ident" id="8007248">dep</span><span class="op" id="8007251">]</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8007254">for</span>&nbsp;<span class="ident" id="8007258">k</span>&nbsp;<span class="op" id="8007260">:=</span>&nbsp;<span class="keyword" id="8007263">range</span>&nbsp;<span class="ident" id="8007269">ds</span>&nbsp;<span class="op" id="8007272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8007276">t</span><span class="op" id="8007277">.</span><span class="ident" id="8007278">Logf</span><span class="op" id="8007282">(</span><span class="string" id="8007283">&#34;%s%T&nbsp;(%p)&nbsp;waiting&nbsp;for&nbsp;-&gt;&nbsp;%T&nbsp;(%p)&#34;</span><span class="op" id="8007317">,</span>&nbsp;<span class="ident" id="8007319">indent</span><span class="op" id="8007325">,</span>&nbsp;<span class="ident" id="8007327">dep</span><span class="op" id="8007330">,</span>&nbsp;<span class="ident" id="8007332">dep</span><span class="op" id="8007335">,</span>&nbsp;<span class="ident" id="8007337">k</span><span class="op" id="8007338">,</span>&nbsp;<span class="ident" id="8007340">k</span><span class="op" id="8007341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8007345">if</span>&nbsp;<span class="ident" id="8007348">fc</span><span class="op" id="8007350">,</span>&nbsp;<span class="ident" id="8007352">ok</span>&nbsp;<span class="op" id="8007355">:=</span>&nbsp;<span class="ident" id="8007358">k</span><span class="op" id="8007359">.</span><span class="op" id="8007360">(</span><span class="ident" id="8007361">finalCloser</span><span class="op" id="8007372">)</span><span class="op" id="8007373">;</span>&nbsp;<span class="ident" id="8007375">ok</span>&nbsp;<span class="op" id="8007378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8007383">if</span>&nbsp;<span class="op" id="8007386">!</span><span class="ident" id="8007387">seen</span><span class="op" id="8007391">[</span><span class="ident" id="8007392">fc</span><span class="op" id="8007394">]</span>&nbsp;<span class="op" id="8007396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8007402">db</span><span class="op" id="8007404">.</span><span class="ident" id="8007405">dumpDep</span><span class="op" id="8007412">(</span><span class="ident" id="8007413">t</span><span class="op" id="8007414">,</span>&nbsp;<span class="ident" id="8007416">depth</span><span class="op" id="8007421">+</span><span class="num" id="8007422">1</span><span class="op" id="8007423">,</span>&nbsp;<span class="ident" id="8007425">fc</span><span class="op" id="8007427">,</span>&nbsp;<span class="ident" id="8007429">seen</span><span class="op" id="8007433">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8007438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8007442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8007445">}</span><br>
<span class="lineno"></span><span class="op" id="8007447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="8007450">func</span>&nbsp;<span class="ident" id="8007455">TestQuery</span><span class="op" id="8007464">(</span><span class="ident" id="8007465">t</span>&nbsp;<span class="op" id="8007467">*</span><span class="ident" id="8007468">testing</span><span class="op" id="8007475">.</span><span class="ident" id="8007476">T</span><span class="op" id="8007477">)</span>&nbsp;<span class="op" id="8007479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8007482">db</span>&nbsp;<span class="op" id="8007485">:=</span>&nbsp;<span class="ident" id="8007488">newTestDB</span><span class="op" id="8007497">(</span><span class="ident" id="8007498">t</span><span class="op" id="8007499">,</span>&nbsp;<span class="string" id="8007501">&#34;people&#34;</span><span class="op" id="8007509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8007512">defer</span>&nbsp;<span class="ident" id="8007518">closeDB</span><span class="op" id="8007525">(</span><span class="ident" id="8007526">t</span><span class="op" id="8007527">,</span>&nbsp;<span class="ident" id="8007529">db</span><span class="op" id="8007531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8007534">prepares0</span>&nbsp;<span class="op" id="8007544">:=</span>&nbsp;<span class="ident" id="8007547">numPrepares</span><span class="op" id="8007558">(</span><span class="ident" id="8007559">t</span><span class="op" id="8007560">,</span>&nbsp;<span class="ident" id="8007562">db</span><span class="op" id="8007564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8007567">rows</span><span class="op" id="8007571">,</span>&nbsp;<span class="ident" id="8007573">err</span>&nbsp;<span class="op" id="8007577">:=</span>&nbsp;<span class="ident" id="8007580">db</span><span class="op" id="8007582">.</span><span class="ident" id="8007583">Query</span><span class="op" id="8007588">(</span><span class="string" id="8007589">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="8007614">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8007617">if</span>&nbsp;<span class="ident" id="8007620">err</span>&nbsp;<span class="op" id="8007624">!=</span>&nbsp;<span class="builtintype" id="8007627">nil</span>&nbsp;<span class="op" id="8007631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8007635">t</span><span class="op" id="8007636">.</span><span class="ident" id="8007637">Fatalf</span><span class="op" id="8007643">(</span><span class="string" id="8007644">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="8007655">,</span>&nbsp;<span class="ident" id="8007657">err</span><span class="op" id="8007660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8007663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8007666">type</span>&nbsp;<span class="ident" id="8007671">row</span>&nbsp;<span class="keyword" id="8007675">struct</span>&nbsp;<span class="op" id="8007682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8007686">age</span>&nbsp;&nbsp;<span class="builtintype" id="8007691">int</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8007697">name</span>&nbsp;<span class="builtintype" id="8007702">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8007710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8007713">got</span>&nbsp;<span class="op" id="8007717">:=</span>&nbsp;<span class="op" id="8007720">[</span><span class="op" id="8007721">]</span><span class="ident" id="8007722">row</span><span class="op" id="8007725">{</span><span class="op" id="8007726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8007729">for</span>&nbsp;<span class="ident" id="8007733">rows</span><span class="op" id="8007737">.</span><span class="ident" id="8007738">Next</span><span class="op" id="8007742">(</span><span class="op" id="8007743">)</span>&nbsp;<span class="op" id="8007745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8007749">var</span>&nbsp;<span class="ident" id="8007753">r</span>&nbsp;<span class="ident" id="8007755">row</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8007761">err</span>&nbsp;<span class="op" id="8007765">=</span>&nbsp;<span class="ident" id="8007767">rows</span><span class="op" id="8007771">.</span><span class="ident" id="8007772">Scan</span><span class="op" id="8007776">(</span><span class="op" id="8007777">&amp;</span><span class="ident" id="8007778">r</span><span class="op" id="8007779">.</span><span class="ident" id="8007780">age</span><span class="op" id="8007783">,</span>&nbsp;<span class="op" id="8007785">&amp;</span><span class="ident" id="8007786">r</span><span class="op" id="8007787">.</span><span class="ident" id="8007788">name</span><span class="op" id="8007792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8007796">if</span>&nbsp;<span class="ident" id="8007799">err</span>&nbsp;<span class="op" id="8007803">!=</span>&nbsp;<span class="builtintype" id="8007806">nil</span>&nbsp;<span class="op" id="8007810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8007815">t</span><span class="op" id="8007816">.</span><span class="ident" id="8007817">Fatalf</span><span class="op" id="8007823">(</span><span class="string" id="8007824">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="8007834">,</span>&nbsp;<span class="ident" id="8007836">err</span><span class="op" id="8007839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8007843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8007847">got</span>&nbsp;<span class="op" id="8007851">=</span>&nbsp;<span class="builtinfunc" id="8007853">append</span><span class="op" id="8007859">(</span><span class="ident" id="8007860">got</span><span class="op" id="8007863">,</span>&nbsp;<span class="ident" id="8007865">r</span><span class="op" id="8007866">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8007869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8007872">err</span>&nbsp;<span class="op" id="8007876">=</span>&nbsp;<span class="ident" id="8007878">rows</span><span class="op" id="8007882">.</span><span class="ident" id="8007883">Err</span><span class="op" id="8007886">(</span><span class="op" id="8007887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8007890">if</span>&nbsp;<span class="ident" id="8007893">err</span>&nbsp;<span class="op" id="8007897">!=</span>&nbsp;<span class="builtintype" id="8007900">nil</span>&nbsp;<span class="op" id="8007904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8007908">t</span><span class="op" id="8007909">.</span><span class="ident" id="8007910">Fatalf</span><span class="op" id="8007916">(</span><span class="string" id="8007917">&#34;Err:&nbsp;%v&#34;</span><span class="op" id="8007926">,</span>&nbsp;<span class="ident" id="8007928">err</span><span class="op" id="8007931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8007934">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8007937">want</span>&nbsp;<span class="op" id="8007942">:=</span>&nbsp;<span class="op" id="8007945">[</span><span class="op" id="8007946">]</span><span class="ident" id="8007947">row</span><span class="op" id="8007950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8007954">{</span><span class="ident" id="8007955">age</span><span class="op" id="8007958">:</span>&nbsp;<span class="num" id="8007960">1</span><span class="op" id="8007961">,</span>&nbsp;<span class="ident" id="8007963">name</span><span class="op" id="8007967">:</span>&nbsp;<span class="string" id="8007969">&#34;Alice&#34;</span><span class="op" id="8007976">}</span><span class="op" id="8007977">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8007981">{</span><span class="ident" id="8007982">age</span><span class="op" id="8007985">:</span>&nbsp;<span class="num" id="8007987">2</span><span class="op" id="8007988">,</span>&nbsp;<span class="ident" id="8007990">name</span><span class="op" id="8007994">:</span>&nbsp;<span class="string" id="8007996">&#34;Bob&#34;</span><span class="op" id="8008001">}</span><span class="op" id="8008002">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8008006">{</span><span class="ident" id="8008007">age</span><span class="op" id="8008010">:</span>&nbsp;<span class="num" id="8008012">3</span><span class="op" id="8008013">,</span>&nbsp;<span class="ident" id="8008015">name</span><span class="op" id="8008019">:</span>&nbsp;<span class="string" id="8008021">&#34;Chris&#34;</span><span class="op" id="8008028">}</span><span class="op" id="8008029">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8008032">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8008035">if</span>&nbsp;<span class="op" id="8008038">!</span><span class="ident" id="8008039">reflect</span><span class="op" id="8008046">.</span><span class="ident" id="8008047">DeepEqual</span><span class="op" id="8008056">(</span><span class="ident" id="8008057">got</span><span class="op" id="8008060">,</span>&nbsp;<span class="ident" id="8008062">want</span><span class="op" id="8008066">)</span>&nbsp;<span class="op" id="8008068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8008072">t</span><span class="op" id="8008073">.</span><span class="ident" id="8008074">Errorf</span><span class="op" id="8008080">(</span><span class="string" id="8008081">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="8008114">,</span>&nbsp;<span class="ident" id="8008116">got</span><span class="op" id="8008119">,</span>&nbsp;<span class="ident" id="8008121">want</span><span class="op" id="8008125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8008128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8008132">//&nbsp;And&nbsp;verify&nbsp;that&nbsp;the&nbsp;final&nbsp;rows.Next()&nbsp;call,&nbsp;which&nbsp;hit&nbsp;EOF,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8008195">//&nbsp;also&nbsp;closed&nbsp;the&nbsp;rows&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8008232">if</span>&nbsp;<span class="ident" id="8008235">n</span>&nbsp;<span class="op" id="8008237">:=</span>&nbsp;<span class="ident" id="8008240">db</span><span class="op" id="8008242">.</span><span class="ident" id="8008243">numFreeConns</span><span class="op" id="8008255">(</span><span class="op" id="8008256">)</span><span class="op" id="8008257">;</span>&nbsp;<span class="ident" id="8008259">n</span>&nbsp;<span class="op" id="8008261">!=</span>&nbsp;<span class="num" id="8008264">1</span>&nbsp;<span class="op" id="8008266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8008270">t</span><span class="op" id="8008271">.</span><span class="ident" id="8008272">Fatalf</span><span class="op" id="8008278">(</span><span class="string" id="8008279">&#34;free&nbsp;conns&nbsp;after&nbsp;query&nbsp;hitting&nbsp;EOF&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="8008328">,</span>&nbsp;<span class="ident" id="8008330">n</span><span class="op" id="8008331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8008334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8008337">if</span>&nbsp;<span class="ident" id="8008340">prepares</span>&nbsp;<span class="op" id="8008349">:=</span>&nbsp;<span class="ident" id="8008352">numPrepares</span><span class="op" id="8008363">(</span><span class="ident" id="8008364">t</span><span class="op" id="8008365">,</span>&nbsp;<span class="ident" id="8008367">db</span><span class="op" id="8008369">)</span>&nbsp;<span class="op" id="8008371">-</span>&nbsp;<span class="ident" id="8008373">prepares0</span><span class="op" id="8008382">;</span>&nbsp;<span class="ident" id="8008384">prepares</span>&nbsp;<span class="op" id="8008393">!=</span>&nbsp;<span class="num" id="8008396">1</span>&nbsp;<span class="op" id="8008398">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8008402">t</span><span class="op" id="8008403">.</span><span class="ident" id="8008404">Errorf</span><span class="op" id="8008410">(</span><span class="string" id="8008411">&#34;executed&nbsp;%d&nbsp;Prepare&nbsp;statements;&nbsp;want&nbsp;1&#34;</span><span class="op" id="8008451">,</span>&nbsp;<span class="ident" id="8008453">prepares</span><span class="op" id="8008461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8008464">}</span><br>
<span class="lineno"></span><span class="op" id="8008466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8008469">func</span>&nbsp;<span class="ident" id="8008474">TestByteOwnership</span><span class="op" id="8008491">(</span><span class="ident" id="8008492">t</span>&nbsp;<span class="op" id="8008494">*</span><span class="ident" id="8008495">testing</span><span class="op" id="8008502">.</span><span class="ident" id="8008503">T</span><span class="op" id="8008504">)</span>&nbsp;<span class="op" id="8008506">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8008509">db</span>&nbsp;<span class="op" id="8008512">:=</span>&nbsp;<span class="ident" id="8008515">newTestDB</span><span class="op" id="8008524">(</span><span class="ident" id="8008525">t</span><span class="op" id="8008526">,</span>&nbsp;<span class="string" id="8008528">&#34;people&#34;</span><span class="op" id="8008536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8008539">defer</span>&nbsp;<span class="ident" id="8008545">closeDB</span><span class="op" id="8008552">(</span><span class="ident" id="8008553">t</span><span class="op" id="8008554">,</span>&nbsp;<span class="ident" id="8008556">db</span><span class="op" id="8008558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8008561">rows</span><span class="op" id="8008565">,</span>&nbsp;<span class="ident" id="8008567">err</span>&nbsp;<span class="op" id="8008571">:=</span>&nbsp;<span class="ident" id="8008574">db</span><span class="op" id="8008576">.</span><span class="ident" id="8008577">Query</span><span class="op" id="8008582">(</span><span class="string" id="8008583">&#34;SELECT|people|name,photo|&#34;</span><span class="op" id="8008610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8008613">if</span>&nbsp;<span class="ident" id="8008616">err</span>&nbsp;<span class="op" id="8008620">!=</span>&nbsp;<span class="builtintype" id="8008623">nil</span>&nbsp;<span class="op" id="8008627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8008631">t</span><span class="op" id="8008632">.</span><span class="ident" id="8008633">Fatalf</span><span class="op" id="8008639">(</span><span class="string" id="8008640">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="8008651">,</span>&nbsp;<span class="ident" id="8008653">err</span><span class="op" id="8008656">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8008659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8008662">type</span>&nbsp;<span class="ident" id="8008667">row</span>&nbsp;<span class="keyword" id="8008671">struct</span>&nbsp;<span class="op" id="8008678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8008682">name</span>&nbsp;&nbsp;<span class="op" id="8008688">[</span><span class="op" id="8008689">]</span><span class="builtintype" id="8008690">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8008697">photo</span>&nbsp;<span class="ident" id="8008703">RawBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8008713">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8008716">got</span>&nbsp;<span class="op" id="8008720">:=</span>&nbsp;<span class="op" id="8008723">[</span><span class="op" id="8008724">]</span><span class="ident" id="8008725">row</span><span class="op" id="8008728">{</span><span class="op" id="8008729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8008732">for</span>&nbsp;<span class="ident" id="8008736">rows</span><span class="op" id="8008740">.</span><span class="ident" id="8008741">Next</span><span class="op" id="8008745">(</span><span class="op" id="8008746">)</span>&nbsp;<span class="op" id="8008748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8008752">var</span>&nbsp;<span class="ident" id="8008756">r</span>&nbsp;<span class="ident" id="8008758">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8008764">err</span>&nbsp;<span class="op" id="8008768">=</span>&nbsp;<span class="ident" id="8008770">rows</span><span class="op" id="8008774">.</span><span class="ident" id="8008775">Scan</span><span class="op" id="8008779">(</span><span class="op" id="8008780">&amp;</span><span class="ident" id="8008781">r</span><span class="op" id="8008782">.</span><span class="ident" id="8008783">name</span><span class="op" id="8008787">,</span>&nbsp;<span class="op" id="8008789">&amp;</span><span class="ident" id="8008790">r</span><span class="op" id="8008791">.</span><span class="ident" id="8008792">photo</span><span class="op" id="8008797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8008801">if</span>&nbsp;<span class="ident" id="8008804">err</span>&nbsp;<span class="op" id="8008808">!=</span>&nbsp;<span class="builtintype" id="8008811">nil</span>&nbsp;<span class="op" id="8008815">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8008820">t</span><span class="op" id="8008821">.</span><span class="ident" id="8008822">Fatalf</span><span class="op" id="8008828">(</span><span class="string" id="8008829">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="8008839">,</span>&nbsp;<span class="ident" id="8008841">err</span><span class="op" id="8008844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8008848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8008852">got</span>&nbsp;<span class="op" id="8008856">=</span>&nbsp;<span class="builtinfunc" id="8008858">append</span><span class="op" id="8008864">(</span><span class="ident" id="8008865">got</span><span class="op" id="8008868">,</span>&nbsp;<span class="ident" id="8008870">r</span><span class="op" id="8008871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8008874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8008877">corruptMemory</span>&nbsp;<span class="op" id="8008891">:=</span>&nbsp;<span class="op" id="8008894">[</span><span class="op" id="8008895">]</span><span class="builtintype" id="8008896">byte</span><span class="op" id="8008900">(</span><span class="string" id="8008901">&#34;\xffPHOTO&#34;</span><span class="op" id="8008912">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8008915">want</span>&nbsp;<span class="op" id="8008920">:=</span>&nbsp;<span class="op" id="8008923">[</span><span class="op" id="8008924">]</span><span class="ident" id="8008925">row</span><span class="op" id="8008928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8008932">{</span><span class="ident" id="8008933">name</span><span class="op" id="8008937">:</span>&nbsp;<span class="op" id="8008939">[</span><span class="op" id="8008940">]</span><span class="builtintype" id="8008941">byte</span><span class="op" id="8008945">(</span><span class="string" id="8008946">&#34;Alice&#34;</span><span class="op" id="8008953">)</span><span class="op" id="8008954">,</span>&nbsp;<span class="ident" id="8008956">photo</span><span class="op" id="8008961">:</span>&nbsp;<span class="ident" id="8008963">corruptMemory</span><span class="op" id="8008976">}</span><span class="op" id="8008977">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8008981">{</span><span class="ident" id="8008982">name</span><span class="op" id="8008986">:</span>&nbsp;<span class="op" id="8008988">[</span><span class="op" id="8008989">]</span><span class="builtintype" id="8008990">byte</span><span class="op" id="8008994">(</span><span class="string" id="8008995">&#34;Bob&#34;</span><span class="op" id="8009000">)</span><span class="op" id="8009001">,</span>&nbsp;<span class="ident" id="8009003">photo</span><span class="op" id="8009008">:</span>&nbsp;<span class="ident" id="8009010">corruptMemory</span><span class="op" id="8009023">}</span><span class="op" id="8009024">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8009028">{</span><span class="ident" id="8009029">name</span><span class="op" id="8009033">:</span>&nbsp;<span class="op" id="8009035">[</span><span class="op" id="8009036">]</span><span class="builtintype" id="8009037">byte</span><span class="op" id="8009041">(</span><span class="string" id="8009042">&#34;Chris&#34;</span><span class="op" id="8009049">)</span><span class="op" id="8009050">,</span>&nbsp;<span class="ident" id="8009052">photo</span><span class="op" id="8009057">:</span>&nbsp;<span class="ident" id="8009059">corruptMemory</span><span class="op" id="8009072">}</span><span class="op" id="8009073">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8009076">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8009079">if</span>&nbsp;<span class="op" id="8009082">!</span><span class="ident" id="8009083">reflect</span><span class="op" id="8009090">.</span><span class="ident" id="8009091">DeepEqual</span><span class="op" id="8009100">(</span><span class="ident" id="8009101">got</span><span class="op" id="8009104">,</span>&nbsp;<span class="ident" id="8009106">want</span><span class="op" id="8009110">)</span>&nbsp;<span class="op" id="8009112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8009116">t</span><span class="op" id="8009117">.</span><span class="ident" id="8009118">Errorf</span><span class="op" id="8009124">(</span><span class="string" id="8009125">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="8009158">,</span>&nbsp;<span class="ident" id="8009160">got</span><span class="op" id="8009163">,</span>&nbsp;<span class="ident" id="8009165">want</span><span class="op" id="8009169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8009172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8009176">var</span>&nbsp;<span class="ident" id="8009180">photo</span>&nbsp;<span class="ident" id="8009186">RawBytes</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8009196">err</span>&nbsp;<span class="op" id="8009200">=</span>&nbsp;<span class="ident" id="8009202">db</span><span class="op" id="8009204">.</span><span class="ident" id="8009205">QueryRow</span><span class="op" id="8009213">(</span><span class="string" id="8009214">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="8009242">,</span>&nbsp;<span class="string" id="8009244">&#34;Alice&#34;</span><span class="op" id="8009251">)</span><span class="op" id="8009252">.</span><span class="ident" id="8009253">Scan</span><span class="op" id="8009257">(</span><span class="op" id="8009258">&amp;</span><span class="ident" id="8009259">photo</span><span class="op" id="8009264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8009267">if</span>&nbsp;<span class="ident" id="8009270">err</span>&nbsp;<span class="op" id="8009274">==</span>&nbsp;<span class="builtintype" id="8009277">nil</span>&nbsp;<span class="op" id="8009281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8009285">t</span><span class="op" id="8009286">.</span><span class="ident" id="8009287">Error</span><span class="op" id="8009292">(</span><span class="string" id="8009293">&#34;want&nbsp;error&nbsp;scanning&nbsp;into&nbsp;RawBytes&nbsp;from&nbsp;QueryRow&#34;</span><span class="op" id="8009342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8009345">}</span><br>
<span class="lineno"></span><span class="op" id="8009347">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword" id="8009350">func</span>&nbsp;<span class="ident" id="8009355">TestRowsColumns</span><span class="op" id="8009370">(</span><span class="ident" id="8009371">t</span>&nbsp;<span class="op" id="8009373">*</span><span class="ident" id="8009374">testing</span><span class="op" id="8009381">.</span><span class="ident" id="8009382">T</span><span class="op" id="8009383">)</span>&nbsp;<span class="op" id="8009385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8009388">db</span>&nbsp;<span class="op" id="8009391">:=</span>&nbsp;<span class="ident" id="8009394">newTestDB</span><span class="op" id="8009403">(</span><span class="ident" id="8009404">t</span><span class="op" id="8009405">,</span>&nbsp;<span class="string" id="8009407">&#34;people&#34;</span><span class="op" id="8009415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8009418">defer</span>&nbsp;<span class="ident" id="8009424">closeDB</span><span class="op" id="8009431">(</span><span class="ident" id="8009432">t</span><span class="op" id="8009433">,</span>&nbsp;<span class="ident" id="8009435">db</span><span class="op" id="8009437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8009440">rows</span><span class="op" id="8009444">,</span>&nbsp;<span class="ident" id="8009446">err</span>&nbsp;<span class="op" id="8009450">:=</span>&nbsp;<span class="ident" id="8009453">db</span><span class="op" id="8009455">.</span><span class="ident" id="8009456">Query</span><span class="op" id="8009461">(</span><span class="string" id="8009462">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="8009487">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8009490">if</span>&nbsp;<span class="ident" id="8009493">err</span>&nbsp;<span class="op" id="8009497">!=</span>&nbsp;<span class="builtintype" id="8009500">nil</span>&nbsp;<span class="op" id="8009504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8009508">t</span><span class="op" id="8009509">.</span><span class="ident" id="8009510">Fatalf</span><span class="op" id="8009516">(</span><span class="string" id="8009517">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="8009528">,</span>&nbsp;<span class="ident" id="8009530">err</span><span class="op" id="8009533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8009536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8009539">cols</span><span class="op" id="8009543">,</span>&nbsp;<span class="ident" id="8009545">err</span>&nbsp;<span class="op" id="8009549">:=</span>&nbsp;<span class="ident" id="8009552">rows</span><span class="op" id="8009556">.</span><span class="ident" id="8009557">Columns</span><span class="op" id="8009564">(</span><span class="op" id="8009565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8009568">if</span>&nbsp;<span class="ident" id="8009571">err</span>&nbsp;<span class="op" id="8009575">!=</span>&nbsp;<span class="builtintype" id="8009578">nil</span>&nbsp;<span class="op" id="8009582">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8009586">t</span><span class="op" id="8009587">.</span><span class="ident" id="8009588">Fatalf</span><span class="op" id="8009594">(</span><span class="string" id="8009595">&#34;Columns:&nbsp;%v&#34;</span><span class="op" id="8009608">,</span>&nbsp;<span class="ident" id="8009610">err</span><span class="op" id="8009613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8009616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8009619">want</span>&nbsp;<span class="op" id="8009624">:=</span>&nbsp;<span class="op" id="8009627">[</span><span class="op" id="8009628">]</span><span class="builtintype" id="8009629">string</span><span class="op" id="8009635">{</span><span class="string" id="8009636">&#34;age&#34;</span><span class="op" id="8009641">,</span>&nbsp;<span class="string" id="8009643">&#34;name&#34;</span><span class="op" id="8009649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8009652">if</span>&nbsp;<span class="op" id="8009655">!</span><span class="ident" id="8009656">reflect</span><span class="op" id="8009663">.</span><span class="ident" id="8009664">DeepEqual</span><span class="op" id="8009673">(</span><span class="ident" id="8009674">cols</span><span class="op" id="8009678">,</span>&nbsp;<span class="ident" id="8009680">want</span><span class="op" id="8009684">)</span>&nbsp;<span class="op" id="8009686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8009690">t</span><span class="op" id="8009691">.</span><span class="ident" id="8009692">Errorf</span><span class="op" id="8009698">(</span><span class="string" id="8009699">&#34;got&nbsp;%#v;&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="8009718">,</span>&nbsp;<span class="ident" id="8009720">cols</span><span class="op" id="8009724">,</span>&nbsp;<span class="ident" id="8009726">want</span><span class="op" id="8009730">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8009733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8009736">if</span>&nbsp;<span class="ident" id="8009739">err</span>&nbsp;<span class="op" id="8009743">:=</span>&nbsp;<span class="ident" id="8009746">rows</span><span class="op" id="8009750">.</span><span class="ident" id="8009751">Close</span><span class="op" id="8009756">(</span><span class="op" id="8009757">)</span><span class="op" id="8009758">;</span>&nbsp;<span class="ident" id="8009760">err</span>&nbsp;<span class="op" id="8009764">!=</span>&nbsp;<span class="builtintype" id="8009767">nil</span>&nbsp;<span class="op" id="8009771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8009775">t</span><span class="op" id="8009776">.</span><span class="ident" id="8009777">Errorf</span><span class="op" id="8009783">(</span><span class="string" id="8009784">&#34;error&nbsp;closing&nbsp;rows:&nbsp;%s&#34;</span><span class="op" id="8009808">,</span>&nbsp;<span class="ident" id="8009810">err</span><span class="op" id="8009813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8009816">}</span><br>
<span class="lineno"></span><span class="op" id="8009818">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="8009821">func</span>&nbsp;<span class="ident" id="8009826">TestQueryRow</span><span class="op" id="8009838">(</span><span class="ident" id="8009839">t</span>&nbsp;<span class="op" id="8009841">*</span><span class="ident" id="8009842">testing</span><span class="op" id="8009849">.</span><span class="ident" id="8009850">T</span><span class="op" id="8009851">)</span>&nbsp;<span class="op" id="8009853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8009856">db</span>&nbsp;<span class="op" id="8009859">:=</span>&nbsp;<span class="ident" id="8009862">newTestDB</span><span class="op" id="8009871">(</span><span class="ident" id="8009872">t</span><span class="op" id="8009873">,</span>&nbsp;<span class="string" id="8009875">&#34;people&#34;</span><span class="op" id="8009883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8009886">defer</span>&nbsp;<span class="ident" id="8009892">closeDB</span><span class="op" id="8009899">(</span><span class="ident" id="8009900">t</span><span class="op" id="8009901">,</span>&nbsp;<span class="ident" id="8009903">db</span><span class="op" id="8009905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8009908">var</span>&nbsp;<span class="ident" id="8009912">name</span>&nbsp;<span class="builtintype" id="8009917">string</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8009925">var</span>&nbsp;<span class="ident" id="8009929">age</span>&nbsp;<span class="builtintype" id="8009933">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8009938">var</span>&nbsp;<span class="ident" id="8009942">birthday</span>&nbsp;<span class="ident" id="8009951">time</span><span class="op" id="8009955">.</span><span class="ident" id="8009956">Time</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8009963">err</span>&nbsp;<span class="op" id="8009967">:=</span>&nbsp;<span class="ident" id="8009970">db</span><span class="op" id="8009972">.</span><span class="ident" id="8009973">QueryRow</span><span class="op" id="8009981">(</span><span class="string" id="8009982">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="8010012">,</span>&nbsp;<span class="num" id="8010014">3</span><span class="op" id="8010015">)</span><span class="op" id="8010016">.</span><span class="ident" id="8010017">Scan</span><span class="op" id="8010021">(</span><span class="op" id="8010022">&amp;</span><span class="ident" id="8010023">age</span><span class="op" id="8010026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8010029">if</span>&nbsp;<span class="ident" id="8010032">err</span>&nbsp;<span class="op" id="8010036">==</span>&nbsp;<span class="builtintype" id="8010039">nil</span>&nbsp;<span class="op" id="8010043">||</span>&nbsp;<span class="op" id="8010046">!</span><span class="ident" id="8010047">strings</span><span class="op" id="8010054">.</span><span class="ident" id="8010055">Contains</span><span class="op" id="8010063">(</span><span class="ident" id="8010064">err</span><span class="op" id="8010067">.</span><span class="ident" id="8010068">Error</span><span class="op" id="8010073">(</span><span class="op" id="8010074">)</span><span class="op" id="8010075">,</span>&nbsp;<span class="string" id="8010077">&#34;expected&nbsp;2&nbsp;destination&nbsp;arguments&#34;</span><span class="op" id="8010111">)</span>&nbsp;<span class="op" id="8010113">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8010117">t</span><span class="op" id="8010118">.</span><span class="ident" id="8010119">Errorf</span><span class="op" id="8010125">(</span><span class="string" id="8010126">&#34;expected&nbsp;error&nbsp;from&nbsp;wrong&nbsp;number&nbsp;of&nbsp;arguments;&nbsp;actually&nbsp;got:&nbsp;%v&#34;</span><span class="op" id="8010191">,</span>&nbsp;<span class="ident" id="8010193">err</span><span class="op" id="8010196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8010199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8010203">err</span>&nbsp;<span class="op" id="8010207">=</span>&nbsp;<span class="ident" id="8010209">db</span><span class="op" id="8010211">.</span><span class="ident" id="8010212">QueryRow</span><span class="op" id="8010220">(</span><span class="string" id="8010221">&#34;SELECT|people|bdate|age=?&#34;</span><span class="op" id="8010248">,</span>&nbsp;<span class="num" id="8010250">3</span><span class="op" id="8010251">)</span><span class="op" id="8010252">.</span><span class="ident" id="8010253">Scan</span><span class="op" id="8010257">(</span><span class="op" id="8010258">&amp;</span><span class="ident" id="8010259">birthday</span><span class="op" id="8010267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8010270">if</span>&nbsp;<span class="ident" id="8010273">err</span>&nbsp;<span class="op" id="8010277">!=</span>&nbsp;<span class="builtintype" id="8010280">nil</span>&nbsp;<span class="op" id="8010284">||</span>&nbsp;<span class="op" id="8010287">!</span><span class="ident" id="8010288">birthday</span><span class="op" id="8010296">.</span><span class="ident" id="8010297">Equal</span><span class="op" id="8010302">(</span><span class="ident" id="8010303">chrisBirthday</span><span class="op" id="8010316">)</span>&nbsp;<span class="op" id="8010318">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8010322">t</span><span class="op" id="8010323">.</span><span class="ident" id="8010324">Errorf</span><span class="op" id="8010330">(</span><span class="string" id="8010331">&#34;chris&nbsp;birthday&nbsp;=&nbsp;%v,&nbsp;err&nbsp;=&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8010371">,</span>&nbsp;<span class="ident" id="8010373">birthday</span><span class="op" id="8010381">,</span>&nbsp;<span class="ident" id="8010383">err</span><span class="op" id="8010386">,</span>&nbsp;<span class="ident" id="8010388">chrisBirthday</span><span class="op" id="8010401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8010404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8010408">err</span>&nbsp;<span class="op" id="8010412">=</span>&nbsp;<span class="ident" id="8010414">db</span><span class="op" id="8010416">.</span><span class="ident" id="8010417">QueryRow</span><span class="op" id="8010425">(</span><span class="string" id="8010426">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="8010456">,</span>&nbsp;<span class="num" id="8010458">2</span><span class="op" id="8010459">)</span><span class="op" id="8010460">.</span><span class="ident" id="8010461">Scan</span><span class="op" id="8010465">(</span><span class="op" id="8010466">&amp;</span><span class="ident" id="8010467">age</span><span class="op" id="8010470">,</span>&nbsp;<span class="op" id="8010472">&amp;</span><span class="ident" id="8010473">name</span><span class="op" id="8010477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8010480">if</span>&nbsp;<span class="ident" id="8010483">err</span>&nbsp;<span class="op" id="8010487">!=</span>&nbsp;<span class="builtintype" id="8010490">nil</span>&nbsp;<span class="op" id="8010494">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8010498">t</span><span class="op" id="8010499">.</span><span class="ident" id="8010500">Fatalf</span><span class="op" id="8010506">(</span><span class="string" id="8010507">&#34;age&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="8010530">,</span>&nbsp;<span class="ident" id="8010532">err</span><span class="op" id="8010535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8010538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8010541">if</span>&nbsp;<span class="ident" id="8010544">name</span>&nbsp;<span class="op" id="8010549">!=</span>&nbsp;<span class="string" id="8010552">&#34;Bob&#34;</span>&nbsp;<span class="op" id="8010558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8010562">t</span><span class="op" id="8010563">.</span><span class="ident" id="8010564">Errorf</span><span class="op" id="8010570">(</span><span class="string" id="8010571">&#34;expected&nbsp;name&nbsp;Bob,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="8010598">,</span>&nbsp;<span class="ident" id="8010600">name</span><span class="op" id="8010604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8010607">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8010610">if</span>&nbsp;<span class="ident" id="8010613">age</span>&nbsp;<span class="op" id="8010617">!=</span>&nbsp;<span class="num" id="8010620">2</span>&nbsp;<span class="op" id="8010622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8010626">t</span><span class="op" id="8010627">.</span><span class="ident" id="8010628">Errorf</span><span class="op" id="8010634">(</span><span class="string" id="8010635">&#34;expected&nbsp;age&nbsp;2,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="8010659">,</span>&nbsp;<span class="ident" id="8010661">age</span><span class="op" id="8010664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8010667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8010671">err</span>&nbsp;<span class="op" id="8010675">=</span>&nbsp;<span class="ident" id="8010677">db</span><span class="op" id="8010679">.</span><span class="ident" id="8010680">QueryRow</span><span class="op" id="8010688">(</span><span class="string" id="8010689">&#34;SELECT|people|age,name|name=?&#34;</span><span class="op" id="8010720">,</span>&nbsp;<span class="string" id="8010722">&#34;Alice&#34;</span><span class="op" id="8010729">)</span><span class="op" id="8010730">.</span><span class="ident" id="8010731">Scan</span><span class="op" id="8010735">(</span><span class="op" id="8010736">&amp;</span><span class="ident" id="8010737">age</span><span class="op" id="8010740">,</span>&nbsp;<span class="op" id="8010742">&amp;</span><span class="ident" id="8010743">name</span><span class="op" id="8010747">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8010750">if</span>&nbsp;<span class="ident" id="8010753">err</span>&nbsp;<span class="op" id="8010757">!=</span>&nbsp;<span class="builtintype" id="8010760">nil</span>&nbsp;<span class="op" id="8010764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8010768">t</span><span class="op" id="8010769">.</span><span class="ident" id="8010770">Fatalf</span><span class="op" id="8010776">(</span><span class="string" id="8010777">&#34;name&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="8010801">,</span>&nbsp;<span class="ident" id="8010803">err</span><span class="op" id="8010806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8010809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8010812">if</span>&nbsp;<span class="ident" id="8010815">name</span>&nbsp;<span class="op" id="8010820">!=</span>&nbsp;<span class="string" id="8010823">&#34;Alice&#34;</span>&nbsp;<span class="op" id="8010831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8010835">t</span><span class="op" id="8010836">.</span><span class="ident" id="8010837">Errorf</span><span class="op" id="8010843">(</span><span class="string" id="8010844">&#34;expected&nbsp;name&nbsp;Alice,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="8010873">,</span>&nbsp;<span class="ident" id="8010875">name</span><span class="op" id="8010879">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8010882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8010885">if</span>&nbsp;<span class="ident" id="8010888">age</span>&nbsp;<span class="op" id="8010892">!=</span>&nbsp;<span class="num" id="8010895">1</span>&nbsp;<span class="op" id="8010897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8010901">t</span><span class="op" id="8010902">.</span><span class="ident" id="8010903">Errorf</span><span class="op" id="8010909">(</span><span class="string" id="8010910">&#34;expected&nbsp;age&nbsp;1,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="8010934">,</span>&nbsp;<span class="ident" id="8010936">age</span><span class="op" id="8010939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8010942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8010946">var</span>&nbsp;<span class="ident" id="8010950">photo</span>&nbsp;<span class="op" id="8010956">[</span><span class="op" id="8010957">]</span><span class="builtintype" id="8010958">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8010964">err</span>&nbsp;<span class="op" id="8010968">=</span>&nbsp;<span class="ident" id="8010970">db</span><span class="op" id="8010972">.</span><span class="ident" id="8010973">QueryRow</span><span class="op" id="8010981">(</span><span class="string" id="8010982">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="8011010">,</span>&nbsp;<span class="string" id="8011012">&#34;Alice&#34;</span><span class="op" id="8011019">)</span><span class="op" id="8011020">.</span><span class="ident" id="8011021">Scan</span><span class="op" id="8011025">(</span><span class="op" id="8011026">&amp;</span><span class="ident" id="8011027">photo</span><span class="op" id="8011032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8011035">if</span>&nbsp;<span class="ident" id="8011038">err</span>&nbsp;<span class="op" id="8011042">!=</span>&nbsp;<span class="builtintype" id="8011045">nil</span>&nbsp;<span class="op" id="8011049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8011053">t</span><span class="op" id="8011054">.</span><span class="ident" id="8011055">Fatalf</span><span class="op" id="8011061">(</span><span class="string" id="8011062">&#34;photo&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="8011087">,</span>&nbsp;<span class="ident" id="8011089">err</span><span class="op" id="8011092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8011095">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8011098">want</span>&nbsp;<span class="op" id="8011103">:=</span>&nbsp;<span class="op" id="8011106">[</span><span class="op" id="8011107">]</span><span class="builtintype" id="8011108">byte</span><span class="op" id="8011112">(</span><span class="string" id="8011113">&#34;APHOTO&#34;</span><span class="op" id="8011121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8011124">if</span>&nbsp;<span class="op" id="8011127">!</span><span class="ident" id="8011128">reflect</span><span class="op" id="8011135">.</span><span class="ident" id="8011136">DeepEqual</span><span class="op" id="8011145">(</span><span class="ident" id="8011146">photo</span><span class="op" id="8011151">,</span>&nbsp;<span class="ident" id="8011153">want</span><span class="op" id="8011157">)</span>&nbsp;<span class="op" id="8011159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8011163">t</span><span class="op" id="8011164">.</span><span class="ident" id="8011165">Errorf</span><span class="op" id="8011171">(</span><span class="string" id="8011172">&#34;photo&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8011193">,</span>&nbsp;<span class="ident" id="8011195">photo</span><span class="op" id="8011200">,</span>&nbsp;<span class="ident" id="8011202">want</span><span class="op" id="8011206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8011209">}</span><br>
<span class="lineno"></span><span class="op" id="8011211">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="8011214">func</span>&nbsp;<span class="ident" id="8011219">TestStatementErrorAfterClose</span><span class="op" id="8011247">(</span><span class="ident" id="8011248">t</span>&nbsp;<span class="op" id="8011250">*</span><span class="ident" id="8011251">testing</span><span class="op" id="8011258">.</span><span class="ident" id="8011259">T</span><span class="op" id="8011260">)</span>&nbsp;<span class="op" id="8011262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8011265">db</span>&nbsp;<span class="op" id="8011268">:=</span>&nbsp;<span class="ident" id="8011271">newTestDB</span><span class="op" id="8011280">(</span><span class="ident" id="8011281">t</span><span class="op" id="8011282">,</span>&nbsp;<span class="string" id="8011284">&#34;people&#34;</span><span class="op" id="8011292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8011295">defer</span>&nbsp;<span class="ident" id="8011301">closeDB</span><span class="op" id="8011308">(</span><span class="ident" id="8011309">t</span><span class="op" id="8011310">,</span>&nbsp;<span class="ident" id="8011312">db</span><span class="op" id="8011314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8011317">stmt</span><span class="op" id="8011321">,</span>&nbsp;<span class="ident" id="8011323">err</span>&nbsp;<span class="op" id="8011327">:=</span>&nbsp;<span class="ident" id="8011330">db</span><span class="op" id="8011332">.</span><span class="ident" id="8011333">Prepare</span><span class="op" id="8011340">(</span><span class="string" id="8011341">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="8011367">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8011370">if</span>&nbsp;<span class="ident" id="8011373">err</span>&nbsp;<span class="op" id="8011377">!=</span>&nbsp;<span class="builtintype" id="8011380">nil</span>&nbsp;<span class="op" id="8011384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8011388">t</span><span class="op" id="8011389">.</span><span class="ident" id="8011390">Fatalf</span><span class="op" id="8011396">(</span><span class="string" id="8011397">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="8011410">,</span>&nbsp;<span class="ident" id="8011412">err</span><span class="op" id="8011415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8011418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8011421">err</span>&nbsp;<span class="op" id="8011425">=</span>&nbsp;<span class="ident" id="8011427">stmt</span><span class="op" id="8011431">.</span><span class="ident" id="8011432">Close</span><span class="op" id="8011437">(</span><span class="op" id="8011438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8011441">if</span>&nbsp;<span class="ident" id="8011444">err</span>&nbsp;<span class="op" id="8011448">!=</span>&nbsp;<span class="builtintype" id="8011451">nil</span>&nbsp;<span class="op" id="8011455">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8011459">t</span><span class="op" id="8011460">.</span><span class="ident" id="8011461">Fatalf</span><span class="op" id="8011467">(</span><span class="string" id="8011468">&#34;Close:&nbsp;%v&#34;</span><span class="op" id="8011479">,</span>&nbsp;<span class="ident" id="8011481">err</span><span class="op" id="8011484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8011487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8011490">var</span>&nbsp;<span class="ident" id="8011494">name</span>&nbsp;<span class="builtintype" id="8011499">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8011507">err</span>&nbsp;<span class="op" id="8011511">=</span>&nbsp;<span class="ident" id="8011513">stmt</span><span class="op" id="8011517">.</span><span class="ident" id="8011518">QueryRow</span><span class="op" id="8011526">(</span><span class="string" id="8011527">&#34;foo&#34;</span><span class="op" id="8011532">)</span><span class="op" id="8011533">.</span><span class="ident" id="8011534">Scan</span><span class="op" id="8011538">(</span><span class="op" id="8011539">&amp;</span><span class="ident" id="8011540">name</span><span class="op" id="8011544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8011547">if</span>&nbsp;<span class="ident" id="8011550">err</span>&nbsp;<span class="op" id="8011554">==</span>&nbsp;<span class="builtintype" id="8011557">nil</span>&nbsp;<span class="op" id="8011561">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8011565">t</span><span class="op" id="8011566">.</span><span class="ident" id="8011567">Errorf</span><span class="op" id="8011573">(</span><span class="string" id="8011574">&#34;expected&nbsp;error&nbsp;from&nbsp;QueryRow.Scan&nbsp;after&nbsp;Stmt.Close&#34;</span><span class="op" id="8011626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8011629">}</span><br>
<span class="lineno"></span><span class="op" id="8011631">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8011634">func</span>&nbsp;<span class="ident" id="8011639">TestStatementQueryRow</span><span class="op" id="8011660">(</span><span class="ident" id="8011661">t</span>&nbsp;<span class="op" id="8011663">*</span><span class="ident" id="8011664">testing</span><span class="op" id="8011671">.</span><span class="ident" id="8011672">T</span><span class="op" id="8011673">)</span>&nbsp;<span class="op" id="8011675">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8011678">db</span>&nbsp;<span class="op" id="8011681">:=</span>&nbsp;<span class="ident" id="8011684">newTestDB</span><span class="op" id="8011693">(</span><span class="ident" id="8011694">t</span><span class="op" id="8011695">,</span>&nbsp;<span class="string" id="8011697">&#34;people&#34;</span><span class="op" id="8011705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8011708">defer</span>&nbsp;<span class="ident" id="8011714">closeDB</span><span class="op" id="8011721">(</span><span class="ident" id="8011722">t</span><span class="op" id="8011723">,</span>&nbsp;<span class="ident" id="8011725">db</span><span class="op" id="8011727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8011730">stmt</span><span class="op" id="8011734">,</span>&nbsp;<span class="ident" id="8011736">err</span>&nbsp;<span class="op" id="8011740">:=</span>&nbsp;<span class="ident" id="8011743">db</span><span class="op" id="8011745">.</span><span class="ident" id="8011746">Prepare</span><span class="op" id="8011753">(</span><span class="string" id="8011754">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="8011780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8011783">if</span>&nbsp;<span class="ident" id="8011786">err</span>&nbsp;<span class="op" id="8011790">!=</span>&nbsp;<span class="builtintype" id="8011793">nil</span>&nbsp;<span class="op" id="8011797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8011801">t</span><span class="op" id="8011802">.</span><span class="ident" id="8011803">Fatalf</span><span class="op" id="8011809">(</span><span class="string" id="8011810">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="8011823">,</span>&nbsp;<span class="ident" id="8011825">err</span><span class="op" id="8011828">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8011831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8011834">defer</span>&nbsp;<span class="ident" id="8011840">stmt</span><span class="op" id="8011844">.</span><span class="ident" id="8011845">Close</span><span class="op" id="8011850">(</span><span class="op" id="8011851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8011854">var</span>&nbsp;<span class="ident" id="8011858">age</span>&nbsp;<span class="builtintype" id="8011862">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8011867">for</span>&nbsp;<span class="ident" id="8011871">n</span><span class="op" id="8011872">,</span>&nbsp;<span class="ident" id="8011874">tt</span>&nbsp;<span class="op" id="8011877">:=</span>&nbsp;<span class="keyword" id="8011880">range</span>&nbsp;<span class="op" id="8011886">[</span><span class="op" id="8011887">]</span><span class="keyword" id="8011888">struct</span>&nbsp;<span class="op" id="8011895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8011899">name</span>&nbsp;<span class="builtintype" id="8011904">string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8011913">want</span>&nbsp;<span class="builtintype" id="8011918">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8011923">}</span><span class="op" id="8011924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8011928">{</span><span class="string" id="8011929">&#34;Alice&#34;</span><span class="op" id="8011936">,</span>&nbsp;<span class="num" id="8011938">1</span><span class="op" id="8011939">}</span><span class="op" id="8011940">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8011944">{</span><span class="string" id="8011945">&#34;Bob&#34;</span><span class="op" id="8011950">,</span>&nbsp;<span class="num" id="8011952">2</span><span class="op" id="8011953">}</span><span class="op" id="8011954">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8011958">{</span><span class="string" id="8011959">&#34;Chris&#34;</span><span class="op" id="8011966">,</span>&nbsp;<span class="num" id="8011968">3</span><span class="op" id="8011969">}</span><span class="op" id="8011970">,</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8011973">}</span>&nbsp;<span class="op" id="8011975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8011979">if</span>&nbsp;<span class="ident" id="8011982">err</span>&nbsp;<span class="op" id="8011986">:=</span>&nbsp;<span class="ident" id="8011989">stmt</span><span class="op" id="8011993">.</span><span class="ident" id="8011994">QueryRow</span><span class="op" id="8012002">(</span><span class="ident" id="8012003">tt</span><span class="op" id="8012005">.</span><span class="ident" id="8012006">name</span><span class="op" id="8012010">)</span><span class="op" id="8012011">.</span><span class="ident" id="8012012">Scan</span><span class="op" id="8012016">(</span><span class="op" id="8012017">&amp;</span><span class="ident" id="8012018">age</span><span class="op" id="8012021">)</span><span class="op" id="8012022">;</span>&nbsp;<span class="ident" id="8012024">err</span>&nbsp;<span class="op" id="8012028">!=</span>&nbsp;<span class="builtintype" id="8012031">nil</span>&nbsp;<span class="op" id="8012035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8012040">t</span><span class="op" id="8012041">.</span><span class="ident" id="8012042">Errorf</span><span class="op" id="8012048">(</span><span class="string" id="8012049">&#34;%d:&nbsp;on&nbsp;%q,&nbsp;QueryRow/Scan:&nbsp;%v&#34;</span><span class="op" id="8012079">,</span>&nbsp;<span class="ident" id="8012081">n</span><span class="op" id="8012082">,</span>&nbsp;<span class="ident" id="8012084">tt</span><span class="op" id="8012086">.</span><span class="ident" id="8012087">name</span><span class="op" id="8012091">,</span>&nbsp;<span class="ident" id="8012093">err</span><span class="op" id="8012096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8012100">}</span>&nbsp;<span class="keyword" id="8012102">else</span>&nbsp;<span class="keyword" id="8012107">if</span>&nbsp;<span class="ident" id="8012110">age</span>&nbsp;<span class="op" id="8012114">!=</span>&nbsp;<span class="ident" id="8012117">tt</span><span class="op" id="8012119">.</span><span class="ident" id="8012120">want</span>&nbsp;<span class="op" id="8012125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8012130">t</span><span class="op" id="8012131">.</span><span class="ident" id="8012132">Errorf</span><span class="op" id="8012138">(</span><span class="string" id="8012139">&#34;%d:&nbsp;age=%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8012160">,</span>&nbsp;<span class="ident" id="8012162">n</span><span class="op" id="8012163">,</span>&nbsp;<span class="ident" id="8012165">age</span><span class="op" id="8012168">,</span>&nbsp;<span class="ident" id="8012170">tt</span><span class="op" id="8012172">.</span><span class="ident" id="8012173">want</span><span class="op" id="8012177">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8012181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8012184">}</span><br>
<span class="lineno"></span><span class="op" id="8012186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8012189">//&nbsp;golang.org/issue/3734</span><br>
<span class="lineno">360</span><span class="keyword" id="8012214">func</span>&nbsp;<span class="ident" id="8012219">TestStatementQueryRowConcurrent</span><span class="op" id="8012250">(</span><span class="ident" id="8012251">t</span>&nbsp;<span class="op" id="8012253">*</span><span class="ident" id="8012254">testing</span><span class="op" id="8012261">.</span><span class="ident" id="8012262">T</span><span class="op" id="8012263">)</span>&nbsp;<span class="op" id="8012265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8012268">db</span>&nbsp;<span class="op" id="8012271">:=</span>&nbsp;<span class="ident" id="8012274">newTestDB</span><span class="op" id="8012283">(</span><span class="ident" id="8012284">t</span><span class="op" id="8012285">,</span>&nbsp;<span class="string" id="8012287">&#34;people&#34;</span><span class="op" id="8012295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8012298">defer</span>&nbsp;<span class="ident" id="8012304">closeDB</span><span class="op" id="8012311">(</span><span class="ident" id="8012312">t</span><span class="op" id="8012313">,</span>&nbsp;<span class="ident" id="8012315">db</span><span class="op" id="8012317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8012320">stmt</span><span class="op" id="8012324">,</span>&nbsp;<span class="ident" id="8012326">err</span>&nbsp;<span class="op" id="8012330">:=</span>&nbsp;<span class="ident" id="8012333">db</span><span class="op" id="8012335">.</span><span class="ident" id="8012336">Prepare</span><span class="op" id="8012343">(</span><span class="string" id="8012344">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="8012370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8012373">if</span>&nbsp;<span class="ident" id="8012376">err</span>&nbsp;<span class="op" id="8012380">!=</span>&nbsp;<span class="builtintype" id="8012383">nil</span>&nbsp;<span class="op" id="8012387">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8012391">t</span><span class="op" id="8012392">.</span><span class="ident" id="8012393">Fatalf</span><span class="op" id="8012399">(</span><span class="string" id="8012400">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="8012413">,</span>&nbsp;<span class="ident" id="8012415">err</span><span class="op" id="8012418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8012421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8012424">defer</span>&nbsp;<span class="ident" id="8012430">stmt</span><span class="op" id="8012434">.</span><span class="ident" id="8012435">Close</span><span class="op" id="8012440">(</span><span class="op" id="8012441">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8012445">const</span>&nbsp;<span class="ident" id="8012451">n</span>&nbsp;<span class="op" id="8012453">=</span>&nbsp;<span class="num" id="8012455">10</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8012459">ch</span>&nbsp;<span class="op" id="8012462">:=</span>&nbsp;<span class="builtinfunc" id="8012465">make</span><span class="op" id="8012469">(</span><span class="keyword" id="8012470">chan</span>&nbsp;<span class="builtintype" id="8012475">error</span><span class="op" id="8012480">,</span>&nbsp;<span class="ident" id="8012482">n</span><span class="op" id="8012483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8012486">for</span>&nbsp;<span class="ident" id="8012490">i</span>&nbsp;<span class="op" id="8012492">:=</span>&nbsp;<span class="num" id="8012495">0</span><span class="op" id="8012496">;</span>&nbsp;<span class="ident" id="8012498">i</span>&nbsp;<span class="op" id="8012500">&lt;</span>&nbsp;<span class="ident" id="8012502">n</span><span class="op" id="8012503">;</span>&nbsp;<span class="ident" id="8012505">i</span><span class="op" id="8012506">++</span>&nbsp;<span class="op" id="8012509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8012513">go</span>&nbsp;<span class="keyword" id="8012516">func</span><span class="op" id="8012520">(</span><span class="op" id="8012521">)</span>&nbsp;<span class="op" id="8012523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8012528">var</span>&nbsp;<span class="ident" id="8012532">age</span>&nbsp;<span class="builtintype" id="8012536">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8012543">err</span>&nbsp;<span class="op" id="8012547">:=</span>&nbsp;<span class="ident" id="8012550">stmt</span><span class="op" id="8012554">.</span><span class="ident" id="8012555">QueryRow</span><span class="op" id="8012563">(</span><span class="string" id="8012564">&#34;Alice&#34;</span><span class="op" id="8012571">)</span><span class="op" id="8012572">.</span><span class="ident" id="8012573">Scan</span><span class="op" id="8012577">(</span><span class="op" id="8012578">&amp;</span><span class="ident" id="8012579">age</span><span class="op" id="8012582">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8012587">if</span>&nbsp;<span class="ident" id="8012590">err</span>&nbsp;<span class="op" id="8012594">==</span>&nbsp;<span class="builtintype" id="8012597">nil</span>&nbsp;<span class="op" id="8012601">&amp;&amp;</span>&nbsp;<span class="ident" id="8012604">age</span>&nbsp;<span class="op" id="8012608">!=</span>&nbsp;<span class="num" id="8012611">1</span>&nbsp;<span class="op" id="8012613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8012619">err</span>&nbsp;<span class="op" id="8012623">=</span>&nbsp;<span class="ident" id="8012625">fmt</span><span class="op" id="8012628">.</span><span class="ident" id="8012629">Errorf</span><span class="op" id="8012635">(</span><span class="string" id="8012636">&#34;unexpected&nbsp;age&nbsp;%d&#34;</span><span class="op" id="8012655">,</span>&nbsp;<span class="ident" id="8012657">age</span><span class="op" id="8012660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8012665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8012670">ch</span>&nbsp;<span class="op" id="8012673">&lt;-</span>&nbsp;<span class="ident" id="8012676">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8012682">}</span><span class="op" id="8012683">(</span><span class="op" id="8012684">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8012687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8012690">for</span>&nbsp;<span class="ident" id="8012694">i</span>&nbsp;<span class="op" id="8012696">:=</span>&nbsp;<span class="num" id="8012699">0</span><span class="op" id="8012700">;</span>&nbsp;<span class="ident" id="8012702">i</span>&nbsp;<span class="op" id="8012704">&lt;</span>&nbsp;<span class="ident" id="8012706">n</span><span class="op" id="8012707">;</span>&nbsp;<span class="ident" id="8012709">i</span><span class="op" id="8012710">++</span>&nbsp;<span class="op" id="8012713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8012717">if</span>&nbsp;<span class="ident" id="8012720">err</span>&nbsp;<span class="op" id="8012724">:=</span>&nbsp;<span class="op" id="8012727">&lt;-</span><span class="ident" id="8012729">ch</span><span class="op" id="8012731">;</span>&nbsp;<span class="ident" id="8012733">err</span>&nbsp;<span class="op" id="8012737">!=</span>&nbsp;<span class="builtintype" id="8012740">nil</span>&nbsp;<span class="op" id="8012744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8012749">t</span><span class="op" id="8012750">.</span><span class="ident" id="8012751">Error</span><span class="op" id="8012756">(</span><span class="ident" id="8012757">err</span><span class="op" id="8012760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8012764">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8012767">}</span><br>
<span class="lineno"></span><span class="op" id="8012769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8012772">//&nbsp;just&nbsp;a&nbsp;test&nbsp;of&nbsp;fakedb&nbsp;itself</span><br>
<span class="lineno"></span><span class="keyword" id="8012804">func</span>&nbsp;<span class="ident" id="8012809">TestBogusPreboundParameters</span><span class="op" id="8012836">(</span><span class="ident" id="8012837">t</span>&nbsp;<span class="op" id="8012839">*</span><span class="ident" id="8012840">testing</span><span class="op" id="8012847">.</span><span class="ident" id="8012848">T</span><span class="op" id="8012849">)</span>&nbsp;<span class="op" id="8012851">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8012854">db</span>&nbsp;<span class="op" id="8012857">:=</span>&nbsp;<span class="ident" id="8012860">newTestDB</span><span class="op" id="8012869">(</span><span class="ident" id="8012870">t</span><span class="op" id="8012871">,</span>&nbsp;<span class="string" id="8012873">&#34;foo&#34;</span><span class="op" id="8012878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8012881">defer</span>&nbsp;<span class="ident" id="8012887">closeDB</span><span class="op" id="8012894">(</span><span class="ident" id="8012895">t</span><span class="op" id="8012896">,</span>&nbsp;<span class="ident" id="8012898">db</span><span class="op" id="8012900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8012903">exec</span><span class="op" id="8012907">(</span><span class="ident" id="8012908">t</span><span class="op" id="8012909">,</span>&nbsp;<span class="ident" id="8012911">db</span><span class="op" id="8012913">,</span>&nbsp;<span class="string" id="8012915">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8012958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8012961">_</span><span class="op" id="8012962">,</span>&nbsp;<span class="ident" id="8012964">err</span>&nbsp;<span class="op" id="8012968">:=</span>&nbsp;<span class="ident" id="8012971">db</span><span class="op" id="8012973">.</span><span class="ident" id="8012974">Prepare</span><span class="op" id="8012981">(</span><span class="string" id="8012982">&#34;INSERT|t1|name=?,age=bogusconversion&#34;</span><span class="op" id="8013020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8013023">if</span>&nbsp;<span class="ident" id="8013026">err</span>&nbsp;<span class="op" id="8013030">==</span>&nbsp;<span class="builtintype" id="8013033">nil</span>&nbsp;<span class="op" id="8013037">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8013041">t</span><span class="op" id="8013042">.</span><span class="ident" id="8013043">Fatalf</span><span class="op" id="8013049">(</span><span class="string" id="8013050">&#34;expected&nbsp;error&#34;</span><span class="op" id="8013066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8013069">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8013072">if</span>&nbsp;<span class="ident" id="8013075">err</span><span class="op" id="8013078">.</span><span class="ident" id="8013079">Error</span><span class="op" id="8013084">(</span><span class="op" id="8013085">)</span>&nbsp;<span class="op" id="8013087">!=</span>&nbsp;<span class="string" id="8013090">`fakedb:&nbsp;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;&#34;bogusconversion&#34;`</span>&nbsp;<span class="op" id="8013151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8013155">t</span><span class="op" id="8013156">.</span><span class="ident" id="8013157">Errorf</span><span class="op" id="8013163">(</span><span class="string" id="8013164">&#34;unexpected&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8013186">,</span>&nbsp;<span class="ident" id="8013188">err</span><span class="op" id="8013191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8013194">}</span><br>
<span class="lineno">400</span><span class="op" id="8013196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8013199">func</span>&nbsp;<span class="ident" id="8013204">TestExec</span><span class="op" id="8013212">(</span><span class="ident" id="8013213">t</span>&nbsp;<span class="op" id="8013215">*</span><span class="ident" id="8013216">testing</span><span class="op" id="8013223">.</span><span class="ident" id="8013224">T</span><span class="op" id="8013225">)</span>&nbsp;<span class="op" id="8013227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8013230">db</span>&nbsp;<span class="op" id="8013233">:=</span>&nbsp;<span class="ident" id="8013236">newTestDB</span><span class="op" id="8013245">(</span><span class="ident" id="8013246">t</span><span class="op" id="8013247">,</span>&nbsp;<span class="string" id="8013249">&#34;foo&#34;</span><span class="op" id="8013254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8013257">defer</span>&nbsp;<span class="ident" id="8013263">closeDB</span><span class="op" id="8013270">(</span><span class="ident" id="8013271">t</span><span class="op" id="8013272">,</span>&nbsp;<span class="ident" id="8013274">db</span><span class="op" id="8013276">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8013279">exec</span><span class="op" id="8013283">(</span><span class="ident" id="8013284">t</span><span class="op" id="8013285">,</span>&nbsp;<span class="ident" id="8013287">db</span><span class="op" id="8013289">,</span>&nbsp;<span class="string" id="8013291">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8013334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8013337">stmt</span><span class="op" id="8013341">,</span>&nbsp;<span class="ident" id="8013343">err</span>&nbsp;<span class="op" id="8013347">:=</span>&nbsp;<span class="ident" id="8013350">db</span><span class="op" id="8013352">.</span><span class="ident" id="8013353">Prepare</span><span class="op" id="8013360">(</span><span class="string" id="8013361">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="8013385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8013388">if</span>&nbsp;<span class="ident" id="8013391">err</span>&nbsp;<span class="op" id="8013395">!=</span>&nbsp;<span class="builtintype" id="8013398">nil</span>&nbsp;<span class="op" id="8013402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8013406">t</span><span class="op" id="8013407">.</span><span class="ident" id="8013408">Errorf</span><span class="op" id="8013414">(</span><span class="string" id="8013415">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="8013435">,</span>&nbsp;<span class="ident" id="8013437">stmt</span><span class="op" id="8013441">,</span>&nbsp;<span class="ident" id="8013443">err</span><span class="op" id="8013446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8013449">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8013452">defer</span>&nbsp;<span class="ident" id="8013458">stmt</span><span class="op" id="8013462">.</span><span class="ident" id="8013463">Close</span><span class="op" id="8013468">(</span><span class="op" id="8013469">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8013473">type</span>&nbsp;<span class="ident" id="8013478">execTest</span>&nbsp;<span class="keyword" id="8013487">struct</span>&nbsp;<span class="op" id="8013494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8013498">args</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8013506">[</span><span class="op" id="8013507">]</span><span class="keyword" id="8013508">interface</span><span class="op" id="8013517">{</span><span class="op" id="8013518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8013522">wantErr</span>&nbsp;<span class="builtintype" id="8013530">string</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8013538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8013541">execTests</span>&nbsp;<span class="op" id="8013551">:=</span>&nbsp;<span class="op" id="8013554">[</span><span class="op" id="8013555">]</span><span class="ident" id="8013556">execTest</span><span class="op" id="8013564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8013568">//&nbsp;Okay:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8013579">{</span><span class="op" id="8013580">[</span><span class="op" id="8013581">]</span><span class="keyword" id="8013582">interface</span><span class="op" id="8013591">{</span><span class="op" id="8013592">}</span><span class="op" id="8013593">{</span><span class="string" id="8013594">&#34;Brad&#34;</span><span class="op" id="8013600">,</span>&nbsp;<span class="num" id="8013602">31</span><span class="op" id="8013604">}</span><span class="op" id="8013605">,</span>&nbsp;<span class="string" id="8013607">&#34;&#34;</span><span class="op" id="8013609">}</span><span class="op" id="8013610">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8013614">{</span><span class="op" id="8013615">[</span><span class="op" id="8013616">]</span><span class="keyword" id="8013617">interface</span><span class="op" id="8013626">{</span><span class="op" id="8013627">}</span><span class="op" id="8013628">{</span><span class="string" id="8013629">&#34;Brad&#34;</span><span class="op" id="8013635">,</span>&nbsp;<span class="ident" id="8013637">int64</span><span class="op" id="8013642">(</span><span class="num" id="8013643">31</span><span class="op" id="8013645">)</span><span class="op" id="8013646">}</span><span class="op" id="8013647">,</span>&nbsp;<span class="string" id="8013649">&#34;&#34;</span><span class="op" id="8013651">}</span><span class="op" id="8013652">,</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8013656">{</span><span class="op" id="8013657">[</span><span class="op" id="8013658">]</span><span class="keyword" id="8013659">interface</span><span class="op" id="8013668">{</span><span class="op" id="8013669">}</span><span class="op" id="8013670">{</span><span class="string" id="8013671">&#34;Bob&#34;</span><span class="op" id="8013676">,</span>&nbsp;<span class="string" id="8013678">&#34;32&#34;</span><span class="op" id="8013682">}</span><span class="op" id="8013683">,</span>&nbsp;<span class="string" id="8013685">&#34;&#34;</span><span class="op" id="8013687">}</span><span class="op" id="8013688">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8013692">{</span><span class="op" id="8013693">[</span><span class="op" id="8013694">]</span><span class="keyword" id="8013695">interface</span><span class="op" id="8013704">{</span><span class="op" id="8013705">}</span><span class="op" id="8013706">{</span><span class="num" id="8013707">7</span><span class="op" id="8013708">,</span>&nbsp;<span class="num" id="8013710">9</span><span class="op" id="8013711">}</span><span class="op" id="8013712">,</span>&nbsp;<span class="string" id="8013714">&#34;&#34;</span><span class="op" id="8013716">}</span><span class="op" id="8013717">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8013722">//&nbsp;Invalid&nbsp;conversions:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8013748">{</span><span class="op" id="8013749">[</span><span class="op" id="8013750">]</span><span class="keyword" id="8013751">interface</span><span class="op" id="8013760">{</span><span class="op" id="8013761">}</span><span class="op" id="8013762">{</span><span class="string" id="8013763">&#34;Brad&#34;</span><span class="op" id="8013769">,</span>&nbsp;<span class="ident" id="8013771">int64</span><span class="op" id="8013776">(</span><span class="num" id="8013777">0xFFFFFFFF</span><span class="op" id="8013787">)</span><span class="op" id="8013788">}</span><span class="op" id="8013789">,</span>&nbsp;<span class="string" id="8013791">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;4294967295&nbsp;overflows&nbsp;int32&#34;</span><span class="op" id="8013873">}</span><span class="op" id="8013874">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8013878">{</span><span class="op" id="8013879">[</span><span class="op" id="8013880">]</span><span class="keyword" id="8013881">interface</span><span class="op" id="8013890">{</span><span class="op" id="8013891">}</span><span class="op" id="8013892">{</span><span class="string" id="8013893">&#34;Brad&#34;</span><span class="op" id="8013899">,</span>&nbsp;<span class="string" id="8013901">&#34;strconv&nbsp;fail&#34;</span><span class="op" id="8013915">}</span><span class="op" id="8013916">,</span>&nbsp;<span class="string" id="8013918">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;\&#34;strconv&nbsp;fail\&#34;&nbsp;can&#39;t&nbsp;be&nbsp;converted&nbsp;to&nbsp;int32&#34;</span><span class="op" id="8014018">}</span><span class="op" id="8014019">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8014024">//&nbsp;Wrong&nbsp;number&nbsp;of&nbsp;args:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8014051">{</span><span class="op" id="8014052">[</span><span class="op" id="8014053">]</span><span class="keyword" id="8014054">interface</span><span class="op" id="8014063">{</span><span class="op" id="8014064">}</span><span class="op" id="8014065">{</span><span class="op" id="8014066">}</span><span class="op" id="8014067">,</span>&nbsp;<span class="string" id="8014069">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;0&#34;</span><span class="op" id="8014103">}</span><span class="op" id="8014104">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8014108">{</span><span class="op" id="8014109">[</span><span class="op" id="8014110">]</span><span class="keyword" id="8014111">interface</span><span class="op" id="8014120">{</span><span class="op" id="8014121">}</span><span class="op" id="8014122">{</span><span class="num" id="8014123">1</span><span class="op" id="8014124">,</span>&nbsp;<span class="num" id="8014126">2</span><span class="op" id="8014127">,</span>&nbsp;<span class="num" id="8014129">3</span><span class="op" id="8014130">}</span><span class="op" id="8014131">,</span>&nbsp;<span class="string" id="8014133">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;3&#34;</span><span class="op" id="8014167">}</span><span class="op" id="8014168">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8014171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8014174">for</span>&nbsp;<span class="ident" id="8014178">n</span><span class="op" id="8014179">,</span>&nbsp;<span class="ident" id="8014181">et</span>&nbsp;<span class="op" id="8014184">:=</span>&nbsp;<span class="keyword" id="8014187">range</span>&nbsp;<span class="ident" id="8014193">execTests</span>&nbsp;<span class="op" id="8014203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8014207">_</span><span class="op" id="8014208">,</span>&nbsp;<span class="ident" id="8014210">err</span>&nbsp;<span class="op" id="8014214">:=</span>&nbsp;<span class="ident" id="8014217">stmt</span><span class="op" id="8014221">.</span><span class="ident" id="8014222">Exec</span><span class="op" id="8014226">(</span><span class="ident" id="8014227">et</span><span class="op" id="8014229">.</span><span class="ident" id="8014230">args</span><span class="op" id="8014234">...</span><span class="op" id="8014237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8014241">errStr</span>&nbsp;<span class="op" id="8014248">:=</span>&nbsp;<span class="string" id="8014251">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8014256">if</span>&nbsp;<span class="ident" id="8014259">err</span>&nbsp;<span class="op" id="8014263">!=</span>&nbsp;<span class="builtintype" id="8014266">nil</span>&nbsp;<span class="op" id="8014270">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8014275">errStr</span>&nbsp;<span class="op" id="8014282">=</span>&nbsp;<span class="ident" id="8014284">err</span><span class="op" id="8014287">.</span><span class="ident" id="8014288">Error</span><span class="op" id="8014293">(</span><span class="op" id="8014294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8014298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8014302">if</span>&nbsp;<span class="ident" id="8014305">errStr</span>&nbsp;<span class="op" id="8014312">!=</span>&nbsp;<span class="ident" id="8014315">et</span><span class="op" id="8014317">.</span><span class="ident" id="8014318">wantErr</span>&nbsp;<span class="op" id="8014326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8014331">t</span><span class="op" id="8014332">.</span><span class="ident" id="8014333">Errorf</span><span class="op" id="8014339">(</span><span class="string" id="8014340">&#34;stmt.Execute&nbsp;#%d:&nbsp;for&nbsp;%v,&nbsp;got&nbsp;error&nbsp;%q,&nbsp;want&nbsp;error&nbsp;%q&#34;</span><span class="op" id="8014395">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8014401">n</span><span class="op" id="8014402">,</span>&nbsp;<span class="ident" id="8014404">et</span><span class="op" id="8014406">.</span><span class="ident" id="8014407">args</span><span class="op" id="8014411">,</span>&nbsp;<span class="ident" id="8014413">errStr</span><span class="op" id="8014419">,</span>&nbsp;<span class="ident" id="8014421">et</span><span class="op" id="8014423">.</span><span class="ident" id="8014424">wantErr</span><span class="op" id="8014431">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8014435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8014438">}</span><br>
<span class="lineno"></span><span class="op" id="8014440">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8014443">func</span>&nbsp;<span class="ident" id="8014448">TestTxPrepare</span><span class="op" id="8014461">(</span><span class="ident" id="8014462">t</span>&nbsp;<span class="op" id="8014464">*</span><span class="ident" id="8014465">testing</span><span class="op" id="8014472">.</span><span class="ident" id="8014473">T</span><span class="op" id="8014474">)</span>&nbsp;<span class="op" id="8014476">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8014479">db</span>&nbsp;<span class="op" id="8014482">:=</span>&nbsp;<span class="ident" id="8014485">newTestDB</span><span class="op" id="8014494">(</span><span class="ident" id="8014495">t</span><span class="op" id="8014496">,</span>&nbsp;<span class="string" id="8014498">&#34;&#34;</span><span class="op" id="8014500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8014503">defer</span>&nbsp;<span class="ident" id="8014509">closeDB</span><span class="op" id="8014516">(</span><span class="ident" id="8014517">t</span><span class="op" id="8014518">,</span>&nbsp;<span class="ident" id="8014520">db</span><span class="op" id="8014522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8014525">exec</span><span class="op" id="8014529">(</span><span class="ident" id="8014530">t</span><span class="op" id="8014531">,</span>&nbsp;<span class="ident" id="8014533">db</span><span class="op" id="8014535">,</span>&nbsp;<span class="string" id="8014537">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8014580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8014583">tx</span><span class="op" id="8014585">,</span>&nbsp;<span class="ident" id="8014587">err</span>&nbsp;<span class="op" id="8014591">:=</span>&nbsp;<span class="ident" id="8014594">db</span><span class="op" id="8014596">.</span><span class="ident" id="8014597">Begin</span><span class="op" id="8014602">(</span><span class="op" id="8014603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8014606">if</span>&nbsp;<span class="ident" id="8014609">err</span>&nbsp;<span class="op" id="8014613">!=</span>&nbsp;<span class="builtintype" id="8014616">nil</span>&nbsp;<span class="op" id="8014620">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8014624">t</span><span class="op" id="8014625">.</span><span class="ident" id="8014626">Fatalf</span><span class="op" id="8014632">(</span><span class="string" id="8014633">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8014645">,</span>&nbsp;<span class="ident" id="8014647">err</span><span class="op" id="8014650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8014653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8014656">stmt</span><span class="op" id="8014660">,</span>&nbsp;<span class="ident" id="8014662">err</span>&nbsp;<span class="op" id="8014666">:=</span>&nbsp;<span class="ident" id="8014669">tx</span><span class="op" id="8014671">.</span><span class="ident" id="8014672">Prepare</span><span class="op" id="8014679">(</span><span class="string" id="8014680">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="8014704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8014707">if</span>&nbsp;<span class="ident" id="8014710">err</span>&nbsp;<span class="op" id="8014714">!=</span>&nbsp;<span class="builtintype" id="8014717">nil</span>&nbsp;<span class="op" id="8014721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8014725">t</span><span class="op" id="8014726">.</span><span class="ident" id="8014727">Fatalf</span><span class="op" id="8014733">(</span><span class="string" id="8014734">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="8014754">,</span>&nbsp;<span class="ident" id="8014756">stmt</span><span class="op" id="8014760">,</span>&nbsp;<span class="ident" id="8014762">err</span><span class="op" id="8014765">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8014768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8014771">defer</span>&nbsp;<span class="ident" id="8014777">stmt</span><span class="op" id="8014781">.</span><span class="ident" id="8014782">Close</span><span class="op" id="8014787">(</span><span class="op" id="8014788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8014791">_</span><span class="op" id="8014792">,</span>&nbsp;<span class="ident" id="8014794">err</span>&nbsp;<span class="op" id="8014798">=</span>&nbsp;<span class="ident" id="8014800">stmt</span><span class="op" id="8014804">.</span><span class="ident" id="8014805">Exec</span><span class="op" id="8014809">(</span><span class="string" id="8014810">&#34;Bobby&#34;</span><span class="op" id="8014817">,</span>&nbsp;<span class="num" id="8014819">7</span><span class="op" id="8014820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8014823">if</span>&nbsp;<span class="ident" id="8014826">err</span>&nbsp;<span class="op" id="8014830">!=</span>&nbsp;<span class="builtintype" id="8014833">nil</span>&nbsp;<span class="op" id="8014837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8014841">t</span><span class="op" id="8014842">.</span><span class="ident" id="8014843">Fatalf</span><span class="op" id="8014849">(</span><span class="string" id="8014850">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8014861">,</span>&nbsp;<span class="ident" id="8014863">err</span><span class="op" id="8014866">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8014869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8014872">err</span>&nbsp;<span class="op" id="8014876">=</span>&nbsp;<span class="ident" id="8014878">tx</span><span class="op" id="8014880">.</span><span class="ident" id="8014881">Commit</span><span class="op" id="8014887">(</span><span class="op" id="8014888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8014891">if</span>&nbsp;<span class="ident" id="8014894">err</span>&nbsp;<span class="op" id="8014898">!=</span>&nbsp;<span class="builtintype" id="8014901">nil</span>&nbsp;<span class="op" id="8014905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8014909">t</span><span class="op" id="8014910">.</span><span class="ident" id="8014911">Fatalf</span><span class="op" id="8014917">(</span><span class="string" id="8014918">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8014931">,</span>&nbsp;<span class="ident" id="8014933">err</span><span class="op" id="8014936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8014939">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8014942">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8014988">if</span>&nbsp;<span class="op" id="8014991">!</span><span class="ident" id="8014992">stmt</span><span class="op" id="8014996">.</span><span class="ident" id="8014997">closed</span>&nbsp;<span class="op" id="8015004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8015008">t</span><span class="op" id="8015009">.</span><span class="ident" id="8015010">Fatal</span><span class="op" id="8015015">(</span><span class="string" id="8015016">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="8015046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8015049">}</span><br>
<span class="lineno"></span><span class="op" id="8015051">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="keyword" id="8015054">func</span>&nbsp;<span class="ident" id="8015059">TestTxStmt</span><span class="op" id="8015069">(</span><span class="ident" id="8015070">t</span>&nbsp;<span class="op" id="8015072">*</span><span class="ident" id="8015073">testing</span><span class="op" id="8015080">.</span><span class="ident" id="8015081">T</span><span class="op" id="8015082">)</span>&nbsp;<span class="op" id="8015084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8015087">db</span>&nbsp;<span class="op" id="8015090">:=</span>&nbsp;<span class="ident" id="8015093">newTestDB</span><span class="op" id="8015102">(</span><span class="ident" id="8015103">t</span><span class="op" id="8015104">,</span>&nbsp;<span class="string" id="8015106">&#34;&#34;</span><span class="op" id="8015108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8015111">defer</span>&nbsp;<span class="ident" id="8015117">closeDB</span><span class="op" id="8015124">(</span><span class="ident" id="8015125">t</span><span class="op" id="8015126">,</span>&nbsp;<span class="ident" id="8015128">db</span><span class="op" id="8015130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8015133">exec</span><span class="op" id="8015137">(</span><span class="ident" id="8015138">t</span><span class="op" id="8015139">,</span>&nbsp;<span class="ident" id="8015141">db</span><span class="op" id="8015143">,</span>&nbsp;<span class="string" id="8015145">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8015188">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8015191">stmt</span><span class="op" id="8015195">,</span>&nbsp;<span class="ident" id="8015197">err</span>&nbsp;<span class="op" id="8015201">:=</span>&nbsp;<span class="ident" id="8015204">db</span><span class="op" id="8015206">.</span><span class="ident" id="8015207">Prepare</span><span class="op" id="8015214">(</span><span class="string" id="8015215">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="8015239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8015242">if</span>&nbsp;<span class="ident" id="8015245">err</span>&nbsp;<span class="op" id="8015249">!=</span>&nbsp;<span class="builtintype" id="8015252">nil</span>&nbsp;<span class="op" id="8015256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8015260">t</span><span class="op" id="8015261">.</span><span class="ident" id="8015262">Fatalf</span><span class="op" id="8015268">(</span><span class="string" id="8015269">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="8015289">,</span>&nbsp;<span class="ident" id="8015291">stmt</span><span class="op" id="8015295">,</span>&nbsp;<span class="ident" id="8015297">err</span><span class="op" id="8015300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8015303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8015306">defer</span>&nbsp;<span class="ident" id="8015312">stmt</span><span class="op" id="8015316">.</span><span class="ident" id="8015317">Close</span><span class="op" id="8015322">(</span><span class="op" id="8015323">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8015326">tx</span><span class="op" id="8015328">,</span>&nbsp;<span class="ident" id="8015330">err</span>&nbsp;<span class="op" id="8015334">:=</span>&nbsp;<span class="ident" id="8015337">db</span><span class="op" id="8015339">.</span><span class="ident" id="8015340">Begin</span><span class="op" id="8015345">(</span><span class="op" id="8015346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8015349">if</span>&nbsp;<span class="ident" id="8015352">err</span>&nbsp;<span class="op" id="8015356">!=</span>&nbsp;<span class="builtintype" id="8015359">nil</span>&nbsp;<span class="op" id="8015363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8015367">t</span><span class="op" id="8015368">.</span><span class="ident" id="8015369">Fatalf</span><span class="op" id="8015375">(</span><span class="string" id="8015376">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8015388">,</span>&nbsp;<span class="ident" id="8015390">err</span><span class="op" id="8015393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8015396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8015399">txs</span>&nbsp;<span class="op" id="8015403">:=</span>&nbsp;<span class="ident" id="8015406">tx</span><span class="op" id="8015408">.</span><span class="ident" id="8015409">Stmt</span><span class="op" id="8015413">(</span><span class="ident" id="8015414">stmt</span><span class="op" id="8015418">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8015421">defer</span>&nbsp;<span class="ident" id="8015427">txs</span><span class="op" id="8015430">.</span><span class="ident" id="8015431">Close</span><span class="op" id="8015436">(</span><span class="op" id="8015437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8015440">_</span><span class="op" id="8015441">,</span>&nbsp;<span class="ident" id="8015443">err</span>&nbsp;<span class="op" id="8015447">=</span>&nbsp;<span class="ident" id="8015449">txs</span><span class="op" id="8015452">.</span><span class="ident" id="8015453">Exec</span><span class="op" id="8015457">(</span><span class="string" id="8015458">&#34;Bobby&#34;</span><span class="op" id="8015465">,</span>&nbsp;<span class="num" id="8015467">7</span><span class="op" id="8015468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8015471">if</span>&nbsp;<span class="ident" id="8015474">err</span>&nbsp;<span class="op" id="8015478">!=</span>&nbsp;<span class="builtintype" id="8015481">nil</span>&nbsp;<span class="op" id="8015485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8015489">t</span><span class="op" id="8015490">.</span><span class="ident" id="8015491">Fatalf</span><span class="op" id="8015497">(</span><span class="string" id="8015498">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8015509">,</span>&nbsp;<span class="ident" id="8015511">err</span><span class="op" id="8015514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8015517">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8015520">err</span>&nbsp;<span class="op" id="8015524">=</span>&nbsp;<span class="ident" id="8015526">tx</span><span class="op" id="8015528">.</span><span class="ident" id="8015529">Commit</span><span class="op" id="8015535">(</span><span class="op" id="8015536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8015539">if</span>&nbsp;<span class="ident" id="8015542">err</span>&nbsp;<span class="op" id="8015546">!=</span>&nbsp;<span class="builtintype" id="8015549">nil</span>&nbsp;<span class="op" id="8015553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8015557">t</span><span class="op" id="8015558">.</span><span class="ident" id="8015559">Fatalf</span><span class="op" id="8015565">(</span><span class="string" id="8015566">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8015579">,</span>&nbsp;<span class="ident" id="8015581">err</span><span class="op" id="8015584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8015587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8015590">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8015636">if</span>&nbsp;<span class="op" id="8015639">!</span><span class="ident" id="8015640">txs</span><span class="op" id="8015643">.</span><span class="ident" id="8015644">closed</span>&nbsp;<span class="op" id="8015651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8015655">t</span><span class="op" id="8015656">.</span><span class="ident" id="8015657">Fatal</span><span class="op" id="8015662">(</span><span class="string" id="8015663">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="8015693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8015696">}</span><br>
<span class="lineno"></span><span class="op" id="8015698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">500</span><span class="comment" id="8015701">//&nbsp;Issue:&nbsp;http://golang.org/issue/2784</span><br>
<span class="lineno"></span><span class="comment" id="8015740">//&nbsp;This&nbsp;test&nbsp;didn&#39;t&nbsp;fail&nbsp;before&nbsp;because&nbsp;we&nbsp;got&nbsp;lucky&nbsp;with&nbsp;the&nbsp;fakedb&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="8015817">//&nbsp;It&nbsp;was&nbsp;failing,&nbsp;and&nbsp;now&nbsp;not,&nbsp;in&nbsp;github.com/bradfitz/go-sql-test</span><br>
<span class="lineno"></span><span class="keyword" id="8015884">func</span>&nbsp;<span class="ident" id="8015889">TestTxQuery</span><span class="op" id="8015900">(</span><span class="ident" id="8015901">t</span>&nbsp;<span class="op" id="8015903">*</span><span class="ident" id="8015904">testing</span><span class="op" id="8015911">.</span><span class="ident" id="8015912">T</span><span class="op" id="8015913">)</span>&nbsp;<span class="op" id="8015915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8015918">db</span>&nbsp;<span class="op" id="8015921">:=</span>&nbsp;<span class="ident" id="8015924">newTestDB</span><span class="op" id="8015933">(</span><span class="ident" id="8015934">t</span><span class="op" id="8015935">,</span>&nbsp;<span class="string" id="8015937">&#34;&#34;</span><span class="op" id="8015939">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8015942">defer</span>&nbsp;<span class="ident" id="8015948">closeDB</span><span class="op" id="8015955">(</span><span class="ident" id="8015956">t</span><span class="op" id="8015957">,</span>&nbsp;<span class="ident" id="8015959">db</span><span class="op" id="8015961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8015964">exec</span><span class="op" id="8015968">(</span><span class="ident" id="8015969">t</span><span class="op" id="8015970">,</span>&nbsp;<span class="ident" id="8015972">db</span><span class="op" id="8015974">,</span>&nbsp;<span class="string" id="8015976">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8016019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8016022">exec</span><span class="op" id="8016026">(</span><span class="ident" id="8016027">t</span><span class="op" id="8016028">,</span>&nbsp;<span class="ident" id="8016030">db</span><span class="op" id="8016032">,</span>&nbsp;<span class="string" id="8016034">&#34;INSERT|t1|name=Alice&#34;</span><span class="op" id="8016056">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8016060">tx</span><span class="op" id="8016062">,</span>&nbsp;<span class="ident" id="8016064">err</span>&nbsp;<span class="op" id="8016068">:=</span>&nbsp;<span class="ident" id="8016071">db</span><span class="op" id="8016073">.</span><span class="ident" id="8016074">Begin</span><span class="op" id="8016079">(</span><span class="op" id="8016080">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8016083">if</span>&nbsp;<span class="ident" id="8016086">err</span>&nbsp;<span class="op" id="8016090">!=</span>&nbsp;<span class="builtintype" id="8016093">nil</span>&nbsp;<span class="op" id="8016097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8016101">t</span><span class="op" id="8016102">.</span><span class="ident" id="8016103">Fatal</span><span class="op" id="8016108">(</span><span class="ident" id="8016109">err</span><span class="op" id="8016112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8016115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8016118">defer</span>&nbsp;<span class="ident" id="8016124">tx</span><span class="op" id="8016126">.</span><span class="ident" id="8016127">Rollback</span><span class="op" id="8016135">(</span><span class="op" id="8016136">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8016140">r</span><span class="op" id="8016141">,</span>&nbsp;<span class="ident" id="8016143">err</span>&nbsp;<span class="op" id="8016147">:=</span>&nbsp;<span class="ident" id="8016150">tx</span><span class="op" id="8016152">.</span><span class="ident" id="8016153">Query</span><span class="op" id="8016158">(</span><span class="string" id="8016159">&#34;SELECT|t1|name|&#34;</span><span class="op" id="8016176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8016179">if</span>&nbsp;<span class="ident" id="8016182">err</span>&nbsp;<span class="op" id="8016186">!=</span>&nbsp;<span class="builtintype" id="8016189">nil</span>&nbsp;<span class="op" id="8016193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8016197">t</span><span class="op" id="8016198">.</span><span class="ident" id="8016199">Fatal</span><span class="op" id="8016204">(</span><span class="ident" id="8016205">err</span><span class="op" id="8016208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8016211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8016214">defer</span>&nbsp;<span class="ident" id="8016220">r</span><span class="op" id="8016221">.</span><span class="ident" id="8016222">Close</span><span class="op" id="8016227">(</span><span class="op" id="8016228">)</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8016232">if</span>&nbsp;<span class="op" id="8016235">!</span><span class="ident" id="8016236">r</span><span class="op" id="8016237">.</span><span class="ident" id="8016238">Next</span><span class="op" id="8016242">(</span><span class="op" id="8016243">)</span>&nbsp;<span class="op" id="8016245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8016249">if</span>&nbsp;<span class="ident" id="8016252">r</span><span class="op" id="8016253">.</span><span class="ident" id="8016254">Err</span><span class="op" id="8016257">(</span><span class="op" id="8016258">)</span>&nbsp;<span class="op" id="8016260">!=</span>&nbsp;<span class="builtintype" id="8016263">nil</span>&nbsp;<span class="op" id="8016267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8016272">t</span><span class="op" id="8016273">.</span><span class="ident" id="8016274">Fatal</span><span class="op" id="8016279">(</span><span class="ident" id="8016280">r</span><span class="op" id="8016281">.</span><span class="ident" id="8016282">Err</span><span class="op" id="8016285">(</span><span class="op" id="8016286">)</span><span class="op" id="8016287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8016291">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8016295">t</span><span class="op" id="8016296">.</span><span class="ident" id="8016297">Fatal</span><span class="op" id="8016302">(</span><span class="string" id="8016303">&#34;expected&nbsp;one&nbsp;row&#34;</span><span class="op" id="8016321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8016324">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8016328">var</span>&nbsp;<span class="ident" id="8016332">x</span>&nbsp;<span class="builtintype" id="8016334">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8016342">err</span>&nbsp;<span class="op" id="8016346">=</span>&nbsp;<span class="ident" id="8016348">r</span><span class="op" id="8016349">.</span><span class="ident" id="8016350">Scan</span><span class="op" id="8016354">(</span><span class="op" id="8016355">&amp;</span><span class="ident" id="8016356">x</span><span class="op" id="8016357">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8016360">if</span>&nbsp;<span class="ident" id="8016363">err</span>&nbsp;<span class="op" id="8016367">!=</span>&nbsp;<span class="builtintype" id="8016370">nil</span>&nbsp;<span class="op" id="8016374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8016378">t</span><span class="op" id="8016379">.</span><span class="ident" id="8016380">Fatal</span><span class="op" id="8016385">(</span><span class="ident" id="8016386">err</span><span class="op" id="8016389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8016392">}</span><br>
<span class="lineno"></span><span class="op" id="8016394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="8016397">func</span>&nbsp;<span class="ident" id="8016402">TestTxQueryInvalid</span><span class="op" id="8016420">(</span><span class="ident" id="8016421">t</span>&nbsp;<span class="op" id="8016423">*</span><span class="ident" id="8016424">testing</span><span class="op" id="8016431">.</span><span class="ident" id="8016432">T</span><span class="op" id="8016433">)</span>&nbsp;<span class="op" id="8016435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8016438">db</span>&nbsp;<span class="op" id="8016441">:=</span>&nbsp;<span class="ident" id="8016444">newTestDB</span><span class="op" id="8016453">(</span><span class="ident" id="8016454">t</span><span class="op" id="8016455">,</span>&nbsp;<span class="string" id="8016457">&#34;&#34;</span><span class="op" id="8016459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8016462">defer</span>&nbsp;<span class="ident" id="8016468">closeDB</span><span class="op" id="8016475">(</span><span class="ident" id="8016476">t</span><span class="op" id="8016477">,</span>&nbsp;<span class="ident" id="8016479">db</span><span class="op" id="8016481">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8016485">tx</span><span class="op" id="8016487">,</span>&nbsp;<span class="ident" id="8016489">err</span>&nbsp;<span class="op" id="8016493">:=</span>&nbsp;<span class="ident" id="8016496">db</span><span class="op" id="8016498">.</span><span class="ident" id="8016499">Begin</span><span class="op" id="8016504">(</span><span class="op" id="8016505">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8016508">if</span>&nbsp;<span class="ident" id="8016511">err</span>&nbsp;<span class="op" id="8016515">!=</span>&nbsp;<span class="builtintype" id="8016518">nil</span>&nbsp;<span class="op" id="8016522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8016526">t</span><span class="op" id="8016527">.</span><span class="ident" id="8016528">Fatal</span><span class="op" id="8016533">(</span><span class="ident" id="8016534">err</span><span class="op" id="8016537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8016540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8016543">defer</span>&nbsp;<span class="ident" id="8016549">tx</span><span class="op" id="8016551">.</span><span class="ident" id="8016552">Rollback</span><span class="op" id="8016560">(</span><span class="op" id="8016561">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8016565">_</span><span class="op" id="8016566">,</span>&nbsp;<span class="ident" id="8016568">err</span>&nbsp;<span class="op" id="8016572">=</span>&nbsp;<span class="ident" id="8016574">tx</span><span class="op" id="8016576">.</span><span class="ident" id="8016577">Query</span><span class="op" id="8016582">(</span><span class="string" id="8016583">&#34;SELECT|t1|name|&#34;</span><span class="op" id="8016600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8016603">if</span>&nbsp;<span class="ident" id="8016606">err</span>&nbsp;<span class="op" id="8016610">==</span>&nbsp;<span class="builtintype" id="8016613">nil</span>&nbsp;<span class="op" id="8016617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8016621">t</span><span class="op" id="8016622">.</span><span class="ident" id="8016623">Fatal</span><span class="op" id="8016628">(</span><span class="string" id="8016629">&#34;Error&nbsp;expected&#34;</span><span class="op" id="8016645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8016648">}</span><br>
<span class="lineno"></span><span class="op" id="8016650">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="8016653">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;4433,&nbsp;that&nbsp;retries&nbsp;in&nbsp;Begin&nbsp;happen&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="8016716">//&nbsp;conn.Begin()&nbsp;returns&nbsp;ErrBadConn</span><br>
<span class="lineno"></span><span class="keyword" id="8016751">func</span>&nbsp;<span class="ident" id="8016756">TestTxErrBadConn</span><span class="op" id="8016772">(</span><span class="ident" id="8016773">t</span>&nbsp;<span class="op" id="8016775">*</span><span class="ident" id="8016776">testing</span><span class="op" id="8016783">.</span><span class="ident" id="8016784">T</span><span class="op" id="8016785">)</span>&nbsp;<span class="op" id="8016787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8016790">db</span><span class="op" id="8016792">,</span>&nbsp;<span class="ident" id="8016794">err</span>&nbsp;<span class="op" id="8016798">:=</span>&nbsp;<span class="ident" id="8016801">Open</span><span class="op" id="8016805">(</span><span class="string" id="8016806">&#34;test&#34;</span><span class="op" id="8016812">,</span>&nbsp;<span class="ident" id="8016814">fakeDBName</span><span class="op" id="8016824">+</span><span class="string" id="8016825">&#34;;badConn&#34;</span><span class="op" id="8016835">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8016838">if</span>&nbsp;<span class="ident" id="8016841">err</span>&nbsp;<span class="op" id="8016845">!=</span>&nbsp;<span class="builtintype" id="8016848">nil</span>&nbsp;<span class="op" id="8016852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8016856">t</span><span class="op" id="8016857">.</span><span class="ident" id="8016858">Fatalf</span><span class="op" id="8016864">(</span><span class="string" id="8016865">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="8016875">,</span>&nbsp;<span class="ident" id="8016877">err</span><span class="op" id="8016880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8016883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8016886">if</span>&nbsp;<span class="ident" id="8016889">_</span><span class="op" id="8016890">,</span>&nbsp;<span class="ident" id="8016892">err</span>&nbsp;<span class="op" id="8016896">:=</span>&nbsp;<span class="ident" id="8016899">db</span><span class="op" id="8016901">.</span><span class="ident" id="8016902">Exec</span><span class="op" id="8016906">(</span><span class="string" id="8016907">&#34;WIPE&#34;</span><span class="op" id="8016913">)</span><span class="op" id="8016914">;</span>&nbsp;<span class="ident" id="8016916">err</span>&nbsp;<span class="op" id="8016920">!=</span>&nbsp;<span class="builtintype" id="8016923">nil</span>&nbsp;<span class="op" id="8016927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8016931">t</span><span class="op" id="8016932">.</span><span class="ident" id="8016933">Fatalf</span><span class="op" id="8016939">(</span><span class="string" id="8016940">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="8016955">,</span>&nbsp;<span class="ident" id="8016957">err</span><span class="op" id="8016960">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8016963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8016966">defer</span>&nbsp;<span class="ident" id="8016972">closeDB</span><span class="op" id="8016979">(</span><span class="ident" id="8016980">t</span><span class="op" id="8016981">,</span>&nbsp;<span class="ident" id="8016983">db</span><span class="op" id="8016985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8016988">exec</span><span class="op" id="8016992">(</span><span class="ident" id="8016993">t</span><span class="op" id="8016994">,</span>&nbsp;<span class="ident" id="8016996">db</span><span class="op" id="8016998">,</span>&nbsp;<span class="string" id="8017000">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8017043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8017046">stmt</span><span class="op" id="8017050">,</span>&nbsp;<span class="ident" id="8017052">err</span>&nbsp;<span class="op" id="8017056">:=</span>&nbsp;<span class="ident" id="8017059">db</span><span class="op" id="8017061">.</span><span class="ident" id="8017062">Prepare</span><span class="op" id="8017069">(</span><span class="string" id="8017070">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="8017094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8017097">if</span>&nbsp;<span class="ident" id="8017100">err</span>&nbsp;<span class="op" id="8017104">!=</span>&nbsp;<span class="builtintype" id="8017107">nil</span>&nbsp;<span class="op" id="8017111">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8017115">t</span><span class="op" id="8017116">.</span><span class="ident" id="8017117">Fatalf</span><span class="op" id="8017123">(</span><span class="string" id="8017124">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="8017144">,</span>&nbsp;<span class="ident" id="8017146">stmt</span><span class="op" id="8017150">,</span>&nbsp;<span class="ident" id="8017152">err</span><span class="op" id="8017155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8017158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8017161">defer</span>&nbsp;<span class="ident" id="8017167">stmt</span><span class="op" id="8017171">.</span><span class="ident" id="8017172">Close</span><span class="op" id="8017177">(</span><span class="op" id="8017178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8017181">tx</span><span class="op" id="8017183">,</span>&nbsp;<span class="ident" id="8017185">err</span>&nbsp;<span class="op" id="8017189">:=</span>&nbsp;<span class="ident" id="8017192">db</span><span class="op" id="8017194">.</span><span class="ident" id="8017195">Begin</span><span class="op" id="8017200">(</span><span class="op" id="8017201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8017204">if</span>&nbsp;<span class="ident" id="8017207">err</span>&nbsp;<span class="op" id="8017211">!=</span>&nbsp;<span class="builtintype" id="8017214">nil</span>&nbsp;<span class="op" id="8017218">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8017222">t</span><span class="op" id="8017223">.</span><span class="ident" id="8017224">Fatalf</span><span class="op" id="8017230">(</span><span class="string" id="8017231">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8017243">,</span>&nbsp;<span class="ident" id="8017245">err</span><span class="op" id="8017248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8017251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8017254">txs</span>&nbsp;<span class="op" id="8017258">:=</span>&nbsp;<span class="ident" id="8017261">tx</span><span class="op" id="8017263">.</span><span class="ident" id="8017264">Stmt</span><span class="op" id="8017268">(</span><span class="ident" id="8017269">stmt</span><span class="op" id="8017273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8017276">defer</span>&nbsp;<span class="ident" id="8017282">txs</span><span class="op" id="8017285">.</span><span class="ident" id="8017286">Close</span><span class="op" id="8017291">(</span><span class="op" id="8017292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8017295">_</span><span class="op" id="8017296">,</span>&nbsp;<span class="ident" id="8017298">err</span>&nbsp;<span class="op" id="8017302">=</span>&nbsp;<span class="ident" id="8017304">txs</span><span class="op" id="8017307">.</span><span class="ident" id="8017308">Exec</span><span class="op" id="8017312">(</span><span class="string" id="8017313">&#34;Bobby&#34;</span><span class="op" id="8017320">,</span>&nbsp;<span class="num" id="8017322">7</span><span class="op" id="8017323">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8017326">if</span>&nbsp;<span class="ident" id="8017329">err</span>&nbsp;<span class="op" id="8017333">!=</span>&nbsp;<span class="builtintype" id="8017336">nil</span>&nbsp;<span class="op" id="8017340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8017344">t</span><span class="op" id="8017345">.</span><span class="ident" id="8017346">Fatalf</span><span class="op" id="8017352">(</span><span class="string" id="8017353">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8017364">,</span>&nbsp;<span class="ident" id="8017366">err</span><span class="op" id="8017369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8017372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8017375">err</span>&nbsp;<span class="op" id="8017379">=</span>&nbsp;<span class="ident" id="8017381">tx</span><span class="op" id="8017383">.</span><span class="ident" id="8017384">Commit</span><span class="op" id="8017390">(</span><span class="op" id="8017391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8017394">if</span>&nbsp;<span class="ident" id="8017397">err</span>&nbsp;<span class="op" id="8017401">!=</span>&nbsp;<span class="builtintype" id="8017404">nil</span>&nbsp;<span class="op" id="8017408">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8017412">t</span><span class="op" id="8017413">.</span><span class="ident" id="8017414">Fatalf</span><span class="op" id="8017420">(</span><span class="string" id="8017421">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8017434">,</span>&nbsp;<span class="ident" id="8017436">err</span><span class="op" id="8017439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8017442">}</span><br>
<span class="lineno"></span><span class="op" id="8017444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8017447">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2542,&nbsp;that&nbsp;we&nbsp;release&nbsp;a&nbsp;lock&nbsp;when&nbsp;querying&nbsp;on</span><br>
<span class="lineno">585</span><span class="comment" id="8017516">//&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="8017540">func</span>&nbsp;<span class="ident" id="8017545">TestIssue2542Deadlock</span><span class="op" id="8017566">(</span><span class="ident" id="8017567">t</span>&nbsp;<span class="op" id="8017569">*</span><span class="ident" id="8017570">testing</span><span class="op" id="8017577">.</span><span class="ident" id="8017578">T</span><span class="op" id="8017579">)</span>&nbsp;<span class="op" id="8017581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8017584">db</span>&nbsp;<span class="op" id="8017587">:=</span>&nbsp;<span class="ident" id="8017590">newTestDB</span><span class="op" id="8017599">(</span><span class="ident" id="8017600">t</span><span class="op" id="8017601">,</span>&nbsp;<span class="string" id="8017603">&#34;people&#34;</span><span class="op" id="8017611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8017614">closeDB</span><span class="op" id="8017621">(</span><span class="ident" id="8017622">t</span><span class="op" id="8017623">,</span>&nbsp;<span class="ident" id="8017625">db</span><span class="op" id="8017627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8017630">for</span>&nbsp;<span class="ident" id="8017634">i</span>&nbsp;<span class="op" id="8017636">:=</span>&nbsp;<span class="num" id="8017639">0</span><span class="op" id="8017640">;</span>&nbsp;<span class="ident" id="8017642">i</span>&nbsp;<span class="op" id="8017644">&lt;</span>&nbsp;<span class="num" id="8017646">2</span><span class="op" id="8017647">;</span>&nbsp;<span class="ident" id="8017649">i</span><span class="op" id="8017650">++</span>&nbsp;<span class="op" id="8017653">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8017657">_</span><span class="op" id="8017658">,</span>&nbsp;<span class="ident" id="8017660">err</span>&nbsp;<span class="op" id="8017664">:=</span>&nbsp;<span class="ident" id="8017667">db</span><span class="op" id="8017669">.</span><span class="ident" id="8017670">Query</span><span class="op" id="8017675">(</span><span class="string" id="8017676">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="8017701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8017705">if</span>&nbsp;<span class="ident" id="8017708">err</span>&nbsp;<span class="op" id="8017712">==</span>&nbsp;<span class="builtintype" id="8017715">nil</span>&nbsp;<span class="op" id="8017719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8017724">t</span><span class="op" id="8017725">.</span><span class="ident" id="8017726">Fatalf</span><span class="op" id="8017732">(</span><span class="string" id="8017733">&#34;expected&nbsp;error&#34;</span><span class="op" id="8017749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8017753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8017756">}</span><br>
<span class="lineno">595</span><span class="op" id="8017758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8017761">//&nbsp;From&nbsp;golang.org/issue/3865</span><br>
<span class="lineno"></span><span class="keyword" id="8017791">func</span>&nbsp;<span class="ident" id="8017796">TestCloseStmtBeforeRows</span><span class="op" id="8017819">(</span><span class="ident" id="8017820">t</span>&nbsp;<span class="op" id="8017822">*</span><span class="ident" id="8017823">testing</span><span class="op" id="8017830">.</span><span class="ident" id="8017831">T</span><span class="op" id="8017832">)</span>&nbsp;<span class="op" id="8017834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8017837">db</span>&nbsp;<span class="op" id="8017840">:=</span>&nbsp;<span class="ident" id="8017843">newTestDB</span><span class="op" id="8017852">(</span><span class="ident" id="8017853">t</span><span class="op" id="8017854">,</span>&nbsp;<span class="string" id="8017856">&#34;people&#34;</span><span class="op" id="8017864">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8017867">defer</span>&nbsp;<span class="ident" id="8017873">closeDB</span><span class="op" id="8017880">(</span><span class="ident" id="8017881">t</span><span class="op" id="8017882">,</span>&nbsp;<span class="ident" id="8017884">db</span><span class="op" id="8017886">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8017890">s</span><span class="op" id="8017891">,</span>&nbsp;<span class="ident" id="8017893">err</span>&nbsp;<span class="op" id="8017897">:=</span>&nbsp;<span class="ident" id="8017900">db</span><span class="op" id="8017902">.</span><span class="ident" id="8017903">Prepare</span><span class="op" id="8017910">(</span><span class="string" id="8017911">&#34;SELECT|people|name|&#34;</span><span class="op" id="8017932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8017935">if</span>&nbsp;<span class="ident" id="8017938">err</span>&nbsp;<span class="op" id="8017942">!=</span>&nbsp;<span class="builtintype" id="8017945">nil</span>&nbsp;<span class="op" id="8017949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8017953">t</span><span class="op" id="8017954">.</span><span class="ident" id="8017955">Fatal</span><span class="op" id="8017960">(</span><span class="ident" id="8017961">err</span><span class="op" id="8017964">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8017967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8017971">r</span><span class="op" id="8017972">,</span>&nbsp;<span class="ident" id="8017974">err</span>&nbsp;<span class="op" id="8017978">:=</span>&nbsp;<span class="ident" id="8017981">s</span><span class="op" id="8017982">.</span><span class="ident" id="8017983">Query</span><span class="op" id="8017988">(</span><span class="op" id="8017989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8017992">if</span>&nbsp;<span class="ident" id="8017995">err</span>&nbsp;<span class="op" id="8017999">!=</span>&nbsp;<span class="builtintype" id="8018002">nil</span>&nbsp;<span class="op" id="8018006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8018010">s</span><span class="op" id="8018011">.</span><span class="ident" id="8018012">Close</span><span class="op" id="8018017">(</span><span class="op" id="8018018">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8018022">t</span><span class="op" id="8018023">.</span><span class="ident" id="8018024">Fatal</span><span class="op" id="8018029">(</span><span class="ident" id="8018030">err</span><span class="op" id="8018033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8018036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8018040">err</span>&nbsp;<span class="op" id="8018044">=</span>&nbsp;<span class="ident" id="8018046">s</span><span class="op" id="8018047">.</span><span class="ident" id="8018048">Close</span><span class="op" id="8018053">(</span><span class="op" id="8018054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8018057">if</span>&nbsp;<span class="ident" id="8018060">err</span>&nbsp;<span class="op" id="8018064">!=</span>&nbsp;<span class="builtintype" id="8018067">nil</span>&nbsp;<span class="op" id="8018071">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8018075">t</span><span class="op" id="8018076">.</span><span class="ident" id="8018077">Fatal</span><span class="op" id="8018082">(</span><span class="ident" id="8018083">err</span><span class="op" id="8018086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8018089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8018093">r</span><span class="op" id="8018094">.</span><span class="ident" id="8018095">Close</span><span class="op" id="8018100">(</span><span class="op" id="8018101">)</span><br>
<span class="lineno"></span><span class="op" id="8018103">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="comment" id="8018106">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2788,&nbsp;that&nbsp;we&nbsp;bind&nbsp;nil&nbsp;to&nbsp;a&nbsp;[]byte&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="8018171">//&nbsp;value&nbsp;in&nbsp;the&nbsp;column&nbsp;is&nbsp;sql&nbsp;null</span><br>
<span class="lineno"></span><span class="keyword" id="8018206">func</span>&nbsp;<span class="ident" id="8018211">TestNullByteSlice</span><span class="op" id="8018228">(</span><span class="ident" id="8018229">t</span>&nbsp;<span class="op" id="8018231">*</span><span class="ident" id="8018232">testing</span><span class="op" id="8018239">.</span><span class="ident" id="8018240">T</span><span class="op" id="8018241">)</span>&nbsp;<span class="op" id="8018243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8018246">db</span>&nbsp;<span class="op" id="8018249">:=</span>&nbsp;<span class="ident" id="8018252">newTestDB</span><span class="op" id="8018261">(</span><span class="ident" id="8018262">t</span><span class="op" id="8018263">,</span>&nbsp;<span class="string" id="8018265">&#34;&#34;</span><span class="op" id="8018267">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8018270">defer</span>&nbsp;<span class="ident" id="8018276">closeDB</span><span class="op" id="8018283">(</span><span class="ident" id="8018284">t</span><span class="op" id="8018285">,</span>&nbsp;<span class="ident" id="8018287">db</span><span class="op" id="8018289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8018292">exec</span><span class="op" id="8018296">(</span><span class="ident" id="8018297">t</span><span class="op" id="8018298">,</span>&nbsp;<span class="ident" id="8018300">db</span><span class="op" id="8018302">,</span>&nbsp;<span class="string" id="8018304">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="8018339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8018342">exec</span><span class="op" id="8018346">(</span><span class="ident" id="8018347">t</span><span class="op" id="8018348">,</span>&nbsp;<span class="ident" id="8018350">db</span><span class="op" id="8018352">,</span>&nbsp;<span class="string" id="8018354">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="8018377">,</span>&nbsp;<span class="builtintype" id="8018379">nil</span><span class="op" id="8018382">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8018386">var</span>&nbsp;<span class="ident" id="8018390">name</span>&nbsp;<span class="op" id="8018395">[</span><span class="op" id="8018396">]</span><span class="builtintype" id="8018397">byte</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8018404">err</span>&nbsp;<span class="op" id="8018408">:=</span>&nbsp;<span class="ident" id="8018411">db</span><span class="op" id="8018413">.</span><span class="ident" id="8018414">QueryRow</span><span class="op" id="8018422">(</span><span class="string" id="8018423">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="8018443">,</span>&nbsp;<span class="num" id="8018445">10</span><span class="op" id="8018447">)</span><span class="op" id="8018448">.</span><span class="ident" id="8018449">Scan</span><span class="op" id="8018453">(</span><span class="op" id="8018454">&amp;</span><span class="ident" id="8018455">name</span><span class="op" id="8018459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8018462">if</span>&nbsp;<span class="ident" id="8018465">err</span>&nbsp;<span class="op" id="8018469">!=</span>&nbsp;<span class="builtintype" id="8018472">nil</span>&nbsp;<span class="op" id="8018476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8018480">t</span><span class="op" id="8018481">.</span><span class="ident" id="8018482">Fatal</span><span class="op" id="8018487">(</span><span class="ident" id="8018488">err</span><span class="op" id="8018491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8018494">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8018497">if</span>&nbsp;<span class="ident" id="8018500">name</span>&nbsp;<span class="op" id="8018505">!=</span>&nbsp;<span class="builtintype" id="8018508">nil</span>&nbsp;<span class="op" id="8018512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8018516">t</span><span class="op" id="8018517">.</span><span class="ident" id="8018518">Fatalf</span><span class="op" id="8018524">(</span><span class="string" id="8018525">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;nil&nbsp;for&nbsp;null&nbsp;column&nbsp;value,&nbsp;got:&nbsp;%#v&#34;</span><span class="op" id="8018584">,</span>&nbsp;<span class="ident" id="8018586">name</span><span class="op" id="8018590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8018593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8018597">exec</span><span class="op" id="8018601">(</span><span class="ident" id="8018602">t</span><span class="op" id="8018603">,</span>&nbsp;<span class="ident" id="8018605">db</span><span class="op" id="8018607">,</span>&nbsp;<span class="string" id="8018609">&#34;INSERT|t|id=11,name=?&#34;</span><span class="op" id="8018632">,</span>&nbsp;<span class="string" id="8018634">&#34;bob&#34;</span><span class="op" id="8018639">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8018642">err</span>&nbsp;<span class="op" id="8018646">=</span>&nbsp;<span class="ident" id="8018648">db</span><span class="op" id="8018650">.</span><span class="ident" id="8018651">QueryRow</span><span class="op" id="8018659">(</span><span class="string" id="8018660">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="8018680">,</span>&nbsp;<span class="num" id="8018682">11</span><span class="op" id="8018684">)</span><span class="op" id="8018685">.</span><span class="ident" id="8018686">Scan</span><span class="op" id="8018690">(</span><span class="op" id="8018691">&amp;</span><span class="ident" id="8018692">name</span><span class="op" id="8018696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8018699">if</span>&nbsp;<span class="ident" id="8018702">err</span>&nbsp;<span class="op" id="8018706">!=</span>&nbsp;<span class="builtintype" id="8018709">nil</span>&nbsp;<span class="op" id="8018713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8018717">t</span><span class="op" id="8018718">.</span><span class="ident" id="8018719">Fatal</span><span class="op" id="8018724">(</span><span class="ident" id="8018725">err</span><span class="op" id="8018728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8018731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8018734">if</span>&nbsp;<span class="builtintype" id="8018737">string</span><span class="op" id="8018743">(</span><span class="ident" id="8018744">name</span><span class="op" id="8018748">)</span>&nbsp;<span class="op" id="8018750">!=</span>&nbsp;<span class="string" id="8018753">&#34;bob&#34;</span>&nbsp;<span class="op" id="8018759">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8018763">t</span><span class="op" id="8018764">.</span><span class="ident" id="8018765">Fatalf</span><span class="op" id="8018771">(</span><span class="string" id="8018772">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;bob,&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="8018808">,</span>&nbsp;<span class="builtintype" id="8018810">string</span><span class="op" id="8018816">(</span><span class="ident" id="8018817">name</span><span class="op" id="8018821">)</span><span class="op" id="8018822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8018825">}</span><br>
<span class="lineno"></span><span class="op" id="8018827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8018830">func</span>&nbsp;<span class="ident" id="8018835">TestPointerParamsAndScans</span><span class="op" id="8018860">(</span><span class="ident" id="8018861">t</span>&nbsp;<span class="op" id="8018863">*</span><span class="ident" id="8018864">testing</span><span class="op" id="8018871">.</span><span class="ident" id="8018872">T</span><span class="op" id="8018873">)</span>&nbsp;<span class="op" id="8018875">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8018878">db</span>&nbsp;<span class="op" id="8018881">:=</span>&nbsp;<span class="ident" id="8018884">newTestDB</span><span class="op" id="8018893">(</span><span class="ident" id="8018894">t</span><span class="op" id="8018895">,</span>&nbsp;<span class="string" id="8018897">&#34;&#34;</span><span class="op" id="8018899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8018902">defer</span>&nbsp;<span class="ident" id="8018908">closeDB</span><span class="op" id="8018915">(</span><span class="ident" id="8018916">t</span><span class="op" id="8018917">,</span>&nbsp;<span class="ident" id="8018919">db</span><span class="op" id="8018921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8018924">exec</span><span class="op" id="8018928">(</span><span class="ident" id="8018929">t</span><span class="op" id="8018930">,</span>&nbsp;<span class="ident" id="8018932">db</span><span class="op" id="8018934">,</span>&nbsp;<span class="string" id="8018936">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="8018971">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8018975">bob</span>&nbsp;<span class="op" id="8018979">:=</span>&nbsp;<span class="string" id="8018982">&#34;bob&#34;</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8018989">var</span>&nbsp;<span class="ident" id="8018993">name</span>&nbsp;<span class="op" id="8018998">*</span><span class="builtintype" id="8018999">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8019008">name</span>&nbsp;<span class="op" id="8019013">=</span>&nbsp;<span class="op" id="8019015">&amp;</span><span class="ident" id="8019016">bob</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8019021">exec</span><span class="op" id="8019025">(</span><span class="ident" id="8019026">t</span><span class="op" id="8019027">,</span>&nbsp;<span class="ident" id="8019029">db</span><span class="op" id="8019031">,</span>&nbsp;<span class="string" id="8019033">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="8019056">,</span>&nbsp;<span class="ident" id="8019058">name</span><span class="op" id="8019062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8019065">name</span>&nbsp;<span class="op" id="8019070">=</span>&nbsp;<span class="builtintype" id="8019072">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8019077">exec</span><span class="op" id="8019081">(</span><span class="ident" id="8019082">t</span><span class="op" id="8019083">,</span>&nbsp;<span class="ident" id="8019085">db</span><span class="op" id="8019087">,</span>&nbsp;<span class="string" id="8019089">&#34;INSERT|t|id=20,name=?&#34;</span><span class="op" id="8019112">,</span>&nbsp;<span class="ident" id="8019114">name</span><span class="op" id="8019118">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8019122">err</span>&nbsp;<span class="op" id="8019126">:=</span>&nbsp;<span class="ident" id="8019129">db</span><span class="op" id="8019131">.</span><span class="ident" id="8019132">QueryRow</span><span class="op" id="8019140">(</span><span class="string" id="8019141">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="8019161">,</span>&nbsp;<span class="num" id="8019163">10</span><span class="op" id="8019165">)</span><span class="op" id="8019166">.</span><span class="ident" id="8019167">Scan</span><span class="op" id="8019171">(</span><span class="op" id="8019172">&amp;</span><span class="ident" id="8019173">name</span><span class="op" id="8019177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8019180">if</span>&nbsp;<span class="ident" id="8019183">err</span>&nbsp;<span class="op" id="8019187">!=</span>&nbsp;<span class="builtintype" id="8019190">nil</span>&nbsp;<span class="op" id="8019194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8019198">t</span><span class="op" id="8019199">.</span><span class="ident" id="8019200">Fatalf</span><span class="op" id="8019206">(</span><span class="string" id="8019207">&#34;querying&nbsp;id&nbsp;10:&nbsp;%v&#34;</span><span class="op" id="8019227">,</span>&nbsp;<span class="ident" id="8019229">err</span><span class="op" id="8019232">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8019235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8019238">if</span>&nbsp;<span class="ident" id="8019241">name</span>&nbsp;<span class="op" id="8019246">==</span>&nbsp;<span class="builtintype" id="8019249">nil</span>&nbsp;<span class="op" id="8019253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8019257">t</span><span class="op" id="8019258">.</span><span class="ident" id="8019259">Errorf</span><span class="op" id="8019265">(</span><span class="string" id="8019266">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;nil;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="8019296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8019299">}</span>&nbsp;<span class="keyword" id="8019301">else</span>&nbsp;<span class="keyword" id="8019306">if</span>&nbsp;<span class="op" id="8019309">*</span><span class="ident" id="8019310">name</span>&nbsp;<span class="op" id="8019315">!=</span>&nbsp;<span class="string" id="8019318">&#34;bob&#34;</span>&nbsp;<span class="op" id="8019324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8019328">t</span><span class="op" id="8019329">.</span><span class="ident" id="8019330">Errorf</span><span class="op" id="8019336">(</span><span class="string" id="8019337">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="8019366">,</span>&nbsp;<span class="op" id="8019368">*</span><span class="ident" id="8019369">name</span><span class="op" id="8019373">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8019376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8019380">err</span>&nbsp;<span class="op" id="8019384">=</span>&nbsp;<span class="ident" id="8019386">db</span><span class="op" id="8019388">.</span><span class="ident" id="8019389">QueryRow</span><span class="op" id="8019397">(</span><span class="string" id="8019398">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="8019418">,</span>&nbsp;<span class="num" id="8019420">20</span><span class="op" id="8019422">)</span><span class="op" id="8019423">.</span><span class="ident" id="8019424">Scan</span><span class="op" id="8019428">(</span><span class="op" id="8019429">&amp;</span><span class="ident" id="8019430">name</span><span class="op" id="8019434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8019437">if</span>&nbsp;<span class="ident" id="8019440">err</span>&nbsp;<span class="op" id="8019444">!=</span>&nbsp;<span class="builtintype" id="8019447">nil</span>&nbsp;<span class="op" id="8019451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8019455">t</span><span class="op" id="8019456">.</span><span class="ident" id="8019457">Fatalf</span><span class="op" id="8019463">(</span><span class="string" id="8019464">&#34;querying&nbsp;id&nbsp;20:&nbsp;%v&#34;</span><span class="op" id="8019484">,</span>&nbsp;<span class="ident" id="8019486">err</span><span class="op" id="8019489">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8019492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8019495">if</span>&nbsp;<span class="ident" id="8019498">name</span>&nbsp;<span class="op" id="8019503">!=</span>&nbsp;<span class="builtintype" id="8019506">nil</span>&nbsp;<span class="op" id="8019510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8019514">t</span><span class="op" id="8019515">.</span><span class="ident" id="8019516">Errorf</span><span class="op" id="8019522">(</span><span class="string" id="8019523">&#34;id&nbsp;20&nbsp;=&nbsp;%q;&nbsp;want&nbsp;nil&#34;</span><span class="op" id="8019545">,</span>&nbsp;<span class="op" id="8019547">*</span><span class="ident" id="8019548">name</span><span class="op" id="8019552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8019555">}</span><br>
<span class="lineno"></span><span class="op" id="8019557">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="8019560">func</span>&nbsp;<span class="ident" id="8019565">TestQueryRowClosingStmt</span><span class="op" id="8019588">(</span><span class="ident" id="8019589">t</span>&nbsp;<span class="op" id="8019591">*</span><span class="ident" id="8019592">testing</span><span class="op" id="8019599">.</span><span class="ident" id="8019600">T</span><span class="op" id="8019601">)</span>&nbsp;<span class="op" id="8019603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8019606">db</span>&nbsp;<span class="op" id="8019609">:=</span>&nbsp;<span class="ident" id="8019612">newTestDB</span><span class="op" id="8019621">(</span><span class="ident" id="8019622">t</span><span class="op" id="8019623">,</span>&nbsp;<span class="string" id="8019625">&#34;people&#34;</span><span class="op" id="8019633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8019636">defer</span>&nbsp;<span class="ident" id="8019642">closeDB</span><span class="op" id="8019649">(</span><span class="ident" id="8019650">t</span><span class="op" id="8019651">,</span>&nbsp;<span class="ident" id="8019653">db</span><span class="op" id="8019655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8019658">var</span>&nbsp;<span class="ident" id="8019662">name</span>&nbsp;<span class="builtintype" id="8019667">string</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8019675">var</span>&nbsp;<span class="ident" id="8019679">age</span>&nbsp;<span class="builtintype" id="8019683">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8019688">err</span>&nbsp;<span class="op" id="8019692">:=</span>&nbsp;<span class="ident" id="8019695">db</span><span class="op" id="8019697">.</span><span class="ident" id="8019698">QueryRow</span><span class="op" id="8019706">(</span><span class="string" id="8019707">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="8019737">,</span>&nbsp;<span class="num" id="8019739">3</span><span class="op" id="8019740">)</span><span class="op" id="8019741">.</span><span class="ident" id="8019742">Scan</span><span class="op" id="8019746">(</span><span class="op" id="8019747">&amp;</span><span class="ident" id="8019748">age</span><span class="op" id="8019751">,</span>&nbsp;<span class="op" id="8019753">&amp;</span><span class="ident" id="8019754">name</span><span class="op" id="8019758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8019761">if</span>&nbsp;<span class="ident" id="8019764">err</span>&nbsp;<span class="op" id="8019768">!=</span>&nbsp;<span class="builtintype" id="8019771">nil</span>&nbsp;<span class="op" id="8019775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8019779">t</span><span class="op" id="8019780">.</span><span class="ident" id="8019781">Fatal</span><span class="op" id="8019786">(</span><span class="ident" id="8019787">err</span><span class="op" id="8019790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8019793">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8019796">if</span>&nbsp;<span class="builtinfunc" id="8019799">len</span><span class="op" id="8019802">(</span><span class="ident" id="8019803">db</span><span class="op" id="8019805">.</span><span class="ident" id="8019806">freeConn</span><span class="op" id="8019814">)</span>&nbsp;<span class="op" id="8019816">!=</span>&nbsp;<span class="num" id="8019819">1</span>&nbsp;<span class="op" id="8019821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8019825">t</span><span class="op" id="8019826">.</span><span class="ident" id="8019827">Fatalf</span><span class="op" id="8019833">(</span><span class="string" id="8019834">&#34;expected&nbsp;1&nbsp;free&nbsp;conn&#34;</span><span class="op" id="8019856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8019859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8019862">fakeConn</span>&nbsp;<span class="op" id="8019871">:=</span>&nbsp;<span class="ident" id="8019874">db</span><span class="op" id="8019876">.</span><span class="ident" id="8019877">freeConn</span><span class="op" id="8019885">[</span><span class="num" id="8019886">0</span><span class="op" id="8019887">]</span><span class="op" id="8019888">.</span><span class="ident" id="8019889">ci</span><span class="op" id="8019891">.</span><span class="op" id="8019892">(</span><span class="op" id="8019893">*</span><span class="ident" id="8019894">fakeConn</span><span class="op" id="8019902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8019905">if</span>&nbsp;<span class="ident" id="8019908">made</span><span class="op" id="8019912">,</span>&nbsp;<span class="ident" id="8019914">closed</span>&nbsp;<span class="op" id="8019921">:=</span>&nbsp;<span class="ident" id="8019924">fakeConn</span><span class="op" id="8019932">.</span><span class="ident" id="8019933">stmtsMade</span><span class="op" id="8019942">,</span>&nbsp;<span class="ident" id="8019944">fakeConn</span><span class="op" id="8019952">.</span><span class="ident" id="8019953">stmtsClosed</span><span class="op" id="8019964">;</span>&nbsp;<span class="ident" id="8019966">made</span>&nbsp;<span class="op" id="8019971">!=</span>&nbsp;<span class="ident" id="8019974">closed</span>&nbsp;<span class="op" id="8019981">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8019985">t</span><span class="op" id="8019986">.</span><span class="ident" id="8019987">Errorf</span><span class="op" id="8019993">(</span><span class="string" id="8019994">&#34;statement&nbsp;close&nbsp;mismatch:&nbsp;made&nbsp;%d,&nbsp;closed&nbsp;%d&#34;</span><span class="op" id="8020040">,</span>&nbsp;<span class="ident" id="8020042">made</span><span class="op" id="8020046">,</span>&nbsp;<span class="ident" id="8020048">closed</span><span class="op" id="8020054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8020057">}</span><br>
<span class="lineno"></span><span class="op" id="8020059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8020062">//&nbsp;Test&nbsp;issue&nbsp;6651</span><br>
<span class="lineno">700</span><span class="keyword" id="8020081">func</span>&nbsp;<span class="ident" id="8020086">TestIssue6651</span><span class="op" id="8020099">(</span><span class="ident" id="8020100">t</span>&nbsp;<span class="op" id="8020102">*</span><span class="ident" id="8020103">testing</span><span class="op" id="8020110">.</span><span class="ident" id="8020111">T</span><span class="op" id="8020112">)</span>&nbsp;<span class="op" id="8020114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8020117">db</span>&nbsp;<span class="op" id="8020120">:=</span>&nbsp;<span class="ident" id="8020123">newTestDB</span><span class="op" id="8020132">(</span><span class="ident" id="8020133">t</span><span class="op" id="8020134">,</span>&nbsp;<span class="string" id="8020136">&#34;people&#34;</span><span class="op" id="8020144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8020147">defer</span>&nbsp;<span class="ident" id="8020153">closeDB</span><span class="op" id="8020160">(</span><span class="ident" id="8020161">t</span><span class="op" id="8020162">,</span>&nbsp;<span class="ident" id="8020164">db</span><span class="op" id="8020166">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8020170">var</span>&nbsp;<span class="ident" id="8020174">v</span>&nbsp;<span class="builtintype" id="8020176">string</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8020185">want</span>&nbsp;<span class="op" id="8020190">:=</span>&nbsp;<span class="string" id="8020193">&#34;error&nbsp;in&nbsp;rows.Next&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8020215">rowsCursorNextHook</span>&nbsp;<span class="op" id="8020234">=</span>&nbsp;<span class="keyword" id="8020236">func</span><span class="op" id="8020240">(</span><span class="ident" id="8020241">dest</span>&nbsp;<span class="op" id="8020246">[</span><span class="op" id="8020247">]</span><span class="ident" id="8020248">driver</span><span class="op" id="8020254">.</span><span class="ident" id="8020255">Value</span><span class="op" id="8020260">)</span>&nbsp;<span class="builtintype" id="8020262">error</span>&nbsp;<span class="op" id="8020268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8020272">return</span>&nbsp;<span class="ident" id="8020279">fmt</span><span class="op" id="8020282">.</span><span class="ident" id="8020283">Errorf</span><span class="op" id="8020289">(</span><span class="ident" id="8020290">want</span><span class="op" id="8020294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8020297">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8020300">defer</span>&nbsp;<span class="keyword" id="8020306">func</span><span class="op" id="8020310">(</span><span class="op" id="8020311">)</span>&nbsp;<span class="op" id="8020313">{</span>&nbsp;<span class="ident" id="8020315">rowsCursorNextHook</span>&nbsp;<span class="op" id="8020334">=</span>&nbsp;<span class="builtintype" id="8020336">nil</span>&nbsp;<span class="op" id="8020340">}</span><span class="op" id="8020341">(</span><span class="op" id="8020342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8020345">err</span>&nbsp;<span class="op" id="8020349">:=</span>&nbsp;<span class="ident" id="8020352">db</span><span class="op" id="8020354">.</span><span class="ident" id="8020355">QueryRow</span><span class="op" id="8020363">(</span><span class="string" id="8020364">&#34;SELECT|people|name|&#34;</span><span class="op" id="8020385">)</span><span class="op" id="8020386">.</span><span class="ident" id="8020387">Scan</span><span class="op" id="8020391">(</span><span class="op" id="8020392">&amp;</span><span class="ident" id="8020393">v</span><span class="op" id="8020394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8020397">if</span>&nbsp;<span class="ident" id="8020400">err</span>&nbsp;<span class="op" id="8020404">==</span>&nbsp;<span class="builtintype" id="8020407">nil</span>&nbsp;<span class="op" id="8020411">||</span>&nbsp;<span class="ident" id="8020414">err</span><span class="op" id="8020417">.</span><span class="ident" id="8020418">Error</span><span class="op" id="8020423">(</span><span class="op" id="8020424">)</span>&nbsp;<span class="op" id="8020426">!=</span>&nbsp;<span class="ident" id="8020429">want</span>&nbsp;<span class="op" id="8020434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8020438">t</span><span class="op" id="8020439">.</span><span class="ident" id="8020440">Errorf</span><span class="op" id="8020446">(</span><span class="string" id="8020447">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8020468">,</span>&nbsp;<span class="ident" id="8020470">err</span><span class="op" id="8020473">,</span>&nbsp;<span class="ident" id="8020475">want</span><span class="op" id="8020479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8020482">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8020485">rowsCursorNextHook</span>&nbsp;<span class="op" id="8020504">=</span>&nbsp;<span class="builtintype" id="8020506">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8020512">want</span>&nbsp;<span class="op" id="8020517">=</span>&nbsp;<span class="string" id="8020519">&#34;error&nbsp;in&nbsp;rows.Close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8020542">rowsCloseHook</span>&nbsp;<span class="op" id="8020556">=</span>&nbsp;<span class="keyword" id="8020558">func</span><span class="op" id="8020562">(</span><span class="ident" id="8020563">rows</span>&nbsp;<span class="op" id="8020568">*</span><span class="ident" id="8020569">Rows</span><span class="op" id="8020573">,</span>&nbsp;<span class="ident" id="8020575">err</span>&nbsp;<span class="op" id="8020579">*</span><span class="builtintype" id="8020580">error</span><span class="op" id="8020585">)</span>&nbsp;<span class="op" id="8020587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8020591">*</span><span class="ident" id="8020592">err</span>&nbsp;<span class="op" id="8020596">=</span>&nbsp;<span class="ident" id="8020598">fmt</span><span class="op" id="8020601">.</span><span class="ident" id="8020602">Errorf</span><span class="op" id="8020608">(</span><span class="ident" id="8020609">want</span><span class="op" id="8020613">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8020616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8020619">defer</span>&nbsp;<span class="keyword" id="8020625">func</span><span class="op" id="8020629">(</span><span class="op" id="8020630">)</span>&nbsp;<span class="op" id="8020632">{</span>&nbsp;<span class="ident" id="8020634">rowsCloseHook</span>&nbsp;<span class="op" id="8020648">=</span>&nbsp;<span class="builtintype" id="8020650">nil</span>&nbsp;<span class="op" id="8020654">}</span><span class="op" id="8020655">(</span><span class="op" id="8020656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8020659">err</span>&nbsp;<span class="op" id="8020663">=</span>&nbsp;<span class="ident" id="8020665">db</span><span class="op" id="8020667">.</span><span class="ident" id="8020668">QueryRow</span><span class="op" id="8020676">(</span><span class="string" id="8020677">&#34;SELECT|people|name|&#34;</span><span class="op" id="8020698">)</span><span class="op" id="8020699">.</span><span class="ident" id="8020700">Scan</span><span class="op" id="8020704">(</span><span class="op" id="8020705">&amp;</span><span class="ident" id="8020706">v</span><span class="op" id="8020707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8020710">if</span>&nbsp;<span class="ident" id="8020713">err</span>&nbsp;<span class="op" id="8020717">==</span>&nbsp;<span class="builtintype" id="8020720">nil</span>&nbsp;<span class="op" id="8020724">||</span>&nbsp;<span class="ident" id="8020727">err</span><span class="op" id="8020730">.</span><span class="ident" id="8020731">Error</span><span class="op" id="8020736">(</span><span class="op" id="8020737">)</span>&nbsp;<span class="op" id="8020739">!=</span>&nbsp;<span class="ident" id="8020742">want</span>&nbsp;<span class="op" id="8020747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8020751">t</span><span class="op" id="8020752">.</span><span class="ident" id="8020753">Errorf</span><span class="op" id="8020759">(</span><span class="string" id="8020760">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8020781">,</span>&nbsp;<span class="ident" id="8020783">err</span><span class="op" id="8020786">,</span>&nbsp;<span class="ident" id="8020788">want</span><span class="op" id="8020792">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8020795">}</span><br>
<span class="lineno"></span><span class="op" id="8020797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8020800">type</span>&nbsp;<span class="ident" id="8020805">nullTestRow</span>&nbsp;<span class="keyword" id="8020817">struct</span>&nbsp;<span class="op" id="8020824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8020827">nullParam</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8020840">interface</span><span class="op" id="8020849">{</span><span class="op" id="8020850">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8020853">notNullParam</span>&nbsp;<span class="keyword" id="8020866">interface</span><span class="op" id="8020875">{</span><span class="op" id="8020876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8020879">scanNullVal</span>&nbsp;&nbsp;<span class="keyword" id="8020892">interface</span><span class="op" id="8020901">{</span><span class="op" id="8020902">}</span><br>
<span class="lineno"></span><span class="op" id="8020904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8020907">type</span>&nbsp;<span class="ident" id="8020912">nullTestSpec</span>&nbsp;<span class="keyword" id="8020925">struct</span>&nbsp;<span class="op" id="8020932">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8020935">nullType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8020947">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8020955">notNullType</span>&nbsp;<span class="builtintype" id="8020967">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8020975">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8020987">[</span><span class="num" id="8020988">6</span><span class="op" id="8020989">]</span><span class="ident" id="8020990">nullTestRow</span><br>
<span class="lineno"></span><span class="op" id="8021002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">740</span><span class="keyword" id="8021005">func</span>&nbsp;<span class="ident" id="8021010">TestNullStringParam</span><span class="op" id="8021029">(</span><span class="ident" id="8021030">t</span>&nbsp;<span class="op" id="8021032">*</span><span class="ident" id="8021033">testing</span><span class="op" id="8021040">.</span><span class="ident" id="8021041">T</span><span class="op" id="8021042">)</span>&nbsp;<span class="op" id="8021044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8021047">spec</span>&nbsp;<span class="op" id="8021052">:=</span>&nbsp;<span class="ident" id="8021055">nullTestSpec</span><span class="op" id="8021067">{</span><span class="string" id="8021068">&#34;nullstring&#34;</span><span class="op" id="8021080">,</span>&nbsp;<span class="string" id="8021082">&#34;string&#34;</span><span class="op" id="8021090">,</span>&nbsp;<span class="op" id="8021092">[</span><span class="num" id="8021093">6</span><span class="op" id="8021094">]</span><span class="ident" id="8021095">nullTestRow</span><span class="op" id="8021106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8021110">{</span><span class="ident" id="8021111">NullString</span><span class="op" id="8021121">{</span><span class="string" id="8021122">&#34;aqua&#34;</span><span class="op" id="8021128">,</span>&nbsp;<span class="builtintype" id="8021130">true</span><span class="op" id="8021134">}</span><span class="op" id="8021135">,</span>&nbsp;<span class="string" id="8021137">&#34;&#34;</span><span class="op" id="8021139">,</span>&nbsp;<span class="ident" id="8021141">NullString</span><span class="op" id="8021151">{</span><span class="string" id="8021152">&#34;aqua&#34;</span><span class="op" id="8021158">,</span>&nbsp;<span class="builtintype" id="8021160">true</span><span class="op" id="8021164">}</span><span class="op" id="8021165">}</span><span class="op" id="8021166">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8021170">{</span><span class="ident" id="8021171">NullString</span><span class="op" id="8021181">{</span><span class="string" id="8021182">&#34;brown&#34;</span><span class="op" id="8021189">,</span>&nbsp;<span class="builtintype" id="8021191">false</span><span class="op" id="8021196">}</span><span class="op" id="8021197">,</span>&nbsp;<span class="string" id="8021199">&#34;&#34;</span><span class="op" id="8021201">,</span>&nbsp;<span class="ident" id="8021203">NullString</span><span class="op" id="8021213">{</span><span class="string" id="8021214">&#34;&#34;</span><span class="op" id="8021216">,</span>&nbsp;<span class="builtintype" id="8021218">false</span><span class="op" id="8021223">}</span><span class="op" id="8021224">}</span><span class="op" id="8021225">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8021229">{</span><span class="string" id="8021230">&#34;chartreuse&#34;</span><span class="op" id="8021242">,</span>&nbsp;<span class="string" id="8021244">&#34;&#34;</span><span class="op" id="8021246">,</span>&nbsp;<span class="ident" id="8021248">NullString</span><span class="op" id="8021258">{</span><span class="string" id="8021259">&#34;chartreuse&#34;</span><span class="op" id="8021271">,</span>&nbsp;<span class="builtintype" id="8021273">true</span><span class="op" id="8021277">}</span><span class="op" id="8021278">}</span><span class="op" id="8021279">,</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8021283">{</span><span class="ident" id="8021284">NullString</span><span class="op" id="8021294">{</span><span class="string" id="8021295">&#34;darkred&#34;</span><span class="op" id="8021304">,</span>&nbsp;<span class="builtintype" id="8021306">true</span><span class="op" id="8021310">}</span><span class="op" id="8021311">,</span>&nbsp;<span class="string" id="8021313">&#34;&#34;</span><span class="op" id="8021315">,</span>&nbsp;<span class="ident" id="8021317">NullString</span><span class="op" id="8021327">{</span><span class="string" id="8021328">&#34;darkred&#34;</span><span class="op" id="8021337">,</span>&nbsp;<span class="builtintype" id="8021339">true</span><span class="op" id="8021343">}</span><span class="op" id="8021344">}</span><span class="op" id="8021345">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8021349">{</span><span class="ident" id="8021350">NullString</span><span class="op" id="8021360">{</span><span class="string" id="8021361">&#34;eel&#34;</span><span class="op" id="8021366">,</span>&nbsp;<span class="builtintype" id="8021368">false</span><span class="op" id="8021373">}</span><span class="op" id="8021374">,</span>&nbsp;<span class="string" id="8021376">&#34;&#34;</span><span class="op" id="8021378">,</span>&nbsp;<span class="ident" id="8021380">NullString</span><span class="op" id="8021390">{</span><span class="string" id="8021391">&#34;&#34;</span><span class="op" id="8021393">,</span>&nbsp;<span class="builtintype" id="8021395">false</span><span class="op" id="8021400">}</span><span class="op" id="8021401">}</span><span class="op" id="8021402">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8021406">{</span><span class="string" id="8021407">&#34;foo&#34;</span><span class="op" id="8021412">,</span>&nbsp;<span class="ident" id="8021414">NullString</span><span class="op" id="8021424">{</span><span class="string" id="8021425">&#34;black&#34;</span><span class="op" id="8021432">,</span>&nbsp;<span class="builtintype" id="8021434">false</span><span class="op" id="8021439">}</span><span class="op" id="8021440">,</span>&nbsp;<span class="builtintype" id="8021442">nil</span><span class="op" id="8021445">}</span><span class="op" id="8021446">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8021449">}</span><span class="op" id="8021450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8021453">nullTestRun</span><span class="op" id="8021464">(</span><span class="ident" id="8021465">t</span><span class="op" id="8021466">,</span>&nbsp;<span class="ident" id="8021468">spec</span><span class="op" id="8021472">)</span><br>
<span class="lineno">750</span><span class="op" id="8021474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8021477">func</span>&nbsp;<span class="ident" id="8021482">TestNullInt64Param</span><span class="op" id="8021500">(</span><span class="ident" id="8021501">t</span>&nbsp;<span class="op" id="8021503">*</span><span class="ident" id="8021504">testing</span><span class="op" id="8021511">.</span><span class="ident" id="8021512">T</span><span class="op" id="8021513">)</span>&nbsp;<span class="op" id="8021515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8021518">spec</span>&nbsp;<span class="op" id="8021523">:=</span>&nbsp;<span class="ident" id="8021526">nullTestSpec</span><span class="op" id="8021538">{</span><span class="string" id="8021539">&#34;nullint64&#34;</span><span class="op" id="8021550">,</span>&nbsp;<span class="string" id="8021552">&#34;int64&#34;</span><span class="op" id="8021559">,</span>&nbsp;<span class="op" id="8021561">[</span><span class="num" id="8021562">6</span><span class="op" id="8021563">]</span><span class="ident" id="8021564">nullTestRow</span><span class="op" id="8021575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8021579">{</span><span class="ident" id="8021580">NullInt64</span><span class="op" id="8021589">{</span><span class="num" id="8021590">31</span><span class="op" id="8021592">,</span>&nbsp;<span class="builtintype" id="8021594">true</span><span class="op" id="8021598">}</span><span class="op" id="8021599">,</span>&nbsp;<span class="num" id="8021601">1</span><span class="op" id="8021602">,</span>&nbsp;<span class="ident" id="8021604">NullInt64</span><span class="op" id="8021613">{</span><span class="num" id="8021614">31</span><span class="op" id="8021616">,</span>&nbsp;<span class="builtintype" id="8021618">true</span><span class="op" id="8021622">}</span><span class="op" id="8021623">}</span><span class="op" id="8021624">,</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8021628">{</span><span class="ident" id="8021629">NullInt64</span><span class="op" id="8021638">{</span><span class="op" id="8021639">-</span><span class="num" id="8021640">22</span><span class="op" id="8021642">,</span>&nbsp;<span class="builtintype" id="8021644">false</span><span class="op" id="8021649">}</span><span class="op" id="8021650">,</span>&nbsp;<span class="num" id="8021652">1</span><span class="op" id="8021653">,</span>&nbsp;<span class="ident" id="8021655">NullInt64</span><span class="op" id="8021664">{</span><span class="num" id="8021665">0</span><span class="op" id="8021666">,</span>&nbsp;<span class="builtintype" id="8021668">false</span><span class="op" id="8021673">}</span><span class="op" id="8021674">}</span><span class="op" id="8021675">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8021679">{</span><span class="num" id="8021680">22</span><span class="op" id="8021682">,</span>&nbsp;<span class="num" id="8021684">1</span><span class="op" id="8021685">,</span>&nbsp;<span class="ident" id="8021687">NullInt64</span><span class="op" id="8021696">{</span><span class="num" id="8021697">22</span><span class="op" id="8021699">,</span>&nbsp;<span class="builtintype" id="8021701">true</span><span class="op" id="8021705">}</span><span class="op" id="8021706">}</span><span class="op" id="8021707">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8021711">{</span><span class="ident" id="8021712">NullInt64</span><span class="op" id="8021721">{</span><span class="num" id="8021722">33</span><span class="op" id="8021724">,</span>&nbsp;<span class="builtintype" id="8021726">true</span><span class="op" id="8021730">}</span><span class="op" id="8021731">,</span>&nbsp;<span class="num" id="8021733">1</span><span class="op" id="8021734">,</span>&nbsp;<span class="ident" id="8021736">NullInt64</span><span class="op" id="8021745">{</span><span class="num" id="8021746">33</span><span class="op" id="8021748">,</span>&nbsp;<span class="builtintype" id="8021750">true</span><span class="op" id="8021754">}</span><span class="op" id="8021755">}</span><span class="op" id="8021756">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8021760">{</span><span class="ident" id="8021761">NullInt64</span><span class="op" id="8021770">{</span><span class="num" id="8021771">222</span><span class="op" id="8021774">,</span>&nbsp;<span class="builtintype" id="8021776">false</span><span class="op" id="8021781">}</span><span class="op" id="8021782">,</span>&nbsp;<span class="num" id="8021784">1</span><span class="op" id="8021785">,</span>&nbsp;<span class="ident" id="8021787">NullInt64</span><span class="op" id="8021796">{</span><span class="num" id="8021797">0</span><span class="op" id="8021798">,</span>&nbsp;<span class="builtintype" id="8021800">false</span><span class="op" id="8021805">}</span><span class="op" id="8021806">}</span><span class="op" id="8021807">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8021811">{</span><span class="num" id="8021812">0</span><span class="op" id="8021813">,</span>&nbsp;<span class="ident" id="8021815">NullInt64</span><span class="op" id="8021824">{</span><span class="num" id="8021825">31</span><span class="op" id="8021827">,</span>&nbsp;<span class="builtintype" id="8021829">false</span><span class="op" id="8021834">}</span><span class="op" id="8021835">,</span>&nbsp;<span class="builtintype" id="8021837">nil</span><span class="op" id="8021840">}</span><span class="op" id="8021841">,</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8021844">}</span><span class="op" id="8021845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8021848">nullTestRun</span><span class="op" id="8021859">(</span><span class="ident" id="8021860">t</span><span class="op" id="8021861">,</span>&nbsp;<span class="ident" id="8021863">spec</span><span class="op" id="8021867">)</span><br>
<span class="lineno"></span><span class="op" id="8021869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8021872">func</span>&nbsp;<span class="ident" id="8021877">TestNullFloat64Param</span><span class="op" id="8021897">(</span><span class="ident" id="8021898">t</span>&nbsp;<span class="op" id="8021900">*</span><span class="ident" id="8021901">testing</span><span class="op" id="8021908">.</span><span class="ident" id="8021909">T</span><span class="op" id="8021910">)</span>&nbsp;<span class="op" id="8021912">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8021915">spec</span>&nbsp;<span class="op" id="8021920">:=</span>&nbsp;<span class="ident" id="8021923">nullTestSpec</span><span class="op" id="8021935">{</span><span class="string" id="8021936">&#34;nullfloat64&#34;</span><span class="op" id="8021949">,</span>&nbsp;<span class="string" id="8021951">&#34;float64&#34;</span><span class="op" id="8021960">,</span>&nbsp;<span class="op" id="8021962">[</span><span class="num" id="8021963">6</span><span class="op" id="8021964">]</span><span class="ident" id="8021965">nullTestRow</span><span class="op" id="8021976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8021980">{</span><span class="ident" id="8021981">NullFloat64</span><span class="op" id="8021992">{</span><span class="num" id="8021993">31.2</span><span class="op" id="8021997">,</span>&nbsp;<span class="builtintype" id="8021999">true</span><span class="op" id="8022003">}</span><span class="op" id="8022004">,</span>&nbsp;<span class="num" id="8022006">1</span><span class="op" id="8022007">,</span>&nbsp;<span class="ident" id="8022009">NullFloat64</span><span class="op" id="8022020">{</span><span class="num" id="8022021">31.2</span><span class="op" id="8022025">,</span>&nbsp;<span class="builtintype" id="8022027">true</span><span class="op" id="8022031">}</span><span class="op" id="8022032">}</span><span class="op" id="8022033">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8022037">{</span><span class="ident" id="8022038">NullFloat64</span><span class="op" id="8022049">{</span><span class="num" id="8022050">13.1</span><span class="op" id="8022054">,</span>&nbsp;<span class="builtintype" id="8022056">false</span><span class="op" id="8022061">}</span><span class="op" id="8022062">,</span>&nbsp;<span class="num" id="8022064">1</span><span class="op" id="8022065">,</span>&nbsp;<span class="ident" id="8022067">NullFloat64</span><span class="op" id="8022078">{</span><span class="num" id="8022079">0</span><span class="op" id="8022080">,</span>&nbsp;<span class="builtintype" id="8022082">false</span><span class="op" id="8022087">}</span><span class="op" id="8022088">}</span><span class="op" id="8022089">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8022093">{</span><span class="op" id="8022094">-</span><span class="num" id="8022095">22.9</span><span class="op" id="8022099">,</span>&nbsp;<span class="num" id="8022101">1</span><span class="op" id="8022102">,</span>&nbsp;<span class="ident" id="8022104">NullFloat64</span><span class="op" id="8022115">{</span><span class="op" id="8022116">-</span><span class="num" id="8022117">22.9</span><span class="op" id="8022121">,</span>&nbsp;<span class="builtintype" id="8022123">true</span><span class="op" id="8022127">}</span><span class="op" id="8022128">}</span><span class="op" id="8022129">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8022133">{</span><span class="ident" id="8022134">NullFloat64</span><span class="op" id="8022145">{</span><span class="num" id="8022146">33.81</span><span class="op" id="8022151">,</span>&nbsp;<span class="builtintype" id="8022153">true</span><span class="op" id="8022157">}</span><span class="op" id="8022158">,</span>&nbsp;<span class="num" id="8022160">1</span><span class="op" id="8022161">,</span>&nbsp;<span class="ident" id="8022163">NullFloat64</span><span class="op" id="8022174">{</span><span class="num" id="8022175">33.81</span><span class="op" id="8022180">,</span>&nbsp;<span class="builtintype" id="8022182">true</span><span class="op" id="8022186">}</span><span class="op" id="8022187">}</span><span class="op" id="8022188">,</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8022192">{</span><span class="ident" id="8022193">NullFloat64</span><span class="op" id="8022204">{</span><span class="num" id="8022205">222</span><span class="op" id="8022208">,</span>&nbsp;<span class="builtintype" id="8022210">false</span><span class="op" id="8022215">}</span><span class="op" id="8022216">,</span>&nbsp;<span class="num" id="8022218">1</span><span class="op" id="8022219">,</span>&nbsp;<span class="ident" id="8022221">NullFloat64</span><span class="op" id="8022232">{</span><span class="num" id="8022233">0</span><span class="op" id="8022234">,</span>&nbsp;<span class="builtintype" id="8022236">false</span><span class="op" id="8022241">}</span><span class="op" id="8022242">}</span><span class="op" id="8022243">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8022247">{</span><span class="num" id="8022248">10</span><span class="op" id="8022250">,</span>&nbsp;<span class="ident" id="8022252">NullFloat64</span><span class="op" id="8022263">{</span><span class="num" id="8022264">31.2</span><span class="op" id="8022268">,</span>&nbsp;<span class="builtintype" id="8022270">false</span><span class="op" id="8022275">}</span><span class="op" id="8022276">,</span>&nbsp;<span class="builtintype" id="8022278">nil</span><span class="op" id="8022281">}</span><span class="op" id="8022282">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8022285">}</span><span class="op" id="8022286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8022289">nullTestRun</span><span class="op" id="8022300">(</span><span class="ident" id="8022301">t</span><span class="op" id="8022302">,</span>&nbsp;<span class="ident" id="8022304">spec</span><span class="op" id="8022308">)</span><br>
<span class="lineno"></span><span class="op" id="8022310">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="keyword" id="8022313">func</span>&nbsp;<span class="ident" id="8022318">TestNullBoolParam</span><span class="op" id="8022335">(</span><span class="ident" id="8022336">t</span>&nbsp;<span class="op" id="8022338">*</span><span class="ident" id="8022339">testing</span><span class="op" id="8022346">.</span><span class="ident" id="8022347">T</span><span class="op" id="8022348">)</span>&nbsp;<span class="op" id="8022350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8022353">spec</span>&nbsp;<span class="op" id="8022358">:=</span>&nbsp;<span class="ident" id="8022361">nullTestSpec</span><span class="op" id="8022373">{</span><span class="string" id="8022374">&#34;nullbool&#34;</span><span class="op" id="8022384">,</span>&nbsp;<span class="string" id="8022386">&#34;bool&#34;</span><span class="op" id="8022392">,</span>&nbsp;<span class="op" id="8022394">[</span><span class="num" id="8022395">6</span><span class="op" id="8022396">]</span><span class="ident" id="8022397">nullTestRow</span><span class="op" id="8022408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8022412">{</span><span class="ident" id="8022413">NullBool</span><span class="op" id="8022421">{</span><span class="builtintype" id="8022422">false</span><span class="op" id="8022427">,</span>&nbsp;<span class="builtintype" id="8022429">true</span><span class="op" id="8022433">}</span><span class="op" id="8022434">,</span>&nbsp;<span class="builtintype" id="8022436">true</span><span class="op" id="8022440">,</span>&nbsp;<span class="ident" id="8022442">NullBool</span><span class="op" id="8022450">{</span><span class="builtintype" id="8022451">false</span><span class="op" id="8022456">,</span>&nbsp;<span class="builtintype" id="8022458">true</span><span class="op" id="8022462">}</span><span class="op" id="8022463">}</span><span class="op" id="8022464">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8022468">{</span><span class="ident" id="8022469">NullBool</span><span class="op" id="8022477">{</span><span class="builtintype" id="8022478">true</span><span class="op" id="8022482">,</span>&nbsp;<span class="builtintype" id="8022484">false</span><span class="op" id="8022489">}</span><span class="op" id="8022490">,</span>&nbsp;<span class="builtintype" id="8022492">false</span><span class="op" id="8022497">,</span>&nbsp;<span class="ident" id="8022499">NullBool</span><span class="op" id="8022507">{</span><span class="builtintype" id="8022508">false</span><span class="op" id="8022513">,</span>&nbsp;<span class="builtintype" id="8022515">false</span><span class="op" id="8022520">}</span><span class="op" id="8022521">}</span><span class="op" id="8022522">,</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8022526">{</span><span class="builtintype" id="8022527">true</span><span class="op" id="8022531">,</span>&nbsp;<span class="builtintype" id="8022533">true</span><span class="op" id="8022537">,</span>&nbsp;<span class="ident" id="8022539">NullBool</span><span class="op" id="8022547">{</span><span class="builtintype" id="8022548">true</span><span class="op" id="8022552">,</span>&nbsp;<span class="builtintype" id="8022554">true</span><span class="op" id="8022558">}</span><span class="op" id="8022559">}</span><span class="op" id="8022560">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8022564">{</span><span class="ident" id="8022565">NullBool</span><span class="op" id="8022573">{</span><span class="builtintype" id="8022574">true</span><span class="op" id="8022578">,</span>&nbsp;<span class="builtintype" id="8022580">true</span><span class="op" id="8022584">}</span><span class="op" id="8022585">,</span>&nbsp;<span class="builtintype" id="8022587">false</span><span class="op" id="8022592">,</span>&nbsp;<span class="ident" id="8022594">NullBool</span><span class="op" id="8022602">{</span><span class="builtintype" id="8022603">true</span><span class="op" id="8022607">,</span>&nbsp;<span class="builtintype" id="8022609">true</span><span class="op" id="8022613">}</span><span class="op" id="8022614">}</span><span class="op" id="8022615">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8022619">{</span><span class="ident" id="8022620">NullBool</span><span class="op" id="8022628">{</span><span class="builtintype" id="8022629">true</span><span class="op" id="8022633">,</span>&nbsp;<span class="builtintype" id="8022635">false</span><span class="op" id="8022640">}</span><span class="op" id="8022641">,</span>&nbsp;<span class="builtintype" id="8022643">true</span><span class="op" id="8022647">,</span>&nbsp;<span class="ident" id="8022649">NullBool</span><span class="op" id="8022657">{</span><span class="builtintype" id="8022658">false</span><span class="op" id="8022663">,</span>&nbsp;<span class="builtintype" id="8022665">false</span><span class="op" id="8022670">}</span><span class="op" id="8022671">}</span><span class="op" id="8022672">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8022676">{</span><span class="builtintype" id="8022677">true</span><span class="op" id="8022681">,</span>&nbsp;<span class="ident" id="8022683">NullBool</span><span class="op" id="8022691">{</span><span class="builtintype" id="8022692">true</span><span class="op" id="8022696">,</span>&nbsp;<span class="builtintype" id="8022698">false</span><span class="op" id="8022703">}</span><span class="op" id="8022704">,</span>&nbsp;<span class="builtintype" id="8022706">nil</span><span class="op" id="8022709">}</span><span class="op" id="8022710">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8022713">}</span><span class="op" id="8022714">}</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8022717">nullTestRun</span><span class="op" id="8022728">(</span><span class="ident" id="8022729">t</span><span class="op" id="8022730">,</span>&nbsp;<span class="ident" id="8022732">spec</span><span class="op" id="8022736">)</span><br>
<span class="lineno"></span><span class="op" id="8022738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8022741">func</span>&nbsp;<span class="ident" id="8022746">nullTestRun</span><span class="op" id="8022757">(</span><span class="ident" id="8022758">t</span>&nbsp;<span class="op" id="8022760">*</span><span class="ident" id="8022761">testing</span><span class="op" id="8022768">.</span><span class="ident" id="8022769">T</span><span class="op" id="8022770">,</span>&nbsp;<span class="ident" id="8022772">spec</span>&nbsp;<span class="ident" id="8022777">nullTestSpec</span><span class="op" id="8022789">)</span>&nbsp;<span class="op" id="8022791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8022794">db</span>&nbsp;<span class="op" id="8022797">:=</span>&nbsp;<span class="ident" id="8022800">newTestDB</span><span class="op" id="8022809">(</span><span class="ident" id="8022810">t</span><span class="op" id="8022811">,</span>&nbsp;<span class="string" id="8022813">&#34;&#34;</span><span class="op" id="8022815">)</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8022818">defer</span>&nbsp;<span class="ident" id="8022824">closeDB</span><span class="op" id="8022831">(</span><span class="ident" id="8022832">t</span><span class="op" id="8022833">,</span>&nbsp;<span class="ident" id="8022835">db</span><span class="op" id="8022837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8022840">exec</span><span class="op" id="8022844">(</span><span class="ident" id="8022845">t</span><span class="op" id="8022846">,</span>&nbsp;<span class="ident" id="8022848">db</span><span class="op" id="8022850">,</span>&nbsp;<span class="ident" id="8022852">fmt</span><span class="op" id="8022855">.</span><span class="ident" id="8022856">Sprintf</span><span class="op" id="8022863">(</span><span class="string" id="8022864">&#34;CREATE|t|id=int32,name=string,nullf=%s,notnullf=%s&#34;</span><span class="op" id="8022916">,</span>&nbsp;<span class="ident" id="8022918">spec</span><span class="op" id="8022922">.</span><span class="ident" id="8022923">nullType</span><span class="op" id="8022931">,</span>&nbsp;<span class="ident" id="8022933">spec</span><span class="op" id="8022937">.</span><span class="ident" id="8022938">notNullType</span><span class="op" id="8022949">)</span><span class="op" id="8022950">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8022954">//&nbsp;Inserts&nbsp;with&nbsp;db.Exec:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8022980">exec</span><span class="op" id="8022984">(</span><span class="ident" id="8022985">t</span><span class="op" id="8022986">,</span>&nbsp;<span class="ident" id="8022988">db</span><span class="op" id="8022990">,</span>&nbsp;<span class="string" id="8022992">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="8023033">,</span>&nbsp;<span class="num" id="8023035">1</span><span class="op" id="8023036">,</span>&nbsp;<span class="string" id="8023038">&#34;alice&#34;</span><span class="op" id="8023045">,</span>&nbsp;<span class="ident" id="8023047">spec</span><span class="op" id="8023051">.</span><span class="ident" id="8023052">rows</span><span class="op" id="8023056">[</span><span class="num" id="8023057">0</span><span class="op" id="8023058">]</span><span class="op" id="8023059">.</span><span class="ident" id="8023060">nullParam</span><span class="op" id="8023069">,</span>&nbsp;<span class="ident" id="8023071">spec</span><span class="op" id="8023075">.</span><span class="ident" id="8023076">rows</span><span class="op" id="8023080">[</span><span class="num" id="8023081">0</span><span class="op" id="8023082">]</span><span class="op" id="8023083">.</span><span class="ident" id="8023084">notNullParam</span><span class="op" id="8023096">)</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8023099">exec</span><span class="op" id="8023103">(</span><span class="ident" id="8023104">t</span><span class="op" id="8023105">,</span>&nbsp;<span class="ident" id="8023107">db</span><span class="op" id="8023109">,</span>&nbsp;<span class="string" id="8023111">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="8023152">,</span>&nbsp;<span class="num" id="8023154">2</span><span class="op" id="8023155">,</span>&nbsp;<span class="string" id="8023157">&#34;bob&#34;</span><span class="op" id="8023162">,</span>&nbsp;<span class="ident" id="8023164">spec</span><span class="op" id="8023168">.</span><span class="ident" id="8023169">rows</span><span class="op" id="8023173">[</span><span class="num" id="8023174">1</span><span class="op" id="8023175">]</span><span class="op" id="8023176">.</span><span class="ident" id="8023177">nullParam</span><span class="op" id="8023186">,</span>&nbsp;<span class="ident" id="8023188">spec</span><span class="op" id="8023192">.</span><span class="ident" id="8023193">rows</span><span class="op" id="8023197">[</span><span class="num" id="8023198">1</span><span class="op" id="8023199">]</span><span class="op" id="8023200">.</span><span class="ident" id="8023201">notNullParam</span><span class="op" id="8023213">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8023217">//&nbsp;Inserts&nbsp;with&nbsp;a&nbsp;prepared&nbsp;statement:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8023256">stmt</span><span class="op" id="8023260">,</span>&nbsp;<span class="ident" id="8023262">err</span>&nbsp;<span class="op" id="8023266">:=</span>&nbsp;<span class="ident" id="8023269">db</span><span class="op" id="8023271">.</span><span class="ident" id="8023272">Prepare</span><span class="op" id="8023279">(</span><span class="string" id="8023280">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="8023321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8023324">if</span>&nbsp;<span class="ident" id="8023327">err</span>&nbsp;<span class="op" id="8023331">!=</span>&nbsp;<span class="builtintype" id="8023334">nil</span>&nbsp;<span class="op" id="8023338">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8023342">t</span><span class="op" id="8023343">.</span><span class="ident" id="8023344">Fatalf</span><span class="op" id="8023350">(</span><span class="string" id="8023351">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="8023364">,</span>&nbsp;<span class="ident" id="8023366">err</span><span class="op" id="8023369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8023372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8023375">defer</span>&nbsp;<span class="ident" id="8023381">stmt</span><span class="op" id="8023385">.</span><span class="ident" id="8023386">Close</span><span class="op" id="8023391">(</span><span class="op" id="8023392">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8023395">if</span>&nbsp;<span class="ident" id="8023398">_</span><span class="op" id="8023399">,</span>&nbsp;<span class="ident" id="8023401">err</span>&nbsp;<span class="op" id="8023405">:=</span>&nbsp;<span class="ident" id="8023408">stmt</span><span class="op" id="8023412">.</span><span class="ident" id="8023413">Exec</span><span class="op" id="8023417">(</span><span class="num" id="8023418">3</span><span class="op" id="8023419">,</span>&nbsp;<span class="string" id="8023421">&#34;chris&#34;</span><span class="op" id="8023428">,</span>&nbsp;<span class="ident" id="8023430">spec</span><span class="op" id="8023434">.</span><span class="ident" id="8023435">rows</span><span class="op" id="8023439">[</span><span class="num" id="8023440">2</span><span class="op" id="8023441">]</span><span class="op" id="8023442">.</span><span class="ident" id="8023443">nullParam</span><span class="op" id="8023452">,</span>&nbsp;<span class="ident" id="8023454">spec</span><span class="op" id="8023458">.</span><span class="ident" id="8023459">rows</span><span class="op" id="8023463">[</span><span class="num" id="8023464">2</span><span class="op" id="8023465">]</span><span class="op" id="8023466">.</span><span class="ident" id="8023467">notNullParam</span><span class="op" id="8023479">)</span><span class="op" id="8023480">;</span>&nbsp;<span class="ident" id="8023482">err</span>&nbsp;<span class="op" id="8023486">!=</span>&nbsp;<span class="builtintype" id="8023489">nil</span>&nbsp;<span class="op" id="8023493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8023497">t</span><span class="op" id="8023498">.</span><span class="ident" id="8023499">Errorf</span><span class="op" id="8023505">(</span><span class="string" id="8023506">&#34;exec&nbsp;insert&nbsp;chris:&nbsp;%v&#34;</span><span class="op" id="8023529">,</span>&nbsp;<span class="ident" id="8023531">err</span><span class="op" id="8023534">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8023537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8023540">if</span>&nbsp;<span class="ident" id="8023543">_</span><span class="op" id="8023544">,</span>&nbsp;<span class="ident" id="8023546">err</span>&nbsp;<span class="op" id="8023550">:=</span>&nbsp;<span class="ident" id="8023553">stmt</span><span class="op" id="8023557">.</span><span class="ident" id="8023558">Exec</span><span class="op" id="8023562">(</span><span class="num" id="8023563">4</span><span class="op" id="8023564">,</span>&nbsp;<span class="string" id="8023566">&#34;dave&#34;</span><span class="op" id="8023572">,</span>&nbsp;<span class="ident" id="8023574">spec</span><span class="op" id="8023578">.</span><span class="ident" id="8023579">rows</span><span class="op" id="8023583">[</span><span class="num" id="8023584">3</span><span class="op" id="8023585">]</span><span class="op" id="8023586">.</span><span class="ident" id="8023587">nullParam</span><span class="op" id="8023596">,</span>&nbsp;<span class="ident" id="8023598">spec</span><span class="op" id="8023602">.</span><span class="ident" id="8023603">rows</span><span class="op" id="8023607">[</span><span class="num" id="8023608">3</span><span class="op" id="8023609">]</span><span class="op" id="8023610">.</span><span class="ident" id="8023611">notNullParam</span><span class="op" id="8023623">)</span><span class="op" id="8023624">;</span>&nbsp;<span class="ident" id="8023626">err</span>&nbsp;<span class="op" id="8023630">!=</span>&nbsp;<span class="builtintype" id="8023633">nil</span>&nbsp;<span class="op" id="8023637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8023641">t</span><span class="op" id="8023642">.</span><span class="ident" id="8023643">Errorf</span><span class="op" id="8023649">(</span><span class="string" id="8023650">&#34;exec&nbsp;insert&nbsp;dave:&nbsp;%v&#34;</span><span class="op" id="8023672">,</span>&nbsp;<span class="ident" id="8023674">err</span><span class="op" id="8023677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8023680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8023683">if</span>&nbsp;<span class="ident" id="8023686">_</span><span class="op" id="8023687">,</span>&nbsp;<span class="ident" id="8023689">err</span>&nbsp;<span class="op" id="8023693">:=</span>&nbsp;<span class="ident" id="8023696">stmt</span><span class="op" id="8023700">.</span><span class="ident" id="8023701">Exec</span><span class="op" id="8023705">(</span><span class="num" id="8023706">5</span><span class="op" id="8023707">,</span>&nbsp;<span class="string" id="8023709">&#34;eleanor&#34;</span><span class="op" id="8023718">,</span>&nbsp;<span class="ident" id="8023720">spec</span><span class="op" id="8023724">.</span><span class="ident" id="8023725">rows</span><span class="op" id="8023729">[</span><span class="num" id="8023730">4</span><span class="op" id="8023731">]</span><span class="op" id="8023732">.</span><span class="ident" id="8023733">nullParam</span><span class="op" id="8023742">,</span>&nbsp;<span class="ident" id="8023744">spec</span><span class="op" id="8023748">.</span><span class="ident" id="8023749">rows</span><span class="op" id="8023753">[</span><span class="num" id="8023754">4</span><span class="op" id="8023755">]</span><span class="op" id="8023756">.</span><span class="ident" id="8023757">notNullParam</span><span class="op" id="8023769">)</span><span class="op" id="8023770">;</span>&nbsp;<span class="ident" id="8023772">err</span>&nbsp;<span class="op" id="8023776">!=</span>&nbsp;<span class="builtintype" id="8023779">nil</span>&nbsp;<span class="op" id="8023783">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8023787">t</span><span class="op" id="8023788">.</span><span class="ident" id="8023789">Errorf</span><span class="op" id="8023795">(</span><span class="string" id="8023796">&#34;exec&nbsp;insert&nbsp;eleanor:&nbsp;%v&#34;</span><span class="op" id="8023821">,</span>&nbsp;<span class="ident" id="8023823">err</span><span class="op" id="8023826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8023829">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8023833">//&nbsp;Can&#39;t&nbsp;put&nbsp;null&nbsp;val&nbsp;into&nbsp;non-null&nbsp;col</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8023874">if</span>&nbsp;<span class="ident" id="8023877">_</span><span class="op" id="8023878">,</span>&nbsp;<span class="ident" id="8023880">err</span>&nbsp;<span class="op" id="8023884">:=</span>&nbsp;<span class="ident" id="8023887">stmt</span><span class="op" id="8023891">.</span><span class="ident" id="8023892">Exec</span><span class="op" id="8023896">(</span><span class="num" id="8023897">6</span><span class="op" id="8023898">,</span>&nbsp;<span class="string" id="8023900">&#34;bob&#34;</span><span class="op" id="8023905">,</span>&nbsp;<span class="ident" id="8023907">spec</span><span class="op" id="8023911">.</span><span class="ident" id="8023912">rows</span><span class="op" id="8023916">[</span><span class="num" id="8023917">5</span><span class="op" id="8023918">]</span><span class="op" id="8023919">.</span><span class="ident" id="8023920">nullParam</span><span class="op" id="8023929">,</span>&nbsp;<span class="ident" id="8023931">spec</span><span class="op" id="8023935">.</span><span class="ident" id="8023936">rows</span><span class="op" id="8023940">[</span><span class="num" id="8023941">5</span><span class="op" id="8023942">]</span><span class="op" id="8023943">.</span><span class="ident" id="8023944">notNullParam</span><span class="op" id="8023956">)</span><span class="op" id="8023957">;</span>&nbsp;<span class="ident" id="8023959">err</span>&nbsp;<span class="op" id="8023963">==</span>&nbsp;<span class="builtintype" id="8023966">nil</span>&nbsp;<span class="op" id="8023970">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8023974">t</span><span class="op" id="8023975">.</span><span class="ident" id="8023976">Errorf</span><span class="op" id="8023982">(</span><span class="string" id="8023983">&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;val&nbsp;with&nbsp;prepared&nbsp;statement&nbsp;Exec&#34;</span><span class="op" id="8024046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8024049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8024053">_</span><span class="op" id="8024054">,</span>&nbsp;<span class="ident" id="8024056">err</span>&nbsp;<span class="op" id="8024060">=</span>&nbsp;<span class="ident" id="8024062">db</span><span class="op" id="8024064">.</span><span class="ident" id="8024065">Exec</span><span class="op" id="8024069">(</span><span class="string" id="8024070">&#34;INSERT|t|id=?,name=?,nullf=?&#34;</span><span class="op" id="8024100">,</span>&nbsp;<span class="num" id="8024102">999</span><span class="op" id="8024105">,</span>&nbsp;<span class="builtintype" id="8024107">nil</span><span class="op" id="8024110">,</span>&nbsp;<span class="builtintype" id="8024112">nil</span><span class="op" id="8024115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8024118">if</span>&nbsp;<span class="ident" id="8024121">err</span>&nbsp;<span class="op" id="8024125">==</span>&nbsp;<span class="builtintype" id="8024128">nil</span>&nbsp;<span class="op" id="8024132">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8024136">//&nbsp;TODO:&nbsp;this&nbsp;test&nbsp;fails,&nbsp;but&nbsp;it&#39;s&nbsp;just&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8024186">//&nbsp;fakeConn&nbsp;implements&nbsp;the&nbsp;optional&nbsp;Execer&nbsp;interface,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8024242">//&nbsp;so&nbsp;arguably&nbsp;this&nbsp;is&nbsp;the&nbsp;correct&nbsp;behavior.&nbsp;&nbsp;But</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8024294">//&nbsp;maybe&nbsp;I&nbsp;should&nbsp;flesh&nbsp;out&nbsp;the&nbsp;fakeConn.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8024342">//&nbsp;implementation&nbsp;so&nbsp;this&nbsp;properly&nbsp;fails.</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8024386">//&nbsp;t.Errorf(&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;name&nbsp;with&nbsp;Exec&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8024446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8024450">paramtype</span>&nbsp;<span class="op" id="8024460">:=</span>&nbsp;<span class="ident" id="8024463">reflect</span><span class="op" id="8024470">.</span><span class="ident" id="8024471">TypeOf</span><span class="op" id="8024477">(</span><span class="ident" id="8024478">spec</span><span class="op" id="8024482">.</span><span class="ident" id="8024483">rows</span><span class="op" id="8024487">[</span><span class="num" id="8024488">0</span><span class="op" id="8024489">]</span><span class="op" id="8024490">.</span><span class="ident" id="8024491">nullParam</span><span class="op" id="8024500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8024503">bindVal</span>&nbsp;<span class="op" id="8024511">:=</span>&nbsp;<span class="ident" id="8024514">reflect</span><span class="op" id="8024521">.</span><span class="ident" id="8024522">New</span><span class="op" id="8024525">(</span><span class="ident" id="8024526">paramtype</span><span class="op" id="8024535">)</span><span class="op" id="8024536">.</span><span class="ident" id="8024537">Interface</span><span class="op" id="8024546">(</span><span class="op" id="8024547">)</span><br>
<span class="lineno">830</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8024551">for</span>&nbsp;<span class="ident" id="8024555">i</span>&nbsp;<span class="op" id="8024557">:=</span>&nbsp;<span class="num" id="8024560">0</span><span class="op" id="8024561">;</span>&nbsp;<span class="ident" id="8024563">i</span>&nbsp;<span class="op" id="8024565">&lt;</span>&nbsp;<span class="num" id="8024567">5</span><span class="op" id="8024568">;</span>&nbsp;<span class="ident" id="8024570">i</span><span class="op" id="8024571">++</span>&nbsp;<span class="op" id="8024574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8024578">id</span>&nbsp;<span class="op" id="8024581">:=</span>&nbsp;<span class="ident" id="8024584">i</span>&nbsp;<span class="op" id="8024586">+</span>&nbsp;<span class="num" id="8024588">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8024592">if</span>&nbsp;<span class="ident" id="8024595">err</span>&nbsp;<span class="op" id="8024599">:=</span>&nbsp;<span class="ident" id="8024602">db</span><span class="op" id="8024604">.</span><span class="ident" id="8024605">QueryRow</span><span class="op" id="8024613">(</span><span class="string" id="8024614">&#34;SELECT|t|nullf|id=?&#34;</span><span class="op" id="8024635">,</span>&nbsp;<span class="ident" id="8024637">id</span><span class="op" id="8024639">)</span><span class="op" id="8024640">.</span><span class="ident" id="8024641">Scan</span><span class="op" id="8024645">(</span><span class="ident" id="8024646">bindVal</span><span class="op" id="8024653">)</span><span class="op" id="8024654">;</span>&nbsp;<span class="ident" id="8024656">err</span>&nbsp;<span class="op" id="8024660">!=</span>&nbsp;<span class="builtintype" id="8024663">nil</span>&nbsp;<span class="op" id="8024667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8024672">t</span><span class="op" id="8024673">.</span><span class="ident" id="8024674">Errorf</span><span class="op" id="8024680">(</span><span class="string" id="8024681">&#34;id=%d&nbsp;Scan:&nbsp;%v&#34;</span><span class="op" id="8024697">,</span>&nbsp;<span class="ident" id="8024699">id</span><span class="op" id="8024701">,</span>&nbsp;<span class="ident" id="8024703">err</span><span class="op" id="8024706">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8024710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8024714">bindValDeref</span>&nbsp;<span class="op" id="8024727">:=</span>&nbsp;<span class="ident" id="8024730">reflect</span><span class="op" id="8024737">.</span><span class="ident" id="8024738">ValueOf</span><span class="op" id="8024745">(</span><span class="ident" id="8024746">bindVal</span><span class="op" id="8024753">)</span><span class="op" id="8024754">.</span><span class="ident" id="8024755">Elem</span><span class="op" id="8024759">(</span><span class="op" id="8024760">)</span><span class="op" id="8024761">.</span><span class="ident" id="8024762">Interface</span><span class="op" id="8024771">(</span><span class="op" id="8024772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8024776">if</span>&nbsp;<span class="op" id="8024779">!</span><span class="ident" id="8024780">reflect</span><span class="op" id="8024787">.</span><span class="ident" id="8024788">DeepEqual</span><span class="op" id="8024797">(</span><span class="ident" id="8024798">bindValDeref</span><span class="op" id="8024810">,</span>&nbsp;<span class="ident" id="8024812">spec</span><span class="op" id="8024816">.</span><span class="ident" id="8024817">rows</span><span class="op" id="8024821">[</span><span class="ident" id="8024822">i</span><span class="op" id="8024823">]</span><span class="op" id="8024824">.</span><span class="ident" id="8024825">scanNullVal</span><span class="op" id="8024836">)</span>&nbsp;<span class="op" id="8024838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8024843">t</span><span class="op" id="8024844">.</span><span class="ident" id="8024845">Errorf</span><span class="op" id="8024851">(</span><span class="string" id="8024852">&#34;id=%d&nbsp;got&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="8024877">,</span>&nbsp;<span class="ident" id="8024879">id</span><span class="op" id="8024881">,</span>&nbsp;<span class="ident" id="8024883">bindValDeref</span><span class="op" id="8024895">,</span>&nbsp;<span class="ident" id="8024897">spec</span><span class="op" id="8024901">.</span><span class="ident" id="8024902">rows</span><span class="op" id="8024906">[</span><span class="ident" id="8024907">i</span><span class="op" id="8024908">]</span><span class="op" id="8024909">.</span><span class="ident" id="8024910">scanNullVal</span><span class="op" id="8024921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8024925">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8024928">}</span><br>
<span class="lineno"></span><span class="op" id="8024930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8024933">//&nbsp;golang.org/issue/4859</span><br>
<span class="lineno"></span><span class="keyword" id="8024958">func</span>&nbsp;<span class="ident" id="8024963">TestQueryRowNilScanDest</span><span class="op" id="8024986">(</span><span class="ident" id="8024987">t</span>&nbsp;<span class="op" id="8024989">*</span><span class="ident" id="8024990">testing</span><span class="op" id="8024997">.</span><span class="ident" id="8024998">T</span><span class="op" id="8024999">)</span>&nbsp;<span class="op" id="8025001">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8025004">db</span>&nbsp;<span class="op" id="8025007">:=</span>&nbsp;<span class="ident" id="8025010">newTestDB</span><span class="op" id="8025019">(</span><span class="ident" id="8025020">t</span><span class="op" id="8025021">,</span>&nbsp;<span class="string" id="8025023">&#34;people&#34;</span><span class="op" id="8025031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8025034">defer</span>&nbsp;<span class="ident" id="8025040">closeDB</span><span class="op" id="8025047">(</span><span class="ident" id="8025048">t</span><span class="op" id="8025049">,</span>&nbsp;<span class="ident" id="8025051">db</span><span class="op" id="8025053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8025056">var</span>&nbsp;<span class="ident" id="8025060">name</span>&nbsp;<span class="op" id="8025065">*</span><span class="builtintype" id="8025066">string</span>&nbsp;<span class="comment" id="8025073">//&nbsp;nil&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8025089">err</span>&nbsp;<span class="op" id="8025093">:=</span>&nbsp;<span class="ident" id="8025096">db</span><span class="op" id="8025098">.</span><span class="ident" id="8025099">QueryRow</span><span class="op" id="8025107">(</span><span class="string" id="8025108">&#34;SELECT|people|name|&#34;</span><span class="op" id="8025129">)</span><span class="op" id="8025130">.</span><span class="ident" id="8025131">Scan</span><span class="op" id="8025135">(</span><span class="ident" id="8025136">name</span><span class="op" id="8025140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8025143">want</span>&nbsp;<span class="op" id="8025148">:=</span>&nbsp;<span class="string" id="8025151">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;0:&nbsp;destination&nbsp;pointer&nbsp;is&nbsp;nil&#34;</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8025216">if</span>&nbsp;<span class="ident" id="8025219">err</span>&nbsp;<span class="op" id="8025223">==</span>&nbsp;<span class="builtintype" id="8025226">nil</span>&nbsp;<span class="op" id="8025230">||</span>&nbsp;<span class="ident" id="8025233">err</span><span class="op" id="8025236">.</span><span class="ident" id="8025237">Error</span><span class="op" id="8025242">(</span><span class="op" id="8025243">)</span>&nbsp;<span class="op" id="8025245">!=</span>&nbsp;<span class="ident" id="8025248">want</span>&nbsp;<span class="op" id="8025253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8025257">t</span><span class="op" id="8025258">.</span><span class="ident" id="8025259">Errorf</span><span class="op" id="8025265">(</span><span class="string" id="8025266">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8025287">,</span>&nbsp;<span class="ident" id="8025289">err</span><span class="op" id="8025292">.</span><span class="ident" id="8025293">Error</span><span class="op" id="8025298">(</span><span class="op" id="8025299">)</span><span class="op" id="8025300">,</span>&nbsp;<span class="ident" id="8025302">want</span><span class="op" id="8025306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8025309">}</span><br>
<span class="lineno"></span><span class="op" id="8025311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">855</span><span class="keyword" id="8025314">func</span>&nbsp;<span class="ident" id="8025319">TestIssue4902</span><span class="op" id="8025332">(</span><span class="ident" id="8025333">t</span>&nbsp;<span class="op" id="8025335">*</span><span class="ident" id="8025336">testing</span><span class="op" id="8025343">.</span><span class="ident" id="8025344">T</span><span class="op" id="8025345">)</span>&nbsp;<span class="op" id="8025347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8025350">db</span>&nbsp;<span class="op" id="8025353">:=</span>&nbsp;<span class="ident" id="8025356">newTestDB</span><span class="op" id="8025365">(</span><span class="ident" id="8025366">t</span><span class="op" id="8025367">,</span>&nbsp;<span class="string" id="8025369">&#34;people&#34;</span><span class="op" id="8025377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8025380">defer</span>&nbsp;<span class="ident" id="8025386">closeDB</span><span class="op" id="8025393">(</span><span class="ident" id="8025394">t</span><span class="op" id="8025395">,</span>&nbsp;<span class="ident" id="8025397">db</span><span class="op" id="8025399">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8025403">driver</span>&nbsp;<span class="op" id="8025410">:=</span>&nbsp;<span class="ident" id="8025413">db</span><span class="op" id="8025415">.</span><span class="ident" id="8025416">driver</span><span class="op" id="8025422">.</span><span class="op" id="8025423">(</span><span class="op" id="8025424">*</span><span class="ident" id="8025425">fakeDriver</span><span class="op" id="8025435">)</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8025438">opens0</span>&nbsp;<span class="op" id="8025445">:=</span>&nbsp;<span class="ident" id="8025448">driver</span><span class="op" id="8025454">.</span><span class="ident" id="8025455">openCount</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8025467">var</span>&nbsp;<span class="ident" id="8025471">stmt</span>&nbsp;<span class="op" id="8025476">*</span><span class="ident" id="8025477">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8025483">var</span>&nbsp;<span class="ident" id="8025487">err</span>&nbsp;<span class="builtintype" id="8025491">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8025498">for</span>&nbsp;<span class="ident" id="8025502">i</span>&nbsp;<span class="op" id="8025504">:=</span>&nbsp;<span class="num" id="8025507">0</span><span class="op" id="8025508">;</span>&nbsp;<span class="ident" id="8025510">i</span>&nbsp;<span class="op" id="8025512">&lt;</span>&nbsp;<span class="num" id="8025514">10</span><span class="op" id="8025516">;</span>&nbsp;<span class="ident" id="8025518">i</span><span class="op" id="8025519">++</span>&nbsp;<span class="op" id="8025522">{</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8025526">stmt</span><span class="op" id="8025530">,</span>&nbsp;<span class="ident" id="8025532">err</span>&nbsp;<span class="op" id="8025536">=</span>&nbsp;<span class="ident" id="8025538">db</span><span class="op" id="8025540">.</span><span class="ident" id="8025541">Prepare</span><span class="op" id="8025548">(</span><span class="string" id="8025549">&#34;SELECT|people|name|&#34;</span><span class="op" id="8025570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8025574">if</span>&nbsp;<span class="ident" id="8025577">err</span>&nbsp;<span class="op" id="8025581">!=</span>&nbsp;<span class="builtintype" id="8025584">nil</span>&nbsp;<span class="op" id="8025588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8025593">t</span><span class="op" id="8025594">.</span><span class="ident" id="8025595">Fatal</span><span class="op" id="8025600">(</span><span class="ident" id="8025601">err</span><span class="op" id="8025604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8025608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8025612">err</span>&nbsp;<span class="op" id="8025616">=</span>&nbsp;<span class="ident" id="8025618">stmt</span><span class="op" id="8025622">.</span><span class="ident" id="8025623">Close</span><span class="op" id="8025628">(</span><span class="op" id="8025629">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8025633">if</span>&nbsp;<span class="ident" id="8025636">err</span>&nbsp;<span class="op" id="8025640">!=</span>&nbsp;<span class="builtintype" id="8025643">nil</span>&nbsp;<span class="op" id="8025647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8025652">t</span><span class="op" id="8025653">.</span><span class="ident" id="8025654">Fatal</span><span class="op" id="8025659">(</span><span class="ident" id="8025660">err</span><span class="op" id="8025663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8025667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8025670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8025674">opens</span>&nbsp;<span class="op" id="8025680">:=</span>&nbsp;<span class="ident" id="8025683">driver</span><span class="op" id="8025689">.</span><span class="ident" id="8025690">openCount</span>&nbsp;<span class="op" id="8025700">-</span>&nbsp;<span class="ident" id="8025702">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8025710">if</span>&nbsp;<span class="ident" id="8025713">opens</span>&nbsp;<span class="op" id="8025719">&gt;</span>&nbsp;<span class="num" id="8025721">1</span>&nbsp;<span class="op" id="8025723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8025727">t</span><span class="op" id="8025728">.</span><span class="ident" id="8025729">Errorf</span><span class="op" id="8025735">(</span><span class="string" id="8025736">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="8025759">,</span>&nbsp;<span class="ident" id="8025761">opens</span><span class="op" id="8025766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8025770">t</span><span class="op" id="8025771">.</span><span class="ident" id="8025772">Logf</span><span class="op" id="8025776">(</span><span class="string" id="8025777">&#34;db&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="8025787">,</span>&nbsp;<span class="ident" id="8025789">db</span><span class="op" id="8025791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8025795">t</span><span class="op" id="8025796">.</span><span class="ident" id="8025797">Logf</span><span class="op" id="8025801">(</span><span class="string" id="8025802">&#34;driver&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="8025816">,</span>&nbsp;<span class="ident" id="8025818">driver</span><span class="op" id="8025824">)</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8025828">t</span><span class="op" id="8025829">.</span><span class="ident" id="8025830">Logf</span><span class="op" id="8025834">(</span><span class="string" id="8025835">&#34;stmt&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="8025847">,</span>&nbsp;<span class="ident" id="8025849">stmt</span><span class="op" id="8025853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8025856">}</span><br>
<span class="lineno"></span><span class="op" id="8025858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8025861">//&nbsp;Issue&nbsp;3857</span><br>
<span class="lineno">885</span><span class="comment" id="8025875">//&nbsp;This&nbsp;used&nbsp;to&nbsp;deadlock.</span><br>
<span class="lineno"></span><span class="keyword" id="8025901">func</span>&nbsp;<span class="ident" id="8025906">TestSimultaneousQueries</span><span class="op" id="8025929">(</span><span class="ident" id="8025930">t</span>&nbsp;<span class="op" id="8025932">*</span><span class="ident" id="8025933">testing</span><span class="op" id="8025940">.</span><span class="ident" id="8025941">T</span><span class="op" id="8025942">)</span>&nbsp;<span class="op" id="8025944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8025947">db</span>&nbsp;<span class="op" id="8025950">:=</span>&nbsp;<span class="ident" id="8025953">newTestDB</span><span class="op" id="8025962">(</span><span class="ident" id="8025963">t</span><span class="op" id="8025964">,</span>&nbsp;<span class="string" id="8025966">&#34;people&#34;</span><span class="op" id="8025974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8025977">defer</span>&nbsp;<span class="ident" id="8025983">closeDB</span><span class="op" id="8025990">(</span><span class="ident" id="8025991">t</span><span class="op" id="8025992">,</span>&nbsp;<span class="ident" id="8025994">db</span><span class="op" id="8025996">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8026000">tx</span><span class="op" id="8026002">,</span>&nbsp;<span class="ident" id="8026004">err</span>&nbsp;<span class="op" id="8026008">:=</span>&nbsp;<span class="ident" id="8026011">db</span><span class="op" id="8026013">.</span><span class="ident" id="8026014">Begin</span><span class="op" id="8026019">(</span><span class="op" id="8026020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8026023">if</span>&nbsp;<span class="ident" id="8026026">err</span>&nbsp;<span class="op" id="8026030">!=</span>&nbsp;<span class="builtintype" id="8026033">nil</span>&nbsp;<span class="op" id="8026037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8026041">t</span><span class="op" id="8026042">.</span><span class="ident" id="8026043">Fatal</span><span class="op" id="8026048">(</span><span class="ident" id="8026049">err</span><span class="op" id="8026052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8026055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8026058">defer</span>&nbsp;<span class="ident" id="8026064">tx</span><span class="op" id="8026066">.</span><span class="ident" id="8026067">Rollback</span><span class="op" id="8026075">(</span><span class="op" id="8026076">)</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8026080">r1</span><span class="op" id="8026082">,</span>&nbsp;<span class="ident" id="8026084">err</span>&nbsp;<span class="op" id="8026088">:=</span>&nbsp;<span class="ident" id="8026091">tx</span><span class="op" id="8026093">.</span><span class="ident" id="8026094">Query</span><span class="op" id="8026099">(</span><span class="string" id="8026100">&#34;SELECT|people|name|&#34;</span><span class="op" id="8026121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8026124">if</span>&nbsp;<span class="ident" id="8026127">err</span>&nbsp;<span class="op" id="8026131">!=</span>&nbsp;<span class="builtintype" id="8026134">nil</span>&nbsp;<span class="op" id="8026138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8026142">t</span><span class="op" id="8026143">.</span><span class="ident" id="8026144">Fatal</span><span class="op" id="8026149">(</span><span class="ident" id="8026150">err</span><span class="op" id="8026153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8026156">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8026159">defer</span>&nbsp;<span class="ident" id="8026165">r1</span><span class="op" id="8026167">.</span><span class="ident" id="8026168">Close</span><span class="op" id="8026173">(</span><span class="op" id="8026174">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8026178">r2</span><span class="op" id="8026180">,</span>&nbsp;<span class="ident" id="8026182">err</span>&nbsp;<span class="op" id="8026186">:=</span>&nbsp;<span class="ident" id="8026189">tx</span><span class="op" id="8026191">.</span><span class="ident" id="8026192">Query</span><span class="op" id="8026197">(</span><span class="string" id="8026198">&#34;SELECT|people|name|&#34;</span><span class="op" id="8026219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8026222">if</span>&nbsp;<span class="ident" id="8026225">err</span>&nbsp;<span class="op" id="8026229">!=</span>&nbsp;<span class="builtintype" id="8026232">nil</span>&nbsp;<span class="op" id="8026236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8026240">t</span><span class="op" id="8026241">.</span><span class="ident" id="8026242">Fatal</span><span class="op" id="8026247">(</span><span class="ident" id="8026248">err</span><span class="op" id="8026251">)</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8026254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8026257">defer</span>&nbsp;<span class="ident" id="8026263">r2</span><span class="op" id="8026265">.</span><span class="ident" id="8026266">Close</span><span class="op" id="8026271">(</span><span class="op" id="8026272">)</span><br>
<span class="lineno"></span><span class="op" id="8026274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8026277">func</span>&nbsp;<span class="ident" id="8026282">TestMaxIdleConns</span><span class="op" id="8026298">(</span><span class="ident" id="8026299">t</span>&nbsp;<span class="op" id="8026301">*</span><span class="ident" id="8026302">testing</span><span class="op" id="8026309">.</span><span class="ident" id="8026310">T</span><span class="op" id="8026311">)</span>&nbsp;<span class="op" id="8026313">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8026316">db</span>&nbsp;<span class="op" id="8026319">:=</span>&nbsp;<span class="ident" id="8026322">newTestDB</span><span class="op" id="8026331">(</span><span class="ident" id="8026332">t</span><span class="op" id="8026333">,</span>&nbsp;<span class="string" id="8026335">&#34;people&#34;</span><span class="op" id="8026343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8026346">defer</span>&nbsp;<span class="ident" id="8026352">closeDB</span><span class="op" id="8026359">(</span><span class="ident" id="8026360">t</span><span class="op" id="8026361">,</span>&nbsp;<span class="ident" id="8026363">db</span><span class="op" id="8026365">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8026369">tx</span><span class="op" id="8026371">,</span>&nbsp;<span class="ident" id="8026373">err</span>&nbsp;<span class="op" id="8026377">:=</span>&nbsp;<span class="ident" id="8026380">db</span><span class="op" id="8026382">.</span><span class="ident" id="8026383">Begin</span><span class="op" id="8026388">(</span><span class="op" id="8026389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8026392">if</span>&nbsp;<span class="ident" id="8026395">err</span>&nbsp;<span class="op" id="8026399">!=</span>&nbsp;<span class="builtintype" id="8026402">nil</span>&nbsp;<span class="op" id="8026406">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8026410">t</span><span class="op" id="8026411">.</span><span class="ident" id="8026412">Fatal</span><span class="op" id="8026417">(</span><span class="ident" id="8026418">err</span><span class="op" id="8026421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8026424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8026427">tx</span><span class="op" id="8026429">.</span><span class="ident" id="8026430">Commit</span><span class="op" id="8026436">(</span><span class="op" id="8026437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8026440">if</span>&nbsp;<span class="ident" id="8026443">got</span>&nbsp;<span class="op" id="8026447">:=</span>&nbsp;<span class="builtinfunc" id="8026450">len</span><span class="op" id="8026453">(</span><span class="ident" id="8026454">db</span><span class="op" id="8026456">.</span><span class="ident" id="8026457">freeConn</span><span class="op" id="8026465">)</span><span class="op" id="8026466">;</span>&nbsp;<span class="ident" id="8026468">got</span>&nbsp;<span class="op" id="8026472">!=</span>&nbsp;<span class="num" id="8026475">1</span>&nbsp;<span class="op" id="8026477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8026481">t</span><span class="op" id="8026482">.</span><span class="ident" id="8026483">Errorf</span><span class="op" id="8026489">(</span><span class="string" id="8026490">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="8026514">,</span>&nbsp;<span class="ident" id="8026516">got</span><span class="op" id="8026519">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8026522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8026526">db</span><span class="op" id="8026528">.</span><span class="ident" id="8026529">SetMaxIdleConns</span><span class="op" id="8026544">(</span><span class="num" id="8026545">0</span><span class="op" id="8026546">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8026550">if</span>&nbsp;<span class="ident" id="8026553">got</span>&nbsp;<span class="op" id="8026557">:=</span>&nbsp;<span class="builtinfunc" id="8026560">len</span><span class="op" id="8026563">(</span><span class="ident" id="8026564">db</span><span class="op" id="8026566">.</span><span class="ident" id="8026567">freeConn</span><span class="op" id="8026575">)</span><span class="op" id="8026576">;</span>&nbsp;<span class="ident" id="8026578">got</span>&nbsp;<span class="op" id="8026582">!=</span>&nbsp;<span class="num" id="8026585">0</span>&nbsp;<span class="op" id="8026587">{</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8026591">t</span><span class="op" id="8026592">.</span><span class="ident" id="8026593">Errorf</span><span class="op" id="8026599">(</span><span class="string" id="8026600">&#34;freeConns&nbsp;after&nbsp;set&nbsp;to&nbsp;zero&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="8026642">,</span>&nbsp;<span class="ident" id="8026644">got</span><span class="op" id="8026647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8026650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8026654">tx</span><span class="op" id="8026656">,</span>&nbsp;<span class="ident" id="8026658">err</span>&nbsp;<span class="op" id="8026662">=</span>&nbsp;<span class="ident" id="8026664">db</span><span class="op" id="8026666">.</span><span class="ident" id="8026667">Begin</span><span class="op" id="8026672">(</span><span class="op" id="8026673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8026676">if</span>&nbsp;<span class="ident" id="8026679">err</span>&nbsp;<span class="op" id="8026683">!=</span>&nbsp;<span class="builtintype" id="8026686">nil</span>&nbsp;<span class="op" id="8026690">{</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8026694">t</span><span class="op" id="8026695">.</span><span class="ident" id="8026696">Fatal</span><span class="op" id="8026701">(</span><span class="ident" id="8026702">err</span><span class="op" id="8026705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8026708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8026711">tx</span><span class="op" id="8026713">.</span><span class="ident" id="8026714">Commit</span><span class="op" id="8026720">(</span><span class="op" id="8026721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8026724">if</span>&nbsp;<span class="ident" id="8026727">got</span>&nbsp;<span class="op" id="8026731">:=</span>&nbsp;<span class="builtinfunc" id="8026734">len</span><span class="op" id="8026737">(</span><span class="ident" id="8026738">db</span><span class="op" id="8026740">.</span><span class="ident" id="8026741">freeConn</span><span class="op" id="8026749">)</span><span class="op" id="8026750">;</span>&nbsp;<span class="ident" id="8026752">got</span>&nbsp;<span class="op" id="8026756">!=</span>&nbsp;<span class="num" id="8026759">0</span>&nbsp;<span class="op" id="8026761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8026765">t</span><span class="op" id="8026766">.</span><span class="ident" id="8026767">Errorf</span><span class="op" id="8026773">(</span><span class="string" id="8026774">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="8026798">,</span>&nbsp;<span class="ident" id="8026800">got</span><span class="op" id="8026803">)</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8026806">}</span><br>
<span class="lineno"></span><span class="op" id="8026808">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8026811">func</span>&nbsp;<span class="ident" id="8026816">TestMaxOpenConns</span><span class="op" id="8026832">(</span><span class="ident" id="8026833">t</span>&nbsp;<span class="op" id="8026835">*</span><span class="ident" id="8026836">testing</span><span class="op" id="8026843">.</span><span class="ident" id="8026844">T</span><span class="op" id="8026845">)</span>&nbsp;<span class="op" id="8026847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8026850">if</span>&nbsp;<span class="ident" id="8026853">testing</span><span class="op" id="8026860">.</span><span class="ident" id="8026861">Short</span><span class="op" id="8026866">(</span><span class="op" id="8026867">)</span>&nbsp;<span class="op" id="8026869">{</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8026873">t</span><span class="op" id="8026874">.</span><span class="ident" id="8026875">Skip</span><span class="op" id="8026879">(</span><span class="string" id="8026880">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="8026904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8026907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8026910">defer</span>&nbsp;<span class="ident" id="8026916">setHookpostCloseConn</span><span class="op" id="8026936">(</span><span class="builtintype" id="8026937">nil</span><span class="op" id="8026940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8026943">setHookpostCloseConn</span><span class="op" id="8026963">(</span><span class="keyword" id="8026964">func</span><span class="op" id="8026968">(</span><span class="ident" id="8026969">_</span>&nbsp;<span class="op" id="8026971">*</span><span class="ident" id="8026972">fakeConn</span><span class="op" id="8026980">,</span>&nbsp;<span class="ident" id="8026982">err</span>&nbsp;<span class="builtintype" id="8026986">error</span><span class="op" id="8026991">)</span>&nbsp;<span class="op" id="8026993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8026997">if</span>&nbsp;<span class="ident" id="8027000">err</span>&nbsp;<span class="op" id="8027004">!=</span>&nbsp;<span class="builtintype" id="8027007">nil</span>&nbsp;<span class="op" id="8027011">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8027016">t</span><span class="op" id="8027017">.</span><span class="ident" id="8027018">Errorf</span><span class="op" id="8027024">(</span><span class="string" id="8027025">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="8027053">,</span>&nbsp;<span class="ident" id="8027055">err</span><span class="op" id="8027058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8027062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8027065">}</span><span class="op" id="8027066">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8027070">db</span>&nbsp;<span class="op" id="8027073">:=</span>&nbsp;<span class="ident" id="8027076">newTestDB</span><span class="op" id="8027085">(</span><span class="ident" id="8027086">t</span><span class="op" id="8027087">,</span>&nbsp;<span class="string" id="8027089">&#34;magicquery&#34;</span><span class="op" id="8027101">)</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8027104">defer</span>&nbsp;<span class="ident" id="8027110">closeDB</span><span class="op" id="8027117">(</span><span class="ident" id="8027118">t</span><span class="op" id="8027119">,</span>&nbsp;<span class="ident" id="8027121">db</span><span class="op" id="8027123">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8027127">driver</span>&nbsp;<span class="op" id="8027134">:=</span>&nbsp;<span class="ident" id="8027137">db</span><span class="op" id="8027139">.</span><span class="ident" id="8027140">driver</span><span class="op" id="8027146">.</span><span class="op" id="8027147">(</span><span class="op" id="8027148">*</span><span class="ident" id="8027149">fakeDriver</span><span class="op" id="8027159">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8027163">//&nbsp;Force&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;0&nbsp;so&nbsp;we&nbsp;can&nbsp;get&nbsp;an&nbsp;accurate</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8027235">//&nbsp;count&nbsp;for&nbsp;the&nbsp;test</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8027258">db</span><span class="op" id="8027260">.</span><span class="ident" id="8027261">SetMaxIdleConns</span><span class="op" id="8027276">(</span><span class="num" id="8027277">0</span><span class="op" id="8027278">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8027282">if</span>&nbsp;<span class="ident" id="8027285">g</span><span class="op" id="8027286">,</span>&nbsp;<span class="ident" id="8027288">w</span>&nbsp;<span class="op" id="8027290">:=</span>&nbsp;<span class="ident" id="8027293">db</span><span class="op" id="8027295">.</span><span class="ident" id="8027296">numFreeConns</span><span class="op" id="8027308">(</span><span class="op" id="8027309">)</span><span class="op" id="8027310">,</span>&nbsp;<span class="num" id="8027312">0</span><span class="op" id="8027313">;</span>&nbsp;<span class="ident" id="8027315">g</span>&nbsp;<span class="op" id="8027317">!=</span>&nbsp;<span class="ident" id="8027320">w</span>&nbsp;<span class="op" id="8027322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8027326">t</span><span class="op" id="8027327">.</span><span class="ident" id="8027328">Errorf</span><span class="op" id="8027334">(</span><span class="string" id="8027335">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8027361">,</span>&nbsp;<span class="ident" id="8027363">g</span><span class="op" id="8027364">,</span>&nbsp;<span class="ident" id="8027366">w</span><span class="op" id="8027367">)</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8027370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8027374">if</span>&nbsp;<span class="ident" id="8027377">n</span>&nbsp;<span class="op" id="8027379">:=</span>&nbsp;<span class="ident" id="8027382">db</span><span class="op" id="8027384">.</span><span class="ident" id="8027385">numDepsPollUntil</span><span class="op" id="8027401">(</span><span class="num" id="8027402">0</span><span class="op" id="8027403">,</span>&nbsp;<span class="ident" id="8027405">time</span><span class="op" id="8027409">.</span><span class="ident" id="8027410">Second</span><span class="op" id="8027416">)</span><span class="op" id="8027417">;</span>&nbsp;<span class="ident" id="8027419">n</span>&nbsp;<span class="op" id="8027421">&gt;</span>&nbsp;<span class="num" id="8027423">0</span>&nbsp;<span class="op" id="8027425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8027429">t</span><span class="op" id="8027430">.</span><span class="ident" id="8027431">Errorf</span><span class="op" id="8027437">(</span><span class="string" id="8027438">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="8027479">,</span>&nbsp;<span class="ident" id="8027481">n</span><span class="op" id="8027482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8027486">db</span><span class="op" id="8027488">.</span><span class="ident" id="8027489">dumpDeps</span><span class="op" id="8027497">(</span><span class="ident" id="8027498">t</span><span class="op" id="8027499">)</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8027502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8027506">driver</span><span class="op" id="8027512">.</span><span class="ident" id="8027513">mu</span><span class="op" id="8027515">.</span><span class="ident" id="8027516">Lock</span><span class="op" id="8027520">(</span><span class="op" id="8027521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8027524">opens0</span>&nbsp;<span class="op" id="8027531">:=</span>&nbsp;<span class="ident" id="8027534">driver</span><span class="op" id="8027540">.</span><span class="ident" id="8027541">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8027552">closes0</span>&nbsp;<span class="op" id="8027560">:=</span>&nbsp;<span class="ident" id="8027563">driver</span><span class="op" id="8027569">.</span><span class="ident" id="8027570">closeCount</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8027582">driver</span><span class="op" id="8027588">.</span><span class="ident" id="8027589">mu</span><span class="op" id="8027591">.</span><span class="ident" id="8027592">Unlock</span><span class="op" id="8027598">(</span><span class="op" id="8027599">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8027603">db</span><span class="op" id="8027605">.</span><span class="ident" id="8027606">SetMaxIdleConns</span><span class="op" id="8027621">(</span><span class="num" id="8027622">10</span><span class="op" id="8027624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8027627">db</span><span class="op" id="8027629">.</span><span class="ident" id="8027630">SetMaxOpenConns</span><span class="op" id="8027645">(</span><span class="num" id="8027646">10</span><span class="op" id="8027648">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8027652">stmt</span><span class="op" id="8027656">,</span>&nbsp;<span class="ident" id="8027658">err</span>&nbsp;<span class="op" id="8027662">:=</span>&nbsp;<span class="ident" id="8027665">db</span><span class="op" id="8027667">.</span><span class="ident" id="8027668">Prepare</span><span class="op" id="8027675">(</span><span class="string" id="8027676">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="8027712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8027715">if</span>&nbsp;<span class="ident" id="8027718">err</span>&nbsp;<span class="op" id="8027722">!=</span>&nbsp;<span class="builtintype" id="8027725">nil</span>&nbsp;<span class="op" id="8027729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8027733">t</span><span class="op" id="8027734">.</span><span class="ident" id="8027735">Fatal</span><span class="op" id="8027740">(</span><span class="ident" id="8027741">err</span><span class="op" id="8027744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8027747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8027751">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8027787">const</span>&nbsp;<span class="op" id="8027793">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8027797">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8027809">=</span>&nbsp;<span class="num" id="8027811">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8027816">sleepMillis</span>&nbsp;<span class="op" id="8027828">=</span>&nbsp;<span class="num" id="8027830">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8027835">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8027847">=</span>&nbsp;<span class="num" id="8027849">2</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8027852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8027855">var</span>&nbsp;<span class="ident" id="8027859">wg</span>&nbsp;<span class="ident" id="8027862">sync</span><span class="op" id="8027866">.</span><span class="ident" id="8027867">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8027878">for</span>&nbsp;<span class="ident" id="8027882">batch</span>&nbsp;<span class="op" id="8027888">:=</span>&nbsp;<span class="num" id="8027891">0</span><span class="op" id="8027892">;</span>&nbsp;<span class="ident" id="8027894">batch</span>&nbsp;<span class="op" id="8027900">&lt;</span>&nbsp;<span class="ident" id="8027902">nbatch</span><span class="op" id="8027908">;</span>&nbsp;<span class="ident" id="8027910">batch</span><span class="op" id="8027915">++</span>&nbsp;<span class="op" id="8027918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8027922">for</span>&nbsp;<span class="ident" id="8027926">i</span>&nbsp;<span class="op" id="8027928">:=</span>&nbsp;<span class="num" id="8027931">0</span><span class="op" id="8027932">;</span>&nbsp;<span class="ident" id="8027934">i</span>&nbsp;<span class="op" id="8027936">&lt;</span>&nbsp;<span class="ident" id="8027938">nquery</span><span class="op" id="8027944">;</span>&nbsp;<span class="ident" id="8027946">i</span><span class="op" id="8027947">++</span>&nbsp;<span class="op" id="8027950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8027955">wg</span><span class="op" id="8027957">.</span><span class="ident" id="8027958">Add</span><span class="op" id="8027961">(</span><span class="num" id="8027962">1</span><span class="op" id="8027963">)</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8027968">go</span>&nbsp;<span class="keyword" id="8027971">func</span><span class="op" id="8027975">(</span><span class="op" id="8027976">)</span>&nbsp;<span class="op" id="8027978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8027984">defer</span>&nbsp;<span class="ident" id="8027990">wg</span><span class="op" id="8027992">.</span><span class="ident" id="8027993">Done</span><span class="op" id="8027997">(</span><span class="op" id="8027998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8028004">var</span>&nbsp;<span class="ident" id="8028008">op</span>&nbsp;<span class="builtintype" id="8028011">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8028022">if</span>&nbsp;<span class="ident" id="8028025">err</span>&nbsp;<span class="op" id="8028029">:=</span>&nbsp;<span class="ident" id="8028032">stmt</span><span class="op" id="8028036">.</span><span class="ident" id="8028037">QueryRow</span><span class="op" id="8028045">(</span><span class="string" id="8028046">&#34;sleep&#34;</span><span class="op" id="8028053">,</span>&nbsp;<span class="ident" id="8028055">sleepMillis</span><span class="op" id="8028066">)</span><span class="op" id="8028067">.</span><span class="ident" id="8028068">Scan</span><span class="op" id="8028072">(</span><span class="op" id="8028073">&amp;</span><span class="ident" id="8028074">op</span><span class="op" id="8028076">)</span><span class="op" id="8028077">;</span>&nbsp;<span class="ident" id="8028079">err</span>&nbsp;<span class="op" id="8028083">!=</span>&nbsp;<span class="builtintype" id="8028086">nil</span>&nbsp;<span class="op" id="8028090">&amp;&amp;</span>&nbsp;<span class="ident" id="8028093">err</span>&nbsp;<span class="op" id="8028097">!=</span>&nbsp;<span class="ident" id="8028100">ErrNoRows</span>&nbsp;<span class="op" id="8028110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8028117">t</span><span class="op" id="8028118">.</span><span class="ident" id="8028119">Error</span><span class="op" id="8028124">(</span><span class="ident" id="8028125">err</span><span class="op" id="8028128">)</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8028134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8028139">}</span><span class="op" id="8028140">(</span><span class="op" id="8028141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8028145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8028149">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8028206">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8028263">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8028284">time</span><span class="op" id="8028288">.</span><span class="ident" id="8028289">Sleep</span><span class="op" id="8028294">(</span><span class="num" id="8028295">2</span>&nbsp;<span class="op" id="8028297">*</span>&nbsp;<span class="ident" id="8028299">sleepMillis</span>&nbsp;<span class="op" id="8028311">*</span>&nbsp;<span class="ident" id="8028313">time</span><span class="op" id="8028317">.</span><span class="ident" id="8028318">Millisecond</span><span class="op" id="8028329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8028332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8028335">wg</span><span class="op" id="8028337">.</span><span class="ident" id="8028338">Wait</span><span class="op" id="8028342">(</span><span class="op" id="8028343">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8028347">if</span>&nbsp;<span class="ident" id="8028350">g</span><span class="op" id="8028351">,</span>&nbsp;<span class="ident" id="8028353">w</span>&nbsp;<span class="op" id="8028355">:=</span>&nbsp;<span class="ident" id="8028358">db</span><span class="op" id="8028360">.</span><span class="ident" id="8028361">numFreeConns</span><span class="op" id="8028373">(</span><span class="op" id="8028374">)</span><span class="op" id="8028375">,</span>&nbsp;<span class="num" id="8028377">10</span><span class="op" id="8028379">;</span>&nbsp;<span class="ident" id="8028381">g</span>&nbsp;<span class="op" id="8028383">!=</span>&nbsp;<span class="ident" id="8028386">w</span>&nbsp;<span class="op" id="8028388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8028392">t</span><span class="op" id="8028393">.</span><span class="ident" id="8028394">Errorf</span><span class="op" id="8028400">(</span><span class="string" id="8028401">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8028427">,</span>&nbsp;<span class="ident" id="8028429">g</span><span class="op" id="8028430">,</span>&nbsp;<span class="ident" id="8028432">w</span><span class="op" id="8028433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8028436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8028440">if</span>&nbsp;<span class="ident" id="8028443">n</span>&nbsp;<span class="op" id="8028445">:=</span>&nbsp;<span class="ident" id="8028448">db</span><span class="op" id="8028450">.</span><span class="ident" id="8028451">numDepsPollUntil</span><span class="op" id="8028467">(</span><span class="num" id="8028468">20</span><span class="op" id="8028470">,</span>&nbsp;<span class="ident" id="8028472">time</span><span class="op" id="8028476">.</span><span class="ident" id="8028477">Second</span><span class="op" id="8028483">)</span><span class="op" id="8028484">;</span>&nbsp;<span class="ident" id="8028486">n</span>&nbsp;<span class="op" id="8028488">&gt;</span>&nbsp;<span class="num" id="8028490">20</span>&nbsp;<span class="op" id="8028493">{</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8028497">t</span><span class="op" id="8028498">.</span><span class="ident" id="8028499">Errorf</span><span class="op" id="8028505">(</span><span class="string" id="8028506">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;20&#34;</span><span class="op" id="8028551">,</span>&nbsp;<span class="ident" id="8028553">n</span><span class="op" id="8028554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8028558">db</span><span class="op" id="8028560">.</span><span class="ident" id="8028561">dumpDeps</span><span class="op" id="8028569">(</span><span class="ident" id="8028570">t</span><span class="op" id="8028571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8028574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8028578">driver</span><span class="op" id="8028584">.</span><span class="ident" id="8028585">mu</span><span class="op" id="8028587">.</span><span class="ident" id="8028588">Lock</span><span class="op" id="8028592">(</span><span class="op" id="8028593">)</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8028596">opens</span>&nbsp;<span class="op" id="8028602">:=</span>&nbsp;<span class="ident" id="8028605">driver</span><span class="op" id="8028611">.</span><span class="ident" id="8028612">openCount</span>&nbsp;<span class="op" id="8028622">-</span>&nbsp;<span class="ident" id="8028624">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8028632">closes</span>&nbsp;<span class="op" id="8028639">:=</span>&nbsp;<span class="ident" id="8028642">driver</span><span class="op" id="8028648">.</span><span class="ident" id="8028649">closeCount</span>&nbsp;<span class="op" id="8028660">-</span>&nbsp;<span class="ident" id="8028662">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8028671">driver</span><span class="op" id="8028677">.</span><span class="ident" id="8028678">mu</span><span class="op" id="8028680">.</span><span class="ident" id="8028681">Unlock</span><span class="op" id="8028687">(</span><span class="op" id="8028688">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8028692">if</span>&nbsp;<span class="ident" id="8028695">opens</span>&nbsp;<span class="op" id="8028701">&gt;</span>&nbsp;<span class="num" id="8028703">10</span>&nbsp;<span class="op" id="8028706">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8028710">t</span><span class="op" id="8028711">.</span><span class="ident" id="8028712">Logf</span><span class="op" id="8028716">(</span><span class="string" id="8028717">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8028734">,</span>&nbsp;<span class="ident" id="8028736">opens</span><span class="op" id="8028741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8028745">t</span><span class="op" id="8028746">.</span><span class="ident" id="8028747">Logf</span><span class="op" id="8028751">(</span><span class="string" id="8028752">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8028770">,</span>&nbsp;<span class="ident" id="8028772">closes</span><span class="op" id="8028778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8028782">t</span><span class="op" id="8028783">.</span><span class="ident" id="8028784">Errorf</span><span class="op" id="8028790">(</span><span class="string" id="8028791">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="8028831">,</span>&nbsp;<span class="ident" id="8028833">opens</span><span class="op" id="8028838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8028842">db</span><span class="op" id="8028844">.</span><span class="ident" id="8028845">dumpDeps</span><span class="op" id="8028853">(</span><span class="ident" id="8028854">t</span><span class="op" id="8028855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8028858">}</span><br>
<span class="lineno">1025</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8028862">if</span>&nbsp;<span class="ident" id="8028865">err</span>&nbsp;<span class="op" id="8028869">:=</span>&nbsp;<span class="ident" id="8028872">stmt</span><span class="op" id="8028876">.</span><span class="ident" id="8028877">Close</span><span class="op" id="8028882">(</span><span class="op" id="8028883">)</span><span class="op" id="8028884">;</span>&nbsp;<span class="ident" id="8028886">err</span>&nbsp;<span class="op" id="8028890">!=</span>&nbsp;<span class="builtintype" id="8028893">nil</span>&nbsp;<span class="op" id="8028897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8028901">t</span><span class="op" id="8028902">.</span><span class="ident" id="8028903">Fatal</span><span class="op" id="8028908">(</span><span class="ident" id="8028909">err</span><span class="op" id="8028912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8028915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8028919">if</span>&nbsp;<span class="ident" id="8028922">g</span><span class="op" id="8028923">,</span>&nbsp;<span class="ident" id="8028925">w</span>&nbsp;<span class="op" id="8028927">:=</span>&nbsp;<span class="ident" id="8028930">db</span><span class="op" id="8028932">.</span><span class="ident" id="8028933">numFreeConns</span><span class="op" id="8028945">(</span><span class="op" id="8028946">)</span><span class="op" id="8028947">,</span>&nbsp;<span class="num" id="8028949">10</span><span class="op" id="8028951">;</span>&nbsp;<span class="ident" id="8028953">g</span>&nbsp;<span class="op" id="8028955">!=</span>&nbsp;<span class="ident" id="8028958">w</span>&nbsp;<span class="op" id="8028960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8028964">t</span><span class="op" id="8028965">.</span><span class="ident" id="8028966">Errorf</span><span class="op" id="8028972">(</span><span class="string" id="8028973">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8028999">,</span>&nbsp;<span class="ident" id="8029001">g</span><span class="op" id="8029002">,</span>&nbsp;<span class="ident" id="8029004">w</span><span class="op" id="8029005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8029008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8029012">if</span>&nbsp;<span class="ident" id="8029015">n</span>&nbsp;<span class="op" id="8029017">:=</span>&nbsp;<span class="ident" id="8029020">db</span><span class="op" id="8029022">.</span><span class="ident" id="8029023">numDepsPollUntil</span><span class="op" id="8029039">(</span><span class="num" id="8029040">10</span><span class="op" id="8029042">,</span>&nbsp;<span class="ident" id="8029044">time</span><span class="op" id="8029048">.</span><span class="ident" id="8029049">Second</span><span class="op" id="8029055">)</span><span class="op" id="8029056">;</span>&nbsp;<span class="ident" id="8029058">n</span>&nbsp;<span class="op" id="8029060">&gt;</span>&nbsp;<span class="num" id="8029062">10</span>&nbsp;<span class="op" id="8029065">{</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8029069">t</span><span class="op" id="8029070">.</span><span class="ident" id="8029071">Errorf</span><span class="op" id="8029077">(</span><span class="string" id="8029078">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="8029123">,</span>&nbsp;<span class="ident" id="8029125">n</span><span class="op" id="8029126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8029130">db</span><span class="op" id="8029132">.</span><span class="ident" id="8029133">dumpDeps</span><span class="op" id="8029141">(</span><span class="ident" id="8029142">t</span><span class="op" id="8029143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8029146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8029150">db</span><span class="op" id="8029152">.</span><span class="ident" id="8029153">SetMaxOpenConns</span><span class="op" id="8029168">(</span><span class="num" id="8029169">5</span><span class="op" id="8029170">)</span><br>
<span class="lineno">1040</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8029174">if</span>&nbsp;<span class="ident" id="8029177">g</span><span class="op" id="8029178">,</span>&nbsp;<span class="ident" id="8029180">w</span>&nbsp;<span class="op" id="8029182">:=</span>&nbsp;<span class="ident" id="8029185">db</span><span class="op" id="8029187">.</span><span class="ident" id="8029188">numFreeConns</span><span class="op" id="8029200">(</span><span class="op" id="8029201">)</span><span class="op" id="8029202">,</span>&nbsp;<span class="num" id="8029204">5</span><span class="op" id="8029205">;</span>&nbsp;<span class="ident" id="8029207">g</span>&nbsp;<span class="op" id="8029209">!=</span>&nbsp;<span class="ident" id="8029212">w</span>&nbsp;<span class="op" id="8029214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8029218">t</span><span class="op" id="8029219">.</span><span class="ident" id="8029220">Errorf</span><span class="op" id="8029226">(</span><span class="string" id="8029227">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8029253">,</span>&nbsp;<span class="ident" id="8029255">g</span><span class="op" id="8029256">,</span>&nbsp;<span class="ident" id="8029258">w</span><span class="op" id="8029259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8029262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8029266">if</span>&nbsp;<span class="ident" id="8029269">n</span>&nbsp;<span class="op" id="8029271">:=</span>&nbsp;<span class="ident" id="8029274">db</span><span class="op" id="8029276">.</span><span class="ident" id="8029277">numDepsPollUntil</span><span class="op" id="8029293">(</span><span class="num" id="8029294">5</span><span class="op" id="8029295">,</span>&nbsp;<span class="ident" id="8029297">time</span><span class="op" id="8029301">.</span><span class="ident" id="8029302">Second</span><span class="op" id="8029308">)</span><span class="op" id="8029309">;</span>&nbsp;<span class="ident" id="8029311">n</span>&nbsp;<span class="op" id="8029313">&gt;</span>&nbsp;<span class="num" id="8029315">5</span>&nbsp;<span class="op" id="8029317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8029321">t</span><span class="op" id="8029322">.</span><span class="ident" id="8029323">Errorf</span><span class="op" id="8029329">(</span><span class="string" id="8029330">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="8029371">,</span>&nbsp;<span class="ident" id="8029373">n</span><span class="op" id="8029374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8029378">db</span><span class="op" id="8029380">.</span><span class="ident" id="8029381">dumpDeps</span><span class="op" id="8029389">(</span><span class="ident" id="8029390">t</span><span class="op" id="8029391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8029394">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8029398">db</span><span class="op" id="8029400">.</span><span class="ident" id="8029401">SetMaxOpenConns</span><span class="op" id="8029416">(</span><span class="num" id="8029417">0</span><span class="op" id="8029418">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8029422">if</span>&nbsp;<span class="ident" id="8029425">g</span><span class="op" id="8029426">,</span>&nbsp;<span class="ident" id="8029428">w</span>&nbsp;<span class="op" id="8029430">:=</span>&nbsp;<span class="ident" id="8029433">db</span><span class="op" id="8029435">.</span><span class="ident" id="8029436">numFreeConns</span><span class="op" id="8029448">(</span><span class="op" id="8029449">)</span><span class="op" id="8029450">,</span>&nbsp;<span class="num" id="8029452">5</span><span class="op" id="8029453">;</span>&nbsp;<span class="ident" id="8029455">g</span>&nbsp;<span class="op" id="8029457">!=</span>&nbsp;<span class="ident" id="8029460">w</span>&nbsp;<span class="op" id="8029462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8029466">t</span><span class="op" id="8029467">.</span><span class="ident" id="8029468">Errorf</span><span class="op" id="8029474">(</span><span class="string" id="8029475">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8029501">,</span>&nbsp;<span class="ident" id="8029503">g</span><span class="op" id="8029504">,</span>&nbsp;<span class="ident" id="8029506">w</span><span class="op" id="8029507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8029510">}</span><br>
<span class="lineno">1055</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8029514">if</span>&nbsp;<span class="ident" id="8029517">n</span>&nbsp;<span class="op" id="8029519">:=</span>&nbsp;<span class="ident" id="8029522">db</span><span class="op" id="8029524">.</span><span class="ident" id="8029525">numDepsPollUntil</span><span class="op" id="8029541">(</span><span class="num" id="8029542">5</span><span class="op" id="8029543">,</span>&nbsp;<span class="ident" id="8029545">time</span><span class="op" id="8029549">.</span><span class="ident" id="8029550">Second</span><span class="op" id="8029556">)</span><span class="op" id="8029557">;</span>&nbsp;<span class="ident" id="8029559">n</span>&nbsp;<span class="op" id="8029561">&gt;</span>&nbsp;<span class="num" id="8029563">5</span>&nbsp;<span class="op" id="8029565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8029569">t</span><span class="op" id="8029570">.</span><span class="ident" id="8029571">Errorf</span><span class="op" id="8029577">(</span><span class="string" id="8029578">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="8029619">,</span>&nbsp;<span class="ident" id="8029621">n</span><span class="op" id="8029622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8029626">db</span><span class="op" id="8029628">.</span><span class="ident" id="8029629">dumpDeps</span><span class="op" id="8029637">(</span><span class="ident" id="8029638">t</span><span class="op" id="8029639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8029642">}</span><br>
<span class="lineno">1060</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8029646">db</span><span class="op" id="8029648">.</span><span class="ident" id="8029649">SetMaxIdleConns</span><span class="op" id="8029664">(</span><span class="num" id="8029665">0</span><span class="op" id="8029666">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8029670">if</span>&nbsp;<span class="ident" id="8029673">g</span><span class="op" id="8029674">,</span>&nbsp;<span class="ident" id="8029676">w</span>&nbsp;<span class="op" id="8029678">:=</span>&nbsp;<span class="ident" id="8029681">db</span><span class="op" id="8029683">.</span><span class="ident" id="8029684">numFreeConns</span><span class="op" id="8029696">(</span><span class="op" id="8029697">)</span><span class="op" id="8029698">,</span>&nbsp;<span class="num" id="8029700">0</span><span class="op" id="8029701">;</span>&nbsp;<span class="ident" id="8029703">g</span>&nbsp;<span class="op" id="8029705">!=</span>&nbsp;<span class="ident" id="8029708">w</span>&nbsp;<span class="op" id="8029710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8029714">t</span><span class="op" id="8029715">.</span><span class="ident" id="8029716">Errorf</span><span class="op" id="8029722">(</span><span class="string" id="8029723">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8029749">,</span>&nbsp;<span class="ident" id="8029751">g</span><span class="op" id="8029752">,</span>&nbsp;<span class="ident" id="8029754">w</span><span class="op" id="8029755">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8029758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8029762">if</span>&nbsp;<span class="ident" id="8029765">n</span>&nbsp;<span class="op" id="8029767">:=</span>&nbsp;<span class="ident" id="8029770">db</span><span class="op" id="8029772">.</span><span class="ident" id="8029773">numDepsPollUntil</span><span class="op" id="8029789">(</span><span class="num" id="8029790">0</span><span class="op" id="8029791">,</span>&nbsp;<span class="ident" id="8029793">time</span><span class="op" id="8029797">.</span><span class="ident" id="8029798">Second</span><span class="op" id="8029804">)</span><span class="op" id="8029805">;</span>&nbsp;<span class="ident" id="8029807">n</span>&nbsp;<span class="op" id="8029809">&gt;</span>&nbsp;<span class="num" id="8029811">0</span>&nbsp;<span class="op" id="8029813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8029817">t</span><span class="op" id="8029818">.</span><span class="ident" id="8029819">Errorf</span><span class="op" id="8029825">(</span><span class="string" id="8029826">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="8029867">,</span>&nbsp;<span class="ident" id="8029869">n</span><span class="op" id="8029870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8029874">db</span><span class="op" id="8029876">.</span><span class="ident" id="8029877">dumpDeps</span><span class="op" id="8029885">(</span><span class="ident" id="8029886">t</span><span class="op" id="8029887">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8029890">}</span><br>
<span class="lineno"></span><span class="op" id="8029892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8029895">func</span>&nbsp;<span class="ident" id="8029900">TestSingleOpenConn</span><span class="op" id="8029918">(</span><span class="ident" id="8029919">t</span>&nbsp;<span class="op" id="8029921">*</span><span class="ident" id="8029922">testing</span><span class="op" id="8029929">.</span><span class="ident" id="8029930">T</span><span class="op" id="8029931">)</span>&nbsp;<span class="op" id="8029933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8029936">db</span>&nbsp;<span class="op" id="8029939">:=</span>&nbsp;<span class="ident" id="8029942">newTestDB</span><span class="op" id="8029951">(</span><span class="ident" id="8029952">t</span><span class="op" id="8029953">,</span>&nbsp;<span class="string" id="8029955">&#34;people&#34;</span><span class="op" id="8029963">)</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8029966">defer</span>&nbsp;<span class="ident" id="8029972">closeDB</span><span class="op" id="8029979">(</span><span class="ident" id="8029980">t</span><span class="op" id="8029981">,</span>&nbsp;<span class="ident" id="8029983">db</span><span class="op" id="8029985">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8029989">db</span><span class="op" id="8029991">.</span><span class="ident" id="8029992">SetMaxOpenConns</span><span class="op" id="8030007">(</span><span class="num" id="8030008">1</span><span class="op" id="8030009">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8030013">rows</span><span class="op" id="8030017">,</span>&nbsp;<span class="ident" id="8030019">err</span>&nbsp;<span class="op" id="8030023">:=</span>&nbsp;<span class="ident" id="8030026">db</span><span class="op" id="8030028">.</span><span class="ident" id="8030029">Query</span><span class="op" id="8030034">(</span><span class="string" id="8030035">&#34;SELECT|people|name|&#34;</span><span class="op" id="8030056">)</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8030059">if</span>&nbsp;<span class="ident" id="8030062">err</span>&nbsp;<span class="op" id="8030066">!=</span>&nbsp;<span class="builtintype" id="8030069">nil</span>&nbsp;<span class="op" id="8030073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8030077">t</span><span class="op" id="8030078">.</span><span class="ident" id="8030079">Fatal</span><span class="op" id="8030084">(</span><span class="ident" id="8030085">err</span><span class="op" id="8030088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8030091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8030094">if</span>&nbsp;<span class="ident" id="8030097">err</span>&nbsp;<span class="op" id="8030101">=</span>&nbsp;<span class="ident" id="8030103">rows</span><span class="op" id="8030107">.</span><span class="ident" id="8030108">Close</span><span class="op" id="8030113">(</span><span class="op" id="8030114">)</span><span class="op" id="8030115">;</span>&nbsp;<span class="ident" id="8030117">err</span>&nbsp;<span class="op" id="8030121">!=</span>&nbsp;<span class="builtintype" id="8030124">nil</span>&nbsp;<span class="op" id="8030128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8030132">t</span><span class="op" id="8030133">.</span><span class="ident" id="8030134">Fatal</span><span class="op" id="8030139">(</span><span class="ident" id="8030140">err</span><span class="op" id="8030143">)</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8030146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8030149">//&nbsp;shouldn&#39;t&nbsp;deadlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8030172">rows</span><span class="op" id="8030176">,</span>&nbsp;<span class="ident" id="8030178">err</span>&nbsp;<span class="op" id="8030182">=</span>&nbsp;<span class="ident" id="8030184">db</span><span class="op" id="8030186">.</span><span class="ident" id="8030187">Query</span><span class="op" id="8030192">(</span><span class="string" id="8030193">&#34;SELECT|people|name|&#34;</span><span class="op" id="8030214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8030217">if</span>&nbsp;<span class="ident" id="8030220">err</span>&nbsp;<span class="op" id="8030224">!=</span>&nbsp;<span class="builtintype" id="8030227">nil</span>&nbsp;<span class="op" id="8030231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8030235">t</span><span class="op" id="8030236">.</span><span class="ident" id="8030237">Fatal</span><span class="op" id="8030242">(</span><span class="ident" id="8030243">err</span><span class="op" id="8030246">)</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8030249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8030252">if</span>&nbsp;<span class="ident" id="8030255">err</span>&nbsp;<span class="op" id="8030259">=</span>&nbsp;<span class="ident" id="8030261">rows</span><span class="op" id="8030265">.</span><span class="ident" id="8030266">Close</span><span class="op" id="8030271">(</span><span class="op" id="8030272">)</span><span class="op" id="8030273">;</span>&nbsp;<span class="ident" id="8030275">err</span>&nbsp;<span class="op" id="8030279">!=</span>&nbsp;<span class="builtintype" id="8030282">nil</span>&nbsp;<span class="op" id="8030286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8030290">t</span><span class="op" id="8030291">.</span><span class="ident" id="8030292">Fatal</span><span class="op" id="8030297">(</span><span class="ident" id="8030298">err</span><span class="op" id="8030301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8030304">}</span><br>
<span class="lineno"></span><span class="op" id="8030306">}</span><br>
<span class="lineno">1095</span><br>
<span class="lineno"></span><span class="comment" id="8030309">//&nbsp;golang.org/issue/5323</span><br>
<span class="lineno"></span><span class="keyword" id="8030334">func</span>&nbsp;<span class="ident" id="8030339">TestStmtCloseDeps</span><span class="op" id="8030356">(</span><span class="ident" id="8030357">t</span>&nbsp;<span class="op" id="8030359">*</span><span class="ident" id="8030360">testing</span><span class="op" id="8030367">.</span><span class="ident" id="8030368">T</span><span class="op" id="8030369">)</span>&nbsp;<span class="op" id="8030371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8030374">if</span>&nbsp;<span class="ident" id="8030377">testing</span><span class="op" id="8030384">.</span><span class="ident" id="8030385">Short</span><span class="op" id="8030390">(</span><span class="op" id="8030391">)</span>&nbsp;<span class="op" id="8030393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8030397">t</span><span class="op" id="8030398">.</span><span class="ident" id="8030399">Skip</span><span class="op" id="8030403">(</span><span class="string" id="8030404">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="8030428">)</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8030431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8030434">defer</span>&nbsp;<span class="ident" id="8030440">setHookpostCloseConn</span><span class="op" id="8030460">(</span><span class="builtintype" id="8030461">nil</span><span class="op" id="8030464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8030467">setHookpostCloseConn</span><span class="op" id="8030487">(</span><span class="keyword" id="8030488">func</span><span class="op" id="8030492">(</span><span class="ident" id="8030493">_</span>&nbsp;<span class="op" id="8030495">*</span><span class="ident" id="8030496">fakeConn</span><span class="op" id="8030504">,</span>&nbsp;<span class="ident" id="8030506">err</span>&nbsp;<span class="builtintype" id="8030510">error</span><span class="op" id="8030515">)</span>&nbsp;<span class="op" id="8030517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8030521">if</span>&nbsp;<span class="ident" id="8030524">err</span>&nbsp;<span class="op" id="8030528">!=</span>&nbsp;<span class="builtintype" id="8030531">nil</span>&nbsp;<span class="op" id="8030535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8030540">t</span><span class="op" id="8030541">.</span><span class="ident" id="8030542">Errorf</span><span class="op" id="8030548">(</span><span class="string" id="8030549">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="8030577">,</span>&nbsp;<span class="ident" id="8030579">err</span><span class="op" id="8030582">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8030586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8030589">}</span><span class="op" id="8030590">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8030594">db</span>&nbsp;<span class="op" id="8030597">:=</span>&nbsp;<span class="ident" id="8030600">newTestDB</span><span class="op" id="8030609">(</span><span class="ident" id="8030610">t</span><span class="op" id="8030611">,</span>&nbsp;<span class="string" id="8030613">&#34;magicquery&#34;</span><span class="op" id="8030625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8030628">defer</span>&nbsp;<span class="ident" id="8030634">closeDB</span><span class="op" id="8030641">(</span><span class="ident" id="8030642">t</span><span class="op" id="8030643">,</span>&nbsp;<span class="ident" id="8030645">db</span><span class="op" id="8030647">)</span><br>
<span class="lineno">1110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8030651">driver</span>&nbsp;<span class="op" id="8030658">:=</span>&nbsp;<span class="ident" id="8030661">db</span><span class="op" id="8030663">.</span><span class="ident" id="8030664">driver</span><span class="op" id="8030670">.</span><span class="op" id="8030671">(</span><span class="op" id="8030672">*</span><span class="ident" id="8030673">fakeDriver</span><span class="op" id="8030683">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8030687">driver</span><span class="op" id="8030693">.</span><span class="ident" id="8030694">mu</span><span class="op" id="8030696">.</span><span class="ident" id="8030697">Lock</span><span class="op" id="8030701">(</span><span class="op" id="8030702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8030705">opens0</span>&nbsp;<span class="op" id="8030712">:=</span>&nbsp;<span class="ident" id="8030715">driver</span><span class="op" id="8030721">.</span><span class="ident" id="8030722">openCount</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8030733">closes0</span>&nbsp;<span class="op" id="8030741">:=</span>&nbsp;<span class="ident" id="8030744">driver</span><span class="op" id="8030750">.</span><span class="ident" id="8030751">closeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8030763">driver</span><span class="op" id="8030769">.</span><span class="ident" id="8030770">mu</span><span class="op" id="8030772">.</span><span class="ident" id="8030773">Unlock</span><span class="op" id="8030779">(</span><span class="op" id="8030780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8030783">openDelta0</span>&nbsp;<span class="op" id="8030794">:=</span>&nbsp;<span class="ident" id="8030797">opens0</span>&nbsp;<span class="op" id="8030804">-</span>&nbsp;<span class="ident" id="8030806">closes0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8030816">stmt</span><span class="op" id="8030820">,</span>&nbsp;<span class="ident" id="8030822">err</span>&nbsp;<span class="op" id="8030826">:=</span>&nbsp;<span class="ident" id="8030829">db</span><span class="op" id="8030831">.</span><span class="ident" id="8030832">Prepare</span><span class="op" id="8030839">(</span><span class="string" id="8030840">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="8030876">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8030879">if</span>&nbsp;<span class="ident" id="8030882">err</span>&nbsp;<span class="op" id="8030886">!=</span>&nbsp;<span class="builtintype" id="8030889">nil</span>&nbsp;<span class="op" id="8030893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8030897">t</span><span class="op" id="8030898">.</span><span class="ident" id="8030899">Fatal</span><span class="op" id="8030904">(</span><span class="ident" id="8030905">err</span><span class="op" id="8030908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8030911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8030915">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8030951">const</span>&nbsp;<span class="op" id="8030957">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8030961">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8030973">=</span>&nbsp;<span class="num" id="8030975">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8030980">sleepMillis</span>&nbsp;<span class="op" id="8030992">=</span>&nbsp;<span class="num" id="8030994">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8030999">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8031011">=</span>&nbsp;<span class="num" id="8031013">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8031016">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8031019">var</span>&nbsp;<span class="ident" id="8031023">wg</span>&nbsp;<span class="ident" id="8031026">sync</span><span class="op" id="8031030">.</span><span class="ident" id="8031031">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8031042">for</span>&nbsp;<span class="ident" id="8031046">batch</span>&nbsp;<span class="op" id="8031052">:=</span>&nbsp;<span class="num" id="8031055">0</span><span class="op" id="8031056">;</span>&nbsp;<span class="ident" id="8031058">batch</span>&nbsp;<span class="op" id="8031064">&lt;</span>&nbsp;<span class="ident" id="8031066">nbatch</span><span class="op" id="8031072">;</span>&nbsp;<span class="ident" id="8031074">batch</span><span class="op" id="8031079">++</span>&nbsp;<span class="op" id="8031082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8031086">for</span>&nbsp;<span class="ident" id="8031090">i</span>&nbsp;<span class="op" id="8031092">:=</span>&nbsp;<span class="num" id="8031095">0</span><span class="op" id="8031096">;</span>&nbsp;<span class="ident" id="8031098">i</span>&nbsp;<span class="op" id="8031100">&lt;</span>&nbsp;<span class="ident" id="8031102">nquery</span><span class="op" id="8031108">;</span>&nbsp;<span class="ident" id="8031110">i</span><span class="op" id="8031111">++</span>&nbsp;<span class="op" id="8031114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8031119">wg</span><span class="op" id="8031121">.</span><span class="ident" id="8031122">Add</span><span class="op" id="8031125">(</span><span class="num" id="8031126">1</span><span class="op" id="8031127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8031132">go</span>&nbsp;<span class="keyword" id="8031135">func</span><span class="op" id="8031139">(</span><span class="op" id="8031140">)</span>&nbsp;<span class="op" id="8031142">{</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8031148">defer</span>&nbsp;<span class="ident" id="8031154">wg</span><span class="op" id="8031156">.</span><span class="ident" id="8031157">Done</span><span class="op" id="8031161">(</span><span class="op" id="8031162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8031168">var</span>&nbsp;<span class="ident" id="8031172">op</span>&nbsp;<span class="builtintype" id="8031175">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8031186">if</span>&nbsp;<span class="ident" id="8031189">err</span>&nbsp;<span class="op" id="8031193">:=</span>&nbsp;<span class="ident" id="8031196">stmt</span><span class="op" id="8031200">.</span><span class="ident" id="8031201">QueryRow</span><span class="op" id="8031209">(</span><span class="string" id="8031210">&#34;sleep&#34;</span><span class="op" id="8031217">,</span>&nbsp;<span class="ident" id="8031219">sleepMillis</span><span class="op" id="8031230">)</span><span class="op" id="8031231">.</span><span class="ident" id="8031232">Scan</span><span class="op" id="8031236">(</span><span class="op" id="8031237">&amp;</span><span class="ident" id="8031238">op</span><span class="op" id="8031240">)</span><span class="op" id="8031241">;</span>&nbsp;<span class="ident" id="8031243">err</span>&nbsp;<span class="op" id="8031247">!=</span>&nbsp;<span class="builtintype" id="8031250">nil</span>&nbsp;<span class="op" id="8031254">&amp;&amp;</span>&nbsp;<span class="ident" id="8031257">err</span>&nbsp;<span class="op" id="8031261">!=</span>&nbsp;<span class="ident" id="8031264">ErrNoRows</span>&nbsp;<span class="op" id="8031274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8031281">t</span><span class="op" id="8031282">.</span><span class="ident" id="8031283">Error</span><span class="op" id="8031288">(</span><span class="ident" id="8031289">err</span><span class="op" id="8031292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8031298">}</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8031303">}</span><span class="op" id="8031304">(</span><span class="op" id="8031305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8031309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8031313">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8031370">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8031427">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8031448">time</span><span class="op" id="8031452">.</span><span class="ident" id="8031453">Sleep</span><span class="op" id="8031458">(</span><span class="num" id="8031459">2</span>&nbsp;<span class="op" id="8031461">*</span>&nbsp;<span class="ident" id="8031463">sleepMillis</span>&nbsp;<span class="op" id="8031475">*</span>&nbsp;<span class="ident" id="8031477">time</span><span class="op" id="8031481">.</span><span class="ident" id="8031482">Millisecond</span><span class="op" id="8031493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8031496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8031499">wg</span><span class="op" id="8031501">.</span><span class="ident" id="8031502">Wait</span><span class="op" id="8031506">(</span><span class="op" id="8031507">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8031511">if</span>&nbsp;<span class="ident" id="8031514">g</span><span class="op" id="8031515">,</span>&nbsp;<span class="ident" id="8031517">w</span>&nbsp;<span class="op" id="8031519">:=</span>&nbsp;<span class="ident" id="8031522">db</span><span class="op" id="8031524">.</span><span class="ident" id="8031525">numFreeConns</span><span class="op" id="8031537">(</span><span class="op" id="8031538">)</span><span class="op" id="8031539">,</span>&nbsp;<span class="num" id="8031541">2</span><span class="op" id="8031542">;</span>&nbsp;<span class="ident" id="8031544">g</span>&nbsp;<span class="op" id="8031546">!=</span>&nbsp;<span class="ident" id="8031549">w</span>&nbsp;<span class="op" id="8031551">{</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8031555">t</span><span class="op" id="8031556">.</span><span class="ident" id="8031557">Errorf</span><span class="op" id="8031563">(</span><span class="string" id="8031564">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8031590">,</span>&nbsp;<span class="ident" id="8031592">g</span><span class="op" id="8031593">,</span>&nbsp;<span class="ident" id="8031595">w</span><span class="op" id="8031596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8031599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8031603">if</span>&nbsp;<span class="ident" id="8031606">n</span>&nbsp;<span class="op" id="8031608">:=</span>&nbsp;<span class="ident" id="8031611">db</span><span class="op" id="8031613">.</span><span class="ident" id="8031614">numDepsPollUntil</span><span class="op" id="8031630">(</span><span class="num" id="8031631">4</span><span class="op" id="8031632">,</span>&nbsp;<span class="ident" id="8031634">time</span><span class="op" id="8031638">.</span><span class="ident" id="8031639">Second</span><span class="op" id="8031645">)</span><span class="op" id="8031646">;</span>&nbsp;<span class="ident" id="8031648">n</span>&nbsp;<span class="op" id="8031650">&gt;</span>&nbsp;<span class="num" id="8031652">4</span>&nbsp;<span class="op" id="8031654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8031658">t</span><span class="op" id="8031659">.</span><span class="ident" id="8031660">Errorf</span><span class="op" id="8031666">(</span><span class="string" id="8031667">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;4&#34;</span><span class="op" id="8031711">,</span>&nbsp;<span class="ident" id="8031713">n</span><span class="op" id="8031714">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8031718">db</span><span class="op" id="8031720">.</span><span class="ident" id="8031721">dumpDeps</span><span class="op" id="8031729">(</span><span class="ident" id="8031730">t</span><span class="op" id="8031731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8031734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8031738">driver</span><span class="op" id="8031744">.</span><span class="ident" id="8031745">mu</span><span class="op" id="8031747">.</span><span class="ident" id="8031748">Lock</span><span class="op" id="8031752">(</span><span class="op" id="8031753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8031756">opens</span>&nbsp;<span class="op" id="8031762">:=</span>&nbsp;<span class="ident" id="8031765">driver</span><span class="op" id="8031771">.</span><span class="ident" id="8031772">openCount</span>&nbsp;<span class="op" id="8031782">-</span>&nbsp;<span class="ident" id="8031784">opens0</span><br>
<span class="lineno">1160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8031792">closes</span>&nbsp;<span class="op" id="8031799">:=</span>&nbsp;<span class="ident" id="8031802">driver</span><span class="op" id="8031808">.</span><span class="ident" id="8031809">closeCount</span>&nbsp;<span class="op" id="8031820">-</span>&nbsp;<span class="ident" id="8031822">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8031831">openDelta</span>&nbsp;<span class="op" id="8031841">:=</span>&nbsp;<span class="op" id="8031844">(</span><span class="ident" id="8031845">driver</span><span class="op" id="8031851">.</span><span class="ident" id="8031852">openCount</span>&nbsp;<span class="op" id="8031862">-</span>&nbsp;<span class="ident" id="8031864">driver</span><span class="op" id="8031870">.</span><span class="ident" id="8031871">closeCount</span><span class="op" id="8031881">)</span>&nbsp;<span class="op" id="8031883">-</span>&nbsp;<span class="ident" id="8031885">openDelta0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8031897">driver</span><span class="op" id="8031903">.</span><span class="ident" id="8031904">mu</span><span class="op" id="8031906">.</span><span class="ident" id="8031907">Unlock</span><span class="op" id="8031913">(</span><span class="op" id="8031914">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8031918">if</span>&nbsp;<span class="ident" id="8031921">openDelta</span>&nbsp;<span class="op" id="8031931">&gt;</span>&nbsp;<span class="num" id="8031933">2</span>&nbsp;<span class="op" id="8031935">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8031939">t</span><span class="op" id="8031940">.</span><span class="ident" id="8031941">Logf</span><span class="op" id="8031945">(</span><span class="string" id="8031946">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8031963">,</span>&nbsp;<span class="ident" id="8031965">opens</span><span class="op" id="8031970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8031974">t</span><span class="op" id="8031975">.</span><span class="ident" id="8031976">Logf</span><span class="op" id="8031980">(</span><span class="string" id="8031981">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8031999">,</span>&nbsp;<span class="ident" id="8032001">closes</span><span class="op" id="8032007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8032011">t</span><span class="op" id="8032012">.</span><span class="ident" id="8032013">Logf</span><span class="op" id="8032017">(</span><span class="string" id="8032018">&#34;open&nbsp;delta&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8032035">,</span>&nbsp;<span class="ident" id="8032037">openDelta</span><span class="op" id="8032046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8032050">t</span><span class="op" id="8032051">.</span><span class="ident" id="8032052">Errorf</span><span class="op" id="8032058">(</span><span class="string" id="8032059">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="8032098">,</span>&nbsp;<span class="ident" id="8032100">openDelta</span><span class="op" id="8032109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8032113">db</span><span class="op" id="8032115">.</span><span class="ident" id="8032116">dumpDeps</span><span class="op" id="8032124">(</span><span class="ident" id="8032125">t</span><span class="op" id="8032126">)</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8032129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8032133">if</span>&nbsp;<span class="builtinfunc" id="8032136">len</span><span class="op" id="8032139">(</span><span class="ident" id="8032140">stmt</span><span class="op" id="8032144">.</span><span class="ident" id="8032145">css</span><span class="op" id="8032148">)</span>&nbsp;<span class="op" id="8032150">&gt;</span>&nbsp;<span class="ident" id="8032152">nquery</span>&nbsp;<span class="op" id="8032159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8032163">t</span><span class="op" id="8032164">.</span><span class="ident" id="8032165">Errorf</span><span class="op" id="8032171">(</span><span class="string" id="8032172">&#34;len(stmt.css)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;%d&#34;</span><span class="op" id="8032204">,</span>&nbsp;<span class="builtinfunc" id="8032206">len</span><span class="op" id="8032209">(</span><span class="ident" id="8032210">stmt</span><span class="op" id="8032214">.</span><span class="ident" id="8032215">css</span><span class="op" id="8032218">)</span><span class="op" id="8032219">,</span>&nbsp;<span class="ident" id="8032221">nquery</span><span class="op" id="8032227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8032230">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8032234">if</span>&nbsp;<span class="ident" id="8032237">err</span>&nbsp;<span class="op" id="8032241">:=</span>&nbsp;<span class="ident" id="8032244">stmt</span><span class="op" id="8032248">.</span><span class="ident" id="8032249">Close</span><span class="op" id="8032254">(</span><span class="op" id="8032255">)</span><span class="op" id="8032256">;</span>&nbsp;<span class="ident" id="8032258">err</span>&nbsp;<span class="op" id="8032262">!=</span>&nbsp;<span class="builtintype" id="8032265">nil</span>&nbsp;<span class="op" id="8032269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8032273">t</span><span class="op" id="8032274">.</span><span class="ident" id="8032275">Fatal</span><span class="op" id="8032280">(</span><span class="ident" id="8032281">err</span><span class="op" id="8032284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8032287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8032291">if</span>&nbsp;<span class="ident" id="8032294">g</span><span class="op" id="8032295">,</span>&nbsp;<span class="ident" id="8032297">w</span>&nbsp;<span class="op" id="8032299">:=</span>&nbsp;<span class="ident" id="8032302">db</span><span class="op" id="8032304">.</span><span class="ident" id="8032305">numFreeConns</span><span class="op" id="8032317">(</span><span class="op" id="8032318">)</span><span class="op" id="8032319">,</span>&nbsp;<span class="num" id="8032321">2</span><span class="op" id="8032322">;</span>&nbsp;<span class="ident" id="8032324">g</span>&nbsp;<span class="op" id="8032326">!=</span>&nbsp;<span class="ident" id="8032329">w</span>&nbsp;<span class="op" id="8032331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8032335">t</span><span class="op" id="8032336">.</span><span class="ident" id="8032337">Errorf</span><span class="op" id="8032343">(</span><span class="string" id="8032344">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8032370">,</span>&nbsp;<span class="ident" id="8032372">g</span><span class="op" id="8032373">,</span>&nbsp;<span class="ident" id="8032375">w</span><span class="op" id="8032376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8032379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8032383">if</span>&nbsp;<span class="ident" id="8032386">n</span>&nbsp;<span class="op" id="8032388">:=</span>&nbsp;<span class="ident" id="8032391">db</span><span class="op" id="8032393">.</span><span class="ident" id="8032394">numDepsPollUntil</span><span class="op" id="8032410">(</span><span class="num" id="8032411">2</span><span class="op" id="8032412">,</span>&nbsp;<span class="ident" id="8032414">time</span><span class="op" id="8032418">.</span><span class="ident" id="8032419">Second</span><span class="op" id="8032425">)</span><span class="op" id="8032426">;</span>&nbsp;<span class="ident" id="8032428">n</span>&nbsp;<span class="op" id="8032430">&gt;</span>&nbsp;<span class="num" id="8032432">2</span>&nbsp;<span class="op" id="8032434">{</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8032438">t</span><span class="op" id="8032439">.</span><span class="ident" id="8032440">Errorf</span><span class="op" id="8032446">(</span><span class="string" id="8032447">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="8032491">,</span>&nbsp;<span class="ident" id="8032493">n</span><span class="op" id="8032494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8032498">db</span><span class="op" id="8032500">.</span><span class="ident" id="8032501">dumpDeps</span><span class="op" id="8032509">(</span><span class="ident" id="8032510">t</span><span class="op" id="8032511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8032514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8032518">db</span><span class="op" id="8032520">.</span><span class="ident" id="8032521">SetMaxIdleConns</span><span class="op" id="8032536">(</span><span class="num" id="8032537">0</span><span class="op" id="8032538">)</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8032542">if</span>&nbsp;<span class="ident" id="8032545">g</span><span class="op" id="8032546">,</span>&nbsp;<span class="ident" id="8032548">w</span>&nbsp;<span class="op" id="8032550">:=</span>&nbsp;<span class="ident" id="8032553">db</span><span class="op" id="8032555">.</span><span class="ident" id="8032556">numFreeConns</span><span class="op" id="8032568">(</span><span class="op" id="8032569">)</span><span class="op" id="8032570">,</span>&nbsp;<span class="num" id="8032572">0</span><span class="op" id="8032573">;</span>&nbsp;<span class="ident" id="8032575">g</span>&nbsp;<span class="op" id="8032577">!=</span>&nbsp;<span class="ident" id="8032580">w</span>&nbsp;<span class="op" id="8032582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8032586">t</span><span class="op" id="8032587">.</span><span class="ident" id="8032588">Errorf</span><span class="op" id="8032594">(</span><span class="string" id="8032595">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8032621">,</span>&nbsp;<span class="ident" id="8032623">g</span><span class="op" id="8032624">,</span>&nbsp;<span class="ident" id="8032626">w</span><span class="op" id="8032627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8032630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8032634">if</span>&nbsp;<span class="ident" id="8032637">n</span>&nbsp;<span class="op" id="8032639">:=</span>&nbsp;<span class="ident" id="8032642">db</span><span class="op" id="8032644">.</span><span class="ident" id="8032645">numDepsPollUntil</span><span class="op" id="8032661">(</span><span class="num" id="8032662">0</span><span class="op" id="8032663">,</span>&nbsp;<span class="ident" id="8032665">time</span><span class="op" id="8032669">.</span><span class="ident" id="8032670">Second</span><span class="op" id="8032676">)</span><span class="op" id="8032677">;</span>&nbsp;<span class="ident" id="8032679">n</span>&nbsp;<span class="op" id="8032681">&gt;</span>&nbsp;<span class="num" id="8032683">0</span>&nbsp;<span class="op" id="8032685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8032689">t</span><span class="op" id="8032690">.</span><span class="ident" id="8032691">Errorf</span><span class="op" id="8032697">(</span><span class="string" id="8032698">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="8032739">,</span>&nbsp;<span class="ident" id="8032741">n</span><span class="op" id="8032742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8032746">db</span><span class="op" id="8032748">.</span><span class="ident" id="8032749">dumpDeps</span><span class="op" id="8032757">(</span><span class="ident" id="8032758">t</span><span class="op" id="8032759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8032762">}</span><br>
<span class="lineno"></span><span class="op" id="8032764">}</span><br>
<span class="lineno">1200</span><br>
<span class="lineno"></span><span class="comment" id="8032767">//&nbsp;golang.org/issue/5046</span><br>
<span class="lineno"></span><span class="keyword" id="8032792">func</span>&nbsp;<span class="ident" id="8032797">TestCloseConnBeforeStmts</span><span class="op" id="8032821">(</span><span class="ident" id="8032822">t</span>&nbsp;<span class="op" id="8032824">*</span><span class="ident" id="8032825">testing</span><span class="op" id="8032832">.</span><span class="ident" id="8032833">T</span><span class="op" id="8032834">)</span>&nbsp;<span class="op" id="8032836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8032839">db</span>&nbsp;<span class="op" id="8032842">:=</span>&nbsp;<span class="ident" id="8032845">newTestDB</span><span class="op" id="8032854">(</span><span class="ident" id="8032855">t</span><span class="op" id="8032856">,</span>&nbsp;<span class="string" id="8032858">&#34;people&#34;</span><span class="op" id="8032866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8032869">defer</span>&nbsp;<span class="ident" id="8032875">closeDB</span><span class="op" id="8032882">(</span><span class="ident" id="8032883">t</span><span class="op" id="8032884">,</span>&nbsp;<span class="ident" id="8032886">db</span><span class="op" id="8032888">)</span><br>
<span class="lineno">1205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8032892">defer</span>&nbsp;<span class="ident" id="8032898">setHookpostCloseConn</span><span class="op" id="8032918">(</span><span class="builtintype" id="8032919">nil</span><span class="op" id="8032922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8032925">setHookpostCloseConn</span><span class="op" id="8032945">(</span><span class="keyword" id="8032946">func</span><span class="op" id="8032950">(</span><span class="ident" id="8032951">_</span>&nbsp;<span class="op" id="8032953">*</span><span class="ident" id="8032954">fakeConn</span><span class="op" id="8032962">,</span>&nbsp;<span class="ident" id="8032964">err</span>&nbsp;<span class="builtintype" id="8032968">error</span><span class="op" id="8032973">)</span>&nbsp;<span class="op" id="8032975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8032979">if</span>&nbsp;<span class="ident" id="8032982">err</span>&nbsp;<span class="op" id="8032986">!=</span>&nbsp;<span class="builtintype" id="8032989">nil</span>&nbsp;<span class="op" id="8032993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8032998">t</span><span class="op" id="8032999">.</span><span class="ident" id="8033000">Errorf</span><span class="op" id="8033006">(</span><span class="string" id="8033007">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v;&nbsp;from&nbsp;%s&#34;</span><span class="op" id="8033044">,</span>&nbsp;<span class="ident" id="8033046">err</span><span class="op" id="8033049">,</span>&nbsp;<span class="ident" id="8033051">stack</span><span class="op" id="8033056">(</span><span class="op" id="8033057">)</span><span class="op" id="8033058">)</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8033063">db</span><span class="op" id="8033065">.</span><span class="ident" id="8033066">dumpDeps</span><span class="op" id="8033074">(</span><span class="ident" id="8033075">t</span><span class="op" id="8033076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8033081">t</span><span class="op" id="8033082">.</span><span class="ident" id="8033083">Errorf</span><span class="op" id="8033089">(</span><span class="string" id="8033090">&#34;DB&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="8033100">,</span>&nbsp;<span class="ident" id="8033102">db</span><span class="op" id="8033104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8033108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8033111">}</span><span class="op" id="8033112">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8033116">stmt</span><span class="op" id="8033120">,</span>&nbsp;<span class="ident" id="8033122">err</span>&nbsp;<span class="op" id="8033126">:=</span>&nbsp;<span class="ident" id="8033129">db</span><span class="op" id="8033131">.</span><span class="ident" id="8033132">Prepare</span><span class="op" id="8033139">(</span><span class="string" id="8033140">&#34;SELECT|people|name|&#34;</span><span class="op" id="8033161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8033164">if</span>&nbsp;<span class="ident" id="8033167">err</span>&nbsp;<span class="op" id="8033171">!=</span>&nbsp;<span class="builtintype" id="8033174">nil</span>&nbsp;<span class="op" id="8033178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8033182">t</span><span class="op" id="8033183">.</span><span class="ident" id="8033184">Fatal</span><span class="op" id="8033189">(</span><span class="ident" id="8033190">err</span><span class="op" id="8033193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8033196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8033200">if</span>&nbsp;<span class="builtinfunc" id="8033203">len</span><span class="op" id="8033206">(</span><span class="ident" id="8033207">db</span><span class="op" id="8033209">.</span><span class="ident" id="8033210">freeConn</span><span class="op" id="8033218">)</span>&nbsp;<span class="op" id="8033220">!=</span>&nbsp;<span class="num" id="8033223">1</span>&nbsp;<span class="op" id="8033225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8033229">t</span><span class="op" id="8033230">.</span><span class="ident" id="8033231">Fatalf</span><span class="op" id="8033237">(</span><span class="string" id="8033238">&#34;expected&nbsp;1&nbsp;freeConn;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="8033267">,</span>&nbsp;<span class="builtinfunc" id="8033269">len</span><span class="op" id="8033272">(</span><span class="ident" id="8033273">db</span><span class="op" id="8033275">.</span><span class="ident" id="8033276">freeConn</span><span class="op" id="8033284">)</span><span class="op" id="8033285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8033288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8033291">dc</span>&nbsp;<span class="op" id="8033294">:=</span>&nbsp;<span class="ident" id="8033297">db</span><span class="op" id="8033299">.</span><span class="ident" id="8033300">freeConn</span><span class="op" id="8033308">[</span><span class="num" id="8033309">0</span><span class="op" id="8033310">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8033313">if</span>&nbsp;<span class="ident" id="8033316">dc</span><span class="op" id="8033318">.</span><span class="ident" id="8033319">closed</span>&nbsp;<span class="op" id="8033326">{</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8033330">t</span><span class="op" id="8033331">.</span><span class="ident" id="8033332">Errorf</span><span class="op" id="8033338">(</span><span class="string" id="8033339">&#34;conn&nbsp;shouldn&#39;t&nbsp;be&nbsp;closed&#34;</span><span class="op" id="8033365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8033368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8033372">if</span>&nbsp;<span class="ident" id="8033375">n</span>&nbsp;<span class="op" id="8033377">:=</span>&nbsp;<span class="builtinfunc" id="8033380">len</span><span class="op" id="8033383">(</span><span class="ident" id="8033384">dc</span><span class="op" id="8033386">.</span><span class="ident" id="8033387">openStmt</span><span class="op" id="8033395">)</span><span class="op" id="8033396">;</span>&nbsp;<span class="ident" id="8033398">n</span>&nbsp;<span class="op" id="8033400">!=</span>&nbsp;<span class="num" id="8033403">1</span>&nbsp;<span class="op" id="8033405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8033409">t</span><span class="op" id="8033410">.</span><span class="ident" id="8033411">Errorf</span><span class="op" id="8033417">(</span><span class="string" id="8033418">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="8033456">,</span>&nbsp;<span class="ident" id="8033458">n</span><span class="op" id="8033459">)</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8033462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8033465">err</span>&nbsp;<span class="op" id="8033469">=</span>&nbsp;<span class="ident" id="8033471">db</span><span class="op" id="8033473">.</span><span class="ident" id="8033474">Close</span><span class="op" id="8033479">(</span><span class="op" id="8033480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8033483">if</span>&nbsp;<span class="ident" id="8033486">err</span>&nbsp;<span class="op" id="8033490">!=</span>&nbsp;<span class="builtintype" id="8033493">nil</span>&nbsp;<span class="op" id="8033497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8033501">t</span><span class="op" id="8033502">.</span><span class="ident" id="8033503">Errorf</span><span class="op" id="8033509">(</span><span class="string" id="8033510">&#34;db&nbsp;Close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8033525">,</span>&nbsp;<span class="ident" id="8033527">err</span><span class="op" id="8033530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8033533">}</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8033536">if</span>&nbsp;<span class="op" id="8033539">!</span><span class="ident" id="8033540">dc</span><span class="op" id="8033542">.</span><span class="ident" id="8033543">closed</span>&nbsp;<span class="op" id="8033550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8033554">t</span><span class="op" id="8033555">.</span><span class="ident" id="8033556">Errorf</span><span class="op" id="8033562">(</span><span class="string" id="8033563">&#34;after&nbsp;db.Close,&nbsp;driverConn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="8033608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8033611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8033614">if</span>&nbsp;<span class="ident" id="8033617">n</span>&nbsp;<span class="op" id="8033619">:=</span>&nbsp;<span class="builtinfunc" id="8033622">len</span><span class="op" id="8033625">(</span><span class="ident" id="8033626">dc</span><span class="op" id="8033628">.</span><span class="ident" id="8033629">openStmt</span><span class="op" id="8033637">)</span><span class="op" id="8033638">;</span>&nbsp;<span class="ident" id="8033640">n</span>&nbsp;<span class="op" id="8033642">!=</span>&nbsp;<span class="num" id="8033645">0</span>&nbsp;<span class="op" id="8033647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8033651">t</span><span class="op" id="8033652">.</span><span class="ident" id="8033653">Errorf</span><span class="op" id="8033659">(</span><span class="string" id="8033660">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="8033698">,</span>&nbsp;<span class="ident" id="8033700">n</span><span class="op" id="8033701">)</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8033704">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8033708">err</span>&nbsp;<span class="op" id="8033712">=</span>&nbsp;<span class="ident" id="8033714">stmt</span><span class="op" id="8033718">.</span><span class="ident" id="8033719">Close</span><span class="op" id="8033724">(</span><span class="op" id="8033725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8033728">if</span>&nbsp;<span class="ident" id="8033731">err</span>&nbsp;<span class="op" id="8033735">!=</span>&nbsp;<span class="builtintype" id="8033738">nil</span>&nbsp;<span class="op" id="8033742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8033746">t</span><span class="op" id="8033747">.</span><span class="ident" id="8033748">Errorf</span><span class="op" id="8033754">(</span><span class="string" id="8033755">&#34;Stmt&nbsp;close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8033772">,</span>&nbsp;<span class="ident" id="8033774">err</span><span class="op" id="8033777">)</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8033780">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8033784">if</span>&nbsp;<span class="op" id="8033787">!</span><span class="ident" id="8033788">dc</span><span class="op" id="8033790">.</span><span class="ident" id="8033791">closed</span>&nbsp;<span class="op" id="8033798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8033802">t</span><span class="op" id="8033803">.</span><span class="ident" id="8033804">Errorf</span><span class="op" id="8033810">(</span><span class="string" id="8033811">&#34;conn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="8033834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8033837">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8033840">if</span>&nbsp;<span class="ident" id="8033843">dc</span><span class="op" id="8033845">.</span><span class="ident" id="8033846">ci</span>&nbsp;<span class="op" id="8033849">!=</span>&nbsp;<span class="builtintype" id="8033852">nil</span>&nbsp;<span class="op" id="8033856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8033860">t</span><span class="op" id="8033861">.</span><span class="ident" id="8033862">Errorf</span><span class="op" id="8033868">(</span><span class="string" id="8033869">&#34;after&nbsp;Stmt&nbsp;Close,&nbsp;driverConn&#39;s&nbsp;Conn&nbsp;interface&nbsp;should&nbsp;be&nbsp;nil&#34;</span><span class="op" id="8033930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8033933">}</span><br>
<span class="lineno"></span><span class="op" id="8033935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1255</span><span class="comment" id="8033938">//&nbsp;golang.org/issue/5283:&nbsp;don&#39;t&nbsp;release&nbsp;the&nbsp;Rows&#39;&nbsp;connection&nbsp;in&nbsp;Close</span><br>
<span class="lineno"></span><span class="comment" id="8034008">//&nbsp;before&nbsp;calling&nbsp;Stmt.Close.</span><br>
<span class="lineno"></span><span class="keyword" id="8034038">func</span>&nbsp;<span class="ident" id="8034043">TestRowsCloseOrder</span><span class="op" id="8034061">(</span><span class="ident" id="8034062">t</span>&nbsp;<span class="op" id="8034064">*</span><span class="ident" id="8034065">testing</span><span class="op" id="8034072">.</span><span class="ident" id="8034073">T</span><span class="op" id="8034074">)</span>&nbsp;<span class="op" id="8034076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8034079">db</span>&nbsp;<span class="op" id="8034082">:=</span>&nbsp;<span class="ident" id="8034085">newTestDB</span><span class="op" id="8034094">(</span><span class="ident" id="8034095">t</span><span class="op" id="8034096">,</span>&nbsp;<span class="string" id="8034098">&#34;people&#34;</span><span class="op" id="8034106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8034109">defer</span>&nbsp;<span class="ident" id="8034115">closeDB</span><span class="op" id="8034122">(</span><span class="ident" id="8034123">t</span><span class="op" id="8034124">,</span>&nbsp;<span class="ident" id="8034126">db</span><span class="op" id="8034128">)</span><br>
<span class="lineno">1260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8034132">db</span><span class="op" id="8034134">.</span><span class="ident" id="8034135">SetMaxIdleConns</span><span class="op" id="8034150">(</span><span class="num" id="8034151">0</span><span class="op" id="8034152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8034155">setStrictFakeConnClose</span><span class="op" id="8034177">(</span><span class="ident" id="8034178">t</span><span class="op" id="8034179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8034182">defer</span>&nbsp;<span class="ident" id="8034188">setStrictFakeConnClose</span><span class="op" id="8034210">(</span><span class="builtintype" id="8034211">nil</span><span class="op" id="8034214">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8034218">rows</span><span class="op" id="8034222">,</span>&nbsp;<span class="ident" id="8034224">err</span>&nbsp;<span class="op" id="8034228">:=</span>&nbsp;<span class="ident" id="8034231">db</span><span class="op" id="8034233">.</span><span class="ident" id="8034234">Query</span><span class="op" id="8034239">(</span><span class="string" id="8034240">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="8034265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8034268">if</span>&nbsp;<span class="ident" id="8034271">err</span>&nbsp;<span class="op" id="8034275">!=</span>&nbsp;<span class="builtintype" id="8034278">nil</span>&nbsp;<span class="op" id="8034282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8034286">t</span><span class="op" id="8034287">.</span><span class="ident" id="8034288">Fatal</span><span class="op" id="8034293">(</span><span class="ident" id="8034294">err</span><span class="op" id="8034297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8034300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8034303">err</span>&nbsp;<span class="op" id="8034307">=</span>&nbsp;<span class="ident" id="8034309">rows</span><span class="op" id="8034313">.</span><span class="ident" id="8034314">Close</span><span class="op" id="8034319">(</span><span class="op" id="8034320">)</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8034323">if</span>&nbsp;<span class="ident" id="8034326">err</span>&nbsp;<span class="op" id="8034330">!=</span>&nbsp;<span class="builtintype" id="8034333">nil</span>&nbsp;<span class="op" id="8034337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8034341">t</span><span class="op" id="8034342">.</span><span class="ident" id="8034343">Fatal</span><span class="op" id="8034348">(</span><span class="ident" id="8034349">err</span><span class="op" id="8034352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8034355">}</span><br>
<span class="lineno"></span><span class="op" id="8034357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1275</span><span class="keyword" id="8034360">func</span>&nbsp;<span class="ident" id="8034365">TestRowsImplicitClose</span><span class="op" id="8034386">(</span><span class="ident" id="8034387">t</span>&nbsp;<span class="op" id="8034389">*</span><span class="ident" id="8034390">testing</span><span class="op" id="8034397">.</span><span class="ident" id="8034398">T</span><span class="op" id="8034399">)</span>&nbsp;<span class="op" id="8034401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8034404">db</span>&nbsp;<span class="op" id="8034407">:=</span>&nbsp;<span class="ident" id="8034410">newTestDB</span><span class="op" id="8034419">(</span><span class="ident" id="8034420">t</span><span class="op" id="8034421">,</span>&nbsp;<span class="string" id="8034423">&#34;people&#34;</span><span class="op" id="8034431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8034434">defer</span>&nbsp;<span class="ident" id="8034440">closeDB</span><span class="op" id="8034447">(</span><span class="ident" id="8034448">t</span><span class="op" id="8034449">,</span>&nbsp;<span class="ident" id="8034451">db</span><span class="op" id="8034453">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8034457">rows</span><span class="op" id="8034461">,</span>&nbsp;<span class="ident" id="8034463">err</span>&nbsp;<span class="op" id="8034467">:=</span>&nbsp;<span class="ident" id="8034470">db</span><span class="op" id="8034472">.</span><span class="ident" id="8034473">Query</span><span class="op" id="8034478">(</span><span class="string" id="8034479">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="8034504">)</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8034507">if</span>&nbsp;<span class="ident" id="8034510">err</span>&nbsp;<span class="op" id="8034514">!=</span>&nbsp;<span class="builtintype" id="8034517">nil</span>&nbsp;<span class="op" id="8034521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8034525">t</span><span class="op" id="8034526">.</span><span class="ident" id="8034527">Fatal</span><span class="op" id="8034532">(</span><span class="ident" id="8034533">err</span><span class="op" id="8034536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8034539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8034543">want</span><span class="op" id="8034547">,</span>&nbsp;<span class="ident" id="8034549">fail</span>&nbsp;<span class="op" id="8034554">:=</span>&nbsp;<span class="num" id="8034557">2</span><span class="op" id="8034558">,</span>&nbsp;<span class="ident" id="8034560">errors</span><span class="op" id="8034566">.</span><span class="ident" id="8034567">New</span><span class="op" id="8034570">(</span><span class="string" id="8034571">&#34;fail&#34;</span><span class="op" id="8034577">)</span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8034580">r</span>&nbsp;<span class="op" id="8034582">:=</span>&nbsp;<span class="ident" id="8034585">rows</span><span class="op" id="8034589">.</span><span class="ident" id="8034590">rowsi</span><span class="op" id="8034595">.</span><span class="op" id="8034596">(</span><span class="op" id="8034597">*</span><span class="ident" id="8034598">rowsCursor</span><span class="op" id="8034608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8034611">r</span><span class="op" id="8034612">.</span><span class="ident" id="8034613">errPos</span><span class="op" id="8034619">,</span>&nbsp;<span class="ident" id="8034621">r</span><span class="op" id="8034622">.</span><span class="ident" id="8034623">err</span>&nbsp;<span class="op" id="8034627">=</span>&nbsp;<span class="ident" id="8034629">want</span><span class="op" id="8034633">,</span>&nbsp;<span class="ident" id="8034635">fail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8034642">got</span>&nbsp;<span class="op" id="8034646">:=</span>&nbsp;<span class="num" id="8034649">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8034652">for</span>&nbsp;<span class="ident" id="8034656">rows</span><span class="op" id="8034660">.</span><span class="ident" id="8034661">Next</span><span class="op" id="8034665">(</span><span class="op" id="8034666">)</span>&nbsp;<span class="op" id="8034668">{</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8034672">got</span><span class="op" id="8034675">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8034679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8034682">if</span>&nbsp;<span class="ident" id="8034685">got</span>&nbsp;<span class="op" id="8034689">!=</span>&nbsp;<span class="ident" id="8034692">want</span>&nbsp;<span class="op" id="8034697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8034701">t</span><span class="op" id="8034702">.</span><span class="ident" id="8034703">Errorf</span><span class="op" id="8034709">(</span><span class="string" id="8034710">&#34;got&nbsp;%d&nbsp;rows,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8034732">,</span>&nbsp;<span class="ident" id="8034734">got</span><span class="op" id="8034737">,</span>&nbsp;<span class="ident" id="8034739">want</span><span class="op" id="8034743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8034746">}</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8034749">if</span>&nbsp;<span class="ident" id="8034752">err</span>&nbsp;<span class="op" id="8034756">:=</span>&nbsp;<span class="ident" id="8034759">rows</span><span class="op" id="8034763">.</span><span class="ident" id="8034764">Err</span><span class="op" id="8034767">(</span><span class="op" id="8034768">)</span><span class="op" id="8034769">;</span>&nbsp;<span class="ident" id="8034771">err</span>&nbsp;<span class="op" id="8034775">!=</span>&nbsp;<span class="ident" id="8034778">fail</span>&nbsp;<span class="op" id="8034783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8034787">t</span><span class="op" id="8034788">.</span><span class="ident" id="8034789">Errorf</span><span class="op" id="8034795">(</span><span class="string" id="8034796">&#34;got&nbsp;error&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8034819">,</span>&nbsp;<span class="ident" id="8034821">err</span><span class="op" id="8034824">,</span>&nbsp;<span class="ident" id="8034826">fail</span><span class="op" id="8034830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8034833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8034836">if</span>&nbsp;<span class="op" id="8034839">!</span><span class="ident" id="8034840">r</span><span class="op" id="8034841">.</span><span class="ident" id="8034842">closed</span>&nbsp;<span class="op" id="8034849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8034853">t</span><span class="op" id="8034854">.</span><span class="ident" id="8034855">Errorf</span><span class="op" id="8034861">(</span><span class="string" id="8034862">&#34;r.closed&nbsp;is&nbsp;false,&nbsp;want&nbsp;true&#34;</span><span class="op" id="8034892">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8034895">}</span><br>
<span class="lineno"></span><span class="op" id="8034897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8034900">func</span>&nbsp;<span class="ident" id="8034905">TestStmtCloseOrder</span><span class="op" id="8034923">(</span><span class="ident" id="8034924">t</span>&nbsp;<span class="op" id="8034926">*</span><span class="ident" id="8034927">testing</span><span class="op" id="8034934">.</span><span class="ident" id="8034935">T</span><span class="op" id="8034936">)</span>&nbsp;<span class="op" id="8034938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8034941">db</span>&nbsp;<span class="op" id="8034944">:=</span>&nbsp;<span class="ident" id="8034947">newTestDB</span><span class="op" id="8034956">(</span><span class="ident" id="8034957">t</span><span class="op" id="8034958">,</span>&nbsp;<span class="string" id="8034960">&#34;people&#34;</span><span class="op" id="8034968">)</span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8034971">defer</span>&nbsp;<span class="ident" id="8034977">closeDB</span><span class="op" id="8034984">(</span><span class="ident" id="8034985">t</span><span class="op" id="8034986">,</span>&nbsp;<span class="ident" id="8034988">db</span><span class="op" id="8034990">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8034994">db</span><span class="op" id="8034996">.</span><span class="ident" id="8034997">SetMaxIdleConns</span><span class="op" id="8035012">(</span><span class="num" id="8035013">0</span><span class="op" id="8035014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8035017">setStrictFakeConnClose</span><span class="op" id="8035039">(</span><span class="ident" id="8035040">t</span><span class="op" id="8035041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8035044">defer</span>&nbsp;<span class="ident" id="8035050">setStrictFakeConnClose</span><span class="op" id="8035072">(</span><span class="builtintype" id="8035073">nil</span><span class="op" id="8035076">)</span><br>
<span class="lineno">1310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8035080">_</span><span class="op" id="8035081">,</span>&nbsp;<span class="ident" id="8035083">err</span>&nbsp;<span class="op" id="8035087">:=</span>&nbsp;<span class="ident" id="8035090">db</span><span class="op" id="8035092">.</span><span class="ident" id="8035093">Query</span><span class="op" id="8035098">(</span><span class="string" id="8035099">&#34;SELECT|non_existent|name|&#34;</span><span class="op" id="8035126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8035129">if</span>&nbsp;<span class="ident" id="8035132">err</span>&nbsp;<span class="op" id="8035136">==</span>&nbsp;<span class="builtintype" id="8035139">nil</span>&nbsp;<span class="op" id="8035143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8035147">t</span><span class="op" id="8035148">.</span><span class="ident" id="8035149">Fatal</span><span class="op" id="8035154">(</span><span class="string" id="8035155">&#34;Quering&nbsp;non-existent&nbsp;table&nbsp;should&nbsp;fail&#34;</span><span class="op" id="8035195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8035198">}</span><br>
<span class="lineno">1315</span><span class="op" id="8035200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8035203">//&nbsp;golang.org/issue/5781</span><br>
<span class="lineno"></span><span class="keyword" id="8035228">func</span>&nbsp;<span class="ident" id="8035233">TestErrBadConnReconnect</span><span class="op" id="8035256">(</span><span class="ident" id="8035257">t</span>&nbsp;<span class="op" id="8035259">*</span><span class="ident" id="8035260">testing</span><span class="op" id="8035267">.</span><span class="ident" id="8035268">T</span><span class="op" id="8035269">)</span>&nbsp;<span class="op" id="8035271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8035274">db</span>&nbsp;<span class="op" id="8035277">:=</span>&nbsp;<span class="ident" id="8035280">newTestDB</span><span class="op" id="8035289">(</span><span class="ident" id="8035290">t</span><span class="op" id="8035291">,</span>&nbsp;<span class="string" id="8035293">&#34;foo&#34;</span><span class="op" id="8035298">)</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8035301">defer</span>&nbsp;<span class="ident" id="8035307">closeDB</span><span class="op" id="8035314">(</span><span class="ident" id="8035315">t</span><span class="op" id="8035316">,</span>&nbsp;<span class="ident" id="8035318">db</span><span class="op" id="8035320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8035323">exec</span><span class="op" id="8035327">(</span><span class="ident" id="8035328">t</span><span class="op" id="8035329">,</span>&nbsp;<span class="ident" id="8035331">db</span><span class="op" id="8035333">,</span>&nbsp;<span class="string" id="8035335">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8035378">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8035382">simulateBadConn</span>&nbsp;<span class="op" id="8035398">:=</span>&nbsp;<span class="keyword" id="8035401">func</span><span class="op" id="8035405">(</span><span class="ident" id="8035406">name</span>&nbsp;<span class="builtintype" id="8035411">string</span><span class="op" id="8035417">,</span>&nbsp;<span class="ident" id="8035419">hook</span>&nbsp;<span class="op" id="8035424">*</span><span class="keyword" id="8035425">func</span><span class="op" id="8035429">(</span><span class="op" id="8035430">)</span>&nbsp;<span class="builtintype" id="8035432">bool</span><span class="op" id="8035436">,</span>&nbsp;<span class="ident" id="8035438">op</span>&nbsp;<span class="keyword" id="8035441">func</span><span class="op" id="8035445">(</span><span class="op" id="8035446">)</span>&nbsp;<span class="builtintype" id="8035448">error</span><span class="op" id="8035453">)</span>&nbsp;<span class="op" id="8035455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8035459">broken</span><span class="op" id="8035465">,</span>&nbsp;<span class="ident" id="8035467">retried</span>&nbsp;<span class="op" id="8035475">:=</span>&nbsp;<span class="builtintype" id="8035478">false</span><span class="op" id="8035483">,</span>&nbsp;<span class="builtintype" id="8035485">false</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8035493">numOpen</span>&nbsp;<span class="op" id="8035501">:=</span>&nbsp;<span class="ident" id="8035504">db</span><span class="op" id="8035506">.</span><span class="ident" id="8035507">numOpen</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8035518">//&nbsp;simulate&nbsp;a&nbsp;broken&nbsp;connection&nbsp;on&nbsp;the&nbsp;first&nbsp;try</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8035569">*</span><span class="ident" id="8035570">hook</span>&nbsp;<span class="op" id="8035575">=</span>&nbsp;<span class="keyword" id="8035577">func</span><span class="op" id="8035581">(</span><span class="op" id="8035582">)</span>&nbsp;<span class="builtintype" id="8035584">bool</span>&nbsp;<span class="op" id="8035589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8035594">if</span>&nbsp;<span class="op" id="8035597">!</span><span class="ident" id="8035598">broken</span>&nbsp;<span class="op" id="8035605">{</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8035611">broken</span>&nbsp;<span class="op" id="8035618">=</span>&nbsp;<span class="builtintype" id="8035620">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8035629">return</span>&nbsp;<span class="builtintype" id="8035636">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8035644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8035649">retried</span>&nbsp;<span class="op" id="8035657">=</span>&nbsp;<span class="builtintype" id="8035659">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8035667">return</span>&nbsp;<span class="builtintype" id="8035674">false</span><br>
<span class="lineno">1335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8035682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8035687">if</span>&nbsp;<span class="ident" id="8035690">err</span>&nbsp;<span class="op" id="8035694">:=</span>&nbsp;<span class="ident" id="8035697">op</span><span class="op" id="8035699">(</span><span class="op" id="8035700">)</span><span class="op" id="8035701">;</span>&nbsp;<span class="ident" id="8035703">err</span>&nbsp;<span class="op" id="8035707">!=</span>&nbsp;<span class="builtintype" id="8035710">nil</span>&nbsp;<span class="op" id="8035714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8035719">t</span><span class="op" id="8035720">.</span><span class="ident" id="8035721">Errorf</span><span class="op" id="8035727">(</span><span class="ident" id="8035728">name</span><span class="op" id="8035732">+</span><span class="string" id="8035733">&#34;:&nbsp;%v&#34;</span><span class="op" id="8035739">,</span>&nbsp;<span class="ident" id="8035741">err</span><span class="op" id="8035744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8035749">return</span><br>
<span class="lineno">1340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8035758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8035763">if</span>&nbsp;<span class="op" id="8035766">!</span><span class="ident" id="8035767">broken</span>&nbsp;<span class="op" id="8035774">||</span>&nbsp;<span class="op" id="8035777">!</span><span class="ident" id="8035778">retried</span>&nbsp;<span class="op" id="8035786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8035791">t</span><span class="op" id="8035792">.</span><span class="ident" id="8035793">Error</span><span class="op" id="8035798">(</span><span class="ident" id="8035799">name</span>&nbsp;<span class="op" id="8035804">+</span>&nbsp;<span class="string" id="8035806">&#34;:&nbsp;Failed&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="8035846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8035850">}</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8035854">*</span><span class="ident" id="8035855">hook</span>&nbsp;<span class="op" id="8035860">=</span>&nbsp;<span class="builtintype" id="8035862">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8035869">if</span>&nbsp;<span class="ident" id="8035872">numOpen</span>&nbsp;<span class="op" id="8035880">!=</span>&nbsp;<span class="ident" id="8035883">db</span><span class="op" id="8035885">.</span><span class="ident" id="8035886">numOpen</span>&nbsp;<span class="op" id="8035894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8035899">t</span><span class="op" id="8035900">.</span><span class="ident" id="8035901">Errorf</span><span class="op" id="8035907">(</span><span class="ident" id="8035908">name</span><span class="op" id="8035912">+</span><span class="string" id="8035913">&#34;:&nbsp;leaked&nbsp;%d&nbsp;connection(s)!&#34;</span><span class="op" id="8035941">,</span>&nbsp;<span class="ident" id="8035943">db</span><span class="op" id="8035945">.</span><span class="ident" id="8035946">numOpen</span><span class="op" id="8035953">-</span><span class="ident" id="8035954">numOpen</span><span class="op" id="8035961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8035966">numOpen</span>&nbsp;<span class="op" id="8035974">=</span>&nbsp;<span class="ident" id="8035976">db</span><span class="op" id="8035978">.</span><span class="ident" id="8035979">numOpen</span><br>
<span class="lineno">1350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8035989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8035992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8035996">//&nbsp;db.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8036008">dbExec</span>&nbsp;<span class="op" id="8036015">:=</span>&nbsp;<span class="keyword" id="8036018">func</span><span class="op" id="8036022">(</span><span class="op" id="8036023">)</span>&nbsp;<span class="builtintype" id="8036025">error</span>&nbsp;<span class="op" id="8036031">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8036035">_</span><span class="op" id="8036036">,</span>&nbsp;<span class="ident" id="8036038">err</span>&nbsp;<span class="op" id="8036042">:=</span>&nbsp;<span class="ident" id="8036045">db</span><span class="op" id="8036047">.</span><span class="ident" id="8036048">Exec</span><span class="op" id="8036052">(</span><span class="string" id="8036053">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="8036084">,</span>&nbsp;<span class="string" id="8036086">&#34;Gordon&#34;</span><span class="op" id="8036094">,</span>&nbsp;<span class="num" id="8036096">3</span><span class="op" id="8036097">,</span>&nbsp;<span class="builtintype" id="8036099">true</span><span class="op" id="8036103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8036107">return</span>&nbsp;<span class="ident" id="8036114">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8036119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8036122">simulateBadConn</span><span class="op" id="8036137">(</span><span class="string" id="8036138">&#34;db.Exec&nbsp;prepare&#34;</span><span class="op" id="8036155">,</span>&nbsp;<span class="op" id="8036157">&amp;</span><span class="ident" id="8036158">hookPrepareBadConn</span><span class="op" id="8036176">,</span>&nbsp;<span class="ident" id="8036178">dbExec</span><span class="op" id="8036184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8036187">simulateBadConn</span><span class="op" id="8036202">(</span><span class="string" id="8036203">&#34;db.Exec&nbsp;exec&#34;</span><span class="op" id="8036217">,</span>&nbsp;<span class="op" id="8036219">&amp;</span><span class="ident" id="8036220">hookExecBadConn</span><span class="op" id="8036235">,</span>&nbsp;<span class="ident" id="8036237">dbExec</span><span class="op" id="8036243">)</span><br>
<span class="lineno">1360</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8036247">//&nbsp;db.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8036260">dbQuery</span>&nbsp;<span class="op" id="8036268">:=</span>&nbsp;<span class="keyword" id="8036271">func</span><span class="op" id="8036275">(</span><span class="op" id="8036276">)</span>&nbsp;<span class="builtintype" id="8036278">error</span>&nbsp;<span class="op" id="8036284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8036288">rows</span><span class="op" id="8036292">,</span>&nbsp;<span class="ident" id="8036294">err</span>&nbsp;<span class="op" id="8036298">:=</span>&nbsp;<span class="ident" id="8036301">db</span><span class="op" id="8036303">.</span><span class="ident" id="8036304">Query</span><span class="op" id="8036309">(</span><span class="string" id="8036310">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="8036331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8036335">if</span>&nbsp;<span class="ident" id="8036338">err</span>&nbsp;<span class="op" id="8036342">==</span>&nbsp;<span class="builtintype" id="8036345">nil</span>&nbsp;<span class="op" id="8036349">{</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8036354">err</span>&nbsp;<span class="op" id="8036358">=</span>&nbsp;<span class="ident" id="8036360">rows</span><span class="op" id="8036364">.</span><span class="ident" id="8036365">Close</span><span class="op" id="8036370">(</span><span class="op" id="8036371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8036375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8036379">return</span>&nbsp;<span class="ident" id="8036386">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8036391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8036394">simulateBadConn</span><span class="op" id="8036409">(</span><span class="string" id="8036410">&#34;db.Query&nbsp;prepare&#34;</span><span class="op" id="8036428">,</span>&nbsp;<span class="op" id="8036430">&amp;</span><span class="ident" id="8036431">hookPrepareBadConn</span><span class="op" id="8036449">,</span>&nbsp;<span class="ident" id="8036451">dbQuery</span><span class="op" id="8036458">)</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8036461">simulateBadConn</span><span class="op" id="8036476">(</span><span class="string" id="8036477">&#34;db.Query&nbsp;query&#34;</span><span class="op" id="8036493">,</span>&nbsp;<span class="op" id="8036495">&amp;</span><span class="ident" id="8036496">hookQueryBadConn</span><span class="op" id="8036512">,</span>&nbsp;<span class="ident" id="8036514">dbQuery</span><span class="op" id="8036521">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8036525">//&nbsp;db.Prepare</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8036540">simulateBadConn</span><span class="op" id="8036555">(</span><span class="string" id="8036556">&#34;db.Prepare&#34;</span><span class="op" id="8036568">,</span>&nbsp;<span class="op" id="8036570">&amp;</span><span class="ident" id="8036571">hookPrepareBadConn</span><span class="op" id="8036589">,</span>&nbsp;<span class="keyword" id="8036591">func</span><span class="op" id="8036595">(</span><span class="op" id="8036596">)</span>&nbsp;<span class="builtintype" id="8036598">error</span>&nbsp;<span class="op" id="8036604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8036608">stmt</span><span class="op" id="8036612">,</span>&nbsp;<span class="ident" id="8036614">err</span>&nbsp;<span class="op" id="8036618">:=</span>&nbsp;<span class="ident" id="8036621">db</span><span class="op" id="8036623">.</span><span class="ident" id="8036624">Prepare</span><span class="op" id="8036631">(</span><span class="string" id="8036632">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="8036663">)</span><br>
<span class="lineno">1375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8036667">if</span>&nbsp;<span class="ident" id="8036670">err</span>&nbsp;<span class="op" id="8036674">!=</span>&nbsp;<span class="builtintype" id="8036677">nil</span>&nbsp;<span class="op" id="8036681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8036686">return</span>&nbsp;<span class="ident" id="8036693">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8036699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8036703">stmt</span><span class="op" id="8036707">.</span><span class="ident" id="8036708">Close</span><span class="op" id="8036713">(</span><span class="op" id="8036714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8036718">return</span>&nbsp;<span class="builtintype" id="8036725">nil</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8036730">}</span><span class="op" id="8036731">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8036735">//&nbsp;Provide&nbsp;a&nbsp;way&nbsp;to&nbsp;force&nbsp;a&nbsp;re-prepare&nbsp;of&nbsp;a&nbsp;statement&nbsp;on&nbsp;next&nbsp;execution</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8036808">forcePrepare</span>&nbsp;<span class="op" id="8036821">:=</span>&nbsp;<span class="keyword" id="8036824">func</span><span class="op" id="8036828">(</span><span class="ident" id="8036829">stmt</span>&nbsp;<span class="op" id="8036834">*</span><span class="ident" id="8036835">Stmt</span><span class="op" id="8036839">)</span>&nbsp;<span class="op" id="8036841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8036845">stmt</span><span class="op" id="8036849">.</span><span class="ident" id="8036850">css</span>&nbsp;<span class="op" id="8036854">=</span>&nbsp;<span class="builtintype" id="8036856">nil</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8036861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8036865">//&nbsp;stmt.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8036879">stmt1</span><span class="op" id="8036884">,</span>&nbsp;<span class="ident" id="8036886">err</span>&nbsp;<span class="op" id="8036890">:=</span>&nbsp;<span class="ident" id="8036893">db</span><span class="op" id="8036895">.</span><span class="ident" id="8036896">Prepare</span><span class="op" id="8036903">(</span><span class="string" id="8036904">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="8036935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8036938">if</span>&nbsp;<span class="ident" id="8036941">err</span>&nbsp;<span class="op" id="8036945">!=</span>&nbsp;<span class="builtintype" id="8036948">nil</span>&nbsp;<span class="op" id="8036952">{</span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8036956">t</span><span class="op" id="8036957">.</span><span class="ident" id="8036958">Fatalf</span><span class="op" id="8036964">(</span><span class="string" id="8036965">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="8036978">,</span>&nbsp;<span class="ident" id="8036980">err</span><span class="op" id="8036983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8036986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8036989">defer</span>&nbsp;<span class="ident" id="8036995">stmt1</span><span class="op" id="8037000">.</span><span class="ident" id="8037001">Close</span><span class="op" id="8037006">(</span><span class="op" id="8037007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8037010">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8037055">forcePrepare</span><span class="op" id="8037067">(</span><span class="ident" id="8037068">stmt1</span><span class="op" id="8037073">)</span><br>
<span class="lineno">1395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8037077">stmtExec</span>&nbsp;<span class="op" id="8037086">:=</span>&nbsp;<span class="keyword" id="8037089">func</span><span class="op" id="8037093">(</span><span class="op" id="8037094">)</span>&nbsp;<span class="builtintype" id="8037096">error</span>&nbsp;<span class="op" id="8037102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8037106">_</span><span class="op" id="8037107">,</span>&nbsp;<span class="ident" id="8037109">err</span>&nbsp;<span class="op" id="8037113">:=</span>&nbsp;<span class="ident" id="8037116">stmt1</span><span class="op" id="8037121">.</span><span class="ident" id="8037122">Exec</span><span class="op" id="8037126">(</span><span class="string" id="8037127">&#34;Gopher&#34;</span><span class="op" id="8037135">,</span>&nbsp;<span class="num" id="8037137">3</span><span class="op" id="8037138">,</span>&nbsp;<span class="builtintype" id="8037140">false</span><span class="op" id="8037145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8037149">return</span>&nbsp;<span class="ident" id="8037156">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8037161">}</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8037164">simulateBadConn</span><span class="op" id="8037179">(</span><span class="string" id="8037180">&#34;stmt.Exec&nbsp;prepare&#34;</span><span class="op" id="8037199">,</span>&nbsp;<span class="op" id="8037201">&amp;</span><span class="ident" id="8037202">hookPrepareBadConn</span><span class="op" id="8037220">,</span>&nbsp;<span class="ident" id="8037222">stmtExec</span><span class="op" id="8037230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8037233">simulateBadConn</span><span class="op" id="8037248">(</span><span class="string" id="8037249">&#34;stmt.Exec&nbsp;exec&#34;</span><span class="op" id="8037265">,</span>&nbsp;<span class="op" id="8037267">&amp;</span><span class="ident" id="8037268">hookExecBadConn</span><span class="op" id="8037283">,</span>&nbsp;<span class="ident" id="8037285">stmtExec</span><span class="op" id="8037293">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8037297">//&nbsp;stmt.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8037312">stmt2</span><span class="op" id="8037317">,</span>&nbsp;<span class="ident" id="8037319">err</span>&nbsp;<span class="op" id="8037323">:=</span>&nbsp;<span class="ident" id="8037326">db</span><span class="op" id="8037328">.</span><span class="ident" id="8037329">Prepare</span><span class="op" id="8037336">(</span><span class="string" id="8037337">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="8037358">)</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8037361">if</span>&nbsp;<span class="ident" id="8037364">err</span>&nbsp;<span class="op" id="8037368">!=</span>&nbsp;<span class="builtintype" id="8037371">nil</span>&nbsp;<span class="op" id="8037375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8037379">t</span><span class="op" id="8037380">.</span><span class="ident" id="8037381">Fatalf</span><span class="op" id="8037387">(</span><span class="string" id="8037388">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="8037401">,</span>&nbsp;<span class="ident" id="8037403">err</span><span class="op" id="8037406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8037409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8037412">defer</span>&nbsp;<span class="ident" id="8037418">stmt2</span><span class="op" id="8037423">.</span><span class="ident" id="8037424">Close</span><span class="op" id="8037429">(</span><span class="op" id="8037430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8037433">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8037478">forcePrepare</span><span class="op" id="8037490">(</span><span class="ident" id="8037491">stmt2</span><span class="op" id="8037496">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8037500">stmtQuery</span>&nbsp;<span class="op" id="8037510">:=</span>&nbsp;<span class="keyword" id="8037513">func</span><span class="op" id="8037517">(</span><span class="op" id="8037518">)</span>&nbsp;<span class="builtintype" id="8037520">error</span>&nbsp;<span class="op" id="8037526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8037530">rows</span><span class="op" id="8037534">,</span>&nbsp;<span class="ident" id="8037536">err</span>&nbsp;<span class="op" id="8037540">:=</span>&nbsp;<span class="ident" id="8037543">stmt2</span><span class="op" id="8037548">.</span><span class="ident" id="8037549">Query</span><span class="op" id="8037554">(</span><span class="op" id="8037555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8037559">if</span>&nbsp;<span class="ident" id="8037562">err</span>&nbsp;<span class="op" id="8037566">==</span>&nbsp;<span class="builtintype" id="8037569">nil</span>&nbsp;<span class="op" id="8037573">{</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8037578">err</span>&nbsp;<span class="op" id="8037582">=</span>&nbsp;<span class="ident" id="8037584">rows</span><span class="op" id="8037588">.</span><span class="ident" id="8037589">Close</span><span class="op" id="8037594">(</span><span class="op" id="8037595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8037599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8037603">return</span>&nbsp;<span class="ident" id="8037610">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8037615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8037618">simulateBadConn</span><span class="op" id="8037633">(</span><span class="string" id="8037634">&#34;stmt.Query&nbsp;prepare&#34;</span><span class="op" id="8037654">,</span>&nbsp;<span class="op" id="8037656">&amp;</span><span class="ident" id="8037657">hookPrepareBadConn</span><span class="op" id="8037675">,</span>&nbsp;<span class="ident" id="8037677">stmtQuery</span><span class="op" id="8037686">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8037689">simulateBadConn</span><span class="op" id="8037704">(</span><span class="string" id="8037705">&#34;stmt.Query&nbsp;exec&#34;</span><span class="op" id="8037722">,</span>&nbsp;<span class="op" id="8037724">&amp;</span><span class="ident" id="8037725">hookQueryBadConn</span><span class="op" id="8037741">,</span>&nbsp;<span class="ident" id="8037743">stmtQuery</span><span class="op" id="8037752">)</span><br>
<span class="lineno"></span><span class="op" id="8037754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8037757">type</span>&nbsp;<span class="ident" id="8037762">concurrentTest</span>&nbsp;<span class="keyword" id="8037777">interface</span>&nbsp;<span class="op" id="8037787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8037790">init</span><span class="op" id="8037794">(</span><span class="ident" id="8037795">t</span>&nbsp;<span class="ident" id="8037797">testing</span><span class="op" id="8037804">.</span><span class="ident" id="8037805">TB</span><span class="op" id="8037807">,</span>&nbsp;<span class="ident" id="8037809">db</span>&nbsp;<span class="op" id="8037812">*</span><span class="ident" id="8037813">DB</span><span class="op" id="8037815">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8037818">finish</span><span class="op" id="8037824">(</span><span class="ident" id="8037825">t</span>&nbsp;<span class="ident" id="8037827">testing</span><span class="op" id="8037834">.</span><span class="ident" id="8037835">TB</span><span class="op" id="8037837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8037840">test</span><span class="op" id="8037844">(</span><span class="ident" id="8037845">t</span>&nbsp;<span class="ident" id="8037847">testing</span><span class="op" id="8037854">.</span><span class="ident" id="8037855">TB</span><span class="op" id="8037857">)</span>&nbsp;<span class="builtintype" id="8037859">error</span><br>
<span class="lineno"></span><span class="op" id="8037865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8037868">type</span>&nbsp;<span class="ident" id="8037873">concurrentDBQueryTest</span>&nbsp;<span class="keyword" id="8037895">struct</span>&nbsp;<span class="op" id="8037902">{</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8037905">db</span>&nbsp;<span class="op" id="8037908">*</span><span class="ident" id="8037909">DB</span><br>
<span class="lineno"></span><span class="op" id="8037912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8037915">func</span>&nbsp;<span class="op" id="8037920">(</span><span class="ident" id="8037921">c</span>&nbsp;<span class="op" id="8037923">*</span><span class="ident" id="8037924">concurrentDBQueryTest</span><span class="op" id="8037945">)</span>&nbsp;<span class="ident" id="8037947">init</span><span class="op" id="8037951">(</span><span class="ident" id="8037952">t</span>&nbsp;<span class="ident" id="8037954">testing</span><span class="op" id="8037961">.</span><span class="ident" id="8037962">TB</span><span class="op" id="8037964">,</span>&nbsp;<span class="ident" id="8037966">db</span>&nbsp;<span class="op" id="8037969">*</span><span class="ident" id="8037970">DB</span><span class="op" id="8037972">)</span>&nbsp;<span class="op" id="8037974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8037977">c</span><span class="op" id="8037978">.</span><span class="ident" id="8037979">db</span>&nbsp;<span class="op" id="8037982">=</span>&nbsp;<span class="ident" id="8037984">db</span><br>
<span class="lineno">1435</span><span class="op" id="8037987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8037990">func</span>&nbsp;<span class="op" id="8037995">(</span><span class="ident" id="8037996">c</span>&nbsp;<span class="op" id="8037998">*</span><span class="ident" id="8037999">concurrentDBQueryTest</span><span class="op" id="8038020">)</span>&nbsp;<span class="ident" id="8038022">finish</span><span class="op" id="8038028">(</span><span class="ident" id="8038029">t</span>&nbsp;<span class="ident" id="8038031">testing</span><span class="op" id="8038038">.</span><span class="ident" id="8038039">TB</span><span class="op" id="8038041">)</span>&nbsp;<span class="op" id="8038043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8038046">c</span><span class="op" id="8038047">.</span><span class="ident" id="8038048">db</span>&nbsp;<span class="op" id="8038051">=</span>&nbsp;<span class="builtintype" id="8038053">nil</span><br>
<span class="lineno"></span><span class="op" id="8038057">}</span><br>
<span class="lineno">1440</span><br>
<span class="lineno"></span><span class="keyword" id="8038060">func</span>&nbsp;<span class="op" id="8038065">(</span><span class="ident" id="8038066">c</span>&nbsp;<span class="op" id="8038068">*</span><span class="ident" id="8038069">concurrentDBQueryTest</span><span class="op" id="8038090">)</span>&nbsp;<span class="ident" id="8038092">test</span><span class="op" id="8038096">(</span><span class="ident" id="8038097">t</span>&nbsp;<span class="ident" id="8038099">testing</span><span class="op" id="8038106">.</span><span class="ident" id="8038107">TB</span><span class="op" id="8038109">)</span>&nbsp;<span class="builtintype" id="8038111">error</span>&nbsp;<span class="op" id="8038117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8038120">rows</span><span class="op" id="8038124">,</span>&nbsp;<span class="ident" id="8038126">err</span>&nbsp;<span class="op" id="8038130">:=</span>&nbsp;<span class="ident" id="8038133">c</span><span class="op" id="8038134">.</span><span class="ident" id="8038135">db</span><span class="op" id="8038137">.</span><span class="ident" id="8038138">Query</span><span class="op" id="8038143">(</span><span class="string" id="8038144">&#34;SELECT|people|name|&#34;</span><span class="op" id="8038165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8038168">if</span>&nbsp;<span class="ident" id="8038171">err</span>&nbsp;<span class="op" id="8038175">!=</span>&nbsp;<span class="builtintype" id="8038178">nil</span>&nbsp;<span class="op" id="8038182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8038186">t</span><span class="op" id="8038187">.</span><span class="ident" id="8038188">Error</span><span class="op" id="8038193">(</span><span class="ident" id="8038194">err</span><span class="op" id="8038197">)</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8038201">return</span>&nbsp;<span class="ident" id="8038208">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8038213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8038216">var</span>&nbsp;<span class="ident" id="8038220">name</span>&nbsp;<span class="builtintype" id="8038225">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8038233">for</span>&nbsp;<span class="ident" id="8038237">rows</span><span class="op" id="8038241">.</span><span class="ident" id="8038242">Next</span><span class="op" id="8038246">(</span><span class="op" id="8038247">)</span>&nbsp;<span class="op" id="8038249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8038253">rows</span><span class="op" id="8038257">.</span><span class="ident" id="8038258">Scan</span><span class="op" id="8038262">(</span><span class="op" id="8038263">&amp;</span><span class="ident" id="8038264">name</span><span class="op" id="8038268">)</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8038271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8038274">rows</span><span class="op" id="8038278">.</span><span class="ident" id="8038279">Close</span><span class="op" id="8038284">(</span><span class="op" id="8038285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8038288">return</span>&nbsp;<span class="builtintype" id="8038295">nil</span><br>
<span class="lineno"></span><span class="op" id="8038299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1455</span><span class="keyword" id="8038302">type</span>&nbsp;<span class="ident" id="8038307">concurrentDBExecTest</span>&nbsp;<span class="keyword" id="8038328">struct</span>&nbsp;<span class="op" id="8038335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8038338">db</span>&nbsp;<span class="op" id="8038341">*</span><span class="ident" id="8038342">DB</span><br>
<span class="lineno"></span><span class="op" id="8038345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8038348">func</span>&nbsp;<span class="op" id="8038353">(</span><span class="ident" id="8038354">c</span>&nbsp;<span class="op" id="8038356">*</span><span class="ident" id="8038357">concurrentDBExecTest</span><span class="op" id="8038377">)</span>&nbsp;<span class="ident" id="8038379">init</span><span class="op" id="8038383">(</span><span class="ident" id="8038384">t</span>&nbsp;<span class="ident" id="8038386">testing</span><span class="op" id="8038393">.</span><span class="ident" id="8038394">TB</span><span class="op" id="8038396">,</span>&nbsp;<span class="ident" id="8038398">db</span>&nbsp;<span class="op" id="8038401">*</span><span class="ident" id="8038402">DB</span><span class="op" id="8038404">)</span>&nbsp;<span class="op" id="8038406">{</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8038409">c</span><span class="op" id="8038410">.</span><span class="ident" id="8038411">db</span>&nbsp;<span class="op" id="8038414">=</span>&nbsp;<span class="ident" id="8038416">db</span><br>
<span class="lineno"></span><span class="op" id="8038419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8038422">func</span>&nbsp;<span class="op" id="8038427">(</span><span class="ident" id="8038428">c</span>&nbsp;<span class="op" id="8038430">*</span><span class="ident" id="8038431">concurrentDBExecTest</span><span class="op" id="8038451">)</span>&nbsp;<span class="ident" id="8038453">finish</span><span class="op" id="8038459">(</span><span class="ident" id="8038460">t</span>&nbsp;<span class="ident" id="8038462">testing</span><span class="op" id="8038469">.</span><span class="ident" id="8038470">TB</span><span class="op" id="8038472">)</span>&nbsp;<span class="op" id="8038474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8038477">c</span><span class="op" id="8038478">.</span><span class="ident" id="8038479">db</span>&nbsp;<span class="op" id="8038482">=</span>&nbsp;<span class="builtintype" id="8038484">nil</span><br>
<span class="lineno">1465</span><span class="op" id="8038488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8038491">func</span>&nbsp;<span class="op" id="8038496">(</span><span class="ident" id="8038497">c</span>&nbsp;<span class="op" id="8038499">*</span><span class="ident" id="8038500">concurrentDBExecTest</span><span class="op" id="8038520">)</span>&nbsp;<span class="ident" id="8038522">test</span><span class="op" id="8038526">(</span><span class="ident" id="8038527">t</span>&nbsp;<span class="ident" id="8038529">testing</span><span class="op" id="8038536">.</span><span class="ident" id="8038537">TB</span><span class="op" id="8038539">)</span>&nbsp;<span class="builtintype" id="8038541">error</span>&nbsp;<span class="op" id="8038547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8038550">_</span><span class="op" id="8038551">,</span>&nbsp;<span class="ident" id="8038553">err</span>&nbsp;<span class="op" id="8038557">:=</span>&nbsp;<span class="ident" id="8038560">c</span><span class="op" id="8038561">.</span><span class="ident" id="8038562">db</span><span class="op" id="8038564">.</span><span class="ident" id="8038565">Exec</span><span class="op" id="8038569">(</span><span class="string" id="8038570">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="8038623">,</span>&nbsp;<span class="num" id="8038625">3</span><span class="op" id="8038626">,</span>&nbsp;<span class="ident" id="8038628">chrisBirthday</span><span class="op" id="8038641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8038644">if</span>&nbsp;<span class="ident" id="8038647">err</span>&nbsp;<span class="op" id="8038651">!=</span>&nbsp;<span class="builtintype" id="8038654">nil</span>&nbsp;<span class="op" id="8038658">{</span><br>
<span class="lineno">1470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8038662">t</span><span class="op" id="8038663">.</span><span class="ident" id="8038664">Error</span><span class="op" id="8038669">(</span><span class="ident" id="8038670">err</span><span class="op" id="8038673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8038677">return</span>&nbsp;<span class="ident" id="8038684">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8038689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8038692">return</span>&nbsp;<span class="builtintype" id="8038699">nil</span><br>
<span class="lineno"></span><span class="op" id="8038703">}</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span><span class="keyword" id="8038706">type</span>&nbsp;<span class="ident" id="8038711">concurrentStmtQueryTest</span>&nbsp;<span class="keyword" id="8038735">struct</span>&nbsp;<span class="op" id="8038742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8038745">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8038750">*</span><span class="ident" id="8038751">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8038755">stmt</span>&nbsp;<span class="op" id="8038760">*</span><span class="ident" id="8038761">Stmt</span><br>
<span class="lineno"></span><span class="op" id="8038766">}</span><br>
<span class="lineno">1480</span><br>
<span class="lineno"></span><span class="keyword" id="8038769">func</span>&nbsp;<span class="op" id="8038774">(</span><span class="ident" id="8038775">c</span>&nbsp;<span class="op" id="8038777">*</span><span class="ident" id="8038778">concurrentStmtQueryTest</span><span class="op" id="8038801">)</span>&nbsp;<span class="ident" id="8038803">init</span><span class="op" id="8038807">(</span><span class="ident" id="8038808">t</span>&nbsp;<span class="ident" id="8038810">testing</span><span class="op" id="8038817">.</span><span class="ident" id="8038818">TB</span><span class="op" id="8038820">,</span>&nbsp;<span class="ident" id="8038822">db</span>&nbsp;<span class="op" id="8038825">*</span><span class="ident" id="8038826">DB</span><span class="op" id="8038828">)</span>&nbsp;<span class="op" id="8038830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8038833">c</span><span class="op" id="8038834">.</span><span class="ident" id="8038835">db</span>&nbsp;<span class="op" id="8038838">=</span>&nbsp;<span class="ident" id="8038840">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8038844">var</span>&nbsp;<span class="ident" id="8038848">err</span>&nbsp;<span class="builtintype" id="8038852">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8038859">c</span><span class="op" id="8038860">.</span><span class="ident" id="8038861">stmt</span><span class="op" id="8038865">,</span>&nbsp;<span class="ident" id="8038867">err</span>&nbsp;<span class="op" id="8038871">=</span>&nbsp;<span class="ident" id="8038873">db</span><span class="op" id="8038875">.</span><span class="ident" id="8038876">Prepare</span><span class="op" id="8038883">(</span><span class="string" id="8038884">&#34;SELECT|people|name|&#34;</span><span class="op" id="8038905">)</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8038908">if</span>&nbsp;<span class="ident" id="8038911">err</span>&nbsp;<span class="op" id="8038915">!=</span>&nbsp;<span class="builtintype" id="8038918">nil</span>&nbsp;<span class="op" id="8038922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8038926">t</span><span class="op" id="8038927">.</span><span class="ident" id="8038928">Fatal</span><span class="op" id="8038933">(</span><span class="ident" id="8038934">err</span><span class="op" id="8038937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8038940">}</span><br>
<span class="lineno"></span><span class="op" id="8038942">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1490</span><span class="keyword" id="8038945">func</span>&nbsp;<span class="op" id="8038950">(</span><span class="ident" id="8038951">c</span>&nbsp;<span class="op" id="8038953">*</span><span class="ident" id="8038954">concurrentStmtQueryTest</span><span class="op" id="8038977">)</span>&nbsp;<span class="ident" id="8038979">finish</span><span class="op" id="8038985">(</span><span class="ident" id="8038986">t</span>&nbsp;<span class="ident" id="8038988">testing</span><span class="op" id="8038995">.</span><span class="ident" id="8038996">TB</span><span class="op" id="8038998">)</span>&nbsp;<span class="op" id="8039000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8039003">if</span>&nbsp;<span class="ident" id="8039006">c</span><span class="op" id="8039007">.</span><span class="ident" id="8039008">stmt</span>&nbsp;<span class="op" id="8039013">!=</span>&nbsp;<span class="builtintype" id="8039016">nil</span>&nbsp;<span class="op" id="8039020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8039024">c</span><span class="op" id="8039025">.</span><span class="ident" id="8039026">stmt</span><span class="op" id="8039030">.</span><span class="ident" id="8039031">Close</span><span class="op" id="8039036">(</span><span class="op" id="8039037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8039041">c</span><span class="op" id="8039042">.</span><span class="ident" id="8039043">stmt</span>&nbsp;<span class="op" id="8039048">=</span>&nbsp;<span class="builtintype" id="8039050">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8039055">}</span><br>
<span class="lineno">1495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8039058">c</span><span class="op" id="8039059">.</span><span class="ident" id="8039060">db</span>&nbsp;<span class="op" id="8039063">=</span>&nbsp;<span class="builtintype" id="8039065">nil</span><br>
<span class="lineno"></span><span class="op" id="8039069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8039072">func</span>&nbsp;<span class="op" id="8039077">(</span><span class="ident" id="8039078">c</span>&nbsp;<span class="op" id="8039080">*</span><span class="ident" id="8039081">concurrentStmtQueryTest</span><span class="op" id="8039104">)</span>&nbsp;<span class="ident" id="8039106">test</span><span class="op" id="8039110">(</span><span class="ident" id="8039111">t</span>&nbsp;<span class="ident" id="8039113">testing</span><span class="op" id="8039120">.</span><span class="ident" id="8039121">TB</span><span class="op" id="8039123">)</span>&nbsp;<span class="builtintype" id="8039125">error</span>&nbsp;<span class="op" id="8039131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8039134">rows</span><span class="op" id="8039138">,</span>&nbsp;<span class="ident" id="8039140">err</span>&nbsp;<span class="op" id="8039144">:=</span>&nbsp;<span class="ident" id="8039147">c</span><span class="op" id="8039148">.</span><span class="ident" id="8039149">stmt</span><span class="op" id="8039153">.</span><span class="ident" id="8039154">Query</span><span class="op" id="8039159">(</span><span class="op" id="8039160">)</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8039163">if</span>&nbsp;<span class="ident" id="8039166">err</span>&nbsp;<span class="op" id="8039170">!=</span>&nbsp;<span class="builtintype" id="8039173">nil</span>&nbsp;<span class="op" id="8039177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8039181">t</span><span class="op" id="8039182">.</span><span class="ident" id="8039183">Errorf</span><span class="op" id="8039189">(</span><span class="string" id="8039190">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="8039211">,</span>&nbsp;<span class="ident" id="8039213">err</span><span class="op" id="8039216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8039220">return</span>&nbsp;<span class="ident" id="8039227">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8039232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8039236">var</span>&nbsp;<span class="ident" id="8039240">name</span>&nbsp;<span class="builtintype" id="8039245">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8039253">for</span>&nbsp;<span class="ident" id="8039257">rows</span><span class="op" id="8039261">.</span><span class="ident" id="8039262">Next</span><span class="op" id="8039266">(</span><span class="op" id="8039267">)</span>&nbsp;<span class="op" id="8039269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8039273">rows</span><span class="op" id="8039277">.</span><span class="ident" id="8039278">Scan</span><span class="op" id="8039282">(</span><span class="op" id="8039283">&amp;</span><span class="ident" id="8039284">name</span><span class="op" id="8039288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8039291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8039294">rows</span><span class="op" id="8039298">.</span><span class="ident" id="8039299">Close</span><span class="op" id="8039304">(</span><span class="op" id="8039305">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8039308">return</span>&nbsp;<span class="builtintype" id="8039315">nil</span><br>
<span class="lineno"></span><span class="op" id="8039319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8039322">type</span>&nbsp;<span class="ident" id="8039327">concurrentStmtExecTest</span>&nbsp;<span class="keyword" id="8039350">struct</span>&nbsp;<span class="op" id="8039357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8039360">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8039365">*</span><span class="ident" id="8039366">DB</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8039370">stmt</span>&nbsp;<span class="op" id="8039375">*</span><span class="ident" id="8039376">Stmt</span><br>
<span class="lineno"></span><span class="op" id="8039381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8039384">func</span>&nbsp;<span class="op" id="8039389">(</span><span class="ident" id="8039390">c</span>&nbsp;<span class="op" id="8039392">*</span><span class="ident" id="8039393">concurrentStmtExecTest</span><span class="op" id="8039415">)</span>&nbsp;<span class="ident" id="8039417">init</span><span class="op" id="8039421">(</span><span class="ident" id="8039422">t</span>&nbsp;<span class="ident" id="8039424">testing</span><span class="op" id="8039431">.</span><span class="ident" id="8039432">TB</span><span class="op" id="8039434">,</span>&nbsp;<span class="ident" id="8039436">db</span>&nbsp;<span class="op" id="8039439">*</span><span class="ident" id="8039440">DB</span><span class="op" id="8039442">)</span>&nbsp;<span class="op" id="8039444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8039447">c</span><span class="op" id="8039448">.</span><span class="ident" id="8039449">db</span>&nbsp;<span class="op" id="8039452">=</span>&nbsp;<span class="ident" id="8039454">db</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8039458">var</span>&nbsp;<span class="ident" id="8039462">err</span>&nbsp;<span class="builtintype" id="8039466">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8039473">c</span><span class="op" id="8039474">.</span><span class="ident" id="8039475">stmt</span><span class="op" id="8039479">,</span>&nbsp;<span class="ident" id="8039481">err</span>&nbsp;<span class="op" id="8039485">=</span>&nbsp;<span class="ident" id="8039487">db</span><span class="op" id="8039489">.</span><span class="ident" id="8039490">Prepare</span><span class="op" id="8039497">(</span><span class="string" id="8039498">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="8039551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8039554">if</span>&nbsp;<span class="ident" id="8039557">err</span>&nbsp;<span class="op" id="8039561">!=</span>&nbsp;<span class="builtintype" id="8039564">nil</span>&nbsp;<span class="op" id="8039568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8039572">t</span><span class="op" id="8039573">.</span><span class="ident" id="8039574">Fatal</span><span class="op" id="8039579">(</span><span class="ident" id="8039580">err</span><span class="op" id="8039583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8039586">}</span><br>
<span class="lineno">1525</span><span class="op" id="8039588">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8039591">func</span>&nbsp;<span class="op" id="8039596">(</span><span class="ident" id="8039597">c</span>&nbsp;<span class="op" id="8039599">*</span><span class="ident" id="8039600">concurrentStmtExecTest</span><span class="op" id="8039622">)</span>&nbsp;<span class="ident" id="8039624">finish</span><span class="op" id="8039630">(</span><span class="ident" id="8039631">t</span>&nbsp;<span class="ident" id="8039633">testing</span><span class="op" id="8039640">.</span><span class="ident" id="8039641">TB</span><span class="op" id="8039643">)</span>&nbsp;<span class="op" id="8039645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8039648">if</span>&nbsp;<span class="ident" id="8039651">c</span><span class="op" id="8039652">.</span><span class="ident" id="8039653">stmt</span>&nbsp;<span class="op" id="8039658">!=</span>&nbsp;<span class="builtintype" id="8039661">nil</span>&nbsp;<span class="op" id="8039665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8039669">c</span><span class="op" id="8039670">.</span><span class="ident" id="8039671">stmt</span><span class="op" id="8039675">.</span><span class="ident" id="8039676">Close</span><span class="op" id="8039681">(</span><span class="op" id="8039682">)</span><br>
<span class="lineno">1530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8039686">c</span><span class="op" id="8039687">.</span><span class="ident" id="8039688">stmt</span>&nbsp;<span class="op" id="8039693">=</span>&nbsp;<span class="builtintype" id="8039695">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8039700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8039703">c</span><span class="op" id="8039704">.</span><span class="ident" id="8039705">db</span>&nbsp;<span class="op" id="8039708">=</span>&nbsp;<span class="builtintype" id="8039710">nil</span><br>
<span class="lineno"></span><span class="op" id="8039714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1535</span><span class="keyword" id="8039717">func</span>&nbsp;<span class="op" id="8039722">(</span><span class="ident" id="8039723">c</span>&nbsp;<span class="op" id="8039725">*</span><span class="ident" id="8039726">concurrentStmtExecTest</span><span class="op" id="8039748">)</span>&nbsp;<span class="ident" id="8039750">test</span><span class="op" id="8039754">(</span><span class="ident" id="8039755">t</span>&nbsp;<span class="ident" id="8039757">testing</span><span class="op" id="8039764">.</span><span class="ident" id="8039765">TB</span><span class="op" id="8039767">)</span>&nbsp;<span class="builtintype" id="8039769">error</span>&nbsp;<span class="op" id="8039775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8039778">_</span><span class="op" id="8039779">,</span>&nbsp;<span class="ident" id="8039781">err</span>&nbsp;<span class="op" id="8039785">:=</span>&nbsp;<span class="ident" id="8039788">c</span><span class="op" id="8039789">.</span><span class="ident" id="8039790">stmt</span><span class="op" id="8039794">.</span><span class="ident" id="8039795">Exec</span><span class="op" id="8039799">(</span><span class="num" id="8039800">3</span><span class="op" id="8039801">,</span>&nbsp;<span class="ident" id="8039803">chrisBirthday</span><span class="op" id="8039816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8039819">if</span>&nbsp;<span class="ident" id="8039822">err</span>&nbsp;<span class="op" id="8039826">!=</span>&nbsp;<span class="builtintype" id="8039829">nil</span>&nbsp;<span class="op" id="8039833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8039837">t</span><span class="op" id="8039838">.</span><span class="ident" id="8039839">Errorf</span><span class="op" id="8039845">(</span><span class="string" id="8039846">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="8039866">,</span>&nbsp;<span class="ident" id="8039868">err</span><span class="op" id="8039871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8039875">return</span>&nbsp;<span class="ident" id="8039882">err</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8039887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8039890">return</span>&nbsp;<span class="builtintype" id="8039897">nil</span><br>
<span class="lineno"></span><span class="op" id="8039901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8039904">type</span>&nbsp;<span class="ident" id="8039909">concurrentTxQueryTest</span>&nbsp;<span class="keyword" id="8039931">struct</span>&nbsp;<span class="op" id="8039938">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8039941">db</span>&nbsp;<span class="op" id="8039944">*</span><span class="ident" id="8039945">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8039949">tx</span>&nbsp;<span class="op" id="8039952">*</span><span class="ident" id="8039953">Tx</span><br>
<span class="lineno"></span><span class="op" id="8039956">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8039959">func</span>&nbsp;<span class="op" id="8039964">(</span><span class="ident" id="8039965">c</span>&nbsp;<span class="op" id="8039967">*</span><span class="ident" id="8039968">concurrentTxQueryTest</span><span class="op" id="8039989">)</span>&nbsp;<span class="ident" id="8039991">init</span><span class="op" id="8039995">(</span><span class="ident" id="8039996">t</span>&nbsp;<span class="ident" id="8039998">testing</span><span class="op" id="8040005">.</span><span class="ident" id="8040006">TB</span><span class="op" id="8040008">,</span>&nbsp;<span class="ident" id="8040010">db</span>&nbsp;<span class="op" id="8040013">*</span><span class="ident" id="8040014">DB</span><span class="op" id="8040016">)</span>&nbsp;<span class="op" id="8040018">{</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8040021">c</span><span class="op" id="8040022">.</span><span class="ident" id="8040023">db</span>&nbsp;<span class="op" id="8040026">=</span>&nbsp;<span class="ident" id="8040028">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8040032">var</span>&nbsp;<span class="ident" id="8040036">err</span>&nbsp;<span class="builtintype" id="8040040">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8040047">c</span><span class="op" id="8040048">.</span><span class="ident" id="8040049">tx</span><span class="op" id="8040051">,</span>&nbsp;<span class="ident" id="8040053">err</span>&nbsp;<span class="op" id="8040057">=</span>&nbsp;<span class="ident" id="8040059">c</span><span class="op" id="8040060">.</span><span class="ident" id="8040061">db</span><span class="op" id="8040063">.</span><span class="ident" id="8040064">Begin</span><span class="op" id="8040069">(</span><span class="op" id="8040070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8040073">if</span>&nbsp;<span class="ident" id="8040076">err</span>&nbsp;<span class="op" id="8040080">!=</span>&nbsp;<span class="builtintype" id="8040083">nil</span>&nbsp;<span class="op" id="8040087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8040091">t</span><span class="op" id="8040092">.</span><span class="ident" id="8040093">Fatal</span><span class="op" id="8040098">(</span><span class="ident" id="8040099">err</span><span class="op" id="8040102">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8040105">}</span><br>
<span class="lineno"></span><span class="op" id="8040107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8040110">func</span>&nbsp;<span class="op" id="8040115">(</span><span class="ident" id="8040116">c</span>&nbsp;<span class="op" id="8040118">*</span><span class="ident" id="8040119">concurrentTxQueryTest</span><span class="op" id="8040140">)</span>&nbsp;<span class="ident" id="8040142">finish</span><span class="op" id="8040148">(</span><span class="ident" id="8040149">t</span>&nbsp;<span class="ident" id="8040151">testing</span><span class="op" id="8040158">.</span><span class="ident" id="8040159">TB</span><span class="op" id="8040161">)</span>&nbsp;<span class="op" id="8040163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8040166">if</span>&nbsp;<span class="ident" id="8040169">c</span><span class="op" id="8040170">.</span><span class="ident" id="8040171">tx</span>&nbsp;<span class="op" id="8040174">!=</span>&nbsp;<span class="builtintype" id="8040177">nil</span>&nbsp;<span class="op" id="8040181">{</span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8040185">c</span><span class="op" id="8040186">.</span><span class="ident" id="8040187">tx</span><span class="op" id="8040189">.</span><span class="ident" id="8040190">Rollback</span><span class="op" id="8040198">(</span><span class="op" id="8040199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8040203">c</span><span class="op" id="8040204">.</span><span class="ident" id="8040205">tx</span>&nbsp;<span class="op" id="8040208">=</span>&nbsp;<span class="builtintype" id="8040210">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8040215">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8040218">c</span><span class="op" id="8040219">.</span><span class="ident" id="8040220">db</span>&nbsp;<span class="op" id="8040223">=</span>&nbsp;<span class="builtintype" id="8040225">nil</span><br>
<span class="lineno"></span><span class="op" id="8040229">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span><span class="keyword" id="8040232">func</span>&nbsp;<span class="op" id="8040237">(</span><span class="ident" id="8040238">c</span>&nbsp;<span class="op" id="8040240">*</span><span class="ident" id="8040241">concurrentTxQueryTest</span><span class="op" id="8040262">)</span>&nbsp;<span class="ident" id="8040264">test</span><span class="op" id="8040268">(</span><span class="ident" id="8040269">t</span>&nbsp;<span class="ident" id="8040271">testing</span><span class="op" id="8040278">.</span><span class="ident" id="8040279">TB</span><span class="op" id="8040281">)</span>&nbsp;<span class="builtintype" id="8040283">error</span>&nbsp;<span class="op" id="8040289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8040292">rows</span><span class="op" id="8040296">,</span>&nbsp;<span class="ident" id="8040298">err</span>&nbsp;<span class="op" id="8040302">:=</span>&nbsp;<span class="ident" id="8040305">c</span><span class="op" id="8040306">.</span><span class="ident" id="8040307">db</span><span class="op" id="8040309">.</span><span class="ident" id="8040310">Query</span><span class="op" id="8040315">(</span><span class="string" id="8040316">&#34;SELECT|people|name|&#34;</span><span class="op" id="8040337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8040340">if</span>&nbsp;<span class="ident" id="8040343">err</span>&nbsp;<span class="op" id="8040347">!=</span>&nbsp;<span class="builtintype" id="8040350">nil</span>&nbsp;<span class="op" id="8040354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8040358">t</span><span class="op" id="8040359">.</span><span class="ident" id="8040360">Error</span><span class="op" id="8040365">(</span><span class="ident" id="8040366">err</span><span class="op" id="8040369">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8040373">return</span>&nbsp;<span class="ident" id="8040380">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8040385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8040388">var</span>&nbsp;<span class="ident" id="8040392">name</span>&nbsp;<span class="builtintype" id="8040397">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8040405">for</span>&nbsp;<span class="ident" id="8040409">rows</span><span class="op" id="8040413">.</span><span class="ident" id="8040414">Next</span><span class="op" id="8040418">(</span><span class="op" id="8040419">)</span>&nbsp;<span class="op" id="8040421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8040425">rows</span><span class="op" id="8040429">.</span><span class="ident" id="8040430">Scan</span><span class="op" id="8040434">(</span><span class="op" id="8040435">&amp;</span><span class="ident" id="8040436">name</span><span class="op" id="8040440">)</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8040443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8040446">rows</span><span class="op" id="8040450">.</span><span class="ident" id="8040451">Close</span><span class="op" id="8040456">(</span><span class="op" id="8040457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8040460">return</span>&nbsp;<span class="builtintype" id="8040467">nil</span><br>
<span class="lineno"></span><span class="op" id="8040471">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1580</span><span class="keyword" id="8040474">type</span>&nbsp;<span class="ident" id="8040479">concurrentTxExecTest</span>&nbsp;<span class="keyword" id="8040500">struct</span>&nbsp;<span class="op" id="8040507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8040510">db</span>&nbsp;<span class="op" id="8040513">*</span><span class="ident" id="8040514">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8040518">tx</span>&nbsp;<span class="op" id="8040521">*</span><span class="ident" id="8040522">Tx</span><br>
<span class="lineno"></span><span class="op" id="8040525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1585</span><span class="keyword" id="8040528">func</span>&nbsp;<span class="op" id="8040533">(</span><span class="ident" id="8040534">c</span>&nbsp;<span class="op" id="8040536">*</span><span class="ident" id="8040537">concurrentTxExecTest</span><span class="op" id="8040557">)</span>&nbsp;<span class="ident" id="8040559">init</span><span class="op" id="8040563">(</span><span class="ident" id="8040564">t</span>&nbsp;<span class="ident" id="8040566">testing</span><span class="op" id="8040573">.</span><span class="ident" id="8040574">TB</span><span class="op" id="8040576">,</span>&nbsp;<span class="ident" id="8040578">db</span>&nbsp;<span class="op" id="8040581">*</span><span class="ident" id="8040582">DB</span><span class="op" id="8040584">)</span>&nbsp;<span class="op" id="8040586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8040589">c</span><span class="op" id="8040590">.</span><span class="ident" id="8040591">db</span>&nbsp;<span class="op" id="8040594">=</span>&nbsp;<span class="ident" id="8040596">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8040600">var</span>&nbsp;<span class="ident" id="8040604">err</span>&nbsp;<span class="builtintype" id="8040608">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8040615">c</span><span class="op" id="8040616">.</span><span class="ident" id="8040617">tx</span><span class="op" id="8040619">,</span>&nbsp;<span class="ident" id="8040621">err</span>&nbsp;<span class="op" id="8040625">=</span>&nbsp;<span class="ident" id="8040627">c</span><span class="op" id="8040628">.</span><span class="ident" id="8040629">db</span><span class="op" id="8040631">.</span><span class="ident" id="8040632">Begin</span><span class="op" id="8040637">(</span><span class="op" id="8040638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8040641">if</span>&nbsp;<span class="ident" id="8040644">err</span>&nbsp;<span class="op" id="8040648">!=</span>&nbsp;<span class="builtintype" id="8040651">nil</span>&nbsp;<span class="op" id="8040655">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8040659">t</span><span class="op" id="8040660">.</span><span class="ident" id="8040661">Fatal</span><span class="op" id="8040666">(</span><span class="ident" id="8040667">err</span><span class="op" id="8040670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8040673">}</span><br>
<span class="lineno"></span><span class="op" id="8040675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8040678">func</span>&nbsp;<span class="op" id="8040683">(</span><span class="ident" id="8040684">c</span>&nbsp;<span class="op" id="8040686">*</span><span class="ident" id="8040687">concurrentTxExecTest</span><span class="op" id="8040707">)</span>&nbsp;<span class="ident" id="8040709">finish</span><span class="op" id="8040715">(</span><span class="ident" id="8040716">t</span>&nbsp;<span class="ident" id="8040718">testing</span><span class="op" id="8040725">.</span><span class="ident" id="8040726">TB</span><span class="op" id="8040728">)</span>&nbsp;<span class="op" id="8040730">{</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8040733">if</span>&nbsp;<span class="ident" id="8040736">c</span><span class="op" id="8040737">.</span><span class="ident" id="8040738">tx</span>&nbsp;<span class="op" id="8040741">!=</span>&nbsp;<span class="builtintype" id="8040744">nil</span>&nbsp;<span class="op" id="8040748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8040752">c</span><span class="op" id="8040753">.</span><span class="ident" id="8040754">tx</span><span class="op" id="8040756">.</span><span class="ident" id="8040757">Rollback</span><span class="op" id="8040765">(</span><span class="op" id="8040766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8040770">c</span><span class="op" id="8040771">.</span><span class="ident" id="8040772">tx</span>&nbsp;<span class="op" id="8040775">=</span>&nbsp;<span class="builtintype" id="8040777">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8040782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8040785">c</span><span class="op" id="8040786">.</span><span class="ident" id="8040787">db</span>&nbsp;<span class="op" id="8040790">=</span>&nbsp;<span class="builtintype" id="8040792">nil</span><br>
<span class="lineno">1600</span><span class="op" id="8040796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8040799">func</span>&nbsp;<span class="op" id="8040804">(</span><span class="ident" id="8040805">c</span>&nbsp;<span class="op" id="8040807">*</span><span class="ident" id="8040808">concurrentTxExecTest</span><span class="op" id="8040828">)</span>&nbsp;<span class="ident" id="8040830">test</span><span class="op" id="8040834">(</span><span class="ident" id="8040835">t</span>&nbsp;<span class="ident" id="8040837">testing</span><span class="op" id="8040844">.</span><span class="ident" id="8040845">TB</span><span class="op" id="8040847">)</span>&nbsp;<span class="builtintype" id="8040849">error</span>&nbsp;<span class="op" id="8040855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8040858">_</span><span class="op" id="8040859">,</span>&nbsp;<span class="ident" id="8040861">err</span>&nbsp;<span class="op" id="8040865">:=</span>&nbsp;<span class="ident" id="8040868">c</span><span class="op" id="8040869">.</span><span class="ident" id="8040870">tx</span><span class="op" id="8040872">.</span><span class="ident" id="8040873">Exec</span><span class="op" id="8040877">(</span><span class="string" id="8040878">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="8040931">,</span>&nbsp;<span class="num" id="8040933">3</span><span class="op" id="8040934">,</span>&nbsp;<span class="ident" id="8040936">chrisBirthday</span><span class="op" id="8040949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8040952">if</span>&nbsp;<span class="ident" id="8040955">err</span>&nbsp;<span class="op" id="8040959">!=</span>&nbsp;<span class="builtintype" id="8040962">nil</span>&nbsp;<span class="op" id="8040966">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8040970">t</span><span class="op" id="8040971">.</span><span class="ident" id="8040972">Error</span><span class="op" id="8040977">(</span><span class="ident" id="8040978">err</span><span class="op" id="8040981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8040985">return</span>&nbsp;<span class="ident" id="8040992">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8040997">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8041000">return</span>&nbsp;<span class="builtintype" id="8041007">nil</span><br>
<span class="lineno"></span><span class="op" id="8041011">}</span><br>
<span class="lineno">1610</span><br>
<span class="lineno"></span><span class="keyword" id="8041014">type</span>&nbsp;<span class="ident" id="8041019">concurrentTxStmtQueryTest</span>&nbsp;<span class="keyword" id="8041045">struct</span>&nbsp;<span class="op" id="8041052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041055">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8041060">*</span><span class="ident" id="8041061">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041065">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8041070">*</span><span class="ident" id="8041071">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041075">stmt</span>&nbsp;<span class="op" id="8041080">*</span><span class="ident" id="8041081">Stmt</span><br>
<span class="lineno">1615</span><span class="op" id="8041086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8041089">func</span>&nbsp;<span class="op" id="8041094">(</span><span class="ident" id="8041095">c</span>&nbsp;<span class="op" id="8041097">*</span><span class="ident" id="8041098">concurrentTxStmtQueryTest</span><span class="op" id="8041123">)</span>&nbsp;<span class="ident" id="8041125">init</span><span class="op" id="8041129">(</span><span class="ident" id="8041130">t</span>&nbsp;<span class="ident" id="8041132">testing</span><span class="op" id="8041139">.</span><span class="ident" id="8041140">TB</span><span class="op" id="8041142">,</span>&nbsp;<span class="ident" id="8041144">db</span>&nbsp;<span class="op" id="8041147">*</span><span class="ident" id="8041148">DB</span><span class="op" id="8041150">)</span>&nbsp;<span class="op" id="8041152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041155">c</span><span class="op" id="8041156">.</span><span class="ident" id="8041157">db</span>&nbsp;<span class="op" id="8041160">=</span>&nbsp;<span class="ident" id="8041162">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8041166">var</span>&nbsp;<span class="ident" id="8041170">err</span>&nbsp;<span class="builtintype" id="8041174">error</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041181">c</span><span class="op" id="8041182">.</span><span class="ident" id="8041183">tx</span><span class="op" id="8041185">,</span>&nbsp;<span class="ident" id="8041187">err</span>&nbsp;<span class="op" id="8041191">=</span>&nbsp;<span class="ident" id="8041193">c</span><span class="op" id="8041194">.</span><span class="ident" id="8041195">db</span><span class="op" id="8041197">.</span><span class="ident" id="8041198">Begin</span><span class="op" id="8041203">(</span><span class="op" id="8041204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8041207">if</span>&nbsp;<span class="ident" id="8041210">err</span>&nbsp;<span class="op" id="8041214">!=</span>&nbsp;<span class="builtintype" id="8041217">nil</span>&nbsp;<span class="op" id="8041221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041225">t</span><span class="op" id="8041226">.</span><span class="ident" id="8041227">Fatal</span><span class="op" id="8041232">(</span><span class="ident" id="8041233">err</span><span class="op" id="8041236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8041239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041242">c</span><span class="op" id="8041243">.</span><span class="ident" id="8041244">stmt</span><span class="op" id="8041248">,</span>&nbsp;<span class="ident" id="8041250">err</span>&nbsp;<span class="op" id="8041254">=</span>&nbsp;<span class="ident" id="8041256">c</span><span class="op" id="8041257">.</span><span class="ident" id="8041258">tx</span><span class="op" id="8041260">.</span><span class="ident" id="8041261">Prepare</span><span class="op" id="8041268">(</span><span class="string" id="8041269">&#34;SELECT|people|name|&#34;</span><span class="op" id="8041290">)</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8041293">if</span>&nbsp;<span class="ident" id="8041296">err</span>&nbsp;<span class="op" id="8041300">!=</span>&nbsp;<span class="builtintype" id="8041303">nil</span>&nbsp;<span class="op" id="8041307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041311">t</span><span class="op" id="8041312">.</span><span class="ident" id="8041313">Fatal</span><span class="op" id="8041318">(</span><span class="ident" id="8041319">err</span><span class="op" id="8041322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8041325">}</span><br>
<span class="lineno"></span><span class="op" id="8041327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1630</span><span class="keyword" id="8041330">func</span>&nbsp;<span class="op" id="8041335">(</span><span class="ident" id="8041336">c</span>&nbsp;<span class="op" id="8041338">*</span><span class="ident" id="8041339">concurrentTxStmtQueryTest</span><span class="op" id="8041364">)</span>&nbsp;<span class="ident" id="8041366">finish</span><span class="op" id="8041372">(</span><span class="ident" id="8041373">t</span>&nbsp;<span class="ident" id="8041375">testing</span><span class="op" id="8041382">.</span><span class="ident" id="8041383">TB</span><span class="op" id="8041385">)</span>&nbsp;<span class="op" id="8041387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8041390">if</span>&nbsp;<span class="ident" id="8041393">c</span><span class="op" id="8041394">.</span><span class="ident" id="8041395">stmt</span>&nbsp;<span class="op" id="8041400">!=</span>&nbsp;<span class="builtintype" id="8041403">nil</span>&nbsp;<span class="op" id="8041407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041411">c</span><span class="op" id="8041412">.</span><span class="ident" id="8041413">stmt</span><span class="op" id="8041417">.</span><span class="ident" id="8041418">Close</span><span class="op" id="8041423">(</span><span class="op" id="8041424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041428">c</span><span class="op" id="8041429">.</span><span class="ident" id="8041430">stmt</span>&nbsp;<span class="op" id="8041435">=</span>&nbsp;<span class="builtintype" id="8041437">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8041442">}</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8041445">if</span>&nbsp;<span class="ident" id="8041448">c</span><span class="op" id="8041449">.</span><span class="ident" id="8041450">tx</span>&nbsp;<span class="op" id="8041453">!=</span>&nbsp;<span class="builtintype" id="8041456">nil</span>&nbsp;<span class="op" id="8041460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041464">c</span><span class="op" id="8041465">.</span><span class="ident" id="8041466">tx</span><span class="op" id="8041468">.</span><span class="ident" id="8041469">Rollback</span><span class="op" id="8041477">(</span><span class="op" id="8041478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041482">c</span><span class="op" id="8041483">.</span><span class="ident" id="8041484">tx</span>&nbsp;<span class="op" id="8041487">=</span>&nbsp;<span class="builtintype" id="8041489">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8041494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041497">c</span><span class="op" id="8041498">.</span><span class="ident" id="8041499">db</span>&nbsp;<span class="op" id="8041502">=</span>&nbsp;<span class="builtintype" id="8041504">nil</span><br>
<span class="lineno">1640</span><span class="op" id="8041508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8041511">func</span>&nbsp;<span class="op" id="8041516">(</span><span class="ident" id="8041517">c</span>&nbsp;<span class="op" id="8041519">*</span><span class="ident" id="8041520">concurrentTxStmtQueryTest</span><span class="op" id="8041545">)</span>&nbsp;<span class="ident" id="8041547">test</span><span class="op" id="8041551">(</span><span class="ident" id="8041552">t</span>&nbsp;<span class="ident" id="8041554">testing</span><span class="op" id="8041561">.</span><span class="ident" id="8041562">TB</span><span class="op" id="8041564">)</span>&nbsp;<span class="builtintype" id="8041566">error</span>&nbsp;<span class="op" id="8041572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041575">rows</span><span class="op" id="8041579">,</span>&nbsp;<span class="ident" id="8041581">err</span>&nbsp;<span class="op" id="8041585">:=</span>&nbsp;<span class="ident" id="8041588">c</span><span class="op" id="8041589">.</span><span class="ident" id="8041590">stmt</span><span class="op" id="8041594">.</span><span class="ident" id="8041595">Query</span><span class="op" id="8041600">(</span><span class="op" id="8041601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8041604">if</span>&nbsp;<span class="ident" id="8041607">err</span>&nbsp;<span class="op" id="8041611">!=</span>&nbsp;<span class="builtintype" id="8041614">nil</span>&nbsp;<span class="op" id="8041618">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041622">t</span><span class="op" id="8041623">.</span><span class="ident" id="8041624">Errorf</span><span class="op" id="8041630">(</span><span class="string" id="8041631">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="8041652">,</span>&nbsp;<span class="ident" id="8041654">err</span><span class="op" id="8041657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8041661">return</span>&nbsp;<span class="ident" id="8041668">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8041673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8041677">var</span>&nbsp;<span class="ident" id="8041681">name</span>&nbsp;<span class="builtintype" id="8041686">string</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8041694">for</span>&nbsp;<span class="ident" id="8041698">rows</span><span class="op" id="8041702">.</span><span class="ident" id="8041703">Next</span><span class="op" id="8041707">(</span><span class="op" id="8041708">)</span>&nbsp;<span class="op" id="8041710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041714">rows</span><span class="op" id="8041718">.</span><span class="ident" id="8041719">Scan</span><span class="op" id="8041723">(</span><span class="op" id="8041724">&amp;</span><span class="ident" id="8041725">name</span><span class="op" id="8041729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8041732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041735">rows</span><span class="op" id="8041739">.</span><span class="ident" id="8041740">Close</span><span class="op" id="8041745">(</span><span class="op" id="8041746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8041749">return</span>&nbsp;<span class="builtintype" id="8041756">nil</span><br>
<span class="lineno">1655</span><span class="op" id="8041760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8041763">type</span>&nbsp;<span class="ident" id="8041768">concurrentTxStmtExecTest</span>&nbsp;<span class="keyword" id="8041793">struct</span>&nbsp;<span class="op" id="8041800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041803">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8041808">*</span><span class="ident" id="8041809">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041813">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8041818">*</span><span class="ident" id="8041819">Tx</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041823">stmt</span>&nbsp;<span class="op" id="8041828">*</span><span class="ident" id="8041829">Stmt</span><br>
<span class="lineno"></span><span class="op" id="8041834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8041837">func</span>&nbsp;<span class="op" id="8041842">(</span><span class="ident" id="8041843">c</span>&nbsp;<span class="op" id="8041845">*</span><span class="ident" id="8041846">concurrentTxStmtExecTest</span><span class="op" id="8041870">)</span>&nbsp;<span class="ident" id="8041872">init</span><span class="op" id="8041876">(</span><span class="ident" id="8041877">t</span>&nbsp;<span class="ident" id="8041879">testing</span><span class="op" id="8041886">.</span><span class="ident" id="8041887">TB</span><span class="op" id="8041889">,</span>&nbsp;<span class="ident" id="8041891">db</span>&nbsp;<span class="op" id="8041894">*</span><span class="ident" id="8041895">DB</span><span class="op" id="8041897">)</span>&nbsp;<span class="op" id="8041899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041902">c</span><span class="op" id="8041903">.</span><span class="ident" id="8041904">db</span>&nbsp;<span class="op" id="8041907">=</span>&nbsp;<span class="ident" id="8041909">db</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8041913">var</span>&nbsp;<span class="ident" id="8041917">err</span>&nbsp;<span class="builtintype" id="8041921">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041928">c</span><span class="op" id="8041929">.</span><span class="ident" id="8041930">tx</span><span class="op" id="8041932">,</span>&nbsp;<span class="ident" id="8041934">err</span>&nbsp;<span class="op" id="8041938">=</span>&nbsp;<span class="ident" id="8041940">c</span><span class="op" id="8041941">.</span><span class="ident" id="8041942">db</span><span class="op" id="8041944">.</span><span class="ident" id="8041945">Begin</span><span class="op" id="8041950">(</span><span class="op" id="8041951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8041954">if</span>&nbsp;<span class="ident" id="8041957">err</span>&nbsp;<span class="op" id="8041961">!=</span>&nbsp;<span class="builtintype" id="8041964">nil</span>&nbsp;<span class="op" id="8041968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041972">t</span><span class="op" id="8041973">.</span><span class="ident" id="8041974">Fatal</span><span class="op" id="8041979">(</span><span class="ident" id="8041980">err</span><span class="op" id="8041983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8041986">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8041989">c</span><span class="op" id="8041990">.</span><span class="ident" id="8041991">stmt</span><span class="op" id="8041995">,</span>&nbsp;<span class="ident" id="8041997">err</span>&nbsp;<span class="op" id="8042001">=</span>&nbsp;<span class="ident" id="8042003">c</span><span class="op" id="8042004">.</span><span class="ident" id="8042005">tx</span><span class="op" id="8042007">.</span><span class="ident" id="8042008">Prepare</span><span class="op" id="8042015">(</span><span class="string" id="8042016">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="8042069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8042072">if</span>&nbsp;<span class="ident" id="8042075">err</span>&nbsp;<span class="op" id="8042079">!=</span>&nbsp;<span class="builtintype" id="8042082">nil</span>&nbsp;<span class="op" id="8042086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8042090">t</span><span class="op" id="8042091">.</span><span class="ident" id="8042092">Fatal</span><span class="op" id="8042097">(</span><span class="ident" id="8042098">err</span><span class="op" id="8042101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8042104">}</span><br>
<span class="lineno"></span><span class="op" id="8042106">}</span><br>
<span class="lineno">1675</span><br>
<span class="lineno"></span><span class="keyword" id="8042109">func</span>&nbsp;<span class="op" id="8042114">(</span><span class="ident" id="8042115">c</span>&nbsp;<span class="op" id="8042117">*</span><span class="ident" id="8042118">concurrentTxStmtExecTest</span><span class="op" id="8042142">)</span>&nbsp;<span class="ident" id="8042144">finish</span><span class="op" id="8042150">(</span><span class="ident" id="8042151">t</span>&nbsp;<span class="ident" id="8042153">testing</span><span class="op" id="8042160">.</span><span class="ident" id="8042161">TB</span><span class="op" id="8042163">)</span>&nbsp;<span class="op" id="8042165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8042168">if</span>&nbsp;<span class="ident" id="8042171">c</span><span class="op" id="8042172">.</span><span class="ident" id="8042173">stmt</span>&nbsp;<span class="op" id="8042178">!=</span>&nbsp;<span class="builtintype" id="8042181">nil</span>&nbsp;<span class="op" id="8042185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8042189">c</span><span class="op" id="8042190">.</span><span class="ident" id="8042191">stmt</span><span class="op" id="8042195">.</span><span class="ident" id="8042196">Close</span><span class="op" id="8042201">(</span><span class="op" id="8042202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8042206">c</span><span class="op" id="8042207">.</span><span class="ident" id="8042208">stmt</span>&nbsp;<span class="op" id="8042213">=</span>&nbsp;<span class="builtintype" id="8042215">nil</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8042220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8042223">if</span>&nbsp;<span class="ident" id="8042226">c</span><span class="op" id="8042227">.</span><span class="ident" id="8042228">tx</span>&nbsp;<span class="op" id="8042231">!=</span>&nbsp;<span class="builtintype" id="8042234">nil</span>&nbsp;<span class="op" id="8042238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8042242">c</span><span class="op" id="8042243">.</span><span class="ident" id="8042244">tx</span><span class="op" id="8042246">.</span><span class="ident" id="8042247">Rollback</span><span class="op" id="8042255">(</span><span class="op" id="8042256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8042260">c</span><span class="op" id="8042261">.</span><span class="ident" id="8042262">tx</span>&nbsp;<span class="op" id="8042265">=</span>&nbsp;<span class="builtintype" id="8042267">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8042272">}</span><br>
<span class="lineno">1685</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8042275">c</span><span class="op" id="8042276">.</span><span class="ident" id="8042277">db</span>&nbsp;<span class="op" id="8042280">=</span>&nbsp;<span class="builtintype" id="8042282">nil</span><br>
<span class="lineno"></span><span class="op" id="8042286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8042289">func</span>&nbsp;<span class="op" id="8042294">(</span><span class="ident" id="8042295">c</span>&nbsp;<span class="op" id="8042297">*</span><span class="ident" id="8042298">concurrentTxStmtExecTest</span><span class="op" id="8042322">)</span>&nbsp;<span class="ident" id="8042324">test</span><span class="op" id="8042328">(</span><span class="ident" id="8042329">t</span>&nbsp;<span class="ident" id="8042331">testing</span><span class="op" id="8042338">.</span><span class="ident" id="8042339">TB</span><span class="op" id="8042341">)</span>&nbsp;<span class="builtintype" id="8042343">error</span>&nbsp;<span class="op" id="8042349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8042352">_</span><span class="op" id="8042353">,</span>&nbsp;<span class="ident" id="8042355">err</span>&nbsp;<span class="op" id="8042359">:=</span>&nbsp;<span class="ident" id="8042362">c</span><span class="op" id="8042363">.</span><span class="ident" id="8042364">stmt</span><span class="op" id="8042368">.</span><span class="ident" id="8042369">Exec</span><span class="op" id="8042373">(</span><span class="num" id="8042374">3</span><span class="op" id="8042375">,</span>&nbsp;<span class="ident" id="8042377">chrisBirthday</span><span class="op" id="8042390">)</span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8042393">if</span>&nbsp;<span class="ident" id="8042396">err</span>&nbsp;<span class="op" id="8042400">!=</span>&nbsp;<span class="builtintype" id="8042403">nil</span>&nbsp;<span class="op" id="8042407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8042411">t</span><span class="op" id="8042412">.</span><span class="ident" id="8042413">Errorf</span><span class="op" id="8042419">(</span><span class="string" id="8042420">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="8042440">,</span>&nbsp;<span class="ident" id="8042442">err</span><span class="op" id="8042445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8042449">return</span>&nbsp;<span class="ident" id="8042456">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8042461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8042464">return</span>&nbsp;<span class="builtintype" id="8042471">nil</span><br>
<span class="lineno">1695</span><span class="op" id="8042475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8042478">type</span>&nbsp;<span class="ident" id="8042483">concurrentRandomTest</span>&nbsp;<span class="keyword" id="8042504">struct</span>&nbsp;<span class="op" id="8042511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8042514">tests</span>&nbsp;<span class="op" id="8042520">[</span><span class="op" id="8042521">]</span><span class="ident" id="8042522">concurrentTest</span><br>
<span class="lineno"></span><span class="op" id="8042537">}</span><br>
<span class="lineno">1700</span><br>
<span class="lineno"></span><span class="keyword" id="8042540">func</span>&nbsp;<span class="op" id="8042545">(</span><span class="ident" id="8042546">c</span>&nbsp;<span class="op" id="8042548">*</span><span class="ident" id="8042549">concurrentRandomTest</span><span class="op" id="8042569">)</span>&nbsp;<span class="ident" id="8042571">init</span><span class="op" id="8042575">(</span><span class="ident" id="8042576">t</span>&nbsp;<span class="ident" id="8042578">testing</span><span class="op" id="8042585">.</span><span class="ident" id="8042586">TB</span><span class="op" id="8042588">,</span>&nbsp;<span class="ident" id="8042590">db</span>&nbsp;<span class="op" id="8042593">*</span><span class="ident" id="8042594">DB</span><span class="op" id="8042596">)</span>&nbsp;<span class="op" id="8042598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8042601">c</span><span class="op" id="8042602">.</span><span class="ident" id="8042603">tests</span>&nbsp;<span class="op" id="8042609">=</span>&nbsp;<span class="op" id="8042611">[</span><span class="op" id="8042612">]</span><span class="ident" id="8042613">concurrentTest</span><span class="op" id="8042627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8042631">new</span><span class="op" id="8042634">(</span><span class="ident" id="8042635">concurrentDBQueryTest</span><span class="op" id="8042656">)</span><span class="op" id="8042657">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8042661">new</span><span class="op" id="8042664">(</span><span class="ident" id="8042665">concurrentDBExecTest</span><span class="op" id="8042685">)</span><span class="op" id="8042686">,</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8042690">new</span><span class="op" id="8042693">(</span><span class="ident" id="8042694">concurrentStmtQueryTest</span><span class="op" id="8042717">)</span><span class="op" id="8042718">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8042722">new</span><span class="op" id="8042725">(</span><span class="ident" id="8042726">concurrentStmtExecTest</span><span class="op" id="8042748">)</span><span class="op" id="8042749">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8042753">new</span><span class="op" id="8042756">(</span><span class="ident" id="8042757">concurrentTxQueryTest</span><span class="op" id="8042778">)</span><span class="op" id="8042779">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8042783">new</span><span class="op" id="8042786">(</span><span class="ident" id="8042787">concurrentTxExecTest</span><span class="op" id="8042807">)</span><span class="op" id="8042808">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8042812">new</span><span class="op" id="8042815">(</span><span class="ident" id="8042816">concurrentTxStmtQueryTest</span><span class="op" id="8042841">)</span><span class="op" id="8042842">,</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="8042846">new</span><span class="op" id="8042849">(</span><span class="ident" id="8042850">concurrentTxStmtExecTest</span><span class="op" id="8042874">)</span><span class="op" id="8042875">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8042878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8042881">for</span>&nbsp;<span class="ident" id="8042885">_</span><span class="op" id="8042886">,</span>&nbsp;<span class="ident" id="8042888">ct</span>&nbsp;<span class="op" id="8042891">:=</span>&nbsp;<span class="keyword" id="8042894">range</span>&nbsp;<span class="ident" id="8042900">c</span><span class="op" id="8042901">.</span><span class="ident" id="8042902">tests</span>&nbsp;<span class="op" id="8042908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8042912">ct</span><span class="op" id="8042914">.</span><span class="ident" id="8042915">init</span><span class="op" id="8042919">(</span><span class="ident" id="8042920">t</span><span class="op" id="8042921">,</span>&nbsp;<span class="ident" id="8042923">db</span><span class="op" id="8042925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8042928">}</span><br>
<span class="lineno">1715</span><span class="op" id="8042930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8042933">func</span>&nbsp;<span class="op" id="8042938">(</span><span class="ident" id="8042939">c</span>&nbsp;<span class="op" id="8042941">*</span><span class="ident" id="8042942">concurrentRandomTest</span><span class="op" id="8042962">)</span>&nbsp;<span class="ident" id="8042964">finish</span><span class="op" id="8042970">(</span><span class="ident" id="8042971">t</span>&nbsp;<span class="ident" id="8042973">testing</span><span class="op" id="8042980">.</span><span class="ident" id="8042981">TB</span><span class="op" id="8042983">)</span>&nbsp;<span class="op" id="8042985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8042988">for</span>&nbsp;<span class="ident" id="8042992">_</span><span class="op" id="8042993">,</span>&nbsp;<span class="ident" id="8042995">ct</span>&nbsp;<span class="op" id="8042998">:=</span>&nbsp;<span class="keyword" id="8043001">range</span>&nbsp;<span class="ident" id="8043007">c</span><span class="op" id="8043008">.</span><span class="ident" id="8043009">tests</span>&nbsp;<span class="op" id="8043015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8043019">ct</span><span class="op" id="8043021">.</span><span class="ident" id="8043022">finish</span><span class="op" id="8043028">(</span><span class="ident" id="8043029">t</span><span class="op" id="8043030">)</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8043033">}</span><br>
<span class="lineno"></span><span class="op" id="8043035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8043038">func</span>&nbsp;<span class="op" id="8043043">(</span><span class="ident" id="8043044">c</span>&nbsp;<span class="op" id="8043046">*</span><span class="ident" id="8043047">concurrentRandomTest</span><span class="op" id="8043067">)</span>&nbsp;<span class="ident" id="8043069">test</span><span class="op" id="8043073">(</span><span class="ident" id="8043074">t</span>&nbsp;<span class="ident" id="8043076">testing</span><span class="op" id="8043083">.</span><span class="ident" id="8043084">TB</span><span class="op" id="8043086">)</span>&nbsp;<span class="builtintype" id="8043088">error</span>&nbsp;<span class="op" id="8043094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8043097">ct</span>&nbsp;<span class="op" id="8043100">:=</span>&nbsp;<span class="ident" id="8043103">c</span><span class="op" id="8043104">.</span><span class="ident" id="8043105">tests</span><span class="op" id="8043110">[</span><span class="ident" id="8043111">rand</span><span class="op" id="8043115">.</span><span class="ident" id="8043116">Intn</span><span class="op" id="8043120">(</span><span class="builtinfunc" id="8043121">len</span><span class="op" id="8043124">(</span><span class="ident" id="8043125">c</span><span class="op" id="8043126">.</span><span class="ident" id="8043127">tests</span><span class="op" id="8043132">)</span><span class="op" id="8043133">)</span><span class="op" id="8043134">]</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8043137">return</span>&nbsp;<span class="ident" id="8043144">ct</span><span class="op" id="8043146">.</span><span class="ident" id="8043147">test</span><span class="op" id="8043151">(</span><span class="ident" id="8043152">t</span><span class="op" id="8043153">)</span><br>
<span class="lineno"></span><span class="op" id="8043155">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8043158">func</span>&nbsp;<span class="ident" id="8043163">doConcurrentTest</span><span class="op" id="8043179">(</span><span class="ident" id="8043180">t</span>&nbsp;<span class="ident" id="8043182">testing</span><span class="op" id="8043189">.</span><span class="ident" id="8043190">TB</span><span class="op" id="8043192">,</span>&nbsp;<span class="ident" id="8043194">ct</span>&nbsp;<span class="ident" id="8043197">concurrentTest</span><span class="op" id="8043211">)</span>&nbsp;<span class="op" id="8043213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8043216">maxProcs</span><span class="op" id="8043224">,</span>&nbsp;<span class="ident" id="8043226">numReqs</span>&nbsp;<span class="op" id="8043234">:=</span>&nbsp;<span class="num" id="8043237">1</span><span class="op" id="8043238">,</span>&nbsp;<span class="num" id="8043240">500</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8043245">if</span>&nbsp;<span class="ident" id="8043248">testing</span><span class="op" id="8043255">.</span><span class="ident" id="8043256">Short</span><span class="op" id="8043261">(</span><span class="op" id="8043262">)</span>&nbsp;<span class="op" id="8043264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8043268">maxProcs</span><span class="op" id="8043276">,</span>&nbsp;<span class="ident" id="8043278">numReqs</span>&nbsp;<span class="op" id="8043286">=</span>&nbsp;<span class="num" id="8043288">4</span><span class="op" id="8043289">,</span>&nbsp;<span class="num" id="8043291">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8043295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8043298">defer</span>&nbsp;<span class="ident" id="8043304">runtime</span><span class="op" id="8043311">.</span><span class="ident" id="8043312">GOMAXPROCS</span><span class="op" id="8043322">(</span><span class="ident" id="8043323">runtime</span><span class="op" id="8043330">.</span><span class="ident" id="8043331">GOMAXPROCS</span><span class="op" id="8043341">(</span><span class="ident" id="8043342">maxProcs</span><span class="op" id="8043350">)</span><span class="op" id="8043351">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8043355">db</span>&nbsp;<span class="op" id="8043358">:=</span>&nbsp;<span class="ident" id="8043361">newTestDB</span><span class="op" id="8043370">(</span><span class="ident" id="8043371">t</span><span class="op" id="8043372">,</span>&nbsp;<span class="string" id="8043374">&#34;people&#34;</span><span class="op" id="8043382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8043385">defer</span>&nbsp;<span class="ident" id="8043391">closeDB</span><span class="op" id="8043398">(</span><span class="ident" id="8043399">t</span><span class="op" id="8043400">,</span>&nbsp;<span class="ident" id="8043402">db</span><span class="op" id="8043404">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8043408">ct</span><span class="op" id="8043410">.</span><span class="ident" id="8043411">init</span><span class="op" id="8043415">(</span><span class="ident" id="8043416">t</span><span class="op" id="8043417">,</span>&nbsp;<span class="ident" id="8043419">db</span><span class="op" id="8043421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8043424">defer</span>&nbsp;<span class="ident" id="8043430">ct</span><span class="op" id="8043432">.</span><span class="ident" id="8043433">finish</span><span class="op" id="8043439">(</span><span class="ident" id="8043440">t</span><span class="op" id="8043441">)</span><br>
<span class="lineno">1740</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8043445">var</span>&nbsp;<span class="ident" id="8043449">wg</span>&nbsp;<span class="ident" id="8043452">sync</span><span class="op" id="8043456">.</span><span class="ident" id="8043457">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8043468">wg</span><span class="op" id="8043470">.</span><span class="ident" id="8043471">Add</span><span class="op" id="8043474">(</span><span class="ident" id="8043475">numReqs</span><span class="op" id="8043482">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8043486">reqs</span>&nbsp;<span class="op" id="8043491">:=</span>&nbsp;<span class="builtinfunc" id="8043494">make</span><span class="op" id="8043498">(</span><span class="keyword" id="8043499">chan</span>&nbsp;<span class="builtintype" id="8043504">bool</span><span class="op" id="8043508">)</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8043511">defer</span>&nbsp;<span class="builtinfunc" id="8043517">close</span><span class="op" id="8043522">(</span><span class="ident" id="8043523">reqs</span><span class="op" id="8043527">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8043531">for</span>&nbsp;<span class="ident" id="8043535">i</span>&nbsp;<span class="op" id="8043537">:=</span>&nbsp;<span class="num" id="8043540">0</span><span class="op" id="8043541">;</span>&nbsp;<span class="ident" id="8043543">i</span>&nbsp;<span class="op" id="8043545">&lt;</span>&nbsp;<span class="ident" id="8043547">maxProcs</span><span class="op" id="8043555">*</span><span class="num" id="8043556">2</span><span class="op" id="8043557">;</span>&nbsp;<span class="ident" id="8043559">i</span><span class="op" id="8043560">++</span>&nbsp;<span class="op" id="8043563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8043567">go</span>&nbsp;<span class="keyword" id="8043570">func</span><span class="op" id="8043574">(</span><span class="op" id="8043575">)</span>&nbsp;<span class="op" id="8043577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8043582">for</span>&nbsp;<span class="keyword" id="8043586">range</span>&nbsp;<span class="ident" id="8043592">reqs</span>&nbsp;<span class="op" id="8043597">{</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8043603">err</span>&nbsp;<span class="op" id="8043607">:=</span>&nbsp;<span class="ident" id="8043610">ct</span><span class="op" id="8043612">.</span><span class="ident" id="8043613">test</span><span class="op" id="8043617">(</span><span class="ident" id="8043618">t</span><span class="op" id="8043619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8043625">if</span>&nbsp;<span class="ident" id="8043628">err</span>&nbsp;<span class="op" id="8043632">!=</span>&nbsp;<span class="builtintype" id="8043635">nil</span>&nbsp;<span class="op" id="8043639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8043646">wg</span><span class="op" id="8043648">.</span><span class="ident" id="8043649">Done</span><span class="op" id="8043653">(</span><span class="op" id="8043654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8043661">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8043674">}</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8043680">wg</span><span class="op" id="8043682">.</span><span class="ident" id="8043683">Done</span><span class="op" id="8043687">(</span><span class="op" id="8043688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8043693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8043697">}</span><span class="op" id="8043698">(</span><span class="op" id="8043699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8043702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8043706">for</span>&nbsp;<span class="ident" id="8043710">i</span>&nbsp;<span class="op" id="8043712">:=</span>&nbsp;<span class="num" id="8043715">0</span><span class="op" id="8043716">;</span>&nbsp;<span class="ident" id="8043718">i</span>&nbsp;<span class="op" id="8043720">&lt;</span>&nbsp;<span class="ident" id="8043722">numReqs</span><span class="op" id="8043729">;</span>&nbsp;<span class="ident" id="8043731">i</span><span class="op" id="8043732">++</span>&nbsp;<span class="op" id="8043735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8043739">reqs</span>&nbsp;<span class="op" id="8043744">&lt;-</span>&nbsp;<span class="builtintype" id="8043747">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8043753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8043757">wg</span><span class="op" id="8043759">.</span><span class="ident" id="8043760">Wait</span><span class="op" id="8043764">(</span><span class="op" id="8043765">)</span><br>
<span class="lineno">1765</span><span class="op" id="8043767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8043770">func</span>&nbsp;<span class="ident" id="8043775">manyConcurrentQueries</span><span class="op" id="8043796">(</span><span class="ident" id="8043797">t</span>&nbsp;<span class="ident" id="8043799">testing</span><span class="op" id="8043806">.</span><span class="ident" id="8043807">TB</span><span class="op" id="8043809">)</span>&nbsp;<span class="op" id="8043811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8043814">maxProcs</span><span class="op" id="8043822">,</span>&nbsp;<span class="ident" id="8043824">numReqs</span>&nbsp;<span class="op" id="8043832">:=</span>&nbsp;<span class="num" id="8043835">16</span><span class="op" id="8043837">,</span>&nbsp;<span class="num" id="8043839">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8043844">if</span>&nbsp;<span class="ident" id="8043847">testing</span><span class="op" id="8043854">.</span><span class="ident" id="8043855">Short</span><span class="op" id="8043860">(</span><span class="op" id="8043861">)</span>&nbsp;<span class="op" id="8043863">{</span><br>
<span class="lineno">1770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8043867">maxProcs</span><span class="op" id="8043875">,</span>&nbsp;<span class="ident" id="8043877">numReqs</span>&nbsp;<span class="op" id="8043885">=</span>&nbsp;<span class="num" id="8043887">4</span><span class="op" id="8043888">,</span>&nbsp;<span class="num" id="8043890">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8043894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8043897">defer</span>&nbsp;<span class="ident" id="8043903">runtime</span><span class="op" id="8043910">.</span><span class="ident" id="8043911">GOMAXPROCS</span><span class="op" id="8043921">(</span><span class="ident" id="8043922">runtime</span><span class="op" id="8043929">.</span><span class="ident" id="8043930">GOMAXPROCS</span><span class="op" id="8043940">(</span><span class="ident" id="8043941">maxProcs</span><span class="op" id="8043949">)</span><span class="op" id="8043950">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8043954">db</span>&nbsp;<span class="op" id="8043957">:=</span>&nbsp;<span class="ident" id="8043960">newTestDB</span><span class="op" id="8043969">(</span><span class="ident" id="8043970">t</span><span class="op" id="8043971">,</span>&nbsp;<span class="string" id="8043973">&#34;people&#34;</span><span class="op" id="8043981">)</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8043984">defer</span>&nbsp;<span class="ident" id="8043990">closeDB</span><span class="op" id="8043997">(</span><span class="ident" id="8043998">t</span><span class="op" id="8043999">,</span>&nbsp;<span class="ident" id="8044001">db</span><span class="op" id="8044003">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044007">stmt</span><span class="op" id="8044011">,</span>&nbsp;<span class="ident" id="8044013">err</span>&nbsp;<span class="op" id="8044017">:=</span>&nbsp;<span class="ident" id="8044020">db</span><span class="op" id="8044022">.</span><span class="ident" id="8044023">Prepare</span><span class="op" id="8044030">(</span><span class="string" id="8044031">&#34;SELECT|people|name|&#34;</span><span class="op" id="8044052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8044055">if</span>&nbsp;<span class="ident" id="8044058">err</span>&nbsp;<span class="op" id="8044062">!=</span>&nbsp;<span class="builtintype" id="8044065">nil</span>&nbsp;<span class="op" id="8044069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044073">t</span><span class="op" id="8044074">.</span><span class="ident" id="8044075">Fatal</span><span class="op" id="8044080">(</span><span class="ident" id="8044081">err</span><span class="op" id="8044084">)</span><br>
<span class="lineno">1780</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8044087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8044090">defer</span>&nbsp;<span class="ident" id="8044096">stmt</span><span class="op" id="8044100">.</span><span class="ident" id="8044101">Close</span><span class="op" id="8044106">(</span><span class="op" id="8044107">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8044111">var</span>&nbsp;<span class="ident" id="8044115">wg</span>&nbsp;<span class="ident" id="8044118">sync</span><span class="op" id="8044122">.</span><span class="ident" id="8044123">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044134">wg</span><span class="op" id="8044136">.</span><span class="ident" id="8044137">Add</span><span class="op" id="8044140">(</span><span class="ident" id="8044141">numReqs</span><span class="op" id="8044148">)</span><br>
<span class="lineno">1785</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044152">reqs</span>&nbsp;<span class="op" id="8044157">:=</span>&nbsp;<span class="builtinfunc" id="8044160">make</span><span class="op" id="8044164">(</span><span class="keyword" id="8044165">chan</span>&nbsp;<span class="builtintype" id="8044170">bool</span><span class="op" id="8044174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8044177">defer</span>&nbsp;<span class="builtinfunc" id="8044183">close</span><span class="op" id="8044188">(</span><span class="ident" id="8044189">reqs</span><span class="op" id="8044193">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8044197">for</span>&nbsp;<span class="ident" id="8044201">i</span>&nbsp;<span class="op" id="8044203">:=</span>&nbsp;<span class="num" id="8044206">0</span><span class="op" id="8044207">;</span>&nbsp;<span class="ident" id="8044209">i</span>&nbsp;<span class="op" id="8044211">&lt;</span>&nbsp;<span class="ident" id="8044213">maxProcs</span><span class="op" id="8044221">*</span><span class="num" id="8044222">2</span><span class="op" id="8044223">;</span>&nbsp;<span class="ident" id="8044225">i</span><span class="op" id="8044226">++</span>&nbsp;<span class="op" id="8044229">{</span><br>
<span class="lineno">1790</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8044233">go</span>&nbsp;<span class="keyword" id="8044236">func</span><span class="op" id="8044240">(</span><span class="op" id="8044241">)</span>&nbsp;<span class="op" id="8044243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8044248">for</span>&nbsp;<span class="keyword" id="8044252">range</span>&nbsp;<span class="ident" id="8044258">reqs</span>&nbsp;<span class="op" id="8044263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044269">rows</span><span class="op" id="8044273">,</span>&nbsp;<span class="ident" id="8044275">err</span>&nbsp;<span class="op" id="8044279">:=</span>&nbsp;<span class="ident" id="8044282">stmt</span><span class="op" id="8044286">.</span><span class="ident" id="8044287">Query</span><span class="op" id="8044292">(</span><span class="op" id="8044293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8044299">if</span>&nbsp;<span class="ident" id="8044302">err</span>&nbsp;<span class="op" id="8044306">!=</span>&nbsp;<span class="builtintype" id="8044309">nil</span>&nbsp;<span class="op" id="8044313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044320">t</span><span class="op" id="8044321">.</span><span class="ident" id="8044322">Errorf</span><span class="op" id="8044328">(</span><span class="string" id="8044329">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="8044350">,</span>&nbsp;<span class="ident" id="8044352">err</span><span class="op" id="8044355">)</span><br>
<span class="lineno">1795</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044362">wg</span><span class="op" id="8044364">.</span><span class="ident" id="8044365">Done</span><span class="op" id="8044369">(</span><span class="op" id="8044370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8044377">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8044390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8044397">var</span>&nbsp;<span class="ident" id="8044401">name</span>&nbsp;<span class="builtintype" id="8044406">string</span><br>
<span class="lineno">1800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8044417">for</span>&nbsp;<span class="ident" id="8044421">rows</span><span class="op" id="8044425">.</span><span class="ident" id="8044426">Next</span><span class="op" id="8044430">(</span><span class="op" id="8044431">)</span>&nbsp;<span class="op" id="8044433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044440">rows</span><span class="op" id="8044444">.</span><span class="ident" id="8044445">Scan</span><span class="op" id="8044449">(</span><span class="op" id="8044450">&amp;</span><span class="ident" id="8044451">name</span><span class="op" id="8044455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8044461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044467">rows</span><span class="op" id="8044471">.</span><span class="ident" id="8044472">Close</span><span class="op" id="8044477">(</span><span class="op" id="8044478">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044485">wg</span><span class="op" id="8044487">.</span><span class="ident" id="8044488">Done</span><span class="op" id="8044492">(</span><span class="op" id="8044493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8044498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8044502">}</span><span class="op" id="8044503">(</span><span class="op" id="8044504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8044507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1810</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8044511">for</span>&nbsp;<span class="ident" id="8044515">i</span>&nbsp;<span class="op" id="8044517">:=</span>&nbsp;<span class="num" id="8044520">0</span><span class="op" id="8044521">;</span>&nbsp;<span class="ident" id="8044523">i</span>&nbsp;<span class="op" id="8044525">&lt;</span>&nbsp;<span class="ident" id="8044527">numReqs</span><span class="op" id="8044534">;</span>&nbsp;<span class="ident" id="8044536">i</span><span class="op" id="8044537">++</span>&nbsp;<span class="op" id="8044540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044544">reqs</span>&nbsp;<span class="op" id="8044549">&lt;-</span>&nbsp;<span class="builtintype" id="8044552">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8044558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044562">wg</span><span class="op" id="8044564">.</span><span class="ident" id="8044565">Wait</span><span class="op" id="8044569">(</span><span class="op" id="8044570">)</span><br>
<span class="lineno">1815</span><span class="op" id="8044572">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8044575">func</span>&nbsp;<span class="ident" id="8044580">TestIssue6081</span><span class="op" id="8044593">(</span><span class="ident" id="8044594">t</span>&nbsp;<span class="op" id="8044596">*</span><span class="ident" id="8044597">testing</span><span class="op" id="8044604">.</span><span class="ident" id="8044605">T</span><span class="op" id="8044606">)</span>&nbsp;<span class="op" id="8044608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044611">db</span>&nbsp;<span class="op" id="8044614">:=</span>&nbsp;<span class="ident" id="8044617">newTestDB</span><span class="op" id="8044626">(</span><span class="ident" id="8044627">t</span><span class="op" id="8044628">,</span>&nbsp;<span class="string" id="8044630">&#34;people&#34;</span><span class="op" id="8044638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8044641">defer</span>&nbsp;<span class="ident" id="8044647">closeDB</span><span class="op" id="8044654">(</span><span class="ident" id="8044655">t</span><span class="op" id="8044656">,</span>&nbsp;<span class="ident" id="8044658">db</span><span class="op" id="8044660">)</span><br>
<span class="lineno">1820</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044664">drv</span>&nbsp;<span class="op" id="8044668">:=</span>&nbsp;<span class="ident" id="8044671">db</span><span class="op" id="8044673">.</span><span class="ident" id="8044674">driver</span><span class="op" id="8044680">.</span><span class="op" id="8044681">(</span><span class="op" id="8044682">*</span><span class="ident" id="8044683">fakeDriver</span><span class="op" id="8044693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044696">drv</span><span class="op" id="8044699">.</span><span class="ident" id="8044700">mu</span><span class="op" id="8044702">.</span><span class="ident" id="8044703">Lock</span><span class="op" id="8044707">(</span><span class="op" id="8044708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044711">opens0</span>&nbsp;<span class="op" id="8044718">:=</span>&nbsp;<span class="ident" id="8044721">drv</span><span class="op" id="8044724">.</span><span class="ident" id="8044725">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044736">closes0</span>&nbsp;<span class="op" id="8044744">:=</span>&nbsp;<span class="ident" id="8044747">drv</span><span class="op" id="8044750">.</span><span class="ident" id="8044751">closeCount</span><br>
<span class="lineno">1825</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044763">drv</span><span class="op" id="8044766">.</span><span class="ident" id="8044767">mu</span><span class="op" id="8044769">.</span><span class="ident" id="8044770">Unlock</span><span class="op" id="8044776">(</span><span class="op" id="8044777">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044781">stmt</span><span class="op" id="8044785">,</span>&nbsp;<span class="ident" id="8044787">err</span>&nbsp;<span class="op" id="8044791">:=</span>&nbsp;<span class="ident" id="8044794">db</span><span class="op" id="8044796">.</span><span class="ident" id="8044797">Prepare</span><span class="op" id="8044804">(</span><span class="string" id="8044805">&#34;SELECT|people|name|&#34;</span><span class="op" id="8044826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8044829">if</span>&nbsp;<span class="ident" id="8044832">err</span>&nbsp;<span class="op" id="8044836">!=</span>&nbsp;<span class="builtintype" id="8044839">nil</span>&nbsp;<span class="op" id="8044843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044847">t</span><span class="op" id="8044848">.</span><span class="ident" id="8044849">Fatal</span><span class="op" id="8044854">(</span><span class="ident" id="8044855">err</span><span class="op" id="8044858">)</span><br>
<span class="lineno">1830</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8044861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8044864">rowsCloseHook</span>&nbsp;<span class="op" id="8044878">=</span>&nbsp;<span class="keyword" id="8044880">func</span><span class="op" id="8044884">(</span><span class="ident" id="8044885">rows</span>&nbsp;<span class="op" id="8044890">*</span><span class="ident" id="8044891">Rows</span><span class="op" id="8044895">,</span>&nbsp;<span class="ident" id="8044897">err</span>&nbsp;<span class="op" id="8044901">*</span><span class="builtintype" id="8044902">error</span><span class="op" id="8044907">)</span>&nbsp;<span class="op" id="8044909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8044913">*</span><span class="ident" id="8044914">err</span>&nbsp;<span class="op" id="8044918">=</span>&nbsp;<span class="ident" id="8044920">driver</span><span class="op" id="8044926">.</span><span class="ident" id="8044927">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8044939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8044942">defer</span>&nbsp;<span class="keyword" id="8044948">func</span><span class="op" id="8044952">(</span><span class="op" id="8044953">)</span>&nbsp;<span class="op" id="8044955">{</span>&nbsp;<span class="ident" id="8044957">rowsCloseHook</span>&nbsp;<span class="op" id="8044971">=</span>&nbsp;<span class="builtintype" id="8044973">nil</span>&nbsp;<span class="op" id="8044977">}</span><span class="op" id="8044978">(</span><span class="op" id="8044979">)</span><br>
<span class="lineno">1835</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8044982">for</span>&nbsp;<span class="ident" id="8044986">i</span>&nbsp;<span class="op" id="8044988">:=</span>&nbsp;<span class="num" id="8044991">0</span><span class="op" id="8044992">;</span>&nbsp;<span class="ident" id="8044994">i</span>&nbsp;<span class="op" id="8044996">&lt;</span>&nbsp;<span class="num" id="8044998">10</span><span class="op" id="8045000">;</span>&nbsp;<span class="ident" id="8045002">i</span><span class="op" id="8045003">++</span>&nbsp;<span class="op" id="8045006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8045010">rows</span><span class="op" id="8045014">,</span>&nbsp;<span class="ident" id="8045016">err</span>&nbsp;<span class="op" id="8045020">:=</span>&nbsp;<span class="ident" id="8045023">stmt</span><span class="op" id="8045027">.</span><span class="ident" id="8045028">Query</span><span class="op" id="8045033">(</span><span class="op" id="8045034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8045038">if</span>&nbsp;<span class="ident" id="8045041">err</span>&nbsp;<span class="op" id="8045045">!=</span>&nbsp;<span class="builtintype" id="8045048">nil</span>&nbsp;<span class="op" id="8045052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8045057">t</span><span class="op" id="8045058">.</span><span class="ident" id="8045059">Fatal</span><span class="op" id="8045064">(</span><span class="ident" id="8045065">err</span><span class="op" id="8045068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8045072">}</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8045076">rows</span><span class="op" id="8045080">.</span><span class="ident" id="8045081">Close</span><span class="op" id="8045086">(</span><span class="op" id="8045087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8045090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8045093">if</span>&nbsp;<span class="ident" id="8045096">n</span>&nbsp;<span class="op" id="8045098">:=</span>&nbsp;<span class="builtinfunc" id="8045101">len</span><span class="op" id="8045104">(</span><span class="ident" id="8045105">stmt</span><span class="op" id="8045109">.</span><span class="ident" id="8045110">css</span><span class="op" id="8045113">)</span><span class="op" id="8045114">;</span>&nbsp;<span class="ident" id="8045116">n</span>&nbsp;<span class="op" id="8045118">&gt;</span>&nbsp;<span class="num" id="8045120">1</span>&nbsp;<span class="op" id="8045122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8045126">t</span><span class="op" id="8045127">.</span><span class="ident" id="8045128">Errorf</span><span class="op" id="8045134">(</span><span class="string" id="8045135">&#34;len(css&nbsp;slice)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="8045167">,</span>&nbsp;<span class="ident" id="8045169">n</span><span class="op" id="8045170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8045173">}</span><br>
<span class="lineno">1845</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8045176">stmt</span><span class="op" id="8045180">.</span><span class="ident" id="8045181">Close</span><span class="op" id="8045186">(</span><span class="op" id="8045187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8045190">if</span>&nbsp;<span class="ident" id="8045193">n</span>&nbsp;<span class="op" id="8045195">:=</span>&nbsp;<span class="builtinfunc" id="8045198">len</span><span class="op" id="8045201">(</span><span class="ident" id="8045202">stmt</span><span class="op" id="8045206">.</span><span class="ident" id="8045207">css</span><span class="op" id="8045210">)</span><span class="op" id="8045211">;</span>&nbsp;<span class="ident" id="8045213">n</span>&nbsp;<span class="op" id="8045215">!=</span>&nbsp;<span class="num" id="8045218">0</span>&nbsp;<span class="op" id="8045220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8045224">t</span><span class="op" id="8045225">.</span><span class="ident" id="8045226">Errorf</span><span class="op" id="8045232">(</span><span class="string" id="8045233">&#34;len(css&nbsp;slice)&nbsp;after&nbsp;Close&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="8045274">,</span>&nbsp;<span class="ident" id="8045276">n</span><span class="op" id="8045277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8045280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1850</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8045284">drv</span><span class="op" id="8045287">.</span><span class="ident" id="8045288">mu</span><span class="op" id="8045290">.</span><span class="ident" id="8045291">Lock</span><span class="op" id="8045295">(</span><span class="op" id="8045296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8045299">opens</span>&nbsp;<span class="op" id="8045305">:=</span>&nbsp;<span class="ident" id="8045308">drv</span><span class="op" id="8045311">.</span><span class="ident" id="8045312">openCount</span>&nbsp;<span class="op" id="8045322">-</span>&nbsp;<span class="ident" id="8045324">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8045332">closes</span>&nbsp;<span class="op" id="8045339">:=</span>&nbsp;<span class="ident" id="8045342">drv</span><span class="op" id="8045345">.</span><span class="ident" id="8045346">closeCount</span>&nbsp;<span class="op" id="8045357">-</span>&nbsp;<span class="ident" id="8045359">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8045368">drv</span><span class="op" id="8045371">.</span><span class="ident" id="8045372">mu</span><span class="op" id="8045374">.</span><span class="ident" id="8045375">Unlock</span><span class="op" id="8045381">(</span><span class="op" id="8045382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8045385">if</span>&nbsp;<span class="ident" id="8045388">opens</span>&nbsp;<span class="op" id="8045394">&lt;</span>&nbsp;<span class="num" id="8045396">9</span>&nbsp;<span class="op" id="8045398">{</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8045402">t</span><span class="op" id="8045403">.</span><span class="ident" id="8045404">Errorf</span><span class="op" id="8045410">(</span><span class="string" id="8045411">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="8045434">,</span>&nbsp;<span class="ident" id="8045436">opens</span><span class="op" id="8045441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8045444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8045447">if</span>&nbsp;<span class="ident" id="8045450">closes</span>&nbsp;<span class="op" id="8045457">&lt;</span>&nbsp;<span class="num" id="8045459">9</span>&nbsp;<span class="op" id="8045461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8045465">t</span><span class="op" id="8045466">.</span><span class="ident" id="8045467">Errorf</span><span class="op" id="8045473">(</span><span class="string" id="8045474">&#34;closes&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="8045498">,</span>&nbsp;<span class="ident" id="8045500">closes</span><span class="op" id="8045506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8045509">}</span><br>
<span class="lineno">1860</span><span class="op" id="8045511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8045514">func</span>&nbsp;<span class="ident" id="8045519">TestConcurrency</span><span class="op" id="8045534">(</span><span class="ident" id="8045535">t</span>&nbsp;<span class="op" id="8045537">*</span><span class="ident" id="8045538">testing</span><span class="op" id="8045545">.</span><span class="ident" id="8045546">T</span><span class="op" id="8045547">)</span>&nbsp;<span class="op" id="8045549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8045552">doConcurrentTest</span><span class="op" id="8045568">(</span><span class="ident" id="8045569">t</span><span class="op" id="8045570">,</span>&nbsp;<span class="builtinfunc" id="8045572">new</span><span class="op" id="8045575">(</span><span class="ident" id="8045576">concurrentDBQueryTest</span><span class="op" id="8045597">)</span><span class="op" id="8045598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8045601">doConcurrentTest</span><span class="op" id="8045617">(</span><span class="ident" id="8045618">t</span><span class="op" id="8045619">,</span>&nbsp;<span class="builtinfunc" id="8045621">new</span><span class="op" id="8045624">(</span><span class="ident" id="8045625">concurrentDBExecTest</span><span class="op" id="8045645">)</span><span class="op" id="8045646">)</span><br>
<span class="lineno">1865</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8045649">doConcurrentTest</span><span class="op" id="8045665">(</span><span class="ident" id="8045666">t</span><span class="op" id="8045667">,</span>&nbsp;<span class="builtinfunc" id="8045669">new</span><span class="op" id="8045672">(</span><span class="ident" id="8045673">concurrentStmtQueryTest</span><span class="op" id="8045696">)</span><span class="op" id="8045697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8045700">doConcurrentTest</span><span class="op" id="8045716">(</span><span class="ident" id="8045717">t</span><span class="op" id="8045718">,</span>&nbsp;<span class="builtinfunc" id="8045720">new</span><span class="op" id="8045723">(</span><span class="ident" id="8045724">concurrentStmtExecTest</span><span class="op" id="8045746">)</span><span class="op" id="8045747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8045750">doConcurrentTest</span><span class="op" id="8045766">(</span><span class="ident" id="8045767">t</span><span class="op" id="8045768">,</span>&nbsp;<span class="builtinfunc" id="8045770">new</span><span class="op" id="8045773">(</span><span class="ident" id="8045774">concurrentTxQueryTest</span><span class="op" id="8045795">)</span><span class="op" id="8045796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8045799">doConcurrentTest</span><span class="op" id="8045815">(</span><span class="ident" id="8045816">t</span><span class="op" id="8045817">,</span>&nbsp;<span class="builtinfunc" id="8045819">new</span><span class="op" id="8045822">(</span><span class="ident" id="8045823">concurrentTxExecTest</span><span class="op" id="8045843">)</span><span class="op" id="8045844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8045847">doConcurrentTest</span><span class="op" id="8045863">(</span><span class="ident" id="8045864">t</span><span class="op" id="8045865">,</span>&nbsp;<span class="builtinfunc" id="8045867">new</span><span class="op" id="8045870">(</span><span class="ident" id="8045871">concurrentTxStmtQueryTest</span><span class="op" id="8045896">)</span><span class="op" id="8045897">)</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8045900">doConcurrentTest</span><span class="op" id="8045916">(</span><span class="ident" id="8045917">t</span><span class="op" id="8045918">,</span>&nbsp;<span class="builtinfunc" id="8045920">new</span><span class="op" id="8045923">(</span><span class="ident" id="8045924">concurrentTxStmtExecTest</span><span class="op" id="8045948">)</span><span class="op" id="8045949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8045952">doConcurrentTest</span><span class="op" id="8045968">(</span><span class="ident" id="8045969">t</span><span class="op" id="8045970">,</span>&nbsp;<span class="builtinfunc" id="8045972">new</span><span class="op" id="8045975">(</span><span class="ident" id="8045976">concurrentRandomTest</span><span class="op" id="8045996">)</span><span class="op" id="8045997">)</span><br>
<span class="lineno"></span><span class="op" id="8045999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8046002">func</span>&nbsp;<span class="ident" id="8046007">TestConnectionLeak</span><span class="op" id="8046025">(</span><span class="ident" id="8046026">t</span>&nbsp;<span class="op" id="8046028">*</span><span class="ident" id="8046029">testing</span><span class="op" id="8046036">.</span><span class="ident" id="8046037">T</span><span class="op" id="8046038">)</span>&nbsp;<span class="op" id="8046040">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8046043">db</span>&nbsp;<span class="op" id="8046046">:=</span>&nbsp;<span class="ident" id="8046049">newTestDB</span><span class="op" id="8046058">(</span><span class="ident" id="8046059">t</span><span class="op" id="8046060">,</span>&nbsp;<span class="string" id="8046062">&#34;people&#34;</span><span class="op" id="8046070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8046073">defer</span>&nbsp;<span class="ident" id="8046079">closeDB</span><span class="op" id="8046086">(</span><span class="ident" id="8046087">t</span><span class="op" id="8046088">,</span>&nbsp;<span class="ident" id="8046090">db</span><span class="op" id="8046092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8046095">//&nbsp;Start&nbsp;by&nbsp;opening&nbsp;defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8046136">rows</span>&nbsp;<span class="op" id="8046141">:=</span>&nbsp;<span class="builtinfunc" id="8046144">make</span><span class="op" id="8046148">(</span><span class="op" id="8046149">[</span><span class="op" id="8046150">]</span><span class="op" id="8046151">*</span><span class="ident" id="8046152">Rows</span><span class="op" id="8046156">,</span>&nbsp;<span class="ident" id="8046158">defaultMaxIdleConns</span><span class="op" id="8046177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8046180">//&nbsp;We&nbsp;need&nbsp;to&nbsp;SetMaxOpenConns&nbsp;&gt;&nbsp;MaxIdleConns,&nbsp;so&nbsp;the&nbsp;DB&nbsp;can&nbsp;open</span><br>
<span class="lineno">1880</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8046246">//&nbsp;a&nbsp;new&nbsp;connection&nbsp;and&nbsp;we&nbsp;can&nbsp;fill&nbsp;the&nbsp;idle&nbsp;queue&nbsp;with&nbsp;the&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8046316">//&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8046333">db</span><span class="op" id="8046335">.</span><span class="ident" id="8046336">SetMaxOpenConns</span><span class="op" id="8046351">(</span><span class="builtinfunc" id="8046352">len</span><span class="op" id="8046355">(</span><span class="ident" id="8046356">rows</span><span class="op" id="8046360">)</span>&nbsp;<span class="op" id="8046362">+</span>&nbsp;<span class="num" id="8046364">1</span><span class="op" id="8046365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8046368">for</span>&nbsp;<span class="ident" id="8046372">ii</span>&nbsp;<span class="op" id="8046375">:=</span>&nbsp;<span class="keyword" id="8046378">range</span>&nbsp;<span class="ident" id="8046384">rows</span>&nbsp;<span class="op" id="8046389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8046393">r</span><span class="op" id="8046394">,</span>&nbsp;<span class="ident" id="8046396">err</span>&nbsp;<span class="op" id="8046400">:=</span>&nbsp;<span class="ident" id="8046403">db</span><span class="op" id="8046405">.</span><span class="ident" id="8046406">Query</span><span class="op" id="8046411">(</span><span class="string" id="8046412">&#34;SELECT|people|name|&#34;</span><span class="op" id="8046433">)</span><br>
<span class="lineno">1885</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8046437">if</span>&nbsp;<span class="ident" id="8046440">err</span>&nbsp;<span class="op" id="8046444">!=</span>&nbsp;<span class="builtintype" id="8046447">nil</span>&nbsp;<span class="op" id="8046451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8046456">t</span><span class="op" id="8046457">.</span><span class="ident" id="8046458">Fatal</span><span class="op" id="8046463">(</span><span class="ident" id="8046464">err</span><span class="op" id="8046467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8046471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8046475">r</span><span class="op" id="8046476">.</span><span class="ident" id="8046477">Next</span><span class="op" id="8046481">(</span><span class="op" id="8046482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8046486">if</span>&nbsp;<span class="ident" id="8046489">err</span>&nbsp;<span class="op" id="8046493">:=</span>&nbsp;<span class="ident" id="8046496">r</span><span class="op" id="8046497">.</span><span class="ident" id="8046498">Err</span><span class="op" id="8046501">(</span><span class="op" id="8046502">)</span><span class="op" id="8046503">;</span>&nbsp;<span class="ident" id="8046505">err</span>&nbsp;<span class="op" id="8046509">!=</span>&nbsp;<span class="builtintype" id="8046512">nil</span>&nbsp;<span class="op" id="8046516">{</span><br>
<span class="lineno">1890</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8046521">t</span><span class="op" id="8046522">.</span><span class="ident" id="8046523">Fatal</span><span class="op" id="8046528">(</span><span class="ident" id="8046529">err</span><span class="op" id="8046532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8046536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8046540">rows</span><span class="op" id="8046544">[</span><span class="ident" id="8046545">ii</span><span class="op" id="8046547">]</span>&nbsp;<span class="op" id="8046549">=</span>&nbsp;<span class="ident" id="8046551">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8046554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8046557">//&nbsp;Now&nbsp;we&nbsp;have&nbsp;defaultMaxIdleConns&nbsp;busy&nbsp;connections.&nbsp;Open</span><br>
<span class="lineno">1895</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8046616">//&nbsp;a&nbsp;new&nbsp;one,&nbsp;but&nbsp;wait&nbsp;until&nbsp;the&nbsp;busy&nbsp;connections&nbsp;are&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8046680">//&nbsp;before&nbsp;returning&nbsp;control&nbsp;to&nbsp;DB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8046716">drv</span>&nbsp;<span class="op" id="8046720">:=</span>&nbsp;<span class="ident" id="8046723">db</span><span class="op" id="8046725">.</span><span class="ident" id="8046726">driver</span><span class="op" id="8046732">.</span><span class="op" id="8046733">(</span><span class="op" id="8046734">*</span><span class="ident" id="8046735">fakeDriver</span><span class="op" id="8046745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8046748">drv</span><span class="op" id="8046751">.</span><span class="ident" id="8046752">waitCh</span>&nbsp;<span class="op" id="8046759">=</span>&nbsp;<span class="builtinfunc" id="8046761">make</span><span class="op" id="8046765">(</span><span class="keyword" id="8046766">chan</span>&nbsp;<span class="keyword" id="8046771">struct</span><span class="op" id="8046777">{</span><span class="op" id="8046778">}</span><span class="op" id="8046779">,</span>&nbsp;<span class="num" id="8046781">1</span><span class="op" id="8046782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8046785">drv</span><span class="op" id="8046788">.</span><span class="ident" id="8046789">waitingCh</span>&nbsp;<span class="op" id="8046799">=</span>&nbsp;<span class="builtinfunc" id="8046801">make</span><span class="op" id="8046805">(</span><span class="keyword" id="8046806">chan</span>&nbsp;<span class="keyword" id="8046811">struct</span><span class="op" id="8046817">{</span><span class="op" id="8046818">}</span><span class="op" id="8046819">,</span>&nbsp;<span class="num" id="8046821">1</span><span class="op" id="8046822">)</span><br>
<span class="lineno">1900</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8046825">var</span>&nbsp;<span class="ident" id="8046829">wg</span>&nbsp;<span class="ident" id="8046832">sync</span><span class="op" id="8046836">.</span><span class="ident" id="8046837">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8046848">wg</span><span class="op" id="8046850">.</span><span class="ident" id="8046851">Add</span><span class="op" id="8046854">(</span><span class="num" id="8046855">1</span><span class="op" id="8046856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8046859">go</span>&nbsp;<span class="keyword" id="8046862">func</span><span class="op" id="8046866">(</span><span class="op" id="8046867">)</span>&nbsp;<span class="op" id="8046869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8046873">r</span><span class="op" id="8046874">,</span>&nbsp;<span class="ident" id="8046876">err</span>&nbsp;<span class="op" id="8046880">:=</span>&nbsp;<span class="ident" id="8046883">db</span><span class="op" id="8046885">.</span><span class="ident" id="8046886">Query</span><span class="op" id="8046891">(</span><span class="string" id="8046892">&#34;SELECT|people|name|&#34;</span><span class="op" id="8046913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8046917">if</span>&nbsp;<span class="ident" id="8046920">err</span>&nbsp;<span class="op" id="8046924">!=</span>&nbsp;<span class="builtintype" id="8046927">nil</span>&nbsp;<span class="op" id="8046931">{</span><br>
<span class="lineno">1905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8046936">t</span><span class="op" id="8046937">.</span><span class="ident" id="8046938">Fatal</span><span class="op" id="8046943">(</span><span class="ident" id="8046944">err</span><span class="op" id="8046947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8046951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8046955">r</span><span class="op" id="8046956">.</span><span class="ident" id="8046957">Close</span><span class="op" id="8046962">(</span><span class="op" id="8046963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8046967">wg</span><span class="op" id="8046969">.</span><span class="ident" id="8046970">Done</span><span class="op" id="8046974">(</span><span class="op" id="8046975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8046978">}</span><span class="op" id="8046979">(</span><span class="op" id="8046980">)</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8046983">//&nbsp;Wait&nbsp;until&nbsp;the&nbsp;goroutine&nbsp;we&#39;ve&nbsp;just&nbsp;created&nbsp;has&nbsp;started&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8047052">&lt;-</span><span class="ident" id="8047054">drv</span><span class="op" id="8047057">.</span><span class="ident" id="8047058">waitingCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8047069">//&nbsp;Now&nbsp;close&nbsp;the&nbsp;busy&nbsp;connections.&nbsp;This&nbsp;provides&nbsp;a&nbsp;connection&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8047136">//&nbsp;the&nbsp;blocked&nbsp;goroutine&nbsp;and&nbsp;then&nbsp;fills&nbsp;up&nbsp;the&nbsp;idle&nbsp;queue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8047196">for</span>&nbsp;<span class="ident" id="8047200">_</span><span class="op" id="8047201">,</span>&nbsp;<span class="ident" id="8047203">v</span>&nbsp;<span class="op" id="8047205">:=</span>&nbsp;<span class="keyword" id="8047208">range</span>&nbsp;<span class="ident" id="8047214">rows</span>&nbsp;<span class="op" id="8047219">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8047223">v</span><span class="op" id="8047224">.</span><span class="ident" id="8047225">Close</span><span class="op" id="8047230">(</span><span class="op" id="8047231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8047234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8047237">//&nbsp;At&nbsp;this&nbsp;point&nbsp;we&nbsp;give&nbsp;the&nbsp;new&nbsp;connection&nbsp;to&nbsp;DB.&nbsp;This&nbsp;connection&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8047308">//&nbsp;now&nbsp;useless,&nbsp;since&nbsp;the&nbsp;idle&nbsp;queue&nbsp;is&nbsp;full&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8047379">//&nbsp;requests.&nbsp;DB&nbsp;should&nbsp;deal&nbsp;with&nbsp;this&nbsp;situation&nbsp;without&nbsp;leaking&nbsp;the</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8047448">//&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8047464">drv</span><span class="op" id="8047467">.</span><span class="ident" id="8047468">waitCh</span>&nbsp;<span class="op" id="8047475">&lt;-</span>&nbsp;<span class="keyword" id="8047478">struct</span><span class="op" id="8047484">{</span><span class="op" id="8047485">}</span><span class="op" id="8047486">{</span><span class="op" id="8047487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8047490">wg</span><span class="op" id="8047492">.</span><span class="ident" id="8047493">Wait</span><span class="op" id="8047497">(</span><span class="op" id="8047498">)</span><br>
<span class="lineno"></span><span class="op" id="8047500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1925</span><span class="keyword" id="8047503">func</span>&nbsp;<span class="ident" id="8047508">BenchmarkConcurrentDBExec</span><span class="op" id="8047533">(</span><span class="ident" id="8047534">b</span>&nbsp;<span class="op" id="8047536">*</span><span class="ident" id="8047537">testing</span><span class="op" id="8047544">.</span><span class="ident" id="8047545">B</span><span class="op" id="8047546">)</span>&nbsp;<span class="op" id="8047548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8047551">b</span><span class="op" id="8047552">.</span><span class="ident" id="8047553">ReportAllocs</span><span class="op" id="8047565">(</span><span class="op" id="8047566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8047569">ct</span>&nbsp;<span class="op" id="8047572">:=</span>&nbsp;<span class="builtinfunc" id="8047575">new</span><span class="op" id="8047578">(</span><span class="ident" id="8047579">concurrentDBExecTest</span><span class="op" id="8047599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8047602">for</span>&nbsp;<span class="ident" id="8047606">i</span>&nbsp;<span class="op" id="8047608">:=</span>&nbsp;<span class="num" id="8047611">0</span><span class="op" id="8047612">;</span>&nbsp;<span class="ident" id="8047614">i</span>&nbsp;<span class="op" id="8047616">&lt;</span>&nbsp;<span class="ident" id="8047618">b</span><span class="op" id="8047619">.</span><span class="ident" id="8047620">N</span><span class="op" id="8047621">;</span>&nbsp;<span class="ident" id="8047623">i</span><span class="op" id="8047624">++</span>&nbsp;<span class="op" id="8047627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8047631">doConcurrentTest</span><span class="op" id="8047647">(</span><span class="ident" id="8047648">b</span><span class="op" id="8047649">,</span>&nbsp;<span class="ident" id="8047651">ct</span><span class="op" id="8047653">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8047656">}</span><br>
<span class="lineno"></span><span class="op" id="8047658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8047661">func</span>&nbsp;<span class="ident" id="8047666">BenchmarkConcurrentStmtQuery</span><span class="op" id="8047694">(</span><span class="ident" id="8047695">b</span>&nbsp;<span class="op" id="8047697">*</span><span class="ident" id="8047698">testing</span><span class="op" id="8047705">.</span><span class="ident" id="8047706">B</span><span class="op" id="8047707">)</span>&nbsp;<span class="op" id="8047709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8047712">b</span><span class="op" id="8047713">.</span><span class="ident" id="8047714">ReportAllocs</span><span class="op" id="8047726">(</span><span class="op" id="8047727">)</span><br>
<span class="lineno">1935</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8047730">ct</span>&nbsp;<span class="op" id="8047733">:=</span>&nbsp;<span class="builtinfunc" id="8047736">new</span><span class="op" id="8047739">(</span><span class="ident" id="8047740">concurrentStmtQueryTest</span><span class="op" id="8047763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8047766">for</span>&nbsp;<span class="ident" id="8047770">i</span>&nbsp;<span class="op" id="8047772">:=</span>&nbsp;<span class="num" id="8047775">0</span><span class="op" id="8047776">;</span>&nbsp;<span class="ident" id="8047778">i</span>&nbsp;<span class="op" id="8047780">&lt;</span>&nbsp;<span class="ident" id="8047782">b</span><span class="op" id="8047783">.</span><span class="ident" id="8047784">N</span><span class="op" id="8047785">;</span>&nbsp;<span class="ident" id="8047787">i</span><span class="op" id="8047788">++</span>&nbsp;<span class="op" id="8047791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8047795">doConcurrentTest</span><span class="op" id="8047811">(</span><span class="ident" id="8047812">b</span><span class="op" id="8047813">,</span>&nbsp;<span class="ident" id="8047815">ct</span><span class="op" id="8047817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8047820">}</span><br>
<span class="lineno"></span><span class="op" id="8047822">}</span><br>
<span class="lineno">1940</span><br>
<span class="lineno"></span><span class="keyword" id="8047825">func</span>&nbsp;<span class="ident" id="8047830">BenchmarkConcurrentStmtExec</span><span class="op" id="8047857">(</span><span class="ident" id="8047858">b</span>&nbsp;<span class="op" id="8047860">*</span><span class="ident" id="8047861">testing</span><span class="op" id="8047868">.</span><span class="ident" id="8047869">B</span><span class="op" id="8047870">)</span>&nbsp;<span class="op" id="8047872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8047875">b</span><span class="op" id="8047876">.</span><span class="ident" id="8047877">ReportAllocs</span><span class="op" id="8047889">(</span><span class="op" id="8047890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8047893">ct</span>&nbsp;<span class="op" id="8047896">:=</span>&nbsp;<span class="builtinfunc" id="8047899">new</span><span class="op" id="8047902">(</span><span class="ident" id="8047903">concurrentStmtExecTest</span><span class="op" id="8047925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8047928">for</span>&nbsp;<span class="ident" id="8047932">i</span>&nbsp;<span class="op" id="8047934">:=</span>&nbsp;<span class="num" id="8047937">0</span><span class="op" id="8047938">;</span>&nbsp;<span class="ident" id="8047940">i</span>&nbsp;<span class="op" id="8047942">&lt;</span>&nbsp;<span class="ident" id="8047944">b</span><span class="op" id="8047945">.</span><span class="ident" id="8047946">N</span><span class="op" id="8047947">;</span>&nbsp;<span class="ident" id="8047949">i</span><span class="op" id="8047950">++</span>&nbsp;<span class="op" id="8047953">{</span><br>
<span class="lineno">1945</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8047957">doConcurrentTest</span><span class="op" id="8047973">(</span><span class="ident" id="8047974">b</span><span class="op" id="8047975">,</span>&nbsp;<span class="ident" id="8047977">ct</span><span class="op" id="8047979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8047982">}</span><br>
<span class="lineno"></span><span class="op" id="8047984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8047987">func</span>&nbsp;<span class="ident" id="8047992">BenchmarkConcurrentTxQuery</span><span class="op" id="8048018">(</span><span class="ident" id="8048019">b</span>&nbsp;<span class="op" id="8048021">*</span><span class="ident" id="8048022">testing</span><span class="op" id="8048029">.</span><span class="ident" id="8048030">B</span><span class="op" id="8048031">)</span>&nbsp;<span class="op" id="8048033">{</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8048036">b</span><span class="op" id="8048037">.</span><span class="ident" id="8048038">ReportAllocs</span><span class="op" id="8048050">(</span><span class="op" id="8048051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8048054">ct</span>&nbsp;<span class="op" id="8048057">:=</span>&nbsp;<span class="builtinfunc" id="8048060">new</span><span class="op" id="8048063">(</span><span class="ident" id="8048064">concurrentTxQueryTest</span><span class="op" id="8048085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8048088">for</span>&nbsp;<span class="ident" id="8048092">i</span>&nbsp;<span class="op" id="8048094">:=</span>&nbsp;<span class="num" id="8048097">0</span><span class="op" id="8048098">;</span>&nbsp;<span class="ident" id="8048100">i</span>&nbsp;<span class="op" id="8048102">&lt;</span>&nbsp;<span class="ident" id="8048104">b</span><span class="op" id="8048105">.</span><span class="ident" id="8048106">N</span><span class="op" id="8048107">;</span>&nbsp;<span class="ident" id="8048109">i</span><span class="op" id="8048110">++</span>&nbsp;<span class="op" id="8048113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8048117">doConcurrentTest</span><span class="op" id="8048133">(</span><span class="ident" id="8048134">b</span><span class="op" id="8048135">,</span>&nbsp;<span class="ident" id="8048137">ct</span><span class="op" id="8048139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8048142">}</span><br>
<span class="lineno">1955</span><span class="op" id="8048144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8048147">func</span>&nbsp;<span class="ident" id="8048152">BenchmarkConcurrentTxExec</span><span class="op" id="8048177">(</span><span class="ident" id="8048178">b</span>&nbsp;<span class="op" id="8048180">*</span><span class="ident" id="8048181">testing</span><span class="op" id="8048188">.</span><span class="ident" id="8048189">B</span><span class="op" id="8048190">)</span>&nbsp;<span class="op" id="8048192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8048195">b</span><span class="op" id="8048196">.</span><span class="ident" id="8048197">ReportAllocs</span><span class="op" id="8048209">(</span><span class="op" id="8048210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8048213">ct</span>&nbsp;<span class="op" id="8048216">:=</span>&nbsp;<span class="builtinfunc" id="8048219">new</span><span class="op" id="8048222">(</span><span class="ident" id="8048223">concurrentTxExecTest</span><span class="op" id="8048243">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8048246">for</span>&nbsp;<span class="ident" id="8048250">i</span>&nbsp;<span class="op" id="8048252">:=</span>&nbsp;<span class="num" id="8048255">0</span><span class="op" id="8048256">;</span>&nbsp;<span class="ident" id="8048258">i</span>&nbsp;<span class="op" id="8048260">&lt;</span>&nbsp;<span class="ident" id="8048262">b</span><span class="op" id="8048263">.</span><span class="ident" id="8048264">N</span><span class="op" id="8048265">;</span>&nbsp;<span class="ident" id="8048267">i</span><span class="op" id="8048268">++</span>&nbsp;<span class="op" id="8048271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8048275">doConcurrentTest</span><span class="op" id="8048291">(</span><span class="ident" id="8048292">b</span><span class="op" id="8048293">,</span>&nbsp;<span class="ident" id="8048295">ct</span><span class="op" id="8048297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8048300">}</span><br>
<span class="lineno"></span><span class="op" id="8048302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1965</span><span class="keyword" id="8048305">func</span>&nbsp;<span class="ident" id="8048310">BenchmarkConcurrentTxStmtQuery</span><span class="op" id="8048340">(</span><span class="ident" id="8048341">b</span>&nbsp;<span class="op" id="8048343">*</span><span class="ident" id="8048344">testing</span><span class="op" id="8048351">.</span><span class="ident" id="8048352">B</span><span class="op" id="8048353">)</span>&nbsp;<span class="op" id="8048355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8048358">b</span><span class="op" id="8048359">.</span><span class="ident" id="8048360">ReportAllocs</span><span class="op" id="8048372">(</span><span class="op" id="8048373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8048376">ct</span>&nbsp;<span class="op" id="8048379">:=</span>&nbsp;<span class="builtinfunc" id="8048382">new</span><span class="op" id="8048385">(</span><span class="ident" id="8048386">concurrentTxStmtQueryTest</span><span class="op" id="8048411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8048414">for</span>&nbsp;<span class="ident" id="8048418">i</span>&nbsp;<span class="op" id="8048420">:=</span>&nbsp;<span class="num" id="8048423">0</span><span class="op" id="8048424">;</span>&nbsp;<span class="ident" id="8048426">i</span>&nbsp;<span class="op" id="8048428">&lt;</span>&nbsp;<span class="ident" id="8048430">b</span><span class="op" id="8048431">.</span><span class="ident" id="8048432">N</span><span class="op" id="8048433">;</span>&nbsp;<span class="ident" id="8048435">i</span><span class="op" id="8048436">++</span>&nbsp;<span class="op" id="8048439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8048443">doConcurrentTest</span><span class="op" id="8048459">(</span><span class="ident" id="8048460">b</span><span class="op" id="8048461">,</span>&nbsp;<span class="ident" id="8048463">ct</span><span class="op" id="8048465">)</span><br>
<span class="lineno">1970</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8048468">}</span><br>
<span class="lineno"></span><span class="op" id="8048470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8048473">func</span>&nbsp;<span class="ident" id="8048478">BenchmarkConcurrentTxStmtExec</span><span class="op" id="8048507">(</span><span class="ident" id="8048508">b</span>&nbsp;<span class="op" id="8048510">*</span><span class="ident" id="8048511">testing</span><span class="op" id="8048518">.</span><span class="ident" id="8048519">B</span><span class="op" id="8048520">)</span>&nbsp;<span class="op" id="8048522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8048525">b</span><span class="op" id="8048526">.</span><span class="ident" id="8048527">ReportAllocs</span><span class="op" id="8048539">(</span><span class="op" id="8048540">)</span><br>
<span class="lineno">1975</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8048543">ct</span>&nbsp;<span class="op" id="8048546">:=</span>&nbsp;<span class="builtinfunc" id="8048549">new</span><span class="op" id="8048552">(</span><span class="ident" id="8048553">concurrentTxStmtExecTest</span><span class="op" id="8048577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8048580">for</span>&nbsp;<span class="ident" id="8048584">i</span>&nbsp;<span class="op" id="8048586">:=</span>&nbsp;<span class="num" id="8048589">0</span><span class="op" id="8048590">;</span>&nbsp;<span class="ident" id="8048592">i</span>&nbsp;<span class="op" id="8048594">&lt;</span>&nbsp;<span class="ident" id="8048596">b</span><span class="op" id="8048597">.</span><span class="ident" id="8048598">N</span><span class="op" id="8048599">;</span>&nbsp;<span class="ident" id="8048601">i</span><span class="op" id="8048602">++</span>&nbsp;<span class="op" id="8048605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8048609">doConcurrentTest</span><span class="op" id="8048625">(</span><span class="ident" id="8048626">b</span><span class="op" id="8048627">,</span>&nbsp;<span class="ident" id="8048629">ct</span><span class="op" id="8048631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8048634">}</span><br>
<span class="lineno"></span><span class="op" id="8048636">}</span><br>
<span class="lineno">1980</span><br>
<span class="lineno"></span><span class="keyword" id="8048639">func</span>&nbsp;<span class="ident" id="8048644">BenchmarkConcurrentRandom</span><span class="op" id="8048669">(</span><span class="ident" id="8048670">b</span>&nbsp;<span class="op" id="8048672">*</span><span class="ident" id="8048673">testing</span><span class="op" id="8048680">.</span><span class="ident" id="8048681">B</span><span class="op" id="8048682">)</span>&nbsp;<span class="op" id="8048684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8048687">b</span><span class="op" id="8048688">.</span><span class="ident" id="8048689">ReportAllocs</span><span class="op" id="8048701">(</span><span class="op" id="8048702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8048705">ct</span>&nbsp;<span class="op" id="8048708">:=</span>&nbsp;<span class="builtinfunc" id="8048711">new</span><span class="op" id="8048714">(</span><span class="ident" id="8048715">concurrentRandomTest</span><span class="op" id="8048735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8048738">for</span>&nbsp;<span class="ident" id="8048742">i</span>&nbsp;<span class="op" id="8048744">:=</span>&nbsp;<span class="num" id="8048747">0</span><span class="op" id="8048748">;</span>&nbsp;<span class="ident" id="8048750">i</span>&nbsp;<span class="op" id="8048752">&lt;</span>&nbsp;<span class="ident" id="8048754">b</span><span class="op" id="8048755">.</span><span class="ident" id="8048756">N</span><span class="op" id="8048757">;</span>&nbsp;<span class="ident" id="8048759">i</span><span class="op" id="8048760">++</span>&nbsp;<span class="op" id="8048763">{</span><br>
<span class="lineno">1985</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="8048767">doConcurrentTest</span><span class="op" id="8048783">(</span><span class="ident" id="8048784">b</span><span class="op" id="8048785">,</span>&nbsp;<span class="ident" id="8048787">ct</span><span class="op" id="8048789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8048792">}</span><br>
<span class="lineno"></span><span class="op" id="8048794">}</span>
</div>
</body>
</html>
