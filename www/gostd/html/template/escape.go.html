<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>html/template</h2>
<ul>
<li><a href="/gostd/html/template/attr.go.html">attr.go</a></li>
<li><a href="/gostd/html/template/clone_test.go.html">clone_test.go</a></li>
<li><a href="/gostd/html/template/content.go.html">content.go</a></li>
<li><a href="/gostd/html/template/content_test.go.html">content_test.go</a></li>
<li><a href="/gostd/html/template/context.go.html">context.go</a></li>
<li><a href="/gostd/html/template/css.go.html">css.go</a></li>
<li><a href="/gostd/html/template/css_test.go.html">css_test.go</a></li>
<li><a href="/gostd/html/template/doc.go.html">doc.go</a></li>
<li><a href="/gostd/html/template/error.go.html">error.go</a></li>
<li><a href="/gostd/html/template/escape.go.html" class="current">escape.go</a></li>
<li><a href="/gostd/html/template/escape_test.go.html">escape_test.go</a></li>
<li><a href="/gostd/html/template/html.go.html">html.go</a></li>
<li><a href="/gostd/html/template/html_test.go.html">html_test.go</a></li>
<li><a href="/gostd/html/template/js.go.html">js.go</a></li>
<li><a href="/gostd/html/template/js_test.go.html">js_test.go</a></li>
<li><a href="/gostd/html/template/template.go.html">template.go</a></li>
<li><a href="/gostd/html/template/transition.go.html">transition.go</a></li>
<li><a href="/gostd/html/template/url.go.html">url.go</a></li>
<li><a href="/gostd/html/template/url_test.go.html">url_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5056224">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5056279">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5056333">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5056384">package</span>&nbsp;<span class="ident" id="5056392">template</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5056402">import</span>&nbsp;<span class="op" id="5056409">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5056412">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5056421">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5056428">&#34;html&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5056436">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5056442">&#34;text/template&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5056459">&#34;text/template/parse&#34;</span><br>
<span class="lineno"></span><span class="op" id="5056481">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5056484">//&nbsp;escapeTemplate&nbsp;rewrites&nbsp;the&nbsp;named&nbsp;template,&nbsp;which&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5056545">//&nbsp;associated&nbsp;with&nbsp;t,&nbsp;to&nbsp;guarantee&nbsp;that&nbsp;the&nbsp;output&nbsp;of&nbsp;any&nbsp;of&nbsp;the&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="5056616">//&nbsp;templates&nbsp;is&nbsp;properly&nbsp;escaped.&nbsp;&nbsp;If&nbsp;no&nbsp;error&nbsp;is&nbsp;returned,&nbsp;then&nbsp;the&nbsp;named&nbsp;templates&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="5056706">//&nbsp;been&nbsp;modified.&nbsp;&nbsp;Otherwise&nbsp;the&nbsp;named&nbsp;templates&nbsp;have&nbsp;been&nbsp;rendered</span><br>
<span class="lineno">20</span><span class="comment" id="5056774">//&nbsp;unusable.</span><br>
<span class="lineno"></span><span class="keyword" id="5056787">func</span>&nbsp;<span class="ident" id="5056792">escapeTemplate</span><span class="op" id="5056806">(</span><span class="ident" id="5056807">tmpl</span>&nbsp;<span class="op" id="5056812">*</span><span class="ident" id="5056813">Template</span><span class="op" id="5056821">,</span>&nbsp;<span class="ident" id="5056823">node</span>&nbsp;<span class="ident" id="5056828">parse</span><span class="op" id="5056833">.</span><span class="ident" id="5056834">Node</span><span class="op" id="5056838">,</span>&nbsp;<span class="ident" id="5056840">name</span>&nbsp;<span class="builtintype" id="5056845">string</span><span class="op" id="5056851">)</span>&nbsp;<span class="builtintype" id="5056853">error</span>&nbsp;<span class="op" id="5056859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5056862">e</span>&nbsp;<span class="op" id="5056864">:=</span>&nbsp;<span class="ident" id="5056867">newEscaper</span><span class="op" id="5056877">(</span><span class="ident" id="5056878">tmpl</span><span class="op" id="5056882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5056885">c</span><span class="op" id="5056886">,</span>&nbsp;<span class="ident" id="5056888">_</span>&nbsp;<span class="op" id="5056890">:=</span>&nbsp;<span class="ident" id="5056893">e</span><span class="op" id="5056894">.</span><span class="ident" id="5056895">escapeTree</span><span class="op" id="5056905">(</span><span class="ident" id="5056906">context</span><span class="op" id="5056913">{</span><span class="op" id="5056914">}</span><span class="op" id="5056915">,</span>&nbsp;<span class="ident" id="5056917">node</span><span class="op" id="5056921">,</span>&nbsp;<span class="ident" id="5056923">name</span><span class="op" id="5056927">,</span>&nbsp;<span class="num" id="5056929">0</span><span class="op" id="5056930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5056933">var</span>&nbsp;<span class="ident" id="5056937">err</span>&nbsp;<span class="builtintype" id="5056941">error</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5056948">if</span>&nbsp;<span class="ident" id="5056951">c</span><span class="op" id="5056952">.</span><span class="ident" id="5056953">err</span>&nbsp;<span class="op" id="5056957">!=</span>&nbsp;<span class="ident" id="5056960">nil</span>&nbsp;<span class="op" id="5056964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5056968">err</span><span class="op" id="5056971">,</span>&nbsp;<span class="ident" id="5056973">c</span><span class="op" id="5056974">.</span><span class="ident" id="5056975">err</span><span class="op" id="5056978">.</span><span class="ident" id="5056979">Name</span>&nbsp;<span class="op" id="5056984">=</span>&nbsp;<span class="ident" id="5056986">c</span><span class="op" id="5056987">.</span><span class="ident" id="5056988">err</span><span class="op" id="5056991">,</span>&nbsp;<span class="ident" id="5056993">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5056999">}</span>&nbsp;<span class="keyword" id="5057001">else</span>&nbsp;<span class="keyword" id="5057006">if</span>&nbsp;<span class="ident" id="5057009">c</span><span class="op" id="5057010">.</span><span class="ident" id="5057011">state</span>&nbsp;<span class="op" id="5057017">!=</span>&nbsp;<span class="ident" id="5057020">stateText</span>&nbsp;<span class="op" id="5057030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5057034">err</span>&nbsp;<span class="op" id="5057038">=</span>&nbsp;<span class="op" id="5057040">&amp;</span><span class="ident" id="5057041">Error</span><span class="op" id="5057046">{</span><span class="ident" id="5057047">ErrEndContext</span><span class="op" id="5057060">,</span>&nbsp;<span class="ident" id="5057062">nil</span><span class="op" id="5057065">,</span>&nbsp;<span class="ident" id="5057067">name</span><span class="op" id="5057071">,</span>&nbsp;<span class="num" id="5057073">0</span><span class="op" id="5057074">,</span>&nbsp;<span class="ident" id="5057076">fmt</span><span class="op" id="5057079">.</span><span class="ident" id="5057080">Sprintf</span><span class="op" id="5057087">(</span><span class="string" id="5057088">&#34;ends&nbsp;in&nbsp;a&nbsp;non-text&nbsp;context:&nbsp;%v&#34;</span><span class="op" id="5057120">,</span>&nbsp;<span class="ident" id="5057122">c</span><span class="op" id="5057123">)</span><span class="op" id="5057124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5057127">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5057130">if</span>&nbsp;<span class="ident" id="5057133">err</span>&nbsp;<span class="op" id="5057137">!=</span>&nbsp;<span class="ident" id="5057140">nil</span>&nbsp;<span class="op" id="5057144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5057148">//&nbsp;Prevent&nbsp;execution&nbsp;of&nbsp;unsafe&nbsp;templates.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5057192">if</span>&nbsp;<span class="ident" id="5057195">t</span>&nbsp;<span class="op" id="5057197">:=</span>&nbsp;<span class="ident" id="5057200">tmpl</span><span class="op" id="5057204">.</span><span class="ident" id="5057205">set</span><span class="op" id="5057208">[</span><span class="ident" id="5057209">name</span><span class="op" id="5057213">]</span><span class="op" id="5057214">;</span>&nbsp;<span class="ident" id="5057216">t</span>&nbsp;<span class="op" id="5057218">!=</span>&nbsp;<span class="ident" id="5057221">nil</span>&nbsp;<span class="op" id="5057225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5057230">t</span><span class="op" id="5057231">.</span><span class="ident" id="5057232">escapeErr</span>&nbsp;<span class="op" id="5057242">=</span>&nbsp;<span class="ident" id="5057244">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5057251">t</span><span class="op" id="5057252">.</span><span class="ident" id="5057253">text</span><span class="op" id="5057257">.</span><span class="ident" id="5057258">Tree</span>&nbsp;<span class="op" id="5057263">=</span>&nbsp;<span class="ident" id="5057265">nil</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5057272">t</span><span class="op" id="5057273">.</span><span class="ident" id="5057274">Tree</span>&nbsp;<span class="op" id="5057279">=</span>&nbsp;<span class="ident" id="5057281">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5057287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5057291">return</span>&nbsp;<span class="ident" id="5057298">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5057303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5057306">e</span><span class="op" id="5057307">.</span><span class="ident" id="5057308">commit</span><span class="op" id="5057314">(</span><span class="op" id="5057315">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5057318">if</span>&nbsp;<span class="ident" id="5057321">t</span>&nbsp;<span class="op" id="5057323">:=</span>&nbsp;<span class="ident" id="5057326">tmpl</span><span class="op" id="5057330">.</span><span class="ident" id="5057331">set</span><span class="op" id="5057334">[</span><span class="ident" id="5057335">name</span><span class="op" id="5057339">]</span><span class="op" id="5057340">;</span>&nbsp;<span class="ident" id="5057342">t</span>&nbsp;<span class="op" id="5057344">!=</span>&nbsp;<span class="ident" id="5057347">nil</span>&nbsp;<span class="op" id="5057351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5057355">t</span><span class="op" id="5057356">.</span><span class="ident" id="5057357">escapeErr</span>&nbsp;<span class="op" id="5057367">=</span>&nbsp;<span class="ident" id="5057369">escapeOK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5057380">t</span><span class="op" id="5057381">.</span><span class="ident" id="5057382">Tree</span>&nbsp;<span class="op" id="5057387">=</span>&nbsp;<span class="ident" id="5057389">t</span><span class="op" id="5057390">.</span><span class="ident" id="5057391">text</span><span class="op" id="5057395">.</span><span class="ident" id="5057396">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5057402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5057405">return</span>&nbsp;<span class="ident" id="5057412">nil</span><br>
<span class="lineno">45</span><span class="op" id="5057416">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5057419">//&nbsp;funcMap&nbsp;maps&nbsp;command&nbsp;names&nbsp;to&nbsp;functions&nbsp;that&nbsp;render&nbsp;their&nbsp;inputs&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="5057493">var</span>&nbsp;<span class="ident" id="5057497">funcMap</span>&nbsp;<span class="op" id="5057505">=</span>&nbsp;<span class="ident" id="5057507">template</span><span class="op" id="5057515">.</span><span class="ident" id="5057516">FuncMap</span><span class="op" id="5057523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5057526">&#34;html_template_attrescaper&#34;</span><span class="op" id="5057553">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5057559">attrEscaper</span><span class="op" id="5057570">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5057573">&#34;html_template_commentescaper&#34;</span><span class="op" id="5057603">:</span>&nbsp;&nbsp;<span class="ident" id="5057606">commentEscaper</span><span class="op" id="5057620">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5057623">&#34;html_template_cssescaper&#34;</span><span class="op" id="5057649">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5057656">cssEscaper</span><span class="op" id="5057666">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5057669">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="5057699">:</span>&nbsp;&nbsp;<span class="ident" id="5057702">cssValueFilter</span><span class="op" id="5057716">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5057719">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="5057749">:</span>&nbsp;&nbsp;<span class="ident" id="5057752">htmlNameFilter</span><span class="op" id="5057766">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5057769">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5057796">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5057802">htmlEscaper</span><span class="op" id="5057813">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5057816">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="5057847">:</span>&nbsp;<span class="ident" id="5057849">jsRegexpEscaper</span><span class="op" id="5057864">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5057867">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="5057895">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5057900">jsStrEscaper</span><span class="op" id="5057912">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5057915">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="5057943">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5057948">jsValEscaper</span><span class="op" id="5057960">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5057963">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5057993">:</span>&nbsp;&nbsp;<span class="ident" id="5057996">htmlNospaceEscaper</span><span class="op" id="5058014">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5058017">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="5058046">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5058050">rcdataEscaper</span><span class="op" id="5058063">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5058066">&#34;html_template_urlescaper&#34;</span><span class="op" id="5058092">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5058099">urlEscaper</span><span class="op" id="5058109">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5058112">&#34;html_template_urlfilter&#34;</span><span class="op" id="5058137">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5058145">urlFilter</span><span class="op" id="5058154">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5058157">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5058186">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5058190">urlNormalizer</span><span class="op" id="5058203">,</span><br>
<span class="lineno"></span><span class="op" id="5058205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5058208">//&nbsp;equivEscapers&nbsp;matches&nbsp;contextual&nbsp;escapers&nbsp;to&nbsp;equivalent&nbsp;template&nbsp;builtins.</span><br>
<span class="lineno"></span><span class="keyword" id="5058286">var</span>&nbsp;<span class="ident" id="5058290">equivEscapers</span>&nbsp;<span class="op" id="5058304">=</span>&nbsp;<span class="keyword" id="5058306">map</span><span class="op" id="5058309">[</span><span class="builtintype" id="5058310">string</span><span class="op" id="5058316">]</span><span class="builtintype" id="5058317">string</span><span class="op" id="5058323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5058326">&#34;html_template_attrescaper&#34;</span><span class="op" id="5058353">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5058358">&#34;html&#34;</span><span class="op" id="5058364">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5058367">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5058394">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5058399">&#34;html&#34;</span><span class="op" id="5058405">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5058408">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5058438">:</span>&nbsp;<span class="string" id="5058440">&#34;html&#34;</span><span class="op" id="5058446">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5058449">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="5058478">:</span>&nbsp;&nbsp;<span class="string" id="5058481">&#34;html&#34;</span><span class="op" id="5058487">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5058490">&#34;html_template_urlescaper&#34;</span><span class="op" id="5058516">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5058522">&#34;urlquery&#34;</span><span class="op" id="5058532">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5058535">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5058564">:</span>&nbsp;&nbsp;<span class="string" id="5058567">&#34;urlquery&#34;</span><span class="op" id="5058577">,</span><br>
<span class="lineno"></span><span class="op" id="5058579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="5058582">//&nbsp;escaper&nbsp;collects&nbsp;type&nbsp;inferences&nbsp;about&nbsp;templates&nbsp;and&nbsp;changes&nbsp;needed&nbsp;to&nbsp;make</span><br>
<span class="lineno"></span><span class="comment" id="5058661">//&nbsp;templates&nbsp;injection&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="5058690">type</span>&nbsp;<span class="ident" id="5058695">escaper</span>&nbsp;<span class="keyword" id="5058703">struct</span>&nbsp;<span class="op" id="5058710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5058713">tmpl</span>&nbsp;<span class="op" id="5058718">*</span><span class="ident" id="5058719">Template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5058729">//&nbsp;output[templateName]&nbsp;is&nbsp;the&nbsp;output&nbsp;context&nbsp;for&nbsp;a&nbsp;templateName&nbsp;that</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5058800">//&nbsp;has&nbsp;been&nbsp;mangled&nbsp;to&nbsp;include&nbsp;its&nbsp;input&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5058851">output</span>&nbsp;<span class="keyword" id="5058858">map</span><span class="op" id="5058861">[</span><span class="builtintype" id="5058862">string</span><span class="op" id="5058868">]</span><span class="ident" id="5058869">context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5058878">//&nbsp;derived[c.mangle(name)]&nbsp;maps&nbsp;to&nbsp;a&nbsp;template&nbsp;derived&nbsp;from&nbsp;the&nbsp;template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5058951">//&nbsp;named&nbsp;name&nbsp;templateName&nbsp;for&nbsp;the&nbsp;start&nbsp;context&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5059004">derived</span>&nbsp;<span class="keyword" id="5059012">map</span><span class="op" id="5059015">[</span><span class="builtintype" id="5059016">string</span><span class="op" id="5059022">]</span><span class="op" id="5059023">*</span><span class="ident" id="5059024">template</span><span class="op" id="5059032">.</span><span class="ident" id="5059033">Template</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5059043">//&nbsp;called[templateName]&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;called&nbsp;mangled&nbsp;template&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5059111">called</span>&nbsp;<span class="keyword" id="5059118">map</span><span class="op" id="5059121">[</span><span class="builtintype" id="5059122">string</span><span class="op" id="5059128">]</span><span class="builtintype" id="5059129">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5059135">//&nbsp;xxxNodeEdits&nbsp;are&nbsp;the&nbsp;accumulated&nbsp;edits&nbsp;to&nbsp;apply&nbsp;during&nbsp;commit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5059202">//&nbsp;Such&nbsp;edits&nbsp;are&nbsp;not&nbsp;applied&nbsp;immediately&nbsp;in&nbsp;case&nbsp;a&nbsp;template&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5059268">//&nbsp;executes&nbsp;a&nbsp;given&nbsp;template&nbsp;in&nbsp;different&nbsp;escaping&nbsp;contexts.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5059330">actionNodeEdits</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="5059348">map</span><span class="op" id="5059351">[</span><span class="op" id="5059352">*</span><span class="ident" id="5059353">parse</span><span class="op" id="5059358">.</span><span class="ident" id="5059359">ActionNode</span><span class="op" id="5059369">]</span><span class="op" id="5059370">[</span><span class="op" id="5059371">]</span><span class="builtintype" id="5059372">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5059380">templateNodeEdits</span>&nbsp;<span class="keyword" id="5059398">map</span><span class="op" id="5059401">[</span><span class="op" id="5059402">*</span><span class="ident" id="5059403">parse</span><span class="op" id="5059408">.</span><span class="ident" id="5059409">TemplateNode</span><span class="op" id="5059421">]</span><span class="builtintype" id="5059422">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5059430">textNodeEdits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5059448">map</span><span class="op" id="5059451">[</span><span class="op" id="5059452">*</span><span class="ident" id="5059453">parse</span><span class="op" id="5059458">.</span><span class="ident" id="5059459">TextNode</span><span class="op" id="5059467">]</span><span class="op" id="5059468">[</span><span class="op" id="5059469">]</span><span class="builtintype" id="5059470">byte</span><br>
<span class="lineno"></span><span class="op" id="5059475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="5059478">//&nbsp;newEscaper&nbsp;creates&nbsp;a&nbsp;blank&nbsp;escaper&nbsp;for&nbsp;the&nbsp;given&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="5059535">func</span>&nbsp;<span class="ident" id="5059540">newEscaper</span><span class="op" id="5059550">(</span><span class="ident" id="5059551">t</span>&nbsp;<span class="op" id="5059553">*</span><span class="ident" id="5059554">Template</span><span class="op" id="5059562">)</span>&nbsp;<span class="op" id="5059564">*</span><span class="ident" id="5059565">escaper</span>&nbsp;<span class="op" id="5059573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5059576">return</span>&nbsp;<span class="op" id="5059583">&amp;</span><span class="ident" id="5059584">escaper</span><span class="op" id="5059591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5059595">t</span><span class="op" id="5059596">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5059600">map</span><span class="op" id="5059603">[</span><span class="builtintype" id="5059604">string</span><span class="op" id="5059610">]</span><span class="ident" id="5059611">context</span><span class="op" id="5059618">{</span><span class="op" id="5059619">}</span><span class="op" id="5059620">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5059624">map</span><span class="op" id="5059627">[</span><span class="builtintype" id="5059628">string</span><span class="op" id="5059634">]</span><span class="op" id="5059635">*</span><span class="ident" id="5059636">template</span><span class="op" id="5059644">.</span><span class="ident" id="5059645">Template</span><span class="op" id="5059653">{</span><span class="op" id="5059654">}</span><span class="op" id="5059655">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5059659">map</span><span class="op" id="5059662">[</span><span class="builtintype" id="5059663">string</span><span class="op" id="5059669">]</span><span class="builtintype" id="5059670">bool</span><span class="op" id="5059674">{</span><span class="op" id="5059675">}</span><span class="op" id="5059676">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5059680">map</span><span class="op" id="5059683">[</span><span class="op" id="5059684">*</span><span class="ident" id="5059685">parse</span><span class="op" id="5059690">.</span><span class="ident" id="5059691">ActionNode</span><span class="op" id="5059701">]</span><span class="op" id="5059702">[</span><span class="op" id="5059703">]</span><span class="builtintype" id="5059704">string</span><span class="op" id="5059710">{</span><span class="op" id="5059711">}</span><span class="op" id="5059712">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5059716">map</span><span class="op" id="5059719">[</span><span class="op" id="5059720">*</span><span class="ident" id="5059721">parse</span><span class="op" id="5059726">.</span><span class="ident" id="5059727">TemplateNode</span><span class="op" id="5059739">]</span><span class="builtintype" id="5059740">string</span><span class="op" id="5059746">{</span><span class="op" id="5059747">}</span><span class="op" id="5059748">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5059752">map</span><span class="op" id="5059755">[</span><span class="op" id="5059756">*</span><span class="ident" id="5059757">parse</span><span class="op" id="5059762">.</span><span class="ident" id="5059763">TextNode</span><span class="op" id="5059771">]</span><span class="op" id="5059772">[</span><span class="op" id="5059773">]</span><span class="builtintype" id="5059774">byte</span><span class="op" id="5059778">{</span><span class="op" id="5059779">}</span><span class="op" id="5059780">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5059783">}</span><br>
<span class="lineno"></span><span class="op" id="5059785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5059788">//&nbsp;filterFailsafe&nbsp;is&nbsp;an&nbsp;innocuous&nbsp;word&nbsp;that&nbsp;is&nbsp;emitted&nbsp;in&nbsp;place&nbsp;of&nbsp;unsafe&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="5059869">//&nbsp;by&nbsp;sanitizer&nbsp;functions.&nbsp;It&nbsp;is&nbsp;not&nbsp;a&nbsp;keyword&nbsp;in&nbsp;any&nbsp;programming&nbsp;language,</span><br>
<span class="lineno">110</span><span class="comment" id="5059945">//&nbsp;contains&nbsp;no&nbsp;special&nbsp;characters,&nbsp;is&nbsp;not&nbsp;empty,&nbsp;and&nbsp;when&nbsp;it&nbsp;appears&nbsp;in&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="5060024">//&nbsp;it&nbsp;is&nbsp;distinct&nbsp;enough&nbsp;that&nbsp;a&nbsp;developer&nbsp;can&nbsp;find&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;problem</span><br>
<span class="lineno"></span><span class="comment" id="5060101">//&nbsp;via&nbsp;a&nbsp;search&nbsp;engine.</span><br>
<span class="lineno"></span><span class="keyword" id="5060125">const</span>&nbsp;<span class="ident" id="5060131">filterFailsafe</span>&nbsp;<span class="op" id="5060146">=</span>&nbsp;<span class="string" id="5060148">&#34;ZgotmplZ&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="comment" id="5060160">//&nbsp;escape&nbsp;escapes&nbsp;a&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5060195">func</span>&nbsp;<span class="op" id="5060200">(</span><span class="ident" id="5060201">e</span>&nbsp;<span class="op" id="5060203">*</span><span class="ident" id="5060204">escaper</span><span class="op" id="5060211">)</span>&nbsp;<span class="ident" id="5060213">escape</span><span class="op" id="5060219">(</span><span class="ident" id="5060220">c</span>&nbsp;<span class="ident" id="5060222">context</span><span class="op" id="5060229">,</span>&nbsp;<span class="ident" id="5060231">n</span>&nbsp;<span class="ident" id="5060233">parse</span><span class="op" id="5060238">.</span><span class="ident" id="5060239">Node</span><span class="op" id="5060243">)</span>&nbsp;<span class="ident" id="5060245">context</span>&nbsp;<span class="op" id="5060253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5060256">switch</span>&nbsp;<span class="ident" id="5060263">n</span>&nbsp;<span class="op" id="5060265">:=</span>&nbsp;<span class="ident" id="5060268">n</span><span class="op" id="5060269">.</span><span class="op" id="5060270">(</span><span class="keyword" id="5060271">type</span><span class="op" id="5060275">)</span>&nbsp;<span class="op" id="5060277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5060280">case</span>&nbsp;<span class="op" id="5060285">*</span><span class="ident" id="5060286">parse</span><span class="op" id="5060291">.</span><span class="ident" id="5060292">ActionNode</span><span class="op" id="5060302">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5060306">return</span>&nbsp;<span class="ident" id="5060313">e</span><span class="op" id="5060314">.</span><span class="ident" id="5060315">escapeAction</span><span class="op" id="5060327">(</span><span class="ident" id="5060328">c</span><span class="op" id="5060329">,</span>&nbsp;<span class="ident" id="5060331">n</span><span class="op" id="5060332">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5060335">case</span>&nbsp;<span class="op" id="5060340">*</span><span class="ident" id="5060341">parse</span><span class="op" id="5060346">.</span><span class="ident" id="5060347">IfNode</span><span class="op" id="5060353">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5060357">return</span>&nbsp;<span class="ident" id="5060364">e</span><span class="op" id="5060365">.</span><span class="ident" id="5060366">escapeBranch</span><span class="op" id="5060378">(</span><span class="ident" id="5060379">c</span><span class="op" id="5060380">,</span>&nbsp;<span class="op" id="5060382">&amp;</span><span class="ident" id="5060383">n</span><span class="op" id="5060384">.</span><span class="ident" id="5060385">BranchNode</span><span class="op" id="5060395">,</span>&nbsp;<span class="string" id="5060397">&#34;if&#34;</span><span class="op" id="5060401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5060404">case</span>&nbsp;<span class="op" id="5060409">*</span><span class="ident" id="5060410">parse</span><span class="op" id="5060415">.</span><span class="ident" id="5060416">ListNode</span><span class="op" id="5060424">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5060428">return</span>&nbsp;<span class="ident" id="5060435">e</span><span class="op" id="5060436">.</span><span class="ident" id="5060437">escapeList</span><span class="op" id="5060447">(</span><span class="ident" id="5060448">c</span><span class="op" id="5060449">,</span>&nbsp;<span class="ident" id="5060451">n</span><span class="op" id="5060452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5060455">case</span>&nbsp;<span class="op" id="5060460">*</span><span class="ident" id="5060461">parse</span><span class="op" id="5060466">.</span><span class="ident" id="5060467">RangeNode</span><span class="op" id="5060476">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5060480">return</span>&nbsp;<span class="ident" id="5060487">e</span><span class="op" id="5060488">.</span><span class="ident" id="5060489">escapeBranch</span><span class="op" id="5060501">(</span><span class="ident" id="5060502">c</span><span class="op" id="5060503">,</span>&nbsp;<span class="op" id="5060505">&amp;</span><span class="ident" id="5060506">n</span><span class="op" id="5060507">.</span><span class="ident" id="5060508">BranchNode</span><span class="op" id="5060518">,</span>&nbsp;<span class="string" id="5060520">&#34;range&#34;</span><span class="op" id="5060527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5060530">case</span>&nbsp;<span class="op" id="5060535">*</span><span class="ident" id="5060536">parse</span><span class="op" id="5060541">.</span><span class="ident" id="5060542">TemplateNode</span><span class="op" id="5060554">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5060558">return</span>&nbsp;<span class="ident" id="5060565">e</span><span class="op" id="5060566">.</span><span class="ident" id="5060567">escapeTemplate</span><span class="op" id="5060581">(</span><span class="ident" id="5060582">c</span><span class="op" id="5060583">,</span>&nbsp;<span class="ident" id="5060585">n</span><span class="op" id="5060586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5060589">case</span>&nbsp;<span class="op" id="5060594">*</span><span class="ident" id="5060595">parse</span><span class="op" id="5060600">.</span><span class="ident" id="5060601">TextNode</span><span class="op" id="5060609">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5060613">return</span>&nbsp;<span class="ident" id="5060620">e</span><span class="op" id="5060621">.</span><span class="ident" id="5060622">escapeText</span><span class="op" id="5060632">(</span><span class="ident" id="5060633">c</span><span class="op" id="5060634">,</span>&nbsp;<span class="ident" id="5060636">n</span><span class="op" id="5060637">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5060640">case</span>&nbsp;<span class="op" id="5060645">*</span><span class="ident" id="5060646">parse</span><span class="op" id="5060651">.</span><span class="ident" id="5060652">WithNode</span><span class="op" id="5060660">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5060664">return</span>&nbsp;<span class="ident" id="5060671">e</span><span class="op" id="5060672">.</span><span class="ident" id="5060673">escapeBranch</span><span class="op" id="5060685">(</span><span class="ident" id="5060686">c</span><span class="op" id="5060687">,</span>&nbsp;<span class="op" id="5060689">&amp;</span><span class="ident" id="5060690">n</span><span class="op" id="5060691">.</span><span class="ident" id="5060692">BranchNode</span><span class="op" id="5060702">,</span>&nbsp;<span class="string" id="5060704">&#34;with&#34;</span><span class="op" id="5060710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5060713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5060716">panic</span><span class="op" id="5060721">(</span><span class="string" id="5060722">&#34;escaping&nbsp;&#34;</span>&nbsp;<span class="op" id="5060734">+</span>&nbsp;<span class="ident" id="5060736">n</span><span class="op" id="5060737">.</span><span class="ident" id="5060738">String</span><span class="op" id="5060744">(</span><span class="op" id="5060745">)</span>&nbsp;<span class="op" id="5060747">+</span>&nbsp;<span class="string" id="5060749">&#34;&nbsp;is&nbsp;unimplemented&#34;</span><span class="op" id="5060768">)</span><br>
<span class="lineno"></span><span class="op" id="5060770">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="comment" id="5060773">//&nbsp;escapeAction&nbsp;escapes&nbsp;an&nbsp;action&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5060822">func</span>&nbsp;<span class="op" id="5060827">(</span><span class="ident" id="5060828">e</span>&nbsp;<span class="op" id="5060830">*</span><span class="ident" id="5060831">escaper</span><span class="op" id="5060838">)</span>&nbsp;<span class="ident" id="5060840">escapeAction</span><span class="op" id="5060852">(</span><span class="ident" id="5060853">c</span>&nbsp;<span class="ident" id="5060855">context</span><span class="op" id="5060862">,</span>&nbsp;<span class="ident" id="5060864">n</span>&nbsp;<span class="op" id="5060866">*</span><span class="ident" id="5060867">parse</span><span class="op" id="5060872">.</span><span class="ident" id="5060873">ActionNode</span><span class="op" id="5060883">)</span>&nbsp;<span class="ident" id="5060885">context</span>&nbsp;<span class="op" id="5060893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5060896">if</span>&nbsp;<span class="builtinfunc" id="5060899">len</span><span class="op" id="5060902">(</span><span class="ident" id="5060903">n</span><span class="op" id="5060904">.</span><span class="ident" id="5060905">Pipe</span><span class="op" id="5060909">.</span><span class="ident" id="5060910">Decl</span><span class="op" id="5060914">)</span>&nbsp;<span class="op" id="5060916">!=</span>&nbsp;<span class="num" id="5060919">0</span>&nbsp;<span class="op" id="5060921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5060925">//&nbsp;A&nbsp;local&nbsp;variable&nbsp;assignment,&nbsp;not&nbsp;an&nbsp;interpolation.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5060981">return</span>&nbsp;<span class="ident" id="5060988">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5060991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5060994">c</span>&nbsp;<span class="op" id="5060996">=</span>&nbsp;<span class="ident" id="5060998">nudge</span><span class="op" id="5061003">(</span><span class="ident" id="5061004">c</span><span class="op" id="5061005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5061008">s</span>&nbsp;<span class="op" id="5061010">:=</span>&nbsp;<span class="builtinfunc" id="5061013">make</span><span class="op" id="5061017">(</span><span class="op" id="5061018">[</span><span class="op" id="5061019">]</span><span class="builtintype" id="5061020">string</span><span class="op" id="5061026">,</span>&nbsp;<span class="num" id="5061028">0</span><span class="op" id="5061029">,</span>&nbsp;<span class="num" id="5061031">3</span><span class="op" id="5061032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5061035">switch</span>&nbsp;<span class="ident" id="5061042">c</span><span class="op" id="5061043">.</span><span class="ident" id="5061044">state</span>&nbsp;<span class="op" id="5061050">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5061053">case</span>&nbsp;<span class="ident" id="5061058">stateError</span><span class="op" id="5061068">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5061072">return</span>&nbsp;<span class="ident" id="5061079">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5061082">case</span>&nbsp;<span class="ident" id="5061087">stateURL</span><span class="op" id="5061095">,</span>&nbsp;<span class="ident" id="5061097">stateCSSDqStr</span><span class="op" id="5061110">,</span>&nbsp;<span class="ident" id="5061112">stateCSSSqStr</span><span class="op" id="5061125">,</span>&nbsp;<span class="ident" id="5061127">stateCSSDqURL</span><span class="op" id="5061140">,</span>&nbsp;<span class="ident" id="5061142">stateCSSSqURL</span><span class="op" id="5061155">,</span>&nbsp;<span class="ident" id="5061157">stateCSSURL</span><span class="op" id="5061168">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5061172">switch</span>&nbsp;<span class="ident" id="5061179">c</span><span class="op" id="5061180">.</span><span class="ident" id="5061181">urlPart</span>&nbsp;<span class="op" id="5061189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5061193">case</span>&nbsp;<span class="ident" id="5061198">urlPartNone</span><span class="op" id="5061209">:</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5061214">s</span>&nbsp;<span class="op" id="5061216">=</span>&nbsp;<span class="builtinfunc" id="5061218">append</span><span class="op" id="5061224">(</span><span class="ident" id="5061225">s</span><span class="op" id="5061226">,</span>&nbsp;<span class="string" id="5061228">&#34;html_template_urlfilter&#34;</span><span class="op" id="5061253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5061258">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5061272">case</span>&nbsp;<span class="ident" id="5061277">urlPartPreQuery</span><span class="op" id="5061292">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5061297">switch</span>&nbsp;<span class="ident" id="5061304">c</span><span class="op" id="5061305">.</span><span class="ident" id="5061306">state</span>&nbsp;<span class="op" id="5061312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5061317">case</span>&nbsp;<span class="ident" id="5061322">stateCSSDqStr</span><span class="op" id="5061335">,</span>&nbsp;<span class="ident" id="5061337">stateCSSSqStr</span><span class="op" id="5061350">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5061356">s</span>&nbsp;<span class="op" id="5061358">=</span>&nbsp;<span class="builtinfunc" id="5061360">append</span><span class="op" id="5061366">(</span><span class="ident" id="5061367">s</span><span class="op" id="5061368">,</span>&nbsp;<span class="string" id="5061370">&#34;html_template_cssescaper&#34;</span><span class="op" id="5061396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5061401">default</span><span class="op" id="5061408">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5061414">s</span>&nbsp;<span class="op" id="5061416">=</span>&nbsp;<span class="builtinfunc" id="5061418">append</span><span class="op" id="5061424">(</span><span class="ident" id="5061425">s</span><span class="op" id="5061426">,</span>&nbsp;<span class="string" id="5061428">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5061457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5061462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5061466">case</span>&nbsp;<span class="ident" id="5061471">urlPartQueryOrFrag</span><span class="op" id="5061489">:</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5061494">s</span>&nbsp;<span class="op" id="5061496">=</span>&nbsp;<span class="builtinfunc" id="5061498">append</span><span class="op" id="5061504">(</span><span class="ident" id="5061505">s</span><span class="op" id="5061506">,</span>&nbsp;<span class="string" id="5061508">&#34;html_template_urlescaper&#34;</span><span class="op" id="5061534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5061538">case</span>&nbsp;<span class="ident" id="5061543">urlPartUnknown</span><span class="op" id="5061557">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5061562">return</span>&nbsp;<span class="ident" id="5061569">context</span><span class="op" id="5061576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5061582">state</span><span class="op" id="5061587">:</span>&nbsp;<span class="ident" id="5061589">stateError</span><span class="op" id="5061599">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5061605">err</span><span class="op" id="5061608">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5061612">errorf</span><span class="op" id="5061618">(</span><span class="ident" id="5061619">ErrAmbigContext</span><span class="op" id="5061634">,</span>&nbsp;<span class="ident" id="5061636">n</span><span class="op" id="5061637">,</span>&nbsp;<span class="ident" id="5061639">n</span><span class="op" id="5061640">.</span><span class="ident" id="5061641">Line</span><span class="op" id="5061645">,</span>&nbsp;<span class="string" id="5061647">&#34;%s&nbsp;appears&nbsp;in&nbsp;an&nbsp;ambiguous&nbsp;URL&nbsp;context&#34;</span><span class="op" id="5061687">,</span>&nbsp;<span class="ident" id="5061689">n</span><span class="op" id="5061690">)</span><span class="op" id="5061691">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5061696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5061700">default</span><span class="op" id="5061707">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5061712">panic</span><span class="op" id="5061717">(</span><span class="ident" id="5061718">c</span><span class="op" id="5061719">.</span><span class="ident" id="5061720">urlPart</span><span class="op" id="5061727">.</span><span class="ident" id="5061728">String</span><span class="op" id="5061734">(</span><span class="op" id="5061735">)</span><span class="op" id="5061736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5061740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5061743">case</span>&nbsp;<span class="ident" id="5061748">stateJS</span><span class="op" id="5061755">:</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5061759">s</span>&nbsp;<span class="op" id="5061761">=</span>&nbsp;<span class="builtinfunc" id="5061763">append</span><span class="op" id="5061769">(</span><span class="ident" id="5061770">s</span><span class="op" id="5061771">,</span>&nbsp;<span class="string" id="5061773">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="5061801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5061805">//&nbsp;A&nbsp;slash&nbsp;after&nbsp;a&nbsp;value&nbsp;starts&nbsp;a&nbsp;div&nbsp;operator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5061855">c</span><span class="op" id="5061856">.</span><span class="ident" id="5061857">jsCtx</span>&nbsp;<span class="op" id="5061863">=</span>&nbsp;<span class="ident" id="5061865">jsCtxDivOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5061877">case</span>&nbsp;<span class="ident" id="5061882">stateJSDqStr</span><span class="op" id="5061894">,</span>&nbsp;<span class="ident" id="5061896">stateJSSqStr</span><span class="op" id="5061908">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5061912">s</span>&nbsp;<span class="op" id="5061914">=</span>&nbsp;<span class="builtinfunc" id="5061916">append</span><span class="op" id="5061922">(</span><span class="ident" id="5061923">s</span><span class="op" id="5061924">,</span>&nbsp;<span class="string" id="5061926">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="5061954">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5061957">case</span>&nbsp;<span class="ident" id="5061962">stateJSRegexp</span><span class="op" id="5061975">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5061979">s</span>&nbsp;<span class="op" id="5061981">=</span>&nbsp;<span class="builtinfunc" id="5061983">append</span><span class="op" id="5061989">(</span><span class="ident" id="5061990">s</span><span class="op" id="5061991">,</span>&nbsp;<span class="string" id="5061993">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="5062024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5062027">case</span>&nbsp;<span class="ident" id="5062032">stateCSS</span><span class="op" id="5062040">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5062044">s</span>&nbsp;<span class="op" id="5062046">=</span>&nbsp;<span class="builtinfunc" id="5062048">append</span><span class="op" id="5062054">(</span><span class="ident" id="5062055">s</span><span class="op" id="5062056">,</span>&nbsp;<span class="string" id="5062058">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="5062088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5062091">case</span>&nbsp;<span class="ident" id="5062096">stateText</span><span class="op" id="5062105">:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5062109">s</span>&nbsp;<span class="op" id="5062111">=</span>&nbsp;<span class="builtinfunc" id="5062113">append</span><span class="op" id="5062119">(</span><span class="ident" id="5062120">s</span><span class="op" id="5062121">,</span>&nbsp;<span class="string" id="5062123">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5062150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5062153">case</span>&nbsp;<span class="ident" id="5062158">stateRCDATA</span><span class="op" id="5062169">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5062173">s</span>&nbsp;<span class="op" id="5062175">=</span>&nbsp;<span class="builtinfunc" id="5062177">append</span><span class="op" id="5062183">(</span><span class="ident" id="5062184">s</span><span class="op" id="5062185">,</span>&nbsp;<span class="string" id="5062187">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="5062216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5062219">case</span>&nbsp;<span class="ident" id="5062224">stateAttr</span><span class="op" id="5062233">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5062237">//&nbsp;Handled&nbsp;below&nbsp;in&nbsp;delim&nbsp;check.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5062271">case</span>&nbsp;<span class="ident" id="5062276">stateAttrName</span><span class="op" id="5062289">,</span>&nbsp;<span class="ident" id="5062291">stateTag</span><span class="op" id="5062299">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5062303">c</span><span class="op" id="5062304">.</span><span class="ident" id="5062305">state</span>&nbsp;<span class="op" id="5062311">=</span>&nbsp;<span class="ident" id="5062313">stateAttrName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5062329">s</span>&nbsp;<span class="op" id="5062331">=</span>&nbsp;<span class="builtinfunc" id="5062333">append</span><span class="op" id="5062339">(</span><span class="ident" id="5062340">s</span><span class="op" id="5062341">,</span>&nbsp;<span class="string" id="5062343">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="5062373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5062376">default</span><span class="op" id="5062383">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5062387">if</span>&nbsp;<span class="ident" id="5062390">isComment</span><span class="op" id="5062399">(</span><span class="ident" id="5062400">c</span><span class="op" id="5062401">.</span><span class="ident" id="5062402">state</span><span class="op" id="5062407">)</span>&nbsp;<span class="op" id="5062409">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5062414">s</span>&nbsp;<span class="op" id="5062416">=</span>&nbsp;<span class="builtinfunc" id="5062418">append</span><span class="op" id="5062424">(</span><span class="ident" id="5062425">s</span><span class="op" id="5062426">,</span>&nbsp;<span class="string" id="5062428">&#34;html_template_commentescaper&#34;</span><span class="op" id="5062458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5062462">}</span>&nbsp;<span class="keyword" id="5062464">else</span>&nbsp;<span class="op" id="5062469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5062474">panic</span><span class="op" id="5062479">(</span><span class="string" id="5062480">&#34;unexpected&nbsp;state&nbsp;&#34;</span>&nbsp;<span class="op" id="5062500">+</span>&nbsp;<span class="ident" id="5062502">c</span><span class="op" id="5062503">.</span><span class="ident" id="5062504">state</span><span class="op" id="5062509">.</span><span class="ident" id="5062510">String</span><span class="op" id="5062516">(</span><span class="op" id="5062517">)</span><span class="op" id="5062518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5062522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5062525">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5062528">switch</span>&nbsp;<span class="ident" id="5062535">c</span><span class="op" id="5062536">.</span><span class="ident" id="5062537">delim</span>&nbsp;<span class="op" id="5062543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5062546">case</span>&nbsp;<span class="ident" id="5062551">delimNone</span><span class="op" id="5062560">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5062564">//&nbsp;No&nbsp;extra-escaping&nbsp;needed&nbsp;for&nbsp;raw&nbsp;text&nbsp;content.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5062615">case</span>&nbsp;<span class="ident" id="5062620">delimSpaceOrTagEnd</span><span class="op" id="5062638">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5062642">s</span>&nbsp;<span class="op" id="5062644">=</span>&nbsp;<span class="builtinfunc" id="5062646">append</span><span class="op" id="5062652">(</span><span class="ident" id="5062653">s</span><span class="op" id="5062654">,</span>&nbsp;<span class="string" id="5062656">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5062686">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5062689">default</span><span class="op" id="5062696">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5062700">s</span>&nbsp;<span class="op" id="5062702">=</span>&nbsp;<span class="builtinfunc" id="5062704">append</span><span class="op" id="5062710">(</span><span class="ident" id="5062711">s</span><span class="op" id="5062712">,</span>&nbsp;<span class="string" id="5062714">&#34;html_template_attrescaper&#34;</span><span class="op" id="5062741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5062744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5062747">e</span><span class="op" id="5062748">.</span><span class="ident" id="5062749">editActionNode</span><span class="op" id="5062763">(</span><span class="ident" id="5062764">n</span><span class="op" id="5062765">,</span>&nbsp;<span class="ident" id="5062767">s</span><span class="op" id="5062768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5062771">return</span>&nbsp;<span class="ident" id="5062778">c</span><br>
<span class="lineno">205</span><span class="op" id="5062780">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5062783">//&nbsp;allIdents&nbsp;returns&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;identifiers&nbsp;under&nbsp;the&nbsp;Ident&nbsp;field&nbsp;of&nbsp;the&nbsp;node,</span><br>
<span class="lineno"></span><span class="comment" id="5062868">//&nbsp;which&nbsp;might&nbsp;be&nbsp;a&nbsp;singleton&nbsp;(Identifier)&nbsp;or&nbsp;a&nbsp;slice&nbsp;(Field).</span><br>
<span class="lineno"></span><span class="keyword" id="5062931">func</span>&nbsp;<span class="ident" id="5062936">allIdents</span><span class="op" id="5062945">(</span><span class="ident" id="5062946">node</span>&nbsp;<span class="ident" id="5062951">parse</span><span class="op" id="5062956">.</span><span class="ident" id="5062957">Node</span><span class="op" id="5062961">)</span>&nbsp;<span class="op" id="5062963">[</span><span class="op" id="5062964">]</span><span class="builtintype" id="5062965">string</span>&nbsp;<span class="op" id="5062972">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5062975">switch</span>&nbsp;<span class="ident" id="5062982">node</span>&nbsp;<span class="op" id="5062987">:=</span>&nbsp;<span class="ident" id="5062990">node</span><span class="op" id="5062994">.</span><span class="op" id="5062995">(</span><span class="keyword" id="5062996">type</span><span class="op" id="5063000">)</span>&nbsp;<span class="op" id="5063002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5063005">case</span>&nbsp;<span class="op" id="5063010">*</span><span class="ident" id="5063011">parse</span><span class="op" id="5063016">.</span><span class="ident" id="5063017">IdentifierNode</span><span class="op" id="5063031">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5063035">return</span>&nbsp;<span class="op" id="5063042">[</span><span class="op" id="5063043">]</span><span class="builtintype" id="5063044">string</span><span class="op" id="5063050">{</span><span class="ident" id="5063051">node</span><span class="op" id="5063055">.</span><span class="ident" id="5063056">Ident</span><span class="op" id="5063061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5063064">case</span>&nbsp;<span class="op" id="5063069">*</span><span class="ident" id="5063070">parse</span><span class="op" id="5063075">.</span><span class="ident" id="5063076">FieldNode</span><span class="op" id="5063085">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5063089">return</span>&nbsp;<span class="ident" id="5063096">node</span><span class="op" id="5063100">.</span><span class="ident" id="5063101">Ident</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5063108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5063111">panic</span><span class="op" id="5063116">(</span><span class="string" id="5063117">&#34;unidentified&nbsp;node&nbsp;type&nbsp;in&nbsp;allIdents&#34;</span><span class="op" id="5063154">)</span><br>
<span class="lineno"></span><span class="op" id="5063156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5063159">//&nbsp;ensurePipelineContains&nbsp;ensures&nbsp;that&nbsp;the&nbsp;pipeline&nbsp;has&nbsp;commands&nbsp;with</span><br>
<span class="lineno">220</span><span class="comment" id="5063229">//&nbsp;the&nbsp;identifiers&nbsp;in&nbsp;s&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="comment" id="5063263">//&nbsp;If&nbsp;the&nbsp;pipeline&nbsp;already&nbsp;has&nbsp;some&nbsp;of&nbsp;the&nbsp;sanitizers,&nbsp;do&nbsp;not&nbsp;interfere.</span><br>
<span class="lineno"></span><span class="comment" id="5063336">//&nbsp;For&nbsp;example,&nbsp;if&nbsp;p&nbsp;is&nbsp;(.X&nbsp;|&nbsp;html)&nbsp;and&nbsp;s&nbsp;is&nbsp;[&#34;escapeJSVal&#34;,&nbsp;&#34;html&#34;]&nbsp;then&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5063413">//&nbsp;has&nbsp;one&nbsp;matching,&nbsp;&#34;html&#34;,&nbsp;and&nbsp;one&nbsp;to&nbsp;insert,&nbsp;&#34;escapeJSVal&#34;,&nbsp;to&nbsp;produce</span><br>
<span class="lineno"></span><span class="comment" id="5063487">//&nbsp;(.X&nbsp;|&nbsp;escapeJSVal&nbsp;|&nbsp;html).</span><br>
<span class="lineno">225</span><span class="keyword" id="5063517">func</span>&nbsp;<span class="ident" id="5063522">ensurePipelineContains</span><span class="op" id="5063544">(</span><span class="ident" id="5063545">p</span>&nbsp;<span class="op" id="5063547">*</span><span class="ident" id="5063548">parse</span><span class="op" id="5063553">.</span><span class="ident" id="5063554">PipeNode</span><span class="op" id="5063562">,</span>&nbsp;<span class="ident" id="5063564">s</span>&nbsp;<span class="op" id="5063566">[</span><span class="op" id="5063567">]</span><span class="builtintype" id="5063568">string</span><span class="op" id="5063574">)</span>&nbsp;<span class="op" id="5063576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5063579">if</span>&nbsp;<span class="builtinfunc" id="5063582">len</span><span class="op" id="5063585">(</span><span class="ident" id="5063586">s</span><span class="op" id="5063587">)</span>&nbsp;<span class="op" id="5063589">==</span>&nbsp;<span class="num" id="5063592">0</span>&nbsp;<span class="op" id="5063594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5063598">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5063606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5063609">n</span>&nbsp;<span class="op" id="5063611">:=</span>&nbsp;<span class="builtinfunc" id="5063614">len</span><span class="op" id="5063617">(</span><span class="ident" id="5063618">p</span><span class="op" id="5063619">.</span><span class="ident" id="5063620">Cmds</span><span class="op" id="5063624">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5063627">//&nbsp;Find&nbsp;the&nbsp;identifiers&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;chain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5063685">idents</span>&nbsp;<span class="op" id="5063692">:=</span>&nbsp;<span class="ident" id="5063695">p</span><span class="op" id="5063696">.</span><span class="ident" id="5063697">Cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5063703">for</span>&nbsp;<span class="ident" id="5063707">i</span>&nbsp;<span class="op" id="5063709">:=</span>&nbsp;<span class="ident" id="5063712">n</span>&nbsp;<span class="op" id="5063714">-</span>&nbsp;<span class="num" id="5063716">1</span><span class="op" id="5063717">;</span>&nbsp;<span class="ident" id="5063719">i</span>&nbsp;<span class="op" id="5063721">&gt;=</span>&nbsp;<span class="num" id="5063724">0</span><span class="op" id="5063725">;</span>&nbsp;<span class="ident" id="5063727">i</span><span class="op" id="5063728">--</span>&nbsp;<span class="op" id="5063731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5063735">if</span>&nbsp;<span class="ident" id="5063738">cmd</span>&nbsp;<span class="op" id="5063742">:=</span>&nbsp;<span class="ident" id="5063745">p</span><span class="op" id="5063746">.</span><span class="ident" id="5063747">Cmds</span><span class="op" id="5063751">[</span><span class="ident" id="5063752">i</span><span class="op" id="5063753">]</span><span class="op" id="5063754">;</span>&nbsp;<span class="builtinfunc" id="5063756">len</span><span class="op" id="5063759">(</span><span class="ident" id="5063760">cmd</span><span class="op" id="5063763">.</span><span class="ident" id="5063764">Args</span><span class="op" id="5063768">)</span>&nbsp;<span class="op" id="5063770">!=</span>&nbsp;<span class="num" id="5063773">0</span>&nbsp;<span class="op" id="5063775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5063780">if</span>&nbsp;<span class="ident" id="5063783">_</span><span class="op" id="5063784">,</span>&nbsp;<span class="ident" id="5063786">ok</span>&nbsp;<span class="op" id="5063789">:=</span>&nbsp;<span class="ident" id="5063792">cmd</span><span class="op" id="5063795">.</span><span class="ident" id="5063796">Args</span><span class="op" id="5063800">[</span><span class="num" id="5063801">0</span><span class="op" id="5063802">]</span><span class="op" id="5063803">.</span><span class="op" id="5063804">(</span><span class="op" id="5063805">*</span><span class="ident" id="5063806">parse</span><span class="op" id="5063811">.</span><span class="ident" id="5063812">IdentifierNode</span><span class="op" id="5063826">)</span><span class="op" id="5063827">;</span>&nbsp;<span class="ident" id="5063829">ok</span>&nbsp;<span class="op" id="5063832">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5063838">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5063850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5063854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5063858">idents</span>&nbsp;<span class="op" id="5063865">=</span>&nbsp;<span class="ident" id="5063867">p</span><span class="op" id="5063868">.</span><span class="ident" id="5063869">Cmds</span><span class="op" id="5063873">[</span><span class="ident" id="5063874">i</span><span class="op" id="5063875">+</span><span class="num" id="5063876">1</span><span class="op" id="5063877">:</span><span class="op" id="5063878">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5063881">}</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5063884">dups</span>&nbsp;<span class="op" id="5063889">:=</span>&nbsp;<span class="num" id="5063892">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5063895">for</span>&nbsp;<span class="ident" id="5063899">_</span><span class="op" id="5063900">,</span>&nbsp;<span class="ident" id="5063902">idNode</span>&nbsp;<span class="op" id="5063909">:=</span>&nbsp;<span class="keyword" id="5063912">range</span>&nbsp;<span class="ident" id="5063918">idents</span>&nbsp;<span class="op" id="5063925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5063929">for</span>&nbsp;<span class="ident" id="5063933">_</span><span class="op" id="5063934">,</span>&nbsp;<span class="ident" id="5063936">ident</span>&nbsp;<span class="op" id="5063942">:=</span>&nbsp;<span class="keyword" id="5063945">range</span>&nbsp;<span class="ident" id="5063951">allIdents</span><span class="op" id="5063960">(</span><span class="ident" id="5063961">idNode</span><span class="op" id="5063967">.</span><span class="ident" id="5063968">Args</span><span class="op" id="5063972">[</span><span class="num" id="5063973">0</span><span class="op" id="5063974">]</span><span class="op" id="5063975">)</span>&nbsp;<span class="op" id="5063977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5063982">if</span>&nbsp;<span class="ident" id="5063985">escFnsEq</span><span class="op" id="5063993">(</span><span class="ident" id="5063994">s</span><span class="op" id="5063995">[</span><span class="ident" id="5063996">dups</span><span class="op" id="5064000">]</span><span class="op" id="5064001">,</span>&nbsp;<span class="ident" id="5064003">ident</span><span class="op" id="5064008">)</span>&nbsp;<span class="op" id="5064010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5064016">dups</span><span class="op" id="5064020">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5064027">if</span>&nbsp;<span class="ident" id="5064030">dups</span>&nbsp;<span class="op" id="5064035">==</span>&nbsp;<span class="builtinfunc" id="5064038">len</span><span class="op" id="5064041">(</span><span class="ident" id="5064042">s</span><span class="op" id="5064043">)</span>&nbsp;<span class="op" id="5064045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5064052">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5064063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5064068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5064072">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5064075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5064078">newCmds</span>&nbsp;<span class="op" id="5064086">:=</span>&nbsp;<span class="builtinfunc" id="5064089">make</span><span class="op" id="5064093">(</span><span class="op" id="5064094">[</span><span class="op" id="5064095">]</span><span class="op" id="5064096">*</span><span class="ident" id="5064097">parse</span><span class="op" id="5064102">.</span><span class="ident" id="5064103">CommandNode</span><span class="op" id="5064114">,</span>&nbsp;<span class="ident" id="5064116">n</span><span class="op" id="5064117">-</span><span class="builtinfunc" id="5064118">len</span><span class="op" id="5064121">(</span><span class="ident" id="5064122">idents</span><span class="op" id="5064128">)</span><span class="op" id="5064129">,</span>&nbsp;<span class="ident" id="5064131">n</span><span class="op" id="5064132">+</span><span class="builtinfunc" id="5064133">len</span><span class="op" id="5064136">(</span><span class="ident" id="5064137">s</span><span class="op" id="5064138">)</span><span class="op" id="5064139">-</span><span class="ident" id="5064140">dups</span><span class="op" id="5064144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5064147">copy</span><span class="op" id="5064151">(</span><span class="ident" id="5064152">newCmds</span><span class="op" id="5064159">,</span>&nbsp;<span class="ident" id="5064161">p</span><span class="op" id="5064162">.</span><span class="ident" id="5064163">Cmds</span><span class="op" id="5064167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5064170">//&nbsp;Merge&nbsp;existing&nbsp;identifier&nbsp;commands&nbsp;with&nbsp;the&nbsp;sanitizers&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5064237">for</span>&nbsp;<span class="ident" id="5064241">_</span><span class="op" id="5064242">,</span>&nbsp;<span class="ident" id="5064244">idNode</span>&nbsp;<span class="op" id="5064251">:=</span>&nbsp;<span class="keyword" id="5064254">range</span>&nbsp;<span class="ident" id="5064260">idents</span>&nbsp;<span class="op" id="5064267">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5064271">pos</span>&nbsp;<span class="op" id="5064275">:=</span>&nbsp;<span class="ident" id="5064278">idNode</span><span class="op" id="5064284">.</span><span class="ident" id="5064285">Args</span><span class="op" id="5064289">[</span><span class="num" id="5064290">0</span><span class="op" id="5064291">]</span><span class="op" id="5064292">.</span><span class="ident" id="5064293">Position</span><span class="op" id="5064301">(</span><span class="op" id="5064302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5064306">for</span>&nbsp;<span class="ident" id="5064310">_</span><span class="op" id="5064311">,</span>&nbsp;<span class="ident" id="5064313">ident</span>&nbsp;<span class="op" id="5064319">:=</span>&nbsp;<span class="keyword" id="5064322">range</span>&nbsp;<span class="ident" id="5064328">allIdents</span><span class="op" id="5064337">(</span><span class="ident" id="5064338">idNode</span><span class="op" id="5064344">.</span><span class="ident" id="5064345">Args</span><span class="op" id="5064349">[</span><span class="num" id="5064350">0</span><span class="op" id="5064351">]</span><span class="op" id="5064352">)</span>&nbsp;<span class="op" id="5064354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5064359">i</span>&nbsp;<span class="op" id="5064361">:=</span>&nbsp;<span class="ident" id="5064364">indexOfStr</span><span class="op" id="5064374">(</span><span class="ident" id="5064375">ident</span><span class="op" id="5064380">,</span>&nbsp;<span class="ident" id="5064382">s</span><span class="op" id="5064383">,</span>&nbsp;<span class="ident" id="5064385">escFnsEq</span><span class="op" id="5064393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5064398">if</span>&nbsp;<span class="ident" id="5064401">i</span>&nbsp;<span class="op" id="5064403">!=</span>&nbsp;<span class="op" id="5064406">-</span><span class="num" id="5064407">1</span>&nbsp;<span class="op" id="5064409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5064415">for</span>&nbsp;<span class="ident" id="5064419">_</span><span class="op" id="5064420">,</span>&nbsp;<span class="ident" id="5064422">name</span>&nbsp;<span class="op" id="5064427">:=</span>&nbsp;<span class="keyword" id="5064430">range</span>&nbsp;<span class="ident" id="5064436">s</span><span class="op" id="5064437">[</span><span class="op" id="5064438">:</span><span class="ident" id="5064439">i</span><span class="op" id="5064440">]</span>&nbsp;<span class="op" id="5064442">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5064449">newCmds</span>&nbsp;<span class="op" id="5064457">=</span>&nbsp;<span class="ident" id="5064459">appendCmd</span><span class="op" id="5064468">(</span><span class="ident" id="5064469">newCmds</span><span class="op" id="5064476">,</span>&nbsp;<span class="ident" id="5064478">newIdentCmd</span><span class="op" id="5064489">(</span><span class="ident" id="5064490">name</span><span class="op" id="5064494">,</span>&nbsp;<span class="ident" id="5064496">pos</span><span class="op" id="5064499">)</span><span class="op" id="5064500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5064506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5064512">s</span>&nbsp;<span class="op" id="5064514">=</span>&nbsp;<span class="ident" id="5064516">s</span><span class="op" id="5064517">[</span><span class="ident" id="5064518">i</span><span class="op" id="5064519">+</span><span class="num" id="5064520">1</span><span class="op" id="5064521">:</span><span class="op" id="5064522">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5064527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5064531">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5064535">newCmds</span>&nbsp;<span class="op" id="5064543">=</span>&nbsp;<span class="ident" id="5064545">appendCmd</span><span class="op" id="5064554">(</span><span class="ident" id="5064555">newCmds</span><span class="op" id="5064562">,</span>&nbsp;<span class="ident" id="5064564">idNode</span><span class="op" id="5064570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5064573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5064576">//&nbsp;Create&nbsp;any&nbsp;remaining&nbsp;sanitizers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5064613">for</span>&nbsp;<span class="ident" id="5064617">_</span><span class="op" id="5064618">,</span>&nbsp;<span class="ident" id="5064620">name</span>&nbsp;<span class="op" id="5064625">:=</span>&nbsp;<span class="keyword" id="5064628">range</span>&nbsp;<span class="ident" id="5064634">s</span>&nbsp;<span class="op" id="5064636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5064640">newCmds</span>&nbsp;<span class="op" id="5064648">=</span>&nbsp;<span class="ident" id="5064650">appendCmd</span><span class="op" id="5064659">(</span><span class="ident" id="5064660">newCmds</span><span class="op" id="5064667">,</span>&nbsp;<span class="ident" id="5064669">newIdentCmd</span><span class="op" id="5064680">(</span><span class="ident" id="5064681">name</span><span class="op" id="5064685">,</span>&nbsp;<span class="ident" id="5064687">p</span><span class="op" id="5064688">.</span><span class="ident" id="5064689">Position</span><span class="op" id="5064697">(</span><span class="op" id="5064698">)</span><span class="op" id="5064699">)</span><span class="op" id="5064700">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5064703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5064706">p</span><span class="op" id="5064707">.</span><span class="ident" id="5064708">Cmds</span>&nbsp;<span class="op" id="5064713">=</span>&nbsp;<span class="ident" id="5064715">newCmds</span><br>
<span class="lineno"></span><span class="op" id="5064723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5064726">//&nbsp;redundantFuncs[a][b]&nbsp;implies&nbsp;that&nbsp;funcMap[b](funcMap[a](x))&nbsp;==&nbsp;funcMap[a](x)</span><br>
<span class="lineno">275</span><span class="comment" id="5064806">//&nbsp;for&nbsp;all&nbsp;x.</span><br>
<span class="lineno"></span><span class="keyword" id="5064820">var</span>&nbsp;<span class="ident" id="5064824">redundantFuncs</span>&nbsp;<span class="op" id="5064839">=</span>&nbsp;<span class="keyword" id="5064841">map</span><span class="op" id="5064844">[</span><span class="builtintype" id="5064845">string</span><span class="op" id="5064851">]</span><span class="keyword" id="5064852">map</span><span class="op" id="5064855">[</span><span class="builtintype" id="5064856">string</span><span class="op" id="5064862">]</span><span class="builtintype" id="5064863">bool</span><span class="op" id="5064867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5064870">&#34;html_template_commentescaper&#34;</span><span class="op" id="5064900">:</span>&nbsp;<span class="op" id="5064902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5064906">&#34;html_template_attrescaper&#34;</span><span class="op" id="5064933">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5064938">true</span><span class="op" id="5064942">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5064946">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5064976">:</span>&nbsp;<span class="builtintype" id="5064978">true</span><span class="op" id="5064982">,</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5064986">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5065013">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5065018">true</span><span class="op" id="5065022">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5065025">}</span><span class="op" id="5065026">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5065029">&#34;html_template_cssescaper&#34;</span><span class="op" id="5065055">:</span>&nbsp;<span class="op" id="5065057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5065061">&#34;html_template_attrescaper&#34;</span><span class="op" id="5065088">:</span>&nbsp;<span class="builtintype" id="5065090">true</span><span class="op" id="5065094">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5065097">}</span><span class="op" id="5065098">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5065101">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="5065132">:</span>&nbsp;<span class="op" id="5065134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5065138">&#34;html_template_attrescaper&#34;</span><span class="op" id="5065165">:</span>&nbsp;<span class="builtintype" id="5065167">true</span><span class="op" id="5065171">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5065174">}</span><span class="op" id="5065175">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5065178">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="5065206">:</span>&nbsp;<span class="op" id="5065208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5065212">&#34;html_template_attrescaper&#34;</span><span class="op" id="5065239">:</span>&nbsp;<span class="builtintype" id="5065241">true</span><span class="op" id="5065245">,</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5065248">}</span><span class="op" id="5065249">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5065252">&#34;html_template_urlescaper&#34;</span><span class="op" id="5065278">:</span>&nbsp;<span class="op" id="5065280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5065284">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5065313">:</span>&nbsp;<span class="builtintype" id="5065315">true</span><span class="op" id="5065319">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5065322">}</span><span class="op" id="5065323">,</span><br>
<span class="lineno"></span><span class="op" id="5065325">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span><span class="comment" id="5065328">//&nbsp;appendCmd&nbsp;appends&nbsp;the&nbsp;given&nbsp;command&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;pipeline</span><br>
<span class="lineno"></span><span class="comment" id="5065402">//&nbsp;unless&nbsp;it&nbsp;is&nbsp;redundant&nbsp;with&nbsp;the&nbsp;last&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="5065451">func</span>&nbsp;<span class="ident" id="5065456">appendCmd</span><span class="op" id="5065465">(</span><span class="ident" id="5065466">cmds</span>&nbsp;<span class="op" id="5065471">[</span><span class="op" id="5065472">]</span><span class="op" id="5065473">*</span><span class="ident" id="5065474">parse</span><span class="op" id="5065479">.</span><span class="ident" id="5065480">CommandNode</span><span class="op" id="5065491">,</span>&nbsp;<span class="ident" id="5065493">cmd</span>&nbsp;<span class="op" id="5065497">*</span><span class="ident" id="5065498">parse</span><span class="op" id="5065503">.</span><span class="ident" id="5065504">CommandNode</span><span class="op" id="5065515">)</span>&nbsp;<span class="op" id="5065517">[</span><span class="op" id="5065518">]</span><span class="op" id="5065519">*</span><span class="ident" id="5065520">parse</span><span class="op" id="5065525">.</span><span class="ident" id="5065526">CommandNode</span>&nbsp;<span class="op" id="5065538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5065541">if</span>&nbsp;<span class="ident" id="5065544">n</span>&nbsp;<span class="op" id="5065546">:=</span>&nbsp;<span class="builtinfunc" id="5065549">len</span><span class="op" id="5065552">(</span><span class="ident" id="5065553">cmds</span><span class="op" id="5065557">)</span><span class="op" id="5065558">;</span>&nbsp;<span class="ident" id="5065560">n</span>&nbsp;<span class="op" id="5065562">!=</span>&nbsp;<span class="num" id="5065565">0</span>&nbsp;<span class="op" id="5065567">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5065571">last</span><span class="op" id="5065575">,</span>&nbsp;<span class="ident" id="5065577">ok</span>&nbsp;<span class="op" id="5065580">:=</span>&nbsp;<span class="ident" id="5065583">cmds</span><span class="op" id="5065587">[</span><span class="ident" id="5065588">n</span><span class="op" id="5065589">-</span><span class="num" id="5065590">1</span><span class="op" id="5065591">]</span><span class="op" id="5065592">.</span><span class="ident" id="5065593">Args</span><span class="op" id="5065597">[</span><span class="num" id="5065598">0</span><span class="op" id="5065599">]</span><span class="op" id="5065600">.</span><span class="op" id="5065601">(</span><span class="op" id="5065602">*</span><span class="ident" id="5065603">parse</span><span class="op" id="5065608">.</span><span class="ident" id="5065609">IdentifierNode</span><span class="op" id="5065623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5065627">next</span><span class="op" id="5065631">,</span>&nbsp;<span class="ident" id="5065633">_</span>&nbsp;<span class="op" id="5065635">:=</span>&nbsp;<span class="ident" id="5065638">cmd</span><span class="op" id="5065641">.</span><span class="ident" id="5065642">Args</span><span class="op" id="5065646">[</span><span class="num" id="5065647">0</span><span class="op" id="5065648">]</span><span class="op" id="5065649">.</span><span class="op" id="5065650">(</span><span class="op" id="5065651">*</span><span class="ident" id="5065652">parse</span><span class="op" id="5065657">.</span><span class="ident" id="5065658">IdentifierNode</span><span class="op" id="5065672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5065676">if</span>&nbsp;<span class="ident" id="5065679">ok</span>&nbsp;<span class="op" id="5065682">&amp;&amp;</span>&nbsp;<span class="ident" id="5065685">redundantFuncs</span><span class="op" id="5065699">[</span><span class="ident" id="5065700">last</span><span class="op" id="5065704">.</span><span class="ident" id="5065705">Ident</span><span class="op" id="5065710">]</span><span class="op" id="5065711">[</span><span class="ident" id="5065712">next</span><span class="op" id="5065716">.</span><span class="ident" id="5065717">Ident</span><span class="op" id="5065722">]</span>&nbsp;<span class="op" id="5065724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5065729">return</span>&nbsp;<span class="ident" id="5065736">cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5065743">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5065746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5065749">return</span>&nbsp;<span class="builtinfunc" id="5065756">append</span><span class="op" id="5065762">(</span><span class="ident" id="5065763">cmds</span><span class="op" id="5065767">,</span>&nbsp;<span class="ident" id="5065769">cmd</span><span class="op" id="5065772">)</span><br>
<span class="lineno"></span><span class="op" id="5065774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5065777">//&nbsp;indexOfStr&nbsp;is&nbsp;the&nbsp;first&nbsp;i&nbsp;such&nbsp;that&nbsp;eq(s,&nbsp;strs[i])&nbsp;or&nbsp;-1&nbsp;if&nbsp;s&nbsp;was&nbsp;not&nbsp;found.</span><br>
<span class="lineno">310</span><span class="keyword" id="5065857">func</span>&nbsp;<span class="ident" id="5065862">indexOfStr</span><span class="op" id="5065872">(</span><span class="ident" id="5065873">s</span>&nbsp;<span class="builtintype" id="5065875">string</span><span class="op" id="5065881">,</span>&nbsp;<span class="ident" id="5065883">strs</span>&nbsp;<span class="op" id="5065888">[</span><span class="op" id="5065889">]</span><span class="builtintype" id="5065890">string</span><span class="op" id="5065896">,</span>&nbsp;<span class="ident" id="5065898">eq</span>&nbsp;<span class="keyword" id="5065901">func</span><span class="op" id="5065905">(</span><span class="ident" id="5065906">a</span><span class="op" id="5065907">,</span>&nbsp;<span class="ident" id="5065909">b</span>&nbsp;<span class="builtintype" id="5065911">string</span><span class="op" id="5065917">)</span>&nbsp;<span class="builtintype" id="5065919">bool</span><span class="op" id="5065923">)</span>&nbsp;<span class="builtintype" id="5065925">int</span>&nbsp;<span class="op" id="5065929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5065932">for</span>&nbsp;<span class="ident" id="5065936">i</span><span class="op" id="5065937">,</span>&nbsp;<span class="ident" id="5065939">t</span>&nbsp;<span class="op" id="5065941">:=</span>&nbsp;<span class="keyword" id="5065944">range</span>&nbsp;<span class="ident" id="5065950">strs</span>&nbsp;<span class="op" id="5065955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5065959">if</span>&nbsp;<span class="ident" id="5065962">eq</span><span class="op" id="5065964">(</span><span class="ident" id="5065965">s</span><span class="op" id="5065966">,</span>&nbsp;<span class="ident" id="5065968">t</span><span class="op" id="5065969">)</span>&nbsp;<span class="op" id="5065971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5065976">return</span>&nbsp;<span class="ident" id="5065983">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5065987">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5065990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5065993">return</span>&nbsp;<span class="op" id="5066000">-</span><span class="num" id="5066001">1</span><br>
<span class="lineno"></span><span class="op" id="5066003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5066006">//&nbsp;escFnsEq&nbsp;reports&nbsp;whether&nbsp;the&nbsp;two&nbsp;escaping&nbsp;functions&nbsp;are&nbsp;equivalent.</span><br>
<span class="lineno">320</span><span class="keyword" id="5066077">func</span>&nbsp;<span class="ident" id="5066082">escFnsEq</span><span class="op" id="5066090">(</span><span class="ident" id="5066091">a</span><span class="op" id="5066092">,</span>&nbsp;<span class="ident" id="5066094">b</span>&nbsp;<span class="builtintype" id="5066096">string</span><span class="op" id="5066102">)</span>&nbsp;<span class="builtintype" id="5066104">bool</span>&nbsp;<span class="op" id="5066109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5066112">if</span>&nbsp;<span class="ident" id="5066115">e</span>&nbsp;<span class="op" id="5066117">:=</span>&nbsp;<span class="ident" id="5066120">equivEscapers</span><span class="op" id="5066133">[</span><span class="ident" id="5066134">a</span><span class="op" id="5066135">]</span><span class="op" id="5066136">;</span>&nbsp;<span class="ident" id="5066138">e</span>&nbsp;<span class="op" id="5066140">!=</span>&nbsp;<span class="string" id="5066143">&#34;&#34;</span>&nbsp;<span class="op" id="5066146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5066150">a</span>&nbsp;<span class="op" id="5066152">=</span>&nbsp;<span class="ident" id="5066154">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5066157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5066160">if</span>&nbsp;<span class="ident" id="5066163">e</span>&nbsp;<span class="op" id="5066165">:=</span>&nbsp;<span class="ident" id="5066168">equivEscapers</span><span class="op" id="5066181">[</span><span class="ident" id="5066182">b</span><span class="op" id="5066183">]</span><span class="op" id="5066184">;</span>&nbsp;<span class="ident" id="5066186">e</span>&nbsp;<span class="op" id="5066188">!=</span>&nbsp;<span class="string" id="5066191">&#34;&#34;</span>&nbsp;<span class="op" id="5066194">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5066198">b</span>&nbsp;<span class="op" id="5066200">=</span>&nbsp;<span class="ident" id="5066202">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5066205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5066208">return</span>&nbsp;<span class="ident" id="5066215">a</span>&nbsp;<span class="op" id="5066217">==</span>&nbsp;<span class="ident" id="5066220">b</span><br>
<span class="lineno"></span><span class="op" id="5066222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="5066225">//&nbsp;newIdentCmd&nbsp;produces&nbsp;a&nbsp;command&nbsp;containing&nbsp;a&nbsp;single&nbsp;identifier&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5066296">func</span>&nbsp;<span class="ident" id="5066301">newIdentCmd</span><span class="op" id="5066312">(</span><span class="ident" id="5066313">identifier</span>&nbsp;<span class="builtintype" id="5066324">string</span><span class="op" id="5066330">,</span>&nbsp;<span class="ident" id="5066332">pos</span>&nbsp;<span class="ident" id="5066336">parse</span><span class="op" id="5066341">.</span><span class="ident" id="5066342">Pos</span><span class="op" id="5066345">)</span>&nbsp;<span class="op" id="5066347">*</span><span class="ident" id="5066348">parse</span><span class="op" id="5066353">.</span><span class="ident" id="5066354">CommandNode</span>&nbsp;<span class="op" id="5066366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5066369">return</span>&nbsp;<span class="op" id="5066376">&amp;</span><span class="ident" id="5066377">parse</span><span class="op" id="5066382">.</span><span class="ident" id="5066383">CommandNode</span><span class="op" id="5066394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5066398">NodeType</span><span class="op" id="5066406">:</span>&nbsp;<span class="ident" id="5066408">parse</span><span class="op" id="5066413">.</span><span class="ident" id="5066414">NodeCommand</span><span class="op" id="5066425">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5066429">Args</span><span class="op" id="5066433">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5066439">[</span><span class="op" id="5066440">]</span><span class="ident" id="5066441">parse</span><span class="op" id="5066446">.</span><span class="ident" id="5066447">Node</span><span class="op" id="5066451">{</span><span class="ident" id="5066452">parse</span><span class="op" id="5066457">.</span><span class="ident" id="5066458">NewIdentifier</span><span class="op" id="5066471">(</span><span class="ident" id="5066472">identifier</span><span class="op" id="5066482">)</span><span class="op" id="5066483">.</span><span class="ident" id="5066484">SetTree</span><span class="op" id="5066491">(</span><span class="ident" id="5066492">nil</span><span class="op" id="5066495">)</span><span class="op" id="5066496">.</span><span class="ident" id="5066497">SetPos</span><span class="op" id="5066503">(</span><span class="ident" id="5066504">pos</span><span class="op" id="5066507">)</span><span class="op" id="5066508">}</span><span class="op" id="5066509">,</span>&nbsp;<span class="comment" id="5066511">//&nbsp;TODO:&nbsp;SetTree.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5066530">}</span><br>
<span class="lineno"></span><span class="op" id="5066532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5066535">//&nbsp;nudge&nbsp;returns&nbsp;the&nbsp;context&nbsp;that&nbsp;would&nbsp;result&nbsp;from&nbsp;following&nbsp;empty&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5066610">//&nbsp;transitions&nbsp;from&nbsp;the&nbsp;input&nbsp;context.</span><br>
<span class="lineno">340</span><span class="comment" id="5066649">//&nbsp;For&nbsp;example,&nbsp;parsing:</span><br>
<span class="lineno"></span><span class="comment" id="5066674">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=`</span><br>
<span class="lineno"></span><span class="comment" id="5066692">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateBeforeValue,&nbsp;attrURL},&nbsp;but&nbsp;parsing&nbsp;one&nbsp;extra&nbsp;rune:</span><br>
<span class="lineno"></span><span class="comment" id="5066771">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=x`</span><br>
<span class="lineno"></span><span class="comment" id="5066790">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateURL,&nbsp;delimSpaceOrTagEnd,&nbsp;...}.</span><br>
<span class="lineno">345</span><span class="comment" id="5066849">//&nbsp;There&nbsp;are&nbsp;two&nbsp;transitions&nbsp;that&nbsp;happen&nbsp;when&nbsp;the&nbsp;&#39;x&#39;&nbsp;is&nbsp;seen:</span><br>
<span class="lineno"></span><span class="comment" id="5066912">//&nbsp;(1)&nbsp;Transition&nbsp;from&nbsp;a&nbsp;before-value&nbsp;state&nbsp;to&nbsp;a&nbsp;start-of-value&nbsp;state&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="5066990">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consuming&nbsp;any&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5067022">//&nbsp;(2)&nbsp;Consume&nbsp;&#39;x&#39;&nbsp;and&nbsp;transition&nbsp;past&nbsp;the&nbsp;first&nbsp;value&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5067088">//&nbsp;In&nbsp;this&nbsp;case,&nbsp;nudging&nbsp;produces&nbsp;the&nbsp;context&nbsp;after&nbsp;(1)&nbsp;happens.</span><br>
<span class="lineno">350</span><span class="keyword" id="5067153">func</span>&nbsp;<span class="ident" id="5067158">nudge</span><span class="op" id="5067163">(</span><span class="ident" id="5067164">c</span>&nbsp;<span class="ident" id="5067166">context</span><span class="op" id="5067173">)</span>&nbsp;<span class="ident" id="5067175">context</span>&nbsp;<span class="op" id="5067183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5067186">switch</span>&nbsp;<span class="ident" id="5067193">c</span><span class="op" id="5067194">.</span><span class="ident" id="5067195">state</span>&nbsp;<span class="op" id="5067201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5067204">case</span>&nbsp;<span class="ident" id="5067209">stateTag</span><span class="op" id="5067217">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5067221">//&nbsp;In&nbsp;`&lt;foo&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;should&nbsp;emit&nbsp;an&nbsp;attribute.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5067280">c</span><span class="op" id="5067281">.</span><span class="ident" id="5067282">state</span>&nbsp;<span class="op" id="5067288">=</span>&nbsp;<span class="ident" id="5067290">stateAttrName</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5067305">case</span>&nbsp;<span class="ident" id="5067310">stateBeforeValue</span><span class="op" id="5067326">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5067330">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar={{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;undelimited&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5067392">c</span><span class="op" id="5067393">.</span><span class="ident" id="5067394">state</span><span class="op" id="5067399">,</span>&nbsp;<span class="ident" id="5067401">c</span><span class="op" id="5067402">.</span><span class="ident" id="5067403">delim</span><span class="op" id="5067408">,</span>&nbsp;<span class="ident" id="5067410">c</span><span class="op" id="5067411">.</span><span class="ident" id="5067412">attr</span>&nbsp;<span class="op" id="5067417">=</span>&nbsp;<span class="ident" id="5067419">attrStartStates</span><span class="op" id="5067434">[</span><span class="ident" id="5067435">c</span><span class="op" id="5067436">.</span><span class="ident" id="5067437">attr</span><span class="op" id="5067441">]</span><span class="op" id="5067442">,</span>&nbsp;<span class="ident" id="5067444">delimSpaceOrTagEnd</span><span class="op" id="5067462">,</span>&nbsp;<span class="ident" id="5067464">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5067474">case</span>&nbsp;<span class="ident" id="5067479">stateAfterName</span><span class="op" id="5067493">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5067497">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;attribute&nbsp;name.</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5067556">c</span><span class="op" id="5067557">.</span><span class="ident" id="5067558">state</span><span class="op" id="5067563">,</span>&nbsp;<span class="ident" id="5067565">c</span><span class="op" id="5067566">.</span><span class="ident" id="5067567">attr</span>&nbsp;<span class="op" id="5067572">=</span>&nbsp;<span class="ident" id="5067574">stateAttrName</span><span class="op" id="5067587">,</span>&nbsp;<span class="ident" id="5067589">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5067599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5067602">return</span>&nbsp;<span class="ident" id="5067609">c</span><br>
<span class="lineno"></span><span class="op" id="5067611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="5067614">//&nbsp;join&nbsp;joins&nbsp;the&nbsp;two&nbsp;contexts&nbsp;of&nbsp;a&nbsp;branch&nbsp;template&nbsp;node.&nbsp;The&nbsp;result&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="5067689">//&nbsp;error&nbsp;context&nbsp;if&nbsp;either&nbsp;of&nbsp;the&nbsp;input&nbsp;contexts&nbsp;are&nbsp;error&nbsp;contexts,&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5067768">//&nbsp;the&nbsp;input&nbsp;contexts&nbsp;differ.</span><br>
<span class="lineno"></span><span class="keyword" id="5067798">func</span>&nbsp;<span class="ident" id="5067803">join</span><span class="op" id="5067807">(</span><span class="ident" id="5067808">a</span><span class="op" id="5067809">,</span>&nbsp;<span class="ident" id="5067811">b</span>&nbsp;<span class="ident" id="5067813">context</span><span class="op" id="5067820">,</span>&nbsp;<span class="ident" id="5067822">node</span>&nbsp;<span class="ident" id="5067827">parse</span><span class="op" id="5067832">.</span><span class="ident" id="5067833">Node</span><span class="op" id="5067837">,</span>&nbsp;<span class="ident" id="5067839">nodeName</span>&nbsp;<span class="builtintype" id="5067848">string</span><span class="op" id="5067854">)</span>&nbsp;<span class="ident" id="5067856">context</span>&nbsp;<span class="op" id="5067864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5067867">if</span>&nbsp;<span class="ident" id="5067870">a</span><span class="op" id="5067871">.</span><span class="ident" id="5067872">state</span>&nbsp;<span class="op" id="5067878">==</span>&nbsp;<span class="ident" id="5067881">stateError</span>&nbsp;<span class="op" id="5067892">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5067896">return</span>&nbsp;<span class="ident" id="5067903">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5067906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5067909">if</span>&nbsp;<span class="ident" id="5067912">b</span><span class="op" id="5067913">.</span><span class="ident" id="5067914">state</span>&nbsp;<span class="op" id="5067920">==</span>&nbsp;<span class="ident" id="5067923">stateError</span>&nbsp;<span class="op" id="5067934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5067938">return</span>&nbsp;<span class="ident" id="5067945">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5067948">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5067951">if</span>&nbsp;<span class="ident" id="5067954">a</span><span class="op" id="5067955">.</span><span class="ident" id="5067956">eq</span><span class="op" id="5067958">(</span><span class="ident" id="5067959">b</span><span class="op" id="5067960">)</span>&nbsp;<span class="op" id="5067962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5067966">return</span>&nbsp;<span class="ident" id="5067973">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5067976">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5067980">c</span>&nbsp;<span class="op" id="5067982">:=</span>&nbsp;<span class="ident" id="5067985">a</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5067988">c</span><span class="op" id="5067989">.</span><span class="ident" id="5067990">urlPart</span>&nbsp;<span class="op" id="5067998">=</span>&nbsp;<span class="ident" id="5068000">b</span><span class="op" id="5068001">.</span><span class="ident" id="5068002">urlPart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5068011">if</span>&nbsp;<span class="ident" id="5068014">c</span><span class="op" id="5068015">.</span><span class="ident" id="5068016">eq</span><span class="op" id="5068018">(</span><span class="ident" id="5068019">b</span><span class="op" id="5068020">)</span>&nbsp;<span class="op" id="5068022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5068026">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;urlPart.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5068068">c</span><span class="op" id="5068069">.</span><span class="ident" id="5068070">urlPart</span>&nbsp;<span class="op" id="5068078">=</span>&nbsp;<span class="ident" id="5068080">urlPartUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5068097">return</span>&nbsp;<span class="ident" id="5068104">c</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5068107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5068111">c</span>&nbsp;<span class="op" id="5068113">=</span>&nbsp;<span class="ident" id="5068115">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5068118">c</span><span class="op" id="5068119">.</span><span class="ident" id="5068120">jsCtx</span>&nbsp;<span class="op" id="5068126">=</span>&nbsp;<span class="ident" id="5068128">b</span><span class="op" id="5068129">.</span><span class="ident" id="5068130">jsCtx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5068137">if</span>&nbsp;<span class="ident" id="5068140">c</span><span class="op" id="5068141">.</span><span class="ident" id="5068142">eq</span><span class="op" id="5068144">(</span><span class="ident" id="5068145">b</span><span class="op" id="5068146">)</span>&nbsp;<span class="op" id="5068148">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5068152">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;jsCtx.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5068192">c</span><span class="op" id="5068193">.</span><span class="ident" id="5068194">jsCtx</span>&nbsp;<span class="op" id="5068200">=</span>&nbsp;<span class="ident" id="5068202">jsCtxUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5068217">return</span>&nbsp;<span class="ident" id="5068224">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5068227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5068231">//&nbsp;Allow&nbsp;a&nbsp;nudged&nbsp;context&nbsp;to&nbsp;join&nbsp;with&nbsp;an&nbsp;unnudged&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5068288">//&nbsp;This&nbsp;means&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5068308">//&nbsp;&nbsp;&nbsp;&lt;p&nbsp;title={{if&nbsp;.C}}{{.}}{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5068345">//&nbsp;ends&nbsp;in&nbsp;an&nbsp;unquoted&nbsp;value&nbsp;state&nbsp;even&nbsp;though&nbsp;the&nbsp;else&nbsp;branch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5068409">//&nbsp;ends&nbsp;in&nbsp;stateBeforeValue.</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5068439">if</span>&nbsp;<span class="ident" id="5068442">c</span><span class="op" id="5068443">,</span>&nbsp;<span class="ident" id="5068445">d</span>&nbsp;<span class="op" id="5068447">:=</span>&nbsp;<span class="ident" id="5068450">nudge</span><span class="op" id="5068455">(</span><span class="ident" id="5068456">a</span><span class="op" id="5068457">)</span><span class="op" id="5068458">,</span>&nbsp;<span class="ident" id="5068460">nudge</span><span class="op" id="5068465">(</span><span class="ident" id="5068466">b</span><span class="op" id="5068467">)</span><span class="op" id="5068468">;</span>&nbsp;<span class="op" id="5068470">!</span><span class="op" id="5068471">(</span><span class="ident" id="5068472">c</span><span class="op" id="5068473">.</span><span class="ident" id="5068474">eq</span><span class="op" id="5068476">(</span><span class="ident" id="5068477">a</span><span class="op" id="5068478">)</span>&nbsp;<span class="op" id="5068480">&amp;&amp;</span>&nbsp;<span class="ident" id="5068483">d</span><span class="op" id="5068484">.</span><span class="ident" id="5068485">eq</span><span class="op" id="5068487">(</span><span class="ident" id="5068488">b</span><span class="op" id="5068489">)</span><span class="op" id="5068490">)</span>&nbsp;<span class="op" id="5068492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5068496">if</span>&nbsp;<span class="ident" id="5068499">e</span>&nbsp;<span class="op" id="5068501">:=</span>&nbsp;<span class="ident" id="5068504">join</span><span class="op" id="5068508">(</span><span class="ident" id="5068509">c</span><span class="op" id="5068510">,</span>&nbsp;<span class="ident" id="5068512">d</span><span class="op" id="5068513">,</span>&nbsp;<span class="ident" id="5068515">node</span><span class="op" id="5068519">,</span>&nbsp;<span class="ident" id="5068521">nodeName</span><span class="op" id="5068529">)</span><span class="op" id="5068530">;</span>&nbsp;<span class="ident" id="5068532">e</span><span class="op" id="5068533">.</span><span class="ident" id="5068534">state</span>&nbsp;<span class="op" id="5068540">!=</span>&nbsp;<span class="ident" id="5068543">stateError</span>&nbsp;<span class="op" id="5068554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5068559">return</span>&nbsp;<span class="ident" id="5068566">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5068570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5068573">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5068577">return</span>&nbsp;<span class="ident" id="5068584">context</span><span class="op" id="5068591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5068595">state</span><span class="op" id="5068600">:</span>&nbsp;<span class="ident" id="5068602">stateError</span><span class="op" id="5068612">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5068616">err</span><span class="op" id="5068619">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5068623">errorf</span><span class="op" id="5068629">(</span><span class="ident" id="5068630">ErrBranchEnd</span><span class="op" id="5068642">,</span>&nbsp;<span class="ident" id="5068644">node</span><span class="op" id="5068648">,</span>&nbsp;<span class="num" id="5068650">0</span><span class="op" id="5068651">,</span>&nbsp;<span class="string" id="5068653">&#34;{{%s}}&nbsp;branches&nbsp;end&nbsp;in&nbsp;different&nbsp;contexts:&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="5068704">,</span>&nbsp;<span class="ident" id="5068706">nodeName</span><span class="op" id="5068714">,</span>&nbsp;<span class="ident" id="5068716">a</span><span class="op" id="5068717">,</span>&nbsp;<span class="ident" id="5068719">b</span><span class="op" id="5068720">)</span><span class="op" id="5068721">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5068724">}</span><br>
<span class="lineno">410</span><span class="op" id="5068726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5068729">//&nbsp;escapeBranch&nbsp;escapes&nbsp;a&nbsp;branch&nbsp;template&nbsp;node:&nbsp;&#34;if&#34;,&nbsp;&#34;range&#34;&nbsp;and&nbsp;&#34;with&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="5068803">func</span>&nbsp;<span class="op" id="5068808">(</span><span class="ident" id="5068809">e</span>&nbsp;<span class="op" id="5068811">*</span><span class="ident" id="5068812">escaper</span><span class="op" id="5068819">)</span>&nbsp;<span class="ident" id="5068821">escapeBranch</span><span class="op" id="5068833">(</span><span class="ident" id="5068834">c</span>&nbsp;<span class="ident" id="5068836">context</span><span class="op" id="5068843">,</span>&nbsp;<span class="ident" id="5068845">n</span>&nbsp;<span class="op" id="5068847">*</span><span class="ident" id="5068848">parse</span><span class="op" id="5068853">.</span><span class="ident" id="5068854">BranchNode</span><span class="op" id="5068864">,</span>&nbsp;<span class="ident" id="5068866">nodeName</span>&nbsp;<span class="builtintype" id="5068875">string</span><span class="op" id="5068881">)</span>&nbsp;<span class="ident" id="5068883">context</span>&nbsp;<span class="op" id="5068891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5068894">c0</span>&nbsp;<span class="op" id="5068897">:=</span>&nbsp;<span class="ident" id="5068900">e</span><span class="op" id="5068901">.</span><span class="ident" id="5068902">escapeList</span><span class="op" id="5068912">(</span><span class="ident" id="5068913">c</span><span class="op" id="5068914">,</span>&nbsp;<span class="ident" id="5068916">n</span><span class="op" id="5068917">.</span><span class="ident" id="5068918">List</span><span class="op" id="5068922">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5068925">if</span>&nbsp;<span class="ident" id="5068928">nodeName</span>&nbsp;<span class="op" id="5068937">==</span>&nbsp;<span class="string" id="5068940">&#34;range&#34;</span>&nbsp;<span class="op" id="5068948">&amp;&amp;</span>&nbsp;<span class="ident" id="5068951">c0</span><span class="op" id="5068953">.</span><span class="ident" id="5068954">state</span>&nbsp;<span class="op" id="5068960">!=</span>&nbsp;<span class="ident" id="5068963">stateError</span>&nbsp;<span class="op" id="5068974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5068978">//&nbsp;The&nbsp;&#34;true&#34;&nbsp;branch&nbsp;of&nbsp;a&nbsp;&#34;range&#34;&nbsp;node&nbsp;can&nbsp;execute&nbsp;multiple&nbsp;times.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5069047">//&nbsp;We&nbsp;check&nbsp;that&nbsp;executing&nbsp;n.List&nbsp;once&nbsp;results&nbsp;in&nbsp;the&nbsp;same&nbsp;context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5069116">//&nbsp;as&nbsp;executing&nbsp;n.List&nbsp;twice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5069148">c1</span><span class="op" id="5069150">,</span>&nbsp;<span class="ident" id="5069152">_</span>&nbsp;<span class="op" id="5069154">:=</span>&nbsp;<span class="ident" id="5069157">e</span><span class="op" id="5069158">.</span><span class="ident" id="5069159">escapeListConditionally</span><span class="op" id="5069182">(</span><span class="ident" id="5069183">c0</span><span class="op" id="5069185">,</span>&nbsp;<span class="ident" id="5069187">n</span><span class="op" id="5069188">.</span><span class="ident" id="5069189">List</span><span class="op" id="5069193">,</span>&nbsp;<span class="ident" id="5069195">nil</span><span class="op" id="5069198">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5069202">c0</span>&nbsp;<span class="op" id="5069205">=</span>&nbsp;<span class="ident" id="5069207">join</span><span class="op" id="5069211">(</span><span class="ident" id="5069212">c0</span><span class="op" id="5069214">,</span>&nbsp;<span class="ident" id="5069216">c1</span><span class="op" id="5069218">,</span>&nbsp;<span class="ident" id="5069220">n</span><span class="op" id="5069221">,</span>&nbsp;<span class="ident" id="5069223">nodeName</span><span class="op" id="5069231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5069235">if</span>&nbsp;<span class="ident" id="5069238">c0</span><span class="op" id="5069240">.</span><span class="ident" id="5069241">state</span>&nbsp;<span class="op" id="5069247">==</span>&nbsp;<span class="ident" id="5069250">stateError</span>&nbsp;<span class="op" id="5069261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5069266">//&nbsp;Make&nbsp;clear&nbsp;that&nbsp;this&nbsp;is&nbsp;a&nbsp;problem&nbsp;on&nbsp;loop&nbsp;re-entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5069323">//&nbsp;since&nbsp;developers&nbsp;tend&nbsp;to&nbsp;overlook&nbsp;that&nbsp;branch&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5069380">//&nbsp;debugging&nbsp;templates.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5069407">c0</span><span class="op" id="5069409">.</span><span class="ident" id="5069410">err</span><span class="op" id="5069413">.</span><span class="ident" id="5069414">Line</span>&nbsp;<span class="op" id="5069419">=</span>&nbsp;<span class="ident" id="5069421">n</span><span class="op" id="5069422">.</span><span class="ident" id="5069423">Line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5069431">c0</span><span class="op" id="5069433">.</span><span class="ident" id="5069434">err</span><span class="op" id="5069437">.</span><span class="ident" id="5069438">Description</span>&nbsp;<span class="op" id="5069450">=</span>&nbsp;<span class="string" id="5069452">&#34;on&nbsp;range&nbsp;loop&nbsp;re-entry:&nbsp;&#34;</span>&nbsp;<span class="op" id="5069479">+</span>&nbsp;<span class="ident" id="5069481">c0</span><span class="op" id="5069483">.</span><span class="ident" id="5069484">err</span><span class="op" id="5069487">.</span><span class="ident" id="5069488">Description</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5069503">return</span>&nbsp;<span class="ident" id="5069510">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5069515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5069518">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5069521">c1</span>&nbsp;<span class="op" id="5069524">:=</span>&nbsp;<span class="ident" id="5069527">e</span><span class="op" id="5069528">.</span><span class="ident" id="5069529">escapeList</span><span class="op" id="5069539">(</span><span class="ident" id="5069540">c</span><span class="op" id="5069541">,</span>&nbsp;<span class="ident" id="5069543">n</span><span class="op" id="5069544">.</span><span class="ident" id="5069545">ElseList</span><span class="op" id="5069553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5069556">return</span>&nbsp;<span class="ident" id="5069563">join</span><span class="op" id="5069567">(</span><span class="ident" id="5069568">c0</span><span class="op" id="5069570">,</span>&nbsp;<span class="ident" id="5069572">c1</span><span class="op" id="5069574">,</span>&nbsp;<span class="ident" id="5069576">n</span><span class="op" id="5069577">,</span>&nbsp;<span class="ident" id="5069579">nodeName</span><span class="op" id="5069587">)</span><br>
<span class="lineno"></span><span class="op" id="5069589">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5069592">//&nbsp;escapeList&nbsp;escapes&nbsp;a&nbsp;list&nbsp;template&nbsp;node.</span><br>
<span class="lineno">435</span><span class="keyword" id="5069636">func</span>&nbsp;<span class="op" id="5069641">(</span><span class="ident" id="5069642">e</span>&nbsp;<span class="op" id="5069644">*</span><span class="ident" id="5069645">escaper</span><span class="op" id="5069652">)</span>&nbsp;<span class="ident" id="5069654">escapeList</span><span class="op" id="5069664">(</span><span class="ident" id="5069665">c</span>&nbsp;<span class="ident" id="5069667">context</span><span class="op" id="5069674">,</span>&nbsp;<span class="ident" id="5069676">n</span>&nbsp;<span class="op" id="5069678">*</span><span class="ident" id="5069679">parse</span><span class="op" id="5069684">.</span><span class="ident" id="5069685">ListNode</span><span class="op" id="5069693">)</span>&nbsp;<span class="ident" id="5069695">context</span>&nbsp;<span class="op" id="5069703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5069706">if</span>&nbsp;<span class="ident" id="5069709">n</span>&nbsp;<span class="op" id="5069711">==</span>&nbsp;<span class="ident" id="5069714">nil</span>&nbsp;<span class="op" id="5069718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5069722">return</span>&nbsp;<span class="ident" id="5069729">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5069732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5069735">for</span>&nbsp;<span class="ident" id="5069739">_</span><span class="op" id="5069740">,</span>&nbsp;<span class="ident" id="5069742">m</span>&nbsp;<span class="op" id="5069744">:=</span>&nbsp;<span class="keyword" id="5069747">range</span>&nbsp;<span class="ident" id="5069753">n</span><span class="op" id="5069754">.</span><span class="ident" id="5069755">Nodes</span>&nbsp;<span class="op" id="5069761">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5069765">c</span>&nbsp;<span class="op" id="5069767">=</span>&nbsp;<span class="ident" id="5069769">e</span><span class="op" id="5069770">.</span><span class="ident" id="5069771">escape</span><span class="op" id="5069777">(</span><span class="ident" id="5069778">c</span><span class="op" id="5069779">,</span>&nbsp;<span class="ident" id="5069781">m</span><span class="op" id="5069782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5069785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5069788">return</span>&nbsp;<span class="ident" id="5069795">c</span><br>
<span class="lineno"></span><span class="op" id="5069797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="5069800">//&nbsp;escapeListConditionally&nbsp;escapes&nbsp;a&nbsp;list&nbsp;node&nbsp;but&nbsp;only&nbsp;preserves&nbsp;edits&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5069876">//&nbsp;inferences&nbsp;in&nbsp;e&nbsp;if&nbsp;the&nbsp;inferences&nbsp;and&nbsp;output&nbsp;context&nbsp;satisfy&nbsp;filter.</span><br>
<span class="lineno"></span><span class="comment" id="5069948">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;an&nbsp;output&nbsp;context,&nbsp;and&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;filter</span><br>
<span class="lineno"></span><span class="comment" id="5070028">//&nbsp;which&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;whether&nbsp;e&nbsp;was&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="5070075">func</span>&nbsp;<span class="op" id="5070080">(</span><span class="ident" id="5070081">e</span>&nbsp;<span class="op" id="5070083">*</span><span class="ident" id="5070084">escaper</span><span class="op" id="5070091">)</span>&nbsp;<span class="ident" id="5070093">escapeListConditionally</span><span class="op" id="5070116">(</span><span class="ident" id="5070117">c</span>&nbsp;<span class="ident" id="5070119">context</span><span class="op" id="5070126">,</span>&nbsp;<span class="ident" id="5070128">n</span>&nbsp;<span class="op" id="5070130">*</span><span class="ident" id="5070131">parse</span><span class="op" id="5070136">.</span><span class="ident" id="5070137">ListNode</span><span class="op" id="5070145">,</span>&nbsp;<span class="ident" id="5070147">filter</span>&nbsp;<span class="keyword" id="5070154">func</span><span class="op" id="5070158">(</span><span class="op" id="5070159">*</span><span class="ident" id="5070160">escaper</span><span class="op" id="5070167">,</span>&nbsp;<span class="ident" id="5070169">context</span><span class="op" id="5070176">)</span>&nbsp;<span class="builtintype" id="5070178">bool</span><span class="op" id="5070182">)</span>&nbsp;<span class="op" id="5070184">(</span><span class="ident" id="5070185">context</span><span class="op" id="5070192">,</span>&nbsp;<span class="builtintype" id="5070194">bool</span><span class="op" id="5070198">)</span>&nbsp;<span class="op" id="5070200">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5070203">e1</span>&nbsp;<span class="op" id="5070206">:=</span>&nbsp;<span class="ident" id="5070209">newEscaper</span><span class="op" id="5070219">(</span><span class="ident" id="5070220">e</span><span class="op" id="5070221">.</span><span class="ident" id="5070222">tmpl</span><span class="op" id="5070226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5070229">//&nbsp;Make&nbsp;type&nbsp;inferences&nbsp;available&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5070270">for</span>&nbsp;<span class="ident" id="5070274">k</span><span class="op" id="5070275">,</span>&nbsp;<span class="ident" id="5070277">v</span>&nbsp;<span class="op" id="5070279">:=</span>&nbsp;<span class="keyword" id="5070282">range</span>&nbsp;<span class="ident" id="5070288">e</span><span class="op" id="5070289">.</span><span class="ident" id="5070290">output</span>&nbsp;<span class="op" id="5070297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5070301">e1</span><span class="op" id="5070303">.</span><span class="ident" id="5070304">output</span><span class="op" id="5070310">[</span><span class="ident" id="5070311">k</span><span class="op" id="5070312">]</span>&nbsp;<span class="op" id="5070314">=</span>&nbsp;<span class="ident" id="5070316">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5070319">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5070322">c</span>&nbsp;<span class="op" id="5070324">=</span>&nbsp;<span class="ident" id="5070326">e1</span><span class="op" id="5070328">.</span><span class="ident" id="5070329">escapeList</span><span class="op" id="5070339">(</span><span class="ident" id="5070340">c</span><span class="op" id="5070341">,</span>&nbsp;<span class="ident" id="5070343">n</span><span class="op" id="5070344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5070347">ok</span>&nbsp;<span class="op" id="5070350">:=</span>&nbsp;<span class="ident" id="5070353">filter</span>&nbsp;<span class="op" id="5070360">!=</span>&nbsp;<span class="ident" id="5070363">nil</span>&nbsp;<span class="op" id="5070367">&amp;&amp;</span>&nbsp;<span class="ident" id="5070370">filter</span><span class="op" id="5070376">(</span><span class="ident" id="5070377">e1</span><span class="op" id="5070379">,</span>&nbsp;<span class="ident" id="5070381">c</span><span class="op" id="5070382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5070385">if</span>&nbsp;<span class="ident" id="5070388">ok</span>&nbsp;<span class="op" id="5070391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5070395">//&nbsp;Copy&nbsp;inferences&nbsp;and&nbsp;edits&nbsp;from&nbsp;e1&nbsp;back&nbsp;into&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5070447">for</span>&nbsp;<span class="ident" id="5070451">k</span><span class="op" id="5070452">,</span>&nbsp;<span class="ident" id="5070454">v</span>&nbsp;<span class="op" id="5070456">:=</span>&nbsp;<span class="keyword" id="5070459">range</span>&nbsp;<span class="ident" id="5070465">e1</span><span class="op" id="5070467">.</span><span class="ident" id="5070468">output</span>&nbsp;<span class="op" id="5070475">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5070480">e</span><span class="op" id="5070481">.</span><span class="ident" id="5070482">output</span><span class="op" id="5070488">[</span><span class="ident" id="5070489">k</span><span class="op" id="5070490">]</span>&nbsp;<span class="op" id="5070492">=</span>&nbsp;<span class="ident" id="5070494">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5070498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5070502">for</span>&nbsp;<span class="ident" id="5070506">k</span><span class="op" id="5070507">,</span>&nbsp;<span class="ident" id="5070509">v</span>&nbsp;<span class="op" id="5070511">:=</span>&nbsp;<span class="keyword" id="5070514">range</span>&nbsp;<span class="ident" id="5070520">e1</span><span class="op" id="5070522">.</span><span class="ident" id="5070523">derived</span>&nbsp;<span class="op" id="5070531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5070536">e</span><span class="op" id="5070537">.</span><span class="ident" id="5070538">derived</span><span class="op" id="5070545">[</span><span class="ident" id="5070546">k</span><span class="op" id="5070547">]</span>&nbsp;<span class="op" id="5070549">=</span>&nbsp;<span class="ident" id="5070551">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5070555">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5070559">for</span>&nbsp;<span class="ident" id="5070563">k</span><span class="op" id="5070564">,</span>&nbsp;<span class="ident" id="5070566">v</span>&nbsp;<span class="op" id="5070568">:=</span>&nbsp;<span class="keyword" id="5070571">range</span>&nbsp;<span class="ident" id="5070577">e1</span><span class="op" id="5070579">.</span><span class="ident" id="5070580">called</span>&nbsp;<span class="op" id="5070587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5070592">e</span><span class="op" id="5070593">.</span><span class="ident" id="5070594">called</span><span class="op" id="5070600">[</span><span class="ident" id="5070601">k</span><span class="op" id="5070602">]</span>&nbsp;<span class="op" id="5070604">=</span>&nbsp;<span class="ident" id="5070606">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5070610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5070614">for</span>&nbsp;<span class="ident" id="5070618">k</span><span class="op" id="5070619">,</span>&nbsp;<span class="ident" id="5070621">v</span>&nbsp;<span class="op" id="5070623">:=</span>&nbsp;<span class="keyword" id="5070626">range</span>&nbsp;<span class="ident" id="5070632">e1</span><span class="op" id="5070634">.</span><span class="ident" id="5070635">actionNodeEdits</span>&nbsp;<span class="op" id="5070651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5070656">e</span><span class="op" id="5070657">.</span><span class="ident" id="5070658">editActionNode</span><span class="op" id="5070672">(</span><span class="ident" id="5070673">k</span><span class="op" id="5070674">,</span>&nbsp;<span class="ident" id="5070676">v</span><span class="op" id="5070677">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5070681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5070685">for</span>&nbsp;<span class="ident" id="5070689">k</span><span class="op" id="5070690">,</span>&nbsp;<span class="ident" id="5070692">v</span>&nbsp;<span class="op" id="5070694">:=</span>&nbsp;<span class="keyword" id="5070697">range</span>&nbsp;<span class="ident" id="5070703">e1</span><span class="op" id="5070705">.</span><span class="ident" id="5070706">templateNodeEdits</span>&nbsp;<span class="op" id="5070724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5070729">e</span><span class="op" id="5070730">.</span><span class="ident" id="5070731">editTemplateNode</span><span class="op" id="5070747">(</span><span class="ident" id="5070748">k</span><span class="op" id="5070749">,</span>&nbsp;<span class="ident" id="5070751">v</span><span class="op" id="5070752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5070756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5070760">for</span>&nbsp;<span class="ident" id="5070764">k</span><span class="op" id="5070765">,</span>&nbsp;<span class="ident" id="5070767">v</span>&nbsp;<span class="op" id="5070769">:=</span>&nbsp;<span class="keyword" id="5070772">range</span>&nbsp;<span class="ident" id="5070778">e1</span><span class="op" id="5070780">.</span><span class="ident" id="5070781">textNodeEdits</span>&nbsp;<span class="op" id="5070795">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5070800">e</span><span class="op" id="5070801">.</span><span class="ident" id="5070802">editTextNode</span><span class="op" id="5070814">(</span><span class="ident" id="5070815">k</span><span class="op" id="5070816">,</span>&nbsp;<span class="ident" id="5070818">v</span><span class="op" id="5070819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5070823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5070826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5070829">return</span>&nbsp;<span class="ident" id="5070836">c</span><span class="op" id="5070837">,</span>&nbsp;<span class="ident" id="5070839">ok</span><br>
<span class="lineno"></span><span class="op" id="5070842">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="5070845">//&nbsp;escapeTemplate&nbsp;escapes&nbsp;a&nbsp;{{template}}&nbsp;call&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5070897">func</span>&nbsp;<span class="op" id="5070902">(</span><span class="ident" id="5070903">e</span>&nbsp;<span class="op" id="5070905">*</span><span class="ident" id="5070906">escaper</span><span class="op" id="5070913">)</span>&nbsp;<span class="ident" id="5070915">escapeTemplate</span><span class="op" id="5070929">(</span><span class="ident" id="5070930">c</span>&nbsp;<span class="ident" id="5070932">context</span><span class="op" id="5070939">,</span>&nbsp;<span class="ident" id="5070941">n</span>&nbsp;<span class="op" id="5070943">*</span><span class="ident" id="5070944">parse</span><span class="op" id="5070949">.</span><span class="ident" id="5070950">TemplateNode</span><span class="op" id="5070962">)</span>&nbsp;<span class="ident" id="5070964">context</span>&nbsp;<span class="op" id="5070972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5070975">c</span><span class="op" id="5070976">,</span>&nbsp;<span class="ident" id="5070978">name</span>&nbsp;<span class="op" id="5070983">:=</span>&nbsp;<span class="ident" id="5070986">e</span><span class="op" id="5070987">.</span><span class="ident" id="5070988">escapeTree</span><span class="op" id="5070998">(</span><span class="ident" id="5070999">c</span><span class="op" id="5071000">,</span>&nbsp;<span class="ident" id="5071002">n</span><span class="op" id="5071003">,</span>&nbsp;<span class="ident" id="5071005">n</span><span class="op" id="5071006">.</span><span class="ident" id="5071007">Name</span><span class="op" id="5071011">,</span>&nbsp;<span class="ident" id="5071013">n</span><span class="op" id="5071014">.</span><span class="ident" id="5071015">Line</span><span class="op" id="5071019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5071022">if</span>&nbsp;<span class="ident" id="5071025">name</span>&nbsp;<span class="op" id="5071030">!=</span>&nbsp;<span class="ident" id="5071033">n</span><span class="op" id="5071034">.</span><span class="ident" id="5071035">Name</span>&nbsp;<span class="op" id="5071040">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5071044">e</span><span class="op" id="5071045">.</span><span class="ident" id="5071046">editTemplateNode</span><span class="op" id="5071062">(</span><span class="ident" id="5071063">n</span><span class="op" id="5071064">,</span>&nbsp;<span class="ident" id="5071066">name</span><span class="op" id="5071070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5071073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5071076">return</span>&nbsp;<span class="ident" id="5071083">c</span><br>
<span class="lineno"></span><span class="op" id="5071085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="comment" id="5071088">//&nbsp;escapeTree&nbsp;escapes&nbsp;the&nbsp;named&nbsp;template&nbsp;starting&nbsp;in&nbsp;the&nbsp;given&nbsp;context&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="5071162">//&nbsp;necessary&nbsp;and&nbsp;returns&nbsp;its&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span><span class="keyword" id="5071207">func</span>&nbsp;<span class="op" id="5071212">(</span><span class="ident" id="5071213">e</span>&nbsp;<span class="op" id="5071215">*</span><span class="ident" id="5071216">escaper</span><span class="op" id="5071223">)</span>&nbsp;<span class="ident" id="5071225">escapeTree</span><span class="op" id="5071235">(</span><span class="ident" id="5071236">c</span>&nbsp;<span class="ident" id="5071238">context</span><span class="op" id="5071245">,</span>&nbsp;<span class="ident" id="5071247">node</span>&nbsp;<span class="ident" id="5071252">parse</span><span class="op" id="5071257">.</span><span class="ident" id="5071258">Node</span><span class="op" id="5071262">,</span>&nbsp;<span class="ident" id="5071264">name</span>&nbsp;<span class="builtintype" id="5071269">string</span><span class="op" id="5071275">,</span>&nbsp;<span class="ident" id="5071277">line</span>&nbsp;<span class="builtintype" id="5071282">int</span><span class="op" id="5071285">)</span>&nbsp;<span class="op" id="5071287">(</span><span class="ident" id="5071288">context</span><span class="op" id="5071295">,</span>&nbsp;<span class="builtintype" id="5071297">string</span><span class="op" id="5071303">)</span>&nbsp;<span class="op" id="5071305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5071308">//&nbsp;Mangle&nbsp;the&nbsp;template&nbsp;name&nbsp;with&nbsp;the&nbsp;input&nbsp;context&nbsp;to&nbsp;produce&nbsp;a&nbsp;reliable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5071382">//&nbsp;identifier.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5071398">dname</span>&nbsp;<span class="op" id="5071404">:=</span>&nbsp;<span class="ident" id="5071407">c</span><span class="op" id="5071408">.</span><span class="ident" id="5071409">mangle</span><span class="op" id="5071415">(</span><span class="ident" id="5071416">name</span><span class="op" id="5071420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5071423">e</span><span class="op" id="5071424">.</span><span class="ident" id="5071425">called</span><span class="op" id="5071431">[</span><span class="ident" id="5071432">dname</span><span class="op" id="5071437">]</span>&nbsp;<span class="op" id="5071439">=</span>&nbsp;<span class="builtintype" id="5071441">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5071447">if</span>&nbsp;<span class="ident" id="5071450">out</span><span class="op" id="5071453">,</span>&nbsp;<span class="ident" id="5071455">ok</span>&nbsp;<span class="op" id="5071458">:=</span>&nbsp;<span class="ident" id="5071461">e</span><span class="op" id="5071462">.</span><span class="ident" id="5071463">output</span><span class="op" id="5071469">[</span><span class="ident" id="5071470">dname</span><span class="op" id="5071475">]</span><span class="op" id="5071476">;</span>&nbsp;<span class="ident" id="5071478">ok</span>&nbsp;<span class="op" id="5071481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5071485">//&nbsp;Already&nbsp;escaped.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5071507">return</span>&nbsp;<span class="ident" id="5071514">out</span><span class="op" id="5071517">,</span>&nbsp;<span class="ident" id="5071519">dname</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5071526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5071529">t</span>&nbsp;<span class="op" id="5071531">:=</span>&nbsp;<span class="ident" id="5071534">e</span><span class="op" id="5071535">.</span><span class="ident" id="5071536">template</span><span class="op" id="5071544">(</span><span class="ident" id="5071545">name</span><span class="op" id="5071549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5071552">if</span>&nbsp;<span class="ident" id="5071555">t</span>&nbsp;<span class="op" id="5071557">==</span>&nbsp;<span class="ident" id="5071560">nil</span>&nbsp;<span class="op" id="5071564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5071568">//&nbsp;Two&nbsp;cases:&nbsp;The&nbsp;template&nbsp;exists&nbsp;but&nbsp;is&nbsp;empty,&nbsp;or&nbsp;has&nbsp;never&nbsp;been&nbsp;mentioned&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5071649">//&nbsp;all.&nbsp;Distinguish&nbsp;the&nbsp;cases&nbsp;in&nbsp;the&nbsp;error&nbsp;messages.</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5071704">if</span>&nbsp;<span class="ident" id="5071707">e</span><span class="op" id="5071708">.</span><span class="ident" id="5071709">tmpl</span><span class="op" id="5071713">.</span><span class="ident" id="5071714">set</span><span class="op" id="5071717">[</span><span class="ident" id="5071718">name</span><span class="op" id="5071722">]</span>&nbsp;<span class="op" id="5071724">!=</span>&nbsp;<span class="ident" id="5071727">nil</span>&nbsp;<span class="op" id="5071731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5071736">return</span>&nbsp;<span class="ident" id="5071743">context</span><span class="op" id="5071750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5071756">state</span><span class="op" id="5071761">:</span>&nbsp;<span class="ident" id="5071763">stateError</span><span class="op" id="5071773">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5071779">err</span><span class="op" id="5071782">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5071786">errorf</span><span class="op" id="5071792">(</span><span class="ident" id="5071793">ErrNoSuchTemplate</span><span class="op" id="5071810">,</span>&nbsp;<span class="ident" id="5071812">node</span><span class="op" id="5071816">,</span>&nbsp;<span class="ident" id="5071818">line</span><span class="op" id="5071822">,</span>&nbsp;<span class="string" id="5071824">&#34;%q&nbsp;is&nbsp;an&nbsp;incomplete&nbsp;or&nbsp;empty&nbsp;template&#34;</span><span class="op" id="5071863">,</span>&nbsp;<span class="ident" id="5071865">name</span><span class="op" id="5071869">)</span><span class="op" id="5071870">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5071875">}</span><span class="op" id="5071876">,</span>&nbsp;<span class="ident" id="5071878">dname</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5071886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5071890">return</span>&nbsp;<span class="ident" id="5071897">context</span><span class="op" id="5071904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5071909">state</span><span class="op" id="5071914">:</span>&nbsp;<span class="ident" id="5071916">stateError</span><span class="op" id="5071926">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5071931">err</span><span class="op" id="5071934">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5071938">errorf</span><span class="op" id="5071944">(</span><span class="ident" id="5071945">ErrNoSuchTemplate</span><span class="op" id="5071962">,</span>&nbsp;<span class="ident" id="5071964">node</span><span class="op" id="5071968">,</span>&nbsp;<span class="ident" id="5071970">line</span><span class="op" id="5071974">,</span>&nbsp;<span class="string" id="5071976">&#34;no&nbsp;such&nbsp;template&nbsp;%q&#34;</span><span class="op" id="5071997">,</span>&nbsp;<span class="ident" id="5071999">name</span><span class="op" id="5072003">)</span><span class="op" id="5072004">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5072008">}</span><span class="op" id="5072009">,</span>&nbsp;<span class="ident" id="5072011">dname</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5072018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5072021">if</span>&nbsp;<span class="ident" id="5072024">dname</span>&nbsp;<span class="op" id="5072030">!=</span>&nbsp;<span class="ident" id="5072033">name</span>&nbsp;<span class="op" id="5072038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5072042">//&nbsp;Use&nbsp;any&nbsp;template&nbsp;derived&nbsp;during&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;escapeTemplate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5072113">//&nbsp;with&nbsp;different&nbsp;top&nbsp;level&nbsp;templates,&nbsp;or&nbsp;clone&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5072177">dt</span>&nbsp;<span class="op" id="5072180">:=</span>&nbsp;<span class="ident" id="5072183">e</span><span class="op" id="5072184">.</span><span class="ident" id="5072185">template</span><span class="op" id="5072193">(</span><span class="ident" id="5072194">dname</span><span class="op" id="5072199">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5072203">if</span>&nbsp;<span class="ident" id="5072206">dt</span>&nbsp;<span class="op" id="5072209">==</span>&nbsp;<span class="ident" id="5072212">nil</span>&nbsp;<span class="op" id="5072216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5072221">dt</span>&nbsp;<span class="op" id="5072224">=</span>&nbsp;<span class="ident" id="5072226">template</span><span class="op" id="5072234">.</span><span class="ident" id="5072235">New</span><span class="op" id="5072238">(</span><span class="ident" id="5072239">dname</span><span class="op" id="5072244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5072249">dt</span><span class="op" id="5072251">.</span><span class="ident" id="5072252">Tree</span>&nbsp;<span class="op" id="5072257">=</span>&nbsp;<span class="op" id="5072259">&amp;</span><span class="ident" id="5072260">parse</span><span class="op" id="5072265">.</span><span class="ident" id="5072266">Tree</span><span class="op" id="5072270">{</span><span class="ident" id="5072271">Name</span><span class="op" id="5072275">:</span>&nbsp;<span class="ident" id="5072277">dname</span><span class="op" id="5072282">,</span>&nbsp;<span class="ident" id="5072284">Root</span><span class="op" id="5072288">:</span>&nbsp;<span class="ident" id="5072290">t</span><span class="op" id="5072291">.</span><span class="ident" id="5072292">Root</span><span class="op" id="5072296">.</span><span class="ident" id="5072297">CopyList</span><span class="op" id="5072305">(</span><span class="op" id="5072306">)</span><span class="op" id="5072307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5072312">e</span><span class="op" id="5072313">.</span><span class="ident" id="5072314">derived</span><span class="op" id="5072321">[</span><span class="ident" id="5072322">dname</span><span class="op" id="5072327">]</span>&nbsp;<span class="op" id="5072329">=</span>&nbsp;<span class="ident" id="5072331">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5072336">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5072340">t</span>&nbsp;<span class="op" id="5072342">=</span>&nbsp;<span class="ident" id="5072344">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5072348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5072351">return</span>&nbsp;<span class="ident" id="5072358">e</span><span class="op" id="5072359">.</span><span class="ident" id="5072360">computeOutCtx</span><span class="op" id="5072373">(</span><span class="ident" id="5072374">c</span><span class="op" id="5072375">,</span>&nbsp;<span class="ident" id="5072377">t</span><span class="op" id="5072378">)</span><span class="op" id="5072379">,</span>&nbsp;<span class="ident" id="5072381">dname</span><br>
<span class="lineno"></span><span class="op" id="5072387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="comment" id="5072390">//&nbsp;computeOutCtx&nbsp;takes&nbsp;a&nbsp;template&nbsp;and&nbsp;its&nbsp;start&nbsp;context&nbsp;and&nbsp;computes&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="5072470">//&nbsp;context&nbsp;while&nbsp;storing&nbsp;any&nbsp;inferences&nbsp;in&nbsp;e.</span><br>
<span class="lineno"></span><span class="keyword" id="5072516">func</span>&nbsp;<span class="op" id="5072521">(</span><span class="ident" id="5072522">e</span>&nbsp;<span class="op" id="5072524">*</span><span class="ident" id="5072525">escaper</span><span class="op" id="5072532">)</span>&nbsp;<span class="ident" id="5072534">computeOutCtx</span><span class="op" id="5072547">(</span><span class="ident" id="5072548">c</span>&nbsp;<span class="ident" id="5072550">context</span><span class="op" id="5072557">,</span>&nbsp;<span class="ident" id="5072559">t</span>&nbsp;<span class="op" id="5072561">*</span><span class="ident" id="5072562">template</span><span class="op" id="5072570">.</span><span class="ident" id="5072571">Template</span><span class="op" id="5072579">)</span>&nbsp;<span class="ident" id="5072581">context</span>&nbsp;<span class="op" id="5072589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5072592">//&nbsp;Propagate&nbsp;context&nbsp;over&nbsp;the&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5072629">c1</span><span class="op" id="5072631">,</span>&nbsp;<span class="ident" id="5072633">ok</span>&nbsp;<span class="op" id="5072636">:=</span>&nbsp;<span class="ident" id="5072639">e</span><span class="op" id="5072640">.</span><span class="ident" id="5072641">escapeTemplateBody</span><span class="op" id="5072659">(</span><span class="ident" id="5072660">c</span><span class="op" id="5072661">,</span>&nbsp;<span class="ident" id="5072663">t</span><span class="op" id="5072664">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5072667">if</span>&nbsp;<span class="op" id="5072670">!</span><span class="ident" id="5072671">ok</span>&nbsp;<span class="op" id="5072674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5072678">//&nbsp;Look&nbsp;for&nbsp;a&nbsp;fixed&nbsp;point&nbsp;by&nbsp;assuming&nbsp;c1&nbsp;as&nbsp;the&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5072744">if</span>&nbsp;<span class="ident" id="5072747">c2</span><span class="op" id="5072749">,</span>&nbsp;<span class="ident" id="5072751">ok2</span>&nbsp;<span class="op" id="5072755">:=</span>&nbsp;<span class="ident" id="5072758">e</span><span class="op" id="5072759">.</span><span class="ident" id="5072760">escapeTemplateBody</span><span class="op" id="5072778">(</span><span class="ident" id="5072779">c1</span><span class="op" id="5072781">,</span>&nbsp;<span class="ident" id="5072783">t</span><span class="op" id="5072784">)</span><span class="op" id="5072785">;</span>&nbsp;<span class="ident" id="5072787">ok2</span>&nbsp;<span class="op" id="5072791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5072796">c1</span><span class="op" id="5072798">,</span>&nbsp;<span class="ident" id="5072800">ok</span>&nbsp;<span class="op" id="5072803">=</span>&nbsp;<span class="ident" id="5072805">c2</span><span class="op" id="5072807">,</span>&nbsp;<span class="builtintype" id="5072809">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5072816">}</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5072820">//&nbsp;Use&nbsp;c1&nbsp;as&nbsp;the&nbsp;error&nbsp;context&nbsp;if&nbsp;neither&nbsp;assumption&nbsp;worked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5072882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5072885">if</span>&nbsp;<span class="op" id="5072888">!</span><span class="ident" id="5072889">ok</span>&nbsp;<span class="op" id="5072892">&amp;&amp;</span>&nbsp;<span class="ident" id="5072895">c1</span><span class="op" id="5072897">.</span><span class="ident" id="5072898">state</span>&nbsp;<span class="op" id="5072904">!=</span>&nbsp;<span class="ident" id="5072907">stateError</span>&nbsp;<span class="op" id="5072918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5072922">return</span>&nbsp;<span class="ident" id="5072929">context</span><span class="op" id="5072936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5072941">state</span><span class="op" id="5072946">:</span>&nbsp;<span class="ident" id="5072948">stateError</span><span class="op" id="5072958">,</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5072963">err</span><span class="op" id="5072966">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5072970">errorf</span><span class="op" id="5072976">(</span><span class="ident" id="5072977">ErrOutputContext</span><span class="op" id="5072993">,</span>&nbsp;<span class="ident" id="5072995">t</span><span class="op" id="5072996">.</span><span class="ident" id="5072997">Tree</span><span class="op" id="5073001">.</span><span class="ident" id="5073002">Root</span><span class="op" id="5073006">,</span>&nbsp;<span class="num" id="5073008">0</span><span class="op" id="5073009">,</span>&nbsp;<span class="string" id="5073011">&#34;cannot&nbsp;compute&nbsp;output&nbsp;context&nbsp;for&nbsp;template&nbsp;%s&#34;</span><span class="op" id="5073058">,</span>&nbsp;<span class="ident" id="5073060">t</span><span class="op" id="5073061">.</span><span class="ident" id="5073062">Name</span><span class="op" id="5073066">(</span><span class="op" id="5073067">)</span><span class="op" id="5073068">)</span><span class="op" id="5073069">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5073073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5073076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5073079">return</span>&nbsp;<span class="ident" id="5073086">c1</span><br>
<span class="lineno"></span><span class="op" id="5073089">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="5073092">//&nbsp;escapeTemplateBody&nbsp;escapes&nbsp;the&nbsp;given&nbsp;template&nbsp;assuming&nbsp;the&nbsp;given&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="5073167">//&nbsp;context,&nbsp;and&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;the&nbsp;output&nbsp;context&nbsp;and&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5073244">//&nbsp;assumption&nbsp;was&nbsp;correct.</span><br>
<span class="lineno"></span><span class="keyword" id="5073271">func</span>&nbsp;<span class="op" id="5073276">(</span><span class="ident" id="5073277">e</span>&nbsp;<span class="op" id="5073279">*</span><span class="ident" id="5073280">escaper</span><span class="op" id="5073287">)</span>&nbsp;<span class="ident" id="5073289">escapeTemplateBody</span><span class="op" id="5073307">(</span><span class="ident" id="5073308">c</span>&nbsp;<span class="ident" id="5073310">context</span><span class="op" id="5073317">,</span>&nbsp;<span class="ident" id="5073319">t</span>&nbsp;<span class="op" id="5073321">*</span><span class="ident" id="5073322">template</span><span class="op" id="5073330">.</span><span class="ident" id="5073331">Template</span><span class="op" id="5073339">)</span>&nbsp;<span class="op" id="5073341">(</span><span class="ident" id="5073342">context</span><span class="op" id="5073349">,</span>&nbsp;<span class="builtintype" id="5073351">bool</span><span class="op" id="5073355">)</span>&nbsp;<span class="op" id="5073357">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5073360">filter</span>&nbsp;<span class="op" id="5073367">:=</span>&nbsp;<span class="keyword" id="5073370">func</span><span class="op" id="5073374">(</span><span class="ident" id="5073375">e1</span>&nbsp;<span class="op" id="5073378">*</span><span class="ident" id="5073379">escaper</span><span class="op" id="5073386">,</span>&nbsp;<span class="ident" id="5073388">c1</span>&nbsp;<span class="ident" id="5073391">context</span><span class="op" id="5073398">)</span>&nbsp;<span class="builtintype" id="5073400">bool</span>&nbsp;<span class="op" id="5073405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5073409">if</span>&nbsp;<span class="ident" id="5073412">c1</span><span class="op" id="5073414">.</span><span class="ident" id="5073415">state</span>&nbsp;<span class="op" id="5073421">==</span>&nbsp;<span class="ident" id="5073424">stateError</span>&nbsp;<span class="op" id="5073435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5073440">//&nbsp;Do&nbsp;not&nbsp;update&nbsp;the&nbsp;input&nbsp;escaper,&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5073482">return</span>&nbsp;<span class="builtintype" id="5073489">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5073497">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5073501">if</span>&nbsp;<span class="op" id="5073504">!</span><span class="ident" id="5073505">e1</span><span class="op" id="5073507">.</span><span class="ident" id="5073508">called</span><span class="op" id="5073514">[</span><span class="ident" id="5073515">t</span><span class="op" id="5073516">.</span><span class="ident" id="5073517">Name</span><span class="op" id="5073521">(</span><span class="op" id="5073522">)</span><span class="op" id="5073523">]</span>&nbsp;<span class="op" id="5073525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5073530">//&nbsp;If&nbsp;t&nbsp;is&nbsp;not&nbsp;recursively&nbsp;called,&nbsp;then&nbsp;c1&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5073582">//&nbsp;accurate&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5073613">return</span>&nbsp;<span class="builtintype" id="5073620">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5073627">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5073631">//&nbsp;c1&nbsp;is&nbsp;accurate&nbsp;if&nbsp;it&nbsp;matches&nbsp;our&nbsp;assumed&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5073693">return</span>&nbsp;<span class="ident" id="5073700">c</span><span class="op" id="5073701">.</span><span class="ident" id="5073702">eq</span><span class="op" id="5073704">(</span><span class="ident" id="5073705">c1</span><span class="op" id="5073707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5073710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5073713">//&nbsp;We&nbsp;need&nbsp;to&nbsp;assume&nbsp;an&nbsp;output&nbsp;context&nbsp;so&nbsp;that&nbsp;recursive&nbsp;template&nbsp;calls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5073786">//&nbsp;take&nbsp;the&nbsp;fast&nbsp;path&nbsp;out&nbsp;of&nbsp;escapeTree&nbsp;instead&nbsp;of&nbsp;infinitely&nbsp;recursing.</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5073860">//&nbsp;Naively&nbsp;assuming&nbsp;that&nbsp;the&nbsp;input&nbsp;context&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5073930">//&nbsp;works&nbsp;&gt;90%&nbsp;of&nbsp;the&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5073958">e</span><span class="op" id="5073959">.</span><span class="ident" id="5073960">output</span><span class="op" id="5073966">[</span><span class="ident" id="5073967">t</span><span class="op" id="5073968">.</span><span class="ident" id="5073969">Name</span><span class="op" id="5073973">(</span><span class="op" id="5073974">)</span><span class="op" id="5073975">]</span>&nbsp;<span class="op" id="5073977">=</span>&nbsp;<span class="ident" id="5073979">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5073982">return</span>&nbsp;<span class="ident" id="5073989">e</span><span class="op" id="5073990">.</span><span class="ident" id="5073991">escapeListConditionally</span><span class="op" id="5074014">(</span><span class="ident" id="5074015">c</span><span class="op" id="5074016">,</span>&nbsp;<span class="ident" id="5074018">t</span><span class="op" id="5074019">.</span><span class="ident" id="5074020">Tree</span><span class="op" id="5074024">.</span><span class="ident" id="5074025">Root</span><span class="op" id="5074029">,</span>&nbsp;<span class="ident" id="5074031">filter</span><span class="op" id="5074037">)</span><br>
<span class="lineno"></span><span class="op" id="5074039">}</span><br>
<span class="lineno">575</span><br>
<span class="lineno"></span><span class="comment" id="5074042">//&nbsp;delimEnds&nbsp;maps&nbsp;each&nbsp;delim&nbsp;to&nbsp;a&nbsp;string&nbsp;of&nbsp;characters&nbsp;that&nbsp;terminate&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="5074116">var</span>&nbsp;<span class="ident" id="5074120">delimEnds</span>&nbsp;<span class="op" id="5074130">=</span>&nbsp;<span class="op" id="5074132">[</span><span class="op" id="5074133">...</span><span class="op" id="5074136">]</span><span class="builtintype" id="5074137">string</span><span class="op" id="5074143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5074146">delimDoubleQuote</span><span class="op" id="5074162">:</span>&nbsp;<span class="string" id="5074164">`&#34;`</span><span class="op" id="5074167">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5074170">delimSingleQuote</span><span class="op" id="5074186">:</span>&nbsp;<span class="string" id="5074188">&#34;&#39;&#34;</span><span class="op" id="5074191">,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5074194">//&nbsp;Determined&nbsp;empirically&nbsp;by&nbsp;running&nbsp;the&nbsp;below&nbsp;in&nbsp;various&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5074263">//&nbsp;var&nbsp;div&nbsp;=&nbsp;document.createElement(&#34;DIV&#34;);</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5074308">//&nbsp;for&nbsp;(var&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;0x10000;&nbsp;++i)&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5074348">//&nbsp;&nbsp;&nbsp;div.innerHTML&nbsp;=&nbsp;&#34;&lt;span&nbsp;title=x&#34;&nbsp;+&nbsp;String.fromCharCode(i)&nbsp;+&nbsp;&#34;-bar&gt;&#34;;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5074422">//&nbsp;&nbsp;&nbsp;if&nbsp;(div.getElementsByTagName(&#34;SPAN&#34;)[0].title.indexOf(&#34;bar&#34;)&nbsp;&lt;&nbsp;0)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5074494">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;document.write(&#34;&lt;p&gt;U+&#34;&nbsp;+&nbsp;i.toString(16));</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5074544">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5074550">delimSpaceOrTagEnd</span><span class="op" id="5074568">:</span>&nbsp;<span class="string" id="5074570">&#34;&nbsp;\t\n\f\r&gt;&#34;</span><span class="op" id="5074582">,</span><br>
<span class="lineno"></span><span class="op" id="5074584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="keyword" id="5074587">var</span>&nbsp;<span class="ident" id="5074591">doctypeBytes</span>&nbsp;<span class="op" id="5074604">=</span>&nbsp;<span class="op" id="5074606">[</span><span class="op" id="5074607">]</span><span class="builtintype" id="5074608">byte</span><span class="op" id="5074612">(</span><span class="string" id="5074613">&#34;&lt;!DOCTYPE&#34;</span><span class="op" id="5074624">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5074627">//&nbsp;escapeText&nbsp;escapes&nbsp;a&nbsp;text&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5074671">func</span>&nbsp;<span class="op" id="5074676">(</span><span class="ident" id="5074677">e</span>&nbsp;<span class="op" id="5074679">*</span><span class="ident" id="5074680">escaper</span><span class="op" id="5074687">)</span>&nbsp;<span class="ident" id="5074689">escapeText</span><span class="op" id="5074699">(</span><span class="ident" id="5074700">c</span>&nbsp;<span class="ident" id="5074702">context</span><span class="op" id="5074709">,</span>&nbsp;<span class="ident" id="5074711">n</span>&nbsp;<span class="op" id="5074713">*</span><span class="ident" id="5074714">parse</span><span class="op" id="5074719">.</span><span class="ident" id="5074720">TextNode</span><span class="op" id="5074728">)</span>&nbsp;<span class="ident" id="5074730">context</span>&nbsp;<span class="op" id="5074738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5074741">s</span><span class="op" id="5074742">,</span>&nbsp;<span class="ident" id="5074744">written</span><span class="op" id="5074751">,</span>&nbsp;<span class="ident" id="5074753">i</span><span class="op" id="5074754">,</span>&nbsp;<span class="ident" id="5074756">b</span>&nbsp;<span class="op" id="5074758">:=</span>&nbsp;<span class="ident" id="5074761">n</span><span class="op" id="5074762">.</span><span class="ident" id="5074763">Text</span><span class="op" id="5074767">,</span>&nbsp;<span class="num" id="5074769">0</span><span class="op" id="5074770">,</span>&nbsp;<span class="num" id="5074772">0</span><span class="op" id="5074773">,</span>&nbsp;<span class="builtinfunc" id="5074775">new</span><span class="op" id="5074778">(</span><span class="ident" id="5074779">bytes</span><span class="op" id="5074784">.</span><span class="ident" id="5074785">Buffer</span><span class="op" id="5074791">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5074794">for</span>&nbsp;<span class="ident" id="5074798">i</span>&nbsp;<span class="op" id="5074800">!=</span>&nbsp;<span class="builtinfunc" id="5074803">len</span><span class="op" id="5074806">(</span><span class="ident" id="5074807">s</span><span class="op" id="5074808">)</span>&nbsp;<span class="op" id="5074810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5074814">c1</span><span class="op" id="5074816">,</span>&nbsp;<span class="ident" id="5074818">nread</span>&nbsp;<span class="op" id="5074824">:=</span>&nbsp;<span class="ident" id="5074827">contextAfterText</span><span class="op" id="5074843">(</span><span class="ident" id="5074844">c</span><span class="op" id="5074845">,</span>&nbsp;<span class="ident" id="5074847">s</span><span class="op" id="5074848">[</span><span class="ident" id="5074849">i</span><span class="op" id="5074850">:</span><span class="op" id="5074851">]</span><span class="op" id="5074852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5074856">i1</span>&nbsp;<span class="op" id="5074859">:=</span>&nbsp;<span class="ident" id="5074862">i</span>&nbsp;<span class="op" id="5074864">+</span>&nbsp;<span class="ident" id="5074866">nread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5074874">if</span>&nbsp;<span class="ident" id="5074877">c</span><span class="op" id="5074878">.</span><span class="ident" id="5074879">state</span>&nbsp;<span class="op" id="5074885">==</span>&nbsp;<span class="ident" id="5074888">stateText</span>&nbsp;<span class="op" id="5074898">||</span>&nbsp;<span class="ident" id="5074901">c</span><span class="op" id="5074902">.</span><span class="ident" id="5074903">state</span>&nbsp;<span class="op" id="5074909">==</span>&nbsp;<span class="ident" id="5074912">stateRCDATA</span>&nbsp;<span class="op" id="5074924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5074929">end</span>&nbsp;<span class="op" id="5074933">:=</span>&nbsp;<span class="ident" id="5074936">i1</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5074942">if</span>&nbsp;<span class="ident" id="5074945">c1</span><span class="op" id="5074947">.</span><span class="ident" id="5074948">state</span>&nbsp;<span class="op" id="5074954">!=</span>&nbsp;<span class="ident" id="5074957">c</span><span class="op" id="5074958">.</span><span class="ident" id="5074959">state</span>&nbsp;<span class="op" id="5074965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5074971">for</span>&nbsp;<span class="ident" id="5074975">j</span>&nbsp;<span class="op" id="5074977">:=</span>&nbsp;<span class="ident" id="5074980">end</span>&nbsp;<span class="op" id="5074984">-</span>&nbsp;<span class="num" id="5074986">1</span><span class="op" id="5074987">;</span>&nbsp;<span class="ident" id="5074989">j</span>&nbsp;<span class="op" id="5074991">&gt;=</span>&nbsp;<span class="ident" id="5074994">i</span><span class="op" id="5074995">;</span>&nbsp;<span class="ident" id="5074997">j</span><span class="op" id="5074998">--</span>&nbsp;<span class="op" id="5075001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5075008">if</span>&nbsp;<span class="ident" id="5075011">s</span><span class="op" id="5075012">[</span><span class="ident" id="5075013">j</span><span class="op" id="5075014">]</span>&nbsp;<span class="op" id="5075016">==</span>&nbsp;<span class="string" id="5075019">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5075023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5075031">end</span>&nbsp;<span class="op" id="5075035">=</span>&nbsp;<span class="ident" id="5075037">j</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5075045">break</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5075056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5075062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5075067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5075072">for</span>&nbsp;<span class="ident" id="5075076">j</span>&nbsp;<span class="op" id="5075078">:=</span>&nbsp;<span class="ident" id="5075081">i</span><span class="op" id="5075082">;</span>&nbsp;<span class="ident" id="5075084">j</span>&nbsp;<span class="op" id="5075086">&lt;</span>&nbsp;<span class="ident" id="5075088">end</span><span class="op" id="5075091">;</span>&nbsp;<span class="ident" id="5075093">j</span><span class="op" id="5075094">++</span>&nbsp;<span class="op" id="5075097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5075103">if</span>&nbsp;<span class="ident" id="5075106">s</span><span class="op" id="5075107">[</span><span class="ident" id="5075108">j</span><span class="op" id="5075109">]</span>&nbsp;<span class="op" id="5075111">==</span>&nbsp;<span class="string" id="5075114">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5075118">&amp;&amp;</span>&nbsp;<span class="op" id="5075121">!</span><span class="ident" id="5075122">bytes</span><span class="op" id="5075127">.</span><span class="ident" id="5075128">HasPrefix</span><span class="op" id="5075137">(</span><span class="ident" id="5075138">bytes</span><span class="op" id="5075143">.</span><span class="ident" id="5075144">ToUpper</span><span class="op" id="5075151">(</span><span class="ident" id="5075152">s</span><span class="op" id="5075153">[</span><span class="ident" id="5075154">j</span><span class="op" id="5075155">:</span><span class="op" id="5075156">]</span><span class="op" id="5075157">)</span><span class="op" id="5075158">,</span>&nbsp;<span class="ident" id="5075160">doctypeBytes</span><span class="op" id="5075172">)</span>&nbsp;<span class="op" id="5075174">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5075181">b</span><span class="op" id="5075182">.</span><span class="ident" id="5075183">Write</span><span class="op" id="5075188">(</span><span class="ident" id="5075189">s</span><span class="op" id="5075190">[</span><span class="ident" id="5075191">written</span><span class="op" id="5075198">:</span><span class="ident" id="5075199">j</span><span class="op" id="5075200">]</span><span class="op" id="5075201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5075208">b</span><span class="op" id="5075209">.</span><span class="ident" id="5075210">WriteString</span><span class="op" id="5075221">(</span><span class="string" id="5075222">&#34;&amp;lt;&#34;</span><span class="op" id="5075228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5075235">written</span>&nbsp;<span class="op" id="5075243">=</span>&nbsp;<span class="ident" id="5075245">j</span>&nbsp;<span class="op" id="5075247">+</span>&nbsp;<span class="num" id="5075249">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5075255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5075260">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5075264">}</span>&nbsp;<span class="keyword" id="5075266">else</span>&nbsp;<span class="keyword" id="5075271">if</span>&nbsp;<span class="ident" id="5075274">isComment</span><span class="op" id="5075283">(</span><span class="ident" id="5075284">c</span><span class="op" id="5075285">.</span><span class="ident" id="5075286">state</span><span class="op" id="5075291">)</span>&nbsp;<span class="op" id="5075293">&amp;&amp;</span>&nbsp;<span class="ident" id="5075296">c</span><span class="op" id="5075297">.</span><span class="ident" id="5075298">delim</span>&nbsp;<span class="op" id="5075304">==</span>&nbsp;<span class="ident" id="5075307">delimNone</span>&nbsp;<span class="op" id="5075317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5075322">switch</span>&nbsp;<span class="ident" id="5075329">c</span><span class="op" id="5075330">.</span><span class="ident" id="5075331">state</span>&nbsp;<span class="op" id="5075337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5075342">case</span>&nbsp;<span class="ident" id="5075347">stateJSBlockCmt</span><span class="op" id="5075362">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5075368">//&nbsp;http://es5.github.com/#x7.4:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5075404">//&nbsp;&#34;Comments&nbsp;behave&nbsp;like&nbsp;white&nbsp;space&nbsp;and&nbsp;are</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5075453">//&nbsp;discarded&nbsp;except&nbsp;that,&nbsp;if&nbsp;a&nbsp;MultiLineComment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5075505">//&nbsp;contains&nbsp;a&nbsp;line&nbsp;terminator&nbsp;character,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5075555">//&nbsp;the&nbsp;entire&nbsp;comment&nbsp;is&nbsp;considered&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5075603">//&nbsp;LineTerminator&nbsp;for&nbsp;purposes&nbsp;of&nbsp;parsing&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5075652">//&nbsp;the&nbsp;syntactic&nbsp;grammar.&#34;</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5075683">if</span>&nbsp;<span class="ident" id="5075686">bytes</span><span class="op" id="5075691">.</span><span class="ident" id="5075692">IndexAny</span><span class="op" id="5075700">(</span><span class="ident" id="5075701">s</span><span class="op" id="5075702">[</span><span class="ident" id="5075703">written</span><span class="op" id="5075710">:</span><span class="ident" id="5075711">i1</span><span class="op" id="5075713">]</span><span class="op" id="5075714">,</span>&nbsp;<span class="string" id="5075716">&#34;\n\r\u2028\u2029&#34;</span><span class="op" id="5075734">)</span>&nbsp;<span class="op" id="5075736">!=</span>&nbsp;<span class="op" id="5075739">-</span><span class="num" id="5075740">1</span>&nbsp;<span class="op" id="5075742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5075749">b</span><span class="op" id="5075750">.</span><span class="ident" id="5075751">WriteByte</span><span class="op" id="5075760">(</span><span class="string" id="5075761">&#39;\n&#39;</span><span class="op" id="5075765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5075771">}</span>&nbsp;<span class="keyword" id="5075773">else</span>&nbsp;<span class="op" id="5075778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5075785">b</span><span class="op" id="5075786">.</span><span class="ident" id="5075787">WriteByte</span><span class="op" id="5075796">(</span><span class="string" id="5075797">&#39;&nbsp;&#39;</span><span class="op" id="5075800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5075806">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5075811">case</span>&nbsp;<span class="ident" id="5075816">stateCSSBlockCmt</span><span class="op" id="5075832">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5075838">b</span><span class="op" id="5075839">.</span><span class="ident" id="5075840">WriteByte</span><span class="op" id="5075849">(</span><span class="string" id="5075850">&#39;&nbsp;&#39;</span><span class="op" id="5075853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5075858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5075863">written</span>&nbsp;<span class="op" id="5075871">=</span>&nbsp;<span class="ident" id="5075873">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5075878">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5075882">if</span>&nbsp;<span class="ident" id="5075885">c</span><span class="op" id="5075886">.</span><span class="ident" id="5075887">state</span>&nbsp;<span class="op" id="5075893">!=</span>&nbsp;<span class="ident" id="5075896">c1</span><span class="op" id="5075898">.</span><span class="ident" id="5075899">state</span>&nbsp;<span class="op" id="5075905">&amp;&amp;</span>&nbsp;<span class="ident" id="5075908">isComment</span><span class="op" id="5075917">(</span><span class="ident" id="5075918">c1</span><span class="op" id="5075920">.</span><span class="ident" id="5075921">state</span><span class="op" id="5075926">)</span>&nbsp;<span class="op" id="5075928">&amp;&amp;</span>&nbsp;<span class="ident" id="5075931">c1</span><span class="op" id="5075933">.</span><span class="ident" id="5075934">delim</span>&nbsp;<span class="op" id="5075940">==</span>&nbsp;<span class="ident" id="5075943">delimNone</span>&nbsp;<span class="op" id="5075953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5075958">//&nbsp;Preserve&nbsp;the&nbsp;portion&nbsp;between&nbsp;written&nbsp;and&nbsp;the&nbsp;comment&nbsp;start.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5076024">cs</span>&nbsp;<span class="op" id="5076027">:=</span>&nbsp;<span class="ident" id="5076030">i1</span>&nbsp;<span class="op" id="5076033">-</span>&nbsp;<span class="num" id="5076035">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5076040">if</span>&nbsp;<span class="ident" id="5076043">c1</span><span class="op" id="5076045">.</span><span class="ident" id="5076046">state</span>&nbsp;<span class="op" id="5076052">==</span>&nbsp;<span class="ident" id="5076055">stateHTMLCmt</span>&nbsp;<span class="op" id="5076068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5076074">//&nbsp;&#34;&lt;!--&#34;&nbsp;instead&nbsp;of&nbsp;&#34;/*&#34;&nbsp;or&nbsp;&#34;//&#34;</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5076112">cs</span>&nbsp;<span class="op" id="5076115">-=</span>&nbsp;<span class="num" id="5076118">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5076123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5076128">b</span><span class="op" id="5076129">.</span><span class="ident" id="5076130">Write</span><span class="op" id="5076135">(</span><span class="ident" id="5076136">s</span><span class="op" id="5076137">[</span><span class="ident" id="5076138">written</span><span class="op" id="5076145">:</span><span class="ident" id="5076146">cs</span><span class="op" id="5076148">]</span><span class="op" id="5076149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5076154">written</span>&nbsp;<span class="op" id="5076162">=</span>&nbsp;<span class="ident" id="5076164">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5076169">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5076173">if</span>&nbsp;<span class="ident" id="5076176">i</span>&nbsp;<span class="op" id="5076178">==</span>&nbsp;<span class="ident" id="5076181">i1</span>&nbsp;<span class="op" id="5076184">&amp;&amp;</span>&nbsp;<span class="ident" id="5076187">c</span><span class="op" id="5076188">.</span><span class="ident" id="5076189">state</span>&nbsp;<span class="op" id="5076195">==</span>&nbsp;<span class="ident" id="5076198">c1</span><span class="op" id="5076200">.</span><span class="ident" id="5076201">state</span>&nbsp;<span class="op" id="5076207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5076212">panic</span><span class="op" id="5076217">(</span><span class="ident" id="5076218">fmt</span><span class="op" id="5076221">.</span><span class="ident" id="5076222">Sprintf</span><span class="op" id="5076229">(</span><span class="string" id="5076230">&#34;infinite&nbsp;loop&nbsp;from&nbsp;%v&nbsp;to&nbsp;%v&nbsp;on&nbsp;%q..%q&#34;</span><span class="op" id="5076269">,</span>&nbsp;<span class="ident" id="5076271">c</span><span class="op" id="5076272">,</span>&nbsp;<span class="ident" id="5076274">c1</span><span class="op" id="5076276">,</span>&nbsp;<span class="ident" id="5076278">s</span><span class="op" id="5076279">[</span><span class="op" id="5076280">:</span><span class="ident" id="5076281">i</span><span class="op" id="5076282">]</span><span class="op" id="5076283">,</span>&nbsp;<span class="ident" id="5076285">s</span><span class="op" id="5076286">[</span><span class="ident" id="5076287">i</span><span class="op" id="5076288">:</span><span class="op" id="5076289">]</span><span class="op" id="5076290">)</span><span class="op" id="5076291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5076295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5076299">c</span><span class="op" id="5076300">,</span>&nbsp;<span class="ident" id="5076302">i</span>&nbsp;<span class="op" id="5076304">=</span>&nbsp;<span class="ident" id="5076306">c1</span><span class="op" id="5076308">,</span>&nbsp;<span class="ident" id="5076310">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5076314">}</span><br>
<span class="lineno">650</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5076318">if</span>&nbsp;<span class="ident" id="5076321">written</span>&nbsp;<span class="op" id="5076329">!=</span>&nbsp;<span class="num" id="5076332">0</span>&nbsp;<span class="op" id="5076334">&amp;&amp;</span>&nbsp;<span class="ident" id="5076337">c</span><span class="op" id="5076338">.</span><span class="ident" id="5076339">state</span>&nbsp;<span class="op" id="5076345">!=</span>&nbsp;<span class="ident" id="5076348">stateError</span>&nbsp;<span class="op" id="5076359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5076363">if</span>&nbsp;<span class="op" id="5076366">!</span><span class="ident" id="5076367">isComment</span><span class="op" id="5076376">(</span><span class="ident" id="5076377">c</span><span class="op" id="5076378">.</span><span class="ident" id="5076379">state</span><span class="op" id="5076384">)</span>&nbsp;<span class="op" id="5076386">||</span>&nbsp;<span class="ident" id="5076389">c</span><span class="op" id="5076390">.</span><span class="ident" id="5076391">delim</span>&nbsp;<span class="op" id="5076397">!=</span>&nbsp;<span class="ident" id="5076400">delimNone</span>&nbsp;<span class="op" id="5076410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5076415">b</span><span class="op" id="5076416">.</span><span class="ident" id="5076417">Write</span><span class="op" id="5076422">(</span><span class="ident" id="5076423">n</span><span class="op" id="5076424">.</span><span class="ident" id="5076425">Text</span><span class="op" id="5076429">[</span><span class="ident" id="5076430">written</span><span class="op" id="5076437">:</span><span class="op" id="5076438">]</span><span class="op" id="5076439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5076443">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5076447">e</span><span class="op" id="5076448">.</span><span class="ident" id="5076449">editTextNode</span><span class="op" id="5076461">(</span><span class="ident" id="5076462">n</span><span class="op" id="5076463">,</span>&nbsp;<span class="ident" id="5076465">b</span><span class="op" id="5076466">.</span><span class="ident" id="5076467">Bytes</span><span class="op" id="5076472">(</span><span class="op" id="5076473">)</span><span class="op" id="5076474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5076477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5076480">return</span>&nbsp;<span class="ident" id="5076487">c</span><br>
<span class="lineno"></span><span class="op" id="5076489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span><span class="comment" id="5076492">//&nbsp;contextAfterText&nbsp;starts&nbsp;in&nbsp;context&nbsp;c,&nbsp;consumes&nbsp;some&nbsp;tokens&nbsp;from&nbsp;the&nbsp;front&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5076572">//&nbsp;s,&nbsp;then&nbsp;returns&nbsp;the&nbsp;context&nbsp;after&nbsp;those&nbsp;tokens&nbsp;and&nbsp;the&nbsp;unprocessed&nbsp;suffix.</span><br>
<span class="lineno"></span><span class="keyword" id="5076650">func</span>&nbsp;<span class="ident" id="5076655">contextAfterText</span><span class="op" id="5076671">(</span><span class="ident" id="5076672">c</span>&nbsp;<span class="ident" id="5076674">context</span><span class="op" id="5076681">,</span>&nbsp;<span class="ident" id="5076683">s</span>&nbsp;<span class="op" id="5076685">[</span><span class="op" id="5076686">]</span><span class="builtintype" id="5076687">byte</span><span class="op" id="5076691">)</span>&nbsp;<span class="op" id="5076693">(</span><span class="ident" id="5076694">context</span><span class="op" id="5076701">,</span>&nbsp;<span class="builtintype" id="5076703">int</span><span class="op" id="5076706">)</span>&nbsp;<span class="op" id="5076708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5076711">if</span>&nbsp;<span class="ident" id="5076714">c</span><span class="op" id="5076715">.</span><span class="ident" id="5076716">delim</span>&nbsp;<span class="op" id="5076722">==</span>&nbsp;<span class="ident" id="5076725">delimNone</span>&nbsp;<span class="op" id="5076735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5076739">c1</span><span class="op" id="5076741">,</span>&nbsp;<span class="ident" id="5076743">i</span>&nbsp;<span class="op" id="5076745">:=</span>&nbsp;<span class="ident" id="5076748">tSpecialTagEnd</span><span class="op" id="5076762">(</span><span class="ident" id="5076763">c</span><span class="op" id="5076764">,</span>&nbsp;<span class="ident" id="5076766">s</span><span class="op" id="5076767">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5076771">if</span>&nbsp;<span class="ident" id="5076774">i</span>&nbsp;<span class="op" id="5076776">==</span>&nbsp;<span class="num" id="5076779">0</span>&nbsp;<span class="op" id="5076781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5076786">//&nbsp;A&nbsp;special&nbsp;end&nbsp;tag&nbsp;(`&lt;/script&gt;`)&nbsp;has&nbsp;been&nbsp;seen&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5076842">//&nbsp;all&nbsp;content&nbsp;preceding&nbsp;it&nbsp;has&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5076892">return</span>&nbsp;<span class="ident" id="5076899">c1</span><span class="op" id="5076901">,</span>&nbsp;<span class="num" id="5076903">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5076907">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5076911">//&nbsp;Consider&nbsp;all&nbsp;content&nbsp;up&nbsp;to&nbsp;any&nbsp;end&nbsp;tag.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5076956">return</span>&nbsp;<span class="ident" id="5076963">transitionFunc</span><span class="op" id="5076977">[</span><span class="ident" id="5076978">c</span><span class="op" id="5076979">.</span><span class="ident" id="5076980">state</span><span class="op" id="5076985">]</span><span class="op" id="5076986">(</span><span class="ident" id="5076987">c</span><span class="op" id="5076988">,</span>&nbsp;<span class="ident" id="5076990">s</span><span class="op" id="5076991">[</span><span class="op" id="5076992">:</span><span class="ident" id="5076993">i</span><span class="op" id="5076994">]</span><span class="op" id="5076995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5076998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5077002">i</span>&nbsp;<span class="op" id="5077004">:=</span>&nbsp;<span class="ident" id="5077007">bytes</span><span class="op" id="5077012">.</span><span class="ident" id="5077013">IndexAny</span><span class="op" id="5077021">(</span><span class="ident" id="5077022">s</span><span class="op" id="5077023">,</span>&nbsp;<span class="ident" id="5077025">delimEnds</span><span class="op" id="5077034">[</span><span class="ident" id="5077035">c</span><span class="op" id="5077036">.</span><span class="ident" id="5077037">delim</span><span class="op" id="5077042">]</span><span class="op" id="5077043">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5077046">if</span>&nbsp;<span class="ident" id="5077049">i</span>&nbsp;<span class="op" id="5077051">==</span>&nbsp;<span class="op" id="5077054">-</span><span class="num" id="5077055">1</span>&nbsp;<span class="op" id="5077057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5077061">i</span>&nbsp;<span class="op" id="5077063">=</span>&nbsp;<span class="builtinfunc" id="5077065">len</span><span class="op" id="5077068">(</span><span class="ident" id="5077069">s</span><span class="op" id="5077070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5077073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5077076">if</span>&nbsp;<span class="ident" id="5077079">c</span><span class="op" id="5077080">.</span><span class="ident" id="5077081">delim</span>&nbsp;<span class="op" id="5077087">==</span>&nbsp;<span class="ident" id="5077090">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="5077109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5077113">//&nbsp;http://www.w3.org/TR/html5/syntax.html#attribute-value-(unquoted)-state</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5077190">//&nbsp;lists&nbsp;the&nbsp;runes&nbsp;below&nbsp;as&nbsp;error&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5077238">//&nbsp;Error&nbsp;out&nbsp;because&nbsp;HTML&nbsp;parsers&nbsp;may&nbsp;differ&nbsp;on&nbsp;whether</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5077296">//&nbsp;&#34;&lt;a&nbsp;id=&nbsp;onclick=f(&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;id&#39;s&nbsp;or&nbsp;onclick&#39;s&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5077362">//&nbsp;&#34;&lt;a&nbsp;class=`foo&nbsp;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;a&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5077412">//&nbsp;&#34;&lt;a&nbsp;style=font:&#39;Arial&#39;&#34;&nbsp;needs&nbsp;open-quote&nbsp;fixup.</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5077465">//&nbsp;IE&nbsp;treats&nbsp;&#39;`&#39;&nbsp;as&nbsp;a&nbsp;quotation&nbsp;character.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5077510">if</span>&nbsp;<span class="ident" id="5077513">j</span>&nbsp;<span class="op" id="5077515">:=</span>&nbsp;<span class="ident" id="5077518">bytes</span><span class="op" id="5077523">.</span><span class="ident" id="5077524">IndexAny</span><span class="op" id="5077532">(</span><span class="ident" id="5077533">s</span><span class="op" id="5077534">[</span><span class="op" id="5077535">:</span><span class="ident" id="5077536">i</span><span class="op" id="5077537">]</span><span class="op" id="5077538">,</span>&nbsp;<span class="string" id="5077540">&#34;\&#34;&#39;&lt;=`&#34;</span><span class="op" id="5077548">)</span><span class="op" id="5077549">;</span>&nbsp;<span class="ident" id="5077551">j</span>&nbsp;<span class="op" id="5077553">&gt;=</span>&nbsp;<span class="num" id="5077556">0</span>&nbsp;<span class="op" id="5077558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5077563">return</span>&nbsp;<span class="ident" id="5077570">context</span><span class="op" id="5077577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5077583">state</span><span class="op" id="5077588">:</span>&nbsp;<span class="ident" id="5077590">stateError</span><span class="op" id="5077600">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5077606">err</span><span class="op" id="5077609">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5077613">errorf</span><span class="op" id="5077619">(</span><span class="ident" id="5077620">ErrBadHTML</span><span class="op" id="5077630">,</span>&nbsp;<span class="ident" id="5077632">nil</span><span class="op" id="5077635">,</span>&nbsp;<span class="num" id="5077637">0</span><span class="op" id="5077638">,</span>&nbsp;<span class="string" id="5077640">&#34;%q&nbsp;in&nbsp;unquoted&nbsp;attr:&nbsp;%q&#34;</span><span class="op" id="5077665">,</span>&nbsp;<span class="ident" id="5077667">s</span><span class="op" id="5077668">[</span><span class="ident" id="5077669">j</span><span class="op" id="5077670">:</span><span class="ident" id="5077671">j</span><span class="op" id="5077672">+</span><span class="num" id="5077673">1</span><span class="op" id="5077674">]</span><span class="op" id="5077675">,</span>&nbsp;<span class="ident" id="5077677">s</span><span class="op" id="5077678">[</span><span class="op" id="5077679">:</span><span class="ident" id="5077680">i</span><span class="op" id="5077681">]</span><span class="op" id="5077682">)</span><span class="op" id="5077683">,</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5077688">}</span><span class="op" id="5077689">,</span>&nbsp;<span class="builtinfunc" id="5077691">len</span><span class="op" id="5077694">(</span><span class="ident" id="5077695">s</span><span class="op" id="5077696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5077700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5077703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5077706">if</span>&nbsp;<span class="ident" id="5077709">i</span>&nbsp;<span class="op" id="5077711">==</span>&nbsp;<span class="builtinfunc" id="5077714">len</span><span class="op" id="5077717">(</span><span class="ident" id="5077718">s</span><span class="op" id="5077719">)</span>&nbsp;<span class="op" id="5077721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5077725">//&nbsp;Remain&nbsp;inside&nbsp;the&nbsp;attribute.</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5077759">//&nbsp;Decode&nbsp;the&nbsp;value&nbsp;so&nbsp;non-HTML&nbsp;rules&nbsp;can&nbsp;easily&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5077817">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;button&nbsp;onclick=&#34;alert(&amp;quot;Hi!&amp;quot;)&#34;&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5077868">//&nbsp;without&nbsp;having&nbsp;to&nbsp;entity&nbsp;decode&nbsp;token&nbsp;boundaries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5077923">for</span>&nbsp;<span class="ident" id="5077927">u</span>&nbsp;<span class="op" id="5077929">:=</span>&nbsp;<span class="op" id="5077932">[</span><span class="op" id="5077933">]</span><span class="builtintype" id="5077934">byte</span><span class="op" id="5077938">(</span><span class="ident" id="5077939">html</span><span class="op" id="5077943">.</span><span class="ident" id="5077944">UnescapeString</span><span class="op" id="5077958">(</span><span class="builtintype" id="5077959">string</span><span class="op" id="5077965">(</span><span class="ident" id="5077966">s</span><span class="op" id="5077967">)</span><span class="op" id="5077968">)</span><span class="op" id="5077969">)</span><span class="op" id="5077970">;</span>&nbsp;<span class="builtinfunc" id="5077972">len</span><span class="op" id="5077975">(</span><span class="ident" id="5077976">u</span><span class="op" id="5077977">)</span>&nbsp;<span class="op" id="5077979">!=</span>&nbsp;<span class="num" id="5077982">0</span><span class="op" id="5077983">;</span>&nbsp;<span class="op" id="5077985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5077990">c1</span><span class="op" id="5077992">,</span>&nbsp;<span class="ident" id="5077994">i1</span>&nbsp;<span class="op" id="5077997">:=</span>&nbsp;<span class="ident" id="5078000">transitionFunc</span><span class="op" id="5078014">[</span><span class="ident" id="5078015">c</span><span class="op" id="5078016">.</span><span class="ident" id="5078017">state</span><span class="op" id="5078022">]</span><span class="op" id="5078023">(</span><span class="ident" id="5078024">c</span><span class="op" id="5078025">,</span>&nbsp;<span class="ident" id="5078027">u</span><span class="op" id="5078028">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5078033">c</span><span class="op" id="5078034">,</span>&nbsp;<span class="ident" id="5078036">u</span>&nbsp;<span class="op" id="5078038">=</span>&nbsp;<span class="ident" id="5078040">c1</span><span class="op" id="5078042">,</span>&nbsp;<span class="ident" id="5078044">u</span><span class="op" id="5078045">[</span><span class="ident" id="5078046">i1</span><span class="op" id="5078048">:</span><span class="op" id="5078049">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5078053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5078057">return</span>&nbsp;<span class="ident" id="5078064">c</span><span class="op" id="5078065">,</span>&nbsp;<span class="builtinfunc" id="5078067">len</span><span class="op" id="5078070">(</span><span class="ident" id="5078071">s</span><span class="op" id="5078072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5078075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5078078">if</span>&nbsp;<span class="ident" id="5078081">c</span><span class="op" id="5078082">.</span><span class="ident" id="5078083">delim</span>&nbsp;<span class="op" id="5078089">!=</span>&nbsp;<span class="ident" id="5078092">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="5078111">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5078115">//&nbsp;Consume&nbsp;any&nbsp;quote.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5078139">i</span><span class="op" id="5078140">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5078144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5078147">//&nbsp;On&nbsp;exiting&nbsp;an&nbsp;attribute,&nbsp;we&nbsp;discard&nbsp;all&nbsp;state&nbsp;information</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5078209">//&nbsp;except&nbsp;the&nbsp;state&nbsp;and&nbsp;element.</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5078243">return</span>&nbsp;<span class="ident" id="5078250">context</span><span class="op" id="5078257">{</span><span class="ident" id="5078258">state</span><span class="op" id="5078263">:</span>&nbsp;<span class="ident" id="5078265">stateTag</span><span class="op" id="5078273">,</span>&nbsp;<span class="ident" id="5078275">element</span><span class="op" id="5078282">:</span>&nbsp;<span class="ident" id="5078284">c</span><span class="op" id="5078285">.</span><span class="ident" id="5078286">element</span><span class="op" id="5078293">}</span><span class="op" id="5078294">,</span>&nbsp;<span class="ident" id="5078296">i</span><br>
<span class="lineno"></span><span class="op" id="5078298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5078301">//&nbsp;editActionNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;an&nbsp;action&nbsp;pipeline&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="5078376">func</span>&nbsp;<span class="op" id="5078381">(</span><span class="ident" id="5078382">e</span>&nbsp;<span class="op" id="5078384">*</span><span class="ident" id="5078385">escaper</span><span class="op" id="5078392">)</span>&nbsp;<span class="ident" id="5078394">editActionNode</span><span class="op" id="5078408">(</span><span class="ident" id="5078409">n</span>&nbsp;<span class="op" id="5078411">*</span><span class="ident" id="5078412">parse</span><span class="op" id="5078417">.</span><span class="ident" id="5078418">ActionNode</span><span class="op" id="5078428">,</span>&nbsp;<span class="ident" id="5078430">cmds</span>&nbsp;<span class="op" id="5078435">[</span><span class="op" id="5078436">]</span><span class="builtintype" id="5078437">string</span><span class="op" id="5078443">)</span>&nbsp;<span class="op" id="5078445">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5078448">if</span>&nbsp;<span class="ident" id="5078451">_</span><span class="op" id="5078452">,</span>&nbsp;<span class="ident" id="5078454">ok</span>&nbsp;<span class="op" id="5078457">:=</span>&nbsp;<span class="ident" id="5078460">e</span><span class="op" id="5078461">.</span><span class="ident" id="5078462">actionNodeEdits</span><span class="op" id="5078477">[</span><span class="ident" id="5078478">n</span><span class="op" id="5078479">]</span><span class="op" id="5078480">;</span>&nbsp;<span class="ident" id="5078482">ok</span>&nbsp;<span class="op" id="5078485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5078489">panic</span><span class="op" id="5078494">(</span><span class="ident" id="5078495">fmt</span><span class="op" id="5078498">.</span><span class="ident" id="5078499">Sprintf</span><span class="op" id="5078506">(</span><span class="string" id="5078507">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="5078541">,</span>&nbsp;<span class="ident" id="5078543">n</span><span class="op" id="5078544">)</span><span class="op" id="5078545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5078548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5078551">e</span><span class="op" id="5078552">.</span><span class="ident" id="5078553">actionNodeEdits</span><span class="op" id="5078568">[</span><span class="ident" id="5078569">n</span><span class="op" id="5078570">]</span>&nbsp;<span class="op" id="5078572">=</span>&nbsp;<span class="ident" id="5078574">cmds</span><br>
<span class="lineno"></span><span class="op" id="5078579">}</span><br>
<span class="lineno">720</span><br>
<span class="lineno"></span><span class="comment" id="5078582">//&nbsp;editTemplateNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;{{template}}&nbsp;callee&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="5078662">func</span>&nbsp;<span class="op" id="5078667">(</span><span class="ident" id="5078668">e</span>&nbsp;<span class="op" id="5078670">*</span><span class="ident" id="5078671">escaper</span><span class="op" id="5078678">)</span>&nbsp;<span class="ident" id="5078680">editTemplateNode</span><span class="op" id="5078696">(</span><span class="ident" id="5078697">n</span>&nbsp;<span class="op" id="5078699">*</span><span class="ident" id="5078700">parse</span><span class="op" id="5078705">.</span><span class="ident" id="5078706">TemplateNode</span><span class="op" id="5078718">,</span>&nbsp;<span class="ident" id="5078720">callee</span>&nbsp;<span class="builtintype" id="5078727">string</span><span class="op" id="5078733">)</span>&nbsp;<span class="op" id="5078735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5078738">if</span>&nbsp;<span class="ident" id="5078741">_</span><span class="op" id="5078742">,</span>&nbsp;<span class="ident" id="5078744">ok</span>&nbsp;<span class="op" id="5078747">:=</span>&nbsp;<span class="ident" id="5078750">e</span><span class="op" id="5078751">.</span><span class="ident" id="5078752">templateNodeEdits</span><span class="op" id="5078769">[</span><span class="ident" id="5078770">n</span><span class="op" id="5078771">]</span><span class="op" id="5078772">;</span>&nbsp;<span class="ident" id="5078774">ok</span>&nbsp;<span class="op" id="5078777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5078781">panic</span><span class="op" id="5078786">(</span><span class="ident" id="5078787">fmt</span><span class="op" id="5078790">.</span><span class="ident" id="5078791">Sprintf</span><span class="op" id="5078798">(</span><span class="string" id="5078799">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="5078833">,</span>&nbsp;<span class="ident" id="5078835">n</span><span class="op" id="5078836">)</span><span class="op" id="5078837">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5078840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5078843">e</span><span class="op" id="5078844">.</span><span class="ident" id="5078845">templateNodeEdits</span><span class="op" id="5078862">[</span><span class="ident" id="5078863">n</span><span class="op" id="5078864">]</span>&nbsp;<span class="op" id="5078866">=</span>&nbsp;<span class="ident" id="5078868">callee</span><br>
<span class="lineno"></span><span class="op" id="5078875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5078878">//&nbsp;editTextNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;text&nbsp;node&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno">730</span><span class="keyword" id="5078944">func</span>&nbsp;<span class="op" id="5078949">(</span><span class="ident" id="5078950">e</span>&nbsp;<span class="op" id="5078952">*</span><span class="ident" id="5078953">escaper</span><span class="op" id="5078960">)</span>&nbsp;<span class="ident" id="5078962">editTextNode</span><span class="op" id="5078974">(</span><span class="ident" id="5078975">n</span>&nbsp;<span class="op" id="5078977">*</span><span class="ident" id="5078978">parse</span><span class="op" id="5078983">.</span><span class="ident" id="5078984">TextNode</span><span class="op" id="5078992">,</span>&nbsp;<span class="ident" id="5078994">text</span>&nbsp;<span class="op" id="5078999">[</span><span class="op" id="5079000">]</span><span class="builtintype" id="5079001">byte</span><span class="op" id="5079005">)</span>&nbsp;<span class="op" id="5079007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5079010">if</span>&nbsp;<span class="ident" id="5079013">_</span><span class="op" id="5079014">,</span>&nbsp;<span class="ident" id="5079016">ok</span>&nbsp;<span class="op" id="5079019">:=</span>&nbsp;<span class="ident" id="5079022">e</span><span class="op" id="5079023">.</span><span class="ident" id="5079024">textNodeEdits</span><span class="op" id="5079037">[</span><span class="ident" id="5079038">n</span><span class="op" id="5079039">]</span><span class="op" id="5079040">;</span>&nbsp;<span class="ident" id="5079042">ok</span>&nbsp;<span class="op" id="5079045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5079049">panic</span><span class="op" id="5079054">(</span><span class="ident" id="5079055">fmt</span><span class="op" id="5079058">.</span><span class="ident" id="5079059">Sprintf</span><span class="op" id="5079066">(</span><span class="string" id="5079067">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="5079101">,</span>&nbsp;<span class="ident" id="5079103">n</span><span class="op" id="5079104">)</span><span class="op" id="5079105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5079108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5079111">e</span><span class="op" id="5079112">.</span><span class="ident" id="5079113">textNodeEdits</span><span class="op" id="5079126">[</span><span class="ident" id="5079127">n</span><span class="op" id="5079128">]</span>&nbsp;<span class="op" id="5079130">=</span>&nbsp;<span class="ident" id="5079132">text</span><br>
<span class="lineno">735</span><span class="op" id="5079137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5079140">//&nbsp;commit&nbsp;applies&nbsp;changes&nbsp;to&nbsp;actions&nbsp;and&nbsp;template&nbsp;calls&nbsp;needed&nbsp;to&nbsp;contextually</span><br>
<span class="lineno"></span><span class="comment" id="5079219">//&nbsp;autoescape&nbsp;content&nbsp;and&nbsp;adds&nbsp;any&nbsp;derived&nbsp;templates&nbsp;to&nbsp;the&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="5079284">func</span>&nbsp;<span class="op" id="5079289">(</span><span class="ident" id="5079290">e</span>&nbsp;<span class="op" id="5079292">*</span><span class="ident" id="5079293">escaper</span><span class="op" id="5079300">)</span>&nbsp;<span class="ident" id="5079302">commit</span><span class="op" id="5079308">(</span><span class="op" id="5079309">)</span>&nbsp;<span class="op" id="5079311">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5079314">for</span>&nbsp;<span class="ident" id="5079318">name</span>&nbsp;<span class="op" id="5079323">:=</span>&nbsp;<span class="keyword" id="5079326">range</span>&nbsp;<span class="ident" id="5079332">e</span><span class="op" id="5079333">.</span><span class="ident" id="5079334">output</span>&nbsp;<span class="op" id="5079341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5079345">e</span><span class="op" id="5079346">.</span><span class="ident" id="5079347">template</span><span class="op" id="5079355">(</span><span class="ident" id="5079356">name</span><span class="op" id="5079360">)</span><span class="op" id="5079361">.</span><span class="ident" id="5079362">Funcs</span><span class="op" id="5079367">(</span><span class="ident" id="5079368">funcMap</span><span class="op" id="5079375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5079378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5079381">for</span>&nbsp;<span class="ident" id="5079385">_</span><span class="op" id="5079386">,</span>&nbsp;<span class="ident" id="5079388">t</span>&nbsp;<span class="op" id="5079390">:=</span>&nbsp;<span class="keyword" id="5079393">range</span>&nbsp;<span class="ident" id="5079399">e</span><span class="op" id="5079400">.</span><span class="ident" id="5079401">derived</span>&nbsp;<span class="op" id="5079409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5079413">if</span>&nbsp;<span class="ident" id="5079416">_</span><span class="op" id="5079417">,</span>&nbsp;<span class="ident" id="5079419">err</span>&nbsp;<span class="op" id="5079423">:=</span>&nbsp;<span class="ident" id="5079426">e</span><span class="op" id="5079427">.</span><span class="ident" id="5079428">tmpl</span><span class="op" id="5079432">.</span><span class="ident" id="5079433">text</span><span class="op" id="5079437">.</span><span class="ident" id="5079438">AddParseTree</span><span class="op" id="5079450">(</span><span class="ident" id="5079451">t</span><span class="op" id="5079452">.</span><span class="ident" id="5079453">Name</span><span class="op" id="5079457">(</span><span class="op" id="5079458">)</span><span class="op" id="5079459">,</span>&nbsp;<span class="ident" id="5079461">t</span><span class="op" id="5079462">.</span><span class="ident" id="5079463">Tree</span><span class="op" id="5079467">)</span><span class="op" id="5079468">;</span>&nbsp;<span class="ident" id="5079470">err</span>&nbsp;<span class="op" id="5079474">!=</span>&nbsp;<span class="ident" id="5079477">nil</span>&nbsp;<span class="op" id="5079481">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5079486">panic</span><span class="op" id="5079491">(</span><span class="string" id="5079492">&#34;error&nbsp;adding&nbsp;derived&nbsp;template&#34;</span><span class="op" id="5079523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5079527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5079530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5079533">for</span>&nbsp;<span class="ident" id="5079537">n</span><span class="op" id="5079538">,</span>&nbsp;<span class="ident" id="5079540">s</span>&nbsp;<span class="op" id="5079542">:=</span>&nbsp;<span class="keyword" id="5079545">range</span>&nbsp;<span class="ident" id="5079551">e</span><span class="op" id="5079552">.</span><span class="ident" id="5079553">actionNodeEdits</span>&nbsp;<span class="op" id="5079569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5079573">ensurePipelineContains</span><span class="op" id="5079595">(</span><span class="ident" id="5079596">n</span><span class="op" id="5079597">.</span><span class="ident" id="5079598">Pipe</span><span class="op" id="5079602">,</span>&nbsp;<span class="ident" id="5079604">s</span><span class="op" id="5079605">)</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5079608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5079611">for</span>&nbsp;<span class="ident" id="5079615">n</span><span class="op" id="5079616">,</span>&nbsp;<span class="ident" id="5079618">name</span>&nbsp;<span class="op" id="5079623">:=</span>&nbsp;<span class="keyword" id="5079626">range</span>&nbsp;<span class="ident" id="5079632">e</span><span class="op" id="5079633">.</span><span class="ident" id="5079634">templateNodeEdits</span>&nbsp;<span class="op" id="5079652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5079656">n</span><span class="op" id="5079657">.</span><span class="ident" id="5079658">Name</span>&nbsp;<span class="op" id="5079663">=</span>&nbsp;<span class="ident" id="5079665">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5079671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5079674">for</span>&nbsp;<span class="ident" id="5079678">n</span><span class="op" id="5079679">,</span>&nbsp;<span class="ident" id="5079681">s</span>&nbsp;<span class="op" id="5079683">:=</span>&nbsp;<span class="keyword" id="5079686">range</span>&nbsp;<span class="ident" id="5079692">e</span><span class="op" id="5079693">.</span><span class="ident" id="5079694">textNodeEdits</span>&nbsp;<span class="op" id="5079708">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5079712">n</span><span class="op" id="5079713">.</span><span class="ident" id="5079714">Text</span>&nbsp;<span class="op" id="5079719">=</span>&nbsp;<span class="ident" id="5079721">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5079724">}</span><br>
<span class="lineno"></span><span class="op" id="5079726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5079729">//&nbsp;template&nbsp;returns&nbsp;the&nbsp;named&nbsp;template&nbsp;given&nbsp;a&nbsp;mangled&nbsp;template&nbsp;name.</span><br>
<span class="lineno">760</span><span class="keyword" id="5079799">func</span>&nbsp;<span class="op" id="5079804">(</span><span class="ident" id="5079805">e</span>&nbsp;<span class="op" id="5079807">*</span><span class="ident" id="5079808">escaper</span><span class="op" id="5079815">)</span>&nbsp;<span class="ident" id="5079817">template</span><span class="op" id="5079825">(</span><span class="ident" id="5079826">name</span>&nbsp;<span class="builtintype" id="5079831">string</span><span class="op" id="5079837">)</span>&nbsp;<span class="op" id="5079839">*</span><span class="ident" id="5079840">template</span><span class="op" id="5079848">.</span><span class="ident" id="5079849">Template</span>&nbsp;<span class="op" id="5079858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5079861">t</span>&nbsp;<span class="op" id="5079863">:=</span>&nbsp;<span class="ident" id="5079866">e</span><span class="op" id="5079867">.</span><span class="ident" id="5079868">tmpl</span><span class="op" id="5079872">.</span><span class="ident" id="5079873">text</span><span class="op" id="5079877">.</span><span class="ident" id="5079878">Lookup</span><span class="op" id="5079884">(</span><span class="ident" id="5079885">name</span><span class="op" id="5079889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5079892">if</span>&nbsp;<span class="ident" id="5079895">t</span>&nbsp;<span class="op" id="5079897">==</span>&nbsp;<span class="ident" id="5079900">nil</span>&nbsp;<span class="op" id="5079904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5079908">t</span>&nbsp;<span class="op" id="5079910">=</span>&nbsp;<span class="ident" id="5079912">e</span><span class="op" id="5079913">.</span><span class="ident" id="5079914">derived</span><span class="op" id="5079921">[</span><span class="ident" id="5079922">name</span><span class="op" id="5079926">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5079929">}</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5079932">return</span>&nbsp;<span class="ident" id="5079939">t</span><br>
<span class="lineno"></span><span class="op" id="5079941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5079944">//&nbsp;Forwarding&nbsp;functions&nbsp;so&nbsp;that&nbsp;clients&nbsp;need&nbsp;only&nbsp;import&nbsp;this&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="5080014">//&nbsp;to&nbsp;reach&nbsp;the&nbsp;general&nbsp;escaping&nbsp;functions&nbsp;of&nbsp;text/template.</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="5080076">//&nbsp;HTMLEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="5080156">func</span>&nbsp;<span class="ident" id="5080161">HTMLEscape</span><span class="op" id="5080171">(</span><span class="ident" id="5080172">w</span>&nbsp;<span class="ident" id="5080174">io</span><span class="op" id="5080176">.</span><span class="ident" id="5080177">Writer</span><span class="op" id="5080183">,</span>&nbsp;<span class="ident" id="5080185">b</span>&nbsp;<span class="op" id="5080187">[</span><span class="op" id="5080188">]</span><span class="builtintype" id="5080189">byte</span><span class="op" id="5080193">)</span>&nbsp;<span class="op" id="5080195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5080198">template</span><span class="op" id="5080206">.</span><span class="ident" id="5080207">HTMLEscape</span><span class="op" id="5080217">(</span><span class="ident" id="5080218">w</span><span class="op" id="5080219">,</span>&nbsp;<span class="ident" id="5080221">b</span><span class="op" id="5080222">)</span><br>
<span class="lineno"></span><span class="op" id="5080224">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="comment" id="5080227">//&nbsp;HTMLEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="5080309">func</span>&nbsp;<span class="ident" id="5080314">HTMLEscapeString</span><span class="op" id="5080330">(</span><span class="ident" id="5080331">s</span>&nbsp;<span class="builtintype" id="5080333">string</span><span class="op" id="5080339">)</span>&nbsp;<span class="builtintype" id="5080341">string</span>&nbsp;<span class="op" id="5080348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5080351">return</span>&nbsp;<span class="ident" id="5080358">template</span><span class="op" id="5080366">.</span><span class="ident" id="5080367">HTMLEscapeString</span><span class="op" id="5080383">(</span><span class="ident" id="5080384">s</span><span class="op" id="5080385">)</span><br>
<span class="lineno"></span><span class="op" id="5080387">}</span><br>
<span class="lineno">780</span><br>
<span class="lineno"></span><span class="comment" id="5080390">//&nbsp;HTMLEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="5080456">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="5080492">func</span>&nbsp;<span class="ident" id="5080497">HTMLEscaper</span><span class="op" id="5080508">(</span><span class="ident" id="5080509">args</span>&nbsp;<span class="op" id="5080514">...</span><span class="keyword" id="5080517">interface</span><span class="op" id="5080526">{</span><span class="op" id="5080527">}</span><span class="op" id="5080528">)</span>&nbsp;<span class="builtintype" id="5080530">string</span>&nbsp;<span class="op" id="5080537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5080540">return</span>&nbsp;<span class="ident" id="5080547">template</span><span class="op" id="5080555">.</span><span class="ident" id="5080556">HTMLEscaper</span><span class="op" id="5080567">(</span><span class="ident" id="5080568">args</span><span class="op" id="5080572">...</span><span class="op" id="5080575">)</span><br>
<span class="lineno">785</span><span class="op" id="5080577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5080580">//&nbsp;JSEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="5080664">func</span>&nbsp;<span class="ident" id="5080669">JSEscape</span><span class="op" id="5080677">(</span><span class="ident" id="5080678">w</span>&nbsp;<span class="ident" id="5080680">io</span><span class="op" id="5080682">.</span><span class="ident" id="5080683">Writer</span><span class="op" id="5080689">,</span>&nbsp;<span class="ident" id="5080691">b</span>&nbsp;<span class="op" id="5080693">[</span><span class="op" id="5080694">]</span><span class="builtintype" id="5080695">byte</span><span class="op" id="5080699">)</span>&nbsp;<span class="op" id="5080701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5080704">template</span><span class="op" id="5080712">.</span><span class="ident" id="5080713">JSEscape</span><span class="op" id="5080721">(</span><span class="ident" id="5080722">w</span><span class="op" id="5080723">,</span>&nbsp;<span class="ident" id="5080725">b</span><span class="op" id="5080726">)</span><br>
<span class="lineno">790</span><span class="op" id="5080728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5080731">//&nbsp;JSEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="5080817">func</span>&nbsp;<span class="ident" id="5080822">JSEscapeString</span><span class="op" id="5080836">(</span><span class="ident" id="5080837">s</span>&nbsp;<span class="builtintype" id="5080839">string</span><span class="op" id="5080845">)</span>&nbsp;<span class="builtintype" id="5080847">string</span>&nbsp;<span class="op" id="5080854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5080857">return</span>&nbsp;<span class="ident" id="5080864">template</span><span class="op" id="5080872">.</span><span class="ident" id="5080873">JSEscapeString</span><span class="op" id="5080887">(</span><span class="ident" id="5080888">s</span><span class="op" id="5080889">)</span><br>
<span class="lineno">795</span><span class="op" id="5080891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5080894">//&nbsp;JSEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="5080964">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="5081000">func</span>&nbsp;<span class="ident" id="5081005">JSEscaper</span><span class="op" id="5081014">(</span><span class="ident" id="5081015">args</span>&nbsp;<span class="op" id="5081020">...</span><span class="keyword" id="5081023">interface</span><span class="op" id="5081032">{</span><span class="op" id="5081033">}</span><span class="op" id="5081034">)</span>&nbsp;<span class="builtintype" id="5081036">string</span>&nbsp;<span class="op" id="5081043">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5081046">return</span>&nbsp;<span class="ident" id="5081053">template</span><span class="op" id="5081061">.</span><span class="ident" id="5081062">JSEscaper</span><span class="op" id="5081071">(</span><span class="ident" id="5081072">args</span><span class="op" id="5081076">...</span><span class="op" id="5081079">)</span><br>
<span class="lineno"></span><span class="op" id="5081081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5081084">//&nbsp;URLQueryEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;value&nbsp;of&nbsp;the&nbsp;textual&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5081162">//&nbsp;its&nbsp;arguments&nbsp;in&nbsp;a&nbsp;form&nbsp;suitable&nbsp;for&nbsp;embedding&nbsp;in&nbsp;a&nbsp;URL&nbsp;query.</span><br>
<span class="lineno">805</span><span class="keyword" id="5081228">func</span>&nbsp;<span class="ident" id="5081233">URLQueryEscaper</span><span class="op" id="5081248">(</span><span class="ident" id="5081249">args</span>&nbsp;<span class="op" id="5081254">...</span><span class="keyword" id="5081257">interface</span><span class="op" id="5081266">{</span><span class="op" id="5081267">}</span><span class="op" id="5081268">)</span>&nbsp;<span class="builtintype" id="5081270">string</span>&nbsp;<span class="op" id="5081277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5081280">return</span>&nbsp;<span class="ident" id="5081287">template</span><span class="op" id="5081295">.</span><span class="ident" id="5081296">URLQueryEscaper</span><span class="op" id="5081311">(</span><span class="ident" id="5081312">args</span><span class="op" id="5081316">...</span><span class="op" id="5081319">)</span><br>
<span class="lineno"></span><span class="op" id="5081321">}</span>
</div>
</body>
</html>
