<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html" class="current">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4003307">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4003362">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4003416">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4003467">//&nbsp;Package&nbsp;tls&nbsp;partially&nbsp;implements&nbsp;TLS&nbsp;1.2,&nbsp;as&nbsp;specified&nbsp;in&nbsp;RFC&nbsp;5246.</span><br>
<span class="lineno"></span><span class="keyword" id="4003538">package</span>&nbsp;<span class="ident" id="4003546">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4003551">import</span>&nbsp;<span class="op" id="4003558">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4003561">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4003571">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4003587">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4003601">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4003616">&#34;encoding/pem&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4003632">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4003642">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4003655">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4003662">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4003673">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4003680">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="4003683">//&nbsp;Server&nbsp;returns&nbsp;a&nbsp;new&nbsp;TLS&nbsp;server&nbsp;side&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="4003734">//&nbsp;using&nbsp;conn&nbsp;as&nbsp;the&nbsp;underlying&nbsp;transport.</span><br>
<span class="lineno"></span><span class="comment" id="4003777">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4003835">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno">25</span><span class="keyword" id="4003864">func</span>&nbsp;<span class="ident" id="4003869">Server</span><span class="op" id="4003875">(</span><span class="ident" id="4003876">conn</span>&nbsp;<span class="ident" id="4003881">net</span><span class="op" id="4003884">.</span><span class="ident" id="4003885">Conn</span><span class="op" id="4003889">,</span>&nbsp;<span class="ident" id="4003891">config</span>&nbsp;<span class="op" id="4003898">*</span><span class="ident" id="4003899">Config</span><span class="op" id="4003905">)</span>&nbsp;<span class="op" id="4003907">*</span><span class="ident" id="4003908">Conn</span>&nbsp;<span class="op" id="4003913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4003916">return</span>&nbsp;<span class="op" id="4003923">&amp;</span><span class="ident" id="4003924">Conn</span><span class="op" id="4003928">{</span><span class="ident" id="4003929">conn</span><span class="op" id="4003933">:</span>&nbsp;<span class="ident" id="4003935">conn</span><span class="op" id="4003939">,</span>&nbsp;<span class="ident" id="4003941">config</span><span class="op" id="4003947">:</span>&nbsp;<span class="ident" id="4003949">config</span><span class="op" id="4003955">}</span><br>
<span class="lineno"></span><span class="op" id="4003957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4003960">//&nbsp;Client&nbsp;returns&nbsp;a&nbsp;new&nbsp;TLS&nbsp;client&nbsp;side&nbsp;connection</span><br>
<span class="lineno">30</span><span class="comment" id="4004011">//&nbsp;using&nbsp;conn&nbsp;as&nbsp;the&nbsp;underlying&nbsp;transport.</span><br>
<span class="lineno"></span><span class="comment" id="4004054">//&nbsp;The&nbsp;config&nbsp;cannot&nbsp;be&nbsp;nil:&nbsp;users&nbsp;must&nbsp;set&nbsp;either&nbsp;ServerName&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4004119">//&nbsp;InsecureSkipVerify&nbsp;in&nbsp;the&nbsp;config.</span><br>
<span class="lineno"></span><span class="keyword" id="4004156">func</span>&nbsp;<span class="ident" id="4004161">Client</span><span class="op" id="4004167">(</span><span class="ident" id="4004168">conn</span>&nbsp;<span class="ident" id="4004173">net</span><span class="op" id="4004176">.</span><span class="ident" id="4004177">Conn</span><span class="op" id="4004181">,</span>&nbsp;<span class="ident" id="4004183">config</span>&nbsp;<span class="op" id="4004190">*</span><span class="ident" id="4004191">Config</span><span class="op" id="4004197">)</span>&nbsp;<span class="op" id="4004199">*</span><span class="ident" id="4004200">Conn</span>&nbsp;<span class="op" id="4004205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4004208">return</span>&nbsp;<span class="op" id="4004215">&amp;</span><span class="ident" id="4004216">Conn</span><span class="op" id="4004220">{</span><span class="ident" id="4004221">conn</span><span class="op" id="4004225">:</span>&nbsp;<span class="ident" id="4004227">conn</span><span class="op" id="4004231">,</span>&nbsp;<span class="ident" id="4004233">config</span><span class="op" id="4004239">:</span>&nbsp;<span class="ident" id="4004241">config</span><span class="op" id="4004247">,</span>&nbsp;<span class="ident" id="4004249">isClient</span><span class="op" id="4004257">:</span>&nbsp;<span class="builtintype" id="4004259">true</span><span class="op" id="4004263">}</span><br>
<span class="lineno">35</span><span class="op" id="4004265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4004268">//&nbsp;A&nbsp;listener&nbsp;implements&nbsp;a&nbsp;network&nbsp;listener&nbsp;(net.Listener)&nbsp;for&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="4004348">type</span>&nbsp;<span class="ident" id="4004353">listener</span>&nbsp;<span class="keyword" id="4004362">struct</span>&nbsp;<span class="op" id="4004369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4004372">net</span><span class="op" id="4004375">.</span><span class="ident" id="4004376">Listener</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4004386">config</span>&nbsp;<span class="op" id="4004393">*</span><span class="ident" id="4004394">Config</span><br>
<span class="lineno"></span><span class="op" id="4004401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4004404">//&nbsp;Accept&nbsp;waits&nbsp;for&nbsp;and&nbsp;returns&nbsp;the&nbsp;next&nbsp;incoming&nbsp;TLS&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4004470">//&nbsp;The&nbsp;returned&nbsp;connection&nbsp;c&nbsp;is&nbsp;a&nbsp;*tls.Conn.</span><br>
<span class="lineno">45</span><span class="keyword" id="4004515">func</span>&nbsp;<span class="op" id="4004520">(</span><span class="ident" id="4004521">l</span>&nbsp;<span class="op" id="4004523">*</span><span class="ident" id="4004524">listener</span><span class="op" id="4004532">)</span>&nbsp;<span class="ident" id="4004534">Accept</span><span class="op" id="4004540">(</span><span class="op" id="4004541">)</span>&nbsp;<span class="op" id="4004543">(</span><span class="ident" id="4004544">c</span>&nbsp;<span class="ident" id="4004546">net</span><span class="op" id="4004549">.</span><span class="ident" id="4004550">Conn</span><span class="op" id="4004554">,</span>&nbsp;<span class="ident" id="4004556">err</span>&nbsp;<span class="builtintype" id="4004560">error</span><span class="op" id="4004565">)</span>&nbsp;<span class="op" id="4004567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4004570">c</span><span class="op" id="4004571">,</span>&nbsp;<span class="ident" id="4004573">err</span>&nbsp;<span class="op" id="4004577">=</span>&nbsp;<span class="ident" id="4004579">l</span><span class="op" id="4004580">.</span><span class="ident" id="4004581">Listener</span><span class="op" id="4004589">.</span><span class="ident" id="4004590">Accept</span><span class="op" id="4004596">(</span><span class="op" id="4004597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4004600">if</span>&nbsp;<span class="ident" id="4004603">err</span>&nbsp;<span class="op" id="4004607">!=</span>&nbsp;<span class="ident" id="4004610">nil</span>&nbsp;<span class="op" id="4004614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4004618">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4004626">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4004629">c</span>&nbsp;<span class="op" id="4004631">=</span>&nbsp;<span class="ident" id="4004633">Server</span><span class="op" id="4004639">(</span><span class="ident" id="4004640">c</span><span class="op" id="4004641">,</span>&nbsp;<span class="ident" id="4004643">l</span><span class="op" id="4004644">.</span><span class="ident" id="4004645">config</span><span class="op" id="4004651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4004654">return</span><br>
<span class="lineno"></span><span class="op" id="4004661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4004664">//&nbsp;NewListener&nbsp;creates&nbsp;a&nbsp;Listener&nbsp;which&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;an&nbsp;inner</span><br>
<span class="lineno">55</span><span class="comment" id="4004738">//&nbsp;Listener&nbsp;and&nbsp;wraps&nbsp;each&nbsp;connection&nbsp;with&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="4004789">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4004847">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="4004876">func</span>&nbsp;<span class="ident" id="4004881">NewListener</span><span class="op" id="4004892">(</span><span class="ident" id="4004893">inner</span>&nbsp;<span class="ident" id="4004899">net</span><span class="op" id="4004902">.</span><span class="ident" id="4004903">Listener</span><span class="op" id="4004911">,</span>&nbsp;<span class="ident" id="4004913">config</span>&nbsp;<span class="op" id="4004920">*</span><span class="ident" id="4004921">Config</span><span class="op" id="4004927">)</span>&nbsp;<span class="ident" id="4004929">net</span><span class="op" id="4004932">.</span><span class="ident" id="4004933">Listener</span>&nbsp;<span class="op" id="4004942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4004945">l</span>&nbsp;<span class="op" id="4004947">:=</span>&nbsp;<span class="builtinfunc" id="4004950">new</span><span class="op" id="4004953">(</span><span class="ident" id="4004954">listener</span><span class="op" id="4004962">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4004965">l</span><span class="op" id="4004966">.</span><span class="ident" id="4004967">Listener</span>&nbsp;<span class="op" id="4004976">=</span>&nbsp;<span class="ident" id="4004978">inner</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4004985">l</span><span class="op" id="4004986">.</span><span class="ident" id="4004987">config</span>&nbsp;<span class="op" id="4004994">=</span>&nbsp;<span class="ident" id="4004996">config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4005004">return</span>&nbsp;<span class="ident" id="4005011">l</span><br>
<span class="lineno"></span><span class="op" id="4005013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4005016">//&nbsp;Listen&nbsp;creates&nbsp;a&nbsp;TLS&nbsp;listener&nbsp;accepting&nbsp;connections&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4005078">//&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;net.Listen.</span><br>
<span class="lineno"></span><span class="comment" id="4005121">//&nbsp;The&nbsp;configuration&nbsp;config&nbsp;must&nbsp;be&nbsp;non-nil&nbsp;and&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="4005179">//&nbsp;at&nbsp;least&nbsp;one&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="4005208">func</span>&nbsp;<span class="ident" id="4005213">Listen</span><span class="op" id="4005219">(</span><span class="ident" id="4005220">network</span><span class="op" id="4005227">,</span>&nbsp;<span class="ident" id="4005229">laddr</span>&nbsp;<span class="builtintype" id="4005235">string</span><span class="op" id="4005241">,</span>&nbsp;<span class="ident" id="4005243">config</span>&nbsp;<span class="op" id="4005250">*</span><span class="ident" id="4005251">Config</span><span class="op" id="4005257">)</span>&nbsp;<span class="op" id="4005259">(</span><span class="ident" id="4005260">net</span><span class="op" id="4005263">.</span><span class="ident" id="4005264">Listener</span><span class="op" id="4005272">,</span>&nbsp;<span class="builtintype" id="4005274">error</span><span class="op" id="4005279">)</span>&nbsp;<span class="op" id="4005281">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4005284">if</span>&nbsp;<span class="ident" id="4005287">config</span>&nbsp;<span class="op" id="4005294">==</span>&nbsp;<span class="ident" id="4005297">nil</span>&nbsp;<span class="op" id="4005301">||</span>&nbsp;<span class="builtinfunc" id="4005304">len</span><span class="op" id="4005307">(</span><span class="ident" id="4005308">config</span><span class="op" id="4005314">.</span><span class="ident" id="4005315">Certificates</span><span class="op" id="4005327">)</span>&nbsp;<span class="op" id="4005329">==</span>&nbsp;<span class="num" id="4005332">0</span>&nbsp;<span class="op" id="4005334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4005338">return</span>&nbsp;<span class="ident" id="4005345">nil</span><span class="op" id="4005348">,</span>&nbsp;<span class="ident" id="4005350">errors</span><span class="op" id="4005356">.</span><span class="ident" id="4005357">New</span><span class="op" id="4005360">(</span><span class="string" id="4005361">&#34;tls.Listen:&nbsp;no&nbsp;certificates&nbsp;in&nbsp;configuration&#34;</span><span class="op" id="4005407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4005410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4005413">l</span><span class="op" id="4005414">,</span>&nbsp;<span class="ident" id="4005416">err</span>&nbsp;<span class="op" id="4005420">:=</span>&nbsp;<span class="ident" id="4005423">net</span><span class="op" id="4005426">.</span><span class="ident" id="4005427">Listen</span><span class="op" id="4005433">(</span><span class="ident" id="4005434">network</span><span class="op" id="4005441">,</span>&nbsp;<span class="ident" id="4005443">laddr</span><span class="op" id="4005448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4005451">if</span>&nbsp;<span class="ident" id="4005454">err</span>&nbsp;<span class="op" id="4005458">!=</span>&nbsp;<span class="ident" id="4005461">nil</span>&nbsp;<span class="op" id="4005465">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4005469">return</span>&nbsp;<span class="ident" id="4005476">nil</span><span class="op" id="4005479">,</span>&nbsp;<span class="ident" id="4005481">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4005486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4005489">return</span>&nbsp;<span class="ident" id="4005496">NewListener</span><span class="op" id="4005507">(</span><span class="ident" id="4005508">l</span><span class="op" id="4005509">,</span>&nbsp;<span class="ident" id="4005511">config</span><span class="op" id="4005517">)</span><span class="op" id="4005518">,</span>&nbsp;<span class="ident" id="4005520">nil</span><br>
<span class="lineno"></span><span class="op" id="4005524">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="4005527">type</span>&nbsp;<span class="ident" id="4005532">timeoutError</span>&nbsp;<span class="keyword" id="4005545">struct</span><span class="op" id="4005551">{</span><span class="op" id="4005552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4005555">func</span>&nbsp;<span class="op" id="4005560">(</span><span class="ident" id="4005561">timeoutError</span><span class="op" id="4005573">)</span>&nbsp;<span class="ident" id="4005575">Error</span><span class="op" id="4005580">(</span><span class="op" id="4005581">)</span>&nbsp;<span class="builtintype" id="4005583">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4005592">{</span>&nbsp;<span class="keyword" id="4005594">return</span>&nbsp;<span class="string" id="4005601">&#34;tls:&nbsp;DialWithDialer&nbsp;timed&nbsp;out&#34;</span>&nbsp;<span class="op" id="4005633">}</span><br>
<span class="lineno"></span><span class="keyword" id="4005635">func</span>&nbsp;<span class="op" id="4005640">(</span><span class="ident" id="4005641">timeoutError</span><span class="op" id="4005653">)</span>&nbsp;<span class="ident" id="4005655">Timeout</span><span class="op" id="4005662">(</span><span class="op" id="4005663">)</span>&nbsp;<span class="builtintype" id="4005665">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4005672">{</span>&nbsp;<span class="keyword" id="4005674">return</span>&nbsp;<span class="builtintype" id="4005681">true</span>&nbsp;<span class="op" id="4005686">}</span><br>
<span class="lineno"></span><span class="keyword" id="4005688">func</span>&nbsp;<span class="op" id="4005693">(</span><span class="ident" id="4005694">timeoutError</span><span class="op" id="4005706">)</span>&nbsp;<span class="ident" id="4005708">Temporary</span><span class="op" id="4005717">(</span><span class="op" id="4005718">)</span>&nbsp;<span class="builtintype" id="4005720">bool</span>&nbsp;<span class="op" id="4005725">{</span>&nbsp;<span class="keyword" id="4005727">return</span>&nbsp;<span class="builtintype" id="4005734">true</span>&nbsp;<span class="op" id="4005739">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="4005742">//&nbsp;DialWithDialer&nbsp;connects&nbsp;to&nbsp;the&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;dialer.Dial&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4005820">//&nbsp;then&nbsp;initiates&nbsp;a&nbsp;TLS&nbsp;handshake,&nbsp;returning&nbsp;the&nbsp;resulting&nbsp;TLS&nbsp;connection.&nbsp;Any</span><br>
<span class="lineno"></span><span class="comment" id="4005899">//&nbsp;timeout&nbsp;or&nbsp;deadline&nbsp;given&nbsp;in&nbsp;the&nbsp;dialer&nbsp;apply&nbsp;to&nbsp;connection&nbsp;and&nbsp;TLS</span><br>
<span class="lineno"></span><span class="comment" id="4005970">//&nbsp;handshake&nbsp;as&nbsp;a&nbsp;whole.</span><br>
<span class="lineno">90</span><span class="comment" id="4005995">//</span><br>
<span class="lineno"></span><span class="comment" id="4005998">//&nbsp;DialWithDialer&nbsp;interprets&nbsp;a&nbsp;nil&nbsp;configuration&nbsp;as&nbsp;equivalent&nbsp;to&nbsp;the&nbsp;zero</span><br>
<span class="lineno"></span><span class="comment" id="4006073">//&nbsp;configuration;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;of&nbsp;Config&nbsp;for&nbsp;the&nbsp;defaults.</span><br>
<span class="lineno"></span><span class="keyword" id="4006141">func</span>&nbsp;<span class="ident" id="4006146">DialWithDialer</span><span class="op" id="4006160">(</span><span class="ident" id="4006161">dialer</span>&nbsp;<span class="op" id="4006168">*</span><span class="ident" id="4006169">net</span><span class="op" id="4006172">.</span><span class="ident" id="4006173">Dialer</span><span class="op" id="4006179">,</span>&nbsp;<span class="ident" id="4006181">network</span><span class="op" id="4006188">,</span>&nbsp;<span class="ident" id="4006190">addr</span>&nbsp;<span class="builtintype" id="4006195">string</span><span class="op" id="4006201">,</span>&nbsp;<span class="ident" id="4006203">config</span>&nbsp;<span class="op" id="4006210">*</span><span class="ident" id="4006211">Config</span><span class="op" id="4006217">)</span>&nbsp;<span class="op" id="4006219">(</span><span class="op" id="4006220">*</span><span class="ident" id="4006221">Conn</span><span class="op" id="4006225">,</span>&nbsp;<span class="builtintype" id="4006227">error</span><span class="op" id="4006232">)</span>&nbsp;<span class="op" id="4006234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4006237">//&nbsp;We&nbsp;want&nbsp;the&nbsp;Timeout&nbsp;and&nbsp;Deadline&nbsp;values&nbsp;from&nbsp;dialer&nbsp;to&nbsp;cover&nbsp;the</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4006306">//&nbsp;whole&nbsp;process:&nbsp;TCP&nbsp;connection&nbsp;and&nbsp;TLS&nbsp;handshake.&nbsp;This&nbsp;means&nbsp;that&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4006378">//&nbsp;also&nbsp;need&nbsp;to&nbsp;start&nbsp;our&nbsp;own&nbsp;timers&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4006421">timeout</span>&nbsp;<span class="op" id="4006429">:=</span>&nbsp;<span class="ident" id="4006432">dialer</span><span class="op" id="4006438">.</span><span class="ident" id="4006439">Timeout</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4006449">if</span>&nbsp;<span class="op" id="4006452">!</span><span class="ident" id="4006453">dialer</span><span class="op" id="4006459">.</span><span class="ident" id="4006460">Deadline</span><span class="op" id="4006468">.</span><span class="ident" id="4006469">IsZero</span><span class="op" id="4006475">(</span><span class="op" id="4006476">)</span>&nbsp;<span class="op" id="4006478">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4006482">deadlineTimeout</span>&nbsp;<span class="op" id="4006498">:=</span>&nbsp;<span class="ident" id="4006501">dialer</span><span class="op" id="4006507">.</span><span class="ident" id="4006508">Deadline</span><span class="op" id="4006516">.</span><span class="ident" id="4006517">Sub</span><span class="op" id="4006520">(</span><span class="ident" id="4006521">time</span><span class="op" id="4006525">.</span><span class="ident" id="4006526">Now</span><span class="op" id="4006529">(</span><span class="op" id="4006530">)</span><span class="op" id="4006531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4006535">if</span>&nbsp;<span class="ident" id="4006538">timeout</span>&nbsp;<span class="op" id="4006546">==</span>&nbsp;<span class="num" id="4006549">0</span>&nbsp;<span class="op" id="4006551">||</span>&nbsp;<span class="ident" id="4006554">deadlineTimeout</span>&nbsp;<span class="op" id="4006570">&lt;</span>&nbsp;<span class="ident" id="4006572">timeout</span>&nbsp;<span class="op" id="4006580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4006585">timeout</span>&nbsp;<span class="op" id="4006593">=</span>&nbsp;<span class="ident" id="4006595">deadlineTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4006613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4006616">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4006620">var</span>&nbsp;<span class="ident" id="4006624">errChannel</span>&nbsp;<span class="keyword" id="4006635">chan</span>&nbsp;<span class="builtintype" id="4006640">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4006648">if</span>&nbsp;<span class="ident" id="4006651">timeout</span>&nbsp;<span class="op" id="4006659">!=</span>&nbsp;<span class="num" id="4006662">0</span>&nbsp;<span class="op" id="4006664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4006668">errChannel</span>&nbsp;<span class="op" id="4006679">=</span>&nbsp;<span class="builtinfunc" id="4006681">make</span><span class="op" id="4006685">(</span><span class="keyword" id="4006686">chan</span>&nbsp;<span class="builtintype" id="4006691">error</span><span class="op" id="4006696">,</span>&nbsp;<span class="num" id="4006698">2</span><span class="op" id="4006699">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4006703">time</span><span class="op" id="4006707">.</span><span class="ident" id="4006708">AfterFunc</span><span class="op" id="4006717">(</span><span class="ident" id="4006718">timeout</span><span class="op" id="4006725">,</span>&nbsp;<span class="keyword" id="4006727">func</span><span class="op" id="4006731">(</span><span class="op" id="4006732">)</span>&nbsp;<span class="op" id="4006734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4006739">errChannel</span>&nbsp;<span class="op" id="4006750">&lt;-</span>&nbsp;<span class="ident" id="4006753">timeoutError</span><span class="op" id="4006765">{</span><span class="op" id="4006766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4006770">}</span><span class="op" id="4006771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4006774">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4006778">rawConn</span><span class="op" id="4006785">,</span>&nbsp;<span class="ident" id="4006787">err</span>&nbsp;<span class="op" id="4006791">:=</span>&nbsp;<span class="ident" id="4006794">dialer</span><span class="op" id="4006800">.</span><span class="ident" id="4006801">Dial</span><span class="op" id="4006805">(</span><span class="ident" id="4006806">network</span><span class="op" id="4006813">,</span>&nbsp;<span class="ident" id="4006815">addr</span><span class="op" id="4006819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4006822">if</span>&nbsp;<span class="ident" id="4006825">err</span>&nbsp;<span class="op" id="4006829">!=</span>&nbsp;<span class="ident" id="4006832">nil</span>&nbsp;<span class="op" id="4006836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4006840">return</span>&nbsp;<span class="ident" id="4006847">nil</span><span class="op" id="4006850">,</span>&nbsp;<span class="ident" id="4006852">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4006857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4006861">colonPos</span>&nbsp;<span class="op" id="4006870">:=</span>&nbsp;<span class="ident" id="4006873">strings</span><span class="op" id="4006880">.</span><span class="ident" id="4006881">LastIndex</span><span class="op" id="4006890">(</span><span class="ident" id="4006891">addr</span><span class="op" id="4006895">,</span>&nbsp;<span class="string" id="4006897">&#34;:&#34;</span><span class="op" id="4006900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4006903">if</span>&nbsp;<span class="ident" id="4006906">colonPos</span>&nbsp;<span class="op" id="4006915">==</span>&nbsp;<span class="op" id="4006918">-</span><span class="num" id="4006919">1</span>&nbsp;<span class="op" id="4006921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4006925">colonPos</span>&nbsp;<span class="op" id="4006934">=</span>&nbsp;<span class="builtinfunc" id="4006936">len</span><span class="op" id="4006939">(</span><span class="ident" id="4006940">addr</span><span class="op" id="4006944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4006947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4006950">hostname</span>&nbsp;<span class="op" id="4006959">:=</span>&nbsp;<span class="ident" id="4006962">addr</span><span class="op" id="4006966">[</span><span class="op" id="4006967">:</span><span class="ident" id="4006968">colonPos</span><span class="op" id="4006976">]</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4006980">if</span>&nbsp;<span class="ident" id="4006983">config</span>&nbsp;<span class="op" id="4006990">==</span>&nbsp;<span class="ident" id="4006993">nil</span>&nbsp;<span class="op" id="4006997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4007001">config</span>&nbsp;<span class="op" id="4007008">=</span>&nbsp;<span class="ident" id="4007010">defaultConfig</span><span class="op" id="4007023">(</span><span class="op" id="4007024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4007027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4007030">//&nbsp;If&nbsp;no&nbsp;ServerName&nbsp;is&nbsp;set,&nbsp;infer&nbsp;the&nbsp;ServerName</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4007080">//&nbsp;from&nbsp;the&nbsp;hostname&nbsp;we&#39;re&nbsp;connecting&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4007123">if</span>&nbsp;<span class="ident" id="4007126">config</span><span class="op" id="4007132">.</span><span class="ident" id="4007133">ServerName</span>&nbsp;<span class="op" id="4007144">==</span>&nbsp;<span class="string" id="4007147">&#34;&#34;</span>&nbsp;<span class="op" id="4007150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4007154">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;to&nbsp;avoid&nbsp;polluting&nbsp;argument&nbsp;or&nbsp;default.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4007211">c</span>&nbsp;<span class="op" id="4007213">:=</span>&nbsp;<span class="op" id="4007216">*</span><span class="ident" id="4007217">config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4007226">c</span><span class="op" id="4007227">.</span><span class="ident" id="4007228">ServerName</span>&nbsp;<span class="op" id="4007239">=</span>&nbsp;<span class="ident" id="4007241">hostname</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4007252">config</span>&nbsp;<span class="op" id="4007259">=</span>&nbsp;<span class="op" id="4007261">&amp;</span><span class="ident" id="4007262">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4007265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4007269">conn</span>&nbsp;<span class="op" id="4007274">:=</span>&nbsp;<span class="ident" id="4007277">Client</span><span class="op" id="4007283">(</span><span class="ident" id="4007284">rawConn</span><span class="op" id="4007291">,</span>&nbsp;<span class="ident" id="4007293">config</span><span class="op" id="4007299">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4007303">if</span>&nbsp;<span class="ident" id="4007306">timeout</span>&nbsp;<span class="op" id="4007314">==</span>&nbsp;<span class="num" id="4007317">0</span>&nbsp;<span class="op" id="4007319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4007323">err</span>&nbsp;<span class="op" id="4007327">=</span>&nbsp;<span class="ident" id="4007329">conn</span><span class="op" id="4007333">.</span><span class="ident" id="4007334">Handshake</span><span class="op" id="4007343">(</span><span class="op" id="4007344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4007347">}</span>&nbsp;<span class="keyword" id="4007349">else</span>&nbsp;<span class="op" id="4007354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4007358">go</span>&nbsp;<span class="keyword" id="4007361">func</span><span class="op" id="4007365">(</span><span class="op" id="4007366">)</span>&nbsp;<span class="op" id="4007368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4007373">errChannel</span>&nbsp;<span class="op" id="4007384">&lt;-</span>&nbsp;<span class="ident" id="4007387">conn</span><span class="op" id="4007391">.</span><span class="ident" id="4007392">Handshake</span><span class="op" id="4007401">(</span><span class="op" id="4007402">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4007406">}</span><span class="op" id="4007407">(</span><span class="op" id="4007408">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4007413">err</span>&nbsp;<span class="op" id="4007417">=</span>&nbsp;<span class="op" id="4007419">&lt;-</span><span class="ident" id="4007421">errChannel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4007433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4007437">if</span>&nbsp;<span class="ident" id="4007440">err</span>&nbsp;<span class="op" id="4007444">!=</span>&nbsp;<span class="ident" id="4007447">nil</span>&nbsp;<span class="op" id="4007451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4007455">rawConn</span><span class="op" id="4007462">.</span><span class="ident" id="4007463">Close</span><span class="op" id="4007468">(</span><span class="op" id="4007469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4007473">return</span>&nbsp;<span class="ident" id="4007480">nil</span><span class="op" id="4007483">,</span>&nbsp;<span class="ident" id="4007485">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4007490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4007494">return</span>&nbsp;<span class="ident" id="4007501">conn</span><span class="op" id="4007505">,</span>&nbsp;<span class="ident" id="4007507">nil</span><br>
<span class="lineno"></span><span class="op" id="4007511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4007514">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;the&nbsp;given&nbsp;network&nbsp;address&nbsp;using&nbsp;net.Dial</span><br>
<span class="lineno"></span><span class="comment" id="4007575">//&nbsp;and&nbsp;then&nbsp;initiates&nbsp;a&nbsp;TLS&nbsp;handshake,&nbsp;returning&nbsp;the&nbsp;resulting</span><br>
<span class="lineno">160</span><span class="comment" id="4007638">//&nbsp;TLS&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4007657">//&nbsp;Dial&nbsp;interprets&nbsp;a&nbsp;nil&nbsp;configuration&nbsp;as&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4007713">//&nbsp;the&nbsp;zero&nbsp;configuration;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;of&nbsp;Config</span><br>
<span class="lineno"></span><span class="comment" id="4007772">//&nbsp;for&nbsp;the&nbsp;defaults.</span><br>
<span class="lineno"></span><span class="keyword" id="4007793">func</span>&nbsp;<span class="ident" id="4007798">Dial</span><span class="op" id="4007802">(</span><span class="ident" id="4007803">network</span><span class="op" id="4007810">,</span>&nbsp;<span class="ident" id="4007812">addr</span>&nbsp;<span class="builtintype" id="4007817">string</span><span class="op" id="4007823">,</span>&nbsp;<span class="ident" id="4007825">config</span>&nbsp;<span class="op" id="4007832">*</span><span class="ident" id="4007833">Config</span><span class="op" id="4007839">)</span>&nbsp;<span class="op" id="4007841">(</span><span class="op" id="4007842">*</span><span class="ident" id="4007843">Conn</span><span class="op" id="4007847">,</span>&nbsp;<span class="builtintype" id="4007849">error</span><span class="op" id="4007854">)</span>&nbsp;<span class="op" id="4007856">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4007859">return</span>&nbsp;<span class="ident" id="4007866">DialWithDialer</span><span class="op" id="4007880">(</span><span class="builtinfunc" id="4007881">new</span><span class="op" id="4007884">(</span><span class="ident" id="4007885">net</span><span class="op" id="4007888">.</span><span class="ident" id="4007889">Dialer</span><span class="op" id="4007895">)</span><span class="op" id="4007896">,</span>&nbsp;<span class="ident" id="4007898">network</span><span class="op" id="4007905">,</span>&nbsp;<span class="ident" id="4007907">addr</span><span class="op" id="4007911">,</span>&nbsp;<span class="ident" id="4007913">config</span><span class="op" id="4007919">)</span><br>
<span class="lineno"></span><span class="op" id="4007921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4007924">//&nbsp;LoadX509KeyPair&nbsp;reads&nbsp;and&nbsp;parses&nbsp;a&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;from&nbsp;a&nbsp;pair&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4008001">//&nbsp;files.&nbsp;The&nbsp;files&nbsp;must&nbsp;contain&nbsp;PEM&nbsp;encoded&nbsp;data.</span><br>
<span class="lineno">170</span><span class="keyword" id="4008052">func</span>&nbsp;<span class="ident" id="4008057">LoadX509KeyPair</span><span class="op" id="4008072">(</span><span class="ident" id="4008073">certFile</span><span class="op" id="4008081">,</span>&nbsp;<span class="ident" id="4008083">keyFile</span>&nbsp;<span class="builtintype" id="4008091">string</span><span class="op" id="4008097">)</span>&nbsp;<span class="op" id="4008099">(</span><span class="ident" id="4008100">cert</span>&nbsp;<span class="ident" id="4008105">Certificate</span><span class="op" id="4008116">,</span>&nbsp;<span class="ident" id="4008118">err</span>&nbsp;<span class="builtintype" id="4008122">error</span><span class="op" id="4008127">)</span>&nbsp;<span class="op" id="4008129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4008132">certPEMBlock</span><span class="op" id="4008144">,</span>&nbsp;<span class="ident" id="4008146">err</span>&nbsp;<span class="op" id="4008150">:=</span>&nbsp;<span class="ident" id="4008153">ioutil</span><span class="op" id="4008159">.</span><span class="ident" id="4008160">ReadFile</span><span class="op" id="4008168">(</span><span class="ident" id="4008169">certFile</span><span class="op" id="4008177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4008180">if</span>&nbsp;<span class="ident" id="4008183">err</span>&nbsp;<span class="op" id="4008187">!=</span>&nbsp;<span class="ident" id="4008190">nil</span>&nbsp;<span class="op" id="4008194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4008198">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4008206">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4008209">keyPEMBlock</span><span class="op" id="4008220">,</span>&nbsp;<span class="ident" id="4008222">err</span>&nbsp;<span class="op" id="4008226">:=</span>&nbsp;<span class="ident" id="4008229">ioutil</span><span class="op" id="4008235">.</span><span class="ident" id="4008236">ReadFile</span><span class="op" id="4008244">(</span><span class="ident" id="4008245">keyFile</span><span class="op" id="4008252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4008255">if</span>&nbsp;<span class="ident" id="4008258">err</span>&nbsp;<span class="op" id="4008262">!=</span>&nbsp;<span class="ident" id="4008265">nil</span>&nbsp;<span class="op" id="4008269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4008273">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4008281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4008284">return</span>&nbsp;<span class="ident" id="4008291">X509KeyPair</span><span class="op" id="4008302">(</span><span class="ident" id="4008303">certPEMBlock</span><span class="op" id="4008315">,</span>&nbsp;<span class="ident" id="4008317">keyPEMBlock</span><span class="op" id="4008328">)</span><br>
<span class="lineno">180</span><span class="op" id="4008330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4008333">//&nbsp;X509KeyPair&nbsp;parses&nbsp;a&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;from&nbsp;a&nbsp;pair&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4008396">//&nbsp;PEM&nbsp;encoded&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="4008417">func</span>&nbsp;<span class="ident" id="4008422">X509KeyPair</span><span class="op" id="4008433">(</span><span class="ident" id="4008434">certPEMBlock</span><span class="op" id="4008446">,</span>&nbsp;<span class="ident" id="4008448">keyPEMBlock</span>&nbsp;<span class="op" id="4008460">[</span><span class="op" id="4008461">]</span><span class="builtintype" id="4008462">byte</span><span class="op" id="4008466">)</span>&nbsp;<span class="op" id="4008468">(</span><span class="ident" id="4008469">cert</span>&nbsp;<span class="ident" id="4008474">Certificate</span><span class="op" id="4008485">,</span>&nbsp;<span class="ident" id="4008487">err</span>&nbsp;<span class="builtintype" id="4008491">error</span><span class="op" id="4008496">)</span>&nbsp;<span class="op" id="4008498">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4008501">var</span>&nbsp;<span class="ident" id="4008505">certDERBlock</span>&nbsp;<span class="op" id="4008518">*</span><span class="ident" id="4008519">pem</span><span class="op" id="4008522">.</span><span class="ident" id="4008523">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4008530">for</span>&nbsp;<span class="op" id="4008534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4008538">certDERBlock</span><span class="op" id="4008550">,</span>&nbsp;<span class="ident" id="4008552">certPEMBlock</span>&nbsp;<span class="op" id="4008565">=</span>&nbsp;<span class="ident" id="4008567">pem</span><span class="op" id="4008570">.</span><span class="ident" id="4008571">Decode</span><span class="op" id="4008577">(</span><span class="ident" id="4008578">certPEMBlock</span><span class="op" id="4008590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4008594">if</span>&nbsp;<span class="ident" id="4008597">certDERBlock</span>&nbsp;<span class="op" id="4008610">==</span>&nbsp;<span class="ident" id="4008613">nil</span>&nbsp;<span class="op" id="4008617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4008622">break</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4008630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4008634">if</span>&nbsp;<span class="ident" id="4008637">certDERBlock</span><span class="op" id="4008649">.</span><span class="ident" id="4008650">Type</span>&nbsp;<span class="op" id="4008655">==</span>&nbsp;<span class="string" id="4008658">&#34;CERTIFICATE&#34;</span>&nbsp;<span class="op" id="4008672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4008677">cert</span><span class="op" id="4008681">.</span><span class="ident" id="4008682">Certificate</span>&nbsp;<span class="op" id="4008694">=</span>&nbsp;<span class="builtinfunc" id="4008696">append</span><span class="op" id="4008702">(</span><span class="ident" id="4008703">cert</span><span class="op" id="4008707">.</span><span class="ident" id="4008708">Certificate</span><span class="op" id="4008719">,</span>&nbsp;<span class="ident" id="4008721">certDERBlock</span><span class="op" id="4008733">.</span><span class="ident" id="4008734">Bytes</span><span class="op" id="4008739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4008743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4008746">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4008750">if</span>&nbsp;<span class="builtinfunc" id="4008753">len</span><span class="op" id="4008756">(</span><span class="ident" id="4008757">cert</span><span class="op" id="4008761">.</span><span class="ident" id="4008762">Certificate</span><span class="op" id="4008773">)</span>&nbsp;<span class="op" id="4008775">==</span>&nbsp;<span class="num" id="4008778">0</span>&nbsp;<span class="op" id="4008780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4008784">err</span>&nbsp;<span class="op" id="4008788">=</span>&nbsp;<span class="ident" id="4008790">errors</span><span class="op" id="4008796">.</span><span class="ident" id="4008797">New</span><span class="op" id="4008800">(</span><span class="string" id="4008801">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;PEM&nbsp;data&#34;</span><span class="op" id="4008851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4008855">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4008863">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4008867">var</span>&nbsp;<span class="ident" id="4008871">keyDERBlock</span>&nbsp;<span class="op" id="4008883">*</span><span class="ident" id="4008884">pem</span><span class="op" id="4008887">.</span><span class="ident" id="4008888">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4008895">for</span>&nbsp;<span class="op" id="4008899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4008903">keyDERBlock</span><span class="op" id="4008914">,</span>&nbsp;<span class="ident" id="4008916">keyPEMBlock</span>&nbsp;<span class="op" id="4008928">=</span>&nbsp;<span class="ident" id="4008930">pem</span><span class="op" id="4008933">.</span><span class="ident" id="4008934">Decode</span><span class="op" id="4008940">(</span><span class="ident" id="4008941">keyPEMBlock</span><span class="op" id="4008952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4008956">if</span>&nbsp;<span class="ident" id="4008959">keyDERBlock</span>&nbsp;<span class="op" id="4008971">==</span>&nbsp;<span class="ident" id="4008974">nil</span>&nbsp;<span class="op" id="4008978">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4008983">err</span>&nbsp;<span class="op" id="4008987">=</span>&nbsp;<span class="ident" id="4008989">errors</span><span class="op" id="4008995">.</span><span class="ident" id="4008996">New</span><span class="op" id="4008999">(</span><span class="string" id="4009000">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;key&nbsp;PEM&nbsp;data&#34;</span><span class="op" id="4009042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4009047">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4009056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4009060">if</span>&nbsp;<span class="ident" id="4009063">keyDERBlock</span><span class="op" id="4009074">.</span><span class="ident" id="4009075">Type</span>&nbsp;<span class="op" id="4009080">==</span>&nbsp;<span class="string" id="4009083">&#34;PRIVATE&nbsp;KEY&#34;</span>&nbsp;<span class="op" id="4009097">||</span>&nbsp;<span class="ident" id="4009100">strings</span><span class="op" id="4009107">.</span><span class="ident" id="4009108">HasSuffix</span><span class="op" id="4009117">(</span><span class="ident" id="4009118">keyDERBlock</span><span class="op" id="4009129">.</span><span class="ident" id="4009130">Type</span><span class="op" id="4009134">,</span>&nbsp;<span class="string" id="4009136">&#34;&nbsp;PRIVATE&nbsp;KEY&#34;</span><span class="op" id="4009150">)</span>&nbsp;<span class="op" id="4009152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4009157">break</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4009165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4009168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4009172">cert</span><span class="op" id="4009176">.</span><span class="ident" id="4009177">PrivateKey</span><span class="op" id="4009187">,</span>&nbsp;<span class="ident" id="4009189">err</span>&nbsp;<span class="op" id="4009193">=</span>&nbsp;<span class="ident" id="4009195">parsePrivateKey</span><span class="op" id="4009210">(</span><span class="ident" id="4009211">keyDERBlock</span><span class="op" id="4009222">.</span><span class="ident" id="4009223">Bytes</span><span class="op" id="4009228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4009231">if</span>&nbsp;<span class="ident" id="4009234">err</span>&nbsp;<span class="op" id="4009238">!=</span>&nbsp;<span class="ident" id="4009241">nil</span>&nbsp;<span class="op" id="4009245">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4009249">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4009257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4009261">//&nbsp;We&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;parse&nbsp;the&nbsp;public&nbsp;key&nbsp;for&nbsp;TLS,&nbsp;but&nbsp;we&nbsp;so&nbsp;do&nbsp;anyway</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4009332">//&nbsp;to&nbsp;check&nbsp;that&nbsp;it&nbsp;looks&nbsp;sane&nbsp;and&nbsp;matches&nbsp;the&nbsp;private&nbsp;key.</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4009393">x509Cert</span><span class="op" id="4009401">,</span>&nbsp;<span class="ident" id="4009403">err</span>&nbsp;<span class="op" id="4009407">:=</span>&nbsp;<span class="ident" id="4009410">x509</span><span class="op" id="4009414">.</span><span class="ident" id="4009415">ParseCertificate</span><span class="op" id="4009431">(</span><span class="ident" id="4009432">cert</span><span class="op" id="4009436">.</span><span class="ident" id="4009437">Certificate</span><span class="op" id="4009448">[</span><span class="num" id="4009449">0</span><span class="op" id="4009450">]</span><span class="op" id="4009451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4009454">if</span>&nbsp;<span class="ident" id="4009457">err</span>&nbsp;<span class="op" id="4009461">!=</span>&nbsp;<span class="ident" id="4009464">nil</span>&nbsp;<span class="op" id="4009468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4009472">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4009480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4009484">switch</span>&nbsp;<span class="ident" id="4009491">pub</span>&nbsp;<span class="op" id="4009495">:=</span>&nbsp;<span class="ident" id="4009498">x509Cert</span><span class="op" id="4009506">.</span><span class="ident" id="4009507">PublicKey</span><span class="op" id="4009516">.</span><span class="op" id="4009517">(</span><span class="keyword" id="4009518">type</span><span class="op" id="4009522">)</span>&nbsp;<span class="op" id="4009524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4009527">case</span>&nbsp;<span class="op" id="4009532">*</span><span class="ident" id="4009533">rsa</span><span class="op" id="4009536">.</span><span class="ident" id="4009537">PublicKey</span><span class="op" id="4009546">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4009550">priv</span><span class="op" id="4009554">,</span>&nbsp;<span class="ident" id="4009556">ok</span>&nbsp;<span class="op" id="4009559">:=</span>&nbsp;<span class="ident" id="4009562">cert</span><span class="op" id="4009566">.</span><span class="ident" id="4009567">PrivateKey</span><span class="op" id="4009577">.</span><span class="op" id="4009578">(</span><span class="op" id="4009579">*</span><span class="ident" id="4009580">rsa</span><span class="op" id="4009583">.</span><span class="ident" id="4009584">PrivateKey</span><span class="op" id="4009594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4009598">if</span>&nbsp;<span class="op" id="4009601">!</span><span class="ident" id="4009602">ok</span>&nbsp;<span class="op" id="4009605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4009610">err</span>&nbsp;<span class="op" id="4009614">=</span>&nbsp;<span class="ident" id="4009616">errors</span><span class="op" id="4009622">.</span><span class="ident" id="4009623">New</span><span class="op" id="4009626">(</span><span class="string" id="4009627">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;type&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&nbsp;type&#34;</span><span class="op" id="4009688">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4009693">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4009702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4009706">if</span>&nbsp;<span class="ident" id="4009709">pub</span><span class="op" id="4009712">.</span><span class="ident" id="4009713">N</span><span class="op" id="4009714">.</span><span class="ident" id="4009715">Cmp</span><span class="op" id="4009718">(</span><span class="ident" id="4009719">priv</span><span class="op" id="4009723">.</span><span class="ident" id="4009724">N</span><span class="op" id="4009725">)</span>&nbsp;<span class="op" id="4009727">!=</span>&nbsp;<span class="num" id="4009730">0</span>&nbsp;<span class="op" id="4009732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4009737">err</span>&nbsp;<span class="op" id="4009741">=</span>&nbsp;<span class="ident" id="4009743">errors</span><span class="op" id="4009749">.</span><span class="ident" id="4009750">New</span><span class="op" id="4009753">(</span><span class="string" id="4009754">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&#34;</span><span class="op" id="4009805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4009810">return</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4009819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4009822">case</span>&nbsp;<span class="op" id="4009827">*</span><span class="ident" id="4009828">ecdsa</span><span class="op" id="4009833">.</span><span class="ident" id="4009834">PublicKey</span><span class="op" id="4009843">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4009847">priv</span><span class="op" id="4009851">,</span>&nbsp;<span class="ident" id="4009853">ok</span>&nbsp;<span class="op" id="4009856">:=</span>&nbsp;<span class="ident" id="4009859">cert</span><span class="op" id="4009863">.</span><span class="ident" id="4009864">PrivateKey</span><span class="op" id="4009874">.</span><span class="op" id="4009875">(</span><span class="op" id="4009876">*</span><span class="ident" id="4009877">ecdsa</span><span class="op" id="4009882">.</span><span class="ident" id="4009883">PrivateKey</span><span class="op" id="4009893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4009897">if</span>&nbsp;<span class="op" id="4009900">!</span><span class="ident" id="4009901">ok</span>&nbsp;<span class="op" id="4009904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4009909">err</span>&nbsp;<span class="op" id="4009913">=</span>&nbsp;<span class="ident" id="4009915">errors</span><span class="op" id="4009921">.</span><span class="ident" id="4009922">New</span><span class="op" id="4009925">(</span><span class="string" id="4009926">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;type&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&nbsp;type&#34;</span><span class="op" id="4009987">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4009992">return</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4010002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010006">if</span>&nbsp;<span class="ident" id="4010009">pub</span><span class="op" id="4010012">.</span><span class="ident" id="4010013">X</span><span class="op" id="4010014">.</span><span class="ident" id="4010015">Cmp</span><span class="op" id="4010018">(</span><span class="ident" id="4010019">priv</span><span class="op" id="4010023">.</span><span class="ident" id="4010024">X</span><span class="op" id="4010025">)</span>&nbsp;<span class="op" id="4010027">!=</span>&nbsp;<span class="num" id="4010030">0</span>&nbsp;<span class="op" id="4010032">||</span>&nbsp;<span class="ident" id="4010035">pub</span><span class="op" id="4010038">.</span><span class="ident" id="4010039">Y</span><span class="op" id="4010040">.</span><span class="ident" id="4010041">Cmp</span><span class="op" id="4010044">(</span><span class="ident" id="4010045">priv</span><span class="op" id="4010049">.</span><span class="ident" id="4010050">Y</span><span class="op" id="4010051">)</span>&nbsp;<span class="op" id="4010053">!=</span>&nbsp;<span class="num" id="4010056">0</span>&nbsp;<span class="op" id="4010058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4010063">err</span>&nbsp;<span class="op" id="4010067">=</span>&nbsp;<span class="ident" id="4010069">errors</span><span class="op" id="4010075">.</span><span class="ident" id="4010076">New</span><span class="op" id="4010079">(</span><span class="string" id="4010080">&#34;crypto/tls:&nbsp;private&nbsp;key&nbsp;does&nbsp;not&nbsp;match&nbsp;public&nbsp;key&#34;</span><span class="op" id="4010131">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010136">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4010145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010148">default</span><span class="op" id="4010155">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4010159">err</span>&nbsp;<span class="op" id="4010163">=</span>&nbsp;<span class="ident" id="4010165">errors</span><span class="op" id="4010171">.</span><span class="ident" id="4010172">New</span><span class="op" id="4010175">(</span><span class="string" id="4010176">&#34;crypto/tls:&nbsp;unknown&nbsp;public&nbsp;key&nbsp;algorithm&#34;</span><span class="op" id="4010218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010222">return</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4010230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010234">return</span><br>
<span class="lineno"></span><span class="op" id="4010241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="4010244">//&nbsp;Attempt&nbsp;to&nbsp;parse&nbsp;the&nbsp;given&nbsp;private&nbsp;key&nbsp;DER&nbsp;block.&nbsp;OpenSSL&nbsp;0.9.8&nbsp;generates</span><br>
<span class="lineno"></span><span class="comment" id="4010321">//&nbsp;PKCS#1&nbsp;private&nbsp;keys&nbsp;by&nbsp;default,&nbsp;while&nbsp;OpenSSL&nbsp;1.0.0&nbsp;generates&nbsp;PKCS#8&nbsp;keys.</span><br>
<span class="lineno"></span><span class="comment" id="4010399">//&nbsp;OpenSSL&nbsp;ecparam&nbsp;generates&nbsp;SEC1&nbsp;EC&nbsp;private&nbsp;keys&nbsp;for&nbsp;ECDSA.&nbsp;We&nbsp;try&nbsp;all&nbsp;three.</span><br>
<span class="lineno"></span><span class="keyword" id="4010478">func</span>&nbsp;<span class="ident" id="4010483">parsePrivateKey</span><span class="op" id="4010498">(</span><span class="ident" id="4010499">der</span>&nbsp;<span class="op" id="4010503">[</span><span class="op" id="4010504">]</span><span class="builtintype" id="4010505">byte</span><span class="op" id="4010509">)</span>&nbsp;<span class="op" id="4010511">(</span><span class="ident" id="4010512">crypto</span><span class="op" id="4010518">.</span><span class="ident" id="4010519">PrivateKey</span><span class="op" id="4010529">,</span>&nbsp;<span class="builtintype" id="4010531">error</span><span class="op" id="4010536">)</span>&nbsp;<span class="op" id="4010538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010541">if</span>&nbsp;<span class="ident" id="4010544">key</span><span class="op" id="4010547">,</span>&nbsp;<span class="ident" id="4010549">err</span>&nbsp;<span class="op" id="4010553">:=</span>&nbsp;<span class="ident" id="4010556">x509</span><span class="op" id="4010560">.</span><span class="ident" id="4010561">ParsePKCS1PrivateKey</span><span class="op" id="4010581">(</span><span class="ident" id="4010582">der</span><span class="op" id="4010585">)</span><span class="op" id="4010586">;</span>&nbsp;<span class="ident" id="4010588">err</span>&nbsp;<span class="op" id="4010592">==</span>&nbsp;<span class="ident" id="4010595">nil</span>&nbsp;<span class="op" id="4010599">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010603">return</span>&nbsp;<span class="ident" id="4010610">key</span><span class="op" id="4010613">,</span>&nbsp;<span class="ident" id="4010615">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4010620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010623">if</span>&nbsp;<span class="ident" id="4010626">key</span><span class="op" id="4010629">,</span>&nbsp;<span class="ident" id="4010631">err</span>&nbsp;<span class="op" id="4010635">:=</span>&nbsp;<span class="ident" id="4010638">x509</span><span class="op" id="4010642">.</span><span class="ident" id="4010643">ParsePKCS8PrivateKey</span><span class="op" id="4010663">(</span><span class="ident" id="4010664">der</span><span class="op" id="4010667">)</span><span class="op" id="4010668">;</span>&nbsp;<span class="ident" id="4010670">err</span>&nbsp;<span class="op" id="4010674">==</span>&nbsp;<span class="ident" id="4010677">nil</span>&nbsp;<span class="op" id="4010681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010685">switch</span>&nbsp;<span class="ident" id="4010692">key</span>&nbsp;<span class="op" id="4010696">:=</span>&nbsp;<span class="ident" id="4010699">key</span><span class="op" id="4010702">.</span><span class="op" id="4010703">(</span><span class="keyword" id="4010704">type</span><span class="op" id="4010708">)</span>&nbsp;<span class="op" id="4010710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010714">case</span>&nbsp;<span class="op" id="4010719">*</span><span class="ident" id="4010720">rsa</span><span class="op" id="4010723">.</span><span class="ident" id="4010724">PrivateKey</span><span class="op" id="4010734">,</span>&nbsp;<span class="op" id="4010736">*</span><span class="ident" id="4010737">ecdsa</span><span class="op" id="4010742">.</span><span class="ident" id="4010743">PrivateKey</span><span class="op" id="4010753">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010758">return</span>&nbsp;<span class="ident" id="4010765">key</span><span class="op" id="4010768">,</span>&nbsp;<span class="ident" id="4010770">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010776">default</span><span class="op" id="4010783">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010788">return</span>&nbsp;<span class="ident" id="4010795">nil</span><span class="op" id="4010798">,</span>&nbsp;<span class="ident" id="4010800">errors</span><span class="op" id="4010806">.</span><span class="ident" id="4010807">New</span><span class="op" id="4010810">(</span><span class="string" id="4010811">&#34;crypto/tls:&nbsp;found&nbsp;unknown&nbsp;private&nbsp;key&nbsp;type&nbsp;in&nbsp;PKCS#8&nbsp;wrapping&#34;</span><span class="op" id="4010874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4010878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4010881">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010884">if</span>&nbsp;<span class="ident" id="4010887">key</span><span class="op" id="4010890">,</span>&nbsp;<span class="ident" id="4010892">err</span>&nbsp;<span class="op" id="4010896">:=</span>&nbsp;<span class="ident" id="4010899">x509</span><span class="op" id="4010903">.</span><span class="ident" id="4010904">ParseECPrivateKey</span><span class="op" id="4010921">(</span><span class="ident" id="4010922">der</span><span class="op" id="4010925">)</span><span class="op" id="4010926">;</span>&nbsp;<span class="ident" id="4010928">err</span>&nbsp;<span class="op" id="4010932">==</span>&nbsp;<span class="ident" id="4010935">nil</span>&nbsp;<span class="op" id="4010939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010943">return</span>&nbsp;<span class="ident" id="4010950">key</span><span class="op" id="4010953">,</span>&nbsp;<span class="ident" id="4010955">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4010960">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4010964">return</span>&nbsp;<span class="ident" id="4010971">nil</span><span class="op" id="4010974">,</span>&nbsp;<span class="ident" id="4010976">errors</span><span class="op" id="4010982">.</span><span class="ident" id="4010983">New</span><span class="op" id="4010986">(</span><span class="string" id="4010987">&#34;crypto/tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;private&nbsp;key&#34;</span><span class="op" id="4011028">)</span><br>
<span class="lineno">275</span><span class="op" id="4011030">}</span>
</div>
</body>
</html>
