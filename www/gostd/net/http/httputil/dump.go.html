<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6121767">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6121822">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6121876">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6121927">package</span>&nbsp;<span class="ident" id="6121935">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6121945">import</span>&nbsp;<span class="op" id="6121952">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6121955">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6121964">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6121973">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6121983">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6121990">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6121996">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6122009">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6122016">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6122028">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6122039">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6122050">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6122057">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="6122060">//&nbsp;One&nbsp;of&nbsp;the&nbsp;copies,&nbsp;say&nbsp;from&nbsp;b&nbsp;to&nbsp;r2,&nbsp;could&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using&nbsp;a&nbsp;more</span><br>
<span class="lineno"></span><span class="comment" id="6122133">//&nbsp;elaborate&nbsp;trick&nbsp;where&nbsp;the&nbsp;other&nbsp;copy&nbsp;is&nbsp;made&nbsp;during&nbsp;Request/Response.Write.</span><br>
<span class="lineno"></span><span class="comment" id="6122212">//&nbsp;This&nbsp;would&nbsp;complicate&nbsp;things&nbsp;too&nbsp;much,&nbsp;given&nbsp;that&nbsp;these&nbsp;functions&nbsp;are&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6122289">//&nbsp;debugging&nbsp;only.</span><br>
<span class="lineno">25</span><span class="keyword" id="6122308">func</span>&nbsp;<span class="ident" id="6122313">drainBody</span><span class="op" id="6122322">(</span><span class="ident" id="6122323">b</span>&nbsp;<span class="ident" id="6122325">io</span><span class="op" id="6122327">.</span><span class="ident" id="6122328">ReadCloser</span><span class="op" id="6122338">)</span>&nbsp;<span class="op" id="6122340">(</span><span class="ident" id="6122341">r1</span><span class="op" id="6122343">,</span>&nbsp;<span class="ident" id="6122345">r2</span>&nbsp;<span class="ident" id="6122348">io</span><span class="op" id="6122350">.</span><span class="ident" id="6122351">ReadCloser</span><span class="op" id="6122361">,</span>&nbsp;<span class="ident" id="6122363">err</span>&nbsp;<span class="builtintype" id="6122367">error</span><span class="op" id="6122372">)</span>&nbsp;<span class="op" id="6122374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122377">var</span>&nbsp;<span class="ident" id="6122381">buf</span>&nbsp;<span class="ident" id="6122385">bytes</span><span class="op" id="6122390">.</span><span class="ident" id="6122391">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122399">if</span>&nbsp;<span class="ident" id="6122402">_</span><span class="op" id="6122403">,</span>&nbsp;<span class="ident" id="6122405">err</span>&nbsp;<span class="op" id="6122409">=</span>&nbsp;<span class="ident" id="6122411">buf</span><span class="op" id="6122414">.</span><span class="ident" id="6122415">ReadFrom</span><span class="op" id="6122423">(</span><span class="ident" id="6122424">b</span><span class="op" id="6122425">)</span><span class="op" id="6122426">;</span>&nbsp;<span class="ident" id="6122428">err</span>&nbsp;<span class="op" id="6122432">!=</span>&nbsp;<span class="ident" id="6122435">nil</span>&nbsp;<span class="op" id="6122439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122443">return</span>&nbsp;<span class="ident" id="6122450">nil</span><span class="op" id="6122453">,</span>&nbsp;<span class="ident" id="6122455">nil</span><span class="op" id="6122458">,</span>&nbsp;<span class="ident" id="6122460">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6122465">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122468">if</span>&nbsp;<span class="ident" id="6122471">err</span>&nbsp;<span class="op" id="6122475">=</span>&nbsp;<span class="ident" id="6122477">b</span><span class="op" id="6122478">.</span><span class="ident" id="6122479">Close</span><span class="op" id="6122484">(</span><span class="op" id="6122485">)</span><span class="op" id="6122486">;</span>&nbsp;<span class="ident" id="6122488">err</span>&nbsp;<span class="op" id="6122492">!=</span>&nbsp;<span class="ident" id="6122495">nil</span>&nbsp;<span class="op" id="6122499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122503">return</span>&nbsp;<span class="ident" id="6122510">nil</span><span class="op" id="6122513">,</span>&nbsp;<span class="ident" id="6122515">nil</span><span class="op" id="6122518">,</span>&nbsp;<span class="ident" id="6122520">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6122525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6122528">return</span>&nbsp;<span class="ident" id="6122535">ioutil</span><span class="op" id="6122541">.</span><span class="ident" id="6122542">NopCloser</span><span class="op" id="6122551">(</span><span class="op" id="6122552">&amp;</span><span class="ident" id="6122553">buf</span><span class="op" id="6122556">)</span><span class="op" id="6122557">,</span>&nbsp;<span class="ident" id="6122559">ioutil</span><span class="op" id="6122565">.</span><span class="ident" id="6122566">NopCloser</span><span class="op" id="6122575">(</span><span class="ident" id="6122576">bytes</span><span class="op" id="6122581">.</span><span class="ident" id="6122582">NewReader</span><span class="op" id="6122591">(</span><span class="ident" id="6122592">buf</span><span class="op" id="6122595">.</span><span class="ident" id="6122596">Bytes</span><span class="op" id="6122601">(</span><span class="op" id="6122602">)</span><span class="op" id="6122603">)</span><span class="op" id="6122604">)</span><span class="op" id="6122605">,</span>&nbsp;<span class="ident" id="6122607">nil</span><br>
<span class="lineno"></span><span class="op" id="6122611">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="6122614">//&nbsp;dumpConn&nbsp;is&nbsp;a&nbsp;net.Conn&nbsp;which&nbsp;writes&nbsp;to&nbsp;Writer&nbsp;and&nbsp;reads&nbsp;from&nbsp;Reader</span><br>
<span class="lineno"></span><span class="keyword" id="6122685">type</span>&nbsp;<span class="ident" id="6122690">dumpConn</span>&nbsp;<span class="keyword" id="6122699">struct</span>&nbsp;<span class="op" id="6122706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6122709">io</span><span class="op" id="6122711">.</span><span class="ident" id="6122712">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6122720">io</span><span class="op" id="6122722">.</span><span class="ident" id="6122723">Reader</span><br>
<span class="lineno">40</span><span class="op" id="6122730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6122733">func</span>&nbsp;<span class="op" id="6122738">(</span><span class="ident" id="6122739">c</span>&nbsp;<span class="op" id="6122741">*</span><span class="ident" id="6122742">dumpConn</span><span class="op" id="6122750">)</span>&nbsp;<span class="ident" id="6122752">Close</span><span class="op" id="6122757">(</span><span class="op" id="6122758">)</span>&nbsp;<span class="builtintype" id="6122760">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6122788">{</span>&nbsp;<span class="keyword" id="6122790">return</span>&nbsp;<span class="ident" id="6122797">nil</span>&nbsp;<span class="op" id="6122801">}</span><br>
<span class="lineno"></span><span class="keyword" id="6122803">func</span>&nbsp;<span class="op" id="6122808">(</span><span class="ident" id="6122809">c</span>&nbsp;<span class="op" id="6122811">*</span><span class="ident" id="6122812">dumpConn</span><span class="op" id="6122820">)</span>&nbsp;<span class="ident" id="6122822">LocalAddr</span><span class="op" id="6122831">(</span><span class="op" id="6122832">)</span>&nbsp;<span class="ident" id="6122834">net</span><span class="op" id="6122837">.</span><span class="ident" id="6122838">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6122858">{</span>&nbsp;<span class="keyword" id="6122860">return</span>&nbsp;<span class="ident" id="6122867">nil</span>&nbsp;<span class="op" id="6122871">}</span><br>
<span class="lineno"></span><span class="keyword" id="6122873">func</span>&nbsp;<span class="op" id="6122878">(</span><span class="ident" id="6122879">c</span>&nbsp;<span class="op" id="6122881">*</span><span class="ident" id="6122882">dumpConn</span><span class="op" id="6122890">)</span>&nbsp;<span class="ident" id="6122892">RemoteAddr</span><span class="op" id="6122902">(</span><span class="op" id="6122903">)</span>&nbsp;<span class="ident" id="6122905">net</span><span class="op" id="6122908">.</span><span class="ident" id="6122909">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6122928">{</span>&nbsp;<span class="keyword" id="6122930">return</span>&nbsp;<span class="ident" id="6122937">nil</span>&nbsp;<span class="op" id="6122941">}</span><br>
<span class="lineno">45</span><span class="keyword" id="6122943">func</span>&nbsp;<span class="op" id="6122948">(</span><span class="ident" id="6122949">c</span>&nbsp;<span class="op" id="6122951">*</span><span class="ident" id="6122952">dumpConn</span><span class="op" id="6122960">)</span>&nbsp;<span class="ident" id="6122962">SetDeadline</span><span class="op" id="6122973">(</span><span class="ident" id="6122974">t</span>&nbsp;<span class="ident" id="6122976">time</span><span class="op" id="6122980">.</span><span class="ident" id="6122981">Time</span><span class="op" id="6122985">)</span>&nbsp;<span class="builtintype" id="6122987">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6122998">{</span>&nbsp;<span class="keyword" id="6123000">return</span>&nbsp;<span class="ident" id="6123007">nil</span>&nbsp;<span class="op" id="6123011">}</span><br>
<span class="lineno"></span><span class="keyword" id="6123013">func</span>&nbsp;<span class="op" id="6123018">(</span><span class="ident" id="6123019">c</span>&nbsp;<span class="op" id="6123021">*</span><span class="ident" id="6123022">dumpConn</span><span class="op" id="6123030">)</span>&nbsp;<span class="ident" id="6123032">SetReadDeadline</span><span class="op" id="6123047">(</span><span class="ident" id="6123048">t</span>&nbsp;<span class="ident" id="6123050">time</span><span class="op" id="6123054">.</span><span class="ident" id="6123055">Time</span><span class="op" id="6123059">)</span>&nbsp;<span class="builtintype" id="6123061">error</span>&nbsp;&nbsp;<span class="op" id="6123068">{</span>&nbsp;<span class="keyword" id="6123070">return</span>&nbsp;<span class="ident" id="6123077">nil</span>&nbsp;<span class="op" id="6123081">}</span><br>
<span class="lineno"></span><span class="keyword" id="6123083">func</span>&nbsp;<span class="op" id="6123088">(</span><span class="ident" id="6123089">c</span>&nbsp;<span class="op" id="6123091">*</span><span class="ident" id="6123092">dumpConn</span><span class="op" id="6123100">)</span>&nbsp;<span class="ident" id="6123102">SetWriteDeadline</span><span class="op" id="6123118">(</span><span class="ident" id="6123119">t</span>&nbsp;<span class="ident" id="6123121">time</span><span class="op" id="6123125">.</span><span class="ident" id="6123126">Time</span><span class="op" id="6123130">)</span>&nbsp;<span class="builtintype" id="6123132">error</span>&nbsp;<span class="op" id="6123138">{</span>&nbsp;<span class="keyword" id="6123140">return</span>&nbsp;<span class="ident" id="6123147">nil</span>&nbsp;<span class="op" id="6123151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6123154">type</span>&nbsp;<span class="ident" id="6123159">neverEnding</span>&nbsp;<span class="builtintype" id="6123171">byte</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="6123177">func</span>&nbsp;<span class="op" id="6123182">(</span><span class="ident" id="6123183">b</span>&nbsp;<span class="ident" id="6123185">neverEnding</span><span class="op" id="6123196">)</span>&nbsp;<span class="ident" id="6123198">Read</span><span class="op" id="6123202">(</span><span class="ident" id="6123203">p</span>&nbsp;<span class="op" id="6123205">[</span><span class="op" id="6123206">]</span><span class="builtintype" id="6123207">byte</span><span class="op" id="6123211">)</span>&nbsp;<span class="op" id="6123213">(</span><span class="ident" id="6123214">n</span>&nbsp;<span class="builtintype" id="6123216">int</span><span class="op" id="6123219">,</span>&nbsp;<span class="ident" id="6123221">err</span>&nbsp;<span class="builtintype" id="6123225">error</span><span class="op" id="6123230">)</span>&nbsp;<span class="op" id="6123232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6123235">for</span>&nbsp;<span class="ident" id="6123239">i</span>&nbsp;<span class="op" id="6123241">:=</span>&nbsp;<span class="keyword" id="6123244">range</span>&nbsp;<span class="ident" id="6123250">p</span>&nbsp;<span class="op" id="6123252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6123256">p</span><span class="op" id="6123257">[</span><span class="ident" id="6123258">i</span><span class="op" id="6123259">]</span>&nbsp;<span class="op" id="6123261">=</span>&nbsp;<span class="builtintype" id="6123263">byte</span><span class="op" id="6123267">(</span><span class="ident" id="6123268">b</span><span class="op" id="6123269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6123272">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6123275">return</span>&nbsp;<span class="builtinfunc" id="6123282">len</span><span class="op" id="6123285">(</span><span class="ident" id="6123286">p</span><span class="op" id="6123287">)</span><span class="op" id="6123288">,</span>&nbsp;<span class="ident" id="6123290">nil</span><br>
<span class="lineno"></span><span class="op" id="6123294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6123297">//&nbsp;DumpRequestOut&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;includes</span><br>
<span class="lineno"></span><span class="comment" id="6123348">//&nbsp;headers&nbsp;that&nbsp;the&nbsp;standard&nbsp;http.Transport&nbsp;adds,</span><br>
<span class="lineno">60</span><span class="comment" id="6123398">//&nbsp;such&nbsp;as&nbsp;User-Agent.</span><br>
<span class="lineno"></span><span class="keyword" id="6123421">func</span>&nbsp;<span class="ident" id="6123426">DumpRequestOut</span><span class="op" id="6123440">(</span><span class="ident" id="6123441">req</span>&nbsp;<span class="op" id="6123445">*</span><span class="ident" id="6123446">http</span><span class="op" id="6123450">.</span><span class="ident" id="6123451">Request</span><span class="op" id="6123458">,</span>&nbsp;<span class="ident" id="6123460">body</span>&nbsp;<span class="builtintype" id="6123465">bool</span><span class="op" id="6123469">)</span>&nbsp;<span class="op" id="6123471">(</span><span class="op" id="6123472">[</span><span class="op" id="6123473">]</span><span class="builtintype" id="6123474">byte</span><span class="op" id="6123478">,</span>&nbsp;<span class="builtintype" id="6123480">error</span><span class="op" id="6123485">)</span>&nbsp;<span class="op" id="6123487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6123490">save</span>&nbsp;<span class="op" id="6123495">:=</span>&nbsp;<span class="ident" id="6123498">req</span><span class="op" id="6123501">.</span><span class="ident" id="6123502">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6123508">dummyBody</span>&nbsp;<span class="op" id="6123518">:=</span>&nbsp;<span class="builtintype" id="6123521">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6123528">if</span>&nbsp;<span class="op" id="6123531">!</span><span class="ident" id="6123532">body</span>&nbsp;<span class="op" id="6123537">||</span>&nbsp;<span class="ident" id="6123540">req</span><span class="op" id="6123543">.</span><span class="ident" id="6123544">Body</span>&nbsp;<span class="op" id="6123549">==</span>&nbsp;<span class="ident" id="6123552">nil</span>&nbsp;<span class="op" id="6123556">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6123560">req</span><span class="op" id="6123563">.</span><span class="ident" id="6123564">Body</span>&nbsp;<span class="op" id="6123569">=</span>&nbsp;<span class="ident" id="6123571">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6123577">if</span>&nbsp;<span class="ident" id="6123580">req</span><span class="op" id="6123583">.</span><span class="ident" id="6123584">ContentLength</span>&nbsp;<span class="op" id="6123598">!=</span>&nbsp;<span class="num" id="6123601">0</span>&nbsp;<span class="op" id="6123603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6123608">req</span><span class="op" id="6123611">.</span><span class="ident" id="6123612">Body</span>&nbsp;<span class="op" id="6123617">=</span>&nbsp;<span class="ident" id="6123619">ioutil</span><span class="op" id="6123625">.</span><span class="ident" id="6123626">NopCloser</span><span class="op" id="6123635">(</span><span class="ident" id="6123636">io</span><span class="op" id="6123638">.</span><span class="ident" id="6123639">LimitReader</span><span class="op" id="6123650">(</span><span class="ident" id="6123651">neverEnding</span><span class="op" id="6123662">(</span><span class="string" id="6123663">&#39;x&#39;</span><span class="op" id="6123666">)</span><span class="op" id="6123667">,</span>&nbsp;<span class="ident" id="6123669">req</span><span class="op" id="6123672">.</span><span class="ident" id="6123673">ContentLength</span><span class="op" id="6123686">)</span><span class="op" id="6123687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6123692">dummyBody</span>&nbsp;<span class="op" id="6123702">=</span>&nbsp;<span class="builtintype" id="6123704">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6123711">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6123714">}</span>&nbsp;<span class="keyword" id="6123716">else</span>&nbsp;<span class="op" id="6123721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6123725">var</span>&nbsp;<span class="ident" id="6123729">err</span>&nbsp;<span class="builtintype" id="6123733">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6123741">save</span><span class="op" id="6123745">,</span>&nbsp;<span class="ident" id="6123747">req</span><span class="op" id="6123750">.</span><span class="ident" id="6123751">Body</span><span class="op" id="6123755">,</span>&nbsp;<span class="ident" id="6123757">err</span>&nbsp;<span class="op" id="6123761">=</span>&nbsp;<span class="ident" id="6123763">drainBody</span><span class="op" id="6123772">(</span><span class="ident" id="6123773">req</span><span class="op" id="6123776">.</span><span class="ident" id="6123777">Body</span><span class="op" id="6123781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6123785">if</span>&nbsp;<span class="ident" id="6123788">err</span>&nbsp;<span class="op" id="6123792">!=</span>&nbsp;<span class="ident" id="6123795">nil</span>&nbsp;<span class="op" id="6123799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6123804">return</span>&nbsp;<span class="ident" id="6123811">nil</span><span class="op" id="6123814">,</span>&nbsp;<span class="ident" id="6123816">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6123822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6123825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6123829">//&nbsp;Since&nbsp;we&#39;re&nbsp;using&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;write&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6123899">//&nbsp;switch&nbsp;to&nbsp;http&nbsp;so&nbsp;the&nbsp;Transport&nbsp;doesn&#39;t&nbsp;try&nbsp;to&nbsp;do&nbsp;an&nbsp;SSL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6123960">//&nbsp;negotiation&nbsp;with&nbsp;our&nbsp;dumpConn&nbsp;and&nbsp;its&nbsp;bytes.Buffer&nbsp;&amp;&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6124023">//&nbsp;The&nbsp;wire&nbsp;format&nbsp;for&nbsp;https&nbsp;and&nbsp;http&nbsp;are&nbsp;the&nbsp;same,&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6124084">reqSend</span>&nbsp;<span class="op" id="6124092">:=</span>&nbsp;<span class="ident" id="6124095">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6124100">if</span>&nbsp;<span class="ident" id="6124103">req</span><span class="op" id="6124106">.</span><span class="ident" id="6124107">URL</span><span class="op" id="6124110">.</span><span class="ident" id="6124111">Scheme</span>&nbsp;<span class="op" id="6124118">==</span>&nbsp;<span class="string" id="6124121">&#34;https&#34;</span>&nbsp;<span class="op" id="6124129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6124133">reqSend</span>&nbsp;<span class="op" id="6124141">=</span>&nbsp;<span class="builtinfunc" id="6124143">new</span><span class="op" id="6124146">(</span><span class="ident" id="6124147">http</span><span class="op" id="6124151">.</span><span class="ident" id="6124152">Request</span><span class="op" id="6124159">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6124163">*</span><span class="ident" id="6124164">reqSend</span>&nbsp;<span class="op" id="6124172">=</span>&nbsp;<span class="op" id="6124174">*</span><span class="ident" id="6124175">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6124181">reqSend</span><span class="op" id="6124188">.</span><span class="ident" id="6124189">URL</span>&nbsp;<span class="op" id="6124193">=</span>&nbsp;<span class="builtinfunc" id="6124195">new</span><span class="op" id="6124198">(</span><span class="ident" id="6124199">url</span><span class="op" id="6124202">.</span><span class="ident" id="6124203">URL</span><span class="op" id="6124206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6124210">*</span><span class="ident" id="6124211">reqSend</span><span class="op" id="6124218">.</span><span class="ident" id="6124219">URL</span>&nbsp;<span class="op" id="6124223">=</span>&nbsp;<span class="op" id="6124225">*</span><span class="ident" id="6124226">req</span><span class="op" id="6124229">.</span><span class="ident" id="6124230">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6124236">reqSend</span><span class="op" id="6124243">.</span><span class="ident" id="6124244">URL</span><span class="op" id="6124247">.</span><span class="ident" id="6124248">Scheme</span>&nbsp;<span class="op" id="6124255">=</span>&nbsp;<span class="string" id="6124257">&#34;http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6124265">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6124269">//&nbsp;Use&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;record&nbsp;what&nbsp;we&nbsp;would&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6124332">//&nbsp;on&nbsp;the&nbsp;wire,&nbsp;but&nbsp;not&nbsp;using&nbsp;TCP.&nbsp;&nbsp;Use&nbsp;a&nbsp;Transport&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6124392">//&nbsp;custom&nbsp;dialer&nbsp;that&nbsp;returns&nbsp;a&nbsp;fake&nbsp;net.Conn&nbsp;that&nbsp;waits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6124450">//&nbsp;for&nbsp;the&nbsp;full&nbsp;input&nbsp;(and&nbsp;recording&nbsp;it),&nbsp;and&nbsp;then&nbsp;responds</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6124511">//&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6124538">var</span>&nbsp;<span class="ident" id="6124542">buf</span>&nbsp;<span class="ident" id="6124546">bytes</span><span class="op" id="6124551">.</span><span class="ident" id="6124552">Buffer</span>&nbsp;<span class="comment" id="6124559">//&nbsp;records&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6124582">pr</span><span class="op" id="6124584">,</span>&nbsp;<span class="ident" id="6124586">pw</span>&nbsp;<span class="op" id="6124589">:=</span>&nbsp;<span class="ident" id="6124592">io</span><span class="op" id="6124594">.</span><span class="ident" id="6124595">Pipe</span><span class="op" id="6124599">(</span><span class="op" id="6124600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6124603">defer</span>&nbsp;<span class="ident" id="6124609">pr</span><span class="op" id="6124611">.</span><span class="ident" id="6124612">Close</span><span class="op" id="6124617">(</span><span class="op" id="6124618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6124621">defer</span>&nbsp;<span class="ident" id="6124627">pw</span><span class="op" id="6124629">.</span><span class="ident" id="6124630">Close</span><span class="op" id="6124635">(</span><span class="op" id="6124636">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6124639">dr</span>&nbsp;<span class="op" id="6124642">:=</span>&nbsp;<span class="op" id="6124645">&amp;</span><span class="ident" id="6124646">delegateReader</span><span class="op" id="6124660">{</span><span class="ident" id="6124661">c</span><span class="op" id="6124662">:</span>&nbsp;<span class="builtinfunc" id="6124664">make</span><span class="op" id="6124668">(</span><span class="keyword" id="6124669">chan</span>&nbsp;<span class="ident" id="6124674">io</span><span class="op" id="6124676">.</span><span class="ident" id="6124677">Reader</span><span class="op" id="6124683">)</span><span class="op" id="6124684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6124687">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;request&nbsp;before&nbsp;replying&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6124751">go</span>&nbsp;<span class="keyword" id="6124754">func</span><span class="op" id="6124758">(</span><span class="op" id="6124759">)</span>&nbsp;<span class="op" id="6124761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6124765">req</span><span class="op" id="6124768">,</span>&nbsp;<span class="ident" id="6124770">err</span>&nbsp;<span class="op" id="6124774">:=</span>&nbsp;<span class="ident" id="6124777">http</span><span class="op" id="6124781">.</span><span class="ident" id="6124782">ReadRequest</span><span class="op" id="6124793">(</span><span class="ident" id="6124794">bufio</span><span class="op" id="6124799">.</span><span class="ident" id="6124800">NewReader</span><span class="op" id="6124809">(</span><span class="ident" id="6124810">pr</span><span class="op" id="6124812">)</span><span class="op" id="6124813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6124817">if</span>&nbsp;<span class="ident" id="6124820">err</span>&nbsp;<span class="op" id="6124824">==</span>&nbsp;<span class="ident" id="6124827">nil</span>&nbsp;<span class="op" id="6124831">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6124836">//&nbsp;Ensure&nbsp;all&nbsp;the&nbsp;body&nbsp;is&nbsp;read;&nbsp;otherwise</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6124881">//&nbsp;we&#39;ll&nbsp;get&nbsp;a&nbsp;partial&nbsp;dump.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6124913">io</span><span class="op" id="6124915">.</span><span class="ident" id="6124916">Copy</span><span class="op" id="6124920">(</span><span class="ident" id="6124921">ioutil</span><span class="op" id="6124927">.</span><span class="ident" id="6124928">Discard</span><span class="op" id="6124935">,</span>&nbsp;<span class="ident" id="6124937">req</span><span class="op" id="6124940">.</span><span class="ident" id="6124941">Body</span><span class="op" id="6124945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6124950">req</span><span class="op" id="6124953">.</span><span class="ident" id="6124954">Body</span><span class="op" id="6124958">.</span><span class="ident" id="6124959">Close</span><span class="op" id="6124964">(</span><span class="op" id="6124965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6124969">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6124973">dr</span><span class="op" id="6124975">.</span><span class="ident" id="6124976">c</span>&nbsp;<span class="op" id="6124978">&lt;-</span>&nbsp;<span class="ident" id="6124981">strings</span><span class="op" id="6124988">.</span><span class="ident" id="6124989">NewReader</span><span class="op" id="6124998">(</span><span class="string" id="6124999">&#34;HTTP/1.1&nbsp;204&nbsp;No&nbsp;Content\r\n\r\n&#34;</span><span class="op" id="6125032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6125035">}</span><span class="op" id="6125036">(</span><span class="op" id="6125037">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125041">t</span>&nbsp;<span class="op" id="6125043">:=</span>&nbsp;<span class="op" id="6125046">&amp;</span><span class="ident" id="6125047">http</span><span class="op" id="6125051">.</span><span class="ident" id="6125052">Transport</span><span class="op" id="6125061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125065">DisableKeepAlives</span><span class="op" id="6125082">:</span>&nbsp;<span class="builtintype" id="6125084">true</span><span class="op" id="6125088">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125092">Dial</span><span class="op" id="6125096">:</span>&nbsp;<span class="keyword" id="6125098">func</span><span class="op" id="6125102">(</span><span class="ident" id="6125103">net</span><span class="op" id="6125106">,</span>&nbsp;<span class="ident" id="6125108">addr</span>&nbsp;<span class="builtintype" id="6125113">string</span><span class="op" id="6125119">)</span>&nbsp;<span class="op" id="6125121">(</span><span class="ident" id="6125122">net</span><span class="op" id="6125125">.</span><span class="ident" id="6125126">Conn</span><span class="op" id="6125130">,</span>&nbsp;<span class="builtintype" id="6125132">error</span><span class="op" id="6125137">)</span>&nbsp;<span class="op" id="6125139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6125144">return</span>&nbsp;<span class="op" id="6125151">&amp;</span><span class="ident" id="6125152">dumpConn</span><span class="op" id="6125160">{</span><span class="ident" id="6125161">io</span><span class="op" id="6125163">.</span><span class="ident" id="6125164">MultiWriter</span><span class="op" id="6125175">(</span><span class="op" id="6125176">&amp;</span><span class="ident" id="6125177">buf</span><span class="op" id="6125180">,</span>&nbsp;<span class="ident" id="6125182">pw</span><span class="op" id="6125184">)</span><span class="op" id="6125185">,</span>&nbsp;<span class="ident" id="6125187">dr</span><span class="op" id="6125189">}</span><span class="op" id="6125190">,</span>&nbsp;<span class="ident" id="6125192">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6125198">}</span><span class="op" id="6125199">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6125202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125206">_</span><span class="op" id="6125207">,</span>&nbsp;<span class="ident" id="6125209">err</span>&nbsp;<span class="op" id="6125213">:=</span>&nbsp;<span class="ident" id="6125216">t</span><span class="op" id="6125217">.</span><span class="ident" id="6125218">RoundTrip</span><span class="op" id="6125227">(</span><span class="ident" id="6125228">reqSend</span><span class="op" id="6125235">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125239">req</span><span class="op" id="6125242">.</span><span class="ident" id="6125243">Body</span>&nbsp;<span class="op" id="6125248">=</span>&nbsp;<span class="ident" id="6125250">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6125256">if</span>&nbsp;<span class="ident" id="6125259">err</span>&nbsp;<span class="op" id="6125263">!=</span>&nbsp;<span class="ident" id="6125266">nil</span>&nbsp;<span class="op" id="6125270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6125274">return</span>&nbsp;<span class="ident" id="6125281">nil</span><span class="op" id="6125284">,</span>&nbsp;<span class="ident" id="6125286">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6125291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125294">dump</span>&nbsp;<span class="op" id="6125299">:=</span>&nbsp;<span class="ident" id="6125302">buf</span><span class="op" id="6125305">.</span><span class="ident" id="6125306">Bytes</span><span class="op" id="6125311">(</span><span class="op" id="6125312">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6125316">//&nbsp;If&nbsp;we&nbsp;used&nbsp;a&nbsp;dummy&nbsp;body&nbsp;above,&nbsp;remove&nbsp;it&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6125366">//&nbsp;TODO:&nbsp;if&nbsp;the&nbsp;req.ContentLength&nbsp;is&nbsp;large,&nbsp;we&nbsp;allocate&nbsp;memory</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6125430">//&nbsp;unnecessarily&nbsp;just&nbsp;to&nbsp;slice&nbsp;it&nbsp;off&nbsp;here.&nbsp;&nbsp;But&nbsp;this&nbsp;is&nbsp;just</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6125493">//&nbsp;a&nbsp;debug&nbsp;function,&nbsp;so&nbsp;this&nbsp;is&nbsp;acceptable&nbsp;for&nbsp;now.&nbsp;We&nbsp;could</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6125555">//&nbsp;discard&nbsp;the&nbsp;body&nbsp;earlier&nbsp;if&nbsp;this&nbsp;matters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6125601">if</span>&nbsp;<span class="ident" id="6125604">dummyBody</span>&nbsp;<span class="op" id="6125614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6125618">if</span>&nbsp;<span class="ident" id="6125621">i</span>&nbsp;<span class="op" id="6125623">:=</span>&nbsp;<span class="ident" id="6125626">bytes</span><span class="op" id="6125631">.</span><span class="ident" id="6125632">Index</span><span class="op" id="6125637">(</span><span class="ident" id="6125638">dump</span><span class="op" id="6125642">,</span>&nbsp;<span class="op" id="6125644">[</span><span class="op" id="6125645">]</span><span class="builtintype" id="6125646">byte</span><span class="op" id="6125650">(</span><span class="string" id="6125651">&#34;\r\n\r\n&#34;</span><span class="op" id="6125661">)</span><span class="op" id="6125662">)</span><span class="op" id="6125663">;</span>&nbsp;<span class="ident" id="6125665">i</span>&nbsp;<span class="op" id="6125667">&gt;=</span>&nbsp;<span class="num" id="6125670">0</span>&nbsp;<span class="op" id="6125672">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125677">dump</span>&nbsp;<span class="op" id="6125682">=</span>&nbsp;<span class="ident" id="6125684">dump</span><span class="op" id="6125688">[</span><span class="op" id="6125689">:</span><span class="ident" id="6125690">i</span><span class="op" id="6125691">+</span><span class="num" id="6125692">4</span><span class="op" id="6125693">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6125697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6125700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6125703">return</span>&nbsp;<span class="ident" id="6125710">dump</span><span class="op" id="6125714">,</span>&nbsp;<span class="ident" id="6125716">nil</span><br>
<span class="lineno"></span><span class="op" id="6125720">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="6125723">//&nbsp;delegateReader&nbsp;is&nbsp;a&nbsp;reader&nbsp;that&nbsp;delegates&nbsp;to&nbsp;another&nbsp;reader,</span><br>
<span class="lineno"></span><span class="comment" id="6125787">//&nbsp;once&nbsp;it&nbsp;arrives&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="6125820">type</span>&nbsp;<span class="ident" id="6125825">delegateReader</span>&nbsp;<span class="keyword" id="6125840">struct</span>&nbsp;<span class="op" id="6125847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125850">c</span>&nbsp;<span class="keyword" id="6125852">chan</span>&nbsp;<span class="ident" id="6125857">io</span><span class="op" id="6125859">.</span><span class="ident" id="6125860">Reader</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125868">r</span>&nbsp;<span class="ident" id="6125870">io</span><span class="op" id="6125872">.</span><span class="ident" id="6125873">Reader</span>&nbsp;<span class="comment" id="6125880">//&nbsp;nil&nbsp;until&nbsp;received&nbsp;from&nbsp;c</span><br>
<span class="lineno"></span><span class="op" id="6125909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6125912">func</span>&nbsp;<span class="op" id="6125917">(</span><span class="ident" id="6125918">r</span>&nbsp;<span class="op" id="6125920">*</span><span class="ident" id="6125921">delegateReader</span><span class="op" id="6125935">)</span>&nbsp;<span class="ident" id="6125937">Read</span><span class="op" id="6125941">(</span><span class="ident" id="6125942">p</span>&nbsp;<span class="op" id="6125944">[</span><span class="op" id="6125945">]</span><span class="builtintype" id="6125946">byte</span><span class="op" id="6125950">)</span>&nbsp;<span class="op" id="6125952">(</span><span class="builtintype" id="6125953">int</span><span class="op" id="6125956">,</span>&nbsp;<span class="builtintype" id="6125958">error</span><span class="op" id="6125963">)</span>&nbsp;<span class="op" id="6125965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6125968">if</span>&nbsp;<span class="ident" id="6125971">r</span><span class="op" id="6125972">.</span><span class="ident" id="6125973">r</span>&nbsp;<span class="op" id="6125975">==</span>&nbsp;<span class="ident" id="6125978">nil</span>&nbsp;<span class="op" id="6125982">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6125986">r</span><span class="op" id="6125987">.</span><span class="ident" id="6125988">r</span>&nbsp;<span class="op" id="6125990">=</span>&nbsp;<span class="op" id="6125992">&lt;-</span><span class="ident" id="6125994">r</span><span class="op" id="6125995">.</span><span class="ident" id="6125996">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6125999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126002">return</span>&nbsp;<span class="ident" id="6126009">r</span><span class="op" id="6126010">.</span><span class="ident" id="6126011">r</span><span class="op" id="6126012">.</span><span class="ident" id="6126013">Read</span><span class="op" id="6126017">(</span><span class="ident" id="6126018">p</span><span class="op" id="6126019">)</span><br>
<span class="lineno"></span><span class="op" id="6126021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="comment" id="6126024">//&nbsp;Return&nbsp;value&nbsp;if&nbsp;nonempty,&nbsp;def&nbsp;otherwise.</span><br>
<span class="lineno"></span><span class="keyword" id="6126068">func</span>&nbsp;<span class="ident" id="6126073">valueOrDefault</span><span class="op" id="6126087">(</span><span class="ident" id="6126088">value</span><span class="op" id="6126093">,</span>&nbsp;<span class="ident" id="6126095">def</span>&nbsp;<span class="builtintype" id="6126099">string</span><span class="op" id="6126105">)</span>&nbsp;<span class="builtintype" id="6126107">string</span>&nbsp;<span class="op" id="6126114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126117">if</span>&nbsp;<span class="ident" id="6126120">value</span>&nbsp;<span class="op" id="6126126">!=</span>&nbsp;<span class="string" id="6126129">&#34;&#34;</span>&nbsp;<span class="op" id="6126132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126136">return</span>&nbsp;<span class="ident" id="6126143">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6126150">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126153">return</span>&nbsp;<span class="ident" id="6126160">def</span><br>
<span class="lineno"></span><span class="op" id="6126164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6126167">var</span>&nbsp;<span class="ident" id="6126171">reqWriteExcludeHeaderDump</span>&nbsp;<span class="op" id="6126197">=</span>&nbsp;<span class="keyword" id="6126199">map</span><span class="op" id="6126202">[</span><span class="builtintype" id="6126203">string</span><span class="op" id="6126209">]</span><span class="builtintype" id="6126210">bool</span><span class="op" id="6126214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6126217">&#34;Host&#34;</span><span class="op" id="6126223">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6126238">true</span><span class="op" id="6126242">,</span>&nbsp;<span class="comment" id="6126244">//&nbsp;not&nbsp;in&nbsp;Header&nbsp;map&nbsp;anyway</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6126273">&#34;Content-Length&#34;</span><span class="op" id="6126289">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6126294">true</span><span class="op" id="6126298">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6126301">&#34;Transfer-Encoding&#34;</span><span class="op" id="6126320">:</span>&nbsp;<span class="builtintype" id="6126322">true</span><span class="op" id="6126326">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6126329">&#34;Trailer&#34;</span><span class="op" id="6126338">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6126350">true</span><span class="op" id="6126354">,</span><br>
<span class="lineno"></span><span class="op" id="6126356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="6126359">//&nbsp;dumpAsReceived&nbsp;writes&nbsp;req&nbsp;to&nbsp;w&nbsp;in&nbsp;the&nbsp;form&nbsp;as&nbsp;it&nbsp;was&nbsp;received,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6126428">//&nbsp;at&nbsp;least&nbsp;as&nbsp;accurately&nbsp;as&nbsp;possible&nbsp;from&nbsp;the&nbsp;information&nbsp;retained&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="6126499">//&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span><span class="keyword" id="6126515">func</span>&nbsp;<span class="ident" id="6126520">dumpAsReceived</span><span class="op" id="6126534">(</span><span class="ident" id="6126535">req</span>&nbsp;<span class="op" id="6126539">*</span><span class="ident" id="6126540">http</span><span class="op" id="6126544">.</span><span class="ident" id="6126545">Request</span><span class="op" id="6126552">,</span>&nbsp;<span class="ident" id="6126554">w</span>&nbsp;<span class="ident" id="6126556">io</span><span class="op" id="6126558">.</span><span class="ident" id="6126559">Writer</span><span class="op" id="6126565">)</span>&nbsp;<span class="builtintype" id="6126567">error</span>&nbsp;<span class="op" id="6126573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6126576">return</span>&nbsp;<span class="ident" id="6126583">nil</span><br>
<span class="lineno">175</span><span class="op" id="6126587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6126590">//&nbsp;DumpRequest&nbsp;returns&nbsp;the&nbsp;as-received&nbsp;wire&nbsp;representation&nbsp;of&nbsp;req,</span><br>
<span class="lineno"></span><span class="comment" id="6126657">//&nbsp;optionally&nbsp;including&nbsp;the&nbsp;request&nbsp;body,&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="comment" id="6126714">//&nbsp;DumpRequest&nbsp;is&nbsp;semantically&nbsp;a&nbsp;no-op,&nbsp;but&nbsp;in&nbsp;order&nbsp;to</span><br>
<span class="lineno">180</span><span class="comment" id="6126770">//&nbsp;dump&nbsp;the&nbsp;body,&nbsp;it&nbsp;reads&nbsp;the&nbsp;body&nbsp;data&nbsp;into&nbsp;memory&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="6126827">//&nbsp;changes&nbsp;req.Body&nbsp;to&nbsp;refer&nbsp;to&nbsp;the&nbsp;in-memory&nbsp;copy.</span><br>
<span class="lineno"></span><span class="comment" id="6126879">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;http.Request.Write&nbsp;details&nbsp;which&nbsp;fields</span><br>
<span class="lineno"></span><span class="comment" id="6126944">//&nbsp;of&nbsp;req&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="6126964">func</span>&nbsp;<span class="ident" id="6126969">DumpRequest</span><span class="op" id="6126980">(</span><span class="ident" id="6126981">req</span>&nbsp;<span class="op" id="6126985">*</span><span class="ident" id="6126986">http</span><span class="op" id="6126990">.</span><span class="ident" id="6126991">Request</span><span class="op" id="6126998">,</span>&nbsp;<span class="ident" id="6127000">body</span>&nbsp;<span class="builtintype" id="6127005">bool</span><span class="op" id="6127009">)</span>&nbsp;<span class="op" id="6127011">(</span><span class="ident" id="6127012">dump</span>&nbsp;<span class="op" id="6127017">[</span><span class="op" id="6127018">]</span><span class="builtintype" id="6127019">byte</span><span class="op" id="6127023">,</span>&nbsp;<span class="ident" id="6127025">err</span>&nbsp;<span class="builtintype" id="6127029">error</span><span class="op" id="6127034">)</span>&nbsp;<span class="op" id="6127036">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127039">save</span>&nbsp;<span class="op" id="6127044">:=</span>&nbsp;<span class="ident" id="6127047">req</span><span class="op" id="6127050">.</span><span class="ident" id="6127051">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127057">if</span>&nbsp;<span class="op" id="6127060">!</span><span class="ident" id="6127061">body</span>&nbsp;<span class="op" id="6127066">||</span>&nbsp;<span class="ident" id="6127069">req</span><span class="op" id="6127072">.</span><span class="ident" id="6127073">Body</span>&nbsp;<span class="op" id="6127078">==</span>&nbsp;<span class="ident" id="6127081">nil</span>&nbsp;<span class="op" id="6127085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127089">req</span><span class="op" id="6127092">.</span><span class="ident" id="6127093">Body</span>&nbsp;<span class="op" id="6127098">=</span>&nbsp;<span class="ident" id="6127100">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6127105">}</span>&nbsp;<span class="keyword" id="6127107">else</span>&nbsp;<span class="op" id="6127112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127116">save</span><span class="op" id="6127120">,</span>&nbsp;<span class="ident" id="6127122">req</span><span class="op" id="6127125">.</span><span class="ident" id="6127126">Body</span><span class="op" id="6127130">,</span>&nbsp;<span class="ident" id="6127132">err</span>&nbsp;<span class="op" id="6127136">=</span>&nbsp;<span class="ident" id="6127138">drainBody</span><span class="op" id="6127147">(</span><span class="ident" id="6127148">req</span><span class="op" id="6127151">.</span><span class="ident" id="6127152">Body</span><span class="op" id="6127156">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127160">if</span>&nbsp;<span class="ident" id="6127163">err</span>&nbsp;<span class="op" id="6127167">!=</span>&nbsp;<span class="ident" id="6127170">nil</span>&nbsp;<span class="op" id="6127174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127179">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6127188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6127191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127195">var</span>&nbsp;<span class="ident" id="6127199">b</span>&nbsp;<span class="ident" id="6127201">bytes</span><span class="op" id="6127206">.</span><span class="ident" id="6127207">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127216">fmt</span><span class="op" id="6127219">.</span><span class="ident" id="6127220">Fprintf</span><span class="op" id="6127227">(</span><span class="op" id="6127228">&amp;</span><span class="ident" id="6127229">b</span><span class="op" id="6127230">,</span>&nbsp;<span class="string" id="6127232">&#34;%s&nbsp;%s&nbsp;HTTP/%d.%d\r\n&#34;</span><span class="op" id="6127254">,</span>&nbsp;<span class="ident" id="6127256">valueOrDefault</span><span class="op" id="6127270">(</span><span class="ident" id="6127271">req</span><span class="op" id="6127274">.</span><span class="ident" id="6127275">Method</span><span class="op" id="6127281">,</span>&nbsp;<span class="string" id="6127283">&#34;GET&#34;</span><span class="op" id="6127288">)</span><span class="op" id="6127289">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127293">req</span><span class="op" id="6127296">.</span><span class="ident" id="6127297">URL</span><span class="op" id="6127300">.</span><span class="ident" id="6127301">RequestURI</span><span class="op" id="6127311">(</span><span class="op" id="6127312">)</span><span class="op" id="6127313">,</span>&nbsp;<span class="ident" id="6127315">req</span><span class="op" id="6127318">.</span><span class="ident" id="6127319">ProtoMajor</span><span class="op" id="6127329">,</span>&nbsp;<span class="ident" id="6127331">req</span><span class="op" id="6127334">.</span><span class="ident" id="6127335">ProtoMinor</span><span class="op" id="6127345">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127349">host</span>&nbsp;<span class="op" id="6127354">:=</span>&nbsp;<span class="ident" id="6127357">req</span><span class="op" id="6127360">.</span><span class="ident" id="6127361">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127367">if</span>&nbsp;<span class="ident" id="6127370">host</span>&nbsp;<span class="op" id="6127375">==</span>&nbsp;<span class="string" id="6127378">&#34;&#34;</span>&nbsp;<span class="op" id="6127381">&amp;&amp;</span>&nbsp;<span class="ident" id="6127384">req</span><span class="op" id="6127387">.</span><span class="ident" id="6127388">URL</span>&nbsp;<span class="op" id="6127392">!=</span>&nbsp;<span class="ident" id="6127395">nil</span>&nbsp;<span class="op" id="6127399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127403">host</span>&nbsp;<span class="op" id="6127408">=</span>&nbsp;<span class="ident" id="6127410">req</span><span class="op" id="6127413">.</span><span class="ident" id="6127414">URL</span><span class="op" id="6127417">.</span><span class="ident" id="6127418">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6127424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127427">if</span>&nbsp;<span class="ident" id="6127430">host</span>&nbsp;<span class="op" id="6127435">!=</span>&nbsp;<span class="string" id="6127438">&#34;&#34;</span>&nbsp;<span class="op" id="6127441">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127445">fmt</span><span class="op" id="6127448">.</span><span class="ident" id="6127449">Fprintf</span><span class="op" id="6127456">(</span><span class="op" id="6127457">&amp;</span><span class="ident" id="6127458">b</span><span class="op" id="6127459">,</span>&nbsp;<span class="string" id="6127461">&#34;Host:&nbsp;%s\r\n&#34;</span><span class="op" id="6127475">,</span>&nbsp;<span class="ident" id="6127477">host</span><span class="op" id="6127481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6127484">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127488">chunked</span>&nbsp;<span class="op" id="6127496">:=</span>&nbsp;<span class="builtinfunc" id="6127499">len</span><span class="op" id="6127502">(</span><span class="ident" id="6127503">req</span><span class="op" id="6127506">.</span><span class="ident" id="6127507">TransferEncoding</span><span class="op" id="6127523">)</span>&nbsp;<span class="op" id="6127525">&gt;</span>&nbsp;<span class="num" id="6127527">0</span>&nbsp;<span class="op" id="6127529">&amp;&amp;</span>&nbsp;<span class="ident" id="6127532">req</span><span class="op" id="6127535">.</span><span class="ident" id="6127536">TransferEncoding</span><span class="op" id="6127552">[</span><span class="num" id="6127553">0</span><span class="op" id="6127554">]</span>&nbsp;<span class="op" id="6127556">==</span>&nbsp;<span class="string" id="6127559">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127570">if</span>&nbsp;<span class="builtinfunc" id="6127573">len</span><span class="op" id="6127576">(</span><span class="ident" id="6127577">req</span><span class="op" id="6127580">.</span><span class="ident" id="6127581">TransferEncoding</span><span class="op" id="6127597">)</span>&nbsp;<span class="op" id="6127599">&gt;</span>&nbsp;<span class="num" id="6127601">0</span>&nbsp;<span class="op" id="6127603">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127607">fmt</span><span class="op" id="6127610">.</span><span class="ident" id="6127611">Fprintf</span><span class="op" id="6127618">(</span><span class="op" id="6127619">&amp;</span><span class="ident" id="6127620">b</span><span class="op" id="6127621">,</span>&nbsp;<span class="string" id="6127623">&#34;Transfer-Encoding:&nbsp;%s\r\n&#34;</span><span class="op" id="6127650">,</span>&nbsp;<span class="ident" id="6127652">strings</span><span class="op" id="6127659">.</span><span class="ident" id="6127660">Join</span><span class="op" id="6127664">(</span><span class="ident" id="6127665">req</span><span class="op" id="6127668">.</span><span class="ident" id="6127669">TransferEncoding</span><span class="op" id="6127685">,</span>&nbsp;<span class="string" id="6127687">&#34;,&#34;</span><span class="op" id="6127690">)</span><span class="op" id="6127691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6127694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127697">if</span>&nbsp;<span class="ident" id="6127700">req</span><span class="op" id="6127703">.</span><span class="ident" id="6127704">Close</span>&nbsp;<span class="op" id="6127710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127714">fmt</span><span class="op" id="6127717">.</span><span class="ident" id="6127718">Fprintf</span><span class="op" id="6127725">(</span><span class="op" id="6127726">&amp;</span><span class="ident" id="6127727">b</span><span class="op" id="6127728">,</span>&nbsp;<span class="string" id="6127730">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="6127753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6127756">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127760">err</span>&nbsp;<span class="op" id="6127764">=</span>&nbsp;<span class="ident" id="6127766">req</span><span class="op" id="6127769">.</span><span class="ident" id="6127770">Header</span><span class="op" id="6127776">.</span><span class="ident" id="6127777">WriteSubset</span><span class="op" id="6127788">(</span><span class="op" id="6127789">&amp;</span><span class="ident" id="6127790">b</span><span class="op" id="6127791">,</span>&nbsp;<span class="ident" id="6127793">reqWriteExcludeHeaderDump</span><span class="op" id="6127818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127821">if</span>&nbsp;<span class="ident" id="6127824">err</span>&nbsp;<span class="op" id="6127828">!=</span>&nbsp;<span class="ident" id="6127831">nil</span>&nbsp;<span class="op" id="6127835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127839">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6127847">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127851">io</span><span class="op" id="6127853">.</span><span class="ident" id="6127854">WriteString</span><span class="op" id="6127865">(</span><span class="op" id="6127866">&amp;</span><span class="ident" id="6127867">b</span><span class="op" id="6127868">,</span>&nbsp;<span class="string" id="6127870">&#34;\r\n&#34;</span><span class="op" id="6127876">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127880">if</span>&nbsp;<span class="ident" id="6127883">req</span><span class="op" id="6127886">.</span><span class="ident" id="6127887">Body</span>&nbsp;<span class="op" id="6127892">!=</span>&nbsp;<span class="ident" id="6127895">nil</span>&nbsp;<span class="op" id="6127899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127903">var</span>&nbsp;<span class="ident" id="6127907">dest</span>&nbsp;<span class="ident" id="6127912">io</span><span class="op" id="6127914">.</span><span class="ident" id="6127915">Writer</span>&nbsp;<span class="op" id="6127922">=</span>&nbsp;<span class="op" id="6127924">&amp;</span><span class="ident" id="6127925">b</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6127929">if</span>&nbsp;<span class="ident" id="6127932">chunked</span>&nbsp;<span class="op" id="6127940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127945">dest</span>&nbsp;<span class="op" id="6127950">=</span>&nbsp;<span class="ident" id="6127952">NewChunkedWriter</span><span class="op" id="6127968">(</span><span class="ident" id="6127969">dest</span><span class="op" id="6127973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6127977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6127981">_</span><span class="op" id="6127982">,</span>&nbsp;<span class="ident" id="6127984">err</span>&nbsp;<span class="op" id="6127988">=</span>&nbsp;<span class="ident" id="6127990">io</span><span class="op" id="6127992">.</span><span class="ident" id="6127993">Copy</span><span class="op" id="6127997">(</span><span class="ident" id="6127998">dest</span><span class="op" id="6128002">,</span>&nbsp;<span class="ident" id="6128004">req</span><span class="op" id="6128007">.</span><span class="ident" id="6128008">Body</span><span class="op" id="6128012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128016">if</span>&nbsp;<span class="ident" id="6128019">chunked</span>&nbsp;<span class="op" id="6128027">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6128032">dest</span><span class="op" id="6128036">.</span><span class="op" id="6128037">(</span><span class="ident" id="6128038">io</span><span class="op" id="6128040">.</span><span class="ident" id="6128041">Closer</span><span class="op" id="6128047">)</span><span class="op" id="6128048">.</span><span class="ident" id="6128049">Close</span><span class="op" id="6128054">(</span><span class="op" id="6128055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6128060">io</span><span class="op" id="6128062">.</span><span class="ident" id="6128063">WriteString</span><span class="op" id="6128074">(</span><span class="op" id="6128075">&amp;</span><span class="ident" id="6128076">b</span><span class="op" id="6128077">,</span>&nbsp;<span class="string" id="6128079">&#34;\r\n&#34;</span><span class="op" id="6128085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6128089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6128092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6128096">req</span><span class="op" id="6128099">.</span><span class="ident" id="6128100">Body</span>&nbsp;<span class="op" id="6128105">=</span>&nbsp;<span class="ident" id="6128107">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128113">if</span>&nbsp;<span class="ident" id="6128116">err</span>&nbsp;<span class="op" id="6128120">!=</span>&nbsp;<span class="ident" id="6128123">nil</span>&nbsp;<span class="op" id="6128127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128131">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6128139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6128142">dump</span>&nbsp;<span class="op" id="6128147">=</span>&nbsp;<span class="ident" id="6128149">b</span><span class="op" id="6128150">.</span><span class="ident" id="6128151">Bytes</span><span class="op" id="6128156">(</span><span class="op" id="6128157">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128160">return</span><br>
<span class="lineno"></span><span class="op" id="6128167">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6128170">//&nbsp;errNoBody&nbsp;is&nbsp;a&nbsp;sentinel&nbsp;error&nbsp;value&nbsp;used&nbsp;by&nbsp;failureToReadBody&nbsp;so&nbsp;we&nbsp;can&nbsp;detect</span><br>
<span class="lineno"></span><span class="comment" id="6128252">//&nbsp;that&nbsp;the&nbsp;lack&nbsp;of&nbsp;body&nbsp;was&nbsp;intentional.</span><br>
<span class="lineno">245</span><span class="keyword" id="6128294">var</span>&nbsp;<span class="ident" id="6128298">errNoBody</span>&nbsp;<span class="op" id="6128308">=</span>&nbsp;<span class="ident" id="6128310">errors</span><span class="op" id="6128316">.</span><span class="ident" id="6128317">New</span><span class="op" id="6128320">(</span><span class="string" id="6128321">&#34;sentinel&nbsp;error&nbsp;value&#34;</span><span class="op" id="6128343">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6128346">//&nbsp;failureToReadBody&nbsp;is&nbsp;a&nbsp;io.ReadCloser&nbsp;that&nbsp;just&nbsp;returns&nbsp;errNoBody&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="6128417">//&nbsp;Read.&nbsp;&nbsp;It&#39;s&nbsp;swapped&nbsp;in&nbsp;when&nbsp;we&nbsp;don&#39;t&nbsp;actually&nbsp;want&nbsp;to&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6128486">//&nbsp;body,&nbsp;but&nbsp;need&nbsp;a&nbsp;non-nil&nbsp;one,&nbsp;and&nbsp;want&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;error</span><br>
<span class="lineno">250</span><span class="comment" id="6128553">//&nbsp;from&nbsp;reading&nbsp;the&nbsp;dummy&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="6128585">type</span>&nbsp;<span class="ident" id="6128590">failureToReadBody</span>&nbsp;<span class="keyword" id="6128608">struct</span><span class="op" id="6128614">{</span><span class="op" id="6128615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6128618">func</span>&nbsp;<span class="op" id="6128623">(</span><span class="ident" id="6128624">failureToReadBody</span><span class="op" id="6128641">)</span>&nbsp;<span class="ident" id="6128643">Read</span><span class="op" id="6128647">(</span><span class="op" id="6128648">[</span><span class="op" id="6128649">]</span><span class="builtintype" id="6128650">byte</span><span class="op" id="6128654">)</span>&nbsp;<span class="op" id="6128656">(</span><span class="builtintype" id="6128657">int</span><span class="op" id="6128660">,</span>&nbsp;<span class="builtintype" id="6128662">error</span><span class="op" id="6128667">)</span>&nbsp;<span class="op" id="6128669">{</span>&nbsp;<span class="keyword" id="6128671">return</span>&nbsp;<span class="num" id="6128678">0</span><span class="op" id="6128679">,</span>&nbsp;<span class="ident" id="6128681">errNoBody</span>&nbsp;<span class="op" id="6128691">}</span><br>
<span class="lineno"></span><span class="keyword" id="6128693">func</span>&nbsp;<span class="op" id="6128698">(</span><span class="ident" id="6128699">failureToReadBody</span><span class="op" id="6128716">)</span>&nbsp;<span class="ident" id="6128718">Close</span><span class="op" id="6128723">(</span><span class="op" id="6128724">)</span>&nbsp;<span class="builtintype" id="6128726">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6128744">{</span>&nbsp;<span class="keyword" id="6128746">return</span>&nbsp;<span class="ident" id="6128753">nil</span>&nbsp;<span class="op" id="6128757">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="6128760">var</span>&nbsp;<span class="ident" id="6128764">emptyBody</span>&nbsp;<span class="op" id="6128774">=</span>&nbsp;<span class="ident" id="6128776">ioutil</span><span class="op" id="6128782">.</span><span class="ident" id="6128783">NopCloser</span><span class="op" id="6128792">(</span><span class="ident" id="6128793">strings</span><span class="op" id="6128800">.</span><span class="ident" id="6128801">NewReader</span><span class="op" id="6128810">(</span><span class="string" id="6128811">&#34;&#34;</span><span class="op" id="6128813">)</span><span class="op" id="6128814">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6128817">//&nbsp;DumpResponse&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;dumps&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="6128875">func</span>&nbsp;<span class="ident" id="6128880">DumpResponse</span><span class="op" id="6128892">(</span><span class="ident" id="6128893">resp</span>&nbsp;<span class="op" id="6128898">*</span><span class="ident" id="6128899">http</span><span class="op" id="6128903">.</span><span class="ident" id="6128904">Response</span><span class="op" id="6128912">,</span>&nbsp;<span class="ident" id="6128914">body</span>&nbsp;<span class="builtintype" id="6128919">bool</span><span class="op" id="6128923">)</span>&nbsp;<span class="op" id="6128925">(</span><span class="ident" id="6128926">dump</span>&nbsp;<span class="op" id="6128931">[</span><span class="op" id="6128932">]</span><span class="builtintype" id="6128933">byte</span><span class="op" id="6128937">,</span>&nbsp;<span class="ident" id="6128939">err</span>&nbsp;<span class="builtintype" id="6128943">error</span><span class="op" id="6128948">)</span>&nbsp;<span class="op" id="6128950">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6128953">var</span>&nbsp;<span class="ident" id="6128957">b</span>&nbsp;<span class="ident" id="6128959">bytes</span><span class="op" id="6128964">.</span><span class="ident" id="6128965">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6128973">save</span>&nbsp;<span class="op" id="6128978">:=</span>&nbsp;<span class="ident" id="6128981">resp</span><span class="op" id="6128985">.</span><span class="ident" id="6128986">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6128992">savecl</span>&nbsp;<span class="op" id="6128999">:=</span>&nbsp;<span class="ident" id="6129002">resp</span><span class="op" id="6129006">.</span><span class="ident" id="6129007">ContentLength</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129023">if</span>&nbsp;<span class="op" id="6129026">!</span><span class="ident" id="6129027">body</span>&nbsp;<span class="op" id="6129032">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129036">resp</span><span class="op" id="6129040">.</span><span class="ident" id="6129041">Body</span>&nbsp;<span class="op" id="6129046">=</span>&nbsp;<span class="ident" id="6129048">failureToReadBody</span><span class="op" id="6129065">{</span><span class="op" id="6129066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6129069">}</span>&nbsp;<span class="keyword" id="6129071">else</span>&nbsp;<span class="keyword" id="6129076">if</span>&nbsp;<span class="ident" id="6129079">resp</span><span class="op" id="6129083">.</span><span class="ident" id="6129084">Body</span>&nbsp;<span class="op" id="6129089">==</span>&nbsp;<span class="ident" id="6129092">nil</span>&nbsp;<span class="op" id="6129096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129100">resp</span><span class="op" id="6129104">.</span><span class="ident" id="6129105">Body</span>&nbsp;<span class="op" id="6129110">=</span>&nbsp;<span class="ident" id="6129112">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6129123">}</span>&nbsp;<span class="keyword" id="6129125">else</span>&nbsp;<span class="op" id="6129130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129134">save</span><span class="op" id="6129138">,</span>&nbsp;<span class="ident" id="6129140">resp</span><span class="op" id="6129144">.</span><span class="ident" id="6129145">Body</span><span class="op" id="6129149">,</span>&nbsp;<span class="ident" id="6129151">err</span>&nbsp;<span class="op" id="6129155">=</span>&nbsp;<span class="ident" id="6129157">drainBody</span><span class="op" id="6129166">(</span><span class="ident" id="6129167">resp</span><span class="op" id="6129171">.</span><span class="ident" id="6129172">Body</span><span class="op" id="6129176">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129180">if</span>&nbsp;<span class="ident" id="6129183">err</span>&nbsp;<span class="op" id="6129187">!=</span>&nbsp;<span class="ident" id="6129190">nil</span>&nbsp;<span class="op" id="6129194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129199">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6129208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6129211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129214">err</span>&nbsp;<span class="op" id="6129218">=</span>&nbsp;<span class="ident" id="6129220">resp</span><span class="op" id="6129224">.</span><span class="ident" id="6129225">Write</span><span class="op" id="6129230">(</span><span class="op" id="6129231">&amp;</span><span class="ident" id="6129232">b</span><span class="op" id="6129233">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129236">if</span>&nbsp;<span class="ident" id="6129239">err</span>&nbsp;<span class="op" id="6129243">==</span>&nbsp;<span class="ident" id="6129246">errNoBody</span>&nbsp;<span class="op" id="6129256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129260">err</span>&nbsp;<span class="op" id="6129264">=</span>&nbsp;<span class="ident" id="6129266">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6129271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129274">resp</span><span class="op" id="6129278">.</span><span class="ident" id="6129279">Body</span>&nbsp;<span class="op" id="6129284">=</span>&nbsp;<span class="ident" id="6129286">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6129292">resp</span><span class="op" id="6129296">.</span><span class="ident" id="6129297">ContentLength</span>&nbsp;<span class="op" id="6129311">=</span>&nbsp;<span class="ident" id="6129313">savecl</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129321">if</span>&nbsp;<span class="ident" id="6129324">err</span>&nbsp;<span class="op" id="6129328">!=</span>&nbsp;<span class="ident" id="6129331">nil</span>&nbsp;<span class="op" id="6129335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129339">return</span>&nbsp;<span class="ident" id="6129346">nil</span><span class="op" id="6129349">,</span>&nbsp;<span class="ident" id="6129351">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6129356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6129359">return</span>&nbsp;<span class="ident" id="6129366">b</span><span class="op" id="6129367">.</span><span class="ident" id="6129368">Bytes</span><span class="op" id="6129373">(</span><span class="op" id="6129374">)</span><span class="op" id="6129375">,</span>&nbsp;<span class="ident" id="6129377">nil</span><br>
<span class="lineno"></span><span class="op" id="6129381">}</span>
</div>
</body>
</html>
