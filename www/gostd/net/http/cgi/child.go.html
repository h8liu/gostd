<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html" class="current">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4776751">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4776806">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4776860">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4776911">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;CGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="4776971">//&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4776984">package</span>&nbsp;<span class="ident" id="4776992">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="4776997">import</span>&nbsp;<span class="op" id="4777004">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4777007">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4777016">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4777030">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4777040">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4777047">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4777053">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4777066">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4777073">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4777085">&#34;net/url&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4777096">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4777102">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4777113">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="4777123">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="4777126">//&nbsp;Request&nbsp;returns&nbsp;the&nbsp;HTTP&nbsp;request&nbsp;as&nbsp;represented&nbsp;in&nbsp;the&nbsp;current</span><br>
<span class="lineno"></span><span class="comment" id="4777192">//&nbsp;environment.&nbsp;This&nbsp;assumes&nbsp;the&nbsp;current&nbsp;program&nbsp;is&nbsp;being&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="4777254">//&nbsp;by&nbsp;a&nbsp;web&nbsp;server&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment.</span><br>
<span class="lineno"></span><span class="comment" id="4777295">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;is&nbsp;populated,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="4777355">func</span>&nbsp;<span class="ident" id="4777360">Request</span><span class="op" id="4777367">(</span><span class="op" id="4777368">)</span>&nbsp;<span class="op" id="4777370">(</span><span class="op" id="4777371">*</span><span class="ident" id="4777372">http</span><span class="op" id="4777376">.</span><span class="ident" id="4777377">Request</span><span class="op" id="4777384">,</span>&nbsp;<span class="builtintype" id="4777386">error</span><span class="op" id="4777391">)</span>&nbsp;<span class="op" id="4777393">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777396">r</span><span class="op" id="4777397">,</span>&nbsp;<span class="ident" id="4777399">err</span>&nbsp;<span class="op" id="4777403">:=</span>&nbsp;<span class="ident" id="4777406">RequestFromMap</span><span class="op" id="4777420">(</span><span class="ident" id="4777421">envMap</span><span class="op" id="4777427">(</span><span class="ident" id="4777428">os</span><span class="op" id="4777430">.</span><span class="ident" id="4777431">Environ</span><span class="op" id="4777438">(</span><span class="op" id="4777439">)</span><span class="op" id="4777440">)</span><span class="op" id="4777441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777444">if</span>&nbsp;<span class="ident" id="4777447">err</span>&nbsp;<span class="op" id="4777451">!=</span>&nbsp;<span class="ident" id="4777454">nil</span>&nbsp;<span class="op" id="4777458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777462">return</span>&nbsp;<span class="ident" id="4777469">nil</span><span class="op" id="4777472">,</span>&nbsp;<span class="ident" id="4777474">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4777479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777482">if</span>&nbsp;<span class="ident" id="4777485">r</span><span class="op" id="4777486">.</span><span class="ident" id="4777487">ContentLength</span>&nbsp;<span class="op" id="4777501">&gt;</span>&nbsp;<span class="num" id="4777503">0</span>&nbsp;<span class="op" id="4777505">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777509">r</span><span class="op" id="4777510">.</span><span class="ident" id="4777511">Body</span>&nbsp;<span class="op" id="4777516">=</span>&nbsp;<span class="ident" id="4777518">ioutil</span><span class="op" id="4777524">.</span><span class="ident" id="4777525">NopCloser</span><span class="op" id="4777534">(</span><span class="ident" id="4777535">io</span><span class="op" id="4777537">.</span><span class="ident" id="4777538">LimitReader</span><span class="op" id="4777549">(</span><span class="ident" id="4777550">os</span><span class="op" id="4777552">.</span><span class="ident" id="4777553">Stdin</span><span class="op" id="4777558">,</span>&nbsp;<span class="ident" id="4777560">r</span><span class="op" id="4777561">.</span><span class="ident" id="4777562">ContentLength</span><span class="op" id="4777575">)</span><span class="op" id="4777576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4777579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777582">return</span>&nbsp;<span class="ident" id="4777589">r</span><span class="op" id="4777590">,</span>&nbsp;<span class="ident" id="4777592">nil</span><br>
<span class="lineno"></span><span class="op" id="4777596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="4777599">func</span>&nbsp;<span class="ident" id="4777604">envMap</span><span class="op" id="4777610">(</span><span class="ident" id="4777611">env</span>&nbsp;<span class="op" id="4777615">[</span><span class="op" id="4777616">]</span><span class="builtintype" id="4777617">string</span><span class="op" id="4777623">)</span>&nbsp;<span class="keyword" id="4777625">map</span><span class="op" id="4777628">[</span><span class="builtintype" id="4777629">string</span><span class="op" id="4777635">]</span><span class="builtintype" id="4777636">string</span>&nbsp;<span class="op" id="4777643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777646">m</span>&nbsp;<span class="op" id="4777648">:=</span>&nbsp;<span class="builtinfunc" id="4777651">make</span><span class="op" id="4777655">(</span><span class="keyword" id="4777656">map</span><span class="op" id="4777659">[</span><span class="builtintype" id="4777660">string</span><span class="op" id="4777666">]</span><span class="builtintype" id="4777667">string</span><span class="op" id="4777673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777676">for</span>&nbsp;<span class="ident" id="4777680">_</span><span class="op" id="4777681">,</span>&nbsp;<span class="ident" id="4777683">kv</span>&nbsp;<span class="op" id="4777686">:=</span>&nbsp;<span class="keyword" id="4777689">range</span>&nbsp;<span class="ident" id="4777695">env</span>&nbsp;<span class="op" id="4777699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777703">if</span>&nbsp;<span class="ident" id="4777706">idx</span>&nbsp;<span class="op" id="4777710">:=</span>&nbsp;<span class="ident" id="4777713">strings</span><span class="op" id="4777720">.</span><span class="ident" id="4777721">Index</span><span class="op" id="4777726">(</span><span class="ident" id="4777727">kv</span><span class="op" id="4777729">,</span>&nbsp;<span class="string" id="4777731">&#34;=&#34;</span><span class="op" id="4777734">)</span><span class="op" id="4777735">;</span>&nbsp;<span class="ident" id="4777737">idx</span>&nbsp;<span class="op" id="4777741">!=</span>&nbsp;<span class="op" id="4777744">-</span><span class="num" id="4777745">1</span>&nbsp;<span class="op" id="4777747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777752">m</span><span class="op" id="4777753">[</span><span class="ident" id="4777754">kv</span><span class="op" id="4777756">[</span><span class="op" id="4777757">:</span><span class="ident" id="4777758">idx</span><span class="op" id="4777761">]</span><span class="op" id="4777762">]</span>&nbsp;<span class="op" id="4777764">=</span>&nbsp;<span class="ident" id="4777766">kv</span><span class="op" id="4777768">[</span><span class="ident" id="4777769">idx</span><span class="op" id="4777772">+</span><span class="num" id="4777773">1</span><span class="op" id="4777774">:</span><span class="op" id="4777775">]</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4777779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4777782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4777785">return</span>&nbsp;<span class="ident" id="4777792">m</span><br>
<span class="lineno"></span><span class="op" id="4777794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="4777797">//&nbsp;RequestFromMap&nbsp;creates&nbsp;an&nbsp;http.Request&nbsp;from&nbsp;CGI&nbsp;variables.</span><br>
<span class="lineno"></span><span class="comment" id="4777859">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;field&nbsp;is&nbsp;not&nbsp;populated.</span><br>
<span class="lineno"></span><span class="keyword" id="4777914">func</span>&nbsp;<span class="ident" id="4777919">RequestFromMap</span><span class="op" id="4777933">(</span><span class="ident" id="4777934">params</span>&nbsp;<span class="keyword" id="4777941">map</span><span class="op" id="4777944">[</span><span class="builtintype" id="4777945">string</span><span class="op" id="4777951">]</span><span class="builtintype" id="4777952">string</span><span class="op" id="4777958">)</span>&nbsp;<span class="op" id="4777960">(</span><span class="op" id="4777961">*</span><span class="ident" id="4777962">http</span><span class="op" id="4777966">.</span><span class="ident" id="4777967">Request</span><span class="op" id="4777974">,</span>&nbsp;<span class="builtintype" id="4777976">error</span><span class="op" id="4777981">)</span>&nbsp;<span class="op" id="4777983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4777986">r</span>&nbsp;<span class="op" id="4777988">:=</span>&nbsp;<span class="builtinfunc" id="4777991">new</span><span class="op" id="4777994">(</span><span class="ident" id="4777995">http</span><span class="op" id="4777999">.</span><span class="ident" id="4778000">Request</span><span class="op" id="4778007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778010">r</span><span class="op" id="4778011">.</span><span class="ident" id="4778012">Method</span>&nbsp;<span class="op" id="4778019">=</span>&nbsp;<span class="ident" id="4778021">params</span><span class="op" id="4778027">[</span><span class="string" id="4778028">&#34;REQUEST_METHOD&#34;</span><span class="op" id="4778044">]</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778047">if</span>&nbsp;<span class="ident" id="4778050">r</span><span class="op" id="4778051">.</span><span class="ident" id="4778052">Method</span>&nbsp;<span class="op" id="4778059">==</span>&nbsp;<span class="string" id="4778062">&#34;&#34;</span>&nbsp;<span class="op" id="4778065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778069">return</span>&nbsp;<span class="ident" id="4778076">nil</span><span class="op" id="4778079">,</span>&nbsp;<span class="ident" id="4778081">errors</span><span class="op" id="4778087">.</span><span class="ident" id="4778088">New</span><span class="op" id="4778091">(</span><span class="string" id="4778092">&#34;cgi:&nbsp;no&nbsp;REQUEST_METHOD&nbsp;in&nbsp;environment&#34;</span><span class="op" id="4778131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4778134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778138">r</span><span class="op" id="4778139">.</span><span class="ident" id="4778140">Proto</span>&nbsp;<span class="op" id="4778146">=</span>&nbsp;<span class="ident" id="4778148">params</span><span class="op" id="4778154">[</span><span class="string" id="4778155">&#34;SERVER_PROTOCOL&#34;</span><span class="op" id="4778172">]</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778175">var</span>&nbsp;<span class="ident" id="4778179">ok</span>&nbsp;<span class="builtintype" id="4778182">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778188">r</span><span class="op" id="4778189">.</span><span class="ident" id="4778190">ProtoMajor</span><span class="op" id="4778200">,</span>&nbsp;<span class="ident" id="4778202">r</span><span class="op" id="4778203">.</span><span class="ident" id="4778204">ProtoMinor</span><span class="op" id="4778214">,</span>&nbsp;<span class="ident" id="4778216">ok</span>&nbsp;<span class="op" id="4778219">=</span>&nbsp;<span class="ident" id="4778221">http</span><span class="op" id="4778225">.</span><span class="ident" id="4778226">ParseHTTPVersion</span><span class="op" id="4778242">(</span><span class="ident" id="4778243">r</span><span class="op" id="4778244">.</span><span class="ident" id="4778245">Proto</span><span class="op" id="4778250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778253">if</span>&nbsp;<span class="op" id="4778256">!</span><span class="ident" id="4778257">ok</span>&nbsp;<span class="op" id="4778260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778264">return</span>&nbsp;<span class="ident" id="4778271">nil</span><span class="op" id="4778274">,</span>&nbsp;<span class="ident" id="4778276">errors</span><span class="op" id="4778282">.</span><span class="ident" id="4778283">New</span><span class="op" id="4778286">(</span><span class="string" id="4778287">&#34;cgi:&nbsp;invalid&nbsp;SERVER_PROTOCOL&nbsp;version&#34;</span><span class="op" id="4778325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4778328">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778332">r</span><span class="op" id="4778333">.</span><span class="ident" id="4778334">Close</span>&nbsp;<span class="op" id="4778340">=</span>&nbsp;<span class="builtintype" id="4778342">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778348">r</span><span class="op" id="4778349">.</span><span class="ident" id="4778350">Trailer</span>&nbsp;<span class="op" id="4778358">=</span>&nbsp;<span class="ident" id="4778360">http</span><span class="op" id="4778364">.</span><span class="ident" id="4778365">Header</span><span class="op" id="4778371">{</span><span class="op" id="4778372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778375">r</span><span class="op" id="4778376">.</span><span class="ident" id="4778377">Header</span>&nbsp;<span class="op" id="4778384">=</span>&nbsp;<span class="ident" id="4778386">http</span><span class="op" id="4778390">.</span><span class="ident" id="4778391">Header</span><span class="op" id="4778397">{</span><span class="op" id="4778398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778402">r</span><span class="op" id="4778403">.</span><span class="ident" id="4778404">Host</span>&nbsp;<span class="op" id="4778409">=</span>&nbsp;<span class="ident" id="4778411">params</span><span class="op" id="4778417">[</span><span class="string" id="4778418">&#34;HTTP_HOST&#34;</span><span class="op" id="4778429">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778433">if</span>&nbsp;<span class="ident" id="4778436">lenstr</span>&nbsp;<span class="op" id="4778443">:=</span>&nbsp;<span class="ident" id="4778446">params</span><span class="op" id="4778452">[</span><span class="string" id="4778453">&#34;CONTENT_LENGTH&#34;</span><span class="op" id="4778469">]</span><span class="op" id="4778470">;</span>&nbsp;<span class="ident" id="4778472">lenstr</span>&nbsp;<span class="op" id="4778479">!=</span>&nbsp;<span class="string" id="4778482">&#34;&#34;</span>&nbsp;<span class="op" id="4778485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778489">clen</span><span class="op" id="4778493">,</span>&nbsp;<span class="ident" id="4778495">err</span>&nbsp;<span class="op" id="4778499">:=</span>&nbsp;<span class="ident" id="4778502">strconv</span><span class="op" id="4778509">.</span><span class="ident" id="4778510">ParseInt</span><span class="op" id="4778518">(</span><span class="ident" id="4778519">lenstr</span><span class="op" id="4778525">,</span>&nbsp;<span class="num" id="4778527">10</span><span class="op" id="4778529">,</span>&nbsp;<span class="num" id="4778531">64</span><span class="op" id="4778533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778537">if</span>&nbsp;<span class="ident" id="4778540">err</span>&nbsp;<span class="op" id="4778544">!=</span>&nbsp;<span class="ident" id="4778547">nil</span>&nbsp;<span class="op" id="4778551">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778556">return</span>&nbsp;<span class="ident" id="4778563">nil</span><span class="op" id="4778566">,</span>&nbsp;<span class="ident" id="4778568">errors</span><span class="op" id="4778574">.</span><span class="ident" id="4778575">New</span><span class="op" id="4778578">(</span><span class="string" id="4778579">&#34;cgi:&nbsp;bad&nbsp;CONTENT_LENGTH&nbsp;in&nbsp;environment:&nbsp;&#34;</span>&nbsp;<span class="op" id="4778622">+</span>&nbsp;<span class="ident" id="4778624">lenstr</span><span class="op" id="4778630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4778634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778638">r</span><span class="op" id="4778639">.</span><span class="ident" id="4778640">ContentLength</span>&nbsp;<span class="op" id="4778654">=</span>&nbsp;<span class="ident" id="4778656">clen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4778662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778666">if</span>&nbsp;<span class="ident" id="4778669">ct</span>&nbsp;<span class="op" id="4778672">:=</span>&nbsp;<span class="ident" id="4778675">params</span><span class="op" id="4778681">[</span><span class="string" id="4778682">&#34;CONTENT_TYPE&#34;</span><span class="op" id="4778696">]</span><span class="op" id="4778697">;</span>&nbsp;<span class="ident" id="4778699">ct</span>&nbsp;<span class="op" id="4778702">!=</span>&nbsp;<span class="string" id="4778705">&#34;&#34;</span>&nbsp;<span class="op" id="4778708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778712">r</span><span class="op" id="4778713">.</span><span class="ident" id="4778714">Header</span><span class="op" id="4778720">.</span><span class="ident" id="4778721">Set</span><span class="op" id="4778724">(</span><span class="string" id="4778725">&#34;Content-Type&#34;</span><span class="op" id="4778739">,</span>&nbsp;<span class="ident" id="4778741">ct</span><span class="op" id="4778743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4778746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4778750">//&nbsp;Copy&nbsp;&#34;HTTP_FOO_BAR&#34;&nbsp;variables&nbsp;to&nbsp;&#34;Foo-Bar&#34;&nbsp;Headers</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778805">for</span>&nbsp;<span class="ident" id="4778809">k</span><span class="op" id="4778810">,</span>&nbsp;<span class="ident" id="4778812">v</span>&nbsp;<span class="op" id="4778814">:=</span>&nbsp;<span class="keyword" id="4778817">range</span>&nbsp;<span class="ident" id="4778823">params</span>&nbsp;<span class="op" id="4778830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778834">if</span>&nbsp;<span class="op" id="4778837">!</span><span class="ident" id="4778838">strings</span><span class="op" id="4778845">.</span><span class="ident" id="4778846">HasPrefix</span><span class="op" id="4778855">(</span><span class="ident" id="4778856">k</span><span class="op" id="4778857">,</span>&nbsp;<span class="string" id="4778859">&#34;HTTP_&#34;</span><span class="op" id="4778866">)</span>&nbsp;<span class="op" id="4778868">||</span>&nbsp;<span class="ident" id="4778871">k</span>&nbsp;<span class="op" id="4778873">==</span>&nbsp;<span class="string" id="4778876">&#34;HTTP_HOST&#34;</span>&nbsp;<span class="op" id="4778888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4778893">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4778904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4778908">r</span><span class="op" id="4778909">.</span><span class="ident" id="4778910">Header</span><span class="op" id="4778916">.</span><span class="ident" id="4778917">Add</span><span class="op" id="4778920">(</span><span class="ident" id="4778921">strings</span><span class="op" id="4778928">.</span><span class="ident" id="4778929">Replace</span><span class="op" id="4778936">(</span><span class="ident" id="4778937">k</span><span class="op" id="4778938">[</span><span class="num" id="4778939">5</span><span class="op" id="4778940">:</span><span class="op" id="4778941">]</span><span class="op" id="4778942">,</span>&nbsp;<span class="string" id="4778944">&#34;_&#34;</span><span class="op" id="4778947">,</span>&nbsp;<span class="string" id="4778949">&#34;-&#34;</span><span class="op" id="4778952">,</span>&nbsp;<span class="op" id="4778954">-</span><span class="num" id="4778955">1</span><span class="op" id="4778956">)</span><span class="op" id="4778957">,</span>&nbsp;<span class="ident" id="4778959">v</span><span class="op" id="4778960">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4778963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4778967">//&nbsp;TODO:&nbsp;cookies.&nbsp;&nbsp;parsing&nbsp;them&nbsp;isn&#39;t&nbsp;exported,&nbsp;though.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779025">uriStr</span>&nbsp;<span class="op" id="4779032">:=</span>&nbsp;<span class="ident" id="4779035">params</span><span class="op" id="4779041">[</span><span class="string" id="4779042">&#34;REQUEST_URI&#34;</span><span class="op" id="4779055">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779058">if</span>&nbsp;<span class="ident" id="4779061">uriStr</span>&nbsp;<span class="op" id="4779068">==</span>&nbsp;<span class="string" id="4779071">&#34;&#34;</span>&nbsp;<span class="op" id="4779074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4779078">//&nbsp;Fallback&nbsp;to&nbsp;SCRIPT_NAME,&nbsp;PATH_INFO&nbsp;and&nbsp;QUERY_STRING.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779136">uriStr</span>&nbsp;<span class="op" id="4779143">=</span>&nbsp;<span class="ident" id="4779145">params</span><span class="op" id="4779151">[</span><span class="string" id="4779152">&#34;SCRIPT_NAME&#34;</span><span class="op" id="4779165">]</span>&nbsp;<span class="op" id="4779167">+</span>&nbsp;<span class="ident" id="4779169">params</span><span class="op" id="4779175">[</span><span class="string" id="4779176">&#34;PATH_INFO&#34;</span><span class="op" id="4779187">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779191">s</span>&nbsp;<span class="op" id="4779193">:=</span>&nbsp;<span class="ident" id="4779196">params</span><span class="op" id="4779202">[</span><span class="string" id="4779203">&#34;QUERY_STRING&#34;</span><span class="op" id="4779217">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779221">if</span>&nbsp;<span class="ident" id="4779224">s</span>&nbsp;<span class="op" id="4779226">!=</span>&nbsp;<span class="string" id="4779229">&#34;&#34;</span>&nbsp;<span class="op" id="4779232">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779237">uriStr</span>&nbsp;<span class="op" id="4779244">+=</span>&nbsp;<span class="string" id="4779247">&#34;?&#34;</span>&nbsp;<span class="op" id="4779251">+</span>&nbsp;<span class="ident" id="4779253">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4779257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4779260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4779264">//&nbsp;There&#39;s&nbsp;apparently&nbsp;a&nbsp;de-facto&nbsp;standard&nbsp;for&nbsp;this.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4779317">//&nbsp;http://docstore.mik.ua/orelly/linux/cgi/ch03_02.htm#ch03-35636</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779384">if</span>&nbsp;<span class="ident" id="4779387">s</span>&nbsp;<span class="op" id="4779389">:=</span>&nbsp;<span class="ident" id="4779392">params</span><span class="op" id="4779398">[</span><span class="string" id="4779399">&#34;HTTPS&#34;</span><span class="op" id="4779406">]</span><span class="op" id="4779407">;</span>&nbsp;<span class="ident" id="4779409">s</span>&nbsp;<span class="op" id="4779411">==</span>&nbsp;<span class="string" id="4779414">&#34;on&#34;</span>&nbsp;<span class="op" id="4779419">||</span>&nbsp;<span class="ident" id="4779422">s</span>&nbsp;<span class="op" id="4779424">==</span>&nbsp;<span class="string" id="4779427">&#34;ON&#34;</span>&nbsp;<span class="op" id="4779432">||</span>&nbsp;<span class="ident" id="4779435">s</span>&nbsp;<span class="op" id="4779437">==</span>&nbsp;<span class="string" id="4779440">&#34;1&#34;</span>&nbsp;<span class="op" id="4779444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779448">r</span><span class="op" id="4779449">.</span><span class="ident" id="4779450">TLS</span>&nbsp;<span class="op" id="4779454">=</span>&nbsp;<span class="op" id="4779456">&amp;</span><span class="ident" id="4779457">tls</span><span class="op" id="4779460">.</span><span class="ident" id="4779461">ConnectionState</span><span class="op" id="4779476">{</span><span class="ident" id="4779477">HandshakeComplete</span><span class="op" id="4779494">:</span>&nbsp;<span class="builtintype" id="4779496">true</span><span class="op" id="4779500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4779503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779507">if</span>&nbsp;<span class="ident" id="4779510">r</span><span class="op" id="4779511">.</span><span class="ident" id="4779512">Host</span>&nbsp;<span class="op" id="4779517">!=</span>&nbsp;<span class="string" id="4779520">&#34;&#34;</span>&nbsp;<span class="op" id="4779523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4779527">//&nbsp;Hostname&nbsp;is&nbsp;provided,&nbsp;so&nbsp;we&nbsp;can&nbsp;reasonably&nbsp;construct&nbsp;a&nbsp;URL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779592">rawurl</span>&nbsp;<span class="op" id="4779599">:=</span>&nbsp;<span class="ident" id="4779602">r</span><span class="op" id="4779603">.</span><span class="ident" id="4779604">Host</span>&nbsp;<span class="op" id="4779609">+</span>&nbsp;<span class="ident" id="4779611">uriStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779620">if</span>&nbsp;<span class="ident" id="4779623">r</span><span class="op" id="4779624">.</span><span class="ident" id="4779625">TLS</span>&nbsp;<span class="op" id="4779629">==</span>&nbsp;<span class="ident" id="4779632">nil</span>&nbsp;<span class="op" id="4779636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779641">rawurl</span>&nbsp;<span class="op" id="4779648">=</span>&nbsp;<span class="string" id="4779650">&#34;http://&#34;</span>&nbsp;<span class="op" id="4779660">+</span>&nbsp;<span class="ident" id="4779662">rawurl</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4779671">}</span>&nbsp;<span class="keyword" id="4779673">else</span>&nbsp;<span class="op" id="4779678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779683">rawurl</span>&nbsp;<span class="op" id="4779690">=</span>&nbsp;<span class="string" id="4779692">&#34;https://&#34;</span>&nbsp;<span class="op" id="4779703">+</span>&nbsp;<span class="ident" id="4779705">rawurl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4779714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779718">url</span><span class="op" id="4779721">,</span>&nbsp;<span class="ident" id="4779723">err</span>&nbsp;<span class="op" id="4779727">:=</span>&nbsp;<span class="ident" id="4779730">url</span><span class="op" id="4779733">.</span><span class="ident" id="4779734">Parse</span><span class="op" id="4779739">(</span><span class="ident" id="4779740">rawurl</span><span class="op" id="4779746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779750">if</span>&nbsp;<span class="ident" id="4779753">err</span>&nbsp;<span class="op" id="4779757">!=</span>&nbsp;<span class="ident" id="4779760">nil</span>&nbsp;<span class="op" id="4779764">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779769">return</span>&nbsp;<span class="ident" id="4779776">nil</span><span class="op" id="4779779">,</span>&nbsp;<span class="ident" id="4779781">errors</span><span class="op" id="4779787">.</span><span class="ident" id="4779788">New</span><span class="op" id="4779791">(</span><span class="string" id="4779792">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;host&nbsp;and&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="4779849">+</span>&nbsp;<span class="ident" id="4779851">rawurl</span><span class="op" id="4779857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4779861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779865">r</span><span class="op" id="4779866">.</span><span class="ident" id="4779867">URL</span>&nbsp;<span class="op" id="4779871">=</span>&nbsp;<span class="ident" id="4779873">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4779878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4779881">//&nbsp;Fallback&nbsp;logic&nbsp;if&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a&nbsp;Host&nbsp;header&nbsp;or&nbsp;the&nbsp;URL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4779942">//&nbsp;failed&nbsp;to&nbsp;parse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4779962">if</span>&nbsp;<span class="ident" id="4779965">r</span><span class="op" id="4779966">.</span><span class="ident" id="4779967">URL</span>&nbsp;<span class="op" id="4779971">==</span>&nbsp;<span class="ident" id="4779974">nil</span>&nbsp;<span class="op" id="4779978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4779982">url</span><span class="op" id="4779985">,</span>&nbsp;<span class="ident" id="4779987">err</span>&nbsp;<span class="op" id="4779991">:=</span>&nbsp;<span class="ident" id="4779994">url</span><span class="op" id="4779997">.</span><span class="ident" id="4779998">Parse</span><span class="op" id="4780003">(</span><span class="ident" id="4780004">uriStr</span><span class="op" id="4780010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780014">if</span>&nbsp;<span class="ident" id="4780017">err</span>&nbsp;<span class="op" id="4780021">!=</span>&nbsp;<span class="ident" id="4780024">nil</span>&nbsp;<span class="op" id="4780028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780033">return</span>&nbsp;<span class="ident" id="4780040">nil</span><span class="op" id="4780043">,</span>&nbsp;<span class="ident" id="4780045">errors</span><span class="op" id="4780051">.</span><span class="ident" id="4780052">New</span><span class="op" id="4780055">(</span><span class="string" id="4780056">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="4780104">+</span>&nbsp;<span class="ident" id="4780106">uriStr</span><span class="op" id="4780112">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780120">r</span><span class="op" id="4780121">.</span><span class="ident" id="4780122">URL</span>&nbsp;<span class="op" id="4780126">=</span>&nbsp;<span class="ident" id="4780128">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4780137">//&nbsp;Request.RemoteAddr&nbsp;has&nbsp;its&nbsp;port&nbsp;set&nbsp;by&nbsp;Go&#39;s&nbsp;standard&nbsp;http</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4780199">//&nbsp;server,&nbsp;so&nbsp;we&nbsp;do&nbsp;here&nbsp;too.&nbsp;We&nbsp;don&#39;t&nbsp;have&nbsp;one,&nbsp;though,&nbsp;so&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4780263">//&nbsp;use&nbsp;a&nbsp;dummy&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780284">r</span><span class="op" id="4780285">.</span><span class="ident" id="4780286">RemoteAddr</span>&nbsp;<span class="op" id="4780297">=</span>&nbsp;<span class="ident" id="4780299">net</span><span class="op" id="4780302">.</span><span class="ident" id="4780303">JoinHostPort</span><span class="op" id="4780315">(</span><span class="ident" id="4780316">params</span><span class="op" id="4780322">[</span><span class="string" id="4780323">&#34;REMOTE_ADDR&#34;</span><span class="op" id="4780336">]</span><span class="op" id="4780337">,</span>&nbsp;<span class="string" id="4780339">&#34;0&#34;</span><span class="op" id="4780342">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780346">return</span>&nbsp;<span class="ident" id="4780353">r</span><span class="op" id="4780354">,</span>&nbsp;<span class="ident" id="4780356">nil</span><br>
<span class="lineno">140</span><span class="op" id="4780360">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4780363">//&nbsp;Serve&nbsp;executes&nbsp;the&nbsp;provided&nbsp;Handler&nbsp;on&nbsp;the&nbsp;currently&nbsp;active&nbsp;CGI</span><br>
<span class="lineno"></span><span class="comment" id="4780430">//&nbsp;request,&nbsp;if&nbsp;any.&nbsp;If&nbsp;there&#39;s&nbsp;no&nbsp;current&nbsp;CGI&nbsp;environment</span><br>
<span class="lineno"></span><span class="comment" id="4780488">//&nbsp;an&nbsp;error&nbsp;is&nbsp;returned.&nbsp;The&nbsp;provided&nbsp;handler&nbsp;may&nbsp;be&nbsp;nil&nbsp;to&nbsp;use</span><br>
<span class="lineno">145</span><span class="comment" id="4780552">//&nbsp;http.DefaultServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="4780577">func</span>&nbsp;<span class="ident" id="4780582">Serve</span><span class="op" id="4780587">(</span><span class="ident" id="4780588">handler</span>&nbsp;<span class="ident" id="4780596">http</span><span class="op" id="4780600">.</span><span class="ident" id="4780601">Handler</span><span class="op" id="4780608">)</span>&nbsp;<span class="builtintype" id="4780610">error</span>&nbsp;<span class="op" id="4780616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780619">req</span><span class="op" id="4780622">,</span>&nbsp;<span class="ident" id="4780624">err</span>&nbsp;<span class="op" id="4780628">:=</span>&nbsp;<span class="ident" id="4780631">Request</span><span class="op" id="4780638">(</span><span class="op" id="4780639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780642">if</span>&nbsp;<span class="ident" id="4780645">err</span>&nbsp;<span class="op" id="4780649">!=</span>&nbsp;<span class="ident" id="4780652">nil</span>&nbsp;<span class="op" id="4780656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780660">return</span>&nbsp;<span class="ident" id="4780667">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780675">if</span>&nbsp;<span class="ident" id="4780678">handler</span>&nbsp;<span class="op" id="4780686">==</span>&nbsp;<span class="ident" id="4780689">nil</span>&nbsp;<span class="op" id="4780693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780697">handler</span>&nbsp;<span class="op" id="4780705">=</span>&nbsp;<span class="ident" id="4780707">http</span><span class="op" id="4780711">.</span><span class="ident" id="4780712">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780729">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780732">rw</span>&nbsp;<span class="op" id="4780735">:=</span>&nbsp;<span class="op" id="4780738">&amp;</span><span class="ident" id="4780739">response</span><span class="op" id="4780747">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780751">req</span><span class="op" id="4780754">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4780759">req</span><span class="op" id="4780762">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780766">header</span><span class="op" id="4780772">:</span>&nbsp;<span class="builtinfunc" id="4780774">make</span><span class="op" id="4780778">(</span><span class="ident" id="4780779">http</span><span class="op" id="4780783">.</span><span class="ident" id="4780784">Header</span><span class="op" id="4780790">)</span><span class="op" id="4780791">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780795">bufw</span><span class="op" id="4780799">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4780803">bufio</span><span class="op" id="4780808">.</span><span class="ident" id="4780809">NewWriter</span><span class="op" id="4780818">(</span><span class="ident" id="4780819">os</span><span class="op" id="4780821">.</span><span class="ident" id="4780822">Stdout</span><span class="op" id="4780828">)</span><span class="op" id="4780829">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780835">handler</span><span class="op" id="4780842">.</span><span class="ident" id="4780843">ServeHTTP</span><span class="op" id="4780852">(</span><span class="ident" id="4780853">rw</span><span class="op" id="4780855">,</span>&nbsp;<span class="ident" id="4780857">req</span><span class="op" id="4780860">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4780863">rw</span><span class="op" id="4780865">.</span><span class="ident" id="4780866">Write</span><span class="op" id="4780871">(</span><span class="ident" id="4780872">nil</span><span class="op" id="4780875">)</span>&nbsp;<span class="comment" id="4780877">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;response&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780910">if</span>&nbsp;<span class="ident" id="4780913">err</span>&nbsp;<span class="op" id="4780917">=</span>&nbsp;<span class="ident" id="4780919">rw</span><span class="op" id="4780921">.</span><span class="ident" id="4780922">bufw</span><span class="op" id="4780926">.</span><span class="ident" id="4780927">Flush</span><span class="op" id="4780932">(</span><span class="op" id="4780933">)</span><span class="op" id="4780934">;</span>&nbsp;<span class="ident" id="4780936">err</span>&nbsp;<span class="op" id="4780940">!=</span>&nbsp;<span class="ident" id="4780943">nil</span>&nbsp;<span class="op" id="4780947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780951">return</span>&nbsp;<span class="ident" id="4780958">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4780963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4780966">return</span>&nbsp;<span class="ident" id="4780973">nil</span><br>
<span class="lineno">165</span><span class="op" id="4780977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4780980">type</span>&nbsp;<span class="ident" id="4780985">response</span>&nbsp;<span class="keyword" id="4780994">struct</span>&nbsp;<span class="op" id="4781001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781004">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4781015">*</span><span class="ident" id="4781016">http</span><span class="op" id="4781020">.</span><span class="ident" id="4781021">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781030">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4781041">http</span><span class="op" id="4781045">.</span><span class="ident" id="4781046">Header</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781054">bufw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4781065">*</span><span class="ident" id="4781066">bufio</span><span class="op" id="4781071">.</span><span class="ident" id="4781072">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781080">headerSent</span>&nbsp;<span class="builtintype" id="4781091">bool</span><br>
<span class="lineno"></span><span class="op" id="4781096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4781099">func</span>&nbsp;<span class="op" id="4781104">(</span><span class="ident" id="4781105">r</span>&nbsp;<span class="op" id="4781107">*</span><span class="ident" id="4781108">response</span><span class="op" id="4781116">)</span>&nbsp;<span class="ident" id="4781118">Flush</span><span class="op" id="4781123">(</span><span class="op" id="4781124">)</span>&nbsp;<span class="op" id="4781126">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781129">r</span><span class="op" id="4781130">.</span><span class="ident" id="4781131">bufw</span><span class="op" id="4781135">.</span><span class="ident" id="4781136">Flush</span><span class="op" id="4781141">(</span><span class="op" id="4781142">)</span><br>
<span class="lineno"></span><span class="op" id="4781144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4781147">func</span>&nbsp;<span class="op" id="4781152">(</span><span class="ident" id="4781153">r</span>&nbsp;<span class="op" id="4781155">*</span><span class="ident" id="4781156">response</span><span class="op" id="4781164">)</span>&nbsp;<span class="ident" id="4781166">Header</span><span class="op" id="4781172">(</span><span class="op" id="4781173">)</span>&nbsp;<span class="ident" id="4781175">http</span><span class="op" id="4781179">.</span><span class="ident" id="4781180">Header</span>&nbsp;<span class="op" id="4781187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781190">return</span>&nbsp;<span class="ident" id="4781197">r</span><span class="op" id="4781198">.</span><span class="ident" id="4781199">header</span><br>
<span class="lineno">180</span><span class="op" id="4781206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4781209">func</span>&nbsp;<span class="op" id="4781214">(</span><span class="ident" id="4781215">r</span>&nbsp;<span class="op" id="4781217">*</span><span class="ident" id="4781218">response</span><span class="op" id="4781226">)</span>&nbsp;<span class="ident" id="4781228">Write</span><span class="op" id="4781233">(</span><span class="ident" id="4781234">p</span>&nbsp;<span class="op" id="4781236">[</span><span class="op" id="4781237">]</span><span class="builtintype" id="4781238">byte</span><span class="op" id="4781242">)</span>&nbsp;<span class="op" id="4781244">(</span><span class="ident" id="4781245">n</span>&nbsp;<span class="builtintype" id="4781247">int</span><span class="op" id="4781250">,</span>&nbsp;<span class="ident" id="4781252">err</span>&nbsp;<span class="builtintype" id="4781256">error</span><span class="op" id="4781261">)</span>&nbsp;<span class="op" id="4781263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781266">if</span>&nbsp;<span class="op" id="4781269">!</span><span class="ident" id="4781270">r</span><span class="op" id="4781271">.</span><span class="ident" id="4781272">headerSent</span>&nbsp;<span class="op" id="4781283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781287">r</span><span class="op" id="4781288">.</span><span class="ident" id="4781289">WriteHeader</span><span class="op" id="4781300">(</span><span class="ident" id="4781301">http</span><span class="op" id="4781305">.</span><span class="ident" id="4781306">StatusOK</span><span class="op" id="4781314">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4781317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781320">return</span>&nbsp;<span class="ident" id="4781327">r</span><span class="op" id="4781328">.</span><span class="ident" id="4781329">bufw</span><span class="op" id="4781333">.</span><span class="ident" id="4781334">Write</span><span class="op" id="4781339">(</span><span class="ident" id="4781340">p</span><span class="op" id="4781341">)</span><br>
<span class="lineno"></span><span class="op" id="4781343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4781346">func</span>&nbsp;<span class="op" id="4781351">(</span><span class="ident" id="4781352">r</span>&nbsp;<span class="op" id="4781354">*</span><span class="ident" id="4781355">response</span><span class="op" id="4781363">)</span>&nbsp;<span class="ident" id="4781365">WriteHeader</span><span class="op" id="4781376">(</span><span class="ident" id="4781377">code</span>&nbsp;<span class="builtintype" id="4781382">int</span><span class="op" id="4781385">)</span>&nbsp;<span class="op" id="4781387">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781390">if</span>&nbsp;<span class="ident" id="4781393">r</span><span class="op" id="4781394">.</span><span class="ident" id="4781395">headerSent</span>&nbsp;<span class="op" id="4781406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4781410">//&nbsp;Note:&nbsp;explicitly&nbsp;using&nbsp;Stderr,&nbsp;as&nbsp;Stdout&nbsp;is&nbsp;our&nbsp;HTTP&nbsp;output.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781476">fmt</span><span class="op" id="4781479">.</span><span class="ident" id="4781480">Fprintf</span><span class="op" id="4781487">(</span><span class="ident" id="4781488">os</span><span class="op" id="4781490">.</span><span class="ident" id="4781491">Stderr</span><span class="op" id="4781497">,</span>&nbsp;<span class="string" id="4781499">&#34;CGI&nbsp;attempted&nbsp;to&nbsp;write&nbsp;header&nbsp;twice&nbsp;on&nbsp;request&nbsp;for&nbsp;%s&#34;</span><span class="op" id="4781554">,</span>&nbsp;<span class="ident" id="4781556">r</span><span class="op" id="4781557">.</span><span class="ident" id="4781558">req</span><span class="op" id="4781561">.</span><span class="ident" id="4781562">URL</span><span class="op" id="4781565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781569">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4781577">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781580">r</span><span class="op" id="4781581">.</span><span class="ident" id="4781582">headerSent</span>&nbsp;<span class="op" id="4781593">=</span>&nbsp;<span class="builtintype" id="4781595">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781601">fmt</span><span class="op" id="4781604">.</span><span class="ident" id="4781605">Fprintf</span><span class="op" id="4781612">(</span><span class="ident" id="4781613">r</span><span class="op" id="4781614">.</span><span class="ident" id="4781615">bufw</span><span class="op" id="4781619">,</span>&nbsp;<span class="string" id="4781621">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="4781640">,</span>&nbsp;<span class="ident" id="4781642">code</span><span class="op" id="4781646">,</span>&nbsp;<span class="ident" id="4781648">http</span><span class="op" id="4781652">.</span><span class="ident" id="4781653">StatusText</span><span class="op" id="4781663">(</span><span class="ident" id="4781664">code</span><span class="op" id="4781668">)</span><span class="op" id="4781669">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4781673">//&nbsp;Set&nbsp;a&nbsp;default&nbsp;Content-Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4781704">if</span>&nbsp;<span class="ident" id="4781707">_</span><span class="op" id="4781708">,</span>&nbsp;<span class="ident" id="4781710">hasType</span>&nbsp;<span class="op" id="4781718">:=</span>&nbsp;<span class="ident" id="4781721">r</span><span class="op" id="4781722">.</span><span class="ident" id="4781723">header</span><span class="op" id="4781729">[</span><span class="string" id="4781730">&#34;Content-Type&#34;</span><span class="op" id="4781744">]</span><span class="op" id="4781745">;</span>&nbsp;<span class="op" id="4781747">!</span><span class="ident" id="4781748">hasType</span>&nbsp;<span class="op" id="4781756">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781760">r</span><span class="op" id="4781761">.</span><span class="ident" id="4781762">header</span><span class="op" id="4781768">.</span><span class="ident" id="4781769">Add</span><span class="op" id="4781772">(</span><span class="string" id="4781773">&#34;Content-Type&#34;</span><span class="op" id="4781787">,</span>&nbsp;<span class="string" id="4781789">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="4781815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4781818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781822">r</span><span class="op" id="4781823">.</span><span class="ident" id="4781824">header</span><span class="op" id="4781830">.</span><span class="ident" id="4781831">Write</span><span class="op" id="4781836">(</span><span class="ident" id="4781837">r</span><span class="op" id="4781838">.</span><span class="ident" id="4781839">bufw</span><span class="op" id="4781843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781846">r</span><span class="op" id="4781847">.</span><span class="ident" id="4781848">bufw</span><span class="op" id="4781852">.</span><span class="ident" id="4781853">WriteString</span><span class="op" id="4781864">(</span><span class="string" id="4781865">&#34;\r\n&#34;</span><span class="op" id="4781871">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4781874">r</span><span class="op" id="4781875">.</span><span class="ident" id="4781876">bufw</span><span class="op" id="4781880">.</span><span class="ident" id="4781881">Flush</span><span class="op" id="4781886">(</span><span class="op" id="4781887">)</span><br>
<span class="lineno"></span><span class="op" id="4781889">}</span>
</div>
</body>
</html>
