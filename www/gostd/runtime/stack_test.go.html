<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="966178">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="966234">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="966288">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="966339">package</span>&nbsp;<span class="ident" id="966347">runtime_test</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="966361">import</span>&nbsp;<span class="op" id="966368">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="966371">.</span>&nbsp;<span class="string" id="966373">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="966384">&#34;strings&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="966395">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="966403">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="966414">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="966421">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="966424">//&nbsp;TestStackMem&nbsp;measures&nbsp;per-thread&nbsp;stack&nbsp;segment&nbsp;cache&nbsp;behavior.</span><br>
<span class="lineno"></span><span class="comment" id="966490">//&nbsp;The&nbsp;test&nbsp;consumed&nbsp;up&nbsp;to&nbsp;500MB&nbsp;in&nbsp;the&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="966536">func</span>&nbsp;<span class="ident" id="966541">TestStackMem</span><span class="op" id="966553">(</span><span class="ident" id="966554">t</span>&nbsp;<span class="op" id="966556">*</span><span class="ident" id="966557">testing</span><span class="op" id="966564">.</span><span class="ident" id="966565">T</span><span class="op" id="966566">)</span>&nbsp;<span class="op" id="966568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="966571">const</span>&nbsp;<span class="op" id="966577">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="966581">BatchSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="966596">=</span>&nbsp;<span class="num" id="966598">32</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="966603">BatchCount</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="966618">=</span>&nbsp;<span class="num" id="966620">256</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="966626">ArraySize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="966641">=</span>&nbsp;<span class="num" id="966643">1024</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="966650">RecursionDepth</span>&nbsp;<span class="op" id="966665">=</span>&nbsp;<span class="num" id="966667">128</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="966672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="966675">if</span>&nbsp;<span class="ident" id="966678">testing</span><span class="op" id="966685">.</span><span class="ident" id="966686">Short</span><span class="op" id="966691">(</span><span class="op" id="966692">)</span>&nbsp;<span class="op" id="966694">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="966698">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="966706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="966709">defer</span>&nbsp;<span class="ident" id="966715">GOMAXPROCS</span><span class="op" id="966725">(</span><span class="ident" id="966726">GOMAXPROCS</span><span class="op" id="966736">(</span><span class="ident" id="966737">BatchSize</span><span class="op" id="966746">)</span><span class="op" id="966747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="966750">s0</span>&nbsp;<span class="op" id="966753">:=</span>&nbsp;<span class="builtinfunc" id="966756">new</span><span class="op" id="966759">(</span><span class="ident" id="966760">MemStats</span><span class="op" id="966768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="966771">ReadMemStats</span><span class="op" id="966783">(</span><span class="ident" id="966784">s0</span><span class="op" id="966786">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="966789">for</span>&nbsp;<span class="ident" id="966793">b</span>&nbsp;<span class="op" id="966795">:=</span>&nbsp;<span class="num" id="966798">0</span><span class="op" id="966799">;</span>&nbsp;<span class="ident" id="966801">b</span>&nbsp;<span class="op" id="966803">&lt;</span>&nbsp;<span class="ident" id="966805">BatchCount</span><span class="op" id="966815">;</span>&nbsp;<span class="ident" id="966817">b</span><span class="op" id="966818">++</span>&nbsp;<span class="op" id="966821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="966825">c</span>&nbsp;<span class="op" id="966827">:=</span>&nbsp;<span class="builtinfunc" id="966830">make</span><span class="op" id="966834">(</span><span class="keyword" id="966835">chan</span>&nbsp;<span class="builtintype" id="966840">bool</span><span class="op" id="966844">,</span>&nbsp;<span class="ident" id="966846">BatchSize</span><span class="op" id="966855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="966859">for</span>&nbsp;<span class="ident" id="966863">i</span>&nbsp;<span class="op" id="966865">:=</span>&nbsp;<span class="num" id="966868">0</span><span class="op" id="966869">;</span>&nbsp;<span class="ident" id="966871">i</span>&nbsp;<span class="op" id="966873">&lt;</span>&nbsp;<span class="ident" id="966875">BatchSize</span><span class="op" id="966884">;</span>&nbsp;<span class="ident" id="966886">i</span><span class="op" id="966887">++</span>&nbsp;<span class="op" id="966890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="966895">go</span>&nbsp;<span class="keyword" id="966898">func</span><span class="op" id="966902">(</span><span class="op" id="966903">)</span>&nbsp;<span class="op" id="966905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="966911">var</span>&nbsp;<span class="ident" id="966915">f</span>&nbsp;<span class="keyword" id="966917">func</span><span class="op" id="966921">(</span><span class="ident" id="966922">k</span>&nbsp;<span class="builtintype" id="966924">int</span><span class="op" id="966927">,</span>&nbsp;<span class="ident" id="966929">a</span>&nbsp;<span class="op" id="966931">[</span><span class="ident" id="966932">ArraySize</span><span class="op" id="966941">]</span><span class="builtintype" id="966942">byte</span><span class="op" id="966946">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="966952">f</span>&nbsp;<span class="op" id="966954">=</span>&nbsp;<span class="keyword" id="966956">func</span><span class="op" id="966960">(</span><span class="ident" id="966961">k</span>&nbsp;<span class="builtintype" id="966963">int</span><span class="op" id="966966">,</span>&nbsp;<span class="ident" id="966968">a</span>&nbsp;<span class="op" id="966970">[</span><span class="ident" id="966971">ArraySize</span><span class="op" id="966980">]</span><span class="builtintype" id="966981">byte</span><span class="op" id="966985">)</span>&nbsp;<span class="op" id="966987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="966994">if</span>&nbsp;<span class="ident" id="966997">k</span>&nbsp;<span class="op" id="966999">==</span>&nbsp;<span class="num" id="967002">0</span>&nbsp;<span class="op" id="967004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="967012">time</span><span class="op" id="967016">.</span><span class="ident" id="967017">Sleep</span><span class="op" id="967022">(</span><span class="ident" id="967023">time</span><span class="op" id="967027">.</span><span class="ident" id="967028">Millisecond</span><span class="op" id="967039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="967047">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="967059">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="967066">f</span><span class="op" id="967067">(</span><span class="ident" id="967068">k</span><span class="op" id="967069">-</span><span class="num" id="967070">1</span><span class="op" id="967071">,</span>&nbsp;<span class="ident" id="967073">a</span><span class="op" id="967074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="967080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="967086">f</span><span class="op" id="967087">(</span><span class="ident" id="967088">RecursionDepth</span><span class="op" id="967102">,</span>&nbsp;<span class="op" id="967104">[</span><span class="ident" id="967105">ArraySize</span><span class="op" id="967114">]</span><span class="builtintype" id="967115">byte</span><span class="op" id="967119">{</span><span class="op" id="967120">}</span><span class="op" id="967121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="967127">c</span>&nbsp;<span class="op" id="967129">&lt;-</span>&nbsp;<span class="builtintype" id="967132">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="967140">}</span><span class="op" id="967141">(</span><span class="op" id="967142">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="967146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="967150">for</span>&nbsp;<span class="ident" id="967154">i</span>&nbsp;<span class="op" id="967156">:=</span>&nbsp;<span class="num" id="967159">0</span><span class="op" id="967160">;</span>&nbsp;<span class="ident" id="967162">i</span>&nbsp;<span class="op" id="967164">&lt;</span>&nbsp;<span class="ident" id="967166">BatchSize</span><span class="op" id="967175">;</span>&nbsp;<span class="ident" id="967177">i</span><span class="op" id="967178">++</span>&nbsp;<span class="op" id="967181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="967186">&lt;-</span><span class="ident" id="967188">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="967192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="967197">//&nbsp;The&nbsp;goroutines&nbsp;have&nbsp;signaled&nbsp;via&nbsp;c&nbsp;that&nbsp;they&nbsp;are&nbsp;ready&nbsp;to&nbsp;exit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="967266">//&nbsp;Give&nbsp;them&nbsp;a&nbsp;chance&nbsp;to&nbsp;exit&nbsp;by&nbsp;sleeping.&nbsp;If&nbsp;we&nbsp;don&#39;t&nbsp;wait,&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="967332">//&nbsp;might&nbsp;not&nbsp;reuse&nbsp;them&nbsp;on&nbsp;the&nbsp;next&nbsp;batch.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="967377">time</span><span class="op" id="967381">.</span><span class="ident" id="967382">Sleep</span><span class="op" id="967387">(</span><span class="num" id="967388">10</span>&nbsp;<span class="op" id="967391">*</span>&nbsp;<span class="ident" id="967393">time</span><span class="op" id="967397">.</span><span class="ident" id="967398">Millisecond</span><span class="op" id="967409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="967412">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="967415">s1</span>&nbsp;<span class="op" id="967418">:=</span>&nbsp;<span class="builtinfunc" id="967421">new</span><span class="op" id="967424">(</span><span class="ident" id="967425">MemStats</span><span class="op" id="967433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="967436">ReadMemStats</span><span class="op" id="967448">(</span><span class="ident" id="967449">s1</span><span class="op" id="967451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="967454">consumed</span>&nbsp;<span class="op" id="967463">:=</span>&nbsp;<span class="ident" id="967466">int64</span><span class="op" id="967471">(</span><span class="ident" id="967472">s1</span><span class="op" id="967474">.</span><span class="ident" id="967475">StackSys</span>&nbsp;<span class="op" id="967484">-</span>&nbsp;<span class="ident" id="967486">s0</span><span class="op" id="967488">.</span><span class="ident" id="967489">StackSys</span><span class="op" id="967497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="967500">t</span><span class="op" id="967501">.</span><span class="ident" id="967502">Logf</span><span class="op" id="967506">(</span><span class="string" id="967507">&#34;Consumed&nbsp;%vMB&nbsp;for&nbsp;stack&nbsp;mem&#34;</span><span class="op" id="967536">,</span>&nbsp;<span class="ident" id="967538">consumed</span><span class="op" id="967546">&gt;&gt;</span><span class="num" id="967548">20</span><span class="op" id="967550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="967553">estimate</span>&nbsp;<span class="op" id="967562">:=</span>&nbsp;<span class="ident" id="967565">int64</span><span class="op" id="967570">(</span><span class="num" id="967571">8</span>&nbsp;<span class="op" id="967573">*</span>&nbsp;<span class="ident" id="967575">BatchSize</span>&nbsp;<span class="op" id="967585">*</span>&nbsp;<span class="ident" id="967587">ArraySize</span>&nbsp;<span class="op" id="967597">*</span>&nbsp;<span class="ident" id="967599">RecursionDepth</span><span class="op" id="967613">)</span>&nbsp;<span class="comment" id="967615">//&nbsp;8&nbsp;is&nbsp;to&nbsp;reduce&nbsp;flakiness.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="967645">if</span>&nbsp;<span class="ident" id="967648">consumed</span>&nbsp;<span class="op" id="967657">&gt;</span>&nbsp;<span class="ident" id="967659">estimate</span>&nbsp;<span class="op" id="967668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="967672">t</span><span class="op" id="967673">.</span><span class="ident" id="967674">Fatalf</span><span class="op" id="967680">(</span><span class="string" id="967681">&#34;Stack&nbsp;mem:&nbsp;want&nbsp;%v,&nbsp;got&nbsp;%v&#34;</span><span class="op" id="967709">,</span>&nbsp;<span class="ident" id="967711">estimate</span><span class="op" id="967719">,</span>&nbsp;<span class="ident" id="967721">consumed</span><span class="op" id="967729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="967732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="967735">//&nbsp;Due&nbsp;to&nbsp;broken&nbsp;stack&nbsp;memory&nbsp;accounting&nbsp;(http://golang.org/issue/7468),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="967809">//&nbsp;StackInuse&nbsp;can&nbsp;decrease&nbsp;during&nbsp;function&nbsp;execution,&nbsp;so&nbsp;we&nbsp;cast&nbsp;the&nbsp;values&nbsp;to&nbsp;int64.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="967896">inuse</span>&nbsp;<span class="op" id="967902">:=</span>&nbsp;<span class="ident" id="967905">int64</span><span class="op" id="967910">(</span><span class="ident" id="967911">s1</span><span class="op" id="967913">.</span><span class="ident" id="967914">StackInuse</span><span class="op" id="967924">)</span>&nbsp;<span class="op" id="967926">-</span>&nbsp;<span class="ident" id="967928">int64</span><span class="op" id="967933">(</span><span class="ident" id="967934">s0</span><span class="op" id="967936">.</span><span class="ident" id="967937">StackInuse</span><span class="op" id="967947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="967950">t</span><span class="op" id="967951">.</span><span class="ident" id="967952">Logf</span><span class="op" id="967956">(</span><span class="string" id="967957">&#34;Inuse&nbsp;%vMB&nbsp;for&nbsp;stack&nbsp;mem&#34;</span><span class="op" id="967983">,</span>&nbsp;<span class="ident" id="967985">inuse</span><span class="op" id="967990">&gt;&gt;</span><span class="num" id="967992">20</span><span class="op" id="967994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="967997">if</span>&nbsp;<span class="ident" id="968000">inuse</span>&nbsp;<span class="op" id="968006">&gt;</span>&nbsp;<span class="num" id="968008">4</span><span class="op" id="968009">&lt;&lt;</span><span class="num" id="968011">20</span>&nbsp;<span class="op" id="968014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968018">t</span><span class="op" id="968019">.</span><span class="ident" id="968020">Fatalf</span><span class="op" id="968026">(</span><span class="string" id="968027">&#34;Stack&nbsp;inuse:&nbsp;want&nbsp;%v,&nbsp;got&nbsp;%v&#34;</span><span class="op" id="968057">,</span>&nbsp;<span class="num" id="968059">4</span><span class="op" id="968060">&lt;&lt;</span><span class="num" id="968062">20</span><span class="op" id="968064">,</span>&nbsp;<span class="ident" id="968066">inuse</span><span class="op" id="968071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="968074">}</span><br>
<span class="lineno">70</span><span class="op" id="968076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="968079">//&nbsp;Test&nbsp;stack&nbsp;growing&nbsp;in&nbsp;different&nbsp;contexts.</span><br>
<span class="lineno"></span><span class="keyword" id="968124">func</span>&nbsp;<span class="ident" id="968129">TestStackGrowth</span><span class="op" id="968144">(</span><span class="ident" id="968145">t</span>&nbsp;<span class="op" id="968147">*</span><span class="ident" id="968148">testing</span><span class="op" id="968155">.</span><span class="ident" id="968156">T</span><span class="op" id="968157">)</span>&nbsp;<span class="op" id="968159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968162">t</span><span class="op" id="968163">.</span><span class="ident" id="968164">Parallel</span><span class="op" id="968172">(</span><span class="op" id="968173">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="968176">var</span>&nbsp;<span class="ident" id="968180">wg</span>&nbsp;<span class="ident" id="968183">sync</span><span class="op" id="968187">.</span><span class="ident" id="968188">WaitGroup</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="968200">//&nbsp;in&nbsp;a&nbsp;normal&nbsp;goroutine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968226">wg</span><span class="op" id="968228">.</span><span class="ident" id="968229">Add</span><span class="op" id="968232">(</span><span class="num" id="968233">1</span><span class="op" id="968234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="968237">go</span>&nbsp;<span class="keyword" id="968240">func</span><span class="op" id="968244">(</span><span class="op" id="968245">)</span>&nbsp;<span class="op" id="968247">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="968251">defer</span>&nbsp;<span class="ident" id="968257">wg</span><span class="op" id="968259">.</span><span class="ident" id="968260">Done</span><span class="op" id="968264">(</span><span class="op" id="968265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968269">growStack</span><span class="op" id="968278">(</span><span class="op" id="968279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="968282">}</span><span class="op" id="968283">(</span><span class="op" id="968284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968287">wg</span><span class="op" id="968289">.</span><span class="ident" id="968290">Wait</span><span class="op" id="968294">(</span><span class="op" id="968295">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="968299">//&nbsp;in&nbsp;locked&nbsp;goroutine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968323">wg</span><span class="op" id="968325">.</span><span class="ident" id="968326">Add</span><span class="op" id="968329">(</span><span class="num" id="968330">1</span><span class="op" id="968331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="968334">go</span>&nbsp;<span class="keyword" id="968337">func</span><span class="op" id="968341">(</span><span class="op" id="968342">)</span>&nbsp;<span class="op" id="968344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="968348">defer</span>&nbsp;<span class="ident" id="968354">wg</span><span class="op" id="968356">.</span><span class="ident" id="968357">Done</span><span class="op" id="968361">(</span><span class="op" id="968362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968366">LockOSThread</span><span class="op" id="968378">(</span><span class="op" id="968379">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968383">growStack</span><span class="op" id="968392">(</span><span class="op" id="968393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968397">UnlockOSThread</span><span class="op" id="968411">(</span><span class="op" id="968412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="968415">}</span><span class="op" id="968416">(</span><span class="op" id="968417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968420">wg</span><span class="op" id="968422">.</span><span class="ident" id="968423">Wait</span><span class="op" id="968427">(</span><span class="op" id="968428">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="968432">//&nbsp;in&nbsp;finalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968449">wg</span><span class="op" id="968451">.</span><span class="ident" id="968452">Add</span><span class="op" id="968455">(</span><span class="num" id="968456">1</span><span class="op" id="968457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="968460">go</span>&nbsp;<span class="keyword" id="968463">func</span><span class="op" id="968467">(</span><span class="op" id="968468">)</span>&nbsp;<span class="op" id="968470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="968474">defer</span>&nbsp;<span class="ident" id="968480">wg</span><span class="op" id="968482">.</span><span class="ident" id="968483">Done</span><span class="op" id="968487">(</span><span class="op" id="968488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968492">done</span>&nbsp;<span class="op" id="968497">:=</span>&nbsp;<span class="builtinfunc" id="968500">make</span><span class="op" id="968504">(</span><span class="keyword" id="968505">chan</span>&nbsp;<span class="builtintype" id="968510">bool</span><span class="op" id="968514">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="968518">go</span>&nbsp;<span class="keyword" id="968521">func</span><span class="op" id="968525">(</span><span class="op" id="968526">)</span>&nbsp;<span class="op" id="968528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968533">s</span>&nbsp;<span class="op" id="968535">:=</span>&nbsp;<span class="builtinfunc" id="968538">new</span><span class="op" id="968541">(</span><span class="builtintype" id="968542">string</span><span class="op" id="968548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968553">SetFinalizer</span><span class="op" id="968565">(</span><span class="ident" id="968566">s</span><span class="op" id="968567">,</span>&nbsp;<span class="keyword" id="968569">func</span><span class="op" id="968573">(</span><span class="ident" id="968574">ss</span>&nbsp;<span class="op" id="968577">*</span><span class="builtintype" id="968578">string</span><span class="op" id="968584">)</span>&nbsp;<span class="op" id="968586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968592">growStack</span><span class="op" id="968601">(</span><span class="op" id="968602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968608">done</span>&nbsp;<span class="op" id="968613">&lt;-</span>&nbsp;<span class="builtintype" id="968616">true</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="968624">}</span><span class="op" id="968625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968630">s</span>&nbsp;<span class="op" id="968632">=</span>&nbsp;<span class="ident" id="968634">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968641">done</span>&nbsp;<span class="op" id="968646">&lt;-</span>&nbsp;<span class="builtintype" id="968649">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="968656">}</span><span class="op" id="968657">(</span><span class="op" id="968658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="968662">&lt;-</span><span class="ident" id="968664">done</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968671">GC</span><span class="op" id="968673">(</span><span class="op" id="968674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="968678">select</span>&nbsp;<span class="op" id="968685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="968689">case</span>&nbsp;<span class="op" id="968694">&lt;-</span><span class="ident" id="968696">done</span><span class="op" id="968700">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="968704">case</span>&nbsp;<span class="op" id="968709">&lt;-</span><span class="ident" id="968711">time</span><span class="op" id="968715">.</span><span class="ident" id="968716">After</span><span class="op" id="968721">(</span><span class="num" id="968722">20</span>&nbsp;<span class="op" id="968725">*</span>&nbsp;<span class="ident" id="968727">time</span><span class="op" id="968731">.</span><span class="ident" id="968732">Second</span><span class="op" id="968738">)</span><span class="op" id="968739">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968744">t</span><span class="op" id="968745">.</span><span class="ident" id="968746">Fatal</span><span class="op" id="968751">(</span><span class="string" id="968752">&#34;finalizer&nbsp;did&nbsp;not&nbsp;run&#34;</span><span class="op" id="968775">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="968779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="968782">}</span><span class="op" id="968783">(</span><span class="op" id="968784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968787">wg</span><span class="op" id="968789">.</span><span class="ident" id="968790">Wait</span><span class="op" id="968794">(</span><span class="op" id="968795">)</span><br>
<span class="lineno"></span><span class="op" id="968797">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="968800">//&nbsp;...&nbsp;and&nbsp;in&nbsp;init</span><br>
<span class="lineno"></span><span class="comment" id="968819">//func&nbsp;init()&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="968835">//&nbsp;&nbsp;&nbsp;&nbspgrowStack()</span><br>
<span class="lineno"></span><span class="comment" id="968850">//}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="keyword" id="968855">func</span>&nbsp;<span class="ident" id="968860">growStack</span><span class="op" id="968869">(</span><span class="op" id="968870">)</span>&nbsp;<span class="op" id="968872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968875">n</span>&nbsp;<span class="op" id="968877">:=</span>&nbsp;<span class="num" id="968880">1</span>&nbsp;<span class="op" id="968882">&lt;&lt;</span>&nbsp;<span class="num" id="968885">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="968889">if</span>&nbsp;<span class="ident" id="968892">testing</span><span class="op" id="968899">.</span><span class="ident" id="968900">Short</span><span class="op" id="968905">(</span><span class="op" id="968906">)</span>&nbsp;<span class="op" id="968908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968912">n</span>&nbsp;<span class="op" id="968914">=</span>&nbsp;<span class="num" id="968916">1</span>&nbsp;<span class="op" id="968918">&lt;&lt;</span>&nbsp;<span class="num" id="968921">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="968924">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="968927">for</span>&nbsp;<span class="ident" id="968931">i</span>&nbsp;<span class="op" id="968933">:=</span>&nbsp;<span class="num" id="968936">0</span><span class="op" id="968937">;</span>&nbsp;<span class="ident" id="968939">i</span>&nbsp;<span class="op" id="968941">&lt;</span>&nbsp;<span class="ident" id="968943">n</span><span class="op" id="968944">;</span>&nbsp;<span class="ident" id="968946">i</span><span class="op" id="968947">++</span>&nbsp;<span class="op" id="968950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968954">x</span>&nbsp;<span class="op" id="968956">:=</span>&nbsp;<span class="num" id="968959">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="968963">growStackIter</span><span class="op" id="968976">(</span><span class="op" id="968977">&amp;</span><span class="ident" id="968978">x</span><span class="op" id="968979">,</span>&nbsp;<span class="ident" id="968981">i</span><span class="op" id="968982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="968986">if</span>&nbsp;<span class="ident" id="968989">x</span>&nbsp;<span class="op" id="968991">!=</span>&nbsp;<span class="ident" id="968994">i</span><span class="op" id="968995">+</span><span class="num" id="968996">1</span>&nbsp;<span class="op" id="968998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="969003">panic</span><span class="op" id="969008">(</span><span class="string" id="969009">&#34;stack&nbsp;is&nbsp;corrupted&#34;</span><span class="op" id="969029">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="969033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="969036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="969039">GC</span><span class="op" id="969041">(</span><span class="op" id="969042">)</span><br>
<span class="lineno"></span><span class="op" id="969044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="969047">//&nbsp;This&nbsp;function&nbsp;is&nbsp;not&nbsp;an&nbsp;anonymous&nbsp;func,&nbsp;so&nbsp;that&nbsp;the&nbsp;compiler&nbsp;can&nbsp;do&nbsp;escape</span><br>
<span class="lineno"></span><span class="comment" id="969125">//&nbsp;analysis&nbsp;and&nbsp;place&nbsp;x&nbsp;on&nbsp;stack&nbsp;(and&nbsp;subsequently&nbsp;stack&nbsp;growth&nbsp;update&nbsp;the&nbsp;pointer).</span><br>
<span class="lineno"></span><span class="keyword" id="969210">func</span>&nbsp;<span class="ident" id="969215">growStackIter</span><span class="op" id="969228">(</span><span class="ident" id="969229">p</span>&nbsp;<span class="op" id="969231">*</span><span class="builtintype" id="969232">int</span><span class="op" id="969235">,</span>&nbsp;<span class="ident" id="969237">n</span>&nbsp;<span class="builtintype" id="969239">int</span><span class="op" id="969242">)</span>&nbsp;<span class="op" id="969244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="969247">if</span>&nbsp;<span class="ident" id="969250">n</span>&nbsp;<span class="op" id="969252">==</span>&nbsp;<span class="num" id="969255">0</span>&nbsp;<span class="op" id="969257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="969261">*</span><span class="ident" id="969262">p</span>&nbsp;<span class="op" id="969264">=</span>&nbsp;<span class="ident" id="969266">n</span>&nbsp;<span class="op" id="969268">+</span>&nbsp;<span class="num" id="969270">1</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="969274">GC</span><span class="op" id="969276">(</span><span class="op" id="969277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="969281">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="969289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="969292">*</span><span class="ident" id="969293">p</span>&nbsp;<span class="op" id="969295">=</span>&nbsp;<span class="ident" id="969297">n</span>&nbsp;<span class="op" id="969299">+</span>&nbsp;<span class="num" id="969301">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="969304">x</span>&nbsp;<span class="op" id="969306">:=</span>&nbsp;<span class="num" id="969309">0</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="969312">growStackIter</span><span class="op" id="969325">(</span><span class="op" id="969326">&amp;</span><span class="ident" id="969327">x</span><span class="op" id="969328">,</span>&nbsp;<span class="ident" id="969330">n</span><span class="op" id="969331">-</span><span class="num" id="969332">1</span><span class="op" id="969333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="969336">if</span>&nbsp;<span class="ident" id="969339">x</span>&nbsp;<span class="op" id="969341">!=</span>&nbsp;<span class="ident" id="969344">n</span>&nbsp;<span class="op" id="969346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="969350">panic</span><span class="op" id="969355">(</span><span class="string" id="969356">&#34;stack&nbsp;is&nbsp;corrupted&#34;</span><span class="op" id="969376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="969379">}</span><br>
<span class="lineno"></span><span class="op" id="969381">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="keyword" id="969384">func</span>&nbsp;<span class="ident" id="969389">TestStackGrowthCallback</span><span class="op" id="969412">(</span><span class="ident" id="969413">t</span>&nbsp;<span class="op" id="969415">*</span><span class="ident" id="969416">testing</span><span class="op" id="969423">.</span><span class="ident" id="969424">T</span><span class="op" id="969425">)</span>&nbsp;<span class="op" id="969427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="969430">t</span><span class="op" id="969431">.</span><span class="ident" id="969432">Parallel</span><span class="op" id="969440">(</span><span class="op" id="969441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="969444">var</span>&nbsp;<span class="ident" id="969448">wg</span>&nbsp;<span class="ident" id="969451">sync</span><span class="op" id="969455">.</span><span class="ident" id="969456">WaitGroup</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="969468">//&nbsp;test&nbsp;stack&nbsp;growth&nbsp;at&nbsp;chan&nbsp;op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="969501">wg</span><span class="op" id="969503">.</span><span class="ident" id="969504">Add</span><span class="op" id="969507">(</span><span class="num" id="969508">1</span><span class="op" id="969509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="969512">go</span>&nbsp;<span class="keyword" id="969515">func</span><span class="op" id="969519">(</span><span class="op" id="969520">)</span>&nbsp;<span class="op" id="969522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="969526">defer</span>&nbsp;<span class="ident" id="969532">wg</span><span class="op" id="969534">.</span><span class="ident" id="969535">Done</span><span class="op" id="969539">(</span><span class="op" id="969540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="969544">c</span>&nbsp;<span class="op" id="969546">:=</span>&nbsp;<span class="builtinfunc" id="969549">make</span><span class="op" id="969553">(</span><span class="keyword" id="969554">chan</span>&nbsp;<span class="builtintype" id="969559">int</span><span class="op" id="969562">,</span>&nbsp;<span class="num" id="969564">1</span><span class="op" id="969565">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="969569">growStackWithCallback</span><span class="op" id="969590">(</span><span class="keyword" id="969591">func</span><span class="op" id="969595">(</span><span class="op" id="969596">)</span>&nbsp;<span class="op" id="969598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="969603">c</span>&nbsp;<span class="op" id="969605">&lt;-</span>&nbsp;<span class="num" id="969608">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="969613">&lt;-</span><span class="ident" id="969615">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="969619">}</span><span class="op" id="969620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="969623">}</span><span class="op" id="969624">(</span><span class="op" id="969625">)</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="969629">//&nbsp;test&nbsp;stack&nbsp;growth&nbsp;at&nbsp;map&nbsp;op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="969661">wg</span><span class="op" id="969663">.</span><span class="ident" id="969664">Add</span><span class="op" id="969667">(</span><span class="num" id="969668">1</span><span class="op" id="969669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="969672">go</span>&nbsp;<span class="keyword" id="969675">func</span><span class="op" id="969679">(</span><span class="op" id="969680">)</span>&nbsp;<span class="op" id="969682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="969686">defer</span>&nbsp;<span class="ident" id="969692">wg</span><span class="op" id="969694">.</span><span class="ident" id="969695">Done</span><span class="op" id="969699">(</span><span class="op" id="969700">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="969704">m</span>&nbsp;<span class="op" id="969706">:=</span>&nbsp;<span class="builtinfunc" id="969709">make</span><span class="op" id="969713">(</span><span class="keyword" id="969714">map</span><span class="op" id="969717">[</span><span class="builtintype" id="969718">int</span><span class="op" id="969721">]</span><span class="builtintype" id="969722">int</span><span class="op" id="969725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="969729">growStackWithCallback</span><span class="op" id="969750">(</span><span class="keyword" id="969751">func</span><span class="op" id="969755">(</span><span class="op" id="969756">)</span>&nbsp;<span class="op" id="969758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="969763">_</span><span class="op" id="969764">,</span>&nbsp;<span class="ident" id="969766">_</span>&nbsp;<span class="op" id="969768">=</span>&nbsp;<span class="ident" id="969770">m</span><span class="op" id="969771">[</span><span class="num" id="969772">1</span><span class="op" id="969773">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="969778">m</span><span class="op" id="969779">[</span><span class="num" id="969780">1</span><span class="op" id="969781">]</span>&nbsp;<span class="op" id="969783">=</span>&nbsp;<span class="num" id="969785">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="969789">}</span><span class="op" id="969790">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="969793">}</span><span class="op" id="969794">(</span><span class="op" id="969795">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="969799">//&nbsp;test&nbsp;stack&nbsp;growth&nbsp;at&nbsp;goroutine&nbsp;creation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="969843">wg</span><span class="op" id="969845">.</span><span class="ident" id="969846">Add</span><span class="op" id="969849">(</span><span class="num" id="969850">1</span><span class="op" id="969851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="969854">go</span>&nbsp;<span class="keyword" id="969857">func</span><span class="op" id="969861">(</span><span class="op" id="969862">)</span>&nbsp;<span class="op" id="969864">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="969868">defer</span>&nbsp;<span class="ident" id="969874">wg</span><span class="op" id="969876">.</span><span class="ident" id="969877">Done</span><span class="op" id="969881">(</span><span class="op" id="969882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="969886">growStackWithCallback</span><span class="op" id="969907">(</span><span class="keyword" id="969908">func</span><span class="op" id="969912">(</span><span class="op" id="969913">)</span>&nbsp;<span class="op" id="969915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="969920">done</span>&nbsp;<span class="op" id="969925">:=</span>&nbsp;<span class="builtinfunc" id="969928">make</span><span class="op" id="969932">(</span><span class="keyword" id="969933">chan</span>&nbsp;<span class="builtintype" id="969938">bool</span><span class="op" id="969942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="969947">go</span>&nbsp;<span class="keyword" id="969950">func</span><span class="op" id="969954">(</span><span class="op" id="969955">)</span>&nbsp;<span class="op" id="969957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="969963">done</span>&nbsp;<span class="op" id="969968">&lt;-</span>&nbsp;<span class="builtintype" id="969971">true</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="969979">}</span><span class="op" id="969980">(</span><span class="op" id="969981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="969986">&lt;-</span><span class="ident" id="969988">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="969995">}</span><span class="op" id="969996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="969999">}</span><span class="op" id="970000">(</span><span class="op" id="970001">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="970005">wg</span><span class="op" id="970007">.</span><span class="ident" id="970008">Wait</span><span class="op" id="970012">(</span><span class="op" id="970013">)</span><br>
<span class="lineno"></span><span class="op" id="970015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="970018">func</span>&nbsp;<span class="ident" id="970023">growStackWithCallback</span><span class="op" id="970044">(</span><span class="ident" id="970045">cb</span>&nbsp;<span class="keyword" id="970048">func</span><span class="op" id="970052">(</span><span class="op" id="970053">)</span><span class="op" id="970054">)</span>&nbsp;<span class="op" id="970056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="970059">var</span>&nbsp;<span class="ident" id="970063">f</span>&nbsp;<span class="keyword" id="970065">func</span><span class="op" id="970069">(</span><span class="ident" id="970070">n</span>&nbsp;<span class="builtintype" id="970072">int</span><span class="op" id="970075">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="970078">f</span>&nbsp;<span class="op" id="970080">=</span>&nbsp;<span class="keyword" id="970082">func</span><span class="op" id="970086">(</span><span class="ident" id="970087">n</span>&nbsp;<span class="builtintype" id="970089">int</span><span class="op" id="970092">)</span>&nbsp;<span class="op" id="970094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="970098">if</span>&nbsp;<span class="ident" id="970101">n</span>&nbsp;<span class="op" id="970103">==</span>&nbsp;<span class="num" id="970106">0</span>&nbsp;<span class="op" id="970108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="970113">cb</span><span class="op" id="970115">(</span><span class="op" id="970116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="970121">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="970130">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="970134">f</span><span class="op" id="970135">(</span><span class="ident" id="970136">n</span>&nbsp;<span class="op" id="970138">-</span>&nbsp;<span class="num" id="970140">1</span><span class="op" id="970141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="970144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="970147">for</span>&nbsp;<span class="ident" id="970151">i</span>&nbsp;<span class="op" id="970153">:=</span>&nbsp;<span class="num" id="970156">0</span><span class="op" id="970157">;</span>&nbsp;<span class="ident" id="970159">i</span>&nbsp;<span class="op" id="970161">&lt;</span>&nbsp;<span class="num" id="970163">1</span><span class="op" id="970164">&lt;&lt;</span><span class="num" id="970166">10</span><span class="op" id="970168">;</span>&nbsp;<span class="ident" id="970170">i</span><span class="op" id="970171">++</span>&nbsp;<span class="op" id="970174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="970178">f</span><span class="op" id="970179">(</span><span class="ident" id="970180">i</span><span class="op" id="970181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="970184">}</span><br>
<span class="lineno">210</span><span class="op" id="970186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="970189">//&nbsp;TestDeferPtrs&nbsp;tests&nbsp;the&nbsp;adjustment&nbsp;of&nbsp;Defer&#39;s&nbsp;argument&nbsp;pointers&nbsp;(p&nbsp;aka&nbsp;&amp;y)</span><br>
<span class="lineno"></span><span class="comment" id="970267">//&nbsp;during&nbsp;a&nbsp;stack&nbsp;copy.</span><br>
<span class="lineno"></span><span class="keyword" id="970291">func</span>&nbsp;<span class="ident" id="970296">set</span><span class="op" id="970299">(</span><span class="ident" id="970300">p</span>&nbsp;<span class="op" id="970302">*</span><span class="builtintype" id="970303">int</span><span class="op" id="970306">,</span>&nbsp;<span class="ident" id="970308">x</span>&nbsp;<span class="builtintype" id="970310">int</span><span class="op" id="970313">)</span>&nbsp;<span class="op" id="970315">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="970318">*</span><span class="ident" id="970319">p</span>&nbsp;<span class="op" id="970321">=</span>&nbsp;<span class="ident" id="970323">x</span><br>
<span class="lineno"></span><span class="op" id="970325">}</span><br>
<span class="lineno"></span><span class="keyword" id="970327">func</span>&nbsp;<span class="ident" id="970332">TestDeferPtrs</span><span class="op" id="970345">(</span><span class="ident" id="970346">t</span>&nbsp;<span class="op" id="970348">*</span><span class="ident" id="970349">testing</span><span class="op" id="970356">.</span><span class="ident" id="970357">T</span><span class="op" id="970358">)</span>&nbsp;<span class="op" id="970360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="970363">var</span>&nbsp;<span class="ident" id="970367">y</span>&nbsp;<span class="builtintype" id="970369">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="970375">defer</span>&nbsp;<span class="keyword" id="970381">func</span><span class="op" id="970385">(</span><span class="op" id="970386">)</span>&nbsp;<span class="op" id="970388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="970392">if</span>&nbsp;<span class="ident" id="970395">y</span>&nbsp;<span class="op" id="970397">!=</span>&nbsp;<span class="num" id="970400">42</span>&nbsp;<span class="op" id="970403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="970408">t</span><span class="op" id="970409">.</span><span class="ident" id="970410">Errorf</span><span class="op" id="970416">(</span><span class="string" id="970417">&#34;defer&#39;s&nbsp;stack&nbsp;references&nbsp;were&nbsp;not&nbsp;adjusted&nbsp;appropriately&#34;</span><span class="op" id="970475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="970479">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="970482">}</span><span class="op" id="970483">(</span><span class="op" id="970484">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="970487">defer</span>&nbsp;<span class="ident" id="970493">set</span><span class="op" id="970496">(</span><span class="op" id="970497">&amp;</span><span class="ident" id="970498">y</span><span class="op" id="970499">,</span>&nbsp;<span class="num" id="970501">42</span><span class="op" id="970503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="970506">growStack</span><span class="op" id="970515">(</span><span class="op" id="970516">)</span><br>
<span class="lineno"></span><span class="op" id="970518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="970521">type</span>&nbsp;<span class="ident" id="970526">bigBuf</span>&nbsp;<span class="op" id="970533">[</span><span class="num" id="970534">4</span>&nbsp;<span class="op" id="970536">*</span>&nbsp;<span class="num" id="970538">1024</span><span class="op" id="970542">]</span><span class="builtintype" id="970543">byte</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="970549">//&nbsp;TestDeferPtrsGoexit&nbsp;is&nbsp;like&nbsp;TestDeferPtrs&nbsp;but&nbsp;exercises&nbsp;the&nbsp;possibility&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="970633">//&nbsp;stack&nbsp;grows&nbsp;as&nbsp;part&nbsp;of&nbsp;starting&nbsp;the&nbsp;deferred&nbsp;function.&nbsp;It&nbsp;calls&nbsp;Goexit&nbsp;at&nbsp;various</span><br>
<span class="lineno"></span><span class="comment" id="970718">//&nbsp;stack&nbsp;depths,&nbsp;forcing&nbsp;the&nbsp;deferred&nbsp;function&nbsp;(with&nbsp;&gt;4kB&nbsp;of&nbsp;args)&nbsp;to&nbsp;be&nbsp;run&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="970798">//&nbsp;the&nbsp;bottom&nbsp;of&nbsp;the&nbsp;stack.&nbsp;The&nbsp;goal&nbsp;is&nbsp;to&nbsp;find&nbsp;a&nbsp;stack&nbsp;depth&nbsp;less&nbsp;than&nbsp;4kB&nbsp;from</span><br>
<span class="lineno">235</span><span class="comment" id="970879">//&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;stack.&nbsp;Each&nbsp;trial&nbsp;runs&nbsp;in&nbsp;a&nbsp;different&nbsp;goroutine&nbsp;so&nbsp;that&nbsp;an&nbsp;earlier</span><br>
<span class="lineno"></span><span class="comment" id="970964">//&nbsp;stack&nbsp;growth&nbsp;does&nbsp;not&nbsp;invalidate&nbsp;a&nbsp;later&nbsp;attempt.</span><br>
<span class="lineno"></span><span class="keyword" id="971017">func</span>&nbsp;<span class="ident" id="971022">TestDeferPtrsGoexit</span><span class="op" id="971041">(</span><span class="ident" id="971042">t</span>&nbsp;<span class="op" id="971044">*</span><span class="ident" id="971045">testing</span><span class="op" id="971052">.</span><span class="ident" id="971053">T</span><span class="op" id="971054">)</span>&nbsp;<span class="op" id="971056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="971059">for</span>&nbsp;<span class="ident" id="971063">i</span>&nbsp;<span class="op" id="971065">:=</span>&nbsp;<span class="num" id="971068">0</span><span class="op" id="971069">;</span>&nbsp;<span class="ident" id="971071">i</span>&nbsp;<span class="op" id="971073">&lt;</span>&nbsp;<span class="num" id="971075">100</span><span class="op" id="971078">;</span>&nbsp;<span class="ident" id="971080">i</span><span class="op" id="971081">++</span>&nbsp;<span class="op" id="971084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="971088">c</span>&nbsp;<span class="op" id="971090">:=</span>&nbsp;<span class="builtinfunc" id="971093">make</span><span class="op" id="971097">(</span><span class="keyword" id="971098">chan</span>&nbsp;<span class="builtintype" id="971103">int</span><span class="op" id="971106">,</span>&nbsp;<span class="num" id="971108">1</span><span class="op" id="971109">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="971113">go</span>&nbsp;<span class="ident" id="971116">testDeferPtrsGoexit</span><span class="op" id="971135">(</span><span class="ident" id="971136">c</span><span class="op" id="971137">,</span>&nbsp;<span class="ident" id="971139">i</span><span class="op" id="971140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="971144">if</span>&nbsp;<span class="ident" id="971147">n</span>&nbsp;<span class="op" id="971149">:=</span>&nbsp;<span class="op" id="971152">&lt;-</span><span class="ident" id="971154">c</span><span class="op" id="971155">;</span>&nbsp;<span class="ident" id="971157">n</span>&nbsp;<span class="op" id="971159">!=</span>&nbsp;<span class="num" id="971162">42</span>&nbsp;<span class="op" id="971165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="971170">t</span><span class="op" id="971171">.</span><span class="ident" id="971172">Fatalf</span><span class="op" id="971178">(</span><span class="string" id="971179">&#34;defer&#39;s&nbsp;stack&nbsp;references&nbsp;were&nbsp;not&nbsp;adjusted&nbsp;appropriately&nbsp;(i=%d&nbsp;n=%d)&#34;</span><span class="op" id="971249">,</span>&nbsp;<span class="ident" id="971251">i</span><span class="op" id="971252">,</span>&nbsp;<span class="ident" id="971254">n</span><span class="op" id="971255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="971259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="971262">}</span><br>
<span class="lineno">245</span><span class="op" id="971264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="971267">func</span>&nbsp;<span class="ident" id="971272">testDeferPtrsGoexit</span><span class="op" id="971291">(</span><span class="ident" id="971292">c</span>&nbsp;<span class="keyword" id="971294">chan</span>&nbsp;<span class="builtintype" id="971299">int</span><span class="op" id="971302">,</span>&nbsp;<span class="ident" id="971304">i</span>&nbsp;<span class="builtintype" id="971306">int</span><span class="op" id="971309">)</span>&nbsp;<span class="op" id="971311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="971314">var</span>&nbsp;<span class="ident" id="971318">y</span>&nbsp;<span class="builtintype" id="971320">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="971325">defer</span>&nbsp;<span class="keyword" id="971331">func</span><span class="op" id="971335">(</span><span class="op" id="971336">)</span>&nbsp;<span class="op" id="971338">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="971342">c</span>&nbsp;<span class="op" id="971344">&lt;-</span>&nbsp;<span class="ident" id="971347">y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="971350">}</span><span class="op" id="971351">(</span><span class="op" id="971352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="971355">defer</span>&nbsp;<span class="ident" id="971361">setBig</span><span class="op" id="971367">(</span><span class="op" id="971368">&amp;</span><span class="ident" id="971369">y</span><span class="op" id="971370">,</span>&nbsp;<span class="num" id="971372">42</span><span class="op" id="971374">,</span>&nbsp;<span class="ident" id="971376">bigBuf</span><span class="op" id="971382">{</span><span class="op" id="971383">}</span><span class="op" id="971384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="971387">useStackAndCall</span><span class="op" id="971402">(</span><span class="ident" id="971403">i</span><span class="op" id="971404">,</span>&nbsp;<span class="ident" id="971406">Goexit</span><span class="op" id="971412">)</span><br>
<span class="lineno"></span><span class="op" id="971414">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="971417">func</span>&nbsp;<span class="ident" id="971422">setBig</span><span class="op" id="971428">(</span><span class="ident" id="971429">p</span>&nbsp;<span class="op" id="971431">*</span><span class="builtintype" id="971432">int</span><span class="op" id="971435">,</span>&nbsp;<span class="ident" id="971437">x</span>&nbsp;<span class="builtintype" id="971439">int</span><span class="op" id="971442">,</span>&nbsp;<span class="ident" id="971444">b</span>&nbsp;<span class="ident" id="971446">bigBuf</span><span class="op" id="971452">)</span>&nbsp;<span class="op" id="971454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="971457">*</span><span class="ident" id="971458">p</span>&nbsp;<span class="op" id="971460">=</span>&nbsp;<span class="ident" id="971462">x</span><br>
<span class="lineno"></span><span class="op" id="971464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="comment" id="971467">//&nbsp;TestDeferPtrsPanic&nbsp;is&nbsp;like&nbsp;TestDeferPtrsGoexit,&nbsp;but&nbsp;it&#39;s&nbsp;using&nbsp;panic&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="971547">//&nbsp;of&nbsp;Goexit&nbsp;to&nbsp;run&nbsp;the&nbsp;Defers.&nbsp;Those&nbsp;two&nbsp;are&nbsp;different&nbsp;execution&nbsp;paths</span><br>
<span class="lineno"></span><span class="comment" id="971619">//&nbsp;in&nbsp;the&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="971638">func</span>&nbsp;<span class="ident" id="971643">TestDeferPtrsPanic</span><span class="op" id="971661">(</span><span class="ident" id="971662">t</span>&nbsp;<span class="op" id="971664">*</span><span class="ident" id="971665">testing</span><span class="op" id="971672">.</span><span class="ident" id="971673">T</span><span class="op" id="971674">)</span>&nbsp;<span class="op" id="971676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="971679">for</span>&nbsp;<span class="ident" id="971683">i</span>&nbsp;<span class="op" id="971685">:=</span>&nbsp;<span class="num" id="971688">0</span><span class="op" id="971689">;</span>&nbsp;<span class="ident" id="971691">i</span>&nbsp;<span class="op" id="971693">&lt;</span>&nbsp;<span class="num" id="971695">100</span><span class="op" id="971698">;</span>&nbsp;<span class="ident" id="971700">i</span><span class="op" id="971701">++</span>&nbsp;<span class="op" id="971704">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="971708">c</span>&nbsp;<span class="op" id="971710">:=</span>&nbsp;<span class="builtinfunc" id="971713">make</span><span class="op" id="971717">(</span><span class="keyword" id="971718">chan</span>&nbsp;<span class="builtintype" id="971723">int</span><span class="op" id="971726">,</span>&nbsp;<span class="num" id="971728">1</span><span class="op" id="971729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="971733">go</span>&nbsp;<span class="ident" id="971736">testDeferPtrsGoexit</span><span class="op" id="971755">(</span><span class="ident" id="971756">c</span><span class="op" id="971757">,</span>&nbsp;<span class="ident" id="971759">i</span><span class="op" id="971760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="971764">if</span>&nbsp;<span class="ident" id="971767">n</span>&nbsp;<span class="op" id="971769">:=</span>&nbsp;<span class="op" id="971772">&lt;-</span><span class="ident" id="971774">c</span><span class="op" id="971775">;</span>&nbsp;<span class="ident" id="971777">n</span>&nbsp;<span class="op" id="971779">!=</span>&nbsp;<span class="num" id="971782">42</span>&nbsp;<span class="op" id="971785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="971790">t</span><span class="op" id="971791">.</span><span class="ident" id="971792">Fatalf</span><span class="op" id="971798">(</span><span class="string" id="971799">&#34;defer&#39;s&nbsp;stack&nbsp;references&nbsp;were&nbsp;not&nbsp;adjusted&nbsp;appropriately&nbsp;(i=%d&nbsp;n=%d)&#34;</span><span class="op" id="971869">,</span>&nbsp;<span class="ident" id="971871">i</span><span class="op" id="971872">,</span>&nbsp;<span class="ident" id="971874">n</span><span class="op" id="971875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="971879">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="971882">}</span><br>
<span class="lineno"></span><span class="op" id="971884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="971887">func</span>&nbsp;<span class="ident" id="971892">testDeferPtrsPanic</span><span class="op" id="971910">(</span><span class="ident" id="971911">c</span>&nbsp;<span class="keyword" id="971913">chan</span>&nbsp;<span class="builtintype" id="971918">int</span><span class="op" id="971921">,</span>&nbsp;<span class="ident" id="971923">i</span>&nbsp;<span class="builtintype" id="971925">int</span><span class="op" id="971928">)</span>&nbsp;<span class="op" id="971930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="971933">var</span>&nbsp;<span class="ident" id="971937">y</span>&nbsp;<span class="builtintype" id="971939">int</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="971944">defer</span>&nbsp;<span class="keyword" id="971950">func</span><span class="op" id="971954">(</span><span class="op" id="971955">)</span>&nbsp;<span class="op" id="971957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="971961">if</span>&nbsp;<span class="builtinfunc" id="971964">recover</span><span class="op" id="971971">(</span><span class="op" id="971972">)</span>&nbsp;<span class="op" id="971974">==</span>&nbsp;<span class="ident" id="971977">nil</span>&nbsp;<span class="op" id="971981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="971986">c</span>&nbsp;<span class="op" id="971988">&lt;-</span>&nbsp;<span class="op" id="971991">-</span><span class="num" id="971992">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="971997">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="972006">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="972010">c</span>&nbsp;<span class="op" id="972012">&lt;-</span>&nbsp;<span class="ident" id="972015">y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="972018">}</span><span class="op" id="972019">(</span><span class="op" id="972020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="972023">defer</span>&nbsp;<span class="ident" id="972029">setBig</span><span class="op" id="972035">(</span><span class="op" id="972036">&amp;</span><span class="ident" id="972037">y</span><span class="op" id="972038">,</span>&nbsp;<span class="num" id="972040">42</span><span class="op" id="972042">,</span>&nbsp;<span class="ident" id="972044">bigBuf</span><span class="op" id="972050">{</span><span class="op" id="972051">}</span><span class="op" id="972052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="972055">useStackAndCall</span><span class="op" id="972070">(</span><span class="ident" id="972071">i</span><span class="op" id="972072">,</span>&nbsp;<span class="keyword" id="972074">func</span><span class="op" id="972078">(</span><span class="op" id="972079">)</span>&nbsp;<span class="op" id="972081">{</span>&nbsp;<span class="builtinfunc" id="972083">panic</span><span class="op" id="972088">(</span><span class="num" id="972089">1</span><span class="op" id="972090">)</span>&nbsp;<span class="op" id="972092">}</span><span class="op" id="972093">)</span><br>
<span class="lineno"></span><span class="op" id="972095">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="972098">//&nbsp;TestPanicUseStack&nbsp;checks&nbsp;that&nbsp;a&nbsp;chain&nbsp;of&nbsp;Panic&nbsp;structs&nbsp;on&nbsp;the&nbsp;stack&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="972173">//&nbsp;updated&nbsp;correctly&nbsp;if&nbsp;the&nbsp;stack&nbsp;grows&nbsp;during&nbsp;the&nbsp;deferred&nbsp;execution&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="972248">//&nbsp;happens&nbsp;as&nbsp;a&nbsp;result&nbsp;of&nbsp;the&nbsp;panic.</span><br>
<span class="lineno"></span><span class="keyword" id="972285">func</span>&nbsp;<span class="ident" id="972290">TestPanicUseStack</span><span class="op" id="972307">(</span><span class="ident" id="972308">t</span>&nbsp;<span class="op" id="972310">*</span><span class="ident" id="972311">testing</span><span class="op" id="972318">.</span><span class="ident" id="972319">T</span><span class="op" id="972320">)</span>&nbsp;<span class="op" id="972322">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="972325">pc</span>&nbsp;<span class="op" id="972328">:=</span>&nbsp;<span class="builtinfunc" id="972331">make</span><span class="op" id="972335">(</span><span class="op" id="972336">[</span><span class="op" id="972337">]</span><span class="builtintype" id="972338">uintptr</span><span class="op" id="972345">,</span>&nbsp;<span class="num" id="972347">10000</span><span class="op" id="972352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="972355">defer</span>&nbsp;<span class="keyword" id="972361">func</span><span class="op" id="972365">(</span><span class="op" id="972366">)</span>&nbsp;<span class="op" id="972368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="972372">recover</span><span class="op" id="972379">(</span><span class="op" id="972380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="972384">Callers</span><span class="op" id="972391">(</span><span class="num" id="972392">0</span><span class="op" id="972393">,</span>&nbsp;<span class="ident" id="972395">pc</span><span class="op" id="972397">)</span>&nbsp;<span class="comment" id="972399">//&nbsp;force&nbsp;stack&nbsp;walk</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="972421">useStackAndCall</span><span class="op" id="972436">(</span><span class="num" id="972437">100</span><span class="op" id="972440">,</span>&nbsp;<span class="keyword" id="972442">func</span><span class="op" id="972446">(</span><span class="op" id="972447">)</span>&nbsp;<span class="op" id="972449">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="972454">defer</span>&nbsp;<span class="keyword" id="972460">func</span><span class="op" id="972464">(</span><span class="op" id="972465">)</span>&nbsp;<span class="op" id="972467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="972473">recover</span><span class="op" id="972480">(</span><span class="op" id="972481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="972487">Callers</span><span class="op" id="972494">(</span><span class="num" id="972495">0</span><span class="op" id="972496">,</span>&nbsp;<span class="ident" id="972498">pc</span><span class="op" id="972500">)</span>&nbsp;<span class="comment" id="972502">//&nbsp;force&nbsp;stack&nbsp;walk</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="972526">useStackAndCall</span><span class="op" id="972541">(</span><span class="num" id="972542">200</span><span class="op" id="972545">,</span>&nbsp;<span class="keyword" id="972547">func</span><span class="op" id="972551">(</span><span class="op" id="972552">)</span>&nbsp;<span class="op" id="972554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="972561">defer</span>&nbsp;<span class="keyword" id="972567">func</span><span class="op" id="972571">(</span><span class="op" id="972572">)</span>&nbsp;<span class="op" id="972574">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="972582">recover</span><span class="op" id="972589">(</span><span class="op" id="972590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="972598">Callers</span><span class="op" id="972605">(</span><span class="num" id="972606">0</span><span class="op" id="972607">,</span>&nbsp;<span class="ident" id="972609">pc</span><span class="op" id="972611">)</span>&nbsp;<span class="comment" id="972613">//&nbsp;force&nbsp;stack&nbsp;walk</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="972638">}</span><span class="op" id="972639">(</span><span class="op" id="972640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="972647">panic</span><span class="op" id="972652">(</span><span class="num" id="972653">3</span><span class="op" id="972654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="972660">}</span><span class="op" id="972661">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="972666">}</span><span class="op" id="972667">(</span><span class="op" id="972668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="972673">panic</span><span class="op" id="972678">(</span><span class="num" id="972679">2</span><span class="op" id="972680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="972684">}</span><span class="op" id="972685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="972688">}</span><span class="op" id="972689">(</span><span class="op" id="972690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="972693">panic</span><span class="op" id="972698">(</span><span class="num" id="972699">1</span><span class="op" id="972700">)</span><br>
<span class="lineno">310</span><span class="op" id="972702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="972705">//&nbsp;use&nbsp;about&nbsp;n&nbsp;KB&nbsp;of&nbsp;stack&nbsp;and&nbsp;call&nbsp;f</span><br>
<span class="lineno"></span><span class="keyword" id="972743">func</span>&nbsp;<span class="ident" id="972748">useStackAndCall</span><span class="op" id="972763">(</span><span class="ident" id="972764">n</span>&nbsp;<span class="builtintype" id="972766">int</span><span class="op" id="972769">,</span>&nbsp;<span class="ident" id="972771">f</span>&nbsp;<span class="keyword" id="972773">func</span><span class="op" id="972777">(</span><span class="op" id="972778">)</span><span class="op" id="972779">)</span>&nbsp;<span class="op" id="972781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="972784">if</span>&nbsp;<span class="ident" id="972787">n</span>&nbsp;<span class="op" id="972789">==</span>&nbsp;<span class="num" id="972792">0</span>&nbsp;<span class="op" id="972794">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="972798">f</span><span class="op" id="972799">(</span><span class="op" id="972800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="972804">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="972812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="972815">var</span>&nbsp;<span class="ident" id="972819">b</span>&nbsp;<span class="op" id="972821">[</span><span class="num" id="972822">1024</span><span class="op" id="972826">]</span><span class="builtintype" id="972827">byte</span>&nbsp;<span class="comment" id="972832">//&nbsp;makes&nbsp;frame&nbsp;about&nbsp;1KB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="972858">useStackAndCall</span><span class="op" id="972873">(</span><span class="ident" id="972874">n</span><span class="op" id="972875">-</span><span class="num" id="972876">1</span><span class="op" id="972877">+</span><span class="builtintype" id="972878">int</span><span class="op" id="972881">(</span><span class="ident" id="972882">b</span><span class="op" id="972883">[</span><span class="num" id="972884">99</span><span class="op" id="972886">]</span><span class="op" id="972887">)</span><span class="op" id="972888">,</span>&nbsp;<span class="ident" id="972890">f</span><span class="op" id="972891">)</span><br>
<span class="lineno">320</span><span class="op" id="972893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="972896">func</span>&nbsp;<span class="ident" id="972901">useStack</span><span class="op" id="972909">(</span><span class="ident" id="972910">n</span>&nbsp;<span class="builtintype" id="972912">int</span><span class="op" id="972915">)</span>&nbsp;<span class="op" id="972917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="972920">useStackAndCall</span><span class="op" id="972935">(</span><span class="ident" id="972936">n</span><span class="op" id="972937">,</span>&nbsp;<span class="keyword" id="972939">func</span><span class="op" id="972943">(</span><span class="op" id="972944">)</span>&nbsp;<span class="op" id="972946">{</span><span class="op" id="972947">}</span><span class="op" id="972948">)</span><br>
<span class="lineno"></span><span class="op" id="972950">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="972953">func</span>&nbsp;<span class="ident" id="972958">growing</span><span class="op" id="972965">(</span><span class="ident" id="972966">c</span>&nbsp;<span class="keyword" id="972968">chan</span>&nbsp;<span class="builtintype" id="972973">int</span><span class="op" id="972976">,</span>&nbsp;<span class="ident" id="972978">done</span>&nbsp;<span class="keyword" id="972983">chan</span>&nbsp;<span class="keyword" id="972988">struct</span><span class="op" id="972994">{</span><span class="op" id="972995">}</span><span class="op" id="972996">)</span>&nbsp;<span class="op" id="972998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="973001">for</span>&nbsp;<span class="ident" id="973005">n</span>&nbsp;<span class="op" id="973007">:=</span>&nbsp;<span class="keyword" id="973010">range</span>&nbsp;<span class="ident" id="973016">c</span>&nbsp;<span class="op" id="973018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="973022">useStack</span><span class="op" id="973030">(</span><span class="ident" id="973031">n</span><span class="op" id="973032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="973036">done</span>&nbsp;<span class="op" id="973041">&lt;-</span>&nbsp;<span class="keyword" id="973044">struct</span><span class="op" id="973050">{</span><span class="op" id="973051">}</span><span class="op" id="973052">{</span><span class="op" id="973053">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="973056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="973059">done</span>&nbsp;<span class="op" id="973064">&lt;-</span>&nbsp;<span class="keyword" id="973067">struct</span><span class="op" id="973073">{</span><span class="op" id="973074">}</span><span class="op" id="973075">{</span><span class="op" id="973076">}</span><br>
<span class="lineno"></span><span class="op" id="973078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="973081">func</span>&nbsp;<span class="ident" id="973086">TestStackCache</span><span class="op" id="973100">(</span><span class="ident" id="973101">t</span>&nbsp;<span class="op" id="973103">*</span><span class="ident" id="973104">testing</span><span class="op" id="973111">.</span><span class="ident" id="973112">T</span><span class="op" id="973113">)</span>&nbsp;<span class="op" id="973115">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="973118">//&nbsp;Allocate&nbsp;a&nbsp;bunch&nbsp;of&nbsp;goroutines&nbsp;and&nbsp;grow&nbsp;their&nbsp;stacks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="973176">//&nbsp;Repeat&nbsp;a&nbsp;few&nbsp;times&nbsp;to&nbsp;test&nbsp;the&nbsp;stack&nbsp;cache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="973224">const</span>&nbsp;<span class="op" id="973230">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="973234">R</span>&nbsp;<span class="op" id="973236">=</span>&nbsp;<span class="num" id="973238">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="973242">G</span>&nbsp;<span class="op" id="973244">=</span>&nbsp;<span class="num" id="973246">200</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="973252">S</span>&nbsp;<span class="op" id="973254">=</span>&nbsp;<span class="num" id="973256">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="973259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="973262">for</span>&nbsp;<span class="ident" id="973266">i</span>&nbsp;<span class="op" id="973268">:=</span>&nbsp;<span class="num" id="973271">0</span><span class="op" id="973272">;</span>&nbsp;<span class="ident" id="973274">i</span>&nbsp;<span class="op" id="973276">&lt;</span>&nbsp;<span class="ident" id="973278">R</span><span class="op" id="973279">;</span>&nbsp;<span class="ident" id="973281">i</span><span class="op" id="973282">++</span>&nbsp;<span class="op" id="973285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="973289">var</span>&nbsp;<span class="ident" id="973293">reqchans</span>&nbsp;<span class="op" id="973302">[</span><span class="ident" id="973303">G</span><span class="op" id="973304">]</span><span class="keyword" id="973305">chan</span>&nbsp;<span class="builtintype" id="973310">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="973316">done</span>&nbsp;<span class="op" id="973321">:=</span>&nbsp;<span class="builtinfunc" id="973324">make</span><span class="op" id="973328">(</span><span class="keyword" id="973329">chan</span>&nbsp;<span class="keyword" id="973334">struct</span><span class="op" id="973340">{</span><span class="op" id="973341">}</span><span class="op" id="973342">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="973346">for</span>&nbsp;<span class="ident" id="973350">j</span>&nbsp;<span class="op" id="973352">:=</span>&nbsp;<span class="num" id="973355">0</span><span class="op" id="973356">;</span>&nbsp;<span class="ident" id="973358">j</span>&nbsp;<span class="op" id="973360">&lt;</span>&nbsp;<span class="ident" id="973362">G</span><span class="op" id="973363">;</span>&nbsp;<span class="ident" id="973365">j</span><span class="op" id="973366">++</span>&nbsp;<span class="op" id="973369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="973374">reqchans</span><span class="op" id="973382">[</span><span class="ident" id="973383">j</span><span class="op" id="973384">]</span>&nbsp;<span class="op" id="973386">=</span>&nbsp;<span class="builtinfunc" id="973388">make</span><span class="op" id="973392">(</span><span class="keyword" id="973393">chan</span>&nbsp;<span class="builtintype" id="973398">int</span><span class="op" id="973401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="973406">go</span>&nbsp;<span class="ident" id="973409">growing</span><span class="op" id="973416">(</span><span class="ident" id="973417">reqchans</span><span class="op" id="973425">[</span><span class="ident" id="973426">j</span><span class="op" id="973427">]</span><span class="op" id="973428">,</span>&nbsp;<span class="ident" id="973430">done</span><span class="op" id="973434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="973438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="973442">for</span>&nbsp;<span class="ident" id="973446">s</span>&nbsp;<span class="op" id="973448">:=</span>&nbsp;<span class="num" id="973451">0</span><span class="op" id="973452">;</span>&nbsp;<span class="ident" id="973454">s</span>&nbsp;<span class="op" id="973456">&lt;</span>&nbsp;<span class="ident" id="973458">S</span><span class="op" id="973459">;</span>&nbsp;<span class="ident" id="973461">s</span><span class="op" id="973462">++</span>&nbsp;<span class="op" id="973465">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="973470">for</span>&nbsp;<span class="ident" id="973474">j</span>&nbsp;<span class="op" id="973476">:=</span>&nbsp;<span class="num" id="973479">0</span><span class="op" id="973480">;</span>&nbsp;<span class="ident" id="973482">j</span>&nbsp;<span class="op" id="973484">&lt;</span>&nbsp;<span class="ident" id="973486">G</span><span class="op" id="973487">;</span>&nbsp;<span class="ident" id="973489">j</span><span class="op" id="973490">++</span>&nbsp;<span class="op" id="973493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="973499">reqchans</span><span class="op" id="973507">[</span><span class="ident" id="973508">j</span><span class="op" id="973509">]</span>&nbsp;<span class="op" id="973511">&lt;-</span>&nbsp;<span class="num" id="973514">1</span>&nbsp;<span class="op" id="973516">&lt;&lt;</span>&nbsp;<span class="builtintype" id="973519">uint</span><span class="op" id="973523">(</span><span class="ident" id="973524">s</span><span class="op" id="973525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="973530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="973535">for</span>&nbsp;<span class="ident" id="973539">j</span>&nbsp;<span class="op" id="973541">:=</span>&nbsp;<span class="num" id="973544">0</span><span class="op" id="973545">;</span>&nbsp;<span class="ident" id="973547">j</span>&nbsp;<span class="op" id="973549">&lt;</span>&nbsp;<span class="ident" id="973551">G</span><span class="op" id="973552">;</span>&nbsp;<span class="ident" id="973554">j</span><span class="op" id="973555">++</span>&nbsp;<span class="op" id="973558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="973564">&lt;-</span><span class="ident" id="973566">done</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="973574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="973578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="973582">for</span>&nbsp;<span class="ident" id="973586">j</span>&nbsp;<span class="op" id="973588">:=</span>&nbsp;<span class="num" id="973591">0</span><span class="op" id="973592">;</span>&nbsp;<span class="ident" id="973594">j</span>&nbsp;<span class="op" id="973596">&lt;</span>&nbsp;<span class="ident" id="973598">G</span><span class="op" id="973599">;</span>&nbsp;<span class="ident" id="973601">j</span><span class="op" id="973602">++</span>&nbsp;<span class="op" id="973605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="973610">close</span><span class="op" id="973615">(</span><span class="ident" id="973616">reqchans</span><span class="op" id="973624">[</span><span class="ident" id="973625">j</span><span class="op" id="973626">]</span><span class="op" id="973627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="973631">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="973635">for</span>&nbsp;<span class="ident" id="973639">j</span>&nbsp;<span class="op" id="973641">:=</span>&nbsp;<span class="num" id="973644">0</span><span class="op" id="973645">;</span>&nbsp;<span class="ident" id="973647">j</span>&nbsp;<span class="op" id="973649">&lt;</span>&nbsp;<span class="ident" id="973651">G</span><span class="op" id="973652">;</span>&nbsp;<span class="ident" id="973654">j</span><span class="op" id="973655">++</span>&nbsp;<span class="op" id="973658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="973663">&lt;-</span><span class="ident" id="973665">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="973672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="973675">}</span><br>
<span class="lineno"></span><span class="op" id="973677">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span><span class="keyword" id="973680">func</span>&nbsp;<span class="ident" id="973685">TestStackOutput</span><span class="op" id="973700">(</span><span class="ident" id="973701">t</span>&nbsp;<span class="op" id="973703">*</span><span class="ident" id="973704">testing</span><span class="op" id="973711">.</span><span class="ident" id="973712">T</span><span class="op" id="973713">)</span>&nbsp;<span class="op" id="973715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="973718">b</span>&nbsp;<span class="op" id="973720">:=</span>&nbsp;<span class="builtinfunc" id="973723">make</span><span class="op" id="973727">(</span><span class="op" id="973728">[</span><span class="op" id="973729">]</span><span class="builtintype" id="973730">byte</span><span class="op" id="973734">,</span>&nbsp;<span class="num" id="973736">1024</span><span class="op" id="973740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="973743">stk</span>&nbsp;<span class="op" id="973747">:=</span>&nbsp;<span class="builtintype" id="973750">string</span><span class="op" id="973756">(</span><span class="ident" id="973757">b</span><span class="op" id="973758">[</span><span class="op" id="973759">:</span><span class="ident" id="973760">Stack</span><span class="op" id="973765">(</span><span class="ident" id="973766">b</span><span class="op" id="973767">,</span>&nbsp;<span class="builtintype" id="973769">false</span><span class="op" id="973774">)</span><span class="op" id="973775">]</span><span class="op" id="973776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="973779">if</span>&nbsp;<span class="op" id="973782">!</span><span class="ident" id="973783">strings</span><span class="op" id="973790">.</span><span class="ident" id="973791">HasPrefix</span><span class="op" id="973800">(</span><span class="ident" id="973801">stk</span><span class="op" id="973804">,</span>&nbsp;<span class="string" id="973806">&#34;goroutine&nbsp;&#34;</span><span class="op" id="973818">)</span>&nbsp;<span class="op" id="973820">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="973824">t</span><span class="op" id="973825">.</span><span class="ident" id="973826">Errorf</span><span class="op" id="973832">(</span><span class="string" id="973833">&#34;Stack&nbsp;(len&nbsp;%d):\n%s&#34;</span><span class="op" id="973854">,</span>&nbsp;<span class="builtinfunc" id="973856">len</span><span class="op" id="973859">(</span><span class="ident" id="973860">stk</span><span class="op" id="973863">)</span><span class="op" id="973864">,</span>&nbsp;<span class="ident" id="973866">stk</span><span class="op" id="973869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="973873">t</span><span class="op" id="973874">.</span><span class="ident" id="973875">Errorf</span><span class="op" id="973881">(</span><span class="string" id="973882">&#34;Stack&nbsp;output&nbsp;should&nbsp;begin&nbsp;with&nbsp;\&#34;goroutine&nbsp;\&#34;&#34;</span><span class="op" id="973929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="973932">}</span><br>
<span class="lineno"></span><span class="op" id="973934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span><span class="keyword" id="973937">func</span>&nbsp;<span class="ident" id="973942">TestStackAllOutput</span><span class="op" id="973960">(</span><span class="ident" id="973961">t</span>&nbsp;<span class="op" id="973963">*</span><span class="ident" id="973964">testing</span><span class="op" id="973971">.</span><span class="ident" id="973972">T</span><span class="op" id="973973">)</span>&nbsp;<span class="op" id="973975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="973978">b</span>&nbsp;<span class="op" id="973980">:=</span>&nbsp;<span class="builtinfunc" id="973983">make</span><span class="op" id="973987">(</span><span class="op" id="973988">[</span><span class="op" id="973989">]</span><span class="builtintype" id="973990">byte</span><span class="op" id="973994">,</span>&nbsp;<span class="num" id="973996">1024</span><span class="op" id="974000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="974003">stk</span>&nbsp;<span class="op" id="974007">:=</span>&nbsp;<span class="builtintype" id="974010">string</span><span class="op" id="974016">(</span><span class="ident" id="974017">b</span><span class="op" id="974018">[</span><span class="op" id="974019">:</span><span class="ident" id="974020">Stack</span><span class="op" id="974025">(</span><span class="ident" id="974026">b</span><span class="op" id="974027">,</span>&nbsp;<span class="builtintype" id="974029">true</span><span class="op" id="974033">)</span><span class="op" id="974034">]</span><span class="op" id="974035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="974038">if</span>&nbsp;<span class="op" id="974041">!</span><span class="ident" id="974042">strings</span><span class="op" id="974049">.</span><span class="ident" id="974050">HasPrefix</span><span class="op" id="974059">(</span><span class="ident" id="974060">stk</span><span class="op" id="974063">,</span>&nbsp;<span class="string" id="974065">&#34;goroutine&nbsp;&#34;</span><span class="op" id="974077">)</span>&nbsp;<span class="op" id="974079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="974083">t</span><span class="op" id="974084">.</span><span class="ident" id="974085">Errorf</span><span class="op" id="974091">(</span><span class="string" id="974092">&#34;Stack&nbsp;(len&nbsp;%d):\n%s&#34;</span><span class="op" id="974113">,</span>&nbsp;<span class="builtinfunc" id="974115">len</span><span class="op" id="974118">(</span><span class="ident" id="974119">stk</span><span class="op" id="974122">)</span><span class="op" id="974123">,</span>&nbsp;<span class="ident" id="974125">stk</span><span class="op" id="974128">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="974132">t</span><span class="op" id="974133">.</span><span class="ident" id="974134">Errorf</span><span class="op" id="974140">(</span><span class="string" id="974141">&#34;Stack&nbsp;output&nbsp;should&nbsp;begin&nbsp;with&nbsp;\&#34;goroutine&nbsp;\&#34;&#34;</span><span class="op" id="974188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="974191">}</span><br>
<span class="lineno"></span><span class="op" id="974193">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="974196">func</span>&nbsp;<span class="ident" id="974201">TestStackPanic</span><span class="op" id="974215">(</span><span class="ident" id="974216">t</span>&nbsp;<span class="op" id="974218">*</span><span class="ident" id="974219">testing</span><span class="op" id="974226">.</span><span class="ident" id="974227">T</span><span class="op" id="974228">)</span>&nbsp;<span class="op" id="974230">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="974233">//&nbsp;Test&nbsp;that&nbsp;stack&nbsp;copying&nbsp;copies&nbsp;panics&nbsp;correctly.&nbsp;&nbsp;This&nbsp;is&nbsp;difficult</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="974305">//&nbsp;to&nbsp;test&nbsp;because&nbsp;it&nbsp;is&nbsp;very&nbsp;unlikely&nbsp;that&nbsp;the&nbsp;stack&nbsp;will&nbsp;be&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="974375">//&nbsp;in&nbsp;the&nbsp;middle&nbsp;of&nbsp;gopanic.&nbsp;&nbsp;But&nbsp;it&nbsp;can&nbsp;happen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="974425">//&nbsp;To&nbsp;make&nbsp;this&nbsp;test&nbsp;effective,&nbsp;edit&nbsp;panic.go:gopanic&nbsp;and&nbsp;uncomment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="974494">//&nbsp;the&nbsp;GC()&nbsp;call&nbsp;just&nbsp;before&nbsp;freedefer(d).</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="974538">defer</span>&nbsp;<span class="keyword" id="974544">func</span><span class="op" id="974548">(</span><span class="op" id="974549">)</span>&nbsp;<span class="op" id="974551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="974555">if</span>&nbsp;<span class="ident" id="974558">x</span>&nbsp;<span class="op" id="974560">:=</span>&nbsp;<span class="builtinfunc" id="974563">recover</span><span class="op" id="974570">(</span><span class="op" id="974571">)</span><span class="op" id="974572">;</span>&nbsp;<span class="ident" id="974574">x</span>&nbsp;<span class="op" id="974576">==</span>&nbsp;<span class="ident" id="974579">nil</span>&nbsp;<span class="op" id="974583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="974588">t</span><span class="op" id="974589">.</span><span class="ident" id="974590">Errorf</span><span class="op" id="974596">(</span><span class="string" id="974597">&#34;recover&nbsp;failed&#34;</span><span class="op" id="974613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="974617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="974620">}</span><span class="op" id="974621">(</span><span class="op" id="974622">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="974625">useStack</span><span class="op" id="974633">(</span><span class="num" id="974634">32</span><span class="op" id="974636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="974639">panic</span><span class="op" id="974644">(</span><span class="string" id="974645">&#34;test&nbsp;panic&#34;</span><span class="op" id="974657">)</span><br>
<span class="lineno"></span><span class="op" id="974659">}</span>
</div>
</body>
</html>
