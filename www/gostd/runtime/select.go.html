<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html" class="current">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1645315">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1645370">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1645424">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1645475">package</span>&nbsp;<span class="ident" id="1645483">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1645492">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;select&nbsp;statements.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1645559">import</span>&nbsp;<span class="string" id="1645566">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1645576">const</span>&nbsp;<span class="op" id="1645582">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645585">debugSelect</span>&nbsp;<span class="op" id="1645597">=</span>&nbsp;<span class="builtintype" id="1645599">false</span><br>
<span class="lineno"></span><span class="op" id="1645605">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="1645608">var</span>&nbsp;<span class="op" id="1645612">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645615">chansendpc</span>&nbsp;<span class="op" id="1645626">=</span>&nbsp;<span class="ident" id="1645628">funcPC</span><span class="op" id="1645634">(</span><span class="ident" id="1645635">chansend</span><span class="op" id="1645643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645646">chanrecvpc</span>&nbsp;<span class="op" id="1645657">=</span>&nbsp;<span class="ident" id="1645659">funcPC</span><span class="op" id="1645665">(</span><span class="ident" id="1645666">chanrecv</span><span class="op" id="1645674">)</span><br>
<span class="lineno"></span><span class="op" id="1645676">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1645679">func</span>&nbsp;<span class="ident" id="1645684">selectsize</span><span class="op" id="1645694">(</span><span class="ident" id="1645695">size</span>&nbsp;<span class="builtintype" id="1645700">uintptr</span><span class="op" id="1645707">)</span>&nbsp;<span class="builtintype" id="1645709">uintptr</span>&nbsp;<span class="op" id="1645717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645720">selsize</span>&nbsp;<span class="op" id="1645728">:=</span>&nbsp;<span class="ident" id="1645731">unsafe</span><span class="op" id="1645737">.</span><span class="ident" id="1645738">Sizeof</span><span class="op" id="1645744">(</span><span class="ident" id="1645745">_select</span><span class="op" id="1645752">{</span><span class="op" id="1645753">}</span><span class="op" id="1645754">)</span>&nbsp;<span class="op" id="1645756">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1645760">(</span><span class="ident" id="1645761">size</span><span class="op" id="1645765">-</span><span class="num" id="1645766">1</span><span class="op" id="1645767">)</span><span class="op" id="1645768">*</span><span class="ident" id="1645769">unsafe</span><span class="op" id="1645775">.</span><span class="ident" id="1645776">Sizeof</span><span class="op" id="1645782">(</span><span class="ident" id="1645783">_select</span><span class="op" id="1645790">{</span><span class="op" id="1645791">}</span><span class="op" id="1645792">.</span><span class="ident" id="1645793">scase</span><span class="op" id="1645798">[</span><span class="num" id="1645799">0</span><span class="op" id="1645800">]</span><span class="op" id="1645801">)</span>&nbsp;<span class="op" id="1645803">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645807">size</span><span class="op" id="1645811">*</span><span class="ident" id="1645812">unsafe</span><span class="op" id="1645818">.</span><span class="ident" id="1645819">Sizeof</span><span class="op" id="1645825">(</span><span class="op" id="1645826">*</span><span class="ident" id="1645827">_select</span><span class="op" id="1645834">{</span><span class="op" id="1645835">}</span><span class="op" id="1645836">.</span><span class="ident" id="1645837">lockorder</span><span class="op" id="1645846">)</span>&nbsp;<span class="op" id="1645848">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1645852">size</span><span class="op" id="1645856">*</span><span class="ident" id="1645857">unsafe</span><span class="op" id="1645863">.</span><span class="ident" id="1645864">Sizeof</span><span class="op" id="1645870">(</span><span class="op" id="1645871">*</span><span class="ident" id="1645872">_select</span><span class="op" id="1645879">{</span><span class="op" id="1645880">}</span><span class="op" id="1645881">.</span><span class="ident" id="1645882">pollorder</span><span class="op" id="1645891">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1645894">return</span>&nbsp;<span class="ident" id="1645901">round</span><span class="op" id="1645906">(</span><span class="ident" id="1645907">selsize</span><span class="op" id="1645914">,</span>&nbsp;<span class="ident" id="1645916">_Int64Align</span><span class="op" id="1645927">)</span><br>
<span class="lineno"></span><span class="op" id="1645929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1645932">func</span>&nbsp;<span class="ident" id="1645937">newselect</span><span class="op" id="1645946">(</span><span class="ident" id="1645947">sel</span>&nbsp;<span class="op" id="1645951">*</span><span class="ident" id="1645952">_select</span><span class="op" id="1645959">,</span>&nbsp;<span class="ident" id="1645961">selsize</span>&nbsp;<span class="ident" id="1645969">int64</span><span class="op" id="1645974">,</span>&nbsp;<span class="ident" id="1645976">size</span>&nbsp;<span class="builtintype" id="1645981">int32</span><span class="op" id="1645986">)</span>&nbsp;<span class="op" id="1645988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1645991">if</span>&nbsp;<span class="ident" id="1645994">selsize</span>&nbsp;<span class="op" id="1646002">!=</span>&nbsp;<span class="ident" id="1646005">int64</span><span class="op" id="1646010">(</span><span class="ident" id="1646011">selectsize</span><span class="op" id="1646021">(</span><span class="builtintype" id="1646022">uintptr</span><span class="op" id="1646029">(</span><span class="ident" id="1646030">size</span><span class="op" id="1646034">)</span><span class="op" id="1646035">)</span><span class="op" id="1646036">)</span>&nbsp;<span class="op" id="1646038">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1646042">print</span><span class="op" id="1646047">(</span><span class="string" id="1646048">&#34;runtime:&nbsp;bad&nbsp;select&nbsp;size&nbsp;&#34;</span><span class="op" id="1646075">,</span>&nbsp;<span class="ident" id="1646077">selsize</span><span class="op" id="1646084">,</span>&nbsp;<span class="string" id="1646086">&#34;,&nbsp;want&nbsp;&#34;</span><span class="op" id="1646095">,</span>&nbsp;<span class="ident" id="1646097">selectsize</span><span class="op" id="1646107">(</span><span class="builtintype" id="1646108">uintptr</span><span class="op" id="1646115">(</span><span class="ident" id="1646116">size</span><span class="op" id="1646120">)</span><span class="op" id="1646121">)</span><span class="op" id="1646122">,</span>&nbsp;<span class="string" id="1646124">&#34;\n&#34;</span><span class="op" id="1646128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646132">gothrow</span><span class="op" id="1646139">(</span><span class="string" id="1646140">&#34;bad&nbsp;select&nbsp;size&#34;</span><span class="op" id="1646157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1646160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646163">sel</span><span class="op" id="1646166">.</span><span class="ident" id="1646167">tcase</span>&nbsp;<span class="op" id="1646173">=</span>&nbsp;<span class="builtintype" id="1646175">uint16</span><span class="op" id="1646181">(</span><span class="ident" id="1646182">size</span><span class="op" id="1646186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646189">sel</span><span class="op" id="1646192">.</span><span class="ident" id="1646193">ncase</span>&nbsp;<span class="op" id="1646199">=</span>&nbsp;<span class="num" id="1646201">0</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646204">sel</span><span class="op" id="1646207">.</span><span class="ident" id="1646208">lockorder</span>&nbsp;<span class="op" id="1646218">=</span>&nbsp;<span class="op" id="1646220">(</span><span class="op" id="1646221">*</span><span class="op" id="1646222">*</span><span class="ident" id="1646223">hchan</span><span class="op" id="1646228">)</span><span class="op" id="1646229">(</span><span class="ident" id="1646230">add</span><span class="op" id="1646233">(</span><span class="ident" id="1646234">unsafe</span><span class="op" id="1646240">.</span><span class="ident" id="1646241">Pointer</span><span class="op" id="1646248">(</span><span class="op" id="1646249">&amp;</span><span class="ident" id="1646250">sel</span><span class="op" id="1646253">.</span><span class="ident" id="1646254">scase</span><span class="op" id="1646259">)</span><span class="op" id="1646260">,</span>&nbsp;<span class="builtintype" id="1646262">uintptr</span><span class="op" id="1646269">(</span><span class="ident" id="1646270">size</span><span class="op" id="1646274">)</span><span class="op" id="1646275">*</span><span class="ident" id="1646276">unsafe</span><span class="op" id="1646282">.</span><span class="ident" id="1646283">Sizeof</span><span class="op" id="1646289">(</span><span class="ident" id="1646290">_select</span><span class="op" id="1646297">{</span><span class="op" id="1646298">}</span><span class="op" id="1646299">.</span><span class="ident" id="1646300">scase</span><span class="op" id="1646305">[</span><span class="num" id="1646306">0</span><span class="op" id="1646307">]</span><span class="op" id="1646308">)</span><span class="op" id="1646309">)</span><span class="op" id="1646310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646313">sel</span><span class="op" id="1646316">.</span><span class="ident" id="1646317">pollorder</span>&nbsp;<span class="op" id="1646327">=</span>&nbsp;<span class="op" id="1646329">(</span><span class="op" id="1646330">*</span><span class="builtintype" id="1646331">uint16</span><span class="op" id="1646337">)</span><span class="op" id="1646338">(</span><span class="ident" id="1646339">add</span><span class="op" id="1646342">(</span><span class="ident" id="1646343">unsafe</span><span class="op" id="1646349">.</span><span class="ident" id="1646350">Pointer</span><span class="op" id="1646357">(</span><span class="ident" id="1646358">sel</span><span class="op" id="1646361">.</span><span class="ident" id="1646362">lockorder</span><span class="op" id="1646371">)</span><span class="op" id="1646372">,</span>&nbsp;<span class="builtintype" id="1646374">uintptr</span><span class="op" id="1646381">(</span><span class="ident" id="1646382">size</span><span class="op" id="1646386">)</span><span class="op" id="1646387">*</span><span class="ident" id="1646388">unsafe</span><span class="op" id="1646394">.</span><span class="ident" id="1646395">Sizeof</span><span class="op" id="1646401">(</span><span class="op" id="1646402">*</span><span class="ident" id="1646403">_select</span><span class="op" id="1646410">{</span><span class="op" id="1646411">}</span><span class="op" id="1646412">.</span><span class="ident" id="1646413">lockorder</span><span class="op" id="1646422">)</span><span class="op" id="1646423">)</span><span class="op" id="1646424">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1646428">if</span>&nbsp;<span class="ident" id="1646431">debugSelect</span>&nbsp;<span class="op" id="1646443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1646447">print</span><span class="op" id="1646452">(</span><span class="string" id="1646453">&#34;newselect&nbsp;s=&#34;</span><span class="op" id="1646467">,</span>&nbsp;<span class="ident" id="1646469">sel</span><span class="op" id="1646472">,</span>&nbsp;<span class="string" id="1646474">&#34;&nbsp;size=&#34;</span><span class="op" id="1646482">,</span>&nbsp;<span class="ident" id="1646484">size</span><span class="op" id="1646488">,</span>&nbsp;<span class="string" id="1646490">&#34;\n&#34;</span><span class="op" id="1646494">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1646497">}</span><br>
<span class="lineno"></span><span class="op" id="1646499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1646502">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1646515">func</span>&nbsp;<span class="ident" id="1646520">selectsend</span><span class="op" id="1646530">(</span><span class="ident" id="1646531">sel</span>&nbsp;<span class="op" id="1646535">*</span><span class="ident" id="1646536">_select</span><span class="op" id="1646543">,</span>&nbsp;<span class="ident" id="1646545">c</span>&nbsp;<span class="op" id="1646547">*</span><span class="ident" id="1646548">hchan</span><span class="op" id="1646553">,</span>&nbsp;<span class="ident" id="1646555">elem</span>&nbsp;<span class="ident" id="1646560">unsafe</span><span class="op" id="1646566">.</span><span class="ident" id="1646567">Pointer</span><span class="op" id="1646574">)</span>&nbsp;<span class="op" id="1646576">(</span><span class="ident" id="1646577">selected</span>&nbsp;<span class="builtintype" id="1646586">bool</span><span class="op" id="1646590">)</span>&nbsp;<span class="op" id="1646592">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1646595">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1646624">if</span>&nbsp;<span class="ident" id="1646627">c</span>&nbsp;<span class="op" id="1646629">!=</span>&nbsp;<span class="builtintype" id="1646632">nil</span>&nbsp;<span class="op" id="1646636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646640">selectsendImpl</span><span class="op" id="1646654">(</span><span class="ident" id="1646655">sel</span><span class="op" id="1646658">,</span>&nbsp;<span class="ident" id="1646660">c</span><span class="op" id="1646661">,</span>&nbsp;<span class="ident" id="1646663">getcallerpc</span><span class="op" id="1646674">(</span><span class="ident" id="1646675">unsafe</span><span class="op" id="1646681">.</span><span class="ident" id="1646682">Pointer</span><span class="op" id="1646689">(</span><span class="op" id="1646690">&amp;</span><span class="ident" id="1646691">sel</span><span class="op" id="1646694">)</span><span class="op" id="1646695">)</span><span class="op" id="1646696">,</span>&nbsp;<span class="ident" id="1646698">elem</span><span class="op" id="1646702">,</span>&nbsp;<span class="builtintype" id="1646704">uintptr</span><span class="op" id="1646711">(</span><span class="ident" id="1646712">unsafe</span><span class="op" id="1646718">.</span><span class="ident" id="1646719">Pointer</span><span class="op" id="1646726">(</span><span class="op" id="1646727">&amp;</span><span class="ident" id="1646728">selected</span><span class="op" id="1646736">)</span><span class="op" id="1646737">)</span><span class="op" id="1646738">-</span><span class="builtintype" id="1646739">uintptr</span><span class="op" id="1646746">(</span><span class="ident" id="1646747">unsafe</span><span class="op" id="1646753">.</span><span class="ident" id="1646754">Pointer</span><span class="op" id="1646761">(</span><span class="op" id="1646762">&amp;</span><span class="ident" id="1646763">sel</span><span class="op" id="1646766">)</span><span class="op" id="1646767">)</span><span class="op" id="1646768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1646771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1646774">return</span><br>
<span class="lineno">50</span><span class="op" id="1646781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1646784">//&nbsp;cut&nbsp;in&nbsp;half&nbsp;to&nbsp;give&nbsp;stack&nbsp;a&nbsp;chance&nbsp;to&nbsp;split</span><br>
<span class="lineno"></span><span class="keyword" id="1646831">func</span>&nbsp;<span class="ident" id="1646836">selectsendImpl</span><span class="op" id="1646850">(</span><span class="ident" id="1646851">sel</span>&nbsp;<span class="op" id="1646855">*</span><span class="ident" id="1646856">_select</span><span class="op" id="1646863">,</span>&nbsp;<span class="ident" id="1646865">c</span>&nbsp;<span class="op" id="1646867">*</span><span class="ident" id="1646868">hchan</span><span class="op" id="1646873">,</span>&nbsp;<span class="ident" id="1646875">pc</span>&nbsp;<span class="builtintype" id="1646878">uintptr</span><span class="op" id="1646885">,</span>&nbsp;<span class="ident" id="1646887">elem</span>&nbsp;<span class="ident" id="1646892">unsafe</span><span class="op" id="1646898">.</span><span class="ident" id="1646899">Pointer</span><span class="op" id="1646906">,</span>&nbsp;<span class="ident" id="1646908">so</span>&nbsp;<span class="builtintype" id="1646911">uintptr</span><span class="op" id="1646918">)</span>&nbsp;<span class="op" id="1646920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646923">i</span>&nbsp;<span class="op" id="1646925">:=</span>&nbsp;<span class="ident" id="1646928">sel</span><span class="op" id="1646931">.</span><span class="ident" id="1646932">ncase</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1646939">if</span>&nbsp;<span class="ident" id="1646942">i</span>&nbsp;<span class="op" id="1646944">&gt;=</span>&nbsp;<span class="ident" id="1646947">sel</span><span class="op" id="1646950">.</span><span class="ident" id="1646951">tcase</span>&nbsp;<span class="op" id="1646957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1646961">gothrow</span><span class="op" id="1646968">(</span><span class="string" id="1646969">&#34;selectsend:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1646997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1647000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647003">sel</span><span class="op" id="1647006">.</span><span class="ident" id="1647007">ncase</span>&nbsp;<span class="op" id="1647013">=</span>&nbsp;<span class="ident" id="1647015">i</span>&nbsp;<span class="op" id="1647017">+</span>&nbsp;<span class="num" id="1647019">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647022">cas</span>&nbsp;<span class="op" id="1647026">:=</span>&nbsp;<span class="op" id="1647029">(</span><span class="op" id="1647030">*</span><span class="ident" id="1647031">scase</span><span class="op" id="1647036">)</span><span class="op" id="1647037">(</span><span class="ident" id="1647038">add</span><span class="op" id="1647041">(</span><span class="ident" id="1647042">unsafe</span><span class="op" id="1647048">.</span><span class="ident" id="1647049">Pointer</span><span class="op" id="1647056">(</span><span class="op" id="1647057">&amp;</span><span class="ident" id="1647058">sel</span><span class="op" id="1647061">.</span><span class="ident" id="1647062">scase</span><span class="op" id="1647067">)</span><span class="op" id="1647068">,</span>&nbsp;<span class="builtintype" id="1647070">uintptr</span><span class="op" id="1647077">(</span><span class="ident" id="1647078">i</span><span class="op" id="1647079">)</span><span class="op" id="1647080">*</span><span class="ident" id="1647081">unsafe</span><span class="op" id="1647087">.</span><span class="ident" id="1647088">Sizeof</span><span class="op" id="1647094">(</span><span class="ident" id="1647095">sel</span><span class="op" id="1647098">.</span><span class="ident" id="1647099">scase</span><span class="op" id="1647104">[</span><span class="num" id="1647105">0</span><span class="op" id="1647106">]</span><span class="op" id="1647107">)</span><span class="op" id="1647108">)</span><span class="op" id="1647109">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647113">cas</span><span class="op" id="1647116">.</span><span class="ident" id="1647117">pc</span>&nbsp;<span class="op" id="1647120">=</span>&nbsp;<span class="ident" id="1647122">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647126">cas</span><span class="op" id="1647129">.</span><span class="ident" id="1647130">_chan</span>&nbsp;<span class="op" id="1647136">=</span>&nbsp;<span class="ident" id="1647138">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647141">cas</span><span class="op" id="1647144">.</span><span class="ident" id="1647145">so</span>&nbsp;<span class="op" id="1647148">=</span>&nbsp;<span class="builtintype" id="1647150">uint16</span><span class="op" id="1647156">(</span><span class="ident" id="1647157">so</span><span class="op" id="1647159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647162">cas</span><span class="op" id="1647165">.</span><span class="ident" id="1647166">kind</span>&nbsp;<span class="op" id="1647171">=</span>&nbsp;<span class="ident" id="1647173">_CaseSend</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647184">cas</span><span class="op" id="1647187">.</span><span class="ident" id="1647188">elem</span>&nbsp;<span class="op" id="1647193">=</span>&nbsp;<span class="ident" id="1647195">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1647202">if</span>&nbsp;<span class="ident" id="1647205">debugSelect</span>&nbsp;<span class="op" id="1647217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1647221">print</span><span class="op" id="1647226">(</span><span class="string" id="1647227">&#34;selectsend&nbsp;s=&#34;</span><span class="op" id="1647242">,</span>&nbsp;<span class="ident" id="1647244">sel</span><span class="op" id="1647247">,</span>&nbsp;<span class="string" id="1647249">&#34;&nbsp;pc=&#34;</span><span class="op" id="1647255">,</span>&nbsp;<span class="ident" id="1647257">hex</span><span class="op" id="1647260">(</span><span class="ident" id="1647261">cas</span><span class="op" id="1647264">.</span><span class="ident" id="1647265">pc</span><span class="op" id="1647267">)</span><span class="op" id="1647268">,</span>&nbsp;<span class="string" id="1647270">&#34;&nbsp;chan=&#34;</span><span class="op" id="1647278">,</span>&nbsp;<span class="ident" id="1647280">cas</span><span class="op" id="1647283">.</span><span class="ident" id="1647284">_chan</span><span class="op" id="1647289">,</span>&nbsp;<span class="string" id="1647291">&#34;&nbsp;so=&#34;</span><span class="op" id="1647297">,</span>&nbsp;<span class="ident" id="1647299">cas</span><span class="op" id="1647302">.</span><span class="ident" id="1647303">so</span><span class="op" id="1647305">,</span>&nbsp;<span class="string" id="1647307">&#34;\n&#34;</span><span class="op" id="1647311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1647314">}</span><br>
<span class="lineno">70</span><span class="op" id="1647316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1647319">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1647332">func</span>&nbsp;<span class="ident" id="1647337">selectrecv</span><span class="op" id="1647347">(</span><span class="ident" id="1647348">sel</span>&nbsp;<span class="op" id="1647352">*</span><span class="ident" id="1647353">_select</span><span class="op" id="1647360">,</span>&nbsp;<span class="ident" id="1647362">c</span>&nbsp;<span class="op" id="1647364">*</span><span class="ident" id="1647365">hchan</span><span class="op" id="1647370">,</span>&nbsp;<span class="ident" id="1647372">elem</span>&nbsp;<span class="ident" id="1647377">unsafe</span><span class="op" id="1647383">.</span><span class="ident" id="1647384">Pointer</span><span class="op" id="1647391">)</span>&nbsp;<span class="op" id="1647393">(</span><span class="ident" id="1647394">selected</span>&nbsp;<span class="builtintype" id="1647403">bool</span><span class="op" id="1647407">)</span>&nbsp;<span class="op" id="1647409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1647412">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1647441">if</span>&nbsp;<span class="ident" id="1647444">c</span>&nbsp;<span class="op" id="1647446">!=</span>&nbsp;<span class="builtintype" id="1647449">nil</span>&nbsp;<span class="op" id="1647453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647457">selectrecvImpl</span><span class="op" id="1647471">(</span><span class="ident" id="1647472">sel</span><span class="op" id="1647475">,</span>&nbsp;<span class="ident" id="1647477">c</span><span class="op" id="1647478">,</span>&nbsp;<span class="ident" id="1647480">getcallerpc</span><span class="op" id="1647491">(</span><span class="ident" id="1647492">unsafe</span><span class="op" id="1647498">.</span><span class="ident" id="1647499">Pointer</span><span class="op" id="1647506">(</span><span class="op" id="1647507">&amp;</span><span class="ident" id="1647508">sel</span><span class="op" id="1647511">)</span><span class="op" id="1647512">)</span><span class="op" id="1647513">,</span>&nbsp;<span class="ident" id="1647515">elem</span><span class="op" id="1647519">,</span>&nbsp;<span class="builtintype" id="1647521">nil</span><span class="op" id="1647524">,</span>&nbsp;<span class="builtintype" id="1647526">uintptr</span><span class="op" id="1647533">(</span><span class="ident" id="1647534">unsafe</span><span class="op" id="1647540">.</span><span class="ident" id="1647541">Pointer</span><span class="op" id="1647548">(</span><span class="op" id="1647549">&amp;</span><span class="ident" id="1647550">selected</span><span class="op" id="1647558">)</span><span class="op" id="1647559">)</span><span class="op" id="1647560">-</span><span class="builtintype" id="1647561">uintptr</span><span class="op" id="1647568">(</span><span class="ident" id="1647569">unsafe</span><span class="op" id="1647575">.</span><span class="ident" id="1647576">Pointer</span><span class="op" id="1647583">(</span><span class="op" id="1647584">&amp;</span><span class="ident" id="1647585">sel</span><span class="op" id="1647588">)</span><span class="op" id="1647589">)</span><span class="op" id="1647590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1647593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1647596">return</span><br>
<span class="lineno"></span><span class="op" id="1647603">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="comment" id="1647606">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1647619">func</span>&nbsp;<span class="ident" id="1647624">selectrecv2</span><span class="op" id="1647635">(</span><span class="ident" id="1647636">sel</span>&nbsp;<span class="op" id="1647640">*</span><span class="ident" id="1647641">_select</span><span class="op" id="1647648">,</span>&nbsp;<span class="ident" id="1647650">c</span>&nbsp;<span class="op" id="1647652">*</span><span class="ident" id="1647653">hchan</span><span class="op" id="1647658">,</span>&nbsp;<span class="ident" id="1647660">elem</span>&nbsp;<span class="ident" id="1647665">unsafe</span><span class="op" id="1647671">.</span><span class="ident" id="1647672">Pointer</span><span class="op" id="1647679">,</span>&nbsp;<span class="ident" id="1647681">received</span>&nbsp;<span class="op" id="1647690">*</span><span class="builtintype" id="1647691">bool</span><span class="op" id="1647695">)</span>&nbsp;<span class="op" id="1647697">(</span><span class="ident" id="1647698">selected</span>&nbsp;<span class="builtintype" id="1647707">bool</span><span class="op" id="1647711">)</span>&nbsp;<span class="op" id="1647713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1647716">//&nbsp;nil&nbsp;cases&nbsp;do&nbsp;not&nbsp;compete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1647745">if</span>&nbsp;<span class="ident" id="1647748">c</span>&nbsp;<span class="op" id="1647750">!=</span>&nbsp;<span class="builtintype" id="1647753">nil</span>&nbsp;<span class="op" id="1647757">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1647761">selectrecvImpl</span><span class="op" id="1647775">(</span><span class="ident" id="1647776">sel</span><span class="op" id="1647779">,</span>&nbsp;<span class="ident" id="1647781">c</span><span class="op" id="1647782">,</span>&nbsp;<span class="ident" id="1647784">getcallerpc</span><span class="op" id="1647795">(</span><span class="ident" id="1647796">unsafe</span><span class="op" id="1647802">.</span><span class="ident" id="1647803">Pointer</span><span class="op" id="1647810">(</span><span class="op" id="1647811">&amp;</span><span class="ident" id="1647812">sel</span><span class="op" id="1647815">)</span><span class="op" id="1647816">)</span><span class="op" id="1647817">,</span>&nbsp;<span class="ident" id="1647819">elem</span><span class="op" id="1647823">,</span>&nbsp;<span class="ident" id="1647825">received</span><span class="op" id="1647833">,</span>&nbsp;<span class="builtintype" id="1647835">uintptr</span><span class="op" id="1647842">(</span><span class="ident" id="1647843">unsafe</span><span class="op" id="1647849">.</span><span class="ident" id="1647850">Pointer</span><span class="op" id="1647857">(</span><span class="op" id="1647858">&amp;</span><span class="ident" id="1647859">selected</span><span class="op" id="1647867">)</span><span class="op" id="1647868">)</span><span class="op" id="1647869">-</span><span class="builtintype" id="1647870">uintptr</span><span class="op" id="1647877">(</span><span class="ident" id="1647878">unsafe</span><span class="op" id="1647884">.</span><span class="ident" id="1647885">Pointer</span><span class="op" id="1647892">(</span><span class="op" id="1647893">&amp;</span><span class="ident" id="1647894">sel</span><span class="op" id="1647897">)</span><span class="op" id="1647898">)</span><span class="op" id="1647899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1647902">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1647905">return</span><br>
<span class="lineno"></span><span class="op" id="1647912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="1647915">func</span>&nbsp;<span class="ident" id="1647920">selectrecvImpl</span><span class="op" id="1647934">(</span><span class="ident" id="1647935">sel</span>&nbsp;<span class="op" id="1647939">*</span><span class="ident" id="1647940">_select</span><span class="op" id="1647947">,</span>&nbsp;<span class="ident" id="1647949">c</span>&nbsp;<span class="op" id="1647951">*</span><span class="ident" id="1647952">hchan</span><span class="op" id="1647957">,</span>&nbsp;<span class="ident" id="1647959">pc</span>&nbsp;<span class="builtintype" id="1647962">uintptr</span><span class="op" id="1647969">,</span>&nbsp;<span class="ident" id="1647971">elem</span>&nbsp;<span class="ident" id="1647976">unsafe</span><span class="op" id="1647982">.</span><span class="ident" id="1647983">Pointer</span><span class="op" id="1647990">,</span>&nbsp;<span class="ident" id="1647992">received</span>&nbsp;<span class="op" id="1648001">*</span><span class="builtintype" id="1648002">bool</span><span class="op" id="1648006">,</span>&nbsp;<span class="ident" id="1648008">so</span>&nbsp;<span class="builtintype" id="1648011">uintptr</span><span class="op" id="1648018">)</span>&nbsp;<span class="op" id="1648020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648023">i</span>&nbsp;<span class="op" id="1648025">:=</span>&nbsp;<span class="ident" id="1648028">sel</span><span class="op" id="1648031">.</span><span class="ident" id="1648032">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1648039">if</span>&nbsp;<span class="ident" id="1648042">i</span>&nbsp;<span class="op" id="1648044">&gt;=</span>&nbsp;<span class="ident" id="1648047">sel</span><span class="op" id="1648050">.</span><span class="ident" id="1648051">tcase</span>&nbsp;<span class="op" id="1648057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648061">gothrow</span><span class="op" id="1648068">(</span><span class="string" id="1648069">&#34;selectrecv:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1648097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1648100">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648103">sel</span><span class="op" id="1648106">.</span><span class="ident" id="1648107">ncase</span>&nbsp;<span class="op" id="1648113">=</span>&nbsp;<span class="ident" id="1648115">i</span>&nbsp;<span class="op" id="1648117">+</span>&nbsp;<span class="num" id="1648119">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648122">cas</span>&nbsp;<span class="op" id="1648126">:=</span>&nbsp;<span class="op" id="1648129">(</span><span class="op" id="1648130">*</span><span class="ident" id="1648131">scase</span><span class="op" id="1648136">)</span><span class="op" id="1648137">(</span><span class="ident" id="1648138">add</span><span class="op" id="1648141">(</span><span class="ident" id="1648142">unsafe</span><span class="op" id="1648148">.</span><span class="ident" id="1648149">Pointer</span><span class="op" id="1648156">(</span><span class="op" id="1648157">&amp;</span><span class="ident" id="1648158">sel</span><span class="op" id="1648161">.</span><span class="ident" id="1648162">scase</span><span class="op" id="1648167">)</span><span class="op" id="1648168">,</span>&nbsp;<span class="builtintype" id="1648170">uintptr</span><span class="op" id="1648177">(</span><span class="ident" id="1648178">i</span><span class="op" id="1648179">)</span><span class="op" id="1648180">*</span><span class="ident" id="1648181">unsafe</span><span class="op" id="1648187">.</span><span class="ident" id="1648188">Sizeof</span><span class="op" id="1648194">(</span><span class="ident" id="1648195">sel</span><span class="op" id="1648198">.</span><span class="ident" id="1648199">scase</span><span class="op" id="1648204">[</span><span class="num" id="1648205">0</span><span class="op" id="1648206">]</span><span class="op" id="1648207">)</span><span class="op" id="1648208">)</span><span class="op" id="1648209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648212">cas</span><span class="op" id="1648215">.</span><span class="ident" id="1648216">pc</span>&nbsp;<span class="op" id="1648219">=</span>&nbsp;<span class="ident" id="1648221">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648225">cas</span><span class="op" id="1648228">.</span><span class="ident" id="1648229">_chan</span>&nbsp;<span class="op" id="1648235">=</span>&nbsp;<span class="ident" id="1648237">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648240">cas</span><span class="op" id="1648243">.</span><span class="ident" id="1648244">so</span>&nbsp;<span class="op" id="1648247">=</span>&nbsp;<span class="builtintype" id="1648249">uint16</span><span class="op" id="1648255">(</span><span class="ident" id="1648256">so</span><span class="op" id="1648258">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648261">cas</span><span class="op" id="1648264">.</span><span class="ident" id="1648265">kind</span>&nbsp;<span class="op" id="1648270">=</span>&nbsp;<span class="ident" id="1648272">_CaseRecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648283">cas</span><span class="op" id="1648286">.</span><span class="ident" id="1648287">elem</span>&nbsp;<span class="op" id="1648292">=</span>&nbsp;<span class="ident" id="1648294">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648300">cas</span><span class="op" id="1648303">.</span><span class="ident" id="1648304">receivedp</span>&nbsp;<span class="op" id="1648314">=</span>&nbsp;<span class="ident" id="1648316">received</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1648327">if</span>&nbsp;<span class="ident" id="1648330">debugSelect</span>&nbsp;<span class="op" id="1648342">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1648346">print</span><span class="op" id="1648351">(</span><span class="string" id="1648352">&#34;selectrecv&nbsp;s=&#34;</span><span class="op" id="1648367">,</span>&nbsp;<span class="ident" id="1648369">sel</span><span class="op" id="1648372">,</span>&nbsp;<span class="string" id="1648374">&#34;&nbsp;pc=&#34;</span><span class="op" id="1648380">,</span>&nbsp;<span class="ident" id="1648382">hex</span><span class="op" id="1648385">(</span><span class="ident" id="1648386">cas</span><span class="op" id="1648389">.</span><span class="ident" id="1648390">pc</span><span class="op" id="1648392">)</span><span class="op" id="1648393">,</span>&nbsp;<span class="string" id="1648395">&#34;&nbsp;chan=&#34;</span><span class="op" id="1648403">,</span>&nbsp;<span class="ident" id="1648405">cas</span><span class="op" id="1648408">.</span><span class="ident" id="1648409">_chan</span><span class="op" id="1648414">,</span>&nbsp;<span class="string" id="1648416">&#34;&nbsp;so=&#34;</span><span class="op" id="1648422">,</span>&nbsp;<span class="ident" id="1648424">cas</span><span class="op" id="1648427">.</span><span class="ident" id="1648428">so</span><span class="op" id="1648430">,</span>&nbsp;<span class="string" id="1648432">&#34;\n&#34;</span><span class="op" id="1648436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1648439">}</span><br>
<span class="lineno"></span><span class="op" id="1648441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1648444">//go:nosplit</span><br>
<span class="lineno">110</span><span class="keyword" id="1648457">func</span>&nbsp;<span class="ident" id="1648462">selectdefault</span><span class="op" id="1648475">(</span><span class="ident" id="1648476">sel</span>&nbsp;<span class="op" id="1648480">*</span><span class="ident" id="1648481">_select</span><span class="op" id="1648488">)</span>&nbsp;<span class="op" id="1648490">(</span><span class="ident" id="1648491">selected</span>&nbsp;<span class="builtintype" id="1648500">bool</span><span class="op" id="1648504">)</span>&nbsp;<span class="op" id="1648506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648509">selectdefaultImpl</span><span class="op" id="1648526">(</span><span class="ident" id="1648527">sel</span><span class="op" id="1648530">,</span>&nbsp;<span class="ident" id="1648532">getcallerpc</span><span class="op" id="1648543">(</span><span class="ident" id="1648544">unsafe</span><span class="op" id="1648550">.</span><span class="ident" id="1648551">Pointer</span><span class="op" id="1648558">(</span><span class="op" id="1648559">&amp;</span><span class="ident" id="1648560">sel</span><span class="op" id="1648563">)</span><span class="op" id="1648564">)</span><span class="op" id="1648565">,</span>&nbsp;<span class="builtintype" id="1648567">uintptr</span><span class="op" id="1648574">(</span><span class="ident" id="1648575">unsafe</span><span class="op" id="1648581">.</span><span class="ident" id="1648582">Pointer</span><span class="op" id="1648589">(</span><span class="op" id="1648590">&amp;</span><span class="ident" id="1648591">selected</span><span class="op" id="1648599">)</span><span class="op" id="1648600">)</span><span class="op" id="1648601">-</span><span class="builtintype" id="1648602">uintptr</span><span class="op" id="1648609">(</span><span class="ident" id="1648610">unsafe</span><span class="op" id="1648616">.</span><span class="ident" id="1648617">Pointer</span><span class="op" id="1648624">(</span><span class="op" id="1648625">&amp;</span><span class="ident" id="1648626">sel</span><span class="op" id="1648629">)</span><span class="op" id="1648630">)</span><span class="op" id="1648631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1648634">return</span><br>
<span class="lineno"></span><span class="op" id="1648641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="1648644">func</span>&nbsp;<span class="ident" id="1648649">selectdefaultImpl</span><span class="op" id="1648666">(</span><span class="ident" id="1648667">sel</span>&nbsp;<span class="op" id="1648671">*</span><span class="ident" id="1648672">_select</span><span class="op" id="1648679">,</span>&nbsp;<span class="ident" id="1648681">callerpc</span>&nbsp;<span class="builtintype" id="1648690">uintptr</span><span class="op" id="1648697">,</span>&nbsp;<span class="ident" id="1648699">so</span>&nbsp;<span class="builtintype" id="1648702">uintptr</span><span class="op" id="1648709">)</span>&nbsp;<span class="op" id="1648711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648714">i</span>&nbsp;<span class="op" id="1648716">:=</span>&nbsp;<span class="ident" id="1648719">sel</span><span class="op" id="1648722">.</span><span class="ident" id="1648723">ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1648730">if</span>&nbsp;<span class="ident" id="1648733">i</span>&nbsp;<span class="op" id="1648735">&gt;=</span>&nbsp;<span class="ident" id="1648738">sel</span><span class="op" id="1648741">.</span><span class="ident" id="1648742">tcase</span>&nbsp;<span class="op" id="1648748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648752">gothrow</span><span class="op" id="1648759">(</span><span class="string" id="1648760">&#34;selectdefault:&nbsp;too&nbsp;many&nbsp;cases&#34;</span><span class="op" id="1648791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1648794">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648797">sel</span><span class="op" id="1648800">.</span><span class="ident" id="1648801">ncase</span>&nbsp;<span class="op" id="1648807">=</span>&nbsp;<span class="ident" id="1648809">i</span>&nbsp;<span class="op" id="1648811">+</span>&nbsp;<span class="num" id="1648813">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648816">cas</span>&nbsp;<span class="op" id="1648820">:=</span>&nbsp;<span class="op" id="1648823">(</span><span class="op" id="1648824">*</span><span class="ident" id="1648825">scase</span><span class="op" id="1648830">)</span><span class="op" id="1648831">(</span><span class="ident" id="1648832">add</span><span class="op" id="1648835">(</span><span class="ident" id="1648836">unsafe</span><span class="op" id="1648842">.</span><span class="ident" id="1648843">Pointer</span><span class="op" id="1648850">(</span><span class="op" id="1648851">&amp;</span><span class="ident" id="1648852">sel</span><span class="op" id="1648855">.</span><span class="ident" id="1648856">scase</span><span class="op" id="1648861">)</span><span class="op" id="1648862">,</span>&nbsp;<span class="builtintype" id="1648864">uintptr</span><span class="op" id="1648871">(</span><span class="ident" id="1648872">i</span><span class="op" id="1648873">)</span><span class="op" id="1648874">*</span><span class="ident" id="1648875">unsafe</span><span class="op" id="1648881">.</span><span class="ident" id="1648882">Sizeof</span><span class="op" id="1648888">(</span><span class="ident" id="1648889">sel</span><span class="op" id="1648892">.</span><span class="ident" id="1648893">scase</span><span class="op" id="1648898">[</span><span class="num" id="1648899">0</span><span class="op" id="1648900">]</span><span class="op" id="1648901">)</span><span class="op" id="1648902">)</span><span class="op" id="1648903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648906">cas</span><span class="op" id="1648909">.</span><span class="ident" id="1648910">pc</span>&nbsp;<span class="op" id="1648913">=</span>&nbsp;<span class="ident" id="1648915">callerpc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648925">cas</span><span class="op" id="1648928">.</span><span class="ident" id="1648929">_chan</span>&nbsp;<span class="op" id="1648935">=</span>&nbsp;<span class="builtintype" id="1648937">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648942">cas</span><span class="op" id="1648945">.</span><span class="ident" id="1648946">so</span>&nbsp;<span class="op" id="1648949">=</span>&nbsp;<span class="builtintype" id="1648951">uint16</span><span class="op" id="1648957">(</span><span class="ident" id="1648958">so</span><span class="op" id="1648960">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1648963">cas</span><span class="op" id="1648966">.</span><span class="ident" id="1648967">kind</span>&nbsp;<span class="op" id="1648972">=</span>&nbsp;<span class="ident" id="1648974">_CaseDefault</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1648989">if</span>&nbsp;<span class="ident" id="1648992">debugSelect</span>&nbsp;<span class="op" id="1649004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1649008">print</span><span class="op" id="1649013">(</span><span class="string" id="1649014">&#34;selectdefault&nbsp;s=&#34;</span><span class="op" id="1649032">,</span>&nbsp;<span class="ident" id="1649034">sel</span><span class="op" id="1649037">,</span>&nbsp;<span class="string" id="1649039">&#34;&nbsp;pc=&#34;</span><span class="op" id="1649045">,</span>&nbsp;<span class="ident" id="1649047">hex</span><span class="op" id="1649050">(</span><span class="ident" id="1649051">cas</span><span class="op" id="1649054">.</span><span class="ident" id="1649055">pc</span><span class="op" id="1649057">)</span><span class="op" id="1649058">,</span>&nbsp;<span class="string" id="1649060">&#34;&nbsp;so=&#34;</span><span class="op" id="1649066">,</span>&nbsp;<span class="ident" id="1649068">cas</span><span class="op" id="1649071">.</span><span class="ident" id="1649072">so</span><span class="op" id="1649074">,</span>&nbsp;<span class="string" id="1649076">&#34;\n&#34;</span><span class="op" id="1649080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1649083">}</span><br>
<span class="lineno">130</span><span class="op" id="1649085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1649088">func</span>&nbsp;<span class="ident" id="1649093">sellock</span><span class="op" id="1649100">(</span><span class="ident" id="1649101">sel</span>&nbsp;<span class="op" id="1649105">*</span><span class="ident" id="1649106">_select</span><span class="op" id="1649113">)</span>&nbsp;<span class="op" id="1649115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1649118">lockslice</span>&nbsp;<span class="op" id="1649128">:=</span>&nbsp;<span class="ident" id="1649131">sliceStruct</span><span class="op" id="1649142">{</span><span class="ident" id="1649143">unsafe</span><span class="op" id="1649149">.</span><span class="ident" id="1649150">Pointer</span><span class="op" id="1649157">(</span><span class="ident" id="1649158">sel</span><span class="op" id="1649161">.</span><span class="ident" id="1649162">lockorder</span><span class="op" id="1649171">)</span><span class="op" id="1649172">,</span>&nbsp;<span class="builtintype" id="1649174">int</span><span class="op" id="1649177">(</span><span class="ident" id="1649178">sel</span><span class="op" id="1649181">.</span><span class="ident" id="1649182">ncase</span><span class="op" id="1649187">)</span><span class="op" id="1649188">,</span>&nbsp;<span class="builtintype" id="1649190">int</span><span class="op" id="1649193">(</span><span class="ident" id="1649194">sel</span><span class="op" id="1649197">.</span><span class="ident" id="1649198">ncase</span><span class="op" id="1649203">)</span><span class="op" id="1649204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1649207">lockorder</span>&nbsp;<span class="op" id="1649217">:=</span>&nbsp;<span class="op" id="1649220">*</span><span class="op" id="1649221">(</span><span class="op" id="1649222">*</span><span class="op" id="1649223">[</span><span class="op" id="1649224">]</span><span class="op" id="1649225">*</span><span class="ident" id="1649226">hchan</span><span class="op" id="1649231">)</span><span class="op" id="1649232">(</span><span class="ident" id="1649233">unsafe</span><span class="op" id="1649239">.</span><span class="ident" id="1649240">Pointer</span><span class="op" id="1649247">(</span><span class="op" id="1649248">&amp;</span><span class="ident" id="1649249">lockslice</span><span class="op" id="1649258">)</span><span class="op" id="1649259">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1649262">var</span>&nbsp;<span class="ident" id="1649266">c</span>&nbsp;<span class="op" id="1649268">*</span><span class="ident" id="1649269">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1649276">for</span>&nbsp;<span class="ident" id="1649280">_</span><span class="op" id="1649281">,</span>&nbsp;<span class="ident" id="1649283">c0</span>&nbsp;<span class="op" id="1649286">:=</span>&nbsp;<span class="keyword" id="1649289">range</span>&nbsp;<span class="ident" id="1649295">lockorder</span>&nbsp;<span class="op" id="1649305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1649309">if</span>&nbsp;<span class="ident" id="1649312">c0</span>&nbsp;<span class="op" id="1649315">!=</span>&nbsp;<span class="builtintype" id="1649318">nil</span>&nbsp;<span class="op" id="1649322">&amp;&amp;</span>&nbsp;<span class="ident" id="1649325">c0</span>&nbsp;<span class="op" id="1649328">!=</span>&nbsp;<span class="ident" id="1649331">c</span>&nbsp;<span class="op" id="1649333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1649338">c</span>&nbsp;<span class="op" id="1649340">=</span>&nbsp;<span class="ident" id="1649342">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1649348">lock</span><span class="op" id="1649352">(</span><span class="op" id="1649353">&amp;</span><span class="ident" id="1649354">c</span><span class="op" id="1649355">.</span><span class="ident" id="1649356">lock</span><span class="op" id="1649360">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1649364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1649367">}</span><br>
<span class="lineno"></span><span class="op" id="1649369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1649372">func</span>&nbsp;<span class="ident" id="1649377">selunlock</span><span class="op" id="1649386">(</span><span class="ident" id="1649387">sel</span>&nbsp;<span class="op" id="1649391">*</span><span class="ident" id="1649392">_select</span><span class="op" id="1649399">)</span>&nbsp;<span class="op" id="1649401">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1649404">//&nbsp;We&nbsp;must&nbsp;be&nbsp;very&nbsp;careful&nbsp;here&nbsp;to&nbsp;not&nbsp;touch&nbsp;sel&nbsp;after&nbsp;we&nbsp;have&nbsp;unlocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1649477">//&nbsp;the&nbsp;last&nbsp;lock,&nbsp;because&nbsp;sel&nbsp;can&nbsp;be&nbsp;freed&nbsp;right&nbsp;after&nbsp;the&nbsp;last&nbsp;unlock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1649550">//&nbsp;Consider&nbsp;the&nbsp;following&nbsp;situation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1649588">//&nbsp;First&nbsp;M&nbsp;calls&nbsp;runtime·park()&nbsp;in&nbsp;runtime·selectgo()&nbsp;passing&nbsp;the&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1649662">//&nbsp;Once&nbsp;runtime·park()&nbsp;has&nbsp;unlocked&nbsp;the&nbsp;last&nbsp;lock,&nbsp;another&nbsp;M&nbsp;makes</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1649731">//&nbsp;the&nbsp;G&nbsp;that&nbsp;calls&nbsp;select&nbsp;runnable&nbsp;again&nbsp;and&nbsp;schedules&nbsp;it&nbsp;for&nbsp;execution.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1649806">//&nbsp;When&nbsp;the&nbsp;G&nbsp;runs&nbsp;on&nbsp;another&nbsp;M,&nbsp;it&nbsp;locks&nbsp;all&nbsp;the&nbsp;locks&nbsp;and&nbsp;frees&nbsp;sel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1649878">//&nbsp;Now&nbsp;if&nbsp;the&nbsp;first&nbsp;M&nbsp;touches&nbsp;sel,&nbsp;it&nbsp;will&nbsp;access&nbsp;freed&nbsp;memory.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1649943">n</span>&nbsp;<span class="op" id="1649945">:=</span>&nbsp;<span class="builtintype" id="1649948">int</span><span class="op" id="1649951">(</span><span class="ident" id="1649952">sel</span><span class="op" id="1649955">.</span><span class="ident" id="1649956">ncase</span><span class="op" id="1649961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1649964">r</span>&nbsp;<span class="op" id="1649966">:=</span>&nbsp;<span class="num" id="1649969">0</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1649972">lockslice</span>&nbsp;<span class="op" id="1649982">:=</span>&nbsp;<span class="ident" id="1649985">sliceStruct</span><span class="op" id="1649996">{</span><span class="ident" id="1649997">unsafe</span><span class="op" id="1650003">.</span><span class="ident" id="1650004">Pointer</span><span class="op" id="1650011">(</span><span class="ident" id="1650012">sel</span><span class="op" id="1650015">.</span><span class="ident" id="1650016">lockorder</span><span class="op" id="1650025">)</span><span class="op" id="1650026">,</span>&nbsp;<span class="ident" id="1650028">n</span><span class="op" id="1650029">,</span>&nbsp;<span class="ident" id="1650031">n</span><span class="op" id="1650032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650035">lockorder</span>&nbsp;<span class="op" id="1650045">:=</span>&nbsp;<span class="op" id="1650048">*</span><span class="op" id="1650049">(</span><span class="op" id="1650050">*</span><span class="op" id="1650051">[</span><span class="op" id="1650052">]</span><span class="op" id="1650053">*</span><span class="ident" id="1650054">hchan</span><span class="op" id="1650059">)</span><span class="op" id="1650060">(</span><span class="ident" id="1650061">unsafe</span><span class="op" id="1650067">.</span><span class="ident" id="1650068">Pointer</span><span class="op" id="1650075">(</span><span class="op" id="1650076">&amp;</span><span class="ident" id="1650077">lockslice</span><span class="op" id="1650086">)</span><span class="op" id="1650087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1650090">//&nbsp;skip&nbsp;the&nbsp;default&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1650116">if</span>&nbsp;<span class="ident" id="1650119">n</span>&nbsp;<span class="op" id="1650121">&gt;</span>&nbsp;<span class="num" id="1650123">0</span>&nbsp;<span class="op" id="1650125">&amp;&amp;</span>&nbsp;<span class="ident" id="1650128">lockorder</span><span class="op" id="1650137">[</span><span class="num" id="1650138">0</span><span class="op" id="1650139">]</span>&nbsp;<span class="op" id="1650141">==</span>&nbsp;<span class="builtintype" id="1650144">nil</span>&nbsp;<span class="op" id="1650148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650152">r</span>&nbsp;<span class="op" id="1650154">=</span>&nbsp;<span class="num" id="1650156">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1650159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1650162">for</span>&nbsp;<span class="ident" id="1650166">i</span>&nbsp;<span class="op" id="1650168">:=</span>&nbsp;<span class="ident" id="1650171">n</span>&nbsp;<span class="op" id="1650173">-</span>&nbsp;<span class="num" id="1650175">1</span><span class="op" id="1650176">;</span>&nbsp;<span class="ident" id="1650178">i</span>&nbsp;<span class="op" id="1650180">&gt;=</span>&nbsp;<span class="ident" id="1650183">r</span><span class="op" id="1650184">;</span>&nbsp;<span class="ident" id="1650186">i</span><span class="op" id="1650187">--</span>&nbsp;<span class="op" id="1650190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650194">c</span>&nbsp;<span class="op" id="1650196">:=</span>&nbsp;<span class="ident" id="1650199">lockorder</span><span class="op" id="1650208">[</span><span class="ident" id="1650209">i</span><span class="op" id="1650210">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1650214">if</span>&nbsp;<span class="ident" id="1650217">i</span>&nbsp;<span class="op" id="1650219">&gt;</span>&nbsp;<span class="num" id="1650221">0</span>&nbsp;<span class="op" id="1650223">&amp;&amp;</span>&nbsp;<span class="ident" id="1650226">c</span>&nbsp;<span class="op" id="1650228">==</span>&nbsp;<span class="ident" id="1650231">lockorder</span><span class="op" id="1650240">[</span><span class="ident" id="1650241">i</span><span class="op" id="1650242">-</span><span class="num" id="1650243">1</span><span class="op" id="1650244">]</span>&nbsp;<span class="op" id="1650246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1650251">continue</span>&nbsp;<span class="comment" id="1650260">//&nbsp;will&nbsp;unlock&nbsp;it&nbsp;on&nbsp;the&nbsp;next&nbsp;iteration</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1650302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650306">unlock</span><span class="op" id="1650312">(</span><span class="op" id="1650313">&amp;</span><span class="ident" id="1650314">c</span><span class="op" id="1650315">.</span><span class="ident" id="1650316">lock</span><span class="op" id="1650320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1650323">}</span><br>
<span class="lineno"></span><span class="op" id="1650325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="keyword" id="1650328">func</span>&nbsp;<span class="ident" id="1650333">selparkcommit</span><span class="op" id="1650346">(</span><span class="ident" id="1650347">gp</span>&nbsp;<span class="op" id="1650350">*</span><span class="ident" id="1650351">g</span><span class="op" id="1650352">,</span>&nbsp;<span class="ident" id="1650354">sel</span>&nbsp;<span class="op" id="1650358">*</span><span class="ident" id="1650359">_select</span><span class="op" id="1650366">)</span>&nbsp;<span class="builtintype" id="1650368">bool</span>&nbsp;<span class="op" id="1650373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650376">selunlock</span><span class="op" id="1650385">(</span><span class="ident" id="1650386">sel</span><span class="op" id="1650389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1650392">return</span>&nbsp;<span class="builtintype" id="1650399">true</span><br>
<span class="lineno"></span><span class="op" id="1650404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="keyword" id="1650407">func</span>&nbsp;<span class="ident" id="1650412">block</span><span class="op" id="1650417">(</span><span class="op" id="1650418">)</span>&nbsp;<span class="op" id="1650420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650423">gopark</span><span class="op" id="1650429">(</span><span class="builtintype" id="1650430">nil</span><span class="op" id="1650433">,</span>&nbsp;<span class="builtintype" id="1650435">nil</span><span class="op" id="1650438">,</span>&nbsp;<span class="string" id="1650440">&#34;select&nbsp;(no&nbsp;cases)&#34;</span><span class="op" id="1650459">)</span>&nbsp;<span class="comment" id="1650461">//&nbsp;forever</span><br>
<span class="lineno"></span><span class="op" id="1650472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1650475">//&nbsp;overwrites&nbsp;return&nbsp;pc&nbsp;on&nbsp;stack&nbsp;to&nbsp;signal&nbsp;which&nbsp;case&nbsp;of&nbsp;the&nbsp;select</span><br>
<span class="lineno">180</span><span class="comment" id="1650543">//&nbsp;to&nbsp;run,&nbsp;so&nbsp;cannot&nbsp;appear&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;a&nbsp;split&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="1650600">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1650613">func</span>&nbsp;<span class="ident" id="1650618">selectgo</span><span class="op" id="1650626">(</span><span class="ident" id="1650627">sel</span>&nbsp;<span class="op" id="1650631">*</span><span class="ident" id="1650632">_select</span><span class="op" id="1650639">)</span>&nbsp;<span class="op" id="1650641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650644">pc</span><span class="op" id="1650646">,</span>&nbsp;<span class="ident" id="1650648">offset</span>&nbsp;<span class="op" id="1650655">:=</span>&nbsp;<span class="ident" id="1650658">selectgoImpl</span><span class="op" id="1650670">(</span><span class="ident" id="1650671">sel</span><span class="op" id="1650674">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1650677">*</span><span class="op" id="1650678">(</span><span class="op" id="1650679">*</span><span class="builtintype" id="1650680">bool</span><span class="op" id="1650684">)</span><span class="op" id="1650685">(</span><span class="ident" id="1650686">add</span><span class="op" id="1650689">(</span><span class="ident" id="1650690">unsafe</span><span class="op" id="1650696">.</span><span class="ident" id="1650697">Pointer</span><span class="op" id="1650704">(</span><span class="op" id="1650705">&amp;</span><span class="ident" id="1650706">sel</span><span class="op" id="1650709">)</span><span class="op" id="1650710">,</span>&nbsp;<span class="builtintype" id="1650712">uintptr</span><span class="op" id="1650719">(</span><span class="ident" id="1650720">offset</span><span class="op" id="1650726">)</span><span class="op" id="1650727">)</span><span class="op" id="1650728">)</span>&nbsp;<span class="op" id="1650730">=</span>&nbsp;<span class="builtintype" id="1650732">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650738">setcallerpc</span><span class="op" id="1650749">(</span><span class="ident" id="1650750">unsafe</span><span class="op" id="1650756">.</span><span class="ident" id="1650757">Pointer</span><span class="op" id="1650764">(</span><span class="op" id="1650765">&amp;</span><span class="ident" id="1650766">sel</span><span class="op" id="1650769">)</span><span class="op" id="1650770">,</span>&nbsp;<span class="ident" id="1650772">pc</span><span class="op" id="1650774">)</span><br>
<span class="lineno"></span><span class="op" id="1650776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1650779">//&nbsp;selectgoImpl&nbsp;returns&nbsp;scase.pc&nbsp;and&nbsp;scase.so&nbsp;for&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span><span class="comment" id="1650840">//&nbsp;case&nbsp;which&nbsp;fired.</span><br>
<span class="lineno">190</span><span class="keyword" id="1650861">func</span>&nbsp;<span class="ident" id="1650866">selectgoImpl</span><span class="op" id="1650878">(</span><span class="ident" id="1650879">sel</span>&nbsp;<span class="op" id="1650883">*</span><span class="ident" id="1650884">_select</span><span class="op" id="1650891">)</span>&nbsp;<span class="op" id="1650893">(</span><span class="builtintype" id="1650894">uintptr</span><span class="op" id="1650901">,</span>&nbsp;<span class="builtintype" id="1650903">uint16</span><span class="op" id="1650909">)</span>&nbsp;<span class="op" id="1650911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1650914">if</span>&nbsp;<span class="ident" id="1650917">debugSelect</span>&nbsp;<span class="op" id="1650929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1650933">print</span><span class="op" id="1650938">(</span><span class="string" id="1650939">&#34;select:&nbsp;sel=&#34;</span><span class="op" id="1650953">,</span>&nbsp;<span class="ident" id="1650955">sel</span><span class="op" id="1650958">,</span>&nbsp;<span class="string" id="1650960">&#34;\n&#34;</span><span class="op" id="1650964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1650967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1650971">scaseslice</span>&nbsp;<span class="op" id="1650982">:=</span>&nbsp;<span class="ident" id="1650985">sliceStruct</span><span class="op" id="1650996">{</span><span class="ident" id="1650997">unsafe</span><span class="op" id="1651003">.</span><span class="ident" id="1651004">Pointer</span><span class="op" id="1651011">(</span><span class="op" id="1651012">&amp;</span><span class="ident" id="1651013">sel</span><span class="op" id="1651016">.</span><span class="ident" id="1651017">scase</span><span class="op" id="1651022">)</span><span class="op" id="1651023">,</span>&nbsp;<span class="builtintype" id="1651025">int</span><span class="op" id="1651028">(</span><span class="ident" id="1651029">sel</span><span class="op" id="1651032">.</span><span class="ident" id="1651033">ncase</span><span class="op" id="1651038">)</span><span class="op" id="1651039">,</span>&nbsp;<span class="builtintype" id="1651041">int</span><span class="op" id="1651044">(</span><span class="ident" id="1651045">sel</span><span class="op" id="1651048">.</span><span class="ident" id="1651049">ncase</span><span class="op" id="1651054">)</span><span class="op" id="1651055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651058">scases</span>&nbsp;<span class="op" id="1651065">:=</span>&nbsp;<span class="op" id="1651068">*</span><span class="op" id="1651069">(</span><span class="op" id="1651070">*</span><span class="op" id="1651071">[</span><span class="op" id="1651072">]</span><span class="ident" id="1651073">scase</span><span class="op" id="1651078">)</span><span class="op" id="1651079">(</span><span class="ident" id="1651080">unsafe</span><span class="op" id="1651086">.</span><span class="ident" id="1651087">Pointer</span><span class="op" id="1651094">(</span><span class="op" id="1651095">&amp;</span><span class="ident" id="1651096">scaseslice</span><span class="op" id="1651106">)</span><span class="op" id="1651107">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1651111">var</span>&nbsp;<span class="ident" id="1651115">t0</span>&nbsp;<span class="ident" id="1651118">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1651125">if</span>&nbsp;<span class="ident" id="1651128">blockprofilerate</span>&nbsp;<span class="op" id="1651145">&gt;</span>&nbsp;<span class="num" id="1651147">0</span>&nbsp;<span class="op" id="1651149">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651153">t0</span>&nbsp;<span class="op" id="1651156">=</span>&nbsp;<span class="ident" id="1651158">cputicks</span><span class="op" id="1651166">(</span><span class="op" id="1651167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1651171">for</span>&nbsp;<span class="ident" id="1651175">i</span>&nbsp;<span class="op" id="1651177">:=</span>&nbsp;<span class="num" id="1651180">0</span><span class="op" id="1651181">;</span>&nbsp;<span class="ident" id="1651183">i</span>&nbsp;<span class="op" id="1651185">&lt;</span>&nbsp;<span class="builtintype" id="1651187">int</span><span class="op" id="1651190">(</span><span class="ident" id="1651191">sel</span><span class="op" id="1651194">.</span><span class="ident" id="1651195">ncase</span><span class="op" id="1651200">)</span><span class="op" id="1651201">;</span>&nbsp;<span class="ident" id="1651203">i</span><span class="op" id="1651204">++</span>&nbsp;<span class="op" id="1651207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651212">scases</span><span class="op" id="1651218">[</span><span class="ident" id="1651219">i</span><span class="op" id="1651220">]</span><span class="op" id="1651221">.</span><span class="ident" id="1651222">releasetime</span>&nbsp;<span class="op" id="1651234">=</span>&nbsp;<span class="op" id="1651236">-</span><span class="num" id="1651237">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1651241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1651244">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1651248">//&nbsp;The&nbsp;compiler&nbsp;rewrites&nbsp;selects&nbsp;that&nbsp;statically&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1651303">//&nbsp;only&nbsp;0&nbsp;or&nbsp;1&nbsp;cases&nbsp;plus&nbsp;default&nbsp;into&nbsp;simpler&nbsp;constructs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1651363">//&nbsp;The&nbsp;only&nbsp;way&nbsp;we&nbsp;can&nbsp;end&nbsp;up&nbsp;with&nbsp;such&nbsp;small&nbsp;sel.ncase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1651420">//&nbsp;values&nbsp;here&nbsp;is&nbsp;for&nbsp;a&nbsp;larger&nbsp;select&nbsp;in&nbsp;which&nbsp;most&nbsp;channels</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1651482">//&nbsp;have&nbsp;been&nbsp;nilled&nbsp;out.&nbsp;&nbsp;The&nbsp;general&nbsp;code&nbsp;handles&nbsp;those</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1651540">//&nbsp;cases&nbsp;correctly,&nbsp;and&nbsp;they&nbsp;are&nbsp;rare&nbsp;enough&nbsp;not&nbsp;to&nbsp;bother</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1651600">//&nbsp;optimizing&nbsp;(and&nbsp;needing&nbsp;to&nbsp;test).</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1651639">//&nbsp;generate&nbsp;permuted&nbsp;order</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651667">pollslice</span>&nbsp;<span class="op" id="1651677">:=</span>&nbsp;<span class="ident" id="1651680">sliceStruct</span><span class="op" id="1651691">{</span><span class="ident" id="1651692">unsafe</span><span class="op" id="1651698">.</span><span class="ident" id="1651699">Pointer</span><span class="op" id="1651706">(</span><span class="ident" id="1651707">sel</span><span class="op" id="1651710">.</span><span class="ident" id="1651711">pollorder</span><span class="op" id="1651720">)</span><span class="op" id="1651721">,</span>&nbsp;<span class="builtintype" id="1651723">int</span><span class="op" id="1651726">(</span><span class="ident" id="1651727">sel</span><span class="op" id="1651730">.</span><span class="ident" id="1651731">ncase</span><span class="op" id="1651736">)</span><span class="op" id="1651737">,</span>&nbsp;<span class="builtintype" id="1651739">int</span><span class="op" id="1651742">(</span><span class="ident" id="1651743">sel</span><span class="op" id="1651746">.</span><span class="ident" id="1651747">ncase</span><span class="op" id="1651752">)</span><span class="op" id="1651753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651756">pollorder</span>&nbsp;<span class="op" id="1651766">:=</span>&nbsp;<span class="op" id="1651769">*</span><span class="op" id="1651770">(</span><span class="op" id="1651771">*</span><span class="op" id="1651772">[</span><span class="op" id="1651773">]</span><span class="builtintype" id="1651774">uint16</span><span class="op" id="1651780">)</span><span class="op" id="1651781">(</span><span class="ident" id="1651782">unsafe</span><span class="op" id="1651788">.</span><span class="ident" id="1651789">Pointer</span><span class="op" id="1651796">(</span><span class="op" id="1651797">&amp;</span><span class="ident" id="1651798">pollslice</span><span class="op" id="1651807">)</span><span class="op" id="1651808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1651811">for</span>&nbsp;<span class="ident" id="1651815">i</span>&nbsp;<span class="op" id="1651817">:=</span>&nbsp;<span class="num" id="1651820">0</span><span class="op" id="1651821">;</span>&nbsp;<span class="ident" id="1651823">i</span>&nbsp;<span class="op" id="1651825">&lt;</span>&nbsp;<span class="builtintype" id="1651827">int</span><span class="op" id="1651830">(</span><span class="ident" id="1651831">sel</span><span class="op" id="1651834">.</span><span class="ident" id="1651835">ncase</span><span class="op" id="1651840">)</span><span class="op" id="1651841">;</span>&nbsp;<span class="ident" id="1651843">i</span><span class="op" id="1651844">++</span>&nbsp;<span class="op" id="1651847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651851">pollorder</span><span class="op" id="1651860">[</span><span class="ident" id="1651861">i</span><span class="op" id="1651862">]</span>&nbsp;<span class="op" id="1651864">=</span>&nbsp;<span class="builtintype" id="1651866">uint16</span><span class="op" id="1651872">(</span><span class="ident" id="1651873">i</span><span class="op" id="1651874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1651877">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1651880">for</span>&nbsp;<span class="ident" id="1651884">i</span>&nbsp;<span class="op" id="1651886">:=</span>&nbsp;<span class="num" id="1651889">1</span><span class="op" id="1651890">;</span>&nbsp;<span class="ident" id="1651892">i</span>&nbsp;<span class="op" id="1651894">&lt;</span>&nbsp;<span class="builtintype" id="1651896">int</span><span class="op" id="1651899">(</span><span class="ident" id="1651900">sel</span><span class="op" id="1651903">.</span><span class="ident" id="1651904">ncase</span><span class="op" id="1651909">)</span><span class="op" id="1651910">;</span>&nbsp;<span class="ident" id="1651912">i</span><span class="op" id="1651913">++</span>&nbsp;<span class="op" id="1651916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651920">o</span>&nbsp;<span class="op" id="1651922">:=</span>&nbsp;<span class="ident" id="1651925">pollorder</span><span class="op" id="1651934">[</span><span class="ident" id="1651935">i</span><span class="op" id="1651936">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651940">j</span>&nbsp;<span class="op" id="1651942">:=</span>&nbsp;<span class="builtintype" id="1651945">int</span><span class="op" id="1651948">(</span><span class="ident" id="1651949">fastrand1</span><span class="op" id="1651958">(</span><span class="op" id="1651959">)</span><span class="op" id="1651960">)</span>&nbsp;<span class="op" id="1651962">%</span>&nbsp;<span class="op" id="1651964">(</span><span class="ident" id="1651965">i</span>&nbsp;<span class="op" id="1651967">+</span>&nbsp;<span class="num" id="1651969">1</span><span class="op" id="1651970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1651974">pollorder</span><span class="op" id="1651983">[</span><span class="ident" id="1651984">i</span><span class="op" id="1651985">]</span>&nbsp;<span class="op" id="1651987">=</span>&nbsp;<span class="ident" id="1651989">pollorder</span><span class="op" id="1651998">[</span><span class="ident" id="1651999">j</span><span class="op" id="1652000">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652004">pollorder</span><span class="op" id="1652013">[</span><span class="ident" id="1652014">j</span><span class="op" id="1652015">]</span>&nbsp;<span class="op" id="1652017">=</span>&nbsp;<span class="ident" id="1652019">o</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1652022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1652026">//&nbsp;sort&nbsp;the&nbsp;cases&nbsp;by&nbsp;Hchan&nbsp;address&nbsp;to&nbsp;get&nbsp;the&nbsp;locking&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1652088">//&nbsp;simple&nbsp;heap&nbsp;sort,&nbsp;to&nbsp;guarantee&nbsp;n&nbsp;log&nbsp;n&nbsp;time&nbsp;and&nbsp;constant&nbsp;stack&nbsp;footprint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652166">lockslice</span>&nbsp;<span class="op" id="1652176">:=</span>&nbsp;<span class="ident" id="1652179">sliceStruct</span><span class="op" id="1652190">{</span><span class="ident" id="1652191">unsafe</span><span class="op" id="1652197">.</span><span class="ident" id="1652198">Pointer</span><span class="op" id="1652205">(</span><span class="ident" id="1652206">sel</span><span class="op" id="1652209">.</span><span class="ident" id="1652210">lockorder</span><span class="op" id="1652219">)</span><span class="op" id="1652220">,</span>&nbsp;<span class="builtintype" id="1652222">int</span><span class="op" id="1652225">(</span><span class="ident" id="1652226">sel</span><span class="op" id="1652229">.</span><span class="ident" id="1652230">ncase</span><span class="op" id="1652235">)</span><span class="op" id="1652236">,</span>&nbsp;<span class="builtintype" id="1652238">int</span><span class="op" id="1652241">(</span><span class="ident" id="1652242">sel</span><span class="op" id="1652245">.</span><span class="ident" id="1652246">ncase</span><span class="op" id="1652251">)</span><span class="op" id="1652252">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652255">lockorder</span>&nbsp;<span class="op" id="1652265">:=</span>&nbsp;<span class="op" id="1652268">*</span><span class="op" id="1652269">(</span><span class="op" id="1652270">*</span><span class="op" id="1652271">[</span><span class="op" id="1652272">]</span><span class="op" id="1652273">*</span><span class="ident" id="1652274">hchan</span><span class="op" id="1652279">)</span><span class="op" id="1652280">(</span><span class="ident" id="1652281">unsafe</span><span class="op" id="1652287">.</span><span class="ident" id="1652288">Pointer</span><span class="op" id="1652295">(</span><span class="op" id="1652296">&amp;</span><span class="ident" id="1652297">lockslice</span><span class="op" id="1652306">)</span><span class="op" id="1652307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652310">for</span>&nbsp;<span class="ident" id="1652314">i</span>&nbsp;<span class="op" id="1652316">:=</span>&nbsp;<span class="num" id="1652319">0</span><span class="op" id="1652320">;</span>&nbsp;<span class="ident" id="1652322">i</span>&nbsp;<span class="op" id="1652324">&lt;</span>&nbsp;<span class="builtintype" id="1652326">int</span><span class="op" id="1652329">(</span><span class="ident" id="1652330">sel</span><span class="op" id="1652333">.</span><span class="ident" id="1652334">ncase</span><span class="op" id="1652339">)</span><span class="op" id="1652340">;</span>&nbsp;<span class="ident" id="1652342">i</span><span class="op" id="1652343">++</span>&nbsp;<span class="op" id="1652346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652350">j</span>&nbsp;<span class="op" id="1652352">:=</span>&nbsp;<span class="ident" id="1652355">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652359">c</span>&nbsp;<span class="op" id="1652361">:=</span>&nbsp;<span class="ident" id="1652364">scases</span><span class="op" id="1652370">[</span><span class="ident" id="1652371">j</span><span class="op" id="1652372">]</span><span class="op" id="1652373">.</span><span class="ident" id="1652374">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652382">for</span>&nbsp;<span class="ident" id="1652386">j</span>&nbsp;<span class="op" id="1652388">&gt;</span>&nbsp;<span class="num" id="1652390">0</span>&nbsp;<span class="op" id="1652392">&amp;&amp;</span>&nbsp;<span class="ident" id="1652395">lockorder</span><span class="op" id="1652404">[</span><span class="op" id="1652405">(</span><span class="ident" id="1652406">j</span><span class="op" id="1652407">-</span><span class="num" id="1652408">1</span><span class="op" id="1652409">)</span><span class="op" id="1652410">/</span><span class="num" id="1652411">2</span><span class="op" id="1652412">]</span><span class="op" id="1652413">.</span><span class="ident" id="1652414">sortkey</span><span class="op" id="1652421">(</span><span class="op" id="1652422">)</span>&nbsp;<span class="op" id="1652424">&lt;</span>&nbsp;<span class="ident" id="1652426">c</span><span class="op" id="1652427">.</span><span class="ident" id="1652428">sortkey</span><span class="op" id="1652435">(</span><span class="op" id="1652436">)</span>&nbsp;<span class="op" id="1652438">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652443">k</span>&nbsp;<span class="op" id="1652445">:=</span>&nbsp;<span class="op" id="1652448">(</span><span class="ident" id="1652449">j</span>&nbsp;<span class="op" id="1652451">-</span>&nbsp;<span class="num" id="1652453">1</span><span class="op" id="1652454">)</span>&nbsp;<span class="op" id="1652456">/</span>&nbsp;<span class="num" id="1652458">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652463">lockorder</span><span class="op" id="1652472">[</span><span class="ident" id="1652473">j</span><span class="op" id="1652474">]</span>&nbsp;<span class="op" id="1652476">=</span>&nbsp;<span class="ident" id="1652478">lockorder</span><span class="op" id="1652487">[</span><span class="ident" id="1652488">k</span><span class="op" id="1652489">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652494">j</span>&nbsp;<span class="op" id="1652496">=</span>&nbsp;<span class="ident" id="1652498">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1652502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652506">lockorder</span><span class="op" id="1652515">[</span><span class="ident" id="1652516">j</span><span class="op" id="1652517">]</span>&nbsp;<span class="op" id="1652519">=</span>&nbsp;<span class="ident" id="1652521">c</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1652524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652527">for</span>&nbsp;<span class="ident" id="1652531">i</span>&nbsp;<span class="op" id="1652533">:=</span>&nbsp;<span class="builtintype" id="1652536">int</span><span class="op" id="1652539">(</span><span class="ident" id="1652540">sel</span><span class="op" id="1652543">.</span><span class="ident" id="1652544">ncase</span><span class="op" id="1652549">)</span>&nbsp;<span class="op" id="1652551">-</span>&nbsp;<span class="num" id="1652553">1</span><span class="op" id="1652554">;</span>&nbsp;<span class="ident" id="1652556">i</span>&nbsp;<span class="op" id="1652558">&gt;=</span>&nbsp;<span class="num" id="1652561">0</span><span class="op" id="1652562">;</span>&nbsp;<span class="ident" id="1652564">i</span><span class="op" id="1652565">--</span>&nbsp;<span class="op" id="1652568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652572">c</span>&nbsp;<span class="op" id="1652574">:=</span>&nbsp;<span class="ident" id="1652577">lockorder</span><span class="op" id="1652586">[</span><span class="ident" id="1652587">i</span><span class="op" id="1652588">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652592">lockorder</span><span class="op" id="1652601">[</span><span class="ident" id="1652602">i</span><span class="op" id="1652603">]</span>&nbsp;<span class="op" id="1652605">=</span>&nbsp;<span class="ident" id="1652607">lockorder</span><span class="op" id="1652616">[</span><span class="num" id="1652617">0</span><span class="op" id="1652618">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652622">j</span>&nbsp;<span class="op" id="1652624">:=</span>&nbsp;<span class="num" id="1652627">0</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652631">for</span>&nbsp;<span class="op" id="1652635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652640">k</span>&nbsp;<span class="op" id="1652642">:=</span>&nbsp;<span class="ident" id="1652645">j</span><span class="op" id="1652646">*</span><span class="num" id="1652647">2</span>&nbsp;<span class="op" id="1652649">+</span>&nbsp;<span class="num" id="1652651">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652656">if</span>&nbsp;<span class="ident" id="1652659">k</span>&nbsp;<span class="op" id="1652661">&gt;=</span>&nbsp;<span class="ident" id="1652664">i</span>&nbsp;<span class="op" id="1652666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652672">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1652681">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652686">if</span>&nbsp;<span class="ident" id="1652689">k</span><span class="op" id="1652690">+</span><span class="num" id="1652691">1</span>&nbsp;<span class="op" id="1652693">&lt;</span>&nbsp;<span class="ident" id="1652695">i</span>&nbsp;<span class="op" id="1652697">&amp;&amp;</span>&nbsp;<span class="ident" id="1652700">lockorder</span><span class="op" id="1652709">[</span><span class="ident" id="1652710">k</span><span class="op" id="1652711">]</span><span class="op" id="1652712">.</span><span class="ident" id="1652713">sortkey</span><span class="op" id="1652720">(</span><span class="op" id="1652721">)</span>&nbsp;<span class="op" id="1652723">&lt;</span>&nbsp;<span class="ident" id="1652725">lockorder</span><span class="op" id="1652734">[</span><span class="ident" id="1652735">k</span><span class="op" id="1652736">+</span><span class="num" id="1652737">1</span><span class="op" id="1652738">]</span><span class="op" id="1652739">.</span><span class="ident" id="1652740">sortkey</span><span class="op" id="1652747">(</span><span class="op" id="1652748">)</span>&nbsp;<span class="op" id="1652750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652756">k</span><span class="op" id="1652757">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1652763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652768">if</span>&nbsp;<span class="ident" id="1652771">c</span><span class="op" id="1652772">.</span><span class="ident" id="1652773">sortkey</span><span class="op" id="1652780">(</span><span class="op" id="1652781">)</span>&nbsp;<span class="op" id="1652783">&lt;</span>&nbsp;<span class="ident" id="1652785">lockorder</span><span class="op" id="1652794">[</span><span class="ident" id="1652795">k</span><span class="op" id="1652796">]</span><span class="op" id="1652797">.</span><span class="ident" id="1652798">sortkey</span><span class="op" id="1652805">(</span><span class="op" id="1652806">)</span>&nbsp;<span class="op" id="1652808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652814">lockorder</span><span class="op" id="1652823">[</span><span class="ident" id="1652824">j</span><span class="op" id="1652825">]</span>&nbsp;<span class="op" id="1652827">=</span>&nbsp;<span class="ident" id="1652829">lockorder</span><span class="op" id="1652838">[</span><span class="ident" id="1652839">k</span><span class="op" id="1652840">]</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652846">j</span>&nbsp;<span class="op" id="1652848">=</span>&nbsp;<span class="ident" id="1652850">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652856">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1652868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1652873">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1652881">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1652885">lockorder</span><span class="op" id="1652894">[</span><span class="ident" id="1652895">j</span><span class="op" id="1652896">]</span>&nbsp;<span class="op" id="1652898">=</span>&nbsp;<span class="ident" id="1652900">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1652903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1652906">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;:=&nbsp;0;&nbsp;i+1&nbsp;&lt;&nbsp;int(sel.ncase);&nbsp;i++&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;lockorder[i].sortkey()&nbsp;&gt;&nbsp;lockorder[i+1].sortkey()&nbsp;{<br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#34;i=&#34;,&nbsp;i,&nbsp;&#34;&nbsp;x=&#34;,&nbsp;lockorder[i],&nbsp;&#34;&nbsp;y=&#34;,&nbsp;lockorder[i+1],&nbsp;&#34;\n&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gothrow(&#34;select:&nbsp;broken&nbsp;sort&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;*/</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1653128">//&nbsp;lock&nbsp;all&nbsp;the&nbsp;channels&nbsp;involved&nbsp;in&nbsp;the&nbsp;select</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653177">sellock</span><span class="op" id="1653184">(</span><span class="ident" id="1653185">sel</span><span class="op" id="1653188">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653192">var</span>&nbsp;<span class="op" id="1653196">(</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653200">gp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653207">*</span><span class="ident" id="1653208">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653212">done</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1653219">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653228">sg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653235">*</span><span class="ident" id="1653236">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653244">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653251">*</span><span class="ident" id="1653252">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653260">k</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653267">*</span><span class="ident" id="1653268">scase</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653276">sglist</span>&nbsp;<span class="op" id="1653283">*</span><span class="ident" id="1653284">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653292">sgnext</span>&nbsp;<span class="op" id="1653299">*</span><span class="ident" id="1653300">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653307">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1653310">loop</span><span class="op" id="1653314">:</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1653317">//&nbsp;pass&nbsp;1&nbsp;-&nbsp;look&nbsp;for&nbsp;something&nbsp;already&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653365">var</span>&nbsp;<span class="ident" id="1653369">dfl</span>&nbsp;<span class="op" id="1653373">*</span><span class="ident" id="1653374">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653381">var</span>&nbsp;<span class="ident" id="1653385">cas</span>&nbsp;<span class="op" id="1653389">*</span><span class="ident" id="1653390">scase</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653397">for</span>&nbsp;<span class="ident" id="1653401">i</span>&nbsp;<span class="op" id="1653403">:=</span>&nbsp;<span class="num" id="1653406">0</span><span class="op" id="1653407">;</span>&nbsp;<span class="ident" id="1653409">i</span>&nbsp;<span class="op" id="1653411">&lt;</span>&nbsp;<span class="builtintype" id="1653413">int</span><span class="op" id="1653416">(</span><span class="ident" id="1653417">sel</span><span class="op" id="1653420">.</span><span class="ident" id="1653421">ncase</span><span class="op" id="1653426">)</span><span class="op" id="1653427">;</span>&nbsp;<span class="ident" id="1653429">i</span><span class="op" id="1653430">++</span>&nbsp;<span class="op" id="1653433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653437">cas</span>&nbsp;<span class="op" id="1653441">=</span>&nbsp;<span class="op" id="1653443">&amp;</span><span class="ident" id="1653444">scases</span><span class="op" id="1653450">[</span><span class="ident" id="1653451">pollorder</span><span class="op" id="1653460">[</span><span class="ident" id="1653461">i</span><span class="op" id="1653462">]</span><span class="op" id="1653463">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653467">c</span>&nbsp;<span class="op" id="1653469">=</span>&nbsp;<span class="ident" id="1653471">cas</span><span class="op" id="1653474">.</span><span class="ident" id="1653475">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653484">switch</span>&nbsp;<span class="ident" id="1653491">cas</span><span class="op" id="1653494">.</span><span class="ident" id="1653495">kind</span>&nbsp;<span class="op" id="1653500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653504">case</span>&nbsp;<span class="ident" id="1653509">_CaseRecv</span><span class="op" id="1653518">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653523">if</span>&nbsp;<span class="ident" id="1653526">c</span><span class="op" id="1653527">.</span><span class="ident" id="1653528">dataqsiz</span>&nbsp;<span class="op" id="1653537">&gt;</span>&nbsp;<span class="num" id="1653539">0</span>&nbsp;<span class="op" id="1653541">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653547">if</span>&nbsp;<span class="ident" id="1653550">c</span><span class="op" id="1653551">.</span><span class="ident" id="1653552">qcount</span>&nbsp;<span class="op" id="1653559">&gt;</span>&nbsp;<span class="num" id="1653561">0</span>&nbsp;<span class="op" id="1653563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653570">goto</span>&nbsp;<span class="ident" id="1653575">asyncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653594">}</span>&nbsp;<span class="keyword" id="1653596">else</span>&nbsp;<span class="op" id="1653601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653607">sg</span>&nbsp;<span class="op" id="1653610">=</span>&nbsp;<span class="ident" id="1653612">c</span><span class="op" id="1653613">.</span><span class="ident" id="1653614">sendq</span><span class="op" id="1653619">.</span><span class="ident" id="1653620">dequeue</span><span class="op" id="1653627">(</span><span class="op" id="1653628">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653634">if</span>&nbsp;<span class="ident" id="1653637">sg</span>&nbsp;<span class="op" id="1653640">!=</span>&nbsp;<span class="builtintype" id="1653643">nil</span>&nbsp;<span class="op" id="1653647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653654">goto</span>&nbsp;<span class="ident" id="1653659">syncrecv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653682">if</span>&nbsp;<span class="ident" id="1653685">c</span><span class="op" id="1653686">.</span><span class="ident" id="1653687">closed</span>&nbsp;<span class="op" id="1653694">!=</span>&nbsp;<span class="num" id="1653697">0</span>&nbsp;<span class="op" id="1653699">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653705">goto</span>&nbsp;<span class="ident" id="1653710">rclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653725">case</span>&nbsp;<span class="ident" id="1653730">_CaseSend</span><span class="op" id="1653739">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653744">if</span>&nbsp;<span class="ident" id="1653747">raceenabled</span>&nbsp;<span class="op" id="1653759">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653765">racereadpc</span><span class="op" id="1653775">(</span><span class="ident" id="1653776">unsafe</span><span class="op" id="1653782">.</span><span class="ident" id="1653783">Pointer</span><span class="op" id="1653790">(</span><span class="ident" id="1653791">c</span><span class="op" id="1653792">)</span><span class="op" id="1653793">,</span>&nbsp;<span class="ident" id="1653795">cas</span><span class="op" id="1653798">.</span><span class="ident" id="1653799">pc</span><span class="op" id="1653801">,</span>&nbsp;<span class="ident" id="1653803">chansendpc</span><span class="op" id="1653813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653823">if</span>&nbsp;<span class="ident" id="1653826">c</span><span class="op" id="1653827">.</span><span class="ident" id="1653828">closed</span>&nbsp;<span class="op" id="1653835">!=</span>&nbsp;<span class="num" id="1653838">0</span>&nbsp;<span class="op" id="1653840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653846">goto</span>&nbsp;<span class="ident" id="1653851">sclose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653861">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653866">if</span>&nbsp;<span class="ident" id="1653869">c</span><span class="op" id="1653870">.</span><span class="ident" id="1653871">dataqsiz</span>&nbsp;<span class="op" id="1653880">&gt;</span>&nbsp;<span class="num" id="1653882">0</span>&nbsp;<span class="op" id="1653884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653890">if</span>&nbsp;<span class="ident" id="1653893">c</span><span class="op" id="1653894">.</span><span class="ident" id="1653895">qcount</span>&nbsp;<span class="op" id="1653902">&lt;</span>&nbsp;<span class="ident" id="1653904">c</span><span class="op" id="1653905">.</span><span class="ident" id="1653906">dataqsiz</span>&nbsp;<span class="op" id="1653915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653922">goto</span>&nbsp;<span class="ident" id="1653927">asyncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1653946">}</span>&nbsp;<span class="keyword" id="1653948">else</span>&nbsp;<span class="op" id="1653953">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1653959">sg</span>&nbsp;<span class="op" id="1653962">=</span>&nbsp;<span class="ident" id="1653964">c</span><span class="op" id="1653965">.</span><span class="ident" id="1653966">recvq</span><span class="op" id="1653971">.</span><span class="ident" id="1653972">dequeue</span><span class="op" id="1653979">(</span><span class="op" id="1653980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1653986">if</span>&nbsp;<span class="ident" id="1653989">sg</span>&nbsp;<span class="op" id="1653992">!=</span>&nbsp;<span class="builtintype" id="1653995">nil</span>&nbsp;<span class="op" id="1653999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1654006">goto</span>&nbsp;<span class="ident" id="1654011">syncsend</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1654024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1654029">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1654034">case</span>&nbsp;<span class="ident" id="1654039">_CaseDefault</span><span class="op" id="1654051">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654056">dfl</span>&nbsp;<span class="op" id="1654060">=</span>&nbsp;<span class="ident" id="1654062">cas</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1654068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1654071">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1654075">if</span>&nbsp;<span class="ident" id="1654078">dfl</span>&nbsp;<span class="op" id="1654082">!=</span>&nbsp;<span class="builtintype" id="1654085">nil</span>&nbsp;<span class="op" id="1654089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654093">selunlock</span><span class="op" id="1654102">(</span><span class="ident" id="1654103">sel</span><span class="op" id="1654106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654110">cas</span>&nbsp;<span class="op" id="1654114">=</span>&nbsp;<span class="ident" id="1654116">dfl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1654122">goto</span>&nbsp;<span class="ident" id="1654127">retc</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1654133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1654137">//&nbsp;pass&nbsp;2&nbsp;-&nbsp;enqueue&nbsp;on&nbsp;all&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654171">gp</span>&nbsp;<span class="op" id="1654174">=</span>&nbsp;<span class="ident" id="1654176">getg</span><span class="op" id="1654180">(</span><span class="op" id="1654181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654184">done</span>&nbsp;<span class="op" id="1654189">=</span>&nbsp;<span class="num" id="1654191">0</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1654194">for</span>&nbsp;<span class="ident" id="1654198">i</span>&nbsp;<span class="op" id="1654200">:=</span>&nbsp;<span class="num" id="1654203">0</span><span class="op" id="1654204">;</span>&nbsp;<span class="ident" id="1654206">i</span>&nbsp;<span class="op" id="1654208">&lt;</span>&nbsp;<span class="builtintype" id="1654210">int</span><span class="op" id="1654213">(</span><span class="ident" id="1654214">sel</span><span class="op" id="1654217">.</span><span class="ident" id="1654218">ncase</span><span class="op" id="1654223">)</span><span class="op" id="1654224">;</span>&nbsp;<span class="ident" id="1654226">i</span><span class="op" id="1654227">++</span>&nbsp;<span class="op" id="1654230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654234">cas</span>&nbsp;<span class="op" id="1654238">=</span>&nbsp;<span class="op" id="1654240">&amp;</span><span class="ident" id="1654241">scases</span><span class="op" id="1654247">[</span><span class="ident" id="1654248">pollorder</span><span class="op" id="1654257">[</span><span class="ident" id="1654258">i</span><span class="op" id="1654259">]</span><span class="op" id="1654260">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654264">c</span>&nbsp;<span class="op" id="1654266">=</span>&nbsp;<span class="ident" id="1654268">cas</span><span class="op" id="1654271">.</span><span class="ident" id="1654272">_chan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654280">sg</span>&nbsp;<span class="op" id="1654283">:=</span>&nbsp;<span class="ident" id="1654286">acquireSudog</span><span class="op" id="1654298">(</span><span class="op" id="1654299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654303">sg</span><span class="op" id="1654305">.</span><span class="ident" id="1654306">g</span>&nbsp;<span class="op" id="1654308">=</span>&nbsp;<span class="ident" id="1654310">gp</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1654315">//&nbsp;Note:&nbsp;selectdone&nbsp;is&nbsp;adjusted&nbsp;for&nbsp;stack&nbsp;copies&nbsp;in&nbsp;stack.c:adjustsudogs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654390">sg</span><span class="op" id="1654392">.</span><span class="ident" id="1654393">selectdone</span>&nbsp;<span class="op" id="1654404">=</span>&nbsp;<span class="op" id="1654406">(</span><span class="op" id="1654407">*</span><span class="builtintype" id="1654408">uint32</span><span class="op" id="1654414">)</span><span class="op" id="1654415">(</span><span class="ident" id="1654416">noescape</span><span class="op" id="1654424">(</span><span class="ident" id="1654425">unsafe</span><span class="op" id="1654431">.</span><span class="ident" id="1654432">Pointer</span><span class="op" id="1654439">(</span><span class="op" id="1654440">&amp;</span><span class="ident" id="1654441">done</span><span class="op" id="1654445">)</span><span class="op" id="1654446">)</span><span class="op" id="1654447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654451">sg</span><span class="op" id="1654453">.</span><span class="ident" id="1654454">elem</span>&nbsp;<span class="op" id="1654459">=</span>&nbsp;<span class="ident" id="1654461">cas</span><span class="op" id="1654464">.</span><span class="ident" id="1654465">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654472">sg</span><span class="op" id="1654474">.</span><span class="ident" id="1654475">releasetime</span>&nbsp;<span class="op" id="1654487">=</span>&nbsp;<span class="num" id="1654489">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1654493">if</span>&nbsp;<span class="ident" id="1654496">t0</span>&nbsp;<span class="op" id="1654499">!=</span>&nbsp;<span class="num" id="1654502">0</span>&nbsp;<span class="op" id="1654504">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654509">sg</span><span class="op" id="1654511">.</span><span class="ident" id="1654512">releasetime</span>&nbsp;<span class="op" id="1654524">=</span>&nbsp;<span class="op" id="1654526">-</span><span class="num" id="1654527">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1654531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654535">sg</span><span class="op" id="1654537">.</span><span class="ident" id="1654538">waitlink</span>&nbsp;<span class="op" id="1654547">=</span>&nbsp;<span class="ident" id="1654549">gp</span><span class="op" id="1654551">.</span><span class="ident" id="1654552">waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654562">gp</span><span class="op" id="1654564">.</span><span class="ident" id="1654565">waiting</span>&nbsp;<span class="op" id="1654573">=</span>&nbsp;<span class="ident" id="1654575">sg</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1654581">switch</span>&nbsp;<span class="ident" id="1654588">cas</span><span class="op" id="1654591">.</span><span class="ident" id="1654592">kind</span>&nbsp;<span class="op" id="1654597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1654601">case</span>&nbsp;<span class="ident" id="1654606">_CaseRecv</span><span class="op" id="1654615">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654620">c</span><span class="op" id="1654621">.</span><span class="ident" id="1654622">recvq</span><span class="op" id="1654627">.</span><span class="ident" id="1654628">enqueue</span><span class="op" id="1654635">(</span><span class="ident" id="1654636">sg</span><span class="op" id="1654638">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1654643">case</span>&nbsp;<span class="ident" id="1654648">_CaseSend</span><span class="op" id="1654657">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654662">c</span><span class="op" id="1654663">.</span><span class="ident" id="1654664">sendq</span><span class="op" id="1654669">.</span><span class="ident" id="1654670">enqueue</span><span class="op" id="1654677">(</span><span class="ident" id="1654678">sg</span><span class="op" id="1654680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1654684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1654687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1654691">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;wake&nbsp;us&nbsp;up</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654726">gp</span><span class="op" id="1654728">.</span><span class="ident" id="1654729">param</span>&nbsp;<span class="op" id="1654735">=</span>&nbsp;<span class="builtintype" id="1654737">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654742">gopark</span><span class="op" id="1654748">(</span><span class="ident" id="1654749">unsafe</span><span class="op" id="1654755">.</span><span class="ident" id="1654756">Pointer</span><span class="op" id="1654763">(</span><span class="ident" id="1654764">funcPC</span><span class="op" id="1654770">(</span><span class="ident" id="1654771">selparkcommit</span><span class="op" id="1654784">)</span><span class="op" id="1654785">)</span><span class="op" id="1654786">,</span>&nbsp;<span class="ident" id="1654788">unsafe</span><span class="op" id="1654794">.</span><span class="ident" id="1654795">Pointer</span><span class="op" id="1654802">(</span><span class="ident" id="1654803">sel</span><span class="op" id="1654806">)</span><span class="op" id="1654807">,</span>&nbsp;<span class="string" id="1654809">&#34;select&#34;</span><span class="op" id="1654817">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1654821">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654844">sellock</span><span class="op" id="1654851">(</span><span class="ident" id="1654852">sel</span><span class="op" id="1654855">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654858">sg</span>&nbsp;<span class="op" id="1654861">=</span>&nbsp;<span class="op" id="1654863">(</span><span class="op" id="1654864">*</span><span class="ident" id="1654865">sudog</span><span class="op" id="1654870">)</span><span class="op" id="1654871">(</span><span class="ident" id="1654872">gp</span><span class="op" id="1654874">.</span><span class="ident" id="1654875">param</span><span class="op" id="1654880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1654883">gp</span><span class="op" id="1654885">.</span><span class="ident" id="1654886">param</span>&nbsp;<span class="op" id="1654892">=</span>&nbsp;<span class="builtintype" id="1654894">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1654900">//&nbsp;pass&nbsp;3&nbsp;-&nbsp;dequeue&nbsp;from&nbsp;unsuccessful&nbsp;chans</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1654945">//&nbsp;otherwise&nbsp;they&nbsp;stack&nbsp;up&nbsp;on&nbsp;quiet&nbsp;channels</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1654991">//&nbsp;record&nbsp;the&nbsp;successful&nbsp;case,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1655031">//&nbsp;We&nbsp;singly-linked&nbsp;up&nbsp;the&nbsp;SudoGs&nbsp;in&nbsp;case&nbsp;order,&nbsp;so&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1655089">//&nbsp;iterating&nbsp;through&nbsp;the&nbsp;linked&nbsp;list&nbsp;they&nbsp;are&nbsp;in&nbsp;reverse&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1655154">cas</span>&nbsp;<span class="op" id="1655158">=</span>&nbsp;<span class="builtintype" id="1655160">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1655165">sglist</span>&nbsp;<span class="op" id="1655172">=</span>&nbsp;<span class="ident" id="1655174">gp</span><span class="op" id="1655176">.</span><span class="ident" id="1655177">waiting</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1655186">//&nbsp;Clear&nbsp;all&nbsp;selectdone&nbsp;and&nbsp;elem&nbsp;before&nbsp;unlinking&nbsp;from&nbsp;gp.waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1655254">//&nbsp;They&nbsp;must&nbsp;be&nbsp;cleared&nbsp;before&nbsp;being&nbsp;put&nbsp;back&nbsp;into&nbsp;the&nbsp;sudog&nbsp;cache.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1655323">//&nbsp;Clear&nbsp;before&nbsp;unlinking,&nbsp;because&nbsp;if&nbsp;a&nbsp;stack&nbsp;copy&nbsp;happens&nbsp;after&nbsp;the&nbsp;unlink,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1655401">//&nbsp;they&nbsp;will&nbsp;not&nbsp;be&nbsp;updated,&nbsp;they&nbsp;will&nbsp;be&nbsp;left&nbsp;pointing&nbsp;to&nbsp;the&nbsp;old&nbsp;stack,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1655476">//&nbsp;which&nbsp;creates&nbsp;dangling&nbsp;pointers,&nbsp;which&nbsp;may&nbsp;be&nbsp;detected&nbsp;by&nbsp;the</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1655542">//&nbsp;garbage&nbsp;collector.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1655565">for</span>&nbsp;<span class="ident" id="1655569">sg1</span>&nbsp;<span class="op" id="1655573">:=</span>&nbsp;<span class="ident" id="1655576">gp</span><span class="op" id="1655578">.</span><span class="ident" id="1655579">waiting</span><span class="op" id="1655586">;</span>&nbsp;<span class="ident" id="1655588">sg1</span>&nbsp;<span class="op" id="1655592">!=</span>&nbsp;<span class="builtintype" id="1655595">nil</span><span class="op" id="1655598">;</span>&nbsp;<span class="ident" id="1655600">sg1</span>&nbsp;<span class="op" id="1655604">=</span>&nbsp;<span class="ident" id="1655606">sg1</span><span class="op" id="1655609">.</span><span class="ident" id="1655610">waitlink</span>&nbsp;<span class="op" id="1655619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1655623">sg1</span><span class="op" id="1655626">.</span><span class="ident" id="1655627">selectdone</span>&nbsp;<span class="op" id="1655638">=</span>&nbsp;<span class="builtintype" id="1655640">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1655646">sg1</span><span class="op" id="1655649">.</span><span class="ident" id="1655650">elem</span>&nbsp;<span class="op" id="1655655">=</span>&nbsp;<span class="builtintype" id="1655657">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1655662">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1655665">gp</span><span class="op" id="1655667">.</span><span class="ident" id="1655668">waiting</span>&nbsp;<span class="op" id="1655676">=</span>&nbsp;<span class="builtintype" id="1655678">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1655683">for</span>&nbsp;<span class="ident" id="1655687">i</span>&nbsp;<span class="op" id="1655689">:=</span>&nbsp;<span class="builtintype" id="1655692">int</span><span class="op" id="1655695">(</span><span class="ident" id="1655696">sel</span><span class="op" id="1655699">.</span><span class="ident" id="1655700">ncase</span><span class="op" id="1655705">)</span>&nbsp;<span class="op" id="1655707">-</span>&nbsp;<span class="num" id="1655709">1</span><span class="op" id="1655710">;</span>&nbsp;<span class="ident" id="1655712">i</span>&nbsp;<span class="op" id="1655714">&gt;=</span>&nbsp;<span class="num" id="1655717">0</span><span class="op" id="1655718">;</span>&nbsp;<span class="ident" id="1655720">i</span><span class="op" id="1655721">--</span>&nbsp;<span class="op" id="1655724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1655728">k</span>&nbsp;<span class="op" id="1655730">=</span>&nbsp;<span class="op" id="1655732">&amp;</span><span class="ident" id="1655733">scases</span><span class="op" id="1655739">[</span><span class="ident" id="1655740">pollorder</span><span class="op" id="1655749">[</span><span class="ident" id="1655750">i</span><span class="op" id="1655751">]</span><span class="op" id="1655752">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1655756">if</span>&nbsp;<span class="ident" id="1655759">sglist</span><span class="op" id="1655765">.</span><span class="ident" id="1655766">releasetime</span>&nbsp;<span class="op" id="1655778">&gt;</span>&nbsp;<span class="num" id="1655780">0</span>&nbsp;<span class="op" id="1655782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1655787">k</span><span class="op" id="1655788">.</span><span class="ident" id="1655789">releasetime</span>&nbsp;<span class="op" id="1655801">=</span>&nbsp;<span class="ident" id="1655803">sglist</span><span class="op" id="1655809">.</span><span class="ident" id="1655810">releasetime</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1655824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1655828">if</span>&nbsp;<span class="ident" id="1655831">sg</span>&nbsp;<span class="op" id="1655834">==</span>&nbsp;<span class="ident" id="1655837">sglist</span>&nbsp;<span class="op" id="1655844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1655849">cas</span>&nbsp;<span class="op" id="1655853">=</span>&nbsp;<span class="ident" id="1655855">k</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1655859">}</span>&nbsp;<span class="keyword" id="1655861">else</span>&nbsp;<span class="op" id="1655866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1655871">c</span>&nbsp;<span class="op" id="1655873">=</span>&nbsp;<span class="ident" id="1655875">k</span><span class="op" id="1655876">.</span><span class="ident" id="1655877">_chan</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1655886">if</span>&nbsp;<span class="ident" id="1655889">k</span><span class="op" id="1655890">.</span><span class="ident" id="1655891">kind</span>&nbsp;<span class="op" id="1655896">==</span>&nbsp;<span class="ident" id="1655899">_CaseSend</span>&nbsp;<span class="op" id="1655909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1655915">c</span><span class="op" id="1655916">.</span><span class="ident" id="1655917">sendq</span><span class="op" id="1655922">.</span><span class="ident" id="1655923">dequeueSudoG</span><span class="op" id="1655935">(</span><span class="ident" id="1655936">sglist</span><span class="op" id="1655942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1655947">}</span>&nbsp;<span class="keyword" id="1655949">else</span>&nbsp;<span class="op" id="1655954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1655960">c</span><span class="op" id="1655961">.</span><span class="ident" id="1655962">recvq</span><span class="op" id="1655967">.</span><span class="ident" id="1655968">dequeueSudoG</span><span class="op" id="1655980">(</span><span class="ident" id="1655981">sglist</span><span class="op" id="1655987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1655992">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1655996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656000">sgnext</span>&nbsp;<span class="op" id="1656007">=</span>&nbsp;<span class="ident" id="1656009">sglist</span><span class="op" id="1656015">.</span><span class="ident" id="1656016">waitlink</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656027">sglist</span><span class="op" id="1656033">.</span><span class="ident" id="1656034">waitlink</span>&nbsp;<span class="op" id="1656043">=</span>&nbsp;<span class="builtintype" id="1656045">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656051">releaseSudog</span><span class="op" id="1656063">(</span><span class="ident" id="1656064">sglist</span><span class="op" id="1656070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656074">sglist</span>&nbsp;<span class="op" id="1656081">=</span>&nbsp;<span class="ident" id="1656083">sgnext</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1656091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1656095">if</span>&nbsp;<span class="ident" id="1656098">cas</span>&nbsp;<span class="op" id="1656102">==</span>&nbsp;<span class="builtintype" id="1656105">nil</span>&nbsp;<span class="op" id="1656109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1656113">goto</span>&nbsp;<span class="ident" id="1656118">loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1656124">}</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656128">c</span>&nbsp;<span class="op" id="1656130">=</span>&nbsp;<span class="ident" id="1656132">cas</span><span class="op" id="1656135">.</span><span class="ident" id="1656136">_chan</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1656144">if</span>&nbsp;<span class="ident" id="1656147">c</span><span class="op" id="1656148">.</span><span class="ident" id="1656149">dataqsiz</span>&nbsp;<span class="op" id="1656158">&gt;</span>&nbsp;<span class="num" id="1656160">0</span>&nbsp;<span class="op" id="1656162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656166">gothrow</span><span class="op" id="1656173">(</span><span class="string" id="1656174">&#34;selectgo:&nbsp;shouldn&#39;t&nbsp;happen&#34;</span><span class="op" id="1656202">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1656205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1656209">if</span>&nbsp;<span class="ident" id="1656212">debugSelect</span>&nbsp;<span class="op" id="1656224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1656228">print</span><span class="op" id="1656233">(</span><span class="string" id="1656234">&#34;wait-return:&nbsp;sel=&#34;</span><span class="op" id="1656253">,</span>&nbsp;<span class="ident" id="1656255">sel</span><span class="op" id="1656258">,</span>&nbsp;<span class="string" id="1656260">&#34;&nbsp;c=&#34;</span><span class="op" id="1656265">,</span>&nbsp;<span class="ident" id="1656267">c</span><span class="op" id="1656268">,</span>&nbsp;<span class="string" id="1656270">&#34;&nbsp;cas=&#34;</span><span class="op" id="1656277">,</span>&nbsp;<span class="ident" id="1656279">cas</span><span class="op" id="1656282">,</span>&nbsp;<span class="string" id="1656284">&#34;&nbsp;kind=&#34;</span><span class="op" id="1656292">,</span>&nbsp;<span class="ident" id="1656294">cas</span><span class="op" id="1656297">.</span><span class="ident" id="1656298">kind</span><span class="op" id="1656302">,</span>&nbsp;<span class="string" id="1656304">&#34;\n&#34;</span><span class="op" id="1656308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1656311">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1656315">if</span>&nbsp;<span class="ident" id="1656318">cas</span><span class="op" id="1656321">.</span><span class="ident" id="1656322">kind</span>&nbsp;<span class="op" id="1656327">==</span>&nbsp;<span class="ident" id="1656330">_CaseRecv</span>&nbsp;<span class="op" id="1656340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1656344">if</span>&nbsp;<span class="ident" id="1656347">cas</span><span class="op" id="1656350">.</span><span class="ident" id="1656351">receivedp</span>&nbsp;<span class="op" id="1656361">!=</span>&nbsp;<span class="builtintype" id="1656364">nil</span>&nbsp;<span class="op" id="1656368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1656373">*</span><span class="ident" id="1656374">cas</span><span class="op" id="1656377">.</span><span class="ident" id="1656378">receivedp</span>&nbsp;<span class="op" id="1656388">=</span>&nbsp;<span class="builtintype" id="1656390">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1656397">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1656400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1656404">if</span>&nbsp;<span class="ident" id="1656407">raceenabled</span>&nbsp;<span class="op" id="1656419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1656423">if</span>&nbsp;<span class="ident" id="1656426">cas</span><span class="op" id="1656429">.</span><span class="ident" id="1656430">kind</span>&nbsp;<span class="op" id="1656435">==</span>&nbsp;<span class="ident" id="1656438">_CaseRecv</span>&nbsp;<span class="op" id="1656448">&amp;&amp;</span>&nbsp;<span class="ident" id="1656451">cas</span><span class="op" id="1656454">.</span><span class="ident" id="1656455">elem</span>&nbsp;<span class="op" id="1656460">!=</span>&nbsp;<span class="builtintype" id="1656463">nil</span>&nbsp;<span class="op" id="1656467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656472">raceWriteObjectPC</span><span class="op" id="1656489">(</span><span class="ident" id="1656490">c</span><span class="op" id="1656491">.</span><span class="ident" id="1656492">elemtype</span><span class="op" id="1656500">,</span>&nbsp;<span class="ident" id="1656502">cas</span><span class="op" id="1656505">.</span><span class="ident" id="1656506">elem</span><span class="op" id="1656510">,</span>&nbsp;<span class="ident" id="1656512">cas</span><span class="op" id="1656515">.</span><span class="ident" id="1656516">pc</span><span class="op" id="1656518">,</span>&nbsp;<span class="ident" id="1656520">chanrecvpc</span><span class="op" id="1656530">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1656534">}</span>&nbsp;<span class="keyword" id="1656536">else</span>&nbsp;<span class="keyword" id="1656541">if</span>&nbsp;<span class="ident" id="1656544">cas</span><span class="op" id="1656547">.</span><span class="ident" id="1656548">kind</span>&nbsp;<span class="op" id="1656553">==</span>&nbsp;<span class="ident" id="1656556">_CaseSend</span>&nbsp;<span class="op" id="1656566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656571">raceReadObjectPC</span><span class="op" id="1656587">(</span><span class="ident" id="1656588">c</span><span class="op" id="1656589">.</span><span class="ident" id="1656590">elemtype</span><span class="op" id="1656598">,</span>&nbsp;<span class="ident" id="1656600">cas</span><span class="op" id="1656603">.</span><span class="ident" id="1656604">elem</span><span class="op" id="1656608">,</span>&nbsp;<span class="ident" id="1656610">cas</span><span class="op" id="1656613">.</span><span class="ident" id="1656614">pc</span><span class="op" id="1656616">,</span>&nbsp;<span class="ident" id="1656618">chansendpc</span><span class="op" id="1656628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1656632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1656635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656639">selunlock</span><span class="op" id="1656648">(</span><span class="ident" id="1656649">sel</span><span class="op" id="1656652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1656655">goto</span>&nbsp;<span class="ident" id="1656660">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1656666">asyncrecv</span><span class="op" id="1656675">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1656678">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;buffer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1656706">if</span>&nbsp;<span class="ident" id="1656709">raceenabled</span>&nbsp;<span class="op" id="1656721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1656725">if</span>&nbsp;<span class="ident" id="1656728">cas</span><span class="op" id="1656731">.</span><span class="ident" id="1656732">elem</span>&nbsp;<span class="op" id="1656737">!=</span>&nbsp;<span class="builtintype" id="1656740">nil</span>&nbsp;<span class="op" id="1656744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656749">raceWriteObjectPC</span><span class="op" id="1656766">(</span><span class="ident" id="1656767">c</span><span class="op" id="1656768">.</span><span class="ident" id="1656769">elemtype</span><span class="op" id="1656777">,</span>&nbsp;<span class="ident" id="1656779">cas</span><span class="op" id="1656782">.</span><span class="ident" id="1656783">elem</span><span class="op" id="1656787">,</span>&nbsp;<span class="ident" id="1656789">cas</span><span class="op" id="1656792">.</span><span class="ident" id="1656793">pc</span><span class="op" id="1656795">,</span>&nbsp;<span class="ident" id="1656797">chanrecvpc</span><span class="op" id="1656807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1656811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656815">raceacquire</span><span class="op" id="1656826">(</span><span class="ident" id="1656827">chanbuf</span><span class="op" id="1656834">(</span><span class="ident" id="1656835">c</span><span class="op" id="1656836">,</span>&nbsp;<span class="ident" id="1656838">c</span><span class="op" id="1656839">.</span><span class="ident" id="1656840">recvx</span><span class="op" id="1656845">)</span><span class="op" id="1656846">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656850">racerelease</span><span class="op" id="1656861">(</span><span class="ident" id="1656862">chanbuf</span><span class="op" id="1656869">(</span><span class="ident" id="1656870">c</span><span class="op" id="1656871">,</span>&nbsp;<span class="ident" id="1656873">c</span><span class="op" id="1656874">.</span><span class="ident" id="1656875">recvx</span><span class="op" id="1656880">)</span><span class="op" id="1656881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1656884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1656887">if</span>&nbsp;<span class="ident" id="1656890">cas</span><span class="op" id="1656893">.</span><span class="ident" id="1656894">receivedp</span>&nbsp;<span class="op" id="1656904">!=</span>&nbsp;<span class="builtintype" id="1656907">nil</span>&nbsp;<span class="op" id="1656911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1656915">*</span><span class="ident" id="1656916">cas</span><span class="op" id="1656919">.</span><span class="ident" id="1656920">receivedp</span>&nbsp;<span class="op" id="1656930">=</span>&nbsp;<span class="builtintype" id="1656932">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1656938">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1656941">if</span>&nbsp;<span class="ident" id="1656944">cas</span><span class="op" id="1656947">.</span><span class="ident" id="1656948">elem</span>&nbsp;<span class="op" id="1656953">!=</span>&nbsp;<span class="builtintype" id="1656956">nil</span>&nbsp;<span class="op" id="1656960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1656964">memmove</span><span class="op" id="1656971">(</span><span class="ident" id="1656972">cas</span><span class="op" id="1656975">.</span><span class="ident" id="1656976">elem</span><span class="op" id="1656980">,</span>&nbsp;<span class="ident" id="1656982">chanbuf</span><span class="op" id="1656989">(</span><span class="ident" id="1656990">c</span><span class="op" id="1656991">,</span>&nbsp;<span class="ident" id="1656993">c</span><span class="op" id="1656994">.</span><span class="ident" id="1656995">recvx</span><span class="op" id="1657000">)</span><span class="op" id="1657001">,</span>&nbsp;<span class="builtintype" id="1657003">uintptr</span><span class="op" id="1657010">(</span><span class="ident" id="1657011">c</span><span class="op" id="1657012">.</span><span class="ident" id="1657013">elemsize</span><span class="op" id="1657021">)</span><span class="op" id="1657022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657028">memclr</span><span class="op" id="1657034">(</span><span class="ident" id="1657035">chanbuf</span><span class="op" id="1657042">(</span><span class="ident" id="1657043">c</span><span class="op" id="1657044">,</span>&nbsp;<span class="ident" id="1657046">c</span><span class="op" id="1657047">.</span><span class="ident" id="1657048">recvx</span><span class="op" id="1657053">)</span><span class="op" id="1657054">,</span>&nbsp;<span class="builtintype" id="1657056">uintptr</span><span class="op" id="1657063">(</span><span class="ident" id="1657064">c</span><span class="op" id="1657065">.</span><span class="ident" id="1657066">elemsize</span><span class="op" id="1657074">)</span><span class="op" id="1657075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657078">c</span><span class="op" id="1657079">.</span><span class="ident" id="1657080">recvx</span><span class="op" id="1657085">++</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657089">if</span>&nbsp;<span class="ident" id="1657092">c</span><span class="op" id="1657093">.</span><span class="ident" id="1657094">recvx</span>&nbsp;<span class="op" id="1657100">==</span>&nbsp;<span class="ident" id="1657103">c</span><span class="op" id="1657104">.</span><span class="ident" id="1657105">dataqsiz</span>&nbsp;<span class="op" id="1657114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657118">c</span><span class="op" id="1657119">.</span><span class="ident" id="1657120">recvx</span>&nbsp;<span class="op" id="1657126">=</span>&nbsp;<span class="num" id="1657128">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657134">c</span><span class="op" id="1657135">.</span><span class="ident" id="1657136">qcount</span><span class="op" id="1657142">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657146">sg</span>&nbsp;<span class="op" id="1657149">=</span>&nbsp;<span class="ident" id="1657151">c</span><span class="op" id="1657152">.</span><span class="ident" id="1657153">sendq</span><span class="op" id="1657158">.</span><span class="ident" id="1657159">dequeue</span><span class="op" id="1657166">(</span><span class="op" id="1657167">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657170">if</span>&nbsp;<span class="ident" id="1657173">sg</span>&nbsp;<span class="op" id="1657176">!=</span>&nbsp;<span class="builtintype" id="1657179">nil</span>&nbsp;<span class="op" id="1657183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657187">gp</span>&nbsp;<span class="op" id="1657190">=</span>&nbsp;<span class="ident" id="1657192">sg</span><span class="op" id="1657194">.</span><span class="ident" id="1657195">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657199">selunlock</span><span class="op" id="1657208">(</span><span class="ident" id="1657209">sel</span><span class="op" id="1657212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657216">if</span>&nbsp;<span class="ident" id="1657219">sg</span><span class="op" id="1657221">.</span><span class="ident" id="1657222">releasetime</span>&nbsp;<span class="op" id="1657234">!=</span>&nbsp;<span class="num" id="1657237">0</span>&nbsp;<span class="op" id="1657239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657244">sg</span><span class="op" id="1657246">.</span><span class="ident" id="1657247">releasetime</span>&nbsp;<span class="op" id="1657259">=</span>&nbsp;<span class="ident" id="1657261">cputicks</span><span class="op" id="1657269">(</span><span class="op" id="1657270">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657278">goready</span><span class="op" id="1657285">(</span><span class="ident" id="1657286">gp</span><span class="op" id="1657288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657291">}</span>&nbsp;<span class="keyword" id="1657293">else</span>&nbsp;<span class="op" id="1657298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657302">selunlock</span><span class="op" id="1657311">(</span><span class="ident" id="1657312">sel</span><span class="op" id="1657315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657318">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657321">goto</span>&nbsp;<span class="ident" id="1657326">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1657332">asyncsend</span><span class="op" id="1657341">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1657344">//&nbsp;can&nbsp;send&nbsp;to&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657367">if</span>&nbsp;<span class="ident" id="1657370">raceenabled</span>&nbsp;<span class="op" id="1657382">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657386">raceacquire</span><span class="op" id="1657397">(</span><span class="ident" id="1657398">chanbuf</span><span class="op" id="1657405">(</span><span class="ident" id="1657406">c</span><span class="op" id="1657407">,</span>&nbsp;<span class="ident" id="1657409">c</span><span class="op" id="1657410">.</span><span class="ident" id="1657411">sendx</span><span class="op" id="1657416">)</span><span class="op" id="1657417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657421">racerelease</span><span class="op" id="1657432">(</span><span class="ident" id="1657433">chanbuf</span><span class="op" id="1657440">(</span><span class="ident" id="1657441">c</span><span class="op" id="1657442">,</span>&nbsp;<span class="ident" id="1657444">c</span><span class="op" id="1657445">.</span><span class="ident" id="1657446">sendx</span><span class="op" id="1657451">)</span><span class="op" id="1657452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657456">raceReadObjectPC</span><span class="op" id="1657472">(</span><span class="ident" id="1657473">c</span><span class="op" id="1657474">.</span><span class="ident" id="1657475">elemtype</span><span class="op" id="1657483">,</span>&nbsp;<span class="ident" id="1657485">cas</span><span class="op" id="1657488">.</span><span class="ident" id="1657489">elem</span><span class="op" id="1657493">,</span>&nbsp;<span class="ident" id="1657495">cas</span><span class="op" id="1657498">.</span><span class="ident" id="1657499">pc</span><span class="op" id="1657501">,</span>&nbsp;<span class="ident" id="1657503">chansendpc</span><span class="op" id="1657513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657519">memmove</span><span class="op" id="1657526">(</span><span class="ident" id="1657527">chanbuf</span><span class="op" id="1657534">(</span><span class="ident" id="1657535">c</span><span class="op" id="1657536">,</span>&nbsp;<span class="ident" id="1657538">c</span><span class="op" id="1657539">.</span><span class="ident" id="1657540">sendx</span><span class="op" id="1657545">)</span><span class="op" id="1657546">,</span>&nbsp;<span class="ident" id="1657548">cas</span><span class="op" id="1657551">.</span><span class="ident" id="1657552">elem</span><span class="op" id="1657556">,</span>&nbsp;<span class="builtintype" id="1657558">uintptr</span><span class="op" id="1657565">(</span><span class="ident" id="1657566">c</span><span class="op" id="1657567">.</span><span class="ident" id="1657568">elemsize</span><span class="op" id="1657576">)</span><span class="op" id="1657577">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657580">c</span><span class="op" id="1657581">.</span><span class="ident" id="1657582">sendx</span><span class="op" id="1657587">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657591">if</span>&nbsp;<span class="ident" id="1657594">c</span><span class="op" id="1657595">.</span><span class="ident" id="1657596">sendx</span>&nbsp;<span class="op" id="1657602">==</span>&nbsp;<span class="ident" id="1657605">c</span><span class="op" id="1657606">.</span><span class="ident" id="1657607">dataqsiz</span>&nbsp;<span class="op" id="1657616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657620">c</span><span class="op" id="1657621">.</span><span class="ident" id="1657622">sendx</span>&nbsp;<span class="op" id="1657628">=</span>&nbsp;<span class="num" id="1657630">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657636">c</span><span class="op" id="1657637">.</span><span class="ident" id="1657638">qcount</span><span class="op" id="1657644">++</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657648">sg</span>&nbsp;<span class="op" id="1657651">=</span>&nbsp;<span class="ident" id="1657653">c</span><span class="op" id="1657654">.</span><span class="ident" id="1657655">recvq</span><span class="op" id="1657660">.</span><span class="ident" id="1657661">dequeue</span><span class="op" id="1657668">(</span><span class="op" id="1657669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657672">if</span>&nbsp;<span class="ident" id="1657675">sg</span>&nbsp;<span class="op" id="1657678">!=</span>&nbsp;<span class="builtintype" id="1657681">nil</span>&nbsp;<span class="op" id="1657685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657689">gp</span>&nbsp;<span class="op" id="1657692">=</span>&nbsp;<span class="ident" id="1657694">sg</span><span class="op" id="1657696">.</span><span class="ident" id="1657697">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657701">selunlock</span><span class="op" id="1657710">(</span><span class="ident" id="1657711">sel</span><span class="op" id="1657714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657718">if</span>&nbsp;<span class="ident" id="1657721">sg</span><span class="op" id="1657723">.</span><span class="ident" id="1657724">releasetime</span>&nbsp;<span class="op" id="1657736">!=</span>&nbsp;<span class="num" id="1657739">0</span>&nbsp;<span class="op" id="1657741">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657746">sg</span><span class="op" id="1657748">.</span><span class="ident" id="1657749">releasetime</span>&nbsp;<span class="op" id="1657761">=</span>&nbsp;<span class="ident" id="1657763">cputicks</span><span class="op" id="1657771">(</span><span class="op" id="1657772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657780">goready</span><span class="op" id="1657787">(</span><span class="ident" id="1657788">gp</span><span class="op" id="1657790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657793">}</span>&nbsp;<span class="keyword" id="1657795">else</span>&nbsp;<span class="op" id="1657800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657804">selunlock</span><span class="op" id="1657813">(</span><span class="ident" id="1657814">sel</span><span class="op" id="1657817">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657823">goto</span>&nbsp;<span class="ident" id="1657828">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1657834">syncrecv</span><span class="op" id="1657842">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1657845">//&nbsp;can&nbsp;receive&nbsp;from&nbsp;sleeping&nbsp;sender&nbsp;(sg)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657887">if</span>&nbsp;<span class="ident" id="1657890">raceenabled</span>&nbsp;<span class="op" id="1657902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1657906">if</span>&nbsp;<span class="ident" id="1657909">cas</span><span class="op" id="1657912">.</span><span class="ident" id="1657913">elem</span>&nbsp;<span class="op" id="1657918">!=</span>&nbsp;<span class="builtintype" id="1657921">nil</span>&nbsp;<span class="op" id="1657925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657930">raceWriteObjectPC</span><span class="op" id="1657947">(</span><span class="ident" id="1657948">c</span><span class="op" id="1657949">.</span><span class="ident" id="1657950">elemtype</span><span class="op" id="1657958">,</span>&nbsp;<span class="ident" id="1657960">cas</span><span class="op" id="1657963">.</span><span class="ident" id="1657964">elem</span><span class="op" id="1657968">,</span>&nbsp;<span class="ident" id="1657970">cas</span><span class="op" id="1657973">.</span><span class="ident" id="1657974">pc</span><span class="op" id="1657976">,</span>&nbsp;<span class="ident" id="1657978">chanrecvpc</span><span class="op" id="1657988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1657992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1657996">racesync</span><span class="op" id="1658004">(</span><span class="ident" id="1658005">c</span><span class="op" id="1658006">,</span>&nbsp;<span class="ident" id="1658008">sg</span><span class="op" id="1658010">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658016">selunlock</span><span class="op" id="1658025">(</span><span class="ident" id="1658026">sel</span><span class="op" id="1658029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658032">if</span>&nbsp;<span class="ident" id="1658035">debugSelect</span>&nbsp;<span class="op" id="1658047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1658051">print</span><span class="op" id="1658056">(</span><span class="string" id="1658057">&#34;syncrecv:&nbsp;sel=&#34;</span><span class="op" id="1658073">,</span>&nbsp;<span class="ident" id="1658075">sel</span><span class="op" id="1658078">,</span>&nbsp;<span class="string" id="1658080">&#34;&nbsp;c=&#34;</span><span class="op" id="1658085">,</span>&nbsp;<span class="ident" id="1658087">c</span><span class="op" id="1658088">,</span>&nbsp;<span class="string" id="1658090">&#34;\n&#34;</span><span class="op" id="1658094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658097">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658100">if</span>&nbsp;<span class="ident" id="1658103">cas</span><span class="op" id="1658106">.</span><span class="ident" id="1658107">receivedp</span>&nbsp;<span class="op" id="1658117">!=</span>&nbsp;<span class="builtintype" id="1658120">nil</span>&nbsp;<span class="op" id="1658124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658128">*</span><span class="ident" id="1658129">cas</span><span class="op" id="1658132">.</span><span class="ident" id="1658133">receivedp</span>&nbsp;<span class="op" id="1658143">=</span>&nbsp;<span class="builtintype" id="1658145">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658154">if</span>&nbsp;<span class="ident" id="1658157">cas</span><span class="op" id="1658160">.</span><span class="ident" id="1658161">elem</span>&nbsp;<span class="op" id="1658166">!=</span>&nbsp;<span class="builtintype" id="1658169">nil</span>&nbsp;<span class="op" id="1658173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658177">memmove</span><span class="op" id="1658184">(</span><span class="ident" id="1658185">cas</span><span class="op" id="1658188">.</span><span class="ident" id="1658189">elem</span><span class="op" id="1658193">,</span>&nbsp;<span class="ident" id="1658195">sg</span><span class="op" id="1658197">.</span><span class="ident" id="1658198">elem</span><span class="op" id="1658202">,</span>&nbsp;<span class="builtintype" id="1658204">uintptr</span><span class="op" id="1658211">(</span><span class="ident" id="1658212">c</span><span class="op" id="1658213">.</span><span class="ident" id="1658214">elemsize</span><span class="op" id="1658222">)</span><span class="op" id="1658223">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658229">sg</span><span class="op" id="1658231">.</span><span class="ident" id="1658232">elem</span>&nbsp;<span class="op" id="1658237">=</span>&nbsp;<span class="builtintype" id="1658239">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658244">gp</span>&nbsp;<span class="op" id="1658247">=</span>&nbsp;<span class="ident" id="1658249">sg</span><span class="op" id="1658251">.</span><span class="ident" id="1658252">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658255">gp</span><span class="op" id="1658257">.</span><span class="ident" id="1658258">param</span>&nbsp;<span class="op" id="1658264">=</span>&nbsp;<span class="ident" id="1658266">unsafe</span><span class="op" id="1658272">.</span><span class="ident" id="1658273">Pointer</span><span class="op" id="1658280">(</span><span class="ident" id="1658281">sg</span><span class="op" id="1658283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658286">if</span>&nbsp;<span class="ident" id="1658289">sg</span><span class="op" id="1658291">.</span><span class="ident" id="1658292">releasetime</span>&nbsp;<span class="op" id="1658304">!=</span>&nbsp;<span class="num" id="1658307">0</span>&nbsp;<span class="op" id="1658309">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658313">sg</span><span class="op" id="1658315">.</span><span class="ident" id="1658316">releasetime</span>&nbsp;<span class="op" id="1658328">=</span>&nbsp;<span class="ident" id="1658330">cputicks</span><span class="op" id="1658338">(</span><span class="op" id="1658339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658345">goready</span><span class="op" id="1658352">(</span><span class="ident" id="1658353">gp</span><span class="op" id="1658355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658358">goto</span>&nbsp;<span class="ident" id="1658363">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="ident" id="1658369">rclose</span><span class="op" id="1658375">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1658378">//&nbsp;read&nbsp;at&nbsp;end&nbsp;of&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658412">selunlock</span><span class="op" id="1658421">(</span><span class="ident" id="1658422">sel</span><span class="op" id="1658425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658428">if</span>&nbsp;<span class="ident" id="1658431">cas</span><span class="op" id="1658434">.</span><span class="ident" id="1658435">receivedp</span>&nbsp;<span class="op" id="1658445">!=</span>&nbsp;<span class="builtintype" id="1658448">nil</span>&nbsp;<span class="op" id="1658452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658456">*</span><span class="ident" id="1658457">cas</span><span class="op" id="1658460">.</span><span class="ident" id="1658461">receivedp</span>&nbsp;<span class="op" id="1658471">=</span>&nbsp;<span class="builtintype" id="1658473">false</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658483">if</span>&nbsp;<span class="ident" id="1658486">cas</span><span class="op" id="1658489">.</span><span class="ident" id="1658490">elem</span>&nbsp;<span class="op" id="1658495">!=</span>&nbsp;<span class="builtintype" id="1658498">nil</span>&nbsp;<span class="op" id="1658502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658506">memclr</span><span class="op" id="1658512">(</span><span class="ident" id="1658513">cas</span><span class="op" id="1658516">.</span><span class="ident" id="1658517">elem</span><span class="op" id="1658521">,</span>&nbsp;<span class="builtintype" id="1658523">uintptr</span><span class="op" id="1658530">(</span><span class="ident" id="1658531">c</span><span class="op" id="1658532">.</span><span class="ident" id="1658533">elemsize</span><span class="op" id="1658541">)</span><span class="op" id="1658542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658548">if</span>&nbsp;<span class="ident" id="1658551">raceenabled</span>&nbsp;<span class="op" id="1658563">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658567">raceacquire</span><span class="op" id="1658578">(</span><span class="ident" id="1658579">unsafe</span><span class="op" id="1658585">.</span><span class="ident" id="1658586">Pointer</span><span class="op" id="1658593">(</span><span class="ident" id="1658594">c</span><span class="op" id="1658595">)</span><span class="op" id="1658596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658602">goto</span>&nbsp;<span class="ident" id="1658607">retc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="1658613">syncsend</span><span class="op" id="1658621">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1658624">//&nbsp;can&nbsp;send&nbsp;to&nbsp;sleeping&nbsp;receiver&nbsp;(sg)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658663">if</span>&nbsp;<span class="ident" id="1658666">raceenabled</span>&nbsp;<span class="op" id="1658678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658682">raceReadObjectPC</span><span class="op" id="1658698">(</span><span class="ident" id="1658699">c</span><span class="op" id="1658700">.</span><span class="ident" id="1658701">elemtype</span><span class="op" id="1658709">,</span>&nbsp;<span class="ident" id="1658711">cas</span><span class="op" id="1658714">.</span><span class="ident" id="1658715">elem</span><span class="op" id="1658719">,</span>&nbsp;<span class="ident" id="1658721">cas</span><span class="op" id="1658724">.</span><span class="ident" id="1658725">pc</span><span class="op" id="1658727">,</span>&nbsp;<span class="ident" id="1658729">chansendpc</span><span class="op" id="1658739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658743">racesync</span><span class="op" id="1658751">(</span><span class="ident" id="1658752">c</span><span class="op" id="1658753">,</span>&nbsp;<span class="ident" id="1658755">sg</span><span class="op" id="1658757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658760">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658763">selunlock</span><span class="op" id="1658772">(</span><span class="ident" id="1658773">sel</span><span class="op" id="1658776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658779">if</span>&nbsp;<span class="ident" id="1658782">debugSelect</span>&nbsp;<span class="op" id="1658794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1658798">print</span><span class="op" id="1658803">(</span><span class="string" id="1658804">&#34;syncsend:&nbsp;sel=&#34;</span><span class="op" id="1658820">,</span>&nbsp;<span class="ident" id="1658822">sel</span><span class="op" id="1658825">,</span>&nbsp;<span class="string" id="1658827">&#34;&nbsp;c=&#34;</span><span class="op" id="1658832">,</span>&nbsp;<span class="ident" id="1658834">c</span><span class="op" id="1658835">,</span>&nbsp;<span class="string" id="1658837">&#34;\n&#34;</span><span class="op" id="1658841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658847">if</span>&nbsp;<span class="ident" id="1658850">sg</span><span class="op" id="1658852">.</span><span class="ident" id="1658853">elem</span>&nbsp;<span class="op" id="1658858">!=</span>&nbsp;<span class="builtintype" id="1658861">nil</span>&nbsp;<span class="op" id="1658865">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658869">memmove</span><span class="op" id="1658876">(</span><span class="ident" id="1658877">sg</span><span class="op" id="1658879">.</span><span class="ident" id="1658880">elem</span><span class="op" id="1658884">,</span>&nbsp;<span class="ident" id="1658886">cas</span><span class="op" id="1658889">.</span><span class="ident" id="1658890">elem</span><span class="op" id="1658894">,</span>&nbsp;<span class="builtintype" id="1658896">uintptr</span><span class="op" id="1658903">(</span><span class="ident" id="1658904">c</span><span class="op" id="1658905">.</span><span class="ident" id="1658906">elemsize</span><span class="op" id="1658914">)</span><span class="op" id="1658915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1658918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658921">sg</span><span class="op" id="1658923">.</span><span class="ident" id="1658924">elem</span>&nbsp;<span class="op" id="1658929">=</span>&nbsp;<span class="builtintype" id="1658931">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658936">gp</span>&nbsp;<span class="op" id="1658939">=</span>&nbsp;<span class="ident" id="1658941">sg</span><span class="op" id="1658943">.</span><span class="ident" id="1658944">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1658947">gp</span><span class="op" id="1658949">.</span><span class="ident" id="1658950">param</span>&nbsp;<span class="op" id="1658956">=</span>&nbsp;<span class="ident" id="1658958">unsafe</span><span class="op" id="1658964">.</span><span class="ident" id="1658965">Pointer</span><span class="op" id="1658972">(</span><span class="ident" id="1658973">sg</span><span class="op" id="1658975">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1658978">if</span>&nbsp;<span class="ident" id="1658981">sg</span><span class="op" id="1658983">.</span><span class="ident" id="1658984">releasetime</span>&nbsp;<span class="op" id="1658996">!=</span>&nbsp;<span class="num" id="1658999">0</span>&nbsp;<span class="op" id="1659001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659005">sg</span><span class="op" id="1659007">.</span><span class="ident" id="1659008">releasetime</span>&nbsp;<span class="op" id="1659020">=</span>&nbsp;<span class="ident" id="1659022">cputicks</span><span class="op" id="1659030">(</span><span class="op" id="1659031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659037">goready</span><span class="op" id="1659044">(</span><span class="ident" id="1659045">gp</span><span class="op" id="1659047">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">565</span><span class="ident" id="1659050">retc</span><span class="op" id="1659054">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659057">if</span>&nbsp;<span class="ident" id="1659060">cas</span><span class="op" id="1659063">.</span><span class="ident" id="1659064">releasetime</span>&nbsp;<span class="op" id="1659076">&gt;</span>&nbsp;<span class="num" id="1659078">0</span>&nbsp;<span class="op" id="1659080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659084">blockevent</span><span class="op" id="1659094">(</span><span class="ident" id="1659095">cas</span><span class="op" id="1659098">.</span><span class="ident" id="1659099">releasetime</span><span class="op" id="1659110">-</span><span class="ident" id="1659111">t0</span><span class="op" id="1659113">,</span>&nbsp;<span class="num" id="1659115">2</span><span class="op" id="1659116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1659119">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659122">return</span>&nbsp;<span class="ident" id="1659129">cas</span><span class="op" id="1659132">.</span><span class="ident" id="1659133">pc</span><span class="op" id="1659135">,</span>&nbsp;<span class="ident" id="1659137">cas</span><span class="op" id="1659140">.</span><span class="ident" id="1659141">so</span><br>
<span class="lineno">570</span><br>
<span class="lineno"></span><span class="ident" id="1659145">sclose</span><span class="op" id="1659151">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1659154">//&nbsp;send&nbsp;on&nbsp;closed&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659181">selunlock</span><span class="op" id="1659190">(</span><span class="ident" id="1659191">sel</span><span class="op" id="1659194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1659197">panic</span><span class="op" id="1659202">(</span><span class="string" id="1659203">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1659227">)</span><br>
<span class="lineno">575</span><span class="op" id="1659229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1659232">func</span>&nbsp;<span class="op" id="1659237">(</span><span class="ident" id="1659238">c</span>&nbsp;<span class="op" id="1659240">*</span><span class="ident" id="1659241">hchan</span><span class="op" id="1659246">)</span>&nbsp;<span class="ident" id="1659248">sortkey</span><span class="op" id="1659255">(</span><span class="op" id="1659256">)</span>&nbsp;<span class="builtintype" id="1659258">uintptr</span>&nbsp;<span class="op" id="1659266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1659269">//&nbsp;TODO(khr):&nbsp;if&nbsp;we&nbsp;have&nbsp;a&nbsp;moving&nbsp;garbage&nbsp;collector,&nbsp;we&#39;ll&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1659337">//&nbsp;change&nbsp;this&nbsp;function.</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1659363">return</span>&nbsp;<span class="builtintype" id="1659370">uintptr</span><span class="op" id="1659377">(</span><span class="ident" id="1659378">unsafe</span><span class="op" id="1659384">.</span><span class="ident" id="1659385">Pointer</span><span class="op" id="1659392">(</span><span class="ident" id="1659393">c</span><span class="op" id="1659394">)</span><span class="op" id="1659395">)</span><br>
<span class="lineno"></span><span class="op" id="1659397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1659400">//&nbsp;A&nbsp;runtimeSelect&nbsp;is&nbsp;a&nbsp;single&nbsp;case&nbsp;passed&nbsp;to&nbsp;rselect.</span><br>
<span class="lineno"></span><span class="comment" id="1659455">//&nbsp;This&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/runtimeSelect</span><br>
<span class="lineno">585</span><span class="keyword" id="1659509">type</span>&nbsp;<span class="ident" id="1659514">runtimeSelect</span>&nbsp;<span class="keyword" id="1659528">struct</span>&nbsp;<span class="op" id="1659535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659538">dir</span>&nbsp;<span class="ident" id="1659542">selectDir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659553">typ</span>&nbsp;<span class="ident" id="1659557">unsafe</span><span class="op" id="1659563">.</span><span class="ident" id="1659564">Pointer</span>&nbsp;<span class="comment" id="1659572">//&nbsp;channel&nbsp;type&nbsp;(not&nbsp;used&nbsp;here)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659605">ch</span>&nbsp;&nbsp;<span class="op" id="1659609">*</span><span class="ident" id="1659610">hchan</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1659624">//&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659636">val</span>&nbsp;<span class="ident" id="1659640">unsafe</span><span class="op" id="1659646">.</span><span class="ident" id="1659647">Pointer</span>&nbsp;<span class="comment" id="1659655">//&nbsp;ptr&nbsp;to&nbsp;data&nbsp;(SendDir)&nbsp;or&nbsp;ptr&nbsp;to&nbsp;receive&nbsp;buffer&nbsp;(RecvDir)</span><br>
<span class="lineno">590</span><span class="op" id="1659715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1659718">//&nbsp;These&nbsp;values&nbsp;must&nbsp;match&nbsp;../reflect/value.go:/SelectDir.</span><br>
<span class="lineno"></span><span class="keyword" id="1659777">type</span>&nbsp;<span class="ident" id="1659782">selectDir</span>&nbsp;<span class="builtintype" id="1659792">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span><span class="keyword" id="1659797">const</span>&nbsp;<span class="op" id="1659803">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659806">_</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659820">selectDir</span>&nbsp;<span class="op" id="1659830">=</span>&nbsp;<span class="ident" id="1659832">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659838">selectSend</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1659862">//&nbsp;case&nbsp;Chan&nbsp;&lt;-&nbsp;Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659884">selectRecv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1659908">//&nbsp;case&nbsp;&lt;-Chan:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1659925">selectDefault</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1659949">//&nbsp;default</span><br>
<span class="lineno">600</span><span class="op" id="1659960">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1659963">func</span>&nbsp;<span class="ident" id="1659968">reflect_rselect</span><span class="op" id="1659983">(</span><span class="ident" id="1659984">cases</span>&nbsp;<span class="op" id="1659990">[</span><span class="op" id="1659991">]</span><span class="ident" id="1659992">runtimeSelect</span><span class="op" id="1660005">)</span>&nbsp;<span class="op" id="1660007">(</span><span class="ident" id="1660008">chosen</span>&nbsp;<span class="builtintype" id="1660015">int</span><span class="op" id="1660018">,</span>&nbsp;<span class="ident" id="1660020">recvOK</span>&nbsp;<span class="builtintype" id="1660027">bool</span><span class="op" id="1660031">)</span>&nbsp;<span class="op" id="1660033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1660036">//&nbsp;flagNoScan&nbsp;is&nbsp;safe&nbsp;here,&nbsp;because&nbsp;all&nbsp;objects&nbsp;are&nbsp;also&nbsp;referenced&nbsp;from&nbsp;cases.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660117">size</span>&nbsp;<span class="op" id="1660122">:=</span>&nbsp;<span class="ident" id="1660125">selectsize</span><span class="op" id="1660135">(</span><span class="builtintype" id="1660136">uintptr</span><span class="op" id="1660143">(</span><span class="builtinfunc" id="1660144">len</span><span class="op" id="1660147">(</span><span class="ident" id="1660148">cases</span><span class="op" id="1660153">)</span><span class="op" id="1660154">)</span><span class="op" id="1660155">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660158">sel</span>&nbsp;<span class="op" id="1660162">:=</span>&nbsp;<span class="op" id="1660165">(</span><span class="op" id="1660166">*</span><span class="ident" id="1660167">_select</span><span class="op" id="1660174">)</span><span class="op" id="1660175">(</span><span class="ident" id="1660176">mallocgc</span><span class="op" id="1660184">(</span><span class="ident" id="1660185">size</span><span class="op" id="1660189">,</span>&nbsp;<span class="builtintype" id="1660191">nil</span><span class="op" id="1660194">,</span>&nbsp;<span class="ident" id="1660196">flagNoScan</span><span class="op" id="1660206">)</span><span class="op" id="1660207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660210">newselect</span><span class="op" id="1660219">(</span><span class="ident" id="1660220">sel</span><span class="op" id="1660223">,</span>&nbsp;<span class="ident" id="1660225">int64</span><span class="op" id="1660230">(</span><span class="ident" id="1660231">size</span><span class="op" id="1660235">)</span><span class="op" id="1660236">,</span>&nbsp;<span class="builtintype" id="1660238">int32</span><span class="op" id="1660243">(</span><span class="builtinfunc" id="1660244">len</span><span class="op" id="1660247">(</span><span class="ident" id="1660248">cases</span><span class="op" id="1660253">)</span><span class="op" id="1660254">)</span><span class="op" id="1660255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660258">r</span>&nbsp;<span class="op" id="1660260">:=</span>&nbsp;<span class="builtinfunc" id="1660263">new</span><span class="op" id="1660266">(</span><span class="builtintype" id="1660267">bool</span><span class="op" id="1660271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1660274">for</span>&nbsp;<span class="ident" id="1660278">i</span>&nbsp;<span class="op" id="1660280">:=</span>&nbsp;<span class="keyword" id="1660283">range</span>&nbsp;<span class="ident" id="1660289">cases</span>&nbsp;<span class="op" id="1660295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660299">rc</span>&nbsp;<span class="op" id="1660302">:=</span>&nbsp;<span class="op" id="1660305">&amp;</span><span class="ident" id="1660306">cases</span><span class="op" id="1660311">[</span><span class="ident" id="1660312">i</span><span class="op" id="1660313">]</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1660317">switch</span>&nbsp;<span class="ident" id="1660324">rc</span><span class="op" id="1660326">.</span><span class="ident" id="1660327">dir</span>&nbsp;<span class="op" id="1660331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1660335">case</span>&nbsp;<span class="ident" id="1660340">selectDefault</span><span class="op" id="1660353">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660358">selectdefaultImpl</span><span class="op" id="1660375">(</span><span class="ident" id="1660376">sel</span><span class="op" id="1660379">,</span>&nbsp;<span class="builtintype" id="1660381">uintptr</span><span class="op" id="1660388">(</span><span class="ident" id="1660389">i</span><span class="op" id="1660390">)</span><span class="op" id="1660391">,</span>&nbsp;<span class="num" id="1660393">0</span><span class="op" id="1660394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1660398">case</span>&nbsp;<span class="ident" id="1660403">selectSend</span><span class="op" id="1660413">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1660418">if</span>&nbsp;<span class="ident" id="1660421">rc</span><span class="op" id="1660423">.</span><span class="ident" id="1660424">ch</span>&nbsp;<span class="op" id="1660427">==</span>&nbsp;<span class="builtintype" id="1660430">nil</span>&nbsp;<span class="op" id="1660434">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1660440">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1660449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660454">selectsendImpl</span><span class="op" id="1660468">(</span><span class="ident" id="1660469">sel</span><span class="op" id="1660472">,</span>&nbsp;<span class="ident" id="1660474">rc</span><span class="op" id="1660476">.</span><span class="ident" id="1660477">ch</span><span class="op" id="1660479">,</span>&nbsp;<span class="builtintype" id="1660481">uintptr</span><span class="op" id="1660488">(</span><span class="ident" id="1660489">i</span><span class="op" id="1660490">)</span><span class="op" id="1660491">,</span>&nbsp;<span class="ident" id="1660493">rc</span><span class="op" id="1660495">.</span><span class="ident" id="1660496">val</span><span class="op" id="1660499">,</span>&nbsp;<span class="num" id="1660501">0</span><span class="op" id="1660502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1660506">case</span>&nbsp;<span class="ident" id="1660511">selectRecv</span><span class="op" id="1660521">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1660526">if</span>&nbsp;<span class="ident" id="1660529">rc</span><span class="op" id="1660531">.</span><span class="ident" id="1660532">ch</span>&nbsp;<span class="op" id="1660535">==</span>&nbsp;<span class="builtintype" id="1660538">nil</span>&nbsp;<span class="op" id="1660542">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1660548">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1660557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660562">selectrecvImpl</span><span class="op" id="1660576">(</span><span class="ident" id="1660577">sel</span><span class="op" id="1660580">,</span>&nbsp;<span class="ident" id="1660582">rc</span><span class="op" id="1660584">.</span><span class="ident" id="1660585">ch</span><span class="op" id="1660587">,</span>&nbsp;<span class="builtintype" id="1660589">uintptr</span><span class="op" id="1660596">(</span><span class="ident" id="1660597">i</span><span class="op" id="1660598">)</span><span class="op" id="1660599">,</span>&nbsp;<span class="ident" id="1660601">rc</span><span class="op" id="1660603">.</span><span class="ident" id="1660604">val</span><span class="op" id="1660607">,</span>&nbsp;<span class="ident" id="1660609">r</span><span class="op" id="1660610">,</span>&nbsp;<span class="num" id="1660612">0</span><span class="op" id="1660613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1660617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1660620">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660624">pc</span><span class="op" id="1660626">,</span>&nbsp;<span class="ident" id="1660628">_</span>&nbsp;<span class="op" id="1660630">:=</span>&nbsp;<span class="ident" id="1660633">selectgoImpl</span><span class="op" id="1660645">(</span><span class="ident" id="1660646">sel</span><span class="op" id="1660649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660652">chosen</span>&nbsp;<span class="op" id="1660659">=</span>&nbsp;<span class="builtintype" id="1660661">int</span><span class="op" id="1660664">(</span><span class="ident" id="1660665">pc</span><span class="op" id="1660667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660670">recvOK</span>&nbsp;<span class="op" id="1660677">=</span>&nbsp;<span class="op" id="1660679">*</span><span class="ident" id="1660680">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1660683">return</span><br>
<span class="lineno">630</span><span class="op" id="1660690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1660693">func</span>&nbsp;<span class="op" id="1660698">(</span><span class="ident" id="1660699">q</span>&nbsp;<span class="op" id="1660701">*</span><span class="ident" id="1660702">waitq</span><span class="op" id="1660707">)</span>&nbsp;<span class="ident" id="1660709">dequeueSudoG</span><span class="op" id="1660721">(</span><span class="ident" id="1660722">s</span>&nbsp;<span class="op" id="1660724">*</span><span class="ident" id="1660725">sudog</span><span class="op" id="1660730">)</span>&nbsp;<span class="op" id="1660732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1660735">var</span>&nbsp;<span class="ident" id="1660739">prevsgp</span>&nbsp;<span class="op" id="1660747">*</span><span class="ident" id="1660748">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660755">l</span>&nbsp;<span class="op" id="1660757">:=</span>&nbsp;<span class="op" id="1660760">&amp;</span><span class="ident" id="1660761">q</span><span class="op" id="1660762">.</span><span class="ident" id="1660763">first</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1660770">for</span>&nbsp;<span class="op" id="1660774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660778">sgp</span>&nbsp;<span class="op" id="1660782">:=</span>&nbsp;<span class="op" id="1660785">*</span><span class="ident" id="1660786">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1660790">if</span>&nbsp;<span class="ident" id="1660793">sgp</span>&nbsp;<span class="op" id="1660797">==</span>&nbsp;<span class="builtintype" id="1660800">nil</span>&nbsp;<span class="op" id="1660804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1660809">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1660818">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1660822">if</span>&nbsp;<span class="ident" id="1660825">sgp</span>&nbsp;<span class="op" id="1660829">==</span>&nbsp;<span class="ident" id="1660832">s</span>&nbsp;<span class="op" id="1660834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1660839">*</span><span class="ident" id="1660840">l</span>&nbsp;<span class="op" id="1660842">=</span>&nbsp;<span class="ident" id="1660844">sgp</span><span class="op" id="1660847">.</span><span class="ident" id="1660848">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1660856">if</span>&nbsp;<span class="ident" id="1660859">q</span><span class="op" id="1660860">.</span><span class="ident" id="1660861">last</span>&nbsp;<span class="op" id="1660866">==</span>&nbsp;<span class="ident" id="1660869">sgp</span>&nbsp;<span class="op" id="1660873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660879">q</span><span class="op" id="1660880">.</span><span class="ident" id="1660881">last</span>&nbsp;<span class="op" id="1660886">=</span>&nbsp;<span class="ident" id="1660888">prevsgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1660899">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660904">s</span><span class="op" id="1660905">.</span><span class="ident" id="1660906">next</span>&nbsp;<span class="op" id="1660911">=</span>&nbsp;<span class="builtintype" id="1660913">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1660920">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1660929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660933">l</span>&nbsp;<span class="op" id="1660935">=</span>&nbsp;<span class="op" id="1660937">&amp;</span><span class="ident" id="1660938">sgp</span><span class="op" id="1660941">.</span><span class="ident" id="1660942">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1660949">prevsgp</span>&nbsp;<span class="op" id="1660957">=</span>&nbsp;<span class="ident" id="1660959">sgp</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1660964">}</span><br>
<span class="lineno"></span><span class="op" id="1660966">}</span>
</div>
</body>
</html>
