<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4853035">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4853090">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4853144">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4853195">//&nbsp;HTTP&nbsp;file&nbsp;system&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4853232">package</span>&nbsp;<span class="ident" id="4853240">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4853246">import</span>&nbsp;<span class="op" id="4853253">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4853256">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4853266">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4853273">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4853279">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4853287">&#34;mime/multipart&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4853305">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4853322">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4853333">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4853339">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4853347">&#34;path/filepath&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4853364">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4853375">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4853386">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4853393">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="4853396">//&nbsp;A&nbsp;Dir&nbsp;implements&nbsp;FileSystem&nbsp;using&nbsp;the&nbsp;native&nbsp;file&nbsp;system&nbsp;restricted&nbsp;to&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4853472">//&nbsp;specific&nbsp;directory&nbsp;tree.</span><br>
<span class="lineno"></span><span class="comment" id="4853500">//</span><br>
<span class="lineno"></span><span class="comment" id="4853503">//&nbsp;While&nbsp;the&nbsp;FileSystem.Open&nbsp;method&nbsp;takes&nbsp;&#39;/&#39;-separated&nbsp;paths,&nbsp;a&nbsp;Dir&#39;s&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="4853581">//&nbsp;value&nbsp;is&nbsp;a&nbsp;filename&nbsp;on&nbsp;the&nbsp;native&nbsp;file&nbsp;system,&nbsp;not&nbsp;a&nbsp;URL,&nbsp;so&nbsp;it&nbsp;is&nbsp;separated</span><br>
<span class="lineno">30</span><span class="comment" id="4853661">//&nbsp;by&nbsp;filepath.Separator,&nbsp;which&nbsp;isn&#39;t&nbsp;necessarily&nbsp;&#39;/&#39;.</span><br>
<span class="lineno"></span><span class="comment" id="4853716">//</span><br>
<span class="lineno"></span><span class="comment" id="4853719">//&nbsp;An&nbsp;empty&nbsp;Dir&nbsp;is&nbsp;treated&nbsp;as&nbsp;&#34;.&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="4853754">type</span>&nbsp;<span class="ident" id="4853759">Dir</span>&nbsp;<span class="builtintype" id="4853763">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="4853771">func</span>&nbsp;<span class="op" id="4853776">(</span><span class="ident" id="4853777">d</span>&nbsp;<span class="ident" id="4853779">Dir</span><span class="op" id="4853782">)</span>&nbsp;<span class="ident" id="4853784">Open</span><span class="op" id="4853788">(</span><span class="ident" id="4853789">name</span>&nbsp;<span class="builtintype" id="4853794">string</span><span class="op" id="4853800">)</span>&nbsp;<span class="op" id="4853802">(</span><span class="ident" id="4853803">File</span><span class="op" id="4853807">,</span>&nbsp;<span class="builtintype" id="4853809">error</span><span class="op" id="4853814">)</span>&nbsp;<span class="op" id="4853816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4853819">if</span>&nbsp;<span class="ident" id="4853822">filepath</span><span class="op" id="4853830">.</span><span class="ident" id="4853831">Separator</span>&nbsp;<span class="op" id="4853841">!=</span>&nbsp;<span class="string" id="4853844">&#39;/&#39;</span>&nbsp;<span class="op" id="4853848">&amp;&amp;</span>&nbsp;<span class="ident" id="4853851">strings</span><span class="op" id="4853858">.</span><span class="ident" id="4853859">IndexRune</span><span class="op" id="4853868">(</span><span class="ident" id="4853869">name</span><span class="op" id="4853873">,</span>&nbsp;<span class="ident" id="4853875">filepath</span><span class="op" id="4853883">.</span><span class="ident" id="4853884">Separator</span><span class="op" id="4853893">)</span>&nbsp;<span class="op" id="4853895">&gt;=</span>&nbsp;<span class="num" id="4853898">0</span>&nbsp;<span class="op" id="4853900">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4853905">strings</span><span class="op" id="4853912">.</span><span class="ident" id="4853913">Contains</span><span class="op" id="4853921">(</span><span class="ident" id="4853922">name</span><span class="op" id="4853926">,</span>&nbsp;<span class="string" id="4853928">&#34;\x00&#34;</span><span class="op" id="4853934">)</span>&nbsp;<span class="op" id="4853936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4853940">return</span>&nbsp;<span class="ident" id="4853947">nil</span><span class="op" id="4853950">,</span>&nbsp;<span class="ident" id="4853952">errors</span><span class="op" id="4853958">.</span><span class="ident" id="4853959">New</span><span class="op" id="4853962">(</span><span class="string" id="4853963">&#34;http:&nbsp;invalid&nbsp;character&nbsp;in&nbsp;file&nbsp;path&#34;</span><span class="op" id="4854001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4854004">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4854007">dir</span>&nbsp;<span class="op" id="4854011">:=</span>&nbsp;<span class="builtintype" id="4854014">string</span><span class="op" id="4854020">(</span><span class="ident" id="4854021">d</span><span class="op" id="4854022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4854025">if</span>&nbsp;<span class="ident" id="4854028">dir</span>&nbsp;<span class="op" id="4854032">==</span>&nbsp;<span class="string" id="4854035">&#34;&#34;</span>&nbsp;<span class="op" id="4854038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4854042">dir</span>&nbsp;<span class="op" id="4854046">=</span>&nbsp;<span class="string" id="4854048">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4854053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4854056">f</span><span class="op" id="4854057">,</span>&nbsp;<span class="ident" id="4854059">err</span>&nbsp;<span class="op" id="4854063">:=</span>&nbsp;<span class="ident" id="4854066">os</span><span class="op" id="4854068">.</span><span class="ident" id="4854069">Open</span><span class="op" id="4854073">(</span><span class="ident" id="4854074">filepath</span><span class="op" id="4854082">.</span><span class="ident" id="4854083">Join</span><span class="op" id="4854087">(</span><span class="ident" id="4854088">dir</span><span class="op" id="4854091">,</span>&nbsp;<span class="ident" id="4854093">filepath</span><span class="op" id="4854101">.</span><span class="ident" id="4854102">FromSlash</span><span class="op" id="4854111">(</span><span class="ident" id="4854112">path</span><span class="op" id="4854116">.</span><span class="ident" id="4854117">Clean</span><span class="op" id="4854122">(</span><span class="string" id="4854123">&#34;/&#34;</span><span class="op" id="4854126">+</span><span class="ident" id="4854127">name</span><span class="op" id="4854131">)</span><span class="op" id="4854132">)</span><span class="op" id="4854133">)</span><span class="op" id="4854134">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4854137">if</span>&nbsp;<span class="ident" id="4854140">err</span>&nbsp;<span class="op" id="4854144">!=</span>&nbsp;<span class="ident" id="4854147">nil</span>&nbsp;<span class="op" id="4854151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4854155">return</span>&nbsp;<span class="ident" id="4854162">nil</span><span class="op" id="4854165">,</span>&nbsp;<span class="ident" id="4854167">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4854172">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4854175">return</span>&nbsp;<span class="ident" id="4854182">f</span><span class="op" id="4854183">,</span>&nbsp;<span class="ident" id="4854185">nil</span><br>
<span class="lineno"></span><span class="op" id="4854189">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="4854192">//&nbsp;A&nbsp;FileSystem&nbsp;implements&nbsp;access&nbsp;to&nbsp;a&nbsp;collection&nbsp;of&nbsp;named&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="4854258">//&nbsp;The&nbsp;elements&nbsp;in&nbsp;a&nbsp;file&nbsp;path&nbsp;are&nbsp;separated&nbsp;by&nbsp;slash&nbsp;(&#39;/&#39;,&nbsp;U+002F)</span><br>
<span class="lineno"></span><span class="comment" id="4854326">//&nbsp;characters,&nbsp;regardless&nbsp;of&nbsp;host&nbsp;operating&nbsp;system&nbsp;convention.</span><br>
<span class="lineno"></span><span class="keyword" id="4854389">type</span>&nbsp;<span class="ident" id="4854394">FileSystem</span>&nbsp;<span class="keyword" id="4854405">interface</span>&nbsp;<span class="op" id="4854415">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4854418">Open</span><span class="op" id="4854422">(</span><span class="ident" id="4854423">name</span>&nbsp;<span class="builtintype" id="4854428">string</span><span class="op" id="4854434">)</span>&nbsp;<span class="op" id="4854436">(</span><span class="ident" id="4854437">File</span><span class="op" id="4854441">,</span>&nbsp;<span class="builtintype" id="4854443">error</span><span class="op" id="4854448">)</span><br>
<span class="lineno"></span><span class="op" id="4854450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4854453">//&nbsp;A&nbsp;File&nbsp;is&nbsp;returned&nbsp;by&nbsp;a&nbsp;FileSystem&#39;s&nbsp;Open&nbsp;method&nbsp;and&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4854516">//&nbsp;served&nbsp;by&nbsp;the&nbsp;FileServer&nbsp;implementation.</span><br>
<span class="lineno">60</span><span class="comment" id="4854560">//</span><br>
<span class="lineno"></span><span class="comment" id="4854563">//&nbsp;The&nbsp;methods&nbsp;should&nbsp;behave&nbsp;the&nbsp;same&nbsp;as&nbsp;those&nbsp;on&nbsp;an&nbsp;*os.File.</span><br>
<span class="lineno"></span><span class="keyword" id="4854626">type</span>&nbsp;<span class="ident" id="4854631">File</span>&nbsp;<span class="keyword" id="4854636">interface</span>&nbsp;<span class="op" id="4854646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4854649">io</span><span class="op" id="4854651">.</span><span class="ident" id="4854652">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4854660">io</span><span class="op" id="4854662">.</span><span class="ident" id="4854663">Reader</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4854671">Readdir</span><span class="op" id="4854678">(</span><span class="ident" id="4854679">count</span>&nbsp;<span class="builtintype" id="4854685">int</span><span class="op" id="4854688">)</span>&nbsp;<span class="op" id="4854690">(</span><span class="op" id="4854691">[</span><span class="op" id="4854692">]</span><span class="ident" id="4854693">os</span><span class="op" id="4854695">.</span><span class="ident" id="4854696">FileInfo</span><span class="op" id="4854704">,</span>&nbsp;<span class="builtintype" id="4854706">error</span><span class="op" id="4854711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4854714">Seek</span><span class="op" id="4854718">(</span><span class="ident" id="4854719">offset</span>&nbsp;<span class="ident" id="4854726">int64</span><span class="op" id="4854731">,</span>&nbsp;<span class="ident" id="4854733">whence</span>&nbsp;<span class="builtintype" id="4854740">int</span><span class="op" id="4854743">)</span>&nbsp;<span class="op" id="4854745">(</span><span class="ident" id="4854746">int64</span><span class="op" id="4854751">,</span>&nbsp;<span class="builtintype" id="4854753">error</span><span class="op" id="4854758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4854761">Stat</span><span class="op" id="4854765">(</span><span class="op" id="4854766">)</span>&nbsp;<span class="op" id="4854768">(</span><span class="ident" id="4854769">os</span><span class="op" id="4854771">.</span><span class="ident" id="4854772">FileInfo</span><span class="op" id="4854780">,</span>&nbsp;<span class="builtintype" id="4854782">error</span><span class="op" id="4854787">)</span><br>
<span class="lineno"></span><span class="op" id="4854789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="4854792">func</span>&nbsp;<span class="ident" id="4854797">dirList</span><span class="op" id="4854804">(</span><span class="ident" id="4854805">w</span>&nbsp;<span class="ident" id="4854807">ResponseWriter</span><span class="op" id="4854821">,</span>&nbsp;<span class="ident" id="4854823">f</span>&nbsp;<span class="ident" id="4854825">File</span><span class="op" id="4854829">)</span>&nbsp;<span class="op" id="4854831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4854834">w</span><span class="op" id="4854835">.</span><span class="ident" id="4854836">Header</span><span class="op" id="4854842">(</span><span class="op" id="4854843">)</span><span class="op" id="4854844">.</span><span class="ident" id="4854845">Set</span><span class="op" id="4854848">(</span><span class="string" id="4854849">&#34;Content-Type&#34;</span><span class="op" id="4854863">,</span>&nbsp;<span class="string" id="4854865">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="4854891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4854894">fmt</span><span class="op" id="4854897">.</span><span class="ident" id="4854898">Fprintf</span><span class="op" id="4854905">(</span><span class="ident" id="4854906">w</span><span class="op" id="4854907">,</span>&nbsp;<span class="string" id="4854909">&#34;&lt;pre&gt;\n&#34;</span><span class="op" id="4854918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4854921">for</span>&nbsp;<span class="op" id="4854925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4854929">dirs</span><span class="op" id="4854933">,</span>&nbsp;<span class="ident" id="4854935">err</span>&nbsp;<span class="op" id="4854939">:=</span>&nbsp;<span class="ident" id="4854942">f</span><span class="op" id="4854943">.</span><span class="ident" id="4854944">Readdir</span><span class="op" id="4854951">(</span><span class="num" id="4854952">100</span><span class="op" id="4854955">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4854959">if</span>&nbsp;<span class="ident" id="4854962">err</span>&nbsp;<span class="op" id="4854966">!=</span>&nbsp;<span class="ident" id="4854969">nil</span>&nbsp;<span class="op" id="4854973">||</span>&nbsp;<span class="builtinfunc" id="4854976">len</span><span class="op" id="4854979">(</span><span class="ident" id="4854980">dirs</span><span class="op" id="4854984">)</span>&nbsp;<span class="op" id="4854986">==</span>&nbsp;<span class="num" id="4854989">0</span>&nbsp;<span class="op" id="4854991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4854996">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4855004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4855008">for</span>&nbsp;<span class="ident" id="4855012">_</span><span class="op" id="4855013">,</span>&nbsp;<span class="ident" id="4855015">d</span>&nbsp;<span class="op" id="4855017">:=</span>&nbsp;<span class="keyword" id="4855020">range</span>&nbsp;<span class="ident" id="4855026">dirs</span>&nbsp;<span class="op" id="4855031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4855036">name</span>&nbsp;<span class="op" id="4855041">:=</span>&nbsp;<span class="ident" id="4855044">d</span><span class="op" id="4855045">.</span><span class="ident" id="4855046">Name</span><span class="op" id="4855050">(</span><span class="op" id="4855051">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4855056">if</span>&nbsp;<span class="ident" id="4855059">d</span><span class="op" id="4855060">.</span><span class="ident" id="4855061">IsDir</span><span class="op" id="4855066">(</span><span class="op" id="4855067">)</span>&nbsp;<span class="op" id="4855069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4855075">name</span>&nbsp;<span class="op" id="4855080">+=</span>&nbsp;<span class="string" id="4855083">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4855090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4855095">//&nbsp;name&nbsp;may&nbsp;contain&nbsp;&#39;?&#39;&nbsp;or&nbsp;&#39;#&#39;,&nbsp;which&nbsp;must&nbsp;be&nbsp;escaped&nbsp;to&nbsp;remain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4855162">//&nbsp;part&nbsp;of&nbsp;the&nbsp;URL&nbsp;path,&nbsp;and&nbsp;not&nbsp;indicate&nbsp;the&nbsp;start&nbsp;of&nbsp;a&nbsp;query</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4855228">//&nbsp;string&nbsp;or&nbsp;fragment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4855254">url</span>&nbsp;<span class="op" id="4855258">:=</span>&nbsp;<span class="ident" id="4855261">url</span><span class="op" id="4855264">.</span><span class="ident" id="4855265">URL</span><span class="op" id="4855268">{</span><span class="ident" id="4855269">Path</span><span class="op" id="4855273">:</span>&nbsp;<span class="ident" id="4855275">name</span><span class="op" id="4855279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4855284">fmt</span><span class="op" id="4855287">.</span><span class="ident" id="4855288">Fprintf</span><span class="op" id="4855295">(</span><span class="ident" id="4855296">w</span><span class="op" id="4855297">,</span>&nbsp;<span class="string" id="4855299">&#34;&lt;a&nbsp;href=\&#34;%s\&#34;&gt;%s&lt;/a&gt;\n&#34;</span><span class="op" id="4855324">,</span>&nbsp;<span class="ident" id="4855326">url</span><span class="op" id="4855329">.</span><span class="ident" id="4855330">String</span><span class="op" id="4855336">(</span><span class="op" id="4855337">)</span><span class="op" id="4855338">,</span>&nbsp;<span class="ident" id="4855340">htmlReplacer</span><span class="op" id="4855352">.</span><span class="ident" id="4855353">Replace</span><span class="op" id="4855360">(</span><span class="ident" id="4855361">name</span><span class="op" id="4855365">)</span><span class="op" id="4855366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4855370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4855373">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4855376">fmt</span><span class="op" id="4855379">.</span><span class="ident" id="4855380">Fprintf</span><span class="op" id="4855387">(</span><span class="ident" id="4855388">w</span><span class="op" id="4855389">,</span>&nbsp;<span class="string" id="4855391">&#34;&lt;/pre&gt;\n&#34;</span><span class="op" id="4855401">)</span><br>
<span class="lineno"></span><span class="op" id="4855403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4855406">//&nbsp;ServeContent&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;using&nbsp;the&nbsp;content&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4855470">//&nbsp;provided&nbsp;ReadSeeker.&nbsp;&nbsp;The&nbsp;main&nbsp;benefit&nbsp;of&nbsp;ServeContent&nbsp;over&nbsp;io.Copy</span><br>
<span class="lineno">95</span><span class="comment" id="4855541">//&nbsp;is&nbsp;that&nbsp;it&nbsp;handles&nbsp;Range&nbsp;requests&nbsp;properly,&nbsp;sets&nbsp;the&nbsp;MIME&nbsp;type,&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4855612">//&nbsp;handles&nbsp;If-Modified-Since&nbsp;requests.</span><br>
<span class="lineno"></span><span class="comment" id="4855651">//</span><br>
<span class="lineno"></span><span class="comment" id="4855654">//&nbsp;If&nbsp;the&nbsp;response&#39;s&nbsp;Content-Type&nbsp;header&nbsp;is&nbsp;not&nbsp;set,&nbsp;ServeContent</span><br>
<span class="lineno"></span><span class="comment" id="4855720">//&nbsp;first&nbsp;tries&nbsp;to&nbsp;deduce&nbsp;the&nbsp;type&nbsp;from&nbsp;name&#39;s&nbsp;file&nbsp;extension&nbsp;and,</span><br>
<span class="lineno">100</span><span class="comment" id="4855786">//&nbsp;if&nbsp;that&nbsp;fails,&nbsp;falls&nbsp;back&nbsp;to&nbsp;reading&nbsp;the&nbsp;first&nbsp;block&nbsp;of&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="4855857">//&nbsp;and&nbsp;passing&nbsp;it&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span><span class="comment" id="4855897">//&nbsp;The&nbsp;name&nbsp;is&nbsp;otherwise&nbsp;unused;&nbsp;in&nbsp;particular&nbsp;it&nbsp;can&nbsp;be&nbsp;empty&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4855967">//&nbsp;never&nbsp;sent&nbsp;in&nbsp;the&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="4855998">//</span><br>
<span class="lineno">105</span><span class="comment" id="4856001">//&nbsp;If&nbsp;modtime&nbsp;is&nbsp;not&nbsp;the&nbsp;zero&nbsp;time,&nbsp;ServeContent&nbsp;includes&nbsp;it&nbsp;in&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4856067">//&nbsp;Last-Modified&nbsp;header&nbsp;in&nbsp;the&nbsp;response.&nbsp;&nbsp;If&nbsp;the&nbsp;request&nbsp;includes&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="4856136">//&nbsp;If-Modified-Since&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;modtime&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span><span class="comment" id="4856201">//&nbsp;whether&nbsp;the&nbsp;content&nbsp;needs&nbsp;to&nbsp;be&nbsp;sent&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span><span class="comment" id="4856249">//</span><br>
<span class="lineno">110</span><span class="comment" id="4856252">//&nbsp;The&nbsp;content&#39;s&nbsp;Seek&nbsp;method&nbsp;must&nbsp;work:&nbsp;ServeContent&nbsp;uses</span><br>
<span class="lineno"></span><span class="comment" id="4856310">//&nbsp;a&nbsp;seek&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;content&nbsp;to&nbsp;determine&nbsp;its&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment" id="4856369">//</span><br>
<span class="lineno"></span><span class="comment" id="4856372">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;has&nbsp;set&nbsp;w&#39;s&nbsp;ETag&nbsp;header,&nbsp;ServeContent&nbsp;uses&nbsp;it&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4856438">//&nbsp;handle&nbsp;requests&nbsp;using&nbsp;If-Range&nbsp;and&nbsp;If-None-Match.</span><br>
<span class="lineno">115</span><span class="comment" id="4856491">//</span><br>
<span class="lineno"></span><span class="comment" id="4856494">//&nbsp;Note&nbsp;that&nbsp;*os.File&nbsp;implements&nbsp;the&nbsp;io.ReadSeeker&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="4856556">func</span>&nbsp;<span class="ident" id="4856561">ServeContent</span><span class="op" id="4856573">(</span><span class="ident" id="4856574">w</span>&nbsp;<span class="ident" id="4856576">ResponseWriter</span><span class="op" id="4856590">,</span>&nbsp;<span class="ident" id="4856592">req</span>&nbsp;<span class="op" id="4856596">*</span><span class="ident" id="4856597">Request</span><span class="op" id="4856604">,</span>&nbsp;<span class="ident" id="4856606">name</span>&nbsp;<span class="builtintype" id="4856611">string</span><span class="op" id="4856617">,</span>&nbsp;<span class="ident" id="4856619">modtime</span>&nbsp;<span class="ident" id="4856627">time</span><span class="op" id="4856631">.</span><span class="ident" id="4856632">Time</span><span class="op" id="4856636">,</span>&nbsp;<span class="ident" id="4856638">content</span>&nbsp;<span class="ident" id="4856646">io</span><span class="op" id="4856648">.</span><span class="ident" id="4856649">ReadSeeker</span><span class="op" id="4856659">)</span>&nbsp;<span class="op" id="4856661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4856664">sizeFunc</span>&nbsp;<span class="op" id="4856673">:=</span>&nbsp;<span class="keyword" id="4856676">func</span><span class="op" id="4856680">(</span><span class="op" id="4856681">)</span>&nbsp;<span class="op" id="4856683">(</span><span class="ident" id="4856684">int64</span><span class="op" id="4856689">,</span>&nbsp;<span class="builtintype" id="4856691">error</span><span class="op" id="4856696">)</span>&nbsp;<span class="op" id="4856698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4856702">size</span><span class="op" id="4856706">,</span>&nbsp;<span class="ident" id="4856708">err</span>&nbsp;<span class="op" id="4856712">:=</span>&nbsp;<span class="ident" id="4856715">content</span><span class="op" id="4856722">.</span><span class="ident" id="4856723">Seek</span><span class="op" id="4856727">(</span><span class="num" id="4856728">0</span><span class="op" id="4856729">,</span>&nbsp;<span class="ident" id="4856731">os</span><span class="op" id="4856733">.</span><span class="ident" id="4856734">SEEK_END</span><span class="op" id="4856742">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4856746">if</span>&nbsp;<span class="ident" id="4856749">err</span>&nbsp;<span class="op" id="4856753">!=</span>&nbsp;<span class="ident" id="4856756">nil</span>&nbsp;<span class="op" id="4856760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4856765">return</span>&nbsp;<span class="num" id="4856772">0</span><span class="op" id="4856773">,</span>&nbsp;<span class="ident" id="4856775">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4856787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4856791">_</span><span class="op" id="4856792">,</span>&nbsp;<span class="ident" id="4856794">err</span>&nbsp;<span class="op" id="4856798">=</span>&nbsp;<span class="ident" id="4856800">content</span><span class="op" id="4856807">.</span><span class="ident" id="4856808">Seek</span><span class="op" id="4856812">(</span><span class="num" id="4856813">0</span><span class="op" id="4856814">,</span>&nbsp;<span class="ident" id="4856816">os</span><span class="op" id="4856818">.</span><span class="ident" id="4856819">SEEK_SET</span><span class="op" id="4856827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4856831">if</span>&nbsp;<span class="ident" id="4856834">err</span>&nbsp;<span class="op" id="4856838">!=</span>&nbsp;<span class="ident" id="4856841">nil</span>&nbsp;<span class="op" id="4856845">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4856850">return</span>&nbsp;<span class="num" id="4856857">0</span><span class="op" id="4856858">,</span>&nbsp;<span class="ident" id="4856860">errSeeker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4856872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4856876">return</span>&nbsp;<span class="ident" id="4856883">size</span><span class="op" id="4856887">,</span>&nbsp;<span class="ident" id="4856889">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4856894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4856897">serveContent</span><span class="op" id="4856909">(</span><span class="ident" id="4856910">w</span><span class="op" id="4856911">,</span>&nbsp;<span class="ident" id="4856913">req</span><span class="op" id="4856916">,</span>&nbsp;<span class="ident" id="4856918">name</span><span class="op" id="4856922">,</span>&nbsp;<span class="ident" id="4856924">modtime</span><span class="op" id="4856931">,</span>&nbsp;<span class="ident" id="4856933">sizeFunc</span><span class="op" id="4856941">,</span>&nbsp;<span class="ident" id="4856943">content</span><span class="op" id="4856950">)</span><br>
<span class="lineno">130</span><span class="op" id="4856952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4856955">//&nbsp;errSeeker&nbsp;is&nbsp;returned&nbsp;by&nbsp;ServeContent&#39;s&nbsp;sizeFunc&nbsp;when&nbsp;the&nbsp;content</span><br>
<span class="lineno"></span><span class="comment" id="4857024">//&nbsp;doesn&#39;t&nbsp;seek&nbsp;properly.&nbsp;The&nbsp;underlying&nbsp;Seeker&#39;s&nbsp;error&nbsp;text&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="4857091">//&nbsp;included&nbsp;in&nbsp;the&nbsp;sizeFunc&nbsp;reply&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;sent&nbsp;over&nbsp;HTTP&nbsp;to&nbsp;end</span><br>
<span class="lineno">135</span><span class="comment" id="4857159">//&nbsp;users.</span><br>
<span class="lineno"></span><span class="keyword" id="4857169">var</span>&nbsp;<span class="ident" id="4857173">errSeeker</span>&nbsp;<span class="op" id="4857183">=</span>&nbsp;<span class="ident" id="4857185">errors</span><span class="op" id="4857191">.</span><span class="ident" id="4857192">New</span><span class="op" id="4857195">(</span><span class="string" id="4857196">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="4857215">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4857218">//&nbsp;if&nbsp;name&nbsp;is&nbsp;empty,&nbsp;filename&nbsp;is&nbsp;unknown.&nbsp;(used&nbsp;for&nbsp;mime&nbsp;type,&nbsp;before&nbsp;sniffing)</span><br>
<span class="lineno"></span><span class="comment" id="4857298">//&nbsp;if&nbsp;modtime.IsZero(),&nbsp;modtime&nbsp;is&nbsp;unknown.</span><br>
<span class="lineno">140</span><span class="comment" id="4857342">//&nbsp;content&nbsp;must&nbsp;be&nbsp;seeked&nbsp;to&nbsp;the&nbsp;beginning&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="4857398">//&nbsp;The&nbsp;sizeFunc&nbsp;is&nbsp;called&nbsp;at&nbsp;most&nbsp;once.&nbsp;Its&nbsp;error,&nbsp;if&nbsp;any,&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="4857487">func</span>&nbsp;<span class="ident" id="4857492">serveContent</span><span class="op" id="4857504">(</span><span class="ident" id="4857505">w</span>&nbsp;<span class="ident" id="4857507">ResponseWriter</span><span class="op" id="4857521">,</span>&nbsp;<span class="ident" id="4857523">r</span>&nbsp;<span class="op" id="4857525">*</span><span class="ident" id="4857526">Request</span><span class="op" id="4857533">,</span>&nbsp;<span class="ident" id="4857535">name</span>&nbsp;<span class="builtintype" id="4857540">string</span><span class="op" id="4857546">,</span>&nbsp;<span class="ident" id="4857548">modtime</span>&nbsp;<span class="ident" id="4857556">time</span><span class="op" id="4857560">.</span><span class="ident" id="4857561">Time</span><span class="op" id="4857565">,</span>&nbsp;<span class="ident" id="4857567">sizeFunc</span>&nbsp;<span class="keyword" id="4857576">func</span><span class="op" id="4857580">(</span><span class="op" id="4857581">)</span>&nbsp;<span class="op" id="4857583">(</span><span class="ident" id="4857584">int64</span><span class="op" id="4857589">,</span>&nbsp;<span class="builtintype" id="4857591">error</span><span class="op" id="4857596">)</span><span class="op" id="4857597">,</span>&nbsp;<span class="ident" id="4857599">content</span>&nbsp;<span class="ident" id="4857607">io</span><span class="op" id="4857609">.</span><span class="ident" id="4857610">ReadSeeker</span><span class="op" id="4857620">)</span>&nbsp;<span class="op" id="4857622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4857625">if</span>&nbsp;<span class="ident" id="4857628">checkLastModified</span><span class="op" id="4857645">(</span><span class="ident" id="4857646">w</span><span class="op" id="4857647">,</span>&nbsp;<span class="ident" id="4857649">r</span><span class="op" id="4857650">,</span>&nbsp;<span class="ident" id="4857652">modtime</span><span class="op" id="4857659">)</span>&nbsp;<span class="op" id="4857661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4857665">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4857673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4857676">rangeReq</span><span class="op" id="4857684">,</span>&nbsp;<span class="ident" id="4857686">done</span>&nbsp;<span class="op" id="4857691">:=</span>&nbsp;<span class="ident" id="4857694">checkETag</span><span class="op" id="4857703">(</span><span class="ident" id="4857704">w</span><span class="op" id="4857705">,</span>&nbsp;<span class="ident" id="4857707">r</span><span class="op" id="4857708">,</span>&nbsp;<span class="ident" id="4857710">modtime</span><span class="op" id="4857717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4857720">if</span>&nbsp;<span class="ident" id="4857723">done</span>&nbsp;<span class="op" id="4857728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4857732">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4857740">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4857744">code</span>&nbsp;<span class="op" id="4857749">:=</span>&nbsp;<span class="ident" id="4857752">StatusOK</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4857763">//&nbsp;If&nbsp;Content-Type&nbsp;isn&#39;t&nbsp;set,&nbsp;use&nbsp;the&nbsp;file&#39;s&nbsp;extension&nbsp;to&nbsp;find&nbsp;it,&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4857835">//&nbsp;if&nbsp;the&nbsp;Content-Type&nbsp;is&nbsp;unset&nbsp;explicitly,&nbsp;do&nbsp;not&nbsp;sniff&nbsp;the&nbsp;type.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4857903">ctypes</span><span class="op" id="4857909">,</span>&nbsp;<span class="ident" id="4857911">haveType</span>&nbsp;<span class="op" id="4857920">:=</span>&nbsp;<span class="ident" id="4857923">w</span><span class="op" id="4857924">.</span><span class="ident" id="4857925">Header</span><span class="op" id="4857931">(</span><span class="op" id="4857932">)</span><span class="op" id="4857933">[</span><span class="string" id="4857934">&#34;Content-Type&#34;</span><span class="op" id="4857948">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4857951">var</span>&nbsp;<span class="ident" id="4857955">ctype</span>&nbsp;<span class="builtintype" id="4857961">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4857969">if</span>&nbsp;<span class="op" id="4857972">!</span><span class="ident" id="4857973">haveType</span>&nbsp;<span class="op" id="4857982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4857986">ctype</span>&nbsp;<span class="op" id="4857992">=</span>&nbsp;<span class="ident" id="4857994">mime</span><span class="op" id="4857998">.</span><span class="ident" id="4857999">TypeByExtension</span><span class="op" id="4858014">(</span><span class="ident" id="4858015">filepath</span><span class="op" id="4858023">.</span><span class="ident" id="4858024">Ext</span><span class="op" id="4858027">(</span><span class="ident" id="4858028">name</span><span class="op" id="4858032">)</span><span class="op" id="4858033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858037">if</span>&nbsp;<span class="ident" id="4858040">ctype</span>&nbsp;<span class="op" id="4858046">==</span>&nbsp;<span class="string" id="4858049">&#34;&#34;</span>&nbsp;<span class="op" id="4858052">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4858057">//&nbsp;read&nbsp;a&nbsp;chunk&nbsp;to&nbsp;decide&nbsp;between&nbsp;utf-8&nbsp;text&nbsp;and&nbsp;binary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858116">var</span>&nbsp;<span class="ident" id="4858120">buf</span>&nbsp;<span class="op" id="4858124">[</span><span class="ident" id="4858125">sniffLen</span><span class="op" id="4858133">]</span><span class="builtintype" id="4858134">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858142">n</span><span class="op" id="4858143">,</span>&nbsp;<span class="ident" id="4858145">_</span>&nbsp;<span class="op" id="4858147">:=</span>&nbsp;<span class="ident" id="4858150">io</span><span class="op" id="4858152">.</span><span class="ident" id="4858153">ReadFull</span><span class="op" id="4858161">(</span><span class="ident" id="4858162">content</span><span class="op" id="4858169">,</span>&nbsp;<span class="ident" id="4858171">buf</span><span class="op" id="4858174">[</span><span class="op" id="4858175">:</span><span class="op" id="4858176">]</span><span class="op" id="4858177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858182">ctype</span>&nbsp;<span class="op" id="4858188">=</span>&nbsp;<span class="ident" id="4858190">DetectContentType</span><span class="op" id="4858207">(</span><span class="ident" id="4858208">buf</span><span class="op" id="4858211">[</span><span class="op" id="4858212">:</span><span class="ident" id="4858213">n</span><span class="op" id="4858214">]</span><span class="op" id="4858215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858220">_</span><span class="op" id="4858221">,</span>&nbsp;<span class="ident" id="4858223">err</span>&nbsp;<span class="op" id="4858227">:=</span>&nbsp;<span class="ident" id="4858230">content</span><span class="op" id="4858237">.</span><span class="ident" id="4858238">Seek</span><span class="op" id="4858242">(</span><span class="num" id="4858243">0</span><span class="op" id="4858244">,</span>&nbsp;<span class="ident" id="4858246">os</span><span class="op" id="4858248">.</span><span class="ident" id="4858249">SEEK_SET</span><span class="op" id="4858257">)</span>&nbsp;<span class="comment" id="4858259">//&nbsp;rewind&nbsp;to&nbsp;output&nbsp;whole&nbsp;file</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858293">if</span>&nbsp;<span class="ident" id="4858296">err</span>&nbsp;<span class="op" id="4858300">!=</span>&nbsp;<span class="ident" id="4858303">nil</span>&nbsp;<span class="op" id="4858307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858313">Error</span><span class="op" id="4858318">(</span><span class="ident" id="4858319">w</span><span class="op" id="4858320">,</span>&nbsp;<span class="string" id="4858322">&#34;seeker&nbsp;can&#39;t&nbsp;seek&#34;</span><span class="op" id="4858341">,</span>&nbsp;<span class="ident" id="4858343">StatusInternalServerError</span><span class="op" id="4858368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858374">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4858384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4858388">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858392">w</span><span class="op" id="4858393">.</span><span class="ident" id="4858394">Header</span><span class="op" id="4858400">(</span><span class="op" id="4858401">)</span><span class="op" id="4858402">.</span><span class="ident" id="4858403">Set</span><span class="op" id="4858406">(</span><span class="string" id="4858407">&#34;Content-Type&#34;</span><span class="op" id="4858421">,</span>&nbsp;<span class="ident" id="4858423">ctype</span><span class="op" id="4858428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4858431">}</span>&nbsp;<span class="keyword" id="4858433">else</span>&nbsp;<span class="keyword" id="4858438">if</span>&nbsp;<span class="builtinfunc" id="4858441">len</span><span class="op" id="4858444">(</span><span class="ident" id="4858445">ctypes</span><span class="op" id="4858451">)</span>&nbsp;<span class="op" id="4858453">&gt;</span>&nbsp;<span class="num" id="4858455">0</span>&nbsp;<span class="op" id="4858457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858461">ctype</span>&nbsp;<span class="op" id="4858467">=</span>&nbsp;<span class="ident" id="4858469">ctypes</span><span class="op" id="4858475">[</span><span class="num" id="4858476">0</span><span class="op" id="4858477">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4858480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858484">size</span><span class="op" id="4858488">,</span>&nbsp;<span class="ident" id="4858490">err</span>&nbsp;<span class="op" id="4858494">:=</span>&nbsp;<span class="ident" id="4858497">sizeFunc</span><span class="op" id="4858505">(</span><span class="op" id="4858506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858509">if</span>&nbsp;<span class="ident" id="4858512">err</span>&nbsp;<span class="op" id="4858516">!=</span>&nbsp;<span class="ident" id="4858519">nil</span>&nbsp;<span class="op" id="4858523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858527">Error</span><span class="op" id="4858532">(</span><span class="ident" id="4858533">w</span><span class="op" id="4858534">,</span>&nbsp;<span class="ident" id="4858536">err</span><span class="op" id="4858539">.</span><span class="ident" id="4858540">Error</span><span class="op" id="4858545">(</span><span class="op" id="4858546">)</span><span class="op" id="4858547">,</span>&nbsp;<span class="ident" id="4858549">StatusInternalServerError</span><span class="op" id="4858574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858578">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4858586">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4858590">//&nbsp;handle&nbsp;Content-Range&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858623">sendSize</span>&nbsp;<span class="op" id="4858632">:=</span>&nbsp;<span class="ident" id="4858635">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858641">var</span>&nbsp;<span class="ident" id="4858645">sendContent</span>&nbsp;<span class="ident" id="4858657">io</span><span class="op" id="4858659">.</span><span class="ident" id="4858660">Reader</span>&nbsp;<span class="op" id="4858667">=</span>&nbsp;<span class="ident" id="4858669">content</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858678">if</span>&nbsp;<span class="ident" id="4858681">size</span>&nbsp;<span class="op" id="4858686">&gt;=</span>&nbsp;<span class="num" id="4858689">0</span>&nbsp;<span class="op" id="4858691">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858695">ranges</span><span class="op" id="4858701">,</span>&nbsp;<span class="ident" id="4858703">err</span>&nbsp;<span class="op" id="4858707">:=</span>&nbsp;<span class="ident" id="4858710">parseRange</span><span class="op" id="4858720">(</span><span class="ident" id="4858721">rangeReq</span><span class="op" id="4858729">,</span>&nbsp;<span class="ident" id="4858731">size</span><span class="op" id="4858735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858739">if</span>&nbsp;<span class="ident" id="4858742">err</span>&nbsp;<span class="op" id="4858746">!=</span>&nbsp;<span class="ident" id="4858749">nil</span>&nbsp;<span class="op" id="4858753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858758">Error</span><span class="op" id="4858763">(</span><span class="ident" id="4858764">w</span><span class="op" id="4858765">,</span>&nbsp;<span class="ident" id="4858767">err</span><span class="op" id="4858770">.</span><span class="ident" id="4858771">Error</span><span class="op" id="4858776">(</span><span class="op" id="4858777">)</span><span class="op" id="4858778">,</span>&nbsp;<span class="ident" id="4858780">StatusRequestedRangeNotSatisfiable</span><span class="op" id="4858814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858819">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4858828">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858832">if</span>&nbsp;<span class="ident" id="4858835">sumRangesSize</span><span class="op" id="4858848">(</span><span class="ident" id="4858849">ranges</span><span class="op" id="4858855">)</span>&nbsp;<span class="op" id="4858857">&gt;</span>&nbsp;<span class="ident" id="4858859">size</span>&nbsp;<span class="op" id="4858864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4858869">//&nbsp;The&nbsp;total&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;all&nbsp;the&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4858919">//&nbsp;is&nbsp;larger&nbsp;than&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;file&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4858964">//&nbsp;itself,&nbsp;so&nbsp;this&nbsp;is&nbsp;probably&nbsp;an&nbsp;attack,&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4859014">//&nbsp;dumb&nbsp;client.&nbsp;&nbsp;Ignore&nbsp;the&nbsp;range&nbsp;request.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859060">ranges</span>&nbsp;<span class="op" id="4859067">=</span>&nbsp;<span class="ident" id="4859069">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4859075">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4859079">switch</span>&nbsp;<span class="op" id="4859086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4859090">case</span>&nbsp;<span class="builtinfunc" id="4859095">len</span><span class="op" id="4859098">(</span><span class="ident" id="4859099">ranges</span><span class="op" id="4859105">)</span>&nbsp;<span class="op" id="4859107">==</span>&nbsp;<span class="num" id="4859110">1</span><span class="op" id="4859111">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4859116">//&nbsp;RFC&nbsp;2616,&nbsp;Section&nbsp;14.16:</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4859147">//&nbsp;&#34;When&nbsp;an&nbsp;HTTP&nbsp;message&nbsp;includes&nbsp;the&nbsp;content&nbsp;of&nbsp;a&nbsp;single</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4859208">//&nbsp;range&nbsp;(for&nbsp;example,&nbsp;a&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4859264">//&nbsp;single&nbsp;range,&nbsp;or&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;set&nbsp;of&nbsp;ranges</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4859320">//&nbsp;that&nbsp;overlap&nbsp;without&nbsp;any&nbsp;holes),&nbsp;this&nbsp;content&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4859375">//&nbsp;transmitted&nbsp;with&nbsp;a&nbsp;Content-Range&nbsp;header,&nbsp;and&nbsp;a</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4859428">//&nbsp;Content-Length&nbsp;header&nbsp;showing&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4859484">//&nbsp;actually&nbsp;transferred.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4859512">//&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4859522">//&nbsp;A&nbsp;response&nbsp;to&nbsp;a&nbsp;request&nbsp;for&nbsp;a&nbsp;single&nbsp;range&nbsp;MUST&nbsp;NOT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4859580">//&nbsp;be&nbsp;sent&nbsp;using&nbsp;the&nbsp;multipart/byteranges&nbsp;media&nbsp;type.&#34;</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859638">ra</span>&nbsp;<span class="op" id="4859641">:=</span>&nbsp;<span class="ident" id="4859644">ranges</span><span class="op" id="4859650">[</span><span class="num" id="4859651">0</span><span class="op" id="4859652">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4859657">if</span>&nbsp;<span class="ident" id="4859660">_</span><span class="op" id="4859661">,</span>&nbsp;<span class="ident" id="4859663">err</span>&nbsp;<span class="op" id="4859667">:=</span>&nbsp;<span class="ident" id="4859670">content</span><span class="op" id="4859677">.</span><span class="ident" id="4859678">Seek</span><span class="op" id="4859682">(</span><span class="ident" id="4859683">ra</span><span class="op" id="4859685">.</span><span class="ident" id="4859686">start</span><span class="op" id="4859691">,</span>&nbsp;<span class="ident" id="4859693">os</span><span class="op" id="4859695">.</span><span class="ident" id="4859696">SEEK_SET</span><span class="op" id="4859704">)</span><span class="op" id="4859705">;</span>&nbsp;<span class="ident" id="4859707">err</span>&nbsp;<span class="op" id="4859711">!=</span>&nbsp;<span class="ident" id="4859714">nil</span>&nbsp;<span class="op" id="4859718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859724">Error</span><span class="op" id="4859729">(</span><span class="ident" id="4859730">w</span><span class="op" id="4859731">,</span>&nbsp;<span class="ident" id="4859733">err</span><span class="op" id="4859736">.</span><span class="ident" id="4859737">Error</span><span class="op" id="4859742">(</span><span class="op" id="4859743">)</span><span class="op" id="4859744">,</span>&nbsp;<span class="ident" id="4859746">StatusRequestedRangeNotSatisfiable</span><span class="op" id="4859780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4859786">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4859796">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859801">sendSize</span>&nbsp;<span class="op" id="4859810">=</span>&nbsp;<span class="ident" id="4859812">ra</span><span class="op" id="4859814">.</span><span class="ident" id="4859815">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859825">code</span>&nbsp;<span class="op" id="4859830">=</span>&nbsp;<span class="ident" id="4859832">StatusPartialContent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859856">w</span><span class="op" id="4859857">.</span><span class="ident" id="4859858">Header</span><span class="op" id="4859864">(</span><span class="op" id="4859865">)</span><span class="op" id="4859866">.</span><span class="ident" id="4859867">Set</span><span class="op" id="4859870">(</span><span class="string" id="4859871">&#34;Content-Range&#34;</span><span class="op" id="4859886">,</span>&nbsp;<span class="ident" id="4859888">ra</span><span class="op" id="4859890">.</span><span class="ident" id="4859891">contentRange</span><span class="op" id="4859903">(</span><span class="ident" id="4859904">size</span><span class="op" id="4859908">)</span><span class="op" id="4859909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4859913">case</span>&nbsp;<span class="builtinfunc" id="4859918">len</span><span class="op" id="4859921">(</span><span class="ident" id="4859922">ranges</span><span class="op" id="4859928">)</span>&nbsp;<span class="op" id="4859930">&gt;</span>&nbsp;<span class="num" id="4859932">1</span><span class="op" id="4859933">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859938">sendSize</span>&nbsp;<span class="op" id="4859947">=</span>&nbsp;<span class="ident" id="4859949">rangesMIMESize</span><span class="op" id="4859963">(</span><span class="ident" id="4859964">ranges</span><span class="op" id="4859970">,</span>&nbsp;<span class="ident" id="4859972">ctype</span><span class="op" id="4859977">,</span>&nbsp;<span class="ident" id="4859979">size</span><span class="op" id="4859983">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859988">code</span>&nbsp;<span class="op" id="4859993">=</span>&nbsp;<span class="ident" id="4859995">StatusPartialContent</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860020">pr</span><span class="op" id="4860022">,</span>&nbsp;<span class="ident" id="4860024">pw</span>&nbsp;<span class="op" id="4860027">:=</span>&nbsp;<span class="ident" id="4860030">io</span><span class="op" id="4860032">.</span><span class="ident" id="4860033">Pipe</span><span class="op" id="4860037">(</span><span class="op" id="4860038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860043">mw</span>&nbsp;<span class="op" id="4860046">:=</span>&nbsp;<span class="ident" id="4860049">multipart</span><span class="op" id="4860058">.</span><span class="ident" id="4860059">NewWriter</span><span class="op" id="4860068">(</span><span class="ident" id="4860069">pw</span><span class="op" id="4860071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860076">w</span><span class="op" id="4860077">.</span><span class="ident" id="4860078">Header</span><span class="op" id="4860084">(</span><span class="op" id="4860085">)</span><span class="op" id="4860086">.</span><span class="ident" id="4860087">Set</span><span class="op" id="4860090">(</span><span class="string" id="4860091">&#34;Content-Type&#34;</span><span class="op" id="4860105">,</span>&nbsp;<span class="string" id="4860107">&#34;multipart/byteranges;&nbsp;boundary=&#34;</span><span class="op" id="4860140">+</span><span class="ident" id="4860141">mw</span><span class="op" id="4860143">.</span><span class="ident" id="4860144">Boundary</span><span class="op" id="4860152">(</span><span class="op" id="4860153">)</span><span class="op" id="4860154">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860159">sendContent</span>&nbsp;<span class="op" id="4860171">=</span>&nbsp;<span class="ident" id="4860173">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860179">defer</span>&nbsp;<span class="ident" id="4860185">pr</span><span class="op" id="4860187">.</span><span class="ident" id="4860188">Close</span><span class="op" id="4860193">(</span><span class="op" id="4860194">)</span>&nbsp;<span class="comment" id="4860196">//&nbsp;cause&nbsp;writing&nbsp;goroutine&nbsp;to&nbsp;fail&nbsp;and&nbsp;exit&nbsp;if&nbsp;CopyN&nbsp;doesn&#39;t&nbsp;finish.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860268">go</span>&nbsp;<span class="keyword" id="4860271">func</span><span class="op" id="4860275">(</span><span class="op" id="4860276">)</span>&nbsp;<span class="op" id="4860278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860284">for</span>&nbsp;<span class="ident" id="4860288">_</span><span class="op" id="4860289">,</span>&nbsp;<span class="ident" id="4860291">ra</span>&nbsp;<span class="op" id="4860294">:=</span>&nbsp;<span class="keyword" id="4860297">range</span>&nbsp;<span class="ident" id="4860303">ranges</span>&nbsp;<span class="op" id="4860310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860317">part</span><span class="op" id="4860321">,</span>&nbsp;<span class="ident" id="4860323">err</span>&nbsp;<span class="op" id="4860327">:=</span>&nbsp;<span class="ident" id="4860330">mw</span><span class="op" id="4860332">.</span><span class="ident" id="4860333">CreatePart</span><span class="op" id="4860343">(</span><span class="ident" id="4860344">ra</span><span class="op" id="4860346">.</span><span class="ident" id="4860347">mimeHeader</span><span class="op" id="4860357">(</span><span class="ident" id="4860358">ctype</span><span class="op" id="4860363">,</span>&nbsp;<span class="ident" id="4860365">size</span><span class="op" id="4860369">)</span><span class="op" id="4860370">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860377">if</span>&nbsp;<span class="ident" id="4860380">err</span>&nbsp;<span class="op" id="4860384">!=</span>&nbsp;<span class="ident" id="4860387">nil</span>&nbsp;<span class="op" id="4860391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860399">pw</span><span class="op" id="4860401">.</span><span class="ident" id="4860402">CloseWithError</span><span class="op" id="4860416">(</span><span class="ident" id="4860417">err</span><span class="op" id="4860420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860428">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4860440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860447">if</span>&nbsp;<span class="ident" id="4860450">_</span><span class="op" id="4860451">,</span>&nbsp;<span class="ident" id="4860453">err</span>&nbsp;<span class="op" id="4860457">:=</span>&nbsp;<span class="ident" id="4860460">content</span><span class="op" id="4860467">.</span><span class="ident" id="4860468">Seek</span><span class="op" id="4860472">(</span><span class="ident" id="4860473">ra</span><span class="op" id="4860475">.</span><span class="ident" id="4860476">start</span><span class="op" id="4860481">,</span>&nbsp;<span class="ident" id="4860483">os</span><span class="op" id="4860485">.</span><span class="ident" id="4860486">SEEK_SET</span><span class="op" id="4860494">)</span><span class="op" id="4860495">;</span>&nbsp;<span class="ident" id="4860497">err</span>&nbsp;<span class="op" id="4860501">!=</span>&nbsp;<span class="ident" id="4860504">nil</span>&nbsp;<span class="op" id="4860508">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860516">pw</span><span class="op" id="4860518">.</span><span class="ident" id="4860519">CloseWithError</span><span class="op" id="4860533">(</span><span class="ident" id="4860534">err</span><span class="op" id="4860537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860545">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4860557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860564">if</span>&nbsp;<span class="ident" id="4860567">_</span><span class="op" id="4860568">,</span>&nbsp;<span class="ident" id="4860570">err</span>&nbsp;<span class="op" id="4860574">:=</span>&nbsp;<span class="ident" id="4860577">io</span><span class="op" id="4860579">.</span><span class="ident" id="4860580">CopyN</span><span class="op" id="4860585">(</span><span class="ident" id="4860586">part</span><span class="op" id="4860590">,</span>&nbsp;<span class="ident" id="4860592">content</span><span class="op" id="4860599">,</span>&nbsp;<span class="ident" id="4860601">ra</span><span class="op" id="4860603">.</span><span class="ident" id="4860604">length</span><span class="op" id="4860610">)</span><span class="op" id="4860611">;</span>&nbsp;<span class="ident" id="4860613">err</span>&nbsp;<span class="op" id="4860617">!=</span>&nbsp;<span class="ident" id="4860620">nil</span>&nbsp;<span class="op" id="4860624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860632">pw</span><span class="op" id="4860634">.</span><span class="ident" id="4860635">CloseWithError</span><span class="op" id="4860649">(</span><span class="ident" id="4860650">err</span><span class="op" id="4860653">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860661">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4860673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4860679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860685">mw</span><span class="op" id="4860687">.</span><span class="ident" id="4860688">Close</span><span class="op" id="4860693">(</span><span class="op" id="4860694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860700">pw</span><span class="op" id="4860702">.</span><span class="ident" id="4860703">Close</span><span class="op" id="4860708">(</span><span class="op" id="4860709">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4860714">}</span><span class="op" id="4860715">(</span><span class="op" id="4860716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4860720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860725">w</span><span class="op" id="4860726">.</span><span class="ident" id="4860727">Header</span><span class="op" id="4860733">(</span><span class="op" id="4860734">)</span><span class="op" id="4860735">.</span><span class="ident" id="4860736">Set</span><span class="op" id="4860739">(</span><span class="string" id="4860740">&#34;Accept-Ranges&#34;</span><span class="op" id="4860755">,</span>&nbsp;<span class="string" id="4860757">&#34;bytes&#34;</span><span class="op" id="4860764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860768">if</span>&nbsp;<span class="ident" id="4860771">w</span><span class="op" id="4860772">.</span><span class="ident" id="4860773">Header</span><span class="op" id="4860779">(</span><span class="op" id="4860780">)</span><span class="op" id="4860781">.</span><span class="ident" id="4860782">Get</span><span class="op" id="4860785">(</span><span class="string" id="4860786">&#34;Content-Encoding&#34;</span><span class="op" id="4860804">)</span>&nbsp;<span class="op" id="4860806">==</span>&nbsp;<span class="string" id="4860809">&#34;&#34;</span>&nbsp;<span class="op" id="4860812">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860817">w</span><span class="op" id="4860818">.</span><span class="ident" id="4860819">Header</span><span class="op" id="4860825">(</span><span class="op" id="4860826">)</span><span class="op" id="4860827">.</span><span class="ident" id="4860828">Set</span><span class="op" id="4860831">(</span><span class="string" id="4860832">&#34;Content-Length&#34;</span><span class="op" id="4860848">,</span>&nbsp;<span class="ident" id="4860850">strconv</span><span class="op" id="4860857">.</span><span class="ident" id="4860858">FormatInt</span><span class="op" id="4860867">(</span><span class="ident" id="4860868">sendSize</span><span class="op" id="4860876">,</span>&nbsp;<span class="num" id="4860878">10</span><span class="op" id="4860880">)</span><span class="op" id="4860881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4860885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4860888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860892">w</span><span class="op" id="4860893">.</span><span class="ident" id="4860894">WriteHeader</span><span class="op" id="4860905">(</span><span class="ident" id="4860906">code</span><span class="op" id="4860910">)</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4860914">if</span>&nbsp;<span class="ident" id="4860917">r</span><span class="op" id="4860918">.</span><span class="ident" id="4860919">Method</span>&nbsp;<span class="op" id="4860926">!=</span>&nbsp;<span class="string" id="4860929">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4860936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4860940">io</span><span class="op" id="4860942">.</span><span class="ident" id="4860943">CopyN</span><span class="op" id="4860948">(</span><span class="ident" id="4860949">w</span><span class="op" id="4860950">,</span>&nbsp;<span class="ident" id="4860952">sendContent</span><span class="op" id="4860963">,</span>&nbsp;<span class="ident" id="4860965">sendSize</span><span class="op" id="4860973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4860976">}</span><br>
<span class="lineno"></span><span class="op" id="4860978">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="4860981">//&nbsp;modtime&nbsp;is&nbsp;the&nbsp;modification&nbsp;time&nbsp;of&nbsp;the&nbsp;resource&nbsp;to&nbsp;be&nbsp;served,&nbsp;or&nbsp;IsZero().</span><br>
<span class="lineno"></span><span class="comment" id="4861060">//&nbsp;return&nbsp;value&nbsp;is&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;complete.</span><br>
<span class="lineno"></span><span class="keyword" id="4861117">func</span>&nbsp;<span class="ident" id="4861122">checkLastModified</span><span class="op" id="4861139">(</span><span class="ident" id="4861140">w</span>&nbsp;<span class="ident" id="4861142">ResponseWriter</span><span class="op" id="4861156">,</span>&nbsp;<span class="ident" id="4861158">r</span>&nbsp;<span class="op" id="4861160">*</span><span class="ident" id="4861161">Request</span><span class="op" id="4861168">,</span>&nbsp;<span class="ident" id="4861170">modtime</span>&nbsp;<span class="ident" id="4861178">time</span><span class="op" id="4861182">.</span><span class="ident" id="4861183">Time</span><span class="op" id="4861187">)</span>&nbsp;<span class="builtintype" id="4861189">bool</span>&nbsp;<span class="op" id="4861194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861197">if</span>&nbsp;<span class="ident" id="4861200">modtime</span><span class="op" id="4861207">.</span><span class="ident" id="4861208">IsZero</span><span class="op" id="4861214">(</span><span class="op" id="4861215">)</span>&nbsp;<span class="op" id="4861217">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861221">return</span>&nbsp;<span class="builtintype" id="4861228">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4861235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4861239">//&nbsp;The&nbsp;Date-Modified&nbsp;header&nbsp;truncates&nbsp;sub-second&nbsp;precision,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4861303">//&nbsp;use&nbsp;mtime&nbsp;&lt;&nbsp;t+1s&nbsp;instead&nbsp;of&nbsp;mtime&nbsp;&lt;=&nbsp;t&nbsp;to&nbsp;check&nbsp;for&nbsp;unmodified.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861371">if</span>&nbsp;<span class="ident" id="4861374">t</span><span class="op" id="4861375">,</span>&nbsp;<span class="ident" id="4861377">err</span>&nbsp;<span class="op" id="4861381">:=</span>&nbsp;<span class="ident" id="4861384">time</span><span class="op" id="4861388">.</span><span class="ident" id="4861389">Parse</span><span class="op" id="4861394">(</span><span class="ident" id="4861395">TimeFormat</span><span class="op" id="4861405">,</span>&nbsp;<span class="ident" id="4861407">r</span><span class="op" id="4861408">.</span><span class="ident" id="4861409">Header</span><span class="op" id="4861415">.</span><span class="ident" id="4861416">Get</span><span class="op" id="4861419">(</span><span class="string" id="4861420">&#34;If-Modified-Since&#34;</span><span class="op" id="4861439">)</span><span class="op" id="4861440">)</span><span class="op" id="4861441">;</span>&nbsp;<span class="ident" id="4861443">err</span>&nbsp;<span class="op" id="4861447">==</span>&nbsp;<span class="ident" id="4861450">nil</span>&nbsp;<span class="op" id="4861454">&amp;&amp;</span>&nbsp;<span class="ident" id="4861457">modtime</span><span class="op" id="4861464">.</span><span class="ident" id="4861465">Before</span><span class="op" id="4861471">(</span><span class="ident" id="4861472">t</span><span class="op" id="4861473">.</span><span class="ident" id="4861474">Add</span><span class="op" id="4861477">(</span><span class="num" id="4861478">1</span><span class="op" id="4861479">*</span><span class="ident" id="4861480">time</span><span class="op" id="4861484">.</span><span class="ident" id="4861485">Second</span><span class="op" id="4861491">)</span><span class="op" id="4861492">)</span>&nbsp;<span class="op" id="4861494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861498">h</span>&nbsp;<span class="op" id="4861500">:=</span>&nbsp;<span class="ident" id="4861503">w</span><span class="op" id="4861504">.</span><span class="ident" id="4861505">Header</span><span class="op" id="4861511">(</span><span class="op" id="4861512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4861516">delete</span><span class="op" id="4861522">(</span><span class="ident" id="4861523">h</span><span class="op" id="4861524">,</span>&nbsp;<span class="string" id="4861526">&#34;Content-Type&#34;</span><span class="op" id="4861540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4861544">delete</span><span class="op" id="4861550">(</span><span class="ident" id="4861551">h</span><span class="op" id="4861552">,</span>&nbsp;<span class="string" id="4861554">&#34;Content-Length&#34;</span><span class="op" id="4861570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861574">w</span><span class="op" id="4861575">.</span><span class="ident" id="4861576">WriteHeader</span><span class="op" id="4861587">(</span><span class="ident" id="4861588">StatusNotModified</span><span class="op" id="4861605">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861609">return</span>&nbsp;<span class="builtintype" id="4861616">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4861622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861625">w</span><span class="op" id="4861626">.</span><span class="ident" id="4861627">Header</span><span class="op" id="4861633">(</span><span class="op" id="4861634">)</span><span class="op" id="4861635">.</span><span class="ident" id="4861636">Set</span><span class="op" id="4861639">(</span><span class="string" id="4861640">&#34;Last-Modified&#34;</span><span class="op" id="4861655">,</span>&nbsp;<span class="ident" id="4861657">modtime</span><span class="op" id="4861664">.</span><span class="ident" id="4861665">UTC</span><span class="op" id="4861668">(</span><span class="op" id="4861669">)</span><span class="op" id="4861670">.</span><span class="ident" id="4861671">Format</span><span class="op" id="4861677">(</span><span class="ident" id="4861678">TimeFormat</span><span class="op" id="4861688">)</span><span class="op" id="4861689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861692">return</span>&nbsp;<span class="builtintype" id="4861699">false</span><br>
<span class="lineno"></span><span class="op" id="4861705">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="4861708">//&nbsp;checkETag&nbsp;implements&nbsp;If-None-Match&nbsp;and&nbsp;If-Range&nbsp;checks.</span><br>
<span class="lineno"></span><span class="comment" id="4861767">//</span><br>
<span class="lineno"></span><span class="comment" id="4861770">//&nbsp;The&nbsp;ETag&nbsp;or&nbsp;modtime&nbsp;must&nbsp;have&nbsp;been&nbsp;previously&nbsp;set&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4861830">//&nbsp;ResponseWriter&#39;s&nbsp;headers.&nbsp;&nbsp;The&nbsp;modtime&nbsp;is&nbsp;only&nbsp;compared&nbsp;at&nbsp;second</span><br>
<span class="lineno">285</span><span class="comment" id="4861899">//&nbsp;granularity&nbsp;and&nbsp;may&nbsp;be&nbsp;the&nbsp;zero&nbsp;value&nbsp;to&nbsp;mean&nbsp;unknown.</span><br>
<span class="lineno"></span><span class="comment" id="4861957">//</span><br>
<span class="lineno"></span><span class="comment" id="4861960">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;effective&nbsp;request&nbsp;&#34;Range&#34;&nbsp;header&nbsp;to&nbsp;use&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4862031">//&nbsp;whether&nbsp;this&nbsp;request&nbsp;is&nbsp;now&nbsp;considered&nbsp;done.</span><br>
<span class="lineno"></span><span class="keyword" id="4862079">func</span>&nbsp;<span class="ident" id="4862084">checkETag</span><span class="op" id="4862093">(</span><span class="ident" id="4862094">w</span>&nbsp;<span class="ident" id="4862096">ResponseWriter</span><span class="op" id="4862110">,</span>&nbsp;<span class="ident" id="4862112">r</span>&nbsp;<span class="op" id="4862114">*</span><span class="ident" id="4862115">Request</span><span class="op" id="4862122">,</span>&nbsp;<span class="ident" id="4862124">modtime</span>&nbsp;<span class="ident" id="4862132">time</span><span class="op" id="4862136">.</span><span class="ident" id="4862137">Time</span><span class="op" id="4862141">)</span>&nbsp;<span class="op" id="4862143">(</span><span class="ident" id="4862144">rangeReq</span>&nbsp;<span class="builtintype" id="4862153">string</span><span class="op" id="4862159">,</span>&nbsp;<span class="ident" id="4862161">done</span>&nbsp;<span class="builtintype" id="4862166">bool</span><span class="op" id="4862170">)</span>&nbsp;<span class="op" id="4862172">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4862175">etag</span>&nbsp;<span class="op" id="4862180">:=</span>&nbsp;<span class="ident" id="4862183">w</span><span class="op" id="4862184">.</span><span class="ident" id="4862185">Header</span><span class="op" id="4862191">(</span><span class="op" id="4862192">)</span><span class="op" id="4862193">.</span><span class="ident" id="4862194">get</span><span class="op" id="4862197">(</span><span class="string" id="4862198">&#34;Etag&#34;</span><span class="op" id="4862204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4862207">rangeReq</span>&nbsp;<span class="op" id="4862216">=</span>&nbsp;<span class="ident" id="4862218">r</span><span class="op" id="4862219">.</span><span class="ident" id="4862220">Header</span><span class="op" id="4862226">.</span><span class="ident" id="4862227">get</span><span class="op" id="4862230">(</span><span class="string" id="4862231">&#34;Range&#34;</span><span class="op" id="4862238">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4862242">//&nbsp;Invalidate&nbsp;the&nbsp;range&nbsp;request&nbsp;if&nbsp;the&nbsp;entity&nbsp;doesn&#39;t&nbsp;match&nbsp;the&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4862311">//&nbsp;the&nbsp;client&nbsp;was&nbsp;expecting.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4862341">//&nbsp;&#34;If-Range:&nbsp;version&#34;&nbsp;means&nbsp;&#34;ignore&nbsp;the&nbsp;Range:&nbsp;header&nbsp;unless&nbsp;version&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4862424">//&nbsp;current&nbsp;file.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4862443">//&nbsp;We&nbsp;only&nbsp;support&nbsp;ETag&nbsp;versions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4862478">//&nbsp;The&nbsp;caller&nbsp;must&nbsp;have&nbsp;set&nbsp;the&nbsp;ETag&nbsp;on&nbsp;the&nbsp;response&nbsp;already.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4862541">if</span>&nbsp;<span class="ident" id="4862544">ir</span>&nbsp;<span class="op" id="4862547">:=</span>&nbsp;<span class="ident" id="4862550">r</span><span class="op" id="4862551">.</span><span class="ident" id="4862552">Header</span><span class="op" id="4862558">.</span><span class="ident" id="4862559">get</span><span class="op" id="4862562">(</span><span class="string" id="4862563">&#34;If-Range&#34;</span><span class="op" id="4862573">)</span><span class="op" id="4862574">;</span>&nbsp;<span class="ident" id="4862576">ir</span>&nbsp;<span class="op" id="4862579">!=</span>&nbsp;<span class="string" id="4862582">&#34;&#34;</span>&nbsp;<span class="op" id="4862585">&amp;&amp;</span>&nbsp;<span class="ident" id="4862588">ir</span>&nbsp;<span class="op" id="4862591">!=</span>&nbsp;<span class="ident" id="4862594">etag</span>&nbsp;<span class="op" id="4862599">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4862603">//&nbsp;The&nbsp;If-Range&nbsp;value&nbsp;is&nbsp;typically&nbsp;the&nbsp;ETag&nbsp;value,&nbsp;but&nbsp;it&nbsp;may&nbsp;also&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4862675">//&nbsp;the&nbsp;modtime&nbsp;date.&nbsp;See&nbsp;golang.org/issue/8367.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4862725">timeMatches</span>&nbsp;<span class="op" id="4862737">:=</span>&nbsp;<span class="builtintype" id="4862740">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4862748">if</span>&nbsp;<span class="op" id="4862751">!</span><span class="ident" id="4862752">modtime</span><span class="op" id="4862759">.</span><span class="ident" id="4862760">IsZero</span><span class="op" id="4862766">(</span><span class="op" id="4862767">)</span>&nbsp;<span class="op" id="4862769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4862774">if</span>&nbsp;<span class="ident" id="4862777">t</span><span class="op" id="4862778">,</span>&nbsp;<span class="ident" id="4862780">err</span>&nbsp;<span class="op" id="4862784">:=</span>&nbsp;<span class="ident" id="4862787">ParseTime</span><span class="op" id="4862796">(</span><span class="ident" id="4862797">ir</span><span class="op" id="4862799">)</span><span class="op" id="4862800">;</span>&nbsp;<span class="ident" id="4862802">err</span>&nbsp;<span class="op" id="4862806">==</span>&nbsp;<span class="ident" id="4862809">nil</span>&nbsp;<span class="op" id="4862813">&amp;&amp;</span>&nbsp;<span class="ident" id="4862816">t</span><span class="op" id="4862817">.</span><span class="ident" id="4862818">Unix</span><span class="op" id="4862822">(</span><span class="op" id="4862823">)</span>&nbsp;<span class="op" id="4862825">==</span>&nbsp;<span class="ident" id="4862828">modtime</span><span class="op" id="4862835">.</span><span class="ident" id="4862836">Unix</span><span class="op" id="4862840">(</span><span class="op" id="4862841">)</span>&nbsp;<span class="op" id="4862843">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4862849">timeMatches</span>&nbsp;<span class="op" id="4862861">=</span>&nbsp;<span class="builtintype" id="4862863">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4862871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4862875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4862879">if</span>&nbsp;<span class="op" id="4862882">!</span><span class="ident" id="4862883">timeMatches</span>&nbsp;<span class="op" id="4862895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4862900">rangeReq</span>&nbsp;<span class="op" id="4862909">=</span>&nbsp;<span class="string" id="4862911">&#34;&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4862916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4862919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4862923">if</span>&nbsp;<span class="ident" id="4862926">inm</span>&nbsp;<span class="op" id="4862930">:=</span>&nbsp;<span class="ident" id="4862933">r</span><span class="op" id="4862934">.</span><span class="ident" id="4862935">Header</span><span class="op" id="4862941">.</span><span class="ident" id="4862942">get</span><span class="op" id="4862945">(</span><span class="string" id="4862946">&#34;If-None-Match&#34;</span><span class="op" id="4862961">)</span><span class="op" id="4862962">;</span>&nbsp;<span class="ident" id="4862964">inm</span>&nbsp;<span class="op" id="4862968">!=</span>&nbsp;<span class="string" id="4862971">&#34;&#34;</span>&nbsp;<span class="op" id="4862974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4862978">//&nbsp;Must&nbsp;know&nbsp;ETag.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4862999">if</span>&nbsp;<span class="ident" id="4863002">etag</span>&nbsp;<span class="op" id="4863007">==</span>&nbsp;<span class="string" id="4863010">&#34;&#34;</span>&nbsp;<span class="op" id="4863013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4863018">return</span>&nbsp;<span class="ident" id="4863025">rangeReq</span><span class="op" id="4863033">,</span>&nbsp;<span class="builtintype" id="4863035">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4863043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4863048">//&nbsp;TODO(bradfitz):&nbsp;non-GET/HEAD&nbsp;requests&nbsp;require&nbsp;more&nbsp;work:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4863110">//&nbsp;sending&nbsp;a&nbsp;different&nbsp;status&nbsp;code&nbsp;on&nbsp;matches,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4863163">//&nbsp;also&nbsp;can&#39;t&nbsp;use&nbsp;weak&nbsp;cache&nbsp;validators&nbsp;(those&nbsp;with&nbsp;a&nbsp;&#34;W/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4863223">//&nbsp;prefix).&nbsp;&nbsp;But&nbsp;most&nbsp;users&nbsp;of&nbsp;ServeContent&nbsp;will&nbsp;be&nbsp;using</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4863283">//&nbsp;it&nbsp;on&nbsp;GET&nbsp;or&nbsp;HEAD,&nbsp;so&nbsp;only&nbsp;support&nbsp;those&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4863338">if</span>&nbsp;<span class="ident" id="4863341">r</span><span class="op" id="4863342">.</span><span class="ident" id="4863343">Method</span>&nbsp;<span class="op" id="4863350">!=</span>&nbsp;<span class="string" id="4863353">&#34;GET&#34;</span>&nbsp;<span class="op" id="4863359">&amp;&amp;</span>&nbsp;<span class="ident" id="4863362">r</span><span class="op" id="4863363">.</span><span class="ident" id="4863364">Method</span>&nbsp;<span class="op" id="4863371">!=</span>&nbsp;<span class="string" id="4863374">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4863381">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4863386">return</span>&nbsp;<span class="ident" id="4863393">rangeReq</span><span class="op" id="4863401">,</span>&nbsp;<span class="builtintype" id="4863403">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4863411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4863416">//&nbsp;TODO(bradfitz):&nbsp;deal&nbsp;with&nbsp;comma-separated&nbsp;or&nbsp;multiple-valued</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4863482">//&nbsp;list&nbsp;of&nbsp;If-None-match&nbsp;values.&nbsp;&nbsp;For&nbsp;now&nbsp;just&nbsp;handle&nbsp;the&nbsp;common</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4863549">//&nbsp;case&nbsp;of&nbsp;a&nbsp;single&nbsp;item.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4863577">if</span>&nbsp;<span class="ident" id="4863580">inm</span>&nbsp;<span class="op" id="4863584">==</span>&nbsp;<span class="ident" id="4863587">etag</span>&nbsp;<span class="op" id="4863592">||</span>&nbsp;<span class="ident" id="4863595">inm</span>&nbsp;<span class="op" id="4863599">==</span>&nbsp;<span class="string" id="4863602">&#34;*&#34;</span>&nbsp;<span class="op" id="4863606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4863611">h</span>&nbsp;<span class="op" id="4863613">:=</span>&nbsp;<span class="ident" id="4863616">w</span><span class="op" id="4863617">.</span><span class="ident" id="4863618">Header</span><span class="op" id="4863624">(</span><span class="op" id="4863625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4863630">delete</span><span class="op" id="4863636">(</span><span class="ident" id="4863637">h</span><span class="op" id="4863638">,</span>&nbsp;<span class="string" id="4863640">&#34;Content-Type&#34;</span><span class="op" id="4863654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4863659">delete</span><span class="op" id="4863665">(</span><span class="ident" id="4863666">h</span><span class="op" id="4863667">,</span>&nbsp;<span class="string" id="4863669">&#34;Content-Length&#34;</span><span class="op" id="4863685">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4863690">w</span><span class="op" id="4863691">.</span><span class="ident" id="4863692">WriteHeader</span><span class="op" id="4863703">(</span><span class="ident" id="4863704">StatusNotModified</span><span class="op" id="4863721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4863726">return</span>&nbsp;<span class="string" id="4863733">&#34;&#34;</span><span class="op" id="4863735">,</span>&nbsp;<span class="builtintype" id="4863737">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4863744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4863747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4863750">return</span>&nbsp;<span class="ident" id="4863757">rangeReq</span><span class="op" id="4863765">,</span>&nbsp;<span class="builtintype" id="4863767">false</span><br>
<span class="lineno">340</span><span class="op" id="4863773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4863776">//&nbsp;name&nbsp;is&nbsp;&#39;/&#39;-separated,&nbsp;not&nbsp;filepath.Separator.</span><br>
<span class="lineno"></span><span class="keyword" id="4863826">func</span>&nbsp;<span class="ident" id="4863831">serveFile</span><span class="op" id="4863840">(</span><span class="ident" id="4863841">w</span>&nbsp;<span class="ident" id="4863843">ResponseWriter</span><span class="op" id="4863857">,</span>&nbsp;<span class="ident" id="4863859">r</span>&nbsp;<span class="op" id="4863861">*</span><span class="ident" id="4863862">Request</span><span class="op" id="4863869">,</span>&nbsp;<span class="ident" id="4863871">fs</span>&nbsp;<span class="ident" id="4863874">FileSystem</span><span class="op" id="4863884">,</span>&nbsp;<span class="ident" id="4863886">name</span>&nbsp;<span class="builtintype" id="4863891">string</span><span class="op" id="4863897">,</span>&nbsp;<span class="ident" id="4863899">redirect</span>&nbsp;<span class="builtintype" id="4863908">bool</span><span class="op" id="4863912">)</span>&nbsp;<span class="op" id="4863914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4863917">const</span>&nbsp;<span class="ident" id="4863923">indexPage</span>&nbsp;<span class="op" id="4863933">=</span>&nbsp;<span class="string" id="4863935">&#34;/index.html&#34;</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4863951">//&nbsp;redirect&nbsp;.../index.html&nbsp;to&nbsp;.../</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4863987">//&nbsp;can&#39;t&nbsp;use&nbsp;Redirect()&nbsp;because&nbsp;that&nbsp;would&nbsp;make&nbsp;the&nbsp;path&nbsp;absolute,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4864055">//&nbsp;which&nbsp;would&nbsp;be&nbsp;a&nbsp;problem&nbsp;running&nbsp;under&nbsp;StripPrefix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864110">if</span>&nbsp;<span class="ident" id="4864113">strings</span><span class="op" id="4864120">.</span><span class="ident" id="4864121">HasSuffix</span><span class="op" id="4864130">(</span><span class="ident" id="4864131">r</span><span class="op" id="4864132">.</span><span class="ident" id="4864133">URL</span><span class="op" id="4864136">.</span><span class="ident" id="4864137">Path</span><span class="op" id="4864141">,</span>&nbsp;<span class="ident" id="4864143">indexPage</span><span class="op" id="4864152">)</span>&nbsp;<span class="op" id="4864154">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4864158">localRedirect</span><span class="op" id="4864171">(</span><span class="ident" id="4864172">w</span><span class="op" id="4864173">,</span>&nbsp;<span class="ident" id="4864175">r</span><span class="op" id="4864176">,</span>&nbsp;<span class="string" id="4864178">&#34;./&#34;</span><span class="op" id="4864182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864186">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4864194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4864198">f</span><span class="op" id="4864199">,</span>&nbsp;<span class="ident" id="4864201">err</span>&nbsp;<span class="op" id="4864205">:=</span>&nbsp;<span class="ident" id="4864208">fs</span><span class="op" id="4864210">.</span><span class="ident" id="4864211">Open</span><span class="op" id="4864215">(</span><span class="ident" id="4864216">name</span><span class="op" id="4864220">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864223">if</span>&nbsp;<span class="ident" id="4864226">err</span>&nbsp;<span class="op" id="4864230">!=</span>&nbsp;<span class="ident" id="4864233">nil</span>&nbsp;<span class="op" id="4864237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4864241">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4864272">NotFound</span><span class="op" id="4864280">(</span><span class="ident" id="4864281">w</span><span class="op" id="4864282">,</span>&nbsp;<span class="ident" id="4864284">r</span><span class="op" id="4864285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864289">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4864297">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864300">defer</span>&nbsp;<span class="ident" id="4864306">f</span><span class="op" id="4864307">.</span><span class="ident" id="4864308">Close</span><span class="op" id="4864313">(</span><span class="op" id="4864314">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4864318">d</span><span class="op" id="4864319">,</span>&nbsp;<span class="ident" id="4864321">err1</span>&nbsp;<span class="op" id="4864326">:=</span>&nbsp;<span class="ident" id="4864329">f</span><span class="op" id="4864330">.</span><span class="ident" id="4864331">Stat</span><span class="op" id="4864335">(</span><span class="op" id="4864336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864339">if</span>&nbsp;<span class="ident" id="4864342">err1</span>&nbsp;<span class="op" id="4864347">!=</span>&nbsp;<span class="ident" id="4864350">nil</span>&nbsp;<span class="op" id="4864354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4864358">//&nbsp;TODO&nbsp;expose&nbsp;actual&nbsp;error?</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4864389">NotFound</span><span class="op" id="4864397">(</span><span class="ident" id="4864398">w</span><span class="op" id="4864399">,</span>&nbsp;<span class="ident" id="4864401">r</span><span class="op" id="4864402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864406">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4864414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864418">if</span>&nbsp;<span class="ident" id="4864421">redirect</span>&nbsp;<span class="op" id="4864430">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4864434">//&nbsp;redirect&nbsp;to&nbsp;canonical&nbsp;path:&nbsp;/&nbsp;at&nbsp;end&nbsp;of&nbsp;directory&nbsp;url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4864493">//&nbsp;r.URL.Path&nbsp;always&nbsp;begins&nbsp;with&nbsp;/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4864530">url</span>&nbsp;<span class="op" id="4864534">:=</span>&nbsp;<span class="ident" id="4864537">r</span><span class="op" id="4864538">.</span><span class="ident" id="4864539">URL</span><span class="op" id="4864542">.</span><span class="ident" id="4864543">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864550">if</span>&nbsp;<span class="ident" id="4864553">d</span><span class="op" id="4864554">.</span><span class="ident" id="4864555">IsDir</span><span class="op" id="4864560">(</span><span class="op" id="4864561">)</span>&nbsp;<span class="op" id="4864563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864568">if</span>&nbsp;<span class="ident" id="4864571">url</span><span class="op" id="4864574">[</span><span class="builtinfunc" id="4864575">len</span><span class="op" id="4864578">(</span><span class="ident" id="4864579">url</span><span class="op" id="4864582">)</span><span class="op" id="4864583">-</span><span class="num" id="4864584">1</span><span class="op" id="4864585">]</span>&nbsp;<span class="op" id="4864587">!=</span>&nbsp;<span class="string" id="4864590">&#39;/&#39;</span>&nbsp;<span class="op" id="4864594">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4864600">localRedirect</span><span class="op" id="4864613">(</span><span class="ident" id="4864614">w</span><span class="op" id="4864615">,</span>&nbsp;<span class="ident" id="4864617">r</span><span class="op" id="4864618">,</span>&nbsp;<span class="ident" id="4864620">path</span><span class="op" id="4864624">.</span><span class="ident" id="4864625">Base</span><span class="op" id="4864629">(</span><span class="ident" id="4864630">url</span><span class="op" id="4864633">)</span><span class="op" id="4864634">+</span><span class="string" id="4864635">&#34;/&#34;</span><span class="op" id="4864638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864644">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4864654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4864658">}</span>&nbsp;<span class="keyword" id="4864660">else</span>&nbsp;<span class="op" id="4864665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864670">if</span>&nbsp;<span class="ident" id="4864673">url</span><span class="op" id="4864676">[</span><span class="builtinfunc" id="4864677">len</span><span class="op" id="4864680">(</span><span class="ident" id="4864681">url</span><span class="op" id="4864684">)</span><span class="op" id="4864685">-</span><span class="num" id="4864686">1</span><span class="op" id="4864687">]</span>&nbsp;<span class="op" id="4864689">==</span>&nbsp;<span class="string" id="4864692">&#39;/&#39;</span>&nbsp;<span class="op" id="4864696">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4864702">localRedirect</span><span class="op" id="4864715">(</span><span class="ident" id="4864716">w</span><span class="op" id="4864717">,</span>&nbsp;<span class="ident" id="4864719">r</span><span class="op" id="4864720">,</span>&nbsp;<span class="string" id="4864722">&#34;../&#34;</span><span class="op" id="4864727">+</span><span class="ident" id="4864728">path</span><span class="op" id="4864732">.</span><span class="ident" id="4864733">Base</span><span class="op" id="4864737">(</span><span class="ident" id="4864738">url</span><span class="op" id="4864741">)</span><span class="op" id="4864742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864748">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4864758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4864762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4864765">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4864769">//&nbsp;use&nbsp;contents&nbsp;of&nbsp;index.html&nbsp;for&nbsp;directory,&nbsp;if&nbsp;present</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864826">if</span>&nbsp;<span class="ident" id="4864829">d</span><span class="op" id="4864830">.</span><span class="ident" id="4864831">IsDir</span><span class="op" id="4864836">(</span><span class="op" id="4864837">)</span>&nbsp;<span class="op" id="4864839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4864843">index</span>&nbsp;<span class="op" id="4864849">:=</span>&nbsp;<span class="ident" id="4864852">strings</span><span class="op" id="4864859">.</span><span class="ident" id="4864860">TrimSuffix</span><span class="op" id="4864870">(</span><span class="ident" id="4864871">name</span><span class="op" id="4864875">,</span>&nbsp;<span class="string" id="4864877">&#34;/&#34;</span><span class="op" id="4864880">)</span>&nbsp;<span class="op" id="4864882">+</span>&nbsp;<span class="ident" id="4864884">indexPage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4864896">ff</span><span class="op" id="4864898">,</span>&nbsp;<span class="ident" id="4864900">err</span>&nbsp;<span class="op" id="4864904">:=</span>&nbsp;<span class="ident" id="4864907">fs</span><span class="op" id="4864909">.</span><span class="ident" id="4864910">Open</span><span class="op" id="4864914">(</span><span class="ident" id="4864915">index</span><span class="op" id="4864920">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864924">if</span>&nbsp;<span class="ident" id="4864927">err</span>&nbsp;<span class="op" id="4864931">==</span>&nbsp;<span class="ident" id="4864934">nil</span>&nbsp;<span class="op" id="4864938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864943">defer</span>&nbsp;<span class="ident" id="4864949">ff</span><span class="op" id="4864951">.</span><span class="ident" id="4864952">Close</span><span class="op" id="4864957">(</span><span class="op" id="4864958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4864963">dd</span><span class="op" id="4864965">,</span>&nbsp;<span class="ident" id="4864967">err</span>&nbsp;<span class="op" id="4864971">:=</span>&nbsp;<span class="ident" id="4864974">ff</span><span class="op" id="4864976">.</span><span class="ident" id="4864977">Stat</span><span class="op" id="4864981">(</span><span class="op" id="4864982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864987">if</span>&nbsp;<span class="ident" id="4864990">err</span>&nbsp;<span class="op" id="4864994">==</span>&nbsp;<span class="ident" id="4864997">nil</span>&nbsp;<span class="op" id="4865001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4865007">name</span>&nbsp;<span class="op" id="4865012">=</span>&nbsp;<span class="ident" id="4865014">index</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4865024">d</span>&nbsp;<span class="op" id="4865026">=</span>&nbsp;<span class="ident" id="4865028">dd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4865035">f</span>&nbsp;<span class="op" id="4865037">=</span>&nbsp;<span class="ident" id="4865039">ff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4865045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4865049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4865052">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4865056">//&nbsp;Still&nbsp;a&nbsp;directory?&nbsp;(we&nbsp;didn&#39;t&nbsp;find&nbsp;an&nbsp;index.html&nbsp;file)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4865115">if</span>&nbsp;<span class="ident" id="4865118">d</span><span class="op" id="4865119">.</span><span class="ident" id="4865120">IsDir</span><span class="op" id="4865125">(</span><span class="op" id="4865126">)</span>&nbsp;<span class="op" id="4865128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4865132">if</span>&nbsp;<span class="ident" id="4865135">checkLastModified</span><span class="op" id="4865152">(</span><span class="ident" id="4865153">w</span><span class="op" id="4865154">,</span>&nbsp;<span class="ident" id="4865156">r</span><span class="op" id="4865157">,</span>&nbsp;<span class="ident" id="4865159">d</span><span class="op" id="4865160">.</span><span class="ident" id="4865161">ModTime</span><span class="op" id="4865168">(</span><span class="op" id="4865169">)</span><span class="op" id="4865170">)</span>&nbsp;<span class="op" id="4865172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4865177">return</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4865186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4865190">dirList</span><span class="op" id="4865197">(</span><span class="ident" id="4865198">w</span><span class="op" id="4865199">,</span>&nbsp;<span class="ident" id="4865201">f</span><span class="op" id="4865202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4865206">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4865214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4865218">//&nbsp;serveContent&nbsp;will&nbsp;check&nbsp;modification&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4865264">sizeFunc</span>&nbsp;<span class="op" id="4865273">:=</span>&nbsp;<span class="keyword" id="4865276">func</span><span class="op" id="4865280">(</span><span class="op" id="4865281">)</span>&nbsp;<span class="op" id="4865283">(</span><span class="ident" id="4865284">int64</span><span class="op" id="4865289">,</span>&nbsp;<span class="builtintype" id="4865291">error</span><span class="op" id="4865296">)</span>&nbsp;<span class="op" id="4865298">{</span>&nbsp;<span class="keyword" id="4865300">return</span>&nbsp;<span class="ident" id="4865307">d</span><span class="op" id="4865308">.</span><span class="ident" id="4865309">Size</span><span class="op" id="4865313">(</span><span class="op" id="4865314">)</span><span class="op" id="4865315">,</span>&nbsp;<span class="ident" id="4865317">nil</span>&nbsp;<span class="op" id="4865321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4865324">serveContent</span><span class="op" id="4865336">(</span><span class="ident" id="4865337">w</span><span class="op" id="4865338">,</span>&nbsp;<span class="ident" id="4865340">r</span><span class="op" id="4865341">,</span>&nbsp;<span class="ident" id="4865343">d</span><span class="op" id="4865344">.</span><span class="ident" id="4865345">Name</span><span class="op" id="4865349">(</span><span class="op" id="4865350">)</span><span class="op" id="4865351">,</span>&nbsp;<span class="ident" id="4865353">d</span><span class="op" id="4865354">.</span><span class="ident" id="4865355">ModTime</span><span class="op" id="4865362">(</span><span class="op" id="4865363">)</span><span class="op" id="4865364">,</span>&nbsp;<span class="ident" id="4865366">sizeFunc</span><span class="op" id="4865374">,</span>&nbsp;<span class="ident" id="4865376">f</span><span class="op" id="4865377">)</span><br>
<span class="lineno"></span><span class="op" id="4865379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="4865382">//&nbsp;localRedirect&nbsp;gives&nbsp;a&nbsp;Moved&nbsp;Permanently&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="4865435">//&nbsp;It&nbsp;does&nbsp;not&nbsp;convert&nbsp;relative&nbsp;paths&nbsp;to&nbsp;absolute&nbsp;paths&nbsp;like&nbsp;Redirect&nbsp;does.</span><br>
<span class="lineno"></span><span class="keyword" id="4865511">func</span>&nbsp;<span class="ident" id="4865516">localRedirect</span><span class="op" id="4865529">(</span><span class="ident" id="4865530">w</span>&nbsp;<span class="ident" id="4865532">ResponseWriter</span><span class="op" id="4865546">,</span>&nbsp;<span class="ident" id="4865548">r</span>&nbsp;<span class="op" id="4865550">*</span><span class="ident" id="4865551">Request</span><span class="op" id="4865558">,</span>&nbsp;<span class="ident" id="4865560">newPath</span>&nbsp;<span class="builtintype" id="4865568">string</span><span class="op" id="4865574">)</span>&nbsp;<span class="op" id="4865576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4865579">if</span>&nbsp;<span class="ident" id="4865582">q</span>&nbsp;<span class="op" id="4865584">:=</span>&nbsp;<span class="ident" id="4865587">r</span><span class="op" id="4865588">.</span><span class="ident" id="4865589">URL</span><span class="op" id="4865592">.</span><span class="ident" id="4865593">RawQuery</span><span class="op" id="4865601">;</span>&nbsp;<span class="ident" id="4865603">q</span>&nbsp;<span class="op" id="4865605">!=</span>&nbsp;<span class="string" id="4865608">&#34;&#34;</span>&nbsp;<span class="op" id="4865611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4865615">newPath</span>&nbsp;<span class="op" id="4865623">+=</span>&nbsp;<span class="string" id="4865626">&#34;?&#34;</span>&nbsp;<span class="op" id="4865630">+</span>&nbsp;<span class="ident" id="4865632">q</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4865635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4865638">w</span><span class="op" id="4865639">.</span><span class="ident" id="4865640">Header</span><span class="op" id="4865646">(</span><span class="op" id="4865647">)</span><span class="op" id="4865648">.</span><span class="ident" id="4865649">Set</span><span class="op" id="4865652">(</span><span class="string" id="4865653">&#34;Location&#34;</span><span class="op" id="4865663">,</span>&nbsp;<span class="ident" id="4865665">newPath</span><span class="op" id="4865672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4865675">w</span><span class="op" id="4865676">.</span><span class="ident" id="4865677">WriteHeader</span><span class="op" id="4865688">(</span><span class="ident" id="4865689">StatusMovedPermanently</span><span class="op" id="4865711">)</span><br>
<span class="lineno"></span><span class="op" id="4865713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span><span class="comment" id="4865716">//&nbsp;ServeFile&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;named&nbsp;file&nbsp;or&nbsp;directory.</span><br>
<span class="lineno"></span><span class="keyword" id="4865802">func</span>&nbsp;<span class="ident" id="4865807">ServeFile</span><span class="op" id="4865816">(</span><span class="ident" id="4865817">w</span>&nbsp;<span class="ident" id="4865819">ResponseWriter</span><span class="op" id="4865833">,</span>&nbsp;<span class="ident" id="4865835">r</span>&nbsp;<span class="op" id="4865837">*</span><span class="ident" id="4865838">Request</span><span class="op" id="4865845">,</span>&nbsp;<span class="ident" id="4865847">name</span>&nbsp;<span class="builtintype" id="4865852">string</span><span class="op" id="4865858">)</span>&nbsp;<span class="op" id="4865860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4865863">dir</span><span class="op" id="4865866">,</span>&nbsp;<span class="ident" id="4865868">file</span>&nbsp;<span class="op" id="4865873">:=</span>&nbsp;<span class="ident" id="4865876">filepath</span><span class="op" id="4865884">.</span><span class="ident" id="4865885">Split</span><span class="op" id="4865890">(</span><span class="ident" id="4865891">name</span><span class="op" id="4865895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4865898">serveFile</span><span class="op" id="4865907">(</span><span class="ident" id="4865908">w</span><span class="op" id="4865909">,</span>&nbsp;<span class="ident" id="4865911">r</span><span class="op" id="4865912">,</span>&nbsp;<span class="ident" id="4865914">Dir</span><span class="op" id="4865917">(</span><span class="ident" id="4865918">dir</span><span class="op" id="4865921">)</span><span class="op" id="4865922">,</span>&nbsp;<span class="ident" id="4865924">file</span><span class="op" id="4865928">,</span>&nbsp;<span class="builtintype" id="4865930">false</span><span class="op" id="4865935">)</span><br>
<span class="lineno"></span><span class="op" id="4865937">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="4865940">type</span>&nbsp;<span class="ident" id="4865945">fileHandler</span>&nbsp;<span class="keyword" id="4865957">struct</span>&nbsp;<span class="op" id="4865964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4865967">root</span>&nbsp;<span class="ident" id="4865972">FileSystem</span><br>
<span class="lineno"></span><span class="op" id="4865983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="comment" id="4865986">//&nbsp;FileServer&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="4866044">//&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;file&nbsp;system&nbsp;rooted&nbsp;at&nbsp;root.</span><br>
<span class="lineno"></span><span class="comment" id="4866100">//</span><br>
<span class="lineno"></span><span class="comment" id="4866103">//&nbsp;To&nbsp;use&nbsp;the&nbsp;operating&nbsp;system&#39;s&nbsp;file&nbsp;system&nbsp;implementation,</span><br>
<span class="lineno"></span><span class="comment" id="4866164">//&nbsp;use&nbsp;http.Dir:</span><br>
<span class="lineno">440</span><span class="comment" id="4866181">//</span><br>
<span class="lineno"></span><span class="comment" id="4866184">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.Handle(&#34;/&#34;,&nbsp;http.FileServer(http.Dir(&#34;/tmp&#34;)))</span><br>
<span class="lineno"></span><span class="keyword" id="4866243">func</span>&nbsp;<span class="ident" id="4866248">FileServer</span><span class="op" id="4866258">(</span><span class="ident" id="4866259">root</span>&nbsp;<span class="ident" id="4866264">FileSystem</span><span class="op" id="4866274">)</span>&nbsp;<span class="ident" id="4866276">Handler</span>&nbsp;<span class="op" id="4866284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4866287">return</span>&nbsp;<span class="op" id="4866294">&amp;</span><span class="ident" id="4866295">fileHandler</span><span class="op" id="4866306">{</span><span class="ident" id="4866307">root</span><span class="op" id="4866311">}</span><br>
<span class="lineno"></span><span class="op" id="4866313">}</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span><span class="keyword" id="4866316">func</span>&nbsp;<span class="op" id="4866321">(</span><span class="ident" id="4866322">f</span>&nbsp;<span class="op" id="4866324">*</span><span class="ident" id="4866325">fileHandler</span><span class="op" id="4866336">)</span>&nbsp;<span class="ident" id="4866338">ServeHTTP</span><span class="op" id="4866347">(</span><span class="ident" id="4866348">w</span>&nbsp;<span class="ident" id="4866350">ResponseWriter</span><span class="op" id="4866364">,</span>&nbsp;<span class="ident" id="4866366">r</span>&nbsp;<span class="op" id="4866368">*</span><span class="ident" id="4866369">Request</span><span class="op" id="4866376">)</span>&nbsp;<span class="op" id="4866378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4866381">upath</span>&nbsp;<span class="op" id="4866387">:=</span>&nbsp;<span class="ident" id="4866390">r</span><span class="op" id="4866391">.</span><span class="ident" id="4866392">URL</span><span class="op" id="4866395">.</span><span class="ident" id="4866396">Path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4866402">if</span>&nbsp;<span class="op" id="4866405">!</span><span class="ident" id="4866406">strings</span><span class="op" id="4866413">.</span><span class="ident" id="4866414">HasPrefix</span><span class="op" id="4866423">(</span><span class="ident" id="4866424">upath</span><span class="op" id="4866429">,</span>&nbsp;<span class="string" id="4866431">&#34;/&#34;</span><span class="op" id="4866434">)</span>&nbsp;<span class="op" id="4866436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4866440">upath</span>&nbsp;<span class="op" id="4866446">=</span>&nbsp;<span class="string" id="4866448">&#34;/&#34;</span>&nbsp;<span class="op" id="4866452">+</span>&nbsp;<span class="ident" id="4866454">upath</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4866462">r</span><span class="op" id="4866463">.</span><span class="ident" id="4866464">URL</span><span class="op" id="4866467">.</span><span class="ident" id="4866468">Path</span>&nbsp;<span class="op" id="4866473">=</span>&nbsp;<span class="ident" id="4866475">upath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4866482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4866485">serveFile</span><span class="op" id="4866494">(</span><span class="ident" id="4866495">w</span><span class="op" id="4866496">,</span>&nbsp;<span class="ident" id="4866498">r</span><span class="op" id="4866499">,</span>&nbsp;<span class="ident" id="4866501">f</span><span class="op" id="4866502">.</span><span class="ident" id="4866503">root</span><span class="op" id="4866507">,</span>&nbsp;<span class="ident" id="4866509">path</span><span class="op" id="4866513">.</span><span class="ident" id="4866514">Clean</span><span class="op" id="4866519">(</span><span class="ident" id="4866520">upath</span><span class="op" id="4866525">)</span><span class="op" id="4866526">,</span>&nbsp;<span class="builtintype" id="4866528">true</span><span class="op" id="4866532">)</span><br>
<span class="lineno"></span><span class="op" id="4866534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="comment" id="4866537">//&nbsp;httpRange&nbsp;specifies&nbsp;the&nbsp;byte&nbsp;range&nbsp;to&nbsp;be&nbsp;sent&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="4866601">type</span>&nbsp;<span class="ident" id="4866606">httpRange</span>&nbsp;<span class="keyword" id="4866616">struct</span>&nbsp;<span class="op" id="4866623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4866626">start</span><span class="op" id="4866631">,</span>&nbsp;<span class="ident" id="4866633">length</span>&nbsp;<span class="ident" id="4866640">int64</span><br>
<span class="lineno"></span><span class="op" id="4866646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="keyword" id="4866649">func</span>&nbsp;<span class="op" id="4866654">(</span><span class="ident" id="4866655">r</span>&nbsp;<span class="ident" id="4866657">httpRange</span><span class="op" id="4866666">)</span>&nbsp;<span class="ident" id="4866668">contentRange</span><span class="op" id="4866680">(</span><span class="ident" id="4866681">size</span>&nbsp;<span class="ident" id="4866686">int64</span><span class="op" id="4866691">)</span>&nbsp;<span class="builtintype" id="4866693">string</span>&nbsp;<span class="op" id="4866700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4866703">return</span>&nbsp;<span class="ident" id="4866710">fmt</span><span class="op" id="4866713">.</span><span class="ident" id="4866714">Sprintf</span><span class="op" id="4866721">(</span><span class="string" id="4866722">&#34;bytes&nbsp;%d-%d/%d&#34;</span><span class="op" id="4866738">,</span>&nbsp;<span class="ident" id="4866740">r</span><span class="op" id="4866741">.</span><span class="ident" id="4866742">start</span><span class="op" id="4866747">,</span>&nbsp;<span class="ident" id="4866749">r</span><span class="op" id="4866750">.</span><span class="ident" id="4866751">start</span><span class="op" id="4866756">+</span><span class="ident" id="4866757">r</span><span class="op" id="4866758">.</span><span class="ident" id="4866759">length</span><span class="op" id="4866765">-</span><span class="num" id="4866766">1</span><span class="op" id="4866767">,</span>&nbsp;<span class="ident" id="4866769">size</span><span class="op" id="4866773">)</span><br>
<span class="lineno"></span><span class="op" id="4866775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4866778">func</span>&nbsp;<span class="op" id="4866783">(</span><span class="ident" id="4866784">r</span>&nbsp;<span class="ident" id="4866786">httpRange</span><span class="op" id="4866795">)</span>&nbsp;<span class="ident" id="4866797">mimeHeader</span><span class="op" id="4866807">(</span><span class="ident" id="4866808">contentType</span>&nbsp;<span class="builtintype" id="4866820">string</span><span class="op" id="4866826">,</span>&nbsp;<span class="ident" id="4866828">size</span>&nbsp;<span class="ident" id="4866833">int64</span><span class="op" id="4866838">)</span>&nbsp;<span class="ident" id="4866840">textproto</span><span class="op" id="4866849">.</span><span class="ident" id="4866850">MIMEHeader</span>&nbsp;<span class="op" id="4866861">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4866864">return</span>&nbsp;<span class="ident" id="4866871">textproto</span><span class="op" id="4866880">.</span><span class="ident" id="4866881">MIMEHeader</span><span class="op" id="4866891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4866895">&#34;Content-Range&#34;</span><span class="op" id="4866910">:</span>&nbsp;<span class="op" id="4866912">{</span><span class="ident" id="4866913">r</span><span class="op" id="4866914">.</span><span class="ident" id="4866915">contentRange</span><span class="op" id="4866927">(</span><span class="ident" id="4866928">size</span><span class="op" id="4866932">)</span><span class="op" id="4866933">}</span><span class="op" id="4866934">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4866938">&#34;Content-Type&#34;</span><span class="op" id="4866952">:</span>&nbsp;&nbsp;<span class="op" id="4866955">{</span><span class="ident" id="4866956">contentType</span><span class="op" id="4866967">}</span><span class="op" id="4866968">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4866971">}</span><br>
<span class="lineno"></span><span class="op" id="4866973">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="comment" id="4866976">//&nbsp;parseRange&nbsp;parses&nbsp;a&nbsp;Range&nbsp;header&nbsp;string&nbsp;as&nbsp;per&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="keyword" id="4867036">func</span>&nbsp;<span class="ident" id="4867041">parseRange</span><span class="op" id="4867051">(</span><span class="ident" id="4867052">s</span>&nbsp;<span class="builtintype" id="4867054">string</span><span class="op" id="4867060">,</span>&nbsp;<span class="ident" id="4867062">size</span>&nbsp;<span class="ident" id="4867067">int64</span><span class="op" id="4867072">)</span>&nbsp;<span class="op" id="4867074">(</span><span class="op" id="4867075">[</span><span class="op" id="4867076">]</span><span class="ident" id="4867077">httpRange</span><span class="op" id="4867086">,</span>&nbsp;<span class="builtintype" id="4867088">error</span><span class="op" id="4867093">)</span>&nbsp;<span class="op" id="4867095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4867098">if</span>&nbsp;<span class="ident" id="4867101">s</span>&nbsp;<span class="op" id="4867103">==</span>&nbsp;<span class="string" id="4867106">&#34;&#34;</span>&nbsp;<span class="op" id="4867109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4867113">return</span>&nbsp;<span class="ident" id="4867120">nil</span><span class="op" id="4867123">,</span>&nbsp;<span class="ident" id="4867125">nil</span>&nbsp;<span class="comment" id="4867129">//&nbsp;header&nbsp;not&nbsp;present</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4867152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4867155">const</span>&nbsp;<span class="ident" id="4867161">b</span>&nbsp;<span class="op" id="4867163">=</span>&nbsp;<span class="string" id="4867165">&#34;bytes=&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4867175">if</span>&nbsp;<span class="op" id="4867178">!</span><span class="ident" id="4867179">strings</span><span class="op" id="4867186">.</span><span class="ident" id="4867187">HasPrefix</span><span class="op" id="4867196">(</span><span class="ident" id="4867197">s</span><span class="op" id="4867198">,</span>&nbsp;<span class="ident" id="4867200">b</span><span class="op" id="4867201">)</span>&nbsp;<span class="op" id="4867203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4867207">return</span>&nbsp;<span class="ident" id="4867214">nil</span><span class="op" id="4867217">,</span>&nbsp;<span class="ident" id="4867219">errors</span><span class="op" id="4867225">.</span><span class="ident" id="4867226">New</span><span class="op" id="4867229">(</span><span class="string" id="4867230">&#34;invalid&nbsp;range&#34;</span><span class="op" id="4867245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4867248">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4867251">var</span>&nbsp;<span class="ident" id="4867255">ranges</span>&nbsp;<span class="op" id="4867262">[</span><span class="op" id="4867263">]</span><span class="ident" id="4867264">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4867275">for</span>&nbsp;<span class="ident" id="4867279">_</span><span class="op" id="4867280">,</span>&nbsp;<span class="ident" id="4867282">ra</span>&nbsp;<span class="op" id="4867285">:=</span>&nbsp;<span class="keyword" id="4867288">range</span>&nbsp;<span class="ident" id="4867294">strings</span><span class="op" id="4867301">.</span><span class="ident" id="4867302">Split</span><span class="op" id="4867307">(</span><span class="ident" id="4867308">s</span><span class="op" id="4867309">[</span><span class="builtinfunc" id="4867310">len</span><span class="op" id="4867313">(</span><span class="ident" id="4867314">b</span><span class="op" id="4867315">)</span><span class="op" id="4867316">:</span><span class="op" id="4867317">]</span><span class="op" id="4867318">,</span>&nbsp;<span class="string" id="4867320">&#34;,&#34;</span><span class="op" id="4867323">)</span>&nbsp;<span class="op" id="4867325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4867329">ra</span>&nbsp;<span class="op" id="4867332">=</span>&nbsp;<span class="ident" id="4867334">strings</span><span class="op" id="4867341">.</span><span class="ident" id="4867342">TrimSpace</span><span class="op" id="4867351">(</span><span class="ident" id="4867352">ra</span><span class="op" id="4867354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4867358">if</span>&nbsp;<span class="ident" id="4867361">ra</span>&nbsp;<span class="op" id="4867364">==</span>&nbsp;<span class="string" id="4867367">&#34;&#34;</span>&nbsp;<span class="op" id="4867370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4867375">continue</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4867386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4867390">i</span>&nbsp;<span class="op" id="4867392">:=</span>&nbsp;<span class="ident" id="4867395">strings</span><span class="op" id="4867402">.</span><span class="ident" id="4867403">Index</span><span class="op" id="4867408">(</span><span class="ident" id="4867409">ra</span><span class="op" id="4867411">,</span>&nbsp;<span class="string" id="4867413">&#34;-&#34;</span><span class="op" id="4867416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4867420">if</span>&nbsp;<span class="ident" id="4867423">i</span>&nbsp;<span class="op" id="4867425">&lt;</span>&nbsp;<span class="num" id="4867427">0</span>&nbsp;<span class="op" id="4867429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4867434">return</span>&nbsp;<span class="ident" id="4867441">nil</span><span class="op" id="4867444">,</span>&nbsp;<span class="ident" id="4867446">errors</span><span class="op" id="4867452">.</span><span class="ident" id="4867453">New</span><span class="op" id="4867456">(</span><span class="string" id="4867457">&#34;invalid&nbsp;range&#34;</span><span class="op" id="4867472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4867476">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4867480">start</span><span class="op" id="4867485">,</span>&nbsp;<span class="ident" id="4867487">end</span>&nbsp;<span class="op" id="4867491">:=</span>&nbsp;<span class="ident" id="4867494">strings</span><span class="op" id="4867501">.</span><span class="ident" id="4867502">TrimSpace</span><span class="op" id="4867511">(</span><span class="ident" id="4867512">ra</span><span class="op" id="4867514">[</span><span class="op" id="4867515">:</span><span class="ident" id="4867516">i</span><span class="op" id="4867517">]</span><span class="op" id="4867518">)</span><span class="op" id="4867519">,</span>&nbsp;<span class="ident" id="4867521">strings</span><span class="op" id="4867528">.</span><span class="ident" id="4867529">TrimSpace</span><span class="op" id="4867538">(</span><span class="ident" id="4867539">ra</span><span class="op" id="4867541">[</span><span class="ident" id="4867542">i</span><span class="op" id="4867543">+</span><span class="num" id="4867544">1</span><span class="op" id="4867545">:</span><span class="op" id="4867546">]</span><span class="op" id="4867547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4867551">var</span>&nbsp;<span class="ident" id="4867555">r</span>&nbsp;<span class="ident" id="4867557">httpRange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4867569">if</span>&nbsp;<span class="ident" id="4867572">start</span>&nbsp;<span class="op" id="4867578">==</span>&nbsp;<span class="string" id="4867581">&#34;&#34;</span>&nbsp;<span class="op" id="4867584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4867589">//&nbsp;If&nbsp;no&nbsp;start&nbsp;is&nbsp;specified,&nbsp;end&nbsp;specifies&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4867639">//&nbsp;range&nbsp;start&nbsp;relative&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4867690">i</span><span class="op" id="4867691">,</span>&nbsp;<span class="ident" id="4867693">err</span>&nbsp;<span class="op" id="4867697">:=</span>&nbsp;<span class="ident" id="4867700">strconv</span><span class="op" id="4867707">.</span><span class="ident" id="4867708">ParseInt</span><span class="op" id="4867716">(</span><span class="ident" id="4867717">end</span><span class="op" id="4867720">,</span>&nbsp;<span class="num" id="4867722">10</span><span class="op" id="4867724">,</span>&nbsp;<span class="num" id="4867726">64</span><span class="op" id="4867728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4867733">if</span>&nbsp;<span class="ident" id="4867736">err</span>&nbsp;<span class="op" id="4867740">!=</span>&nbsp;<span class="ident" id="4867743">nil</span>&nbsp;<span class="op" id="4867747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4867753">return</span>&nbsp;<span class="ident" id="4867760">nil</span><span class="op" id="4867763">,</span>&nbsp;<span class="ident" id="4867765">errors</span><span class="op" id="4867771">.</span><span class="ident" id="4867772">New</span><span class="op" id="4867775">(</span><span class="string" id="4867776">&#34;invalid&nbsp;range&#34;</span><span class="op" id="4867791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4867796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4867801">if</span>&nbsp;<span class="ident" id="4867804">i</span>&nbsp;<span class="op" id="4867806">&gt;</span>&nbsp;<span class="ident" id="4867808">size</span>&nbsp;<span class="op" id="4867813">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4867819">i</span>&nbsp;<span class="op" id="4867821">=</span>&nbsp;<span class="ident" id="4867823">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4867831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4867836">r</span><span class="op" id="4867837">.</span><span class="ident" id="4867838">start</span>&nbsp;<span class="op" id="4867844">=</span>&nbsp;<span class="ident" id="4867846">size</span>&nbsp;<span class="op" id="4867851">-</span>&nbsp;<span class="ident" id="4867853">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4867858">r</span><span class="op" id="4867859">.</span><span class="ident" id="4867860">length</span>&nbsp;<span class="op" id="4867867">=</span>&nbsp;<span class="ident" id="4867869">size</span>&nbsp;<span class="op" id="4867874">-</span>&nbsp;<span class="ident" id="4867876">r</span><span class="op" id="4867877">.</span><span class="ident" id="4867878">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4867886">}</span>&nbsp;<span class="keyword" id="4867888">else</span>&nbsp;<span class="op" id="4867893">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4867898">i</span><span class="op" id="4867899">,</span>&nbsp;<span class="ident" id="4867901">err</span>&nbsp;<span class="op" id="4867905">:=</span>&nbsp;<span class="ident" id="4867908">strconv</span><span class="op" id="4867915">.</span><span class="ident" id="4867916">ParseInt</span><span class="op" id="4867924">(</span><span class="ident" id="4867925">start</span><span class="op" id="4867930">,</span>&nbsp;<span class="num" id="4867932">10</span><span class="op" id="4867934">,</span>&nbsp;<span class="num" id="4867936">64</span><span class="op" id="4867938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4867943">if</span>&nbsp;<span class="ident" id="4867946">err</span>&nbsp;<span class="op" id="4867950">!=</span>&nbsp;<span class="ident" id="4867953">nil</span>&nbsp;<span class="op" id="4867957">||</span>&nbsp;<span class="ident" id="4867960">i</span>&nbsp;<span class="op" id="4867962">&gt;</span>&nbsp;<span class="ident" id="4867964">size</span>&nbsp;<span class="op" id="4867969">||</span>&nbsp;<span class="ident" id="4867972">i</span>&nbsp;<span class="op" id="4867974">&lt;</span>&nbsp;<span class="num" id="4867976">0</span>&nbsp;<span class="op" id="4867978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4867984">return</span>&nbsp;<span class="ident" id="4867991">nil</span><span class="op" id="4867994">,</span>&nbsp;<span class="ident" id="4867996">errors</span><span class="op" id="4868002">.</span><span class="ident" id="4868003">New</span><span class="op" id="4868006">(</span><span class="string" id="4868007">&#34;invalid&nbsp;range&#34;</span><span class="op" id="4868022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4868027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4868032">r</span><span class="op" id="4868033">.</span><span class="ident" id="4868034">start</span>&nbsp;<span class="op" id="4868040">=</span>&nbsp;<span class="ident" id="4868042">i</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4868047">if</span>&nbsp;<span class="ident" id="4868050">end</span>&nbsp;<span class="op" id="4868054">==</span>&nbsp;<span class="string" id="4868057">&#34;&#34;</span>&nbsp;<span class="op" id="4868060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4868066">//&nbsp;If&nbsp;no&nbsp;end&nbsp;is&nbsp;specified,&nbsp;range&nbsp;extends&nbsp;to&nbsp;end&nbsp;of&nbsp;the&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4868131">r</span><span class="op" id="4868132">.</span><span class="ident" id="4868133">length</span>&nbsp;<span class="op" id="4868140">=</span>&nbsp;<span class="ident" id="4868142">size</span>&nbsp;<span class="op" id="4868147">-</span>&nbsp;<span class="ident" id="4868149">r</span><span class="op" id="4868150">.</span><span class="ident" id="4868151">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4868160">}</span>&nbsp;<span class="keyword" id="4868162">else</span>&nbsp;<span class="op" id="4868167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4868173">i</span><span class="op" id="4868174">,</span>&nbsp;<span class="ident" id="4868176">err</span>&nbsp;<span class="op" id="4868180">:=</span>&nbsp;<span class="ident" id="4868183">strconv</span><span class="op" id="4868190">.</span><span class="ident" id="4868191">ParseInt</span><span class="op" id="4868199">(</span><span class="ident" id="4868200">end</span><span class="op" id="4868203">,</span>&nbsp;<span class="num" id="4868205">10</span><span class="op" id="4868207">,</span>&nbsp;<span class="num" id="4868209">64</span><span class="op" id="4868211">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4868217">if</span>&nbsp;<span class="ident" id="4868220">err</span>&nbsp;<span class="op" id="4868224">!=</span>&nbsp;<span class="ident" id="4868227">nil</span>&nbsp;<span class="op" id="4868231">||</span>&nbsp;<span class="ident" id="4868234">r</span><span class="op" id="4868235">.</span><span class="ident" id="4868236">start</span>&nbsp;<span class="op" id="4868242">&gt;</span>&nbsp;<span class="ident" id="4868244">i</span>&nbsp;<span class="op" id="4868246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4868253">return</span>&nbsp;<span class="ident" id="4868260">nil</span><span class="op" id="4868263">,</span>&nbsp;<span class="ident" id="4868265">errors</span><span class="op" id="4868271">.</span><span class="ident" id="4868272">New</span><span class="op" id="4868275">(</span><span class="string" id="4868276">&#34;invalid&nbsp;range&#34;</span><span class="op" id="4868291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4868297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4868303">if</span>&nbsp;<span class="ident" id="4868306">i</span>&nbsp;<span class="op" id="4868308">&gt;=</span>&nbsp;<span class="ident" id="4868311">size</span>&nbsp;<span class="op" id="4868316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4868323">i</span>&nbsp;<span class="op" id="4868325">=</span>&nbsp;<span class="ident" id="4868327">size</span>&nbsp;<span class="op" id="4868332">-</span>&nbsp;<span class="num" id="4868334">1</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4868340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4868346">r</span><span class="op" id="4868347">.</span><span class="ident" id="4868348">length</span>&nbsp;<span class="op" id="4868355">=</span>&nbsp;<span class="ident" id="4868357">i</span>&nbsp;<span class="op" id="4868359">-</span>&nbsp;<span class="ident" id="4868361">r</span><span class="op" id="4868362">.</span><span class="ident" id="4868363">start</span>&nbsp;<span class="op" id="4868369">+</span>&nbsp;<span class="num" id="4868371">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4868376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4868380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4868384">ranges</span>&nbsp;<span class="op" id="4868391">=</span>&nbsp;<span class="builtinfunc" id="4868393">append</span><span class="op" id="4868399">(</span><span class="ident" id="4868400">ranges</span><span class="op" id="4868406">,</span>&nbsp;<span class="ident" id="4868408">r</span><span class="op" id="4868409">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4868412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4868415">return</span>&nbsp;<span class="ident" id="4868422">ranges</span><span class="op" id="4868428">,</span>&nbsp;<span class="ident" id="4868430">nil</span><br>
<span class="lineno"></span><span class="op" id="4868434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4868437">//&nbsp;countingWriter&nbsp;counts&nbsp;how&nbsp;many&nbsp;bytes&nbsp;have&nbsp;been&nbsp;written&nbsp;to&nbsp;it.</span><br>
<span class="lineno">530</span><span class="keyword" id="4868502">type</span>&nbsp;<span class="ident" id="4868507">countingWriter</span>&nbsp;<span class="ident" id="4868522">int64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4868529">func</span>&nbsp;<span class="op" id="4868534">(</span><span class="ident" id="4868535">w</span>&nbsp;<span class="op" id="4868537">*</span><span class="ident" id="4868538">countingWriter</span><span class="op" id="4868552">)</span>&nbsp;<span class="ident" id="4868554">Write</span><span class="op" id="4868559">(</span><span class="ident" id="4868560">p</span>&nbsp;<span class="op" id="4868562">[</span><span class="op" id="4868563">]</span><span class="builtintype" id="4868564">byte</span><span class="op" id="4868568">)</span>&nbsp;<span class="op" id="4868570">(</span><span class="ident" id="4868571">n</span>&nbsp;<span class="builtintype" id="4868573">int</span><span class="op" id="4868576">,</span>&nbsp;<span class="ident" id="4868578">err</span>&nbsp;<span class="builtintype" id="4868582">error</span><span class="op" id="4868587">)</span>&nbsp;<span class="op" id="4868589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4868592">*</span><span class="ident" id="4868593">w</span>&nbsp;<span class="op" id="4868595">+=</span>&nbsp;<span class="ident" id="4868598">countingWriter</span><span class="op" id="4868612">(</span><span class="builtinfunc" id="4868613">len</span><span class="op" id="4868616">(</span><span class="ident" id="4868617">p</span><span class="op" id="4868618">)</span><span class="op" id="4868619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4868622">return</span>&nbsp;<span class="builtinfunc" id="4868629">len</span><span class="op" id="4868632">(</span><span class="ident" id="4868633">p</span><span class="op" id="4868634">)</span><span class="op" id="4868635">,</span>&nbsp;<span class="ident" id="4868637">nil</span><br>
<span class="lineno">535</span><span class="op" id="4868641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4868644">//&nbsp;rangesMIMESize&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;it&nbsp;takes&nbsp;to&nbsp;encode&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4868713">//&nbsp;provided&nbsp;ranges&nbsp;as&nbsp;a&nbsp;multipart&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="4868757">func</span>&nbsp;<span class="ident" id="4868762">rangesMIMESize</span><span class="op" id="4868776">(</span><span class="ident" id="4868777">ranges</span>&nbsp;<span class="op" id="4868784">[</span><span class="op" id="4868785">]</span><span class="ident" id="4868786">httpRange</span><span class="op" id="4868795">,</span>&nbsp;<span class="ident" id="4868797">contentType</span>&nbsp;<span class="builtintype" id="4868809">string</span><span class="op" id="4868815">,</span>&nbsp;<span class="ident" id="4868817">contentSize</span>&nbsp;<span class="ident" id="4868829">int64</span><span class="op" id="4868834">)</span>&nbsp;<span class="op" id="4868836">(</span><span class="ident" id="4868837">encSize</span>&nbsp;<span class="ident" id="4868845">int64</span><span class="op" id="4868850">)</span>&nbsp;<span class="op" id="4868852">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4868855">var</span>&nbsp;<span class="ident" id="4868859">w</span>&nbsp;<span class="ident" id="4868861">countingWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4868877">mw</span>&nbsp;<span class="op" id="4868880">:=</span>&nbsp;<span class="ident" id="4868883">multipart</span><span class="op" id="4868892">.</span><span class="ident" id="4868893">NewWriter</span><span class="op" id="4868902">(</span><span class="op" id="4868903">&amp;</span><span class="ident" id="4868904">w</span><span class="op" id="4868905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4868908">for</span>&nbsp;<span class="ident" id="4868912">_</span><span class="op" id="4868913">,</span>&nbsp;<span class="ident" id="4868915">ra</span>&nbsp;<span class="op" id="4868918">:=</span>&nbsp;<span class="keyword" id="4868921">range</span>&nbsp;<span class="ident" id="4868927">ranges</span>&nbsp;<span class="op" id="4868934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4868938">mw</span><span class="op" id="4868940">.</span><span class="ident" id="4868941">CreatePart</span><span class="op" id="4868951">(</span><span class="ident" id="4868952">ra</span><span class="op" id="4868954">.</span><span class="ident" id="4868955">mimeHeader</span><span class="op" id="4868965">(</span><span class="ident" id="4868966">contentType</span><span class="op" id="4868977">,</span>&nbsp;<span class="ident" id="4868979">contentSize</span><span class="op" id="4868990">)</span><span class="op" id="4868991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4868995">encSize</span>&nbsp;<span class="op" id="4869003">+=</span>&nbsp;<span class="ident" id="4869006">ra</span><span class="op" id="4869008">.</span><span class="ident" id="4869009">length</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4869017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869020">mw</span><span class="op" id="4869022">.</span><span class="ident" id="4869023">Close</span><span class="op" id="4869028">(</span><span class="op" id="4869029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869032">encSize</span>&nbsp;<span class="op" id="4869040">+=</span>&nbsp;<span class="ident" id="4869043">int64</span><span class="op" id="4869048">(</span><span class="ident" id="4869049">w</span><span class="op" id="4869050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4869053">return</span><br>
<span class="lineno"></span><span class="op" id="4869060">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="keyword" id="4869063">func</span>&nbsp;<span class="ident" id="4869068">sumRangesSize</span><span class="op" id="4869081">(</span><span class="ident" id="4869082">ranges</span>&nbsp;<span class="op" id="4869089">[</span><span class="op" id="4869090">]</span><span class="ident" id="4869091">httpRange</span><span class="op" id="4869100">)</span>&nbsp;<span class="op" id="4869102">(</span><span class="ident" id="4869103">size</span>&nbsp;<span class="ident" id="4869108">int64</span><span class="op" id="4869113">)</span>&nbsp;<span class="op" id="4869115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4869118">for</span>&nbsp;<span class="ident" id="4869122">_</span><span class="op" id="4869123">,</span>&nbsp;<span class="ident" id="4869125">ra</span>&nbsp;<span class="op" id="4869128">:=</span>&nbsp;<span class="keyword" id="4869131">range</span>&nbsp;<span class="ident" id="4869137">ranges</span>&nbsp;<span class="op" id="4869144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869148">size</span>&nbsp;<span class="op" id="4869153">+=</span>&nbsp;<span class="ident" id="4869156">ra</span><span class="op" id="4869158">.</span><span class="ident" id="4869159">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4869167">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4869170">return</span><br>
<span class="lineno"></span><span class="op" id="4869177">}</span>
</div>
</body>
</html>
