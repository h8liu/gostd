<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7980564">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7980619">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7980673">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7980724">package</span>&nbsp;<span class="ident" id="7980732">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7980737">import</span>&nbsp;<span class="op" id="7980744">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7980747">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7980770">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7980780">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7980787">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7980793">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7980800">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7980808">&#34;strconv&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7980819">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7980830">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7980838">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7980849">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7980856">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7980859">var</span>&nbsp;<span class="ident" id="7980863">_</span>&nbsp;<span class="op" id="7980865">=</span>&nbsp;<span class="ident" id="7980867">log</span><span class="op" id="7980870">.</span><span class="ident" id="7980871">Printf</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7980879">//&nbsp;fakeDriver&nbsp;is&nbsp;a&nbsp;fake&nbsp;database&nbsp;that&nbsp;implements&nbsp;Go&#39;s&nbsp;driver.Driver</span><br>
<span class="lineno"></span><span class="comment" id="7980947">//&nbsp;interface,&nbsp;just&nbsp;for&nbsp;testing.</span><br>
<span class="lineno">25</span><span class="comment" id="7980979">//</span><br>
<span class="lineno"></span><span class="comment" id="7980982">//&nbsp;It&nbsp;speaks&nbsp;a&nbsp;query&nbsp;language&nbsp;that&#39;s&nbsp;semantically&nbsp;similar&nbsp;to&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="7981047">//&nbsp;syntactically&nbsp;different&nbsp;and&nbsp;simpler&nbsp;than&nbsp;SQL.&nbsp;&nbsp;The&nbsp;syntax&nbsp;is&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="7981114">//&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="7981126">//</span><br>
<span class="lineno">30</span><span class="comment" id="7981129">//&nbsp;&nbsp;&nbsp;WIPE</span><br>
<span class="lineno"></span><span class="comment" id="7981139">//&nbsp;&nbsp;&nbsp;CREATE|&lt;tablename&gt;|&lt;col&gt;=&lt;type&gt;,&lt;col&gt;=&lt;type&gt;,...</span><br>
<span class="lineno"></span><span class="comment" id="7981193">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;types&nbsp;are:&nbsp;&#34;string&#34;,&nbsp;[u]int{8,16,32,64},&nbsp;&#34;bool&#34;</span><br>
<span class="lineno"></span><span class="comment" id="7981254">//&nbsp;&nbsp;&nbsp;INSERT|&lt;tablename&gt;|col=val,col2=val2,col3=?</span><br>
<span class="lineno"></span><span class="comment" id="7981303">//&nbsp;&nbsp;&nbsp;SELECT|&lt;tablename&gt;|projectcol1,projectcol2|filtercol=?,filtercol2=?</span><br>
<span class="lineno">35</span><span class="comment" id="7981376">//</span><br>
<span class="lineno"></span><span class="comment" id="7981379">//&nbsp;When&nbsp;opening&nbsp;a&nbsp;fakeDriver&#39;s&nbsp;database,&nbsp;it&nbsp;starts&nbsp;empty&nbsp;with&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="7981444">//&nbsp;tables.&nbsp;&nbsp;All&nbsp;tables&nbsp;and&nbsp;data&nbsp;are&nbsp;stored&nbsp;in&nbsp;memory&nbsp;only.</span><br>
<span class="lineno"></span><span class="keyword" id="7981503">type</span>&nbsp;<span class="ident" id="7981508">fakeDriver</span>&nbsp;<span class="keyword" id="7981519">struct</span>&nbsp;<span class="op" id="7981526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7981529">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7981540">sync</span><span class="op" id="7981544">.</span><span class="ident" id="7981545">Mutex</span>&nbsp;<span class="comment" id="7981551">//&nbsp;guards&nbsp;3&nbsp;following&nbsp;fields</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7981581">openCount</span>&nbsp;&nbsp;<span class="builtintype" id="7981592">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7981603">//&nbsp;conn&nbsp;opens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7981618">closeCount</span>&nbsp;<span class="builtintype" id="7981629">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7981640">//&nbsp;conn&nbsp;closes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7981656">waitCh</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7981667">chan</span>&nbsp;<span class="keyword" id="7981672">struct</span><span class="op" id="7981678">{</span><span class="op" id="7981679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7981682">waitingCh</span>&nbsp;&nbsp;<span class="keyword" id="7981693">chan</span>&nbsp;<span class="keyword" id="7981698">struct</span><span class="op" id="7981704">{</span><span class="op" id="7981705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7981708">dbs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="7981719">map</span><span class="op" id="7981722">[</span><span class="builtintype" id="7981723">string</span><span class="op" id="7981729">]</span><span class="op" id="7981730">*</span><span class="ident" id="7981731">fakeDB</span><br>
<span class="lineno">45</span><span class="op" id="7981738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7981741">type</span>&nbsp;<span class="ident" id="7981746">fakeDB</span>&nbsp;<span class="keyword" id="7981753">struct</span>&nbsp;<span class="op" id="7981760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7981763">name</span>&nbsp;<span class="builtintype" id="7981768">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7981777">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7981785">sync</span><span class="op" id="7981789">.</span><span class="ident" id="7981790">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7981797">free</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7981805">[</span><span class="op" id="7981806">]</span><span class="op" id="7981807">*</span><span class="ident" id="7981808">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7981818">tables</span>&nbsp;&nbsp;<span class="keyword" id="7981826">map</span><span class="op" id="7981829">[</span><span class="builtintype" id="7981830">string</span><span class="op" id="7981836">]</span><span class="op" id="7981837">*</span><span class="ident" id="7981838">table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7981845">badConn</span>&nbsp;<span class="builtintype" id="7981853">bool</span><br>
<span class="lineno"></span><span class="op" id="7981858">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="7981861">type</span>&nbsp;<span class="ident" id="7981866">table</span>&nbsp;<span class="keyword" id="7981872">struct</span>&nbsp;<span class="op" id="7981879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7981882">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7981890">sync</span><span class="op" id="7981894">.</span><span class="ident" id="7981895">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7981902">colname</span>&nbsp;<span class="op" id="7981910">[</span><span class="op" id="7981911">]</span><span class="builtintype" id="7981912">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7981920">coltype</span>&nbsp;<span class="op" id="7981928">[</span><span class="op" id="7981929">]</span><span class="builtintype" id="7981930">string</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7981938">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7981946">[</span><span class="op" id="7981947">]</span><span class="op" id="7981948">*</span><span class="ident" id="7981949">row</span><br>
<span class="lineno"></span><span class="op" id="7981953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7981956">func</span>&nbsp;<span class="op" id="7981961">(</span><span class="ident" id="7981962">t</span>&nbsp;<span class="op" id="7981964">*</span><span class="ident" id="7981965">table</span><span class="op" id="7981970">)</span>&nbsp;<span class="ident" id="7981972">columnIndex</span><span class="op" id="7981983">(</span><span class="ident" id="7981984">name</span>&nbsp;<span class="builtintype" id="7981989">string</span><span class="op" id="7981995">)</span>&nbsp;<span class="builtintype" id="7981997">int</span>&nbsp;<span class="op" id="7982001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7982004">for</span>&nbsp;<span class="ident" id="7982008">n</span><span class="op" id="7982009">,</span>&nbsp;<span class="ident" id="7982011">nname</span>&nbsp;<span class="op" id="7982017">:=</span>&nbsp;<span class="keyword" id="7982020">range</span>&nbsp;<span class="ident" id="7982026">t</span><span class="op" id="7982027">.</span><span class="ident" id="7982028">colname</span>&nbsp;<span class="op" id="7982036">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7982040">if</span>&nbsp;<span class="ident" id="7982043">name</span>&nbsp;<span class="op" id="7982048">==</span>&nbsp;<span class="ident" id="7982051">nname</span>&nbsp;<span class="op" id="7982057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7982062">return</span>&nbsp;<span class="ident" id="7982069">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7982073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7982076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7982079">return</span>&nbsp;<span class="op" id="7982086">-</span><span class="num" id="7982087">1</span><br>
<span class="lineno">70</span><span class="op" id="7982089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7982092">type</span>&nbsp;<span class="ident" id="7982097">row</span>&nbsp;<span class="keyword" id="7982101">struct</span>&nbsp;<span class="op" id="7982108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7982111">cols</span>&nbsp;<span class="op" id="7982116">[</span><span class="op" id="7982117">]</span><span class="keyword" id="7982118">interface</span><span class="op" id="7982127">{</span><span class="op" id="7982128">}</span>&nbsp;<span class="comment" id="7982130">//&nbsp;must&nbsp;be&nbsp;same&nbsp;size&nbsp;as&nbsp;its&nbsp;table&nbsp;colname&nbsp;+&nbsp;coltype</span><br>
<span class="lineno"></span><span class="op" id="7982182">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="7982185">func</span>&nbsp;<span class="op" id="7982190">(</span><span class="ident" id="7982191">r</span>&nbsp;<span class="op" id="7982193">*</span><span class="ident" id="7982194">row</span><span class="op" id="7982197">)</span>&nbsp;<span class="ident" id="7982199">clone</span><span class="op" id="7982204">(</span><span class="op" id="7982205">)</span>&nbsp;<span class="op" id="7982207">*</span><span class="ident" id="7982208">row</span>&nbsp;<span class="op" id="7982212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7982215">nrow</span>&nbsp;<span class="op" id="7982220">:=</span>&nbsp;<span class="op" id="7982223">&amp;</span><span class="ident" id="7982224">row</span><span class="op" id="7982227">{</span><span class="ident" id="7982228">cols</span><span class="op" id="7982232">:</span>&nbsp;<span class="builtinfunc" id="7982234">make</span><span class="op" id="7982238">(</span><span class="op" id="7982239">[</span><span class="op" id="7982240">]</span><span class="keyword" id="7982241">interface</span><span class="op" id="7982250">{</span><span class="op" id="7982251">}</span><span class="op" id="7982252">,</span>&nbsp;<span class="builtinfunc" id="7982254">len</span><span class="op" id="7982257">(</span><span class="ident" id="7982258">r</span><span class="op" id="7982259">.</span><span class="ident" id="7982260">cols</span><span class="op" id="7982264">)</span><span class="op" id="7982265">)</span><span class="op" id="7982266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7982269">copy</span><span class="op" id="7982273">(</span><span class="ident" id="7982274">nrow</span><span class="op" id="7982278">.</span><span class="ident" id="7982279">cols</span><span class="op" id="7982283">,</span>&nbsp;<span class="ident" id="7982285">r</span><span class="op" id="7982286">.</span><span class="ident" id="7982287">cols</span><span class="op" id="7982291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7982294">return</span>&nbsp;<span class="ident" id="7982301">nrow</span><br>
<span class="lineno">80</span><span class="op" id="7982306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7982309">type</span>&nbsp;<span class="ident" id="7982314">fakeConn</span>&nbsp;<span class="keyword" id="7982323">struct</span>&nbsp;<span class="op" id="7982330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7982333">db</span>&nbsp;<span class="op" id="7982336">*</span><span class="ident" id="7982337">fakeDB</span>&nbsp;<span class="comment" id="7982344">//&nbsp;where&nbsp;to&nbsp;return&nbsp;ourselves&nbsp;to</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7982378">currTx</span>&nbsp;<span class="op" id="7982385">*</span><span class="ident" id="7982386">fakeTx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7982395">//&nbsp;Stats&nbsp;for&nbsp;tests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7982416">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7982428">sync</span><span class="op" id="7982432">.</span><span class="ident" id="7982433">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7982440">stmtsMade</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7982452">int</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7982457">stmtsClosed</span>&nbsp;<span class="builtintype" id="7982469">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7982474">numPrepare</span>&nbsp;&nbsp;<span class="builtintype" id="7982486">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7982491">bad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7982503">bool</span><br>
<span class="lineno"></span><span class="op" id="7982508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7982511">func</span>&nbsp;<span class="op" id="7982516">(</span><span class="ident" id="7982517">c</span>&nbsp;<span class="op" id="7982519">*</span><span class="ident" id="7982520">fakeConn</span><span class="op" id="7982528">)</span>&nbsp;<span class="ident" id="7982530">incrStat</span><span class="op" id="7982538">(</span><span class="ident" id="7982539">v</span>&nbsp;<span class="op" id="7982541">*</span><span class="builtintype" id="7982542">int</span><span class="op" id="7982545">)</span>&nbsp;<span class="op" id="7982547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7982550">c</span><span class="op" id="7982551">.</span><span class="ident" id="7982552">mu</span><span class="op" id="7982554">.</span><span class="ident" id="7982555">Lock</span><span class="op" id="7982559">(</span><span class="op" id="7982560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7982563">*</span><span class="ident" id="7982564">v</span><span class="op" id="7982565">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7982569">c</span><span class="op" id="7982570">.</span><span class="ident" id="7982571">mu</span><span class="op" id="7982573">.</span><span class="ident" id="7982574">Unlock</span><span class="op" id="7982580">(</span><span class="op" id="7982581">)</span><br>
<span class="lineno"></span><span class="op" id="7982583">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="7982586">type</span>&nbsp;<span class="ident" id="7982591">fakeTx</span>&nbsp;<span class="keyword" id="7982598">struct</span>&nbsp;<span class="op" id="7982605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7982608">c</span>&nbsp;<span class="op" id="7982610">*</span><span class="ident" id="7982611">fakeConn</span><br>
<span class="lineno"></span><span class="op" id="7982620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="7982623">type</span>&nbsp;<span class="ident" id="7982628">fakeStmt</span>&nbsp;<span class="keyword" id="7982637">struct</span>&nbsp;<span class="op" id="7982644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7982647">c</span>&nbsp;<span class="op" id="7982649">*</span><span class="ident" id="7982650">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7982660">q</span>&nbsp;<span class="builtintype" id="7982662">string</span>&nbsp;<span class="comment" id="7982669">//&nbsp;just&nbsp;for&nbsp;debugging</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7982693">cmd</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7982699">string</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7982707">table</span>&nbsp;<span class="builtintype" id="7982713">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7982722">closed</span>&nbsp;<span class="builtintype" id="7982729">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7982736">colName</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7982749">[</span><span class="op" id="7982750">]</span><span class="builtintype" id="7982751">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7982763">//&nbsp;used&nbsp;by&nbsp;CREATE,&nbsp;INSERT,&nbsp;SELECT&nbsp;(selected&nbsp;columns)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7982817">colType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7982830">[</span><span class="op" id="7982831">]</span><span class="builtintype" id="7982832">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7982844">//&nbsp;used&nbsp;by&nbsp;CREATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7982863">colValue</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7982876">[</span><span class="op" id="7982877">]</span><span class="keyword" id="7982878">interface</span><span class="op" id="7982887">{</span><span class="op" id="7982888">}</span>&nbsp;<span class="comment" id="7982890">//&nbsp;used&nbsp;by&nbsp;INSERT&nbsp;(mix&nbsp;of&nbsp;strings&nbsp;and&nbsp;&#34;?&#34;&nbsp;for&nbsp;bound&nbsp;params)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7982951">placeholders</span>&nbsp;<span class="builtintype" id="7982964">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7982978">//&nbsp;used&nbsp;by&nbsp;INSERT/SELECT:&nbsp;number&nbsp;of&nbsp;?&nbsp;params</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7983025">whereCol</span>&nbsp;<span class="op" id="7983034">[</span><span class="op" id="7983035">]</span><span class="builtintype" id="7983036">string</span>&nbsp;<span class="comment" id="7983043">//&nbsp;used&nbsp;by&nbsp;SELECT&nbsp;(all&nbsp;placeholders)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7983082">placeholderConverter</span>&nbsp;<span class="op" id="7983103">[</span><span class="op" id="7983104">]</span><span class="ident" id="7983105">driver</span><span class="op" id="7983111">.</span><span class="ident" id="7983112">ValueConverter</span>&nbsp;<span class="comment" id="7983127">//&nbsp;used&nbsp;by&nbsp;INSERT</span><br>
<span class="lineno"></span><span class="op" id="7983145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7983148">var</span>&nbsp;<span class="ident" id="7983152">fdriver</span>&nbsp;<span class="ident" id="7983160">driver</span><span class="op" id="7983166">.</span><span class="ident" id="7983167">Driver</span>&nbsp;<span class="op" id="7983174">=</span>&nbsp;<span class="op" id="7983176">&amp;</span><span class="ident" id="7983177">fakeDriver</span><span class="op" id="7983187">{</span><span class="op" id="7983188">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="7983191">func</span>&nbsp;<span class="ident" id="7983196">init</span><span class="op" id="7983200">(</span><span class="op" id="7983201">)</span>&nbsp;<span class="op" id="7983203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7983206">Register</span><span class="op" id="7983214">(</span><span class="string" id="7983215">&#34;test&#34;</span><span class="op" id="7983221">,</span>&nbsp;<span class="ident" id="7983223">fdriver</span><span class="op" id="7983230">)</span><br>
<span class="lineno"></span><span class="op" id="7983232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="7983235">func</span>&nbsp;<span class="ident" id="7983240">contains</span><span class="op" id="7983248">(</span><span class="ident" id="7983249">list</span>&nbsp;<span class="op" id="7983254">[</span><span class="op" id="7983255">]</span><span class="builtintype" id="7983256">string</span><span class="op" id="7983262">,</span>&nbsp;<span class="ident" id="7983264">y</span>&nbsp;<span class="builtintype" id="7983266">string</span><span class="op" id="7983272">)</span>&nbsp;<span class="builtintype" id="7983274">bool</span>&nbsp;<span class="op" id="7983279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7983282">for</span>&nbsp;<span class="ident" id="7983286">_</span><span class="op" id="7983287">,</span>&nbsp;<span class="ident" id="7983289">x</span>&nbsp;<span class="op" id="7983291">:=</span>&nbsp;<span class="keyword" id="7983294">range</span>&nbsp;<span class="ident" id="7983300">list</span>&nbsp;<span class="op" id="7983305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7983309">if</span>&nbsp;<span class="ident" id="7983312">x</span>&nbsp;<span class="op" id="7983314">==</span>&nbsp;<span class="ident" id="7983317">y</span>&nbsp;<span class="op" id="7983319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7983324">return</span>&nbsp;<span class="builtintype" id="7983331">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7983338">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7983341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7983344">return</span>&nbsp;<span class="builtintype" id="7983351">false</span><br>
<span class="lineno"></span><span class="op" id="7983357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7983360">type</span>&nbsp;<span class="ident" id="7983365">Dummy</span>&nbsp;<span class="keyword" id="7983371">struct</span>&nbsp;<span class="op" id="7983378">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7983381">driver</span><span class="op" id="7983387">.</span><span class="ident" id="7983388">Driver</span><br>
<span class="lineno"></span><span class="op" id="7983395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7983398">func</span>&nbsp;<span class="ident" id="7983403">TestDrivers</span><span class="op" id="7983414">(</span><span class="ident" id="7983415">t</span>&nbsp;<span class="op" id="7983417">*</span><span class="ident" id="7983418">testing</span><span class="op" id="7983425">.</span><span class="ident" id="7983426">T</span><span class="op" id="7983427">)</span>&nbsp;<span class="op" id="7983429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7983432">unregisterAllDrivers</span><span class="op" id="7983452">(</span><span class="op" id="7983453">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7983456">Register</span><span class="op" id="7983464">(</span><span class="string" id="7983465">&#34;test&#34;</span><span class="op" id="7983471">,</span>&nbsp;<span class="ident" id="7983473">fdriver</span><span class="op" id="7983480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7983483">Register</span><span class="op" id="7983491">(</span><span class="string" id="7983492">&#34;invalid&#34;</span><span class="op" id="7983501">,</span>&nbsp;<span class="ident" id="7983503">Dummy</span><span class="op" id="7983508">{</span><span class="op" id="7983509">}</span><span class="op" id="7983510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7983513">all</span>&nbsp;<span class="op" id="7983517">:=</span>&nbsp;<span class="ident" id="7983520">Drivers</span><span class="op" id="7983527">(</span><span class="op" id="7983528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7983531">if</span>&nbsp;<span class="builtinfunc" id="7983534">len</span><span class="op" id="7983537">(</span><span class="ident" id="7983538">all</span><span class="op" id="7983541">)</span>&nbsp;<span class="op" id="7983543">&lt;</span>&nbsp;<span class="num" id="7983545">2</span>&nbsp;<span class="op" id="7983547">||</span>&nbsp;<span class="op" id="7983550">!</span><span class="ident" id="7983551">sort</span><span class="op" id="7983555">.</span><span class="ident" id="7983556">StringsAreSorted</span><span class="op" id="7983572">(</span><span class="ident" id="7983573">all</span><span class="op" id="7983576">)</span>&nbsp;<span class="op" id="7983578">||</span>&nbsp;<span class="op" id="7983581">!</span><span class="ident" id="7983582">contains</span><span class="op" id="7983590">(</span><span class="ident" id="7983591">all</span><span class="op" id="7983594">,</span>&nbsp;<span class="string" id="7983596">&#34;test&#34;</span><span class="op" id="7983602">)</span>&nbsp;<span class="op" id="7983604">||</span>&nbsp;<span class="op" id="7983607">!</span><span class="ident" id="7983608">contains</span><span class="op" id="7983616">(</span><span class="ident" id="7983617">all</span><span class="op" id="7983620">,</span>&nbsp;<span class="string" id="7983622">&#34;invalid&#34;</span><span class="op" id="7983631">)</span>&nbsp;<span class="op" id="7983633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7983637">t</span><span class="op" id="7983638">.</span><span class="ident" id="7983639">Fatalf</span><span class="op" id="7983645">(</span><span class="string" id="7983646">&#34;Drivers&nbsp;=&nbsp;%v,&nbsp;want&nbsp;sorted&nbsp;list&nbsp;with&nbsp;at&nbsp;least&nbsp;[invalid,&nbsp;test]&#34;</span><span class="op" id="7983708">,</span>&nbsp;<span class="ident" id="7983710">all</span><span class="op" id="7983713">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7983716">}</span><br>
<span class="lineno"></span><span class="op" id="7983718">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7983721">//&nbsp;Supports&nbsp;dsn&nbsp;forms:</span><br>
<span class="lineno"></span><span class="comment" id="7983744">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;</span><br>
<span class="lineno">155</span><span class="comment" id="7983759">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;;&lt;opts&gt;&nbsp;&nbsp;(only&nbsp;currently&nbsp;supported&nbsp;option&nbsp;is&nbsp;`badConn`,</span><br>
<span class="lineno"></span><span class="comment" id="7983829">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;which&nbsp;causes&nbsp;driver.ErrBadConn&nbsp;to&nbsp;be&nbsp;returned&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="7983902">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;every&nbsp;other&nbsp;conn.Begin())</span><br>
<span class="lineno"></span><span class="keyword" id="7983952">func</span>&nbsp;<span class="op" id="7983957">(</span><span class="ident" id="7983958">d</span>&nbsp;<span class="op" id="7983960">*</span><span class="ident" id="7983961">fakeDriver</span><span class="op" id="7983971">)</span>&nbsp;<span class="ident" id="7983973">Open</span><span class="op" id="7983977">(</span><span class="ident" id="7983978">dsn</span>&nbsp;<span class="builtintype" id="7983982">string</span><span class="op" id="7983988">)</span>&nbsp;<span class="op" id="7983990">(</span><span class="ident" id="7983991">driver</span><span class="op" id="7983997">.</span><span class="ident" id="7983998">Conn</span><span class="op" id="7984002">,</span>&nbsp;<span class="builtintype" id="7984004">error</span><span class="op" id="7984009">)</span>&nbsp;<span class="op" id="7984011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7984014">parts</span>&nbsp;<span class="op" id="7984020">:=</span>&nbsp;<span class="ident" id="7984023">strings</span><span class="op" id="7984030">.</span><span class="ident" id="7984031">Split</span><span class="op" id="7984036">(</span><span class="ident" id="7984037">dsn</span><span class="op" id="7984040">,</span>&nbsp;<span class="string" id="7984042">&#34;;&#34;</span><span class="op" id="7984045">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7984048">if</span>&nbsp;<span class="builtinfunc" id="7984051">len</span><span class="op" id="7984054">(</span><span class="ident" id="7984055">parts</span><span class="op" id="7984060">)</span>&nbsp;<span class="op" id="7984062">&lt;</span>&nbsp;<span class="num" id="7984064">1</span>&nbsp;<span class="op" id="7984066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7984070">return</span>&nbsp;<span class="ident" id="7984077">nil</span><span class="op" id="7984080">,</span>&nbsp;<span class="ident" id="7984082">errors</span><span class="op" id="7984088">.</span><span class="ident" id="7984089">New</span><span class="op" id="7984092">(</span><span class="string" id="7984093">&#34;fakedb:&nbsp;no&nbsp;database&nbsp;name&#34;</span><span class="op" id="7984119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7984122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7984125">name</span>&nbsp;<span class="op" id="7984130">:=</span>&nbsp;<span class="ident" id="7984133">parts</span><span class="op" id="7984138">[</span><span class="num" id="7984139">0</span><span class="op" id="7984140">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7984144">db</span>&nbsp;<span class="op" id="7984147">:=</span>&nbsp;<span class="ident" id="7984150">d</span><span class="op" id="7984151">.</span><span class="ident" id="7984152">getDB</span><span class="op" id="7984157">(</span><span class="ident" id="7984158">name</span><span class="op" id="7984162">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7984166">d</span><span class="op" id="7984167">.</span><span class="ident" id="7984168">mu</span><span class="op" id="7984170">.</span><span class="ident" id="7984171">Lock</span><span class="op" id="7984175">(</span><span class="op" id="7984176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7984179">d</span><span class="op" id="7984180">.</span><span class="ident" id="7984181">openCount</span><span class="op" id="7984190">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7984194">d</span><span class="op" id="7984195">.</span><span class="ident" id="7984196">mu</span><span class="op" id="7984198">.</span><span class="ident" id="7984199">Unlock</span><span class="op" id="7984205">(</span><span class="op" id="7984206">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7984209">conn</span>&nbsp;<span class="op" id="7984214">:=</span>&nbsp;<span class="op" id="7984217">&amp;</span><span class="ident" id="7984218">fakeConn</span><span class="op" id="7984226">{</span><span class="ident" id="7984227">db</span><span class="op" id="7984229">:</span>&nbsp;<span class="ident" id="7984231">db</span><span class="op" id="7984233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7984237">if</span>&nbsp;<span class="builtinfunc" id="7984240">len</span><span class="op" id="7984243">(</span><span class="ident" id="7984244">parts</span><span class="op" id="7984249">)</span>&nbsp;<span class="op" id="7984251">&gt;=</span>&nbsp;<span class="num" id="7984254">2</span>&nbsp;<span class="op" id="7984256">&amp;&amp;</span>&nbsp;<span class="ident" id="7984259">parts</span><span class="op" id="7984264">[</span><span class="num" id="7984265">1</span><span class="op" id="7984266">]</span>&nbsp;<span class="op" id="7984268">==</span>&nbsp;<span class="string" id="7984271">&#34;badConn&#34;</span>&nbsp;<span class="op" id="7984281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7984285">conn</span><span class="op" id="7984289">.</span><span class="ident" id="7984290">bad</span>&nbsp;<span class="op" id="7984294">=</span>&nbsp;<span class="builtintype" id="7984296">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7984302">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7984305">if</span>&nbsp;<span class="ident" id="7984308">d</span><span class="op" id="7984309">.</span><span class="ident" id="7984310">waitCh</span>&nbsp;<span class="op" id="7984317">!=</span>&nbsp;<span class="ident" id="7984320">nil</span>&nbsp;<span class="op" id="7984324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7984328">d</span><span class="op" id="7984329">.</span><span class="ident" id="7984330">waitingCh</span>&nbsp;<span class="op" id="7984340">&lt;-</span>&nbsp;<span class="keyword" id="7984343">struct</span><span class="op" id="7984349">{</span><span class="op" id="7984350">}</span><span class="op" id="7984351">{</span><span class="op" id="7984352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7984356">&lt;-</span><span class="ident" id="7984358">d</span><span class="op" id="7984359">.</span><span class="ident" id="7984360">waitCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7984369">d</span><span class="op" id="7984370">.</span><span class="ident" id="7984371">waitCh</span>&nbsp;<span class="op" id="7984378">=</span>&nbsp;<span class="ident" id="7984380">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7984386">d</span><span class="op" id="7984387">.</span><span class="ident" id="7984388">waitingCh</span>&nbsp;<span class="op" id="7984398">=</span>&nbsp;<span class="ident" id="7984400">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7984405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7984408">return</span>&nbsp;<span class="ident" id="7984415">conn</span><span class="op" id="7984419">,</span>&nbsp;<span class="ident" id="7984421">nil</span><br>
<span class="lineno"></span><span class="op" id="7984425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7984428">func</span>&nbsp;<span class="op" id="7984433">(</span><span class="ident" id="7984434">d</span>&nbsp;<span class="op" id="7984436">*</span><span class="ident" id="7984437">fakeDriver</span><span class="op" id="7984447">)</span>&nbsp;<span class="ident" id="7984449">getDB</span><span class="op" id="7984454">(</span><span class="ident" id="7984455">name</span>&nbsp;<span class="builtintype" id="7984460">string</span><span class="op" id="7984466">)</span>&nbsp;<span class="op" id="7984468">*</span><span class="ident" id="7984469">fakeDB</span>&nbsp;<span class="op" id="7984476">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7984479">d</span><span class="op" id="7984480">.</span><span class="ident" id="7984481">mu</span><span class="op" id="7984483">.</span><span class="ident" id="7984484">Lock</span><span class="op" id="7984488">(</span><span class="op" id="7984489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7984492">defer</span>&nbsp;<span class="ident" id="7984498">d</span><span class="op" id="7984499">.</span><span class="ident" id="7984500">mu</span><span class="op" id="7984502">.</span><span class="ident" id="7984503">Unlock</span><span class="op" id="7984509">(</span><span class="op" id="7984510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7984513">if</span>&nbsp;<span class="ident" id="7984516">d</span><span class="op" id="7984517">.</span><span class="ident" id="7984518">dbs</span>&nbsp;<span class="op" id="7984522">==</span>&nbsp;<span class="ident" id="7984525">nil</span>&nbsp;<span class="op" id="7984529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7984533">d</span><span class="op" id="7984534">.</span><span class="ident" id="7984535">dbs</span>&nbsp;<span class="op" id="7984539">=</span>&nbsp;<span class="builtinfunc" id="7984541">make</span><span class="op" id="7984545">(</span><span class="keyword" id="7984546">map</span><span class="op" id="7984549">[</span><span class="builtintype" id="7984550">string</span><span class="op" id="7984556">]</span><span class="op" id="7984557">*</span><span class="ident" id="7984558">fakeDB</span><span class="op" id="7984564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7984567">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7984570">db</span><span class="op" id="7984572">,</span>&nbsp;<span class="ident" id="7984574">ok</span>&nbsp;<span class="op" id="7984577">:=</span>&nbsp;<span class="ident" id="7984580">d</span><span class="op" id="7984581">.</span><span class="ident" id="7984582">dbs</span><span class="op" id="7984585">[</span><span class="ident" id="7984586">name</span><span class="op" id="7984590">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7984593">if</span>&nbsp;<span class="op" id="7984596">!</span><span class="ident" id="7984597">ok</span>&nbsp;<span class="op" id="7984600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7984604">db</span>&nbsp;<span class="op" id="7984607">=</span>&nbsp;<span class="op" id="7984609">&amp;</span><span class="ident" id="7984610">fakeDB</span><span class="op" id="7984616">{</span><span class="ident" id="7984617">name</span><span class="op" id="7984621">:</span>&nbsp;<span class="ident" id="7984623">name</span><span class="op" id="7984627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7984631">d</span><span class="op" id="7984632">.</span><span class="ident" id="7984633">dbs</span><span class="op" id="7984636">[</span><span class="ident" id="7984637">name</span><span class="op" id="7984641">]</span>&nbsp;<span class="op" id="7984643">=</span>&nbsp;<span class="ident" id="7984645">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7984649">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7984652">return</span>&nbsp;<span class="ident" id="7984659">db</span><br>
<span class="lineno"></span><span class="op" id="7984662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7984665">func</span>&nbsp;<span class="op" id="7984670">(</span><span class="ident" id="7984671">db</span>&nbsp;<span class="op" id="7984674">*</span><span class="ident" id="7984675">fakeDB</span><span class="op" id="7984681">)</span>&nbsp;<span class="ident" id="7984683">wipe</span><span class="op" id="7984687">(</span><span class="op" id="7984688">)</span>&nbsp;<span class="op" id="7984690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7984693">db</span><span class="op" id="7984695">.</span><span class="ident" id="7984696">mu</span><span class="op" id="7984698">.</span><span class="ident" id="7984699">Lock</span><span class="op" id="7984703">(</span><span class="op" id="7984704">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7984707">defer</span>&nbsp;<span class="ident" id="7984713">db</span><span class="op" id="7984715">.</span><span class="ident" id="7984716">mu</span><span class="op" id="7984718">.</span><span class="ident" id="7984719">Unlock</span><span class="op" id="7984725">(</span><span class="op" id="7984726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7984729">db</span><span class="op" id="7984731">.</span><span class="ident" id="7984732">tables</span>&nbsp;<span class="op" id="7984739">=</span>&nbsp;<span class="ident" id="7984741">nil</span><br>
<span class="lineno"></span><span class="op" id="7984745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7984748">func</span>&nbsp;<span class="op" id="7984753">(</span><span class="ident" id="7984754">db</span>&nbsp;<span class="op" id="7984757">*</span><span class="ident" id="7984758">fakeDB</span><span class="op" id="7984764">)</span>&nbsp;<span class="ident" id="7984766">createTable</span><span class="op" id="7984777">(</span><span class="ident" id="7984778">name</span>&nbsp;<span class="builtintype" id="7984783">string</span><span class="op" id="7984789">,</span>&nbsp;<span class="ident" id="7984791">columnNames</span><span class="op" id="7984802">,</span>&nbsp;<span class="ident" id="7984804">columnTypes</span>&nbsp;<span class="op" id="7984816">[</span><span class="op" id="7984817">]</span><span class="builtintype" id="7984818">string</span><span class="op" id="7984824">)</span>&nbsp;<span class="builtintype" id="7984826">error</span>&nbsp;<span class="op" id="7984832">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7984835">db</span><span class="op" id="7984837">.</span><span class="ident" id="7984838">mu</span><span class="op" id="7984840">.</span><span class="ident" id="7984841">Lock</span><span class="op" id="7984845">(</span><span class="op" id="7984846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7984849">defer</span>&nbsp;<span class="ident" id="7984855">db</span><span class="op" id="7984857">.</span><span class="ident" id="7984858">mu</span><span class="op" id="7984860">.</span><span class="ident" id="7984861">Unlock</span><span class="op" id="7984867">(</span><span class="op" id="7984868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7984871">if</span>&nbsp;<span class="ident" id="7984874">db</span><span class="op" id="7984876">.</span><span class="ident" id="7984877">tables</span>&nbsp;<span class="op" id="7984884">==</span>&nbsp;<span class="ident" id="7984887">nil</span>&nbsp;<span class="op" id="7984891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7984895">db</span><span class="op" id="7984897">.</span><span class="ident" id="7984898">tables</span>&nbsp;<span class="op" id="7984905">=</span>&nbsp;<span class="builtinfunc" id="7984907">make</span><span class="op" id="7984911">(</span><span class="keyword" id="7984912">map</span><span class="op" id="7984915">[</span><span class="builtintype" id="7984916">string</span><span class="op" id="7984922">]</span><span class="op" id="7984923">*</span><span class="ident" id="7984924">table</span><span class="op" id="7984929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7984932">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7984935">if</span>&nbsp;<span class="ident" id="7984938">_</span><span class="op" id="7984939">,</span>&nbsp;<span class="ident" id="7984941">exist</span>&nbsp;<span class="op" id="7984947">:=</span>&nbsp;<span class="ident" id="7984950">db</span><span class="op" id="7984952">.</span><span class="ident" id="7984953">tables</span><span class="op" id="7984959">[</span><span class="ident" id="7984960">name</span><span class="op" id="7984964">]</span><span class="op" id="7984965">;</span>&nbsp;<span class="ident" id="7984967">exist</span>&nbsp;<span class="op" id="7984973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7984977">return</span>&nbsp;<span class="ident" id="7984984">fmt</span><span class="op" id="7984987">.</span><span class="ident" id="7984988">Errorf</span><span class="op" id="7984994">(</span><span class="string" id="7984995">&#34;table&nbsp;%q&nbsp;already&nbsp;exists&#34;</span><span class="op" id="7985020">,</span>&nbsp;<span class="ident" id="7985022">name</span><span class="op" id="7985026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7985029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7985032">if</span>&nbsp;<span class="builtinfunc" id="7985035">len</span><span class="op" id="7985038">(</span><span class="ident" id="7985039">columnNames</span><span class="op" id="7985050">)</span>&nbsp;<span class="op" id="7985052">!=</span>&nbsp;<span class="builtinfunc" id="7985055">len</span><span class="op" id="7985058">(</span><span class="ident" id="7985059">columnTypes</span><span class="op" id="7985070">)</span>&nbsp;<span class="op" id="7985072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7985076">return</span>&nbsp;<span class="ident" id="7985083">fmt</span><span class="op" id="7985086">.</span><span class="ident" id="7985087">Errorf</span><span class="op" id="7985093">(</span><span class="string" id="7985094">&#34;create&nbsp;table&nbsp;of&nbsp;%q&nbsp;len(names)&nbsp;!=&nbsp;len(types):&nbsp;%d&nbsp;vs&nbsp;%d&#34;</span><span class="op" id="7985149">,</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7985154">name</span><span class="op" id="7985158">,</span>&nbsp;<span class="builtinfunc" id="7985160">len</span><span class="op" id="7985163">(</span><span class="ident" id="7985164">columnNames</span><span class="op" id="7985175">)</span><span class="op" id="7985176">,</span>&nbsp;<span class="builtinfunc" id="7985178">len</span><span class="op" id="7985181">(</span><span class="ident" id="7985182">columnTypes</span><span class="op" id="7985193">)</span><span class="op" id="7985194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7985197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7985200">db</span><span class="op" id="7985202">.</span><span class="ident" id="7985203">tables</span><span class="op" id="7985209">[</span><span class="ident" id="7985210">name</span><span class="op" id="7985214">]</span>&nbsp;<span class="op" id="7985216">=</span>&nbsp;<span class="op" id="7985218">&amp;</span><span class="ident" id="7985219">table</span><span class="op" id="7985224">{</span><span class="ident" id="7985225">colname</span><span class="op" id="7985232">:</span>&nbsp;<span class="ident" id="7985234">columnNames</span><span class="op" id="7985245">,</span>&nbsp;<span class="ident" id="7985247">coltype</span><span class="op" id="7985254">:</span>&nbsp;<span class="ident" id="7985256">columnTypes</span><span class="op" id="7985267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7985270">return</span>&nbsp;<span class="ident" id="7985277">nil</span><br>
<span class="lineno"></span><span class="op" id="7985281">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="7985284">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;db.mu&nbsp;lock&nbsp;held</span><br>
<span class="lineno"></span><span class="keyword" id="7985323">func</span>&nbsp;<span class="op" id="7985328">(</span><span class="ident" id="7985329">db</span>&nbsp;<span class="op" id="7985332">*</span><span class="ident" id="7985333">fakeDB</span><span class="op" id="7985339">)</span>&nbsp;<span class="ident" id="7985341">table</span><span class="op" id="7985346">(</span><span class="ident" id="7985347">table</span>&nbsp;<span class="builtintype" id="7985353">string</span><span class="op" id="7985359">)</span>&nbsp;<span class="op" id="7985361">(</span><span class="op" id="7985362">*</span><span class="ident" id="7985363">table</span><span class="op" id="7985368">,</span>&nbsp;<span class="builtintype" id="7985370">bool</span><span class="op" id="7985374">)</span>&nbsp;<span class="op" id="7985376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7985379">if</span>&nbsp;<span class="ident" id="7985382">db</span><span class="op" id="7985384">.</span><span class="ident" id="7985385">tables</span>&nbsp;<span class="op" id="7985392">==</span>&nbsp;<span class="ident" id="7985395">nil</span>&nbsp;<span class="op" id="7985399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7985403">return</span>&nbsp;<span class="ident" id="7985410">nil</span><span class="op" id="7985413">,</span>&nbsp;<span class="builtintype" id="7985415">false</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7985422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7985425">t</span><span class="op" id="7985426">,</span>&nbsp;<span class="ident" id="7985428">ok</span>&nbsp;<span class="op" id="7985431">:=</span>&nbsp;<span class="ident" id="7985434">db</span><span class="op" id="7985436">.</span><span class="ident" id="7985437">tables</span><span class="op" id="7985443">[</span><span class="ident" id="7985444">table</span><span class="op" id="7985449">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7985452">return</span>&nbsp;<span class="ident" id="7985459">t</span><span class="op" id="7985460">,</span>&nbsp;<span class="ident" id="7985462">ok</span><br>
<span class="lineno"></span><span class="op" id="7985465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="7985468">func</span>&nbsp;<span class="op" id="7985473">(</span><span class="ident" id="7985474">db</span>&nbsp;<span class="op" id="7985477">*</span><span class="ident" id="7985478">fakeDB</span><span class="op" id="7985484">)</span>&nbsp;<span class="ident" id="7985486">columnType</span><span class="op" id="7985496">(</span><span class="ident" id="7985497">table</span><span class="op" id="7985502">,</span>&nbsp;<span class="ident" id="7985504">column</span>&nbsp;<span class="builtintype" id="7985511">string</span><span class="op" id="7985517">)</span>&nbsp;<span class="op" id="7985519">(</span><span class="ident" id="7985520">typ</span>&nbsp;<span class="builtintype" id="7985524">string</span><span class="op" id="7985530">,</span>&nbsp;<span class="ident" id="7985532">ok</span>&nbsp;<span class="builtintype" id="7985535">bool</span><span class="op" id="7985539">)</span>&nbsp;<span class="op" id="7985541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7985544">db</span><span class="op" id="7985546">.</span><span class="ident" id="7985547">mu</span><span class="op" id="7985549">.</span><span class="ident" id="7985550">Lock</span><span class="op" id="7985554">(</span><span class="op" id="7985555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7985558">defer</span>&nbsp;<span class="ident" id="7985564">db</span><span class="op" id="7985566">.</span><span class="ident" id="7985567">mu</span><span class="op" id="7985569">.</span><span class="ident" id="7985570">Unlock</span><span class="op" id="7985576">(</span><span class="op" id="7985577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7985580">t</span><span class="op" id="7985581">,</span>&nbsp;<span class="ident" id="7985583">ok</span>&nbsp;<span class="op" id="7985586">:=</span>&nbsp;<span class="ident" id="7985589">db</span><span class="op" id="7985591">.</span><span class="ident" id="7985592">table</span><span class="op" id="7985597">(</span><span class="ident" id="7985598">table</span><span class="op" id="7985603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7985606">if</span>&nbsp;<span class="op" id="7985609">!</span><span class="ident" id="7985610">ok</span>&nbsp;<span class="op" id="7985613">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7985617">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7985625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7985628">for</span>&nbsp;<span class="ident" id="7985632">n</span><span class="op" id="7985633">,</span>&nbsp;<span class="ident" id="7985635">cname</span>&nbsp;<span class="op" id="7985641">:=</span>&nbsp;<span class="keyword" id="7985644">range</span>&nbsp;<span class="ident" id="7985650">t</span><span class="op" id="7985651">.</span><span class="ident" id="7985652">colname</span>&nbsp;<span class="op" id="7985660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7985664">if</span>&nbsp;<span class="ident" id="7985667">cname</span>&nbsp;<span class="op" id="7985673">==</span>&nbsp;<span class="ident" id="7985676">column</span>&nbsp;<span class="op" id="7985683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7985688">return</span>&nbsp;<span class="ident" id="7985695">t</span><span class="op" id="7985696">.</span><span class="ident" id="7985697">coltype</span><span class="op" id="7985704">[</span><span class="ident" id="7985705">n</span><span class="op" id="7985706">]</span><span class="op" id="7985707">,</span>&nbsp;<span class="builtintype" id="7985709">true</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7985716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7985719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7985722">return</span>&nbsp;<span class="string" id="7985729">&#34;&#34;</span><span class="op" id="7985731">,</span>&nbsp;<span class="builtintype" id="7985733">false</span><br>
<span class="lineno"></span><span class="op" id="7985739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="keyword" id="7985742">func</span>&nbsp;<span class="op" id="7985747">(</span><span class="ident" id="7985748">c</span>&nbsp;<span class="op" id="7985750">*</span><span class="ident" id="7985751">fakeConn</span><span class="op" id="7985759">)</span>&nbsp;<span class="ident" id="7985761">isBad</span><span class="op" id="7985766">(</span><span class="op" id="7985767">)</span>&nbsp;<span class="builtintype" id="7985769">bool</span>&nbsp;<span class="op" id="7985774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7985777">//&nbsp;if&nbsp;not&nbsp;simulating&nbsp;bad&nbsp;conn,&nbsp;do&nbsp;nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7985820">if</span>&nbsp;<span class="op" id="7985823">!</span><span class="ident" id="7985824">c</span><span class="op" id="7985825">.</span><span class="ident" id="7985826">bad</span>&nbsp;<span class="op" id="7985830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7985834">return</span>&nbsp;<span class="builtintype" id="7985841">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7985848">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7985851">//&nbsp;alternate&nbsp;between&nbsp;bad&nbsp;conn&nbsp;and&nbsp;not&nbsp;bad&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7985899">c</span><span class="op" id="7985900">.</span><span class="ident" id="7985901">db</span><span class="op" id="7985903">.</span><span class="ident" id="7985904">badConn</span>&nbsp;<span class="op" id="7985912">=</span>&nbsp;<span class="op" id="7985914">!</span><span class="ident" id="7985915">c</span><span class="op" id="7985916">.</span><span class="ident" id="7985917">db</span><span class="op" id="7985919">.</span><span class="ident" id="7985920">badConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7985929">return</span>&nbsp;<span class="ident" id="7985936">c</span><span class="op" id="7985937">.</span><span class="ident" id="7985938">db</span><span class="op" id="7985940">.</span><span class="ident" id="7985941">badConn</span><br>
<span class="lineno"></span><span class="op" id="7985949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="7985952">func</span>&nbsp;<span class="op" id="7985957">(</span><span class="ident" id="7985958">c</span>&nbsp;<span class="op" id="7985960">*</span><span class="ident" id="7985961">fakeConn</span><span class="op" id="7985969">)</span>&nbsp;<span class="ident" id="7985971">Begin</span><span class="op" id="7985976">(</span><span class="op" id="7985977">)</span>&nbsp;<span class="op" id="7985979">(</span><span class="ident" id="7985980">driver</span><span class="op" id="7985986">.</span><span class="ident" id="7985987">Tx</span><span class="op" id="7985989">,</span>&nbsp;<span class="builtintype" id="7985991">error</span><span class="op" id="7985996">)</span>&nbsp;<span class="op" id="7985998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7986001">if</span>&nbsp;<span class="ident" id="7986004">c</span><span class="op" id="7986005">.</span><span class="ident" id="7986006">isBad</span><span class="op" id="7986011">(</span><span class="op" id="7986012">)</span>&nbsp;<span class="op" id="7986014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7986018">return</span>&nbsp;<span class="ident" id="7986025">nil</span><span class="op" id="7986028">,</span>&nbsp;<span class="ident" id="7986030">driver</span><span class="op" id="7986036">.</span><span class="ident" id="7986037">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7986049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7986052">if</span>&nbsp;<span class="ident" id="7986055">c</span><span class="op" id="7986056">.</span><span class="ident" id="7986057">currTx</span>&nbsp;<span class="op" id="7986064">!=</span>&nbsp;<span class="ident" id="7986067">nil</span>&nbsp;<span class="op" id="7986071">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7986075">return</span>&nbsp;<span class="ident" id="7986082">nil</span><span class="op" id="7986085">,</span>&nbsp;<span class="ident" id="7986087">errors</span><span class="op" id="7986093">.</span><span class="ident" id="7986094">New</span><span class="op" id="7986097">(</span><span class="string" id="7986098">&#34;already&nbsp;in&nbsp;a&nbsp;transaction&#34;</span><span class="op" id="7986124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7986127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7986130">c</span><span class="op" id="7986131">.</span><span class="ident" id="7986132">currTx</span>&nbsp;<span class="op" id="7986139">=</span>&nbsp;<span class="op" id="7986141">&amp;</span><span class="ident" id="7986142">fakeTx</span><span class="op" id="7986148">{</span><span class="ident" id="7986149">c</span><span class="op" id="7986150">:</span>&nbsp;<span class="ident" id="7986152">c</span><span class="op" id="7986153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7986156">return</span>&nbsp;<span class="ident" id="7986163">c</span><span class="op" id="7986164">.</span><span class="ident" id="7986165">currTx</span><span class="op" id="7986171">,</span>&nbsp;<span class="ident" id="7986173">nil</span><br>
<span class="lineno"></span><span class="op" id="7986177">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="7986180">var</span>&nbsp;<span class="ident" id="7986184">hookPostCloseConn</span>&nbsp;<span class="keyword" id="7986202">struct</span>&nbsp;<span class="op" id="7986209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7986212">sync</span><span class="op" id="7986216">.</span><span class="ident" id="7986217">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7986224">fn</span>&nbsp;<span class="keyword" id="7986227">func</span><span class="op" id="7986231">(</span><span class="op" id="7986232">*</span><span class="ident" id="7986233">fakeConn</span><span class="op" id="7986241">,</span>&nbsp;<span class="builtintype" id="7986243">error</span><span class="op" id="7986248">)</span><br>
<span class="lineno"></span><span class="op" id="7986250">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="7986253">func</span>&nbsp;<span class="ident" id="7986258">setHookpostCloseConn</span><span class="op" id="7986278">(</span><span class="ident" id="7986279">fn</span>&nbsp;<span class="keyword" id="7986282">func</span><span class="op" id="7986286">(</span><span class="op" id="7986287">*</span><span class="ident" id="7986288">fakeConn</span><span class="op" id="7986296">,</span>&nbsp;<span class="builtintype" id="7986298">error</span><span class="op" id="7986303">)</span><span class="op" id="7986304">)</span>&nbsp;<span class="op" id="7986306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7986309">hookPostCloseConn</span><span class="op" id="7986326">.</span><span class="ident" id="7986327">Lock</span><span class="op" id="7986331">(</span><span class="op" id="7986332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7986335">defer</span>&nbsp;<span class="ident" id="7986341">hookPostCloseConn</span><span class="op" id="7986358">.</span><span class="ident" id="7986359">Unlock</span><span class="op" id="7986365">(</span><span class="op" id="7986366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7986369">hookPostCloseConn</span><span class="op" id="7986386">.</span><span class="ident" id="7986387">fn</span>&nbsp;<span class="op" id="7986390">=</span>&nbsp;<span class="ident" id="7986392">fn</span><br>
<span class="lineno">275</span><span class="op" id="7986395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7986398">var</span>&nbsp;<span class="ident" id="7986402">testStrictClose</span>&nbsp;<span class="op" id="7986418">*</span><span class="ident" id="7986419">testing</span><span class="op" id="7986426">.</span><span class="ident" id="7986427">T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7986430">//&nbsp;setStrictFakeConnClose&nbsp;sets&nbsp;the&nbsp;t&nbsp;to&nbsp;Errorf&nbsp;on&nbsp;when&nbsp;fakeConn.Close</span><br>
<span class="lineno">280</span><span class="comment" id="7986500">//&nbsp;fails&nbsp;to&nbsp;close.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;check&nbsp;is&nbsp;disabled.</span><br>
<span class="lineno"></span><span class="keyword" id="7986550">func</span>&nbsp;<span class="ident" id="7986555">setStrictFakeConnClose</span><span class="op" id="7986577">(</span><span class="ident" id="7986578">t</span>&nbsp;<span class="op" id="7986580">*</span><span class="ident" id="7986581">testing</span><span class="op" id="7986588">.</span><span class="ident" id="7986589">T</span><span class="op" id="7986590">)</span>&nbsp;<span class="op" id="7986592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7986595">testStrictClose</span>&nbsp;<span class="op" id="7986611">=</span>&nbsp;<span class="ident" id="7986613">t</span><br>
<span class="lineno"></span><span class="op" id="7986615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="7986618">func</span>&nbsp;<span class="op" id="7986623">(</span><span class="ident" id="7986624">c</span>&nbsp;<span class="op" id="7986626">*</span><span class="ident" id="7986627">fakeConn</span><span class="op" id="7986635">)</span>&nbsp;<span class="ident" id="7986637">Close</span><span class="op" id="7986642">(</span><span class="op" id="7986643">)</span>&nbsp;<span class="op" id="7986645">(</span><span class="ident" id="7986646">err</span>&nbsp;<span class="builtintype" id="7986650">error</span><span class="op" id="7986655">)</span>&nbsp;<span class="op" id="7986657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7986660">drv</span>&nbsp;<span class="op" id="7986664">:=</span>&nbsp;<span class="ident" id="7986667">fdriver</span><span class="op" id="7986674">.</span><span class="op" id="7986675">(</span><span class="op" id="7986676">*</span><span class="ident" id="7986677">fakeDriver</span><span class="op" id="7986687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7986690">defer</span>&nbsp;<span class="keyword" id="7986696">func</span><span class="op" id="7986700">(</span><span class="op" id="7986701">)</span>&nbsp;<span class="op" id="7986703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7986707">if</span>&nbsp;<span class="ident" id="7986710">err</span>&nbsp;<span class="op" id="7986714">!=</span>&nbsp;<span class="ident" id="7986717">nil</span>&nbsp;<span class="op" id="7986721">&amp;&amp;</span>&nbsp;<span class="ident" id="7986724">testStrictClose</span>&nbsp;<span class="op" id="7986740">!=</span>&nbsp;<span class="ident" id="7986743">nil</span>&nbsp;<span class="op" id="7986747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7986752">testStrictClose</span><span class="op" id="7986767">.</span><span class="ident" id="7986768">Errorf</span><span class="op" id="7986774">(</span><span class="string" id="7986775">&#34;failed&nbsp;to&nbsp;close&nbsp;a&nbsp;test&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="7986812">,</span>&nbsp;<span class="ident" id="7986814">err</span><span class="op" id="7986817">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7986821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7986825">hookPostCloseConn</span><span class="op" id="7986842">.</span><span class="ident" id="7986843">Lock</span><span class="op" id="7986847">(</span><span class="op" id="7986848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7986852">fn</span>&nbsp;<span class="op" id="7986855">:=</span>&nbsp;<span class="ident" id="7986858">hookPostCloseConn</span><span class="op" id="7986875">.</span><span class="ident" id="7986876">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7986881">hookPostCloseConn</span><span class="op" id="7986898">.</span><span class="ident" id="7986899">Unlock</span><span class="op" id="7986905">(</span><span class="op" id="7986906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7986910">if</span>&nbsp;<span class="ident" id="7986913">fn</span>&nbsp;<span class="op" id="7986916">!=</span>&nbsp;<span class="ident" id="7986919">nil</span>&nbsp;<span class="op" id="7986923">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7986928">fn</span><span class="op" id="7986930">(</span><span class="ident" id="7986931">c</span><span class="op" id="7986932">,</span>&nbsp;<span class="ident" id="7986934">err</span><span class="op" id="7986937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7986941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7986945">if</span>&nbsp;<span class="ident" id="7986948">err</span>&nbsp;<span class="op" id="7986952">==</span>&nbsp;<span class="ident" id="7986955">nil</span>&nbsp;<span class="op" id="7986959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7986964">drv</span><span class="op" id="7986967">.</span><span class="ident" id="7986968">mu</span><span class="op" id="7986970">.</span><span class="ident" id="7986971">Lock</span><span class="op" id="7986975">(</span><span class="op" id="7986976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7986981">drv</span><span class="op" id="7986984">.</span><span class="ident" id="7986985">closeCount</span><span class="op" id="7986995">++</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7987001">drv</span><span class="op" id="7987004">.</span><span class="ident" id="7987005">mu</span><span class="op" id="7987007">.</span><span class="ident" id="7987008">Unlock</span><span class="op" id="7987014">(</span><span class="op" id="7987015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7987019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7987022">}</span><span class="op" id="7987023">(</span><span class="op" id="7987024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7987027">if</span>&nbsp;<span class="ident" id="7987030">c</span><span class="op" id="7987031">.</span><span class="ident" id="7987032">currTx</span>&nbsp;<span class="op" id="7987039">!=</span>&nbsp;<span class="ident" id="7987042">nil</span>&nbsp;<span class="op" id="7987046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7987050">return</span>&nbsp;<span class="ident" id="7987057">errors</span><span class="op" id="7987063">.</span><span class="ident" id="7987064">New</span><span class="op" id="7987067">(</span><span class="string" id="7987068">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;in&nbsp;a&nbsp;Transaction&#34;</span><span class="op" id="7987108">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7987111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7987114">if</span>&nbsp;<span class="ident" id="7987117">c</span><span class="op" id="7987118">.</span><span class="ident" id="7987119">db</span>&nbsp;<span class="op" id="7987122">==</span>&nbsp;<span class="ident" id="7987125">nil</span>&nbsp;<span class="op" id="7987129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7987133">return</span>&nbsp;<span class="ident" id="7987140">errors</span><span class="op" id="7987146">.</span><span class="ident" id="7987147">New</span><span class="op" id="7987150">(</span><span class="string" id="7987151">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;already&nbsp;closed&#34;</span><span class="op" id="7987189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7987192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7987195">if</span>&nbsp;<span class="ident" id="7987198">c</span><span class="op" id="7987199">.</span><span class="ident" id="7987200">stmtsMade</span>&nbsp;<span class="op" id="7987210">&gt;</span>&nbsp;<span class="ident" id="7987212">c</span><span class="op" id="7987213">.</span><span class="ident" id="7987214">stmtsClosed</span>&nbsp;<span class="op" id="7987226">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7987230">return</span>&nbsp;<span class="ident" id="7987237">errors</span><span class="op" id="7987243">.</span><span class="ident" id="7987244">New</span><span class="op" id="7987247">(</span><span class="string" id="7987248">&#34;can&#39;t&nbsp;close;&nbsp;dangling&nbsp;statement(s)&#34;</span><span class="op" id="7987284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7987287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7987290">c</span><span class="op" id="7987291">.</span><span class="ident" id="7987292">db</span>&nbsp;<span class="op" id="7987295">=</span>&nbsp;<span class="ident" id="7987297">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7987302">return</span>&nbsp;<span class="ident" id="7987309">nil</span><br>
<span class="lineno"></span><span class="op" id="7987313">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="7987316">func</span>&nbsp;<span class="ident" id="7987321">checkSubsetTypes</span><span class="op" id="7987337">(</span><span class="ident" id="7987338">args</span>&nbsp;<span class="op" id="7987343">[</span><span class="op" id="7987344">]</span><span class="ident" id="7987345">driver</span><span class="op" id="7987351">.</span><span class="ident" id="7987352">Value</span><span class="op" id="7987357">)</span>&nbsp;<span class="builtintype" id="7987359">error</span>&nbsp;<span class="op" id="7987365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7987368">for</span>&nbsp;<span class="ident" id="7987372">n</span><span class="op" id="7987373">,</span>&nbsp;<span class="ident" id="7987375">arg</span>&nbsp;<span class="op" id="7987379">:=</span>&nbsp;<span class="keyword" id="7987382">range</span>&nbsp;<span class="ident" id="7987388">args</span>&nbsp;<span class="op" id="7987393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7987397">switch</span>&nbsp;<span class="ident" id="7987404">arg</span><span class="op" id="7987407">.</span><span class="op" id="7987408">(</span><span class="keyword" id="7987409">type</span><span class="op" id="7987413">)</span>&nbsp;<span class="op" id="7987415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7987419">case</span>&nbsp;<span class="ident" id="7987424">int64</span><span class="op" id="7987429">,</span>&nbsp;<span class="builtintype" id="7987431">float64</span><span class="op" id="7987438">,</span>&nbsp;<span class="builtintype" id="7987440">bool</span><span class="op" id="7987444">,</span>&nbsp;<span class="ident" id="7987446">nil</span><span class="op" id="7987449">,</span>&nbsp;<span class="op" id="7987451">[</span><span class="op" id="7987452">]</span><span class="builtintype" id="7987453">byte</span><span class="op" id="7987457">,</span>&nbsp;<span class="builtintype" id="7987459">string</span><span class="op" id="7987465">,</span>&nbsp;<span class="ident" id="7987467">time</span><span class="op" id="7987471">.</span><span class="ident" id="7987472">Time</span><span class="op" id="7987476">:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7987480">default</span><span class="op" id="7987487">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7987492">return</span>&nbsp;<span class="ident" id="7987499">fmt</span><span class="op" id="7987502">.</span><span class="ident" id="7987503">Errorf</span><span class="op" id="7987509">(</span><span class="string" id="7987510">&#34;fakedb_test:&nbsp;invalid&nbsp;argument&nbsp;#%d:&nbsp;%v,&nbsp;type&nbsp;%T&#34;</span><span class="op" id="7987558">,</span>&nbsp;<span class="ident" id="7987560">n</span><span class="op" id="7987561">+</span><span class="num" id="7987562">1</span><span class="op" id="7987563">,</span>&nbsp;<span class="ident" id="7987565">arg</span><span class="op" id="7987568">,</span>&nbsp;<span class="ident" id="7987570">arg</span><span class="op" id="7987573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7987577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7987580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7987583">return</span>&nbsp;<span class="ident" id="7987590">nil</span><br>
<span class="lineno">325</span><span class="op" id="7987594">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7987597">func</span>&nbsp;<span class="op" id="7987602">(</span><span class="ident" id="7987603">c</span>&nbsp;<span class="op" id="7987605">*</span><span class="ident" id="7987606">fakeConn</span><span class="op" id="7987614">)</span>&nbsp;<span class="ident" id="7987616">Exec</span><span class="op" id="7987620">(</span><span class="ident" id="7987621">query</span>&nbsp;<span class="builtintype" id="7987627">string</span><span class="op" id="7987633">,</span>&nbsp;<span class="ident" id="7987635">args</span>&nbsp;<span class="op" id="7987640">[</span><span class="op" id="7987641">]</span><span class="ident" id="7987642">driver</span><span class="op" id="7987648">.</span><span class="ident" id="7987649">Value</span><span class="op" id="7987654">)</span>&nbsp;<span class="op" id="7987656">(</span><span class="ident" id="7987657">driver</span><span class="op" id="7987663">.</span><span class="ident" id="7987664">Result</span><span class="op" id="7987670">,</span>&nbsp;<span class="builtintype" id="7987672">error</span><span class="op" id="7987677">)</span>&nbsp;<span class="op" id="7987679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7987682">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7987743">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7987804">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7987863">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7987890">err</span>&nbsp;<span class="op" id="7987894">:=</span>&nbsp;<span class="ident" id="7987897">checkSubsetTypes</span><span class="op" id="7987913">(</span><span class="ident" id="7987914">args</span><span class="op" id="7987918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7987921">if</span>&nbsp;<span class="ident" id="7987924">err</span>&nbsp;<span class="op" id="7987928">!=</span>&nbsp;<span class="ident" id="7987931">nil</span>&nbsp;<span class="op" id="7987935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7987939">return</span>&nbsp;<span class="ident" id="7987946">nil</span><span class="op" id="7987949">,</span>&nbsp;<span class="ident" id="7987951">err</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7987956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7987959">return</span>&nbsp;<span class="ident" id="7987966">nil</span><span class="op" id="7987969">,</span>&nbsp;<span class="ident" id="7987971">driver</span><span class="op" id="7987977">.</span><span class="ident" id="7987978">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="7987986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7987989">func</span>&nbsp;<span class="op" id="7987994">(</span><span class="ident" id="7987995">c</span>&nbsp;<span class="op" id="7987997">*</span><span class="ident" id="7987998">fakeConn</span><span class="op" id="7988006">)</span>&nbsp;<span class="ident" id="7988008">Query</span><span class="op" id="7988013">(</span><span class="ident" id="7988014">query</span>&nbsp;<span class="builtintype" id="7988020">string</span><span class="op" id="7988026">,</span>&nbsp;<span class="ident" id="7988028">args</span>&nbsp;<span class="op" id="7988033">[</span><span class="op" id="7988034">]</span><span class="ident" id="7988035">driver</span><span class="op" id="7988041">.</span><span class="ident" id="7988042">Value</span><span class="op" id="7988047">)</span>&nbsp;<span class="op" id="7988049">(</span><span class="ident" id="7988050">driver</span><span class="op" id="7988056">.</span><span class="ident" id="7988057">Rows</span><span class="op" id="7988061">,</span>&nbsp;<span class="builtintype" id="7988063">error</span><span class="op" id="7988068">)</span>&nbsp;<span class="op" id="7988070">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7988073">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7988134">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7988195">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7988254">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7988281">err</span>&nbsp;<span class="op" id="7988285">:=</span>&nbsp;<span class="ident" id="7988288">checkSubsetTypes</span><span class="op" id="7988304">(</span><span class="ident" id="7988305">args</span><span class="op" id="7988309">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7988312">if</span>&nbsp;<span class="ident" id="7988315">err</span>&nbsp;<span class="op" id="7988319">!=</span>&nbsp;<span class="ident" id="7988322">nil</span>&nbsp;<span class="op" id="7988326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7988330">return</span>&nbsp;<span class="ident" id="7988337">nil</span><span class="op" id="7988340">,</span>&nbsp;<span class="ident" id="7988342">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7988347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7988350">return</span>&nbsp;<span class="ident" id="7988357">nil</span><span class="op" id="7988360">,</span>&nbsp;<span class="ident" id="7988362">driver</span><span class="op" id="7988368">.</span><span class="ident" id="7988369">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="7988377">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="7988380">func</span>&nbsp;<span class="ident" id="7988385">errf</span><span class="op" id="7988389">(</span><span class="ident" id="7988390">msg</span>&nbsp;<span class="builtintype" id="7988394">string</span><span class="op" id="7988400">,</span>&nbsp;<span class="ident" id="7988402">args</span>&nbsp;<span class="op" id="7988407">...</span><span class="keyword" id="7988410">interface</span><span class="op" id="7988419">{</span><span class="op" id="7988420">}</span><span class="op" id="7988421">)</span>&nbsp;<span class="builtintype" id="7988423">error</span>&nbsp;<span class="op" id="7988429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7988432">return</span>&nbsp;<span class="ident" id="7988439">errors</span><span class="op" id="7988445">.</span><span class="ident" id="7988446">New</span><span class="op" id="7988449">(</span><span class="string" id="7988450">&#34;fakedb:&nbsp;&#34;</span>&nbsp;<span class="op" id="7988461">+</span>&nbsp;<span class="ident" id="7988463">fmt</span><span class="op" id="7988466">.</span><span class="ident" id="7988467">Sprintf</span><span class="op" id="7988474">(</span><span class="ident" id="7988475">msg</span><span class="op" id="7988478">,</span>&nbsp;<span class="ident" id="7988480">args</span><span class="op" id="7988484">...</span><span class="op" id="7988487">)</span><span class="op" id="7988488">)</span><br>
<span class="lineno"></span><span class="op" id="7988490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment" id="7988493">//&nbsp;parts&nbsp;are&nbsp;table|selectCol1,selectCol2|whereCol=?,whereCol2=?</span><br>
<span class="lineno"></span><span class="comment" id="7988557">//&nbsp;(note&nbsp;that&nbsp;where&nbsp;columns&nbsp;must&nbsp;always&nbsp;contain&nbsp;?&nbsp;marks,</span><br>
<span class="lineno"></span><span class="comment" id="7988614">//&nbsp;&nbsp;just&nbsp;a&nbsp;limitation&nbsp;for&nbsp;fakedb)</span><br>
<span class="lineno"></span><span class="keyword" id="7988648">func</span>&nbsp;<span class="op" id="7988653">(</span><span class="ident" id="7988654">c</span>&nbsp;<span class="op" id="7988656">*</span><span class="ident" id="7988657">fakeConn</span><span class="op" id="7988665">)</span>&nbsp;<span class="ident" id="7988667">prepareSelect</span><span class="op" id="7988680">(</span><span class="ident" id="7988681">stmt</span>&nbsp;<span class="op" id="7988686">*</span><span class="ident" id="7988687">fakeStmt</span><span class="op" id="7988695">,</span>&nbsp;<span class="ident" id="7988697">parts</span>&nbsp;<span class="op" id="7988703">[</span><span class="op" id="7988704">]</span><span class="builtintype" id="7988705">string</span><span class="op" id="7988711">)</span>&nbsp;<span class="op" id="7988713">(</span><span class="ident" id="7988714">driver</span><span class="op" id="7988720">.</span><span class="ident" id="7988721">Stmt</span><span class="op" id="7988725">,</span>&nbsp;<span class="builtintype" id="7988727">error</span><span class="op" id="7988732">)</span>&nbsp;<span class="op" id="7988734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7988737">if</span>&nbsp;<span class="builtinfunc" id="7988740">len</span><span class="op" id="7988743">(</span><span class="ident" id="7988744">parts</span><span class="op" id="7988749">)</span>&nbsp;<span class="op" id="7988751">!=</span>&nbsp;<span class="num" id="7988754">3</span>&nbsp;<span class="op" id="7988756">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7988760">stmt</span><span class="op" id="7988764">.</span><span class="ident" id="7988765">Close</span><span class="op" id="7988770">(</span><span class="op" id="7988771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7988775">return</span>&nbsp;<span class="ident" id="7988782">nil</span><span class="op" id="7988785">,</span>&nbsp;<span class="ident" id="7988787">errf</span><span class="op" id="7988791">(</span><span class="string" id="7988792">&#34;invalid&nbsp;SELECT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;3&#34;</span><span class="op" id="7988837">,</span>&nbsp;<span class="builtinfunc" id="7988839">len</span><span class="op" id="7988842">(</span><span class="ident" id="7988843">parts</span><span class="op" id="7988848">)</span><span class="op" id="7988849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7988852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7988855">stmt</span><span class="op" id="7988859">.</span><span class="ident" id="7988860">table</span>&nbsp;<span class="op" id="7988866">=</span>&nbsp;<span class="ident" id="7988868">parts</span><span class="op" id="7988873">[</span><span class="num" id="7988874">0</span><span class="op" id="7988875">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7988878">stmt</span><span class="op" id="7988882">.</span><span class="ident" id="7988883">colName</span>&nbsp;<span class="op" id="7988891">=</span>&nbsp;<span class="ident" id="7988893">strings</span><span class="op" id="7988900">.</span><span class="ident" id="7988901">Split</span><span class="op" id="7988906">(</span><span class="ident" id="7988907">parts</span><span class="op" id="7988912">[</span><span class="num" id="7988913">1</span><span class="op" id="7988914">]</span><span class="op" id="7988915">,</span>&nbsp;<span class="string" id="7988917">&#34;,&#34;</span><span class="op" id="7988920">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7988923">for</span>&nbsp;<span class="ident" id="7988927">n</span><span class="op" id="7988928">,</span>&nbsp;<span class="ident" id="7988930">colspec</span>&nbsp;<span class="op" id="7988938">:=</span>&nbsp;<span class="keyword" id="7988941">range</span>&nbsp;<span class="ident" id="7988947">strings</span><span class="op" id="7988954">.</span><span class="ident" id="7988955">Split</span><span class="op" id="7988960">(</span><span class="ident" id="7988961">parts</span><span class="op" id="7988966">[</span><span class="num" id="7988967">2</span><span class="op" id="7988968">]</span><span class="op" id="7988969">,</span>&nbsp;<span class="string" id="7988971">&#34;,&#34;</span><span class="op" id="7988974">)</span>&nbsp;<span class="op" id="7988976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7988980">if</span>&nbsp;<span class="ident" id="7988983">colspec</span>&nbsp;<span class="op" id="7988991">==</span>&nbsp;<span class="string" id="7988994">&#34;&#34;</span>&nbsp;<span class="op" id="7988997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7989002">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7989013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7989017">nameVal</span>&nbsp;<span class="op" id="7989025">:=</span>&nbsp;<span class="ident" id="7989028">strings</span><span class="op" id="7989035">.</span><span class="ident" id="7989036">Split</span><span class="op" id="7989041">(</span><span class="ident" id="7989042">colspec</span><span class="op" id="7989049">,</span>&nbsp;<span class="string" id="7989051">&#34;=&#34;</span><span class="op" id="7989054">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7989058">if</span>&nbsp;<span class="builtinfunc" id="7989061">len</span><span class="op" id="7989064">(</span><span class="ident" id="7989065">nameVal</span><span class="op" id="7989072">)</span>&nbsp;<span class="op" id="7989074">!=</span>&nbsp;<span class="num" id="7989077">2</span>&nbsp;<span class="op" id="7989079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7989084">stmt</span><span class="op" id="7989088">.</span><span class="ident" id="7989089">Close</span><span class="op" id="7989094">(</span><span class="op" id="7989095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7989100">return</span>&nbsp;<span class="ident" id="7989107">nil</span><span class="op" id="7989110">,</span>&nbsp;<span class="ident" id="7989112">errf</span><span class="op" id="7989116">(</span><span class="string" id="7989117">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="7989178">,</span>&nbsp;<span class="ident" id="7989180">stmt</span><span class="op" id="7989184">.</span><span class="ident" id="7989185">table</span><span class="op" id="7989190">,</span>&nbsp;<span class="ident" id="7989192">colspec</span><span class="op" id="7989199">,</span>&nbsp;<span class="ident" id="7989201">n</span><span class="op" id="7989202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7989206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7989210">column</span><span class="op" id="7989216">,</span>&nbsp;<span class="ident" id="7989218">value</span>&nbsp;<span class="op" id="7989224">:=</span>&nbsp;<span class="ident" id="7989227">nameVal</span><span class="op" id="7989234">[</span><span class="num" id="7989235">0</span><span class="op" id="7989236">]</span><span class="op" id="7989237">,</span>&nbsp;<span class="ident" id="7989239">nameVal</span><span class="op" id="7989246">[</span><span class="num" id="7989247">1</span><span class="op" id="7989248">]</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7989252">_</span><span class="op" id="7989253">,</span>&nbsp;<span class="ident" id="7989255">ok</span>&nbsp;<span class="op" id="7989258">:=</span>&nbsp;<span class="ident" id="7989261">c</span><span class="op" id="7989262">.</span><span class="ident" id="7989263">db</span><span class="op" id="7989265">.</span><span class="ident" id="7989266">columnType</span><span class="op" id="7989276">(</span><span class="ident" id="7989277">stmt</span><span class="op" id="7989281">.</span><span class="ident" id="7989282">table</span><span class="op" id="7989287">,</span>&nbsp;<span class="ident" id="7989289">column</span><span class="op" id="7989295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7989299">if</span>&nbsp;<span class="op" id="7989302">!</span><span class="ident" id="7989303">ok</span>&nbsp;<span class="op" id="7989306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7989311">stmt</span><span class="op" id="7989315">.</span><span class="ident" id="7989316">Close</span><span class="op" id="7989321">(</span><span class="op" id="7989322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7989327">return</span>&nbsp;<span class="ident" id="7989334">nil</span><span class="op" id="7989337">,</span>&nbsp;<span class="ident" id="7989339">errf</span><span class="op" id="7989343">(</span><span class="string" id="7989344">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="7989398">,</span>&nbsp;<span class="ident" id="7989400">stmt</span><span class="op" id="7989404">.</span><span class="ident" id="7989405">table</span><span class="op" id="7989410">,</span>&nbsp;<span class="ident" id="7989412">column</span><span class="op" id="7989418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7989422">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7989426">if</span>&nbsp;<span class="ident" id="7989429">value</span>&nbsp;<span class="op" id="7989435">!=</span>&nbsp;<span class="string" id="7989438">&#34;?&#34;</span>&nbsp;<span class="op" id="7989442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7989447">stmt</span><span class="op" id="7989451">.</span><span class="ident" id="7989452">Close</span><span class="op" id="7989457">(</span><span class="op" id="7989458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7989463">return</span>&nbsp;<span class="ident" id="7989470">nil</span><span class="op" id="7989473">,</span>&nbsp;<span class="ident" id="7989475">errf</span><span class="op" id="7989479">(</span><span class="string" id="7989480">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;pre-bound&nbsp;value&nbsp;for&nbsp;where&nbsp;column&nbsp;%q;&nbsp;need&nbsp;a&nbsp;question&nbsp;mark&#34;</span><span class="op" id="7989562">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7989568">stmt</span><span class="op" id="7989572">.</span><span class="ident" id="7989573">table</span><span class="op" id="7989578">,</span>&nbsp;<span class="ident" id="7989580">column</span><span class="op" id="7989586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7989590">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7989594">stmt</span><span class="op" id="7989598">.</span><span class="ident" id="7989599">whereCol</span>&nbsp;<span class="op" id="7989608">=</span>&nbsp;<span class="builtinfunc" id="7989610">append</span><span class="op" id="7989616">(</span><span class="ident" id="7989617">stmt</span><span class="op" id="7989621">.</span><span class="ident" id="7989622">whereCol</span><span class="op" id="7989630">,</span>&nbsp;<span class="ident" id="7989632">column</span><span class="op" id="7989638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7989642">stmt</span><span class="op" id="7989646">.</span><span class="ident" id="7989647">placeholders</span><span class="op" id="7989659">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7989663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7989666">return</span>&nbsp;<span class="ident" id="7989673">stmt</span><span class="op" id="7989677">,</span>&nbsp;<span class="ident" id="7989679">nil</span><br>
<span class="lineno"></span><span class="op" id="7989683">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span><span class="comment" id="7989686">//&nbsp;parts&nbsp;are&nbsp;table|col=type,col2=type2</span><br>
<span class="lineno"></span><span class="keyword" id="7989725">func</span>&nbsp;<span class="op" id="7989730">(</span><span class="ident" id="7989731">c</span>&nbsp;<span class="op" id="7989733">*</span><span class="ident" id="7989734">fakeConn</span><span class="op" id="7989742">)</span>&nbsp;<span class="ident" id="7989744">prepareCreate</span><span class="op" id="7989757">(</span><span class="ident" id="7989758">stmt</span>&nbsp;<span class="op" id="7989763">*</span><span class="ident" id="7989764">fakeStmt</span><span class="op" id="7989772">,</span>&nbsp;<span class="ident" id="7989774">parts</span>&nbsp;<span class="op" id="7989780">[</span><span class="op" id="7989781">]</span><span class="builtintype" id="7989782">string</span><span class="op" id="7989788">)</span>&nbsp;<span class="op" id="7989790">(</span><span class="ident" id="7989791">driver</span><span class="op" id="7989797">.</span><span class="ident" id="7989798">Stmt</span><span class="op" id="7989802">,</span>&nbsp;<span class="builtintype" id="7989804">error</span><span class="op" id="7989809">)</span>&nbsp;<span class="op" id="7989811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7989814">if</span>&nbsp;<span class="builtinfunc" id="7989817">len</span><span class="op" id="7989820">(</span><span class="ident" id="7989821">parts</span><span class="op" id="7989826">)</span>&nbsp;<span class="op" id="7989828">!=</span>&nbsp;<span class="num" id="7989831">2</span>&nbsp;<span class="op" id="7989833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7989837">stmt</span><span class="op" id="7989841">.</span><span class="ident" id="7989842">Close</span><span class="op" id="7989847">(</span><span class="op" id="7989848">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7989852">return</span>&nbsp;<span class="ident" id="7989859">nil</span><span class="op" id="7989862">,</span>&nbsp;<span class="ident" id="7989864">errf</span><span class="op" id="7989868">(</span><span class="string" id="7989869">&#34;invalid&nbsp;CREATE&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="7989914">,</span>&nbsp;<span class="builtinfunc" id="7989916">len</span><span class="op" id="7989919">(</span><span class="ident" id="7989920">parts</span><span class="op" id="7989925">)</span><span class="op" id="7989926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7989929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7989932">stmt</span><span class="op" id="7989936">.</span><span class="ident" id="7989937">table</span>&nbsp;<span class="op" id="7989943">=</span>&nbsp;<span class="ident" id="7989945">parts</span><span class="op" id="7989950">[</span><span class="num" id="7989951">0</span><span class="op" id="7989952">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7989955">for</span>&nbsp;<span class="ident" id="7989959">n</span><span class="op" id="7989960">,</span>&nbsp;<span class="ident" id="7989962">colspec</span>&nbsp;<span class="op" id="7989970">:=</span>&nbsp;<span class="keyword" id="7989973">range</span>&nbsp;<span class="ident" id="7989979">strings</span><span class="op" id="7989986">.</span><span class="ident" id="7989987">Split</span><span class="op" id="7989992">(</span><span class="ident" id="7989993">parts</span><span class="op" id="7989998">[</span><span class="num" id="7989999">1</span><span class="op" id="7990000">]</span><span class="op" id="7990001">,</span>&nbsp;<span class="string" id="7990003">&#34;,&#34;</span><span class="op" id="7990006">)</span>&nbsp;<span class="op" id="7990008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7990012">nameType</span>&nbsp;<span class="op" id="7990021">:=</span>&nbsp;<span class="ident" id="7990024">strings</span><span class="op" id="7990031">.</span><span class="ident" id="7990032">Split</span><span class="op" id="7990037">(</span><span class="ident" id="7990038">colspec</span><span class="op" id="7990045">,</span>&nbsp;<span class="string" id="7990047">&#34;=&#34;</span><span class="op" id="7990050">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7990054">if</span>&nbsp;<span class="builtinfunc" id="7990057">len</span><span class="op" id="7990060">(</span><span class="ident" id="7990061">nameType</span><span class="op" id="7990069">)</span>&nbsp;<span class="op" id="7990071">!=</span>&nbsp;<span class="num" id="7990074">2</span>&nbsp;<span class="op" id="7990076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7990081">stmt</span><span class="op" id="7990085">.</span><span class="ident" id="7990086">Close</span><span class="op" id="7990091">(</span><span class="op" id="7990092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7990097">return</span>&nbsp;<span class="ident" id="7990104">nil</span><span class="op" id="7990107">,</span>&nbsp;<span class="ident" id="7990109">errf</span><span class="op" id="7990113">(</span><span class="string" id="7990114">&#34;CREATE&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="7990172">,</span>&nbsp;<span class="ident" id="7990174">stmt</span><span class="op" id="7990178">.</span><span class="ident" id="7990179">table</span><span class="op" id="7990184">,</span>&nbsp;<span class="ident" id="7990186">colspec</span><span class="op" id="7990193">,</span>&nbsp;<span class="ident" id="7990195">n</span><span class="op" id="7990196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7990200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7990204">stmt</span><span class="op" id="7990208">.</span><span class="ident" id="7990209">colName</span>&nbsp;<span class="op" id="7990217">=</span>&nbsp;<span class="builtinfunc" id="7990219">append</span><span class="op" id="7990225">(</span><span class="ident" id="7990226">stmt</span><span class="op" id="7990230">.</span><span class="ident" id="7990231">colName</span><span class="op" id="7990238">,</span>&nbsp;<span class="ident" id="7990240">nameType</span><span class="op" id="7990248">[</span><span class="num" id="7990249">0</span><span class="op" id="7990250">]</span><span class="op" id="7990251">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7990255">stmt</span><span class="op" id="7990259">.</span><span class="ident" id="7990260">colType</span>&nbsp;<span class="op" id="7990268">=</span>&nbsp;<span class="builtinfunc" id="7990270">append</span><span class="op" id="7990276">(</span><span class="ident" id="7990277">stmt</span><span class="op" id="7990281">.</span><span class="ident" id="7990282">colType</span><span class="op" id="7990289">,</span>&nbsp;<span class="ident" id="7990291">nameType</span><span class="op" id="7990299">[</span><span class="num" id="7990300">1</span><span class="op" id="7990301">]</span><span class="op" id="7990302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7990305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7990308">return</span>&nbsp;<span class="ident" id="7990315">stmt</span><span class="op" id="7990319">,</span>&nbsp;<span class="ident" id="7990321">nil</span><br>
<span class="lineno"></span><span class="op" id="7990325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="7990328">//&nbsp;parts&nbsp;are&nbsp;table|col=?,col2=val</span><br>
<span class="lineno"></span><span class="keyword" id="7990362">func</span>&nbsp;<span class="op" id="7990367">(</span><span class="ident" id="7990368">c</span>&nbsp;<span class="op" id="7990370">*</span><span class="ident" id="7990371">fakeConn</span><span class="op" id="7990379">)</span>&nbsp;<span class="ident" id="7990381">prepareInsert</span><span class="op" id="7990394">(</span><span class="ident" id="7990395">stmt</span>&nbsp;<span class="op" id="7990400">*</span><span class="ident" id="7990401">fakeStmt</span><span class="op" id="7990409">,</span>&nbsp;<span class="ident" id="7990411">parts</span>&nbsp;<span class="op" id="7990417">[</span><span class="op" id="7990418">]</span><span class="builtintype" id="7990419">string</span><span class="op" id="7990425">)</span>&nbsp;<span class="op" id="7990427">(</span><span class="ident" id="7990428">driver</span><span class="op" id="7990434">.</span><span class="ident" id="7990435">Stmt</span><span class="op" id="7990439">,</span>&nbsp;<span class="builtintype" id="7990441">error</span><span class="op" id="7990446">)</span>&nbsp;<span class="op" id="7990448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7990451">if</span>&nbsp;<span class="builtinfunc" id="7990454">len</span><span class="op" id="7990457">(</span><span class="ident" id="7990458">parts</span><span class="op" id="7990463">)</span>&nbsp;<span class="op" id="7990465">!=</span>&nbsp;<span class="num" id="7990468">2</span>&nbsp;<span class="op" id="7990470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7990474">stmt</span><span class="op" id="7990478">.</span><span class="ident" id="7990479">Close</span><span class="op" id="7990484">(</span><span class="op" id="7990485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7990489">return</span>&nbsp;<span class="ident" id="7990496">nil</span><span class="op" id="7990499">,</span>&nbsp;<span class="ident" id="7990501">errf</span><span class="op" id="7990505">(</span><span class="string" id="7990506">&#34;invalid&nbsp;INSERT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="7990551">,</span>&nbsp;<span class="builtinfunc" id="7990553">len</span><span class="op" id="7990556">(</span><span class="ident" id="7990557">parts</span><span class="op" id="7990562">)</span><span class="op" id="7990563">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7990566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7990569">stmt</span><span class="op" id="7990573">.</span><span class="ident" id="7990574">table</span>&nbsp;<span class="op" id="7990580">=</span>&nbsp;<span class="ident" id="7990582">parts</span><span class="op" id="7990587">[</span><span class="num" id="7990588">0</span><span class="op" id="7990589">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7990592">for</span>&nbsp;<span class="ident" id="7990596">n</span><span class="op" id="7990597">,</span>&nbsp;<span class="ident" id="7990599">colspec</span>&nbsp;<span class="op" id="7990607">:=</span>&nbsp;<span class="keyword" id="7990610">range</span>&nbsp;<span class="ident" id="7990616">strings</span><span class="op" id="7990623">.</span><span class="ident" id="7990624">Split</span><span class="op" id="7990629">(</span><span class="ident" id="7990630">parts</span><span class="op" id="7990635">[</span><span class="num" id="7990636">1</span><span class="op" id="7990637">]</span><span class="op" id="7990638">,</span>&nbsp;<span class="string" id="7990640">&#34;,&#34;</span><span class="op" id="7990643">)</span>&nbsp;<span class="op" id="7990645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7990649">nameVal</span>&nbsp;<span class="op" id="7990657">:=</span>&nbsp;<span class="ident" id="7990660">strings</span><span class="op" id="7990667">.</span><span class="ident" id="7990668">Split</span><span class="op" id="7990673">(</span><span class="ident" id="7990674">colspec</span><span class="op" id="7990681">,</span>&nbsp;<span class="string" id="7990683">&#34;=&#34;</span><span class="op" id="7990686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7990690">if</span>&nbsp;<span class="builtinfunc" id="7990693">len</span><span class="op" id="7990696">(</span><span class="ident" id="7990697">nameVal</span><span class="op" id="7990704">)</span>&nbsp;<span class="op" id="7990706">!=</span>&nbsp;<span class="num" id="7990709">2</span>&nbsp;<span class="op" id="7990711">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7990716">stmt</span><span class="op" id="7990720">.</span><span class="ident" id="7990721">Close</span><span class="op" id="7990726">(</span><span class="op" id="7990727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7990732">return</span>&nbsp;<span class="ident" id="7990739">nil</span><span class="op" id="7990742">,</span>&nbsp;<span class="ident" id="7990744">errf</span><span class="op" id="7990748">(</span><span class="string" id="7990749">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="7990807">,</span>&nbsp;<span class="ident" id="7990809">stmt</span><span class="op" id="7990813">.</span><span class="ident" id="7990814">table</span><span class="op" id="7990819">,</span>&nbsp;<span class="ident" id="7990821">colspec</span><span class="op" id="7990828">,</span>&nbsp;<span class="ident" id="7990830">n</span><span class="op" id="7990831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7990835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7990839">column</span><span class="op" id="7990845">,</span>&nbsp;<span class="ident" id="7990847">value</span>&nbsp;<span class="op" id="7990853">:=</span>&nbsp;<span class="ident" id="7990856">nameVal</span><span class="op" id="7990863">[</span><span class="num" id="7990864">0</span><span class="op" id="7990865">]</span><span class="op" id="7990866">,</span>&nbsp;<span class="ident" id="7990868">nameVal</span><span class="op" id="7990875">[</span><span class="num" id="7990876">1</span><span class="op" id="7990877">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7990881">ctype</span><span class="op" id="7990886">,</span>&nbsp;<span class="ident" id="7990888">ok</span>&nbsp;<span class="op" id="7990891">:=</span>&nbsp;<span class="ident" id="7990894">c</span><span class="op" id="7990895">.</span><span class="ident" id="7990896">db</span><span class="op" id="7990898">.</span><span class="ident" id="7990899">columnType</span><span class="op" id="7990909">(</span><span class="ident" id="7990910">stmt</span><span class="op" id="7990914">.</span><span class="ident" id="7990915">table</span><span class="op" id="7990920">,</span>&nbsp;<span class="ident" id="7990922">column</span><span class="op" id="7990928">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7990932">if</span>&nbsp;<span class="op" id="7990935">!</span><span class="ident" id="7990936">ok</span>&nbsp;<span class="op" id="7990939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7990944">stmt</span><span class="op" id="7990948">.</span><span class="ident" id="7990949">Close</span><span class="op" id="7990954">(</span><span class="op" id="7990955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7990960">return</span>&nbsp;<span class="ident" id="7990967">nil</span><span class="op" id="7990970">,</span>&nbsp;<span class="ident" id="7990972">errf</span><span class="op" id="7990976">(</span><span class="string" id="7990977">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="7991028">,</span>&nbsp;<span class="ident" id="7991030">stmt</span><span class="op" id="7991034">.</span><span class="ident" id="7991035">table</span><span class="op" id="7991040">,</span>&nbsp;<span class="ident" id="7991042">column</span><span class="op" id="7991048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7991052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7991056">stmt</span><span class="op" id="7991060">.</span><span class="ident" id="7991061">colName</span>&nbsp;<span class="op" id="7991069">=</span>&nbsp;<span class="builtinfunc" id="7991071">append</span><span class="op" id="7991077">(</span><span class="ident" id="7991078">stmt</span><span class="op" id="7991082">.</span><span class="ident" id="7991083">colName</span><span class="op" id="7991090">,</span>&nbsp;<span class="ident" id="7991092">column</span><span class="op" id="7991098">)</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7991103">if</span>&nbsp;<span class="ident" id="7991106">value</span>&nbsp;<span class="op" id="7991112">!=</span>&nbsp;<span class="string" id="7991115">&#34;?&#34;</span>&nbsp;<span class="op" id="7991119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7991124">var</span>&nbsp;<span class="ident" id="7991128">subsetVal</span>&nbsp;<span class="keyword" id="7991138">interface</span><span class="op" id="7991147">{</span><span class="op" id="7991148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7991153">//&nbsp;Convert&nbsp;to&nbsp;driver&nbsp;subset&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7991189">switch</span>&nbsp;<span class="ident" id="7991196">ctype</span>&nbsp;<span class="op" id="7991202">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7991207">case</span>&nbsp;<span class="string" id="7991212">&#34;string&#34;</span><span class="op" id="7991220">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7991226">subsetVal</span>&nbsp;<span class="op" id="7991236">=</span>&nbsp;<span class="op" id="7991238">[</span><span class="op" id="7991239">]</span><span class="builtintype" id="7991240">byte</span><span class="op" id="7991244">(</span><span class="ident" id="7991245">value</span><span class="op" id="7991250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7991255">case</span>&nbsp;<span class="string" id="7991260">&#34;blob&#34;</span><span class="op" id="7991266">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7991272">subsetVal</span>&nbsp;<span class="op" id="7991282">=</span>&nbsp;<span class="op" id="7991284">[</span><span class="op" id="7991285">]</span><span class="builtintype" id="7991286">byte</span><span class="op" id="7991290">(</span><span class="ident" id="7991291">value</span><span class="op" id="7991296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7991301">case</span>&nbsp;<span class="string" id="7991306">&#34;int32&#34;</span><span class="op" id="7991313">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7991319">i</span><span class="op" id="7991320">,</span>&nbsp;<span class="ident" id="7991322">err</span>&nbsp;<span class="op" id="7991326">:=</span>&nbsp;<span class="ident" id="7991329">strconv</span><span class="op" id="7991336">.</span><span class="ident" id="7991337">Atoi</span><span class="op" id="7991341">(</span><span class="ident" id="7991342">value</span><span class="op" id="7991347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7991353">if</span>&nbsp;<span class="ident" id="7991356">err</span>&nbsp;<span class="op" id="7991360">!=</span>&nbsp;<span class="ident" id="7991363">nil</span>&nbsp;<span class="op" id="7991367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7991374">stmt</span><span class="op" id="7991378">.</span><span class="ident" id="7991379">Close</span><span class="op" id="7991384">(</span><span class="op" id="7991385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7991392">return</span>&nbsp;<span class="ident" id="7991399">nil</span><span class="op" id="7991402">,</span>&nbsp;<span class="ident" id="7991404">errf</span><span class="op" id="7991408">(</span><span class="string" id="7991409">&#34;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;%q&#34;</span><span class="op" id="7991446">,</span>&nbsp;<span class="ident" id="7991448">value</span><span class="op" id="7991453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7991459">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7991465">subsetVal</span>&nbsp;<span class="op" id="7991475">=</span>&nbsp;<span class="ident" id="7991477">int64</span><span class="op" id="7991482">(</span><span class="ident" id="7991483">i</span><span class="op" id="7991484">)</span>&nbsp;<span class="comment" id="7991486">//&nbsp;int64&nbsp;is&nbsp;a&nbsp;subset&nbsp;type,&nbsp;but&nbsp;not&nbsp;int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7991530">default</span><span class="op" id="7991537">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7991543">stmt</span><span class="op" id="7991547">.</span><span class="ident" id="7991548">Close</span><span class="op" id="7991553">(</span><span class="op" id="7991554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7991560">return</span>&nbsp;<span class="ident" id="7991567">nil</span><span class="op" id="7991570">,</span>&nbsp;<span class="ident" id="7991572">errf</span><span class="op" id="7991576">(</span><span class="string" id="7991577">&#34;unsupported&nbsp;conversion&nbsp;for&nbsp;pre-bound&nbsp;parameter&nbsp;%q&nbsp;to&nbsp;type&nbsp;%q&#34;</span><span class="op" id="7991639">,</span>&nbsp;<span class="ident" id="7991641">value</span><span class="op" id="7991646">,</span>&nbsp;<span class="ident" id="7991648">ctype</span><span class="op" id="7991653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7991658">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7991663">stmt</span><span class="op" id="7991667">.</span><span class="ident" id="7991668">colValue</span>&nbsp;<span class="op" id="7991677">=</span>&nbsp;<span class="builtinfunc" id="7991679">append</span><span class="op" id="7991685">(</span><span class="ident" id="7991686">stmt</span><span class="op" id="7991690">.</span><span class="ident" id="7991691">colValue</span><span class="op" id="7991699">,</span>&nbsp;<span class="ident" id="7991701">subsetVal</span><span class="op" id="7991710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7991714">}</span>&nbsp;<span class="keyword" id="7991716">else</span>&nbsp;<span class="op" id="7991721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7991726">stmt</span><span class="op" id="7991730">.</span><span class="ident" id="7991731">placeholders</span><span class="op" id="7991743">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7991749">stmt</span><span class="op" id="7991753">.</span><span class="ident" id="7991754">placeholderConverter</span>&nbsp;<span class="op" id="7991775">=</span>&nbsp;<span class="builtinfunc" id="7991777">append</span><span class="op" id="7991783">(</span><span class="ident" id="7991784">stmt</span><span class="op" id="7991788">.</span><span class="ident" id="7991789">placeholderConverter</span><span class="op" id="7991809">,</span>&nbsp;<span class="ident" id="7991811">converterForType</span><span class="op" id="7991827">(</span><span class="ident" id="7991828">ctype</span><span class="op" id="7991833">)</span><span class="op" id="7991834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7991839">stmt</span><span class="op" id="7991843">.</span><span class="ident" id="7991844">colValue</span>&nbsp;<span class="op" id="7991853">=</span>&nbsp;<span class="builtinfunc" id="7991855">append</span><span class="op" id="7991861">(</span><span class="ident" id="7991862">stmt</span><span class="op" id="7991866">.</span><span class="ident" id="7991867">colValue</span><span class="op" id="7991875">,</span>&nbsp;<span class="string" id="7991877">&#34;?&#34;</span><span class="op" id="7991880">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7991884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7991887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7991890">return</span>&nbsp;<span class="ident" id="7991897">stmt</span><span class="op" id="7991901">,</span>&nbsp;<span class="ident" id="7991903">nil</span><br>
<span class="lineno"></span><span class="op" id="7991907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="7991910">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="7991949">var</span>&nbsp;<span class="ident" id="7991953">hookPrepareBadConn</span>&nbsp;<span class="keyword" id="7991972">func</span><span class="op" id="7991976">(</span><span class="op" id="7991977">)</span>&nbsp;<span class="builtintype" id="7991979">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7991985">func</span>&nbsp;<span class="op" id="7991990">(</span><span class="ident" id="7991991">c</span>&nbsp;<span class="op" id="7991993">*</span><span class="ident" id="7991994">fakeConn</span><span class="op" id="7992002">)</span>&nbsp;<span class="ident" id="7992004">Prepare</span><span class="op" id="7992011">(</span><span class="ident" id="7992012">query</span>&nbsp;<span class="builtintype" id="7992018">string</span><span class="op" id="7992024">)</span>&nbsp;<span class="op" id="7992026">(</span><span class="ident" id="7992027">driver</span><span class="op" id="7992033">.</span><span class="ident" id="7992034">Stmt</span><span class="op" id="7992038">,</span>&nbsp;<span class="builtintype" id="7992040">error</span><span class="op" id="7992045">)</span>&nbsp;<span class="op" id="7992047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7992050">c</span><span class="op" id="7992051">.</span><span class="ident" id="7992052">numPrepare</span><span class="op" id="7992062">++</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7992066">if</span>&nbsp;<span class="ident" id="7992069">c</span><span class="op" id="7992070">.</span><span class="ident" id="7992071">db</span>&nbsp;<span class="op" id="7992074">==</span>&nbsp;<span class="ident" id="7992077">nil</span>&nbsp;<span class="op" id="7992081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7992085">panic</span><span class="op" id="7992090">(</span><span class="string" id="7992091">&#34;nil&nbsp;c.db;&nbsp;conn&nbsp;=&nbsp;&#34;</span>&nbsp;<span class="op" id="7992111">+</span>&nbsp;<span class="ident" id="7992113">fmt</span><span class="op" id="7992116">.</span><span class="ident" id="7992117">Sprintf</span><span class="op" id="7992124">(</span><span class="string" id="7992125">&#34;%#v&#34;</span><span class="op" id="7992130">,</span>&nbsp;<span class="ident" id="7992132">c</span><span class="op" id="7992133">)</span><span class="op" id="7992134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7992137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7992141">if</span>&nbsp;<span class="ident" id="7992144">hookPrepareBadConn</span>&nbsp;<span class="op" id="7992163">!=</span>&nbsp;<span class="ident" id="7992166">nil</span>&nbsp;<span class="op" id="7992170">&amp;&amp;</span>&nbsp;<span class="ident" id="7992173">hookPrepareBadConn</span><span class="op" id="7992191">(</span><span class="op" id="7992192">)</span>&nbsp;<span class="op" id="7992194">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7992198">return</span>&nbsp;<span class="ident" id="7992205">nil</span><span class="op" id="7992208">,</span>&nbsp;<span class="ident" id="7992210">driver</span><span class="op" id="7992216">.</span><span class="ident" id="7992217">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7992229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7992233">parts</span>&nbsp;<span class="op" id="7992239">:=</span>&nbsp;<span class="ident" id="7992242">strings</span><span class="op" id="7992249">.</span><span class="ident" id="7992250">Split</span><span class="op" id="7992255">(</span><span class="ident" id="7992256">query</span><span class="op" id="7992261">,</span>&nbsp;<span class="string" id="7992263">&#34;|&#34;</span><span class="op" id="7992266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7992269">if</span>&nbsp;<span class="builtinfunc" id="7992272">len</span><span class="op" id="7992275">(</span><span class="ident" id="7992276">parts</span><span class="op" id="7992281">)</span>&nbsp;<span class="op" id="7992283">&lt;</span>&nbsp;<span class="num" id="7992285">1</span>&nbsp;<span class="op" id="7992287">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7992291">return</span>&nbsp;<span class="ident" id="7992298">nil</span><span class="op" id="7992301">,</span>&nbsp;<span class="ident" id="7992303">errf</span><span class="op" id="7992307">(</span><span class="string" id="7992308">&#34;empty&nbsp;query&#34;</span><span class="op" id="7992321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7992324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7992327">cmd</span>&nbsp;<span class="op" id="7992331">:=</span>&nbsp;<span class="ident" id="7992334">parts</span><span class="op" id="7992339">[</span><span class="num" id="7992340">0</span><span class="op" id="7992341">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7992344">parts</span>&nbsp;<span class="op" id="7992350">=</span>&nbsp;<span class="ident" id="7992352">parts</span><span class="op" id="7992357">[</span><span class="num" id="7992358">1</span><span class="op" id="7992359">:</span><span class="op" id="7992360">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7992363">stmt</span>&nbsp;<span class="op" id="7992368">:=</span>&nbsp;<span class="op" id="7992371">&amp;</span><span class="ident" id="7992372">fakeStmt</span><span class="op" id="7992380">{</span><span class="ident" id="7992381">q</span><span class="op" id="7992382">:</span>&nbsp;<span class="ident" id="7992384">query</span><span class="op" id="7992389">,</span>&nbsp;<span class="ident" id="7992391">c</span><span class="op" id="7992392">:</span>&nbsp;<span class="ident" id="7992394">c</span><span class="op" id="7992395">,</span>&nbsp;<span class="ident" id="7992397">cmd</span><span class="op" id="7992400">:</span>&nbsp;<span class="ident" id="7992402">cmd</span><span class="op" id="7992405">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7992408">c</span><span class="op" id="7992409">.</span><span class="ident" id="7992410">incrStat</span><span class="op" id="7992418">(</span><span class="op" id="7992419">&amp;</span><span class="ident" id="7992420">c</span><span class="op" id="7992421">.</span><span class="ident" id="7992422">stmtsMade</span><span class="op" id="7992431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7992434">switch</span>&nbsp;<span class="ident" id="7992441">cmd</span>&nbsp;<span class="op" id="7992445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7992448">case</span>&nbsp;<span class="string" id="7992453">&#34;WIPE&#34;</span><span class="op" id="7992459">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7992463">//&nbsp;Nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7992475">case</span>&nbsp;<span class="string" id="7992480">&#34;SELECT&#34;</span><span class="op" id="7992488">:</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7992492">return</span>&nbsp;<span class="ident" id="7992499">c</span><span class="op" id="7992500">.</span><span class="ident" id="7992501">prepareSelect</span><span class="op" id="7992514">(</span><span class="ident" id="7992515">stmt</span><span class="op" id="7992519">,</span>&nbsp;<span class="ident" id="7992521">parts</span><span class="op" id="7992526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7992529">case</span>&nbsp;<span class="string" id="7992534">&#34;CREATE&#34;</span><span class="op" id="7992542">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7992546">return</span>&nbsp;<span class="ident" id="7992553">c</span><span class="op" id="7992554">.</span><span class="ident" id="7992555">prepareCreate</span><span class="op" id="7992568">(</span><span class="ident" id="7992569">stmt</span><span class="op" id="7992573">,</span>&nbsp;<span class="ident" id="7992575">parts</span><span class="op" id="7992580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7992583">case</span>&nbsp;<span class="string" id="7992588">&#34;INSERT&#34;</span><span class="op" id="7992596">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7992600">return</span>&nbsp;<span class="ident" id="7992607">c</span><span class="op" id="7992608">.</span><span class="ident" id="7992609">prepareInsert</span><span class="op" id="7992622">(</span><span class="ident" id="7992623">stmt</span><span class="op" id="7992627">,</span>&nbsp;<span class="ident" id="7992629">parts</span><span class="op" id="7992634">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7992637">case</span>&nbsp;<span class="string" id="7992642">&#34;NOSERT&#34;</span><span class="op" id="7992650">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7992654">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7992734">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7992778">return</span>&nbsp;<span class="ident" id="7992785">c</span><span class="op" id="7992786">.</span><span class="ident" id="7992787">prepareInsert</span><span class="op" id="7992800">(</span><span class="ident" id="7992801">stmt</span><span class="op" id="7992805">,</span>&nbsp;<span class="ident" id="7992807">parts</span><span class="op" id="7992812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7992815">default</span><span class="op" id="7992822">:</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7992826">stmt</span><span class="op" id="7992830">.</span><span class="ident" id="7992831">Close</span><span class="op" id="7992836">(</span><span class="op" id="7992837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7992841">return</span>&nbsp;<span class="ident" id="7992848">nil</span><span class="op" id="7992851">,</span>&nbsp;<span class="ident" id="7992853">errf</span><span class="op" id="7992857">(</span><span class="string" id="7992858">&#34;unsupported&nbsp;command&nbsp;type&nbsp;%q&#34;</span><span class="op" id="7992887">,</span>&nbsp;<span class="ident" id="7992889">cmd</span><span class="op" id="7992892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7992895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7992898">return</span>&nbsp;<span class="ident" id="7992905">stmt</span><span class="op" id="7992909">,</span>&nbsp;<span class="ident" id="7992911">nil</span><br>
<span class="lineno"></span><span class="op" id="7992915">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="7992918">func</span>&nbsp;<span class="op" id="7992923">(</span><span class="ident" id="7992924">s</span>&nbsp;<span class="op" id="7992926">*</span><span class="ident" id="7992927">fakeStmt</span><span class="op" id="7992935">)</span>&nbsp;<span class="ident" id="7992937">ColumnConverter</span><span class="op" id="7992952">(</span><span class="ident" id="7992953">idx</span>&nbsp;<span class="builtintype" id="7992957">int</span><span class="op" id="7992960">)</span>&nbsp;<span class="ident" id="7992962">driver</span><span class="op" id="7992968">.</span><span class="ident" id="7992969">ValueConverter</span>&nbsp;<span class="op" id="7992984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7992987">if</span>&nbsp;<span class="builtinfunc" id="7992990">len</span><span class="op" id="7992993">(</span><span class="ident" id="7992994">s</span><span class="op" id="7992995">.</span><span class="ident" id="7992996">placeholderConverter</span><span class="op" id="7993016">)</span>&nbsp;<span class="op" id="7993018">==</span>&nbsp;<span class="num" id="7993021">0</span>&nbsp;<span class="op" id="7993023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7993027">return</span>&nbsp;<span class="ident" id="7993034">driver</span><span class="op" id="7993040">.</span><span class="ident" id="7993041">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7993068">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7993071">return</span>&nbsp;<span class="ident" id="7993078">s</span><span class="op" id="7993079">.</span><span class="ident" id="7993080">placeholderConverter</span><span class="op" id="7993100">[</span><span class="ident" id="7993101">idx</span><span class="op" id="7993104">]</span><br>
<span class="lineno"></span><span class="op" id="7993106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7993109">func</span>&nbsp;<span class="op" id="7993114">(</span><span class="ident" id="7993115">s</span>&nbsp;<span class="op" id="7993117">*</span><span class="ident" id="7993118">fakeStmt</span><span class="op" id="7993126">)</span>&nbsp;<span class="ident" id="7993128">Close</span><span class="op" id="7993133">(</span><span class="op" id="7993134">)</span>&nbsp;<span class="builtintype" id="7993136">error</span>&nbsp;<span class="op" id="7993142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7993145">if</span>&nbsp;<span class="ident" id="7993148">s</span><span class="op" id="7993149">.</span><span class="ident" id="7993150">c</span>&nbsp;<span class="op" id="7993152">==</span>&nbsp;<span class="ident" id="7993155">nil</span>&nbsp;<span class="op" id="7993159">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7993163">panic</span><span class="op" id="7993168">(</span><span class="string" id="7993169">&#34;nil&nbsp;conn&nbsp;in&nbsp;fakeStmt.Close&#34;</span><span class="op" id="7993197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7993200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7993203">if</span>&nbsp;<span class="ident" id="7993206">s</span><span class="op" id="7993207">.</span><span class="ident" id="7993208">c</span><span class="op" id="7993209">.</span><span class="ident" id="7993210">db</span>&nbsp;<span class="op" id="7993213">==</span>&nbsp;<span class="ident" id="7993216">nil</span>&nbsp;<span class="op" id="7993220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7993224">panic</span><span class="op" id="7993229">(</span><span class="string" id="7993230">&#34;in&nbsp;fakeStmt.Close,&nbsp;conn&#39;s&nbsp;db&nbsp;is&nbsp;nil&nbsp;(already&nbsp;closed)&#34;</span><span class="op" id="7993284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7993287">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7993290">if</span>&nbsp;<span class="op" id="7993293">!</span><span class="ident" id="7993294">s</span><span class="op" id="7993295">.</span><span class="ident" id="7993296">closed</span>&nbsp;<span class="op" id="7993303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7993307">s</span><span class="op" id="7993308">.</span><span class="ident" id="7993309">c</span><span class="op" id="7993310">.</span><span class="ident" id="7993311">incrStat</span><span class="op" id="7993319">(</span><span class="op" id="7993320">&amp;</span><span class="ident" id="7993321">s</span><span class="op" id="7993322">.</span><span class="ident" id="7993323">c</span><span class="op" id="7993324">.</span><span class="ident" id="7993325">stmtsClosed</span><span class="op" id="7993336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7993340">s</span><span class="op" id="7993341">.</span><span class="ident" id="7993342">closed</span>&nbsp;<span class="op" id="7993349">=</span>&nbsp;<span class="builtintype" id="7993351">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7993357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7993360">return</span>&nbsp;<span class="ident" id="7993367">nil</span><br>
<span class="lineno">520</span><span class="op" id="7993371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7993374">var</span>&nbsp;<span class="ident" id="7993378">errClosed</span>&nbsp;<span class="op" id="7993388">=</span>&nbsp;<span class="ident" id="7993390">errors</span><span class="op" id="7993396">.</span><span class="ident" id="7993397">New</span><span class="op" id="7993400">(</span><span class="string" id="7993401">&#34;fakedb:&nbsp;statement&nbsp;has&nbsp;been&nbsp;closed&#34;</span><span class="op" id="7993436">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7993439">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno">525</span><span class="keyword" id="7993478">var</span>&nbsp;<span class="ident" id="7993482">hookExecBadConn</span>&nbsp;<span class="keyword" id="7993498">func</span><span class="op" id="7993502">(</span><span class="op" id="7993503">)</span>&nbsp;<span class="builtintype" id="7993505">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7993511">func</span>&nbsp;<span class="op" id="7993516">(</span><span class="ident" id="7993517">s</span>&nbsp;<span class="op" id="7993519">*</span><span class="ident" id="7993520">fakeStmt</span><span class="op" id="7993528">)</span>&nbsp;<span class="ident" id="7993530">Exec</span><span class="op" id="7993534">(</span><span class="ident" id="7993535">args</span>&nbsp;<span class="op" id="7993540">[</span><span class="op" id="7993541">]</span><span class="ident" id="7993542">driver</span><span class="op" id="7993548">.</span><span class="ident" id="7993549">Value</span><span class="op" id="7993554">)</span>&nbsp;<span class="op" id="7993556">(</span><span class="ident" id="7993557">driver</span><span class="op" id="7993563">.</span><span class="ident" id="7993564">Result</span><span class="op" id="7993570">,</span>&nbsp;<span class="builtintype" id="7993572">error</span><span class="op" id="7993577">)</span>&nbsp;<span class="op" id="7993579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7993582">if</span>&nbsp;<span class="ident" id="7993585">s</span><span class="op" id="7993586">.</span><span class="ident" id="7993587">closed</span>&nbsp;<span class="op" id="7993594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7993598">return</span>&nbsp;<span class="ident" id="7993605">nil</span><span class="op" id="7993608">,</span>&nbsp;<span class="ident" id="7993610">errClosed</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7993621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7993625">if</span>&nbsp;<span class="ident" id="7993628">hookExecBadConn</span>&nbsp;<span class="op" id="7993644">!=</span>&nbsp;<span class="ident" id="7993647">nil</span>&nbsp;<span class="op" id="7993651">&amp;&amp;</span>&nbsp;<span class="ident" id="7993654">hookExecBadConn</span><span class="op" id="7993669">(</span><span class="op" id="7993670">)</span>&nbsp;<span class="op" id="7993672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7993676">return</span>&nbsp;<span class="ident" id="7993683">nil</span><span class="op" id="7993686">,</span>&nbsp;<span class="ident" id="7993688">driver</span><span class="op" id="7993694">.</span><span class="ident" id="7993695">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7993707">}</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7993711">err</span>&nbsp;<span class="op" id="7993715">:=</span>&nbsp;<span class="ident" id="7993718">checkSubsetTypes</span><span class="op" id="7993734">(</span><span class="ident" id="7993735">args</span><span class="op" id="7993739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7993742">if</span>&nbsp;<span class="ident" id="7993745">err</span>&nbsp;<span class="op" id="7993749">!=</span>&nbsp;<span class="ident" id="7993752">nil</span>&nbsp;<span class="op" id="7993756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7993760">return</span>&nbsp;<span class="ident" id="7993767">nil</span><span class="op" id="7993770">,</span>&nbsp;<span class="ident" id="7993772">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7993777">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7993781">db</span>&nbsp;<span class="op" id="7993784">:=</span>&nbsp;<span class="ident" id="7993787">s</span><span class="op" id="7993788">.</span><span class="ident" id="7993789">c</span><span class="op" id="7993790">.</span><span class="ident" id="7993791">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7993795">switch</span>&nbsp;<span class="ident" id="7993802">s</span><span class="op" id="7993803">.</span><span class="ident" id="7993804">cmd</span>&nbsp;<span class="op" id="7993808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7993811">case</span>&nbsp;<span class="string" id="7993816">&#34;WIPE&#34;</span><span class="op" id="7993822">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7993826">db</span><span class="op" id="7993828">.</span><span class="ident" id="7993829">wipe</span><span class="op" id="7993833">(</span><span class="op" id="7993834">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7993838">return</span>&nbsp;<span class="ident" id="7993845">driver</span><span class="op" id="7993851">.</span><span class="ident" id="7993852">ResultNoRows</span><span class="op" id="7993864">,</span>&nbsp;<span class="ident" id="7993866">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7993871">case</span>&nbsp;<span class="string" id="7993876">&#34;CREATE&#34;</span><span class="op" id="7993884">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7993888">if</span>&nbsp;<span class="ident" id="7993891">err</span>&nbsp;<span class="op" id="7993895">:=</span>&nbsp;<span class="ident" id="7993898">db</span><span class="op" id="7993900">.</span><span class="ident" id="7993901">createTable</span><span class="op" id="7993912">(</span><span class="ident" id="7993913">s</span><span class="op" id="7993914">.</span><span class="ident" id="7993915">table</span><span class="op" id="7993920">,</span>&nbsp;<span class="ident" id="7993922">s</span><span class="op" id="7993923">.</span><span class="ident" id="7993924">colName</span><span class="op" id="7993931">,</span>&nbsp;<span class="ident" id="7993933">s</span><span class="op" id="7993934">.</span><span class="ident" id="7993935">colType</span><span class="op" id="7993942">)</span><span class="op" id="7993943">;</span>&nbsp;<span class="ident" id="7993945">err</span>&nbsp;<span class="op" id="7993949">!=</span>&nbsp;<span class="ident" id="7993952">nil</span>&nbsp;<span class="op" id="7993956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7993961">return</span>&nbsp;<span class="ident" id="7993968">nil</span><span class="op" id="7993971">,</span>&nbsp;<span class="ident" id="7993973">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7993979">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7993983">return</span>&nbsp;<span class="ident" id="7993990">driver</span><span class="op" id="7993996">.</span><span class="ident" id="7993997">ResultNoRows</span><span class="op" id="7994009">,</span>&nbsp;<span class="ident" id="7994011">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7994016">case</span>&nbsp;<span class="string" id="7994021">&#34;INSERT&#34;</span><span class="op" id="7994029">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7994033">return</span>&nbsp;<span class="ident" id="7994040">s</span><span class="op" id="7994041">.</span><span class="ident" id="7994042">execInsert</span><span class="op" id="7994052">(</span><span class="ident" id="7994053">args</span><span class="op" id="7994057">,</span>&nbsp;<span class="builtintype" id="7994059">true</span><span class="op" id="7994063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7994066">case</span>&nbsp;<span class="string" id="7994071">&#34;NOSERT&#34;</span><span class="op" id="7994079">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7994083">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7994163">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7994207">return</span>&nbsp;<span class="ident" id="7994214">s</span><span class="op" id="7994215">.</span><span class="ident" id="7994216">execInsert</span><span class="op" id="7994226">(</span><span class="ident" id="7994227">args</span><span class="op" id="7994231">,</span>&nbsp;<span class="builtintype" id="7994233">false</span><span class="op" id="7994238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7994241">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7994244">fmt</span><span class="op" id="7994247">.</span><span class="ident" id="7994248">Printf</span><span class="op" id="7994254">(</span><span class="string" id="7994255">&#34;EXEC&nbsp;statement,&nbsp;cmd=%q:&nbsp;%#v\n&#34;</span><span class="op" id="7994286">,</span>&nbsp;<span class="ident" id="7994288">s</span><span class="op" id="7994289">.</span><span class="ident" id="7994290">cmd</span><span class="op" id="7994293">,</span>&nbsp;<span class="ident" id="7994295">s</span><span class="op" id="7994296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7994299">return</span>&nbsp;<span class="ident" id="7994306">nil</span><span class="op" id="7994309">,</span>&nbsp;<span class="ident" id="7994311">fmt</span><span class="op" id="7994314">.</span><span class="ident" id="7994315">Errorf</span><span class="op" id="7994321">(</span><span class="string" id="7994322">&#34;unimplemented&nbsp;statement&nbsp;Exec&nbsp;command&nbsp;type&nbsp;of&nbsp;%q&#34;</span><span class="op" id="7994371">,</span>&nbsp;<span class="ident" id="7994373">s</span><span class="op" id="7994374">.</span><span class="ident" id="7994375">cmd</span><span class="op" id="7994378">)</span><br>
<span class="lineno">560</span><span class="op" id="7994380">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7994383">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;true,&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span><span class="comment" id="7994435">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;false&nbsp;do&nbsp;prep-work&nbsp;and&nbsp;error&nbsp;checking,&nbsp;but&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="7994504">//&nbsp;actually&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno">565</span><span class="keyword" id="7994542">func</span>&nbsp;<span class="op" id="7994547">(</span><span class="ident" id="7994548">s</span>&nbsp;<span class="op" id="7994550">*</span><span class="ident" id="7994551">fakeStmt</span><span class="op" id="7994559">)</span>&nbsp;<span class="ident" id="7994561">execInsert</span><span class="op" id="7994571">(</span><span class="ident" id="7994572">args</span>&nbsp;<span class="op" id="7994577">[</span><span class="op" id="7994578">]</span><span class="ident" id="7994579">driver</span><span class="op" id="7994585">.</span><span class="ident" id="7994586">Value</span><span class="op" id="7994591">,</span>&nbsp;<span class="ident" id="7994593">doInsert</span>&nbsp;<span class="builtintype" id="7994602">bool</span><span class="op" id="7994606">)</span>&nbsp;<span class="op" id="7994608">(</span><span class="ident" id="7994609">driver</span><span class="op" id="7994615">.</span><span class="ident" id="7994616">Result</span><span class="op" id="7994622">,</span>&nbsp;<span class="builtintype" id="7994624">error</span><span class="op" id="7994629">)</span>&nbsp;<span class="op" id="7994631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7994634">db</span>&nbsp;<span class="op" id="7994637">:=</span>&nbsp;<span class="ident" id="7994640">s</span><span class="op" id="7994641">.</span><span class="ident" id="7994642">c</span><span class="op" id="7994643">.</span><span class="ident" id="7994644">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7994648">if</span>&nbsp;<span class="builtinfunc" id="7994651">len</span><span class="op" id="7994654">(</span><span class="ident" id="7994655">args</span><span class="op" id="7994659">)</span>&nbsp;<span class="op" id="7994661">!=</span>&nbsp;<span class="ident" id="7994664">s</span><span class="op" id="7994665">.</span><span class="ident" id="7994666">placeholders</span>&nbsp;<span class="op" id="7994679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7994683">panic</span><span class="op" id="7994688">(</span><span class="string" id="7994689">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="7994747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7994750">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7994753">db</span><span class="op" id="7994755">.</span><span class="ident" id="7994756">mu</span><span class="op" id="7994758">.</span><span class="ident" id="7994759">Lock</span><span class="op" id="7994763">(</span><span class="op" id="7994764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7994767">t</span><span class="op" id="7994768">,</span>&nbsp;<span class="ident" id="7994770">ok</span>&nbsp;<span class="op" id="7994773">:=</span>&nbsp;<span class="ident" id="7994776">db</span><span class="op" id="7994778">.</span><span class="ident" id="7994779">table</span><span class="op" id="7994784">(</span><span class="ident" id="7994785">s</span><span class="op" id="7994786">.</span><span class="ident" id="7994787">table</span><span class="op" id="7994792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7994795">db</span><span class="op" id="7994797">.</span><span class="ident" id="7994798">mu</span><span class="op" id="7994800">.</span><span class="ident" id="7994801">Unlock</span><span class="op" id="7994807">(</span><span class="op" id="7994808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7994811">if</span>&nbsp;<span class="op" id="7994814">!</span><span class="ident" id="7994815">ok</span>&nbsp;<span class="op" id="7994818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7994822">return</span>&nbsp;<span class="ident" id="7994829">nil</span><span class="op" id="7994832">,</span>&nbsp;<span class="ident" id="7994834">fmt</span><span class="op" id="7994837">.</span><span class="ident" id="7994838">Errorf</span><span class="op" id="7994844">(</span><span class="string" id="7994845">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="7994877">,</span>&nbsp;<span class="ident" id="7994879">s</span><span class="op" id="7994880">.</span><span class="ident" id="7994881">table</span><span class="op" id="7994886">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7994889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7994893">t</span><span class="op" id="7994894">.</span><span class="ident" id="7994895">mu</span><span class="op" id="7994897">.</span><span class="ident" id="7994898">Lock</span><span class="op" id="7994902">(</span><span class="op" id="7994903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7994906">defer</span>&nbsp;<span class="ident" id="7994912">t</span><span class="op" id="7994913">.</span><span class="ident" id="7994914">mu</span><span class="op" id="7994916">.</span><span class="ident" id="7994917">Unlock</span><span class="op" id="7994923">(</span><span class="op" id="7994924">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7994928">var</span>&nbsp;<span class="ident" id="7994932">cols</span>&nbsp;<span class="op" id="7994937">[</span><span class="op" id="7994938">]</span><span class="keyword" id="7994939">interface</span><span class="op" id="7994948">{</span><span class="op" id="7994949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7994952">if</span>&nbsp;<span class="ident" id="7994955">doInsert</span>&nbsp;<span class="op" id="7994964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7994968">cols</span>&nbsp;<span class="op" id="7994973">=</span>&nbsp;<span class="builtinfunc" id="7994975">make</span><span class="op" id="7994979">(</span><span class="op" id="7994980">[</span><span class="op" id="7994981">]</span><span class="keyword" id="7994982">interface</span><span class="op" id="7994991">{</span><span class="op" id="7994992">}</span><span class="op" id="7994993">,</span>&nbsp;<span class="builtinfunc" id="7994995">len</span><span class="op" id="7994998">(</span><span class="ident" id="7994999">t</span><span class="op" id="7995000">.</span><span class="ident" id="7995001">colname</span><span class="op" id="7995008">)</span><span class="op" id="7995009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7995012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7995015">argPos</span>&nbsp;<span class="op" id="7995022">:=</span>&nbsp;<span class="num" id="7995025">0</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7995028">for</span>&nbsp;<span class="ident" id="7995032">n</span><span class="op" id="7995033">,</span>&nbsp;<span class="ident" id="7995035">colname</span>&nbsp;<span class="op" id="7995043">:=</span>&nbsp;<span class="keyword" id="7995046">range</span>&nbsp;<span class="ident" id="7995052">s</span><span class="op" id="7995053">.</span><span class="ident" id="7995054">colName</span>&nbsp;<span class="op" id="7995062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7995066">colidx</span>&nbsp;<span class="op" id="7995073">:=</span>&nbsp;<span class="ident" id="7995076">t</span><span class="op" id="7995077">.</span><span class="ident" id="7995078">columnIndex</span><span class="op" id="7995089">(</span><span class="ident" id="7995090">colname</span><span class="op" id="7995097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7995101">if</span>&nbsp;<span class="ident" id="7995104">colidx</span>&nbsp;<span class="op" id="7995111">==</span>&nbsp;<span class="op" id="7995114">-</span><span class="num" id="7995115">1</span>&nbsp;<span class="op" id="7995117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7995122">return</span>&nbsp;<span class="ident" id="7995129">nil</span><span class="op" id="7995132">,</span>&nbsp;<span class="ident" id="7995134">fmt</span><span class="op" id="7995137">.</span><span class="ident" id="7995138">Errorf</span><span class="op" id="7995144">(</span><span class="string" id="7995145">&#34;fakedb:&nbsp;column&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&nbsp;or&nbsp;dropped&nbsp;since&nbsp;prepared&nbsp;statement&nbsp;was&nbsp;created&#34;</span><span class="op" id="7995226">,</span>&nbsp;<span class="ident" id="7995228">colname</span><span class="op" id="7995235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7995239">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7995243">var</span>&nbsp;<span class="ident" id="7995247">val</span>&nbsp;<span class="keyword" id="7995251">interface</span><span class="op" id="7995260">{</span><span class="op" id="7995261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7995265">if</span>&nbsp;<span class="ident" id="7995268">strvalue</span><span class="op" id="7995276">,</span>&nbsp;<span class="ident" id="7995278">ok</span>&nbsp;<span class="op" id="7995281">:=</span>&nbsp;<span class="ident" id="7995284">s</span><span class="op" id="7995285">.</span><span class="ident" id="7995286">colValue</span><span class="op" id="7995294">[</span><span class="ident" id="7995295">n</span><span class="op" id="7995296">]</span><span class="op" id="7995297">.</span><span class="op" id="7995298">(</span><span class="builtintype" id="7995299">string</span><span class="op" id="7995305">)</span><span class="op" id="7995306">;</span>&nbsp;<span class="ident" id="7995308">ok</span>&nbsp;<span class="op" id="7995311">&amp;&amp;</span>&nbsp;<span class="ident" id="7995314">strvalue</span>&nbsp;<span class="op" id="7995323">==</span>&nbsp;<span class="string" id="7995326">&#34;?&#34;</span>&nbsp;<span class="op" id="7995330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7995335">val</span>&nbsp;<span class="op" id="7995339">=</span>&nbsp;<span class="ident" id="7995341">args</span><span class="op" id="7995345">[</span><span class="ident" id="7995346">argPos</span><span class="op" id="7995352">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7995357">argPos</span><span class="op" id="7995363">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7995368">}</span>&nbsp;<span class="keyword" id="7995370">else</span>&nbsp;<span class="op" id="7995375">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7995380">val</span>&nbsp;<span class="op" id="7995384">=</span>&nbsp;<span class="ident" id="7995386">s</span><span class="op" id="7995387">.</span><span class="ident" id="7995388">colValue</span><span class="op" id="7995396">[</span><span class="ident" id="7995397">n</span><span class="op" id="7995398">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7995402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7995406">if</span>&nbsp;<span class="ident" id="7995409">doInsert</span>&nbsp;<span class="op" id="7995418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7995423">cols</span><span class="op" id="7995427">[</span><span class="ident" id="7995428">colidx</span><span class="op" id="7995434">]</span>&nbsp;<span class="op" id="7995436">=</span>&nbsp;<span class="ident" id="7995438">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7995444">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7995447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7995451">if</span>&nbsp;<span class="ident" id="7995454">doInsert</span>&nbsp;<span class="op" id="7995463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7995467">t</span><span class="op" id="7995468">.</span><span class="ident" id="7995469">rows</span>&nbsp;<span class="op" id="7995474">=</span>&nbsp;<span class="builtinfunc" id="7995476">append</span><span class="op" id="7995482">(</span><span class="ident" id="7995483">t</span><span class="op" id="7995484">.</span><span class="ident" id="7995485">rows</span><span class="op" id="7995489">,</span>&nbsp;<span class="op" id="7995491">&amp;</span><span class="ident" id="7995492">row</span><span class="op" id="7995495">{</span><span class="ident" id="7995496">cols</span><span class="op" id="7995500">:</span>&nbsp;<span class="ident" id="7995502">cols</span><span class="op" id="7995506">}</span><span class="op" id="7995507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7995510">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7995513">return</span>&nbsp;<span class="ident" id="7995520">driver</span><span class="op" id="7995526">.</span><span class="ident" id="7995527">RowsAffected</span><span class="op" id="7995539">(</span><span class="num" id="7995540">1</span><span class="op" id="7995541">)</span><span class="op" id="7995542">,</span>&nbsp;<span class="ident" id="7995544">nil</span><br>
<span class="lineno"></span><span class="op" id="7995548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7995551">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="7995590">var</span>&nbsp;<span class="ident" id="7995594">hookQueryBadConn</span>&nbsp;<span class="keyword" id="7995611">func</span><span class="op" id="7995615">(</span><span class="op" id="7995616">)</span>&nbsp;<span class="builtintype" id="7995618">bool</span><br>
<span class="lineno">610</span><br>
<span class="lineno"></span><span class="keyword" id="7995624">func</span>&nbsp;<span class="op" id="7995629">(</span><span class="ident" id="7995630">s</span>&nbsp;<span class="op" id="7995632">*</span><span class="ident" id="7995633">fakeStmt</span><span class="op" id="7995641">)</span>&nbsp;<span class="ident" id="7995643">Query</span><span class="op" id="7995648">(</span><span class="ident" id="7995649">args</span>&nbsp;<span class="op" id="7995654">[</span><span class="op" id="7995655">]</span><span class="ident" id="7995656">driver</span><span class="op" id="7995662">.</span><span class="ident" id="7995663">Value</span><span class="op" id="7995668">)</span>&nbsp;<span class="op" id="7995670">(</span><span class="ident" id="7995671">driver</span><span class="op" id="7995677">.</span><span class="ident" id="7995678">Rows</span><span class="op" id="7995682">,</span>&nbsp;<span class="builtintype" id="7995684">error</span><span class="op" id="7995689">)</span>&nbsp;<span class="op" id="7995691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7995694">if</span>&nbsp;<span class="ident" id="7995697">s</span><span class="op" id="7995698">.</span><span class="ident" id="7995699">closed</span>&nbsp;<span class="op" id="7995706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7995710">return</span>&nbsp;<span class="ident" id="7995717">nil</span><span class="op" id="7995720">,</span>&nbsp;<span class="ident" id="7995722">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7995733">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7995737">if</span>&nbsp;<span class="ident" id="7995740">hookQueryBadConn</span>&nbsp;<span class="op" id="7995757">!=</span>&nbsp;<span class="ident" id="7995760">nil</span>&nbsp;<span class="op" id="7995764">&amp;&amp;</span>&nbsp;<span class="ident" id="7995767">hookQueryBadConn</span><span class="op" id="7995783">(</span><span class="op" id="7995784">)</span>&nbsp;<span class="op" id="7995786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7995790">return</span>&nbsp;<span class="ident" id="7995797">nil</span><span class="op" id="7995800">,</span>&nbsp;<span class="ident" id="7995802">driver</span><span class="op" id="7995808">.</span><span class="ident" id="7995809">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7995821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7995825">err</span>&nbsp;<span class="op" id="7995829">:=</span>&nbsp;<span class="ident" id="7995832">checkSubsetTypes</span><span class="op" id="7995848">(</span><span class="ident" id="7995849">args</span><span class="op" id="7995853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7995856">if</span>&nbsp;<span class="ident" id="7995859">err</span>&nbsp;<span class="op" id="7995863">!=</span>&nbsp;<span class="ident" id="7995866">nil</span>&nbsp;<span class="op" id="7995870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7995874">return</span>&nbsp;<span class="ident" id="7995881">nil</span><span class="op" id="7995884">,</span>&nbsp;<span class="ident" id="7995886">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7995891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7995895">db</span>&nbsp;<span class="op" id="7995898">:=</span>&nbsp;<span class="ident" id="7995901">s</span><span class="op" id="7995902">.</span><span class="ident" id="7995903">c</span><span class="op" id="7995904">.</span><span class="ident" id="7995905">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7995909">if</span>&nbsp;<span class="builtinfunc" id="7995912">len</span><span class="op" id="7995915">(</span><span class="ident" id="7995916">args</span><span class="op" id="7995920">)</span>&nbsp;<span class="op" id="7995922">!=</span>&nbsp;<span class="ident" id="7995925">s</span><span class="op" id="7995926">.</span><span class="ident" id="7995927">placeholders</span>&nbsp;<span class="op" id="7995940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7995944">panic</span><span class="op" id="7995949">(</span><span class="string" id="7995950">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="7996008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7996011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7996015">db</span><span class="op" id="7996017">.</span><span class="ident" id="7996018">mu</span><span class="op" id="7996020">.</span><span class="ident" id="7996021">Lock</span><span class="op" id="7996025">(</span><span class="op" id="7996026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7996029">t</span><span class="op" id="7996030">,</span>&nbsp;<span class="ident" id="7996032">ok</span>&nbsp;<span class="op" id="7996035">:=</span>&nbsp;<span class="ident" id="7996038">db</span><span class="op" id="7996040">.</span><span class="ident" id="7996041">table</span><span class="op" id="7996046">(</span><span class="ident" id="7996047">s</span><span class="op" id="7996048">.</span><span class="ident" id="7996049">table</span><span class="op" id="7996054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7996057">db</span><span class="op" id="7996059">.</span><span class="ident" id="7996060">mu</span><span class="op" id="7996062">.</span><span class="ident" id="7996063">Unlock</span><span class="op" id="7996069">(</span><span class="op" id="7996070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7996073">if</span>&nbsp;<span class="op" id="7996076">!</span><span class="ident" id="7996077">ok</span>&nbsp;<span class="op" id="7996080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7996084">return</span>&nbsp;<span class="ident" id="7996091">nil</span><span class="op" id="7996094">,</span>&nbsp;<span class="ident" id="7996096">fmt</span><span class="op" id="7996099">.</span><span class="ident" id="7996100">Errorf</span><span class="op" id="7996106">(</span><span class="string" id="7996107">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="7996139">,</span>&nbsp;<span class="ident" id="7996141">s</span><span class="op" id="7996142">.</span><span class="ident" id="7996143">table</span><span class="op" id="7996148">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7996151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7996155">if</span>&nbsp;<span class="ident" id="7996158">s</span><span class="op" id="7996159">.</span><span class="ident" id="7996160">table</span>&nbsp;<span class="op" id="7996166">==</span>&nbsp;<span class="string" id="7996169">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="7996182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7996186">if</span>&nbsp;<span class="builtinfunc" id="7996189">len</span><span class="op" id="7996192">(</span><span class="ident" id="7996193">s</span><span class="op" id="7996194">.</span><span class="ident" id="7996195">whereCol</span><span class="op" id="7996203">)</span>&nbsp;<span class="op" id="7996205">==</span>&nbsp;<span class="num" id="7996208">2</span>&nbsp;<span class="op" id="7996210">&amp;&amp;</span>&nbsp;<span class="ident" id="7996213">s</span><span class="op" id="7996214">.</span><span class="ident" id="7996215">whereCol</span><span class="op" id="7996223">[</span><span class="num" id="7996224">0</span><span class="op" id="7996225">]</span>&nbsp;<span class="op" id="7996227">==</span>&nbsp;<span class="string" id="7996230">&#34;op&#34;</span>&nbsp;<span class="op" id="7996235">&amp;&amp;</span>&nbsp;<span class="ident" id="7996238">s</span><span class="op" id="7996239">.</span><span class="ident" id="7996240">whereCol</span><span class="op" id="7996248">[</span><span class="num" id="7996249">1</span><span class="op" id="7996250">]</span>&nbsp;<span class="op" id="7996252">==</span>&nbsp;<span class="string" id="7996255">&#34;millis&#34;</span>&nbsp;<span class="op" id="7996264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7996269">if</span>&nbsp;<span class="ident" id="7996272">args</span><span class="op" id="7996276">[</span><span class="num" id="7996277">0</span><span class="op" id="7996278">]</span>&nbsp;<span class="op" id="7996280">==</span>&nbsp;<span class="string" id="7996283">&#34;sleep&#34;</span>&nbsp;<span class="op" id="7996291">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7996297">time</span><span class="op" id="7996301">.</span><span class="ident" id="7996302">Sleep</span><span class="op" id="7996307">(</span><span class="ident" id="7996308">time</span><span class="op" id="7996312">.</span><span class="ident" id="7996313">Duration</span><span class="op" id="7996321">(</span><span class="ident" id="7996322">args</span><span class="op" id="7996326">[</span><span class="num" id="7996327">1</span><span class="op" id="7996328">]</span><span class="op" id="7996329">.</span><span class="op" id="7996330">(</span><span class="ident" id="7996331">int64</span><span class="op" id="7996336">)</span><span class="op" id="7996337">)</span>&nbsp;<span class="op" id="7996339">*</span>&nbsp;<span class="ident" id="7996341">time</span><span class="op" id="7996345">.</span><span class="ident" id="7996346">Millisecond</span><span class="op" id="7996357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7996362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7996366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7996369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7996373">t</span><span class="op" id="7996374">.</span><span class="ident" id="7996375">mu</span><span class="op" id="7996377">.</span><span class="ident" id="7996378">Lock</span><span class="op" id="7996382">(</span><span class="op" id="7996383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7996386">defer</span>&nbsp;<span class="ident" id="7996392">t</span><span class="op" id="7996393">.</span><span class="ident" id="7996394">mu</span><span class="op" id="7996396">.</span><span class="ident" id="7996397">Unlock</span><span class="op" id="7996403">(</span><span class="op" id="7996404">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7996408">colIdx</span>&nbsp;<span class="op" id="7996415">:=</span>&nbsp;<span class="builtinfunc" id="7996418">make</span><span class="op" id="7996422">(</span><span class="keyword" id="7996423">map</span><span class="op" id="7996426">[</span><span class="builtintype" id="7996427">string</span><span class="op" id="7996433">]</span><span class="builtintype" id="7996434">int</span><span class="op" id="7996437">)</span>&nbsp;<span class="comment" id="7996439">//&nbsp;select&nbsp;column&nbsp;name&nbsp;-&gt;&nbsp;column&nbsp;index&nbsp;in&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7996487">for</span>&nbsp;<span class="ident" id="7996491">_</span><span class="op" id="7996492">,</span>&nbsp;<span class="ident" id="7996494">name</span>&nbsp;<span class="op" id="7996499">:=</span>&nbsp;<span class="keyword" id="7996502">range</span>&nbsp;<span class="ident" id="7996508">s</span><span class="op" id="7996509">.</span><span class="ident" id="7996510">colName</span>&nbsp;<span class="op" id="7996518">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7996522">idx</span>&nbsp;<span class="op" id="7996526">:=</span>&nbsp;<span class="ident" id="7996529">t</span><span class="op" id="7996530">.</span><span class="ident" id="7996531">columnIndex</span><span class="op" id="7996542">(</span><span class="ident" id="7996543">name</span><span class="op" id="7996547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7996551">if</span>&nbsp;<span class="ident" id="7996554">idx</span>&nbsp;<span class="op" id="7996558">==</span>&nbsp;<span class="op" id="7996561">-</span><span class="num" id="7996562">1</span>&nbsp;<span class="op" id="7996564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7996569">return</span>&nbsp;<span class="ident" id="7996576">nil</span><span class="op" id="7996579">,</span>&nbsp;<span class="ident" id="7996581">fmt</span><span class="op" id="7996584">.</span><span class="ident" id="7996585">Errorf</span><span class="op" id="7996591">(</span><span class="string" id="7996592">&#34;fakedb:&nbsp;unknown&nbsp;column&nbsp;name&nbsp;%q&#34;</span><span class="op" id="7996624">,</span>&nbsp;<span class="ident" id="7996626">name</span><span class="op" id="7996630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7996634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7996638">colIdx</span><span class="op" id="7996644">[</span><span class="ident" id="7996645">name</span><span class="op" id="7996649">]</span>&nbsp;<span class="op" id="7996651">=</span>&nbsp;<span class="ident" id="7996653">idx</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7996658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7996662">mrows</span>&nbsp;<span class="op" id="7996668">:=</span>&nbsp;<span class="op" id="7996671">[</span><span class="op" id="7996672">]</span><span class="op" id="7996673">*</span><span class="ident" id="7996674">row</span><span class="op" id="7996677">{</span><span class="op" id="7996678">}</span><br>
<span class="lineno"></span><span class="ident" id="7996680">rows</span><span class="op" id="7996684">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7996687">for</span>&nbsp;<span class="ident" id="7996691">_</span><span class="op" id="7996692">,</span>&nbsp;<span class="ident" id="7996694">trow</span>&nbsp;<span class="op" id="7996699">:=</span>&nbsp;<span class="keyword" id="7996702">range</span>&nbsp;<span class="ident" id="7996708">t</span><span class="op" id="7996709">.</span><span class="ident" id="7996710">rows</span>&nbsp;<span class="op" id="7996715">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7996719">//&nbsp;Process&nbsp;the&nbsp;where&nbsp;clause,&nbsp;skipping&nbsp;non-match&nbsp;rows.&nbsp;This&nbsp;is&nbsp;lazy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7996788">//&nbsp;and&nbsp;just&nbsp;uses&nbsp;fmt.Sprintf(&#34;%v&#34;)&nbsp;to&nbsp;test&nbsp;equality.&nbsp;&nbsp;Good&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7996856">//&nbsp;for&nbsp;test&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7996876">for</span>&nbsp;<span class="ident" id="7996880">widx</span><span class="op" id="7996884">,</span>&nbsp;<span class="ident" id="7996886">wcol</span>&nbsp;<span class="op" id="7996891">:=</span>&nbsp;<span class="keyword" id="7996894">range</span>&nbsp;<span class="ident" id="7996900">s</span><span class="op" id="7996901">.</span><span class="ident" id="7996902">whereCol</span>&nbsp;<span class="op" id="7996911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7996916">idx</span>&nbsp;<span class="op" id="7996920">:=</span>&nbsp;<span class="ident" id="7996923">t</span><span class="op" id="7996924">.</span><span class="ident" id="7996925">columnIndex</span><span class="op" id="7996936">(</span><span class="ident" id="7996937">wcol</span><span class="op" id="7996941">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7996946">if</span>&nbsp;<span class="ident" id="7996949">idx</span>&nbsp;<span class="op" id="7996953">==</span>&nbsp;<span class="op" id="7996956">-</span><span class="num" id="7996957">1</span>&nbsp;<span class="op" id="7996959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7996965">return</span>&nbsp;<span class="ident" id="7996972">nil</span><span class="op" id="7996975">,</span>&nbsp;<span class="ident" id="7996977">fmt</span><span class="op" id="7996980">.</span><span class="ident" id="7996981">Errorf</span><span class="op" id="7996987">(</span><span class="string" id="7996988">&#34;db:&nbsp;invalid&nbsp;where&nbsp;clause&nbsp;column&nbsp;%q&#34;</span><span class="op" id="7997024">,</span>&nbsp;<span class="ident" id="7997026">wcol</span><span class="op" id="7997030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7997035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7997040">tcol</span>&nbsp;<span class="op" id="7997045">:=</span>&nbsp;<span class="ident" id="7997048">trow</span><span class="op" id="7997052">.</span><span class="ident" id="7997053">cols</span><span class="op" id="7997057">[</span><span class="ident" id="7997058">idx</span><span class="op" id="7997061">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7997066">if</span>&nbsp;<span class="ident" id="7997069">bs</span><span class="op" id="7997071">,</span>&nbsp;<span class="ident" id="7997073">ok</span>&nbsp;<span class="op" id="7997076">:=</span>&nbsp;<span class="ident" id="7997079">tcol</span><span class="op" id="7997083">.</span><span class="op" id="7997084">(</span><span class="op" id="7997085">[</span><span class="op" id="7997086">]</span><span class="builtintype" id="7997087">byte</span><span class="op" id="7997091">)</span><span class="op" id="7997092">;</span>&nbsp;<span class="ident" id="7997094">ok</span>&nbsp;<span class="op" id="7997097">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7997103">//&nbsp;lazy&nbsp;hack&nbsp;to&nbsp;avoid&nbsp;sprintf&nbsp;%v&nbsp;on&nbsp;a&nbsp;[]byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7997152">tcol</span>&nbsp;<span class="op" id="7997157">=</span>&nbsp;<span class="builtintype" id="7997159">string</span><span class="op" id="7997165">(</span><span class="ident" id="7997166">bs</span><span class="op" id="7997168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7997173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7997178">if</span>&nbsp;<span class="ident" id="7997181">fmt</span><span class="op" id="7997184">.</span><span class="ident" id="7997185">Sprintf</span><span class="op" id="7997192">(</span><span class="string" id="7997193">&#34;%v&#34;</span><span class="op" id="7997197">,</span>&nbsp;<span class="ident" id="7997199">tcol</span><span class="op" id="7997203">)</span>&nbsp;<span class="op" id="7997205">!=</span>&nbsp;<span class="ident" id="7997208">fmt</span><span class="op" id="7997211">.</span><span class="ident" id="7997212">Sprintf</span><span class="op" id="7997219">(</span><span class="string" id="7997220">&#34;%v&#34;</span><span class="op" id="7997224">,</span>&nbsp;<span class="ident" id="7997226">args</span><span class="op" id="7997230">[</span><span class="ident" id="7997231">widx</span><span class="op" id="7997235">]</span><span class="op" id="7997236">)</span>&nbsp;<span class="op" id="7997238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7997244">continue</span>&nbsp;<span class="ident" id="7997253">rows</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7997261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7997265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7997269">mrow</span>&nbsp;<span class="op" id="7997274">:=</span>&nbsp;<span class="op" id="7997277">&amp;</span><span class="ident" id="7997278">row</span><span class="op" id="7997281">{</span><span class="ident" id="7997282">cols</span><span class="op" id="7997286">:</span>&nbsp;<span class="builtinfunc" id="7997288">make</span><span class="op" id="7997292">(</span><span class="op" id="7997293">[</span><span class="op" id="7997294">]</span><span class="keyword" id="7997295">interface</span><span class="op" id="7997304">{</span><span class="op" id="7997305">}</span><span class="op" id="7997306">,</span>&nbsp;<span class="builtinfunc" id="7997308">len</span><span class="op" id="7997311">(</span><span class="ident" id="7997312">s</span><span class="op" id="7997313">.</span><span class="ident" id="7997314">colName</span><span class="op" id="7997321">)</span><span class="op" id="7997322">)</span><span class="op" id="7997323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7997327">for</span>&nbsp;<span class="ident" id="7997331">seli</span><span class="op" id="7997335">,</span>&nbsp;<span class="ident" id="7997337">name</span>&nbsp;<span class="op" id="7997342">:=</span>&nbsp;<span class="keyword" id="7997345">range</span>&nbsp;<span class="ident" id="7997351">s</span><span class="op" id="7997352">.</span><span class="ident" id="7997353">colName</span>&nbsp;<span class="op" id="7997361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7997366">mrow</span><span class="op" id="7997370">.</span><span class="ident" id="7997371">cols</span><span class="op" id="7997375">[</span><span class="ident" id="7997376">seli</span><span class="op" id="7997380">]</span>&nbsp;<span class="op" id="7997382">=</span>&nbsp;<span class="ident" id="7997384">trow</span><span class="op" id="7997388">.</span><span class="ident" id="7997389">cols</span><span class="op" id="7997393">[</span><span class="ident" id="7997394">colIdx</span><span class="op" id="7997400">[</span><span class="ident" id="7997401">name</span><span class="op" id="7997405">]</span><span class="op" id="7997406">]</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7997410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7997414">mrows</span>&nbsp;<span class="op" id="7997420">=</span>&nbsp;<span class="builtinfunc" id="7997422">append</span><span class="op" id="7997428">(</span><span class="ident" id="7997429">mrows</span><span class="op" id="7997434">,</span>&nbsp;<span class="ident" id="7997436">mrow</span><span class="op" id="7997440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7997443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7997447">cursor</span>&nbsp;<span class="op" id="7997454">:=</span>&nbsp;<span class="op" id="7997457">&amp;</span><span class="ident" id="7997458">rowsCursor</span><span class="op" id="7997468">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7997472">pos</span><span class="op" id="7997475">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7997480">-</span><span class="num" id="7997481">1</span><span class="op" id="7997482">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7997486">rows</span><span class="op" id="7997490">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7997494">mrows</span><span class="op" id="7997499">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7997503">cols</span><span class="op" id="7997507">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7997511">s</span><span class="op" id="7997512">.</span><span class="ident" id="7997513">colName</span><span class="op" id="7997520">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7997524">errPos</span><span class="op" id="7997530">:</span>&nbsp;<span class="op" id="7997532">-</span><span class="num" id="7997533">1</span><span class="op" id="7997534">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7997537">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7997540">return</span>&nbsp;<span class="ident" id="7997547">cursor</span><span class="op" id="7997553">,</span>&nbsp;<span class="ident" id="7997555">nil</span><br>
<span class="lineno"></span><span class="op" id="7997559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7997562">func</span>&nbsp;<span class="op" id="7997567">(</span><span class="ident" id="7997568">s</span>&nbsp;<span class="op" id="7997570">*</span><span class="ident" id="7997571">fakeStmt</span><span class="op" id="7997579">)</span>&nbsp;<span class="ident" id="7997581">NumInput</span><span class="op" id="7997589">(</span><span class="op" id="7997590">)</span>&nbsp;<span class="builtintype" id="7997592">int</span>&nbsp;<span class="op" id="7997596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7997599">return</span>&nbsp;<span class="ident" id="7997606">s</span><span class="op" id="7997607">.</span><span class="ident" id="7997608">placeholders</span><br>
<span class="lineno">695</span><span class="op" id="7997621">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7997624">func</span>&nbsp;<span class="op" id="7997629">(</span><span class="ident" id="7997630">tx</span>&nbsp;<span class="op" id="7997633">*</span><span class="ident" id="7997634">fakeTx</span><span class="op" id="7997640">)</span>&nbsp;<span class="ident" id="7997642">Commit</span><span class="op" id="7997648">(</span><span class="op" id="7997649">)</span>&nbsp;<span class="builtintype" id="7997651">error</span>&nbsp;<span class="op" id="7997657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7997660">tx</span><span class="op" id="7997662">.</span><span class="ident" id="7997663">c</span><span class="op" id="7997664">.</span><span class="ident" id="7997665">currTx</span>&nbsp;<span class="op" id="7997672">=</span>&nbsp;<span class="ident" id="7997674">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7997679">return</span>&nbsp;<span class="ident" id="7997686">nil</span><br>
<span class="lineno">700</span><span class="op" id="7997690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7997693">func</span>&nbsp;<span class="op" id="7997698">(</span><span class="ident" id="7997699">tx</span>&nbsp;<span class="op" id="7997702">*</span><span class="ident" id="7997703">fakeTx</span><span class="op" id="7997709">)</span>&nbsp;<span class="ident" id="7997711">Rollback</span><span class="op" id="7997719">(</span><span class="op" id="7997720">)</span>&nbsp;<span class="builtintype" id="7997722">error</span>&nbsp;<span class="op" id="7997728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7997731">tx</span><span class="op" id="7997733">.</span><span class="ident" id="7997734">c</span><span class="op" id="7997735">.</span><span class="ident" id="7997736">currTx</span>&nbsp;<span class="op" id="7997743">=</span>&nbsp;<span class="ident" id="7997745">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7997750">return</span>&nbsp;<span class="ident" id="7997757">nil</span><br>
<span class="lineno">705</span><span class="op" id="7997761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7997764">type</span>&nbsp;<span class="ident" id="7997769">rowsCursor</span>&nbsp;<span class="keyword" id="7997780">struct</span>&nbsp;<span class="op" id="7997787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7997790">cols</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7997797">[</span><span class="op" id="7997798">]</span><span class="builtintype" id="7997799">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7997807">pos</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7997814">int</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7997819">rows</span>&nbsp;&nbsp;&nbsp;<span class="op" id="7997826">[</span><span class="op" id="7997827">]</span><span class="op" id="7997828">*</span><span class="ident" id="7997829">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7997834">closed</span>&nbsp;<span class="builtintype" id="7997841">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7997848">//&nbsp;errPos&nbsp;and&nbsp;err&nbsp;are&nbsp;for&nbsp;making&nbsp;Next&nbsp;return&nbsp;early&nbsp;with&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7997912">errPos</span>&nbsp;<span class="builtintype" id="7997919">int</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7997924">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7997931">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7997939">//&nbsp;a&nbsp;clone&nbsp;of&nbsp;slices&nbsp;to&nbsp;give&nbsp;out&nbsp;to&nbsp;clients,&nbsp;indexed&nbsp;by&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7998000">//&nbsp;the&nbsp;original&nbsp;slice&#39;s&nbsp;first&nbsp;byte&nbsp;address.&nbsp;&nbsp;we&nbsp;clone&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7998060">//&nbsp;just&nbsp;so&nbsp;we&#39;re&nbsp;able&nbsp;to&nbsp;corrupt&nbsp;them&nbsp;on&nbsp;close.</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7998109">bytesClone</span>&nbsp;<span class="keyword" id="7998120">map</span><span class="op" id="7998123">[</span><span class="op" id="7998124">*</span><span class="builtintype" id="7998125">byte</span><span class="op" id="7998129">]</span><span class="op" id="7998130">[</span><span class="op" id="7998131">]</span><span class="builtintype" id="7998132">byte</span><br>
<span class="lineno"></span><span class="op" id="7998137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7998140">func</span>&nbsp;<span class="op" id="7998145">(</span><span class="ident" id="7998146">rc</span>&nbsp;<span class="op" id="7998149">*</span><span class="ident" id="7998150">rowsCursor</span><span class="op" id="7998160">)</span>&nbsp;<span class="ident" id="7998162">Close</span><span class="op" id="7998167">(</span><span class="op" id="7998168">)</span>&nbsp;<span class="builtintype" id="7998170">error</span>&nbsp;<span class="op" id="7998176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7998179">if</span>&nbsp;<span class="op" id="7998182">!</span><span class="ident" id="7998183">rc</span><span class="op" id="7998185">.</span><span class="ident" id="7998186">closed</span>&nbsp;<span class="op" id="7998193">{</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7998197">for</span>&nbsp;<span class="ident" id="7998201">_</span><span class="op" id="7998202">,</span>&nbsp;<span class="ident" id="7998204">bs</span>&nbsp;<span class="op" id="7998207">:=</span>&nbsp;<span class="keyword" id="7998210">range</span>&nbsp;<span class="ident" id="7998216">rc</span><span class="op" id="7998218">.</span><span class="ident" id="7998219">bytesClone</span>&nbsp;<span class="op" id="7998230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7998235">bs</span><span class="op" id="7998237">[</span><span class="num" id="7998238">0</span><span class="op" id="7998239">]</span>&nbsp;<span class="op" id="7998241">=</span>&nbsp;<span class="num" id="7998243">255</span>&nbsp;<span class="comment" id="7998247">//&nbsp;first&nbsp;byte&nbsp;corrupted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7998273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7998276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7998279">rc</span><span class="op" id="7998281">.</span><span class="ident" id="7998282">closed</span>&nbsp;<span class="op" id="7998289">=</span>&nbsp;<span class="builtintype" id="7998291">true</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7998297">return</span>&nbsp;<span class="ident" id="7998304">nil</span><br>
<span class="lineno"></span><span class="op" id="7998308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7998311">func</span>&nbsp;<span class="op" id="7998316">(</span><span class="ident" id="7998317">rc</span>&nbsp;<span class="op" id="7998320">*</span><span class="ident" id="7998321">rowsCursor</span><span class="op" id="7998331">)</span>&nbsp;<span class="ident" id="7998333">Columns</span><span class="op" id="7998340">(</span><span class="op" id="7998341">)</span>&nbsp;<span class="op" id="7998343">[</span><span class="op" id="7998344">]</span><span class="builtintype" id="7998345">string</span>&nbsp;<span class="op" id="7998352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7998355">return</span>&nbsp;<span class="ident" id="7998362">rc</span><span class="op" id="7998364">.</span><span class="ident" id="7998365">cols</span><br>
<span class="lineno">735</span><span class="op" id="7998370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7998373">var</span>&nbsp;<span class="ident" id="7998377">rowsCursorNextHook</span>&nbsp;<span class="keyword" id="7998396">func</span><span class="op" id="7998400">(</span><span class="ident" id="7998401">dest</span>&nbsp;<span class="op" id="7998406">[</span><span class="op" id="7998407">]</span><span class="ident" id="7998408">driver</span><span class="op" id="7998414">.</span><span class="ident" id="7998415">Value</span><span class="op" id="7998420">)</span>&nbsp;<span class="builtintype" id="7998422">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7998429">func</span>&nbsp;<span class="op" id="7998434">(</span><span class="ident" id="7998435">rc</span>&nbsp;<span class="op" id="7998438">*</span><span class="ident" id="7998439">rowsCursor</span><span class="op" id="7998449">)</span>&nbsp;<span class="ident" id="7998451">Next</span><span class="op" id="7998455">(</span><span class="ident" id="7998456">dest</span>&nbsp;<span class="op" id="7998461">[</span><span class="op" id="7998462">]</span><span class="ident" id="7998463">driver</span><span class="op" id="7998469">.</span><span class="ident" id="7998470">Value</span><span class="op" id="7998475">)</span>&nbsp;<span class="builtintype" id="7998477">error</span>&nbsp;<span class="op" id="7998483">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7998486">if</span>&nbsp;<span class="ident" id="7998489">rowsCursorNextHook</span>&nbsp;<span class="op" id="7998508">!=</span>&nbsp;<span class="ident" id="7998511">nil</span>&nbsp;<span class="op" id="7998515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7998519">return</span>&nbsp;<span class="ident" id="7998526">rowsCursorNextHook</span><span class="op" id="7998544">(</span><span class="ident" id="7998545">dest</span><span class="op" id="7998549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7998552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7998556">if</span>&nbsp;<span class="ident" id="7998559">rc</span><span class="op" id="7998561">.</span><span class="ident" id="7998562">closed</span>&nbsp;<span class="op" id="7998569">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7998573">return</span>&nbsp;<span class="ident" id="7998580">errors</span><span class="op" id="7998586">.</span><span class="ident" id="7998587">New</span><span class="op" id="7998590">(</span><span class="string" id="7998591">&#34;fakedb:&nbsp;cursor&nbsp;is&nbsp;closed&#34;</span><span class="op" id="7998617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7998620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7998623">rc</span><span class="op" id="7998625">.</span><span class="ident" id="7998626">pos</span><span class="op" id="7998629">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7998633">if</span>&nbsp;<span class="ident" id="7998636">rc</span><span class="op" id="7998638">.</span><span class="ident" id="7998639">pos</span>&nbsp;<span class="op" id="7998643">==</span>&nbsp;<span class="ident" id="7998646">rc</span><span class="op" id="7998648">.</span><span class="ident" id="7998649">errPos</span>&nbsp;<span class="op" id="7998656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7998660">return</span>&nbsp;<span class="ident" id="7998667">rc</span><span class="op" id="7998669">.</span><span class="ident" id="7998670">err</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7998675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7998678">if</span>&nbsp;<span class="ident" id="7998681">rc</span><span class="op" id="7998683">.</span><span class="ident" id="7998684">pos</span>&nbsp;<span class="op" id="7998688">&gt;=</span>&nbsp;<span class="builtinfunc" id="7998691">len</span><span class="op" id="7998694">(</span><span class="ident" id="7998695">rc</span><span class="op" id="7998697">.</span><span class="ident" id="7998698">rows</span><span class="op" id="7998702">)</span>&nbsp;<span class="op" id="7998704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7998708">return</span>&nbsp;<span class="ident" id="7998715">io</span><span class="op" id="7998717">.</span><span class="ident" id="7998718">EOF</span>&nbsp;<span class="comment" id="7998722">//&nbsp;per&nbsp;interface&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7998745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7998748">for</span>&nbsp;<span class="ident" id="7998752">i</span><span class="op" id="7998753">,</span>&nbsp;<span class="ident" id="7998755">v</span>&nbsp;<span class="op" id="7998757">:=</span>&nbsp;<span class="keyword" id="7998760">range</span>&nbsp;<span class="ident" id="7998766">rc</span><span class="op" id="7998768">.</span><span class="ident" id="7998769">rows</span><span class="op" id="7998773">[</span><span class="ident" id="7998774">rc</span><span class="op" id="7998776">.</span><span class="ident" id="7998777">pos</span><span class="op" id="7998780">]</span><span class="op" id="7998781">.</span><span class="ident" id="7998782">cols</span>&nbsp;<span class="op" id="7998787">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7998791">//&nbsp;TODO(bradfitz):&nbsp;convert&nbsp;to&nbsp;subset&nbsp;types?&nbsp;naah,&nbsp;I</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7998845">//&nbsp;think&nbsp;the&nbsp;subset&nbsp;types&nbsp;should&nbsp;only&nbsp;be&nbsp;input&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7998897">//&nbsp;driver,&nbsp;but&nbsp;the&nbsp;sql&nbsp;package&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7998955">//&nbsp;a&nbsp;wider&nbsp;range&nbsp;of&nbsp;types&nbsp;coming&nbsp;out&nbsp;of&nbsp;drivers.&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7999010">//&nbsp;for&nbsp;ease&nbsp;of&nbsp;drivers,&nbsp;and&nbsp;to&nbsp;prevent&nbsp;drivers&nbsp;from</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7999064">//&nbsp;messing&nbsp;up&nbsp;conversions&nbsp;or&nbsp;doing&nbsp;them&nbsp;differently.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7999119">dest</span><span class="op" id="7999123">[</span><span class="ident" id="7999124">i</span><span class="op" id="7999125">]</span>&nbsp;<span class="op" id="7999127">=</span>&nbsp;<span class="ident" id="7999129">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7999134">if</span>&nbsp;<span class="ident" id="7999137">bs</span><span class="op" id="7999139">,</span>&nbsp;<span class="ident" id="7999141">ok</span>&nbsp;<span class="op" id="7999144">:=</span>&nbsp;<span class="ident" id="7999147">v</span><span class="op" id="7999148">.</span><span class="op" id="7999149">(</span><span class="op" id="7999150">[</span><span class="op" id="7999151">]</span><span class="builtintype" id="7999152">byte</span><span class="op" id="7999156">)</span><span class="op" id="7999157">;</span>&nbsp;<span class="ident" id="7999159">ok</span>&nbsp;<span class="op" id="7999162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7999167">if</span>&nbsp;<span class="ident" id="7999170">rc</span><span class="op" id="7999172">.</span><span class="ident" id="7999173">bytesClone</span>&nbsp;<span class="op" id="7999184">==</span>&nbsp;<span class="ident" id="7999187">nil</span>&nbsp;<span class="op" id="7999191">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7999197">rc</span><span class="op" id="7999199">.</span><span class="ident" id="7999200">bytesClone</span>&nbsp;<span class="op" id="7999211">=</span>&nbsp;<span class="builtinfunc" id="7999213">make</span><span class="op" id="7999217">(</span><span class="keyword" id="7999218">map</span><span class="op" id="7999221">[</span><span class="op" id="7999222">*</span><span class="builtintype" id="7999223">byte</span><span class="op" id="7999227">]</span><span class="op" id="7999228">[</span><span class="op" id="7999229">]</span><span class="builtintype" id="7999230">byte</span><span class="op" id="7999234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7999239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7999244">clone</span><span class="op" id="7999249">,</span>&nbsp;<span class="ident" id="7999251">ok</span>&nbsp;<span class="op" id="7999254">:=</span>&nbsp;<span class="ident" id="7999257">rc</span><span class="op" id="7999259">.</span><span class="ident" id="7999260">bytesClone</span><span class="op" id="7999270">[</span><span class="op" id="7999271">&amp;</span><span class="ident" id="7999272">bs</span><span class="op" id="7999274">[</span><span class="num" id="7999275">0</span><span class="op" id="7999276">]</span><span class="op" id="7999277">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7999282">if</span>&nbsp;<span class="op" id="7999285">!</span><span class="ident" id="7999286">ok</span>&nbsp;<span class="op" id="7999289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7999295">clone</span>&nbsp;<span class="op" id="7999301">=</span>&nbsp;<span class="builtinfunc" id="7999303">make</span><span class="op" id="7999307">(</span><span class="op" id="7999308">[</span><span class="op" id="7999309">]</span><span class="builtintype" id="7999310">byte</span><span class="op" id="7999314">,</span>&nbsp;<span class="builtinfunc" id="7999316">len</span><span class="op" id="7999319">(</span><span class="ident" id="7999320">bs</span><span class="op" id="7999322">)</span><span class="op" id="7999323">)</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7999329">copy</span><span class="op" id="7999333">(</span><span class="ident" id="7999334">clone</span><span class="op" id="7999339">,</span>&nbsp;<span class="ident" id="7999341">bs</span><span class="op" id="7999343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7999349">rc</span><span class="op" id="7999351">.</span><span class="ident" id="7999352">bytesClone</span><span class="op" id="7999362">[</span><span class="op" id="7999363">&amp;</span><span class="ident" id="7999364">bs</span><span class="op" id="7999366">[</span><span class="num" id="7999367">0</span><span class="op" id="7999368">]</span><span class="op" id="7999369">]</span>&nbsp;<span class="op" id="7999371">=</span>&nbsp;<span class="ident" id="7999373">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7999382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7999387">dest</span><span class="op" id="7999391">[</span><span class="ident" id="7999392">i</span><span class="op" id="7999393">]</span>&nbsp;<span class="op" id="7999395">=</span>&nbsp;<span class="ident" id="7999397">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7999405">}</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7999408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7999411">return</span>&nbsp;<span class="ident" id="7999418">nil</span><br>
<span class="lineno"></span><span class="op" id="7999422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7999425">//&nbsp;fakeDriverString&nbsp;is&nbsp;like&nbsp;driver.String,&nbsp;but&nbsp;indirects&nbsp;pointers&nbsp;like</span><br>
<span class="lineno">780</span><span class="comment" id="7999496">//&nbsp;DefaultValueConverter.</span><br>
<span class="lineno"></span><span class="comment" id="7999522">//</span><br>
<span class="lineno"></span><span class="comment" id="7999525">//&nbsp;This&nbsp;could&nbsp;be&nbsp;surprising&nbsp;behavior&nbsp;to&nbsp;retroactively&nbsp;apply&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="7999588">//&nbsp;driver.String&nbsp;now&nbsp;that&nbsp;Go1&nbsp;is&nbsp;out,&nbsp;but&nbsp;this&nbsp;is&nbsp;convenient&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="7999653">//&nbsp;our&nbsp;TestPointerParamsAndScans.</span><br>
<span class="lineno">785</span><span class="comment" id="7999687">//</span><br>
<span class="lineno"></span><span class="keyword" id="7999690">type</span>&nbsp;<span class="ident" id="7999695">fakeDriverString</span>&nbsp;<span class="keyword" id="7999712">struct</span><span class="op" id="7999718">{</span><span class="op" id="7999719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7999722">func</span>&nbsp;<span class="op" id="7999727">(</span><span class="ident" id="7999728">fakeDriverString</span><span class="op" id="7999744">)</span>&nbsp;<span class="ident" id="7999746">ConvertValue</span><span class="op" id="7999758">(</span><span class="ident" id="7999759">v</span>&nbsp;<span class="keyword" id="7999761">interface</span><span class="op" id="7999770">{</span><span class="op" id="7999771">}</span><span class="op" id="7999772">)</span>&nbsp;<span class="op" id="7999774">(</span><span class="ident" id="7999775">driver</span><span class="op" id="7999781">.</span><span class="ident" id="7999782">Value</span><span class="op" id="7999787">,</span>&nbsp;<span class="builtintype" id="7999789">error</span><span class="op" id="7999794">)</span>&nbsp;<span class="op" id="7999796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7999799">switch</span>&nbsp;<span class="ident" id="7999806">c</span>&nbsp;<span class="op" id="7999808">:=</span>&nbsp;<span class="ident" id="7999811">v</span><span class="op" id="7999812">.</span><span class="op" id="7999813">(</span><span class="keyword" id="7999814">type</span><span class="op" id="7999818">)</span>&nbsp;<span class="op" id="7999820">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7999823">case</span>&nbsp;<span class="builtintype" id="7999828">string</span><span class="op" id="7999834">,</span>&nbsp;<span class="op" id="7999836">[</span><span class="op" id="7999837">]</span><span class="builtintype" id="7999838">byte</span><span class="op" id="7999842">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7999846">return</span>&nbsp;<span class="ident" id="7999853">v</span><span class="op" id="7999854">,</span>&nbsp;<span class="ident" id="7999856">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7999861">case</span>&nbsp;<span class="op" id="7999866">*</span><span class="builtintype" id="7999867">string</span><span class="op" id="7999873">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7999877">if</span>&nbsp;<span class="ident" id="7999880">c</span>&nbsp;<span class="op" id="7999882">==</span>&nbsp;<span class="ident" id="7999885">nil</span>&nbsp;<span class="op" id="7999889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7999894">return</span>&nbsp;<span class="ident" id="7999901">nil</span><span class="op" id="7999904">,</span>&nbsp;<span class="ident" id="7999906">nil</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7999912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7999916">return</span>&nbsp;<span class="op" id="7999923">*</span><span class="ident" id="7999924">c</span><span class="op" id="7999925">,</span>&nbsp;<span class="ident" id="7999927">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7999932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7999935">return</span>&nbsp;<span class="ident" id="7999942">fmt</span><span class="op" id="7999945">.</span><span class="ident" id="7999946">Sprintf</span><span class="op" id="7999953">(</span><span class="string" id="7999954">&#34;%v&#34;</span><span class="op" id="7999958">,</span>&nbsp;<span class="ident" id="7999960">v</span><span class="op" id="7999961">)</span><span class="op" id="7999962">,</span>&nbsp;<span class="ident" id="7999964">nil</span><br>
<span class="lineno"></span><span class="op" id="7999968">}</span><br>
<span class="lineno">800</span><br>
<span class="lineno"></span><span class="keyword" id="7999971">func</span>&nbsp;<span class="ident" id="7999976">converterForType</span><span class="op" id="7999992">(</span><span class="ident" id="7999993">typ</span>&nbsp;<span class="builtintype" id="7999997">string</span><span class="op" id="8000003">)</span>&nbsp;<span class="ident" id="8000005">driver</span><span class="op" id="8000011">.</span><span class="ident" id="8000012">ValueConverter</span>&nbsp;<span class="op" id="8000027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8000030">switch</span>&nbsp;<span class="ident" id="8000037">typ</span>&nbsp;<span class="op" id="8000041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8000044">case</span>&nbsp;<span class="string" id="8000049">&#34;bool&#34;</span><span class="op" id="8000055">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8000059">return</span>&nbsp;<span class="ident" id="8000066">driver</span><span class="op" id="8000072">.</span><span class="ident" id="8000073">Bool</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8000079">case</span>&nbsp;<span class="string" id="8000084">&#34;nullbool&#34;</span><span class="op" id="8000094">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8000098">return</span>&nbsp;<span class="ident" id="8000105">driver</span><span class="op" id="8000111">.</span><span class="ident" id="8000112">Null</span><span class="op" id="8000116">{</span><span class="ident" id="8000117">Converter</span><span class="op" id="8000126">:</span>&nbsp;<span class="ident" id="8000128">driver</span><span class="op" id="8000134">.</span><span class="ident" id="8000135">Bool</span><span class="op" id="8000139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8000142">case</span>&nbsp;<span class="string" id="8000147">&#34;int32&#34;</span><span class="op" id="8000154">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8000158">return</span>&nbsp;<span class="ident" id="8000165">driver</span><span class="op" id="8000171">.</span><span class="ident" id="8000172">Int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8000179">case</span>&nbsp;<span class="string" id="8000184">&#34;string&#34;</span><span class="op" id="8000192">:</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8000196">return</span>&nbsp;<span class="ident" id="8000203">driver</span><span class="op" id="8000209">.</span><span class="ident" id="8000210">NotNull</span><span class="op" id="8000217">{</span><span class="ident" id="8000218">Converter</span><span class="op" id="8000227">:</span>&nbsp;<span class="ident" id="8000229">fakeDriverString</span><span class="op" id="8000245">{</span><span class="op" id="8000246">}</span><span class="op" id="8000247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8000250">case</span>&nbsp;<span class="string" id="8000255">&#34;nullstring&#34;</span><span class="op" id="8000267">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8000271">return</span>&nbsp;<span class="ident" id="8000278">driver</span><span class="op" id="8000284">.</span><span class="ident" id="8000285">Null</span><span class="op" id="8000289">{</span><span class="ident" id="8000290">Converter</span><span class="op" id="8000299">:</span>&nbsp;<span class="ident" id="8000301">fakeDriverString</span><span class="op" id="8000317">{</span><span class="op" id="8000318">}</span><span class="op" id="8000319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8000322">case</span>&nbsp;<span class="string" id="8000327">&#34;int64&#34;</span><span class="op" id="8000334">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8000338">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8000390">return</span>&nbsp;<span class="ident" id="8000397">driver</span><span class="op" id="8000403">.</span><span class="ident" id="8000404">NotNull</span><span class="op" id="8000411">{</span><span class="ident" id="8000412">Converter</span><span class="op" id="8000421">:</span>&nbsp;<span class="ident" id="8000423">driver</span><span class="op" id="8000429">.</span><span class="ident" id="8000430">DefaultParameterConverter</span><span class="op" id="8000455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8000458">case</span>&nbsp;<span class="string" id="8000463">&#34;nullint64&#34;</span><span class="op" id="8000474">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8000478">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8000530">return</span>&nbsp;<span class="ident" id="8000537">driver</span><span class="op" id="8000543">.</span><span class="ident" id="8000544">Null</span><span class="op" id="8000548">{</span><span class="ident" id="8000549">Converter</span><span class="op" id="8000558">:</span>&nbsp;<span class="ident" id="8000560">driver</span><span class="op" id="8000566">.</span><span class="ident" id="8000567">DefaultParameterConverter</span><span class="op" id="8000592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8000595">case</span>&nbsp;<span class="string" id="8000600">&#34;float64&#34;</span><span class="op" id="8000609">:</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8000613">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8000665">return</span>&nbsp;<span class="ident" id="8000672">driver</span><span class="op" id="8000678">.</span><span class="ident" id="8000679">NotNull</span><span class="op" id="8000686">{</span><span class="ident" id="8000687">Converter</span><span class="op" id="8000696">:</span>&nbsp;<span class="ident" id="8000698">driver</span><span class="op" id="8000704">.</span><span class="ident" id="8000705">DefaultParameterConverter</span><span class="op" id="8000730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8000733">case</span>&nbsp;<span class="string" id="8000738">&#34;nullfloat64&#34;</span><span class="op" id="8000751">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8000755">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8000807">return</span>&nbsp;<span class="ident" id="8000814">driver</span><span class="op" id="8000820">.</span><span class="ident" id="8000821">Null</span><span class="op" id="8000825">{</span><span class="ident" id="8000826">Converter</span><span class="op" id="8000835">:</span>&nbsp;<span class="ident" id="8000837">driver</span><span class="op" id="8000843">.</span><span class="ident" id="8000844">DefaultParameterConverter</span><span class="op" id="8000869">}</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8000872">case</span>&nbsp;<span class="string" id="8000877">&#34;datetime&#34;</span><span class="op" id="8000887">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8000891">return</span>&nbsp;<span class="ident" id="8000898">driver</span><span class="op" id="8000904">.</span><span class="ident" id="8000905">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8000932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8000935">panic</span><span class="op" id="8000940">(</span><span class="string" id="8000941">&#34;invalid&nbsp;fakedb&nbsp;column&nbsp;type&nbsp;of&nbsp;&#34;</span>&nbsp;<span class="op" id="8000974">+</span>&nbsp;<span class="ident" id="8000976">typ</span><span class="op" id="8000979">)</span><br>
<span class="lineno"></span><span class="op" id="8000981">}</span>
</div>
</body>
</html>
