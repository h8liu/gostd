<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4006028">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4006083">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4006137">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4006188">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4006253">//&nbsp;DNS&nbsp;client:&nbsp;see&nbsp;RFC&nbsp;1035.</span><br>
<span class="lineno"></span><span class="comment" id="4006282">//&nbsp;Has&nbsp;to&nbsp;be&nbsp;linked&nbsp;into&nbsp;package&nbsp;net&nbsp;for&nbsp;Dial.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="4006330">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span><span class="comment" id="4006344">//&nbsp;&nbsp;&nbsp;&nbspCould&nbsp;potentially&nbsp;handle&nbsp;many&nbsp;outstanding&nbsp;lookups&nbsp;faster.</span><br>
<span class="lineno"></span><span class="comment" id="4006405">//&nbsp;&nbsp;&nbsp;&nbspCould&nbsp;have&nbsp;a&nbsp;small&nbsp;cache.</span><br>
<span class="lineno"></span><span class="comment" id="4006434">//&nbsp;&nbsp;&nbsp;&nbspRandom&nbsp;UDP&nbsp;source&nbsp;port&nbsp;(net.Dial&nbsp;should&nbsp;do&nbsp;that&nbsp;for&nbsp;us).</span><br>
<span class="lineno"></span><span class="comment" id="4006494">//&nbsp;&nbsp;&nbsp;&nbspRandom&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="4006518">package</span>&nbsp;<span class="ident" id="4006526">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4006531">import</span>&nbsp;<span class="op" id="4006538">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4006541">&#34;errors&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4006551">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4006557">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4006570">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4006576">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4006584">&#34;time&#34;</span><br>
<span class="lineno">25</span><span class="op" id="4006591">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4006594">//&nbsp;A&nbsp;dnsConn&nbsp;represents&nbsp;a&nbsp;DNS&nbsp;transport&nbsp;endpoint.</span><br>
<span class="lineno"></span><span class="keyword" id="4006644">type</span>&nbsp;<span class="ident" id="4006649">dnsConn</span>&nbsp;<span class="keyword" id="4006657">interface</span>&nbsp;<span class="op" id="4006667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006670">Conn</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4006677">//&nbsp;readDNSResponse&nbsp;reads&nbsp;a&nbsp;DNS&nbsp;response&nbsp;message&nbsp;from&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4006739">//&nbsp;transport&nbsp;endpoint&nbsp;and&nbsp;returns&nbsp;the&nbsp;received&nbsp;DNS&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4006800">//&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006813">readDNSResponse</span><span class="op" id="4006828">(</span><span class="op" id="4006829">)</span>&nbsp;<span class="op" id="4006831">(</span><span class="op" id="4006832">*</span><span class="ident" id="4006833">dnsMsg</span><span class="op" id="4006839">,</span>&nbsp;<span class="builtintype" id="4006841">error</span><span class="op" id="4006846">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4006850">//&nbsp;writeDNSQuery&nbsp;writes&nbsp;a&nbsp;DNS&nbsp;query&nbsp;message&nbsp;to&nbsp;the&nbsp;DNS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4006906">//&nbsp;connection&nbsp;endpoint.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4006931">writeDNSQuery</span><span class="op" id="4006944">(</span><span class="op" id="4006945">*</span><span class="ident" id="4006946">dnsMsg</span><span class="op" id="4006952">)</span>&nbsp;<span class="builtintype" id="4006954">error</span><br>
<span class="lineno"></span><span class="op" id="4006960">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="4006963">func</span>&nbsp;<span class="op" id="4006968">(</span><span class="ident" id="4006969">c</span>&nbsp;<span class="op" id="4006971">*</span><span class="ident" id="4006972">UDPConn</span><span class="op" id="4006979">)</span>&nbsp;<span class="ident" id="4006981">readDNSResponse</span><span class="op" id="4006996">(</span><span class="op" id="4006997">)</span>&nbsp;<span class="op" id="4006999">(</span><span class="op" id="4007000">*</span><span class="ident" id="4007001">dnsMsg</span><span class="op" id="4007007">,</span>&nbsp;<span class="builtintype" id="4007009">error</span><span class="op" id="4007014">)</span>&nbsp;<span class="op" id="4007016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007019">b</span>&nbsp;<span class="op" id="4007021">:=</span>&nbsp;<span class="builtinfunc" id="4007024">make</span><span class="op" id="4007028">(</span><span class="op" id="4007029">[</span><span class="op" id="4007030">]</span><span class="builtintype" id="4007031">byte</span><span class="op" id="4007035">,</span>&nbsp;<span class="num" id="4007037">512</span><span class="op" id="4007040">)</span>&nbsp;<span class="comment" id="4007042">//&nbsp;see&nbsp;RFC&nbsp;1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007059">n</span><span class="op" id="4007060">,</span>&nbsp;<span class="ident" id="4007062">err</span>&nbsp;<span class="op" id="4007066">:=</span>&nbsp;<span class="ident" id="4007069">c</span><span class="op" id="4007070">.</span><span class="ident" id="4007071">Read</span><span class="op" id="4007075">(</span><span class="ident" id="4007076">b</span><span class="op" id="4007077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007080">if</span>&nbsp;<span class="ident" id="4007083">err</span>&nbsp;<span class="op" id="4007087">!=</span>&nbsp;<span class="ident" id="4007090">nil</span>&nbsp;<span class="op" id="4007094">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007098">return</span>&nbsp;<span class="ident" id="4007105">nil</span><span class="op" id="4007108">,</span>&nbsp;<span class="ident" id="4007110">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4007115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007118">msg</span>&nbsp;<span class="op" id="4007122">:=</span>&nbsp;<span class="op" id="4007125">&amp;</span><span class="ident" id="4007126">dnsMsg</span><span class="op" id="4007132">{</span><span class="op" id="4007133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007136">if</span>&nbsp;<span class="op" id="4007139">!</span><span class="ident" id="4007140">msg</span><span class="op" id="4007143">.</span><span class="ident" id="4007144">Unpack</span><span class="op" id="4007150">(</span><span class="ident" id="4007151">b</span><span class="op" id="4007152">[</span><span class="op" id="4007153">:</span><span class="ident" id="4007154">n</span><span class="op" id="4007155">]</span><span class="op" id="4007156">)</span>&nbsp;<span class="op" id="4007158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007162">return</span>&nbsp;<span class="ident" id="4007169">nil</span><span class="op" id="4007172">,</span>&nbsp;<span class="ident" id="4007174">errors</span><span class="op" id="4007180">.</span><span class="ident" id="4007181">New</span><span class="op" id="4007184">(</span><span class="string" id="4007185">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="4007215">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4007218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007221">return</span>&nbsp;<span class="ident" id="4007228">msg</span><span class="op" id="4007231">,</span>&nbsp;<span class="ident" id="4007233">nil</span><br>
<span class="lineno"></span><span class="op" id="4007237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4007240">func</span>&nbsp;<span class="op" id="4007245">(</span><span class="ident" id="4007246">c</span>&nbsp;<span class="op" id="4007248">*</span><span class="ident" id="4007249">UDPConn</span><span class="op" id="4007256">)</span>&nbsp;<span class="ident" id="4007258">writeDNSQuery</span><span class="op" id="4007271">(</span><span class="ident" id="4007272">msg</span>&nbsp;<span class="op" id="4007276">*</span><span class="ident" id="4007277">dnsMsg</span><span class="op" id="4007283">)</span>&nbsp;<span class="builtintype" id="4007285">error</span>&nbsp;<span class="op" id="4007291">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007294">b</span><span class="op" id="4007295">,</span>&nbsp;<span class="ident" id="4007297">ok</span>&nbsp;<span class="op" id="4007300">:=</span>&nbsp;<span class="ident" id="4007303">msg</span><span class="op" id="4007306">.</span><span class="ident" id="4007307">Pack</span><span class="op" id="4007311">(</span><span class="op" id="4007312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007315">if</span>&nbsp;<span class="op" id="4007318">!</span><span class="ident" id="4007319">ok</span>&nbsp;<span class="op" id="4007322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007326">return</span>&nbsp;<span class="ident" id="4007333">errors</span><span class="op" id="4007339">.</span><span class="ident" id="4007340">New</span><span class="op" id="4007343">(</span><span class="string" id="4007344">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="4007372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4007375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007378">if</span>&nbsp;<span class="ident" id="4007381">_</span><span class="op" id="4007382">,</span>&nbsp;<span class="ident" id="4007384">err</span>&nbsp;<span class="op" id="4007388">:=</span>&nbsp;<span class="ident" id="4007391">c</span><span class="op" id="4007392">.</span><span class="ident" id="4007393">Write</span><span class="op" id="4007398">(</span><span class="ident" id="4007399">b</span><span class="op" id="4007400">)</span><span class="op" id="4007401">;</span>&nbsp;<span class="ident" id="4007403">err</span>&nbsp;<span class="op" id="4007407">!=</span>&nbsp;<span class="ident" id="4007410">nil</span>&nbsp;<span class="op" id="4007414">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007418">return</span>&nbsp;<span class="ident" id="4007425">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4007430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007433">return</span>&nbsp;<span class="ident" id="4007440">nil</span><br>
<span class="lineno"></span><span class="op" id="4007444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="keyword" id="4007447">func</span>&nbsp;<span class="op" id="4007452">(</span><span class="ident" id="4007453">c</span>&nbsp;<span class="op" id="4007455">*</span><span class="ident" id="4007456">TCPConn</span><span class="op" id="4007463">)</span>&nbsp;<span class="ident" id="4007465">readDNSResponse</span><span class="op" id="4007480">(</span><span class="op" id="4007481">)</span>&nbsp;<span class="op" id="4007483">(</span><span class="op" id="4007484">*</span><span class="ident" id="4007485">dnsMsg</span><span class="op" id="4007491">,</span>&nbsp;<span class="builtintype" id="4007493">error</span><span class="op" id="4007498">)</span>&nbsp;<span class="op" id="4007500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007503">b</span>&nbsp;<span class="op" id="4007505">:=</span>&nbsp;<span class="builtinfunc" id="4007508">make</span><span class="op" id="4007512">(</span><span class="op" id="4007513">[</span><span class="op" id="4007514">]</span><span class="builtintype" id="4007515">byte</span><span class="op" id="4007519">,</span>&nbsp;<span class="num" id="4007521">1280</span><span class="op" id="4007525">)</span>&nbsp;<span class="comment" id="4007527">//&nbsp;1280&nbsp;is&nbsp;a&nbsp;reasonable&nbsp;initial&nbsp;size&nbsp;for&nbsp;IP&nbsp;over&nbsp;Ethernet,&nbsp;see&nbsp;RFC&nbsp;4035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007600">if</span>&nbsp;<span class="ident" id="4007603">_</span><span class="op" id="4007604">,</span>&nbsp;<span class="ident" id="4007606">err</span>&nbsp;<span class="op" id="4007610">:=</span>&nbsp;<span class="ident" id="4007613">io</span><span class="op" id="4007615">.</span><span class="ident" id="4007616">ReadFull</span><span class="op" id="4007624">(</span><span class="ident" id="4007625">c</span><span class="op" id="4007626">,</span>&nbsp;<span class="ident" id="4007628">b</span><span class="op" id="4007629">[</span><span class="op" id="4007630">:</span><span class="num" id="4007631">2</span><span class="op" id="4007632">]</span><span class="op" id="4007633">)</span><span class="op" id="4007634">;</span>&nbsp;<span class="ident" id="4007636">err</span>&nbsp;<span class="op" id="4007640">!=</span>&nbsp;<span class="ident" id="4007643">nil</span>&nbsp;<span class="op" id="4007647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007651">return</span>&nbsp;<span class="ident" id="4007658">nil</span><span class="op" id="4007661">,</span>&nbsp;<span class="ident" id="4007663">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4007668">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007671">l</span>&nbsp;<span class="op" id="4007673">:=</span>&nbsp;<span class="builtintype" id="4007676">int</span><span class="op" id="4007679">(</span><span class="ident" id="4007680">b</span><span class="op" id="4007681">[</span><span class="num" id="4007682">0</span><span class="op" id="4007683">]</span><span class="op" id="4007684">)</span><span class="op" id="4007685">&lt;&lt;</span><span class="num" id="4007687">8</span>&nbsp;<span class="op" id="4007689">|</span>&nbsp;<span class="builtintype" id="4007691">int</span><span class="op" id="4007694">(</span><span class="ident" id="4007695">b</span><span class="op" id="4007696">[</span><span class="num" id="4007697">1</span><span class="op" id="4007698">]</span><span class="op" id="4007699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007702">if</span>&nbsp;<span class="ident" id="4007705">l</span>&nbsp;<span class="op" id="4007707">&gt;</span>&nbsp;<span class="builtinfunc" id="4007709">len</span><span class="op" id="4007712">(</span><span class="ident" id="4007713">b</span><span class="op" id="4007714">)</span>&nbsp;<span class="op" id="4007716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007720">b</span>&nbsp;<span class="op" id="4007722">=</span>&nbsp;<span class="builtinfunc" id="4007724">make</span><span class="op" id="4007728">(</span><span class="op" id="4007729">[</span><span class="op" id="4007730">]</span><span class="builtintype" id="4007731">byte</span><span class="op" id="4007735">,</span>&nbsp;<span class="ident" id="4007737">l</span><span class="op" id="4007738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4007741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007744">n</span><span class="op" id="4007745">,</span>&nbsp;<span class="ident" id="4007747">err</span>&nbsp;<span class="op" id="4007751">:=</span>&nbsp;<span class="ident" id="4007754">io</span><span class="op" id="4007756">.</span><span class="ident" id="4007757">ReadFull</span><span class="op" id="4007765">(</span><span class="ident" id="4007766">c</span><span class="op" id="4007767">,</span>&nbsp;<span class="ident" id="4007769">b</span><span class="op" id="4007770">[</span><span class="op" id="4007771">:</span><span class="ident" id="4007772">l</span><span class="op" id="4007773">]</span><span class="op" id="4007774">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007777">if</span>&nbsp;<span class="ident" id="4007780">err</span>&nbsp;<span class="op" id="4007784">!=</span>&nbsp;<span class="ident" id="4007787">nil</span>&nbsp;<span class="op" id="4007791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007795">return</span>&nbsp;<span class="ident" id="4007802">nil</span><span class="op" id="4007805">,</span>&nbsp;<span class="ident" id="4007807">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4007812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007815">msg</span>&nbsp;<span class="op" id="4007819">:=</span>&nbsp;<span class="op" id="4007822">&amp;</span><span class="ident" id="4007823">dnsMsg</span><span class="op" id="4007829">{</span><span class="op" id="4007830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007833">if</span>&nbsp;<span class="op" id="4007836">!</span><span class="ident" id="4007837">msg</span><span class="op" id="4007840">.</span><span class="ident" id="4007841">Unpack</span><span class="op" id="4007847">(</span><span class="ident" id="4007848">b</span><span class="op" id="4007849">[</span><span class="op" id="4007850">:</span><span class="ident" id="4007851">n</span><span class="op" id="4007852">]</span><span class="op" id="4007853">)</span>&nbsp;<span class="op" id="4007855">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007859">return</span>&nbsp;<span class="ident" id="4007866">nil</span><span class="op" id="4007869">,</span>&nbsp;<span class="ident" id="4007871">errors</span><span class="op" id="4007877">.</span><span class="ident" id="4007878">New</span><span class="op" id="4007881">(</span><span class="string" id="4007882">&#34;cannot&nbsp;unmarshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="4007912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4007915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4007918">return</span>&nbsp;<span class="ident" id="4007925">msg</span><span class="op" id="4007928">,</span>&nbsp;<span class="ident" id="4007930">nil</span><br>
<span class="lineno"></span><span class="op" id="4007934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="keyword" id="4007937">func</span>&nbsp;<span class="op" id="4007942">(</span><span class="ident" id="4007943">c</span>&nbsp;<span class="op" id="4007945">*</span><span class="ident" id="4007946">TCPConn</span><span class="op" id="4007953">)</span>&nbsp;<span class="ident" id="4007955">writeDNSQuery</span><span class="op" id="4007968">(</span><span class="ident" id="4007969">msg</span>&nbsp;<span class="op" id="4007973">*</span><span class="ident" id="4007974">dnsMsg</span><span class="op" id="4007980">)</span>&nbsp;<span class="builtintype" id="4007982">error</span>&nbsp;<span class="op" id="4007988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4007991">b</span><span class="op" id="4007992">,</span>&nbsp;<span class="ident" id="4007994">ok</span>&nbsp;<span class="op" id="4007997">:=</span>&nbsp;<span class="ident" id="4008000">msg</span><span class="op" id="4008003">.</span><span class="ident" id="4008004">Pack</span><span class="op" id="4008008">(</span><span class="op" id="4008009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008012">if</span>&nbsp;<span class="op" id="4008015">!</span><span class="ident" id="4008016">ok</span>&nbsp;<span class="op" id="4008019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008023">return</span>&nbsp;<span class="ident" id="4008030">errors</span><span class="op" id="4008036">.</span><span class="ident" id="4008037">New</span><span class="op" id="4008040">(</span><span class="string" id="4008041">&#34;cannot&nbsp;marshal&nbsp;DNS&nbsp;message&#34;</span><span class="op" id="4008069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4008072">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4008075">l</span>&nbsp;<span class="op" id="4008077">:=</span>&nbsp;<span class="builtintype" id="4008080">uint16</span><span class="op" id="4008086">(</span><span class="builtinfunc" id="4008087">len</span><span class="op" id="4008090">(</span><span class="ident" id="4008091">b</span><span class="op" id="4008092">)</span><span class="op" id="4008093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4008096">b</span>&nbsp;<span class="op" id="4008098">=</span>&nbsp;<span class="builtinfunc" id="4008100">append</span><span class="op" id="4008106">(</span><span class="op" id="4008107">[</span><span class="op" id="4008108">]</span><span class="builtintype" id="4008109">byte</span><span class="op" id="4008113">{</span><span class="builtintype" id="4008114">byte</span><span class="op" id="4008118">(</span><span class="ident" id="4008119">l</span>&nbsp;<span class="op" id="4008121">&gt;&gt;</span>&nbsp;<span class="num" id="4008124">8</span><span class="op" id="4008125">)</span><span class="op" id="4008126">,</span>&nbsp;<span class="builtintype" id="4008128">byte</span><span class="op" id="4008132">(</span><span class="ident" id="4008133">l</span><span class="op" id="4008134">)</span><span class="op" id="4008135">}</span><span class="op" id="4008136">,</span>&nbsp;<span class="ident" id="4008138">b</span><span class="op" id="4008139">...</span><span class="op" id="4008142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008145">if</span>&nbsp;<span class="ident" id="4008148">_</span><span class="op" id="4008149">,</span>&nbsp;<span class="ident" id="4008151">err</span>&nbsp;<span class="op" id="4008155">:=</span>&nbsp;<span class="ident" id="4008158">c</span><span class="op" id="4008159">.</span><span class="ident" id="4008160">Write</span><span class="op" id="4008165">(</span><span class="ident" id="4008166">b</span><span class="op" id="4008167">)</span><span class="op" id="4008168">;</span>&nbsp;<span class="ident" id="4008170">err</span>&nbsp;<span class="op" id="4008174">!=</span>&nbsp;<span class="ident" id="4008177">nil</span>&nbsp;<span class="op" id="4008181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008185">return</span>&nbsp;<span class="ident" id="4008192">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4008197">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008200">return</span>&nbsp;<span class="ident" id="4008207">nil</span><br>
<span class="lineno"></span><span class="op" id="4008211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4008214">func</span>&nbsp;<span class="op" id="4008219">(</span><span class="ident" id="4008220">d</span>&nbsp;<span class="op" id="4008222">*</span><span class="ident" id="4008223">Dialer</span><span class="op" id="4008229">)</span>&nbsp;<span class="ident" id="4008231">dialDNS</span><span class="op" id="4008238">(</span><span class="ident" id="4008239">network</span><span class="op" id="4008246">,</span>&nbsp;<span class="ident" id="4008248">server</span>&nbsp;<span class="builtintype" id="4008255">string</span><span class="op" id="4008261">)</span>&nbsp;<span class="op" id="4008263">(</span><span class="ident" id="4008264">dnsConn</span><span class="op" id="4008271">,</span>&nbsp;<span class="builtintype" id="4008273">error</span><span class="op" id="4008278">)</span>&nbsp;<span class="op" id="4008280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008283">switch</span>&nbsp;<span class="ident" id="4008290">network</span>&nbsp;<span class="op" id="4008298">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008301">case</span>&nbsp;<span class="string" id="4008306">&#34;tcp&#34;</span><span class="op" id="4008311">,</span>&nbsp;<span class="string" id="4008313">&#34;tcp4&#34;</span><span class="op" id="4008319">,</span>&nbsp;<span class="string" id="4008321">&#34;tcp6&#34;</span><span class="op" id="4008327">,</span>&nbsp;<span class="string" id="4008329">&#34;udp&#34;</span><span class="op" id="4008334">,</span>&nbsp;<span class="string" id="4008336">&#34;udp4&#34;</span><span class="op" id="4008342">,</span>&nbsp;<span class="string" id="4008344">&#34;udp6&#34;</span><span class="op" id="4008350">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008353">default</span><span class="op" id="4008360">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008364">return</span>&nbsp;<span class="ident" id="4008371">nil</span><span class="op" id="4008374">,</span>&nbsp;<span class="ident" id="4008376">UnknownNetworkError</span><span class="op" id="4008395">(</span><span class="ident" id="4008396">network</span><span class="op" id="4008403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4008406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4008409">//&nbsp;Calling&nbsp;Dial&nbsp;here&nbsp;is&nbsp;scary&nbsp;--&nbsp;we&nbsp;have&nbsp;to&nbsp;be&nbsp;sure&nbsp;not&nbsp;to</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4008469">//&nbsp;dial&nbsp;a&nbsp;name&nbsp;that&nbsp;will&nbsp;require&nbsp;a&nbsp;DNS&nbsp;lookup,&nbsp;or&nbsp;Dial&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4008530">//&nbsp;call&nbsp;back&nbsp;here&nbsp;to&nbsp;translate&nbsp;it.&nbsp;The&nbsp;DNS&nbsp;config&nbsp;parser&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4008592">//&nbsp;already&nbsp;checked&nbsp;that&nbsp;all&nbsp;the&nbsp;cfg.servers[i]&nbsp;are&nbsp;IP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4008647">//&nbsp;addresses,&nbsp;which&nbsp;Dial&nbsp;will&nbsp;use&nbsp;without&nbsp;a&nbsp;DNS&nbsp;lookup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4008704">c</span><span class="op" id="4008705">,</span>&nbsp;<span class="ident" id="4008707">err</span>&nbsp;<span class="op" id="4008711">:=</span>&nbsp;<span class="ident" id="4008714">d</span><span class="op" id="4008715">.</span><span class="ident" id="4008716">Dial</span><span class="op" id="4008720">(</span><span class="ident" id="4008721">network</span><span class="op" id="4008728">,</span>&nbsp;<span class="ident" id="4008730">server</span><span class="op" id="4008736">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008739">if</span>&nbsp;<span class="ident" id="4008742">err</span>&nbsp;<span class="op" id="4008746">!=</span>&nbsp;<span class="ident" id="4008749">nil</span>&nbsp;<span class="op" id="4008753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008757">return</span>&nbsp;<span class="ident" id="4008764">nil</span><span class="op" id="4008767">,</span>&nbsp;<span class="ident" id="4008769">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4008774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008777">switch</span>&nbsp;<span class="ident" id="4008784">network</span>&nbsp;<span class="op" id="4008792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008795">case</span>&nbsp;<span class="string" id="4008800">&#34;tcp&#34;</span><span class="op" id="4008805">,</span>&nbsp;<span class="string" id="4008807">&#34;tcp4&#34;</span><span class="op" id="4008813">,</span>&nbsp;<span class="string" id="4008815">&#34;tcp6&#34;</span><span class="op" id="4008821">:</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008825">return</span>&nbsp;<span class="ident" id="4008832">c</span><span class="op" id="4008833">.</span><span class="op" id="4008834">(</span><span class="op" id="4008835">*</span><span class="ident" id="4008836">TCPConn</span><span class="op" id="4008843">)</span><span class="op" id="4008844">,</span>&nbsp;<span class="ident" id="4008846">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008851">case</span>&nbsp;<span class="string" id="4008856">&#34;udp&#34;</span><span class="op" id="4008861">,</span>&nbsp;<span class="string" id="4008863">&#34;udp4&#34;</span><span class="op" id="4008869">,</span>&nbsp;<span class="string" id="4008871">&#34;udp6&#34;</span><span class="op" id="4008877">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4008881">return</span>&nbsp;<span class="ident" id="4008888">c</span><span class="op" id="4008889">.</span><span class="op" id="4008890">(</span><span class="op" id="4008891">*</span><span class="ident" id="4008892">UDPConn</span><span class="op" id="4008899">)</span><span class="op" id="4008900">,</span>&nbsp;<span class="ident" id="4008902">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4008907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4008910">panic</span><span class="op" id="4008915">(</span><span class="string" id="4008916">&#34;unreachable&#34;</span><span class="op" id="4008929">)</span><br>
<span class="lineno">120</span><span class="op" id="4008931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4008934">//&nbsp;exchange&nbsp;sends&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;connection&nbsp;and&nbsp;hopes&nbsp;for&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="4009004">func</span>&nbsp;<span class="ident" id="4009009">exchange</span><span class="op" id="4009017">(</span><span class="ident" id="4009018">server</span><span class="op" id="4009024">,</span>&nbsp;<span class="ident" id="4009026">name</span>&nbsp;<span class="builtintype" id="4009031">string</span><span class="op" id="4009037">,</span>&nbsp;<span class="ident" id="4009039">qtype</span>&nbsp;<span class="builtintype" id="4009045">uint16</span><span class="op" id="4009051">,</span>&nbsp;<span class="ident" id="4009053">timeout</span>&nbsp;<span class="ident" id="4009061">time</span><span class="op" id="4009065">.</span><span class="ident" id="4009066">Duration</span><span class="op" id="4009074">)</span>&nbsp;<span class="op" id="4009076">(</span><span class="op" id="4009077">*</span><span class="ident" id="4009078">dnsMsg</span><span class="op" id="4009084">,</span>&nbsp;<span class="builtintype" id="4009086">error</span><span class="op" id="4009091">)</span>&nbsp;<span class="op" id="4009093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009096">d</span>&nbsp;<span class="op" id="4009098">:=</span>&nbsp;<span class="ident" id="4009101">Dialer</span><span class="op" id="4009107">{</span><span class="ident" id="4009108">Timeout</span><span class="op" id="4009115">:</span>&nbsp;<span class="ident" id="4009117">timeout</span><span class="op" id="4009124">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009127">out</span>&nbsp;<span class="op" id="4009131">:=</span>&nbsp;<span class="ident" id="4009134">dnsMsg</span><span class="op" id="4009140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009144">dnsMsgHdr</span><span class="op" id="4009153">:</span>&nbsp;<span class="ident" id="4009155">dnsMsgHdr</span><span class="op" id="4009164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009169">recursion_desired</span><span class="op" id="4009186">:</span>&nbsp;<span class="builtintype" id="4009188">true</span><span class="op" id="4009192">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009196">}</span><span class="op" id="4009197">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009201">question</span><span class="op" id="4009209">:</span>&nbsp;<span class="op" id="4009211">[</span><span class="op" id="4009212">]</span><span class="ident" id="4009213">dnsQuestion</span><span class="op" id="4009224">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009229">{</span><span class="ident" id="4009230">name</span><span class="op" id="4009234">,</span>&nbsp;<span class="ident" id="4009236">qtype</span><span class="op" id="4009241">,</span>&nbsp;<span class="ident" id="4009243">dnsClassINET</span><span class="op" id="4009255">}</span><span class="op" id="4009256">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009260">}</span><span class="op" id="4009261">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009267">for</span>&nbsp;<span class="ident" id="4009271">_</span><span class="op" id="4009272">,</span>&nbsp;<span class="ident" id="4009274">network</span>&nbsp;<span class="op" id="4009282">:=</span>&nbsp;<span class="keyword" id="4009285">range</span>&nbsp;<span class="op" id="4009291">[</span><span class="op" id="4009292">]</span><span class="builtintype" id="4009293">string</span><span class="op" id="4009299">{</span><span class="string" id="4009300">&#34;udp&#34;</span><span class="op" id="4009305">,</span>&nbsp;<span class="string" id="4009307">&#34;tcp&#34;</span><span class="op" id="4009312">}</span>&nbsp;<span class="op" id="4009314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009318">c</span><span class="op" id="4009319">,</span>&nbsp;<span class="ident" id="4009321">err</span>&nbsp;<span class="op" id="4009325">:=</span>&nbsp;<span class="ident" id="4009328">d</span><span class="op" id="4009329">.</span><span class="ident" id="4009330">dialDNS</span><span class="op" id="4009337">(</span><span class="ident" id="4009338">network</span><span class="op" id="4009345">,</span>&nbsp;<span class="ident" id="4009347">server</span><span class="op" id="4009353">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009357">if</span>&nbsp;<span class="ident" id="4009360">err</span>&nbsp;<span class="op" id="4009364">!=</span>&nbsp;<span class="ident" id="4009367">nil</span>&nbsp;<span class="op" id="4009371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009376">return</span>&nbsp;<span class="ident" id="4009383">nil</span><span class="op" id="4009386">,</span>&nbsp;<span class="ident" id="4009388">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009394">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009398">defer</span>&nbsp;<span class="ident" id="4009404">c</span><span class="op" id="4009405">.</span><span class="ident" id="4009406">Close</span><span class="op" id="4009411">(</span><span class="op" id="4009412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009416">if</span>&nbsp;<span class="ident" id="4009419">timeout</span>&nbsp;<span class="op" id="4009427">&gt;</span>&nbsp;<span class="num" id="4009429">0</span>&nbsp;<span class="op" id="4009431">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009436">c</span><span class="op" id="4009437">.</span><span class="ident" id="4009438">SetDeadline</span><span class="op" id="4009449">(</span><span class="ident" id="4009450">time</span><span class="op" id="4009454">.</span><span class="ident" id="4009455">Now</span><span class="op" id="4009458">(</span><span class="op" id="4009459">)</span><span class="op" id="4009460">.</span><span class="ident" id="4009461">Add</span><span class="op" id="4009464">(</span><span class="ident" id="4009465">timeout</span><span class="op" id="4009472">)</span><span class="op" id="4009473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009481">out</span><span class="op" id="4009484">.</span><span class="ident" id="4009485">id</span>&nbsp;<span class="op" id="4009488">=</span>&nbsp;<span class="builtintype" id="4009490">uint16</span><span class="op" id="4009496">(</span><span class="ident" id="4009497">rand</span><span class="op" id="4009501">.</span><span class="ident" id="4009502">Int</span><span class="op" id="4009505">(</span><span class="op" id="4009506">)</span><span class="op" id="4009507">)</span>&nbsp;<span class="op" id="4009509">^</span>&nbsp;<span class="builtintype" id="4009511">uint16</span><span class="op" id="4009517">(</span><span class="ident" id="4009518">time</span><span class="op" id="4009522">.</span><span class="ident" id="4009523">Now</span><span class="op" id="4009526">(</span><span class="op" id="4009527">)</span><span class="op" id="4009528">.</span><span class="ident" id="4009529">UnixNano</span><span class="op" id="4009537">(</span><span class="op" id="4009538">)</span><span class="op" id="4009539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009543">if</span>&nbsp;<span class="ident" id="4009546">err</span>&nbsp;<span class="op" id="4009550">:=</span>&nbsp;<span class="ident" id="4009553">c</span><span class="op" id="4009554">.</span><span class="ident" id="4009555">writeDNSQuery</span><span class="op" id="4009568">(</span><span class="op" id="4009569">&amp;</span><span class="ident" id="4009570">out</span><span class="op" id="4009573">)</span><span class="op" id="4009574">;</span>&nbsp;<span class="ident" id="4009576">err</span>&nbsp;<span class="op" id="4009580">!=</span>&nbsp;<span class="ident" id="4009583">nil</span>&nbsp;<span class="op" id="4009587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009592">return</span>&nbsp;<span class="ident" id="4009599">nil</span><span class="op" id="4009602">,</span>&nbsp;<span class="ident" id="4009604">err</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4009614">in</span><span class="op" id="4009616">,</span>&nbsp;<span class="ident" id="4009618">err</span>&nbsp;<span class="op" id="4009622">:=</span>&nbsp;<span class="ident" id="4009625">c</span><span class="op" id="4009626">.</span><span class="ident" id="4009627">readDNSResponse</span><span class="op" id="4009642">(</span><span class="op" id="4009643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009647">if</span>&nbsp;<span class="ident" id="4009650">err</span>&nbsp;<span class="op" id="4009654">!=</span>&nbsp;<span class="ident" id="4009657">nil</span>&nbsp;<span class="op" id="4009661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009666">return</span>&nbsp;<span class="ident" id="4009673">nil</span><span class="op" id="4009676">,</span>&nbsp;<span class="ident" id="4009678">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009684">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009688">if</span>&nbsp;<span class="ident" id="4009691">in</span><span class="op" id="4009693">.</span><span class="ident" id="4009694">id</span>&nbsp;<span class="op" id="4009697">!=</span>&nbsp;<span class="ident" id="4009700">out</span><span class="op" id="4009703">.</span><span class="ident" id="4009704">id</span>&nbsp;<span class="op" id="4009707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009712">return</span>&nbsp;<span class="ident" id="4009719">nil</span><span class="op" id="4009722">,</span>&nbsp;<span class="ident" id="4009724">errors</span><span class="op" id="4009730">.</span><span class="ident" id="4009731">New</span><span class="op" id="4009734">(</span><span class="string" id="4009735">&#34;DNS&nbsp;message&nbsp;ID&nbsp;mismatch&#34;</span><span class="op" id="4009760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009768">if</span>&nbsp;<span class="ident" id="4009771">in</span><span class="op" id="4009773">.</span><span class="ident" id="4009774">truncated</span>&nbsp;<span class="op" id="4009784">{</span>&nbsp;<span class="comment" id="4009786">//&nbsp;see&nbsp;RFC&nbsp;5966</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009805">continue</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009820">return</span>&nbsp;<span class="ident" id="4009827">in</span><span class="op" id="4009829">,</span>&nbsp;<span class="ident" id="4009831">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4009836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4009839">return</span>&nbsp;<span class="ident" id="4009846">nil</span><span class="op" id="4009849">,</span>&nbsp;<span class="ident" id="4009851">errors</span><span class="op" id="4009857">.</span><span class="ident" id="4009858">New</span><span class="op" id="4009861">(</span><span class="string" id="4009862">&#34;no&nbsp;answer&nbsp;from&nbsp;DNS&nbsp;server&#34;</span><span class="op" id="4009889">)</span><br>
<span class="lineno"></span><span class="op" id="4009891">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="4009894">//&nbsp;Do&nbsp;a&nbsp;lookup&nbsp;for&nbsp;a&nbsp;single&nbsp;name,&nbsp;which&nbsp;must&nbsp;be&nbsp;rooted</span><br>
<span class="lineno"></span><span class="comment" id="4009949">//&nbsp;(otherwise&nbsp;answer&nbsp;will&nbsp;not&nbsp;find&nbsp;the&nbsp;answers).</span><br>
<span class="lineno"></span><span class="keyword" id="4009998">func</span>&nbsp;<span class="ident" id="4010003">tryOneName</span><span class="op" id="4010013">(</span><span class="ident" id="4010014">cfg</span>&nbsp;<span class="op" id="4010018">*</span><span class="ident" id="4010019">dnsConfig</span><span class="op" id="4010028">,</span>&nbsp;<span class="ident" id="4010030">name</span>&nbsp;<span class="builtintype" id="4010035">string</span><span class="op" id="4010041">,</span>&nbsp;<span class="ident" id="4010043">qtype</span>&nbsp;<span class="builtintype" id="4010049">uint16</span><span class="op" id="4010055">)</span>&nbsp;<span class="op" id="4010057">(</span><span class="builtintype" id="4010058">string</span><span class="op" id="4010064">,</span>&nbsp;<span class="op" id="4010066">[</span><span class="op" id="4010067">]</span><span class="ident" id="4010068">dnsRR</span><span class="op" id="4010073">,</span>&nbsp;<span class="builtintype" id="4010075">error</span><span class="op" id="4010080">)</span>&nbsp;<span class="op" id="4010082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010085">if</span>&nbsp;<span class="builtinfunc" id="4010088">len</span><span class="op" id="4010091">(</span><span class="ident" id="4010092">cfg</span><span class="op" id="4010095">.</span><span class="ident" id="4010096">servers</span><span class="op" id="4010103">)</span>&nbsp;<span class="op" id="4010105">==</span>&nbsp;<span class="num" id="4010108">0</span>&nbsp;<span class="op" id="4010110">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010114">return</span>&nbsp;<span class="string" id="4010121">&#34;&#34;</span><span class="op" id="4010123">,</span>&nbsp;<span class="ident" id="4010125">nil</span><span class="op" id="4010128">,</span>&nbsp;<span class="op" id="4010130">&amp;</span><span class="ident" id="4010131">DNSError</span><span class="op" id="4010139">{</span><span class="ident" id="4010140">Err</span><span class="op" id="4010143">:</span>&nbsp;<span class="string" id="4010145">&#34;no&nbsp;DNS&nbsp;servers&#34;</span><span class="op" id="4010161">,</span>&nbsp;<span class="ident" id="4010163">Name</span><span class="op" id="4010167">:</span>&nbsp;<span class="ident" id="4010169">name</span><span class="op" id="4010173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4010176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010179">if</span>&nbsp;<span class="builtinfunc" id="4010182">len</span><span class="op" id="4010185">(</span><span class="ident" id="4010186">name</span><span class="op" id="4010190">)</span>&nbsp;<span class="op" id="4010192">&gt;=</span>&nbsp;<span class="num" id="4010195">256</span>&nbsp;<span class="op" id="4010199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010203">return</span>&nbsp;<span class="string" id="4010210">&#34;&#34;</span><span class="op" id="4010212">,</span>&nbsp;<span class="ident" id="4010214">nil</span><span class="op" id="4010217">,</span>&nbsp;<span class="op" id="4010219">&amp;</span><span class="ident" id="4010220">DNSError</span><span class="op" id="4010228">{</span><span class="ident" id="4010229">Err</span><span class="op" id="4010232">:</span>&nbsp;<span class="string" id="4010234">&#34;DNS&nbsp;name&nbsp;too&nbsp;long&#34;</span><span class="op" id="4010253">,</span>&nbsp;<span class="ident" id="4010255">Name</span><span class="op" id="4010259">:</span>&nbsp;<span class="ident" id="4010261">name</span><span class="op" id="4010265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4010268">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4010271">timeout</span>&nbsp;<span class="op" id="4010279">:=</span>&nbsp;<span class="ident" id="4010282">time</span><span class="op" id="4010286">.</span><span class="ident" id="4010287">Duration</span><span class="op" id="4010295">(</span><span class="ident" id="4010296">cfg</span><span class="op" id="4010299">.</span><span class="ident" id="4010300">timeout</span><span class="op" id="4010307">)</span>&nbsp;<span class="op" id="4010309">*</span>&nbsp;<span class="ident" id="4010311">time</span><span class="op" id="4010315">.</span><span class="ident" id="4010316">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010324">var</span>&nbsp;<span class="ident" id="4010328">lastErr</span>&nbsp;<span class="builtintype" id="4010336">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010343">for</span>&nbsp;<span class="ident" id="4010347">i</span>&nbsp;<span class="op" id="4010349">:=</span>&nbsp;<span class="num" id="4010352">0</span><span class="op" id="4010353">;</span>&nbsp;<span class="ident" id="4010355">i</span>&nbsp;<span class="op" id="4010357">&lt;</span>&nbsp;<span class="ident" id="4010359">cfg</span><span class="op" id="4010362">.</span><span class="ident" id="4010363">attempts</span><span class="op" id="4010371">;</span>&nbsp;<span class="ident" id="4010373">i</span><span class="op" id="4010374">++</span>&nbsp;<span class="op" id="4010377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010381">for</span>&nbsp;<span class="ident" id="4010385">_</span><span class="op" id="4010386">,</span>&nbsp;<span class="ident" id="4010388">server</span>&nbsp;<span class="op" id="4010395">:=</span>&nbsp;<span class="keyword" id="4010398">range</span>&nbsp;<span class="ident" id="4010404">cfg</span><span class="op" id="4010407">.</span><span class="ident" id="4010408">servers</span>&nbsp;<span class="op" id="4010416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4010421">server</span>&nbsp;<span class="op" id="4010428">=</span>&nbsp;<span class="ident" id="4010430">JoinHostPort</span><span class="op" id="4010442">(</span><span class="ident" id="4010443">server</span><span class="op" id="4010449">,</span>&nbsp;<span class="string" id="4010451">&#34;53&#34;</span><span class="op" id="4010455">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4010460">msg</span><span class="op" id="4010463">,</span>&nbsp;<span class="ident" id="4010465">err</span>&nbsp;<span class="op" id="4010469">:=</span>&nbsp;<span class="ident" id="4010472">exchange</span><span class="op" id="4010480">(</span><span class="ident" id="4010481">server</span><span class="op" id="4010487">,</span>&nbsp;<span class="ident" id="4010489">name</span><span class="op" id="4010493">,</span>&nbsp;<span class="ident" id="4010495">qtype</span><span class="op" id="4010500">,</span>&nbsp;<span class="ident" id="4010502">timeout</span><span class="op" id="4010509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010514">if</span>&nbsp;<span class="ident" id="4010517">err</span>&nbsp;<span class="op" id="4010521">!=</span>&nbsp;<span class="ident" id="4010524">nil</span>&nbsp;<span class="op" id="4010528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4010534">lastErr</span>&nbsp;<span class="op" id="4010542">=</span>&nbsp;<span class="op" id="4010544">&amp;</span><span class="ident" id="4010545">DNSError</span><span class="op" id="4010553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4010560">Err</span><span class="op" id="4010563">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4010568">err</span><span class="op" id="4010571">.</span><span class="ident" id="4010572">Error</span><span class="op" id="4010577">(</span><span class="op" id="4010578">)</span><span class="op" id="4010579">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4010586">Name</span><span class="op" id="4010590">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4010594">name</span><span class="op" id="4010598">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4010605">Server</span><span class="op" id="4010611">:</span>&nbsp;<span class="ident" id="4010613">server</span><span class="op" id="4010619">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4010625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010631">if</span>&nbsp;<span class="ident" id="4010634">nerr</span><span class="op" id="4010638">,</span>&nbsp;<span class="ident" id="4010640">ok</span>&nbsp;<span class="op" id="4010643">:=</span>&nbsp;<span class="ident" id="4010646">err</span><span class="op" id="4010649">.</span><span class="op" id="4010650">(</span><span class="ident" id="4010651">Error</span><span class="op" id="4010656">)</span><span class="op" id="4010657">;</span>&nbsp;<span class="ident" id="4010659">ok</span>&nbsp;<span class="op" id="4010662">&amp;&amp;</span>&nbsp;<span class="ident" id="4010665">nerr</span><span class="op" id="4010669">.</span><span class="ident" id="4010670">Timeout</span><span class="op" id="4010677">(</span><span class="op" id="4010678">)</span>&nbsp;<span class="op" id="4010680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4010687">lastErr</span><span class="op" id="4010694">.</span><span class="op" id="4010695">(</span><span class="op" id="4010696">*</span><span class="ident" id="4010697">DNSError</span><span class="op" id="4010705">)</span><span class="op" id="4010706">.</span><span class="ident" id="4010707">IsTimeout</span>&nbsp;<span class="op" id="4010717">=</span>&nbsp;<span class="builtintype" id="4010719">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4010728">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010734">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4010746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4010751">cname</span><span class="op" id="4010756">,</span>&nbsp;<span class="ident" id="4010758">addrs</span><span class="op" id="4010763">,</span>&nbsp;<span class="ident" id="4010765">err</span>&nbsp;<span class="op" id="4010769">:=</span>&nbsp;<span class="ident" id="4010772">answer</span><span class="op" id="4010778">(</span><span class="ident" id="4010779">name</span><span class="op" id="4010783">,</span>&nbsp;<span class="ident" id="4010785">server</span><span class="op" id="4010791">,</span>&nbsp;<span class="ident" id="4010793">msg</span><span class="op" id="4010796">,</span>&nbsp;<span class="ident" id="4010798">qtype</span><span class="op" id="4010803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010808">if</span>&nbsp;<span class="ident" id="4010811">err</span>&nbsp;<span class="op" id="4010815">==</span>&nbsp;<span class="ident" id="4010818">nil</span>&nbsp;<span class="op" id="4010822">||</span>&nbsp;<span class="ident" id="4010825">err</span><span class="op" id="4010828">.</span><span class="op" id="4010829">(</span><span class="op" id="4010830">*</span><span class="ident" id="4010831">DNSError</span><span class="op" id="4010839">)</span><span class="op" id="4010840">.</span><span class="ident" id="4010841">Err</span>&nbsp;<span class="op" id="4010845">==</span>&nbsp;<span class="ident" id="4010848">noSuchHost</span>&nbsp;<span class="op" id="4010859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010865">return</span>&nbsp;<span class="ident" id="4010872">cname</span><span class="op" id="4010877">,</span>&nbsp;<span class="ident" id="4010879">addrs</span><span class="op" id="4010884">,</span>&nbsp;<span class="ident" id="4010886">err</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4010893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4010898">lastErr</span>&nbsp;<span class="op" id="4010906">=</span>&nbsp;<span class="ident" id="4010908">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4010914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4010917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4010920">return</span>&nbsp;<span class="string" id="4010927">&#34;&#34;</span><span class="op" id="4010929">,</span>&nbsp;<span class="ident" id="4010931">nil</span><span class="op" id="4010934">,</span>&nbsp;<span class="ident" id="4010936">lastErr</span><br>
<span class="lineno">195</span><span class="op" id="4010944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4010947">func</span>&nbsp;<span class="ident" id="4010952">convertRR_A</span><span class="op" id="4010963">(</span><span class="ident" id="4010964">records</span>&nbsp;<span class="op" id="4010972">[</span><span class="op" id="4010973">]</span><span class="ident" id="4010974">dnsRR</span><span class="op" id="4010979">)</span>&nbsp;<span class="op" id="4010981">[</span><span class="op" id="4010982">]</span><span class="ident" id="4010983">IP</span>&nbsp;<span class="op" id="4010986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4010989">addrs</span>&nbsp;<span class="op" id="4010995">:=</span>&nbsp;<span class="builtinfunc" id="4010998">make</span><span class="op" id="4011002">(</span><span class="op" id="4011003">[</span><span class="op" id="4011004">]</span><span class="ident" id="4011005">IP</span><span class="op" id="4011007">,</span>&nbsp;<span class="builtinfunc" id="4011009">len</span><span class="op" id="4011012">(</span><span class="ident" id="4011013">records</span><span class="op" id="4011020">)</span><span class="op" id="4011021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4011024">for</span>&nbsp;<span class="ident" id="4011028">i</span><span class="op" id="4011029">,</span>&nbsp;<span class="ident" id="4011031">rr</span>&nbsp;<span class="op" id="4011034">:=</span>&nbsp;<span class="keyword" id="4011037">range</span>&nbsp;<span class="ident" id="4011043">records</span>&nbsp;<span class="op" id="4011051">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4011055">a</span>&nbsp;<span class="op" id="4011057">:=</span>&nbsp;<span class="ident" id="4011060">rr</span><span class="op" id="4011062">.</span><span class="op" id="4011063">(</span><span class="op" id="4011064">*</span><span class="ident" id="4011065">dnsRR_A</span><span class="op" id="4011072">)</span><span class="op" id="4011073">.</span><span class="ident" id="4011074">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4011078">addrs</span><span class="op" id="4011083">[</span><span class="ident" id="4011084">i</span><span class="op" id="4011085">]</span>&nbsp;<span class="op" id="4011087">=</span>&nbsp;<span class="ident" id="4011089">IPv4</span><span class="op" id="4011093">(</span><span class="builtintype" id="4011094">byte</span><span class="op" id="4011098">(</span><span class="ident" id="4011099">a</span><span class="op" id="4011100">&gt;&gt;</span><span class="num" id="4011102">24</span><span class="op" id="4011104">)</span><span class="op" id="4011105">,</span>&nbsp;<span class="builtintype" id="4011107">byte</span><span class="op" id="4011111">(</span><span class="ident" id="4011112">a</span><span class="op" id="4011113">&gt;&gt;</span><span class="num" id="4011115">16</span><span class="op" id="4011117">)</span><span class="op" id="4011118">,</span>&nbsp;<span class="builtintype" id="4011120">byte</span><span class="op" id="4011124">(</span><span class="ident" id="4011125">a</span><span class="op" id="4011126">&gt;&gt;</span><span class="num" id="4011128">8</span><span class="op" id="4011129">)</span><span class="op" id="4011130">,</span>&nbsp;<span class="builtintype" id="4011132">byte</span><span class="op" id="4011136">(</span><span class="ident" id="4011137">a</span><span class="op" id="4011138">)</span><span class="op" id="4011139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4011142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4011145">return</span>&nbsp;<span class="ident" id="4011152">addrs</span><br>
<span class="lineno"></span><span class="op" id="4011158">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="4011161">func</span>&nbsp;<span class="ident" id="4011166">convertRR_AAAA</span><span class="op" id="4011180">(</span><span class="ident" id="4011181">records</span>&nbsp;<span class="op" id="4011189">[</span><span class="op" id="4011190">]</span><span class="ident" id="4011191">dnsRR</span><span class="op" id="4011196">)</span>&nbsp;<span class="op" id="4011198">[</span><span class="op" id="4011199">]</span><span class="ident" id="4011200">IP</span>&nbsp;<span class="op" id="4011203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4011206">addrs</span>&nbsp;<span class="op" id="4011212">:=</span>&nbsp;<span class="builtinfunc" id="4011215">make</span><span class="op" id="4011219">(</span><span class="op" id="4011220">[</span><span class="op" id="4011221">]</span><span class="ident" id="4011222">IP</span><span class="op" id="4011224">,</span>&nbsp;<span class="builtinfunc" id="4011226">len</span><span class="op" id="4011229">(</span><span class="ident" id="4011230">records</span><span class="op" id="4011237">)</span><span class="op" id="4011238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4011241">for</span>&nbsp;<span class="ident" id="4011245">i</span><span class="op" id="4011246">,</span>&nbsp;<span class="ident" id="4011248">rr</span>&nbsp;<span class="op" id="4011251">:=</span>&nbsp;<span class="keyword" id="4011254">range</span>&nbsp;<span class="ident" id="4011260">records</span>&nbsp;<span class="op" id="4011268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4011272">a</span>&nbsp;<span class="op" id="4011274">:=</span>&nbsp;<span class="builtinfunc" id="4011277">make</span><span class="op" id="4011281">(</span><span class="ident" id="4011282">IP</span><span class="op" id="4011284">,</span>&nbsp;<span class="ident" id="4011286">IPv6len</span><span class="op" id="4011293">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4011297">copy</span><span class="op" id="4011301">(</span><span class="ident" id="4011302">a</span><span class="op" id="4011303">,</span>&nbsp;<span class="ident" id="4011305">rr</span><span class="op" id="4011307">.</span><span class="op" id="4011308">(</span><span class="op" id="4011309">*</span><span class="ident" id="4011310">dnsRR_AAAA</span><span class="op" id="4011320">)</span><span class="op" id="4011321">.</span><span class="ident" id="4011322">AAAA</span><span class="op" id="4011326">[</span><span class="op" id="4011327">:</span><span class="op" id="4011328">]</span><span class="op" id="4011329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4011333">addrs</span><span class="op" id="4011338">[</span><span class="ident" id="4011339">i</span><span class="op" id="4011340">]</span>&nbsp;<span class="op" id="4011342">=</span>&nbsp;<span class="ident" id="4011344">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4011347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4011350">return</span>&nbsp;<span class="ident" id="4011357">addrs</span><br>
<span class="lineno"></span><span class="op" id="4011363">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="4011366">var</span>&nbsp;<span class="ident" id="4011370">cfg</span>&nbsp;<span class="keyword" id="4011374">struct</span>&nbsp;<span class="op" id="4011381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4011384">ch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4011394">chan</span>&nbsp;<span class="keyword" id="4011399">struct</span><span class="op" id="4011405">{</span><span class="op" id="4011406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4011409">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4011419">sync</span><span class="op" id="4011423">.</span><span class="ident" id="4011424">RWMutex</span>&nbsp;<span class="comment" id="4011432">//&nbsp;protects&nbsp;dnsConfig&nbsp;and&nbsp;dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4011466">dnsConfig</span>&nbsp;<span class="op" id="4011476">*</span><span class="ident" id="4011477">dnsConfig</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4011488">dnserr</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4011498">error</span><br>
<span class="lineno"></span><span class="op" id="4011504">}</span><br>
<span class="lineno"></span><span class="keyword" id="4011506">var</span>&nbsp;<span class="ident" id="4011510">onceLoadConfig</span>&nbsp;<span class="ident" id="4011525">sync</span><span class="op" id="4011529">.</span><span class="ident" id="4011530">Once</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4011536">//&nbsp;Assume&nbsp;dns&nbsp;config&nbsp;file&nbsp;is&nbsp;/etc/resolv.conf&nbsp;here</span><br>
<span class="lineno">225</span><span class="keyword" id="4011587">func</span>&nbsp;<span class="ident" id="4011592">loadDefaultConfig</span><span class="op" id="4011609">(</span><span class="op" id="4011610">)</span>&nbsp;<span class="op" id="4011612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4011615">loadConfig</span><span class="op" id="4011625">(</span><span class="string" id="4011626">&#34;/etc/resolv.conf&#34;</span><span class="op" id="4011644">,</span>&nbsp;<span class="num" id="4011646">5</span><span class="op" id="4011647">*</span><span class="ident" id="4011648">time</span><span class="op" id="4011652">.</span><span class="ident" id="4011653">Second</span><span class="op" id="4011659">,</span>&nbsp;<span class="ident" id="4011661">nil</span><span class="op" id="4011664">)</span><br>
<span class="lineno"></span><span class="op" id="4011666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4011669">func</span>&nbsp;<span class="ident" id="4011674">loadConfig</span><span class="op" id="4011684">(</span><span class="ident" id="4011685">resolvConfPath</span>&nbsp;<span class="builtintype" id="4011700">string</span><span class="op" id="4011706">,</span>&nbsp;<span class="ident" id="4011708">reloadTime</span>&nbsp;<span class="ident" id="4011719">time</span><span class="op" id="4011723">.</span><span class="ident" id="4011724">Duration</span><span class="op" id="4011732">,</span>&nbsp;<span class="ident" id="4011734">quit</span>&nbsp;<span class="op" id="4011739">&lt;-</span><span class="keyword" id="4011741">chan</span>&nbsp;<span class="keyword" id="4011746">chan</span>&nbsp;<span class="keyword" id="4011751">struct</span><span class="op" id="4011757">{</span><span class="op" id="4011758">}</span><span class="op" id="4011759">)</span>&nbsp;<span class="op" id="4011761">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4011764">var</span>&nbsp;<span class="ident" id="4011768">mtime</span>&nbsp;<span class="ident" id="4011774">time</span><span class="op" id="4011778">.</span><span class="ident" id="4011779">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4011785">cfg</span><span class="op" id="4011788">.</span><span class="ident" id="4011789">ch</span>&nbsp;<span class="op" id="4011792">=</span>&nbsp;<span class="builtinfunc" id="4011794">make</span><span class="op" id="4011798">(</span><span class="keyword" id="4011799">chan</span>&nbsp;<span class="keyword" id="4011804">struct</span><span class="op" id="4011810">{</span><span class="op" id="4011811">}</span><span class="op" id="4011812">,</span>&nbsp;<span class="num" id="4011814">1</span><span class="op" id="4011815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4011818">if</span>&nbsp;<span class="ident" id="4011821">fi</span><span class="op" id="4011823">,</span>&nbsp;<span class="ident" id="4011825">err</span>&nbsp;<span class="op" id="4011829">:=</span>&nbsp;<span class="ident" id="4011832">os</span><span class="op" id="4011834">.</span><span class="ident" id="4011835">Stat</span><span class="op" id="4011839">(</span><span class="ident" id="4011840">resolvConfPath</span><span class="op" id="4011854">)</span><span class="op" id="4011855">;</span>&nbsp;<span class="ident" id="4011857">err</span>&nbsp;<span class="op" id="4011861">!=</span>&nbsp;<span class="ident" id="4011864">nil</span>&nbsp;<span class="op" id="4011868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4011872">cfg</span><span class="op" id="4011875">.</span><span class="ident" id="4011876">dnserr</span>&nbsp;<span class="op" id="4011883">=</span>&nbsp;<span class="ident" id="4011885">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4011890">}</span>&nbsp;<span class="keyword" id="4011892">else</span>&nbsp;<span class="op" id="4011897">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4011901">mtime</span>&nbsp;<span class="op" id="4011907">=</span>&nbsp;<span class="ident" id="4011909">fi</span><span class="op" id="4011911">.</span><span class="ident" id="4011912">ModTime</span><span class="op" id="4011919">(</span><span class="op" id="4011920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4011924">cfg</span><span class="op" id="4011927">.</span><span class="ident" id="4011928">dnsConfig</span><span class="op" id="4011937">,</span>&nbsp;<span class="ident" id="4011939">cfg</span><span class="op" id="4011942">.</span><span class="ident" id="4011943">dnserr</span>&nbsp;<span class="op" id="4011950">=</span>&nbsp;<span class="ident" id="4011952">dnsReadConfig</span><span class="op" id="4011965">(</span><span class="ident" id="4011966">resolvConfPath</span><span class="op" id="4011980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4011983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4011986">go</span>&nbsp;<span class="keyword" id="4011989">func</span><span class="op" id="4011993">(</span><span class="op" id="4011994">)</span>&nbsp;<span class="op" id="4011996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012000">for</span>&nbsp;<span class="op" id="4012004">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4012009">time</span><span class="op" id="4012013">.</span><span class="ident" id="4012014">Sleep</span><span class="op" id="4012019">(</span><span class="ident" id="4012020">reloadTime</span><span class="op" id="4012030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012035">select</span>&nbsp;<span class="op" id="4012042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012047">case</span>&nbsp;<span class="ident" id="4012052">qresp</span>&nbsp;<span class="op" id="4012058">:=</span>&nbsp;<span class="op" id="4012061">&lt;-</span><span class="ident" id="4012063">quit</span><span class="op" id="4012067">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4012073">qresp</span>&nbsp;<span class="op" id="4012079">&lt;-</span>&nbsp;<span class="keyword" id="4012082">struct</span><span class="op" id="4012088">{</span><span class="op" id="4012089">}</span><span class="op" id="4012090">{</span><span class="op" id="4012091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012097">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012107">case</span>&nbsp;<span class="op" id="4012112">&lt;-</span><span class="ident" id="4012114">cfg</span><span class="op" id="4012117">.</span><span class="ident" id="4012118">ch</span><span class="op" id="4012120">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4012125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4012131">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4012183">fi</span><span class="op" id="4012185">,</span>&nbsp;<span class="ident" id="4012187">err</span>&nbsp;<span class="op" id="4012191">:=</span>&nbsp;<span class="ident" id="4012194">os</span><span class="op" id="4012196">.</span><span class="ident" id="4012197">Stat</span><span class="op" id="4012201">(</span><span class="ident" id="4012202">resolvConfPath</span><span class="op" id="4012216">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012221">if</span>&nbsp;<span class="ident" id="4012224">err</span>&nbsp;<span class="op" id="4012228">!=</span>&nbsp;<span class="ident" id="4012231">nil</span>&nbsp;<span class="op" id="4012235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012241">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4012253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4012258">//&nbsp;If&nbsp;the&nbsp;resolv.conf&nbsp;mtime&nbsp;didn&#39;t&nbsp;change,&nbsp;do&nbsp;not&nbsp;reload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4012318">m</span>&nbsp;<span class="op" id="4012320">:=</span>&nbsp;<span class="ident" id="4012323">fi</span><span class="op" id="4012325">.</span><span class="ident" id="4012326">ModTime</span><span class="op" id="4012333">(</span><span class="op" id="4012334">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012339">if</span>&nbsp;<span class="ident" id="4012342">m</span><span class="op" id="4012343">.</span><span class="ident" id="4012344">Equal</span><span class="op" id="4012349">(</span><span class="ident" id="4012350">mtime</span><span class="op" id="4012355">)</span>&nbsp;<span class="op" id="4012357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012363">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4012375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4012380">mtime</span>&nbsp;<span class="op" id="4012386">=</span>&nbsp;<span class="ident" id="4012388">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4012393">//&nbsp;In&nbsp;case&nbsp;of&nbsp;error,&nbsp;we&nbsp;keep&nbsp;the&nbsp;previous&nbsp;config</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4012445">ncfg</span><span class="op" id="4012449">,</span>&nbsp;<span class="ident" id="4012451">err</span>&nbsp;<span class="op" id="4012455">:=</span>&nbsp;<span class="ident" id="4012458">dnsReadConfig</span><span class="op" id="4012471">(</span><span class="ident" id="4012472">resolvConfPath</span><span class="op" id="4012486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012491">if</span>&nbsp;<span class="ident" id="4012494">err</span>&nbsp;<span class="op" id="4012498">!=</span>&nbsp;<span class="ident" id="4012501">nil</span>&nbsp;<span class="op" id="4012505">||</span>&nbsp;<span class="builtinfunc" id="4012508">len</span><span class="op" id="4012511">(</span><span class="ident" id="4012512">ncfg</span><span class="op" id="4012516">.</span><span class="ident" id="4012517">servers</span><span class="op" id="4012524">)</span>&nbsp;<span class="op" id="4012526">==</span>&nbsp;<span class="num" id="4012529">0</span>&nbsp;<span class="op" id="4012531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012537">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4012549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4012554">cfg</span><span class="op" id="4012557">.</span><span class="ident" id="4012558">mu</span><span class="op" id="4012560">.</span><span class="ident" id="4012561">Lock</span><span class="op" id="4012565">(</span><span class="op" id="4012566">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4012571">cfg</span><span class="op" id="4012574">.</span><span class="ident" id="4012575">dnsConfig</span>&nbsp;<span class="op" id="4012585">=</span>&nbsp;<span class="ident" id="4012587">ncfg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4012595">cfg</span><span class="op" id="4012598">.</span><span class="ident" id="4012599">dnserr</span>&nbsp;<span class="op" id="4012606">=</span>&nbsp;<span class="ident" id="4012608">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4012615">cfg</span><span class="op" id="4012618">.</span><span class="ident" id="4012619">mu</span><span class="op" id="4012621">.</span><span class="ident" id="4012622">Unlock</span><span class="op" id="4012628">(</span><span class="op" id="4012629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4012633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4012636">}</span><span class="op" id="4012637">(</span><span class="op" id="4012638">)</span><br>
<span class="lineno">270</span><span class="op" id="4012640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4012643">func</span>&nbsp;<span class="ident" id="4012648">lookup</span><span class="op" id="4012654">(</span><span class="ident" id="4012655">name</span>&nbsp;<span class="builtintype" id="4012660">string</span><span class="op" id="4012666">,</span>&nbsp;<span class="ident" id="4012668">qtype</span>&nbsp;<span class="builtintype" id="4012674">uint16</span><span class="op" id="4012680">)</span>&nbsp;<span class="op" id="4012682">(</span><span class="ident" id="4012683">cname</span>&nbsp;<span class="builtintype" id="4012689">string</span><span class="op" id="4012695">,</span>&nbsp;<span class="ident" id="4012697">addrs</span>&nbsp;<span class="op" id="4012703">[</span><span class="op" id="4012704">]</span><span class="ident" id="4012705">dnsRR</span><span class="op" id="4012710">,</span>&nbsp;<span class="ident" id="4012712">err</span>&nbsp;<span class="builtintype" id="4012716">error</span><span class="op" id="4012721">)</span>&nbsp;<span class="op" id="4012723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012726">if</span>&nbsp;<span class="op" id="4012729">!</span><span class="ident" id="4012730">isDomainName</span><span class="op" id="4012742">(</span><span class="ident" id="4012743">name</span><span class="op" id="4012747">)</span>&nbsp;<span class="op" id="4012749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012753">return</span>&nbsp;<span class="ident" id="4012760">name</span><span class="op" id="4012764">,</span>&nbsp;<span class="ident" id="4012766">nil</span><span class="op" id="4012769">,</span>&nbsp;<span class="op" id="4012771">&amp;</span><span class="ident" id="4012772">DNSError</span><span class="op" id="4012780">{</span><span class="ident" id="4012781">Err</span><span class="op" id="4012784">:</span>&nbsp;<span class="string" id="4012786">&#34;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="4012807">,</span>&nbsp;<span class="ident" id="4012809">Name</span><span class="op" id="4012813">:</span>&nbsp;<span class="ident" id="4012815">name</span><span class="op" id="4012819">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4012822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4012825">onceLoadConfig</span><span class="op" id="4012839">.</span><span class="ident" id="4012840">Do</span><span class="op" id="4012842">(</span><span class="ident" id="4012843">loadDefaultConfig</span><span class="op" id="4012860">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012864">select</span>&nbsp;<span class="op" id="4012871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012874">case</span>&nbsp;<span class="ident" id="4012879">cfg</span><span class="op" id="4012882">.</span><span class="ident" id="4012883">ch</span>&nbsp;<span class="op" id="4012886">&lt;-</span>&nbsp;<span class="keyword" id="4012889">struct</span><span class="op" id="4012895">{</span><span class="op" id="4012896">}</span><span class="op" id="4012897">{</span><span class="op" id="4012898">}</span><span class="op" id="4012899">:</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012902">default</span><span class="op" id="4012909">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4012912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4012916">cfg</span><span class="op" id="4012919">.</span><span class="ident" id="4012920">mu</span><span class="op" id="4012922">.</span><span class="ident" id="4012923">RLock</span><span class="op" id="4012928">(</span><span class="op" id="4012929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012932">defer</span>&nbsp;<span class="ident" id="4012938">cfg</span><span class="op" id="4012941">.</span><span class="ident" id="4012942">mu</span><span class="op" id="4012944">.</span><span class="ident" id="4012945">RUnlock</span><span class="op" id="4012952">(</span><span class="op" id="4012953">)</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4012957">if</span>&nbsp;<span class="ident" id="4012960">cfg</span><span class="op" id="4012963">.</span><span class="ident" id="4012964">dnserr</span>&nbsp;<span class="op" id="4012971">!=</span>&nbsp;<span class="ident" id="4012974">nil</span>&nbsp;<span class="op" id="4012978">||</span>&nbsp;<span class="ident" id="4012981">cfg</span><span class="op" id="4012984">.</span><span class="ident" id="4012985">dnsConfig</span>&nbsp;<span class="op" id="4012995">==</span>&nbsp;<span class="ident" id="4012998">nil</span>&nbsp;<span class="op" id="4013002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4013006">err</span>&nbsp;<span class="op" id="4013010">=</span>&nbsp;<span class="ident" id="4013012">cfg</span><span class="op" id="4013015">.</span><span class="ident" id="4013016">dnserr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4013025">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4013033">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4013036">//&nbsp;If&nbsp;name&nbsp;is&nbsp;rooted&nbsp;(trailing&nbsp;dot)&nbsp;or&nbsp;has&nbsp;enough&nbsp;dots,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4013093">//&nbsp;try&nbsp;it&nbsp;by&nbsp;itself&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4013121">rooted</span>&nbsp;<span class="op" id="4013128">:=</span>&nbsp;<span class="builtinfunc" id="4013131">len</span><span class="op" id="4013134">(</span><span class="ident" id="4013135">name</span><span class="op" id="4013139">)</span>&nbsp;<span class="op" id="4013141">&gt;</span>&nbsp;<span class="num" id="4013143">0</span>&nbsp;<span class="op" id="4013145">&amp;&amp;</span>&nbsp;<span class="ident" id="4013148">name</span><span class="op" id="4013152">[</span><span class="builtinfunc" id="4013153">len</span><span class="op" id="4013156">(</span><span class="ident" id="4013157">name</span><span class="op" id="4013161">)</span><span class="op" id="4013162">-</span><span class="num" id="4013163">1</span><span class="op" id="4013164">]</span>&nbsp;<span class="op" id="4013166">==</span>&nbsp;<span class="string" id="4013169">&#39;.&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4013174">if</span>&nbsp;<span class="ident" id="4013177">rooted</span>&nbsp;<span class="op" id="4013184">||</span>&nbsp;<span class="ident" id="4013187">count</span><span class="op" id="4013192">(</span><span class="ident" id="4013193">name</span><span class="op" id="4013197">,</span>&nbsp;<span class="string" id="4013199">&#39;.&#39;</span><span class="op" id="4013202">)</span>&nbsp;<span class="op" id="4013204">&gt;=</span>&nbsp;<span class="ident" id="4013207">cfg</span><span class="op" id="4013210">.</span><span class="ident" id="4013211">dnsConfig</span><span class="op" id="4013220">.</span><span class="ident" id="4013221">ndots</span>&nbsp;<span class="op" id="4013227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4013231">rname</span>&nbsp;<span class="op" id="4013237">:=</span>&nbsp;<span class="ident" id="4013240">name</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4013247">if</span>&nbsp;<span class="op" id="4013250">!</span><span class="ident" id="4013251">rooted</span>&nbsp;<span class="op" id="4013258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4013263">rname</span>&nbsp;<span class="op" id="4013269">+=</span>&nbsp;<span class="string" id="4013272">&#34;.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4013278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4013282">//&nbsp;Can&nbsp;try&nbsp;as&nbsp;ordinary&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4013313">cname</span><span class="op" id="4013318">,</span>&nbsp;<span class="ident" id="4013320">addrs</span><span class="op" id="4013325">,</span>&nbsp;<span class="ident" id="4013327">err</span>&nbsp;<span class="op" id="4013331">=</span>&nbsp;<span class="ident" id="4013333">tryOneName</span><span class="op" id="4013343">(</span><span class="ident" id="4013344">cfg</span><span class="op" id="4013347">.</span><span class="ident" id="4013348">dnsConfig</span><span class="op" id="4013357">,</span>&nbsp;<span class="ident" id="4013359">rname</span><span class="op" id="4013364">,</span>&nbsp;<span class="ident" id="4013366">qtype</span><span class="op" id="4013371">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4013375">if</span>&nbsp;<span class="ident" id="4013378">rooted</span>&nbsp;<span class="op" id="4013385">||</span>&nbsp;<span class="ident" id="4013388">err</span>&nbsp;<span class="op" id="4013392">==</span>&nbsp;<span class="ident" id="4013395">nil</span>&nbsp;<span class="op" id="4013399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4013404">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4013413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4013416">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4013420">//&nbsp;Otherwise,&nbsp;try&nbsp;suffixes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4013449">for</span>&nbsp;<span class="ident" id="4013453">i</span>&nbsp;<span class="op" id="4013455">:=</span>&nbsp;<span class="num" id="4013458">0</span><span class="op" id="4013459">;</span>&nbsp;<span class="ident" id="4013461">i</span>&nbsp;<span class="op" id="4013463">&lt;</span>&nbsp;<span class="builtinfunc" id="4013465">len</span><span class="op" id="4013468">(</span><span class="ident" id="4013469">cfg</span><span class="op" id="4013472">.</span><span class="ident" id="4013473">dnsConfig</span><span class="op" id="4013482">.</span><span class="ident" id="4013483">search</span><span class="op" id="4013489">)</span><span class="op" id="4013490">;</span>&nbsp;<span class="ident" id="4013492">i</span><span class="op" id="4013493">++</span>&nbsp;<span class="op" id="4013496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4013500">rname</span>&nbsp;<span class="op" id="4013506">:=</span>&nbsp;<span class="ident" id="4013509">name</span>&nbsp;<span class="op" id="4013514">+</span>&nbsp;<span class="string" id="4013516">&#34;.&#34;</span>&nbsp;<span class="op" id="4013520">+</span>&nbsp;<span class="ident" id="4013522">cfg</span><span class="op" id="4013525">.</span><span class="ident" id="4013526">dnsConfig</span><span class="op" id="4013535">.</span><span class="ident" id="4013536">search</span><span class="op" id="4013542">[</span><span class="ident" id="4013543">i</span><span class="op" id="4013544">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4013548">if</span>&nbsp;<span class="ident" id="4013551">rname</span><span class="op" id="4013556">[</span><span class="builtinfunc" id="4013557">len</span><span class="op" id="4013560">(</span><span class="ident" id="4013561">rname</span><span class="op" id="4013566">)</span><span class="op" id="4013567">-</span><span class="num" id="4013568">1</span><span class="op" id="4013569">]</span>&nbsp;<span class="op" id="4013571">!=</span>&nbsp;<span class="string" id="4013574">&#39;.&#39;</span>&nbsp;<span class="op" id="4013578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4013583">rname</span>&nbsp;<span class="op" id="4013589">+=</span>&nbsp;<span class="string" id="4013592">&#34;.&#34;</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4013598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4013602">cname</span><span class="op" id="4013607">,</span>&nbsp;<span class="ident" id="4013609">addrs</span><span class="op" id="4013614">,</span>&nbsp;<span class="ident" id="4013616">err</span>&nbsp;<span class="op" id="4013620">=</span>&nbsp;<span class="ident" id="4013622">tryOneName</span><span class="op" id="4013632">(</span><span class="ident" id="4013633">cfg</span><span class="op" id="4013636">.</span><span class="ident" id="4013637">dnsConfig</span><span class="op" id="4013646">,</span>&nbsp;<span class="ident" id="4013648">rname</span><span class="op" id="4013653">,</span>&nbsp;<span class="ident" id="4013655">qtype</span><span class="op" id="4013660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4013664">if</span>&nbsp;<span class="ident" id="4013667">err</span>&nbsp;<span class="op" id="4013671">==</span>&nbsp;<span class="ident" id="4013674">nil</span>&nbsp;<span class="op" id="4013678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4013683">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4013692">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4013695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4013699">//&nbsp;Last&nbsp;ditch&nbsp;effort:&nbsp;try&nbsp;unsuffixed&nbsp;only&nbsp;if&nbsp;we&nbsp;haven&#39;t&nbsp;already,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4013765">//&nbsp;that&nbsp;is,&nbsp;name&nbsp;is&nbsp;not&nbsp;rooted&nbsp;and&nbsp;has&nbsp;less&nbsp;than&nbsp;ndots&nbsp;dots.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4013827">if</span>&nbsp;<span class="ident" id="4013830">count</span><span class="op" id="4013835">(</span><span class="ident" id="4013836">name</span><span class="op" id="4013840">,</span>&nbsp;<span class="string" id="4013842">&#39;.&#39;</span><span class="op" id="4013845">)</span>&nbsp;<span class="op" id="4013847">&lt;</span>&nbsp;<span class="ident" id="4013849">cfg</span><span class="op" id="4013852">.</span><span class="ident" id="4013853">dnsConfig</span><span class="op" id="4013862">.</span><span class="ident" id="4013863">ndots</span>&nbsp;<span class="op" id="4013869">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4013873">cname</span><span class="op" id="4013878">,</span>&nbsp;<span class="ident" id="4013880">addrs</span><span class="op" id="4013885">,</span>&nbsp;<span class="ident" id="4013887">err</span>&nbsp;<span class="op" id="4013891">=</span>&nbsp;<span class="ident" id="4013893">tryOneName</span><span class="op" id="4013903">(</span><span class="ident" id="4013904">cfg</span><span class="op" id="4013907">.</span><span class="ident" id="4013908">dnsConfig</span><span class="op" id="4013917">,</span>&nbsp;<span class="ident" id="4013919">name</span><span class="op" id="4013923">+</span><span class="string" id="4013924">&#34;.&#34;</span><span class="op" id="4013927">,</span>&nbsp;<span class="ident" id="4013929">qtype</span><span class="op" id="4013934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4013938">if</span>&nbsp;<span class="ident" id="4013941">err</span>&nbsp;<span class="op" id="4013945">==</span>&nbsp;<span class="ident" id="4013948">nil</span>&nbsp;<span class="op" id="4013952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4013957">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4013966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4013969">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4013973">if</span>&nbsp;<span class="ident" id="4013976">e</span><span class="op" id="4013977">,</span>&nbsp;<span class="ident" id="4013979">ok</span>&nbsp;<span class="op" id="4013982">:=</span>&nbsp;<span class="ident" id="4013985">err</span><span class="op" id="4013988">.</span><span class="op" id="4013989">(</span><span class="op" id="4013990">*</span><span class="ident" id="4013991">DNSError</span><span class="op" id="4013999">)</span><span class="op" id="4014000">;</span>&nbsp;<span class="ident" id="4014002">ok</span>&nbsp;<span class="op" id="4014005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4014009">//&nbsp;Show&nbsp;original&nbsp;name&nbsp;passed&nbsp;to&nbsp;lookup,&nbsp;not&nbsp;suffixed&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4014069">//&nbsp;In&nbsp;general&nbsp;we&nbsp;might&nbsp;have&nbsp;tried&nbsp;many&nbsp;suffixes;&nbsp;showing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4014128">//&nbsp;just&nbsp;one&nbsp;is&nbsp;misleading.&nbsp;See&nbsp;also&nbsp;golang.org/issue/6324.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4014189">e</span><span class="op" id="4014190">.</span><span class="ident" id="4014191">Name</span>&nbsp;<span class="op" id="4014196">=</span>&nbsp;<span class="ident" id="4014198">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4014204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4014207">return</span><br>
<span class="lineno"></span><span class="op" id="4014214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="4014217">//&nbsp;goLookupHost&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupHost.</span><br>
<span class="lineno"></span><span class="comment" id="4014280">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="4014340">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupHost&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="4014404">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4014465">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">340</span><span class="comment" id="4014528">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="4014540">func</span>&nbsp;<span class="ident" id="4014545">goLookupHost</span><span class="op" id="4014557">(</span><span class="ident" id="4014558">name</span>&nbsp;<span class="builtintype" id="4014563">string</span><span class="op" id="4014569">)</span>&nbsp;<span class="op" id="4014571">(</span><span class="ident" id="4014572">addrs</span>&nbsp;<span class="op" id="4014578">[</span><span class="op" id="4014579">]</span><span class="builtintype" id="4014580">string</span><span class="op" id="4014586">,</span>&nbsp;<span class="ident" id="4014588">err</span>&nbsp;<span class="builtintype" id="4014592">error</span><span class="op" id="4014597">)</span>&nbsp;<span class="op" id="4014599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4014602">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;they&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4014649">addrs</span>&nbsp;<span class="op" id="4014655">=</span>&nbsp;<span class="ident" id="4014657">lookupStaticHost</span><span class="op" id="4014673">(</span><span class="ident" id="4014674">name</span><span class="op" id="4014678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4014681">if</span>&nbsp;<span class="builtinfunc" id="4014684">len</span><span class="op" id="4014687">(</span><span class="ident" id="4014688">addrs</span><span class="op" id="4014693">)</span>&nbsp;<span class="op" id="4014695">&gt;</span>&nbsp;<span class="num" id="4014697">0</span>&nbsp;<span class="op" id="4014699">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4014703">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4014711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4014714">ips</span><span class="op" id="4014717">,</span>&nbsp;<span class="ident" id="4014719">err</span>&nbsp;<span class="op" id="4014723">:=</span>&nbsp;<span class="ident" id="4014726">goLookupIP</span><span class="op" id="4014736">(</span><span class="ident" id="4014737">name</span><span class="op" id="4014741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4014744">if</span>&nbsp;<span class="ident" id="4014747">err</span>&nbsp;<span class="op" id="4014751">!=</span>&nbsp;<span class="ident" id="4014754">nil</span>&nbsp;<span class="op" id="4014758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4014762">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4014770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4014773">addrs</span>&nbsp;<span class="op" id="4014779">=</span>&nbsp;<span class="builtinfunc" id="4014781">make</span><span class="op" id="4014785">(</span><span class="op" id="4014786">[</span><span class="op" id="4014787">]</span><span class="builtintype" id="4014788">string</span><span class="op" id="4014794">,</span>&nbsp;<span class="num" id="4014796">0</span><span class="op" id="4014797">,</span>&nbsp;<span class="builtinfunc" id="4014799">len</span><span class="op" id="4014802">(</span><span class="ident" id="4014803">ips</span><span class="op" id="4014806">)</span><span class="op" id="4014807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4014810">for</span>&nbsp;<span class="ident" id="4014814">_</span><span class="op" id="4014815">,</span>&nbsp;<span class="ident" id="4014817">ip</span>&nbsp;<span class="op" id="4014820">:=</span>&nbsp;<span class="keyword" id="4014823">range</span>&nbsp;<span class="ident" id="4014829">ips</span>&nbsp;<span class="op" id="4014833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4014837">addrs</span>&nbsp;<span class="op" id="4014843">=</span>&nbsp;<span class="builtinfunc" id="4014845">append</span><span class="op" id="4014851">(</span><span class="ident" id="4014852">addrs</span><span class="op" id="4014857">,</span>&nbsp;<span class="ident" id="4014859">ip</span><span class="op" id="4014861">.</span><span class="ident" id="4014862">String</span><span class="op" id="4014868">(</span><span class="op" id="4014869">)</span><span class="op" id="4014870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4014873">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4014876">return</span><br>
<span class="lineno"></span><span class="op" id="4014883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4014886">//&nbsp;goLookupIP&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupIP.</span><br>
<span class="lineno"></span><span class="comment" id="4014945">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno">360</span><span class="comment" id="4015003">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupIP&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="4015065">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4015126">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="4015189">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="4015201">func</span>&nbsp;<span class="ident" id="4015206">goLookupIP</span><span class="op" id="4015216">(</span><span class="ident" id="4015217">name</span>&nbsp;<span class="builtintype" id="4015222">string</span><span class="op" id="4015228">)</span>&nbsp;<span class="op" id="4015230">(</span><span class="ident" id="4015231">addrs</span>&nbsp;<span class="op" id="4015237">[</span><span class="op" id="4015238">]</span><span class="ident" id="4015239">IP</span><span class="op" id="4015241">,</span>&nbsp;<span class="ident" id="4015243">err</span>&nbsp;<span class="builtintype" id="4015247">error</span><span class="op" id="4015252">)</span>&nbsp;<span class="op" id="4015254">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4015257">//&nbsp;Use&nbsp;entries&nbsp;from&nbsp;/etc/hosts&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4015302">haddrs</span>&nbsp;<span class="op" id="4015309">:=</span>&nbsp;<span class="ident" id="4015312">lookupStaticHost</span><span class="op" id="4015328">(</span><span class="ident" id="4015329">name</span><span class="op" id="4015333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4015336">if</span>&nbsp;<span class="builtinfunc" id="4015339">len</span><span class="op" id="4015342">(</span><span class="ident" id="4015343">haddrs</span><span class="op" id="4015349">)</span>&nbsp;<span class="op" id="4015351">&gt;</span>&nbsp;<span class="num" id="4015353">0</span>&nbsp;<span class="op" id="4015355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4015359">for</span>&nbsp;<span class="ident" id="4015363">_</span><span class="op" id="4015364">,</span>&nbsp;<span class="ident" id="4015366">haddr</span>&nbsp;<span class="op" id="4015372">:=</span>&nbsp;<span class="keyword" id="4015375">range</span>&nbsp;<span class="ident" id="4015381">haddrs</span>&nbsp;<span class="op" id="4015388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4015393">if</span>&nbsp;<span class="ident" id="4015396">ip</span>&nbsp;<span class="op" id="4015399">:=</span>&nbsp;<span class="ident" id="4015402">ParseIP</span><span class="op" id="4015409">(</span><span class="ident" id="4015410">haddr</span><span class="op" id="4015415">)</span><span class="op" id="4015416">;</span>&nbsp;<span class="ident" id="4015418">ip</span>&nbsp;<span class="op" id="4015421">!=</span>&nbsp;<span class="ident" id="4015424">nil</span>&nbsp;<span class="op" id="4015428">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4015434">addrs</span>&nbsp;<span class="op" id="4015440">=</span>&nbsp;<span class="builtinfunc" id="4015442">append</span><span class="op" id="4015448">(</span><span class="ident" id="4015449">addrs</span><span class="op" id="4015454">,</span>&nbsp;<span class="ident" id="4015456">ip</span><span class="op" id="4015458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4015463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4015467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4015471">if</span>&nbsp;<span class="builtinfunc" id="4015474">len</span><span class="op" id="4015477">(</span><span class="ident" id="4015478">addrs</span><span class="op" id="4015483">)</span>&nbsp;<span class="op" id="4015485">&gt;</span>&nbsp;<span class="num" id="4015487">0</span>&nbsp;<span class="op" id="4015489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4015494">return</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4015503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4015506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4015509">type</span>&nbsp;<span class="ident" id="4015514">racer</span>&nbsp;<span class="keyword" id="4015520">struct</span>&nbsp;<span class="op" id="4015527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4015531">qtype</span>&nbsp;<span class="builtintype" id="4015537">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4015546">rrs</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4015552">[</span><span class="op" id="4015553">]</span><span class="ident" id="4015554">dnsRR</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4015562">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4015569">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4015572">lane</span>&nbsp;<span class="op" id="4015577">:=</span>&nbsp;<span class="builtinfunc" id="4015580">make</span><span class="op" id="4015584">(</span><span class="keyword" id="4015585">chan</span>&nbsp;<span class="ident" id="4015590">racer</span><span class="op" id="4015595">,</span>&nbsp;<span class="num" id="4015597">1</span><span class="op" id="4015598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4015601">qtypes</span>&nbsp;<span class="op" id="4015608">:=</span>&nbsp;<span class="op" id="4015611">[</span><span class="op" id="4015612">...</span><span class="op" id="4015615">]</span><span class="builtintype" id="4015616">uint16</span><span class="op" id="4015622">{</span><span class="ident" id="4015623">dnsTypeA</span><span class="op" id="4015631">,</span>&nbsp;<span class="ident" id="4015633">dnsTypeAAAA</span><span class="op" id="4015644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4015647">for</span>&nbsp;<span class="ident" id="4015651">_</span><span class="op" id="4015652">,</span>&nbsp;<span class="ident" id="4015654">qtype</span>&nbsp;<span class="op" id="4015660">:=</span>&nbsp;<span class="keyword" id="4015663">range</span>&nbsp;<span class="ident" id="4015669">qtypes</span>&nbsp;<span class="op" id="4015676">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4015680">go</span>&nbsp;<span class="keyword" id="4015683">func</span><span class="op" id="4015687">(</span><span class="ident" id="4015688">qtype</span>&nbsp;<span class="builtintype" id="4015694">uint16</span><span class="op" id="4015700">)</span>&nbsp;<span class="op" id="4015702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4015707">_</span><span class="op" id="4015708">,</span>&nbsp;<span class="ident" id="4015710">rrs</span><span class="op" id="4015713">,</span>&nbsp;<span class="ident" id="4015715">err</span>&nbsp;<span class="op" id="4015719">:=</span>&nbsp;<span class="ident" id="4015722">lookup</span><span class="op" id="4015728">(</span><span class="ident" id="4015729">name</span><span class="op" id="4015733">,</span>&nbsp;<span class="ident" id="4015735">qtype</span><span class="op" id="4015740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4015745">lane</span>&nbsp;<span class="op" id="4015750">&lt;-</span>&nbsp;<span class="ident" id="4015753">racer</span><span class="op" id="4015758">{</span><span class="ident" id="4015759">qtype</span><span class="op" id="4015764">,</span>&nbsp;<span class="ident" id="4015766">rrs</span><span class="op" id="4015769">,</span>&nbsp;<span class="ident" id="4015771">err</span><span class="op" id="4015774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4015778">}</span><span class="op" id="4015779">(</span><span class="ident" id="4015780">qtype</span><span class="op" id="4015785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4015788">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4015791">var</span>&nbsp;<span class="ident" id="4015795">lastErr</span>&nbsp;<span class="builtintype" id="4015803">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4015810">for</span>&nbsp;<span class="keyword" id="4015814">range</span>&nbsp;<span class="ident" id="4015820">qtypes</span>&nbsp;<span class="op" id="4015827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4015831">racer</span>&nbsp;<span class="op" id="4015837">:=</span>&nbsp;<span class="op" id="4015840">&lt;-</span><span class="ident" id="4015842">lane</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4015849">if</span>&nbsp;<span class="ident" id="4015852">racer</span><span class="op" id="4015857">.</span><span class="builtintype" id="4015858">error</span>&nbsp;<span class="op" id="4015864">!=</span>&nbsp;<span class="ident" id="4015867">nil</span>&nbsp;<span class="op" id="4015871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4015876">lastErr</span>&nbsp;<span class="op" id="4015884">=</span>&nbsp;<span class="ident" id="4015886">racer</span><span class="op" id="4015891">.</span><span class="builtintype" id="4015892">error</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4015901">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4015912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4015916">switch</span>&nbsp;<span class="ident" id="4015923">racer</span><span class="op" id="4015928">.</span><span class="ident" id="4015929">qtype</span>&nbsp;<span class="op" id="4015935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4015939">case</span>&nbsp;<span class="ident" id="4015944">dnsTypeA</span><span class="op" id="4015952">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4015957">addrs</span>&nbsp;<span class="op" id="4015963">=</span>&nbsp;<span class="builtinfunc" id="4015965">append</span><span class="op" id="4015971">(</span><span class="ident" id="4015972">addrs</span><span class="op" id="4015977">,</span>&nbsp;<span class="ident" id="4015979">convertRR_A</span><span class="op" id="4015990">(</span><span class="ident" id="4015991">racer</span><span class="op" id="4015996">.</span><span class="ident" id="4015997">rrs</span><span class="op" id="4016000">)</span><span class="op" id="4016001">...</span><span class="op" id="4016004">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4016008">case</span>&nbsp;<span class="ident" id="4016013">dnsTypeAAAA</span><span class="op" id="4016024">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4016029">addrs</span>&nbsp;<span class="op" id="4016035">=</span>&nbsp;<span class="builtinfunc" id="4016037">append</span><span class="op" id="4016043">(</span><span class="ident" id="4016044">addrs</span><span class="op" id="4016049">,</span>&nbsp;<span class="ident" id="4016051">convertRR_AAAA</span><span class="op" id="4016065">(</span><span class="ident" id="4016066">racer</span><span class="op" id="4016071">.</span><span class="ident" id="4016072">rrs</span><span class="op" id="4016075">)</span><span class="op" id="4016076">...</span><span class="op" id="4016079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4016083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4016086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4016089">if</span>&nbsp;<span class="builtinfunc" id="4016092">len</span><span class="op" id="4016095">(</span><span class="ident" id="4016096">addrs</span><span class="op" id="4016101">)</span>&nbsp;<span class="op" id="4016103">==</span>&nbsp;<span class="num" id="4016106">0</span>&nbsp;<span class="op" id="4016108">&amp;&amp;</span>&nbsp;<span class="ident" id="4016111">lastErr</span>&nbsp;<span class="op" id="4016119">!=</span>&nbsp;<span class="ident" id="4016122">nil</span>&nbsp;<span class="op" id="4016126">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4016130">return</span>&nbsp;<span class="ident" id="4016137">nil</span><span class="op" id="4016140">,</span>&nbsp;<span class="ident" id="4016142">lastErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4016151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4016154">return</span>&nbsp;<span class="ident" id="4016161">addrs</span><span class="op" id="4016166">,</span>&nbsp;<span class="ident" id="4016168">nil</span><br>
<span class="lineno"></span><span class="op" id="4016172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="4016175">//&nbsp;goLookupCNAME&nbsp;is&nbsp;the&nbsp;native&nbsp;Go&nbsp;implementation&nbsp;of&nbsp;LookupCNAME.</span><br>
<span class="lineno"></span><span class="comment" id="4016240">//&nbsp;Used&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;refuses&nbsp;to&nbsp;handle&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span><span class="comment" id="4016301">//&nbsp;(that&nbsp;is,&nbsp;only&nbsp;if&nbsp;cgoLookupCNAME&nbsp;is&nbsp;the&nbsp;stub&nbsp;in&nbsp;cgo_stub.go).</span><br>
<span class="lineno"></span><span class="comment" id="4016366">//&nbsp;Normally&nbsp;we&nbsp;let&nbsp;cgo&nbsp;use&nbsp;the&nbsp;C&nbsp;library&nbsp;resolver&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4016427">//&nbsp;depending&nbsp;on&nbsp;our&nbsp;lookup&nbsp;code,&nbsp;so&nbsp;that&nbsp;Go&nbsp;and&nbsp;C&nbsp;get&nbsp;the&nbsp;same</span><br>
<span class="lineno">415</span><span class="comment" id="4016490">//&nbsp;answers.</span><br>
<span class="lineno"></span><span class="keyword" id="4016502">func</span>&nbsp;<span class="ident" id="4016507">goLookupCNAME</span><span class="op" id="4016520">(</span><span class="ident" id="4016521">name</span>&nbsp;<span class="builtintype" id="4016526">string</span><span class="op" id="4016532">)</span>&nbsp;<span class="op" id="4016534">(</span><span class="ident" id="4016535">cname</span>&nbsp;<span class="builtintype" id="4016541">string</span><span class="op" id="4016547">,</span>&nbsp;<span class="ident" id="4016549">err</span>&nbsp;<span class="builtintype" id="4016553">error</span><span class="op" id="4016558">)</span>&nbsp;<span class="op" id="4016560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4016563">_</span><span class="op" id="4016564">,</span>&nbsp;<span class="ident" id="4016566">rr</span><span class="op" id="4016568">,</span>&nbsp;<span class="ident" id="4016570">err</span>&nbsp;<span class="op" id="4016574">:=</span>&nbsp;<span class="ident" id="4016577">lookup</span><span class="op" id="4016583">(</span><span class="ident" id="4016584">name</span><span class="op" id="4016588">,</span>&nbsp;<span class="ident" id="4016590">dnsTypeCNAME</span><span class="op" id="4016602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4016605">if</span>&nbsp;<span class="ident" id="4016608">err</span>&nbsp;<span class="op" id="4016612">!=</span>&nbsp;<span class="ident" id="4016615">nil</span>&nbsp;<span class="op" id="4016619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4016623">return</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4016631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4016634">cname</span>&nbsp;<span class="op" id="4016640">=</span>&nbsp;<span class="ident" id="4016642">rr</span><span class="op" id="4016644">[</span><span class="num" id="4016645">0</span><span class="op" id="4016646">]</span><span class="op" id="4016647">.</span><span class="op" id="4016648">(</span><span class="op" id="4016649">*</span><span class="ident" id="4016650">dnsRR_CNAME</span><span class="op" id="4016661">)</span><span class="op" id="4016662">.</span><span class="ident" id="4016663">Cname</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4016670">return</span><br>
<span class="lineno"></span><span class="op" id="4016677">}</span>
</div>
</body>
</html>
