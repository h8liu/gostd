<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4819401">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4819456">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4819510">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4819561">//&nbsp;HTTP&nbsp;server.&nbsp;&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4819593">package</span>&nbsp;<span class="ident" id="4819601">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4819607">import</span>&nbsp;<span class="op" id="4819614">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4819617">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4819626">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4819640">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4819650">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4819657">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4819663">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4819676">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4819683">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4819690">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4819701">&#34;os&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4819707">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4819715">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4819726">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4819737">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4819748">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4819756">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4819771">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4819778">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4819781">//&nbsp;Errors&nbsp;introduced&nbsp;by&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">30</span><span class="keyword" id="4819822">var</span>&nbsp;<span class="op" id="4819826">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4819829">ErrWriteAfterFlush</span>&nbsp;<span class="op" id="4819848">=</span>&nbsp;<span class="ident" id="4819850">errors</span><span class="op" id="4819856">.</span><span class="ident" id="4819857">New</span><span class="op" id="4819860">(</span><span class="string" id="4819861">&#34;Conn.Write&nbsp;called&nbsp;after&nbsp;Flush&#34;</span><span class="op" id="4819892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4819895">ErrBodyNotAllowed</span>&nbsp;&nbsp;<span class="op" id="4819914">=</span>&nbsp;<span class="ident" id="4819916">errors</span><span class="op" id="4819922">.</span><span class="ident" id="4819923">New</span><span class="op" id="4819926">(</span><span class="string" id="4819927">&#34;http:&nbsp;request&nbsp;method&nbsp;or&nbsp;response&nbsp;status&nbsp;code&nbsp;does&nbsp;not&nbsp;allow&nbsp;body&#34;</span><span class="op" id="4819993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4819996">ErrHijacked</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4820015">=</span>&nbsp;<span class="ident" id="4820017">errors</span><span class="op" id="4820023">.</span><span class="ident" id="4820024">New</span><span class="op" id="4820027">(</span><span class="string" id="4820028">&#34;Conn&nbsp;has&nbsp;been&nbsp;hijacked&#34;</span><span class="op" id="4820052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4820055">ErrContentLength</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4820074">=</span>&nbsp;<span class="ident" id="4820076">errors</span><span class="op" id="4820082">.</span><span class="ident" id="4820083">New</span><span class="op" id="4820086">(</span><span class="string" id="4820087">&#34;Conn.Write&nbsp;wrote&nbsp;more&nbsp;than&nbsp;the&nbsp;declared&nbsp;Content-Length&#34;</span><span class="op" id="4820143">)</span><br>
<span class="lineno">35</span><span class="op" id="4820145">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4820148">//&nbsp;Objects&nbsp;implementing&nbsp;the&nbsp;Handler&nbsp;interface&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4820201">//&nbsp;registered&nbsp;to&nbsp;serve&nbsp;a&nbsp;particular&nbsp;path&nbsp;or&nbsp;subtree</span><br>
<span class="lineno"></span><span class="comment" id="4820253">//&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">40</span><span class="comment" id="4820276">//</span><br>
<span class="lineno"></span><span class="comment" id="4820279">//&nbsp;ServeHTTP&nbsp;should&nbsp;write&nbsp;reply&nbsp;headers&nbsp;and&nbsp;data&nbsp;to&nbsp;the&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="4820350">//&nbsp;and&nbsp;then&nbsp;return.&nbsp;&nbsp;Returning&nbsp;signals&nbsp;that&nbsp;the&nbsp;request&nbsp;is&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="4820418">//&nbsp;and&nbsp;that&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;can&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="4820481">//&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">45</span><span class="comment" id="4820500">//</span><br>
<span class="lineno"></span><span class="comment" id="4820503">//&nbsp;If&nbsp;ServeHTTP&nbsp;panics,&nbsp;the&nbsp;server&nbsp;(the&nbsp;caller&nbsp;of&nbsp;ServeHTTP)&nbsp;assumes</span><br>
<span class="lineno"></span><span class="comment" id="4820572">//&nbsp;that&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;panic&nbsp;was&nbsp;isolated&nbsp;to&nbsp;the&nbsp;active&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="4820640">//&nbsp;It&nbsp;recovers&nbsp;the&nbsp;panic,&nbsp;logs&nbsp;a&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;server&nbsp;error&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="4820710">//&nbsp;and&nbsp;hangs&nbsp;up&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">50</span><span class="comment" id="4820742">//</span><br>
<span class="lineno"></span><span class="keyword" id="4820745">type</span>&nbsp;<span class="ident" id="4820750">Handler</span>&nbsp;<span class="keyword" id="4820758">interface</span>&nbsp;<span class="op" id="4820768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4820771">ServeHTTP</span><span class="op" id="4820780">(</span><span class="ident" id="4820781">ResponseWriter</span><span class="op" id="4820795">,</span>&nbsp;<span class="op" id="4820797">*</span><span class="ident" id="4820798">Request</span><span class="op" id="4820805">)</span><br>
<span class="lineno"></span><span class="op" id="4820807">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="4820810">//&nbsp;A&nbsp;ResponseWriter&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4820870">//&nbsp;construct&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="4820901">type</span>&nbsp;<span class="ident" id="4820906">ResponseWriter</span>&nbsp;<span class="keyword" id="4820921">interface</span>&nbsp;<span class="op" id="4820931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4820934">//&nbsp;Header&nbsp;returns&nbsp;the&nbsp;header&nbsp;map&nbsp;that&nbsp;will&nbsp;be&nbsp;sent&nbsp;by&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4821002">//&nbsp;Changing&nbsp;the&nbsp;header&nbsp;after&nbsp;a&nbsp;call&nbsp;to&nbsp;WriteHeader&nbsp;(or&nbsp;Write)&nbsp;has</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4821069">//&nbsp;no&nbsp;effect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821084">Header</span><span class="op" id="4821090">(</span><span class="op" id="4821091">)</span>&nbsp;<span class="ident" id="4821093">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4821102">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;data&nbsp;to&nbsp;the&nbsp;connection&nbsp;as&nbsp;part&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4821172">//&nbsp;If&nbsp;WriteHeader&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;called,&nbsp;Write&nbsp;calls&nbsp;WriteHeader(http.StatusOK)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4821255">//&nbsp;before&nbsp;writing&nbsp;the&nbsp;data.&nbsp;&nbsp;If&nbsp;the&nbsp;Header&nbsp;does&nbsp;not&nbsp;contain&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4821318">//&nbsp;Content-Type&nbsp;line,&nbsp;Write&nbsp;adds&nbsp;a&nbsp;Content-Type&nbsp;set&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;passing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4821396">//&nbsp;the&nbsp;initial&nbsp;512&nbsp;bytes&nbsp;of&nbsp;written&nbsp;data&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821460">Write</span><span class="op" id="4821465">(</span><span class="op" id="4821466">[</span><span class="op" id="4821467">]</span><span class="builtintype" id="4821468">byte</span><span class="op" id="4821472">)</span>&nbsp;<span class="op" id="4821474">(</span><span class="builtintype" id="4821475">int</span><span class="op" id="4821478">,</span>&nbsp;<span class="builtintype" id="4821480">error</span><span class="op" id="4821485">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4821489">//&nbsp;WriteHeader&nbsp;sends&nbsp;an&nbsp;HTTP&nbsp;response&nbsp;header&nbsp;with&nbsp;status&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4821553">//&nbsp;If&nbsp;WriteHeader&nbsp;is&nbsp;not&nbsp;called&nbsp;explicitly,&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4821622">//&nbsp;will&nbsp;trigger&nbsp;an&nbsp;implicit&nbsp;WriteHeader(http.StatusOK).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4821679">//&nbsp;Thus&nbsp;explicit&nbsp;calls&nbsp;to&nbsp;WriteHeader&nbsp;are&nbsp;mainly&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4821737">//&nbsp;send&nbsp;error&nbsp;codes.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4821759">WriteHeader</span><span class="op" id="4821770">(</span><span class="builtintype" id="4821771">int</span><span class="op" id="4821774">)</span><br>
<span class="lineno"></span><span class="op" id="4821776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4821779">//&nbsp;The&nbsp;Flusher&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="4821849">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;flush&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno">80</span><span class="comment" id="4821906">//</span><br>
<span class="lineno"></span><span class="comment" id="4821909">//&nbsp;Note&nbsp;that&nbsp;even&nbsp;for&nbsp;ResponseWriters&nbsp;that&nbsp;support&nbsp;Flush,</span><br>
<span class="lineno"></span><span class="comment" id="4821967">//&nbsp;if&nbsp;the&nbsp;client&nbsp;is&nbsp;connected&nbsp;through&nbsp;an&nbsp;HTTP&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="4822020">//&nbsp;the&nbsp;buffered&nbsp;data&nbsp;may&nbsp;not&nbsp;reach&nbsp;the&nbsp;client&nbsp;until&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="4822085">//&nbsp;completes.</span><br>
<span class="lineno">85</span><span class="keyword" id="4822099">type</span>&nbsp;<span class="ident" id="4822104">Flusher</span>&nbsp;<span class="keyword" id="4822112">interface</span>&nbsp;<span class="op" id="4822122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4822125">//&nbsp;Flush&nbsp;sends&nbsp;any&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4822174">Flush</span><span class="op" id="4822179">(</span><span class="op" id="4822180">)</span><br>
<span class="lineno"></span><span class="op" id="4822182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="4822185">//&nbsp;The&nbsp;Hijacker&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="4822256">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4822304">type</span>&nbsp;<span class="ident" id="4822309">Hijacker</span>&nbsp;<span class="keyword" id="4822318">interface</span>&nbsp;<span class="op" id="4822328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4822331">//&nbsp;Hijack&nbsp;lets&nbsp;the&nbsp;caller&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4822384">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Hijack(),&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;library</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4822438">//&nbsp;will&nbsp;not&nbsp;do&nbsp;anything&nbsp;else&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4822489">//&nbsp;It&nbsp;becomes&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;manage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4822542">//&nbsp;and&nbsp;close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4822572">Hijack</span><span class="op" id="4822578">(</span><span class="op" id="4822579">)</span>&nbsp;<span class="op" id="4822581">(</span><span class="ident" id="4822582">net</span><span class="op" id="4822585">.</span><span class="ident" id="4822586">Conn</span><span class="op" id="4822590">,</span>&nbsp;<span class="op" id="4822592">*</span><span class="ident" id="4822593">bufio</span><span class="op" id="4822598">.</span><span class="ident" id="4822599">ReadWriter</span><span class="op" id="4822609">,</span>&nbsp;<span class="builtintype" id="4822611">error</span><span class="op" id="4822616">)</span><br>
<span class="lineno"></span><span class="op" id="4822618">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="4822621">//&nbsp;The&nbsp;CloseNotifier&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="4822692">//&nbsp;allow&nbsp;detecting&nbsp;when&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span><span class="comment" id="4822757">//</span><br>
<span class="lineno"></span><span class="comment" id="4822760">//&nbsp;This&nbsp;mechanism&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;cancel&nbsp;long&nbsp;operations&nbsp;on&nbsp;the&nbsp;server</span><br>
<span class="lineno">105</span><span class="comment" id="4822830">//&nbsp;if&nbsp;the&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;before&nbsp;the&nbsp;response&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="4822894">type</span>&nbsp;<span class="ident" id="4822899">CloseNotifier</span>&nbsp;<span class="keyword" id="4822913">interface</span>&nbsp;<span class="op" id="4822923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4822926">//&nbsp;CloseNotify&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;receives&nbsp;a&nbsp;single&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4822989">//&nbsp;when&nbsp;the&nbsp;client&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823035">CloseNotify</span><span class="op" id="4823046">(</span><span class="op" id="4823047">)</span>&nbsp;<span class="op" id="4823049">&lt;-</span><span class="keyword" id="4823051">chan</span>&nbsp;<span class="builtintype" id="4823056">bool</span><br>
<span class="lineno">110</span><span class="op" id="4823061">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4823064">//&nbsp;A&nbsp;conn&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4823124">type</span>&nbsp;<span class="ident" id="4823129">conn</span>&nbsp;<span class="keyword" id="4823134">struct</span>&nbsp;<span class="op" id="4823141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823144">remoteAddr</span>&nbsp;<span class="builtintype" id="4823155">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4823176">//&nbsp;network&nbsp;address&nbsp;of&nbsp;remote&nbsp;side</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823211">server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4823222">*</span><span class="ident" id="4823223">Server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4823243">//&nbsp;the&nbsp;Server&nbsp;on&nbsp;which&nbsp;the&nbsp;connection&nbsp;arrived</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823290">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4823301">net</span><span class="op" id="4823304">.</span><span class="ident" id="4823305">Conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4823322">//&nbsp;i/o&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823341">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4823352">io</span><span class="op" id="4823354">.</span><span class="ident" id="4823355">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4823373">//&nbsp;checkConnErrorWriter&#39;s&nbsp;copy&nbsp;of&nbsp;wrc,&nbsp;not&nbsp;zeroed&nbsp;on&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823434">werr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4823445">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4823466">//&nbsp;any&nbsp;errors&nbsp;writing&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823494">sr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4823505">liveSwitchReader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4823526">//&nbsp;where&nbsp;the&nbsp;LimitReader&nbsp;reads&nbsp;from;&nbsp;usually&nbsp;the&nbsp;rwc</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823580">lr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4823591">*</span><span class="ident" id="4823592">io</span><span class="op" id="4823594">.</span><span class="ident" id="4823595">LimitedReader</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4823612">//&nbsp;io.LimitReader(sr)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823635">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4823646">*</span><span class="ident" id="4823647">bufio</span><span class="op" id="4823652">.</span><span class="ident" id="4823653">ReadWriter</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4823667">//&nbsp;buffered(lr,rwc),&nbsp;reading&nbsp;from&nbsp;bufio-&gt;limitReader-&gt;sr-&gt;rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823730">tlsState</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4823741">*</span><span class="ident" id="4823742">tls</span><span class="op" id="4823745">.</span><span class="ident" id="4823746">ConnectionState</span>&nbsp;<span class="comment" id="4823762">//&nbsp;or&nbsp;nil&nbsp;when&nbsp;not&nbsp;using&nbsp;TLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823793">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4823806">sync</span><span class="op" id="4823810">.</span><span class="ident" id="4823811">Mutex</span>&nbsp;<span class="comment" id="4823817">//&nbsp;guards&nbsp;the&nbsp;following</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823842">clientGone</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4823855">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4823866">//&nbsp;if&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;mid-request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823909">closeNotifyc</span>&nbsp;<span class="keyword" id="4823922">chan</span>&nbsp;<span class="builtintype" id="4823927">bool</span>&nbsp;&nbsp;<span class="comment" id="4823933">//&nbsp;made&nbsp;lazily</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4823949">hijackedv</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4823962">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4823973">//&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked&nbsp;by&nbsp;handler</span><br>
<span class="lineno"></span><span class="op" id="4824016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="4824019">func</span>&nbsp;<span class="op" id="4824024">(</span><span class="ident" id="4824025">c</span>&nbsp;<span class="op" id="4824027">*</span><span class="ident" id="4824028">conn</span><span class="op" id="4824032">)</span>&nbsp;<span class="ident" id="4824034">hijacked</span><span class="op" id="4824042">(</span><span class="op" id="4824043">)</span>&nbsp;<span class="builtintype" id="4824045">bool</span>&nbsp;<span class="op" id="4824050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824053">c</span><span class="op" id="4824054">.</span><span class="ident" id="4824055">mu</span><span class="op" id="4824057">.</span><span class="ident" id="4824058">Lock</span><span class="op" id="4824062">(</span><span class="op" id="4824063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824066">defer</span>&nbsp;<span class="ident" id="4824072">c</span><span class="op" id="4824073">.</span><span class="ident" id="4824074">mu</span><span class="op" id="4824076">.</span><span class="ident" id="4824077">Unlock</span><span class="op" id="4824083">(</span><span class="op" id="4824084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824087">return</span>&nbsp;<span class="ident" id="4824094">c</span><span class="op" id="4824095">.</span><span class="ident" id="4824096">hijackedv</span><br>
<span class="lineno"></span><span class="op" id="4824106">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="4824109">func</span>&nbsp;<span class="op" id="4824114">(</span><span class="ident" id="4824115">c</span>&nbsp;<span class="op" id="4824117">*</span><span class="ident" id="4824118">conn</span><span class="op" id="4824122">)</span>&nbsp;<span class="ident" id="4824124">hijack</span><span class="op" id="4824130">(</span><span class="op" id="4824131">)</span>&nbsp;<span class="op" id="4824133">(</span><span class="ident" id="4824134">rwc</span>&nbsp;<span class="ident" id="4824138">net</span><span class="op" id="4824141">.</span><span class="ident" id="4824142">Conn</span><span class="op" id="4824146">,</span>&nbsp;<span class="ident" id="4824148">buf</span>&nbsp;<span class="op" id="4824152">*</span><span class="ident" id="4824153">bufio</span><span class="op" id="4824158">.</span><span class="ident" id="4824159">ReadWriter</span><span class="op" id="4824169">,</span>&nbsp;<span class="ident" id="4824171">err</span>&nbsp;<span class="builtintype" id="4824175">error</span><span class="op" id="4824180">)</span>&nbsp;<span class="op" id="4824182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824185">c</span><span class="op" id="4824186">.</span><span class="ident" id="4824187">mu</span><span class="op" id="4824189">.</span><span class="ident" id="4824190">Lock</span><span class="op" id="4824194">(</span><span class="op" id="4824195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824198">defer</span>&nbsp;<span class="ident" id="4824204">c</span><span class="op" id="4824205">.</span><span class="ident" id="4824206">mu</span><span class="op" id="4824208">.</span><span class="ident" id="4824209">Unlock</span><span class="op" id="4824215">(</span><span class="op" id="4824216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824219">if</span>&nbsp;<span class="ident" id="4824222">c</span><span class="op" id="4824223">.</span><span class="ident" id="4824224">hijackedv</span>&nbsp;<span class="op" id="4824234">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824238">return</span>&nbsp;<span class="ident" id="4824245">nil</span><span class="op" id="4824248">,</span>&nbsp;<span class="ident" id="4824250">nil</span><span class="op" id="4824253">,</span>&nbsp;<span class="ident" id="4824255">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4824268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824271">if</span>&nbsp;<span class="ident" id="4824274">c</span><span class="op" id="4824275">.</span><span class="ident" id="4824276">closeNotifyc</span>&nbsp;<span class="op" id="4824289">!=</span>&nbsp;<span class="ident" id="4824292">nil</span>&nbsp;<span class="op" id="4824296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824300">return</span>&nbsp;<span class="ident" id="4824307">nil</span><span class="op" id="4824310">,</span>&nbsp;<span class="ident" id="4824312">nil</span><span class="op" id="4824315">,</span>&nbsp;<span class="ident" id="4824317">errors</span><span class="op" id="4824323">.</span><span class="ident" id="4824324">New</span><span class="op" id="4824327">(</span><span class="string" id="4824328">&#34;http:&nbsp;Hijack&nbsp;is&nbsp;incompatible&nbsp;with&nbsp;use&nbsp;of&nbsp;CloseNotifier&#34;</span><span class="op" id="4824384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4824387">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824390">c</span><span class="op" id="4824391">.</span><span class="ident" id="4824392">hijackedv</span>&nbsp;<span class="op" id="4824402">=</span>&nbsp;<span class="builtintype" id="4824404">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824410">rwc</span>&nbsp;<span class="op" id="4824414">=</span>&nbsp;<span class="ident" id="4824416">c</span><span class="op" id="4824417">.</span><span class="ident" id="4824418">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824423">buf</span>&nbsp;<span class="op" id="4824427">=</span>&nbsp;<span class="ident" id="4824429">c</span><span class="op" id="4824430">.</span><span class="ident" id="4824431">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824436">c</span><span class="op" id="4824437">.</span><span class="ident" id="4824438">rwc</span>&nbsp;<span class="op" id="4824442">=</span>&nbsp;<span class="ident" id="4824444">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824449">c</span><span class="op" id="4824450">.</span><span class="ident" id="4824451">buf</span>&nbsp;<span class="op" id="4824455">=</span>&nbsp;<span class="ident" id="4824457">nil</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824462">c</span><span class="op" id="4824463">.</span><span class="ident" id="4824464">setState</span><span class="op" id="4824472">(</span><span class="ident" id="4824473">rwc</span><span class="op" id="4824476">,</span>&nbsp;<span class="ident" id="4824478">StateHijacked</span><span class="op" id="4824491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824494">return</span><br>
<span class="lineno"></span><span class="op" id="4824501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4824504">func</span>&nbsp;<span class="op" id="4824509">(</span><span class="ident" id="4824510">c</span>&nbsp;<span class="op" id="4824512">*</span><span class="ident" id="4824513">conn</span><span class="op" id="4824517">)</span>&nbsp;<span class="ident" id="4824519">closeNotify</span><span class="op" id="4824530">(</span><span class="op" id="4824531">)</span>&nbsp;<span class="op" id="4824533">&lt;-</span><span class="keyword" id="4824535">chan</span>&nbsp;<span class="builtintype" id="4824540">bool</span>&nbsp;<span class="op" id="4824545">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824548">c</span><span class="op" id="4824549">.</span><span class="ident" id="4824550">mu</span><span class="op" id="4824552">.</span><span class="ident" id="4824553">Lock</span><span class="op" id="4824557">(</span><span class="op" id="4824558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824561">defer</span>&nbsp;<span class="ident" id="4824567">c</span><span class="op" id="4824568">.</span><span class="ident" id="4824569">mu</span><span class="op" id="4824571">.</span><span class="ident" id="4824572">Unlock</span><span class="op" id="4824578">(</span><span class="op" id="4824579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824582">if</span>&nbsp;<span class="ident" id="4824585">c</span><span class="op" id="4824586">.</span><span class="ident" id="4824587">closeNotifyc</span>&nbsp;<span class="op" id="4824600">==</span>&nbsp;<span class="ident" id="4824603">nil</span>&nbsp;<span class="op" id="4824607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824611">c</span><span class="op" id="4824612">.</span><span class="ident" id="4824613">closeNotifyc</span>&nbsp;<span class="op" id="4824626">=</span>&nbsp;<span class="builtinfunc" id="4824628">make</span><span class="op" id="4824632">(</span><span class="keyword" id="4824633">chan</span>&nbsp;<span class="builtintype" id="4824638">bool</span><span class="op" id="4824642">,</span>&nbsp;<span class="num" id="4824644">1</span><span class="op" id="4824645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824649">if</span>&nbsp;<span class="ident" id="4824652">c</span><span class="op" id="4824653">.</span><span class="ident" id="4824654">hijackedv</span>&nbsp;<span class="op" id="4824664">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4824669">//&nbsp;to&nbsp;obey&nbsp;the&nbsp;function&nbsp;signature,&nbsp;even&nbsp;though</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4824719">//&nbsp;it&#39;ll&nbsp;never&nbsp;receive&nbsp;a&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824754">return</span>&nbsp;<span class="ident" id="4824761">c</span><span class="op" id="4824762">.</span><span class="ident" id="4824763">closeNotifyc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4824778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824782">pr</span><span class="op" id="4824784">,</span>&nbsp;<span class="ident" id="4824786">pw</span>&nbsp;<span class="op" id="4824789">:=</span>&nbsp;<span class="ident" id="4824792">io</span><span class="op" id="4824794">.</span><span class="ident" id="4824795">Pipe</span><span class="op" id="4824799">(</span><span class="op" id="4824800">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824805">readSource</span>&nbsp;<span class="op" id="4824816">:=</span>&nbsp;<span class="ident" id="4824819">c</span><span class="op" id="4824820">.</span><span class="ident" id="4824821">sr</span><span class="op" id="4824823">.</span><span class="ident" id="4824824">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824828">c</span><span class="op" id="4824829">.</span><span class="ident" id="4824830">sr</span><span class="op" id="4824832">.</span><span class="ident" id="4824833">Lock</span><span class="op" id="4824837">(</span><span class="op" id="4824838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824842">c</span><span class="op" id="4824843">.</span><span class="ident" id="4824844">sr</span><span class="op" id="4824846">.</span><span class="ident" id="4824847">r</span>&nbsp;<span class="op" id="4824849">=</span>&nbsp;<span class="ident" id="4824851">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824856">c</span><span class="op" id="4824857">.</span><span class="ident" id="4824858">sr</span><span class="op" id="4824860">.</span><span class="ident" id="4824861">Unlock</span><span class="op" id="4824867">(</span><span class="op" id="4824868">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824872">go</span>&nbsp;<span class="keyword" id="4824875">func</span><span class="op" id="4824879">(</span><span class="op" id="4824880">)</span>&nbsp;<span class="op" id="4824882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824887">_</span><span class="op" id="4824888">,</span>&nbsp;<span class="ident" id="4824890">err</span>&nbsp;<span class="op" id="4824894">:=</span>&nbsp;<span class="ident" id="4824897">io</span><span class="op" id="4824899">.</span><span class="ident" id="4824900">Copy</span><span class="op" id="4824904">(</span><span class="ident" id="4824905">pw</span><span class="op" id="4824907">,</span>&nbsp;<span class="ident" id="4824909">readSource</span><span class="op" id="4824919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4824924">if</span>&nbsp;<span class="ident" id="4824927">err</span>&nbsp;<span class="op" id="4824931">==</span>&nbsp;<span class="ident" id="4824934">nil</span>&nbsp;<span class="op" id="4824938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824944">err</span>&nbsp;<span class="op" id="4824948">=</span>&nbsp;<span class="ident" id="4824950">io</span><span class="op" id="4824952">.</span><span class="ident" id="4824953">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4824960">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824965">pw</span><span class="op" id="4824967">.</span><span class="ident" id="4824968">CloseWithError</span><span class="op" id="4824982">(</span><span class="ident" id="4824983">err</span><span class="op" id="4824986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4824991">c</span><span class="op" id="4824992">.</span><span class="ident" id="4824993">noteClientGone</span><span class="op" id="4825007">(</span><span class="op" id="4825008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4825012">}</span><span class="op" id="4825013">(</span><span class="op" id="4825014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4825017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825020">return</span>&nbsp;<span class="ident" id="4825027">c</span><span class="op" id="4825028">.</span><span class="ident" id="4825029">closeNotifyc</span><br>
<span class="lineno">180</span><span class="op" id="4825042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4825045">func</span>&nbsp;<span class="op" id="4825050">(</span><span class="ident" id="4825051">c</span>&nbsp;<span class="op" id="4825053">*</span><span class="ident" id="4825054">conn</span><span class="op" id="4825058">)</span>&nbsp;<span class="ident" id="4825060">noteClientGone</span><span class="op" id="4825074">(</span><span class="op" id="4825075">)</span>&nbsp;<span class="op" id="4825077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4825080">c</span><span class="op" id="4825081">.</span><span class="ident" id="4825082">mu</span><span class="op" id="4825084">.</span><span class="ident" id="4825085">Lock</span><span class="op" id="4825089">(</span><span class="op" id="4825090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825093">defer</span>&nbsp;<span class="ident" id="4825099">c</span><span class="op" id="4825100">.</span><span class="ident" id="4825101">mu</span><span class="op" id="4825103">.</span><span class="ident" id="4825104">Unlock</span><span class="op" id="4825110">(</span><span class="op" id="4825111">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825114">if</span>&nbsp;<span class="ident" id="4825117">c</span><span class="op" id="4825118">.</span><span class="ident" id="4825119">closeNotifyc</span>&nbsp;<span class="op" id="4825132">!=</span>&nbsp;<span class="ident" id="4825135">nil</span>&nbsp;<span class="op" id="4825139">&amp;&amp;</span>&nbsp;<span class="op" id="4825142">!</span><span class="ident" id="4825143">c</span><span class="op" id="4825144">.</span><span class="ident" id="4825145">clientGone</span>&nbsp;<span class="op" id="4825156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4825160">c</span><span class="op" id="4825161">.</span><span class="ident" id="4825162">closeNotifyc</span>&nbsp;<span class="op" id="4825175">&lt;-</span>&nbsp;<span class="builtintype" id="4825178">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4825184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4825187">c</span><span class="op" id="4825188">.</span><span class="ident" id="4825189">clientGone</span>&nbsp;<span class="op" id="4825200">=</span>&nbsp;<span class="builtintype" id="4825202">true</span><br>
<span class="lineno"></span><span class="op" id="4825207">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="4825210">//&nbsp;A&nbsp;switchReader&nbsp;can&nbsp;have&nbsp;its&nbsp;Reader&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="4825268">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Reads&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="4825320">type</span>&nbsp;<span class="ident" id="4825325">switchReader</span>&nbsp;<span class="keyword" id="4825338">struct</span>&nbsp;<span class="op" id="4825345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4825348">io</span><span class="op" id="4825350">.</span><span class="ident" id="4825351">Reader</span><br>
<span class="lineno">195</span><span class="op" id="4825358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4825361">//&nbsp;A&nbsp;switchWriter&nbsp;can&nbsp;have&nbsp;its&nbsp;Writer&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="4825419">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Writes&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="4825472">type</span>&nbsp;<span class="ident" id="4825477">switchWriter</span>&nbsp;<span class="keyword" id="4825490">struct</span>&nbsp;<span class="op" id="4825497">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4825500">io</span><span class="op" id="4825502">.</span><span class="ident" id="4825503">Writer</span><br>
<span class="lineno"></span><span class="op" id="4825510">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4825513">//&nbsp;A&nbsp;liveSwitchReader&nbsp;is&nbsp;a&nbsp;switchReader&nbsp;that&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent</span><br>
<span class="lineno"></span><span class="comment" id="4825580">//&nbsp;reads&nbsp;and&nbsp;switches,&nbsp;if&nbsp;its&nbsp;mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno">205</span><span class="keyword" id="4825625">type</span>&nbsp;<span class="ident" id="4825630">liveSwitchReader</span>&nbsp;<span class="keyword" id="4825647">struct</span>&nbsp;<span class="op" id="4825654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4825657">sync</span><span class="op" id="4825661">.</span><span class="ident" id="4825662">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4825669">r</span>&nbsp;<span class="ident" id="4825671">io</span><span class="op" id="4825673">.</span><span class="ident" id="4825674">Reader</span><br>
<span class="lineno"></span><span class="op" id="4825681">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="keyword" id="4825684">func</span>&nbsp;<span class="op" id="4825689">(</span><span class="ident" id="4825690">sr</span>&nbsp;<span class="op" id="4825693">*</span><span class="ident" id="4825694">liveSwitchReader</span><span class="op" id="4825710">)</span>&nbsp;<span class="ident" id="4825712">Read</span><span class="op" id="4825716">(</span><span class="ident" id="4825717">p</span>&nbsp;<span class="op" id="4825719">[</span><span class="op" id="4825720">]</span><span class="builtintype" id="4825721">byte</span><span class="op" id="4825725">)</span>&nbsp;<span class="op" id="4825727">(</span><span class="ident" id="4825728">n</span>&nbsp;<span class="builtintype" id="4825730">int</span><span class="op" id="4825733">,</span>&nbsp;<span class="ident" id="4825735">err</span>&nbsp;<span class="builtintype" id="4825739">error</span><span class="op" id="4825744">)</span>&nbsp;<span class="op" id="4825746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4825749">sr</span><span class="op" id="4825751">.</span><span class="ident" id="4825752">Lock</span><span class="op" id="4825756">(</span><span class="op" id="4825757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4825760">r</span>&nbsp;<span class="op" id="4825762">:=</span>&nbsp;<span class="ident" id="4825765">sr</span><span class="op" id="4825767">.</span><span class="ident" id="4825768">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4825771">sr</span><span class="op" id="4825773">.</span><span class="ident" id="4825774">Unlock</span><span class="op" id="4825780">(</span><span class="op" id="4825781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4825784">return</span>&nbsp;<span class="ident" id="4825791">r</span><span class="op" id="4825792">.</span><span class="ident" id="4825793">Read</span><span class="op" id="4825797">(</span><span class="ident" id="4825798">p</span><span class="op" id="4825799">)</span><br>
<span class="lineno">215</span><span class="op" id="4825801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4825804">//&nbsp;This&nbsp;should&nbsp;be&nbsp;&gt;=&nbsp;512&nbsp;bytes&nbsp;for&nbsp;DetectContentType,</span><br>
<span class="lineno"></span><span class="comment" id="4825858">//&nbsp;but&nbsp;otherwise&nbsp;it&#39;s&nbsp;somewhat&nbsp;arbitrary.</span><br>
<span class="lineno"></span><span class="keyword" id="4825900">const</span>&nbsp;<span class="ident" id="4825906">bufferBeforeChunkingSize</span>&nbsp;<span class="op" id="4825931">=</span>&nbsp;<span class="num" id="4825933">2048</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="4825939">//&nbsp;chunkWriter&nbsp;writes&nbsp;to&nbsp;a&nbsp;response&#39;s&nbsp;conn&nbsp;buffer,&nbsp;and&nbsp;is&nbsp;the&nbsp;writer</span><br>
<span class="lineno"></span><span class="comment" id="4826008">//&nbsp;wrapped&nbsp;by&nbsp;the&nbsp;response.bufw&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="4826057">//</span><br>
<span class="lineno"></span><span class="comment" id="4826060">//&nbsp;chunkWriter&nbsp;also&nbsp;is&nbsp;responsible&nbsp;for&nbsp;finalizing&nbsp;the&nbsp;Header,&nbsp;including</span><br>
<span class="lineno">225</span><span class="comment" id="4826132">//&nbsp;conditionally&nbsp;setting&nbsp;the&nbsp;Content-Type&nbsp;and&nbsp;setting&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span><span class="comment" id="4826203">//&nbsp;in&nbsp;cases&nbsp;where&nbsp;the&nbsp;handler&#39;s&nbsp;final&nbsp;output&nbsp;is&nbsp;smaller&nbsp;than&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="4826275">//&nbsp;size.&nbsp;It&nbsp;also&nbsp;conditionally&nbsp;adds&nbsp;chunk&nbsp;headers,&nbsp;when&nbsp;in&nbsp;chunking&nbsp;mode.</span><br>
<span class="lineno"></span><span class="comment" id="4826349">//</span><br>
<span class="lineno"></span><span class="comment" id="4826352">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;above&nbsp;(*response).Write&nbsp;for&nbsp;the&nbsp;entire&nbsp;write&nbsp;flow.</span><br>
<span class="lineno">230</span><span class="keyword" id="4826422">type</span>&nbsp;<span class="ident" id="4826427">chunkWriter</span>&nbsp;<span class="keyword" id="4826439">struct</span>&nbsp;<span class="op" id="4826446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826449">res</span>&nbsp;<span class="op" id="4826453">*</span><span class="ident" id="4826454">response</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4826465">//&nbsp;header&nbsp;is&nbsp;either&nbsp;nil&nbsp;or&nbsp;a&nbsp;deep&nbsp;clone&nbsp;of&nbsp;res.handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4826527">//&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;res.WriteHeader,&nbsp;if&nbsp;res.WriteHeader&nbsp;is</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4826585">//&nbsp;called&nbsp;and&nbsp;extra&nbsp;buffering&nbsp;is&nbsp;being&nbsp;done&nbsp;to&nbsp;calculate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4826643">//&nbsp;Content-Type&nbsp;and/or&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826683">header</span>&nbsp;<span class="ident" id="4826690">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4826699">//&nbsp;wroteHeader&nbsp;tells&nbsp;whether&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;written&nbsp;to&nbsp;&#34;the</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4826763">//&nbsp;wire&#34;&nbsp;(or&nbsp;rather:&nbsp;w.conn.buf).&nbsp;this&nbsp;is&nbsp;unlike</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4826813">//&nbsp;(*response).wroteHeader,&nbsp;which&nbsp;tells&nbsp;only&nbsp;whether&nbsp;it&nbsp;was</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4826874">//&nbsp;logically&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826897">wroteHeader</span>&nbsp;<span class="builtintype" id="4826909">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4826916">//&nbsp;set&nbsp;by&nbsp;the&nbsp;writeHeader&nbsp;method:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4826951">chunking</span>&nbsp;<span class="builtintype" id="4826960">bool</span>&nbsp;<span class="comment" id="4826965">//&nbsp;using&nbsp;chunked&nbsp;transfer&nbsp;encoding&nbsp;for&nbsp;reply&nbsp;body</span><br>
<span class="lineno"></span><span class="op" id="4827015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4827018">var</span>&nbsp;<span class="op" id="4827022">(</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827025">crlf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4827036">=</span>&nbsp;<span class="op" id="4827038">[</span><span class="op" id="4827039">]</span><span class="builtintype" id="4827040">byte</span><span class="op" id="4827044">(</span><span class="string" id="4827045">&#34;\r\n&#34;</span><span class="op" id="4827051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827054">colonSpace</span>&nbsp;<span class="op" id="4827065">=</span>&nbsp;<span class="op" id="4827067">[</span><span class="op" id="4827068">]</span><span class="builtintype" id="4827069">byte</span><span class="op" id="4827073">(</span><span class="string" id="4827074">&#34;:&nbsp;&#34;</span><span class="op" id="4827078">)</span><br>
<span class="lineno"></span><span class="op" id="4827080">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4827083">func</span>&nbsp;<span class="op" id="4827088">(</span><span class="ident" id="4827089">cw</span>&nbsp;<span class="op" id="4827092">*</span><span class="ident" id="4827093">chunkWriter</span><span class="op" id="4827104">)</span>&nbsp;<span class="ident" id="4827106">Write</span><span class="op" id="4827111">(</span><span class="ident" id="4827112">p</span>&nbsp;<span class="op" id="4827114">[</span><span class="op" id="4827115">]</span><span class="builtintype" id="4827116">byte</span><span class="op" id="4827120">)</span>&nbsp;<span class="op" id="4827122">(</span><span class="ident" id="4827123">n</span>&nbsp;<span class="builtintype" id="4827125">int</span><span class="op" id="4827128">,</span>&nbsp;<span class="ident" id="4827130">err</span>&nbsp;<span class="builtintype" id="4827134">error</span><span class="op" id="4827139">)</span>&nbsp;<span class="op" id="4827141">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827144">if</span>&nbsp;<span class="op" id="4827147">!</span><span class="ident" id="4827148">cw</span><span class="op" id="4827150">.</span><span class="ident" id="4827151">wroteHeader</span>&nbsp;<span class="op" id="4827163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827167">cw</span><span class="op" id="4827169">.</span><span class="ident" id="4827170">writeHeader</span><span class="op" id="4827181">(</span><span class="ident" id="4827182">p</span><span class="op" id="4827183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4827186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827189">if</span>&nbsp;<span class="ident" id="4827192">cw</span><span class="op" id="4827194">.</span><span class="ident" id="4827195">res</span><span class="op" id="4827198">.</span><span class="ident" id="4827199">req</span><span class="op" id="4827202">.</span><span class="ident" id="4827203">Method</span>&nbsp;<span class="op" id="4827210">==</span>&nbsp;<span class="string" id="4827213">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4827220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4827224">//&nbsp;Eat&nbsp;writes.</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827241">return</span>&nbsp;<span class="builtinfunc" id="4827248">len</span><span class="op" id="4827251">(</span><span class="ident" id="4827252">p</span><span class="op" id="4827253">)</span><span class="op" id="4827254">,</span>&nbsp;<span class="ident" id="4827256">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4827261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827264">if</span>&nbsp;<span class="ident" id="4827267">cw</span><span class="op" id="4827269">.</span><span class="ident" id="4827270">chunking</span>&nbsp;<span class="op" id="4827279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827283">_</span><span class="op" id="4827284">,</span>&nbsp;<span class="ident" id="4827286">err</span>&nbsp;<span class="op" id="4827290">=</span>&nbsp;<span class="ident" id="4827292">fmt</span><span class="op" id="4827295">.</span><span class="ident" id="4827296">Fprintf</span><span class="op" id="4827303">(</span><span class="ident" id="4827304">cw</span><span class="op" id="4827306">.</span><span class="ident" id="4827307">res</span><span class="op" id="4827310">.</span><span class="ident" id="4827311">conn</span><span class="op" id="4827315">.</span><span class="ident" id="4827316">buf</span><span class="op" id="4827319">,</span>&nbsp;<span class="string" id="4827321">&#34;%x\r\n&#34;</span><span class="op" id="4827329">,</span>&nbsp;<span class="builtinfunc" id="4827331">len</span><span class="op" id="4827334">(</span><span class="ident" id="4827335">p</span><span class="op" id="4827336">)</span><span class="op" id="4827337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827341">if</span>&nbsp;<span class="ident" id="4827344">err</span>&nbsp;<span class="op" id="4827348">!=</span>&nbsp;<span class="ident" id="4827351">nil</span>&nbsp;<span class="op" id="4827355">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827360">cw</span><span class="op" id="4827362">.</span><span class="ident" id="4827363">res</span><span class="op" id="4827366">.</span><span class="ident" id="4827367">conn</span><span class="op" id="4827371">.</span><span class="ident" id="4827372">rwc</span><span class="op" id="4827375">.</span><span class="ident" id="4827376">Close</span><span class="op" id="4827381">(</span><span class="op" id="4827382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827387">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4827396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4827399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827402">n</span><span class="op" id="4827403">,</span>&nbsp;<span class="ident" id="4827405">err</span>&nbsp;<span class="op" id="4827409">=</span>&nbsp;<span class="ident" id="4827411">cw</span><span class="op" id="4827413">.</span><span class="ident" id="4827414">res</span><span class="op" id="4827417">.</span><span class="ident" id="4827418">conn</span><span class="op" id="4827422">.</span><span class="ident" id="4827423">buf</span><span class="op" id="4827426">.</span><span class="ident" id="4827427">Write</span><span class="op" id="4827432">(</span><span class="ident" id="4827433">p</span><span class="op" id="4827434">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827437">if</span>&nbsp;<span class="ident" id="4827440">cw</span><span class="op" id="4827442">.</span><span class="ident" id="4827443">chunking</span>&nbsp;<span class="op" id="4827452">&amp;&amp;</span>&nbsp;<span class="ident" id="4827455">err</span>&nbsp;<span class="op" id="4827459">==</span>&nbsp;<span class="ident" id="4827462">nil</span>&nbsp;<span class="op" id="4827466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827470">_</span><span class="op" id="4827471">,</span>&nbsp;<span class="ident" id="4827473">err</span>&nbsp;<span class="op" id="4827477">=</span>&nbsp;<span class="ident" id="4827479">cw</span><span class="op" id="4827481">.</span><span class="ident" id="4827482">res</span><span class="op" id="4827485">.</span><span class="ident" id="4827486">conn</span><span class="op" id="4827490">.</span><span class="ident" id="4827491">buf</span><span class="op" id="4827494">.</span><span class="ident" id="4827495">Write</span><span class="op" id="4827500">(</span><span class="ident" id="4827501">crlf</span><span class="op" id="4827505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4827508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827511">if</span>&nbsp;<span class="ident" id="4827514">err</span>&nbsp;<span class="op" id="4827518">!=</span>&nbsp;<span class="ident" id="4827521">nil</span>&nbsp;<span class="op" id="4827525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827529">cw</span><span class="op" id="4827531">.</span><span class="ident" id="4827532">res</span><span class="op" id="4827535">.</span><span class="ident" id="4827536">conn</span><span class="op" id="4827540">.</span><span class="ident" id="4827541">rwc</span><span class="op" id="4827544">.</span><span class="ident" id="4827545">Close</span><span class="op" id="4827550">(</span><span class="op" id="4827551">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4827554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827557">return</span><br>
<span class="lineno"></span><span class="op" id="4827564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4827567">func</span>&nbsp;<span class="op" id="4827572">(</span><span class="ident" id="4827573">cw</span>&nbsp;<span class="op" id="4827576">*</span><span class="ident" id="4827577">chunkWriter</span><span class="op" id="4827588">)</span>&nbsp;<span class="ident" id="4827590">flush</span><span class="op" id="4827595">(</span><span class="op" id="4827596">)</span>&nbsp;<span class="op" id="4827598">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827601">if</span>&nbsp;<span class="op" id="4827604">!</span><span class="ident" id="4827605">cw</span><span class="op" id="4827607">.</span><span class="ident" id="4827608">wroteHeader</span>&nbsp;<span class="op" id="4827620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827624">cw</span><span class="op" id="4827626">.</span><span class="ident" id="4827627">writeHeader</span><span class="op" id="4827638">(</span><span class="ident" id="4827639">nil</span><span class="op" id="4827642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4827645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827648">cw</span><span class="op" id="4827650">.</span><span class="ident" id="4827651">res</span><span class="op" id="4827654">.</span><span class="ident" id="4827655">conn</span><span class="op" id="4827659">.</span><span class="ident" id="4827660">buf</span><span class="op" id="4827663">.</span><span class="ident" id="4827664">Flush</span><span class="op" id="4827669">(</span><span class="op" id="4827670">)</span><br>
<span class="lineno"></span><span class="op" id="4827672">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="4827675">func</span>&nbsp;<span class="op" id="4827680">(</span><span class="ident" id="4827681">cw</span>&nbsp;<span class="op" id="4827684">*</span><span class="ident" id="4827685">chunkWriter</span><span class="op" id="4827696">)</span>&nbsp;<span class="builtinfunc" id="4827698">close</span><span class="op" id="4827703">(</span><span class="op" id="4827704">)</span>&nbsp;<span class="op" id="4827706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827709">if</span>&nbsp;<span class="op" id="4827712">!</span><span class="ident" id="4827713">cw</span><span class="op" id="4827715">.</span><span class="ident" id="4827716">wroteHeader</span>&nbsp;<span class="op" id="4827728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827732">cw</span><span class="op" id="4827734">.</span><span class="ident" id="4827735">writeHeader</span><span class="op" id="4827746">(</span><span class="ident" id="4827747">nil</span><span class="op" id="4827750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4827753">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4827756">if</span>&nbsp;<span class="ident" id="4827759">cw</span><span class="op" id="4827761">.</span><span class="ident" id="4827762">chunking</span>&nbsp;<span class="op" id="4827771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4827775">//&nbsp;zero&nbsp;EOF&nbsp;chunk,&nbsp;trailer&nbsp;key/value&nbsp;pairs&nbsp;(currently</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4827831">//&nbsp;unsupported&nbsp;in&nbsp;Go&#39;s&nbsp;server),&nbsp;followed&nbsp;by&nbsp;a&nbsp;blank</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4827885">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4827896">cw</span><span class="op" id="4827898">.</span><span class="ident" id="4827899">res</span><span class="op" id="4827902">.</span><span class="ident" id="4827903">conn</span><span class="op" id="4827907">.</span><span class="ident" id="4827908">buf</span><span class="op" id="4827911">.</span><span class="ident" id="4827912">WriteString</span><span class="op" id="4827923">(</span><span class="string" id="4827924">&#34;0\r\n\r\n&#34;</span><span class="op" id="4827935">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4827938">}</span><br>
<span class="lineno"></span><span class="op" id="4827940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4827943">//&nbsp;A&nbsp;response&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="4828005">type</span>&nbsp;<span class="ident" id="4828010">response</span>&nbsp;<span class="keyword" id="4828019">struct</span>&nbsp;<span class="op" id="4828026">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828029">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4828043">*</span><span class="ident" id="4828044">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828050">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4828064">*</span><span class="ident" id="4828065">Request</span>&nbsp;<span class="comment" id="4828073">//&nbsp;request&nbsp;for&nbsp;this&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828103">wroteHeader</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4828117">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4828126">//&nbsp;reply&nbsp;header&nbsp;has&nbsp;been&nbsp;(logically)&nbsp;written</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828172">wroteContinue</span>&nbsp;<span class="builtintype" id="4828186">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4828195">//&nbsp;100&nbsp;Continue&nbsp;response&nbsp;was&nbsp;written</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828234">w</span>&nbsp;&nbsp;<span class="op" id="4828237">*</span><span class="ident" id="4828238">bufio</span><span class="op" id="4828243">.</span><span class="ident" id="4828244">Writer</span>&nbsp;<span class="comment" id="4828251">//&nbsp;buffers&nbsp;output&nbsp;in&nbsp;chunks&nbsp;to&nbsp;chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828295">cw</span>&nbsp;<span class="ident" id="4828298">chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828311">sw</span>&nbsp;<span class="op" id="4828314">*</span><span class="ident" id="4828315">switchWriter</span>&nbsp;<span class="comment" id="4828328">//&nbsp;of&nbsp;the&nbsp;bufio.Writer,&nbsp;for&nbsp;return&nbsp;to&nbsp;putBufioWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4828383">//&nbsp;handlerHeader&nbsp;is&nbsp;the&nbsp;Header&nbsp;that&nbsp;Handlers&nbsp;get&nbsp;access&nbsp;to,</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4828444">//&nbsp;which&nbsp;may&nbsp;be&nbsp;retained&nbsp;and&nbsp;mutated&nbsp;even&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4828506">//&nbsp;handlerHeader&nbsp;is&nbsp;copied&nbsp;into&nbsp;cw.header&nbsp;at&nbsp;WriteHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4828564">//&nbsp;time,&nbsp;and&nbsp;privately&nbsp;mutated&nbsp;thereafter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828608">handlerHeader</span>&nbsp;<span class="ident" id="4828622">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828630">calledHeader</span>&nbsp;&nbsp;<span class="builtintype" id="4828644">bool</span>&nbsp;<span class="comment" id="4828649">//&nbsp;handler&nbsp;accessed&nbsp;handlerHeader&nbsp;via&nbsp;Header</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828696">written</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4828710">int64</span>&nbsp;<span class="comment" id="4828716">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;in&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828752">contentLength</span>&nbsp;<span class="ident" id="4828766">int64</span>&nbsp;<span class="comment" id="4828772">//&nbsp;explicitly-declared&nbsp;Content-Length;&nbsp;or&nbsp;-1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4828818">status</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4828832">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4828838">//&nbsp;status&nbsp;code&nbsp;passed&nbsp;to&nbsp;WriteHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4828877">//&nbsp;close&nbsp;connection&nbsp;after&nbsp;this&nbsp;reply.&nbsp;&nbsp;set&nbsp;on&nbsp;request&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4828936">//&nbsp;updated&nbsp;after&nbsp;response&nbsp;from&nbsp;handler&nbsp;if&nbsp;there&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4828989">//&nbsp;&#34;Connection:&nbsp;keep-alive&#34;&nbsp;response&nbsp;header&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4829040">//&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4829060">closeAfterReply</span>&nbsp;<span class="builtintype" id="4829076">bool</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4829083">//&nbsp;requestBodyLimitHit&nbsp;is&nbsp;set&nbsp;by&nbsp;requestTooLarge&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4829138">//&nbsp;maxBytesReader&nbsp;hits&nbsp;its&nbsp;max&nbsp;size.&nbsp;It&nbsp;is&nbsp;checked&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4829193">//&nbsp;WriteHeader,&nbsp;to&nbsp;make&nbsp;sure&nbsp;we&nbsp;don&#39;t&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4829244">//&nbsp;remaining&nbsp;request&nbsp;body&nbsp;to&nbsp;try&nbsp;to&nbsp;advance&nbsp;to&nbsp;the&nbsp;next&nbsp;HTTP</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4829306">//&nbsp;request.&nbsp;Instead,&nbsp;when&nbsp;this&nbsp;is&nbsp;set,&nbsp;we&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4829362">//&nbsp;subsequent&nbsp;requests&nbsp;on&nbsp;this&nbsp;connection&nbsp;and&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4829422">//&nbsp;input&nbsp;from&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4829441">requestBodyLimitHit</span>&nbsp;<span class="builtintype" id="4829461">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4829468">handlerDone</span>&nbsp;<span class="builtintype" id="4829480">bool</span>&nbsp;<span class="comment" id="4829485">//&nbsp;set&nbsp;true&nbsp;when&nbsp;the&nbsp;handler&nbsp;exits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4829522">//&nbsp;Buffers&nbsp;for&nbsp;Date&nbsp;and&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4829562">dateBuf</span>&nbsp;<span class="op" id="4829570">[</span><span class="builtinfunc" id="4829571">len</span><span class="op" id="4829574">(</span><span class="ident" id="4829575">TimeFormat</span><span class="op" id="4829585">)</span><span class="op" id="4829586">]</span><span class="builtintype" id="4829587">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4829593">clenBuf</span>&nbsp;<span class="op" id="4829601">[</span><span class="num" id="4829602">10</span><span class="op" id="4829604">]</span><span class="builtintype" id="4829605">byte</span><br>
<span class="lineno">340</span><span class="op" id="4829610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4829613">//&nbsp;requestTooLarge&nbsp;is&nbsp;called&nbsp;by&nbsp;maxBytesReader&nbsp;when&nbsp;too&nbsp;much&nbsp;input&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="4829684">//&nbsp;been&nbsp;read&nbsp;from&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="4829714">func</span>&nbsp;<span class="op" id="4829719">(</span><span class="ident" id="4829720">w</span>&nbsp;<span class="op" id="4829722">*</span><span class="ident" id="4829723">response</span><span class="op" id="4829731">)</span>&nbsp;<span class="ident" id="4829733">requestTooLarge</span><span class="op" id="4829748">(</span><span class="op" id="4829749">)</span>&nbsp;<span class="op" id="4829751">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4829754">w</span><span class="op" id="4829755">.</span><span class="ident" id="4829756">closeAfterReply</span>&nbsp;<span class="op" id="4829772">=</span>&nbsp;<span class="builtintype" id="4829774">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4829780">w</span><span class="op" id="4829781">.</span><span class="ident" id="4829782">requestBodyLimitHit</span>&nbsp;<span class="op" id="4829802">=</span>&nbsp;<span class="builtintype" id="4829804">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4829810">if</span>&nbsp;<span class="op" id="4829813">!</span><span class="ident" id="4829814">w</span><span class="op" id="4829815">.</span><span class="ident" id="4829816">wroteHeader</span>&nbsp;<span class="op" id="4829828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4829832">w</span><span class="op" id="4829833">.</span><span class="ident" id="4829834">Header</span><span class="op" id="4829840">(</span><span class="op" id="4829841">)</span><span class="op" id="4829842">.</span><span class="ident" id="4829843">Set</span><span class="op" id="4829846">(</span><span class="string" id="4829847">&#34;Connection&#34;</span><span class="op" id="4829859">,</span>&nbsp;<span class="string" id="4829861">&#34;close&#34;</span><span class="op" id="4829868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4829871">}</span><br>
<span class="lineno">350</span><span class="op" id="4829873">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4829876">//&nbsp;needsSniff&nbsp;reports&nbsp;whether&nbsp;a&nbsp;Content-Type&nbsp;still&nbsp;needs&nbsp;to&nbsp;be&nbsp;sniffed.</span><br>
<span class="lineno"></span><span class="keyword" id="4829948">func</span>&nbsp;<span class="op" id="4829953">(</span><span class="ident" id="4829954">w</span>&nbsp;<span class="op" id="4829956">*</span><span class="ident" id="4829957">response</span><span class="op" id="4829965">)</span>&nbsp;<span class="ident" id="4829967">needsSniff</span><span class="op" id="4829977">(</span><span class="op" id="4829978">)</span>&nbsp;<span class="builtintype" id="4829980">bool</span>&nbsp;<span class="op" id="4829985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4829988">_</span><span class="op" id="4829989">,</span>&nbsp;<span class="ident" id="4829991">haveType</span>&nbsp;<span class="op" id="4830000">:=</span>&nbsp;<span class="ident" id="4830003">w</span><span class="op" id="4830004">.</span><span class="ident" id="4830005">handlerHeader</span><span class="op" id="4830018">[</span><span class="string" id="4830019">&#34;Content-Type&#34;</span><span class="op" id="4830033">]</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830036">return</span>&nbsp;<span class="op" id="4830043">!</span><span class="ident" id="4830044">w</span><span class="op" id="4830045">.</span><span class="ident" id="4830046">cw</span><span class="op" id="4830048">.</span><span class="ident" id="4830049">wroteHeader</span>&nbsp;<span class="op" id="4830061">&amp;&amp;</span>&nbsp;<span class="op" id="4830064">!</span><span class="ident" id="4830065">haveType</span>&nbsp;<span class="op" id="4830074">&amp;&amp;</span>&nbsp;<span class="ident" id="4830077">w</span><span class="op" id="4830078">.</span><span class="ident" id="4830079">written</span>&nbsp;<span class="op" id="4830087">&lt;</span>&nbsp;<span class="ident" id="4830089">sniffLen</span><br>
<span class="lineno"></span><span class="op" id="4830098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4830101">//&nbsp;writerOnly&nbsp;hides&nbsp;an&nbsp;io.Writer&nbsp;value&#39;s&nbsp;optional&nbsp;ReadFrom&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="4830167">//&nbsp;from&nbsp;io.Copy.</span><br>
<span class="lineno">360</span><span class="keyword" id="4830184">type</span>&nbsp;<span class="ident" id="4830189">writerOnly</span>&nbsp;<span class="keyword" id="4830200">struct</span>&nbsp;<span class="op" id="4830207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4830210">io</span><span class="op" id="4830212">.</span><span class="ident" id="4830213">Writer</span><br>
<span class="lineno"></span><span class="op" id="4830220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4830223">func</span>&nbsp;<span class="ident" id="4830228">srcIsRegularFile</span><span class="op" id="4830244">(</span><span class="ident" id="4830245">src</span>&nbsp;<span class="ident" id="4830249">io</span><span class="op" id="4830251">.</span><span class="ident" id="4830252">Reader</span><span class="op" id="4830258">)</span>&nbsp;<span class="op" id="4830260">(</span><span class="ident" id="4830261">isRegular</span>&nbsp;<span class="builtintype" id="4830271">bool</span><span class="op" id="4830275">,</span>&nbsp;<span class="ident" id="4830277">err</span>&nbsp;<span class="builtintype" id="4830281">error</span><span class="op" id="4830286">)</span>&nbsp;<span class="op" id="4830288">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830291">switch</span>&nbsp;<span class="ident" id="4830298">v</span>&nbsp;<span class="op" id="4830300">:=</span>&nbsp;<span class="ident" id="4830303">src</span><span class="op" id="4830306">.</span><span class="op" id="4830307">(</span><span class="keyword" id="4830308">type</span><span class="op" id="4830312">)</span>&nbsp;<span class="op" id="4830314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830317">case</span>&nbsp;<span class="op" id="4830322">*</span><span class="ident" id="4830323">os</span><span class="op" id="4830325">.</span><span class="ident" id="4830326">File</span><span class="op" id="4830330">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4830334">fi</span><span class="op" id="4830336">,</span>&nbsp;<span class="ident" id="4830338">err</span>&nbsp;<span class="op" id="4830342">:=</span>&nbsp;<span class="ident" id="4830345">v</span><span class="op" id="4830346">.</span><span class="ident" id="4830347">Stat</span><span class="op" id="4830351">(</span><span class="op" id="4830352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830356">if</span>&nbsp;<span class="ident" id="4830359">err</span>&nbsp;<span class="op" id="4830363">!=</span>&nbsp;<span class="ident" id="4830366">nil</span>&nbsp;<span class="op" id="4830370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830375">return</span>&nbsp;<span class="builtintype" id="4830382">false</span><span class="op" id="4830387">,</span>&nbsp;<span class="ident" id="4830389">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4830395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830399">return</span>&nbsp;<span class="ident" id="4830406">fi</span><span class="op" id="4830408">.</span><span class="ident" id="4830409">Mode</span><span class="op" id="4830413">(</span><span class="op" id="4830414">)</span><span class="op" id="4830415">.</span><span class="ident" id="4830416">IsRegular</span><span class="op" id="4830425">(</span><span class="op" id="4830426">)</span><span class="op" id="4830427">,</span>&nbsp;<span class="ident" id="4830429">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830434">case</span>&nbsp;<span class="op" id="4830439">*</span><span class="ident" id="4830440">io</span><span class="op" id="4830442">.</span><span class="ident" id="4830443">LimitedReader</span><span class="op" id="4830456">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830460">return</span>&nbsp;<span class="ident" id="4830467">srcIsRegularFile</span><span class="op" id="4830483">(</span><span class="ident" id="4830484">v</span><span class="op" id="4830485">.</span><span class="ident" id="4830486">R</span><span class="op" id="4830487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830490">default</span><span class="op" id="4830497">:</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830501">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4830509">}</span><br>
<span class="lineno"></span><span class="op" id="4830511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4830514">//&nbsp;ReadFrom&nbsp;is&nbsp;here&nbsp;to&nbsp;optimize&nbsp;copying&nbsp;from&nbsp;an&nbsp;*os.File&nbsp;regular&nbsp;file</span><br>
<span class="lineno">380</span><span class="comment" id="4830584">//&nbsp;to&nbsp;a&nbsp;*net.TCPConn&nbsp;with&nbsp;sendfile.</span><br>
<span class="lineno"></span><span class="keyword" id="4830620">func</span>&nbsp;<span class="op" id="4830625">(</span><span class="ident" id="4830626">w</span>&nbsp;<span class="op" id="4830628">*</span><span class="ident" id="4830629">response</span><span class="op" id="4830637">)</span>&nbsp;<span class="ident" id="4830639">ReadFrom</span><span class="op" id="4830647">(</span><span class="ident" id="4830648">src</span>&nbsp;<span class="ident" id="4830652">io</span><span class="op" id="4830654">.</span><span class="ident" id="4830655">Reader</span><span class="op" id="4830661">)</span>&nbsp;<span class="op" id="4830663">(</span><span class="ident" id="4830664">n</span>&nbsp;<span class="ident" id="4830666">int64</span><span class="op" id="4830671">,</span>&nbsp;<span class="ident" id="4830673">err</span>&nbsp;<span class="builtintype" id="4830677">error</span><span class="op" id="4830682">)</span>&nbsp;<span class="op" id="4830684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4830687">//&nbsp;Our&nbsp;underlying&nbsp;w.conn.rwc&nbsp;is&nbsp;usually&nbsp;a&nbsp;*TCPConn&nbsp;(with&nbsp;its</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4830749">//&nbsp;own&nbsp;ReadFrom&nbsp;method).&nbsp;If&nbsp;not,&nbsp;or&nbsp;if&nbsp;our&nbsp;src&nbsp;isn&#39;t&nbsp;a&nbsp;regular</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4830813">//&nbsp;file,&nbsp;just&nbsp;fall&nbsp;back&nbsp;to&nbsp;the&nbsp;normal&nbsp;copy&nbsp;method.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4830865">rf</span><span class="op" id="4830867">,</span>&nbsp;<span class="ident" id="4830869">ok</span>&nbsp;<span class="op" id="4830872">:=</span>&nbsp;<span class="ident" id="4830875">w</span><span class="op" id="4830876">.</span><span class="ident" id="4830877">conn</span><span class="op" id="4830881">.</span><span class="ident" id="4830882">rwc</span><span class="op" id="4830885">.</span><span class="op" id="4830886">(</span><span class="ident" id="4830887">io</span><span class="op" id="4830889">.</span><span class="ident" id="4830890">ReaderFrom</span><span class="op" id="4830900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4830903">regFile</span><span class="op" id="4830910">,</span>&nbsp;<span class="ident" id="4830912">err</span>&nbsp;<span class="op" id="4830916">:=</span>&nbsp;<span class="ident" id="4830919">srcIsRegularFile</span><span class="op" id="4830935">(</span><span class="ident" id="4830936">src</span><span class="op" id="4830939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830942">if</span>&nbsp;<span class="ident" id="4830945">err</span>&nbsp;<span class="op" id="4830949">!=</span>&nbsp;<span class="ident" id="4830952">nil</span>&nbsp;<span class="op" id="4830956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830960">return</span>&nbsp;<span class="num" id="4830967">0</span><span class="op" id="4830968">,</span>&nbsp;<span class="ident" id="4830970">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4830975">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4830978">if</span>&nbsp;<span class="op" id="4830981">!</span><span class="ident" id="4830982">ok</span>&nbsp;<span class="op" id="4830985">||</span>&nbsp;<span class="op" id="4830988">!</span><span class="ident" id="4830989">regFile</span>&nbsp;<span class="op" id="4830997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4831001">return</span>&nbsp;<span class="ident" id="4831008">io</span><span class="op" id="4831010">.</span><span class="ident" id="4831011">Copy</span><span class="op" id="4831015">(</span><span class="ident" id="4831016">writerOnly</span><span class="op" id="4831026">{</span><span class="ident" id="4831027">w</span><span class="op" id="4831028">}</span><span class="op" id="4831029">,</span>&nbsp;<span class="ident" id="4831031">src</span><span class="op" id="4831034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4831037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4831041">//&nbsp;sendfile&nbsp;path:</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4831061">if</span>&nbsp;<span class="op" id="4831064">!</span><span class="ident" id="4831065">w</span><span class="op" id="4831066">.</span><span class="ident" id="4831067">wroteHeader</span>&nbsp;<span class="op" id="4831079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831083">w</span><span class="op" id="4831084">.</span><span class="ident" id="4831085">WriteHeader</span><span class="op" id="4831096">(</span><span class="ident" id="4831097">StatusOK</span><span class="op" id="4831105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4831108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4831112">if</span>&nbsp;<span class="ident" id="4831115">w</span><span class="op" id="4831116">.</span><span class="ident" id="4831117">needsSniff</span><span class="op" id="4831127">(</span><span class="op" id="4831128">)</span>&nbsp;<span class="op" id="4831130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831134">n0</span><span class="op" id="4831136">,</span>&nbsp;<span class="ident" id="4831138">err</span>&nbsp;<span class="op" id="4831142">:=</span>&nbsp;<span class="ident" id="4831145">io</span><span class="op" id="4831147">.</span><span class="ident" id="4831148">Copy</span><span class="op" id="4831152">(</span><span class="ident" id="4831153">writerOnly</span><span class="op" id="4831163">{</span><span class="ident" id="4831164">w</span><span class="op" id="4831165">}</span><span class="op" id="4831166">,</span>&nbsp;<span class="ident" id="4831168">io</span><span class="op" id="4831170">.</span><span class="ident" id="4831171">LimitReader</span><span class="op" id="4831182">(</span><span class="ident" id="4831183">src</span><span class="op" id="4831186">,</span>&nbsp;<span class="ident" id="4831188">sniffLen</span><span class="op" id="4831196">)</span><span class="op" id="4831197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831201">n</span>&nbsp;<span class="op" id="4831203">+=</span>&nbsp;<span class="ident" id="4831206">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4831211">if</span>&nbsp;<span class="ident" id="4831214">err</span>&nbsp;<span class="op" id="4831218">!=</span>&nbsp;<span class="ident" id="4831221">nil</span>&nbsp;<span class="op" id="4831225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4831230">return</span>&nbsp;<span class="ident" id="4831237">n</span><span class="op" id="4831238">,</span>&nbsp;<span class="ident" id="4831240">err</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4831246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4831249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831253">w</span><span class="op" id="4831254">.</span><span class="ident" id="4831255">w</span><span class="op" id="4831256">.</span><span class="ident" id="4831257">Flush</span><span class="op" id="4831262">(</span><span class="op" id="4831263">)</span>&nbsp;&nbsp;<span class="comment" id="4831266">//&nbsp;get&nbsp;rid&nbsp;of&nbsp;any&nbsp;previous&nbsp;writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831301">w</span><span class="op" id="4831302">.</span><span class="ident" id="4831303">cw</span><span class="op" id="4831305">.</span><span class="ident" id="4831306">flush</span><span class="op" id="4831311">(</span><span class="op" id="4831312">)</span>&nbsp;<span class="comment" id="4831314">//&nbsp;make&nbsp;sure&nbsp;Header&nbsp;is&nbsp;written;&nbsp;flush&nbsp;data&nbsp;to&nbsp;rwc</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4831366">//&nbsp;Now&nbsp;that&nbsp;cw&nbsp;has&nbsp;been&nbsp;flushed,&nbsp;its&nbsp;chunking&nbsp;field&nbsp;is&nbsp;guaranteed&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4831446">if</span>&nbsp;<span class="op" id="4831449">!</span><span class="ident" id="4831450">w</span><span class="op" id="4831451">.</span><span class="ident" id="4831452">cw</span><span class="op" id="4831454">.</span><span class="ident" id="4831455">chunking</span>&nbsp;<span class="op" id="4831464">&amp;&amp;</span>&nbsp;<span class="ident" id="4831467">w</span><span class="op" id="4831468">.</span><span class="ident" id="4831469">bodyAllowed</span><span class="op" id="4831480">(</span><span class="op" id="4831481">)</span>&nbsp;<span class="op" id="4831483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831487">n0</span><span class="op" id="4831489">,</span>&nbsp;<span class="ident" id="4831491">err</span>&nbsp;<span class="op" id="4831495">:=</span>&nbsp;<span class="ident" id="4831498">rf</span><span class="op" id="4831500">.</span><span class="ident" id="4831501">ReadFrom</span><span class="op" id="4831509">(</span><span class="ident" id="4831510">src</span><span class="op" id="4831513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831517">n</span>&nbsp;<span class="op" id="4831519">+=</span>&nbsp;<span class="ident" id="4831522">n0</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831527">w</span><span class="op" id="4831528">.</span><span class="ident" id="4831529">written</span>&nbsp;<span class="op" id="4831537">+=</span>&nbsp;<span class="ident" id="4831540">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4831545">return</span>&nbsp;<span class="ident" id="4831552">n</span><span class="op" id="4831553">,</span>&nbsp;<span class="ident" id="4831555">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4831560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831564">n0</span><span class="op" id="4831566">,</span>&nbsp;<span class="ident" id="4831568">err</span>&nbsp;<span class="op" id="4831572">:=</span>&nbsp;<span class="ident" id="4831575">io</span><span class="op" id="4831577">.</span><span class="ident" id="4831578">Copy</span><span class="op" id="4831582">(</span><span class="ident" id="4831583">writerOnly</span><span class="op" id="4831593">{</span><span class="ident" id="4831594">w</span><span class="op" id="4831595">}</span><span class="op" id="4831596">,</span>&nbsp;<span class="ident" id="4831598">src</span><span class="op" id="4831601">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831604">n</span>&nbsp;<span class="op" id="4831606">+=</span>&nbsp;<span class="ident" id="4831609">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4831613">return</span>&nbsp;<span class="ident" id="4831620">n</span><span class="op" id="4831621">,</span>&nbsp;<span class="ident" id="4831623">err</span><br>
<span class="lineno"></span><span class="op" id="4831627">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4831630">//&nbsp;noLimit&nbsp;is&nbsp;an&nbsp;effective&nbsp;infinite&nbsp;upper&nbsp;bound&nbsp;for&nbsp;io.LimitedReader</span><br>
<span class="lineno">425</span><span class="keyword" id="4831699">const</span>&nbsp;<span class="ident" id="4831705">noLimit</span>&nbsp;<span class="ident" id="4831713">int64</span>&nbsp;<span class="op" id="4831719">=</span>&nbsp;<span class="op" id="4831721">(</span><span class="num" id="4831722">1</span>&nbsp;<span class="op" id="4831724">&lt;&lt;</span>&nbsp;<span class="num" id="4831727">63</span><span class="op" id="4831729">)</span>&nbsp;<span class="op" id="4831731">-</span>&nbsp;<span class="num" id="4831733">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4831736">//&nbsp;debugServerConnections&nbsp;controls&nbsp;whether&nbsp;all&nbsp;server&nbsp;connections&nbsp;are&nbsp;wrapped</span><br>
<span class="lineno"></span><span class="comment" id="4831814">//&nbsp;with&nbsp;a&nbsp;verbose&nbsp;logging&nbsp;wrapper.</span><br>
<span class="lineno"></span><span class="keyword" id="4831849">const</span>&nbsp;<span class="ident" id="4831855">debugServerConnections</span>&nbsp;<span class="op" id="4831878">=</span>&nbsp;<span class="builtintype" id="4831880">false</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="comment" id="4831887">//&nbsp;Create&nbsp;new&nbsp;connection&nbsp;from&nbsp;rwc.</span><br>
<span class="lineno"></span><span class="keyword" id="4831922">func</span>&nbsp;<span class="op" id="4831927">(</span><span class="ident" id="4831928">srv</span>&nbsp;<span class="op" id="4831932">*</span><span class="ident" id="4831933">Server</span><span class="op" id="4831939">)</span>&nbsp;<span class="ident" id="4831941">newConn</span><span class="op" id="4831948">(</span><span class="ident" id="4831949">rwc</span>&nbsp;<span class="ident" id="4831953">net</span><span class="op" id="4831956">.</span><span class="ident" id="4831957">Conn</span><span class="op" id="4831961">)</span>&nbsp;<span class="op" id="4831963">(</span><span class="ident" id="4831964">c</span>&nbsp;<span class="op" id="4831966">*</span><span class="ident" id="4831967">conn</span><span class="op" id="4831971">,</span>&nbsp;<span class="ident" id="4831973">err</span>&nbsp;<span class="builtintype" id="4831977">error</span><span class="op" id="4831982">)</span>&nbsp;<span class="op" id="4831984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4831987">c</span>&nbsp;<span class="op" id="4831989">=</span>&nbsp;<span class="builtinfunc" id="4831991">new</span><span class="op" id="4831994">(</span><span class="ident" id="4831995">conn</span><span class="op" id="4831999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832002">c</span><span class="op" id="4832003">.</span><span class="ident" id="4832004">remoteAddr</span>&nbsp;<span class="op" id="4832015">=</span>&nbsp;<span class="ident" id="4832017">rwc</span><span class="op" id="4832020">.</span><span class="ident" id="4832021">RemoteAddr</span><span class="op" id="4832031">(</span><span class="op" id="4832032">)</span><span class="op" id="4832033">.</span><span class="ident" id="4832034">String</span><span class="op" id="4832040">(</span><span class="op" id="4832041">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832044">c</span><span class="op" id="4832045">.</span><span class="ident" id="4832046">server</span>&nbsp;<span class="op" id="4832053">=</span>&nbsp;<span class="ident" id="4832055">srv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832060">c</span><span class="op" id="4832061">.</span><span class="ident" id="4832062">rwc</span>&nbsp;<span class="op" id="4832066">=</span>&nbsp;<span class="ident" id="4832068">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832073">c</span><span class="op" id="4832074">.</span><span class="ident" id="4832075">w</span>&nbsp;<span class="op" id="4832077">=</span>&nbsp;<span class="ident" id="4832079">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832084">if</span>&nbsp;<span class="ident" id="4832087">debugServerConnections</span>&nbsp;<span class="op" id="4832110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832114">c</span><span class="op" id="4832115">.</span><span class="ident" id="4832116">rwc</span>&nbsp;<span class="op" id="4832120">=</span>&nbsp;<span class="ident" id="4832122">newLoggingConn</span><span class="op" id="4832136">(</span><span class="string" id="4832137">&#34;server&#34;</span><span class="op" id="4832145">,</span>&nbsp;<span class="ident" id="4832147">c</span><span class="op" id="4832148">.</span><span class="ident" id="4832149">rwc</span><span class="op" id="4832152">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4832155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832158">c</span><span class="op" id="4832159">.</span><span class="ident" id="4832160">sr</span>&nbsp;<span class="op" id="4832163">=</span>&nbsp;<span class="ident" id="4832165">liveSwitchReader</span><span class="op" id="4832181">{</span><span class="ident" id="4832182">r</span><span class="op" id="4832183">:</span>&nbsp;<span class="ident" id="4832185">c</span><span class="op" id="4832186">.</span><span class="ident" id="4832187">rwc</span><span class="op" id="4832190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832193">c</span><span class="op" id="4832194">.</span><span class="ident" id="4832195">lr</span>&nbsp;<span class="op" id="4832198">=</span>&nbsp;<span class="ident" id="4832200">io</span><span class="op" id="4832202">.</span><span class="ident" id="4832203">LimitReader</span><span class="op" id="4832214">(</span><span class="op" id="4832215">&amp;</span><span class="ident" id="4832216">c</span><span class="op" id="4832217">.</span><span class="ident" id="4832218">sr</span><span class="op" id="4832220">,</span>&nbsp;<span class="ident" id="4832222">noLimit</span><span class="op" id="4832229">)</span><span class="op" id="4832230">.</span><span class="op" id="4832231">(</span><span class="op" id="4832232">*</span><span class="ident" id="4832233">io</span><span class="op" id="4832235">.</span><span class="ident" id="4832236">LimitedReader</span><span class="op" id="4832249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832252">br</span>&nbsp;<span class="op" id="4832255">:=</span>&nbsp;<span class="ident" id="4832258">newBufioReader</span><span class="op" id="4832272">(</span><span class="ident" id="4832273">c</span><span class="op" id="4832274">.</span><span class="ident" id="4832275">lr</span><span class="op" id="4832277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832280">bw</span>&nbsp;<span class="op" id="4832283">:=</span>&nbsp;<span class="ident" id="4832286">newBufioWriterSize</span><span class="op" id="4832304">(</span><span class="ident" id="4832305">checkConnErrorWriter</span><span class="op" id="4832325">{</span><span class="ident" id="4832326">c</span><span class="op" id="4832327">}</span><span class="op" id="4832328">,</span>&nbsp;<span class="num" id="4832330">4</span><span class="op" id="4832331">&lt;&lt;</span><span class="num" id="4832333">10</span><span class="op" id="4832335">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832338">c</span><span class="op" id="4832339">.</span><span class="ident" id="4832340">buf</span>&nbsp;<span class="op" id="4832344">=</span>&nbsp;<span class="ident" id="4832346">bufio</span><span class="op" id="4832351">.</span><span class="ident" id="4832352">NewReadWriter</span><span class="op" id="4832365">(</span><span class="ident" id="4832366">br</span><span class="op" id="4832368">,</span>&nbsp;<span class="ident" id="4832370">bw</span><span class="op" id="4832372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832375">return</span>&nbsp;<span class="ident" id="4832382">c</span><span class="op" id="4832383">,</span>&nbsp;<span class="ident" id="4832385">nil</span><br>
<span class="lineno"></span><span class="op" id="4832389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4832392">var</span>&nbsp;<span class="op" id="4832396">(</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832399">bufioReaderPool</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4832417">sync</span><span class="op" id="4832421">.</span><span class="ident" id="4832422">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832428">bufioWriter2kPool</span>&nbsp;<span class="ident" id="4832446">sync</span><span class="op" id="4832450">.</span><span class="ident" id="4832451">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832457">bufioWriter4kPool</span>&nbsp;<span class="ident" id="4832475">sync</span><span class="op" id="4832479">.</span><span class="ident" id="4832480">Pool</span><br>
<span class="lineno"></span><span class="op" id="4832485">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="keyword" id="4832488">func</span>&nbsp;<span class="ident" id="4832493">bufioWriterPool</span><span class="op" id="4832508">(</span><span class="ident" id="4832509">size</span>&nbsp;<span class="builtintype" id="4832514">int</span><span class="op" id="4832517">)</span>&nbsp;<span class="op" id="4832519">*</span><span class="ident" id="4832520">sync</span><span class="op" id="4832524">.</span><span class="ident" id="4832525">Pool</span>&nbsp;<span class="op" id="4832530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832533">switch</span>&nbsp;<span class="ident" id="4832540">size</span>&nbsp;<span class="op" id="4832545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832548">case</span>&nbsp;<span class="num" id="4832553">2</span>&nbsp;<span class="op" id="4832555">&lt;&lt;</span>&nbsp;<span class="num" id="4832558">10</span><span class="op" id="4832560">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832564">return</span>&nbsp;<span class="op" id="4832571">&amp;</span><span class="ident" id="4832572">bufioWriter2kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832591">case</span>&nbsp;<span class="num" id="4832596">4</span>&nbsp;<span class="op" id="4832598">&lt;&lt;</span>&nbsp;<span class="num" id="4832601">10</span><span class="op" id="4832603">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832607">return</span>&nbsp;<span class="op" id="4832614">&amp;</span><span class="ident" id="4832615">bufioWriter4kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4832634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832637">return</span>&nbsp;<span class="ident" id="4832644">nil</span><br>
<span class="lineno"></span><span class="op" id="4832648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="keyword" id="4832651">func</span>&nbsp;<span class="ident" id="4832656">newBufioReader</span><span class="op" id="4832670">(</span><span class="ident" id="4832671">r</span>&nbsp;<span class="ident" id="4832673">io</span><span class="op" id="4832675">.</span><span class="ident" id="4832676">Reader</span><span class="op" id="4832682">)</span>&nbsp;<span class="op" id="4832684">*</span><span class="ident" id="4832685">bufio</span><span class="op" id="4832690">.</span><span class="ident" id="4832691">Reader</span>&nbsp;<span class="op" id="4832698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832701">if</span>&nbsp;<span class="ident" id="4832704">v</span>&nbsp;<span class="op" id="4832706">:=</span>&nbsp;<span class="ident" id="4832709">bufioReaderPool</span><span class="op" id="4832724">.</span><span class="ident" id="4832725">Get</span><span class="op" id="4832728">(</span><span class="op" id="4832729">)</span><span class="op" id="4832730">;</span>&nbsp;<span class="ident" id="4832732">v</span>&nbsp;<span class="op" id="4832734">!=</span>&nbsp;<span class="ident" id="4832737">nil</span>&nbsp;<span class="op" id="4832741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832745">br</span>&nbsp;<span class="op" id="4832748">:=</span>&nbsp;<span class="ident" id="4832751">v</span><span class="op" id="4832752">.</span><span class="op" id="4832753">(</span><span class="op" id="4832754">*</span><span class="ident" id="4832755">bufio</span><span class="op" id="4832760">.</span><span class="ident" id="4832761">Reader</span><span class="op" id="4832767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832771">br</span><span class="op" id="4832773">.</span><span class="ident" id="4832774">Reset</span><span class="op" id="4832779">(</span><span class="ident" id="4832780">r</span><span class="op" id="4832781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832785">return</span>&nbsp;<span class="ident" id="4832792">br</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4832796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4832799">return</span>&nbsp;<span class="ident" id="4832806">bufio</span><span class="op" id="4832811">.</span><span class="ident" id="4832812">NewReader</span><span class="op" id="4832821">(</span><span class="ident" id="4832822">r</span><span class="op" id="4832823">)</span><br>
<span class="lineno"></span><span class="op" id="4832825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4832828">func</span>&nbsp;<span class="ident" id="4832833">putBufioReader</span><span class="op" id="4832847">(</span><span class="ident" id="4832848">br</span>&nbsp;<span class="op" id="4832851">*</span><span class="ident" id="4832852">bufio</span><span class="op" id="4832857">.</span><span class="ident" id="4832858">Reader</span><span class="op" id="4832864">)</span>&nbsp;<span class="op" id="4832866">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832869">br</span><span class="op" id="4832871">.</span><span class="ident" id="4832872">Reset</span><span class="op" id="4832877">(</span><span class="ident" id="4832878">nil</span><span class="op" id="4832881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832884">bufioReaderPool</span><span class="op" id="4832899">.</span><span class="ident" id="4832900">Put</span><span class="op" id="4832903">(</span><span class="ident" id="4832904">br</span><span class="op" id="4832906">)</span><br>
<span class="lineno"></span><span class="op" id="4832908">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4832911">func</span>&nbsp;<span class="ident" id="4832916">newBufioWriterSize</span><span class="op" id="4832934">(</span><span class="ident" id="4832935">w</span>&nbsp;<span class="ident" id="4832937">io</span><span class="op" id="4832939">.</span><span class="ident" id="4832940">Writer</span><span class="op" id="4832946">,</span>&nbsp;<span class="ident" id="4832948">size</span>&nbsp;<span class="builtintype" id="4832953">int</span><span class="op" id="4832956">)</span>&nbsp;<span class="op" id="4832958">*</span><span class="ident" id="4832959">bufio</span><span class="op" id="4832964">.</span><span class="ident" id="4832965">Writer</span>&nbsp;<span class="op" id="4832972">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4832975">pool</span>&nbsp;<span class="op" id="4832980">:=</span>&nbsp;<span class="ident" id="4832983">bufioWriterPool</span><span class="op" id="4832998">(</span><span class="ident" id="4832999">size</span><span class="op" id="4833003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4833006">if</span>&nbsp;<span class="ident" id="4833009">pool</span>&nbsp;<span class="op" id="4833014">!=</span>&nbsp;<span class="ident" id="4833017">nil</span>&nbsp;<span class="op" id="4833021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4833025">if</span>&nbsp;<span class="ident" id="4833028">v</span>&nbsp;<span class="op" id="4833030">:=</span>&nbsp;<span class="ident" id="4833033">pool</span><span class="op" id="4833037">.</span><span class="ident" id="4833038">Get</span><span class="op" id="4833041">(</span><span class="op" id="4833042">)</span><span class="op" id="4833043">;</span>&nbsp;<span class="ident" id="4833045">v</span>&nbsp;<span class="op" id="4833047">!=</span>&nbsp;<span class="ident" id="4833050">nil</span>&nbsp;<span class="op" id="4833054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4833059">bw</span>&nbsp;<span class="op" id="4833062">:=</span>&nbsp;<span class="ident" id="4833065">v</span><span class="op" id="4833066">.</span><span class="op" id="4833067">(</span><span class="op" id="4833068">*</span><span class="ident" id="4833069">bufio</span><span class="op" id="4833074">.</span><span class="ident" id="4833075">Writer</span><span class="op" id="4833081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4833086">bw</span><span class="op" id="4833088">.</span><span class="ident" id="4833089">Reset</span><span class="op" id="4833094">(</span><span class="ident" id="4833095">w</span><span class="op" id="4833096">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4833101">return</span>&nbsp;<span class="ident" id="4833108">bw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4833113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4833116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4833119">return</span>&nbsp;<span class="ident" id="4833126">bufio</span><span class="op" id="4833131">.</span><span class="ident" id="4833132">NewWriterSize</span><span class="op" id="4833145">(</span><span class="ident" id="4833146">w</span><span class="op" id="4833147">,</span>&nbsp;<span class="ident" id="4833149">size</span><span class="op" id="4833153">)</span><br>
<span class="lineno"></span><span class="op" id="4833155">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="keyword" id="4833158">func</span>&nbsp;<span class="ident" id="4833163">putBufioWriter</span><span class="op" id="4833177">(</span><span class="ident" id="4833178">bw</span>&nbsp;<span class="op" id="4833181">*</span><span class="ident" id="4833182">bufio</span><span class="op" id="4833187">.</span><span class="ident" id="4833188">Writer</span><span class="op" id="4833194">)</span>&nbsp;<span class="op" id="4833196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4833199">bw</span><span class="op" id="4833201">.</span><span class="ident" id="4833202">Reset</span><span class="op" id="4833207">(</span><span class="ident" id="4833208">nil</span><span class="op" id="4833211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4833214">if</span>&nbsp;<span class="ident" id="4833217">pool</span>&nbsp;<span class="op" id="4833222">:=</span>&nbsp;<span class="ident" id="4833225">bufioWriterPool</span><span class="op" id="4833240">(</span><span class="ident" id="4833241">bw</span><span class="op" id="4833243">.</span><span class="ident" id="4833244">Available</span><span class="op" id="4833253">(</span><span class="op" id="4833254">)</span><span class="op" id="4833255">)</span><span class="op" id="4833256">;</span>&nbsp;<span class="ident" id="4833258">pool</span>&nbsp;<span class="op" id="4833263">!=</span>&nbsp;<span class="ident" id="4833266">nil</span>&nbsp;<span class="op" id="4833270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4833274">pool</span><span class="op" id="4833278">.</span><span class="ident" id="4833279">Put</span><span class="op" id="4833282">(</span><span class="ident" id="4833283">bw</span><span class="op" id="4833285">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4833288">}</span><br>
<span class="lineno"></span><span class="op" id="4833290">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4833293">//&nbsp;DefaultMaxHeaderBytes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;permitted&nbsp;size&nbsp;of&nbsp;the&nbsp;headers</span><br>
<span class="lineno"></span><span class="comment" id="4833363">//&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;request.</span><br>
<span class="lineno">500</span><span class="comment" id="4833386">//&nbsp;This&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;setting&nbsp;Server.MaxHeaderBytes.</span><br>
<span class="lineno"></span><span class="keyword" id="4833446">const</span>&nbsp;<span class="ident" id="4833452">DefaultMaxHeaderBytes</span>&nbsp;<span class="op" id="4833474">=</span>&nbsp;<span class="num" id="4833476">1</span>&nbsp;<span class="op" id="4833478">&lt;&lt;</span>&nbsp;<span class="num" id="4833481">20</span>&nbsp;<span class="comment" id="4833484">//&nbsp;1&nbsp;MB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4833493">func</span>&nbsp;<span class="op" id="4833498">(</span><span class="ident" id="4833499">srv</span>&nbsp;<span class="op" id="4833503">*</span><span class="ident" id="4833504">Server</span><span class="op" id="4833510">)</span>&nbsp;<span class="ident" id="4833512">maxHeaderBytes</span><span class="op" id="4833526">(</span><span class="op" id="4833527">)</span>&nbsp;<span class="builtintype" id="4833529">int</span>&nbsp;<span class="op" id="4833533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4833536">if</span>&nbsp;<span class="ident" id="4833539">srv</span><span class="op" id="4833542">.</span><span class="ident" id="4833543">MaxHeaderBytes</span>&nbsp;<span class="op" id="4833558">&gt;</span>&nbsp;<span class="num" id="4833560">0</span>&nbsp;<span class="op" id="4833562">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4833566">return</span>&nbsp;<span class="ident" id="4833573">srv</span><span class="op" id="4833576">.</span><span class="ident" id="4833577">MaxHeaderBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4833593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4833596">return</span>&nbsp;<span class="ident" id="4833603">DefaultMaxHeaderBytes</span><br>
<span class="lineno"></span><span class="op" id="4833625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="4833628">func</span>&nbsp;<span class="op" id="4833633">(</span><span class="ident" id="4833634">srv</span>&nbsp;<span class="op" id="4833638">*</span><span class="ident" id="4833639">Server</span><span class="op" id="4833645">)</span>&nbsp;<span class="ident" id="4833647">initialLimitedReaderSize</span><span class="op" id="4833671">(</span><span class="op" id="4833672">)</span>&nbsp;<span class="ident" id="4833674">int64</span>&nbsp;<span class="op" id="4833680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4833683">return</span>&nbsp;<span class="ident" id="4833690">int64</span><span class="op" id="4833695">(</span><span class="ident" id="4833696">srv</span><span class="op" id="4833699">.</span><span class="ident" id="4833700">maxHeaderBytes</span><span class="op" id="4833714">(</span><span class="op" id="4833715">)</span><span class="op" id="4833716">)</span>&nbsp;<span class="op" id="4833718">+</span>&nbsp;<span class="num" id="4833720">4096</span>&nbsp;<span class="comment" id="4833725">//&nbsp;bufio&nbsp;slop</span><br>
<span class="lineno"></span><span class="op" id="4833739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4833742">//&nbsp;wrapper&nbsp;around&nbsp;io.ReaderCloser&nbsp;which&nbsp;on&nbsp;first&nbsp;read,&nbsp;sends&nbsp;an</span><br>
<span class="lineno">515</span><span class="comment" id="4833806">//&nbsp;HTTP/1.1&nbsp;100&nbsp;Continue&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="4833838">type</span>&nbsp;<span class="ident" id="4833843">expectContinueReader</span>&nbsp;<span class="keyword" id="4833864">struct</span>&nbsp;<span class="op" id="4833871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4833874">resp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4833885">*</span><span class="ident" id="4833886">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4833896">readCloser</span>&nbsp;<span class="ident" id="4833907">io</span><span class="op" id="4833909">.</span><span class="ident" id="4833910">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4833922">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4833933">bool</span><br>
<span class="lineno">520</span><span class="op" id="4833938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4833941">func</span>&nbsp;<span class="op" id="4833946">(</span><span class="ident" id="4833947">ecr</span>&nbsp;<span class="op" id="4833951">*</span><span class="ident" id="4833952">expectContinueReader</span><span class="op" id="4833972">)</span>&nbsp;<span class="ident" id="4833974">Read</span><span class="op" id="4833978">(</span><span class="ident" id="4833979">p</span>&nbsp;<span class="op" id="4833981">[</span><span class="op" id="4833982">]</span><span class="builtintype" id="4833983">byte</span><span class="op" id="4833987">)</span>&nbsp;<span class="op" id="4833989">(</span><span class="ident" id="4833990">n</span>&nbsp;<span class="builtintype" id="4833992">int</span><span class="op" id="4833995">,</span>&nbsp;<span class="ident" id="4833997">err</span>&nbsp;<span class="builtintype" id="4834001">error</span><span class="op" id="4834006">)</span>&nbsp;<span class="op" id="4834008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4834011">if</span>&nbsp;<span class="ident" id="4834014">ecr</span><span class="op" id="4834017">.</span><span class="ident" id="4834018">closed</span>&nbsp;<span class="op" id="4834025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4834029">return</span>&nbsp;<span class="num" id="4834036">0</span><span class="op" id="4834037">,</span>&nbsp;<span class="ident" id="4834039">ErrBodyReadAfterClose</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4834062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4834065">if</span>&nbsp;<span class="op" id="4834068">!</span><span class="ident" id="4834069">ecr</span><span class="op" id="4834072">.</span><span class="ident" id="4834073">resp</span><span class="op" id="4834077">.</span><span class="ident" id="4834078">wroteContinue</span>&nbsp;<span class="op" id="4834092">&amp;&amp;</span>&nbsp;<span class="op" id="4834095">!</span><span class="ident" id="4834096">ecr</span><span class="op" id="4834099">.</span><span class="ident" id="4834100">resp</span><span class="op" id="4834104">.</span><span class="ident" id="4834105">conn</span><span class="op" id="4834109">.</span><span class="ident" id="4834110">hijacked</span><span class="op" id="4834118">(</span><span class="op" id="4834119">)</span>&nbsp;<span class="op" id="4834121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4834125">ecr</span><span class="op" id="4834128">.</span><span class="ident" id="4834129">resp</span><span class="op" id="4834133">.</span><span class="ident" id="4834134">wroteContinue</span>&nbsp;<span class="op" id="4834148">=</span>&nbsp;<span class="builtintype" id="4834150">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4834157">ecr</span><span class="op" id="4834160">.</span><span class="ident" id="4834161">resp</span><span class="op" id="4834165">.</span><span class="ident" id="4834166">conn</span><span class="op" id="4834170">.</span><span class="ident" id="4834171">buf</span><span class="op" id="4834174">.</span><span class="ident" id="4834175">WriteString</span><span class="op" id="4834186">(</span><span class="string" id="4834187">&#34;HTTP/1.1&nbsp;100&nbsp;Continue\r\n\r\n&#34;</span><span class="op" id="4834218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4834222">ecr</span><span class="op" id="4834225">.</span><span class="ident" id="4834226">resp</span><span class="op" id="4834230">.</span><span class="ident" id="4834231">conn</span><span class="op" id="4834235">.</span><span class="ident" id="4834236">buf</span><span class="op" id="4834239">.</span><span class="ident" id="4834240">Flush</span><span class="op" id="4834245">(</span><span class="op" id="4834246">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4834249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4834252">return</span>&nbsp;<span class="ident" id="4834259">ecr</span><span class="op" id="4834262">.</span><span class="ident" id="4834263">readCloser</span><span class="op" id="4834273">.</span><span class="ident" id="4834274">Read</span><span class="op" id="4834278">(</span><span class="ident" id="4834279">p</span><span class="op" id="4834280">)</span><br>
<span class="lineno"></span><span class="op" id="4834282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4834285">func</span>&nbsp;<span class="op" id="4834290">(</span><span class="ident" id="4834291">ecr</span>&nbsp;<span class="op" id="4834295">*</span><span class="ident" id="4834296">expectContinueReader</span><span class="op" id="4834316">)</span>&nbsp;<span class="ident" id="4834318">Close</span><span class="op" id="4834323">(</span><span class="op" id="4834324">)</span>&nbsp;<span class="builtintype" id="4834326">error</span>&nbsp;<span class="op" id="4834332">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4834335">ecr</span><span class="op" id="4834338">.</span><span class="ident" id="4834339">closed</span>&nbsp;<span class="op" id="4834346">=</span>&nbsp;<span class="builtintype" id="4834348">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4834354">return</span>&nbsp;<span class="ident" id="4834361">ecr</span><span class="op" id="4834364">.</span><span class="ident" id="4834365">readCloser</span><span class="op" id="4834375">.</span><span class="ident" id="4834376">Close</span><span class="op" id="4834381">(</span><span class="op" id="4834382">)</span><br>
<span class="lineno"></span><span class="op" id="4834384">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4834387">//&nbsp;TimeFormat&nbsp;is&nbsp;the&nbsp;time&nbsp;format&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno">540</span><span class="comment" id="4834432">//&nbsp;time.Parse&nbsp;and&nbsp;time.Time.Format&nbsp;when&nbsp;parsing</span><br>
<span class="lineno"></span><span class="comment" id="4834480">//&nbsp;or&nbsp;generating&nbsp;times&nbsp;in&nbsp;HTTP&nbsp;headers.</span><br>
<span class="lineno"></span><span class="comment" id="4834520">//&nbsp;It&nbsp;is&nbsp;like&nbsp;time.RFC1123&nbsp;but&nbsp;hard&nbsp;codes&nbsp;GMT&nbsp;as&nbsp;the&nbsp;time&nbsp;zone.</span><br>
<span class="lineno"></span><span class="keyword" id="4834584">const</span>&nbsp;<span class="ident" id="4834590">TimeFormat</span>&nbsp;<span class="op" id="4834601">=</span>&nbsp;<span class="string" id="4834603">&#34;Mon,&nbsp;02&nbsp;Jan&nbsp;2006&nbsp;15:04:05&nbsp;GMT&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span><span class="comment" id="4834636">//&nbsp;appendTime&nbsp;is&nbsp;a&nbsp;non-allocating&nbsp;version&nbsp;of&nbsp;[]byte(t.UTC().Format(TimeFormat))</span><br>
<span class="lineno"></span><span class="keyword" id="4834716">func</span>&nbsp;<span class="ident" id="4834721">appendTime</span><span class="op" id="4834731">(</span><span class="ident" id="4834732">b</span>&nbsp;<span class="op" id="4834734">[</span><span class="op" id="4834735">]</span><span class="builtintype" id="4834736">byte</span><span class="op" id="4834740">,</span>&nbsp;<span class="ident" id="4834742">t</span>&nbsp;<span class="ident" id="4834744">time</span><span class="op" id="4834748">.</span><span class="ident" id="4834749">Time</span><span class="op" id="4834753">)</span>&nbsp;<span class="op" id="4834755">[</span><span class="op" id="4834756">]</span><span class="builtintype" id="4834757">byte</span>&nbsp;<span class="op" id="4834762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4834765">const</span>&nbsp;<span class="ident" id="4834771">days</span>&nbsp;<span class="op" id="4834776">=</span>&nbsp;<span class="string" id="4834778">&#34;SunMonTueWedThuFriSat&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4834803">const</span>&nbsp;<span class="ident" id="4834809">months</span>&nbsp;<span class="op" id="4834816">=</span>&nbsp;<span class="string" id="4834818">&#34;JanFebMarAprMayJunJulAugSepOctNovDec&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4834859">t</span>&nbsp;<span class="op" id="4834861">=</span>&nbsp;<span class="ident" id="4834863">t</span><span class="op" id="4834864">.</span><span class="ident" id="4834865">UTC</span><span class="op" id="4834868">(</span><span class="op" id="4834869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4834872">yy</span><span class="op" id="4834874">,</span>&nbsp;<span class="ident" id="4834876">mm</span><span class="op" id="4834878">,</span>&nbsp;<span class="ident" id="4834880">dd</span>&nbsp;<span class="op" id="4834883">:=</span>&nbsp;<span class="ident" id="4834886">t</span><span class="op" id="4834887">.</span><span class="ident" id="4834888">Date</span><span class="op" id="4834892">(</span><span class="op" id="4834893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4834896">hh</span><span class="op" id="4834898">,</span>&nbsp;<span class="ident" id="4834900">mn</span><span class="op" id="4834902">,</span>&nbsp;<span class="ident" id="4834904">ss</span>&nbsp;<span class="op" id="4834907">:=</span>&nbsp;<span class="ident" id="4834910">t</span><span class="op" id="4834911">.</span><span class="ident" id="4834912">Clock</span><span class="op" id="4834917">(</span><span class="op" id="4834918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4834921">day</span>&nbsp;<span class="op" id="4834925">:=</span>&nbsp;<span class="ident" id="4834928">days</span><span class="op" id="4834932">[</span><span class="num" id="4834933">3</span><span class="op" id="4834934">*</span><span class="ident" id="4834935">t</span><span class="op" id="4834936">.</span><span class="ident" id="4834937">Weekday</span><span class="op" id="4834944">(</span><span class="op" id="4834945">)</span><span class="op" id="4834946">:</span><span class="op" id="4834947">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4834950">mon</span>&nbsp;<span class="op" id="4834954">:=</span>&nbsp;<span class="ident" id="4834957">months</span><span class="op" id="4834963">[</span><span class="num" id="4834964">3</span><span class="op" id="4834965">*</span><span class="op" id="4834966">(</span><span class="ident" id="4834967">mm</span><span class="op" id="4834969">-</span><span class="num" id="4834970">1</span><span class="op" id="4834971">)</span><span class="op" id="4834972">:</span><span class="op" id="4834973">]</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4834977">return</span>&nbsp;<span class="builtinfunc" id="4834984">append</span><span class="op" id="4834990">(</span><span class="ident" id="4834991">b</span><span class="op" id="4834992">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4834996">day</span><span class="op" id="4834999">[</span><span class="num" id="4835000">0</span><span class="op" id="4835001">]</span><span class="op" id="4835002">,</span>&nbsp;<span class="ident" id="4835004">day</span><span class="op" id="4835007">[</span><span class="num" id="4835008">1</span><span class="op" id="4835009">]</span><span class="op" id="4835010">,</span>&nbsp;<span class="ident" id="4835012">day</span><span class="op" id="4835015">[</span><span class="num" id="4835016">2</span><span class="op" id="4835017">]</span><span class="op" id="4835018">,</span>&nbsp;<span class="string" id="4835020">&#39;,&#39;</span><span class="op" id="4835023">,</span>&nbsp;<span class="string" id="4835025">&#39;&nbsp;&#39;</span><span class="op" id="4835028">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4835032">byte</span><span class="op" id="4835036">(</span><span class="string" id="4835037">&#39;0&#39;</span><span class="op" id="4835040">+</span><span class="ident" id="4835041">dd</span><span class="op" id="4835043">/</span><span class="num" id="4835044">10</span><span class="op" id="4835046">)</span><span class="op" id="4835047">,</span>&nbsp;<span class="builtintype" id="4835049">byte</span><span class="op" id="4835053">(</span><span class="string" id="4835054">&#39;0&#39;</span><span class="op" id="4835057">+</span><span class="ident" id="4835058">dd</span><span class="op" id="4835060">%</span><span class="num" id="4835061">10</span><span class="op" id="4835063">)</span><span class="op" id="4835064">,</span>&nbsp;<span class="string" id="4835066">&#39;&nbsp;&#39;</span><span class="op" id="4835069">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4835073">mon</span><span class="op" id="4835076">[</span><span class="num" id="4835077">0</span><span class="op" id="4835078">]</span><span class="op" id="4835079">,</span>&nbsp;<span class="ident" id="4835081">mon</span><span class="op" id="4835084">[</span><span class="num" id="4835085">1</span><span class="op" id="4835086">]</span><span class="op" id="4835087">,</span>&nbsp;<span class="ident" id="4835089">mon</span><span class="op" id="4835092">[</span><span class="num" id="4835093">2</span><span class="op" id="4835094">]</span><span class="op" id="4835095">,</span>&nbsp;<span class="string" id="4835097">&#39;&nbsp;&#39;</span><span class="op" id="4835100">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4835104">byte</span><span class="op" id="4835108">(</span><span class="string" id="4835109">&#39;0&#39;</span><span class="op" id="4835112">+</span><span class="ident" id="4835113">yy</span><span class="op" id="4835115">/</span><span class="num" id="4835116">1000</span><span class="op" id="4835120">)</span><span class="op" id="4835121">,</span>&nbsp;<span class="builtintype" id="4835123">byte</span><span class="op" id="4835127">(</span><span class="string" id="4835128">&#39;0&#39;</span><span class="op" id="4835131">+</span><span class="op" id="4835132">(</span><span class="ident" id="4835133">yy</span><span class="op" id="4835135">/</span><span class="num" id="4835136">100</span><span class="op" id="4835139">)</span><span class="op" id="4835140">%</span><span class="num" id="4835141">10</span><span class="op" id="4835143">)</span><span class="op" id="4835144">,</span>&nbsp;<span class="builtintype" id="4835146">byte</span><span class="op" id="4835150">(</span><span class="string" id="4835151">&#39;0&#39;</span><span class="op" id="4835154">+</span><span class="op" id="4835155">(</span><span class="ident" id="4835156">yy</span><span class="op" id="4835158">/</span><span class="num" id="4835159">10</span><span class="op" id="4835161">)</span><span class="op" id="4835162">%</span><span class="num" id="4835163">10</span><span class="op" id="4835165">)</span><span class="op" id="4835166">,</span>&nbsp;<span class="builtintype" id="4835168">byte</span><span class="op" id="4835172">(</span><span class="string" id="4835173">&#39;0&#39;</span><span class="op" id="4835176">+</span><span class="ident" id="4835177">yy</span><span class="op" id="4835179">%</span><span class="num" id="4835180">10</span><span class="op" id="4835182">)</span><span class="op" id="4835183">,</span>&nbsp;<span class="string" id="4835185">&#39;&nbsp;&#39;</span><span class="op" id="4835188">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4835192">byte</span><span class="op" id="4835196">(</span><span class="string" id="4835197">&#39;0&#39;</span><span class="op" id="4835200">+</span><span class="ident" id="4835201">hh</span><span class="op" id="4835203">/</span><span class="num" id="4835204">10</span><span class="op" id="4835206">)</span><span class="op" id="4835207">,</span>&nbsp;<span class="builtintype" id="4835209">byte</span><span class="op" id="4835213">(</span><span class="string" id="4835214">&#39;0&#39;</span><span class="op" id="4835217">+</span><span class="ident" id="4835218">hh</span><span class="op" id="4835220">%</span><span class="num" id="4835221">10</span><span class="op" id="4835223">)</span><span class="op" id="4835224">,</span>&nbsp;<span class="string" id="4835226">&#39;:&#39;</span><span class="op" id="4835229">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4835233">byte</span><span class="op" id="4835237">(</span><span class="string" id="4835238">&#39;0&#39;</span><span class="op" id="4835241">+</span><span class="ident" id="4835242">mn</span><span class="op" id="4835244">/</span><span class="num" id="4835245">10</span><span class="op" id="4835247">)</span><span class="op" id="4835248">,</span>&nbsp;<span class="builtintype" id="4835250">byte</span><span class="op" id="4835254">(</span><span class="string" id="4835255">&#39;0&#39;</span><span class="op" id="4835258">+</span><span class="ident" id="4835259">mn</span><span class="op" id="4835261">%</span><span class="num" id="4835262">10</span><span class="op" id="4835264">)</span><span class="op" id="4835265">,</span>&nbsp;<span class="string" id="4835267">&#39;:&#39;</span><span class="op" id="4835270">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4835274">byte</span><span class="op" id="4835278">(</span><span class="string" id="4835279">&#39;0&#39;</span><span class="op" id="4835282">+</span><span class="ident" id="4835283">ss</span><span class="op" id="4835285">/</span><span class="num" id="4835286">10</span><span class="op" id="4835288">)</span><span class="op" id="4835289">,</span>&nbsp;<span class="builtintype" id="4835291">byte</span><span class="op" id="4835295">(</span><span class="string" id="4835296">&#39;0&#39;</span><span class="op" id="4835299">+</span><span class="ident" id="4835300">ss</span><span class="op" id="4835302">%</span><span class="num" id="4835303">10</span><span class="op" id="4835305">)</span><span class="op" id="4835306">,</span>&nbsp;<span class="string" id="4835308">&#39;&nbsp;&#39;</span><span class="op" id="4835311">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4835315">&#39;G&#39;</span><span class="op" id="4835318">,</span>&nbsp;<span class="string" id="4835320">&#39;M&#39;</span><span class="op" id="4835323">,</span>&nbsp;<span class="string" id="4835325">&#39;T&#39;</span><span class="op" id="4835328">)</span><br>
<span class="lineno">565</span><span class="op" id="4835330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4835333">var</span>&nbsp;<span class="ident" id="4835337">errTooLarge</span>&nbsp;<span class="op" id="4835349">=</span>&nbsp;<span class="ident" id="4835351">errors</span><span class="op" id="4835357">.</span><span class="ident" id="4835358">New</span><span class="op" id="4835361">(</span><span class="string" id="4835362">&#34;http:&nbsp;request&nbsp;too&nbsp;large&#34;</span><span class="op" id="4835387">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4835390">//&nbsp;Read&nbsp;next&nbsp;request&nbsp;from&nbsp;connection.</span><br>
<span class="lineno">570</span><span class="keyword" id="4835428">func</span>&nbsp;<span class="op" id="4835433">(</span><span class="ident" id="4835434">c</span>&nbsp;<span class="op" id="4835436">*</span><span class="ident" id="4835437">conn</span><span class="op" id="4835441">)</span>&nbsp;<span class="ident" id="4835443">readRequest</span><span class="op" id="4835454">(</span><span class="op" id="4835455">)</span>&nbsp;<span class="op" id="4835457">(</span><span class="ident" id="4835458">w</span>&nbsp;<span class="op" id="4835460">*</span><span class="ident" id="4835461">response</span><span class="op" id="4835469">,</span>&nbsp;<span class="ident" id="4835471">err</span>&nbsp;<span class="builtintype" id="4835475">error</span><span class="op" id="4835480">)</span>&nbsp;<span class="op" id="4835482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4835485">if</span>&nbsp;<span class="ident" id="4835488">c</span><span class="op" id="4835489">.</span><span class="ident" id="4835490">hijacked</span><span class="op" id="4835498">(</span><span class="op" id="4835499">)</span>&nbsp;<span class="op" id="4835501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4835505">return</span>&nbsp;<span class="ident" id="4835512">nil</span><span class="op" id="4835515">,</span>&nbsp;<span class="ident" id="4835517">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4835530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4835534">if</span>&nbsp;<span class="ident" id="4835537">d</span>&nbsp;<span class="op" id="4835539">:=</span>&nbsp;<span class="ident" id="4835542">c</span><span class="op" id="4835543">.</span><span class="ident" id="4835544">server</span><span class="op" id="4835550">.</span><span class="ident" id="4835551">ReadTimeout</span><span class="op" id="4835562">;</span>&nbsp;<span class="ident" id="4835564">d</span>&nbsp;<span class="op" id="4835566">!=</span>&nbsp;<span class="num" id="4835569">0</span>&nbsp;<span class="op" id="4835571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4835575">c</span><span class="op" id="4835576">.</span><span class="ident" id="4835577">rwc</span><span class="op" id="4835580">.</span><span class="ident" id="4835581">SetReadDeadline</span><span class="op" id="4835596">(</span><span class="ident" id="4835597">time</span><span class="op" id="4835601">.</span><span class="ident" id="4835602">Now</span><span class="op" id="4835605">(</span><span class="op" id="4835606">)</span><span class="op" id="4835607">.</span><span class="ident" id="4835608">Add</span><span class="op" id="4835611">(</span><span class="ident" id="4835612">d</span><span class="op" id="4835613">)</span><span class="op" id="4835614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4835617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4835620">if</span>&nbsp;<span class="ident" id="4835623">d</span>&nbsp;<span class="op" id="4835625">:=</span>&nbsp;<span class="ident" id="4835628">c</span><span class="op" id="4835629">.</span><span class="ident" id="4835630">server</span><span class="op" id="4835636">.</span><span class="ident" id="4835637">WriteTimeout</span><span class="op" id="4835649">;</span>&nbsp;<span class="ident" id="4835651">d</span>&nbsp;<span class="op" id="4835653">!=</span>&nbsp;<span class="num" id="4835656">0</span>&nbsp;<span class="op" id="4835658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4835662">defer</span>&nbsp;<span class="keyword" id="4835668">func</span><span class="op" id="4835672">(</span><span class="op" id="4835673">)</span>&nbsp;<span class="op" id="4835675">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4835680">c</span><span class="op" id="4835681">.</span><span class="ident" id="4835682">rwc</span><span class="op" id="4835685">.</span><span class="ident" id="4835686">SetWriteDeadline</span><span class="op" id="4835702">(</span><span class="ident" id="4835703">time</span><span class="op" id="4835707">.</span><span class="ident" id="4835708">Now</span><span class="op" id="4835711">(</span><span class="op" id="4835712">)</span><span class="op" id="4835713">.</span><span class="ident" id="4835714">Add</span><span class="op" id="4835717">(</span><span class="ident" id="4835718">d</span><span class="op" id="4835719">)</span><span class="op" id="4835720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4835724">}</span><span class="op" id="4835725">(</span><span class="op" id="4835726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4835729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4835733">c</span><span class="op" id="4835734">.</span><span class="ident" id="4835735">lr</span><span class="op" id="4835737">.</span><span class="ident" id="4835738">N</span>&nbsp;<span class="op" id="4835740">=</span>&nbsp;<span class="ident" id="4835742">c</span><span class="op" id="4835743">.</span><span class="ident" id="4835744">server</span><span class="op" id="4835750">.</span><span class="ident" id="4835751">initialLimitedReaderSize</span><span class="op" id="4835775">(</span><span class="op" id="4835776">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4835779">var</span>&nbsp;<span class="ident" id="4835783">req</span>&nbsp;<span class="op" id="4835787">*</span><span class="ident" id="4835788">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4835797">if</span>&nbsp;<span class="ident" id="4835800">req</span><span class="op" id="4835803">,</span>&nbsp;<span class="ident" id="4835805">err</span>&nbsp;<span class="op" id="4835809">=</span>&nbsp;<span class="ident" id="4835811">ReadRequest</span><span class="op" id="4835822">(</span><span class="ident" id="4835823">c</span><span class="op" id="4835824">.</span><span class="ident" id="4835825">buf</span><span class="op" id="4835828">.</span><span class="ident" id="4835829">Reader</span><span class="op" id="4835835">)</span><span class="op" id="4835836">;</span>&nbsp;<span class="ident" id="4835838">err</span>&nbsp;<span class="op" id="4835842">!=</span>&nbsp;<span class="ident" id="4835845">nil</span>&nbsp;<span class="op" id="4835849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4835853">if</span>&nbsp;<span class="ident" id="4835856">c</span><span class="op" id="4835857">.</span><span class="ident" id="4835858">lr</span><span class="op" id="4835860">.</span><span class="ident" id="4835861">N</span>&nbsp;<span class="op" id="4835863">==</span>&nbsp;<span class="num" id="4835866">0</span>&nbsp;<span class="op" id="4835868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4835873">return</span>&nbsp;<span class="ident" id="4835880">nil</span><span class="op" id="4835883">,</span>&nbsp;<span class="ident" id="4835885">errTooLarge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4835899">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4835903">return</span>&nbsp;<span class="ident" id="4835910">nil</span><span class="op" id="4835913">,</span>&nbsp;<span class="ident" id="4835915">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4835920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4835923">c</span><span class="op" id="4835924">.</span><span class="ident" id="4835925">lr</span><span class="op" id="4835927">.</span><span class="ident" id="4835928">N</span>&nbsp;<span class="op" id="4835930">=</span>&nbsp;<span class="ident" id="4835932">noLimit</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4835942">req</span><span class="op" id="4835945">.</span><span class="ident" id="4835946">RemoteAddr</span>&nbsp;<span class="op" id="4835957">=</span>&nbsp;<span class="ident" id="4835959">c</span><span class="op" id="4835960">.</span><span class="ident" id="4835961">remoteAddr</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4835973">req</span><span class="op" id="4835976">.</span><span class="ident" id="4835977">TLS</span>&nbsp;<span class="op" id="4835981">=</span>&nbsp;<span class="ident" id="4835983">c</span><span class="op" id="4835984">.</span><span class="ident" id="4835985">tlsState</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4835996">w</span>&nbsp;<span class="op" id="4835998">=</span>&nbsp;<span class="op" id="4836000">&amp;</span><span class="ident" id="4836001">response</span><span class="op" id="4836009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4836013">conn</span><span class="op" id="4836017">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4836028">c</span><span class="op" id="4836029">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4836033">req</span><span class="op" id="4836036">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4836048">req</span><span class="op" id="4836051">,</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4836055">handlerHeader</span><span class="op" id="4836068">:</span>&nbsp;<span class="builtinfunc" id="4836070">make</span><span class="op" id="4836074">(</span><span class="ident" id="4836075">Header</span><span class="op" id="4836081">)</span><span class="op" id="4836082">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4836086">contentLength</span><span class="op" id="4836099">:</span>&nbsp;<span class="op" id="4836101">-</span><span class="num" id="4836102">1</span><span class="op" id="4836103">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4836106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4836109">w</span><span class="op" id="4836110">.</span><span class="ident" id="4836111">cw</span><span class="op" id="4836113">.</span><span class="ident" id="4836114">res</span>&nbsp;<span class="op" id="4836118">=</span>&nbsp;<span class="ident" id="4836120">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4836123">w</span><span class="op" id="4836124">.</span><span class="ident" id="4836125">w</span>&nbsp;<span class="op" id="4836127">=</span>&nbsp;<span class="ident" id="4836129">newBufioWriterSize</span><span class="op" id="4836147">(</span><span class="op" id="4836148">&amp;</span><span class="ident" id="4836149">w</span><span class="op" id="4836150">.</span><span class="ident" id="4836151">cw</span><span class="op" id="4836153">,</span>&nbsp;<span class="ident" id="4836155">bufferBeforeChunkingSize</span><span class="op" id="4836179">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4836182">return</span>&nbsp;<span class="ident" id="4836189">w</span><span class="op" id="4836190">,</span>&nbsp;<span class="ident" id="4836192">nil</span><br>
<span class="lineno"></span><span class="op" id="4836196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4836199">func</span>&nbsp;<span class="op" id="4836204">(</span><span class="ident" id="4836205">w</span>&nbsp;<span class="op" id="4836207">*</span><span class="ident" id="4836208">response</span><span class="op" id="4836216">)</span>&nbsp;<span class="ident" id="4836218">Header</span><span class="op" id="4836224">(</span><span class="op" id="4836225">)</span>&nbsp;<span class="ident" id="4836227">Header</span>&nbsp;<span class="op" id="4836234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4836237">if</span>&nbsp;<span class="ident" id="4836240">w</span><span class="op" id="4836241">.</span><span class="ident" id="4836242">cw</span><span class="op" id="4836244">.</span><span class="ident" id="4836245">header</span>&nbsp;<span class="op" id="4836252">==</span>&nbsp;<span class="ident" id="4836255">nil</span>&nbsp;<span class="op" id="4836259">&amp;&amp;</span>&nbsp;<span class="ident" id="4836262">w</span><span class="op" id="4836263">.</span><span class="ident" id="4836264">wroteHeader</span>&nbsp;<span class="op" id="4836276">&amp;&amp;</span>&nbsp;<span class="op" id="4836279">!</span><span class="ident" id="4836280">w</span><span class="op" id="4836281">.</span><span class="ident" id="4836282">cw</span><span class="op" id="4836284">.</span><span class="ident" id="4836285">wroteHeader</span>&nbsp;<span class="op" id="4836297">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4836301">//&nbsp;Accessing&nbsp;the&nbsp;header&nbsp;between&nbsp;logically&nbsp;writing&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4836356">//&nbsp;and&nbsp;physically&nbsp;writing&nbsp;it&nbsp;means&nbsp;we&nbsp;need&nbsp;to&nbsp;allocate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4836413">//&nbsp;a&nbsp;clone&nbsp;to&nbsp;snapshot&nbsp;the&nbsp;logically&nbsp;written&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4836467">w</span><span class="op" id="4836468">.</span><span class="ident" id="4836469">cw</span><span class="op" id="4836471">.</span><span class="ident" id="4836472">header</span>&nbsp;<span class="op" id="4836479">=</span>&nbsp;<span class="ident" id="4836481">w</span><span class="op" id="4836482">.</span><span class="ident" id="4836483">handlerHeader</span><span class="op" id="4836496">.</span><span class="ident" id="4836497">clone</span><span class="op" id="4836502">(</span><span class="op" id="4836503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4836506">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4836509">w</span><span class="op" id="4836510">.</span><span class="ident" id="4836511">calledHeader</span>&nbsp;<span class="op" id="4836524">=</span>&nbsp;<span class="builtintype" id="4836526">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4836532">return</span>&nbsp;<span class="ident" id="4836539">w</span><span class="op" id="4836540">.</span><span class="ident" id="4836541">handlerHeader</span><br>
<span class="lineno"></span><span class="op" id="4836555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4836558">//&nbsp;maxPostHandlerReadBytes&nbsp;is&nbsp;the&nbsp;max&nbsp;number&nbsp;of&nbsp;Request.Body&nbsp;bytes&nbsp;not</span><br>
<span class="lineno">620</span><span class="comment" id="4836629">//&nbsp;consumed&nbsp;by&nbsp;a&nbsp;handler&nbsp;that&nbsp;the&nbsp;server&nbsp;will&nbsp;read&nbsp;from&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="4836696">//&nbsp;in&nbsp;order&nbsp;to&nbsp;keep&nbsp;a&nbsp;connection&nbsp;alive.&nbsp;&nbsp;If&nbsp;there&nbsp;are&nbsp;more&nbsp;bytes&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="4836766">//&nbsp;this&nbsp;then&nbsp;the&nbsp;server&nbsp;to&nbsp;be&nbsp;paranoid&nbsp;instead&nbsp;sends&nbsp;a&nbsp;&#34;Connection:</span><br>
<span class="lineno"></span><span class="comment" id="4836834">//&nbsp;close&#34;&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="4836854">//</span><br>
<span class="lineno">625</span><span class="comment" id="4836857">//&nbsp;This&nbsp;number&nbsp;is&nbsp;approximately&nbsp;what&nbsp;a&nbsp;typical&nbsp;machine&#39;s&nbsp;TCP&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="4836925">//&nbsp;size&nbsp;is&nbsp;anyway.&nbsp;&nbsp;(if&nbsp;we&nbsp;have&nbsp;the&nbsp;bytes&nbsp;on&nbsp;the&nbsp;machine,&nbsp;we&nbsp;might&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="4836995">//&nbsp;well&nbsp;read&nbsp;them)</span><br>
<span class="lineno"></span><span class="keyword" id="4837014">const</span>&nbsp;<span class="ident" id="4837020">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="4837044">=</span>&nbsp;<span class="num" id="4837046">256</span>&nbsp;<span class="op" id="4837050">&lt;&lt;</span>&nbsp;<span class="num" id="4837053">10</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="4837057">func</span>&nbsp;<span class="op" id="4837062">(</span><span class="ident" id="4837063">w</span>&nbsp;<span class="op" id="4837065">*</span><span class="ident" id="4837066">response</span><span class="op" id="4837074">)</span>&nbsp;<span class="ident" id="4837076">WriteHeader</span><span class="op" id="4837087">(</span><span class="ident" id="4837088">code</span>&nbsp;<span class="builtintype" id="4837093">int</span><span class="op" id="4837096">)</span>&nbsp;<span class="op" id="4837098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837101">if</span>&nbsp;<span class="ident" id="4837104">w</span><span class="op" id="4837105">.</span><span class="ident" id="4837106">conn</span><span class="op" id="4837110">.</span><span class="ident" id="4837111">hijacked</span><span class="op" id="4837119">(</span><span class="op" id="4837120">)</span>&nbsp;<span class="op" id="4837122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4837126">w</span><span class="op" id="4837127">.</span><span class="ident" id="4837128">conn</span><span class="op" id="4837132">.</span><span class="ident" id="4837133">server</span><span class="op" id="4837139">.</span><span class="ident" id="4837140">logf</span><span class="op" id="4837144">(</span><span class="string" id="4837145">&#34;http:&nbsp;response.WriteHeader&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="4837196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837200">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4837208">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837211">if</span>&nbsp;<span class="ident" id="4837214">w</span><span class="op" id="4837215">.</span><span class="ident" id="4837216">wroteHeader</span>&nbsp;<span class="op" id="4837228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4837232">w</span><span class="op" id="4837233">.</span><span class="ident" id="4837234">conn</span><span class="op" id="4837238">.</span><span class="ident" id="4837239">server</span><span class="op" id="4837245">.</span><span class="ident" id="4837246">logf</span><span class="op" id="4837250">(</span><span class="string" id="4837251">&#34;http:&nbsp;multiple&nbsp;response.WriteHeader&nbsp;calls&#34;</span><span class="op" id="4837294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837298">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4837306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4837309">w</span><span class="op" id="4837310">.</span><span class="ident" id="4837311">wroteHeader</span>&nbsp;<span class="op" id="4837323">=</span>&nbsp;<span class="builtintype" id="4837325">true</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4837331">w</span><span class="op" id="4837332">.</span><span class="ident" id="4837333">status</span>&nbsp;<span class="op" id="4837340">=</span>&nbsp;<span class="ident" id="4837342">code</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837349">if</span>&nbsp;<span class="ident" id="4837352">w</span><span class="op" id="4837353">.</span><span class="ident" id="4837354">calledHeader</span>&nbsp;<span class="op" id="4837367">&amp;&amp;</span>&nbsp;<span class="ident" id="4837370">w</span><span class="op" id="4837371">.</span><span class="ident" id="4837372">cw</span><span class="op" id="4837374">.</span><span class="ident" id="4837375">header</span>&nbsp;<span class="op" id="4837382">==</span>&nbsp;<span class="ident" id="4837385">nil</span>&nbsp;<span class="op" id="4837389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4837393">w</span><span class="op" id="4837394">.</span><span class="ident" id="4837395">cw</span><span class="op" id="4837397">.</span><span class="ident" id="4837398">header</span>&nbsp;<span class="op" id="4837405">=</span>&nbsp;<span class="ident" id="4837407">w</span><span class="op" id="4837408">.</span><span class="ident" id="4837409">handlerHeader</span><span class="op" id="4837422">.</span><span class="ident" id="4837423">clone</span><span class="op" id="4837428">(</span><span class="op" id="4837429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4837432">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837436">if</span>&nbsp;<span class="ident" id="4837439">cl</span>&nbsp;<span class="op" id="4837442">:=</span>&nbsp;<span class="ident" id="4837445">w</span><span class="op" id="4837446">.</span><span class="ident" id="4837447">handlerHeader</span><span class="op" id="4837460">.</span><span class="ident" id="4837461">get</span><span class="op" id="4837464">(</span><span class="string" id="4837465">&#34;Content-Length&#34;</span><span class="op" id="4837481">)</span><span class="op" id="4837482">;</span>&nbsp;<span class="ident" id="4837484">cl</span>&nbsp;<span class="op" id="4837487">!=</span>&nbsp;<span class="string" id="4837490">&#34;&#34;</span>&nbsp;<span class="op" id="4837493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4837497">v</span><span class="op" id="4837498">,</span>&nbsp;<span class="ident" id="4837500">err</span>&nbsp;<span class="op" id="4837504">:=</span>&nbsp;<span class="ident" id="4837507">strconv</span><span class="op" id="4837514">.</span><span class="ident" id="4837515">ParseInt</span><span class="op" id="4837523">(</span><span class="ident" id="4837524">cl</span><span class="op" id="4837526">,</span>&nbsp;<span class="num" id="4837528">10</span><span class="op" id="4837530">,</span>&nbsp;<span class="num" id="4837532">64</span><span class="op" id="4837534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4837538">if</span>&nbsp;<span class="ident" id="4837541">err</span>&nbsp;<span class="op" id="4837545">==</span>&nbsp;<span class="ident" id="4837548">nil</span>&nbsp;<span class="op" id="4837552">&amp;&amp;</span>&nbsp;<span class="ident" id="4837555">v</span>&nbsp;<span class="op" id="4837557">&gt;=</span>&nbsp;<span class="num" id="4837560">0</span>&nbsp;<span class="op" id="4837562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4837567">w</span><span class="op" id="4837568">.</span><span class="ident" id="4837569">contentLength</span>&nbsp;<span class="op" id="4837583">=</span>&nbsp;<span class="ident" id="4837585">v</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4837589">}</span>&nbsp;<span class="keyword" id="4837591">else</span>&nbsp;<span class="op" id="4837596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4837601">w</span><span class="op" id="4837602">.</span><span class="ident" id="4837603">conn</span><span class="op" id="4837607">.</span><span class="ident" id="4837608">server</span><span class="op" id="4837614">.</span><span class="ident" id="4837615">logf</span><span class="op" id="4837619">(</span><span class="string" id="4837620">&#34;http:&nbsp;invalid&nbsp;Content-Length&nbsp;of&nbsp;%q&#34;</span><span class="op" id="4837656">,</span>&nbsp;<span class="ident" id="4837658">cl</span><span class="op" id="4837660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4837665">w</span><span class="op" id="4837666">.</span><span class="ident" id="4837667">handlerHeader</span><span class="op" id="4837680">.</span><span class="ident" id="4837681">Del</span><span class="op" id="4837684">(</span><span class="string" id="4837685">&#34;Content-Length&#34;</span><span class="op" id="4837701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4837705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4837708">}</span><br>
<span class="lineno">655</span><span class="op" id="4837710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4837713">//&nbsp;extraHeader&nbsp;is&nbsp;the&nbsp;set&nbsp;of&nbsp;headers&nbsp;sometimes&nbsp;added&nbsp;by&nbsp;chunkWriter.writeHeader.</span><br>
<span class="lineno"></span><span class="comment" id="4837794">//&nbsp;This&nbsp;type&nbsp;is&nbsp;used&nbsp;to&nbsp;avoid&nbsp;extra&nbsp;allocations&nbsp;from&nbsp;cloning&nbsp;and/or&nbsp;populating</span><br>
<span class="lineno"></span><span class="comment" id="4837873">//&nbsp;the&nbsp;response&nbsp;Header&nbsp;map&nbsp;and&nbsp;all&nbsp;its&nbsp;1-element&nbsp;slices.</span><br>
<span class="lineno">660</span><span class="keyword" id="4837930">type</span>&nbsp;<span class="ident" id="4837935">extraHeader</span>&nbsp;<span class="keyword" id="4837947">struct</span>&nbsp;<span class="op" id="4837954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4837957">contentType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4837974">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4837982">connection</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4837999">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838007">transferEncoding</span>&nbsp;<span class="builtintype" id="4838024">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838032">date</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4838049">[</span><span class="op" id="4838050">]</span><span class="builtintype" id="4838051">byte</span>&nbsp;<span class="comment" id="4838056">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838079">contentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4838096">[</span><span class="op" id="4838097">]</span><span class="builtintype" id="4838098">byte</span>&nbsp;<span class="comment" id="4838103">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="4838125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4838128">//&nbsp;Sorted&nbsp;the&nbsp;same&nbsp;as&nbsp;extraHeader.Write&#39;s&nbsp;loop.</span><br>
<span class="lineno"></span><span class="keyword" id="4838176">var</span>&nbsp;<span class="ident" id="4838180">extraHeaderKeys</span>&nbsp;<span class="op" id="4838196">=</span>&nbsp;<span class="op" id="4838198">[</span><span class="op" id="4838199">]</span><span class="op" id="4838200">[</span><span class="op" id="4838201">]</span><span class="builtintype" id="4838202">byte</span><span class="op" id="4838206">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4838209">[</span><span class="op" id="4838210">]</span><span class="builtintype" id="4838211">byte</span><span class="op" id="4838215">(</span><span class="string" id="4838216">&#34;Content-Type&#34;</span><span class="op" id="4838230">)</span><span class="op" id="4838231">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4838234">[</span><span class="op" id="4838235">]</span><span class="builtintype" id="4838236">byte</span><span class="op" id="4838240">(</span><span class="string" id="4838241">&#34;Connection&#34;</span><span class="op" id="4838253">)</span><span class="op" id="4838254">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4838257">[</span><span class="op" id="4838258">]</span><span class="builtintype" id="4838259">byte</span><span class="op" id="4838263">(</span><span class="string" id="4838264">&#34;Transfer-Encoding&#34;</span><span class="op" id="4838283">)</span><span class="op" id="4838284">,</span><br>
<span class="lineno"></span><span class="op" id="4838286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span><span class="keyword" id="4838289">var</span>&nbsp;<span class="op" id="4838293">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838296">headerContentLength</span>&nbsp;<span class="op" id="4838316">=</span>&nbsp;<span class="op" id="4838318">[</span><span class="op" id="4838319">]</span><span class="builtintype" id="4838320">byte</span><span class="op" id="4838324">(</span><span class="string" id="4838325">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="4838343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838346">headerDate</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4838366">=</span>&nbsp;<span class="op" id="4838368">[</span><span class="op" id="4838369">]</span><span class="builtintype" id="4838370">byte</span><span class="op" id="4838374">(</span><span class="string" id="4838375">&#34;Date:&nbsp;&#34;</span><span class="op" id="4838383">)</span><br>
<span class="lineno"></span><span class="op" id="4838385">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="comment" id="4838388">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;headers&nbsp;described&nbsp;in&nbsp;h&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="4838437">//</span><br>
<span class="lineno"></span><span class="comment" id="4838440">//&nbsp;This&nbsp;method&nbsp;has&nbsp;a&nbsp;value&nbsp;receiver,&nbsp;despite&nbsp;the&nbsp;somewhat&nbsp;large&nbsp;size</span><br>
<span class="lineno"></span><span class="comment" id="4838509">//&nbsp;of&nbsp;h,&nbsp;because&nbsp;it&nbsp;prevents&nbsp;an&nbsp;allocation.&nbsp;The&nbsp;escape&nbsp;analysis&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="4838579">//&nbsp;smart&nbsp;enough&nbsp;to&nbsp;realize&nbsp;this&nbsp;function&nbsp;doesn&#39;t&nbsp;mutate&nbsp;h.</span><br>
<span class="lineno">685</span><span class="keyword" id="4838638">func</span>&nbsp;<span class="op" id="4838643">(</span><span class="ident" id="4838644">h</span>&nbsp;<span class="ident" id="4838646">extraHeader</span><span class="op" id="4838657">)</span>&nbsp;<span class="ident" id="4838659">Write</span><span class="op" id="4838664">(</span><span class="ident" id="4838665">w</span>&nbsp;<span class="op" id="4838667">*</span><span class="ident" id="4838668">bufio</span><span class="op" id="4838673">.</span><span class="ident" id="4838674">Writer</span><span class="op" id="4838680">)</span>&nbsp;<span class="op" id="4838682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4838685">if</span>&nbsp;<span class="ident" id="4838688">h</span><span class="op" id="4838689">.</span><span class="ident" id="4838690">date</span>&nbsp;<span class="op" id="4838695">!=</span>&nbsp;<span class="ident" id="4838698">nil</span>&nbsp;<span class="op" id="4838702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838706">w</span><span class="op" id="4838707">.</span><span class="ident" id="4838708">Write</span><span class="op" id="4838713">(</span><span class="ident" id="4838714">headerDate</span><span class="op" id="4838724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838728">w</span><span class="op" id="4838729">.</span><span class="ident" id="4838730">Write</span><span class="op" id="4838735">(</span><span class="ident" id="4838736">h</span><span class="op" id="4838737">.</span><span class="ident" id="4838738">date</span><span class="op" id="4838742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838746">w</span><span class="op" id="4838747">.</span><span class="ident" id="4838748">Write</span><span class="op" id="4838753">(</span><span class="ident" id="4838754">crlf</span><span class="op" id="4838758">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4838761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4838764">if</span>&nbsp;<span class="ident" id="4838767">h</span><span class="op" id="4838768">.</span><span class="ident" id="4838769">contentLength</span>&nbsp;<span class="op" id="4838783">!=</span>&nbsp;<span class="ident" id="4838786">nil</span>&nbsp;<span class="op" id="4838790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838794">w</span><span class="op" id="4838795">.</span><span class="ident" id="4838796">Write</span><span class="op" id="4838801">(</span><span class="ident" id="4838802">headerContentLength</span><span class="op" id="4838821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838825">w</span><span class="op" id="4838826">.</span><span class="ident" id="4838827">Write</span><span class="op" id="4838832">(</span><span class="ident" id="4838833">h</span><span class="op" id="4838834">.</span><span class="ident" id="4838835">contentLength</span><span class="op" id="4838848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838852">w</span><span class="op" id="4838853">.</span><span class="ident" id="4838854">Write</span><span class="op" id="4838859">(</span><span class="ident" id="4838860">crlf</span><span class="op" id="4838864">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4838867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4838870">for</span>&nbsp;<span class="ident" id="4838874">i</span><span class="op" id="4838875">,</span>&nbsp;<span class="ident" id="4838877">v</span>&nbsp;<span class="op" id="4838879">:=</span>&nbsp;<span class="keyword" id="4838882">range</span>&nbsp;<span class="op" id="4838888">[</span><span class="op" id="4838889">]</span><span class="builtintype" id="4838890">string</span><span class="op" id="4838896">{</span><span class="ident" id="4838897">h</span><span class="op" id="4838898">.</span><span class="ident" id="4838899">contentType</span><span class="op" id="4838910">,</span>&nbsp;<span class="ident" id="4838912">h</span><span class="op" id="4838913">.</span><span class="ident" id="4838914">connection</span><span class="op" id="4838924">,</span>&nbsp;<span class="ident" id="4838926">h</span><span class="op" id="4838927">.</span><span class="ident" id="4838928">transferEncoding</span><span class="op" id="4838944">}</span>&nbsp;<span class="op" id="4838946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4838950">if</span>&nbsp;<span class="ident" id="4838953">v</span>&nbsp;<span class="op" id="4838955">!=</span>&nbsp;<span class="string" id="4838958">&#34;&#34;</span>&nbsp;<span class="op" id="4838961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838966">w</span><span class="op" id="4838967">.</span><span class="ident" id="4838968">Write</span><span class="op" id="4838973">(</span><span class="ident" id="4838974">extraHeaderKeys</span><span class="op" id="4838989">[</span><span class="ident" id="4838990">i</span><span class="op" id="4838991">]</span><span class="op" id="4838992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4838997">w</span><span class="op" id="4838998">.</span><span class="ident" id="4838999">Write</span><span class="op" id="4839004">(</span><span class="ident" id="4839005">colonSpace</span><span class="op" id="4839015">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839020">w</span><span class="op" id="4839021">.</span><span class="ident" id="4839022">WriteString</span><span class="op" id="4839033">(</span><span class="ident" id="4839034">v</span><span class="op" id="4839035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839040">w</span><span class="op" id="4839041">.</span><span class="ident" id="4839042">Write</span><span class="op" id="4839047">(</span><span class="ident" id="4839048">crlf</span><span class="op" id="4839052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4839056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4839059">}</span><br>
<span class="lineno"></span><span class="op" id="4839061">}</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span><span class="comment" id="4839064">//&nbsp;writeHeader&nbsp;finalizes&nbsp;the&nbsp;header&nbsp;sent&nbsp;to&nbsp;the&nbsp;client&nbsp;and&nbsp;writes&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="4839133">//&nbsp;to&nbsp;cw.res.conn.buf.</span><br>
<span class="lineno"></span><span class="comment" id="4839156">//</span><br>
<span class="lineno"></span><span class="comment" id="4839159">//&nbsp;p&nbsp;is&nbsp;not&nbsp;written&nbsp;by&nbsp;writeHeader,&nbsp;but&nbsp;is&nbsp;the&nbsp;first&nbsp;chunk&nbsp;of&nbsp;the&nbsp;body</span><br>
<span class="lineno">710</span><span class="comment" id="4839230">//&nbsp;that&nbsp;will&nbsp;be&nbsp;written.&nbsp;&nbsp;It&nbsp;is&nbsp;sniffed&nbsp;for&nbsp;a&nbsp;Content-Type&nbsp;if&nbsp;none&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="4839300">//&nbsp;set&nbsp;explicitly.&nbsp;&nbsp;It&#39;s&nbsp;also&nbsp;used&nbsp;to&nbsp;set&nbsp;the&nbsp;Content-Length,&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4839369">//&nbsp;total&nbsp;body&nbsp;size&nbsp;was&nbsp;small&nbsp;and&nbsp;the&nbsp;handler&nbsp;has&nbsp;already&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="4839435">//&nbsp;running.</span><br>
<span class="lineno"></span><span class="keyword" id="4839447">func</span>&nbsp;<span class="op" id="4839452">(</span><span class="ident" id="4839453">cw</span>&nbsp;<span class="op" id="4839456">*</span><span class="ident" id="4839457">chunkWriter</span><span class="op" id="4839468">)</span>&nbsp;<span class="ident" id="4839470">writeHeader</span><span class="op" id="4839481">(</span><span class="ident" id="4839482">p</span>&nbsp;<span class="op" id="4839484">[</span><span class="op" id="4839485">]</span><span class="builtintype" id="4839486">byte</span><span class="op" id="4839490">)</span>&nbsp;<span class="op" id="4839492">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4839495">if</span>&nbsp;<span class="ident" id="4839498">cw</span><span class="op" id="4839500">.</span><span class="ident" id="4839501">wroteHeader</span>&nbsp;<span class="op" id="4839513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4839517">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4839525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839528">cw</span><span class="op" id="4839530">.</span><span class="ident" id="4839531">wroteHeader</span>&nbsp;<span class="op" id="4839543">=</span>&nbsp;<span class="builtintype" id="4839545">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839552">w</span>&nbsp;<span class="op" id="4839554">:=</span>&nbsp;<span class="ident" id="4839557">cw</span><span class="op" id="4839559">.</span><span class="ident" id="4839560">res</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839565">keepAlivesEnabled</span>&nbsp;<span class="op" id="4839583">:=</span>&nbsp;<span class="ident" id="4839586">w</span><span class="op" id="4839587">.</span><span class="ident" id="4839588">conn</span><span class="op" id="4839592">.</span><span class="ident" id="4839593">server</span><span class="op" id="4839599">.</span><span class="ident" id="4839600">doKeepAlives</span><span class="op" id="4839612">(</span><span class="op" id="4839613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839616">isHEAD</span>&nbsp;<span class="op" id="4839623">:=</span>&nbsp;<span class="ident" id="4839626">w</span><span class="op" id="4839627">.</span><span class="ident" id="4839628">req</span><span class="op" id="4839631">.</span><span class="ident" id="4839632">Method</span>&nbsp;<span class="op" id="4839639">==</span>&nbsp;<span class="string" id="4839642">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4839651">//&nbsp;header&nbsp;is&nbsp;written&nbsp;out&nbsp;to&nbsp;w.conn.buf&nbsp;below.&nbsp;Depending&nbsp;on&nbsp;the</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4839715">//&nbsp;state&nbsp;of&nbsp;the&nbsp;handler,&nbsp;we&nbsp;either&nbsp;own&nbsp;the&nbsp;map&nbsp;or&nbsp;not.&nbsp;If&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4839777">//&nbsp;don&#39;t&nbsp;own&nbsp;it,&nbsp;the&nbsp;exclude&nbsp;map&nbsp;is&nbsp;created&nbsp;lazily&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4839833">//&nbsp;WriteSubset&nbsp;to&nbsp;remove&nbsp;headers.&nbsp;The&nbsp;setHeader&nbsp;struct&nbsp;holds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4839895">//&nbsp;headers&nbsp;we&nbsp;need&nbsp;to&nbsp;add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839923">header</span>&nbsp;<span class="op" id="4839930">:=</span>&nbsp;<span class="ident" id="4839933">cw</span><span class="op" id="4839935">.</span><span class="ident" id="4839936">header</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839944">owned</span>&nbsp;<span class="op" id="4839950">:=</span>&nbsp;<span class="ident" id="4839953">header</span>&nbsp;<span class="op" id="4839960">!=</span>&nbsp;<span class="ident" id="4839963">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4839968">if</span>&nbsp;<span class="op" id="4839971">!</span><span class="ident" id="4839972">owned</span>&nbsp;<span class="op" id="4839978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4839982">header</span>&nbsp;<span class="op" id="4839989">=</span>&nbsp;<span class="ident" id="4839991">w</span><span class="op" id="4839992">.</span><span class="ident" id="4839993">handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4840008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4840011">var</span>&nbsp;<span class="ident" id="4840015">excludeHeader</span>&nbsp;<span class="keyword" id="4840029">map</span><span class="op" id="4840032">[</span><span class="builtintype" id="4840033">string</span><span class="op" id="4840039">]</span><span class="builtintype" id="4840040">bool</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4840046">delHeader</span>&nbsp;<span class="op" id="4840056">:=</span>&nbsp;<span class="keyword" id="4840059">func</span><span class="op" id="4840063">(</span><span class="ident" id="4840064">key</span>&nbsp;<span class="builtintype" id="4840068">string</span><span class="op" id="4840074">)</span>&nbsp;<span class="op" id="4840076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4840080">if</span>&nbsp;<span class="ident" id="4840083">owned</span>&nbsp;<span class="op" id="4840089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4840094">header</span><span class="op" id="4840100">.</span><span class="ident" id="4840101">Del</span><span class="op" id="4840104">(</span><span class="ident" id="4840105">key</span><span class="op" id="4840108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4840113">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4840122">}</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4840126">if</span>&nbsp;<span class="ident" id="4840129">_</span><span class="op" id="4840130">,</span>&nbsp;<span class="ident" id="4840132">ok</span>&nbsp;<span class="op" id="4840135">:=</span>&nbsp;<span class="ident" id="4840138">header</span><span class="op" id="4840144">[</span><span class="ident" id="4840145">key</span><span class="op" id="4840148">]</span><span class="op" id="4840149">;</span>&nbsp;<span class="op" id="4840151">!</span><span class="ident" id="4840152">ok</span>&nbsp;<span class="op" id="4840155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4840160">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4840169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4840173">if</span>&nbsp;<span class="ident" id="4840176">excludeHeader</span>&nbsp;<span class="op" id="4840190">==</span>&nbsp;<span class="ident" id="4840193">nil</span>&nbsp;<span class="op" id="4840197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4840202">excludeHeader</span>&nbsp;<span class="op" id="4840216">=</span>&nbsp;<span class="builtinfunc" id="4840218">make</span><span class="op" id="4840222">(</span><span class="keyword" id="4840223">map</span><span class="op" id="4840226">[</span><span class="builtintype" id="4840227">string</span><span class="op" id="4840233">]</span><span class="builtintype" id="4840234">bool</span><span class="op" id="4840238">)</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4840242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4840246">excludeHeader</span><span class="op" id="4840259">[</span><span class="ident" id="4840260">key</span><span class="op" id="4840263">]</span>&nbsp;<span class="op" id="4840265">=</span>&nbsp;<span class="builtintype" id="4840267">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4840273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4840276">var</span>&nbsp;<span class="ident" id="4840280">setHeader</span>&nbsp;<span class="ident" id="4840290">extraHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4840304">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;is&nbsp;done&nbsp;but&nbsp;never&nbsp;sent&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4840363">//&nbsp;response&nbsp;header&nbsp;and&nbsp;this&nbsp;is&nbsp;our&nbsp;first&nbsp;(and&nbsp;last)&nbsp;write,&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4840427">//&nbsp;it,&nbsp;even&nbsp;to&nbsp;zero.&nbsp;This&nbsp;helps&nbsp;HTTP/1.0&nbsp;clients&nbsp;keep&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4840488">//&nbsp;&#34;keep-alive&#34;&nbsp;connections&nbsp;alive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4840524">//&nbsp;Exceptions:&nbsp;304/204/1xx&nbsp;responses&nbsp;never&nbsp;get&nbsp;Content-Length,&nbsp;and&nbsp;if</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4840595">//&nbsp;it&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;difference&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4840659">//&nbsp;0&nbsp;actual&nbsp;bytes&nbsp;and&nbsp;0&nbsp;bytes&nbsp;because&nbsp;the&nbsp;handler&nbsp;noticed&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4840721">//&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request&nbsp;and&nbsp;chose&nbsp;not&nbsp;to&nbsp;write&nbsp;anything.&nbsp;&nbsp;So&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4840785">//&nbsp;HEAD,&nbsp;the&nbsp;handler&nbsp;should&nbsp;either&nbsp;write&nbsp;the&nbsp;Content-Length&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4840849">//&nbsp;write&nbsp;non-zero&nbsp;bytes.&nbsp;&nbsp;If&nbsp;it&#39;s&nbsp;actually&nbsp;0&nbsp;bytes&nbsp;and&nbsp;the</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4840909">//&nbsp;handler&nbsp;never&nbsp;looked&nbsp;at&nbsp;the&nbsp;Request.Method,&nbsp;we&nbsp;just&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4840971">//&nbsp;send&nbsp;a&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4841005">if</span>&nbsp;<span class="ident" id="4841008">w</span><span class="op" id="4841009">.</span><span class="ident" id="4841010">handlerDone</span>&nbsp;<span class="op" id="4841022">&amp;&amp;</span>&nbsp;<span class="ident" id="4841025">bodyAllowedForStatus</span><span class="op" id="4841045">(</span><span class="ident" id="4841046">w</span><span class="op" id="4841047">.</span><span class="ident" id="4841048">status</span><span class="op" id="4841054">)</span>&nbsp;<span class="op" id="4841056">&amp;&amp;</span>&nbsp;<span class="ident" id="4841059">header</span><span class="op" id="4841065">.</span><span class="ident" id="4841066">get</span><span class="op" id="4841069">(</span><span class="string" id="4841070">&#34;Content-Length&#34;</span><span class="op" id="4841086">)</span>&nbsp;<span class="op" id="4841088">==</span>&nbsp;<span class="string" id="4841091">&#34;&#34;</span>&nbsp;<span class="op" id="4841094">&amp;&amp;</span>&nbsp;<span class="op" id="4841097">(</span><span class="op" id="4841098">!</span><span class="ident" id="4841099">isHEAD</span>&nbsp;<span class="op" id="4841106">||</span>&nbsp;<span class="builtinfunc" id="4841109">len</span><span class="op" id="4841112">(</span><span class="ident" id="4841113">p</span><span class="op" id="4841114">)</span>&nbsp;<span class="op" id="4841116">&gt;</span>&nbsp;<span class="num" id="4841118">0</span><span class="op" id="4841119">)</span>&nbsp;<span class="op" id="4841121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4841125">w</span><span class="op" id="4841126">.</span><span class="ident" id="4841127">contentLength</span>&nbsp;<span class="op" id="4841141">=</span>&nbsp;<span class="ident" id="4841143">int64</span><span class="op" id="4841148">(</span><span class="builtinfunc" id="4841149">len</span><span class="op" id="4841152">(</span><span class="ident" id="4841153">p</span><span class="op" id="4841154">)</span><span class="op" id="4841155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4841159">setHeader</span><span class="op" id="4841168">.</span><span class="ident" id="4841169">contentLength</span>&nbsp;<span class="op" id="4841183">=</span>&nbsp;<span class="ident" id="4841185">strconv</span><span class="op" id="4841192">.</span><span class="ident" id="4841193">AppendInt</span><span class="op" id="4841202">(</span><span class="ident" id="4841203">cw</span><span class="op" id="4841205">.</span><span class="ident" id="4841206">res</span><span class="op" id="4841209">.</span><span class="ident" id="4841210">clenBuf</span><span class="op" id="4841217">[</span><span class="op" id="4841218">:</span><span class="num" id="4841219">0</span><span class="op" id="4841220">]</span><span class="op" id="4841221">,</span>&nbsp;<span class="ident" id="4841223">int64</span><span class="op" id="4841228">(</span><span class="builtinfunc" id="4841229">len</span><span class="op" id="4841232">(</span><span class="ident" id="4841233">p</span><span class="op" id="4841234">)</span><span class="op" id="4841235">)</span><span class="op" id="4841236">,</span>&nbsp;<span class="num" id="4841238">10</span><span class="op" id="4841240">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4841243">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4841247">//&nbsp;If&nbsp;this&nbsp;was&nbsp;an&nbsp;HTTP/1.0&nbsp;request&nbsp;with&nbsp;keep-alive&nbsp;and&nbsp;we&nbsp;sent&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4841313">//&nbsp;Content-Length&nbsp;back,&nbsp;we&nbsp;can&nbsp;make&nbsp;this&nbsp;a&nbsp;keep-alive&nbsp;response&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4841381">if</span>&nbsp;<span class="ident" id="4841384">w</span><span class="op" id="4841385">.</span><span class="ident" id="4841386">req</span><span class="op" id="4841389">.</span><span class="ident" id="4841390">wantsHttp10KeepAlive</span><span class="op" id="4841410">(</span><span class="op" id="4841411">)</span>&nbsp;<span class="op" id="4841413">&amp;&amp;</span>&nbsp;<span class="ident" id="4841416">keepAlivesEnabled</span>&nbsp;<span class="op" id="4841434">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4841438">sentLength</span>&nbsp;<span class="op" id="4841449">:=</span>&nbsp;<span class="ident" id="4841452">header</span><span class="op" id="4841458">.</span><span class="ident" id="4841459">get</span><span class="op" id="4841462">(</span><span class="string" id="4841463">&#34;Content-Length&#34;</span><span class="op" id="4841479">)</span>&nbsp;<span class="op" id="4841481">!=</span>&nbsp;<span class="string" id="4841484">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4841489">if</span>&nbsp;<span class="ident" id="4841492">sentLength</span>&nbsp;<span class="op" id="4841503">&amp;&amp;</span>&nbsp;<span class="ident" id="4841506">header</span><span class="op" id="4841512">.</span><span class="ident" id="4841513">get</span><span class="op" id="4841516">(</span><span class="string" id="4841517">&#34;Connection&#34;</span><span class="op" id="4841529">)</span>&nbsp;<span class="op" id="4841531">==</span>&nbsp;<span class="string" id="4841534">&#34;keep-alive&#34;</span>&nbsp;<span class="op" id="4841547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4841552">w</span><span class="op" id="4841553">.</span><span class="ident" id="4841554">closeAfterReply</span>&nbsp;<span class="op" id="4841570">=</span>&nbsp;<span class="builtintype" id="4841572">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4841580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4841583">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4841587">//&nbsp;Check&nbsp;for&nbsp;a&nbsp;explicit&nbsp;(and&nbsp;valid)&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4841647">hasCL</span>&nbsp;<span class="op" id="4841653">:=</span>&nbsp;<span class="ident" id="4841656">w</span><span class="op" id="4841657">.</span><span class="ident" id="4841658">contentLength</span>&nbsp;<span class="op" id="4841672">!=</span>&nbsp;<span class="op" id="4841675">-</span><span class="num" id="4841676">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4841680">if</span>&nbsp;<span class="ident" id="4841683">w</span><span class="op" id="4841684">.</span><span class="ident" id="4841685">req</span><span class="op" id="4841688">.</span><span class="ident" id="4841689">wantsHttp10KeepAlive</span><span class="op" id="4841709">(</span><span class="op" id="4841710">)</span>&nbsp;<span class="op" id="4841712">&amp;&amp;</span>&nbsp;<span class="op" id="4841715">(</span><span class="ident" id="4841716">isHEAD</span>&nbsp;<span class="op" id="4841723">||</span>&nbsp;<span class="ident" id="4841726">hasCL</span><span class="op" id="4841731">)</span>&nbsp;<span class="op" id="4841733">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4841737">_</span><span class="op" id="4841738">,</span>&nbsp;<span class="ident" id="4841740">connectionHeaderSet</span>&nbsp;<span class="op" id="4841760">:=</span>&nbsp;<span class="ident" id="4841763">header</span><span class="op" id="4841769">[</span><span class="string" id="4841770">&#34;Connection&#34;</span><span class="op" id="4841782">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4841786">if</span>&nbsp;<span class="op" id="4841789">!</span><span class="ident" id="4841790">connectionHeaderSet</span>&nbsp;<span class="op" id="4841810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4841815">setHeader</span><span class="op" id="4841824">.</span><span class="ident" id="4841825">connection</span>&nbsp;<span class="op" id="4841836">=</span>&nbsp;<span class="string" id="4841838">&#34;keep-alive&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4841853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4841856">}</span>&nbsp;<span class="keyword" id="4841858">else</span>&nbsp;<span class="keyword" id="4841863">if</span>&nbsp;<span class="op" id="4841866">!</span><span class="ident" id="4841867">w</span><span class="op" id="4841868">.</span><span class="ident" id="4841869">req</span><span class="op" id="4841872">.</span><span class="ident" id="4841873">ProtoAtLeast</span><span class="op" id="4841885">(</span><span class="num" id="4841886">1</span><span class="op" id="4841887">,</span>&nbsp;<span class="num" id="4841889">1</span><span class="op" id="4841890">)</span>&nbsp;<span class="op" id="4841892">||</span>&nbsp;<span class="ident" id="4841895">w</span><span class="op" id="4841896">.</span><span class="ident" id="4841897">req</span><span class="op" id="4841900">.</span><span class="ident" id="4841901">wantsClose</span><span class="op" id="4841911">(</span><span class="op" id="4841912">)</span>&nbsp;<span class="op" id="4841914">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4841918">w</span><span class="op" id="4841919">.</span><span class="ident" id="4841920">closeAfterReply</span>&nbsp;<span class="op" id="4841936">=</span>&nbsp;<span class="builtintype" id="4841938">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4841944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4841948">if</span>&nbsp;<span class="ident" id="4841951">header</span><span class="op" id="4841957">.</span><span class="ident" id="4841958">get</span><span class="op" id="4841961">(</span><span class="string" id="4841962">&#34;Connection&#34;</span><span class="op" id="4841974">)</span>&nbsp;<span class="op" id="4841976">==</span>&nbsp;<span class="string" id="4841979">&#34;close&#34;</span>&nbsp;<span class="op" id="4841987">||</span>&nbsp;<span class="op" id="4841990">!</span><span class="ident" id="4841991">keepAlivesEnabled</span>&nbsp;<span class="op" id="4842009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4842013">w</span><span class="op" id="4842014">.</span><span class="ident" id="4842015">closeAfterReply</span>&nbsp;<span class="op" id="4842031">=</span>&nbsp;<span class="builtintype" id="4842033">true</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4842039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4842043">//&nbsp;Per&nbsp;RFC&nbsp;2616,&nbsp;we&nbsp;should&nbsp;consume&nbsp;the&nbsp;request&nbsp;body&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4842103">//&nbsp;replying,&nbsp;if&nbsp;the&nbsp;handler&nbsp;hasn&#39;t&nbsp;already&nbsp;done&nbsp;so.&nbsp;&nbsp;But&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4842164">//&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;do&nbsp;an&nbsp;unbounded&nbsp;amount&nbsp;of&nbsp;reading&nbsp;here&nbsp;for</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4842225">//&nbsp;DoS&nbsp;reasons,&nbsp;so&nbsp;we&nbsp;only&nbsp;try&nbsp;up&nbsp;to&nbsp;a&nbsp;threshold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4842276">if</span>&nbsp;<span class="ident" id="4842279">w</span><span class="op" id="4842280">.</span><span class="ident" id="4842281">req</span><span class="op" id="4842284">.</span><span class="ident" id="4842285">ContentLength</span>&nbsp;<span class="op" id="4842299">!=</span>&nbsp;<span class="num" id="4842302">0</span>&nbsp;<span class="op" id="4842304">&amp;&amp;</span>&nbsp;<span class="op" id="4842307">!</span><span class="ident" id="4842308">w</span><span class="op" id="4842309">.</span><span class="ident" id="4842310">closeAfterReply</span>&nbsp;<span class="op" id="4842326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4842330">ecr</span><span class="op" id="4842333">,</span>&nbsp;<span class="ident" id="4842335">isExpecter</span>&nbsp;<span class="op" id="4842346">:=</span>&nbsp;<span class="ident" id="4842349">w</span><span class="op" id="4842350">.</span><span class="ident" id="4842351">req</span><span class="op" id="4842354">.</span><span class="ident" id="4842355">Body</span><span class="op" id="4842359">.</span><span class="op" id="4842360">(</span><span class="op" id="4842361">*</span><span class="ident" id="4842362">expectContinueReader</span><span class="op" id="4842382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4842386">if</span>&nbsp;<span class="op" id="4842389">!</span><span class="ident" id="4842390">isExpecter</span>&nbsp;<span class="op" id="4842401">||</span>&nbsp;<span class="ident" id="4842404">ecr</span><span class="op" id="4842407">.</span><span class="ident" id="4842408">resp</span><span class="op" id="4842412">.</span><span class="ident" id="4842413">wroteContinue</span>&nbsp;<span class="op" id="4842427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4842432">n</span><span class="op" id="4842433">,</span>&nbsp;<span class="ident" id="4842435">_</span>&nbsp;<span class="op" id="4842437">:=</span>&nbsp;<span class="ident" id="4842440">io</span><span class="op" id="4842442">.</span><span class="ident" id="4842443">CopyN</span><span class="op" id="4842448">(</span><span class="ident" id="4842449">ioutil</span><span class="op" id="4842455">.</span><span class="ident" id="4842456">Discard</span><span class="op" id="4842463">,</span>&nbsp;<span class="ident" id="4842465">w</span><span class="op" id="4842466">.</span><span class="ident" id="4842467">req</span><span class="op" id="4842470">.</span><span class="ident" id="4842471">Body</span><span class="op" id="4842475">,</span>&nbsp;<span class="ident" id="4842477">maxPostHandlerReadBytes</span><span class="op" id="4842500">+</span><span class="num" id="4842501">1</span><span class="op" id="4842502">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4842507">if</span>&nbsp;<span class="ident" id="4842510">n</span>&nbsp;<span class="op" id="4842512">&gt;=</span>&nbsp;<span class="ident" id="4842515">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="4842539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4842545">w</span><span class="op" id="4842546">.</span><span class="ident" id="4842547">requestTooLarge</span><span class="op" id="4842562">(</span><span class="op" id="4842563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4842569">delHeader</span><span class="op" id="4842578">(</span><span class="string" id="4842579">&#34;Connection&#34;</span><span class="op" id="4842591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4842597">setHeader</span><span class="op" id="4842606">.</span><span class="ident" id="4842607">connection</span>&nbsp;<span class="op" id="4842618">=</span>&nbsp;<span class="string" id="4842620">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4842631">}</span>&nbsp;<span class="keyword" id="4842633">else</span>&nbsp;<span class="op" id="4842638">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4842644">w</span><span class="op" id="4842645">.</span><span class="ident" id="4842646">req</span><span class="op" id="4842649">.</span><span class="ident" id="4842650">Body</span><span class="op" id="4842654">.</span><span class="ident" id="4842655">Close</span><span class="op" id="4842660">(</span><span class="op" id="4842661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4842666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4842670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4842673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4842677">code</span>&nbsp;<span class="op" id="4842682">:=</span>&nbsp;<span class="ident" id="4842685">w</span><span class="op" id="4842686">.</span><span class="ident" id="4842687">status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4842695">if</span>&nbsp;<span class="ident" id="4842698">bodyAllowedForStatus</span><span class="op" id="4842718">(</span><span class="ident" id="4842719">code</span><span class="op" id="4842723">)</span>&nbsp;<span class="op" id="4842725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4842729">//&nbsp;If&nbsp;no&nbsp;content&nbsp;type,&nbsp;apply&nbsp;sniffing&nbsp;algorithm&nbsp;to&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4842788">_</span><span class="op" id="4842789">,</span>&nbsp;<span class="ident" id="4842791">haveType</span>&nbsp;<span class="op" id="4842800">:=</span>&nbsp;<span class="ident" id="4842803">header</span><span class="op" id="4842809">[</span><span class="string" id="4842810">&#34;Content-Type&#34;</span><span class="op" id="4842824">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4842828">if</span>&nbsp;<span class="op" id="4842831">!</span><span class="ident" id="4842832">haveType</span>&nbsp;<span class="op" id="4842841">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4842846">setHeader</span><span class="op" id="4842855">.</span><span class="ident" id="4842856">contentType</span>&nbsp;<span class="op" id="4842868">=</span>&nbsp;<span class="ident" id="4842870">DetectContentType</span><span class="op" id="4842887">(</span><span class="ident" id="4842888">p</span><span class="op" id="4842889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4842893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4842896">}</span>&nbsp;<span class="keyword" id="4842898">else</span>&nbsp;<span class="op" id="4842903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4842907">for</span>&nbsp;<span class="ident" id="4842911">_</span><span class="op" id="4842912">,</span>&nbsp;<span class="ident" id="4842914">k</span>&nbsp;<span class="op" id="4842916">:=</span>&nbsp;<span class="keyword" id="4842919">range</span>&nbsp;<span class="ident" id="4842925">suppressedHeaders</span><span class="op" id="4842942">(</span><span class="ident" id="4842943">code</span><span class="op" id="4842947">)</span>&nbsp;<span class="op" id="4842949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4842954">delHeader</span><span class="op" id="4842963">(</span><span class="ident" id="4842964">k</span><span class="op" id="4842965">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4842969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4842972">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4842976">if</span>&nbsp;<span class="ident" id="4842979">_</span><span class="op" id="4842980">,</span>&nbsp;<span class="ident" id="4842982">ok</span>&nbsp;<span class="op" id="4842985">:=</span>&nbsp;<span class="ident" id="4842988">header</span><span class="op" id="4842994">[</span><span class="string" id="4842995">&#34;Date&#34;</span><span class="op" id="4843001">]</span><span class="op" id="4843002">;</span>&nbsp;<span class="op" id="4843004">!</span><span class="ident" id="4843005">ok</span>&nbsp;<span class="op" id="4843008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4843012">setHeader</span><span class="op" id="4843021">.</span><span class="ident" id="4843022">date</span>&nbsp;<span class="op" id="4843027">=</span>&nbsp;<span class="ident" id="4843029">appendTime</span><span class="op" id="4843039">(</span><span class="ident" id="4843040">cw</span><span class="op" id="4843042">.</span><span class="ident" id="4843043">res</span><span class="op" id="4843046">.</span><span class="ident" id="4843047">dateBuf</span><span class="op" id="4843054">[</span><span class="op" id="4843055">:</span><span class="num" id="4843056">0</span><span class="op" id="4843057">]</span><span class="op" id="4843058">,</span>&nbsp;<span class="ident" id="4843060">time</span><span class="op" id="4843064">.</span><span class="ident" id="4843065">Now</span><span class="op" id="4843068">(</span><span class="op" id="4843069">)</span><span class="op" id="4843070">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4843073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4843077">te</span>&nbsp;<span class="op" id="4843080">:=</span>&nbsp;<span class="ident" id="4843083">header</span><span class="op" id="4843089">.</span><span class="ident" id="4843090">get</span><span class="op" id="4843093">(</span><span class="string" id="4843094">&#34;Transfer-Encoding&#34;</span><span class="op" id="4843113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4843116">hasTE</span>&nbsp;<span class="op" id="4843122">:=</span>&nbsp;<span class="ident" id="4843125">te</span>&nbsp;<span class="op" id="4843128">!=</span>&nbsp;<span class="string" id="4843131">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4843135">if</span>&nbsp;<span class="ident" id="4843138">hasCL</span>&nbsp;<span class="op" id="4843144">&amp;&amp;</span>&nbsp;<span class="ident" id="4843147">hasTE</span>&nbsp;<span class="op" id="4843153">&amp;&amp;</span>&nbsp;<span class="ident" id="4843156">te</span>&nbsp;<span class="op" id="4843159">!=</span>&nbsp;<span class="string" id="4843162">&#34;identity&#34;</span>&nbsp;<span class="op" id="4843173">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4843177">//&nbsp;TODO:&nbsp;return&nbsp;an&nbsp;error&nbsp;if&nbsp;WriteHeader&nbsp;gets&nbsp;a&nbsp;return&nbsp;parameter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4843243">//&nbsp;For&nbsp;now&nbsp;just&nbsp;ignore&nbsp;the&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4843288">w</span><span class="op" id="4843289">.</span><span class="ident" id="4843290">conn</span><span class="op" id="4843294">.</span><span class="ident" id="4843295">server</span><span class="op" id="4843301">.</span><span class="ident" id="4843302">logf</span><span class="op" id="4843306">(</span><span class="string" id="4843307">&#34;http:&nbsp;WriteHeader&nbsp;called&nbsp;with&nbsp;both&nbsp;Transfer-Encoding&nbsp;of&nbsp;%q&nbsp;and&nbsp;a&nbsp;Content-Length&nbsp;of&nbsp;%d&#34;</span><span class="op" id="4843394">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4843399">te</span><span class="op" id="4843401">,</span>&nbsp;<span class="ident" id="4843403">w</span><span class="op" id="4843404">.</span><span class="ident" id="4843405">contentLength</span><span class="op" id="4843418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4843422">delHeader</span><span class="op" id="4843431">(</span><span class="string" id="4843432">&#34;Content-Length&#34;</span><span class="op" id="4843448">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4843452">hasCL</span>&nbsp;<span class="op" id="4843458">=</span>&nbsp;<span class="builtintype" id="4843460">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4843467">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4843471">if</span>&nbsp;<span class="ident" id="4843474">w</span><span class="op" id="4843475">.</span><span class="ident" id="4843476">req</span><span class="op" id="4843479">.</span><span class="ident" id="4843480">Method</span>&nbsp;<span class="op" id="4843487">==</span>&nbsp;<span class="string" id="4843490">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4843497">||</span>&nbsp;<span class="op" id="4843500">!</span><span class="ident" id="4843501">bodyAllowedForStatus</span><span class="op" id="4843521">(</span><span class="ident" id="4843522">code</span><span class="op" id="4843526">)</span>&nbsp;<span class="op" id="4843528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4843532">//&nbsp;do&nbsp;nothing</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4843547">}</span>&nbsp;<span class="keyword" id="4843549">else</span>&nbsp;<span class="keyword" id="4843554">if</span>&nbsp;<span class="ident" id="4843557">code</span>&nbsp;<span class="op" id="4843562">==</span>&nbsp;<span class="ident" id="4843565">StatusNoContent</span>&nbsp;<span class="op" id="4843581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4843585">delHeader</span><span class="op" id="4843594">(</span><span class="string" id="4843595">&#34;Transfer-Encoding&#34;</span><span class="op" id="4843614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4843617">}</span>&nbsp;<span class="keyword" id="4843619">else</span>&nbsp;<span class="keyword" id="4843624">if</span>&nbsp;<span class="ident" id="4843627">hasCL</span>&nbsp;<span class="op" id="4843633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4843637">delHeader</span><span class="op" id="4843646">(</span><span class="string" id="4843647">&#34;Transfer-Encoding&#34;</span><span class="op" id="4843666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4843669">}</span>&nbsp;<span class="keyword" id="4843671">else</span>&nbsp;<span class="keyword" id="4843676">if</span>&nbsp;<span class="ident" id="4843679">w</span><span class="op" id="4843680">.</span><span class="ident" id="4843681">req</span><span class="op" id="4843684">.</span><span class="ident" id="4843685">ProtoAtLeast</span><span class="op" id="4843697">(</span><span class="num" id="4843698">1</span><span class="op" id="4843699">,</span>&nbsp;<span class="num" id="4843701">1</span><span class="op" id="4843702">)</span>&nbsp;<span class="op" id="4843704">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4843708">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;Transfer-Encoding&nbsp;has&nbsp;been&nbsp;set&nbsp;to&nbsp;identity,&nbsp;&nbsp;and&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4843786">//&nbsp;content-length&nbsp;has&nbsp;been&nbsp;provided.&nbsp;The&nbsp;connection&nbsp;must&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4843865">//&nbsp;reply&nbsp;is&nbsp;written,&nbsp;and&nbsp;no&nbsp;chunking&nbsp;is&nbsp;to&nbsp;be&nbsp;done.&nbsp;This&nbsp;is&nbsp;the&nbsp;setup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4843937">//&nbsp;recommended&nbsp;in&nbsp;the&nbsp;Server-Sent&nbsp;Events&nbsp;candidate&nbsp;recommendation&nbsp;11,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4844009">//&nbsp;section&nbsp;8.</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4844025">if</span>&nbsp;<span class="ident" id="4844028">hasTE</span>&nbsp;<span class="op" id="4844034">&amp;&amp;</span>&nbsp;<span class="ident" id="4844037">te</span>&nbsp;<span class="op" id="4844040">==</span>&nbsp;<span class="string" id="4844043">&#34;identity&#34;</span>&nbsp;<span class="op" id="4844054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4844059">cw</span><span class="op" id="4844061">.</span><span class="ident" id="4844062">chunking</span>&nbsp;<span class="op" id="4844071">=</span>&nbsp;<span class="builtintype" id="4844073">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4844082">w</span><span class="op" id="4844083">.</span><span class="ident" id="4844084">closeAfterReply</span>&nbsp;<span class="op" id="4844100">=</span>&nbsp;<span class="builtintype" id="4844102">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4844109">}</span>&nbsp;<span class="keyword" id="4844111">else</span>&nbsp;<span class="op" id="4844116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4844121">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;use&nbsp;chunked&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4844178">//&nbsp;to&nbsp;avoid&nbsp;closing&nbsp;the&nbsp;connection&nbsp;at&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4844224">cw</span><span class="op" id="4844226">.</span><span class="ident" id="4844227">chunking</span>&nbsp;<span class="op" id="4844236">=</span>&nbsp;<span class="builtintype" id="4844238">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4844246">setHeader</span><span class="op" id="4844255">.</span><span class="ident" id="4844256">transferEncoding</span>&nbsp;<span class="op" id="4844273">=</span>&nbsp;<span class="string" id="4844275">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4844287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4844290">}</span>&nbsp;<span class="keyword" id="4844292">else</span>&nbsp;<span class="op" id="4844297">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4844301">//&nbsp;HTTP&nbsp;version&nbsp;&lt;&nbsp;1.1:&nbsp;cannot&nbsp;do&nbsp;chunked&nbsp;transfer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4844353">//&nbsp;encoding&nbsp;and&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;Content-Length&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4844407">//&nbsp;signal&nbsp;EOF&nbsp;by&nbsp;closing&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4844446">w</span><span class="op" id="4844447">.</span><span class="ident" id="4844448">closeAfterReply</span>&nbsp;<span class="op" id="4844464">=</span>&nbsp;<span class="builtintype" id="4844466">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4844473">delHeader</span><span class="op" id="4844482">(</span><span class="string" id="4844483">&#34;Transfer-Encoding&#34;</span><span class="op" id="4844502">)</span>&nbsp;<span class="comment" id="4844504">//&nbsp;in&nbsp;case&nbsp;already&nbsp;set</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4844528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4844532">//&nbsp;Cannot&nbsp;use&nbsp;Content-Length&nbsp;with&nbsp;non-identity&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4844599">if</span>&nbsp;<span class="ident" id="4844602">cw</span><span class="op" id="4844604">.</span><span class="ident" id="4844605">chunking</span>&nbsp;<span class="op" id="4844614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4844618">delHeader</span><span class="op" id="4844627">(</span><span class="string" id="4844628">&#34;Content-Length&#34;</span><span class="op" id="4844644">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4844647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4844650">if</span>&nbsp;<span class="op" id="4844653">!</span><span class="ident" id="4844654">w</span><span class="op" id="4844655">.</span><span class="ident" id="4844656">req</span><span class="op" id="4844659">.</span><span class="ident" id="4844660">ProtoAtLeast</span><span class="op" id="4844672">(</span><span class="num" id="4844673">1</span><span class="op" id="4844674">,</span>&nbsp;<span class="num" id="4844676">0</span><span class="op" id="4844677">)</span>&nbsp;<span class="op" id="4844679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4844683">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4844691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4844695">if</span>&nbsp;<span class="ident" id="4844698">w</span><span class="op" id="4844699">.</span><span class="ident" id="4844700">closeAfterReply</span>&nbsp;<span class="op" id="4844716">&amp;&amp;</span>&nbsp;<span class="op" id="4844719">(</span><span class="op" id="4844720">!</span><span class="ident" id="4844721">keepAlivesEnabled</span>&nbsp;<span class="op" id="4844739">||</span>&nbsp;<span class="op" id="4844742">!</span><span class="ident" id="4844743">hasToken</span><span class="op" id="4844751">(</span><span class="ident" id="4844752">cw</span><span class="op" id="4844754">.</span><span class="ident" id="4844755">header</span><span class="op" id="4844761">.</span><span class="ident" id="4844762">get</span><span class="op" id="4844765">(</span><span class="string" id="4844766">&#34;Connection&#34;</span><span class="op" id="4844778">)</span><span class="op" id="4844779">,</span>&nbsp;<span class="string" id="4844781">&#34;close&#34;</span><span class="op" id="4844788">)</span><span class="op" id="4844789">)</span>&nbsp;<span class="op" id="4844791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4844795">delHeader</span><span class="op" id="4844804">(</span><span class="string" id="4844805">&#34;Connection&#34;</span><span class="op" id="4844817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4844821">if</span>&nbsp;<span class="ident" id="4844824">w</span><span class="op" id="4844825">.</span><span class="ident" id="4844826">req</span><span class="op" id="4844829">.</span><span class="ident" id="4844830">ProtoAtLeast</span><span class="op" id="4844842">(</span><span class="num" id="4844843">1</span><span class="op" id="4844844">,</span>&nbsp;<span class="num" id="4844846">1</span><span class="op" id="4844847">)</span>&nbsp;<span class="op" id="4844849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4844854">setHeader</span><span class="op" id="4844863">.</span><span class="ident" id="4844864">connection</span>&nbsp;<span class="op" id="4844875">=</span>&nbsp;<span class="string" id="4844877">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4844887">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4844890">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4844894">w</span><span class="op" id="4844895">.</span><span class="ident" id="4844896">conn</span><span class="op" id="4844900">.</span><span class="ident" id="4844901">buf</span><span class="op" id="4844904">.</span><span class="ident" id="4844905">WriteString</span><span class="op" id="4844916">(</span><span class="ident" id="4844917">statusLine</span><span class="op" id="4844927">(</span><span class="ident" id="4844928">w</span><span class="op" id="4844929">.</span><span class="ident" id="4844930">req</span><span class="op" id="4844933">,</span>&nbsp;<span class="ident" id="4844935">code</span><span class="op" id="4844939">)</span><span class="op" id="4844940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4844943">cw</span><span class="op" id="4844945">.</span><span class="ident" id="4844946">header</span><span class="op" id="4844952">.</span><span class="ident" id="4844953">WriteSubset</span><span class="op" id="4844964">(</span><span class="ident" id="4844965">w</span><span class="op" id="4844966">.</span><span class="ident" id="4844967">conn</span><span class="op" id="4844971">.</span><span class="ident" id="4844972">buf</span><span class="op" id="4844975">,</span>&nbsp;<span class="ident" id="4844977">excludeHeader</span><span class="op" id="4844990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4844993">setHeader</span><span class="op" id="4845002">.</span><span class="ident" id="4845003">Write</span><span class="op" id="4845008">(</span><span class="ident" id="4845009">w</span><span class="op" id="4845010">.</span><span class="ident" id="4845011">conn</span><span class="op" id="4845015">.</span><span class="ident" id="4845016">buf</span><span class="op" id="4845019">.</span><span class="ident" id="4845020">Writer</span><span class="op" id="4845026">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4845029">w</span><span class="op" id="4845030">.</span><span class="ident" id="4845031">conn</span><span class="op" id="4845035">.</span><span class="ident" id="4845036">buf</span><span class="op" id="4845039">.</span><span class="ident" id="4845040">Write</span><span class="op" id="4845045">(</span><span class="ident" id="4845046">crlf</span><span class="op" id="4845050">)</span><br>
<span class="lineno"></span><span class="op" id="4845052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4845055">//&nbsp;statusLines&nbsp;is&nbsp;a&nbsp;cache&nbsp;of&nbsp;Status-Line&nbsp;strings,&nbsp;keyed&nbsp;by&nbsp;code&nbsp;(for</span><br>
<span class="lineno"></span><span class="comment" id="4845124">//&nbsp;HTTP/1.1)&nbsp;or&nbsp;negative&nbsp;code&nbsp;(for&nbsp;HTTP/1.0).&nbsp;This&nbsp;is&nbsp;faster&nbsp;than&nbsp;a</span><br>
<span class="lineno">890</span><span class="comment" id="4845192">//&nbsp;map&nbsp;keyed&nbsp;by&nbsp;struct&nbsp;of&nbsp;two&nbsp;fields.&nbsp;This&nbsp;map&#39;s&nbsp;max&nbsp;size&nbsp;is&nbsp;bounded</span><br>
<span class="lineno"></span><span class="comment" id="4845261">//&nbsp;by&nbsp;2*len(statusText),&nbsp;two&nbsp;protocol&nbsp;types&nbsp;for&nbsp;each&nbsp;known&nbsp;official</span><br>
<span class="lineno"></span><span class="comment" id="4845329">//&nbsp;status&nbsp;code&nbsp;in&nbsp;the&nbsp;statusText&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="4845367">var</span>&nbsp;<span class="op" id="4845371">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4845374">statusMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4845386">sync</span><span class="op" id="4845390">.</span><span class="ident" id="4845391">RWMutex</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4845400">statusLines</span>&nbsp;<span class="op" id="4845412">=</span>&nbsp;<span class="builtinfunc" id="4845414">make</span><span class="op" id="4845418">(</span><span class="keyword" id="4845419">map</span><span class="op" id="4845422">[</span><span class="builtintype" id="4845423">int</span><span class="op" id="4845426">]</span><span class="builtintype" id="4845427">string</span><span class="op" id="4845433">)</span><br>
<span class="lineno"></span><span class="op" id="4845435">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4845438">//&nbsp;statusLine&nbsp;returns&nbsp;a&nbsp;response&nbsp;Status-Line&nbsp;(RFC&nbsp;2616&nbsp;Section&nbsp;6.1)</span><br>
<span class="lineno"></span><span class="comment" id="4845506">//&nbsp;for&nbsp;the&nbsp;given&nbsp;request&nbsp;and&nbsp;response&nbsp;status&nbsp;code.</span><br>
<span class="lineno">900</span><span class="keyword" id="4845557">func</span>&nbsp;<span class="ident" id="4845562">statusLine</span><span class="op" id="4845572">(</span><span class="ident" id="4845573">req</span>&nbsp;<span class="op" id="4845577">*</span><span class="ident" id="4845578">Request</span><span class="op" id="4845585">,</span>&nbsp;<span class="ident" id="4845587">code</span>&nbsp;<span class="builtintype" id="4845592">int</span><span class="op" id="4845595">)</span>&nbsp;<span class="builtintype" id="4845597">string</span>&nbsp;<span class="op" id="4845604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4845607">//&nbsp;Fast&nbsp;path:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4845622">key</span>&nbsp;<span class="op" id="4845626">:=</span>&nbsp;<span class="ident" id="4845629">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4845635">proto11</span>&nbsp;<span class="op" id="4845643">:=</span>&nbsp;<span class="ident" id="4845646">req</span><span class="op" id="4845649">.</span><span class="ident" id="4845650">ProtoAtLeast</span><span class="op" id="4845662">(</span><span class="num" id="4845663">1</span><span class="op" id="4845664">,</span>&nbsp;<span class="num" id="4845666">1</span><span class="op" id="4845667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4845670">if</span>&nbsp;<span class="op" id="4845673">!</span><span class="ident" id="4845674">proto11</span>&nbsp;<span class="op" id="4845682">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4845686">key</span>&nbsp;<span class="op" id="4845690">=</span>&nbsp;<span class="op" id="4845692">-</span><span class="ident" id="4845693">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4845698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4845701">statusMu</span><span class="op" id="4845709">.</span><span class="ident" id="4845710">RLock</span><span class="op" id="4845715">(</span><span class="op" id="4845716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4845719">line</span><span class="op" id="4845723">,</span>&nbsp;<span class="ident" id="4845725">ok</span>&nbsp;<span class="op" id="4845728">:=</span>&nbsp;<span class="ident" id="4845731">statusLines</span><span class="op" id="4845742">[</span><span class="ident" id="4845743">key</span><span class="op" id="4845746">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4845749">statusMu</span><span class="op" id="4845757">.</span><span class="ident" id="4845758">RUnlock</span><span class="op" id="4845765">(</span><span class="op" id="4845766">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4845769">if</span>&nbsp;<span class="ident" id="4845772">ok</span>&nbsp;<span class="op" id="4845775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4845779">return</span>&nbsp;<span class="ident" id="4845786">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4845792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4845796">//&nbsp;Slow&nbsp;path:</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4845811">proto</span>&nbsp;<span class="op" id="4845817">:=</span>&nbsp;<span class="string" id="4845820">&#34;HTTP/1.0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4845832">if</span>&nbsp;<span class="ident" id="4845835">proto11</span>&nbsp;<span class="op" id="4845843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4845847">proto</span>&nbsp;<span class="op" id="4845853">=</span>&nbsp;<span class="string" id="4845855">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4845867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4845870">codestring</span>&nbsp;<span class="op" id="4845881">:=</span>&nbsp;<span class="ident" id="4845884">strconv</span><span class="op" id="4845891">.</span><span class="ident" id="4845892">Itoa</span><span class="op" id="4845896">(</span><span class="ident" id="4845897">code</span><span class="op" id="4845901">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4845904">text</span><span class="op" id="4845908">,</span>&nbsp;<span class="ident" id="4845910">ok</span>&nbsp;<span class="op" id="4845913">:=</span>&nbsp;<span class="ident" id="4845916">statusText</span><span class="op" id="4845926">[</span><span class="ident" id="4845927">code</span><span class="op" id="4845931">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4845934">if</span>&nbsp;<span class="op" id="4845937">!</span><span class="ident" id="4845938">ok</span>&nbsp;<span class="op" id="4845941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4845945">text</span>&nbsp;<span class="op" id="4845950">=</span>&nbsp;<span class="string" id="4845952">&#34;status&nbsp;code&nbsp;&#34;</span>&nbsp;<span class="op" id="4845967">+</span>&nbsp;<span class="ident" id="4845969">codestring</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4845981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4845984">line</span>&nbsp;<span class="op" id="4845989">=</span>&nbsp;<span class="ident" id="4845991">proto</span>&nbsp;<span class="op" id="4845997">+</span>&nbsp;<span class="string" id="4845999">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="4846003">+</span>&nbsp;<span class="ident" id="4846005">codestring</span>&nbsp;<span class="op" id="4846016">+</span>&nbsp;<span class="string" id="4846018">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="4846022">+</span>&nbsp;<span class="ident" id="4846024">text</span>&nbsp;<span class="op" id="4846029">+</span>&nbsp;<span class="string" id="4846031">&#34;\r\n&#34;</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4846039">if</span>&nbsp;<span class="ident" id="4846042">ok</span>&nbsp;<span class="op" id="4846045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4846049">statusMu</span><span class="op" id="4846057">.</span><span class="ident" id="4846058">Lock</span><span class="op" id="4846062">(</span><span class="op" id="4846063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4846067">defer</span>&nbsp;<span class="ident" id="4846073">statusMu</span><span class="op" id="4846081">.</span><span class="ident" id="4846082">Unlock</span><span class="op" id="4846088">(</span><span class="op" id="4846089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4846093">statusLines</span><span class="op" id="4846104">[</span><span class="ident" id="4846105">key</span><span class="op" id="4846108">]</span>&nbsp;<span class="op" id="4846110">=</span>&nbsp;<span class="ident" id="4846112">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4846118">}</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4846121">return</span>&nbsp;<span class="ident" id="4846128">line</span><br>
<span class="lineno"></span><span class="op" id="4846133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4846136">//&nbsp;bodyAllowed&nbsp;returns&nbsp;true&nbsp;if&nbsp;a&nbsp;Write&nbsp;is&nbsp;allowed&nbsp;for&nbsp;this&nbsp;response&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="4846210">//&nbsp;It&#39;s&nbsp;illegal&nbsp;to&nbsp;call&nbsp;this&nbsp;before&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;flushed.</span><br>
<span class="lineno">935</span><span class="keyword" id="4846275">func</span>&nbsp;<span class="op" id="4846280">(</span><span class="ident" id="4846281">w</span>&nbsp;<span class="op" id="4846283">*</span><span class="ident" id="4846284">response</span><span class="op" id="4846292">)</span>&nbsp;<span class="ident" id="4846294">bodyAllowed</span><span class="op" id="4846305">(</span><span class="op" id="4846306">)</span>&nbsp;<span class="builtintype" id="4846308">bool</span>&nbsp;<span class="op" id="4846313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4846316">if</span>&nbsp;<span class="op" id="4846319">!</span><span class="ident" id="4846320">w</span><span class="op" id="4846321">.</span><span class="ident" id="4846322">wroteHeader</span>&nbsp;<span class="op" id="4846334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4846338">panic</span><span class="op" id="4846343">(</span><span class="string" id="4846344">&#34;&#34;</span><span class="op" id="4846346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4846349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4846352">return</span>&nbsp;<span class="ident" id="4846359">bodyAllowedForStatus</span><span class="op" id="4846379">(</span><span class="ident" id="4846380">w</span><span class="op" id="4846381">.</span><span class="ident" id="4846382">status</span><span class="op" id="4846388">)</span><br>
<span class="lineno">940</span><span class="op" id="4846390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4846393">//&nbsp;The&nbsp;Life&nbsp;Of&nbsp;A&nbsp;Write&nbsp;is&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span><span class="comment" id="4846430">//</span><br>
<span class="lineno"></span><span class="comment" id="4846433">//&nbsp;Handler&nbsp;starts.&nbsp;No&nbsp;header&nbsp;has&nbsp;been&nbsp;sent.&nbsp;The&nbsp;handler&nbsp;can&nbsp;either</span><br>
<span class="lineno">945</span><span class="comment" id="4846500">//&nbsp;write&nbsp;a&nbsp;header,&nbsp;or&nbsp;just&nbsp;start&nbsp;writing.&nbsp;&nbsp;Writing&nbsp;before&nbsp;sending&nbsp;a&nbsp;header</span><br>
<span class="lineno"></span><span class="comment" id="4846575">//&nbsp;sends&nbsp;an&nbsp;implicitly&nbsp;empty&nbsp;200&nbsp;OK&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="4846619">//</span><br>
<span class="lineno"></span><span class="comment" id="4846622">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;declare&nbsp;a&nbsp;Content-Length&nbsp;up&nbsp;front,&nbsp;we&nbsp;either</span><br>
<span class="lineno"></span><span class="comment" id="4846692">//&nbsp;go&nbsp;into&nbsp;chunking&nbsp;mode&nbsp;or,&nbsp;if&nbsp;the&nbsp;handler&nbsp;finishes&nbsp;running&nbsp;before</span><br>
<span class="lineno">950</span><span class="comment" id="4846760">//&nbsp;the&nbsp;chunking&nbsp;buffer&nbsp;size,&nbsp;we&nbsp;compute&nbsp;a&nbsp;Content-Length&nbsp;and&nbsp;send&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4846831">//&nbsp;in&nbsp;the&nbsp;header&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="4846857">//</span><br>
<span class="lineno"></span><span class="comment" id="4846860">//&nbsp;Likewise,&nbsp;if&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;set&nbsp;a&nbsp;Content-Type,&nbsp;we&nbsp;sniff&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4846929">//&nbsp;from&nbsp;the&nbsp;initial&nbsp;chunk&nbsp;of&nbsp;output.</span><br>
<span class="lineno">955</span><span class="comment" id="4846966">//</span><br>
<span class="lineno"></span><span class="comment" id="4846969">//&nbsp;The&nbsp;Writers&nbsp;are&nbsp;wired&nbsp;together&nbsp;like:</span><br>
<span class="lineno"></span><span class="comment" id="4847009">//</span><br>
<span class="lineno"></span><span class="comment" id="4847012">//&nbsp;1.&nbsp;*response&nbsp;(the&nbsp;ResponseWriter)&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="4847052">//&nbsp;2.&nbsp;(*response).w,&nbsp;a&nbsp;*bufio.Writer&nbsp;of&nbsp;bufferBeforeChunkingSize&nbsp;bytes</span><br>
<span class="lineno">960</span><span class="comment" id="4847123">//&nbsp;3.&nbsp;chunkWriter.Writer&nbsp;(whose&nbsp;writeHeader&nbsp;finalizes&nbsp;Content-Length/Type)</span><br>
<span class="lineno"></span><span class="comment" id="4847198">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;which&nbsp;writes&nbsp;the&nbsp;chunk&nbsp;headers,&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="comment" id="4847251">//&nbsp;4.&nbsp;conn.buf,&nbsp;a&nbsp;bufio.Writer&nbsp;of&nbsp;default&nbsp;(4kB)&nbsp;bytes,&nbsp;writing&nbsp;to&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="4847320">//&nbsp;5.&nbsp;checkConnErrorWriter{c},&nbsp;which&nbsp;notes&nbsp;any&nbsp;non-nil&nbsp;error&nbsp;on&nbsp;Write</span><br>
<span class="lineno"></span><span class="comment" id="4847390">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;populates&nbsp;c.werr&nbsp;with&nbsp;it&nbsp;if&nbsp;so.&nbsp;but&nbsp;otherwise&nbsp;writes&nbsp;to:</span><br>
<span class="lineno">965</span><span class="comment" id="4847457">//&nbsp;6.&nbsp;the&nbsp;rwc,&nbsp;the&nbsp;net.Conn.</span><br>
<span class="lineno"></span><span class="comment" id="4847486">//</span><br>
<span class="lineno"></span><span class="comment" id="4847489">//&nbsp;TODO(bradfitz):&nbsp;short-circuit&nbsp;some&nbsp;of&nbsp;the&nbsp;buffering&nbsp;when&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4847553">//&nbsp;initial&nbsp;header&nbsp;contains&nbsp;both&nbsp;a&nbsp;Content-Type&nbsp;and&nbsp;Content-Length.</span><br>
<span class="lineno"></span><span class="comment" id="4847620">//&nbsp;Also&nbsp;short-circuit&nbsp;in&nbsp;(1)&nbsp;when&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;sent&nbsp;and&nbsp;not&nbsp;in</span><br>
<span class="lineno">970</span><span class="comment" id="4847688">//&nbsp;chunking&nbsp;mode,&nbsp;writing&nbsp;directly&nbsp;to&nbsp;(4)&nbsp;instead,&nbsp;if&nbsp;(2)&nbsp;has&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="4847753">//&nbsp;buffered&nbsp;data.&nbsp;&nbsp;More&nbsp;generally,&nbsp;we&nbsp;could&nbsp;short-circuit&nbsp;from&nbsp;(1)&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4847823">//&nbsp;(3)&nbsp;even&nbsp;in&nbsp;chunking&nbsp;mode&nbsp;if&nbsp;the&nbsp;write&nbsp;size&nbsp;from&nbsp;(1)&nbsp;is&nbsp;over&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="4847892">//&nbsp;threshold&nbsp;and&nbsp;nothing&nbsp;is&nbsp;in&nbsp;(2).&nbsp;&nbsp;The&nbsp;answer&nbsp;might&nbsp;be&nbsp;mostly&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="4847963">//&nbsp;bufferBeforeChunkingSize&nbsp;smaller&nbsp;and&nbsp;having&nbsp;bufio&#39;s&nbsp;fast-paths&nbsp;deal</span><br>
<span class="lineno">975</span><span class="comment" id="4848034">//&nbsp;with&nbsp;this&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="4848056">func</span>&nbsp;<span class="op" id="4848061">(</span><span class="ident" id="4848062">w</span>&nbsp;<span class="op" id="4848064">*</span><span class="ident" id="4848065">response</span><span class="op" id="4848073">)</span>&nbsp;<span class="ident" id="4848075">Write</span><span class="op" id="4848080">(</span><span class="ident" id="4848081">data</span>&nbsp;<span class="op" id="4848086">[</span><span class="op" id="4848087">]</span><span class="builtintype" id="4848088">byte</span><span class="op" id="4848092">)</span>&nbsp;<span class="op" id="4848094">(</span><span class="ident" id="4848095">n</span>&nbsp;<span class="builtintype" id="4848097">int</span><span class="op" id="4848100">,</span>&nbsp;<span class="ident" id="4848102">err</span>&nbsp;<span class="builtintype" id="4848106">error</span><span class="op" id="4848111">)</span>&nbsp;<span class="op" id="4848113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4848116">return</span>&nbsp;<span class="ident" id="4848123">w</span><span class="op" id="4848124">.</span><span class="ident" id="4848125">write</span><span class="op" id="4848130">(</span><span class="builtinfunc" id="4848131">len</span><span class="op" id="4848134">(</span><span class="ident" id="4848135">data</span><span class="op" id="4848139">)</span><span class="op" id="4848140">,</span>&nbsp;<span class="ident" id="4848142">data</span><span class="op" id="4848146">,</span>&nbsp;<span class="string" id="4848148">&#34;&#34;</span><span class="op" id="4848150">)</span><br>
<span class="lineno"></span><span class="op" id="4848152">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="4848155">func</span>&nbsp;<span class="op" id="4848160">(</span><span class="ident" id="4848161">w</span>&nbsp;<span class="op" id="4848163">*</span><span class="ident" id="4848164">response</span><span class="op" id="4848172">)</span>&nbsp;<span class="ident" id="4848174">WriteString</span><span class="op" id="4848185">(</span><span class="ident" id="4848186">data</span>&nbsp;<span class="builtintype" id="4848191">string</span><span class="op" id="4848197">)</span>&nbsp;<span class="op" id="4848199">(</span><span class="ident" id="4848200">n</span>&nbsp;<span class="builtintype" id="4848202">int</span><span class="op" id="4848205">,</span>&nbsp;<span class="ident" id="4848207">err</span>&nbsp;<span class="builtintype" id="4848211">error</span><span class="op" id="4848216">)</span>&nbsp;<span class="op" id="4848218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4848221">return</span>&nbsp;<span class="ident" id="4848228">w</span><span class="op" id="4848229">.</span><span class="ident" id="4848230">write</span><span class="op" id="4848235">(</span><span class="builtinfunc" id="4848236">len</span><span class="op" id="4848239">(</span><span class="ident" id="4848240">data</span><span class="op" id="4848244">)</span><span class="op" id="4848245">,</span>&nbsp;<span class="ident" id="4848247">nil</span><span class="op" id="4848250">,</span>&nbsp;<span class="ident" id="4848252">data</span><span class="op" id="4848256">)</span><br>
<span class="lineno"></span><span class="op" id="4848258">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4848261">//&nbsp;either&nbsp;dataB&nbsp;or&nbsp;dataS&nbsp;is&nbsp;non-zero.</span><br>
<span class="lineno">985</span><span class="keyword" id="4848299">func</span>&nbsp;<span class="op" id="4848304">(</span><span class="ident" id="4848305">w</span>&nbsp;<span class="op" id="4848307">*</span><span class="ident" id="4848308">response</span><span class="op" id="4848316">)</span>&nbsp;<span class="ident" id="4848318">write</span><span class="op" id="4848323">(</span><span class="ident" id="4848324">lenData</span>&nbsp;<span class="builtintype" id="4848332">int</span><span class="op" id="4848335">,</span>&nbsp;<span class="ident" id="4848337">dataB</span>&nbsp;<span class="op" id="4848343">[</span><span class="op" id="4848344">]</span><span class="builtintype" id="4848345">byte</span><span class="op" id="4848349">,</span>&nbsp;<span class="ident" id="4848351">dataS</span>&nbsp;<span class="builtintype" id="4848357">string</span><span class="op" id="4848363">)</span>&nbsp;<span class="op" id="4848365">(</span><span class="ident" id="4848366">n</span>&nbsp;<span class="builtintype" id="4848368">int</span><span class="op" id="4848371">,</span>&nbsp;<span class="ident" id="4848373">err</span>&nbsp;<span class="builtintype" id="4848377">error</span><span class="op" id="4848382">)</span>&nbsp;<span class="op" id="4848384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4848387">if</span>&nbsp;<span class="ident" id="4848390">w</span><span class="op" id="4848391">.</span><span class="ident" id="4848392">conn</span><span class="op" id="4848396">.</span><span class="ident" id="4848397">hijacked</span><span class="op" id="4848405">(</span><span class="op" id="4848406">)</span>&nbsp;<span class="op" id="4848408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4848412">w</span><span class="op" id="4848413">.</span><span class="ident" id="4848414">conn</span><span class="op" id="4848418">.</span><span class="ident" id="4848419">server</span><span class="op" id="4848425">.</span><span class="ident" id="4848426">logf</span><span class="op" id="4848430">(</span><span class="string" id="4848431">&#34;http:&nbsp;response.Write&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="4848476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4848480">return</span>&nbsp;<span class="num" id="4848487">0</span><span class="op" id="4848488">,</span>&nbsp;<span class="ident" id="4848490">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4848503">}</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4848506">if</span>&nbsp;<span class="op" id="4848509">!</span><span class="ident" id="4848510">w</span><span class="op" id="4848511">.</span><span class="ident" id="4848512">wroteHeader</span>&nbsp;<span class="op" id="4848524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4848528">w</span><span class="op" id="4848529">.</span><span class="ident" id="4848530">WriteHeader</span><span class="op" id="4848541">(</span><span class="ident" id="4848542">StatusOK</span><span class="op" id="4848550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4848553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4848556">if</span>&nbsp;<span class="ident" id="4848559">lenData</span>&nbsp;<span class="op" id="4848567">==</span>&nbsp;<span class="num" id="4848570">0</span>&nbsp;<span class="op" id="4848572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4848576">return</span>&nbsp;<span class="num" id="4848583">0</span><span class="op" id="4848584">,</span>&nbsp;<span class="ident" id="4848586">nil</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4848591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4848594">if</span>&nbsp;<span class="op" id="4848597">!</span><span class="ident" id="4848598">w</span><span class="op" id="4848599">.</span><span class="ident" id="4848600">bodyAllowed</span><span class="op" id="4848611">(</span><span class="op" id="4848612">)</span>&nbsp;<span class="op" id="4848614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4848618">return</span>&nbsp;<span class="num" id="4848625">0</span><span class="op" id="4848626">,</span>&nbsp;<span class="ident" id="4848628">ErrBodyNotAllowed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4848647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4848651">w</span><span class="op" id="4848652">.</span><span class="ident" id="4848653">written</span>&nbsp;<span class="op" id="4848661">+=</span>&nbsp;<span class="ident" id="4848664">int64</span><span class="op" id="4848669">(</span><span class="ident" id="4848670">lenData</span><span class="op" id="4848677">)</span>&nbsp;<span class="comment" id="4848679">//&nbsp;ignoring&nbsp;errors,&nbsp;for&nbsp;errorKludge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4848716">if</span>&nbsp;<span class="ident" id="4848719">w</span><span class="op" id="4848720">.</span><span class="ident" id="4848721">contentLength</span>&nbsp;<span class="op" id="4848735">!=</span>&nbsp;<span class="op" id="4848738">-</span><span class="num" id="4848739">1</span>&nbsp;<span class="op" id="4848741">&amp;&amp;</span>&nbsp;<span class="ident" id="4848744">w</span><span class="op" id="4848745">.</span><span class="ident" id="4848746">written</span>&nbsp;<span class="op" id="4848754">&gt;</span>&nbsp;<span class="ident" id="4848756">w</span><span class="op" id="4848757">.</span><span class="ident" id="4848758">contentLength</span>&nbsp;<span class="op" id="4848772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4848776">return</span>&nbsp;<span class="num" id="4848783">0</span><span class="op" id="4848784">,</span>&nbsp;<span class="ident" id="4848786">ErrContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4848804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4848807">if</span>&nbsp;<span class="ident" id="4848810">dataB</span>&nbsp;<span class="op" id="4848816">!=</span>&nbsp;<span class="ident" id="4848819">nil</span>&nbsp;<span class="op" id="4848823">{</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4848827">return</span>&nbsp;<span class="ident" id="4848834">w</span><span class="op" id="4848835">.</span><span class="ident" id="4848836">w</span><span class="op" id="4848837">.</span><span class="ident" id="4848838">Write</span><span class="op" id="4848843">(</span><span class="ident" id="4848844">dataB</span><span class="op" id="4848849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4848852">}</span>&nbsp;<span class="keyword" id="4848854">else</span>&nbsp;<span class="op" id="4848859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4848863">return</span>&nbsp;<span class="ident" id="4848870">w</span><span class="op" id="4848871">.</span><span class="ident" id="4848872">w</span><span class="op" id="4848873">.</span><span class="ident" id="4848874">WriteString</span><span class="op" id="4848885">(</span><span class="ident" id="4848886">dataS</span><span class="op" id="4848891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4848894">}</span><br>
<span class="lineno"></span><span class="op" id="4848896">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span><span class="keyword" id="4848899">func</span>&nbsp;<span class="op" id="4848904">(</span><span class="ident" id="4848905">w</span>&nbsp;<span class="op" id="4848907">*</span><span class="ident" id="4848908">response</span><span class="op" id="4848916">)</span>&nbsp;<span class="ident" id="4848918">finishRequest</span><span class="op" id="4848931">(</span><span class="op" id="4848932">)</span>&nbsp;<span class="op" id="4848934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4848937">w</span><span class="op" id="4848938">.</span><span class="ident" id="4848939">handlerDone</span>&nbsp;<span class="op" id="4848951">=</span>&nbsp;<span class="builtintype" id="4848953">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4848960">if</span>&nbsp;<span class="op" id="4848963">!</span><span class="ident" id="4848964">w</span><span class="op" id="4848965">.</span><span class="ident" id="4848966">wroteHeader</span>&nbsp;<span class="op" id="4848978">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4848982">w</span><span class="op" id="4848983">.</span><span class="ident" id="4848984">WriteHeader</span><span class="op" id="4848995">(</span><span class="ident" id="4848996">StatusOK</span><span class="op" id="4849004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4849007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4849011">w</span><span class="op" id="4849012">.</span><span class="ident" id="4849013">w</span><span class="op" id="4849014">.</span><span class="ident" id="4849015">Flush</span><span class="op" id="4849020">(</span><span class="op" id="4849021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4849024">putBufioWriter</span><span class="op" id="4849038">(</span><span class="ident" id="4849039">w</span><span class="op" id="4849040">.</span><span class="ident" id="4849041">w</span><span class="op" id="4849042">)</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4849045">w</span><span class="op" id="4849046">.</span><span class="ident" id="4849047">cw</span><span class="op" id="4849049">.</span><span class="builtinfunc" id="4849050">close</span><span class="op" id="4849055">(</span><span class="op" id="4849056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4849059">w</span><span class="op" id="4849060">.</span><span class="ident" id="4849061">conn</span><span class="op" id="4849065">.</span><span class="ident" id="4849066">buf</span><span class="op" id="4849069">.</span><span class="ident" id="4849070">Flush</span><span class="op" id="4849075">(</span><span class="op" id="4849076">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4849080">//&nbsp;Close&nbsp;the&nbsp;body&nbsp;(regardless&nbsp;of&nbsp;w.closeAfterReply)&nbsp;so&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4849143">//&nbsp;re-use&nbsp;its&nbsp;bufio.Reader&nbsp;later&nbsp;safely.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4849185">w</span><span class="op" id="4849186">.</span><span class="ident" id="4849187">req</span><span class="op" id="4849190">.</span><span class="ident" id="4849191">Body</span><span class="op" id="4849195">.</span><span class="ident" id="4849196">Close</span><span class="op" id="4849201">(</span><span class="op" id="4849202">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4849206">if</span>&nbsp;<span class="ident" id="4849209">w</span><span class="op" id="4849210">.</span><span class="ident" id="4849211">req</span><span class="op" id="4849214">.</span><span class="ident" id="4849215">MultipartForm</span>&nbsp;<span class="op" id="4849229">!=</span>&nbsp;<span class="ident" id="4849232">nil</span>&nbsp;<span class="op" id="4849236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4849240">w</span><span class="op" id="4849241">.</span><span class="ident" id="4849242">req</span><span class="op" id="4849245">.</span><span class="ident" id="4849246">MultipartForm</span><span class="op" id="4849259">.</span><span class="ident" id="4849260">RemoveAll</span><span class="op" id="4849269">(</span><span class="op" id="4849270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4849273">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4849277">if</span>&nbsp;<span class="ident" id="4849280">w</span><span class="op" id="4849281">.</span><span class="ident" id="4849282">req</span><span class="op" id="4849285">.</span><span class="ident" id="4849286">Method</span>&nbsp;<span class="op" id="4849293">!=</span>&nbsp;<span class="string" id="4849296">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="4849303">&amp;&amp;</span>&nbsp;<span class="ident" id="4849306">w</span><span class="op" id="4849307">.</span><span class="ident" id="4849308">contentLength</span>&nbsp;<span class="op" id="4849322">!=</span>&nbsp;<span class="op" id="4849325">-</span><span class="num" id="4849326">1</span>&nbsp;<span class="op" id="4849328">&amp;&amp;</span>&nbsp;<span class="ident" id="4849331">w</span><span class="op" id="4849332">.</span><span class="ident" id="4849333">bodyAllowed</span><span class="op" id="4849344">(</span><span class="op" id="4849345">)</span>&nbsp;<span class="op" id="4849347">&amp;&amp;</span>&nbsp;<span class="ident" id="4849350">w</span><span class="op" id="4849351">.</span><span class="ident" id="4849352">contentLength</span>&nbsp;<span class="op" id="4849366">!=</span>&nbsp;<span class="ident" id="4849369">w</span><span class="op" id="4849370">.</span><span class="ident" id="4849371">written</span>&nbsp;<span class="op" id="4849379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4849383">//&nbsp;Did&nbsp;not&nbsp;write&nbsp;enough.&nbsp;Avoid&nbsp;getting&nbsp;out&nbsp;of&nbsp;sync.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4849437">w</span><span class="op" id="4849438">.</span><span class="ident" id="4849439">closeAfterReply</span>&nbsp;<span class="op" id="4849455">=</span>&nbsp;<span class="builtintype" id="4849457">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4849463">}</span><br>
<span class="lineno">1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4849467">//&nbsp;There&nbsp;was&nbsp;some&nbsp;error&nbsp;writing&nbsp;to&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4849529">//&nbsp;during&nbsp;the&nbsp;request,&nbsp;so&nbsp;don&#39;t&nbsp;re-use&nbsp;this&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4849580">if</span>&nbsp;<span class="ident" id="4849583">w</span><span class="op" id="4849584">.</span><span class="ident" id="4849585">conn</span><span class="op" id="4849589">.</span><span class="ident" id="4849590">werr</span>&nbsp;<span class="op" id="4849595">!=</span>&nbsp;<span class="ident" id="4849598">nil</span>&nbsp;<span class="op" id="4849602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4849606">w</span><span class="op" id="4849607">.</span><span class="ident" id="4849608">closeAfterReply</span>&nbsp;<span class="op" id="4849624">=</span>&nbsp;<span class="builtintype" id="4849626">true</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4849632">}</span><br>
<span class="lineno"></span><span class="op" id="4849634">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4849637">func</span>&nbsp;<span class="op" id="4849642">(</span><span class="ident" id="4849643">w</span>&nbsp;<span class="op" id="4849645">*</span><span class="ident" id="4849646">response</span><span class="op" id="4849654">)</span>&nbsp;<span class="ident" id="4849656">Flush</span><span class="op" id="4849661">(</span><span class="op" id="4849662">)</span>&nbsp;<span class="op" id="4849664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4849667">if</span>&nbsp;<span class="op" id="4849670">!</span><span class="ident" id="4849671">w</span><span class="op" id="4849672">.</span><span class="ident" id="4849673">wroteHeader</span>&nbsp;<span class="op" id="4849685">{</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4849689">w</span><span class="op" id="4849690">.</span><span class="ident" id="4849691">WriteHeader</span><span class="op" id="4849702">(</span><span class="ident" id="4849703">StatusOK</span><span class="op" id="4849711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4849714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4849717">w</span><span class="op" id="4849718">.</span><span class="ident" id="4849719">w</span><span class="op" id="4849720">.</span><span class="ident" id="4849721">Flush</span><span class="op" id="4849726">(</span><span class="op" id="4849727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4849730">w</span><span class="op" id="4849731">.</span><span class="ident" id="4849732">cw</span><span class="op" id="4849734">.</span><span class="ident" id="4849735">flush</span><span class="op" id="4849740">(</span><span class="op" id="4849741">)</span><br>
<span class="lineno"></span><span class="op" id="4849743">}</span><br>
<span class="lineno">1050</span><br>
<span class="lineno"></span><span class="keyword" id="4849746">func</span>&nbsp;<span class="op" id="4849751">(</span><span class="ident" id="4849752">c</span>&nbsp;<span class="op" id="4849754">*</span><span class="ident" id="4849755">conn</span><span class="op" id="4849759">)</span>&nbsp;<span class="ident" id="4849761">finalFlush</span><span class="op" id="4849771">(</span><span class="op" id="4849772">)</span>&nbsp;<span class="op" id="4849774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4849777">if</span>&nbsp;<span class="ident" id="4849780">c</span><span class="op" id="4849781">.</span><span class="ident" id="4849782">buf</span>&nbsp;<span class="op" id="4849786">!=</span>&nbsp;<span class="ident" id="4849789">nil</span>&nbsp;<span class="op" id="4849793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4849797">c</span><span class="op" id="4849798">.</span><span class="ident" id="4849799">buf</span><span class="op" id="4849802">.</span><span class="ident" id="4849803">Flush</span><span class="op" id="4849808">(</span><span class="op" id="4849809">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4849814">//&nbsp;Steal&nbsp;the&nbsp;bufio.Reader&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4849884">//&nbsp;reader&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4849921">putBufioReader</span><span class="op" id="4849935">(</span><span class="ident" id="4849936">c</span><span class="op" id="4849937">.</span><span class="ident" id="4849938">buf</span><span class="op" id="4849941">.</span><span class="ident" id="4849942">Reader</span><span class="op" id="4849948">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4849953">//&nbsp;Steal&nbsp;the&nbsp;bufio.Writer&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4850023">//&nbsp;writer&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4850060">putBufioWriter</span><span class="op" id="4850074">(</span><span class="ident" id="4850075">c</span><span class="op" id="4850076">.</span><span class="ident" id="4850077">buf</span><span class="op" id="4850080">.</span><span class="ident" id="4850081">Writer</span><span class="op" id="4850087">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4850092">c</span><span class="op" id="4850093">.</span><span class="ident" id="4850094">buf</span>&nbsp;<span class="op" id="4850098">=</span>&nbsp;<span class="ident" id="4850100">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4850105">}</span><br>
<span class="lineno">1065</span><span class="op" id="4850107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4850110">//&nbsp;Close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4850135">func</span>&nbsp;<span class="op" id="4850140">(</span><span class="ident" id="4850141">c</span>&nbsp;<span class="op" id="4850143">*</span><span class="ident" id="4850144">conn</span><span class="op" id="4850148">)</span>&nbsp;<span class="builtinfunc" id="4850150">close</span><span class="op" id="4850155">(</span><span class="op" id="4850156">)</span>&nbsp;<span class="op" id="4850158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4850161">c</span><span class="op" id="4850162">.</span><span class="ident" id="4850163">finalFlush</span><span class="op" id="4850173">(</span><span class="op" id="4850174">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4850177">if</span>&nbsp;<span class="ident" id="4850180">c</span><span class="op" id="4850181">.</span><span class="ident" id="4850182">rwc</span>&nbsp;<span class="op" id="4850186">!=</span>&nbsp;<span class="ident" id="4850189">nil</span>&nbsp;<span class="op" id="4850193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4850197">c</span><span class="op" id="4850198">.</span><span class="ident" id="4850199">rwc</span><span class="op" id="4850202">.</span><span class="ident" id="4850203">Close</span><span class="op" id="4850208">(</span><span class="op" id="4850209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4850213">c</span><span class="op" id="4850214">.</span><span class="ident" id="4850215">rwc</span>&nbsp;<span class="op" id="4850219">=</span>&nbsp;<span class="ident" id="4850221">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4850226">}</span><br>
<span class="lineno"></span><span class="op" id="4850228">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span><span class="comment" id="4850231">//&nbsp;rstAvoidanceDelay&nbsp;is&nbsp;the&nbsp;amount&nbsp;of&nbsp;time&nbsp;we&nbsp;sleep&nbsp;after&nbsp;closing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4850301">//&nbsp;write&nbsp;side&nbsp;of&nbsp;a&nbsp;TCP&nbsp;connection&nbsp;before&nbsp;closing&nbsp;the&nbsp;entire&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="4850369">//&nbsp;By&nbsp;sleeping,&nbsp;we&nbsp;increase&nbsp;the&nbsp;chances&nbsp;that&nbsp;the&nbsp;client&nbsp;sees&nbsp;our&nbsp;FIN</span><br>
<span class="lineno"></span><span class="comment" id="4850438">//&nbsp;and&nbsp;processes&nbsp;its&nbsp;final&nbsp;data&nbsp;before&nbsp;they&nbsp;process&nbsp;the&nbsp;subsequent&nbsp;RST</span><br>
<span class="lineno">1080</span><span class="comment" id="4850509">//&nbsp;from&nbsp;closing&nbsp;a&nbsp;connection&nbsp;with&nbsp;known&nbsp;unread&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="4850562">//&nbsp;This&nbsp;RST&nbsp;seems&nbsp;to&nbsp;occur&nbsp;mostly&nbsp;on&nbsp;BSD&nbsp;systems.&nbsp;(And&nbsp;Windows?)</span><br>
<span class="lineno"></span><span class="comment" id="4850627">//&nbsp;This&nbsp;timeout&nbsp;is&nbsp;somewhat&nbsp;arbitrary&nbsp;(~latency&nbsp;around&nbsp;the&nbsp;planet).</span><br>
<span class="lineno"></span><span class="keyword" id="4850695">const</span>&nbsp;<span class="ident" id="4850701">rstAvoidanceDelay</span>&nbsp;<span class="op" id="4850719">=</span>&nbsp;<span class="num" id="4850721">500</span>&nbsp;<span class="op" id="4850725">*</span>&nbsp;<span class="ident" id="4850727">time</span><span class="op" id="4850731">.</span><span class="ident" id="4850732">Millisecond</span><br>
<span class="lineno"></span><br>
<span class="lineno">1085</span><span class="keyword" id="4850745">type</span>&nbsp;<span class="ident" id="4850750">closeWriter</span>&nbsp;<span class="keyword" id="4850762">interface</span>&nbsp;<span class="op" id="4850772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4850775">CloseWrite</span><span class="op" id="4850785">(</span><span class="op" id="4850786">)</span>&nbsp;<span class="builtintype" id="4850788">error</span><br>
<span class="lineno"></span><span class="op" id="4850794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4850797">var</span>&nbsp;<span class="ident" id="4850801">_</span>&nbsp;<span class="ident" id="4850803">closeWriter</span>&nbsp;<span class="op" id="4850815">=</span>&nbsp;<span class="op" id="4850817">(</span><span class="op" id="4850818">*</span><span class="ident" id="4850819">net</span><span class="op" id="4850822">.</span><span class="ident" id="4850823">TCPConn</span><span class="op" id="4850830">)</span><span class="op" id="4850831">(</span><span class="ident" id="4850832">nil</span><span class="op" id="4850835">)</span><br>
<span class="lineno">1090</span><br>
<span class="lineno"></span><span class="comment" id="4850838">//&nbsp;closeWrite&nbsp;flushes&nbsp;any&nbsp;outstanding&nbsp;data&nbsp;and&nbsp;sends&nbsp;a&nbsp;FIN&nbsp;packet&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="4850908">//&nbsp;client&nbsp;is&nbsp;connected&nbsp;via&nbsp;TCP),&nbsp;signalling&nbsp;that&nbsp;we&#39;re&nbsp;done.&nbsp;&nbsp;We&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="4850978">//&nbsp;pause&nbsp;for&nbsp;a&nbsp;bit,&nbsp;hoping&nbsp;the&nbsp;client&nbsp;processes&nbsp;it&nbsp;before&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="4851040">//&nbsp;subsequent&nbsp;RST.</span><br>
<span class="lineno">1095</span><span class="comment" id="4851059">//</span><br>
<span class="lineno"></span><span class="comment" id="4851062">//&nbsp;See&nbsp;http://golang.org/issue/3595</span><br>
<span class="lineno"></span><span class="keyword" id="4851098">func</span>&nbsp;<span class="op" id="4851103">(</span><span class="ident" id="4851104">c</span>&nbsp;<span class="op" id="4851106">*</span><span class="ident" id="4851107">conn</span><span class="op" id="4851111">)</span>&nbsp;<span class="ident" id="4851113">closeWriteAndWait</span><span class="op" id="4851130">(</span><span class="op" id="4851131">)</span>&nbsp;<span class="op" id="4851133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4851136">c</span><span class="op" id="4851137">.</span><span class="ident" id="4851138">finalFlush</span><span class="op" id="4851148">(</span><span class="op" id="4851149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4851152">if</span>&nbsp;<span class="ident" id="4851155">tcp</span><span class="op" id="4851158">,</span>&nbsp;<span class="ident" id="4851160">ok</span>&nbsp;<span class="op" id="4851163">:=</span>&nbsp;<span class="ident" id="4851166">c</span><span class="op" id="4851167">.</span><span class="ident" id="4851168">rwc</span><span class="op" id="4851171">.</span><span class="op" id="4851172">(</span><span class="ident" id="4851173">closeWriter</span><span class="op" id="4851184">)</span><span class="op" id="4851185">;</span>&nbsp;<span class="ident" id="4851187">ok</span>&nbsp;<span class="op" id="4851190">{</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4851194">tcp</span><span class="op" id="4851197">.</span><span class="ident" id="4851198">CloseWrite</span><span class="op" id="4851208">(</span><span class="op" id="4851209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4851212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4851215">time</span><span class="op" id="4851219">.</span><span class="ident" id="4851220">Sleep</span><span class="op" id="4851225">(</span><span class="ident" id="4851226">rstAvoidanceDelay</span><span class="op" id="4851243">)</span><br>
<span class="lineno"></span><span class="op" id="4851245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1105</span><span class="comment" id="4851248">//&nbsp;validNPN&nbsp;reports&nbsp;whether&nbsp;the&nbsp;proto&nbsp;is&nbsp;not&nbsp;a&nbsp;blacklisted&nbsp;Next</span><br>
<span class="lineno"></span><span class="comment" id="4851312">//&nbsp;Protocol&nbsp;Negotiation&nbsp;protocol.&nbsp;&nbsp;Empty&nbsp;and&nbsp;built-in&nbsp;protocol&nbsp;types</span><br>
<span class="lineno"></span><span class="comment" id="4851381">//&nbsp;are&nbsp;blacklisted&nbsp;and&nbsp;can&#39;t&nbsp;be&nbsp;overridden&nbsp;with&nbsp;alternate</span><br>
<span class="lineno"></span><span class="comment" id="4851439">//&nbsp;implementations.</span><br>
<span class="lineno"></span><span class="keyword" id="4851459">func</span>&nbsp;<span class="ident" id="4851464">validNPN</span><span class="op" id="4851472">(</span><span class="ident" id="4851473">proto</span>&nbsp;<span class="builtintype" id="4851479">string</span><span class="op" id="4851485">)</span>&nbsp;<span class="builtintype" id="4851487">bool</span>&nbsp;<span class="op" id="4851492">{</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4851495">switch</span>&nbsp;<span class="ident" id="4851502">proto</span>&nbsp;<span class="op" id="4851508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4851511">case</span>&nbsp;<span class="string" id="4851516">&#34;&#34;</span><span class="op" id="4851518">,</span>&nbsp;<span class="string" id="4851520">&#34;http/1.1&#34;</span><span class="op" id="4851530">,</span>&nbsp;<span class="string" id="4851532">&#34;http/1.0&#34;</span><span class="op" id="4851542">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4851546">return</span>&nbsp;<span class="builtintype" id="4851553">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4851560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4851563">return</span>&nbsp;<span class="builtintype" id="4851570">true</span><br>
<span class="lineno">1115</span><span class="op" id="4851575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4851578">func</span>&nbsp;<span class="op" id="4851583">(</span><span class="ident" id="4851584">c</span>&nbsp;<span class="op" id="4851586">*</span><span class="ident" id="4851587">conn</span><span class="op" id="4851591">)</span>&nbsp;<span class="ident" id="4851593">setState</span><span class="op" id="4851601">(</span><span class="ident" id="4851602">nc</span>&nbsp;<span class="ident" id="4851605">net</span><span class="op" id="4851608">.</span><span class="ident" id="4851609">Conn</span><span class="op" id="4851613">,</span>&nbsp;<span class="ident" id="4851615">state</span>&nbsp;<span class="ident" id="4851621">ConnState</span><span class="op" id="4851630">)</span>&nbsp;<span class="op" id="4851632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4851635">if</span>&nbsp;<span class="ident" id="4851638">hook</span>&nbsp;<span class="op" id="4851643">:=</span>&nbsp;<span class="ident" id="4851646">c</span><span class="op" id="4851647">.</span><span class="ident" id="4851648">server</span><span class="op" id="4851654">.</span><span class="ident" id="4851655">ConnState</span><span class="op" id="4851664">;</span>&nbsp;<span class="ident" id="4851666">hook</span>&nbsp;<span class="op" id="4851671">!=</span>&nbsp;<span class="ident" id="4851674">nil</span>&nbsp;<span class="op" id="4851678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4851682">hook</span><span class="op" id="4851686">(</span><span class="ident" id="4851687">nc</span><span class="op" id="4851689">,</span>&nbsp;<span class="ident" id="4851691">state</span><span class="op" id="4851696">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4851699">}</span><br>
<span class="lineno"></span><span class="op" id="4851701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4851704">//&nbsp;Serve&nbsp;a&nbsp;new&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4851731">func</span>&nbsp;<span class="op" id="4851736">(</span><span class="ident" id="4851737">c</span>&nbsp;<span class="op" id="4851739">*</span><span class="ident" id="4851740">conn</span><span class="op" id="4851744">)</span>&nbsp;<span class="ident" id="4851746">serve</span><span class="op" id="4851751">(</span><span class="op" id="4851752">)</span>&nbsp;<span class="op" id="4851754">{</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4851757">origConn</span>&nbsp;<span class="op" id="4851766">:=</span>&nbsp;<span class="ident" id="4851769">c</span><span class="op" id="4851770">.</span><span class="ident" id="4851771">rwc</span>&nbsp;<span class="comment" id="4851775">//&nbsp;copy&nbsp;it&nbsp;before&nbsp;it&#39;s&nbsp;set&nbsp;nil&nbsp;on&nbsp;Close&nbsp;or&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4851826">defer</span>&nbsp;<span class="keyword" id="4851832">func</span><span class="op" id="4851836">(</span><span class="op" id="4851837">)</span>&nbsp;<span class="op" id="4851839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4851843">if</span>&nbsp;<span class="ident" id="4851846">err</span>&nbsp;<span class="op" id="4851850">:=</span>&nbsp;<span class="builtinfunc" id="4851853">recover</span><span class="op" id="4851860">(</span><span class="op" id="4851861">)</span><span class="op" id="4851862">;</span>&nbsp;<span class="ident" id="4851864">err</span>&nbsp;<span class="op" id="4851868">!=</span>&nbsp;<span class="ident" id="4851871">nil</span>&nbsp;<span class="op" id="4851875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4851880">const</span>&nbsp;<span class="ident" id="4851886">size</span>&nbsp;<span class="op" id="4851891">=</span>&nbsp;<span class="num" id="4851893">64</span>&nbsp;<span class="op" id="4851896">&lt;&lt;</span>&nbsp;<span class="num" id="4851899">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4851905">buf</span>&nbsp;<span class="op" id="4851909">:=</span>&nbsp;<span class="builtinfunc" id="4851912">make</span><span class="op" id="4851916">(</span><span class="op" id="4851917">[</span><span class="op" id="4851918">]</span><span class="builtintype" id="4851919">byte</span><span class="op" id="4851923">,</span>&nbsp;<span class="ident" id="4851925">size</span><span class="op" id="4851929">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4851934">buf</span>&nbsp;<span class="op" id="4851938">=</span>&nbsp;<span class="ident" id="4851940">buf</span><span class="op" id="4851943">[</span><span class="op" id="4851944">:</span><span class="ident" id="4851945">runtime</span><span class="op" id="4851952">.</span><span class="ident" id="4851953">Stack</span><span class="op" id="4851958">(</span><span class="ident" id="4851959">buf</span><span class="op" id="4851962">,</span>&nbsp;<span class="builtintype" id="4851964">false</span><span class="op" id="4851969">)</span><span class="op" id="4851970">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4851975">c</span><span class="op" id="4851976">.</span><span class="ident" id="4851977">server</span><span class="op" id="4851983">.</span><span class="ident" id="4851984">logf</span><span class="op" id="4851988">(</span><span class="string" id="4851989">&#34;http:&nbsp;panic&nbsp;serving&nbsp;%v:&nbsp;%v\n%s&#34;</span><span class="op" id="4852021">,</span>&nbsp;<span class="ident" id="4852023">c</span><span class="op" id="4852024">.</span><span class="ident" id="4852025">remoteAddr</span><span class="op" id="4852035">,</span>&nbsp;<span class="ident" id="4852037">err</span><span class="op" id="4852040">,</span>&nbsp;<span class="ident" id="4852042">buf</span><span class="op" id="4852045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4852049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4852053">if</span>&nbsp;<span class="op" id="4852056">!</span><span class="ident" id="4852057">c</span><span class="op" id="4852058">.</span><span class="ident" id="4852059">hijacked</span><span class="op" id="4852067">(</span><span class="op" id="4852068">)</span>&nbsp;<span class="op" id="4852070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4852075">c</span><span class="op" id="4852076">.</span><span class="builtinfunc" id="4852077">close</span><span class="op" id="4852082">(</span><span class="op" id="4852083">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4852088">c</span><span class="op" id="4852089">.</span><span class="ident" id="4852090">setState</span><span class="op" id="4852098">(</span><span class="ident" id="4852099">origConn</span><span class="op" id="4852107">,</span>&nbsp;<span class="ident" id="4852109">StateClosed</span><span class="op" id="4852120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4852124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4852127">}</span><span class="op" id="4852128">(</span><span class="op" id="4852129">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4852133">if</span>&nbsp;<span class="ident" id="4852136">tlsConn</span><span class="op" id="4852143">,</span>&nbsp;<span class="ident" id="4852145">ok</span>&nbsp;<span class="op" id="4852148">:=</span>&nbsp;<span class="ident" id="4852151">c</span><span class="op" id="4852152">.</span><span class="ident" id="4852153">rwc</span><span class="op" id="4852156">.</span><span class="op" id="4852157">(</span><span class="op" id="4852158">*</span><span class="ident" id="4852159">tls</span><span class="op" id="4852162">.</span><span class="ident" id="4852163">Conn</span><span class="op" id="4852167">)</span><span class="op" id="4852168">;</span>&nbsp;<span class="ident" id="4852170">ok</span>&nbsp;<span class="op" id="4852173">{</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4852177">if</span>&nbsp;<span class="ident" id="4852180">d</span>&nbsp;<span class="op" id="4852182">:=</span>&nbsp;<span class="ident" id="4852185">c</span><span class="op" id="4852186">.</span><span class="ident" id="4852187">server</span><span class="op" id="4852193">.</span><span class="ident" id="4852194">ReadTimeout</span><span class="op" id="4852205">;</span>&nbsp;<span class="ident" id="4852207">d</span>&nbsp;<span class="op" id="4852209">!=</span>&nbsp;<span class="num" id="4852212">0</span>&nbsp;<span class="op" id="4852214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4852219">c</span><span class="op" id="4852220">.</span><span class="ident" id="4852221">rwc</span><span class="op" id="4852224">.</span><span class="ident" id="4852225">SetReadDeadline</span><span class="op" id="4852240">(</span><span class="ident" id="4852241">time</span><span class="op" id="4852245">.</span><span class="ident" id="4852246">Now</span><span class="op" id="4852249">(</span><span class="op" id="4852250">)</span><span class="op" id="4852251">.</span><span class="ident" id="4852252">Add</span><span class="op" id="4852255">(</span><span class="ident" id="4852256">d</span><span class="op" id="4852257">)</span><span class="op" id="4852258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4852262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4852266">if</span>&nbsp;<span class="ident" id="4852269">d</span>&nbsp;<span class="op" id="4852271">:=</span>&nbsp;<span class="ident" id="4852274">c</span><span class="op" id="4852275">.</span><span class="ident" id="4852276">server</span><span class="op" id="4852282">.</span><span class="ident" id="4852283">WriteTimeout</span><span class="op" id="4852295">;</span>&nbsp;<span class="ident" id="4852297">d</span>&nbsp;<span class="op" id="4852299">!=</span>&nbsp;<span class="num" id="4852302">0</span>&nbsp;<span class="op" id="4852304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4852309">c</span><span class="op" id="4852310">.</span><span class="ident" id="4852311">rwc</span><span class="op" id="4852314">.</span><span class="ident" id="4852315">SetWriteDeadline</span><span class="op" id="4852331">(</span><span class="ident" id="4852332">time</span><span class="op" id="4852336">.</span><span class="ident" id="4852337">Now</span><span class="op" id="4852340">(</span><span class="op" id="4852341">)</span><span class="op" id="4852342">.</span><span class="ident" id="4852343">Add</span><span class="op" id="4852346">(</span><span class="ident" id="4852347">d</span><span class="op" id="4852348">)</span><span class="op" id="4852349">)</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4852353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4852357">if</span>&nbsp;<span class="ident" id="4852360">err</span>&nbsp;<span class="op" id="4852364">:=</span>&nbsp;<span class="ident" id="4852367">tlsConn</span><span class="op" id="4852374">.</span><span class="ident" id="4852375">Handshake</span><span class="op" id="4852384">(</span><span class="op" id="4852385">)</span><span class="op" id="4852386">;</span>&nbsp;<span class="ident" id="4852388">err</span>&nbsp;<span class="op" id="4852392">!=</span>&nbsp;<span class="ident" id="4852395">nil</span>&nbsp;<span class="op" id="4852399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4852404">c</span><span class="op" id="4852405">.</span><span class="ident" id="4852406">server</span><span class="op" id="4852412">.</span><span class="ident" id="4852413">logf</span><span class="op" id="4852417">(</span><span class="string" id="4852418">&#34;http:&nbsp;TLS&nbsp;handshake&nbsp;error&nbsp;from&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="4852457">,</span>&nbsp;<span class="ident" id="4852459">c</span><span class="op" id="4852460">.</span><span class="ident" id="4852461">rwc</span><span class="op" id="4852464">.</span><span class="ident" id="4852465">RemoteAddr</span><span class="op" id="4852475">(</span><span class="op" id="4852476">)</span><span class="op" id="4852477">,</span>&nbsp;<span class="ident" id="4852479">err</span><span class="op" id="4852482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4852487">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4852496">}</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4852500">c</span><span class="op" id="4852501">.</span><span class="ident" id="4852502">tlsState</span>&nbsp;<span class="op" id="4852511">=</span>&nbsp;<span class="builtinfunc" id="4852513">new</span><span class="op" id="4852516">(</span><span class="ident" id="4852517">tls</span><span class="op" id="4852520">.</span><span class="ident" id="4852521">ConnectionState</span><span class="op" id="4852536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4852540">*</span><span class="ident" id="4852541">c</span><span class="op" id="4852542">.</span><span class="ident" id="4852543">tlsState</span>&nbsp;<span class="op" id="4852552">=</span>&nbsp;<span class="ident" id="4852554">tlsConn</span><span class="op" id="4852561">.</span><span class="ident" id="4852562">ConnectionState</span><span class="op" id="4852577">(</span><span class="op" id="4852578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4852582">if</span>&nbsp;<span class="ident" id="4852585">proto</span>&nbsp;<span class="op" id="4852591">:=</span>&nbsp;<span class="ident" id="4852594">c</span><span class="op" id="4852595">.</span><span class="ident" id="4852596">tlsState</span><span class="op" id="4852604">.</span><span class="ident" id="4852605">NegotiatedProtocol</span><span class="op" id="4852623">;</span>&nbsp;<span class="ident" id="4852625">validNPN</span><span class="op" id="4852633">(</span><span class="ident" id="4852634">proto</span><span class="op" id="4852639">)</span>&nbsp;<span class="op" id="4852641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4852646">if</span>&nbsp;<span class="ident" id="4852649">fn</span>&nbsp;<span class="op" id="4852652">:=</span>&nbsp;<span class="ident" id="4852655">c</span><span class="op" id="4852656">.</span><span class="ident" id="4852657">server</span><span class="op" id="4852663">.</span><span class="ident" id="4852664">TLSNextProto</span><span class="op" id="4852676">[</span><span class="ident" id="4852677">proto</span><span class="op" id="4852682">]</span><span class="op" id="4852683">;</span>&nbsp;<span class="ident" id="4852685">fn</span>&nbsp;<span class="op" id="4852688">!=</span>&nbsp;<span class="ident" id="4852691">nil</span>&nbsp;<span class="op" id="4852695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4852701">h</span>&nbsp;<span class="op" id="4852703">:=</span>&nbsp;<span class="ident" id="4852706">initNPNRequest</span><span class="op" id="4852720">{</span><span class="ident" id="4852721">tlsConn</span><span class="op" id="4852728">,</span>&nbsp;<span class="ident" id="4852730">serverHandler</span><span class="op" id="4852743">{</span><span class="ident" id="4852744">c</span><span class="op" id="4852745">.</span><span class="ident" id="4852746">server</span><span class="op" id="4852752">}</span><span class="op" id="4852753">}</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4852759">fn</span><span class="op" id="4852761">(</span><span class="ident" id="4852762">c</span><span class="op" id="4852763">.</span><span class="ident" id="4852764">server</span><span class="op" id="4852770">,</span>&nbsp;<span class="ident" id="4852772">tlsConn</span><span class="op" id="4852779">,</span>&nbsp;<span class="ident" id="4852781">h</span><span class="op" id="4852782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4852787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4852792">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4852801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4852804">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4852808">for</span>&nbsp;<span class="op" id="4852812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4852816">w</span><span class="op" id="4852817">,</span>&nbsp;<span class="ident" id="4852819">err</span>&nbsp;<span class="op" id="4852823">:=</span>&nbsp;<span class="ident" id="4852826">c</span><span class="op" id="4852827">.</span><span class="ident" id="4852828">readRequest</span><span class="op" id="4852839">(</span><span class="op" id="4852840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4852844">if</span>&nbsp;<span class="ident" id="4852847">c</span><span class="op" id="4852848">.</span><span class="ident" id="4852849">lr</span><span class="op" id="4852851">.</span><span class="ident" id="4852852">N</span>&nbsp;<span class="op" id="4852854">!=</span>&nbsp;<span class="ident" id="4852857">c</span><span class="op" id="4852858">.</span><span class="ident" id="4852859">server</span><span class="op" id="4852865">.</span><span class="ident" id="4852866">initialLimitedReaderSize</span><span class="op" id="4852890">(</span><span class="op" id="4852891">)</span>&nbsp;<span class="op" id="4852893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4852898">//&nbsp;If&nbsp;we&nbsp;read&nbsp;any&nbsp;bytes&nbsp;off&nbsp;the&nbsp;wire,&nbsp;we&#39;re&nbsp;active.</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4852953">c</span><span class="op" id="4852954">.</span><span class="ident" id="4852955">setState</span><span class="op" id="4852963">(</span><span class="ident" id="4852964">c</span><span class="op" id="4852965">.</span><span class="ident" id="4852966">rwc</span><span class="op" id="4852969">,</span>&nbsp;<span class="ident" id="4852971">StateActive</span><span class="op" id="4852982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4852986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4852990">if</span>&nbsp;<span class="ident" id="4852993">err</span>&nbsp;<span class="op" id="4852997">!=</span>&nbsp;<span class="ident" id="4853000">nil</span>&nbsp;<span class="op" id="4853004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4853009">if</span>&nbsp;<span class="ident" id="4853012">err</span>&nbsp;<span class="op" id="4853016">==</span>&nbsp;<span class="ident" id="4853019">errTooLarge</span>&nbsp;<span class="op" id="4853031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4853037">//&nbsp;Their&nbsp;HTTP&nbsp;client&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;be</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4853080">//&nbsp;able&nbsp;to&nbsp;read&nbsp;this&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4853114">//&nbsp;responding&nbsp;to&nbsp;them&nbsp;and&nbsp;hanging&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4853155">//&nbsp;while&nbsp;they&#39;re&nbsp;still&nbsp;writing&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4853196">//&nbsp;request.&nbsp;&nbsp;Undefined&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4853233">io</span><span class="op" id="4853235">.</span><span class="ident" id="4853236">WriteString</span><span class="op" id="4853247">(</span><span class="ident" id="4853248">c</span><span class="op" id="4853249">.</span><span class="ident" id="4853250">rwc</span><span class="op" id="4853253">,</span>&nbsp;<span class="string" id="4853255">&#34;HTTP/1.1&nbsp;413&nbsp;Request&nbsp;Entity&nbsp;Too&nbsp;Large\r\n\r\n&#34;</span><span class="op" id="4853302">)</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4853308">c</span><span class="op" id="4853309">.</span><span class="ident" id="4853310">closeWriteAndWait</span><span class="op" id="4853327">(</span><span class="op" id="4853328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4853334">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4853343">}</span>&nbsp;<span class="keyword" id="4853345">else</span>&nbsp;<span class="keyword" id="4853350">if</span>&nbsp;<span class="ident" id="4853353">err</span>&nbsp;<span class="op" id="4853357">==</span>&nbsp;<span class="ident" id="4853360">io</span><span class="op" id="4853362">.</span><span class="ident" id="4853363">EOF</span>&nbsp;<span class="op" id="4853367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4853373">break</span>&nbsp;<span class="comment" id="4853379">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4853397">}</span>&nbsp;<span class="keyword" id="4853399">else</span>&nbsp;<span class="keyword" id="4853404">if</span>&nbsp;<span class="ident" id="4853407">neterr</span><span class="op" id="4853413">,</span>&nbsp;<span class="ident" id="4853415">ok</span>&nbsp;<span class="op" id="4853418">:=</span>&nbsp;<span class="ident" id="4853421">err</span><span class="op" id="4853424">.</span><span class="op" id="4853425">(</span><span class="ident" id="4853426">net</span><span class="op" id="4853429">.</span><span class="ident" id="4853430">Error</span><span class="op" id="4853435">)</span><span class="op" id="4853436">;</span>&nbsp;<span class="ident" id="4853438">ok</span>&nbsp;<span class="op" id="4853441">&amp;&amp;</span>&nbsp;<span class="ident" id="4853444">neterr</span><span class="op" id="4853450">.</span><span class="ident" id="4853451">Timeout</span><span class="op" id="4853458">(</span><span class="op" id="4853459">)</span>&nbsp;<span class="op" id="4853461">{</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4853467">break</span>&nbsp;<span class="comment" id="4853473">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4853491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4853496">io</span><span class="op" id="4853498">.</span><span class="ident" id="4853499">WriteString</span><span class="op" id="4853510">(</span><span class="ident" id="4853511">c</span><span class="op" id="4853512">.</span><span class="ident" id="4853513">rwc</span><span class="op" id="4853516">,</span>&nbsp;<span class="string" id="4853518">&#34;HTTP/1.1&nbsp;400&nbsp;Bad&nbsp;Request\r\n\r\n&#34;</span><span class="op" id="4853552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4853557">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4853565">}</span><br>
<span class="lineno">1185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4853570">//&nbsp;Expect&nbsp;100&nbsp;Continue&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4853603">req</span>&nbsp;<span class="op" id="4853607">:=</span>&nbsp;<span class="ident" id="4853610">w</span><span class="op" id="4853611">.</span><span class="ident" id="4853612">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4853618">if</span>&nbsp;<span class="ident" id="4853621">req</span><span class="op" id="4853624">.</span><span class="ident" id="4853625">expectsContinue</span><span class="op" id="4853640">(</span><span class="op" id="4853641">)</span>&nbsp;<span class="op" id="4853643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4853648">if</span>&nbsp;<span class="ident" id="4853651">req</span><span class="op" id="4853654">.</span><span class="ident" id="4853655">ProtoAtLeast</span><span class="op" id="4853667">(</span><span class="num" id="4853668">1</span><span class="op" id="4853669">,</span>&nbsp;<span class="num" id="4853671">1</span><span class="op" id="4853672">)</span>&nbsp;<span class="op" id="4853674">&amp;&amp;</span>&nbsp;<span class="ident" id="4853677">req</span><span class="op" id="4853680">.</span><span class="ident" id="4853681">ContentLength</span>&nbsp;<span class="op" id="4853695">!=</span>&nbsp;<span class="num" id="4853698">0</span>&nbsp;<span class="op" id="4853700">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4853706">//&nbsp;Wrap&nbsp;the&nbsp;Body&nbsp;reader&nbsp;with&nbsp;one&nbsp;that&nbsp;replies&nbsp;on&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4853774">req</span><span class="op" id="4853777">.</span><span class="ident" id="4853778">Body</span>&nbsp;<span class="op" id="4853783">=</span>&nbsp;<span class="op" id="4853785">&amp;</span><span class="ident" id="4853786">expectContinueReader</span><span class="op" id="4853806">{</span><span class="ident" id="4853807">readCloser</span><span class="op" id="4853817">:</span>&nbsp;<span class="ident" id="4853819">req</span><span class="op" id="4853822">.</span><span class="ident" id="4853823">Body</span><span class="op" id="4853827">,</span>&nbsp;<span class="ident" id="4853829">resp</span><span class="op" id="4853833">:</span>&nbsp;<span class="ident" id="4853835">w</span><span class="op" id="4853836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4853841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4853846">req</span><span class="op" id="4853849">.</span><span class="ident" id="4853850">Header</span><span class="op" id="4853856">.</span><span class="ident" id="4853857">Del</span><span class="op" id="4853860">(</span><span class="string" id="4853861">&#34;Expect&#34;</span><span class="op" id="4853869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4853873">}</span>&nbsp;<span class="keyword" id="4853875">else</span>&nbsp;<span class="keyword" id="4853880">if</span>&nbsp;<span class="ident" id="4853883">req</span><span class="op" id="4853886">.</span><span class="ident" id="4853887">Header</span><span class="op" id="4853893">.</span><span class="ident" id="4853894">get</span><span class="op" id="4853897">(</span><span class="string" id="4853898">&#34;Expect&#34;</span><span class="op" id="4853906">)</span>&nbsp;<span class="op" id="4853908">!=</span>&nbsp;<span class="string" id="4853911">&#34;&#34;</span>&nbsp;<span class="op" id="4853914">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4853919">w</span><span class="op" id="4853920">.</span><span class="ident" id="4853921">sendExpectationFailed</span><span class="op" id="4853942">(</span><span class="op" id="4853943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4853948">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4853956">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4853961">//&nbsp;HTTP&nbsp;cannot&nbsp;have&nbsp;multiple&nbsp;simultaneous&nbsp;active&nbsp;requests.[*]</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4854025">//&nbsp;Until&nbsp;the&nbsp;server&nbsp;replies&nbsp;to&nbsp;this&nbsp;request,&nbsp;it&nbsp;can&#39;t&nbsp;read&nbsp;another,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4854095">//&nbsp;so&nbsp;we&nbsp;might&nbsp;as&nbsp;well&nbsp;run&nbsp;the&nbsp;handler&nbsp;in&nbsp;this&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4854155">//&nbsp;[*]&nbsp;Not&nbsp;strictly&nbsp;true:&nbsp;HTTP&nbsp;pipelining.&nbsp;&nbsp;We&nbsp;could&nbsp;let&nbsp;them&nbsp;all&nbsp;process</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4854231">//&nbsp;in&nbsp;parallel&nbsp;even&nbsp;if&nbsp;their&nbsp;responses&nbsp;need&nbsp;to&nbsp;be&nbsp;serialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4854295">serverHandler</span><span class="op" id="4854308">{</span><span class="ident" id="4854309">c</span><span class="op" id="4854310">.</span><span class="ident" id="4854311">server</span><span class="op" id="4854317">}</span><span class="op" id="4854318">.</span><span class="ident" id="4854319">ServeHTTP</span><span class="op" id="4854328">(</span><span class="ident" id="4854329">w</span><span class="op" id="4854330">,</span>&nbsp;<span class="ident" id="4854332">w</span><span class="op" id="4854333">.</span><span class="ident" id="4854334">req</span><span class="op" id="4854337">)</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4854341">if</span>&nbsp;<span class="ident" id="4854344">c</span><span class="op" id="4854345">.</span><span class="ident" id="4854346">hijacked</span><span class="op" id="4854354">(</span><span class="op" id="4854355">)</span>&nbsp;<span class="op" id="4854357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4854362">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4854371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4854375">w</span><span class="op" id="4854376">.</span><span class="ident" id="4854377">finishRequest</span><span class="op" id="4854390">(</span><span class="op" id="4854391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4854395">if</span>&nbsp;<span class="ident" id="4854398">w</span><span class="op" id="4854399">.</span><span class="ident" id="4854400">closeAfterReply</span>&nbsp;<span class="op" id="4854416">{</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4854421">if</span>&nbsp;<span class="ident" id="4854424">w</span><span class="op" id="4854425">.</span><span class="ident" id="4854426">requestBodyLimitHit</span>&nbsp;<span class="op" id="4854446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4854452">c</span><span class="op" id="4854453">.</span><span class="ident" id="4854454">closeWriteAndWait</span><span class="op" id="4854471">(</span><span class="op" id="4854472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4854477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4854482">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4854490">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4854494">c</span><span class="op" id="4854495">.</span><span class="ident" id="4854496">setState</span><span class="op" id="4854504">(</span><span class="ident" id="4854505">c</span><span class="op" id="4854506">.</span><span class="ident" id="4854507">rwc</span><span class="op" id="4854510">,</span>&nbsp;<span class="ident" id="4854512">StateIdle</span><span class="op" id="4854521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4854524">}</span><br>
<span class="lineno"></span><span class="op" id="4854526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4854529">func</span>&nbsp;<span class="op" id="4854534">(</span><span class="ident" id="4854535">w</span>&nbsp;<span class="op" id="4854537">*</span><span class="ident" id="4854538">response</span><span class="op" id="4854546">)</span>&nbsp;<span class="ident" id="4854548">sendExpectationFailed</span><span class="op" id="4854569">(</span><span class="op" id="4854570">)</span>&nbsp;<span class="op" id="4854572">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4854575">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;ServeHTTP&nbsp;handlers&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4854625">//&nbsp;requests&nbsp;with&nbsp;non-standard&nbsp;expectation[s]?&nbsp;Seems</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4854678">//&nbsp;theoretical&nbsp;at&nbsp;best,&nbsp;and&nbsp;doesn&#39;t&nbsp;fit&nbsp;into&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4854728">//&nbsp;current&nbsp;ServeHTTP&nbsp;model&nbsp;anyway.&nbsp;&nbsp;We&#39;d&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4854778">//&nbsp;make&nbsp;the&nbsp;ResponseWriter&nbsp;an&nbsp;optional</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4854818">//&nbsp;&#34;ExpectReplier&#34;&nbsp;interface&nbsp;or&nbsp;something.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4854862">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4854866">//&nbsp;For&nbsp;now&nbsp;we&#39;ll&nbsp;just&nbsp;obey&nbsp;RFC&nbsp;2616&nbsp;14.20&nbsp;which&nbsp;says</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4854920">//&nbsp;&#34;If&nbsp;a&nbsp;server&nbsp;receives&nbsp;a&nbsp;request&nbsp;containing&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4854970">//&nbsp;Expect&nbsp;field&nbsp;that&nbsp;includes&nbsp;an&nbsp;expectation-</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4855017">//&nbsp;extension&nbsp;that&nbsp;it&nbsp;does&nbsp;not&nbsp;support,&nbsp;it&nbsp;MUST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4855065">//&nbsp;respond&nbsp;with&nbsp;a&nbsp;417&nbsp;(Expectation&nbsp;Failed)&nbsp;status.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4855118">w</span><span class="op" id="4855119">.</span><span class="ident" id="4855120">Header</span><span class="op" id="4855126">(</span><span class="op" id="4855127">)</span><span class="op" id="4855128">.</span><span class="ident" id="4855129">Set</span><span class="op" id="4855132">(</span><span class="string" id="4855133">&#34;Connection&#34;</span><span class="op" id="4855145">,</span>&nbsp;<span class="string" id="4855147">&#34;close&#34;</span><span class="op" id="4855154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4855157">w</span><span class="op" id="4855158">.</span><span class="ident" id="4855159">WriteHeader</span><span class="op" id="4855170">(</span><span class="ident" id="4855171">StatusExpectationFailed</span><span class="op" id="4855194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4855197">w</span><span class="op" id="4855198">.</span><span class="ident" id="4855199">finishRequest</span><span class="op" id="4855212">(</span><span class="op" id="4855213">)</span><br>
<span class="lineno">1235</span><span class="op" id="4855215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4855218">//&nbsp;Hijack&nbsp;implements&nbsp;the&nbsp;Hijacker.Hijack&nbsp;method.&nbsp;Our&nbsp;response&nbsp;is&nbsp;both&nbsp;a&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="4855305">//&nbsp;and&nbsp;a&nbsp;Hijacker.</span><br>
<span class="lineno"></span><span class="keyword" id="4855324">func</span>&nbsp;<span class="op" id="4855329">(</span><span class="ident" id="4855330">w</span>&nbsp;<span class="op" id="4855332">*</span><span class="ident" id="4855333">response</span><span class="op" id="4855341">)</span>&nbsp;<span class="ident" id="4855343">Hijack</span><span class="op" id="4855349">(</span><span class="op" id="4855350">)</span>&nbsp;<span class="op" id="4855352">(</span><span class="ident" id="4855353">rwc</span>&nbsp;<span class="ident" id="4855357">net</span><span class="op" id="4855360">.</span><span class="ident" id="4855361">Conn</span><span class="op" id="4855365">,</span>&nbsp;<span class="ident" id="4855367">buf</span>&nbsp;<span class="op" id="4855371">*</span><span class="ident" id="4855372">bufio</span><span class="op" id="4855377">.</span><span class="ident" id="4855378">ReadWriter</span><span class="op" id="4855388">,</span>&nbsp;<span class="ident" id="4855390">err</span>&nbsp;<span class="builtintype" id="4855394">error</span><span class="op" id="4855399">)</span>&nbsp;<span class="op" id="4855401">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4855404">if</span>&nbsp;<span class="ident" id="4855407">w</span><span class="op" id="4855408">.</span><span class="ident" id="4855409">wroteHeader</span>&nbsp;<span class="op" id="4855421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4855425">w</span><span class="op" id="4855426">.</span><span class="ident" id="4855427">cw</span><span class="op" id="4855429">.</span><span class="ident" id="4855430">flush</span><span class="op" id="4855435">(</span><span class="op" id="4855436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4855439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4855442">//&nbsp;Release&nbsp;the&nbsp;bufioWriter&nbsp;that&nbsp;writes&nbsp;to&nbsp;the&nbsp;chunk&nbsp;writer,&nbsp;it&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4855513">//&nbsp;used&nbsp;after&nbsp;a&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked.</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4855560">rwc</span><span class="op" id="4855563">,</span>&nbsp;<span class="ident" id="4855565">buf</span><span class="op" id="4855568">,</span>&nbsp;<span class="ident" id="4855570">err</span>&nbsp;<span class="op" id="4855574">=</span>&nbsp;<span class="ident" id="4855576">w</span><span class="op" id="4855577">.</span><span class="ident" id="4855578">conn</span><span class="op" id="4855582">.</span><span class="ident" id="4855583">hijack</span><span class="op" id="4855589">(</span><span class="op" id="4855590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4855593">if</span>&nbsp;<span class="ident" id="4855596">err</span>&nbsp;<span class="op" id="4855600">==</span>&nbsp;<span class="ident" id="4855603">nil</span>&nbsp;<span class="op" id="4855607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4855611">putBufioWriter</span><span class="op" id="4855625">(</span><span class="ident" id="4855626">w</span><span class="op" id="4855627">.</span><span class="ident" id="4855628">w</span><span class="op" id="4855629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4855633">w</span><span class="op" id="4855634">.</span><span class="ident" id="4855635">w</span>&nbsp;<span class="op" id="4855637">=</span>&nbsp;<span class="ident" id="4855639">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4855644">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4855647">return</span>&nbsp;<span class="ident" id="4855654">rwc</span><span class="op" id="4855657">,</span>&nbsp;<span class="ident" id="4855659">buf</span><span class="op" id="4855662">,</span>&nbsp;<span class="ident" id="4855664">err</span><br>
<span class="lineno"></span><span class="op" id="4855668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4855671">func</span>&nbsp;<span class="op" id="4855676">(</span><span class="ident" id="4855677">w</span>&nbsp;<span class="op" id="4855679">*</span><span class="ident" id="4855680">response</span><span class="op" id="4855688">)</span>&nbsp;<span class="ident" id="4855690">CloseNotify</span><span class="op" id="4855701">(</span><span class="op" id="4855702">)</span>&nbsp;<span class="op" id="4855704">&lt;-</span><span class="keyword" id="4855706">chan</span>&nbsp;<span class="builtintype" id="4855711">bool</span>&nbsp;<span class="op" id="4855716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4855719">return</span>&nbsp;<span class="ident" id="4855726">w</span><span class="op" id="4855727">.</span><span class="ident" id="4855728">conn</span><span class="op" id="4855732">.</span><span class="ident" id="4855733">closeNotify</span><span class="op" id="4855744">(</span><span class="op" id="4855745">)</span><br>
<span class="lineno">1255</span><span class="op" id="4855747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4855750">//&nbsp;The&nbsp;HandlerFunc&nbsp;type&nbsp;is&nbsp;an&nbsp;adapter&nbsp;to&nbsp;allow&nbsp;the&nbsp;use&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4855808">//&nbsp;ordinary&nbsp;functions&nbsp;as&nbsp;HTTP&nbsp;handlers.&nbsp;&nbsp;If&nbsp;f&nbsp;is&nbsp;a&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="4855868">//&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;signature,&nbsp;HandlerFunc(f)&nbsp;is&nbsp;a</span><br>
<span class="lineno">1260</span><span class="comment" id="4855923">//&nbsp;Handler&nbsp;object&nbsp;that&nbsp;calls&nbsp;f.</span><br>
<span class="lineno"></span><span class="keyword" id="4855955">type</span>&nbsp;<span class="ident" id="4855960">HandlerFunc</span>&nbsp;<span class="keyword" id="4855972">func</span><span class="op" id="4855976">(</span><span class="ident" id="4855977">ResponseWriter</span><span class="op" id="4855991">,</span>&nbsp;<span class="op" id="4855993">*</span><span class="ident" id="4855994">Request</span><span class="op" id="4856001">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4856004">//&nbsp;ServeHTTP&nbsp;calls&nbsp;f(w,&nbsp;r).</span><br>
<span class="lineno"></span><span class="keyword" id="4856032">func</span>&nbsp;<span class="op" id="4856037">(</span><span class="ident" id="4856038">f</span>&nbsp;<span class="ident" id="4856040">HandlerFunc</span><span class="op" id="4856051">)</span>&nbsp;<span class="ident" id="4856053">ServeHTTP</span><span class="op" id="4856062">(</span><span class="ident" id="4856063">w</span>&nbsp;<span class="ident" id="4856065">ResponseWriter</span><span class="op" id="4856079">,</span>&nbsp;<span class="ident" id="4856081">r</span>&nbsp;<span class="op" id="4856083">*</span><span class="ident" id="4856084">Request</span><span class="op" id="4856091">)</span>&nbsp;<span class="op" id="4856093">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4856096">f</span><span class="op" id="4856097">(</span><span class="ident" id="4856098">w</span><span class="op" id="4856099">,</span>&nbsp;<span class="ident" id="4856101">r</span><span class="op" id="4856102">)</span><br>
<span class="lineno"></span><span class="op" id="4856104">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4856107">//&nbsp;Helper&nbsp;handlers</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="4856127">//&nbsp;Error&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;specified&nbsp;error&nbsp;message&nbsp;and&nbsp;HTTP&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment" id="4856207">//&nbsp;The&nbsp;error&nbsp;message&nbsp;should&nbsp;be&nbsp;plain&nbsp;text.</span><br>
<span class="lineno"></span><span class="keyword" id="4856250">func</span>&nbsp;<span class="ident" id="4856255">Error</span><span class="op" id="4856260">(</span><span class="ident" id="4856261">w</span>&nbsp;<span class="ident" id="4856263">ResponseWriter</span><span class="op" id="4856277">,</span>&nbsp;<span class="builtintype" id="4856279">error</span>&nbsp;<span class="builtintype" id="4856285">string</span><span class="op" id="4856291">,</span>&nbsp;<span class="ident" id="4856293">code</span>&nbsp;<span class="builtintype" id="4856298">int</span><span class="op" id="4856301">)</span>&nbsp;<span class="op" id="4856303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4856306">w</span><span class="op" id="4856307">.</span><span class="ident" id="4856308">Header</span><span class="op" id="4856314">(</span><span class="op" id="4856315">)</span><span class="op" id="4856316">.</span><span class="ident" id="4856317">Set</span><span class="op" id="4856320">(</span><span class="string" id="4856321">&#34;Content-Type&#34;</span><span class="op" id="4856335">,</span>&nbsp;<span class="string" id="4856337">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="4856364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4856367">w</span><span class="op" id="4856368">.</span><span class="ident" id="4856369">WriteHeader</span><span class="op" id="4856380">(</span><span class="ident" id="4856381">code</span><span class="op" id="4856385">)</span><br>
<span class="lineno">1275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4856388">fmt</span><span class="op" id="4856391">.</span><span class="ident" id="4856392">Fprintln</span><span class="op" id="4856400">(</span><span class="ident" id="4856401">w</span><span class="op" id="4856402">,</span>&nbsp;<span class="builtintype" id="4856404">error</span><span class="op" id="4856409">)</span><br>
<span class="lineno"></span><span class="op" id="4856411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4856414">//&nbsp;NotFound&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4856483">func</span>&nbsp;<span class="ident" id="4856488">NotFound</span><span class="op" id="4856496">(</span><span class="ident" id="4856497">w</span>&nbsp;<span class="ident" id="4856499">ResponseWriter</span><span class="op" id="4856513">,</span>&nbsp;<span class="ident" id="4856515">r</span>&nbsp;<span class="op" id="4856517">*</span><span class="ident" id="4856518">Request</span><span class="op" id="4856525">)</span>&nbsp;<span class="op" id="4856527">{</span>&nbsp;<span class="ident" id="4856529">Error</span><span class="op" id="4856534">(</span><span class="ident" id="4856535">w</span><span class="op" id="4856536">,</span>&nbsp;<span class="string" id="4856538">&#34;404&nbsp;page&nbsp;not&nbsp;found&#34;</span><span class="op" id="4856558">,</span>&nbsp;<span class="ident" id="4856560">StatusNotFound</span><span class="op" id="4856574">)</span>&nbsp;<span class="op" id="4856576">}</span><br>
<span class="lineno">1280</span><br>
<span class="lineno"></span><span class="comment" id="4856579">//&nbsp;NotFoundHandler&nbsp;returns&nbsp;a&nbsp;simple&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="4856631">//&nbsp;that&nbsp;replies&nbsp;to&nbsp;each&nbsp;request&nbsp;with&nbsp;a&nbsp;``404&nbsp;page&nbsp;not&nbsp;found&#39;&#39;&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="4856700">func</span>&nbsp;<span class="ident" id="4856705">NotFoundHandler</span><span class="op" id="4856720">(</span><span class="op" id="4856721">)</span>&nbsp;<span class="ident" id="4856723">Handler</span>&nbsp;<span class="op" id="4856731">{</span>&nbsp;<span class="keyword" id="4856733">return</span>&nbsp;<span class="ident" id="4856740">HandlerFunc</span><span class="op" id="4856751">(</span><span class="ident" id="4856752">NotFound</span><span class="op" id="4856760">)</span>&nbsp;<span class="op" id="4856762">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span><span class="comment" id="4856765">//&nbsp;StripPrefix&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="4856824">//&nbsp;by&nbsp;removing&nbsp;the&nbsp;given&nbsp;prefix&nbsp;from&nbsp;the&nbsp;request&nbsp;URL&#39;s&nbsp;Path</span><br>
<span class="lineno"></span><span class="comment" id="4856884">//&nbsp;and&nbsp;invoking&nbsp;the&nbsp;handler&nbsp;h.&nbsp;StripPrefix&nbsp;handles&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4856937">//&nbsp;request&nbsp;for&nbsp;a&nbsp;path&nbsp;that&nbsp;doesn&#39;t&nbsp;begin&nbsp;with&nbsp;prefix&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="4856993">//&nbsp;replying&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno">1290</span><span class="keyword" id="4857039">func</span>&nbsp;<span class="ident" id="4857044">StripPrefix</span><span class="op" id="4857055">(</span><span class="ident" id="4857056">prefix</span>&nbsp;<span class="builtintype" id="4857063">string</span><span class="op" id="4857069">,</span>&nbsp;<span class="ident" id="4857071">h</span>&nbsp;<span class="ident" id="4857073">Handler</span><span class="op" id="4857080">)</span>&nbsp;<span class="ident" id="4857082">Handler</span>&nbsp;<span class="op" id="4857090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4857093">if</span>&nbsp;<span class="ident" id="4857096">prefix</span>&nbsp;<span class="op" id="4857103">==</span>&nbsp;<span class="string" id="4857106">&#34;&#34;</span>&nbsp;<span class="op" id="4857109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4857113">return</span>&nbsp;<span class="ident" id="4857120">h</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4857123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4857126">return</span>&nbsp;<span class="ident" id="4857133">HandlerFunc</span><span class="op" id="4857144">(</span><span class="keyword" id="4857145">func</span><span class="op" id="4857149">(</span><span class="ident" id="4857150">w</span>&nbsp;<span class="ident" id="4857152">ResponseWriter</span><span class="op" id="4857166">,</span>&nbsp;<span class="ident" id="4857168">r</span>&nbsp;<span class="op" id="4857170">*</span><span class="ident" id="4857171">Request</span><span class="op" id="4857178">)</span>&nbsp;<span class="op" id="4857180">{</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4857184">if</span>&nbsp;<span class="ident" id="4857187">p</span>&nbsp;<span class="op" id="4857189">:=</span>&nbsp;<span class="ident" id="4857192">strings</span><span class="op" id="4857199">.</span><span class="ident" id="4857200">TrimPrefix</span><span class="op" id="4857210">(</span><span class="ident" id="4857211">r</span><span class="op" id="4857212">.</span><span class="ident" id="4857213">URL</span><span class="op" id="4857216">.</span><span class="ident" id="4857217">Path</span><span class="op" id="4857221">,</span>&nbsp;<span class="ident" id="4857223">prefix</span><span class="op" id="4857229">)</span><span class="op" id="4857230">;</span>&nbsp;<span class="builtinfunc" id="4857232">len</span><span class="op" id="4857235">(</span><span class="ident" id="4857236">p</span><span class="op" id="4857237">)</span>&nbsp;<span class="op" id="4857239">&lt;</span>&nbsp;<span class="builtinfunc" id="4857241">len</span><span class="op" id="4857244">(</span><span class="ident" id="4857245">r</span><span class="op" id="4857246">.</span><span class="ident" id="4857247">URL</span><span class="op" id="4857250">.</span><span class="ident" id="4857251">Path</span><span class="op" id="4857255">)</span>&nbsp;<span class="op" id="4857257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4857262">r</span><span class="op" id="4857263">.</span><span class="ident" id="4857264">URL</span><span class="op" id="4857267">.</span><span class="ident" id="4857268">Path</span>&nbsp;<span class="op" id="4857273">=</span>&nbsp;<span class="ident" id="4857275">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4857280">h</span><span class="op" id="4857281">.</span><span class="ident" id="4857282">ServeHTTP</span><span class="op" id="4857291">(</span><span class="ident" id="4857292">w</span><span class="op" id="4857293">,</span>&nbsp;<span class="ident" id="4857295">r</span><span class="op" id="4857296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4857300">}</span>&nbsp;<span class="keyword" id="4857302">else</span>&nbsp;<span class="op" id="4857307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4857312">NotFound</span><span class="op" id="4857320">(</span><span class="ident" id="4857321">w</span><span class="op" id="4857322">,</span>&nbsp;<span class="ident" id="4857324">r</span><span class="op" id="4857325">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4857329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4857332">}</span><span class="op" id="4857333">)</span><br>
<span class="lineno"></span><span class="op" id="4857335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4857338">//&nbsp;Redirect&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;a&nbsp;redirect&nbsp;to&nbsp;url,</span><br>
<span class="lineno">1305</span><span class="comment" id="4857397">//&nbsp;which&nbsp;may&nbsp;be&nbsp;a&nbsp;path&nbsp;relative&nbsp;to&nbsp;the&nbsp;request&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="4857450">func</span>&nbsp;<span class="ident" id="4857455">Redirect</span><span class="op" id="4857463">(</span><span class="ident" id="4857464">w</span>&nbsp;<span class="ident" id="4857466">ResponseWriter</span><span class="op" id="4857480">,</span>&nbsp;<span class="ident" id="4857482">r</span>&nbsp;<span class="op" id="4857484">*</span><span class="ident" id="4857485">Request</span><span class="op" id="4857492">,</span>&nbsp;<span class="ident" id="4857494">urlStr</span>&nbsp;<span class="builtintype" id="4857501">string</span><span class="op" id="4857507">,</span>&nbsp;<span class="ident" id="4857509">code</span>&nbsp;<span class="builtintype" id="4857514">int</span><span class="op" id="4857517">)</span>&nbsp;<span class="op" id="4857519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4857522">if</span>&nbsp;<span class="ident" id="4857525">u</span><span class="op" id="4857526">,</span>&nbsp;<span class="ident" id="4857528">err</span>&nbsp;<span class="op" id="4857532">:=</span>&nbsp;<span class="ident" id="4857535">url</span><span class="op" id="4857538">.</span><span class="ident" id="4857539">Parse</span><span class="op" id="4857544">(</span><span class="ident" id="4857545">urlStr</span><span class="op" id="4857551">)</span><span class="op" id="4857552">;</span>&nbsp;<span class="ident" id="4857554">err</span>&nbsp;<span class="op" id="4857558">==</span>&nbsp;<span class="ident" id="4857561">nil</span>&nbsp;<span class="op" id="4857565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4857569">//&nbsp;If&nbsp;url&nbsp;was&nbsp;relative,&nbsp;make&nbsp;absolute&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4857612">//&nbsp;combining&nbsp;with&nbsp;request&nbsp;path.</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4857646">//&nbsp;The&nbsp;browser&nbsp;would&nbsp;probably&nbsp;do&nbsp;this&nbsp;for&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4857694">//&nbsp;but&nbsp;doing&nbsp;it&nbsp;ourselves&nbsp;is&nbsp;more&nbsp;reliable.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4857741">//&nbsp;NOTE(rsc):&nbsp;RFC&nbsp;2616&nbsp;says&nbsp;that&nbsp;the&nbsp;Location</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4857789">//&nbsp;line&nbsp;must&nbsp;be&nbsp;an&nbsp;absolute&nbsp;URI,&nbsp;like</span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4857829">//&nbsp;&#34;http://www.google.com/redirect/&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4857869">//&nbsp;not&nbsp;a&nbsp;path&nbsp;like&nbsp;&#34;/redirect/&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4857904">//&nbsp;Unfortunately,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;what&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4857946">//&nbsp;put&nbsp;in&nbsp;the&nbsp;host&nbsp;name&nbsp;section&nbsp;to&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4857991">//&nbsp;client&nbsp;to&nbsp;connect&nbsp;to&nbsp;us&nbsp;again,&nbsp;so&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4858039">//&nbsp;know&nbsp;the&nbsp;right&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;send&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4858086">//&nbsp;Because&nbsp;of&nbsp;this&nbsp;problem,&nbsp;no&nbsp;one&nbsp;pays&nbsp;attention</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4858138">//&nbsp;to&nbsp;the&nbsp;RFC;&nbsp;they&nbsp;all&nbsp;send&nbsp;back&nbsp;just&nbsp;a&nbsp;new&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4858191">//&nbsp;So&nbsp;do&nbsp;we.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858206">oldpath</span>&nbsp;<span class="op" id="4858214">:=</span>&nbsp;<span class="ident" id="4858217">r</span><span class="op" id="4858218">.</span><span class="ident" id="4858219">URL</span><span class="op" id="4858222">.</span><span class="ident" id="4858223">Path</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858230">if</span>&nbsp;<span class="ident" id="4858233">oldpath</span>&nbsp;<span class="op" id="4858241">==</span>&nbsp;<span class="string" id="4858244">&#34;&#34;</span>&nbsp;<span class="op" id="4858247">{</span>&nbsp;<span class="comment" id="4858249">//&nbsp;should&nbsp;not&nbsp;happen,&nbsp;but&nbsp;avoid&nbsp;a&nbsp;crash&nbsp;if&nbsp;it&nbsp;does</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858303">oldpath</span>&nbsp;<span class="op" id="4858311">=</span>&nbsp;<span class="string" id="4858313">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4858319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858323">if</span>&nbsp;<span class="ident" id="4858326">u</span><span class="op" id="4858327">.</span><span class="ident" id="4858328">Scheme</span>&nbsp;<span class="op" id="4858335">==</span>&nbsp;<span class="string" id="4858338">&#34;&#34;</span>&nbsp;<span class="op" id="4858341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4858346">//&nbsp;no&nbsp;leading&nbsp;http://server</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858377">if</span>&nbsp;<span class="ident" id="4858380">urlStr</span>&nbsp;<span class="op" id="4858387">==</span>&nbsp;<span class="string" id="4858390">&#34;&#34;</span>&nbsp;<span class="op" id="4858393">||</span>&nbsp;<span class="ident" id="4858396">urlStr</span><span class="op" id="4858402">[</span><span class="num" id="4858403">0</span><span class="op" id="4858404">]</span>&nbsp;<span class="op" id="4858406">!=</span>&nbsp;<span class="string" id="4858409">&#39;/&#39;</span>&nbsp;<span class="op" id="4858413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4858419">//&nbsp;make&nbsp;relative&nbsp;path&nbsp;absolute</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858454">olddir</span><span class="op" id="4858460">,</span>&nbsp;<span class="ident" id="4858462">_</span>&nbsp;<span class="op" id="4858464">:=</span>&nbsp;<span class="ident" id="4858467">path</span><span class="op" id="4858471">.</span><span class="ident" id="4858472">Split</span><span class="op" id="4858477">(</span><span class="ident" id="4858478">oldpath</span><span class="op" id="4858485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858491">urlStr</span>&nbsp;<span class="op" id="4858498">=</span>&nbsp;<span class="ident" id="4858500">olddir</span>&nbsp;<span class="op" id="4858507">+</span>&nbsp;<span class="ident" id="4858509">urlStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4858519">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858525">var</span>&nbsp;<span class="ident" id="4858529">query</span>&nbsp;<span class="builtintype" id="4858535">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858545">if</span>&nbsp;<span class="ident" id="4858548">i</span>&nbsp;<span class="op" id="4858550">:=</span>&nbsp;<span class="ident" id="4858553">strings</span><span class="op" id="4858560">.</span><span class="ident" id="4858561">Index</span><span class="op" id="4858566">(</span><span class="ident" id="4858567">urlStr</span><span class="op" id="4858573">,</span>&nbsp;<span class="string" id="4858575">&#34;?&#34;</span><span class="op" id="4858578">)</span><span class="op" id="4858579">;</span>&nbsp;<span class="ident" id="4858581">i</span>&nbsp;<span class="op" id="4858583">!=</span>&nbsp;<span class="op" id="4858586">-</span><span class="num" id="4858587">1</span>&nbsp;<span class="op" id="4858589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858595">urlStr</span><span class="op" id="4858601">,</span>&nbsp;<span class="ident" id="4858603">query</span>&nbsp;<span class="op" id="4858609">=</span>&nbsp;<span class="ident" id="4858611">urlStr</span><span class="op" id="4858617">[</span><span class="op" id="4858618">:</span><span class="ident" id="4858619">i</span><span class="op" id="4858620">]</span><span class="op" id="4858621">,</span>&nbsp;<span class="ident" id="4858623">urlStr</span><span class="op" id="4858629">[</span><span class="ident" id="4858630">i</span><span class="op" id="4858631">:</span><span class="op" id="4858632">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4858637">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4858643">//&nbsp;clean&nbsp;up&nbsp;but&nbsp;preserve&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858686">trailing</span>&nbsp;<span class="op" id="4858695">:=</span>&nbsp;<span class="ident" id="4858698">strings</span><span class="op" id="4858705">.</span><span class="ident" id="4858706">HasSuffix</span><span class="op" id="4858715">(</span><span class="ident" id="4858716">urlStr</span><span class="op" id="4858722">,</span>&nbsp;<span class="string" id="4858724">&#34;/&#34;</span><span class="op" id="4858727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858732">urlStr</span>&nbsp;<span class="op" id="4858739">=</span>&nbsp;<span class="ident" id="4858741">path</span><span class="op" id="4858745">.</span><span class="ident" id="4858746">Clean</span><span class="op" id="4858751">(</span><span class="ident" id="4858752">urlStr</span><span class="op" id="4858758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4858763">if</span>&nbsp;<span class="ident" id="4858766">trailing</span>&nbsp;<span class="op" id="4858775">&amp;&amp;</span>&nbsp;<span class="op" id="4858778">!</span><span class="ident" id="4858779">strings</span><span class="op" id="4858786">.</span><span class="ident" id="4858787">HasSuffix</span><span class="op" id="4858796">(</span><span class="ident" id="4858797">urlStr</span><span class="op" id="4858803">,</span>&nbsp;<span class="string" id="4858805">&#34;/&#34;</span><span class="op" id="4858808">)</span>&nbsp;<span class="op" id="4858810">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858816">urlStr</span>&nbsp;<span class="op" id="4858823">+=</span>&nbsp;<span class="string" id="4858826">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4858833">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858838">urlStr</span>&nbsp;<span class="op" id="4858845">+=</span>&nbsp;<span class="ident" id="4858848">query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4858856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4858859">}</span><br>
<span class="lineno">1350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858863">w</span><span class="op" id="4858864">.</span><span class="ident" id="4858865">Header</span><span class="op" id="4858871">(</span><span class="op" id="4858872">)</span><span class="op" id="4858873">.</span><span class="ident" id="4858874">Set</span><span class="op" id="4858877">(</span><span class="string" id="4858878">&#34;Location&#34;</span><span class="op" id="4858888">,</span>&nbsp;<span class="ident" id="4858890">urlStr</span><span class="op" id="4858896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4858899">w</span><span class="op" id="4858900">.</span><span class="ident" id="4858901">WriteHeader</span><span class="op" id="4858912">(</span><span class="ident" id="4858913">code</span><span class="op" id="4858917">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4858921">//&nbsp;RFC2616&nbsp;recommends&nbsp;that&nbsp;a&nbsp;short&nbsp;note&nbsp;&#34;SHOULD&#34;&nbsp;be&nbsp;included&nbsp;in&nbsp;the</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4858990">//&nbsp;response&nbsp;because&nbsp;older&nbsp;user&nbsp;agents&nbsp;may&nbsp;not&nbsp;understand&nbsp;301/307.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4859057">//&nbsp;Shouldn&#39;t&nbsp;send&nbsp;the&nbsp;response&nbsp;for&nbsp;POST&nbsp;or&nbsp;HEAD;&nbsp;that&nbsp;leaves&nbsp;GET.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4859124">if</span>&nbsp;<span class="ident" id="4859127">r</span><span class="op" id="4859128">.</span><span class="ident" id="4859129">Method</span>&nbsp;<span class="op" id="4859136">==</span>&nbsp;<span class="string" id="4859139">&#34;GET&#34;</span>&nbsp;<span class="op" id="4859145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859149">note</span>&nbsp;<span class="op" id="4859154">:=</span>&nbsp;<span class="string" id="4859157">&#34;&lt;a&nbsp;href=\&#34;&#34;</span>&nbsp;<span class="op" id="4859170">+</span>&nbsp;<span class="ident" id="4859172">htmlEscape</span><span class="op" id="4859182">(</span><span class="ident" id="4859183">urlStr</span><span class="op" id="4859189">)</span>&nbsp;<span class="op" id="4859191">+</span>&nbsp;<span class="string" id="4859193">&#34;\&#34;&gt;&#34;</span>&nbsp;<span class="op" id="4859199">+</span>&nbsp;<span class="ident" id="4859201">statusText</span><span class="op" id="4859211">[</span><span class="ident" id="4859212">code</span><span class="op" id="4859216">]</span>&nbsp;<span class="op" id="4859218">+</span>&nbsp;<span class="string" id="4859220">&#34;&lt;/a&gt;.\n&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859232">fmt</span><span class="op" id="4859235">.</span><span class="ident" id="4859236">Fprintln</span><span class="op" id="4859244">(</span><span class="ident" id="4859245">w</span><span class="op" id="4859246">,</span>&nbsp;<span class="ident" id="4859248">note</span><span class="op" id="4859252">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4859255">}</span><br>
<span class="lineno"></span><span class="op" id="4859257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4859260">var</span>&nbsp;<span class="ident" id="4859264">htmlReplacer</span>&nbsp;<span class="op" id="4859277">=</span>&nbsp;<span class="ident" id="4859279">strings</span><span class="op" id="4859286">.</span><span class="ident" id="4859287">NewReplacer</span><span class="op" id="4859298">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4859301">&#34;&amp;&#34;</span><span class="op" id="4859304">,</span>&nbsp;<span class="string" id="4859306">&#34;&amp;amp;&#34;</span><span class="op" id="4859313">,</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4859316">&#34;&lt;&#34;</span><span class="op" id="4859319">,</span>&nbsp;<span class="string" id="4859321">&#34;&amp;lt;&#34;</span><span class="op" id="4859327">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4859330">&#34;&gt;&#34;</span><span class="op" id="4859333">,</span>&nbsp;<span class="string" id="4859335">&#34;&amp;gt;&#34;</span><span class="op" id="4859341">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4859344">//&nbsp;&#34;&amp;#34;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;quot;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4859382">`&#34;`</span><span class="op" id="4859385">,</span>&nbsp;<span class="string" id="4859387">&#34;&amp;#34;&#34;</span><span class="op" id="4859394">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4859397">//&nbsp;&#34;&amp;#39;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;apos;&#34;&nbsp;and&nbsp;apos&nbsp;was&nbsp;not&nbsp;in&nbsp;HTML&nbsp;until&nbsp;HTML5.</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4859472">&#34;&#39;&#34;</span><span class="op" id="4859475">,</span>&nbsp;<span class="string" id="4859477">&#34;&amp;#39;&#34;</span><span class="op" id="4859484">,</span><br>
<span class="lineno"></span><span class="op" id="4859486">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4859489">func</span>&nbsp;<span class="ident" id="4859494">htmlEscape</span><span class="op" id="4859504">(</span><span class="ident" id="4859505">s</span>&nbsp;<span class="builtintype" id="4859507">string</span><span class="op" id="4859513">)</span>&nbsp;<span class="builtintype" id="4859515">string</span>&nbsp;<span class="op" id="4859522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4859525">return</span>&nbsp;<span class="ident" id="4859532">htmlReplacer</span><span class="op" id="4859544">.</span><span class="ident" id="4859545">Replace</span><span class="op" id="4859552">(</span><span class="ident" id="4859553">s</span><span class="op" id="4859554">)</span><br>
<span class="lineno">1375</span><span class="op" id="4859556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4859559">//&nbsp;Redirect&nbsp;to&nbsp;a&nbsp;fixed&nbsp;URL</span><br>
<span class="lineno"></span><span class="keyword" id="4859586">type</span>&nbsp;<span class="ident" id="4859591">redirectHandler</span>&nbsp;<span class="keyword" id="4859607">struct</span>&nbsp;<span class="op" id="4859614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859617">url</span>&nbsp;&nbsp;<span class="builtintype" id="4859622">string</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859630">code</span>&nbsp;<span class="builtintype" id="4859635">int</span><br>
<span class="lineno"></span><span class="op" id="4859639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4859642">func</span>&nbsp;<span class="op" id="4859647">(</span><span class="ident" id="4859648">rh</span>&nbsp;<span class="op" id="4859651">*</span><span class="ident" id="4859652">redirectHandler</span><span class="op" id="4859667">)</span>&nbsp;<span class="ident" id="4859669">ServeHTTP</span><span class="op" id="4859678">(</span><span class="ident" id="4859679">w</span>&nbsp;<span class="ident" id="4859681">ResponseWriter</span><span class="op" id="4859695">,</span>&nbsp;<span class="ident" id="4859697">r</span>&nbsp;<span class="op" id="4859699">*</span><span class="ident" id="4859700">Request</span><span class="op" id="4859707">)</span>&nbsp;<span class="op" id="4859709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4859712">Redirect</span><span class="op" id="4859720">(</span><span class="ident" id="4859721">w</span><span class="op" id="4859722">,</span>&nbsp;<span class="ident" id="4859724">r</span><span class="op" id="4859725">,</span>&nbsp;<span class="ident" id="4859727">rh</span><span class="op" id="4859729">.</span><span class="ident" id="4859730">url</span><span class="op" id="4859733">,</span>&nbsp;<span class="ident" id="4859735">rh</span><span class="op" id="4859737">.</span><span class="ident" id="4859738">code</span><span class="op" id="4859742">)</span><br>
<span class="lineno">1385</span><span class="op" id="4859744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4859747">//&nbsp;RedirectHandler&nbsp;returns&nbsp;a&nbsp;request&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno"></span><span class="comment" id="4859807">//&nbsp;each&nbsp;request&nbsp;it&nbsp;receives&nbsp;to&nbsp;the&nbsp;given&nbsp;url&nbsp;using&nbsp;the&nbsp;given</span><br>
<span class="lineno"></span><span class="comment" id="4859868">//&nbsp;status&nbsp;code.</span><br>
<span class="lineno">1390</span><span class="keyword" id="4859884">func</span>&nbsp;<span class="ident" id="4859889">RedirectHandler</span><span class="op" id="4859904">(</span><span class="ident" id="4859905">url</span>&nbsp;<span class="builtintype" id="4859909">string</span><span class="op" id="4859915">,</span>&nbsp;<span class="ident" id="4859917">code</span>&nbsp;<span class="builtintype" id="4859922">int</span><span class="op" id="4859925">)</span>&nbsp;<span class="ident" id="4859927">Handler</span>&nbsp;<span class="op" id="4859935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4859938">return</span>&nbsp;<span class="op" id="4859945">&amp;</span><span class="ident" id="4859946">redirectHandler</span><span class="op" id="4859961">{</span><span class="ident" id="4859962">url</span><span class="op" id="4859965">,</span>&nbsp;<span class="ident" id="4859967">code</span><span class="op" id="4859971">}</span><br>
<span class="lineno"></span><span class="op" id="4859973">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4859976">//&nbsp;ServeMux&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;request&nbsp;multiplexer.</span><br>
<span class="lineno">1395</span><span class="comment" id="4860020">//&nbsp;It&nbsp;matches&nbsp;the&nbsp;URL&nbsp;of&nbsp;each&nbsp;incoming&nbsp;request&nbsp;against&nbsp;a&nbsp;list&nbsp;of&nbsp;registered</span><br>
<span class="lineno"></span><span class="comment" id="4860096">//&nbsp;patterns&nbsp;and&nbsp;calls&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;pattern&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4860151">//&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;URL.</span><br>
<span class="lineno"></span><span class="comment" id="4860184">//</span><br>
<span class="lineno"></span><span class="comment" id="4860187">//&nbsp;Patterns&nbsp;name&nbsp;fixed,&nbsp;rooted&nbsp;paths,&nbsp;like&nbsp;&#34;/favicon.ico&#34;,</span><br>
<span class="lineno">1400</span><span class="comment" id="4860246">//&nbsp;or&nbsp;rooted&nbsp;subtrees,&nbsp;like&nbsp;&#34;/images/&#34;&nbsp;(note&nbsp;the&nbsp;trailing&nbsp;slash).</span><br>
<span class="lineno"></span><span class="comment" id="4860312">//&nbsp;Longer&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over&nbsp;shorter&nbsp;ones,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4860374">//&nbsp;if&nbsp;there&nbsp;are&nbsp;handlers&nbsp;registered&nbsp;for&nbsp;both&nbsp;&#34;/images/&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4860430">//&nbsp;and&nbsp;&#34;/images/thumbnails/&#34;,&nbsp;the&nbsp;latter&nbsp;handler&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="4860487">//&nbsp;called&nbsp;for&nbsp;paths&nbsp;beginning&nbsp;&#34;/images/thumbnails/&#34;&nbsp;and&nbsp;the</span><br>
<span class="lineno">1405</span><span class="comment" id="4860547">//&nbsp;former&nbsp;will&nbsp;receive&nbsp;requests&nbsp;for&nbsp;any&nbsp;other&nbsp;paths&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4860606">//&nbsp;&#34;/images/&#34;&nbsp;subtree.</span><br>
<span class="lineno"></span><span class="comment" id="4860629">//</span><br>
<span class="lineno"></span><span class="comment" id="4860632">//&nbsp;Note&nbsp;that&nbsp;since&nbsp;a&nbsp;pattern&nbsp;ending&nbsp;in&nbsp;a&nbsp;slash&nbsp;names&nbsp;a&nbsp;rooted&nbsp;subtree,</span><br>
<span class="lineno"></span><span class="comment" id="4860703">//&nbsp;the&nbsp;pattern&nbsp;&#34;/&#34;&nbsp;matches&nbsp;all&nbsp;paths&nbsp;not&nbsp;matched&nbsp;by&nbsp;other&nbsp;registered</span><br>
<span class="lineno">1410</span><span class="comment" id="4860772">//&nbsp;patterns,&nbsp;not&nbsp;just&nbsp;the&nbsp;URL&nbsp;with&nbsp;Path&nbsp;==&nbsp;&#34;/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="4860820">//</span><br>
<span class="lineno"></span><span class="comment" id="4860823">//&nbsp;Patterns&nbsp;may&nbsp;optionally&nbsp;begin&nbsp;with&nbsp;a&nbsp;host&nbsp;name,&nbsp;restricting&nbsp;matches&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4860897">//&nbsp;URLs&nbsp;on&nbsp;that&nbsp;host&nbsp;only.&nbsp;&nbsp;Host-specific&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="4860969">//&nbsp;general&nbsp;patterns,&nbsp;so&nbsp;that&nbsp;a&nbsp;handler&nbsp;might&nbsp;register&nbsp;for&nbsp;the&nbsp;two&nbsp;patterns</span><br>
<span class="lineno">1415</span><span class="comment" id="4861044">//&nbsp;&#34;/codesearch&#34;&nbsp;and&nbsp;&#34;codesearch.google.com/&#34;&nbsp;without&nbsp;also&nbsp;taking&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="4861115">//&nbsp;requests&nbsp;for&nbsp;&#34;http://www.google.com/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="4861157">//</span><br>
<span class="lineno"></span><span class="comment" id="4861160">//&nbsp;ServeMux&nbsp;also&nbsp;takes&nbsp;care&nbsp;of&nbsp;sanitizing&nbsp;the&nbsp;URL&nbsp;request&nbsp;path,</span><br>
<span class="lineno"></span><span class="comment" id="4861224">//&nbsp;redirecting&nbsp;any&nbsp;request&nbsp;containing&nbsp;.&nbsp;or&nbsp;..&nbsp;elements&nbsp;to&nbsp;an</span><br>
<span class="lineno">1420</span><span class="comment" id="4861285">//&nbsp;equivalent&nbsp;.-&nbsp;and&nbsp;..-free&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="4861319">type</span>&nbsp;<span class="ident" id="4861324">ServeMux</span>&nbsp;<span class="keyword" id="4861333">struct</span>&nbsp;<span class="op" id="4861340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861343">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4861349">sync</span><span class="op" id="4861353">.</span><span class="ident" id="4861354">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861363">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4861369">map</span><span class="op" id="4861372">[</span><span class="builtintype" id="4861373">string</span><span class="op" id="4861379">]</span><span class="ident" id="4861380">muxEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861390">hosts</span>&nbsp;<span class="builtintype" id="4861396">bool</span>&nbsp;<span class="comment" id="4861401">//&nbsp;whether&nbsp;any&nbsp;patterns&nbsp;contain&nbsp;hostnames</span><br>
<span class="lineno">1425</span><span class="op" id="4861443">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4861446">type</span>&nbsp;<span class="ident" id="4861451">muxEntry</span>&nbsp;<span class="keyword" id="4861460">struct</span>&nbsp;<span class="op" id="4861467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861470">explicit</span>&nbsp;<span class="builtintype" id="4861479">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861485">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4861494">Handler</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861503">pattern</span>&nbsp;&nbsp;<span class="builtintype" id="4861512">string</span><br>
<span class="lineno"></span><span class="op" id="4861519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4861522">//&nbsp;NewServeMux&nbsp;allocates&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="4861575">func</span>&nbsp;<span class="ident" id="4861580">NewServeMux</span><span class="op" id="4861591">(</span><span class="op" id="4861592">)</span>&nbsp;<span class="op" id="4861594">*</span><span class="ident" id="4861595">ServeMux</span>&nbsp;<span class="op" id="4861604">{</span>&nbsp;<span class="keyword" id="4861606">return</span>&nbsp;<span class="op" id="4861613">&amp;</span><span class="ident" id="4861614">ServeMux</span><span class="op" id="4861622">{</span><span class="ident" id="4861623">m</span><span class="op" id="4861624">:</span>&nbsp;<span class="builtinfunc" id="4861626">make</span><span class="op" id="4861630">(</span><span class="keyword" id="4861631">map</span><span class="op" id="4861634">[</span><span class="builtintype" id="4861635">string</span><span class="op" id="4861641">]</span><span class="ident" id="4861642">muxEntry</span><span class="op" id="4861650">)</span><span class="op" id="4861651">}</span>&nbsp;<span class="op" id="4861653">}</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span><span class="comment" id="4861656">//&nbsp;DefaultServeMux&nbsp;is&nbsp;the&nbsp;default&nbsp;ServeMux&nbsp;used&nbsp;by&nbsp;Serve.</span><br>
<span class="lineno"></span><span class="keyword" id="4861714">var</span>&nbsp;<span class="ident" id="4861718">DefaultServeMux</span>&nbsp;<span class="op" id="4861734">=</span>&nbsp;<span class="ident" id="4861736">NewServeMux</span><span class="op" id="4861747">(</span><span class="op" id="4861748">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4861751">//&nbsp;Does&nbsp;path&nbsp;match&nbsp;pattern?</span><br>
<span class="lineno">1440</span><span class="keyword" id="4861779">func</span>&nbsp;<span class="ident" id="4861784">pathMatch</span><span class="op" id="4861793">(</span><span class="ident" id="4861794">pattern</span><span class="op" id="4861801">,</span>&nbsp;<span class="ident" id="4861803">path</span>&nbsp;<span class="builtintype" id="4861808">string</span><span class="op" id="4861814">)</span>&nbsp;<span class="builtintype" id="4861816">bool</span>&nbsp;<span class="op" id="4861821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861824">if</span>&nbsp;<span class="builtinfunc" id="4861827">len</span><span class="op" id="4861830">(</span><span class="ident" id="4861831">pattern</span><span class="op" id="4861838">)</span>&nbsp;<span class="op" id="4861840">==</span>&nbsp;<span class="num" id="4861843">0</span>&nbsp;<span class="op" id="4861845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4861849">//&nbsp;should&nbsp;not&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861872">return</span>&nbsp;<span class="builtintype" id="4861879">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4861886">}</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4861889">n</span>&nbsp;<span class="op" id="4861891">:=</span>&nbsp;<span class="builtinfunc" id="4861894">len</span><span class="op" id="4861897">(</span><span class="ident" id="4861898">pattern</span><span class="op" id="4861905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861908">if</span>&nbsp;<span class="ident" id="4861911">pattern</span><span class="op" id="4861918">[</span><span class="ident" id="4861919">n</span><span class="op" id="4861920">-</span><span class="num" id="4861921">1</span><span class="op" id="4861922">]</span>&nbsp;<span class="op" id="4861924">!=</span>&nbsp;<span class="string" id="4861927">&#39;/&#39;</span>&nbsp;<span class="op" id="4861931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861935">return</span>&nbsp;<span class="ident" id="4861942">pattern</span>&nbsp;<span class="op" id="4861950">==</span>&nbsp;<span class="ident" id="4861953">path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4861959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4861962">return</span>&nbsp;<span class="builtinfunc" id="4861969">len</span><span class="op" id="4861972">(</span><span class="ident" id="4861973">path</span><span class="op" id="4861977">)</span>&nbsp;<span class="op" id="4861979">&gt;=</span>&nbsp;<span class="ident" id="4861982">n</span>&nbsp;<span class="op" id="4861984">&amp;&amp;</span>&nbsp;<span class="ident" id="4861987">path</span><span class="op" id="4861991">[</span><span class="num" id="4861992">0</span><span class="op" id="4861993">:</span><span class="ident" id="4861994">n</span><span class="op" id="4861995">]</span>&nbsp;<span class="op" id="4861997">==</span>&nbsp;<span class="ident" id="4862000">pattern</span><br>
<span class="lineno">1450</span><span class="op" id="4862008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4862011">//&nbsp;Return&nbsp;the&nbsp;canonical&nbsp;path&nbsp;for&nbsp;p,&nbsp;eliminating&nbsp;.&nbsp;and&nbsp;..&nbsp;elements.</span><br>
<span class="lineno"></span><span class="keyword" id="4862078">func</span>&nbsp;<span class="ident" id="4862083">cleanPath</span><span class="op" id="4862092">(</span><span class="ident" id="4862093">p</span>&nbsp;<span class="builtintype" id="4862095">string</span><span class="op" id="4862101">)</span>&nbsp;<span class="builtintype" id="4862103">string</span>&nbsp;<span class="op" id="4862110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4862113">if</span>&nbsp;<span class="ident" id="4862116">p</span>&nbsp;<span class="op" id="4862118">==</span>&nbsp;<span class="string" id="4862121">&#34;&#34;</span>&nbsp;<span class="op" id="4862124">{</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4862128">return</span>&nbsp;<span class="string" id="4862135">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4862140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4862143">if</span>&nbsp;<span class="ident" id="4862146">p</span><span class="op" id="4862147">[</span><span class="num" id="4862148">0</span><span class="op" id="4862149">]</span>&nbsp;<span class="op" id="4862151">!=</span>&nbsp;<span class="string" id="4862154">&#39;/&#39;</span>&nbsp;<span class="op" id="4862158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4862162">p</span>&nbsp;<span class="op" id="4862164">=</span>&nbsp;<span class="string" id="4862166">&#34;/&#34;</span>&nbsp;<span class="op" id="4862170">+</span>&nbsp;<span class="ident" id="4862172">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4862175">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4862178">np</span>&nbsp;<span class="op" id="4862181">:=</span>&nbsp;<span class="ident" id="4862184">path</span><span class="op" id="4862188">.</span><span class="ident" id="4862189">Clean</span><span class="op" id="4862194">(</span><span class="ident" id="4862195">p</span><span class="op" id="4862196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4862199">//&nbsp;path.Clean&nbsp;removes&nbsp;trailing&nbsp;slash&nbsp;except&nbsp;for&nbsp;root;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4862254">//&nbsp;put&nbsp;the&nbsp;trailing&nbsp;slash&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4862300">if</span>&nbsp;<span class="ident" id="4862303">p</span><span class="op" id="4862304">[</span><span class="builtinfunc" id="4862305">len</span><span class="op" id="4862308">(</span><span class="ident" id="4862309">p</span><span class="op" id="4862310">)</span><span class="op" id="4862311">-</span><span class="num" id="4862312">1</span><span class="op" id="4862313">]</span>&nbsp;<span class="op" id="4862315">==</span>&nbsp;<span class="string" id="4862318">&#39;/&#39;</span>&nbsp;<span class="op" id="4862322">&amp;&amp;</span>&nbsp;<span class="ident" id="4862325">np</span>&nbsp;<span class="op" id="4862328">!=</span>&nbsp;<span class="string" id="4862331">&#34;/&#34;</span>&nbsp;<span class="op" id="4862335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4862339">np</span>&nbsp;<span class="op" id="4862342">+=</span>&nbsp;<span class="string" id="4862345">&#34;/&#34;</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4862350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4862353">return</span>&nbsp;<span class="ident" id="4862360">np</span><br>
<span class="lineno"></span><span class="op" id="4862363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4862366">//&nbsp;Find&nbsp;a&nbsp;handler&nbsp;on&nbsp;a&nbsp;handler&nbsp;map&nbsp;given&nbsp;a&nbsp;path&nbsp;string</span><br>
<span class="lineno">1470</span><span class="comment" id="4862421">//&nbsp;Most-specific&nbsp;(longest)&nbsp;pattern&nbsp;wins</span><br>
<span class="lineno"></span><span class="keyword" id="4862461">func</span>&nbsp;<span class="op" id="4862466">(</span><span class="ident" id="4862467">mux</span>&nbsp;<span class="op" id="4862471">*</span><span class="ident" id="4862472">ServeMux</span><span class="op" id="4862480">)</span>&nbsp;<span class="ident" id="4862482">match</span><span class="op" id="4862487">(</span><span class="ident" id="4862488">path</span>&nbsp;<span class="builtintype" id="4862493">string</span><span class="op" id="4862499">)</span>&nbsp;<span class="op" id="4862501">(</span><span class="ident" id="4862502">h</span>&nbsp;<span class="ident" id="4862504">Handler</span><span class="op" id="4862511">,</span>&nbsp;<span class="ident" id="4862513">pattern</span>&nbsp;<span class="builtintype" id="4862521">string</span><span class="op" id="4862527">)</span>&nbsp;<span class="op" id="4862529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4862532">var</span>&nbsp;<span class="ident" id="4862536">n</span>&nbsp;<span class="op" id="4862538">=</span>&nbsp;<span class="num" id="4862540">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4862543">for</span>&nbsp;<span class="ident" id="4862547">k</span><span class="op" id="4862548">,</span>&nbsp;<span class="ident" id="4862550">v</span>&nbsp;<span class="op" id="4862552">:=</span>&nbsp;<span class="keyword" id="4862555">range</span>&nbsp;<span class="ident" id="4862561">mux</span><span class="op" id="4862564">.</span><span class="ident" id="4862565">m</span>&nbsp;<span class="op" id="4862567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4862571">if</span>&nbsp;<span class="op" id="4862574">!</span><span class="ident" id="4862575">pathMatch</span><span class="op" id="4862584">(</span><span class="ident" id="4862585">k</span><span class="op" id="4862586">,</span>&nbsp;<span class="ident" id="4862588">path</span><span class="op" id="4862592">)</span>&nbsp;<span class="op" id="4862594">{</span><br>
<span class="lineno">1475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4862599">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4862610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4862614">if</span>&nbsp;<span class="ident" id="4862617">h</span>&nbsp;<span class="op" id="4862619">==</span>&nbsp;<span class="ident" id="4862622">nil</span>&nbsp;<span class="op" id="4862626">||</span>&nbsp;<span class="builtinfunc" id="4862629">len</span><span class="op" id="4862632">(</span><span class="ident" id="4862633">k</span><span class="op" id="4862634">)</span>&nbsp;<span class="op" id="4862636">&gt;</span>&nbsp;<span class="ident" id="4862638">n</span>&nbsp;<span class="op" id="4862640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4862645">n</span>&nbsp;<span class="op" id="4862647">=</span>&nbsp;<span class="builtinfunc" id="4862649">len</span><span class="op" id="4862652">(</span><span class="ident" id="4862653">k</span><span class="op" id="4862654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4862659">h</span>&nbsp;<span class="op" id="4862661">=</span>&nbsp;<span class="ident" id="4862663">v</span><span class="op" id="4862664">.</span><span class="ident" id="4862665">h</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4862670">pattern</span>&nbsp;<span class="op" id="4862678">=</span>&nbsp;<span class="ident" id="4862680">v</span><span class="op" id="4862681">.</span><span class="ident" id="4862682">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4862692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4862695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4862698">return</span><br>
<span class="lineno"></span><span class="op" id="4862705">}</span><br>
<span class="lineno">1485</span><br>
<span class="lineno"></span><span class="comment" id="4862708">//&nbsp;Handler&nbsp;returns&nbsp;the&nbsp;handler&nbsp;to&nbsp;use&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="4862769">//&nbsp;consulting&nbsp;r.Method,&nbsp;r.Host,&nbsp;and&nbsp;r.URL.Path.&nbsp;It&nbsp;always&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="4862835">//&nbsp;a&nbsp;non-nil&nbsp;handler.&nbsp;If&nbsp;the&nbsp;path&nbsp;is&nbsp;not&nbsp;in&nbsp;its&nbsp;canonical&nbsp;form,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4862903">//&nbsp;handler&nbsp;will&nbsp;be&nbsp;an&nbsp;internally-generated&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno">1490</span><span class="comment" id="4862969">//&nbsp;to&nbsp;the&nbsp;canonical&nbsp;path.</span><br>
<span class="lineno"></span><span class="comment" id="4862995">//</span><br>
<span class="lineno"></span><span class="comment" id="4862998">//&nbsp;Handler&nbsp;also&nbsp;returns&nbsp;the&nbsp;registered&nbsp;pattern&nbsp;that&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4863062">//&nbsp;request&nbsp;or,&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;internally-generated&nbsp;redirects,</span><br>
<span class="lineno"></span><span class="comment" id="4863124">//&nbsp;the&nbsp;pattern&nbsp;that&nbsp;will&nbsp;match&nbsp;after&nbsp;following&nbsp;the&nbsp;redirect.</span><br>
<span class="lineno">1495</span><span class="comment" id="4863185">//</span><br>
<span class="lineno"></span><span class="comment" id="4863188">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;registered&nbsp;handler&nbsp;that&nbsp;applies&nbsp;to&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="4863254">//&nbsp;Handler&nbsp;returns&nbsp;a&nbsp;``page&nbsp;not&nbsp;found&#39;&#39;&nbsp;handler&nbsp;and&nbsp;an&nbsp;empty&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="4863324">func</span>&nbsp;<span class="op" id="4863329">(</span><span class="ident" id="4863330">mux</span>&nbsp;<span class="op" id="4863334">*</span><span class="ident" id="4863335">ServeMux</span><span class="op" id="4863343">)</span>&nbsp;<span class="ident" id="4863345">Handler</span><span class="op" id="4863352">(</span><span class="ident" id="4863353">r</span>&nbsp;<span class="op" id="4863355">*</span><span class="ident" id="4863356">Request</span><span class="op" id="4863363">)</span>&nbsp;<span class="op" id="4863365">(</span><span class="ident" id="4863366">h</span>&nbsp;<span class="ident" id="4863368">Handler</span><span class="op" id="4863375">,</span>&nbsp;<span class="ident" id="4863377">pattern</span>&nbsp;<span class="builtintype" id="4863385">string</span><span class="op" id="4863391">)</span>&nbsp;<span class="op" id="4863393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4863396">if</span>&nbsp;<span class="ident" id="4863399">r</span><span class="op" id="4863400">.</span><span class="ident" id="4863401">Method</span>&nbsp;<span class="op" id="4863408">!=</span>&nbsp;<span class="string" id="4863411">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="4863421">{</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4863425">if</span>&nbsp;<span class="ident" id="4863428">p</span>&nbsp;<span class="op" id="4863430">:=</span>&nbsp;<span class="ident" id="4863433">cleanPath</span><span class="op" id="4863442">(</span><span class="ident" id="4863443">r</span><span class="op" id="4863444">.</span><span class="ident" id="4863445">URL</span><span class="op" id="4863448">.</span><span class="ident" id="4863449">Path</span><span class="op" id="4863453">)</span><span class="op" id="4863454">;</span>&nbsp;<span class="ident" id="4863456">p</span>&nbsp;<span class="op" id="4863458">!=</span>&nbsp;<span class="ident" id="4863461">r</span><span class="op" id="4863462">.</span><span class="ident" id="4863463">URL</span><span class="op" id="4863466">.</span><span class="ident" id="4863467">Path</span>&nbsp;<span class="op" id="4863472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4863477">_</span><span class="op" id="4863478">,</span>&nbsp;<span class="ident" id="4863480">pattern</span>&nbsp;<span class="op" id="4863488">=</span>&nbsp;<span class="ident" id="4863490">mux</span><span class="op" id="4863493">.</span><span class="ident" id="4863494">handler</span><span class="op" id="4863501">(</span><span class="ident" id="4863502">r</span><span class="op" id="4863503">.</span><span class="ident" id="4863504">Host</span><span class="op" id="4863508">,</span>&nbsp;<span class="ident" id="4863510">p</span><span class="op" id="4863511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4863516">url</span>&nbsp;<span class="op" id="4863520">:=</span>&nbsp;<span class="op" id="4863523">*</span><span class="ident" id="4863524">r</span><span class="op" id="4863525">.</span><span class="ident" id="4863526">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4863533">url</span><span class="op" id="4863536">.</span><span class="ident" id="4863537">Path</span>&nbsp;<span class="op" id="4863542">=</span>&nbsp;<span class="ident" id="4863544">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4863549">return</span>&nbsp;<span class="ident" id="4863556">RedirectHandler</span><span class="op" id="4863571">(</span><span class="ident" id="4863572">url</span><span class="op" id="4863575">.</span><span class="ident" id="4863576">String</span><span class="op" id="4863582">(</span><span class="op" id="4863583">)</span><span class="op" id="4863584">,</span>&nbsp;<span class="ident" id="4863586">StatusMovedPermanently</span><span class="op" id="4863608">)</span><span class="op" id="4863609">,</span>&nbsp;<span class="ident" id="4863611">pattern</span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4863621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4863624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4863628">return</span>&nbsp;<span class="ident" id="4863635">mux</span><span class="op" id="4863638">.</span><span class="ident" id="4863639">handler</span><span class="op" id="4863646">(</span><span class="ident" id="4863647">r</span><span class="op" id="4863648">.</span><span class="ident" id="4863649">Host</span><span class="op" id="4863653">,</span>&nbsp;<span class="ident" id="4863655">r</span><span class="op" id="4863656">.</span><span class="ident" id="4863657">URL</span><span class="op" id="4863660">.</span><span class="ident" id="4863661">Path</span><span class="op" id="4863665">)</span><br>
<span class="lineno"></span><span class="op" id="4863667">}</span><br>
<span class="lineno">1510</span><br>
<span class="lineno"></span><span class="comment" id="4863670">//&nbsp;handler&nbsp;is&nbsp;the&nbsp;main&nbsp;implementation&nbsp;of&nbsp;Handler.</span><br>
<span class="lineno"></span><span class="comment" id="4863720">//&nbsp;The&nbsp;path&nbsp;is&nbsp;known&nbsp;to&nbsp;be&nbsp;in&nbsp;canonical&nbsp;form,&nbsp;except&nbsp;for&nbsp;CONNECT&nbsp;methods.</span><br>
<span class="lineno"></span><span class="keyword" id="4863794">func</span>&nbsp;<span class="op" id="4863799">(</span><span class="ident" id="4863800">mux</span>&nbsp;<span class="op" id="4863804">*</span><span class="ident" id="4863805">ServeMux</span><span class="op" id="4863813">)</span>&nbsp;<span class="ident" id="4863815">handler</span><span class="op" id="4863822">(</span><span class="ident" id="4863823">host</span><span class="op" id="4863827">,</span>&nbsp;<span class="ident" id="4863829">path</span>&nbsp;<span class="builtintype" id="4863834">string</span><span class="op" id="4863840">)</span>&nbsp;<span class="op" id="4863842">(</span><span class="ident" id="4863843">h</span>&nbsp;<span class="ident" id="4863845">Handler</span><span class="op" id="4863852">,</span>&nbsp;<span class="ident" id="4863854">pattern</span>&nbsp;<span class="builtintype" id="4863862">string</span><span class="op" id="4863868">)</span>&nbsp;<span class="op" id="4863870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4863873">mux</span><span class="op" id="4863876">.</span><span class="ident" id="4863877">mu</span><span class="op" id="4863879">.</span><span class="ident" id="4863880">RLock</span><span class="op" id="4863885">(</span><span class="op" id="4863886">)</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4863889">defer</span>&nbsp;<span class="ident" id="4863895">mux</span><span class="op" id="4863898">.</span><span class="ident" id="4863899">mu</span><span class="op" id="4863901">.</span><span class="ident" id="4863902">RUnlock</span><span class="op" id="4863909">(</span><span class="op" id="4863910">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4863914">//&nbsp;Host-specific&nbsp;pattern&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;generic&nbsp;ones</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4863975">if</span>&nbsp;<span class="ident" id="4863978">mux</span><span class="op" id="4863981">.</span><span class="ident" id="4863982">hosts</span>&nbsp;<span class="op" id="4863988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4863992">h</span><span class="op" id="4863993">,</span>&nbsp;<span class="ident" id="4863995">pattern</span>&nbsp;<span class="op" id="4864003">=</span>&nbsp;<span class="ident" id="4864005">mux</span><span class="op" id="4864008">.</span><span class="ident" id="4864009">match</span><span class="op" id="4864014">(</span><span class="ident" id="4864015">host</span>&nbsp;<span class="op" id="4864020">+</span>&nbsp;<span class="ident" id="4864022">path</span><span class="op" id="4864026">)</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4864029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864032">if</span>&nbsp;<span class="ident" id="4864035">h</span>&nbsp;<span class="op" id="4864037">==</span>&nbsp;<span class="ident" id="4864040">nil</span>&nbsp;<span class="op" id="4864044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4864048">h</span><span class="op" id="4864049">,</span>&nbsp;<span class="ident" id="4864051">pattern</span>&nbsp;<span class="op" id="4864059">=</span>&nbsp;<span class="ident" id="4864061">mux</span><span class="op" id="4864064">.</span><span class="ident" id="4864065">match</span><span class="op" id="4864070">(</span><span class="ident" id="4864071">path</span><span class="op" id="4864075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4864078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864081">if</span>&nbsp;<span class="ident" id="4864084">h</span>&nbsp;<span class="op" id="4864086">==</span>&nbsp;<span class="ident" id="4864089">nil</span>&nbsp;<span class="op" id="4864093">{</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4864097">h</span><span class="op" id="4864098">,</span>&nbsp;<span class="ident" id="4864100">pattern</span>&nbsp;<span class="op" id="4864108">=</span>&nbsp;<span class="ident" id="4864110">NotFoundHandler</span><span class="op" id="4864125">(</span><span class="op" id="4864126">)</span><span class="op" id="4864127">,</span>&nbsp;<span class="string" id="4864129">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4864133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864136">return</span><br>
<span class="lineno"></span><span class="op" id="4864143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1530</span><span class="comment" id="4864146">//&nbsp;ServeHTTP&nbsp;dispatches&nbsp;the&nbsp;request&nbsp;to&nbsp;the&nbsp;handler&nbsp;whose</span><br>
<span class="lineno"></span><span class="comment" id="4864203">//&nbsp;pattern&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;request&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="4864252">func</span>&nbsp;<span class="op" id="4864257">(</span><span class="ident" id="4864258">mux</span>&nbsp;<span class="op" id="4864262">*</span><span class="ident" id="4864263">ServeMux</span><span class="op" id="4864271">)</span>&nbsp;<span class="ident" id="4864273">ServeHTTP</span><span class="op" id="4864282">(</span><span class="ident" id="4864283">w</span>&nbsp;<span class="ident" id="4864285">ResponseWriter</span><span class="op" id="4864299">,</span>&nbsp;<span class="ident" id="4864301">r</span>&nbsp;<span class="op" id="4864303">*</span><span class="ident" id="4864304">Request</span><span class="op" id="4864311">)</span>&nbsp;<span class="op" id="4864313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864316">if</span>&nbsp;<span class="ident" id="4864319">r</span><span class="op" id="4864320">.</span><span class="ident" id="4864321">RequestURI</span>&nbsp;<span class="op" id="4864332">==</span>&nbsp;<span class="string" id="4864335">&#34;*&#34;</span>&nbsp;<span class="op" id="4864339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864343">if</span>&nbsp;<span class="ident" id="4864346">r</span><span class="op" id="4864347">.</span><span class="ident" id="4864348">ProtoAtLeast</span><span class="op" id="4864360">(</span><span class="num" id="4864361">1</span><span class="op" id="4864362">,</span>&nbsp;<span class="num" id="4864364">1</span><span class="op" id="4864365">)</span>&nbsp;<span class="op" id="4864367">{</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4864372">w</span><span class="op" id="4864373">.</span><span class="ident" id="4864374">Header</span><span class="op" id="4864380">(</span><span class="op" id="4864381">)</span><span class="op" id="4864382">.</span><span class="ident" id="4864383">Set</span><span class="op" id="4864386">(</span><span class="string" id="4864387">&#34;Connection&#34;</span><span class="op" id="4864399">,</span>&nbsp;<span class="string" id="4864401">&#34;close&#34;</span><span class="op" id="4864408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4864412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4864416">w</span><span class="op" id="4864417">.</span><span class="ident" id="4864418">WriteHeader</span><span class="op" id="4864429">(</span><span class="ident" id="4864430">StatusBadRequest</span><span class="op" id="4864446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864450">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4864458">}</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4864461">h</span><span class="op" id="4864462">,</span>&nbsp;<span class="ident" id="4864464">_</span>&nbsp;<span class="op" id="4864466">:=</span>&nbsp;<span class="ident" id="4864469">mux</span><span class="op" id="4864472">.</span><span class="ident" id="4864473">Handler</span><span class="op" id="4864480">(</span><span class="ident" id="4864481">r</span><span class="op" id="4864482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4864485">h</span><span class="op" id="4864486">.</span><span class="ident" id="4864487">ServeHTTP</span><span class="op" id="4864496">(</span><span class="ident" id="4864497">w</span><span class="op" id="4864498">,</span>&nbsp;<span class="ident" id="4864500">r</span><span class="op" id="4864501">)</span><br>
<span class="lineno"></span><span class="op" id="4864503">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4864506">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno">1545</span><span class="comment" id="4864561">//&nbsp;If&nbsp;a&nbsp;handler&nbsp;already&nbsp;exists&nbsp;for&nbsp;pattern,&nbsp;Handle&nbsp;panics.</span><br>
<span class="lineno"></span><span class="keyword" id="4864620">func</span>&nbsp;<span class="op" id="4864625">(</span><span class="ident" id="4864626">mux</span>&nbsp;<span class="op" id="4864630">*</span><span class="ident" id="4864631">ServeMux</span><span class="op" id="4864639">)</span>&nbsp;<span class="ident" id="4864641">Handle</span><span class="op" id="4864647">(</span><span class="ident" id="4864648">pattern</span>&nbsp;<span class="builtintype" id="4864656">string</span><span class="op" id="4864662">,</span>&nbsp;<span class="ident" id="4864664">handler</span>&nbsp;<span class="ident" id="4864672">Handler</span><span class="op" id="4864679">)</span>&nbsp;<span class="op" id="4864681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4864684">mux</span><span class="op" id="4864687">.</span><span class="ident" id="4864688">mu</span><span class="op" id="4864690">.</span><span class="ident" id="4864691">Lock</span><span class="op" id="4864695">(</span><span class="op" id="4864696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864699">defer</span>&nbsp;<span class="ident" id="4864705">mux</span><span class="op" id="4864708">.</span><span class="ident" id="4864709">mu</span><span class="op" id="4864711">.</span><span class="ident" id="4864712">Unlock</span><span class="op" id="4864718">(</span><span class="op" id="4864719">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864723">if</span>&nbsp;<span class="ident" id="4864726">pattern</span>&nbsp;<span class="op" id="4864734">==</span>&nbsp;<span class="string" id="4864737">&#34;&#34;</span>&nbsp;<span class="op" id="4864740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4864744">panic</span><span class="op" id="4864749">(</span><span class="string" id="4864750">&#34;http:&nbsp;invalid&nbsp;pattern&nbsp;&#34;</span>&nbsp;<span class="op" id="4864775">+</span>&nbsp;<span class="ident" id="4864777">pattern</span><span class="op" id="4864784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4864787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864790">if</span>&nbsp;<span class="ident" id="4864793">handler</span>&nbsp;<span class="op" id="4864801">==</span>&nbsp;<span class="ident" id="4864804">nil</span>&nbsp;<span class="op" id="4864808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4864812">panic</span><span class="op" id="4864817">(</span><span class="string" id="4864818">&#34;http:&nbsp;nil&nbsp;handler&#34;</span><span class="op" id="4864837">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4864840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4864843">if</span>&nbsp;<span class="ident" id="4864846">mux</span><span class="op" id="4864849">.</span><span class="ident" id="4864850">m</span><span class="op" id="4864851">[</span><span class="ident" id="4864852">pattern</span><span class="op" id="4864859">]</span><span class="op" id="4864860">.</span><span class="ident" id="4864861">explicit</span>&nbsp;<span class="op" id="4864870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4864874">panic</span><span class="op" id="4864879">(</span><span class="string" id="4864880">&#34;http:&nbsp;multiple&nbsp;registrations&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="4864916">+</span>&nbsp;<span class="ident" id="4864918">pattern</span><span class="op" id="4864925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4864928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4864932">mux</span><span class="op" id="4864935">.</span><span class="ident" id="4864936">m</span><span class="op" id="4864937">[</span><span class="ident" id="4864938">pattern</span><span class="op" id="4864945">]</span>&nbsp;<span class="op" id="4864947">=</span>&nbsp;<span class="ident" id="4864949">muxEntry</span><span class="op" id="4864957">{</span><span class="ident" id="4864958">explicit</span><span class="op" id="4864966">:</span>&nbsp;<span class="builtintype" id="4864968">true</span><span class="op" id="4864972">,</span>&nbsp;<span class="ident" id="4864974">h</span><span class="op" id="4864975">:</span>&nbsp;<span class="ident" id="4864977">handler</span><span class="op" id="4864984">,</span>&nbsp;<span class="ident" id="4864986">pattern</span><span class="op" id="4864993">:</span>&nbsp;<span class="ident" id="4864995">pattern</span><span class="op" id="4865002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4865006">if</span>&nbsp;<span class="ident" id="4865009">pattern</span><span class="op" id="4865016">[</span><span class="num" id="4865017">0</span><span class="op" id="4865018">]</span>&nbsp;<span class="op" id="4865020">!=</span>&nbsp;<span class="string" id="4865023">&#39;/&#39;</span>&nbsp;<span class="op" id="4865027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4865031">mux</span><span class="op" id="4865034">.</span><span class="ident" id="4865035">hosts</span>&nbsp;<span class="op" id="4865041">=</span>&nbsp;<span class="builtintype" id="4865043">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4865049">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4865053">//&nbsp;Helpful&nbsp;behavior:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4865075">//&nbsp;If&nbsp;pattern&nbsp;is&nbsp;/tree/,&nbsp;insert&nbsp;an&nbsp;implicit&nbsp;permanent&nbsp;redirect&nbsp;for&nbsp;/tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4865150">//&nbsp;It&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;an&nbsp;explicit&nbsp;registration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4865204">n</span>&nbsp;<span class="op" id="4865206">:=</span>&nbsp;<span class="builtinfunc" id="4865209">len</span><span class="op" id="4865212">(</span><span class="ident" id="4865213">pattern</span><span class="op" id="4865220">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4865223">if</span>&nbsp;<span class="ident" id="4865226">n</span>&nbsp;<span class="op" id="4865228">&gt;</span>&nbsp;<span class="num" id="4865230">0</span>&nbsp;<span class="op" id="4865232">&amp;&amp;</span>&nbsp;<span class="ident" id="4865235">pattern</span><span class="op" id="4865242">[</span><span class="ident" id="4865243">n</span><span class="op" id="4865244">-</span><span class="num" id="4865245">1</span><span class="op" id="4865246">]</span>&nbsp;<span class="op" id="4865248">==</span>&nbsp;<span class="string" id="4865251">&#39;/&#39;</span>&nbsp;<span class="op" id="4865255">&amp;&amp;</span>&nbsp;<span class="op" id="4865258">!</span><span class="ident" id="4865259">mux</span><span class="op" id="4865262">.</span><span class="ident" id="4865263">m</span><span class="op" id="4865264">[</span><span class="ident" id="4865265">pattern</span><span class="op" id="4865272">[</span><span class="num" id="4865273">0</span><span class="op" id="4865274">:</span><span class="ident" id="4865275">n</span><span class="op" id="4865276">-</span><span class="num" id="4865277">1</span><span class="op" id="4865278">]</span><span class="op" id="4865279">]</span><span class="op" id="4865280">.</span><span class="ident" id="4865281">explicit</span>&nbsp;<span class="op" id="4865290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4865294">//&nbsp;If&nbsp;pattern&nbsp;contains&nbsp;a&nbsp;host&nbsp;name,&nbsp;strip&nbsp;it&nbsp;and&nbsp;use&nbsp;remaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4865359">//&nbsp;path&nbsp;for&nbsp;redirect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4865383">path</span>&nbsp;<span class="op" id="4865388">:=</span>&nbsp;<span class="ident" id="4865391">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4865401">if</span>&nbsp;<span class="ident" id="4865404">pattern</span><span class="op" id="4865411">[</span><span class="num" id="4865412">0</span><span class="op" id="4865413">]</span>&nbsp;<span class="op" id="4865415">!=</span>&nbsp;<span class="string" id="4865418">&#39;/&#39;</span>&nbsp;<span class="op" id="4865422">{</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4865427">//&nbsp;In&nbsp;pattern,&nbsp;at&nbsp;least&nbsp;the&nbsp;last&nbsp;character&nbsp;is&nbsp;a&nbsp;&#39;/&#39;,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4865486">//&nbsp;strings.Index&nbsp;can&#39;t&nbsp;be&nbsp;-1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4865519">path</span>&nbsp;<span class="op" id="4865524">=</span>&nbsp;<span class="ident" id="4865526">pattern</span><span class="op" id="4865533">[</span><span class="ident" id="4865534">strings</span><span class="op" id="4865541">.</span><span class="ident" id="4865542">Index</span><span class="op" id="4865547">(</span><span class="ident" id="4865548">pattern</span><span class="op" id="4865555">,</span>&nbsp;<span class="string" id="4865557">&#34;/&#34;</span><span class="op" id="4865560">)</span><span class="op" id="4865561">:</span><span class="op" id="4865562">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4865566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4865570">mux</span><span class="op" id="4865573">.</span><span class="ident" id="4865574">m</span><span class="op" id="4865575">[</span><span class="ident" id="4865576">pattern</span><span class="op" id="4865583">[</span><span class="num" id="4865584">0</span><span class="op" id="4865585">:</span><span class="ident" id="4865586">n</span><span class="op" id="4865587">-</span><span class="num" id="4865588">1</span><span class="op" id="4865589">]</span><span class="op" id="4865590">]</span>&nbsp;<span class="op" id="4865592">=</span>&nbsp;<span class="ident" id="4865594">muxEntry</span><span class="op" id="4865602">{</span><span class="ident" id="4865603">h</span><span class="op" id="4865604">:</span>&nbsp;<span class="ident" id="4865606">RedirectHandler</span><span class="op" id="4865621">(</span><span class="ident" id="4865622">path</span><span class="op" id="4865626">,</span>&nbsp;<span class="ident" id="4865628">StatusMovedPermanently</span><span class="op" id="4865650">)</span><span class="op" id="4865651">,</span>&nbsp;<span class="ident" id="4865653">pattern</span><span class="op" id="4865660">:</span>&nbsp;<span class="ident" id="4865662">pattern</span><span class="op" id="4865669">}</span><br>
<span class="lineno">1580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4865672">}</span><br>
<span class="lineno"></span><span class="op" id="4865674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4865677">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="4865745">func</span>&nbsp;<span class="op" id="4865750">(</span><span class="ident" id="4865751">mux</span>&nbsp;<span class="op" id="4865755">*</span><span class="ident" id="4865756">ServeMux</span><span class="op" id="4865764">)</span>&nbsp;<span class="ident" id="4865766">HandleFunc</span><span class="op" id="4865776">(</span><span class="ident" id="4865777">pattern</span>&nbsp;<span class="builtintype" id="4865785">string</span><span class="op" id="4865791">,</span>&nbsp;<span class="ident" id="4865793">handler</span>&nbsp;<span class="keyword" id="4865801">func</span><span class="op" id="4865805">(</span><span class="ident" id="4865806">ResponseWriter</span><span class="op" id="4865820">,</span>&nbsp;<span class="op" id="4865822">*</span><span class="ident" id="4865823">Request</span><span class="op" id="4865830">)</span><span class="op" id="4865831">)</span>&nbsp;<span class="op" id="4865833">{</span><br>
<span class="lineno">1585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4865836">mux</span><span class="op" id="4865839">.</span><span class="ident" id="4865840">Handle</span><span class="op" id="4865846">(</span><span class="ident" id="4865847">pattern</span><span class="op" id="4865854">,</span>&nbsp;<span class="ident" id="4865856">HandlerFunc</span><span class="op" id="4865867">(</span><span class="ident" id="4865868">handler</span><span class="op" id="4865875">)</span><span class="op" id="4865876">)</span><br>
<span class="lineno"></span><span class="op" id="4865878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4865881">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="4865935">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1590</span><span class="comment" id="4865962">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="4866031">func</span>&nbsp;<span class="ident" id="4866036">Handle</span><span class="op" id="4866042">(</span><span class="ident" id="4866043">pattern</span>&nbsp;<span class="builtintype" id="4866051">string</span><span class="op" id="4866057">,</span>&nbsp;<span class="ident" id="4866059">handler</span>&nbsp;<span class="ident" id="4866067">Handler</span><span class="op" id="4866074">)</span>&nbsp;<span class="op" id="4866076">{</span>&nbsp;<span class="ident" id="4866078">DefaultServeMux</span><span class="op" id="4866093">.</span><span class="ident" id="4866094">Handle</span><span class="op" id="4866100">(</span><span class="ident" id="4866101">pattern</span><span class="op" id="4866108">,</span>&nbsp;<span class="ident" id="4866110">handler</span><span class="op" id="4866117">)</span>&nbsp;<span class="op" id="4866119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4866122">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="4866189">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1595</span><span class="comment" id="4866216">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="4866285">func</span>&nbsp;<span class="ident" id="4866290">HandleFunc</span><span class="op" id="4866300">(</span><span class="ident" id="4866301">pattern</span>&nbsp;<span class="builtintype" id="4866309">string</span><span class="op" id="4866315">,</span>&nbsp;<span class="ident" id="4866317">handler</span>&nbsp;<span class="keyword" id="4866325">func</span><span class="op" id="4866329">(</span><span class="ident" id="4866330">ResponseWriter</span><span class="op" id="4866344">,</span>&nbsp;<span class="op" id="4866346">*</span><span class="ident" id="4866347">Request</span><span class="op" id="4866354">)</span><span class="op" id="4866355">)</span>&nbsp;<span class="op" id="4866357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4866360">DefaultServeMux</span><span class="op" id="4866375">.</span><span class="ident" id="4866376">HandleFunc</span><span class="op" id="4866386">(</span><span class="ident" id="4866387">pattern</span><span class="op" id="4866394">,</span>&nbsp;<span class="ident" id="4866396">handler</span><span class="op" id="4866403">)</span><br>
<span class="lineno"></span><span class="op" id="4866405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="4866408">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;HTTP&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,</span><br>
<span class="lineno"></span><span class="comment" id="4866470">//&nbsp;creating&nbsp;a&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="4866540">//&nbsp;read&nbsp;requests&nbsp;and&nbsp;then&nbsp;call&nbsp;handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="4866597">//&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4866669">func</span>&nbsp;<span class="ident" id="4866674">Serve</span><span class="op" id="4866679">(</span><span class="ident" id="4866680">l</span>&nbsp;<span class="ident" id="4866682">net</span><span class="op" id="4866685">.</span><span class="ident" id="4866686">Listener</span><span class="op" id="4866694">,</span>&nbsp;<span class="ident" id="4866696">handler</span>&nbsp;<span class="ident" id="4866704">Handler</span><span class="op" id="4866711">)</span>&nbsp;<span class="builtintype" id="4866713">error</span>&nbsp;<span class="op" id="4866719">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4866722">srv</span>&nbsp;<span class="op" id="4866726">:=</span>&nbsp;<span class="op" id="4866729">&amp;</span><span class="ident" id="4866730">Server</span><span class="op" id="4866736">{</span><span class="ident" id="4866737">Handler</span><span class="op" id="4866744">:</span>&nbsp;<span class="ident" id="4866746">handler</span><span class="op" id="4866753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4866756">return</span>&nbsp;<span class="ident" id="4866763">srv</span><span class="op" id="4866766">.</span><span class="ident" id="4866767">Serve</span><span class="op" id="4866772">(</span><span class="ident" id="4866773">l</span><span class="op" id="4866774">)</span><br>
<span class="lineno"></span><span class="op" id="4866776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4866779">//&nbsp;A&nbsp;Server&nbsp;defines&nbsp;parameters&nbsp;for&nbsp;running&nbsp;an&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">1610</span><span class="comment" id="4866838">//&nbsp;The&nbsp;zero&nbsp;value&nbsp;for&nbsp;Server&nbsp;is&nbsp;a&nbsp;valid&nbsp;configuration.</span><br>
<span class="lineno"></span><span class="keyword" id="4866893">type</span>&nbsp;<span class="ident" id="4866898">Server</span>&nbsp;<span class="keyword" id="4866905">struct</span>&nbsp;<span class="op" id="4866912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4866915">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4866930">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4866944">//&nbsp;TCP&nbsp;address&nbsp;to&nbsp;listen&nbsp;on,&nbsp;&#34;:http&#34;&nbsp;if&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4866991">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867006">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4867020">//&nbsp;handler&nbsp;to&nbsp;invoke,&nbsp;http.DefaultServeMux&nbsp;if&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4867071">ReadTimeout</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4867086">time</span><span class="op" id="4867090">.</span><span class="ident" id="4867091">Duration</span>&nbsp;<span class="comment" id="4867100">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;read&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4867159">WriteTimeout</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4867174">time</span><span class="op" id="4867178">.</span><span class="ident" id="4867179">Duration</span>&nbsp;<span class="comment" id="4867188">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;write&nbsp;of&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4867249">MaxHeaderBytes</span>&nbsp;<span class="builtintype" id="4867264">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4867278">//&nbsp;maximum&nbsp;size&nbsp;of&nbsp;request&nbsp;headers,&nbsp;DefaultMaxHeaderBytes&nbsp;if&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4867342">TLSConfig</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4867357">*</span><span class="ident" id="4867358">tls</span><span class="op" id="4867361">.</span><span class="ident" id="4867362">Config</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4867371">//&nbsp;optional&nbsp;TLS&nbsp;config,&nbsp;used&nbsp;by&nbsp;ListenAndServeTLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4867423">//&nbsp;TLSNextProto&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;take&nbsp;over</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4867485">//&nbsp;ownership&nbsp;of&nbsp;the&nbsp;provided&nbsp;TLS&nbsp;connection&nbsp;when&nbsp;an&nbsp;NPN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4867542">//&nbsp;protocol&nbsp;upgrade&nbsp;has&nbsp;occurred.&nbsp;&nbsp;The&nbsp;map&nbsp;key&nbsp;is&nbsp;the&nbsp;protocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4867606">//&nbsp;name&nbsp;negotiated.&nbsp;The&nbsp;Handler&nbsp;argument&nbsp;should&nbsp;be&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4867666">//&nbsp;handle&nbsp;HTTP&nbsp;requests&nbsp;and&nbsp;will&nbsp;initialize&nbsp;the&nbsp;Request&#39;s&nbsp;TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4867729">//&nbsp;and&nbsp;RemoteAddr&nbsp;if&nbsp;not&nbsp;already&nbsp;set.&nbsp;&nbsp;The&nbsp;connection&nbsp;is</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4867787">//&nbsp;automatically&nbsp;closed&nbsp;when&nbsp;the&nbsp;function&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4867839">TLSNextProto</span>&nbsp;<span class="keyword" id="4867852">map</span><span class="op" id="4867855">[</span><span class="builtintype" id="4867856">string</span><span class="op" id="4867862">]</span><span class="keyword" id="4867863">func</span><span class="op" id="4867867">(</span><span class="op" id="4867868">*</span><span class="ident" id="4867869">Server</span><span class="op" id="4867875">,</span>&nbsp;<span class="op" id="4867877">*</span><span class="ident" id="4867878">tls</span><span class="op" id="4867881">.</span><span class="ident" id="4867882">Conn</span><span class="op" id="4867886">,</span>&nbsp;<span class="ident" id="4867888">Handler</span><span class="op" id="4867895">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4867899">//&nbsp;ConnState&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;callback&nbsp;function&nbsp;that&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4867961">//&nbsp;called&nbsp;when&nbsp;a&nbsp;client&nbsp;connection&nbsp;changes&nbsp;state.&nbsp;See&nbsp;the</span><br>
<span class="lineno">1630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4868020">//&nbsp;ConnState&nbsp;type&nbsp;and&nbsp;associated&nbsp;constants&nbsp;for&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4868077">ConnState</span>&nbsp;<span class="keyword" id="4868087">func</span><span class="op" id="4868091">(</span><span class="ident" id="4868092">net</span><span class="op" id="4868095">.</span><span class="ident" id="4868096">Conn</span><span class="op" id="4868100">,</span>&nbsp;<span class="ident" id="4868102">ConnState</span><span class="op" id="4868111">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4868115">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors&nbsp;accepting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4868178">//&nbsp;connections&nbsp;and&nbsp;unexpected&nbsp;behavior&nbsp;from&nbsp;handlers.</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4868233">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4868293">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4868314">ErrorLog</span>&nbsp;<span class="op" id="4868323">*</span><span class="ident" id="4868324">log</span><span class="op" id="4868327">.</span><span class="ident" id="4868328">Logger</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4868337">disableKeepAlives</span>&nbsp;<span class="builtintype" id="4868355">int32</span>&nbsp;<span class="comment" id="4868361">//&nbsp;accessed&nbsp;atomically.</span><br>
<span class="lineno">1640</span><span class="op" id="4868385">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4868388">//&nbsp;A&nbsp;ConnState&nbsp;represents&nbsp;the&nbsp;state&nbsp;of&nbsp;a&nbsp;client&nbsp;connection&nbsp;to&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="comment" id="4868460">//&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;the&nbsp;optional&nbsp;Server.ConnState&nbsp;hook.</span><br>
<span class="lineno"></span><span class="keyword" id="4868512">type</span>&nbsp;<span class="ident" id="4868517">ConnState</span>&nbsp;<span class="builtintype" id="4868527">int</span><br>
<span class="lineno">1645</span><br>
<span class="lineno"></span><span class="keyword" id="4868532">const</span>&nbsp;<span class="op" id="4868538">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4868541">//&nbsp;StateNew&nbsp;represents&nbsp;a&nbsp;new&nbsp;connection&nbsp;that&nbsp;is&nbsp;expected&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4868602">//&nbsp;send&nbsp;a&nbsp;request&nbsp;immediately.&nbsp;Connections&nbsp;begin&nbsp;at&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4868660">//&nbsp;state&nbsp;and&nbsp;then&nbsp;transition&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4868715">//&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4868732">StateNew</span>&nbsp;<span class="ident" id="4868741">ConnState</span>&nbsp;<span class="op" id="4868751">=</span>&nbsp;<span class="ident" id="4868753">iota</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4868760">//&nbsp;StateActive&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;read&nbsp;1&nbsp;or&nbsp;more</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4868824">//&nbsp;bytes&nbsp;of&nbsp;a&nbsp;request.&nbsp;The&nbsp;Server.ConnState&nbsp;hook&nbsp;for</span><br>
<span class="lineno">1655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4868878">//&nbsp;StateActive&nbsp;fires&nbsp;before&nbsp;the&nbsp;request&nbsp;has&nbsp;entered&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4868941">//&nbsp;and&nbsp;doesn&#39;t&nbsp;fire&nbsp;again&nbsp;until&nbsp;the&nbsp;request&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4868995">//&nbsp;handled.&nbsp;After&nbsp;the&nbsp;request&nbsp;is&nbsp;handled,&nbsp;the&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4869048">//&nbsp;transitions&nbsp;to&nbsp;StateClosed,&nbsp;StateHijacked,&nbsp;or&nbsp;StateIdle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869109">StateActive</span><br>
<span class="lineno">1660</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4869123">//&nbsp;StateIdle&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4869179">//&nbsp;handling&nbsp;a&nbsp;request&nbsp;and&nbsp;is&nbsp;in&nbsp;the&nbsp;keep-alive&nbsp;state,&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4869242">//&nbsp;for&nbsp;a&nbsp;new&nbsp;request.&nbsp;Connections&nbsp;transition&nbsp;from&nbsp;StateIdle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4869303">//&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or&nbsp;StateClosed.</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869345">StateIdle</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4869357">//&nbsp;StateHijacked&nbsp;represents&nbsp;a&nbsp;hijacked&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4869409">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869478">StateHijacked</span><br>
<span class="lineno">1670</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4869494">//&nbsp;StateClosed&nbsp;represents&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4869542">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;Hijacked&nbsp;connections&nbsp;do&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4869600">//&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869631">StateClosed</span><br>
<span class="lineno">1675</span><span class="op" id="4869643">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4869646">var</span>&nbsp;<span class="ident" id="4869650">stateName</span>&nbsp;<span class="op" id="4869660">=</span>&nbsp;<span class="keyword" id="4869662">map</span><span class="op" id="4869665">[</span><span class="ident" id="4869666">ConnState</span><span class="op" id="4869675">]</span><span class="builtintype" id="4869676">string</span><span class="op" id="4869682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869685">StateNew</span><span class="op" id="4869693">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4869700">&#34;new&#34;</span><span class="op" id="4869705">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869708">StateActive</span><span class="op" id="4869719">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="4869723">&#34;active&#34;</span><span class="op" id="4869731">,</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869734">StateIdle</span><span class="op" id="4869743">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4869749">&#34;idle&#34;</span><span class="op" id="4869755">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869758">StateHijacked</span><span class="op" id="4869771">:</span>&nbsp;<span class="string" id="4869773">&#34;hijacked&#34;</span><span class="op" id="4869783">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869786">StateClosed</span><span class="op" id="4869797">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="4869801">&#34;closed&#34;</span><span class="op" id="4869809">,</span><br>
<span class="lineno"></span><span class="op" id="4869811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1685</span><span class="keyword" id="4869814">func</span>&nbsp;<span class="op" id="4869819">(</span><span class="ident" id="4869820">c</span>&nbsp;<span class="ident" id="4869822">ConnState</span><span class="op" id="4869831">)</span>&nbsp;<span class="ident" id="4869833">String</span><span class="op" id="4869839">(</span><span class="op" id="4869840">)</span>&nbsp;<span class="builtintype" id="4869842">string</span>&nbsp;<span class="op" id="4869849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4869852">return</span>&nbsp;<span class="ident" id="4869859">stateName</span><span class="op" id="4869868">[</span><span class="ident" id="4869869">c</span><span class="op" id="4869870">]</span><br>
<span class="lineno"></span><span class="op" id="4869872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4869875">//&nbsp;serverHandler&nbsp;delegates&nbsp;to&nbsp;either&nbsp;the&nbsp;server&#39;s&nbsp;Handler&nbsp;or</span><br>
<span class="lineno">1690</span><span class="comment" id="4869936">//&nbsp;DefaultServeMux&nbsp;and&nbsp;also&nbsp;handles&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="4869994">type</span>&nbsp;<span class="ident" id="4869999">serverHandler</span>&nbsp;<span class="keyword" id="4870013">struct</span>&nbsp;<span class="op" id="4870020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870023">srv</span>&nbsp;<span class="op" id="4870027">*</span><span class="ident" id="4870028">Server</span><br>
<span class="lineno"></span><span class="op" id="4870035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1695</span><span class="keyword" id="4870038">func</span>&nbsp;<span class="op" id="4870043">(</span><span class="ident" id="4870044">sh</span>&nbsp;<span class="ident" id="4870047">serverHandler</span><span class="op" id="4870060">)</span>&nbsp;<span class="ident" id="4870062">ServeHTTP</span><span class="op" id="4870071">(</span><span class="ident" id="4870072">rw</span>&nbsp;<span class="ident" id="4870075">ResponseWriter</span><span class="op" id="4870089">,</span>&nbsp;<span class="ident" id="4870091">req</span>&nbsp;<span class="op" id="4870095">*</span><span class="ident" id="4870096">Request</span><span class="op" id="4870103">)</span>&nbsp;<span class="op" id="4870105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870108">handler</span>&nbsp;<span class="op" id="4870116">:=</span>&nbsp;<span class="ident" id="4870119">sh</span><span class="op" id="4870121">.</span><span class="ident" id="4870122">srv</span><span class="op" id="4870125">.</span><span class="ident" id="4870126">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4870135">if</span>&nbsp;<span class="ident" id="4870138">handler</span>&nbsp;<span class="op" id="4870146">==</span>&nbsp;<span class="ident" id="4870149">nil</span>&nbsp;<span class="op" id="4870153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870157">handler</span>&nbsp;<span class="op" id="4870165">=</span>&nbsp;<span class="ident" id="4870167">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4870184">}</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4870187">if</span>&nbsp;<span class="ident" id="4870190">req</span><span class="op" id="4870193">.</span><span class="ident" id="4870194">RequestURI</span>&nbsp;<span class="op" id="4870205">==</span>&nbsp;<span class="string" id="4870208">&#34;*&#34;</span>&nbsp;<span class="op" id="4870212">&amp;&amp;</span>&nbsp;<span class="ident" id="4870215">req</span><span class="op" id="4870218">.</span><span class="ident" id="4870219">Method</span>&nbsp;<span class="op" id="4870226">==</span>&nbsp;<span class="string" id="4870229">&#34;OPTIONS&#34;</span>&nbsp;<span class="op" id="4870239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870243">handler</span>&nbsp;<span class="op" id="4870251">=</span>&nbsp;<span class="ident" id="4870253">globalOptionsHandler</span><span class="op" id="4870273">{</span><span class="op" id="4870274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4870277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870280">handler</span><span class="op" id="4870287">.</span><span class="ident" id="4870288">ServeHTTP</span><span class="op" id="4870297">(</span><span class="ident" id="4870298">rw</span><span class="op" id="4870300">,</span>&nbsp;<span class="ident" id="4870302">req</span><span class="op" id="4870305">)</span><br>
<span class="lineno"></span><span class="op" id="4870307">}</span><br>
<span class="lineno">1705</span><br>
<span class="lineno"></span><span class="comment" id="4870310">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="4870381">//&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;If</span><br>
<span class="lineno"></span><span class="comment" id="4870444">//&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:http&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4870483">func</span>&nbsp;<span class="op" id="4870488">(</span><span class="ident" id="4870489">srv</span>&nbsp;<span class="op" id="4870493">*</span><span class="ident" id="4870494">Server</span><span class="op" id="4870500">)</span>&nbsp;<span class="ident" id="4870502">ListenAndServe</span><span class="op" id="4870516">(</span><span class="op" id="4870517">)</span>&nbsp;<span class="builtintype" id="4870519">error</span>&nbsp;<span class="op" id="4870525">{</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870528">addr</span>&nbsp;<span class="op" id="4870533">:=</span>&nbsp;<span class="ident" id="4870536">srv</span><span class="op" id="4870539">.</span><span class="ident" id="4870540">Addr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4870546">if</span>&nbsp;<span class="ident" id="4870549">addr</span>&nbsp;<span class="op" id="4870554">==</span>&nbsp;<span class="string" id="4870557">&#34;&#34;</span>&nbsp;<span class="op" id="4870560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870564">addr</span>&nbsp;<span class="op" id="4870569">=</span>&nbsp;<span class="string" id="4870571">&#34;:http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4870580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870583">ln</span><span class="op" id="4870585">,</span>&nbsp;<span class="ident" id="4870587">err</span>&nbsp;<span class="op" id="4870591">:=</span>&nbsp;<span class="ident" id="4870594">net</span><span class="op" id="4870597">.</span><span class="ident" id="4870598">Listen</span><span class="op" id="4870604">(</span><span class="string" id="4870605">&#34;tcp&#34;</span><span class="op" id="4870610">,</span>&nbsp;<span class="ident" id="4870612">addr</span><span class="op" id="4870616">)</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4870619">if</span>&nbsp;<span class="ident" id="4870622">err</span>&nbsp;<span class="op" id="4870626">!=</span>&nbsp;<span class="ident" id="4870629">nil</span>&nbsp;<span class="op" id="4870633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4870637">return</span>&nbsp;<span class="ident" id="4870644">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4870649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4870652">return</span>&nbsp;<span class="ident" id="4870659">srv</span><span class="op" id="4870662">.</span><span class="ident" id="4870663">Serve</span><span class="op" id="4870668">(</span><span class="ident" id="4870669">tcpKeepAliveListener</span><span class="op" id="4870689">{</span><span class="ident" id="4870690">ln</span><span class="op" id="4870692">.</span><span class="op" id="4870693">(</span><span class="op" id="4870694">*</span><span class="ident" id="4870695">net</span><span class="op" id="4870698">.</span><span class="ident" id="4870699">TCPListener</span><span class="op" id="4870710">)</span><span class="op" id="4870711">}</span><span class="op" id="4870712">)</span><br>
<span class="lineno"></span><span class="op" id="4870714">}</span><br>
<span class="lineno">1720</span><br>
<span class="lineno"></span><span class="comment" id="4870717">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;connections&nbsp;on&nbsp;the&nbsp;Listener&nbsp;l,&nbsp;creating&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4870785">//&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines&nbsp;read&nbsp;requests&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4870862">//&nbsp;then&nbsp;call&nbsp;srv.Handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="4870905">func</span>&nbsp;<span class="op" id="4870910">(</span><span class="ident" id="4870911">srv</span>&nbsp;<span class="op" id="4870915">*</span><span class="ident" id="4870916">Server</span><span class="op" id="4870922">)</span>&nbsp;<span class="ident" id="4870924">Serve</span><span class="op" id="4870929">(</span><span class="ident" id="4870930">l</span>&nbsp;<span class="ident" id="4870932">net</span><span class="op" id="4870935">.</span><span class="ident" id="4870936">Listener</span><span class="op" id="4870944">)</span>&nbsp;<span class="builtintype" id="4870946">error</span>&nbsp;<span class="op" id="4870952">{</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4870955">defer</span>&nbsp;<span class="ident" id="4870961">l</span><span class="op" id="4870962">.</span><span class="ident" id="4870963">Close</span><span class="op" id="4870968">(</span><span class="op" id="4870969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4870972">var</span>&nbsp;<span class="ident" id="4870976">tempDelay</span>&nbsp;<span class="ident" id="4870986">time</span><span class="op" id="4870990">.</span><span class="ident" id="4870991">Duration</span>&nbsp;<span class="comment" id="4871000">//&nbsp;how&nbsp;long&nbsp;to&nbsp;sleep&nbsp;on&nbsp;accept&nbsp;failure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4871040">for</span>&nbsp;<span class="op" id="4871044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871048">rw</span><span class="op" id="4871050">,</span>&nbsp;<span class="ident" id="4871052">e</span>&nbsp;<span class="op" id="4871054">:=</span>&nbsp;<span class="ident" id="4871057">l</span><span class="op" id="4871058">.</span><span class="ident" id="4871059">Accept</span><span class="op" id="4871065">(</span><span class="op" id="4871066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4871070">if</span>&nbsp;<span class="ident" id="4871073">e</span>&nbsp;<span class="op" id="4871075">!=</span>&nbsp;<span class="ident" id="4871078">nil</span>&nbsp;<span class="op" id="4871082">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4871087">if</span>&nbsp;<span class="ident" id="4871090">ne</span><span class="op" id="4871092">,</span>&nbsp;<span class="ident" id="4871094">ok</span>&nbsp;<span class="op" id="4871097">:=</span>&nbsp;<span class="ident" id="4871100">e</span><span class="op" id="4871101">.</span><span class="op" id="4871102">(</span><span class="ident" id="4871103">net</span><span class="op" id="4871106">.</span><span class="ident" id="4871107">Error</span><span class="op" id="4871112">)</span><span class="op" id="4871113">;</span>&nbsp;<span class="ident" id="4871115">ok</span>&nbsp;<span class="op" id="4871118">&amp;&amp;</span>&nbsp;<span class="ident" id="4871121">ne</span><span class="op" id="4871123">.</span><span class="ident" id="4871124">Temporary</span><span class="op" id="4871133">(</span><span class="op" id="4871134">)</span>&nbsp;<span class="op" id="4871136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4871142">if</span>&nbsp;<span class="ident" id="4871145">tempDelay</span>&nbsp;<span class="op" id="4871155">==</span>&nbsp;<span class="num" id="4871158">0</span>&nbsp;<span class="op" id="4871160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871167">tempDelay</span>&nbsp;<span class="op" id="4871177">=</span>&nbsp;<span class="num" id="4871179">5</span>&nbsp;<span class="op" id="4871181">*</span>&nbsp;<span class="ident" id="4871183">time</span><span class="op" id="4871187">.</span><span class="ident" id="4871188">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4871204">}</span>&nbsp;<span class="keyword" id="4871206">else</span>&nbsp;<span class="op" id="4871211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871218">tempDelay</span>&nbsp;<span class="op" id="4871228">*=</span>&nbsp;<span class="num" id="4871231">2</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4871237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4871243">if</span>&nbsp;<span class="ident" id="4871246">max</span>&nbsp;<span class="op" id="4871250">:=</span>&nbsp;<span class="num" id="4871253">1</span>&nbsp;<span class="op" id="4871255">*</span>&nbsp;<span class="ident" id="4871257">time</span><span class="op" id="4871261">.</span><span class="ident" id="4871262">Second</span><span class="op" id="4871268">;</span>&nbsp;<span class="ident" id="4871270">tempDelay</span>&nbsp;<span class="op" id="4871280">&gt;</span>&nbsp;<span class="ident" id="4871282">max</span>&nbsp;<span class="op" id="4871286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871293">tempDelay</span>&nbsp;<span class="op" id="4871303">=</span>&nbsp;<span class="ident" id="4871305">max</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4871313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871319">srv</span><span class="op" id="4871322">.</span><span class="ident" id="4871323">logf</span><span class="op" id="4871327">(</span><span class="string" id="4871328">&#34;http:&nbsp;Accept&nbsp;error:&nbsp;%v;&nbsp;retrying&nbsp;in&nbsp;%v&#34;</span><span class="op" id="4871368">,</span>&nbsp;<span class="ident" id="4871370">e</span><span class="op" id="4871371">,</span>&nbsp;<span class="ident" id="4871373">tempDelay</span><span class="op" id="4871382">)</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871388">time</span><span class="op" id="4871392">.</span><span class="ident" id="4871393">Sleep</span><span class="op" id="4871398">(</span><span class="ident" id="4871399">tempDelay</span><span class="op" id="4871408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4871414">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4871426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4871431">return</span>&nbsp;<span class="ident" id="4871438">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4871442">}</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871446">tempDelay</span>&nbsp;<span class="op" id="4871456">=</span>&nbsp;<span class="num" id="4871458">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871462">c</span><span class="op" id="4871463">,</span>&nbsp;<span class="ident" id="4871465">err</span>&nbsp;<span class="op" id="4871469">:=</span>&nbsp;<span class="ident" id="4871472">srv</span><span class="op" id="4871475">.</span><span class="ident" id="4871476">newConn</span><span class="op" id="4871483">(</span><span class="ident" id="4871484">rw</span><span class="op" id="4871486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4871490">if</span>&nbsp;<span class="ident" id="4871493">err</span>&nbsp;<span class="op" id="4871497">!=</span>&nbsp;<span class="ident" id="4871500">nil</span>&nbsp;<span class="op" id="4871504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4871509">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4871520">}</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871524">c</span><span class="op" id="4871525">.</span><span class="ident" id="4871526">setState</span><span class="op" id="4871534">(</span><span class="ident" id="4871535">c</span><span class="op" id="4871536">.</span><span class="ident" id="4871537">rwc</span><span class="op" id="4871540">,</span>&nbsp;<span class="ident" id="4871542">StateNew</span><span class="op" id="4871550">)</span>&nbsp;<span class="comment" id="4871552">//&nbsp;before&nbsp;Serve&nbsp;can&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4871581">go</span>&nbsp;<span class="ident" id="4871584">c</span><span class="op" id="4871585">.</span><span class="ident" id="4871586">serve</span><span class="op" id="4871591">(</span><span class="op" id="4871592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4871595">}</span><br>
<span class="lineno"></span><span class="op" id="4871597">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1755</span><span class="keyword" id="4871600">func</span>&nbsp;<span class="op" id="4871605">(</span><span class="ident" id="4871606">s</span>&nbsp;<span class="op" id="4871608">*</span><span class="ident" id="4871609">Server</span><span class="op" id="4871615">)</span>&nbsp;<span class="ident" id="4871617">doKeepAlives</span><span class="op" id="4871629">(</span><span class="op" id="4871630">)</span>&nbsp;<span class="builtintype" id="4871632">bool</span>&nbsp;<span class="op" id="4871637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4871640">return</span>&nbsp;<span class="ident" id="4871647">atomic</span><span class="op" id="4871653">.</span><span class="ident" id="4871654">LoadInt32</span><span class="op" id="4871663">(</span><span class="op" id="4871664">&amp;</span><span class="ident" id="4871665">s</span><span class="op" id="4871666">.</span><span class="ident" id="4871667">disableKeepAlives</span><span class="op" id="4871684">)</span>&nbsp;<span class="op" id="4871686">==</span>&nbsp;<span class="num" id="4871689">0</span><br>
<span class="lineno"></span><span class="op" id="4871691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4871694">//&nbsp;SetKeepAlivesEnabled&nbsp;controls&nbsp;whether&nbsp;HTTP&nbsp;keep-alives&nbsp;are&nbsp;enabled.</span><br>
<span class="lineno">1760</span><span class="comment" id="4871765">//&nbsp;By&nbsp;default,&nbsp;keep-alives&nbsp;are&nbsp;always&nbsp;enabled.&nbsp;Only&nbsp;very</span><br>
<span class="lineno"></span><span class="comment" id="4871822">//&nbsp;resource-constrained&nbsp;environments&nbsp;or&nbsp;servers&nbsp;in&nbsp;the&nbsp;process&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4871888">//&nbsp;shutting&nbsp;down&nbsp;should&nbsp;disable&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="4871926">func</span>&nbsp;<span class="op" id="4871931">(</span><span class="ident" id="4871932">s</span>&nbsp;<span class="op" id="4871934">*</span><span class="ident" id="4871935">Server</span><span class="op" id="4871941">)</span>&nbsp;<span class="ident" id="4871943">SetKeepAlivesEnabled</span><span class="op" id="4871963">(</span><span class="ident" id="4871964">v</span>&nbsp;<span class="builtintype" id="4871966">bool</span><span class="op" id="4871970">)</span>&nbsp;<span class="op" id="4871972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4871975">if</span>&nbsp;<span class="ident" id="4871978">v</span>&nbsp;<span class="op" id="4871980">{</span><br>
<span class="lineno">1765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871984">atomic</span><span class="op" id="4871990">.</span><span class="ident" id="4871991">StoreInt32</span><span class="op" id="4872001">(</span><span class="op" id="4872002">&amp;</span><span class="ident" id="4872003">s</span><span class="op" id="4872004">.</span><span class="ident" id="4872005">disableKeepAlives</span><span class="op" id="4872022">,</span>&nbsp;<span class="num" id="4872024">0</span><span class="op" id="4872025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4872028">}</span>&nbsp;<span class="keyword" id="4872030">else</span>&nbsp;<span class="op" id="4872035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4872039">atomic</span><span class="op" id="4872045">.</span><span class="ident" id="4872046">StoreInt32</span><span class="op" id="4872056">(</span><span class="op" id="4872057">&amp;</span><span class="ident" id="4872058">s</span><span class="op" id="4872059">.</span><span class="ident" id="4872060">disableKeepAlives</span><span class="op" id="4872077">,</span>&nbsp;<span class="num" id="4872079">1</span><span class="op" id="4872080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4872083">}</span><br>
<span class="lineno"></span><span class="op" id="4872085">}</span><br>
<span class="lineno">1770</span><br>
<span class="lineno"></span><span class="keyword" id="4872088">func</span>&nbsp;<span class="op" id="4872093">(</span><span class="ident" id="4872094">s</span>&nbsp;<span class="op" id="4872096">*</span><span class="ident" id="4872097">Server</span><span class="op" id="4872103">)</span>&nbsp;<span class="ident" id="4872105">logf</span><span class="op" id="4872109">(</span><span class="ident" id="4872110">format</span>&nbsp;<span class="builtintype" id="4872117">string</span><span class="op" id="4872123">,</span>&nbsp;<span class="ident" id="4872125">args</span>&nbsp;<span class="op" id="4872130">...</span><span class="keyword" id="4872133">interface</span><span class="op" id="4872142">{</span><span class="op" id="4872143">}</span><span class="op" id="4872144">)</span>&nbsp;<span class="op" id="4872146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4872149">if</span>&nbsp;<span class="ident" id="4872152">s</span><span class="op" id="4872153">.</span><span class="ident" id="4872154">ErrorLog</span>&nbsp;<span class="op" id="4872163">!=</span>&nbsp;<span class="ident" id="4872166">nil</span>&nbsp;<span class="op" id="4872170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4872174">s</span><span class="op" id="4872175">.</span><span class="ident" id="4872176">ErrorLog</span><span class="op" id="4872184">.</span><span class="ident" id="4872185">Printf</span><span class="op" id="4872191">(</span><span class="ident" id="4872192">format</span><span class="op" id="4872198">,</span>&nbsp;<span class="ident" id="4872200">args</span><span class="op" id="4872204">...</span><span class="op" id="4872207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4872210">}</span>&nbsp;<span class="keyword" id="4872212">else</span>&nbsp;<span class="op" id="4872217">{</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4872221">log</span><span class="op" id="4872224">.</span><span class="ident" id="4872225">Printf</span><span class="op" id="4872231">(</span><span class="ident" id="4872232">format</span><span class="op" id="4872238">,</span>&nbsp;<span class="ident" id="4872240">args</span><span class="op" id="4872244">...</span><span class="op" id="4872247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4872250">}</span><br>
<span class="lineno"></span><span class="op" id="4872252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4872255">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;addr</span><br>
<span class="lineno">1780</span><span class="comment" id="4872313">//&nbsp;and&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;with&nbsp;handler&nbsp;to&nbsp;handle&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="4872369">//&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="4872424">//&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="4872470">//</span><br>
<span class="lineno"></span><span class="comment" id="4872473">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno">1785</span><span class="comment" id="4872505">//</span><br>
<span class="lineno"></span><span class="comment" id="4872508">//&nbsp;&nbsp;&nbsp;&nbsppackage&nbsp;main</span><br>
<span class="lineno"></span><span class="comment" id="4872524">//</span><br>
<span class="lineno"></span><span class="comment" id="4872527">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;(</span><br>
<span class="lineno"></span><span class="comment" id="4872539">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;io&#34;</span><br>
<span class="lineno">1790</span><span class="comment" id="4872548">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4872563">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4872573">//&nbsp;&nbsp;&nbsp;&nbsp)</span><br>
<span class="lineno"></span><span class="comment" id="4872578">//</span><br>
<span class="lineno"></span><span class="comment" id="4872581">//&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;hello&nbsp;world,&nbsp;the&nbsp;web&nbsp;server</span><br>
<span class="lineno">1795</span><span class="comment" id="4872615">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;HelloServer(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="4872679">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspio.WriteString(w,&nbsp;&#34;hello,&nbsp;world!\n&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="4872720">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="4872725">//</span><br>
<span class="lineno"></span><span class="comment" id="4872728">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1800</span><span class="comment" id="4872745">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsphttp.HandleFunc(&#34;/hello&#34;,&nbsp;HelloServer)</span><br>
<span class="lineno"></span><span class="comment" id="4872788">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;:=&nbsp;http.ListenAndServe(&#34;:12345&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="4872834">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="4872854">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;ListenAndServe:&nbsp;&#34;,&nbsp;err)</span><br>
<span class="lineno"></span><span class="comment" id="4872894">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno">1805</span><span class="comment" id="4872900">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="keyword" id="4872905">func</span>&nbsp;<span class="ident" id="4872910">ListenAndServe</span><span class="op" id="4872924">(</span><span class="ident" id="4872925">addr</span>&nbsp;<span class="builtintype" id="4872930">string</span><span class="op" id="4872936">,</span>&nbsp;<span class="ident" id="4872938">handler</span>&nbsp;<span class="ident" id="4872946">Handler</span><span class="op" id="4872953">)</span>&nbsp;<span class="builtintype" id="4872955">error</span>&nbsp;<span class="op" id="4872961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4872964">server</span>&nbsp;<span class="op" id="4872971">:=</span>&nbsp;<span class="op" id="4872974">&amp;</span><span class="ident" id="4872975">Server</span><span class="op" id="4872981">{</span><span class="ident" id="4872982">Addr</span><span class="op" id="4872986">:</span>&nbsp;<span class="ident" id="4872988">addr</span><span class="op" id="4872992">,</span>&nbsp;<span class="ident" id="4872994">Handler</span><span class="op" id="4873001">:</span>&nbsp;<span class="ident" id="4873003">handler</span><span class="op" id="4873010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4873013">return</span>&nbsp;<span class="ident" id="4873020">server</span><span class="op" id="4873026">.</span><span class="ident" id="4873027">ListenAndServe</span><span class="op" id="4873041">(</span><span class="op" id="4873042">)</span><br>
<span class="lineno"></span><span class="op" id="4873044">}</span><br>
<span class="lineno">1810</span><br>
<span class="lineno"></span><span class="comment" id="4873047">//&nbsp;ListenAndServeTLS&nbsp;acts&nbsp;identically&nbsp;to&nbsp;ListenAndServe,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="4873119">//&nbsp;expects&nbsp;HTTPS&nbsp;connections.&nbsp;Additionally,&nbsp;files&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4873198">//&nbsp;matching&nbsp;private&nbsp;key&nbsp;for&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate</span><br>
<span class="lineno"></span><span class="comment" id="4873274">//&nbsp;is&nbsp;signed&nbsp;by&nbsp;a&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1815</span><span class="comment" id="4873356">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="4873421">//</span><br>
<span class="lineno"></span><span class="comment" id="4873424">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno"></span><span class="comment" id="4873456">//</span><br>
<span class="lineno"></span><span class="comment" id="4873459">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;(</span><br>
<span class="lineno">1820</span><span class="comment" id="4873471">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4873481">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="4873496">//&nbsp;&nbsp;&nbsp;&nbsp)</span><br>
<span class="lineno"></span><span class="comment" id="4873501">//</span><br>
<span class="lineno"></span><span class="comment" id="4873504">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;handler(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno">1825</span><span class="comment" id="4873564">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspw.Header().Set(&#34;Content-Type&#34;,&nbsp;&#34;text/plain&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="4873613">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspw.Write([]byte(&#34;This&nbsp;is&nbsp;an&nbsp;example&nbsp;server.\n&#34;))</span><br>
<span class="lineno"></span><span class="comment" id="4873665">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="4873670">//</span><br>
<span class="lineno"></span><span class="comment" id="4873673">//&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1830</span><span class="comment" id="4873690">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsphttp.HandleFunc(&#34;/&#34;,&nbsp;handler)</span><br>
<span class="lineno"></span><span class="comment" id="4873724">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Printf(&#34;About&nbsp;to&nbsp;listen&nbsp;on&nbsp;10443.&nbsp;Go&nbsp;to&nbsp;https://127.0.0.1:10443/&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="4873799">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;:=&nbsp;http.ListenAndServeTLS(&#34;:10443&#34;,&nbsp;&#34;cert.pem&#34;,&nbsp;&#34;key.pem&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="4873871">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="4873891">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(err)</span><br>
<span class="lineno">1835</span><span class="comment" id="4873911">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="4873917">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="4873922">//</span><br>
<span class="lineno"></span><span class="comment" id="4873925">//&nbsp;One&nbsp;can&nbsp;use&nbsp;generate_cert.go&nbsp;in&nbsp;crypto/tls&nbsp;to&nbsp;generate&nbsp;cert.pem&nbsp;and&nbsp;key.pem.</span><br>
<span class="lineno"></span><span class="keyword" id="4874005">func</span>&nbsp;<span class="ident" id="4874010">ListenAndServeTLS</span><span class="op" id="4874027">(</span><span class="ident" id="4874028">addr</span>&nbsp;<span class="builtintype" id="4874033">string</span><span class="op" id="4874039">,</span>&nbsp;<span class="ident" id="4874041">certFile</span>&nbsp;<span class="builtintype" id="4874050">string</span><span class="op" id="4874056">,</span>&nbsp;<span class="ident" id="4874058">keyFile</span>&nbsp;<span class="builtintype" id="4874066">string</span><span class="op" id="4874072">,</span>&nbsp;<span class="ident" id="4874074">handler</span>&nbsp;<span class="ident" id="4874082">Handler</span><span class="op" id="4874089">)</span>&nbsp;<span class="builtintype" id="4874091">error</span>&nbsp;<span class="op" id="4874097">{</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4874100">server</span>&nbsp;<span class="op" id="4874107">:=</span>&nbsp;<span class="op" id="4874110">&amp;</span><span class="ident" id="4874111">Server</span><span class="op" id="4874117">{</span><span class="ident" id="4874118">Addr</span><span class="op" id="4874122">:</span>&nbsp;<span class="ident" id="4874124">addr</span><span class="op" id="4874128">,</span>&nbsp;<span class="ident" id="4874130">Handler</span><span class="op" id="4874137">:</span>&nbsp;<span class="ident" id="4874139">handler</span><span class="op" id="4874146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4874149">return</span>&nbsp;<span class="ident" id="4874156">server</span><span class="op" id="4874162">.</span><span class="ident" id="4874163">ListenAndServeTLS</span><span class="op" id="4874180">(</span><span class="ident" id="4874181">certFile</span><span class="op" id="4874189">,</span>&nbsp;<span class="ident" id="4874191">keyFile</span><span class="op" id="4874198">)</span><br>
<span class="lineno"></span><span class="op" id="4874200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4874203">//&nbsp;ListenAndServeTLS&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and</span><br>
<span class="lineno">1845</span><span class="comment" id="4874272">//&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="4874340">//</span><br>
<span class="lineno"></span><span class="comment" id="4874343">//&nbsp;Filenames&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and&nbsp;matching&nbsp;private&nbsp;key&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4874410">//&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4874476">//&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1850</span><span class="comment" id="4874543">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="4874608">//</span><br>
<span class="lineno"></span><span class="comment" id="4874611">//&nbsp;If&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:https&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4874654">func</span>&nbsp;<span class="op" id="4874659">(</span><span class="ident" id="4874660">srv</span>&nbsp;<span class="op" id="4874664">*</span><span class="ident" id="4874665">Server</span><span class="op" id="4874671">)</span>&nbsp;<span class="ident" id="4874673">ListenAndServeTLS</span><span class="op" id="4874690">(</span><span class="ident" id="4874691">certFile</span><span class="op" id="4874699">,</span>&nbsp;<span class="ident" id="4874701">keyFile</span>&nbsp;<span class="builtintype" id="4874709">string</span><span class="op" id="4874715">)</span>&nbsp;<span class="builtintype" id="4874717">error</span>&nbsp;<span class="op" id="4874723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4874726">addr</span>&nbsp;<span class="op" id="4874731">:=</span>&nbsp;<span class="ident" id="4874734">srv</span><span class="op" id="4874737">.</span><span class="ident" id="4874738">Addr</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4874744">if</span>&nbsp;<span class="ident" id="4874747">addr</span>&nbsp;<span class="op" id="4874752">==</span>&nbsp;<span class="string" id="4874755">&#34;&#34;</span>&nbsp;<span class="op" id="4874758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4874762">addr</span>&nbsp;<span class="op" id="4874767">=</span>&nbsp;<span class="string" id="4874769">&#34;:https&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4874779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4874782">config</span>&nbsp;<span class="op" id="4874789">:=</span>&nbsp;<span class="op" id="4874792">&amp;</span><span class="ident" id="4874793">tls</span><span class="op" id="4874796">.</span><span class="ident" id="4874797">Config</span><span class="op" id="4874803">{</span><span class="op" id="4874804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4874807">if</span>&nbsp;<span class="ident" id="4874810">srv</span><span class="op" id="4874813">.</span><span class="ident" id="4874814">TLSConfig</span>&nbsp;<span class="op" id="4874824">!=</span>&nbsp;<span class="ident" id="4874827">nil</span>&nbsp;<span class="op" id="4874831">{</span><br>
<span class="lineno">1860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4874835">*</span><span class="ident" id="4874836">config</span>&nbsp;<span class="op" id="4874843">=</span>&nbsp;<span class="op" id="4874845">*</span><span class="ident" id="4874846">srv</span><span class="op" id="4874849">.</span><span class="ident" id="4874850">TLSConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4874861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4874864">if</span>&nbsp;<span class="ident" id="4874867">config</span><span class="op" id="4874873">.</span><span class="ident" id="4874874">NextProtos</span>&nbsp;<span class="op" id="4874885">==</span>&nbsp;<span class="ident" id="4874888">nil</span>&nbsp;<span class="op" id="4874892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4874896">config</span><span class="op" id="4874902">.</span><span class="ident" id="4874903">NextProtos</span>&nbsp;<span class="op" id="4874914">=</span>&nbsp;<span class="op" id="4874916">[</span><span class="op" id="4874917">]</span><span class="builtintype" id="4874918">string</span><span class="op" id="4874924">{</span><span class="string" id="4874925">&#34;http/1.1&#34;</span><span class="op" id="4874935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4874938">}</span><br>
<span class="lineno">1865</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4874942">var</span>&nbsp;<span class="ident" id="4874946">err</span>&nbsp;<span class="builtintype" id="4874950">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4874957">config</span><span class="op" id="4874963">.</span><span class="ident" id="4874964">Certificates</span>&nbsp;<span class="op" id="4874977">=</span>&nbsp;<span class="builtinfunc" id="4874979">make</span><span class="op" id="4874983">(</span><span class="op" id="4874984">[</span><span class="op" id="4874985">]</span><span class="ident" id="4874986">tls</span><span class="op" id="4874989">.</span><span class="ident" id="4874990">Certificate</span><span class="op" id="4875001">,</span>&nbsp;<span class="num" id="4875003">1</span><span class="op" id="4875004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4875007">config</span><span class="op" id="4875013">.</span><span class="ident" id="4875014">Certificates</span><span class="op" id="4875026">[</span><span class="num" id="4875027">0</span><span class="op" id="4875028">]</span><span class="op" id="4875029">,</span>&nbsp;<span class="ident" id="4875031">err</span>&nbsp;<span class="op" id="4875035">=</span>&nbsp;<span class="ident" id="4875037">tls</span><span class="op" id="4875040">.</span><span class="ident" id="4875041">LoadX509KeyPair</span><span class="op" id="4875056">(</span><span class="ident" id="4875057">certFile</span><span class="op" id="4875065">,</span>&nbsp;<span class="ident" id="4875067">keyFile</span><span class="op" id="4875074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4875077">if</span>&nbsp;<span class="ident" id="4875080">err</span>&nbsp;<span class="op" id="4875084">!=</span>&nbsp;<span class="ident" id="4875087">nil</span>&nbsp;<span class="op" id="4875091">{</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4875095">return</span>&nbsp;<span class="ident" id="4875102">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4875107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4875111">ln</span><span class="op" id="4875113">,</span>&nbsp;<span class="ident" id="4875115">err</span>&nbsp;<span class="op" id="4875119">:=</span>&nbsp;<span class="ident" id="4875122">net</span><span class="op" id="4875125">.</span><span class="ident" id="4875126">Listen</span><span class="op" id="4875132">(</span><span class="string" id="4875133">&#34;tcp&#34;</span><span class="op" id="4875138">,</span>&nbsp;<span class="ident" id="4875140">addr</span><span class="op" id="4875144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4875147">if</span>&nbsp;<span class="ident" id="4875150">err</span>&nbsp;<span class="op" id="4875154">!=</span>&nbsp;<span class="ident" id="4875157">nil</span>&nbsp;<span class="op" id="4875161">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4875165">return</span>&nbsp;<span class="ident" id="4875172">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4875177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4875181">tlsListener</span>&nbsp;<span class="op" id="4875193">:=</span>&nbsp;<span class="ident" id="4875196">tls</span><span class="op" id="4875199">.</span><span class="ident" id="4875200">NewListener</span><span class="op" id="4875211">(</span><span class="ident" id="4875212">tcpKeepAliveListener</span><span class="op" id="4875232">{</span><span class="ident" id="4875233">ln</span><span class="op" id="4875235">.</span><span class="op" id="4875236">(</span><span class="op" id="4875237">*</span><span class="ident" id="4875238">net</span><span class="op" id="4875241">.</span><span class="ident" id="4875242">TCPListener</span><span class="op" id="4875253">)</span><span class="op" id="4875254">}</span><span class="op" id="4875255">,</span>&nbsp;<span class="ident" id="4875257">config</span><span class="op" id="4875263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4875266">return</span>&nbsp;<span class="ident" id="4875273">srv</span><span class="op" id="4875276">.</span><span class="ident" id="4875277">Serve</span><span class="op" id="4875282">(</span><span class="ident" id="4875283">tlsListener</span><span class="op" id="4875294">)</span><br>
<span class="lineno">1880</span><span class="op" id="4875296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4875299">//&nbsp;TimeoutHandler&nbsp;returns&nbsp;a&nbsp;Handler&nbsp;that&nbsp;runs&nbsp;h&nbsp;with&nbsp;the&nbsp;given&nbsp;time&nbsp;limit.</span><br>
<span class="lineno"></span><span class="comment" id="4875374">//</span><br>
<span class="lineno"></span><span class="comment" id="4875377">//&nbsp;The&nbsp;new&nbsp;Handler&nbsp;calls&nbsp;h.ServeHTTP&nbsp;to&nbsp;handle&nbsp;each&nbsp;request,&nbsp;but&nbsp;if&nbsp;a</span><br>
<span class="lineno">1885</span><span class="comment" id="4875447">//&nbsp;call&nbsp;runs&nbsp;for&nbsp;longer&nbsp;than&nbsp;its&nbsp;time&nbsp;limit,&nbsp;the&nbsp;handler&nbsp;responds&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="4875518">//&nbsp;a&nbsp;503&nbsp;Service&nbsp;Unavailable&nbsp;error&nbsp;and&nbsp;the&nbsp;given&nbsp;message&nbsp;in&nbsp;its&nbsp;body.</span><br>
<span class="lineno"></span><span class="comment" id="4875588">//&nbsp;(If&nbsp;msg&nbsp;is&nbsp;empty,&nbsp;a&nbsp;suitable&nbsp;default&nbsp;message&nbsp;will&nbsp;be&nbsp;sent.)</span><br>
<span class="lineno"></span><span class="comment" id="4875651">//&nbsp;After&nbsp;such&nbsp;a&nbsp;timeout,&nbsp;writes&nbsp;by&nbsp;h&nbsp;to&nbsp;its&nbsp;ResponseWriter&nbsp;will&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="4875722">//&nbsp;ErrHandlerTimeout.</span><br>
<span class="lineno">1890</span><span class="keyword" id="4875744">func</span>&nbsp;<span class="ident" id="4875749">TimeoutHandler</span><span class="op" id="4875763">(</span><span class="ident" id="4875764">h</span>&nbsp;<span class="ident" id="4875766">Handler</span><span class="op" id="4875773">,</span>&nbsp;<span class="ident" id="4875775">dt</span>&nbsp;<span class="ident" id="4875778">time</span><span class="op" id="4875782">.</span><span class="ident" id="4875783">Duration</span><span class="op" id="4875791">,</span>&nbsp;<span class="ident" id="4875793">msg</span>&nbsp;<span class="builtintype" id="4875797">string</span><span class="op" id="4875803">)</span>&nbsp;<span class="ident" id="4875805">Handler</span>&nbsp;<span class="op" id="4875813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4875816">f</span>&nbsp;<span class="op" id="4875818">:=</span>&nbsp;<span class="keyword" id="4875821">func</span><span class="op" id="4875825">(</span><span class="op" id="4875826">)</span>&nbsp;<span class="op" id="4875828">&lt;-</span><span class="keyword" id="4875830">chan</span>&nbsp;<span class="ident" id="4875835">time</span><span class="op" id="4875839">.</span><span class="ident" id="4875840">Time</span>&nbsp;<span class="op" id="4875845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4875849">return</span>&nbsp;<span class="ident" id="4875856">time</span><span class="op" id="4875860">.</span><span class="ident" id="4875861">After</span><span class="op" id="4875866">(</span><span class="ident" id="4875867">dt</span><span class="op" id="4875869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4875872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4875875">return</span>&nbsp;<span class="op" id="4875882">&amp;</span><span class="ident" id="4875883">timeoutHandler</span><span class="op" id="4875897">{</span><span class="ident" id="4875898">h</span><span class="op" id="4875899">,</span>&nbsp;<span class="ident" id="4875901">f</span><span class="op" id="4875902">,</span>&nbsp;<span class="ident" id="4875904">msg</span><span class="op" id="4875907">}</span><br>
<span class="lineno">1895</span><span class="op" id="4875909">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4875912">//&nbsp;ErrHandlerTimeout&nbsp;is&nbsp;returned&nbsp;on&nbsp;ResponseWriter&nbsp;Write&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="4875975">//&nbsp;in&nbsp;handlers&nbsp;which&nbsp;have&nbsp;timed&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="4876012">var</span>&nbsp;<span class="ident" id="4876016">ErrHandlerTimeout</span>&nbsp;<span class="op" id="4876034">=</span>&nbsp;<span class="ident" id="4876036">errors</span><span class="op" id="4876042">.</span><span class="ident" id="4876043">New</span><span class="op" id="4876046">(</span><span class="string" id="4876047">&#34;http:&nbsp;Handler&nbsp;timeout&#34;</span><span class="op" id="4876070">)</span><br>
<span class="lineno">1900</span><br>
<span class="lineno"></span><span class="keyword" id="4876073">type</span>&nbsp;<span class="ident" id="4876078">timeoutHandler</span>&nbsp;<span class="keyword" id="4876093">struct</span>&nbsp;<span class="op" id="4876100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4876103">handler</span>&nbsp;<span class="ident" id="4876111">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4876120">timeout</span>&nbsp;<span class="keyword" id="4876128">func</span><span class="op" id="4876132">(</span><span class="op" id="4876133">)</span>&nbsp;<span class="op" id="4876135">&lt;-</span><span class="keyword" id="4876137">chan</span>&nbsp;<span class="ident" id="4876142">time</span><span class="op" id="4876146">.</span><span class="ident" id="4876147">Time</span>&nbsp;<span class="comment" id="4876152">//&nbsp;returns&nbsp;channel&nbsp;producing&nbsp;a&nbsp;timeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4876192">body</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4876200">string</span><br>
<span class="lineno">1905</span><span class="op" id="4876207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4876210">func</span>&nbsp;<span class="op" id="4876215">(</span><span class="ident" id="4876216">h</span>&nbsp;<span class="op" id="4876218">*</span><span class="ident" id="4876219">timeoutHandler</span><span class="op" id="4876233">)</span>&nbsp;<span class="ident" id="4876235">errorBody</span><span class="op" id="4876244">(</span><span class="op" id="4876245">)</span>&nbsp;<span class="builtintype" id="4876247">string</span>&nbsp;<span class="op" id="4876254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4876257">if</span>&nbsp;<span class="ident" id="4876260">h</span><span class="op" id="4876261">.</span><span class="ident" id="4876262">body</span>&nbsp;<span class="op" id="4876267">!=</span>&nbsp;<span class="string" id="4876270">&#34;&#34;</span>&nbsp;<span class="op" id="4876273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4876277">return</span>&nbsp;<span class="ident" id="4876284">h</span><span class="op" id="4876285">.</span><span class="ident" id="4876286">body</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4876292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4876295">return</span>&nbsp;<span class="string" id="4876302">&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Timeout&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Timeout&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#34;</span><br>
<span class="lineno"></span><span class="op" id="4876382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4876385">func</span>&nbsp;<span class="op" id="4876390">(</span><span class="ident" id="4876391">h</span>&nbsp;<span class="op" id="4876393">*</span><span class="ident" id="4876394">timeoutHandler</span><span class="op" id="4876408">)</span>&nbsp;<span class="ident" id="4876410">ServeHTTP</span><span class="op" id="4876419">(</span><span class="ident" id="4876420">w</span>&nbsp;<span class="ident" id="4876422">ResponseWriter</span><span class="op" id="4876436">,</span>&nbsp;<span class="ident" id="4876438">r</span>&nbsp;<span class="op" id="4876440">*</span><span class="ident" id="4876441">Request</span><span class="op" id="4876448">)</span>&nbsp;<span class="op" id="4876450">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4876453">done</span>&nbsp;<span class="op" id="4876458">:=</span>&nbsp;<span class="builtinfunc" id="4876461">make</span><span class="op" id="4876465">(</span><span class="keyword" id="4876466">chan</span>&nbsp;<span class="builtintype" id="4876471">bool</span><span class="op" id="4876475">,</span>&nbsp;<span class="num" id="4876477">1</span><span class="op" id="4876478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4876481">tw</span>&nbsp;<span class="op" id="4876484">:=</span>&nbsp;<span class="op" id="4876487">&amp;</span><span class="ident" id="4876488">timeoutWriter</span><span class="op" id="4876501">{</span><span class="ident" id="4876502">w</span><span class="op" id="4876503">:</span>&nbsp;<span class="ident" id="4876505">w</span><span class="op" id="4876506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4876509">go</span>&nbsp;<span class="keyword" id="4876512">func</span><span class="op" id="4876516">(</span><span class="op" id="4876517">)</span>&nbsp;<span class="op" id="4876519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4876523">h</span><span class="op" id="4876524">.</span><span class="ident" id="4876525">handler</span><span class="op" id="4876532">.</span><span class="ident" id="4876533">ServeHTTP</span><span class="op" id="4876542">(</span><span class="ident" id="4876543">tw</span><span class="op" id="4876545">,</span>&nbsp;<span class="ident" id="4876547">r</span><span class="op" id="4876548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4876552">done</span>&nbsp;<span class="op" id="4876557">&lt;-</span>&nbsp;<span class="builtintype" id="4876560">true</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4876566">}</span><span class="op" id="4876567">(</span><span class="op" id="4876568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4876571">select</span>&nbsp;<span class="op" id="4876578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4876581">case</span>&nbsp;<span class="op" id="4876586">&lt;-</span><span class="ident" id="4876588">done</span><span class="op" id="4876592">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4876596">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4876604">case</span>&nbsp;<span class="op" id="4876609">&lt;-</span><span class="ident" id="4876611">h</span><span class="op" id="4876612">.</span><span class="ident" id="4876613">timeout</span><span class="op" id="4876620">(</span><span class="op" id="4876621">)</span><span class="op" id="4876622">:</span><br>
<span class="lineno">1925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4876626">tw</span><span class="op" id="4876628">.</span><span class="ident" id="4876629">mu</span><span class="op" id="4876631">.</span><span class="ident" id="4876632">Lock</span><span class="op" id="4876636">(</span><span class="op" id="4876637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4876641">defer</span>&nbsp;<span class="ident" id="4876647">tw</span><span class="op" id="4876649">.</span><span class="ident" id="4876650">mu</span><span class="op" id="4876652">.</span><span class="ident" id="4876653">Unlock</span><span class="op" id="4876659">(</span><span class="op" id="4876660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4876664">if</span>&nbsp;<span class="op" id="4876667">!</span><span class="ident" id="4876668">tw</span><span class="op" id="4876670">.</span><span class="ident" id="4876671">wroteHeader</span>&nbsp;<span class="op" id="4876683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4876688">tw</span><span class="op" id="4876690">.</span><span class="ident" id="4876691">w</span><span class="op" id="4876692">.</span><span class="ident" id="4876693">WriteHeader</span><span class="op" id="4876704">(</span><span class="ident" id="4876705">StatusServiceUnavailable</span><span class="op" id="4876729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4876734">tw</span><span class="op" id="4876736">.</span><span class="ident" id="4876737">w</span><span class="op" id="4876738">.</span><span class="ident" id="4876739">Write</span><span class="op" id="4876744">(</span><span class="op" id="4876745">[</span><span class="op" id="4876746">]</span><span class="builtintype" id="4876747">byte</span><span class="op" id="4876751">(</span><span class="ident" id="4876752">h</span><span class="op" id="4876753">.</span><span class="ident" id="4876754">errorBody</span><span class="op" id="4876763">(</span><span class="op" id="4876764">)</span><span class="op" id="4876765">)</span><span class="op" id="4876766">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4876770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4876774">tw</span><span class="op" id="4876776">.</span><span class="ident" id="4876777">timedOut</span>&nbsp;<span class="op" id="4876786">=</span>&nbsp;<span class="builtintype" id="4876788">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4876794">}</span><br>
<span class="lineno"></span><span class="op" id="4876796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1935</span><span class="keyword" id="4876799">type</span>&nbsp;<span class="ident" id="4876804">timeoutWriter</span>&nbsp;<span class="keyword" id="4876818">struct</span>&nbsp;<span class="op" id="4876825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4876828">w</span>&nbsp;<span class="ident" id="4876830">ResponseWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4876847">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4876859">sync</span><span class="op" id="4876863">.</span><span class="ident" id="4876864">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4876871">timedOut</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4876883">bool</span><br>
<span class="lineno">1940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4876889">wroteHeader</span>&nbsp;<span class="builtintype" id="4876901">bool</span><br>
<span class="lineno"></span><span class="op" id="4876906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4876909">func</span>&nbsp;<span class="op" id="4876914">(</span><span class="ident" id="4876915">tw</span>&nbsp;<span class="op" id="4876918">*</span><span class="ident" id="4876919">timeoutWriter</span><span class="op" id="4876932">)</span>&nbsp;<span class="ident" id="4876934">Header</span><span class="op" id="4876940">(</span><span class="op" id="4876941">)</span>&nbsp;<span class="ident" id="4876943">Header</span>&nbsp;<span class="op" id="4876950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4876953">return</span>&nbsp;<span class="ident" id="4876960">tw</span><span class="op" id="4876962">.</span><span class="ident" id="4876963">w</span><span class="op" id="4876964">.</span><span class="ident" id="4876965">Header</span><span class="op" id="4876971">(</span><span class="op" id="4876972">)</span><br>
<span class="lineno">1945</span><span class="op" id="4876974">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4876977">func</span>&nbsp;<span class="op" id="4876982">(</span><span class="ident" id="4876983">tw</span>&nbsp;<span class="op" id="4876986">*</span><span class="ident" id="4876987">timeoutWriter</span><span class="op" id="4877000">)</span>&nbsp;<span class="ident" id="4877002">Write</span><span class="op" id="4877007">(</span><span class="ident" id="4877008">p</span>&nbsp;<span class="op" id="4877010">[</span><span class="op" id="4877011">]</span><span class="builtintype" id="4877012">byte</span><span class="op" id="4877016">)</span>&nbsp;<span class="op" id="4877018">(</span><span class="builtintype" id="4877019">int</span><span class="op" id="4877022">,</span>&nbsp;<span class="builtintype" id="4877024">error</span><span class="op" id="4877029">)</span>&nbsp;<span class="op" id="4877031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4877034">tw</span><span class="op" id="4877036">.</span><span class="ident" id="4877037">mu</span><span class="op" id="4877039">.</span><span class="ident" id="4877040">Lock</span><span class="op" id="4877044">(</span><span class="op" id="4877045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4877048">defer</span>&nbsp;<span class="ident" id="4877054">tw</span><span class="op" id="4877056">.</span><span class="ident" id="4877057">mu</span><span class="op" id="4877059">.</span><span class="ident" id="4877060">Unlock</span><span class="op" id="4877066">(</span><span class="op" id="4877067">)</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4877070">tw</span><span class="op" id="4877072">.</span><span class="ident" id="4877073">wroteHeader</span>&nbsp;<span class="op" id="4877085">=</span>&nbsp;<span class="builtintype" id="4877087">true</span>&nbsp;<span class="comment" id="4877092">//&nbsp;implicitly&nbsp;at&nbsp;least</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4877116">if</span>&nbsp;<span class="ident" id="4877119">tw</span><span class="op" id="4877121">.</span><span class="ident" id="4877122">timedOut</span>&nbsp;<span class="op" id="4877131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4877135">return</span>&nbsp;<span class="num" id="4877142">0</span><span class="op" id="4877143">,</span>&nbsp;<span class="ident" id="4877145">ErrHandlerTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4877164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4877167">return</span>&nbsp;<span class="ident" id="4877174">tw</span><span class="op" id="4877176">.</span><span class="ident" id="4877177">w</span><span class="op" id="4877178">.</span><span class="ident" id="4877179">Write</span><span class="op" id="4877184">(</span><span class="ident" id="4877185">p</span><span class="op" id="4877186">)</span><br>
<span class="lineno">1955</span><span class="op" id="4877188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4877191">func</span>&nbsp;<span class="op" id="4877196">(</span><span class="ident" id="4877197">tw</span>&nbsp;<span class="op" id="4877200">*</span><span class="ident" id="4877201">timeoutWriter</span><span class="op" id="4877214">)</span>&nbsp;<span class="ident" id="4877216">WriteHeader</span><span class="op" id="4877227">(</span><span class="ident" id="4877228">code</span>&nbsp;<span class="builtintype" id="4877233">int</span><span class="op" id="4877236">)</span>&nbsp;<span class="op" id="4877238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4877241">tw</span><span class="op" id="4877243">.</span><span class="ident" id="4877244">mu</span><span class="op" id="4877246">.</span><span class="ident" id="4877247">Lock</span><span class="op" id="4877251">(</span><span class="op" id="4877252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4877255">defer</span>&nbsp;<span class="ident" id="4877261">tw</span><span class="op" id="4877263">.</span><span class="ident" id="4877264">mu</span><span class="op" id="4877266">.</span><span class="ident" id="4877267">Unlock</span><span class="op" id="4877273">(</span><span class="op" id="4877274">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4877277">if</span>&nbsp;<span class="ident" id="4877280">tw</span><span class="op" id="4877282">.</span><span class="ident" id="4877283">timedOut</span>&nbsp;<span class="op" id="4877292">||</span>&nbsp;<span class="ident" id="4877295">tw</span><span class="op" id="4877297">.</span><span class="ident" id="4877298">wroteHeader</span>&nbsp;<span class="op" id="4877310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4877314">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4877322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4877325">tw</span><span class="op" id="4877327">.</span><span class="ident" id="4877328">wroteHeader</span>&nbsp;<span class="op" id="4877340">=</span>&nbsp;<span class="builtintype" id="4877342">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4877348">tw</span><span class="op" id="4877350">.</span><span class="ident" id="4877351">w</span><span class="op" id="4877352">.</span><span class="ident" id="4877353">WriteHeader</span><span class="op" id="4877364">(</span><span class="ident" id="4877365">code</span><span class="op" id="4877369">)</span><br>
<span class="lineno">1965</span><span class="op" id="4877371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4877374">//&nbsp;tcpKeepAliveListener&nbsp;sets&nbsp;TCP&nbsp;keep-alive&nbsp;timeouts&nbsp;on&nbsp;accepted</span><br>
<span class="lineno"></span><span class="comment" id="4877439">//&nbsp;connections.&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;ListenAndServe&nbsp;and&nbsp;ListenAndServeTLS&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="4877508">//&nbsp;dead&nbsp;TCP&nbsp;connections&nbsp;(e.g.&nbsp;closing&nbsp;laptop&nbsp;mid-download)&nbsp;eventually</span><br>
<span class="lineno">1970</span><span class="comment" id="4877578">//&nbsp;go&nbsp;away.</span><br>
<span class="lineno"></span><span class="keyword" id="4877590">type</span>&nbsp;<span class="ident" id="4877595">tcpKeepAliveListener</span>&nbsp;<span class="keyword" id="4877616">struct</span>&nbsp;<span class="op" id="4877623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4877626">*</span><span class="ident" id="4877627">net</span><span class="op" id="4877630">.</span><span class="ident" id="4877631">TCPListener</span><br>
<span class="lineno"></span><span class="op" id="4877643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1975</span><span class="keyword" id="4877646">func</span>&nbsp;<span class="op" id="4877651">(</span><span class="ident" id="4877652">ln</span>&nbsp;<span class="ident" id="4877655">tcpKeepAliveListener</span><span class="op" id="4877675">)</span>&nbsp;<span class="ident" id="4877677">Accept</span><span class="op" id="4877683">(</span><span class="op" id="4877684">)</span>&nbsp;<span class="op" id="4877686">(</span><span class="ident" id="4877687">c</span>&nbsp;<span class="ident" id="4877689">net</span><span class="op" id="4877692">.</span><span class="ident" id="4877693">Conn</span><span class="op" id="4877697">,</span>&nbsp;<span class="ident" id="4877699">err</span>&nbsp;<span class="builtintype" id="4877703">error</span><span class="op" id="4877708">)</span>&nbsp;<span class="op" id="4877710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4877713">tc</span><span class="op" id="4877715">,</span>&nbsp;<span class="ident" id="4877717">err</span>&nbsp;<span class="op" id="4877721">:=</span>&nbsp;<span class="ident" id="4877724">ln</span><span class="op" id="4877726">.</span><span class="ident" id="4877727">AcceptTCP</span><span class="op" id="4877736">(</span><span class="op" id="4877737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4877740">if</span>&nbsp;<span class="ident" id="4877743">err</span>&nbsp;<span class="op" id="4877747">!=</span>&nbsp;<span class="ident" id="4877750">nil</span>&nbsp;<span class="op" id="4877754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4877758">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4877766">}</span><br>
<span class="lineno">1980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4877769">tc</span><span class="op" id="4877771">.</span><span class="ident" id="4877772">SetKeepAlive</span><span class="op" id="4877784">(</span><span class="builtintype" id="4877785">true</span><span class="op" id="4877789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4877792">tc</span><span class="op" id="4877794">.</span><span class="ident" id="4877795">SetKeepAlivePeriod</span><span class="op" id="4877813">(</span><span class="num" id="4877814">3</span>&nbsp;<span class="op" id="4877816">*</span>&nbsp;<span class="ident" id="4877818">time</span><span class="op" id="4877822">.</span><span class="ident" id="4877823">Minute</span><span class="op" id="4877829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4877832">return</span>&nbsp;<span class="ident" id="4877839">tc</span><span class="op" id="4877841">,</span>&nbsp;<span class="ident" id="4877843">nil</span><br>
<span class="lineno"></span><span class="op" id="4877847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1985</span><span class="comment" id="4877850">//&nbsp;globalOptionsHandler&nbsp;responds&nbsp;to&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="4877908">type</span>&nbsp;<span class="ident" id="4877913">globalOptionsHandler</span>&nbsp;<span class="keyword" id="4877934">struct</span><span class="op" id="4877940">{</span><span class="op" id="4877941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4877944">func</span>&nbsp;<span class="op" id="4877949">(</span><span class="ident" id="4877950">globalOptionsHandler</span><span class="op" id="4877970">)</span>&nbsp;<span class="ident" id="4877972">ServeHTTP</span><span class="op" id="4877981">(</span><span class="ident" id="4877982">w</span>&nbsp;<span class="ident" id="4877984">ResponseWriter</span><span class="op" id="4877998">,</span>&nbsp;<span class="ident" id="4878000">r</span>&nbsp;<span class="op" id="4878002">*</span><span class="ident" id="4878003">Request</span><span class="op" id="4878010">)</span>&nbsp;<span class="op" id="4878012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4878015">w</span><span class="op" id="4878016">.</span><span class="ident" id="4878017">Header</span><span class="op" id="4878023">(</span><span class="op" id="4878024">)</span><span class="op" id="4878025">.</span><span class="ident" id="4878026">Set</span><span class="op" id="4878029">(</span><span class="string" id="4878030">&#34;Content-Length&#34;</span><span class="op" id="4878046">,</span>&nbsp;<span class="string" id="4878048">&#34;0&#34;</span><span class="op" id="4878051">)</span><br>
<span class="lineno">1990</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4878054">if</span>&nbsp;<span class="ident" id="4878057">r</span><span class="op" id="4878058">.</span><span class="ident" id="4878059">ContentLength</span>&nbsp;<span class="op" id="4878073">!=</span>&nbsp;<span class="num" id="4878076">0</span>&nbsp;<span class="op" id="4878078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4878082">//&nbsp;Read&nbsp;up&nbsp;to&nbsp;4KB&nbsp;of&nbsp;OPTIONS&nbsp;body&nbsp;(as&nbsp;mentioned&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4878139">//&nbsp;spec&nbsp;as&nbsp;being&nbsp;reserved&nbsp;for&nbsp;future&nbsp;use),&nbsp;but&nbsp;anything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4878197">//&nbsp;over&nbsp;that&nbsp;is&nbsp;considered&nbsp;a&nbsp;waste&nbsp;of&nbsp;server&nbsp;resources</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4878254">//&nbsp;(or&nbsp;an&nbsp;attack)&nbsp;and&nbsp;we&nbsp;abort&nbsp;and&nbsp;close&nbsp;the&nbsp;connection,</span><br>
<span class="lineno">1995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4878313">//&nbsp;courtesy&nbsp;of&nbsp;MaxBytesReader&#39;s&nbsp;EOF&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4878361">mb</span>&nbsp;<span class="op" id="4878364">:=</span>&nbsp;<span class="ident" id="4878367">MaxBytesReader</span><span class="op" id="4878381">(</span><span class="ident" id="4878382">w</span><span class="op" id="4878383">,</span>&nbsp;<span class="ident" id="4878385">r</span><span class="op" id="4878386">.</span><span class="ident" id="4878387">Body</span><span class="op" id="4878391">,</span>&nbsp;<span class="num" id="4878393">4</span><span class="op" id="4878394">&lt;&lt;</span><span class="num" id="4878396">10</span><span class="op" id="4878398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4878402">io</span><span class="op" id="4878404">.</span><span class="ident" id="4878405">Copy</span><span class="op" id="4878409">(</span><span class="ident" id="4878410">ioutil</span><span class="op" id="4878416">.</span><span class="ident" id="4878417">Discard</span><span class="op" id="4878424">,</span>&nbsp;<span class="ident" id="4878426">mb</span><span class="op" id="4878428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4878431">}</span><br>
<span class="lineno"></span><span class="op" id="4878433">}</span><br>
<span class="lineno">2000</span><br>
<span class="lineno"></span><span class="keyword" id="4878436">type</span>&nbsp;<span class="ident" id="4878441">eofReaderWithWriteTo</span>&nbsp;<span class="keyword" id="4878462">struct</span><span class="op" id="4878468">{</span><span class="op" id="4878469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4878472">func</span>&nbsp;<span class="op" id="4878477">(</span><span class="ident" id="4878478">eofReaderWithWriteTo</span><span class="op" id="4878498">)</span>&nbsp;<span class="ident" id="4878500">WriteTo</span><span class="op" id="4878507">(</span><span class="ident" id="4878508">io</span><span class="op" id="4878510">.</span><span class="ident" id="4878511">Writer</span><span class="op" id="4878517">)</span>&nbsp;<span class="op" id="4878519">(</span><span class="ident" id="4878520">int64</span><span class="op" id="4878525">,</span>&nbsp;<span class="builtintype" id="4878527">error</span><span class="op" id="4878532">)</span>&nbsp;<span class="op" id="4878534">{</span>&nbsp;<span class="keyword" id="4878536">return</span>&nbsp;<span class="num" id="4878543">0</span><span class="op" id="4878544">,</span>&nbsp;<span class="ident" id="4878546">nil</span>&nbsp;<span class="op" id="4878550">}</span><br>
<span class="lineno"></span><span class="keyword" id="4878552">func</span>&nbsp;<span class="op" id="4878557">(</span><span class="ident" id="4878558">eofReaderWithWriteTo</span><span class="op" id="4878578">)</span>&nbsp;<span class="ident" id="4878580">Read</span><span class="op" id="4878584">(</span><span class="op" id="4878585">[</span><span class="op" id="4878586">]</span><span class="builtintype" id="4878587">byte</span><span class="op" id="4878591">)</span>&nbsp;<span class="op" id="4878593">(</span><span class="builtintype" id="4878594">int</span><span class="op" id="4878597">,</span>&nbsp;<span class="builtintype" id="4878599">error</span><span class="op" id="4878604">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4878614">{</span>&nbsp;<span class="keyword" id="4878616">return</span>&nbsp;<span class="num" id="4878623">0</span><span class="op" id="4878624">,</span>&nbsp;<span class="ident" id="4878626">io</span><span class="op" id="4878628">.</span><span class="ident" id="4878629">EOF</span>&nbsp;<span class="op" id="4878633">}</span><br>
<span class="lineno">2005</span><br>
<span class="lineno"></span><span class="comment" id="4878636">//&nbsp;eofReader&nbsp;is&nbsp;a&nbsp;non-nil&nbsp;io.ReadCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="comment" id="4878701">//&nbsp;It&nbsp;has&nbsp;a&nbsp;WriteTo&nbsp;method&nbsp;so&nbsp;io.Copy&nbsp;won&#39;t&nbsp;need&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="4878760">var</span>&nbsp;<span class="ident" id="4878764">eofReader</span>&nbsp;<span class="op" id="4878774">=</span>&nbsp;<span class="op" id="4878776">&amp;</span><span class="keyword" id="4878777">struct</span>&nbsp;<span class="op" id="4878784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4878787">eofReaderWithWriteTo</span><br>
<span class="lineno">2010</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4878809">io</span><span class="op" id="4878811">.</span><span class="ident" id="4878812">Closer</span><br>
<span class="lineno"></span><span class="op" id="4878819">}</span><span class="op" id="4878820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4878823">eofReaderWithWriteTo</span><span class="op" id="4878843">{</span><span class="op" id="4878844">}</span><span class="op" id="4878845">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4878848">ioutil</span><span class="op" id="4878854">.</span><span class="ident" id="4878855">NopCloser</span><span class="op" id="4878864">(</span><span class="ident" id="4878865">nil</span><span class="op" id="4878868">)</span><span class="op" id="4878869">,</span><br>
<span class="lineno"></span><span class="op" id="4878871">}</span><br>
<span class="lineno">2015</span><br>
<span class="lineno"></span><span class="comment" id="4878874">//&nbsp;Verify&nbsp;that&nbsp;an&nbsp;io.Copy&nbsp;from&nbsp;an&nbsp;eofReader&nbsp;won&#39;t&nbsp;require&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="4878942">var</span>&nbsp;<span class="ident" id="4878946">_</span>&nbsp;<span class="ident" id="4878948">io</span><span class="op" id="4878950">.</span><span class="ident" id="4878951">WriterTo</span>&nbsp;<span class="op" id="4878960">=</span>&nbsp;<span class="ident" id="4878962">eofReader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4878973">//&nbsp;initNPNRequest&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;that&nbsp;initializes&nbsp;certain</span><br>
<span class="lineno">2020</span><span class="comment" id="4879035">//&nbsp;uninitialized&nbsp;fields&nbsp;in&nbsp;its&nbsp;*Request.&nbsp;Such&nbsp;partially-initialized</span><br>
<span class="lineno"></span><span class="comment" id="4879103">//&nbsp;Requests&nbsp;come&nbsp;from&nbsp;NPN&nbsp;protocol&nbsp;handlers.</span><br>
<span class="lineno"></span><span class="keyword" id="4879148">type</span>&nbsp;<span class="ident" id="4879153">initNPNRequest</span>&nbsp;<span class="keyword" id="4879168">struct</span>&nbsp;<span class="op" id="4879175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879178">c</span>&nbsp;<span class="op" id="4879180">*</span><span class="ident" id="4879181">tls</span><span class="op" id="4879184">.</span><span class="ident" id="4879185">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879191">h</span>&nbsp;<span class="ident" id="4879193">serverHandler</span><br>
<span class="lineno">2025</span><span class="op" id="4879207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4879210">func</span>&nbsp;<span class="op" id="4879215">(</span><span class="ident" id="4879216">h</span>&nbsp;<span class="ident" id="4879218">initNPNRequest</span><span class="op" id="4879232">)</span>&nbsp;<span class="ident" id="4879234">ServeHTTP</span><span class="op" id="4879243">(</span><span class="ident" id="4879244">rw</span>&nbsp;<span class="ident" id="4879247">ResponseWriter</span><span class="op" id="4879261">,</span>&nbsp;<span class="ident" id="4879263">req</span>&nbsp;<span class="op" id="4879267">*</span><span class="ident" id="4879268">Request</span><span class="op" id="4879275">)</span>&nbsp;<span class="op" id="4879277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4879280">if</span>&nbsp;<span class="ident" id="4879283">req</span><span class="op" id="4879286">.</span><span class="ident" id="4879287">TLS</span>&nbsp;<span class="op" id="4879291">==</span>&nbsp;<span class="ident" id="4879294">nil</span>&nbsp;<span class="op" id="4879298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879302">req</span><span class="op" id="4879305">.</span><span class="ident" id="4879306">TLS</span>&nbsp;<span class="op" id="4879310">=</span>&nbsp;<span class="op" id="4879312">&amp;</span><span class="ident" id="4879313">tls</span><span class="op" id="4879316">.</span><span class="ident" id="4879317">ConnectionState</span><span class="op" id="4879332">{</span><span class="op" id="4879333">}</span><br>
<span class="lineno">2030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4879337">*</span><span class="ident" id="4879338">req</span><span class="op" id="4879341">.</span><span class="ident" id="4879342">TLS</span>&nbsp;<span class="op" id="4879346">=</span>&nbsp;<span class="ident" id="4879348">h</span><span class="op" id="4879349">.</span><span class="ident" id="4879350">c</span><span class="op" id="4879351">.</span><span class="ident" id="4879352">ConnectionState</span><span class="op" id="4879367">(</span><span class="op" id="4879368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4879371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4879374">if</span>&nbsp;<span class="ident" id="4879377">req</span><span class="op" id="4879380">.</span><span class="ident" id="4879381">Body</span>&nbsp;<span class="op" id="4879386">==</span>&nbsp;<span class="ident" id="4879389">nil</span>&nbsp;<span class="op" id="4879393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879397">req</span><span class="op" id="4879400">.</span><span class="ident" id="4879401">Body</span>&nbsp;<span class="op" id="4879406">=</span>&nbsp;<span class="ident" id="4879408">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4879419">}</span><br>
<span class="lineno">2035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4879422">if</span>&nbsp;<span class="ident" id="4879425">req</span><span class="op" id="4879428">.</span><span class="ident" id="4879429">RemoteAddr</span>&nbsp;<span class="op" id="4879440">==</span>&nbsp;<span class="string" id="4879443">&#34;&#34;</span>&nbsp;<span class="op" id="4879446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879450">req</span><span class="op" id="4879453">.</span><span class="ident" id="4879454">RemoteAddr</span>&nbsp;<span class="op" id="4879465">=</span>&nbsp;<span class="ident" id="4879467">h</span><span class="op" id="4879468">.</span><span class="ident" id="4879469">c</span><span class="op" id="4879470">.</span><span class="ident" id="4879471">RemoteAddr</span><span class="op" id="4879481">(</span><span class="op" id="4879482">)</span><span class="op" id="4879483">.</span><span class="ident" id="4879484">String</span><span class="op" id="4879490">(</span><span class="op" id="4879491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4879494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879497">h</span><span class="op" id="4879498">.</span><span class="ident" id="4879499">h</span><span class="op" id="4879500">.</span><span class="ident" id="4879501">ServeHTTP</span><span class="op" id="4879510">(</span><span class="ident" id="4879511">rw</span><span class="op" id="4879513">,</span>&nbsp;<span class="ident" id="4879515">req</span><span class="op" id="4879518">)</span><br>
<span class="lineno"></span><span class="op" id="4879520">}</span><br>
<span class="lineno">2040</span><br>
<span class="lineno"></span><span class="comment" id="4879523">//&nbsp;loggingConn&nbsp;is&nbsp;used&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="keyword" id="4879561">type</span>&nbsp;<span class="ident" id="4879566">loggingConn</span>&nbsp;<span class="keyword" id="4879578">struct</span>&nbsp;<span class="op" id="4879585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879588">name</span>&nbsp;<span class="builtintype" id="4879593">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879601">net</span><span class="op" id="4879604">.</span><span class="ident" id="4879605">Conn</span><br>
<span class="lineno">2045</span><span class="op" id="4879610">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4879613">var</span>&nbsp;<span class="op" id="4879617">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879620">uniqNameMu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4879633">sync</span><span class="op" id="4879637">.</span><span class="ident" id="4879638">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879645">uniqNameNext</span>&nbsp;<span class="op" id="4879658">=</span>&nbsp;<span class="builtinfunc" id="4879660">make</span><span class="op" id="4879664">(</span><span class="keyword" id="4879665">map</span><span class="op" id="4879668">[</span><span class="builtintype" id="4879669">string</span><span class="op" id="4879675">]</span><span class="builtintype" id="4879676">int</span><span class="op" id="4879679">)</span><br>
<span class="lineno">2050</span><span class="op" id="4879681">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4879684">func</span>&nbsp;<span class="ident" id="4879689">newLoggingConn</span><span class="op" id="4879703">(</span><span class="ident" id="4879704">baseName</span>&nbsp;<span class="builtintype" id="4879713">string</span><span class="op" id="4879719">,</span>&nbsp;<span class="ident" id="4879721">c</span>&nbsp;<span class="ident" id="4879723">net</span><span class="op" id="4879726">.</span><span class="ident" id="4879727">Conn</span><span class="op" id="4879731">)</span>&nbsp;<span class="ident" id="4879733">net</span><span class="op" id="4879736">.</span><span class="ident" id="4879737">Conn</span>&nbsp;<span class="op" id="4879742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879745">uniqNameMu</span><span class="op" id="4879755">.</span><span class="ident" id="4879756">Lock</span><span class="op" id="4879760">(</span><span class="op" id="4879761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4879764">defer</span>&nbsp;<span class="ident" id="4879770">uniqNameMu</span><span class="op" id="4879780">.</span><span class="ident" id="4879781">Unlock</span><span class="op" id="4879787">(</span><span class="op" id="4879788">)</span><br>
<span class="lineno">2055</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879791">uniqNameNext</span><span class="op" id="4879803">[</span><span class="ident" id="4879804">baseName</span><span class="op" id="4879812">]</span><span class="op" id="4879813">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4879817">return</span>&nbsp;<span class="op" id="4879824">&amp;</span><span class="ident" id="4879825">loggingConn</span><span class="op" id="4879836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879840">name</span><span class="op" id="4879844">:</span>&nbsp;<span class="ident" id="4879846">fmt</span><span class="op" id="4879849">.</span><span class="ident" id="4879850">Sprintf</span><span class="op" id="4879857">(</span><span class="string" id="4879858">&#34;%s-%d&#34;</span><span class="op" id="4879865">,</span>&nbsp;<span class="ident" id="4879867">baseName</span><span class="op" id="4879875">,</span>&nbsp;<span class="ident" id="4879877">uniqNameNext</span><span class="op" id="4879889">[</span><span class="ident" id="4879890">baseName</span><span class="op" id="4879898">]</span><span class="op" id="4879899">)</span><span class="op" id="4879900">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879904">Conn</span><span class="op" id="4879908">:</span>&nbsp;<span class="ident" id="4879910">c</span><span class="op" id="4879911">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4879914">}</span><br>
<span class="lineno">2060</span><span class="op" id="4879916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4879919">func</span>&nbsp;<span class="op" id="4879924">(</span><span class="ident" id="4879925">c</span>&nbsp;<span class="op" id="4879927">*</span><span class="ident" id="4879928">loggingConn</span><span class="op" id="4879939">)</span>&nbsp;<span class="ident" id="4879941">Write</span><span class="op" id="4879946">(</span><span class="ident" id="4879947">p</span>&nbsp;<span class="op" id="4879949">[</span><span class="op" id="4879950">]</span><span class="builtintype" id="4879951">byte</span><span class="op" id="4879955">)</span>&nbsp;<span class="op" id="4879957">(</span><span class="ident" id="4879958">n</span>&nbsp;<span class="builtintype" id="4879960">int</span><span class="op" id="4879963">,</span>&nbsp;<span class="ident" id="4879965">err</span>&nbsp;<span class="builtintype" id="4879969">error</span><span class="op" id="4879974">)</span>&nbsp;<span class="op" id="4879976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4879979">log</span><span class="op" id="4879982">.</span><span class="ident" id="4879983">Printf</span><span class="op" id="4879989">(</span><span class="string" id="4879990">&#34;%s.Write(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="4880011">,</span>&nbsp;<span class="ident" id="4880013">c</span><span class="op" id="4880014">.</span><span class="ident" id="4880015">name</span><span class="op" id="4880019">,</span>&nbsp;<span class="builtinfunc" id="4880021">len</span><span class="op" id="4880024">(</span><span class="ident" id="4880025">p</span><span class="op" id="4880026">)</span><span class="op" id="4880027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4880030">n</span><span class="op" id="4880031">,</span>&nbsp;<span class="ident" id="4880033">err</span>&nbsp;<span class="op" id="4880037">=</span>&nbsp;<span class="ident" id="4880039">c</span><span class="op" id="4880040">.</span><span class="ident" id="4880041">Conn</span><span class="op" id="4880045">.</span><span class="ident" id="4880046">Write</span><span class="op" id="4880051">(</span><span class="ident" id="4880052">p</span><span class="op" id="4880053">)</span><br>
<span class="lineno">2065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4880056">log</span><span class="op" id="4880059">.</span><span class="ident" id="4880060">Printf</span><span class="op" id="4880066">(</span><span class="string" id="4880067">&#34;%s.Write(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="4880090">,</span>&nbsp;<span class="ident" id="4880092">c</span><span class="op" id="4880093">.</span><span class="ident" id="4880094">name</span><span class="op" id="4880098">,</span>&nbsp;<span class="builtinfunc" id="4880100">len</span><span class="op" id="4880103">(</span><span class="ident" id="4880104">p</span><span class="op" id="4880105">)</span><span class="op" id="4880106">,</span>&nbsp;<span class="ident" id="4880108">n</span><span class="op" id="4880109">,</span>&nbsp;<span class="ident" id="4880111">err</span><span class="op" id="4880114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4880117">return</span><br>
<span class="lineno"></span><span class="op" id="4880124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4880127">func</span>&nbsp;<span class="op" id="4880132">(</span><span class="ident" id="4880133">c</span>&nbsp;<span class="op" id="4880135">*</span><span class="ident" id="4880136">loggingConn</span><span class="op" id="4880147">)</span>&nbsp;<span class="ident" id="4880149">Read</span><span class="op" id="4880153">(</span><span class="ident" id="4880154">p</span>&nbsp;<span class="op" id="4880156">[</span><span class="op" id="4880157">]</span><span class="builtintype" id="4880158">byte</span><span class="op" id="4880162">)</span>&nbsp;<span class="op" id="4880164">(</span><span class="ident" id="4880165">n</span>&nbsp;<span class="builtintype" id="4880167">int</span><span class="op" id="4880170">,</span>&nbsp;<span class="ident" id="4880172">err</span>&nbsp;<span class="builtintype" id="4880176">error</span><span class="op" id="4880181">)</span>&nbsp;<span class="op" id="4880183">{</span><br>
<span class="lineno">2070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4880186">log</span><span class="op" id="4880189">.</span><span class="ident" id="4880190">Printf</span><span class="op" id="4880196">(</span><span class="string" id="4880197">&#34;%s.Read(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="4880217">,</span>&nbsp;<span class="ident" id="4880219">c</span><span class="op" id="4880220">.</span><span class="ident" id="4880221">name</span><span class="op" id="4880225">,</span>&nbsp;<span class="builtinfunc" id="4880227">len</span><span class="op" id="4880230">(</span><span class="ident" id="4880231">p</span><span class="op" id="4880232">)</span><span class="op" id="4880233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4880236">n</span><span class="op" id="4880237">,</span>&nbsp;<span class="ident" id="4880239">err</span>&nbsp;<span class="op" id="4880243">=</span>&nbsp;<span class="ident" id="4880245">c</span><span class="op" id="4880246">.</span><span class="ident" id="4880247">Conn</span><span class="op" id="4880251">.</span><span class="ident" id="4880252">Read</span><span class="op" id="4880256">(</span><span class="ident" id="4880257">p</span><span class="op" id="4880258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4880261">log</span><span class="op" id="4880264">.</span><span class="ident" id="4880265">Printf</span><span class="op" id="4880271">(</span><span class="string" id="4880272">&#34;%s.Read(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="4880294">,</span>&nbsp;<span class="ident" id="4880296">c</span><span class="op" id="4880297">.</span><span class="ident" id="4880298">name</span><span class="op" id="4880302">,</span>&nbsp;<span class="builtinfunc" id="4880304">len</span><span class="op" id="4880307">(</span><span class="ident" id="4880308">p</span><span class="op" id="4880309">)</span><span class="op" id="4880310">,</span>&nbsp;<span class="ident" id="4880312">n</span><span class="op" id="4880313">,</span>&nbsp;<span class="ident" id="4880315">err</span><span class="op" id="4880318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4880321">return</span><br>
<span class="lineno"></span><span class="op" id="4880328">}</span><br>
<span class="lineno">2075</span><br>
<span class="lineno"></span><span class="keyword" id="4880331">func</span>&nbsp;<span class="op" id="4880336">(</span><span class="ident" id="4880337">c</span>&nbsp;<span class="op" id="4880339">*</span><span class="ident" id="4880340">loggingConn</span><span class="op" id="4880351">)</span>&nbsp;<span class="ident" id="4880353">Close</span><span class="op" id="4880358">(</span><span class="op" id="4880359">)</span>&nbsp;<span class="op" id="4880361">(</span><span class="ident" id="4880362">err</span>&nbsp;<span class="builtintype" id="4880366">error</span><span class="op" id="4880371">)</span>&nbsp;<span class="op" id="4880373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4880376">log</span><span class="op" id="4880379">.</span><span class="ident" id="4880380">Printf</span><span class="op" id="4880386">(</span><span class="string" id="4880387">&#34;%s.Close()&nbsp;=&nbsp;...&#34;</span><span class="op" id="4880405">,</span>&nbsp;<span class="ident" id="4880407">c</span><span class="op" id="4880408">.</span><span class="ident" id="4880409">name</span><span class="op" id="4880413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4880416">err</span>&nbsp;<span class="op" id="4880420">=</span>&nbsp;<span class="ident" id="4880422">c</span><span class="op" id="4880423">.</span><span class="ident" id="4880424">Conn</span><span class="op" id="4880428">.</span><span class="ident" id="4880429">Close</span><span class="op" id="4880434">(</span><span class="op" id="4880435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4880438">log</span><span class="op" id="4880441">.</span><span class="ident" id="4880442">Printf</span><span class="op" id="4880448">(</span><span class="string" id="4880449">&#34;%s.Close()&nbsp;=&nbsp;%v&#34;</span><span class="op" id="4880466">,</span>&nbsp;<span class="ident" id="4880468">c</span><span class="op" id="4880469">.</span><span class="ident" id="4880470">name</span><span class="op" id="4880474">,</span>&nbsp;<span class="ident" id="4880476">err</span><span class="op" id="4880479">)</span><br>
<span class="lineno">2080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4880482">return</span><br>
<span class="lineno"></span><span class="op" id="4880489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4880492">//&nbsp;checkConnErrorWriter&nbsp;writes&nbsp;to&nbsp;c.rwc&nbsp;and&nbsp;records&nbsp;any&nbsp;write&nbsp;errors&nbsp;to&nbsp;c.werr.</span><br>
<span class="lineno"></span><span class="comment" id="4880572">//&nbsp;It&nbsp;only&nbsp;contains&nbsp;one&nbsp;field&nbsp;(and&nbsp;a&nbsp;pointer&nbsp;field&nbsp;at&nbsp;that),&nbsp;so&nbsp;it</span><br>
<span class="lineno">2085</span><span class="comment" id="4880639">//&nbsp;fits&nbsp;in&nbsp;an&nbsp;interface&nbsp;value&nbsp;without&nbsp;an&nbsp;extra&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="4880698">type</span>&nbsp;<span class="ident" id="4880703">checkConnErrorWriter</span>&nbsp;<span class="keyword" id="4880724">struct</span>&nbsp;<span class="op" id="4880731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4880734">c</span>&nbsp;<span class="op" id="4880736">*</span><span class="ident" id="4880737">conn</span><br>
<span class="lineno"></span><span class="op" id="4880742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2090</span><span class="keyword" id="4880745">func</span>&nbsp;<span class="op" id="4880750">(</span><span class="ident" id="4880751">w</span>&nbsp;<span class="ident" id="4880753">checkConnErrorWriter</span><span class="op" id="4880773">)</span>&nbsp;<span class="ident" id="4880775">Write</span><span class="op" id="4880780">(</span><span class="ident" id="4880781">p</span>&nbsp;<span class="op" id="4880783">[</span><span class="op" id="4880784">]</span><span class="builtintype" id="4880785">byte</span><span class="op" id="4880789">)</span>&nbsp;<span class="op" id="4880791">(</span><span class="ident" id="4880792">n</span>&nbsp;<span class="builtintype" id="4880794">int</span><span class="op" id="4880797">,</span>&nbsp;<span class="ident" id="4880799">err</span>&nbsp;<span class="builtintype" id="4880803">error</span><span class="op" id="4880808">)</span>&nbsp;<span class="op" id="4880810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4880813">n</span><span class="op" id="4880814">,</span>&nbsp;<span class="ident" id="4880816">err</span>&nbsp;<span class="op" id="4880820">=</span>&nbsp;<span class="ident" id="4880822">w</span><span class="op" id="4880823">.</span><span class="ident" id="4880824">c</span><span class="op" id="4880825">.</span><span class="ident" id="4880826">w</span><span class="op" id="4880827">.</span><span class="ident" id="4880828">Write</span><span class="op" id="4880833">(</span><span class="ident" id="4880834">p</span><span class="op" id="4880835">)</span>&nbsp;<span class="comment" id="4880837">//&nbsp;c.w&nbsp;==&nbsp;c.rwc,&nbsp;except&nbsp;after&nbsp;a&nbsp;hijack,&nbsp;when&nbsp;rwc&nbsp;is&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4880895">if</span>&nbsp;<span class="ident" id="4880898">err</span>&nbsp;<span class="op" id="4880902">!=</span>&nbsp;<span class="ident" id="4880905">nil</span>&nbsp;<span class="op" id="4880909">&amp;&amp;</span>&nbsp;<span class="ident" id="4880912">w</span><span class="op" id="4880913">.</span><span class="ident" id="4880914">c</span><span class="op" id="4880915">.</span><span class="ident" id="4880916">werr</span>&nbsp;<span class="op" id="4880921">==</span>&nbsp;<span class="ident" id="4880924">nil</span>&nbsp;<span class="op" id="4880928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4880932">w</span><span class="op" id="4880933">.</span><span class="ident" id="4880934">c</span><span class="op" id="4880935">.</span><span class="ident" id="4880936">werr</span>&nbsp;<span class="op" id="4880941">=</span>&nbsp;<span class="ident" id="4880943">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4880948">}</span><br>
<span class="lineno">2095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4880951">return</span><br>
<span class="lineno"></span><span class="op" id="4880958">}</span>
</div>
</body>
</html>
