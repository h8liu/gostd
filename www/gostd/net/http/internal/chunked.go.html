<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4231748">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4231803">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4231857">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4231908">//&nbsp;The&nbsp;wire&nbsp;protocol&nbsp;for&nbsp;HTTP&#39;s&nbsp;&#34;chunked&#34;&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4231970">//&nbsp;Package&nbsp;internal&nbsp;contains&nbsp;HTTP&nbsp;internals&nbsp;shared&nbsp;by&nbsp;net/http&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4232037">//&nbsp;net/http/httputil.</span><br>
<span class="lineno"></span><span class="keyword" id="4232059">package</span>&nbsp;<span class="ident" id="4232067">internal</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="4232077">import</span>&nbsp;<span class="op" id="4232084">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4232087">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4232096">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4232105">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4232115">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4232122">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4232127">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4232130">const</span>&nbsp;<span class="ident" id="4232136">maxLineLength</span>&nbsp;<span class="op" id="4232150">=</span>&nbsp;<span class="num" id="4232152">4096</span>&nbsp;<span class="comment" id="4232157">//&nbsp;assumed&nbsp;&lt;=&nbsp;bufio.defaultBufSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4232193">var</span>&nbsp;<span class="ident" id="4232197">ErrLineTooLong</span>&nbsp;<span class="op" id="4232212">=</span>&nbsp;<span class="ident" id="4232214">errors</span><span class="op" id="4232220">.</span><span class="ident" id="4232221">New</span><span class="op" id="4232224">(</span><span class="string" id="4232225">&#34;header&nbsp;line&nbsp;too&nbsp;long&#34;</span><span class="op" id="4232247">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4232250">//&nbsp;NewChunkedReader&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedReader&nbsp;that&nbsp;translates&nbsp;the&nbsp;data&nbsp;read&nbsp;from&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="4232335">//&nbsp;out&nbsp;of&nbsp;HTTP&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;returning&nbsp;it.</span><br>
<span class="lineno">25</span><span class="comment" id="4232388">//&nbsp;The&nbsp;chunkedReader&nbsp;returns&nbsp;io.EOF&nbsp;when&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;is&nbsp;read.</span><br>
<span class="lineno"></span><span class="comment" id="4232463">//</span><br>
<span class="lineno"></span><span class="comment" id="4232466">//&nbsp;NewChunkedReader&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="4232541">//&nbsp;automatically&nbsp;decodes&nbsp;chunking&nbsp;when&nbsp;reading&nbsp;response&nbsp;bodies.</span><br>
<span class="lineno"></span><span class="keyword" id="4232605">func</span>&nbsp;<span class="ident" id="4232610">NewChunkedReader</span><span class="op" id="4232626">(</span><span class="ident" id="4232627">r</span>&nbsp;<span class="ident" id="4232629">io</span><span class="op" id="4232631">.</span><span class="ident" id="4232632">Reader</span><span class="op" id="4232638">)</span>&nbsp;<span class="ident" id="4232640">io</span><span class="op" id="4232642">.</span><span class="ident" id="4232643">Reader</span>&nbsp;<span class="op" id="4232650">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4232653">br</span><span class="op" id="4232655">,</span>&nbsp;<span class="ident" id="4232657">ok</span>&nbsp;<span class="op" id="4232660">:=</span>&nbsp;<span class="ident" id="4232663">r</span><span class="op" id="4232664">.</span><span class="op" id="4232665">(</span><span class="op" id="4232666">*</span><span class="ident" id="4232667">bufio</span><span class="op" id="4232672">.</span><span class="ident" id="4232673">Reader</span><span class="op" id="4232679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4232682">if</span>&nbsp;<span class="op" id="4232685">!</span><span class="ident" id="4232686">ok</span>&nbsp;<span class="op" id="4232689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4232693">br</span>&nbsp;<span class="op" id="4232696">=</span>&nbsp;<span class="ident" id="4232698">bufio</span><span class="op" id="4232703">.</span><span class="ident" id="4232704">NewReader</span><span class="op" id="4232713">(</span><span class="ident" id="4232714">r</span><span class="op" id="4232715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4232718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4232721">return</span>&nbsp;<span class="op" id="4232728">&amp;</span><span class="ident" id="4232729">chunkedReader</span><span class="op" id="4232742">{</span><span class="ident" id="4232743">r</span><span class="op" id="4232744">:</span>&nbsp;<span class="ident" id="4232746">br</span><span class="op" id="4232748">}</span><br>
<span class="lineno">35</span><span class="op" id="4232750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4232753">type</span>&nbsp;<span class="ident" id="4232758">chunkedReader</span>&nbsp;<span class="keyword" id="4232772">struct</span>&nbsp;<span class="op" id="4232779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4232782">r</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4232786">*</span><span class="ident" id="4232787">bufio</span><span class="op" id="4232792">.</span><span class="ident" id="4232793">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4232801">n</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4232805">uint64</span>&nbsp;<span class="comment" id="4232812">//&nbsp;unread&nbsp;bytes&nbsp;in&nbsp;chunk</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4232838">err</span>&nbsp;<span class="builtintype" id="4232842">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4232849">buf</span>&nbsp;<span class="op" id="4232853">[</span><span class="num" id="4232854">2</span><span class="op" id="4232855">]</span><span class="builtintype" id="4232856">byte</span><br>
<span class="lineno"></span><span class="op" id="4232861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4232864">func</span>&nbsp;<span class="op" id="4232869">(</span><span class="ident" id="4232870">cr</span>&nbsp;<span class="op" id="4232873">*</span><span class="ident" id="4232874">chunkedReader</span><span class="op" id="4232887">)</span>&nbsp;<span class="ident" id="4232889">beginChunk</span><span class="op" id="4232899">(</span><span class="op" id="4232900">)</span>&nbsp;<span class="op" id="4232902">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4232905">//&nbsp;chunk-size&nbsp;CRLF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4232925">var</span>&nbsp;<span class="ident" id="4232929">line</span>&nbsp;<span class="op" id="4232934">[</span><span class="op" id="4232935">]</span><span class="builtintype" id="4232936">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4232942">line</span><span class="op" id="4232946">,</span>&nbsp;<span class="ident" id="4232948">cr</span><span class="op" id="4232950">.</span><span class="ident" id="4232951">err</span>&nbsp;<span class="op" id="4232955">=</span>&nbsp;<span class="ident" id="4232957">readLine</span><span class="op" id="4232965">(</span><span class="ident" id="4232966">cr</span><span class="op" id="4232968">.</span><span class="ident" id="4232969">r</span><span class="op" id="4232970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4232973">if</span>&nbsp;<span class="ident" id="4232976">cr</span><span class="op" id="4232978">.</span><span class="ident" id="4232979">err</span>&nbsp;<span class="op" id="4232983">!=</span>&nbsp;<span class="ident" id="4232986">nil</span>&nbsp;<span class="op" id="4232990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4232994">return</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4233002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233005">cr</span><span class="op" id="4233007">.</span><span class="ident" id="4233008">n</span><span class="op" id="4233009">,</span>&nbsp;<span class="ident" id="4233011">cr</span><span class="op" id="4233013">.</span><span class="ident" id="4233014">err</span>&nbsp;<span class="op" id="4233018">=</span>&nbsp;<span class="ident" id="4233020">parseHexUint</span><span class="op" id="4233032">(</span><span class="ident" id="4233033">line</span><span class="op" id="4233037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233040">if</span>&nbsp;<span class="ident" id="4233043">cr</span><span class="op" id="4233045">.</span><span class="ident" id="4233046">err</span>&nbsp;<span class="op" id="4233050">!=</span>&nbsp;<span class="ident" id="4233053">nil</span>&nbsp;<span class="op" id="4233057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233061">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4233069">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233072">if</span>&nbsp;<span class="ident" id="4233075">cr</span><span class="op" id="4233077">.</span><span class="ident" id="4233078">n</span>&nbsp;<span class="op" id="4233080">==</span>&nbsp;<span class="num" id="4233083">0</span>&nbsp;<span class="op" id="4233085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233089">cr</span><span class="op" id="4233091">.</span><span class="ident" id="4233092">err</span>&nbsp;<span class="op" id="4233096">=</span>&nbsp;<span class="ident" id="4233098">io</span><span class="op" id="4233100">.</span><span class="ident" id="4233101">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4233106">}</span><br>
<span class="lineno"></span><span class="op" id="4233108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4233111">func</span>&nbsp;<span class="op" id="4233116">(</span><span class="ident" id="4233117">cr</span>&nbsp;<span class="op" id="4233120">*</span><span class="ident" id="4233121">chunkedReader</span><span class="op" id="4233134">)</span>&nbsp;<span class="ident" id="4233136">chunkHeaderAvailable</span><span class="op" id="4233156">(</span><span class="op" id="4233157">)</span>&nbsp;<span class="builtintype" id="4233159">bool</span>&nbsp;<span class="op" id="4233164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233167">n</span>&nbsp;<span class="op" id="4233169">:=</span>&nbsp;<span class="ident" id="4233172">cr</span><span class="op" id="4233174">.</span><span class="ident" id="4233175">r</span><span class="op" id="4233176">.</span><span class="ident" id="4233177">Buffered</span><span class="op" id="4233185">(</span><span class="op" id="4233186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233189">if</span>&nbsp;<span class="ident" id="4233192">n</span>&nbsp;<span class="op" id="4233194">&gt;</span>&nbsp;<span class="num" id="4233196">0</span>&nbsp;<span class="op" id="4233198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233202">peek</span><span class="op" id="4233206">,</span>&nbsp;<span class="ident" id="4233208">_</span>&nbsp;<span class="op" id="4233210">:=</span>&nbsp;<span class="ident" id="4233213">cr</span><span class="op" id="4233215">.</span><span class="ident" id="4233216">r</span><span class="op" id="4233217">.</span><span class="ident" id="4233218">Peek</span><span class="op" id="4233222">(</span><span class="ident" id="4233223">n</span><span class="op" id="4233224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233228">return</span>&nbsp;<span class="ident" id="4233235">bytes</span><span class="op" id="4233240">.</span><span class="ident" id="4233241">IndexByte</span><span class="op" id="4233250">(</span><span class="ident" id="4233251">peek</span><span class="op" id="4233255">,</span>&nbsp;<span class="string" id="4233257">&#39;\n&#39;</span><span class="op" id="4233261">)</span>&nbsp;<span class="op" id="4233263">&gt;=</span>&nbsp;<span class="num" id="4233266">0</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4233269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233272">return</span>&nbsp;<span class="builtintype" id="4233279">false</span><br>
<span class="lineno"></span><span class="op" id="4233285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4233288">func</span>&nbsp;<span class="op" id="4233293">(</span><span class="ident" id="4233294">cr</span>&nbsp;<span class="op" id="4233297">*</span><span class="ident" id="4233298">chunkedReader</span><span class="op" id="4233311">)</span>&nbsp;<span class="ident" id="4233313">Read</span><span class="op" id="4233317">(</span><span class="ident" id="4233318">b</span>&nbsp;<span class="op" id="4233320">[</span><span class="op" id="4233321">]</span><span class="builtintype" id="4233322">uint8</span><span class="op" id="4233327">)</span>&nbsp;<span class="op" id="4233329">(</span><span class="ident" id="4233330">n</span>&nbsp;<span class="builtintype" id="4233332">int</span><span class="op" id="4233335">,</span>&nbsp;<span class="ident" id="4233337">err</span>&nbsp;<span class="builtintype" id="4233341">error</span><span class="op" id="4233346">)</span>&nbsp;<span class="op" id="4233348">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233351">for</span>&nbsp;<span class="ident" id="4233355">cr</span><span class="op" id="4233357">.</span><span class="ident" id="4233358">err</span>&nbsp;<span class="op" id="4233362">==</span>&nbsp;<span class="ident" id="4233365">nil</span>&nbsp;<span class="op" id="4233369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233373">if</span>&nbsp;<span class="ident" id="4233376">cr</span><span class="op" id="4233378">.</span><span class="ident" id="4233379">n</span>&nbsp;<span class="op" id="4233381">==</span>&nbsp;<span class="num" id="4233384">0</span>&nbsp;<span class="op" id="4233386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233391">if</span>&nbsp;<span class="ident" id="4233394">n</span>&nbsp;<span class="op" id="4233396">&gt;</span>&nbsp;<span class="num" id="4233398">0</span>&nbsp;<span class="op" id="4233400">&amp;&amp;</span>&nbsp;<span class="op" id="4233403">!</span><span class="ident" id="4233404">cr</span><span class="op" id="4233406">.</span><span class="ident" id="4233407">chunkHeaderAvailable</span><span class="op" id="4233427">(</span><span class="op" id="4233428">)</span>&nbsp;<span class="op" id="4233430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4233436">//&nbsp;We&#39;ve&nbsp;read&nbsp;enough.&nbsp;Don&#39;t&nbsp;potentially&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4233486">//&nbsp;reading&nbsp;a&nbsp;new&nbsp;chunk&nbsp;header.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233521">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4233530">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233535">cr</span><span class="op" id="4233537">.</span><span class="ident" id="4233538">beginChunk</span><span class="op" id="4233548">(</span><span class="op" id="4233549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233554">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4233565">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233569">if</span>&nbsp;<span class="builtinfunc" id="4233572">len</span><span class="op" id="4233575">(</span><span class="ident" id="4233576">b</span><span class="op" id="4233577">)</span>&nbsp;<span class="op" id="4233579">==</span>&nbsp;<span class="num" id="4233582">0</span>&nbsp;<span class="op" id="4233584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233589">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4233597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233601">rbuf</span>&nbsp;<span class="op" id="4233606">:=</span>&nbsp;<span class="ident" id="4233609">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233613">if</span>&nbsp;<span class="ident" id="4233616">uint64</span><span class="op" id="4233622">(</span><span class="builtinfunc" id="4233623">len</span><span class="op" id="4233626">(</span><span class="ident" id="4233627">rbuf</span><span class="op" id="4233631">)</span><span class="op" id="4233632">)</span>&nbsp;<span class="op" id="4233634">&gt;</span>&nbsp;<span class="ident" id="4233636">cr</span><span class="op" id="4233638">.</span><span class="ident" id="4233639">n</span>&nbsp;<span class="op" id="4233641">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233646">rbuf</span>&nbsp;<span class="op" id="4233651">=</span>&nbsp;<span class="ident" id="4233653">rbuf</span><span class="op" id="4233657">[</span><span class="op" id="4233658">:</span><span class="ident" id="4233659">cr</span><span class="op" id="4233661">.</span><span class="ident" id="4233662">n</span><span class="op" id="4233663">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4233667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233671">var</span>&nbsp;<span class="ident" id="4233675">n0</span>&nbsp;<span class="builtintype" id="4233678">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233684">n0</span><span class="op" id="4233686">,</span>&nbsp;<span class="ident" id="4233688">cr</span><span class="op" id="4233690">.</span><span class="ident" id="4233691">err</span>&nbsp;<span class="op" id="4233695">=</span>&nbsp;<span class="ident" id="4233697">cr</span><span class="op" id="4233699">.</span><span class="ident" id="4233700">r</span><span class="op" id="4233701">.</span><span class="ident" id="4233702">Read</span><span class="op" id="4233706">(</span><span class="ident" id="4233707">rbuf</span><span class="op" id="4233711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233715">n</span>&nbsp;<span class="op" id="4233717">+=</span>&nbsp;<span class="ident" id="4233720">n0</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233725">b</span>&nbsp;<span class="op" id="4233727">=</span>&nbsp;<span class="ident" id="4233729">b</span><span class="op" id="4233730">[</span><span class="ident" id="4233731">n0</span><span class="op" id="4233733">:</span><span class="op" id="4233734">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4233738">cr</span><span class="op" id="4233740">.</span><span class="ident" id="4233741">n</span>&nbsp;<span class="op" id="4233743">-=</span>&nbsp;<span class="ident" id="4233746">uint64</span><span class="op" id="4233752">(</span><span class="ident" id="4233753">n0</span><span class="op" id="4233755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4233759">//&nbsp;If&nbsp;we&#39;re&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;chunk,&nbsp;read&nbsp;the&nbsp;next&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4233814">//&nbsp;bytes&nbsp;to&nbsp;verify&nbsp;they&nbsp;are&nbsp;&#34;\r\n&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233852">if</span>&nbsp;<span class="ident" id="4233855">cr</span><span class="op" id="4233857">.</span><span class="ident" id="4233858">n</span>&nbsp;<span class="op" id="4233860">==</span>&nbsp;<span class="num" id="4233863">0</span>&nbsp;<span class="op" id="4233865">&amp;&amp;</span>&nbsp;<span class="ident" id="4233868">cr</span><span class="op" id="4233870">.</span><span class="ident" id="4233871">err</span>&nbsp;<span class="op" id="4233875">==</span>&nbsp;<span class="ident" id="4233878">nil</span>&nbsp;<span class="op" id="4233882">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233887">if</span>&nbsp;<span class="ident" id="4233890">_</span><span class="op" id="4233891">,</span>&nbsp;<span class="ident" id="4233893">cr</span><span class="op" id="4233895">.</span><span class="ident" id="4233896">err</span>&nbsp;<span class="op" id="4233900">=</span>&nbsp;<span class="ident" id="4233902">io</span><span class="op" id="4233904">.</span><span class="ident" id="4233905">ReadFull</span><span class="op" id="4233913">(</span><span class="ident" id="4233914">cr</span><span class="op" id="4233916">.</span><span class="ident" id="4233917">r</span><span class="op" id="4233918">,</span>&nbsp;<span class="ident" id="4233920">cr</span><span class="op" id="4233922">.</span><span class="ident" id="4233923">buf</span><span class="op" id="4233926">[</span><span class="op" id="4233927">:</span><span class="num" id="4233928">2</span><span class="op" id="4233929">]</span><span class="op" id="4233930">)</span><span class="op" id="4233931">;</span>&nbsp;<span class="ident" id="4233933">cr</span><span class="op" id="4233935">.</span><span class="ident" id="4233936">err</span>&nbsp;<span class="op" id="4233940">==</span>&nbsp;<span class="ident" id="4233943">nil</span>&nbsp;<span class="op" id="4233947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4233953">if</span>&nbsp;<span class="ident" id="4233956">cr</span><span class="op" id="4233958">.</span><span class="ident" id="4233959">buf</span><span class="op" id="4233962">[</span><span class="num" id="4233963">0</span><span class="op" id="4233964">]</span>&nbsp;<span class="op" id="4233966">!=</span>&nbsp;<span class="string" id="4233969">&#39;\r&#39;</span>&nbsp;<span class="op" id="4233974">||</span>&nbsp;<span class="ident" id="4233977">cr</span><span class="op" id="4233979">.</span><span class="ident" id="4233980">buf</span><span class="op" id="4233983">[</span><span class="num" id="4233984">1</span><span class="op" id="4233985">]</span>&nbsp;<span class="op" id="4233987">!=</span>&nbsp;<span class="string" id="4233990">&#39;\n&#39;</span>&nbsp;<span class="op" id="4233995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234002">cr</span><span class="op" id="4234004">.</span><span class="ident" id="4234005">err</span>&nbsp;<span class="op" id="4234009">=</span>&nbsp;<span class="ident" id="4234011">errors</span><span class="op" id="4234017">.</span><span class="ident" id="4234018">New</span><span class="op" id="4234021">(</span><span class="string" id="4234022">&#34;malformed&nbsp;chunked&nbsp;encoding&#34;</span><span class="op" id="4234050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4234056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4234061">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4234065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4234068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234071">return</span>&nbsp;<span class="ident" id="4234078">n</span><span class="op" id="4234079">,</span>&nbsp;<span class="ident" id="4234081">cr</span><span class="op" id="4234083">.</span><span class="ident" id="4234084">err</span><br>
<span class="lineno"></span><span class="op" id="4234088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4234091">//&nbsp;Read&nbsp;a&nbsp;line&nbsp;of&nbsp;bytes&nbsp;(up&nbsp;to&nbsp;\n)&nbsp;from&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="4234134">//&nbsp;Give&nbsp;up&nbsp;if&nbsp;the&nbsp;line&nbsp;exceeds&nbsp;maxLineLength.</span><br>
<span class="lineno"></span><span class="comment" id="4234180">//&nbsp;The&nbsp;returned&nbsp;bytes&nbsp;are&nbsp;a&nbsp;pointer&nbsp;into&nbsp;storage&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4234232">//&nbsp;the&nbsp;bufio,&nbsp;so&nbsp;they&nbsp;are&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;bufio&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="4234296">func</span>&nbsp;<span class="ident" id="4234301">readLine</span><span class="op" id="4234309">(</span><span class="ident" id="4234310">b</span>&nbsp;<span class="op" id="4234312">*</span><span class="ident" id="4234313">bufio</span><span class="op" id="4234318">.</span><span class="ident" id="4234319">Reader</span><span class="op" id="4234325">)</span>&nbsp;<span class="op" id="4234327">(</span><span class="ident" id="4234328">p</span>&nbsp;<span class="op" id="4234330">[</span><span class="op" id="4234331">]</span><span class="builtintype" id="4234332">byte</span><span class="op" id="4234336">,</span>&nbsp;<span class="ident" id="4234338">err</span>&nbsp;<span class="builtintype" id="4234342">error</span><span class="op" id="4234347">)</span>&nbsp;<span class="op" id="4234349">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234352">if</span>&nbsp;<span class="ident" id="4234355">p</span><span class="op" id="4234356">,</span>&nbsp;<span class="ident" id="4234358">err</span>&nbsp;<span class="op" id="4234362">=</span>&nbsp;<span class="ident" id="4234364">b</span><span class="op" id="4234365">.</span><span class="ident" id="4234366">ReadSlice</span><span class="op" id="4234375">(</span><span class="string" id="4234376">&#39;\n&#39;</span><span class="op" id="4234380">)</span><span class="op" id="4234381">;</span>&nbsp;<span class="ident" id="4234383">err</span>&nbsp;<span class="op" id="4234387">!=</span>&nbsp;<span class="ident" id="4234390">nil</span>&nbsp;<span class="op" id="4234394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4234398">//&nbsp;We&nbsp;always&nbsp;know&nbsp;when&nbsp;EOF&nbsp;is&nbsp;coming.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4234438">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;asked&nbsp;for&nbsp;a&nbsp;line,&nbsp;there&nbsp;should&nbsp;be&nbsp;a&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234499">if</span>&nbsp;<span class="ident" id="4234502">err</span>&nbsp;<span class="op" id="4234506">==</span>&nbsp;<span class="ident" id="4234509">io</span><span class="op" id="4234511">.</span><span class="ident" id="4234512">EOF</span>&nbsp;<span class="op" id="4234516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234521">err</span>&nbsp;<span class="op" id="4234525">=</span>&nbsp;<span class="ident" id="4234527">io</span><span class="op" id="4234529">.</span><span class="ident" id="4234530">ErrUnexpectedEOF</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4234549">}</span>&nbsp;<span class="keyword" id="4234551">else</span>&nbsp;<span class="keyword" id="4234556">if</span>&nbsp;<span class="ident" id="4234559">err</span>&nbsp;<span class="op" id="4234563">==</span>&nbsp;<span class="ident" id="4234566">bufio</span><span class="op" id="4234571">.</span><span class="ident" id="4234572">ErrBufferFull</span>&nbsp;<span class="op" id="4234586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234591">err</span>&nbsp;<span class="op" id="4234595">=</span>&nbsp;<span class="ident" id="4234597">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4234614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234618">return</span>&nbsp;<span class="ident" id="4234625">nil</span><span class="op" id="4234628">,</span>&nbsp;<span class="ident" id="4234630">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4234635">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234638">if</span>&nbsp;<span class="builtinfunc" id="4234641">len</span><span class="op" id="4234644">(</span><span class="ident" id="4234645">p</span><span class="op" id="4234646">)</span>&nbsp;<span class="op" id="4234648">&gt;=</span>&nbsp;<span class="ident" id="4234651">maxLineLength</span>&nbsp;<span class="op" id="4234665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234669">return</span>&nbsp;<span class="ident" id="4234676">nil</span><span class="op" id="4234679">,</span>&nbsp;<span class="ident" id="4234681">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4234697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234700">return</span>&nbsp;<span class="ident" id="4234707">trimTrailingWhitespace</span><span class="op" id="4234729">(</span><span class="ident" id="4234730">p</span><span class="op" id="4234731">)</span><span class="op" id="4234732">,</span>&nbsp;<span class="ident" id="4234734">nil</span><br>
<span class="lineno"></span><span class="op" id="4234738">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="4234741">func</span>&nbsp;<span class="ident" id="4234746">trimTrailingWhitespace</span><span class="op" id="4234768">(</span><span class="ident" id="4234769">b</span>&nbsp;<span class="op" id="4234771">[</span><span class="op" id="4234772">]</span><span class="builtintype" id="4234773">byte</span><span class="op" id="4234777">)</span>&nbsp;<span class="op" id="4234779">[</span><span class="op" id="4234780">]</span><span class="builtintype" id="4234781">byte</span>&nbsp;<span class="op" id="4234786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234789">for</span>&nbsp;<span class="builtinfunc" id="4234793">len</span><span class="op" id="4234796">(</span><span class="ident" id="4234797">b</span><span class="op" id="4234798">)</span>&nbsp;<span class="op" id="4234800">&gt;</span>&nbsp;<span class="num" id="4234802">0</span>&nbsp;<span class="op" id="4234804">&amp;&amp;</span>&nbsp;<span class="ident" id="4234807">isASCIISpace</span><span class="op" id="4234819">(</span><span class="ident" id="4234820">b</span><span class="op" id="4234821">[</span><span class="builtinfunc" id="4234822">len</span><span class="op" id="4234825">(</span><span class="ident" id="4234826">b</span><span class="op" id="4234827">)</span><span class="op" id="4234828">-</span><span class="num" id="4234829">1</span><span class="op" id="4234830">]</span><span class="op" id="4234831">)</span>&nbsp;<span class="op" id="4234833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4234837">b</span>&nbsp;<span class="op" id="4234839">=</span>&nbsp;<span class="ident" id="4234841">b</span><span class="op" id="4234842">[</span><span class="op" id="4234843">:</span><span class="builtinfunc" id="4234844">len</span><span class="op" id="4234847">(</span><span class="ident" id="4234848">b</span><span class="op" id="4234849">)</span><span class="op" id="4234850">-</span><span class="num" id="4234851">1</span><span class="op" id="4234852">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4234855">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234858">return</span>&nbsp;<span class="ident" id="4234865">b</span><br>
<span class="lineno"></span><span class="op" id="4234867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4234870">func</span>&nbsp;<span class="ident" id="4234875">isASCIISpace</span><span class="op" id="4234887">(</span><span class="ident" id="4234888">b</span>&nbsp;<span class="builtintype" id="4234890">byte</span><span class="op" id="4234894">)</span>&nbsp;<span class="builtintype" id="4234896">bool</span>&nbsp;<span class="op" id="4234901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4234904">return</span>&nbsp;<span class="ident" id="4234911">b</span>&nbsp;<span class="op" id="4234913">==</span>&nbsp;<span class="string" id="4234916">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4234920">||</span>&nbsp;<span class="ident" id="4234923">b</span>&nbsp;<span class="op" id="4234925">==</span>&nbsp;<span class="string" id="4234928">&#39;\t&#39;</span>&nbsp;<span class="op" id="4234933">||</span>&nbsp;<span class="ident" id="4234936">b</span>&nbsp;<span class="op" id="4234938">==</span>&nbsp;<span class="string" id="4234941">&#39;\n&#39;</span>&nbsp;<span class="op" id="4234946">||</span>&nbsp;<span class="ident" id="4234949">b</span>&nbsp;<span class="op" id="4234951">==</span>&nbsp;<span class="string" id="4234954">&#39;\r&#39;</span><br>
<span class="lineno">135</span><span class="op" id="4234959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4234962">//&nbsp;NewChunkedWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedWriter&nbsp;that&nbsp;translates&nbsp;writes&nbsp;into&nbsp;HTTP</span><br>
<span class="lineno"></span><span class="comment" id="4235043">//&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;writing&nbsp;them&nbsp;to&nbsp;w.&nbsp;Closing&nbsp;the&nbsp;returned&nbsp;chunkedWriter</span><br>
<span class="lineno"></span><span class="comment" id="4235124">//&nbsp;sends&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;that&nbsp;marks&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;stream.</span><br>
<span class="lineno">140</span><span class="comment" id="4235192">//</span><br>
<span class="lineno"></span><span class="comment" id="4235195">//&nbsp;NewChunkedWriter&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http</span><br>
<span class="lineno"></span><span class="comment" id="4235262">//&nbsp;package&nbsp;adds&nbsp;chunking&nbsp;automatically&nbsp;if&nbsp;handlers&nbsp;don&#39;t&nbsp;set&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4235325">//&nbsp;Content-Length&nbsp;header.&nbsp;Using&nbsp;newChunkedWriter&nbsp;inside&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="4235391">//&nbsp;would&nbsp;result&nbsp;in&nbsp;double&nbsp;chunking&nbsp;or&nbsp;chunking&nbsp;with&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno">145</span><span class="comment" id="4235460">//&nbsp;length,&nbsp;both&nbsp;of&nbsp;which&nbsp;are&nbsp;wrong.</span><br>
<span class="lineno"></span><span class="keyword" id="4235496">func</span>&nbsp;<span class="ident" id="4235501">NewChunkedWriter</span><span class="op" id="4235517">(</span><span class="ident" id="4235518">w</span>&nbsp;<span class="ident" id="4235520">io</span><span class="op" id="4235522">.</span><span class="ident" id="4235523">Writer</span><span class="op" id="4235529">)</span>&nbsp;<span class="ident" id="4235531">io</span><span class="op" id="4235533">.</span><span class="ident" id="4235534">WriteCloser</span>&nbsp;<span class="op" id="4235546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4235549">return</span>&nbsp;<span class="op" id="4235556">&amp;</span><span class="ident" id="4235557">chunkedWriter</span><span class="op" id="4235570">{</span><span class="ident" id="4235571">w</span><span class="op" id="4235572">}</span><br>
<span class="lineno"></span><span class="op" id="4235574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="4235577">//&nbsp;Writing&nbsp;to&nbsp;chunkedWriter&nbsp;translates&nbsp;to&nbsp;writing&nbsp;in&nbsp;HTTP&nbsp;chunked&nbsp;Transfer</span><br>
<span class="lineno"></span><span class="comment" id="4235652">//&nbsp;Encoding&nbsp;wire&nbsp;format&nbsp;to&nbsp;the&nbsp;underlying&nbsp;Wire&nbsp;chunkedWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="4235714">type</span>&nbsp;<span class="ident" id="4235719">chunkedWriter</span>&nbsp;<span class="keyword" id="4235733">struct</span>&nbsp;<span class="op" id="4235740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4235743">Wire</span>&nbsp;<span class="ident" id="4235748">io</span><span class="op" id="4235750">.</span><span class="ident" id="4235751">Writer</span><br>
<span class="lineno"></span><span class="op" id="4235758">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="4235761">//&nbsp;Write&nbsp;the&nbsp;contents&nbsp;of&nbsp;data&nbsp;as&nbsp;one&nbsp;chunk&nbsp;to&nbsp;Wire.</span><br>
<span class="lineno"></span><span class="comment" id="4235813">//&nbsp;NOTE:&nbsp;Note&nbsp;that&nbsp;the&nbsp;corresponding&nbsp;chunk-writing&nbsp;procedure&nbsp;in&nbsp;Conn.Write&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="4235892">//&nbsp;a&nbsp;bug&nbsp;since&nbsp;it&nbsp;does&nbsp;not&nbsp;check&nbsp;for&nbsp;success&nbsp;of&nbsp;io.WriteString</span><br>
<span class="lineno"></span><span class="keyword" id="4235955">func</span>&nbsp;<span class="op" id="4235960">(</span><span class="ident" id="4235961">cw</span>&nbsp;<span class="op" id="4235964">*</span><span class="ident" id="4235965">chunkedWriter</span><span class="op" id="4235978">)</span>&nbsp;<span class="ident" id="4235980">Write</span><span class="op" id="4235985">(</span><span class="ident" id="4235986">data</span>&nbsp;<span class="op" id="4235991">[</span><span class="op" id="4235992">]</span><span class="builtintype" id="4235993">byte</span><span class="op" id="4235997">)</span>&nbsp;<span class="op" id="4235999">(</span><span class="ident" id="4236000">n</span>&nbsp;<span class="builtintype" id="4236002">int</span><span class="op" id="4236005">,</span>&nbsp;<span class="ident" id="4236007">err</span>&nbsp;<span class="builtintype" id="4236011">error</span><span class="op" id="4236016">)</span>&nbsp;<span class="op" id="4236018">{</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4236022">//&nbsp;Don&#39;t&nbsp;send&nbsp;0-length&nbsp;data.&nbsp;It&nbsp;looks&nbsp;like&nbsp;EOF&nbsp;for&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236092">if</span>&nbsp;<span class="builtinfunc" id="4236095">len</span><span class="op" id="4236098">(</span><span class="ident" id="4236099">data</span><span class="op" id="4236103">)</span>&nbsp;<span class="op" id="4236105">==</span>&nbsp;<span class="num" id="4236108">0</span>&nbsp;<span class="op" id="4236110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236114">return</span>&nbsp;<span class="num" id="4236121">0</span><span class="op" id="4236122">,</span>&nbsp;<span class="ident" id="4236124">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4236129">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236133">if</span>&nbsp;<span class="ident" id="4236136">_</span><span class="op" id="4236137">,</span>&nbsp;<span class="ident" id="4236139">err</span>&nbsp;<span class="op" id="4236143">=</span>&nbsp;<span class="ident" id="4236145">fmt</span><span class="op" id="4236148">.</span><span class="ident" id="4236149">Fprintf</span><span class="op" id="4236156">(</span><span class="ident" id="4236157">cw</span><span class="op" id="4236159">.</span><span class="ident" id="4236160">Wire</span><span class="op" id="4236164">,</span>&nbsp;<span class="string" id="4236166">&#34;%x\r\n&#34;</span><span class="op" id="4236174">,</span>&nbsp;<span class="builtinfunc" id="4236176">len</span><span class="op" id="4236179">(</span><span class="ident" id="4236180">data</span><span class="op" id="4236184">)</span><span class="op" id="4236185">)</span><span class="op" id="4236186">;</span>&nbsp;<span class="ident" id="4236188">err</span>&nbsp;<span class="op" id="4236192">!=</span>&nbsp;<span class="ident" id="4236195">nil</span>&nbsp;<span class="op" id="4236199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236203">return</span>&nbsp;<span class="num" id="4236210">0</span><span class="op" id="4236211">,</span>&nbsp;<span class="ident" id="4236213">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4236218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236221">if</span>&nbsp;<span class="ident" id="4236224">n</span><span class="op" id="4236225">,</span>&nbsp;<span class="ident" id="4236227">err</span>&nbsp;<span class="op" id="4236231">=</span>&nbsp;<span class="ident" id="4236233">cw</span><span class="op" id="4236235">.</span><span class="ident" id="4236236">Wire</span><span class="op" id="4236240">.</span><span class="ident" id="4236241">Write</span><span class="op" id="4236246">(</span><span class="ident" id="4236247">data</span><span class="op" id="4236251">)</span><span class="op" id="4236252">;</span>&nbsp;<span class="ident" id="4236254">err</span>&nbsp;<span class="op" id="4236258">!=</span>&nbsp;<span class="ident" id="4236261">nil</span>&nbsp;<span class="op" id="4236265">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236269">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4236277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236280">if</span>&nbsp;<span class="ident" id="4236283">n</span>&nbsp;<span class="op" id="4236285">!=</span>&nbsp;<span class="builtinfunc" id="4236288">len</span><span class="op" id="4236291">(</span><span class="ident" id="4236292">data</span><span class="op" id="4236296">)</span>&nbsp;<span class="op" id="4236298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4236302">err</span>&nbsp;<span class="op" id="4236306">=</span>&nbsp;<span class="ident" id="4236308">io</span><span class="op" id="4236310">.</span><span class="ident" id="4236311">ErrShortWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236327">return</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4236335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4236338">_</span><span class="op" id="4236339">,</span>&nbsp;<span class="ident" id="4236341">err</span>&nbsp;<span class="op" id="4236345">=</span>&nbsp;<span class="ident" id="4236347">io</span><span class="op" id="4236349">.</span><span class="ident" id="4236350">WriteString</span><span class="op" id="4236361">(</span><span class="ident" id="4236362">cw</span><span class="op" id="4236364">.</span><span class="ident" id="4236365">Wire</span><span class="op" id="4236369">,</span>&nbsp;<span class="string" id="4236371">&#34;\r\n&#34;</span><span class="op" id="4236377">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236381">return</span><br>
<span class="lineno"></span><span class="op" id="4236388">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="keyword" id="4236391">func</span>&nbsp;<span class="op" id="4236396">(</span><span class="ident" id="4236397">cw</span>&nbsp;<span class="op" id="4236400">*</span><span class="ident" id="4236401">chunkedWriter</span><span class="op" id="4236414">)</span>&nbsp;<span class="ident" id="4236416">Close</span><span class="op" id="4236421">(</span><span class="op" id="4236422">)</span>&nbsp;<span class="builtintype" id="4236424">error</span>&nbsp;<span class="op" id="4236430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4236433">_</span><span class="op" id="4236434">,</span>&nbsp;<span class="ident" id="4236436">err</span>&nbsp;<span class="op" id="4236440">:=</span>&nbsp;<span class="ident" id="4236443">io</span><span class="op" id="4236445">.</span><span class="ident" id="4236446">WriteString</span><span class="op" id="4236457">(</span><span class="ident" id="4236458">cw</span><span class="op" id="4236460">.</span><span class="ident" id="4236461">Wire</span><span class="op" id="4236465">,</span>&nbsp;<span class="string" id="4236467">&#34;0\r\n&#34;</span><span class="op" id="4236474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236477">return</span>&nbsp;<span class="ident" id="4236484">err</span><br>
<span class="lineno"></span><span class="op" id="4236488">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="4236491">func</span>&nbsp;<span class="ident" id="4236496">parseHexUint</span><span class="op" id="4236508">(</span><span class="ident" id="4236509">v</span>&nbsp;<span class="op" id="4236511">[</span><span class="op" id="4236512">]</span><span class="builtintype" id="4236513">byte</span><span class="op" id="4236517">)</span>&nbsp;<span class="op" id="4236519">(</span><span class="ident" id="4236520">n</span>&nbsp;<span class="ident" id="4236522">uint64</span><span class="op" id="4236528">,</span>&nbsp;<span class="ident" id="4236530">err</span>&nbsp;<span class="builtintype" id="4236534">error</span><span class="op" id="4236539">)</span>&nbsp;<span class="op" id="4236541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236544">for</span>&nbsp;<span class="ident" id="4236548">_</span><span class="op" id="4236549">,</span>&nbsp;<span class="ident" id="4236551">b</span>&nbsp;<span class="op" id="4236553">:=</span>&nbsp;<span class="keyword" id="4236556">range</span>&nbsp;<span class="ident" id="4236562">v</span>&nbsp;<span class="op" id="4236564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4236568">n</span>&nbsp;<span class="op" id="4236570">&lt;&lt;=</span>&nbsp;<span class="num" id="4236574">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236578">switch</span>&nbsp;<span class="op" id="4236585">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236589">case</span>&nbsp;<span class="string" id="4236594">&#39;0&#39;</span>&nbsp;<span class="op" id="4236598">&lt;=</span>&nbsp;<span class="ident" id="4236601">b</span>&nbsp;<span class="op" id="4236603">&amp;&amp;</span>&nbsp;<span class="ident" id="4236606">b</span>&nbsp;<span class="op" id="4236608">&lt;=</span>&nbsp;<span class="string" id="4236611">&#39;9&#39;</span><span class="op" id="4236614">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4236619">b</span>&nbsp;<span class="op" id="4236621">=</span>&nbsp;<span class="ident" id="4236623">b</span>&nbsp;<span class="op" id="4236625">-</span>&nbsp;<span class="string" id="4236627">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236633">case</span>&nbsp;<span class="string" id="4236638">&#39;a&#39;</span>&nbsp;<span class="op" id="4236642">&lt;=</span>&nbsp;<span class="ident" id="4236645">b</span>&nbsp;<span class="op" id="4236647">&amp;&amp;</span>&nbsp;<span class="ident" id="4236650">b</span>&nbsp;<span class="op" id="4236652">&lt;=</span>&nbsp;<span class="string" id="4236655">&#39;f&#39;</span><span class="op" id="4236658">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4236663">b</span>&nbsp;<span class="op" id="4236665">=</span>&nbsp;<span class="ident" id="4236667">b</span>&nbsp;<span class="op" id="4236669">-</span>&nbsp;<span class="string" id="4236671">&#39;a&#39;</span>&nbsp;<span class="op" id="4236675">+</span>&nbsp;<span class="num" id="4236677">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236682">case</span>&nbsp;<span class="string" id="4236687">&#39;A&#39;</span>&nbsp;<span class="op" id="4236691">&lt;=</span>&nbsp;<span class="ident" id="4236694">b</span>&nbsp;<span class="op" id="4236696">&amp;&amp;</span>&nbsp;<span class="ident" id="4236699">b</span>&nbsp;<span class="op" id="4236701">&lt;=</span>&nbsp;<span class="string" id="4236704">&#39;F&#39;</span><span class="op" id="4236707">:</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4236712">b</span>&nbsp;<span class="op" id="4236714">=</span>&nbsp;<span class="ident" id="4236716">b</span>&nbsp;<span class="op" id="4236718">-</span>&nbsp;<span class="string" id="4236720">&#39;A&#39;</span>&nbsp;<span class="op" id="4236724">+</span>&nbsp;<span class="num" id="4236726">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236731">default</span><span class="op" id="4236738">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236743">return</span>&nbsp;<span class="num" id="4236750">0</span><span class="op" id="4236751">,</span>&nbsp;<span class="ident" id="4236753">errors</span><span class="op" id="4236759">.</span><span class="ident" id="4236760">New</span><span class="op" id="4236763">(</span><span class="string" id="4236764">&#34;invalid&nbsp;byte&nbsp;in&nbsp;chunk&nbsp;length&#34;</span><span class="op" id="4236794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4236798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4236802">n</span>&nbsp;<span class="op" id="4236804">|=</span>&nbsp;<span class="ident" id="4236807">uint64</span><span class="op" id="4236813">(</span><span class="ident" id="4236814">b</span><span class="op" id="4236815">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4236818">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4236821">return</span><br>
<span class="lineno"></span><span class="op" id="4236828">}</span>
</div>
</body>
</html>
