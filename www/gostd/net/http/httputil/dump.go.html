<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4704055">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4704110">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4704164">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4704215">package</span>&nbsp;<span class="ident" id="4704223">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4704233">import</span>&nbsp;<span class="op" id="4704240">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4704243">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4704252">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4704261">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4704271">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4704278">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4704284">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4704297">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4704304">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4704316">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4704327">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4704338">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4704345">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="4704348">//&nbsp;One&nbsp;of&nbsp;the&nbsp;copies,&nbsp;say&nbsp;from&nbsp;b&nbsp;to&nbsp;r2,&nbsp;could&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using&nbsp;a&nbsp;more</span><br>
<span class="lineno"></span><span class="comment" id="4704421">//&nbsp;elaborate&nbsp;trick&nbsp;where&nbsp;the&nbsp;other&nbsp;copy&nbsp;is&nbsp;made&nbsp;during&nbsp;Request/Response.Write.</span><br>
<span class="lineno"></span><span class="comment" id="4704500">//&nbsp;This&nbsp;would&nbsp;complicate&nbsp;things&nbsp;too&nbsp;much,&nbsp;given&nbsp;that&nbsp;these&nbsp;functions&nbsp;are&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4704577">//&nbsp;debugging&nbsp;only.</span><br>
<span class="lineno">25</span><span class="keyword" id="4704596">func</span>&nbsp;<span class="ident" id="4704601">drainBody</span><span class="op" id="4704610">(</span><span class="ident" id="4704611">b</span>&nbsp;<span class="ident" id="4704613">io</span><span class="op" id="4704615">.</span><span class="ident" id="4704616">ReadCloser</span><span class="op" id="4704626">)</span>&nbsp;<span class="op" id="4704628">(</span><span class="ident" id="4704629">r1</span><span class="op" id="4704631">,</span>&nbsp;<span class="ident" id="4704633">r2</span>&nbsp;<span class="ident" id="4704636">io</span><span class="op" id="4704638">.</span><span class="ident" id="4704639">ReadCloser</span><span class="op" id="4704649">,</span>&nbsp;<span class="ident" id="4704651">err</span>&nbsp;<span class="builtintype" id="4704655">error</span><span class="op" id="4704660">)</span>&nbsp;<span class="op" id="4704662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4704665">var</span>&nbsp;<span class="ident" id="4704669">buf</span>&nbsp;<span class="ident" id="4704673">bytes</span><span class="op" id="4704678">.</span><span class="ident" id="4704679">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4704687">if</span>&nbsp;<span class="ident" id="4704690">_</span><span class="op" id="4704691">,</span>&nbsp;<span class="ident" id="4704693">err</span>&nbsp;<span class="op" id="4704697">=</span>&nbsp;<span class="ident" id="4704699">buf</span><span class="op" id="4704702">.</span><span class="ident" id="4704703">ReadFrom</span><span class="op" id="4704711">(</span><span class="ident" id="4704712">b</span><span class="op" id="4704713">)</span><span class="op" id="4704714">;</span>&nbsp;<span class="ident" id="4704716">err</span>&nbsp;<span class="op" id="4704720">!=</span>&nbsp;<span class="ident" id="4704723">nil</span>&nbsp;<span class="op" id="4704727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4704731">return</span>&nbsp;<span class="ident" id="4704738">nil</span><span class="op" id="4704741">,</span>&nbsp;<span class="ident" id="4704743">nil</span><span class="op" id="4704746">,</span>&nbsp;<span class="ident" id="4704748">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4704753">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4704756">if</span>&nbsp;<span class="ident" id="4704759">err</span>&nbsp;<span class="op" id="4704763">=</span>&nbsp;<span class="ident" id="4704765">b</span><span class="op" id="4704766">.</span><span class="ident" id="4704767">Close</span><span class="op" id="4704772">(</span><span class="op" id="4704773">)</span><span class="op" id="4704774">;</span>&nbsp;<span class="ident" id="4704776">err</span>&nbsp;<span class="op" id="4704780">!=</span>&nbsp;<span class="ident" id="4704783">nil</span>&nbsp;<span class="op" id="4704787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4704791">return</span>&nbsp;<span class="ident" id="4704798">nil</span><span class="op" id="4704801">,</span>&nbsp;<span class="ident" id="4704803">nil</span><span class="op" id="4704806">,</span>&nbsp;<span class="ident" id="4704808">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4704813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4704816">return</span>&nbsp;<span class="ident" id="4704823">ioutil</span><span class="op" id="4704829">.</span><span class="ident" id="4704830">NopCloser</span><span class="op" id="4704839">(</span><span class="op" id="4704840">&amp;</span><span class="ident" id="4704841">buf</span><span class="op" id="4704844">)</span><span class="op" id="4704845">,</span>&nbsp;<span class="ident" id="4704847">ioutil</span><span class="op" id="4704853">.</span><span class="ident" id="4704854">NopCloser</span><span class="op" id="4704863">(</span><span class="ident" id="4704864">bytes</span><span class="op" id="4704869">.</span><span class="ident" id="4704870">NewReader</span><span class="op" id="4704879">(</span><span class="ident" id="4704880">buf</span><span class="op" id="4704883">.</span><span class="ident" id="4704884">Bytes</span><span class="op" id="4704889">(</span><span class="op" id="4704890">)</span><span class="op" id="4704891">)</span><span class="op" id="4704892">)</span><span class="op" id="4704893">,</span>&nbsp;<span class="ident" id="4704895">nil</span><br>
<span class="lineno"></span><span class="op" id="4704899">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="4704902">//&nbsp;dumpConn&nbsp;is&nbsp;a&nbsp;net.Conn&nbsp;which&nbsp;writes&nbsp;to&nbsp;Writer&nbsp;and&nbsp;reads&nbsp;from&nbsp;Reader</span><br>
<span class="lineno"></span><span class="keyword" id="4704973">type</span>&nbsp;<span class="ident" id="4704978">dumpConn</span>&nbsp;<span class="keyword" id="4704987">struct</span>&nbsp;<span class="op" id="4704994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4704997">io</span><span class="op" id="4704999">.</span><span class="ident" id="4705000">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4705008">io</span><span class="op" id="4705010">.</span><span class="ident" id="4705011">Reader</span><br>
<span class="lineno">40</span><span class="op" id="4705018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4705021">func</span>&nbsp;<span class="op" id="4705026">(</span><span class="ident" id="4705027">c</span>&nbsp;<span class="op" id="4705029">*</span><span class="ident" id="4705030">dumpConn</span><span class="op" id="4705038">)</span>&nbsp;<span class="ident" id="4705040">Close</span><span class="op" id="4705045">(</span><span class="op" id="4705046">)</span>&nbsp;<span class="builtintype" id="4705048">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4705076">{</span>&nbsp;<span class="keyword" id="4705078">return</span>&nbsp;<span class="ident" id="4705085">nil</span>&nbsp;<span class="op" id="4705089">}</span><br>
<span class="lineno"></span><span class="keyword" id="4705091">func</span>&nbsp;<span class="op" id="4705096">(</span><span class="ident" id="4705097">c</span>&nbsp;<span class="op" id="4705099">*</span><span class="ident" id="4705100">dumpConn</span><span class="op" id="4705108">)</span>&nbsp;<span class="ident" id="4705110">LocalAddr</span><span class="op" id="4705119">(</span><span class="op" id="4705120">)</span>&nbsp;<span class="ident" id="4705122">net</span><span class="op" id="4705125">.</span><span class="ident" id="4705126">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4705146">{</span>&nbsp;<span class="keyword" id="4705148">return</span>&nbsp;<span class="ident" id="4705155">nil</span>&nbsp;<span class="op" id="4705159">}</span><br>
<span class="lineno"></span><span class="keyword" id="4705161">func</span>&nbsp;<span class="op" id="4705166">(</span><span class="ident" id="4705167">c</span>&nbsp;<span class="op" id="4705169">*</span><span class="ident" id="4705170">dumpConn</span><span class="op" id="4705178">)</span>&nbsp;<span class="ident" id="4705180">RemoteAddr</span><span class="op" id="4705190">(</span><span class="op" id="4705191">)</span>&nbsp;<span class="ident" id="4705193">net</span><span class="op" id="4705196">.</span><span class="ident" id="4705197">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4705216">{</span>&nbsp;<span class="keyword" id="4705218">return</span>&nbsp;<span class="ident" id="4705225">nil</span>&nbsp;<span class="op" id="4705229">}</span><br>
<span class="lineno">45</span><span class="keyword" id="4705231">func</span>&nbsp;<span class="op" id="4705236">(</span><span class="ident" id="4705237">c</span>&nbsp;<span class="op" id="4705239">*</span><span class="ident" id="4705240">dumpConn</span><span class="op" id="4705248">)</span>&nbsp;<span class="ident" id="4705250">SetDeadline</span><span class="op" id="4705261">(</span><span class="ident" id="4705262">t</span>&nbsp;<span class="ident" id="4705264">time</span><span class="op" id="4705268">.</span><span class="ident" id="4705269">Time</span><span class="op" id="4705273">)</span>&nbsp;<span class="builtintype" id="4705275">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4705286">{</span>&nbsp;<span class="keyword" id="4705288">return</span>&nbsp;<span class="ident" id="4705295">nil</span>&nbsp;<span class="op" id="4705299">}</span><br>
<span class="lineno"></span><span class="keyword" id="4705301">func</span>&nbsp;<span class="op" id="4705306">(</span><span class="ident" id="4705307">c</span>&nbsp;<span class="op" id="4705309">*</span><span class="ident" id="4705310">dumpConn</span><span class="op" id="4705318">)</span>&nbsp;<span class="ident" id="4705320">SetReadDeadline</span><span class="op" id="4705335">(</span><span class="ident" id="4705336">t</span>&nbsp;<span class="ident" id="4705338">time</span><span class="op" id="4705342">.</span><span class="ident" id="4705343">Time</span><span class="op" id="4705347">)</span>&nbsp;<span class="builtintype" id="4705349">error</span>&nbsp;&nbsp;<span class="op" id="4705356">{</span>&nbsp;<span class="keyword" id="4705358">return</span>&nbsp;<span class="ident" id="4705365">nil</span>&nbsp;<span class="op" id="4705369">}</span><br>
<span class="lineno"></span><span class="keyword" id="4705371">func</span>&nbsp;<span class="op" id="4705376">(</span><span class="ident" id="4705377">c</span>&nbsp;<span class="op" id="4705379">*</span><span class="ident" id="4705380">dumpConn</span><span class="op" id="4705388">)</span>&nbsp;<span class="ident" id="4705390">SetWriteDeadline</span><span class="op" id="4705406">(</span><span class="ident" id="4705407">t</span>&nbsp;<span class="ident" id="4705409">time</span><span class="op" id="4705413">.</span><span class="ident" id="4705414">Time</span><span class="op" id="4705418">)</span>&nbsp;<span class="builtintype" id="4705420">error</span>&nbsp;<span class="op" id="4705426">{</span>&nbsp;<span class="keyword" id="4705428">return</span>&nbsp;<span class="ident" id="4705435">nil</span>&nbsp;<span class="op" id="4705439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4705442">type</span>&nbsp;<span class="ident" id="4705447">neverEnding</span>&nbsp;<span class="builtintype" id="4705459">byte</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="4705465">func</span>&nbsp;<span class="op" id="4705470">(</span><span class="ident" id="4705471">b</span>&nbsp;<span class="ident" id="4705473">neverEnding</span><span class="op" id="4705484">)</span>&nbsp;<span class="ident" id="4705486">Read</span><span class="op" id="4705490">(</span><span class="ident" id="4705491">p</span>&nbsp;<span class="op" id="4705493">[</span><span class="op" id="4705494">]</span><span class="builtintype" id="4705495">byte</span><span class="op" id="4705499">)</span>&nbsp;<span class="op" id="4705501">(</span><span class="ident" id="4705502">n</span>&nbsp;<span class="builtintype" id="4705504">int</span><span class="op" id="4705507">,</span>&nbsp;<span class="ident" id="4705509">err</span>&nbsp;<span class="builtintype" id="4705513">error</span><span class="op" id="4705518">)</span>&nbsp;<span class="op" id="4705520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4705523">for</span>&nbsp;<span class="ident" id="4705527">i</span>&nbsp;<span class="op" id="4705529">:=</span>&nbsp;<span class="keyword" id="4705532">range</span>&nbsp;<span class="ident" id="4705538">p</span>&nbsp;<span class="op" id="4705540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4705544">p</span><span class="op" id="4705545">[</span><span class="ident" id="4705546">i</span><span class="op" id="4705547">]</span>&nbsp;<span class="op" id="4705549">=</span>&nbsp;<span class="builtintype" id="4705551">byte</span><span class="op" id="4705555">(</span><span class="ident" id="4705556">b</span><span class="op" id="4705557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4705560">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4705563">return</span>&nbsp;<span class="builtinfunc" id="4705570">len</span><span class="op" id="4705573">(</span><span class="ident" id="4705574">p</span><span class="op" id="4705575">)</span><span class="op" id="4705576">,</span>&nbsp;<span class="ident" id="4705578">nil</span><br>
<span class="lineno"></span><span class="op" id="4705582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4705585">//&nbsp;DumpRequestOut&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;includes</span><br>
<span class="lineno"></span><span class="comment" id="4705636">//&nbsp;headers&nbsp;that&nbsp;the&nbsp;standard&nbsp;http.Transport&nbsp;adds,</span><br>
<span class="lineno">60</span><span class="comment" id="4705686">//&nbsp;such&nbsp;as&nbsp;User-Agent.</span><br>
<span class="lineno"></span><span class="keyword" id="4705709">func</span>&nbsp;<span class="ident" id="4705714">DumpRequestOut</span><span class="op" id="4705728">(</span><span class="ident" id="4705729">req</span>&nbsp;<span class="op" id="4705733">*</span><span class="ident" id="4705734">http</span><span class="op" id="4705738">.</span><span class="ident" id="4705739">Request</span><span class="op" id="4705746">,</span>&nbsp;<span class="ident" id="4705748">body</span>&nbsp;<span class="builtintype" id="4705753">bool</span><span class="op" id="4705757">)</span>&nbsp;<span class="op" id="4705759">(</span><span class="op" id="4705760">[</span><span class="op" id="4705761">]</span><span class="builtintype" id="4705762">byte</span><span class="op" id="4705766">,</span>&nbsp;<span class="builtintype" id="4705768">error</span><span class="op" id="4705773">)</span>&nbsp;<span class="op" id="4705775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4705778">save</span>&nbsp;<span class="op" id="4705783">:=</span>&nbsp;<span class="ident" id="4705786">req</span><span class="op" id="4705789">.</span><span class="ident" id="4705790">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4705796">dummyBody</span>&nbsp;<span class="op" id="4705806">:=</span>&nbsp;<span class="builtintype" id="4705809">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4705816">if</span>&nbsp;<span class="op" id="4705819">!</span><span class="ident" id="4705820">body</span>&nbsp;<span class="op" id="4705825">||</span>&nbsp;<span class="ident" id="4705828">req</span><span class="op" id="4705831">.</span><span class="ident" id="4705832">Body</span>&nbsp;<span class="op" id="4705837">==</span>&nbsp;<span class="ident" id="4705840">nil</span>&nbsp;<span class="op" id="4705844">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4705848">req</span><span class="op" id="4705851">.</span><span class="ident" id="4705852">Body</span>&nbsp;<span class="op" id="4705857">=</span>&nbsp;<span class="ident" id="4705859">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4705865">if</span>&nbsp;<span class="ident" id="4705868">req</span><span class="op" id="4705871">.</span><span class="ident" id="4705872">ContentLength</span>&nbsp;<span class="op" id="4705886">!=</span>&nbsp;<span class="num" id="4705889">0</span>&nbsp;<span class="op" id="4705891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4705896">req</span><span class="op" id="4705899">.</span><span class="ident" id="4705900">Body</span>&nbsp;<span class="op" id="4705905">=</span>&nbsp;<span class="ident" id="4705907">ioutil</span><span class="op" id="4705913">.</span><span class="ident" id="4705914">NopCloser</span><span class="op" id="4705923">(</span><span class="ident" id="4705924">io</span><span class="op" id="4705926">.</span><span class="ident" id="4705927">LimitReader</span><span class="op" id="4705938">(</span><span class="ident" id="4705939">neverEnding</span><span class="op" id="4705950">(</span><span class="string" id="4705951">&#39;x&#39;</span><span class="op" id="4705954">)</span><span class="op" id="4705955">,</span>&nbsp;<span class="ident" id="4705957">req</span><span class="op" id="4705960">.</span><span class="ident" id="4705961">ContentLength</span><span class="op" id="4705974">)</span><span class="op" id="4705975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4705980">dummyBody</span>&nbsp;<span class="op" id="4705990">=</span>&nbsp;<span class="builtintype" id="4705992">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4705999">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4706002">}</span>&nbsp;<span class="keyword" id="4706004">else</span>&nbsp;<span class="op" id="4706009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4706013">var</span>&nbsp;<span class="ident" id="4706017">err</span>&nbsp;<span class="builtintype" id="4706021">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4706029">save</span><span class="op" id="4706033">,</span>&nbsp;<span class="ident" id="4706035">req</span><span class="op" id="4706038">.</span><span class="ident" id="4706039">Body</span><span class="op" id="4706043">,</span>&nbsp;<span class="ident" id="4706045">err</span>&nbsp;<span class="op" id="4706049">=</span>&nbsp;<span class="ident" id="4706051">drainBody</span><span class="op" id="4706060">(</span><span class="ident" id="4706061">req</span><span class="op" id="4706064">.</span><span class="ident" id="4706065">Body</span><span class="op" id="4706069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4706073">if</span>&nbsp;<span class="ident" id="4706076">err</span>&nbsp;<span class="op" id="4706080">!=</span>&nbsp;<span class="ident" id="4706083">nil</span>&nbsp;<span class="op" id="4706087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4706092">return</span>&nbsp;<span class="ident" id="4706099">nil</span><span class="op" id="4706102">,</span>&nbsp;<span class="ident" id="4706104">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4706110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4706113">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4706117">//&nbsp;Since&nbsp;we&#39;re&nbsp;using&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;write&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4706187">//&nbsp;switch&nbsp;to&nbsp;http&nbsp;so&nbsp;the&nbsp;Transport&nbsp;doesn&#39;t&nbsp;try&nbsp;to&nbsp;do&nbsp;an&nbsp;SSL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4706248">//&nbsp;negotiation&nbsp;with&nbsp;our&nbsp;dumpConn&nbsp;and&nbsp;its&nbsp;bytes.Buffer&nbsp;&amp;&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4706311">//&nbsp;The&nbsp;wire&nbsp;format&nbsp;for&nbsp;https&nbsp;and&nbsp;http&nbsp;are&nbsp;the&nbsp;same,&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4706372">reqSend</span>&nbsp;<span class="op" id="4706380">:=</span>&nbsp;<span class="ident" id="4706383">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4706388">if</span>&nbsp;<span class="ident" id="4706391">req</span><span class="op" id="4706394">.</span><span class="ident" id="4706395">URL</span><span class="op" id="4706398">.</span><span class="ident" id="4706399">Scheme</span>&nbsp;<span class="op" id="4706406">==</span>&nbsp;<span class="string" id="4706409">&#34;https&#34;</span>&nbsp;<span class="op" id="4706417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4706421">reqSend</span>&nbsp;<span class="op" id="4706429">=</span>&nbsp;<span class="builtinfunc" id="4706431">new</span><span class="op" id="4706434">(</span><span class="ident" id="4706435">http</span><span class="op" id="4706439">.</span><span class="ident" id="4706440">Request</span><span class="op" id="4706447">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4706451">*</span><span class="ident" id="4706452">reqSend</span>&nbsp;<span class="op" id="4706460">=</span>&nbsp;<span class="op" id="4706462">*</span><span class="ident" id="4706463">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4706469">reqSend</span><span class="op" id="4706476">.</span><span class="ident" id="4706477">URL</span>&nbsp;<span class="op" id="4706481">=</span>&nbsp;<span class="builtinfunc" id="4706483">new</span><span class="op" id="4706486">(</span><span class="ident" id="4706487">url</span><span class="op" id="4706490">.</span><span class="ident" id="4706491">URL</span><span class="op" id="4706494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4706498">*</span><span class="ident" id="4706499">reqSend</span><span class="op" id="4706506">.</span><span class="ident" id="4706507">URL</span>&nbsp;<span class="op" id="4706511">=</span>&nbsp;<span class="op" id="4706513">*</span><span class="ident" id="4706514">req</span><span class="op" id="4706517">.</span><span class="ident" id="4706518">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4706524">reqSend</span><span class="op" id="4706531">.</span><span class="ident" id="4706532">URL</span><span class="op" id="4706535">.</span><span class="ident" id="4706536">Scheme</span>&nbsp;<span class="op" id="4706543">=</span>&nbsp;<span class="string" id="4706545">&#34;http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4706553">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4706557">//&nbsp;Use&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;record&nbsp;what&nbsp;we&nbsp;would&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4706620">//&nbsp;on&nbsp;the&nbsp;wire,&nbsp;but&nbsp;not&nbsp;using&nbsp;TCP.&nbsp;&nbsp;Use&nbsp;a&nbsp;Transport&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4706680">//&nbsp;custom&nbsp;dialer&nbsp;that&nbsp;returns&nbsp;a&nbsp;fake&nbsp;net.Conn&nbsp;that&nbsp;waits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4706738">//&nbsp;for&nbsp;the&nbsp;full&nbsp;input&nbsp;(and&nbsp;recording&nbsp;it),&nbsp;and&nbsp;then&nbsp;responds</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4706799">//&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4706826">var</span>&nbsp;<span class="ident" id="4706830">buf</span>&nbsp;<span class="ident" id="4706834">bytes</span><span class="op" id="4706839">.</span><span class="ident" id="4706840">Buffer</span>&nbsp;<span class="comment" id="4706847">//&nbsp;records&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4706870">pr</span><span class="op" id="4706872">,</span>&nbsp;<span class="ident" id="4706874">pw</span>&nbsp;<span class="op" id="4706877">:=</span>&nbsp;<span class="ident" id="4706880">io</span><span class="op" id="4706882">.</span><span class="ident" id="4706883">Pipe</span><span class="op" id="4706887">(</span><span class="op" id="4706888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4706891">defer</span>&nbsp;<span class="ident" id="4706897">pr</span><span class="op" id="4706899">.</span><span class="ident" id="4706900">Close</span><span class="op" id="4706905">(</span><span class="op" id="4706906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4706909">defer</span>&nbsp;<span class="ident" id="4706915">pw</span><span class="op" id="4706917">.</span><span class="ident" id="4706918">Close</span><span class="op" id="4706923">(</span><span class="op" id="4706924">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4706927">dr</span>&nbsp;<span class="op" id="4706930">:=</span>&nbsp;<span class="op" id="4706933">&amp;</span><span class="ident" id="4706934">delegateReader</span><span class="op" id="4706948">{</span><span class="ident" id="4706949">c</span><span class="op" id="4706950">:</span>&nbsp;<span class="builtinfunc" id="4706952">make</span><span class="op" id="4706956">(</span><span class="keyword" id="4706957">chan</span>&nbsp;<span class="ident" id="4706962">io</span><span class="op" id="4706964">.</span><span class="ident" id="4706965">Reader</span><span class="op" id="4706971">)</span><span class="op" id="4706972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4706975">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;request&nbsp;before&nbsp;replying&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4707039">go</span>&nbsp;<span class="keyword" id="4707042">func</span><span class="op" id="4707046">(</span><span class="op" id="4707047">)</span>&nbsp;<span class="op" id="4707049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4707053">req</span><span class="op" id="4707056">,</span>&nbsp;<span class="ident" id="4707058">err</span>&nbsp;<span class="op" id="4707062">:=</span>&nbsp;<span class="ident" id="4707065">http</span><span class="op" id="4707069">.</span><span class="ident" id="4707070">ReadRequest</span><span class="op" id="4707081">(</span><span class="ident" id="4707082">bufio</span><span class="op" id="4707087">.</span><span class="ident" id="4707088">NewReader</span><span class="op" id="4707097">(</span><span class="ident" id="4707098">pr</span><span class="op" id="4707100">)</span><span class="op" id="4707101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4707105">if</span>&nbsp;<span class="ident" id="4707108">err</span>&nbsp;<span class="op" id="4707112">==</span>&nbsp;<span class="ident" id="4707115">nil</span>&nbsp;<span class="op" id="4707119">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4707124">//&nbsp;Ensure&nbsp;all&nbsp;the&nbsp;body&nbsp;is&nbsp;read;&nbsp;otherwise</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4707169">//&nbsp;we&#39;ll&nbsp;get&nbsp;a&nbsp;partial&nbsp;dump.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4707201">io</span><span class="op" id="4707203">.</span><span class="ident" id="4707204">Copy</span><span class="op" id="4707208">(</span><span class="ident" id="4707209">ioutil</span><span class="op" id="4707215">.</span><span class="ident" id="4707216">Discard</span><span class="op" id="4707223">,</span>&nbsp;<span class="ident" id="4707225">req</span><span class="op" id="4707228">.</span><span class="ident" id="4707229">Body</span><span class="op" id="4707233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4707238">req</span><span class="op" id="4707241">.</span><span class="ident" id="4707242">Body</span><span class="op" id="4707246">.</span><span class="ident" id="4707247">Close</span><span class="op" id="4707252">(</span><span class="op" id="4707253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4707257">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4707261">dr</span><span class="op" id="4707263">.</span><span class="ident" id="4707264">c</span>&nbsp;<span class="op" id="4707266">&lt;-</span>&nbsp;<span class="ident" id="4707269">strings</span><span class="op" id="4707276">.</span><span class="ident" id="4707277">NewReader</span><span class="op" id="4707286">(</span><span class="string" id="4707287">&#34;HTTP/1.1&nbsp;204&nbsp;No&nbsp;Content\r\n\r\n&#34;</span><span class="op" id="4707320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4707323">}</span><span class="op" id="4707324">(</span><span class="op" id="4707325">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4707329">t</span>&nbsp;<span class="op" id="4707331">:=</span>&nbsp;<span class="op" id="4707334">&amp;</span><span class="ident" id="4707335">http</span><span class="op" id="4707339">.</span><span class="ident" id="4707340">Transport</span><span class="op" id="4707349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4707353">DisableKeepAlives</span><span class="op" id="4707370">:</span>&nbsp;<span class="builtintype" id="4707372">true</span><span class="op" id="4707376">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4707380">Dial</span><span class="op" id="4707384">:</span>&nbsp;<span class="keyword" id="4707386">func</span><span class="op" id="4707390">(</span><span class="ident" id="4707391">net</span><span class="op" id="4707394">,</span>&nbsp;<span class="ident" id="4707396">addr</span>&nbsp;<span class="builtintype" id="4707401">string</span><span class="op" id="4707407">)</span>&nbsp;<span class="op" id="4707409">(</span><span class="ident" id="4707410">net</span><span class="op" id="4707413">.</span><span class="ident" id="4707414">Conn</span><span class="op" id="4707418">,</span>&nbsp;<span class="builtintype" id="4707420">error</span><span class="op" id="4707425">)</span>&nbsp;<span class="op" id="4707427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4707432">return</span>&nbsp;<span class="op" id="4707439">&amp;</span><span class="ident" id="4707440">dumpConn</span><span class="op" id="4707448">{</span><span class="ident" id="4707449">io</span><span class="op" id="4707451">.</span><span class="ident" id="4707452">MultiWriter</span><span class="op" id="4707463">(</span><span class="op" id="4707464">&amp;</span><span class="ident" id="4707465">buf</span><span class="op" id="4707468">,</span>&nbsp;<span class="ident" id="4707470">pw</span><span class="op" id="4707472">)</span><span class="op" id="4707473">,</span>&nbsp;<span class="ident" id="4707475">dr</span><span class="op" id="4707477">}</span><span class="op" id="4707478">,</span>&nbsp;<span class="ident" id="4707480">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4707486">}</span><span class="op" id="4707487">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4707490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4707494">_</span><span class="op" id="4707495">,</span>&nbsp;<span class="ident" id="4707497">err</span>&nbsp;<span class="op" id="4707501">:=</span>&nbsp;<span class="ident" id="4707504">t</span><span class="op" id="4707505">.</span><span class="ident" id="4707506">RoundTrip</span><span class="op" id="4707515">(</span><span class="ident" id="4707516">reqSend</span><span class="op" id="4707523">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4707527">req</span><span class="op" id="4707530">.</span><span class="ident" id="4707531">Body</span>&nbsp;<span class="op" id="4707536">=</span>&nbsp;<span class="ident" id="4707538">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4707544">if</span>&nbsp;<span class="ident" id="4707547">err</span>&nbsp;<span class="op" id="4707551">!=</span>&nbsp;<span class="ident" id="4707554">nil</span>&nbsp;<span class="op" id="4707558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4707562">return</span>&nbsp;<span class="ident" id="4707569">nil</span><span class="op" id="4707572">,</span>&nbsp;<span class="ident" id="4707574">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4707579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4707582">dump</span>&nbsp;<span class="op" id="4707587">:=</span>&nbsp;<span class="ident" id="4707590">buf</span><span class="op" id="4707593">.</span><span class="ident" id="4707594">Bytes</span><span class="op" id="4707599">(</span><span class="op" id="4707600">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4707604">//&nbsp;If&nbsp;we&nbsp;used&nbsp;a&nbsp;dummy&nbsp;body&nbsp;above,&nbsp;remove&nbsp;it&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4707654">//&nbsp;TODO:&nbsp;if&nbsp;the&nbsp;req.ContentLength&nbsp;is&nbsp;large,&nbsp;we&nbsp;allocate&nbsp;memory</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4707718">//&nbsp;unnecessarily&nbsp;just&nbsp;to&nbsp;slice&nbsp;it&nbsp;off&nbsp;here.&nbsp;&nbsp;But&nbsp;this&nbsp;is&nbsp;just</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4707781">//&nbsp;a&nbsp;debug&nbsp;function,&nbsp;so&nbsp;this&nbsp;is&nbsp;acceptable&nbsp;for&nbsp;now.&nbsp;We&nbsp;could</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4707843">//&nbsp;discard&nbsp;the&nbsp;body&nbsp;earlier&nbsp;if&nbsp;this&nbsp;matters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4707889">if</span>&nbsp;<span class="ident" id="4707892">dummyBody</span>&nbsp;<span class="op" id="4707902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4707906">if</span>&nbsp;<span class="ident" id="4707909">i</span>&nbsp;<span class="op" id="4707911">:=</span>&nbsp;<span class="ident" id="4707914">bytes</span><span class="op" id="4707919">.</span><span class="ident" id="4707920">Index</span><span class="op" id="4707925">(</span><span class="ident" id="4707926">dump</span><span class="op" id="4707930">,</span>&nbsp;<span class="op" id="4707932">[</span><span class="op" id="4707933">]</span><span class="builtintype" id="4707934">byte</span><span class="op" id="4707938">(</span><span class="string" id="4707939">&#34;\r\n\r\n&#34;</span><span class="op" id="4707949">)</span><span class="op" id="4707950">)</span><span class="op" id="4707951">;</span>&nbsp;<span class="ident" id="4707953">i</span>&nbsp;<span class="op" id="4707955">&gt;=</span>&nbsp;<span class="num" id="4707958">0</span>&nbsp;<span class="op" id="4707960">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4707965">dump</span>&nbsp;<span class="op" id="4707970">=</span>&nbsp;<span class="ident" id="4707972">dump</span><span class="op" id="4707976">[</span><span class="op" id="4707977">:</span><span class="ident" id="4707978">i</span><span class="op" id="4707979">+</span><span class="num" id="4707980">4</span><span class="op" id="4707981">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4707985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4707988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4707991">return</span>&nbsp;<span class="ident" id="4707998">dump</span><span class="op" id="4708002">,</span>&nbsp;<span class="ident" id="4708004">nil</span><br>
<span class="lineno"></span><span class="op" id="4708008">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="4708011">//&nbsp;delegateReader&nbsp;is&nbsp;a&nbsp;reader&nbsp;that&nbsp;delegates&nbsp;to&nbsp;another&nbsp;reader,</span><br>
<span class="lineno"></span><span class="comment" id="4708075">//&nbsp;once&nbsp;it&nbsp;arrives&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="4708108">type</span>&nbsp;<span class="ident" id="4708113">delegateReader</span>&nbsp;<span class="keyword" id="4708128">struct</span>&nbsp;<span class="op" id="4708135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4708138">c</span>&nbsp;<span class="keyword" id="4708140">chan</span>&nbsp;<span class="ident" id="4708145">io</span><span class="op" id="4708147">.</span><span class="ident" id="4708148">Reader</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4708156">r</span>&nbsp;<span class="ident" id="4708158">io</span><span class="op" id="4708160">.</span><span class="ident" id="4708161">Reader</span>&nbsp;<span class="comment" id="4708168">//&nbsp;nil&nbsp;until&nbsp;received&nbsp;from&nbsp;c</span><br>
<span class="lineno"></span><span class="op" id="4708197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4708200">func</span>&nbsp;<span class="op" id="4708205">(</span><span class="ident" id="4708206">r</span>&nbsp;<span class="op" id="4708208">*</span><span class="ident" id="4708209">delegateReader</span><span class="op" id="4708223">)</span>&nbsp;<span class="ident" id="4708225">Read</span><span class="op" id="4708229">(</span><span class="ident" id="4708230">p</span>&nbsp;<span class="op" id="4708232">[</span><span class="op" id="4708233">]</span><span class="builtintype" id="4708234">byte</span><span class="op" id="4708238">)</span>&nbsp;<span class="op" id="4708240">(</span><span class="builtintype" id="4708241">int</span><span class="op" id="4708244">,</span>&nbsp;<span class="builtintype" id="4708246">error</span><span class="op" id="4708251">)</span>&nbsp;<span class="op" id="4708253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4708256">if</span>&nbsp;<span class="ident" id="4708259">r</span><span class="op" id="4708260">.</span><span class="ident" id="4708261">r</span>&nbsp;<span class="op" id="4708263">==</span>&nbsp;<span class="ident" id="4708266">nil</span>&nbsp;<span class="op" id="4708270">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4708274">r</span><span class="op" id="4708275">.</span><span class="ident" id="4708276">r</span>&nbsp;<span class="op" id="4708278">=</span>&nbsp;<span class="op" id="4708280">&lt;-</span><span class="ident" id="4708282">r</span><span class="op" id="4708283">.</span><span class="ident" id="4708284">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4708287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4708290">return</span>&nbsp;<span class="ident" id="4708297">r</span><span class="op" id="4708298">.</span><span class="ident" id="4708299">r</span><span class="op" id="4708300">.</span><span class="ident" id="4708301">Read</span><span class="op" id="4708305">(</span><span class="ident" id="4708306">p</span><span class="op" id="4708307">)</span><br>
<span class="lineno"></span><span class="op" id="4708309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="comment" id="4708312">//&nbsp;Return&nbsp;value&nbsp;if&nbsp;nonempty,&nbsp;def&nbsp;otherwise.</span><br>
<span class="lineno"></span><span class="keyword" id="4708356">func</span>&nbsp;<span class="ident" id="4708361">valueOrDefault</span><span class="op" id="4708375">(</span><span class="ident" id="4708376">value</span><span class="op" id="4708381">,</span>&nbsp;<span class="ident" id="4708383">def</span>&nbsp;<span class="builtintype" id="4708387">string</span><span class="op" id="4708393">)</span>&nbsp;<span class="builtintype" id="4708395">string</span>&nbsp;<span class="op" id="4708402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4708405">if</span>&nbsp;<span class="ident" id="4708408">value</span>&nbsp;<span class="op" id="4708414">!=</span>&nbsp;<span class="string" id="4708417">&#34;&#34;</span>&nbsp;<span class="op" id="4708420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4708424">return</span>&nbsp;<span class="ident" id="4708431">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4708438">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4708441">return</span>&nbsp;<span class="ident" id="4708448">def</span><br>
<span class="lineno"></span><span class="op" id="4708452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4708455">var</span>&nbsp;<span class="ident" id="4708459">reqWriteExcludeHeaderDump</span>&nbsp;<span class="op" id="4708485">=</span>&nbsp;<span class="keyword" id="4708487">map</span><span class="op" id="4708490">[</span><span class="builtintype" id="4708491">string</span><span class="op" id="4708497">]</span><span class="builtintype" id="4708498">bool</span><span class="op" id="4708502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4708505">&#34;Host&#34;</span><span class="op" id="4708511">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4708526">true</span><span class="op" id="4708530">,</span>&nbsp;<span class="comment" id="4708532">//&nbsp;not&nbsp;in&nbsp;Header&nbsp;map&nbsp;anyway</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4708561">&#34;Content-Length&#34;</span><span class="op" id="4708577">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4708582">true</span><span class="op" id="4708586">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4708589">&#34;Transfer-Encoding&#34;</span><span class="op" id="4708608">:</span>&nbsp;<span class="builtintype" id="4708610">true</span><span class="op" id="4708614">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4708617">&#34;Trailer&#34;</span><span class="op" id="4708626">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4708638">true</span><span class="op" id="4708642">,</span><br>
<span class="lineno"></span><span class="op" id="4708644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="4708647">//&nbsp;dumpAsReceived&nbsp;writes&nbsp;req&nbsp;to&nbsp;w&nbsp;in&nbsp;the&nbsp;form&nbsp;as&nbsp;it&nbsp;was&nbsp;received,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4708716">//&nbsp;at&nbsp;least&nbsp;as&nbsp;accurately&nbsp;as&nbsp;possible&nbsp;from&nbsp;the&nbsp;information&nbsp;retained&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4708787">//&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span><span class="keyword" id="4708803">func</span>&nbsp;<span class="ident" id="4708808">dumpAsReceived</span><span class="op" id="4708822">(</span><span class="ident" id="4708823">req</span>&nbsp;<span class="op" id="4708827">*</span><span class="ident" id="4708828">http</span><span class="op" id="4708832">.</span><span class="ident" id="4708833">Request</span><span class="op" id="4708840">,</span>&nbsp;<span class="ident" id="4708842">w</span>&nbsp;<span class="ident" id="4708844">io</span><span class="op" id="4708846">.</span><span class="ident" id="4708847">Writer</span><span class="op" id="4708853">)</span>&nbsp;<span class="builtintype" id="4708855">error</span>&nbsp;<span class="op" id="4708861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4708864">return</span>&nbsp;<span class="ident" id="4708871">nil</span><br>
<span class="lineno">175</span><span class="op" id="4708875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4708878">//&nbsp;DumpRequest&nbsp;returns&nbsp;the&nbsp;as-received&nbsp;wire&nbsp;representation&nbsp;of&nbsp;req,</span><br>
<span class="lineno"></span><span class="comment" id="4708945">//&nbsp;optionally&nbsp;including&nbsp;the&nbsp;request&nbsp;body,&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="comment" id="4709002">//&nbsp;DumpRequest&nbsp;is&nbsp;semantically&nbsp;a&nbsp;no-op,&nbsp;but&nbsp;in&nbsp;order&nbsp;to</span><br>
<span class="lineno">180</span><span class="comment" id="4709058">//&nbsp;dump&nbsp;the&nbsp;body,&nbsp;it&nbsp;reads&nbsp;the&nbsp;body&nbsp;data&nbsp;into&nbsp;memory&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4709115">//&nbsp;changes&nbsp;req.Body&nbsp;to&nbsp;refer&nbsp;to&nbsp;the&nbsp;in-memory&nbsp;copy.</span><br>
<span class="lineno"></span><span class="comment" id="4709167">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;http.Request.Write&nbsp;details&nbsp;which&nbsp;fields</span><br>
<span class="lineno"></span><span class="comment" id="4709232">//&nbsp;of&nbsp;req&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4709252">func</span>&nbsp;<span class="ident" id="4709257">DumpRequest</span><span class="op" id="4709268">(</span><span class="ident" id="4709269">req</span>&nbsp;<span class="op" id="4709273">*</span><span class="ident" id="4709274">http</span><span class="op" id="4709278">.</span><span class="ident" id="4709279">Request</span><span class="op" id="4709286">,</span>&nbsp;<span class="ident" id="4709288">body</span>&nbsp;<span class="builtintype" id="4709293">bool</span><span class="op" id="4709297">)</span>&nbsp;<span class="op" id="4709299">(</span><span class="ident" id="4709300">dump</span>&nbsp;<span class="op" id="4709305">[</span><span class="op" id="4709306">]</span><span class="builtintype" id="4709307">byte</span><span class="op" id="4709311">,</span>&nbsp;<span class="ident" id="4709313">err</span>&nbsp;<span class="builtintype" id="4709317">error</span><span class="op" id="4709322">)</span>&nbsp;<span class="op" id="4709324">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4709327">save</span>&nbsp;<span class="op" id="4709332">:=</span>&nbsp;<span class="ident" id="4709335">req</span><span class="op" id="4709338">.</span><span class="ident" id="4709339">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4709345">if</span>&nbsp;<span class="op" id="4709348">!</span><span class="ident" id="4709349">body</span>&nbsp;<span class="op" id="4709354">||</span>&nbsp;<span class="ident" id="4709357">req</span><span class="op" id="4709360">.</span><span class="ident" id="4709361">Body</span>&nbsp;<span class="op" id="4709366">==</span>&nbsp;<span class="ident" id="4709369">nil</span>&nbsp;<span class="op" id="4709373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4709377">req</span><span class="op" id="4709380">.</span><span class="ident" id="4709381">Body</span>&nbsp;<span class="op" id="4709386">=</span>&nbsp;<span class="ident" id="4709388">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4709393">}</span>&nbsp;<span class="keyword" id="4709395">else</span>&nbsp;<span class="op" id="4709400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4709404">save</span><span class="op" id="4709408">,</span>&nbsp;<span class="ident" id="4709410">req</span><span class="op" id="4709413">.</span><span class="ident" id="4709414">Body</span><span class="op" id="4709418">,</span>&nbsp;<span class="ident" id="4709420">err</span>&nbsp;<span class="op" id="4709424">=</span>&nbsp;<span class="ident" id="4709426">drainBody</span><span class="op" id="4709435">(</span><span class="ident" id="4709436">req</span><span class="op" id="4709439">.</span><span class="ident" id="4709440">Body</span><span class="op" id="4709444">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4709448">if</span>&nbsp;<span class="ident" id="4709451">err</span>&nbsp;<span class="op" id="4709455">!=</span>&nbsp;<span class="ident" id="4709458">nil</span>&nbsp;<span class="op" id="4709462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4709467">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4709476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4709479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4709483">var</span>&nbsp;<span class="ident" id="4709487">b</span>&nbsp;<span class="ident" id="4709489">bytes</span><span class="op" id="4709494">.</span><span class="ident" id="4709495">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4709504">fmt</span><span class="op" id="4709507">.</span><span class="ident" id="4709508">Fprintf</span><span class="op" id="4709515">(</span><span class="op" id="4709516">&amp;</span><span class="ident" id="4709517">b</span><span class="op" id="4709518">,</span>&nbsp;<span class="string" id="4709520">&#34;%s&nbsp;%s&nbsp;HTTP/%d.%d\r\n&#34;</span><span class="op" id="4709542">,</span>&nbsp;<span class="ident" id="4709544">valueOrDefault</span><span class="op" id="4709558">(</span><span class="ident" id="4709559">req</span><span class="op" id="4709562">.</span><span class="ident" id="4709563">Method</span><span class="op" id="4709569">,</span>&nbsp;<span class="string" id="4709571">&#34;GET&#34;</span><span class="op" id="4709576">)</span><span class="op" id="4709577">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4709581">req</span><span class="op" id="4709584">.</span><span class="ident" id="4709585">URL</span><span class="op" id="4709588">.</span><span class="ident" id="4709589">RequestURI</span><span class="op" id="4709599">(</span><span class="op" id="4709600">)</span><span class="op" id="4709601">,</span>&nbsp;<span class="ident" id="4709603">req</span><span class="op" id="4709606">.</span><span class="ident" id="4709607">ProtoMajor</span><span class="op" id="4709617">,</span>&nbsp;<span class="ident" id="4709619">req</span><span class="op" id="4709622">.</span><span class="ident" id="4709623">ProtoMinor</span><span class="op" id="4709633">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4709637">host</span>&nbsp;<span class="op" id="4709642">:=</span>&nbsp;<span class="ident" id="4709645">req</span><span class="op" id="4709648">.</span><span class="ident" id="4709649">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4709655">if</span>&nbsp;<span class="ident" id="4709658">host</span>&nbsp;<span class="op" id="4709663">==</span>&nbsp;<span class="string" id="4709666">&#34;&#34;</span>&nbsp;<span class="op" id="4709669">&amp;&amp;</span>&nbsp;<span class="ident" id="4709672">req</span><span class="op" id="4709675">.</span><span class="ident" id="4709676">URL</span>&nbsp;<span class="op" id="4709680">!=</span>&nbsp;<span class="ident" id="4709683">nil</span>&nbsp;<span class="op" id="4709687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4709691">host</span>&nbsp;<span class="op" id="4709696">=</span>&nbsp;<span class="ident" id="4709698">req</span><span class="op" id="4709701">.</span><span class="ident" id="4709702">URL</span><span class="op" id="4709705">.</span><span class="ident" id="4709706">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4709712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4709715">if</span>&nbsp;<span class="ident" id="4709718">host</span>&nbsp;<span class="op" id="4709723">!=</span>&nbsp;<span class="string" id="4709726">&#34;&#34;</span>&nbsp;<span class="op" id="4709729">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4709733">fmt</span><span class="op" id="4709736">.</span><span class="ident" id="4709737">Fprintf</span><span class="op" id="4709744">(</span><span class="op" id="4709745">&amp;</span><span class="ident" id="4709746">b</span><span class="op" id="4709747">,</span>&nbsp;<span class="string" id="4709749">&#34;Host:&nbsp;%s\r\n&#34;</span><span class="op" id="4709763">,</span>&nbsp;<span class="ident" id="4709765">host</span><span class="op" id="4709769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4709772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4709776">chunked</span>&nbsp;<span class="op" id="4709784">:=</span>&nbsp;<span class="builtinfunc" id="4709787">len</span><span class="op" id="4709790">(</span><span class="ident" id="4709791">req</span><span class="op" id="4709794">.</span><span class="ident" id="4709795">TransferEncoding</span><span class="op" id="4709811">)</span>&nbsp;<span class="op" id="4709813">&gt;</span>&nbsp;<span class="num" id="4709815">0</span>&nbsp;<span class="op" id="4709817">&amp;&amp;</span>&nbsp;<span class="ident" id="4709820">req</span><span class="op" id="4709823">.</span><span class="ident" id="4709824">TransferEncoding</span><span class="op" id="4709840">[</span><span class="num" id="4709841">0</span><span class="op" id="4709842">]</span>&nbsp;<span class="op" id="4709844">==</span>&nbsp;<span class="string" id="4709847">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4709858">if</span>&nbsp;<span class="builtinfunc" id="4709861">len</span><span class="op" id="4709864">(</span><span class="ident" id="4709865">req</span><span class="op" id="4709868">.</span><span class="ident" id="4709869">TransferEncoding</span><span class="op" id="4709885">)</span>&nbsp;<span class="op" id="4709887">&gt;</span>&nbsp;<span class="num" id="4709889">0</span>&nbsp;<span class="op" id="4709891">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4709895">fmt</span><span class="op" id="4709898">.</span><span class="ident" id="4709899">Fprintf</span><span class="op" id="4709906">(</span><span class="op" id="4709907">&amp;</span><span class="ident" id="4709908">b</span><span class="op" id="4709909">,</span>&nbsp;<span class="string" id="4709911">&#34;Transfer-Encoding:&nbsp;%s\r\n&#34;</span><span class="op" id="4709938">,</span>&nbsp;<span class="ident" id="4709940">strings</span><span class="op" id="4709947">.</span><span class="ident" id="4709948">Join</span><span class="op" id="4709952">(</span><span class="ident" id="4709953">req</span><span class="op" id="4709956">.</span><span class="ident" id="4709957">TransferEncoding</span><span class="op" id="4709973">,</span>&nbsp;<span class="string" id="4709975">&#34;,&#34;</span><span class="op" id="4709978">)</span><span class="op" id="4709979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4709982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4709985">if</span>&nbsp;<span class="ident" id="4709988">req</span><span class="op" id="4709991">.</span><span class="ident" id="4709992">Close</span>&nbsp;<span class="op" id="4709998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4710002">fmt</span><span class="op" id="4710005">.</span><span class="ident" id="4710006">Fprintf</span><span class="op" id="4710013">(</span><span class="op" id="4710014">&amp;</span><span class="ident" id="4710015">b</span><span class="op" id="4710016">,</span>&nbsp;<span class="string" id="4710018">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="4710041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4710044">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4710048">err</span>&nbsp;<span class="op" id="4710052">=</span>&nbsp;<span class="ident" id="4710054">req</span><span class="op" id="4710057">.</span><span class="ident" id="4710058">Header</span><span class="op" id="4710064">.</span><span class="ident" id="4710065">WriteSubset</span><span class="op" id="4710076">(</span><span class="op" id="4710077">&amp;</span><span class="ident" id="4710078">b</span><span class="op" id="4710079">,</span>&nbsp;<span class="ident" id="4710081">reqWriteExcludeHeaderDump</span><span class="op" id="4710106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4710109">if</span>&nbsp;<span class="ident" id="4710112">err</span>&nbsp;<span class="op" id="4710116">!=</span>&nbsp;<span class="ident" id="4710119">nil</span>&nbsp;<span class="op" id="4710123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4710127">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4710135">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4710139">io</span><span class="op" id="4710141">.</span><span class="ident" id="4710142">WriteString</span><span class="op" id="4710153">(</span><span class="op" id="4710154">&amp;</span><span class="ident" id="4710155">b</span><span class="op" id="4710156">,</span>&nbsp;<span class="string" id="4710158">&#34;\r\n&#34;</span><span class="op" id="4710164">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4710168">if</span>&nbsp;<span class="ident" id="4710171">req</span><span class="op" id="4710174">.</span><span class="ident" id="4710175">Body</span>&nbsp;<span class="op" id="4710180">!=</span>&nbsp;<span class="ident" id="4710183">nil</span>&nbsp;<span class="op" id="4710187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4710191">var</span>&nbsp;<span class="ident" id="4710195">dest</span>&nbsp;<span class="ident" id="4710200">io</span><span class="op" id="4710202">.</span><span class="ident" id="4710203">Writer</span>&nbsp;<span class="op" id="4710210">=</span>&nbsp;<span class="op" id="4710212">&amp;</span><span class="ident" id="4710213">b</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4710217">if</span>&nbsp;<span class="ident" id="4710220">chunked</span>&nbsp;<span class="op" id="4710228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4710233">dest</span>&nbsp;<span class="op" id="4710238">=</span>&nbsp;<span class="ident" id="4710240">NewChunkedWriter</span><span class="op" id="4710256">(</span><span class="ident" id="4710257">dest</span><span class="op" id="4710261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4710265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4710269">_</span><span class="op" id="4710270">,</span>&nbsp;<span class="ident" id="4710272">err</span>&nbsp;<span class="op" id="4710276">=</span>&nbsp;<span class="ident" id="4710278">io</span><span class="op" id="4710280">.</span><span class="ident" id="4710281">Copy</span><span class="op" id="4710285">(</span><span class="ident" id="4710286">dest</span><span class="op" id="4710290">,</span>&nbsp;<span class="ident" id="4710292">req</span><span class="op" id="4710295">.</span><span class="ident" id="4710296">Body</span><span class="op" id="4710300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4710304">if</span>&nbsp;<span class="ident" id="4710307">chunked</span>&nbsp;<span class="op" id="4710315">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4710320">dest</span><span class="op" id="4710324">.</span><span class="op" id="4710325">(</span><span class="ident" id="4710326">io</span><span class="op" id="4710328">.</span><span class="ident" id="4710329">Closer</span><span class="op" id="4710335">)</span><span class="op" id="4710336">.</span><span class="ident" id="4710337">Close</span><span class="op" id="4710342">(</span><span class="op" id="4710343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4710348">io</span><span class="op" id="4710350">.</span><span class="ident" id="4710351">WriteString</span><span class="op" id="4710362">(</span><span class="op" id="4710363">&amp;</span><span class="ident" id="4710364">b</span><span class="op" id="4710365">,</span>&nbsp;<span class="string" id="4710367">&#34;\r\n&#34;</span><span class="op" id="4710373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4710377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4710380">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4710384">req</span><span class="op" id="4710387">.</span><span class="ident" id="4710388">Body</span>&nbsp;<span class="op" id="4710393">=</span>&nbsp;<span class="ident" id="4710395">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4710401">if</span>&nbsp;<span class="ident" id="4710404">err</span>&nbsp;<span class="op" id="4710408">!=</span>&nbsp;<span class="ident" id="4710411">nil</span>&nbsp;<span class="op" id="4710415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4710419">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4710427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4710430">dump</span>&nbsp;<span class="op" id="4710435">=</span>&nbsp;<span class="ident" id="4710437">b</span><span class="op" id="4710438">.</span><span class="ident" id="4710439">Bytes</span><span class="op" id="4710444">(</span><span class="op" id="4710445">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4710448">return</span><br>
<span class="lineno"></span><span class="op" id="4710455">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4710458">//&nbsp;errNoBody&nbsp;is&nbsp;a&nbsp;sentinel&nbsp;error&nbsp;value&nbsp;used&nbsp;by&nbsp;failureToReadBody&nbsp;so&nbsp;we&nbsp;can&nbsp;detect</span><br>
<span class="lineno"></span><span class="comment" id="4710540">//&nbsp;that&nbsp;the&nbsp;lack&nbsp;of&nbsp;body&nbsp;was&nbsp;intentional.</span><br>
<span class="lineno">245</span><span class="keyword" id="4710582">var</span>&nbsp;<span class="ident" id="4710586">errNoBody</span>&nbsp;<span class="op" id="4710596">=</span>&nbsp;<span class="ident" id="4710598">errors</span><span class="op" id="4710604">.</span><span class="ident" id="4710605">New</span><span class="op" id="4710608">(</span><span class="string" id="4710609">&#34;sentinel&nbsp;error&nbsp;value&#34;</span><span class="op" id="4710631">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4710634">//&nbsp;failureToReadBody&nbsp;is&nbsp;a&nbsp;io.ReadCloser&nbsp;that&nbsp;just&nbsp;returns&nbsp;errNoBody&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="4710705">//&nbsp;Read.&nbsp;&nbsp;It&#39;s&nbsp;swapped&nbsp;in&nbsp;when&nbsp;we&nbsp;don&#39;t&nbsp;actually&nbsp;want&nbsp;to&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4710774">//&nbsp;body,&nbsp;but&nbsp;need&nbsp;a&nbsp;non-nil&nbsp;one,&nbsp;and&nbsp;want&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;error</span><br>
<span class="lineno">250</span><span class="comment" id="4710841">//&nbsp;from&nbsp;reading&nbsp;the&nbsp;dummy&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="4710873">type</span>&nbsp;<span class="ident" id="4710878">failureToReadBody</span>&nbsp;<span class="keyword" id="4710896">struct</span><span class="op" id="4710902">{</span><span class="op" id="4710903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4710906">func</span>&nbsp;<span class="op" id="4710911">(</span><span class="ident" id="4710912">failureToReadBody</span><span class="op" id="4710929">)</span>&nbsp;<span class="ident" id="4710931">Read</span><span class="op" id="4710935">(</span><span class="op" id="4710936">[</span><span class="op" id="4710937">]</span><span class="builtintype" id="4710938">byte</span><span class="op" id="4710942">)</span>&nbsp;<span class="op" id="4710944">(</span><span class="builtintype" id="4710945">int</span><span class="op" id="4710948">,</span>&nbsp;<span class="builtintype" id="4710950">error</span><span class="op" id="4710955">)</span>&nbsp;<span class="op" id="4710957">{</span>&nbsp;<span class="keyword" id="4710959">return</span>&nbsp;<span class="num" id="4710966">0</span><span class="op" id="4710967">,</span>&nbsp;<span class="ident" id="4710969">errNoBody</span>&nbsp;<span class="op" id="4710979">}</span><br>
<span class="lineno"></span><span class="keyword" id="4710981">func</span>&nbsp;<span class="op" id="4710986">(</span><span class="ident" id="4710987">failureToReadBody</span><span class="op" id="4711004">)</span>&nbsp;<span class="ident" id="4711006">Close</span><span class="op" id="4711011">(</span><span class="op" id="4711012">)</span>&nbsp;<span class="builtintype" id="4711014">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4711032">{</span>&nbsp;<span class="keyword" id="4711034">return</span>&nbsp;<span class="ident" id="4711041">nil</span>&nbsp;<span class="op" id="4711045">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="4711048">var</span>&nbsp;<span class="ident" id="4711052">emptyBody</span>&nbsp;<span class="op" id="4711062">=</span>&nbsp;<span class="ident" id="4711064">ioutil</span><span class="op" id="4711070">.</span><span class="ident" id="4711071">NopCloser</span><span class="op" id="4711080">(</span><span class="ident" id="4711081">strings</span><span class="op" id="4711088">.</span><span class="ident" id="4711089">NewReader</span><span class="op" id="4711098">(</span><span class="string" id="4711099">&#34;&#34;</span><span class="op" id="4711101">)</span><span class="op" id="4711102">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4711105">//&nbsp;DumpResponse&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;dumps&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="4711163">func</span>&nbsp;<span class="ident" id="4711168">DumpResponse</span><span class="op" id="4711180">(</span><span class="ident" id="4711181">resp</span>&nbsp;<span class="op" id="4711186">*</span><span class="ident" id="4711187">http</span><span class="op" id="4711191">.</span><span class="ident" id="4711192">Response</span><span class="op" id="4711200">,</span>&nbsp;<span class="ident" id="4711202">body</span>&nbsp;<span class="builtintype" id="4711207">bool</span><span class="op" id="4711211">)</span>&nbsp;<span class="op" id="4711213">(</span><span class="ident" id="4711214">dump</span>&nbsp;<span class="op" id="4711219">[</span><span class="op" id="4711220">]</span><span class="builtintype" id="4711221">byte</span><span class="op" id="4711225">,</span>&nbsp;<span class="ident" id="4711227">err</span>&nbsp;<span class="builtintype" id="4711231">error</span><span class="op" id="4711236">)</span>&nbsp;<span class="op" id="4711238">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4711241">var</span>&nbsp;<span class="ident" id="4711245">b</span>&nbsp;<span class="ident" id="4711247">bytes</span><span class="op" id="4711252">.</span><span class="ident" id="4711253">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711261">save</span>&nbsp;<span class="op" id="4711266">:=</span>&nbsp;<span class="ident" id="4711269">resp</span><span class="op" id="4711273">.</span><span class="ident" id="4711274">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711280">savecl</span>&nbsp;<span class="op" id="4711287">:=</span>&nbsp;<span class="ident" id="4711290">resp</span><span class="op" id="4711294">.</span><span class="ident" id="4711295">ContentLength</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4711311">if</span>&nbsp;<span class="op" id="4711314">!</span><span class="ident" id="4711315">body</span>&nbsp;<span class="op" id="4711320">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711324">resp</span><span class="op" id="4711328">.</span><span class="ident" id="4711329">Body</span>&nbsp;<span class="op" id="4711334">=</span>&nbsp;<span class="ident" id="4711336">failureToReadBody</span><span class="op" id="4711353">{</span><span class="op" id="4711354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4711357">}</span>&nbsp;<span class="keyword" id="4711359">else</span>&nbsp;<span class="keyword" id="4711364">if</span>&nbsp;<span class="ident" id="4711367">resp</span><span class="op" id="4711371">.</span><span class="ident" id="4711372">Body</span>&nbsp;<span class="op" id="4711377">==</span>&nbsp;<span class="ident" id="4711380">nil</span>&nbsp;<span class="op" id="4711384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711388">resp</span><span class="op" id="4711392">.</span><span class="ident" id="4711393">Body</span>&nbsp;<span class="op" id="4711398">=</span>&nbsp;<span class="ident" id="4711400">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4711411">}</span>&nbsp;<span class="keyword" id="4711413">else</span>&nbsp;<span class="op" id="4711418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711422">save</span><span class="op" id="4711426">,</span>&nbsp;<span class="ident" id="4711428">resp</span><span class="op" id="4711432">.</span><span class="ident" id="4711433">Body</span><span class="op" id="4711437">,</span>&nbsp;<span class="ident" id="4711439">err</span>&nbsp;<span class="op" id="4711443">=</span>&nbsp;<span class="ident" id="4711445">drainBody</span><span class="op" id="4711454">(</span><span class="ident" id="4711455">resp</span><span class="op" id="4711459">.</span><span class="ident" id="4711460">Body</span><span class="op" id="4711464">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4711468">if</span>&nbsp;<span class="ident" id="4711471">err</span>&nbsp;<span class="op" id="4711475">!=</span>&nbsp;<span class="ident" id="4711478">nil</span>&nbsp;<span class="op" id="4711482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4711487">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4711496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4711499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711502">err</span>&nbsp;<span class="op" id="4711506">=</span>&nbsp;<span class="ident" id="4711508">resp</span><span class="op" id="4711512">.</span><span class="ident" id="4711513">Write</span><span class="op" id="4711518">(</span><span class="op" id="4711519">&amp;</span><span class="ident" id="4711520">b</span><span class="op" id="4711521">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4711524">if</span>&nbsp;<span class="ident" id="4711527">err</span>&nbsp;<span class="op" id="4711531">==</span>&nbsp;<span class="ident" id="4711534">errNoBody</span>&nbsp;<span class="op" id="4711544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711548">err</span>&nbsp;<span class="op" id="4711552">=</span>&nbsp;<span class="ident" id="4711554">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4711559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711562">resp</span><span class="op" id="4711566">.</span><span class="ident" id="4711567">Body</span>&nbsp;<span class="op" id="4711572">=</span>&nbsp;<span class="ident" id="4711574">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711580">resp</span><span class="op" id="4711584">.</span><span class="ident" id="4711585">ContentLength</span>&nbsp;<span class="op" id="4711599">=</span>&nbsp;<span class="ident" id="4711601">savecl</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4711609">if</span>&nbsp;<span class="ident" id="4711612">err</span>&nbsp;<span class="op" id="4711616">!=</span>&nbsp;<span class="ident" id="4711619">nil</span>&nbsp;<span class="op" id="4711623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4711627">return</span>&nbsp;<span class="ident" id="4711634">nil</span><span class="op" id="4711637">,</span>&nbsp;<span class="ident" id="4711639">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4711644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4711647">return</span>&nbsp;<span class="ident" id="4711654">b</span><span class="op" id="4711655">.</span><span class="ident" id="4711656">Bytes</span><span class="op" id="4711661">(</span><span class="op" id="4711662">)</span><span class="op" id="4711663">,</span>&nbsp;<span class="ident" id="4711665">nil</span><br>
<span class="lineno"></span><span class="op" id="4711669">}</span>
</div>
</body>
</html>
